From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f177.google.com (mail-qk1-f177.google.com [209.85.222.177])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0615C18E1F
	for <linux-cxl@vger.kernel.org>; Thu, 26 Dec 2024 20:19:24 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.177
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1735244366; cv=none; b=HY/WFMk7G5WcbCF6yjSK3slsLTUxEx1uRWbfoZqxDZhOc7+0WBSdiDuqW+E1KOnJ93qEqTV2t6OFciFJ7jVndmZtPwX2eR0zM6KGC4Vp8ebTm3BTu3PcBO3FcddC5iGsgWEikmzcy2047Qa9BuvgufVhO0M/6Y1LXALik7ULY1A=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1735244366; c=relaxed/simple;
	bh=lRgHdMNwk8t7SFgHlM9cwhzzs67i3LH2uk2gnqvP67Y=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition; b=KNyhe0husODXbj9D+BDMJ7jNn6yRTHSxJDMP1H8PxuJShJH7fZVDyUA9xTIJ4dRQVZK34ndI2aThKogjzeb/zgP+jtr9axegf3uUAKuVf+oLmE/ZR3OoxeVbvJyyPJ2NAc/zHdAi8gV0VJhzHm0sAPiYbpq3wAOtQqrLpPnHXak=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=Hc0Fi4dK; arc=none smtp.client-ip=209.85.222.177
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="Hc0Fi4dK"
Received: by mail-qk1-f177.google.com with SMTP id af79cd13be357-7b6eb531e13so330441285a.0
        for <linux-cxl@vger.kernel.org>; Thu, 26 Dec 2024 12:19:24 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1735244364; x=1735849164; darn=vger.kernel.org;
        h=content-disposition:mime-version:message-id:subject:cc:to:from:date
         :from:to:cc:subject:date:message-id:reply-to;
        bh=qz5ytK1GRdvKgO8e6oKZGmSzgE/hU2itL0CRU+M0PxQ=;
        b=Hc0Fi4dKJuxxmDRKSnEsLZ3L4WxyNLPznTuINNBbWWXD9O+pEBCsdRlyRVGL3uuLdn
         9JVOocNTNxQr4QSHJXAUNZwxASdyFpCa5ZfShoNCFq5O0jM1XbiuZhpdek5UCxQXyKM3
         sBdhItzleMR299Z2dmQnROqvNDD0tn3UFTfnthb+tGg8Ho0k69Qa8ZKijJMkR4NDRE+5
         Yw9h2epGR+mztTpCZWqIfvDFGvuIEnagn9HzLDuzE0NwY6yGZWi47Kz3UYOUkRfGaCRn
         4CWK3LIg5wXPTtpbJPIRjp1Fc3tlGOgE5hR3TDXJ94dFQln5YPDaejrIrenOV01j/hTW
         2KBA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1735244364; x=1735849164;
        h=content-disposition:mime-version:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=qz5ytK1GRdvKgO8e6oKZGmSzgE/hU2itL0CRU+M0PxQ=;
        b=tFmVYWyDP+PoqF91guGWyCpglh1GSqiOQNcxNnhC0doAlmpTgVQRIEssWZhix2gGzX
         JQ4v65/orZqrDvWfwW0gIsOdsv7cIoiP7w1ZwldEEK/G4CMOu+yI+YJanl5ZjjN6o4BJ
         IuLBkUZIS4Z6LiaFHQAUwa13UPo0hwghgFZcpEU47onuknH8VBzILuRsMN3+UlP9m1RY
         uHQnPGoC3bxZSWAb6NbEilE3fx9Vst974bHywgFUBNd0QeAloVCrx35Tc9qTT1TD9C19
         RJYbVUP1/xk5FncVRIrdYgyDW1RyXVDi8n7H7hubP8plUNVun6h4ZAoaJEJOmXelWcxx
         w65g==
X-Forwarded-Encrypted: i=1; AJvYcCWPQ7JdRGEQzrYtaaPWwZKh7JY4axLOn90xZ4Or3lbT9qQ0BsCvqXG30HVnyT39t7ufvrdF1mawfzA=@vger.kernel.org
X-Gm-Message-State: AOJu0Yy/V7ZnmJkCL40Vec3fMZJbxwS49BgDvuGzYlJq0UwjtgalTcKQ
	hn8hw2W7hSKL6BxxemKsUhhN5cZI5W1jpRd1cDeJfDaXQtIWs3/8MQKicGJpeU8=
X-Gm-Gg: ASbGncuzWOKDefbXHG8JxlNSZ9OxTISpkz96mNdcJ/4XezIyQLwqYXQ/E/drNWtQM2c
	OuQAtmnwkj3bZWhxVIRQQlBB5ynHwBgUirZJqicFbyvJDrSNhdAIctT941RR8GH4QniFrLeq9jU
	gYDI1jTqQmJMP4WJx06+sLFKtqHZ1Oz1+LuEdLHRg66O6mr2A6g62SMWRK9oNDiIBUKlbDYXQye
	dwVsJ3EgEP5UMnxf/SV3SLN5uRNS+C+FsnJ66JmOKKlSxuAtOW1lF2ZAE+S1svJ
X-Google-Smtp-Source: AGHT+IHwbSBUELCWH88to3eKbIbKFQlIGmiEO20KuDJPlMSg8m7xY1XIjb3s2ATL2I5p1b8aOzoeHQ==
X-Received: by 2002:a05:620a:4551:b0:7b6:6c46:55b with SMTP id af79cd13be357-7b9ba6efbbamr4034804785a.7.1735244363986;
        Thu, 26 Dec 2024 12:19:23 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F ([184.169.45.4])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7b9ac2d1054sm648499485a.32.2024.12.26.12.19.16
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 26 Dec 2024 12:19:23 -0800 (PST)
Date: Thu, 26 Dec 2024 13:19:08 -0700
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: [LSF/MM] Linux management of volatile CXL memory devices - boot to
 bash.
Message-ID: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Status: RO
Content-Length: 2097
Lines: 49

I'd like to propose a discussion about the variety of CXL configuration
decisions made by platforms, BIOS, EFI, and linux that have created a
complex, and sometimes subtly confusing administration environment.

In particular, when and how memory configuration occurs have major
implications for major feature support (interleave, ras, hotplug, etc).

For example, treating CXL memory as "conventional" without marking is
"special purpose" may limit the applicability of certain RAS features -
but even marking it "special purpose" may be insufficient for 
(coordinated) device hotplug compatibility.

Another example, RAS features like POISON have different end-state
implications (full system crash vs userland crash) that depend on
whether the memory was being used by kernel or userland (which is
actually somewhat controllable, and therefore useful for
administrators!)

Some of this complexity stems from interleave settings and how CXL
memory is distributed among NUMA nodes (1 per device, 1 per homogeneous
set, or a single heterogeneous numa node).

Specifically we'll talk about
  - iomem resource allocation
    - EFI_CONVENTIONAL_MEMORY, MEMORY_SP, and CONFIG_EFI_SOFT_RESERVE
    - e820 & EFI mmemory map inclusion
    - driver-time allocation
    - hotplug implications
  - Addressing
    - SPA == HPA vs SPA != HPA
    - Boot-time configuration vs Driver Configuration
  - Interleave configuration
    - Platform configuration vs Driver configuration
    - PRMT-provided translation
    - RAS feature implications
    - Management implications (hotplug, teardown, etc)
  - Linux Memory (Block) Hotplug
    - auto-online vs user-policy
    - systemd / typical user story
    - Zone-assignment and Poison
    
I'd like to lay out (as best I can, with help!) the current environment in
linux kernel, the "maintenance implications" of certain configurations
decisions, and discuss where ambiguities are present / challenging.

I'll add some additional follow-on emails that break down some of these
scenarios more in-depth over the next few months for some background reading.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f170.google.com (mail-qk1-f170.google.com [209.85.222.170])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1D03D25A65D
	for <linux-cxl@vger.kernel.org>; Wed,  5 Feb 2025 02:17:13 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.170
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1738721836; cv=none; b=GNe2N1MF8Lh0015rRFBNfTIcH613nJgsB70W3Nf7/QpwCfKVyRDvsU3u9O7lSKnoJm264bCaOPEbhFRJqfVq2pqwP85seSiP6EYkQR99fDxvNLfksWmAv62KvP7/LU/6QfQh39rTltjN/vZbiVuLPsdwX6paQn7lVK1aL0LpJOE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1738721836; c=relaxed/simple;
	bh=CPlLUYXLI0IgQ1H+q1v8VNFC/v8ZG5uQkGMq9h6f9tk=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=oaVVKMcZwDLq0vm1AULkis7Hog6xilg8s1wi/wGlk/rcNkrZBcUdY1pxFwjWnvT79P6YVp/KPK82GnrAQmqCy689xflJYRIUeMiRGIcJp9asa0AnhXj3v9Ae73TDdt8AXAez/eUCxLNQF4sbBA1IZEH2r4Ccd3IDWY8M1N6fhO8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=Wog+RfI2; arc=none smtp.client-ip=209.85.222.170
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="Wog+RfI2"
Received: by mail-qk1-f170.google.com with SMTP id af79cd13be357-7b6f19a6c04so586051785a.0
        for <linux-cxl@vger.kernel.org>; Tue, 04 Feb 2025 18:17:13 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1738721833; x=1739326633; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=gQ4wMumQZupZLc/dhljQZvdj84cqZT9CeaohEOD51F8=;
        b=Wog+RfI2ROXqxVW4hl/py6mW+e/CIBrOu23kIytFdw9QbX7xFmxLEDGuWkuCMdOMLX
         wHvc2P8kHqGCMfVnHfEHOqna0RKceYQLMN9el3qDaY6Pq2soPzZf0O3aUlUfbO0mhxND
         40tnLWpDxl9bU500e8d+T2uC275RpP2qsAbNrA3SyKKXp7Uwk/8RKge6GYDopWKRQ1xd
         dBefFlYbUGEuhw3E73/jRu/dPfsAXzzUyedmCm2j6XMVtKTOexfTOynjzoLV1C4Hh9v0
         JD8eL36XtOQR3ruUXU4ATgddjeEy3l/+ATMVxlLQqCuOYuHsrscd/zcm4lgaZLs/ZvnH
         ZDIg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1738721833; x=1739326633;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=gQ4wMumQZupZLc/dhljQZvdj84cqZT9CeaohEOD51F8=;
        b=OjlyxF2GpNQBnnFdH2Du6jRf3MWYV+2zPuKlmfsuTM2fg0Ss01ddwYQf8i4ZrIFsWQ
         eq6M4TNcZmpNWVxFyOu69Ijt8748+aiASorAcwvJRc9XQuK2VkADNcSVMmtoP/xI4Ngx
         JqLhpt2D1kjJYWVfrP2WSB7Vs/u6iasFydc4KX7435Ehd/7CI2Cwq1LeGqcMq8lVksP+
         fMUddJgson7cGWE/nkVxg6gSfebT+Mz75vq0/auZKFMeqih+QT9eRV35oqtYyl2i2od5
         mZz9dyJk93DqVZ7AmPCILwA/8EIavMvlnlL+JoiTsGD8TtJ59gDNqi+OCuX6iuBAWjZB
         1JoA==
X-Forwarded-Encrypted: i=1; AJvYcCVShDpKgv0NpbxPsFOOiZkF3/wCqY/tILD0G1WLYn445hDD4nnFyCPKz0XgjqE+XCWa1xjEPM4wb+g=@vger.kernel.org
X-Gm-Message-State: AOJu0Yzx0NXVprdYilaeN/lJrkKnrT22OFoj8CvCWgFEKDHVRyytAqor
	akOlLhCASmTTXXu9Y/BLdh/v2F1GBp1MelcMPxddxibUnWOXIR5RZUNnqBKjX3zrO+awbHYN/br
	1
X-Gm-Gg: ASbGncuamxooVAHKDjWn9XBjmTZ5E+MNPcRECIhmAF7IwdSwByKPladprKNy6z0P56n
	bQUBpQ3sq8zc2NvH+z0HnNUxs/Smb1Hfz6zaQ/AnZKYMP4pfVkbGVeUFnbCqwtht2AukwKGav24
	/vY0Lr8FLxGogm5v1L+phxaDaDPdoFTN0zbsl7ldCCZrZvw4/XMPK6DOn3Vnl2JQA3fQuNfRzg8
	On1sn+Pu8Fma+sIFhoVstafG/HEGoAZSXlAlI7j5Bsjxb6XTxl8pTFcVvoA6V93IqRBcT0qmzfs
	bft5Kk8rOKyZP+uYyna9uO8HLR7aDMK0NyhJL1U3/Elw4EJqzVSIFo0ErKAT7FqxtNhB89hFaQ=
	=
X-Google-Smtp-Source: AGHT+IGcCYeEGXr7ma2IdlwziuxtLLKn8PauDO/TRhblgjJ2/h/K5GKeyVVeyaZAXnakq4YCgficbw==
X-Received: by 2002:ad4:5f45:0:b0:6e4:227b:c2b0 with SMTP id 6a1803df08f44-6e42fbef82cmr19007526d6.22.1738721832796;
        Tue, 04 Feb 2025 18:17:12 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e254814007sm68655186d6.34.2025.02.04.18.17.11
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Feb 2025 18:17:11 -0800 (PST)
Date: Tue, 4 Feb 2025 21:17:09 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early Boot
Message-ID: <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 5823
Lines: 140


Tossing this out as larger documentation of these steps for comment,
not as a representation of what will show up in the talk.

This is trying to cover the minimum needed information to start
reasoning about the growing complexity of configurations.


Platform / BIOS / EFI Configuraiton
===================================
---------------------------------------
Step 1: BIOS-time hardware programming.
---------------------------------------

I don't want to focus on platform specifics, so really all you need
to know about this phase for the purpose of MM is that platforms may
program the CXL device heirarchy and lock the configuration.

In practice it means you probably can't reconfigure things after boot
without doing major teardowns of the devices and resetting them -
assuming the platform doesn't have major quirks that prevent this.

This has implications for Hotplug, Interleave, and RAS, but we'll
cover those explicitly elsewhere. Otherwise, if something gets mucked
up at this stage - complain to your platform / hardware vendor.


------------------------------------------------------------------
Step 2: BIOS / EFI generates the CEDT (CXL Early Detection Table).
------------------------------------------------------------------

This table is responsible for reporting each "CXL Host Bridge" and
"CXL Fixed Memory Window" present at boot - which enables early boot
software to manage those devices and the memory capacity presented
by those devices.

Example CEDT Entries (truncated) 
         Subtable Type : 00 [CXL Host Bridge Structure]
              Reserved : 00
                Length : 0020
Associated host bridge : 00000005

         Subtable Type : 01 [CXL Fixed Memory Window Structure]
              Reserved : 00
                Length : 002C
              Reserved : 00000000
   Window base address : 000000C050000000
           Window size : 0000003CA0000000

If this memory is NOT marked "Special Purpose" by BIOS (next section),
you should find a matching entry EFI Memory Map and /proc/iomem

BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] usable
/proc/iomem: c050000000-fcefffffff : System RAM


Observation: This memory is treated as 100% normal System RAM

   1) This memory may be placed in any zone (ZONE_NORMAL, typically)
   2) The kernel may use this memory for arbitrary allocations
   4) The driver still enumerates CXL devices and memory regions, but
   3) The CXL driver CANNOT manage this memory (as of today)
      (Caveat: *some* RAS features may still work, possibly)

This creates an nuanced management state.

The memory is online by default and completely usable, AND the driver
appears to be managing the devices - BUT the memory resources and the
management structure are fundamentally separate.
   1) CXL Driver manages CXL features
   2) Non-CXL SystemRAM mechanisms surface the memory to allocators.


---------------------------------------------------------------
Step 3: EFI_MEMORY_SP - Deferring Management to the CXL Driver.
---------------------------------------------------------------

Assuming you DON'T want CXL memory to default to SystemRAM and prefer
NOT to have your kernel allocate arbitrary resources on CXL, you
probably want to defer managing these memory regions to the CXL driver.

The mechanism for is setting EFI_MEMORY_SP bit on CXL memory in BIOS.
This will mark the memory "Special Purpose".

Doing this will result in your memory being marked "Soft Reserved" on
x86 and ARM (presently unknown on other architectures).

You will see Memory Map and iomem entries like so:

BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] soft reserved
/proc/iomem: c050000000-fcefffffff : Soft Reserved

Unless of course:
  1) CONFIG_EFI_SOFT_RESERVE=n in your build config, or
  2) You set the nosoftreserve boot parameter
  3) You kexec'd from a kernel where conditions #1 or #2 are met

In which case you'll get SystemRAM as if EFI_MEMORY_SP was never set.
(#3 was fun to debug, for some definition of fun. Ask me over coffee)

------------------------------------------------------------
First bit of nuanced complexity: Early-Boot Resource Re-use.
------------------------------------------------------------
How are MemoryMap resources managed by a driver after being reserved
during early boot? Example: Hot-(un)plugging a device.

What if we replace said Hot-unplugged device with a device with a new
capacity?  What if the arch/platform code combines two adjacent
regions with similar attributes before creating resources?

Recent work by Nathan Fontenot [1] has been looking to try to address
some of the issues with these Soft Reserved resources and either re-using them
or handing them off entirely to the relative driver for management.

[1] https://lore.kernel.org/linux-cxl/cover.1737046620.git.nathan.fontenot@amd.com/


--------------------------------------------------------------------
The Complexity story up til now (what's likely to show up in slides)
--------------------------------------------------------------------

Platform and BIOS:
   May configure all the devices prior to kernel hand-off.
   May or may not support reconfiguring / hotplug.
BIOS and EFI:
   EFI_MEMORY_SP              - used to defer management to drivers
Kernel Build and Boot:
   CONFIG_EFI_SOFT_RESERVE=n  - Will always result in CXL as SystemRAM
   nosoftreserve              - Will always result in CXL as SystemRAM
   kexec                      - SystemRAM configs carry over to target


--------------------------------------------------------------------
Next Up:
   Driver Management - Decoders, HPA/SPA, DAX, and RAS.
   Memory (Block) Hotplug - Zones, Auto-Online, and User Policy.
   RAS - Poison, MCE, and why you probably want CXL=ZONE_MOVABLE.
   Interleave - RAS and Region Management (Hotplug-ability) 

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f175.google.com (mail-qt1-f175.google.com [209.85.160.175])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1CBC3191493
	for <linux-cxl@vger.kernel.org>; Wed,  5 Feb 2025 16:06:11 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.175
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1738771574; cv=none; b=kTmgmqAVHazlBciqLB5i47wp1JAkViRqRMEbp3+GhP1/cpELBdjWh5jXVYdH5lmj8druyHp2zPnf9hoZeB/+Wlvr031et1D+2BwY/SdzHloY4N03ESG0WZoBlnIQD3Pxa7CuCXtircvIo3atpU3PVDzsoyJRgvP3AXXfy2E1ihM=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1738771574; c=relaxed/simple;
	bh=2k4OIvFwpgDmPtngF7PHhclVO299hl+2a0vTG+sO5pk=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=jzOwxqwjERxEEaJeDoNU4TzHf/Idq24IBl858uwK4J7p7Xa9/4wrCmhP9X7NEF3xcSyuHfLuczETWrN9mviVlJnBUb1MS+nxQdNpv2wvMk6lYBVTHwMtOIu+4OUPmZ5HQJE/1faTXfCjDlYtu8ZQQoplqYFXROvCrEQ9b4+3Hoc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=VIGEFECV; arc=none smtp.client-ip=209.85.160.175
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="VIGEFECV"
Received: by mail-qt1-f175.google.com with SMTP id d75a77b69052e-467a3c85e11so43262601cf.2
        for <linux-cxl@vger.kernel.org>; Wed, 05 Feb 2025 08:06:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1738771571; x=1739376371; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=8RtR+/2+vJwWC8LPRbdeCn1fr1KijuWFk6Bt2w0eRwc=;
        b=VIGEFECV+wd0tF7Qhfi3ZZzP7lxkSsI2+uhC9rXa/SNAaSEpjWuEZdgPS+MG1ZBxfA
         1gNvaNirNWh0UyQZvFHLqtf0lgX4XZGXW+V/631r7gK1fiuthNzMytiC62ME0L5Tur17
         IOEiIerRvRMk5hcyD1mHO8iOjYOh++X2jshJbfj44WTAeykxrkBqNrAsCu3WNstwC61B
         iiD4Jw79jPHqwbamgC4SAUhj5b6XdrjJLmwiJeliwpoyxyZ1wOOPfnV4ZB3j8qKevgEt
         37a17ptQR19XH5iWls6kEH9tx7h5QFC2IYlNvljeAOjsonjcGp7y93mIWgXuvIZ1MXyJ
         tCjQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1738771571; x=1739376371;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=8RtR+/2+vJwWC8LPRbdeCn1fr1KijuWFk6Bt2w0eRwc=;
        b=fkT5Yz/xFASlJMkTlUEaCsGSA/GS2xG8A/qyZN/LDze1LdGCR29RPVccWifg0M8Z23
         rZdgZVTGsGfVltvlFdGb9PkqmMhpUZrneF6A2rrmfhUtcJXr88rkv0hgIGg0QmltYPsJ
         +lrEphJFzAuyFB95JYPbtAlv8X4ZPUq1zCOi9gWkUcybd9GFW6c4TslDoDXfyCw2E0ht
         M7Zks1Lj96Gqutq7OALCBGSpywpJWgZG+IEeDoLVM7GWbQ3jVMjtsRkEF/QRPG2woSWV
         hGlQVgUrB2qCOVS70b/Ebt15moVo2CJCd2iV7/209NeQIsij/lkuf3P7QH3L0Ccl6T1x
         Ryhw==
X-Forwarded-Encrypted: i=1; AJvYcCVoNuc3zYsc5kD2A5iLJ8/SaWfCSKNgQUv96swfz5tA0k3wt9v2+my8330vV2Gfbi51+Zumlusa6bI=@vger.kernel.org
X-Gm-Message-State: AOJu0YyV8iuQCtjKxlmDSG7sdYljHadO5KYh1E2RK6aZ7wfm4RXRnbjG
	dkygoxY6Sp/LS6FCqGzDFXrwnEvcyXsWqT06X8N9F9uZAGNIPbXasSq0H4Gobso=
X-Gm-Gg: ASbGnctRx7tDoSwfvY/rQd5MvCIpvQQ9Lk70aFxJmZthyuAyJq3GUa0wcsHqqnpCtiZ
	w6y+22z4zJEXurbNIGCJPCOUktPod2NMvIfFgdKghlu/k7ssM1JWhX9Q/UohRwGCM+ufpOaaIVf
	nDNHaNk4uVRqiyncaifa2U4vXhtSW594IcOT1W/tQ7b1QQ5sWNtbPopsCP5XAkEE/UGlMtNeYW3
	JvZZA3gtjpkH+M+z6f4Ay96lTt2+BIyAEo2HtXqrDac72TJ1s9fO6j1Y4iKZghYUt/i6FpAmBSx
	T11uR9tee8kS7zcqsPJ4mYYchwJxFxzpP7nosiFZe60mCnGkhPPk1VQH4PwOhnGHfuOPO8zUoQ=
	=
X-Google-Smtp-Source: AGHT+IFgnrB6Xi1DmmsezS76vJs01fy6PDZJgZsh76Mfnx4A8g6iZOvyt772etAwkiXourOCWwc8QQ==
X-Received: by 2002:a05:622a:199b:b0:467:6901:7589 with SMTP id d75a77b69052e-470281d0e07mr38522361cf.29.1738771570680;
        Wed, 05 Feb 2025 08:06:10 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-46fdf0a768bsm71859021cf.7.2025.02.05.08.06.10
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Feb 2025 08:06:10 -0800 (PST)
Date: Wed, 5 Feb 2025 11:06:08 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: CXL Boot to Bash - Section 2: The Drivers
Message-ID: <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 8409
Lines: 236

(background reading as we build up complexity)

Driver Management - Decoders, HPA/SPA, DAX, and RAS.

The Drivers
===========
----------------------
The Story Up 'til Now.
----------------------

When we left the Platform arena, assuming we've configured with special
purpose memory, we are left with an entry in the memory map like so:

BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] soft reserved
/proc/iomem: c050000000-fcefffffff : Soft Reserved

This resource (see mm/resource.c) is left unused until a driver comes
along to actually surface it to allocators (or some other interface).

In our case, the drivers involved (or at least the ones we'll reference)

drivers/base/     : device probing, memory (block) hotplug
drivers/acpi/     : device hotplug
drivers/acpi/numa : NUMA ACPI table info (SRAT, CEDT, HMAT, ...)
drivers/pci/      : PCI device probing
drivers/cxl/      : CXL device probing
drivers/dax/      : cxl device to memory resource association

We don't necessarily care about the specifics of each driver, we'll
focus on just the aspects that ultimately affect memory management.

-------------------------------
Step 4: Basic build complexity.
-------------------------------
To make a long story short:

CXL Build Configurations:
  CONFIG_CXL_ACPI
  CONFIG_CXL_BUS
  CONFIG_CXL_MEM
  CONFIG_CXL_PCI
  CONFIG_CXL_PORT
  CONFIG_CXL_REGION

DAX Build Configurations:
  CONFIG_DEV_DAX
  CONFIG_DEV_DAX_CXL
  CONFIG_DEV_DAX_KMEM

Without all of these enabled, your journey will end up cut short because
some piece of the probe process will stop progressing.

The most common misconfiguration I run into is CONFIG_DEV_DAX_CXL not
being enabled. You end up with memory regions without dax devices.

[/sys/bus/cxl/devices]# ls
dax_region0  decoder0.0  decoder1.0  decoder2.0 .....
dax_region1  decoder0.1  decoder1.1  decoder3.0 .....

^^^ These dax regions require `CONFIG_DEV_DAX_CXL` enabled to fully
surface as dax devices, which can then be converted to system ram.


---------------------------------------------------------------
Step 5: The CXL driver associating devices and iomem resources.
---------------------------------------------------------------

The CXL driver wires up the following devices:
   root        :  CXL root
   portN       :  An intermediate or endpoint destination for accesses
   memN        :  memory devices


Each device in the heirarchy may have one or more decoders
   decoderN.M  :  Address routing and translation devices


The driver will also create additional objects and associations
   regionN     :  device-to-iomem resource mapping
   dax_regionN :  region-to-dax device mapping


Most associations built by the driver are done by validating decoders
against each other at each point in the heirarchy.

  Root decoders describe memory regions and route DMA to ports.
  Intermediate decoders route DMA through CXL fabric.
  Endpoint decoders translate addresses (Host to device).


A Root port has 1 decoder per associated CFMW in the CEDT
   decoder0.0  ->  `c050000000-fcefffffff   : Soft Reserved`


A region (iomem resource mapping) can be created for these decoders
   [/sys/bus/cxl/devices/region0]# cat resource size target0
      0xc050000000   0x3ca0000000   decoder5.0


A dax_region surfaces these regions as a dax device
   [/sys/bus/cxl/devices/dax_region0/dax0.0]# cat resource
      0xc050000000


So in a simple environment with 1 device, we end up with a mapping
that looks something like this.

     root      ---   decoder0.0  --- region0 -- dax_region0 -- dax0
       |                |              |
     port1     ---   decoder1.0        |
       |                |              |
     endpoint0 ---   decoder3.0--------/


Much of the complexity in region creation stems from validating decoder
programming and associating regions with targets (endpoint decoders).

The take-away from this section is the existence of "decoders", of which
there may be an arbitrary number between the root and endpoint.

This will be relevant when we talk about RAS (Poison) and Interleave.


---------------------------------------------------------------
Step 6: DAX surfacing Memory Blocks - First bit of User Policy.
---------------------------------------------------------------

The last step in surfacing memory to allocators is to convert a dax
device into memory blocks. On most default kernel builds, dax devices
are not automatically converted to SystemRAM.

Policy Choices
   userland policy:  daxctl
   default-online :  CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE
                     or
		     CONFIG_MHP_DEFAULT_ONLINE_TYPE_*
		     or
		     memhp_default_state=*

To convert a dax device to SystemRAM utilizing daxctl:

  daxctl online-memory dax0.0 [--no-movable]

  By default the memory will online into ZONE_MOVABLE
  The --no-movable option will online the memory in ZONE_NORMAL


Alternatively, this can be done at Build or Boot time using
  CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE   (v6.13 or below)
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_*       (v6.14 or above)
  memhp_default_state=*                  (boot param predating cxl)

I will save the discussion of ZONE selection to the next section,
which will cover more memory-hotplug specifics.

At this point, the memory blocks are exposed to the kernel mm allocators
and may be used as normal System RAM.


---------------------------------------------------------
Second bit of nuanced complexity: Memory Block Alignment.
---------------------------------------------------------
In section 1, we introduced CEDT / CFMW and how they map to iomem
resources.  In this section we discussed out we surface memory blocks
to the kernel allocators.

However, at no time did platform, arch code, and driver communicate
about the expected size of a memory block. In most cases, the size
of a memory block is defined by the architecture - unaware of CXL.

On x86, for example, the heuristic for memory block size is:
   1) user boot-arg value
   2) Maximize size (up to 2GB) if operating on bare metal
   3) Use smallest value that aligns with the end of memory

The problem is that [SOFT RESERVED] memory is not considered in the
alignment calculation - and not all [SOFT RESERVED] memory *should*
be considered for alignment.

In the case of our working example (real system, btw):

         Subtable Type : 01 [CXL Fixed Memory Window Structure]
   Window base address : 000000C050000000
           Window size : 0000003CA0000000

The base is 256MB aligned (the minimum for the CXL Spec), and the
window size is 512MB.  This results in a loss of almost a full memory
block worth of memory (~1280MB on the front, and ~512MB on the back).

This is a loss of ~0.7% of capacity (1.5GB) for that region (121.25GB).

[1] has been proposed to allow for drivers (specifically ACPI) to advise
the memory hotplug system on the suggested alignment, and for arch code
to choose how to utilize this advisement.

[1] https://lore.kernel.org/linux-mm/20250127153405.3379117-1-gourry@gourry.net/


--------------------------------------------------------------------
The Complexity story up til now (what's likely to show up in slides)
--------------------------------------------------------------------
Platform and BIOS:
  May configure all the devices prior to kernel hand-off.
  May or may not support reconfiguring / hotplug.
BIOS and EFI:
  EFI_MEMORY_SP              - used to defer management to drivers
Kernel Build and Boot:
  CONFIG_EFI_SOFT_RESERVE=n  - Will always result in CXL as SystemRAM
  nosoftreserve              - Will always result in CXL as SystemRAM
  kexec                      - SystemRAM configs carry over to target
Driver Build Options Required
  CONFIG_CXL_ACPI
  CONFIG_CXL_BUS
  CONFIG_CXL_MEM
  CONFIG_CXL_PCI
  CONFIG_CXL_PORT
  CONFIG_CXL_REGION
  CONFIG_DEV_DAX
  CONFIG_DEV_DAX_CXL
  CONFIG_DEV_DAX_KMEM
User Policy
  CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE (<=v6.13)
  CONFIG_MHP_DEFAULT_ONLINE_TYPE       (>=v6.14)
  memhp_default_state                  (boot param)
  daxctl online-memory daxN.Y          (userland)
Nuances
  Early-boot resource re-use
  Memory Block Alignment

--------------------------------------------------------------------
Next Up:
   Memory (Block) Hotplug - Zones and Kernel Use of CXL
   RAS - Poison, MCE, and why you probably want CXL=ZONE_MOVABLE
   Interleave - RAS and Region Management (Hotplug-ability)

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.8])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5A71B291E;
	Thu,  6 Feb 2025 00:47:51 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.8
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1738802874; cv=fail; b=rR/vMOJa+hv9qtXcsd8ToloBn43VK2fGiUOvSjr/QMU+ADAyMaVp0Oc2ZeueIvKUVFFVUz0HoGujfsTGRowJWLRVY2UPJe5MqyDzQkNEyrGwJvAnheu0UixeP+4rpWxWorJNl1gECDrwfpr2diTx+ncGWor6hU7SFOE7v8yluCY=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1738802874; c=relaxed/simple;
	bh=BfW3FvDKK0YBR489RYl5kO8JnFWLELyTAVsqbJkKx4A=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=p9K+AnNfesTRGDuE7y34eu0eF8vNEuAOZHI2Q/aOZ/oEitr2WcjJN75nmcc4AbBKUiSZenM9kpaxtVTU8LCavdDLH7goFYJQzC69bBxpzpSbAj8B148dpwLXZifYgg/lkVtZJJ8zrmqFV64BSOVaEeoPNkt/CEQwipfVf1M9GuE=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=gHndyp1M; arc=fail smtp.client-ip=192.198.163.8
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="gHndyp1M"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1738802871; x=1770338871;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=BfW3FvDKK0YBR489RYl5kO8JnFWLELyTAVsqbJkKx4A=;
  b=gHndyp1Mkclse48YIHVxRrWAzrRRrcplKSkoWAIS22UpamdDQOVT2oDv
   ditQmQcPjJ6LJ27vzWcBlXu9u9enkpyf1MtAVkap1ueX8yhdggstoDPSF
   gvG98zWFznFVAfLvBEtathQo5/yP3RY0NFpsJD79Dm6eof9hncMnmTm+t
   SG/4o5bTo/C6Q/ogIaNThKJcXsAO1iEwiIyHA5z6GpBYdgz61nA8kyyE9
   MMukZL6OHAb9DCeFypy2rpy+AfU6nc/jt2iIn2WE32sCUUjVZug/TAw1z
   e2hNOknJZGohMUcPZQCLjcpl6Qp8ZComxPJVQfj2hsgBaJb0X3QmOIwDR
   Q==;
X-CSE-ConnectionGUID: ulJ6ggwhS3KvtZD/+B6H8g==
X-CSE-MsgGUID: 2W4UHn4qTuaewl02HQkB9w==
X-IronPort-AV: E=McAfee;i="6700,10204,11336"; a="56938731"
X-IronPort-AV: E=Sophos;i="6.13,263,1732608000"; 
   d="scan'208";a="56938731"
Received: from fmviesa006.fm.intel.com ([10.60.135.146])
  by fmvoesa102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Feb 2025 16:47:50 -0800
X-CSE-ConnectionGUID: 81SqMDxySW+NiVKChoVdLA==
X-CSE-MsgGUID: ITl8rUUIQYCRiEbN9FvjFg==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.13,263,1732608000"; 
   d="scan'208";a="110895100"
Received: from orsmsx601.amr.corp.intel.com ([10.22.229.14])
  by fmviesa006.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 05 Feb 2025 16:47:50 -0800
Received: from orsmsx601.amr.corp.intel.com (10.22.229.14) by
 ORSMSX601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.44; Wed, 5 Feb 2025 16:47:49 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.44 via Frontend Transport; Wed, 5 Feb 2025 16:47:49 -0800
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (104.47.55.46) by
 edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.44; Wed, 5 Feb 2025 16:47:48 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=JMHk/FrPjv0UvCi36R55ZUk03Swyj/DVGHs89CpJED05iTvr7zWmy36SOSgcaxD1QxIYTFTUXBgXRTMVRSn5i7X/CqqHWmHqMdBinzbyZEzauJmsVZxWb1pV3T980NrlQ9iWIMvXdyjW+ZwHVTwQQ8FT7Vr29/8yL4qeppXginms0Q90qybnuXldn9/HHsaJc+9YEEXQaxtj6cVwk+9yMUQhaVhb3F7LMbwFDZM0XJkUhGOOZDmY16pcc9MWhBgReBOxTI362APfGDC14IQlfBPu7ydOvWvGq7LYeh4qfo/xFYnKxpygtcj+QdfqubzUWM9alBcEc+q/RE1PYkqj7Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3n1eOhQi+x7f43UNRZUZWnvsqTCCDXUpQyHZ1/TlE18=;
 b=cHN/xmPTVkVH8RLh2F/n3Yna8IJy0KvDb4jqY6vIhg+FXn4PrTh1jr91E56VTqMnbPPwswLy+wLYogHwSKJHfw58LpA4kYP+1OLN9mTyEQNlUFgihkbjbKD2JPfA4ggC1WrCxCugErZ3Iu/DaC2eWP5wEKqv3wOqXVA5AqMc5uiMEk7atcP1Td3ZS323LFeXUGLFlhVyJW59X/LPJjj5ZtPPuQ/l5MYpQ/If7D+GdV4mqwUq8DkYKhA8vN1ztLI20+cgROpNIxoSn/R0oQ935AItf24O/UBpUXz4pvvOmBqR27wE+01Wj8wY8CX5CGIyhkx7wPqKUwiIuoWuYTsRBg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by LV8PR11MB8747.namprd11.prod.outlook.com (2603:10b6:408:206::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8422.10; Thu, 6 Feb
 2025 00:47:20 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%4]) with mapi id 15.20.8398.025; Thu, 6 Feb 2025
 00:47:19 +0000
Date: Wed, 5 Feb 2025 16:47:17 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Gregory Price <gourry@gourry.net>, <lsf-pc@lists.linux-foundation.org>
CC: <linux-mm@kvack.org>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>
Subject: Re: CXL Boot to Bash - Section 2: The Drivers
Message-ID: <67a4069572eab_2d2c294d4@dwillia2-xfh.jf.intel.com.notmuch>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
X-ClientProxiedBy: MW4PR03CA0197.namprd03.prod.outlook.com
 (2603:10b6:303:b8::22) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|LV8PR11MB8747:EE_
X-MS-Office365-Filtering-Correlation-Id: 3fc2e568-a5b0-4f7d-ff54-08dd4647cfa0
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|366016|1800799024;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?ctXTIr99x5UsHY5ONXNYy6Vm1dZQzVPhaAmRiQThd6kKTh85GyVBwnTmg7vg?=
 =?us-ascii?Q?/4I+WD66eg7weLpIj4RlRtevTytosrIpUClJlIapKKgOdU201wx5R9joJEeA?=
 =?us-ascii?Q?JXh1dZjI5n/7ZzDWdNoules1xFVaIbl2+evLEboY/WyjfcJPpN8p3wjX+ymo?=
 =?us-ascii?Q?z4OY9bdKaFP2B8D36bAUpab4sDLwCvUZwU1vNLZKtGzcMBoOOcLNLZrCzIdZ?=
 =?us-ascii?Q?Ir6BZtldBY8U3QS4d+F7M3FVwG7vZazwhDDjumk3Y/nhFgzyZiUU2UCBYZbg?=
 =?us-ascii?Q?ip8Prs8uuWSOKlekmmjx6MnroxsU4UsAUmrVh5QORW1KqKX8BwRehhEOMc/0?=
 =?us-ascii?Q?nD+RFyalvlegy3+CHaGKs1Ys/Tl9OHHHYr15q/hrQ9Aj6jM/RA2HAEXQxdYm?=
 =?us-ascii?Q?Qlt61K9Wc8FlbAx7WlBIsjwEz292/14ZYgOlvx1wt3EbYGj7Y15CRy+uL8Fk?=
 =?us-ascii?Q?AAdO9qJOrk7Leb0VnXDk9fVRylfLCI1TrHKK51RvCz6a6A8CMPZId+Ji5NqP?=
 =?us-ascii?Q?X+qlft2+G4KhBoSl4BShNdFtpDRkCO4xL/xU6dvwEXMOt8fWh6k+289ICrab?=
 =?us-ascii?Q?mHKcv0PriCllO+aYme0zJVlCw8z9QgT9yxF3DGYUTTTn4V0+sTs/IvGpNSyw?=
 =?us-ascii?Q?bCGfEtlniCzOlrwkIXrhQmlIlRhNE4VTvZ0XUIGsKkUJuvfJ1PZ+DDV2Nu0I?=
 =?us-ascii?Q?mGyLco6/Ib+UwsZslcd2uKA/d2pplisfWJ9yn6ge08zgzPIkuTZVz/ErqtF3?=
 =?us-ascii?Q?smRbUCf1+APbXHfvNanfL74Ll507/U49LDXTKJPEW+DLSlrIbINDBMoDiz4c?=
 =?us-ascii?Q?lh6ljHQP7RRgBrmOOVAegJYYLYu6Z1p1FkHr+a7+sXMiXQWF6EiI8IZ7sfCe?=
 =?us-ascii?Q?c9UqZgjuEi4fsRbqa3xa+TOjEyfceimlxuki3OiGGP1DBv0Hhj+eeZsPmKRa?=
 =?us-ascii?Q?KMlFxgq28uSpftmTGBjThjwWFIs7szkCnZ4GmQRVHjhctElAf+n1IwF8cdZd?=
 =?us-ascii?Q?Yq8CNC2yuIrRr2/BRc5c4L+UQ3e1jBL0iFPasJdfV1PNi2x4oddl5eEaJ3Ii?=
 =?us-ascii?Q?JYifT+elQpaWNZuWdoJIxMi5hqnMJYezlaIy2I335pMDPjCmLOBg0ny92j1i?=
 =?us-ascii?Q?6rFK9PJzAL5+xdprhSO91/5B0NaxsJhRs3qAbPY/rg2Rd8cyN7uZMRU7Sq8N?=
 =?us-ascii?Q?HHPDwG3B/7lKmVLF7JSUWc3WmOR3398uJbGg/B/D6Y8BUC8nzwdVmYoLrJsK?=
 =?us-ascii?Q?mDp9eqWkFcnzuyqkLeM8gfPgcN3FJ6Ew75OUNlX4JLAFCc16RSE2uSGdEXM5?=
 =?us-ascii?Q?gJuY/aDC0T5Nmh+9RA+xafGw4bcsvD1PTfvUD9urY/cgKg=3D=3D?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(366016)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?fKeL3Gulu3ZQJsCy7EaRzcNg0HiG5NzcnbJW650f7KaUzlq3KDNwXX2tCKNo?=
 =?us-ascii?Q?WmjPXzBuimYAgnBEErFGqLzP1oINtcJ8YtS8Ds0zqhf1QhfogONY9iO9XmpF?=
 =?us-ascii?Q?1K3dVH7sEm7bnTgCnekw5cdWNQdCC5MU3NGsmePRJoQWXry6vsygnFUvkkXQ?=
 =?us-ascii?Q?Q/twgQVoc7IT+Stat7eFp0edfILitzDQ7vXhcmto3iJeNvtxkNw40kFBNur8?=
 =?us-ascii?Q?pgCUT4Tmh3ThCjWdvP/OeBWyna8oDesow5SFp/rHXamlaQMSxVBdD53pfEfH?=
 =?us-ascii?Q?sYXtzgH9yfNxVSQnG1eGU17wh7UT5LOOfPjQamTAngIFR7pKXIX1RNmqXWPS?=
 =?us-ascii?Q?BHO2Ng+vOY9dNlIdZ9eLTakzvRn3WxL+MzlKjJvkl2dUktdZoIQo7jQHw9CM?=
 =?us-ascii?Q?biQR2IOak9YqeSW2hrF2fMlgAWfuMPdN/EjbvIHDjwxef1CiSElTMfala1I7?=
 =?us-ascii?Q?1WOnCu046TPLlsJXRb6bnZaBppnpCD+plxjssSU3I+RB0FZQHUCl5R8dQKbI?=
 =?us-ascii?Q?DG1QkxDm0wc2PdHlfU7zdG8KJqFYr6Oigw62u8YLwYDFNonnIWMnQXar4ycm?=
 =?us-ascii?Q?LXF1P3QYyVu5qJowXEHpVEl4P4jRspdwAISJjqnpqCDawPMpWScXaTpPc6DP?=
 =?us-ascii?Q?oeIOSelC4cFpSij4zbQv2/gKvTHYIZEuXndgHi7vkXn6bfTOqeTPizqVMHx9?=
 =?us-ascii?Q?gNcd2CcsqXqRZE/8xi98jBc4WKfDhj6YrEe8tGRGPoVo/8rE3kEW9QaXfYLL?=
 =?us-ascii?Q?r5oxVKLdQoFelL2LICz6OW7mrbLAuBEYZtyM/KKMm7wyrroLcouQ1ORREyn4?=
 =?us-ascii?Q?x0KGw8ow1qyekKKMAv067mRFyrWBHdLzOOt+oN7CMIR2QwudgeVnkJ2qIGOW?=
 =?us-ascii?Q?ovdvUTCSEq4XMpUUToENn1RERm9wytZdSQQieyLnv+rAgnlbWNQpTXeMeb+H?=
 =?us-ascii?Q?/Ucah2yXJFwWpvEXdVJ7zmW5oojE9GUmrWeLqdrgymbFnJVJY4kcv6CzFqht?=
 =?us-ascii?Q?BK9bGaocpxTYLEPgRzJbCiC4qxNQNI2xU7sI7oB2uk5H+nlrPGSZ/EsibJ65?=
 =?us-ascii?Q?R0rFO1nmnYpamLxpt+ynHVKvbmgdMgpd9MpFIganx2W6ZkmmMaZFW487ecJ8?=
 =?us-ascii?Q?0nlYXf4q95sp4sGvbd0OTfVeVcFUn3cv4d1Fsb3R2r5OWatEQpT2VbwZ6DlL?=
 =?us-ascii?Q?hhP/VPkm8364TFcx+9OUf5PGj339qPB5SdI/krcf4/ytT61Xri8FhJvBWShY?=
 =?us-ascii?Q?r07ZBSVXZNApIXcusdi/++1c8gpFo4WUNIBsy2MFIwJwIVtegVv++QI3xVaI?=
 =?us-ascii?Q?M7SA75lSQMzweYC6Onqsn9lD4qsr0sDb7z/szm2cB9wJ9kz/jU7Z/fZ00oWp?=
 =?us-ascii?Q?WUArm97/Wld7XkUfSMBjqRQAKAzA+FSrh0OWYa4yigc6bM1oTn4Qqy6hYmwa?=
 =?us-ascii?Q?COj/l3GJs0CvP7fN/4lhmWfwmuykxgmVa5Vrjsj/EIxyH6fBtyDwdXDcbjHg?=
 =?us-ascii?Q?ExAH1xGGX6hwzuM4qJQv6VTIOVsbqq2QZplCpLzl4Tk07gZPPvzAcySsgkYh?=
 =?us-ascii?Q?yvzBCpr4hrBolbp7KDe1cylJhHrz53x0dTBkUxsaLJ+B3cZ8JTjyTQ/7uNCZ?=
 =?us-ascii?Q?Lg=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 3fc2e568-a5b0-4f7d-ff54-08dd4647cfa0
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 06 Feb 2025 00:47:19.8660
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: mTnNsj4l8eOuFhz5MkaC/4Nm+FTo+y+Kw8unsD83RP5bGOTIJPTOBS2sZU0QykorcqDzecKrQJuKT0zOGzcL/pOQ2qQQkR/mKOjJ3doKVUQ=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: LV8PR11MB8747
X-OriginatorOrg: intel.com
Status: O
Content-Length: 10484
Lines: 276

Gregory Price wrote:
> (background reading as we build up complexity)

Thanks for this taxonomy!

> 
> Driver Management - Decoders, HPA/SPA, DAX, and RAS.
> 
> The Drivers
> ===========
> ----------------------
> The Story Up 'til Now.
> ----------------------
> 
> When we left the Platform arena, assuming we've configured with special
> purpose memory, we are left with an entry in the memory map like so:
> 
> BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] soft reserved
> /proc/iomem: c050000000-fcefffffff : Soft Reserved
> 
> This resource (see mm/resource.c) is left unused until a driver comes
> along to actually surface it to allocators (or some other interface).
> 
> In our case, the drivers involved (or at least the ones we'll reference)
> 
> drivers/base/     : device probing, memory (block) hotplug
> drivers/acpi/     : device hotplug
> drivers/acpi/numa : NUMA ACPI table info (SRAT, CEDT, HMAT, ...)
> drivers/pci/      : PCI device probing
> drivers/cxl/      : CXL device probing
> drivers/dax/      : cxl device to memory resource association
> 
> We don't necessarily care about the specifics of each driver, we'll
> focus on just the aspects that ultimately affect memory management.
> 
> -------------------------------
> Step 4: Basic build complexity.
> -------------------------------
> To make a long story short:
> 
> CXL Build Configurations:
>   CONFIG_CXL_ACPI
>   CONFIG_CXL_BUS
>   CONFIG_CXL_MEM
>   CONFIG_CXL_PCI
>   CONFIG_CXL_PORT
>   CONFIG_CXL_REGION
> 
> DAX Build Configurations:
>   CONFIG_DEV_DAX
>   CONFIG_DEV_DAX_CXL
>   CONFIG_DEV_DAX_KMEM
> 
> Without all of these enabled, your journey will end up cut short because
> some piece of the probe process will stop progressing.
> 
> The most common misconfiguration I run into is CONFIG_DEV_DAX_CXL not
> being enabled. You end up with memory regions without dax devices.
> 
> [/sys/bus/cxl/devices]# ls
> dax_region0  decoder0.0  decoder1.0  decoder2.0 .....
> dax_region1  decoder0.1  decoder1.1  decoder3.0 .....
> 
> ^^^ These dax regions require `CONFIG_DEV_DAX_CXL` enabled to fully
> surface as dax devices, which can then be converted to system ram.

At least for this problem the plan is to fall back to
CONFIG_DEV_DAX_HMEM [1] which skips all of the RAS and device
enumeration benefits and just shunts EFI_MEMORY_SP over to device_dax.

There is also the panic button of efi=nosoftreserve which is the flag of
surrender if the kernel fails to parse the CXL configuration.

I am otherwise open to suggestions about a better model for how to
handle a type of memory capacity that elicits diverging opinions on
whether it should be treated as System RAM, dedicated application
memory, or some kind of cold-memory swap target.

[1]: http://lore.kernel.org/cover.1737046620.git.nathan.fontenot@amd.com

> ---------------------------------------------------------------
> Step 5: The CXL driver associating devices and iomem resources.
> ---------------------------------------------------------------
> 
> The CXL driver wires up the following devices:
>    root        :  CXL root
>    portN       :  An intermediate or endpoint destination for accesses
>    memN        :  memory devices
> 
> 
> Each device in the heirarchy may have one or more decoders
>    decoderN.M  :  Address routing and translation devices
> 
> 
> The driver will also create additional objects and associations
>    regionN     :  device-to-iomem resource mapping
>    dax_regionN :  region-to-dax device mapping
> 
> 
> Most associations built by the driver are done by validating decoders
> against each other at each point in the heirarchy.
> 
>   Root decoders describe memory regions and route DMA to ports.
>   Intermediate decoders route DMA through CXL fabric.
>   Endpoint decoders translate addresses (Host to device).
> 
> 
> A Root port has 1 decoder per associated CFMW in the CEDT
>    decoder0.0  ->  `c050000000-fcefffffff   : Soft Reserved`
> 
> 
> A region (iomem resource mapping) can be created for these decoders
>    [/sys/bus/cxl/devices/region0]# cat resource size target0
>       0xc050000000   0x3ca0000000   decoder5.0
> 
> 
> A dax_region surfaces these regions as a dax device
>    [/sys/bus/cxl/devices/dax_region0/dax0.0]# cat resource
>       0xc050000000
> 
> 
> So in a simple environment with 1 device, we end up with a mapping
> that looks something like this.
> 
>      root      ---   decoder0.0  --- region0 -- dax_region0 -- dax0
>        |                |              |
>      port1     ---   decoder1.0        |
>        |                |              |
>      endpoint0 ---   decoder3.0--------/
> 
> 
> Much of the complexity in region creation stems from validating decoder
> programming and associating regions with targets (endpoint decoders).
> 
> The take-away from this section is the existence of "decoders", of which
> there may be an arbitrary number between the root and endpoint.
> 
> This will be relevant when we talk about RAS (Poison) and Interleave.

Good summary. I often look at this pile of objects and wonder "why so
complex", but then I look at the heroics of drivers/edac/. Compared to
that wide range of implementation specific quirks of various memory
controllers, the CXL object hierarchy does not look that bad.

> ---------------------------------------------------------------
> Step 6: DAX surfacing Memory Blocks - First bit of User Policy.
> ---------------------------------------------------------------
> 
> The last step in surfacing memory to allocators is to convert a dax
> device into memory blocks. On most default kernel builds, dax devices
> are not automatically converted to SystemRAM.

I thought most distributions are shipping with
CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE, or the default online udev rule?
For example Fedora is CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=y and RHEL is
CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=n, but with the udev hotplug rule.

> Policy Choices
>    userland policy:  daxctl
>    default-online :  CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE
>                      or
> 		     CONFIG_MHP_DEFAULT_ONLINE_TYPE_*
> 		     or
> 		     memhp_default_state=*
> 
> To convert a dax device to SystemRAM utilizing daxctl:
> 
>   daxctl online-memory dax0.0 [--no-movable]

On RHEL at least it finds that udev already took care of it.

> 
>   By default the memory will online into ZONE_MOVABLE
>   The --no-movable option will online the memory in ZONE_NORMAL
> 
> 
> Alternatively, this can be done at Build or Boot time using
>   CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE   (v6.13 or below)
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_*       (v6.14 or above)
>   memhp_default_state=*                  (boot param predating cxl)

Oh, TIL the new CONFIG_MHP_DEFAULT_ONLINE_TYPE_* option.

> 
> I will save the discussion of ZONE selection to the next section,
> which will cover more memory-hotplug specifics.
> 
> At this point, the memory blocks are exposed to the kernel mm allocators
> and may be used as normal System RAM.
> 
> 
> ---------------------------------------------------------
> Second bit of nuanced complexity: Memory Block Alignment.
> ---------------------------------------------------------
> In section 1, we introduced CEDT / CFMW and how they map to iomem
> resources.  In this section we discussed out we surface memory blocks
> to the kernel allocators.
> 
> However, at no time did platform, arch code, and driver communicate
> about the expected size of a memory block. In most cases, the size
> of a memory block is defined by the architecture - unaware of CXL.
> 
> On x86, for example, the heuristic for memory block size is:
>    1) user boot-arg value
>    2) Maximize size (up to 2GB) if operating on bare metal
>    3) Use smallest value that aligns with the end of memory
> 
> The problem is that [SOFT RESERVED] memory is not considered in the
> alignment calculation - and not all [SOFT RESERVED] memory *should*
> be considered for alignment.
> 
> In the case of our working example (real system, btw):
> 
>          Subtable Type : 01 [CXL Fixed Memory Window Structure]
>    Window base address : 000000C050000000
>            Window size : 0000003CA0000000
> 
> The base is 256MB aligned (the minimum for the CXL Spec), and the
> window size is 512MB.  This results in a loss of almost a full memory
> block worth of memory (~1280MB on the front, and ~512MB on the back).
> 
> This is a loss of ~0.7% of capacity (1.5GB) for that region (121.25GB).

This feels like an example, of "hey platform vendors, I understand
that spec grants you the freedom to misalign, please refrain from taking
advantage of that freedom".

> 
> [1] has been proposed to allow for drivers (specifically ACPI) to advise
> the memory hotplug system on the suggested alignment, and for arch code
> to choose how to utilize this advisement.
> 
> [1] https://lore.kernel.org/linux-mm/20250127153405.3379117-1-gourry@gourry.net/
> 
> 
> --------------------------------------------------------------------
> The Complexity story up til now (what's likely to show up in slides)
> --------------------------------------------------------------------
> Platform and BIOS:
>   May configure all the devices prior to kernel hand-off.
>   May or may not support reconfiguring / hotplug.
> BIOS and EFI:
>   EFI_MEMORY_SP              - used to defer management to drivers
> Kernel Build and Boot:
>   CONFIG_EFI_SOFT_RESERVE=n  - Will always result in CXL as SystemRAM
>   nosoftreserve              - Will always result in CXL as SystemRAM
>   kexec                      - SystemRAM configs carry over to target
> Driver Build Options Required
>   CONFIG_CXL_ACPI
>   CONFIG_CXL_BUS
>   CONFIG_CXL_MEM
>   CONFIG_CXL_PCI
>   CONFIG_CXL_PORT
>   CONFIG_CXL_REGION
>   CONFIG_DEV_DAX
>   CONFIG_DEV_DAX_CXL
>   CONFIG_DEV_DAX_KMEM
> User Policy
>   CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE (<=v6.13)
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE       (>=v6.14)
>   memhp_default_state                  (boot param)
>   daxctl online-memory daxN.Y          (userland)

    memory hotlpug udev rule		 (userland)

> Nuances
>   Early-boot resource re-use
>   Memory Block Alignment
> 
> --------------------------------------------------------------------
> Next Up:
>    Memory (Block) Hotplug - Zones and Kernel Use of CXL
>    RAS - Poison, MCE, and why you probably want CXL=ZONE_MOVABLE
>    Interleave - RAS and Region Management (Hotplug-ability)

Really appreciate you organizing all of this information.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f180.google.com (mail-qk1-f180.google.com [209.85.222.180])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CAB801A5B86
	for <linux-cxl@vger.kernel.org>; Thu,  6 Feb 2025 15:59:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.180
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1738857582; cv=none; b=uTYRlCuz1RziJjwUU0wnWZr7K3QjMhY1BG3A9sJBCwFyKsd6PKppYxeFTSITiwLINww/sq22WSoluFaXHQmPcW1bbKU5iXBvnFX6Cc0HjZvk7q1H6wsgqo2b/ICbG9cmlT19SWR7ZonSuonbjhYBl4t+zrUjHrtIhc53HmacVNU=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1738857582; c=relaxed/simple;
	bh=wfWG1lBorKdXeSnfHeDzLFkNJVBsnc4Vd66lUdn9zGE=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=LNYpiDqq9KZ1v6F2/5x8KzObol20k7dg0OFhq5eUt4C2D0sHwrDXNcW10nWB2D/XDP3cQF/BwQYyEq0i8EYL2mnYJUNhF111elAqIjGaOUi24xUYMcb3S8gvyEo5fzKu4r2OqFIieniNkPheT7xNFknp1URse+KfiAI7lVscYyI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=Jam60QJw; arc=none smtp.client-ip=209.85.222.180
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="Jam60QJw"
Received: by mail-qk1-f180.google.com with SMTP id af79cd13be357-7bcf33f698dso93429685a.2
        for <linux-cxl@vger.kernel.org>; Thu, 06 Feb 2025 07:59:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1738857579; x=1739462379; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=4rgX3enkDd37pO8Eu6+jW5LrbU18LPSV6Ey4Xi/pbpE=;
        b=Jam60QJwtO8nYmi8PXsRfGX7Yl35tjWmgQ0Ui3Q1FNoRg3sCgKA31Xs13UoeI7CIBa
         bglsgdc3S/QuQbWJde15hqWsAX9NDhmAv0kXkkJ43Ghg5URzJjyI3JZvjfowBA1ZIhND
         3MOsLLCFHMDBYbwBuUhJmca1qSe+eE3Pjyz6A3SEYgFQEy1F56dzGPw3Kck932jbqSyB
         8OsQMAYcbNxIxjZyU1MR3HuU8olV7wwhwqm56GkBV+ZMEuBbmdT3CRU72Ptc/y/nKT0a
         +evArztY6vvkh8HdCItkFFbvkpuM4ulTvqRJS3voxK7AbqnvNxbKx1Zwb8OVzI1caYXn
         0HAQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1738857579; x=1739462379;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=4rgX3enkDd37pO8Eu6+jW5LrbU18LPSV6Ey4Xi/pbpE=;
        b=w4eGN3XcRoROEWGXVlPkoO3ZFmf5b/tTbJJ0le4JK26BeZfTvxyIMDxUmlmFLYRyhQ
         WDrDE/4ampJU4JgbcOHNyxPyARH9yQJnXWu9mWVvcCvhI1QHX4KzgoWCvxxrUMQl7a3W
         thRqmcX1HFmXSOTjCWGcma4ziCI9vT6ptGVDsZ6d0dD7LRLSvf+PzSK2mVByg8pzbKcc
         JzlKmCvK0P7wfXKUYkYXHiZj/iBHF1cdLkwUyObn1bLT3H5QR+h+p2hL2d1hcr/08TGM
         8Xat16dhArJd5hE+knRhTyC4ooCRQAtPfnc/x8wr8WkduZSVgEOkTONOZg7qs1ZBKkDu
         YWzA==
X-Forwarded-Encrypted: i=1; AJvYcCVPym+x2gCw9HmlAuFgYjUbdB1cZk9OjqiQgAkHy757JkbMB1/7MuLCtZyrusMET7fZAzgNotD6t0o=@vger.kernel.org
X-Gm-Message-State: AOJu0Yy3ygOfGFkhOfuN4w3weNZVVpz5lBcrqXS8/vJMBHQWGzXOoSdo
	W9D2XGE2m7fykYOUAnUBTm/XvYnNRZSzaIeOIc81pN9TMGhSprROmA5daCT7DSImEn5ggGtYcoQ
	i
X-Gm-Gg: ASbGnctI5++xOG04W+yYG1b0I5wlR2Qs3NC6hOD4dKseajmUJ8s43OJ8Hq+Zz+m+wVB
	fW1EsmodJWlh5APMe0CuelIIJXFZ8WiEJub8nPU0ubzaPH1yvRSvhr6uDtKmadkzLe8J9kUSM7T
	/7CVpGCeVmIqRoHC3oiQjFy9Mdk5KZthezdMTC+HBO7yRCbnejymrbQvpVat0IlzOoUBwoiQ7BX
	m1Ts3/PTFFWOnZ1yFcqwmy8xfsjpZAqlzUdbWPjpknKiEVf5Orph+P6jY5Sdbnt5XNfrEtA5rJq
	FjmVcvl/QQLk03aynCiFYOCIvt9cxSv1Jug4VgtSvnrSuyppakRcw6wwk//FyHbyfW+jvPdFTg=
	=
X-Google-Smtp-Source: AGHT+IGVD8lviSGrZUHhDUeXaeng33mAdOdehqoxqNfFEFyKhbcfoqIeOcq35NP8wXT2MTIiiQ0kcA==
X-Received: by 2002:a05:620a:40d4:b0:7b1:492c:ba83 with SMTP id af79cd13be357-7c039f95dfemr1002655885a.10.1738857579502;
        Thu, 06 Feb 2025 07:59:39 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c041ded12asm75286685a.5.2025.02.06.07.59.38
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 06 Feb 2025 07:59:39 -0800 (PST)
Date: Thu, 6 Feb 2025 10:59:37 -0500
From: Gregory Price <gourry@gourry.net>
To: Dan Williams <dan.j.williams@intel.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 2: The Drivers
Message-ID: <Z6TcaaScBWzZvLWW@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
 <67a4069572eab_2d2c294d4@dwillia2-xfh.jf.intel.com.notmuch>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <67a4069572eab_2d2c294d4@dwillia2-xfh.jf.intel.com.notmuch>
Status: O
Content-Length: 4979
Lines: 118

On Wed, Feb 05, 2025 at 04:47:17PM -0800, Dan Williams wrote:
> Gregory Price wrote:
> > [/sys/bus/cxl/devices]# ls
> > dax_region0  decoder0.0  decoder1.0  decoder2.0 .....
> > dax_region1  decoder0.1  decoder1.1  decoder3.0 .....
> > 
> > ^^^ These dax regions require `CONFIG_DEV_DAX_CXL` enabled to fully
> > surface as dax devices, which can then be converted to system ram.
> 
> At least for this problem the plan is to fall back to
> CONFIG_DEV_DAX_HMEM [1] which skips all of the RAS and device
> enumeration benefits and just shunts EFI_MEMORY_SP over to device_dax.
> 

Hm, would this actually happen in the scenario where CONFIG_DEV_DAX_CXL
is not enabled but everything else is?  The region0 still gets created
and associated with the resource, but the dax_region0 never gets
created.

On one system I have I see the following:

c050000000-fcefffffff : Soft Reserved
  c050000000-fcefffffff : CXL Window 0
    c050000000-fcefffffff : region0
      c050000000-fcefffffff : dax0.0
        c050000000-fcefffffff : System RAM (kmem)
fcf0000000-ffffffffff : Reserved
10000000000-1035fffffff : Soft Reserved
  10000000000-1035fffffff : CXL Window 1
    10000000000-1035fffffff : region1
      10000000000-1035fffffff : dax1.0
        10000000000-1035fffffff : System RAM (kmem)

I would expect the above HMEM/shunt to only work if everything down
through CXL Window 0 is torn down.

But if CONFIG_DEV_DAX_CXL is not enabled, everything "succeeds", it just
doesn't "Do what you want"(TM) - dax0.0 and RAM entries are absent.

It makes me wonder whether the driver over-componentized the build.

> I am otherwise open to suggestions about a better model for how to
> handle a type of memory capacity that elicits diverging opinions on
> whether it should be treated as System RAM, dedicated application
> memory, or some kind of cold-memory swap target.
> 

My gut tells me there's no "elegant solution" here given that user
intent is fairly unknowable - i.e. best we can do is make the build
and boot options easier to understand.

> > ---------------------------------------------------------------
> > Step 6: DAX surfacing Memory Blocks - First bit of User Policy.
> > ---------------------------------------------------------------
> > 
> > The last step in surfacing memory to allocators is to convert a dax
> > device into memory blocks. On most default kernel builds, dax devices
> > are not automatically converted to SystemRAM.
> 
> I thought most distributions are shipping with
> CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE, or the default online udev rule?
> For example Fedora is CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=y and RHEL is
> CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=n, but with the udev hotplug rule.
> 

Good point, my bias take showing up in the notes here.  I didn't know
RHEL had gotten as far as a udev rule already. I'll adjust my notes.

But this also hides some nuance as well - the default behavior onlines
memory into ZONE_NORMAL with DEFAULT_ONLINE (next section).  

> > Alternatively, this can be done at Build or Boot time using
> >   CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE   (v6.13 or below)
> >   CONFIG_MHP_DEFAULT_ONLINE_TYPE_*       (v6.14 or above)
> >   memhp_default_state=*                  (boot param predating cxl)
> 
> Oh, TIL the new CONFIG_MHP_DEFAULT_ONLINE_TYPE_* option.
> 

It was only just added:
https://lore.kernel.org/linux-mm/20241226182918.648799-1-gourry@gourry.net/

Basically creates parity between memhp_default_state and build options.

> > The base is 256MB aligned (the minimum for the CXL Spec), and the
> > window size is 512MB.  This results in a loss of almost a full memory
> > block worth of memory (~1280MB on the front, and ~512MB on the back).
> > 
> > This is a loss of ~0.7% of capacity (1.5GB) for that region (121.25GB).
> 
> This feels like an example, of "hey platform vendors, I understand
> that spec grants you the freedom to misalign, please refrain from taking
> advantage of that freedom".
> 

Only x86 appears to actually do this (presently) - so is this a real
constraint or just a quirk of how the x86 arch code has chosen to
"optimize memory block size"?

Granted I'm a platform consumer, not a vendor - but I wouldn't even know
where to look to see where this constraint is defined (if it is).

All I'd know is "CXL Says I can align to 256MB, and minimum memory block
size on linux is 256MB so allons y!"

On the linux side - these platforms are now out there, in the wild.
So the surface impression now appears to be that linux just throws
away ~0.5% of your CXL capacity for no reason on these platforms.

That said, I also understand that more memory blocks might affect
allocation performance when the system is pressured - but losing
gigabytes of memory can also reduce performance.
(Preview of one of my next nuance additions in section 3)

If this (advisement) change is unwelcome, then we should be spewing
a really loud warning somewhere so vendors get signal for consumers.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f44.google.com (mail-qv1-f44.google.com [209.85.219.44])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5C004227BAA
	for <linux-cxl@vger.kernel.org>; Mon, 17 Feb 2025 20:05:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.44
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739822752; cv=none; b=IotC9wk/nyBOHmbaN3S5WFpnOOOy+JLsxcHAyuX8jnoL3hA/mqcgVHhDXvNA1UorXQQT0SFsfdzEjE0w56aV0BCEOvpZhuVUaaRBW8vm4rv+pckATlhyDGex3aXj07ca/vXZxEra/TWHSNi1P0x/VygTdW9m+S/BvXdHa6Cz44I=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739822752; c=relaxed/simple;
	bh=k6DNKFKMaCUQ0DgrC2eIhHYG/gMH73GjjhFevt5GJKU=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=UOWqlrkDo744GlvItNDLkMcNIRBwi7OSmBkFoZGJmFcbWgaBIFS3xZ3S4+r2M5aYQ45J1yPAU8+xGJ53XzM91qa4wT0g+7ocily94SIIAgEb6kvUS+5vH8EjF0Z4xNPGib2ZbP+nSU4QCxVPnyID7q5EL5+lFoEn0WxdrSk7KHo=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=m3nCne8t; arc=none smtp.client-ip=209.85.219.44
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="m3nCne8t"
Received: by mail-qv1-f44.google.com with SMTP id 6a1803df08f44-6e67ce516efso11350186d6.3
        for <linux-cxl@vger.kernel.org>; Mon, 17 Feb 2025 12:05:50 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739822749; x=1740427549; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=vCgeOMU2MhngBhzCworEtjOZ+T+D6653XM8U1/nQhGA=;
        b=m3nCne8tCiewC8EhkbNFjLXFzgtYp1CWjAljSQmkPhhzXNZS63hJdGdijnmtlRqgxI
         3aVlPH5wnrNDRYWv3feZQ4LB/qCdF6z8M/L0JlCw2eENLKHU9j8Zz5P+gLznyW1+Bka1
         IhD+rQeiYarlB8qBvMcsqcLKzo5lDj+j81Sw3aiGDFMYsLc6/GqvwOhnKs4AuK+ZnfAA
         mJCkMGhNQuZqaVrBfB6EWiZTmtnQjMfRGoAWlbPwzL7vsynjuCiwIVJohlYoQh5pYIi0
         dlu+tRhkfem7Tltge2WtpJ2Np66+Av4Ce2Ljsj2dQPapXXAca00BExgUtLcd/zr/bkU2
         +1hA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739822749; x=1740427549;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=vCgeOMU2MhngBhzCworEtjOZ+T+D6653XM8U1/nQhGA=;
        b=pqATBBjpvEu2CPU6AAUM582IUtZxY68WsfaPJ9AF09yguzaAGdlb+7ok4fTbfLdmtq
         hjCDfE/0BaIi0PvFWIMx/uyo7dIYCBHP2Jf8AGRBUKd8THu/WIrlQiR8ix6hKwdoW6Mg
         lldPh1fcfsbZuGHcsQwr0+kQRmimX/lC9lOimmIPtK/8PxFgXKE70Q17mieGq31gaurB
         bImQBr0f9CoxS2/V69GFJOnSYOh9mI7IZYBIoCxMuNZ57HrPg8XQRuNotdJzqxWLN2oo
         cRCecdQVqkt3RE+AI6aOnKRImp2qNihq5sixzTTxJoM8dfYpk0IvdGdQDW6RwrPk1G9d
         HvIw==
X-Forwarded-Encrypted: i=1; AJvYcCWwH6W9R00mZEVwDr5GSZvoAOAYOq86GPMIqFw4NTag6etOZVkOTR4OMNEnyNuadqhCOaZ6FIndc3w=@vger.kernel.org
X-Gm-Message-State: AOJu0YxlAx97yS316ryK21SfSjbTa4bk5gIGHwkZ1w2mteIN6yUmLFyK
	ZYh6jLmNfAyzQk2ec6Lfo1ELfYdVStq/JP39iXDeKfdMZDRSzRBcj5CPlHFvmjo=
X-Gm-Gg: ASbGncsWV3YRbanKp5cizy+DpBK6Cn3AIFLPV7paJPTDIz0bopfiWxQ0grCg5QpaePg
	jCPfQTWLkSTKijFZeMgACw7OsJr0OT/Gx/naVgkVsYFeG7wi1CzrOWxDLCmp4pd0rnDMfE0sfjx
	Dk/wEJBoAfGlJoNbMC3lOqdkYhrj0CV232zD9mbNBTjAmm0uD5wHIeqhH6IMJP4gD7JUCwjNVGh
	ODjJBXfs9EXI+B2wsahiF03dWEebLHreEX64t5nW6XZSMCdcrZPTgbm/38hLjvbxJy/4VYzShTk
	mPfQJ8gqWryvSKSVuPE8M3l/DYnLu20a9dDP9sd8ArqPX7CeI5pkMq5mXq6gnxycelJi4Q+wSg=
	=
X-Google-Smtp-Source: AGHT+IFPULOdVELO2VyJgNV5ljLKvzQJzC37IUdklvHnQ5b1U1CtrvxTzhQkTu86wiLswV9Q8uTiRQ==
X-Received: by 2002:a05:6214:3bc9:b0:6e4:4331:aad9 with SMTP id 6a1803df08f44-6e676294de1mr124170946d6.2.1739822748947;
        Mon, 17 Feb 2025 12:05:48 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e65daffdbbsm55675956d6.99.2025.02.17.12.05.47
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 17 Feb 2025 12:05:48 -0800 (PST)
Date: Mon, 17 Feb 2025 15:05:44 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 10120
Lines: 273


The story up to now
-------------------
When we left the driver arena, we had created a dax device - which
connects a Soft Reserved iomem resource to one or more `memory blocks`
via the kmem driver.  We also discussed a bit about ZONE selection
and default online behavior.

In this section we'll discuss what actually goes into memory block
creation, how those memory blocks are exposed to kernel allocators
(tl;dr: sparsemem / memmap / struct page), and the implications of
the selected memory zones.


-------------------------------------
Step 7: Hot-(un)plug Memory (Blocks).
-------------------------------------
Memory hotplug refers to surfacing physical memory to kernel
allocators (page, slab, cache, etc) - as opposed to the action of
"physically hotplugging" a device into a system (e.g. USB). 

Physical memory is exposed to allocators in the form of memory blocks.

A `memory block` is an abstraction to describe a physically
contiguous region memory, or more explicitly a collection of physically
contiguous page frames which is described by a physically contiguous
set of `struct page` structures in the system memory-map.

The system memmap is what is used for pfn-to-page (struct) and
page(struct)-to-pfn conversions. The system memmap has `flat` and
`sparse` modes (configured at build-time). Memory hotplug requires the
use of `sparsemem`, which aptly makes the memory map sparse.

Hot *remove* (un-plug) is distinct from Hot add (plug).  To hot-remove
an active memory block, the pages in-use must have their data (and
therefore mappings) migrated to another memory block. Hot-remove must
be specifically enabled separate from hotplug.


Build configurations affecting memory block hot(un)plug
  CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG
  CONFIG_SPARSEMEM
  CONFIG_64BIT
  CONFIG_MEMORY_HOTPLUG
  CONFIG_ARCH_ENABLE_MEMORY_HOTREMOVE
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_OFFLINE
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_AUTO
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_KERNEL
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_MOVABLE
  CONFIG_MHP_MEMMAP_ON_MEMORY
  CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE
  CONFIG_MIGRATION
  CONFIG_MEMORY_HOTREMOVE

During early-boot, the kernel finds all SystemRAM memory regions NOT
marked "Special Purpose" and will create memory blocks for these
regions by default.  These blocks are defaulted into ZONE_NORMAL
(more on zones shortly).

Memory regions present at boot marked `EFI_MEMORY_SP` have memory blocks
created and hot-plugged by drivers.  The same mechanism is used to
hot-add memory physically hotplugged after system boot (i.e. not present
in the EFI Memory Map at boot time).

The DAX/KMEM driver hotplugs memory blocks via the
  `add_memory_driver_managed()`
function.


-------------------------------
Step 8: Page Struct allocation.
-------------------------------
A `memory block` is made up of a collection of physical memory pages,
which must have entries in the system Memory Map - which is managed by
sparsemem on systems with memory (block) hotplug.  Sparsemem fills the
memory map with `struct page` for hot-plugged memory.

Here is a rough trace through the (current) stack on how page structs
are populated into the system Memory Map on hotplug.

```
add_memory_driver_managed
  add_memory_resource
    memblock_add_node
      arch_add_memory
        init_memory_mapping
          add_pages
            __add_pages
              sparse_add_section
                section_activate
                  populate_section_memmap
                    __populate_section_memmap
                      memmap_alloc
                        memblock_alloc_try_nid_raw
                          memblock_alloc_internal
                            memblock_alloc_range_nid
                              kzalloc_node(..., GFP_KERNEL, ...)
```

All allocatable-memory requires `struct page` resources to describe the
physical page state.  On a system with regular 4kb size pages and 256GB
of memory - 4GB is required just to describe/manage the memory.

This is ~1.5% of the new capacity to just surface it (4/256).

This becomes an issue if the memory is not intended for kernel-use,
as `struct page` memory must be allocated in non-movable, kernel memory
`zones`.  If hot-plugged capacity is designated for a non-kernel zone
(ZONE_MOVABLE, ZONE_DEVICE, etc), then there must be sufficient
ZONE_NORMAL (or similar kernel-compatible zone) to allocate from.

Matthew Wilcox has a plan to reduce this cost, some details of his plan:
https://fosdem.org/2025/schedule/event/fosdem-2025-4860-shrinking-memmap/
https://lore.kernel.org/all/Z37pxbkHPbLYnDKn@casper.infradead.org/


---------------------
Step 9: Memory Zones.
---------------------
We've alluded to "Memory Zones" in prior sections, with really the only
detail about these concepts being that there are "Kernel-allocation
compatible" and "Movable" zones, as well as some relationship between
memory blocks and memory zones.

The two zones we really care about are `ZONE_NORMAL` and `ZONE_MOVABLE`.

For the purpose of this reading we'll consider two basic use-cases:
- memory block hot-unplug
- kernel resource allocation

You can (for the most part) consider these cases incompatible.  If the
kernel allocates `struct page` memory from a block, then that block cannot
be hot-unplugged.  This memory is typically unmovable (cannot be migrated),
and its pages unlikely to be removed from the memory map.

There are other scenarios, such as page pinning, that can block hot-unplug.
The individual mechanisms preventing hot-unplug are less important than
their relationship to memory zones.

ZONE_NORMAL basically allows any allocations, including things like page
tables, struct pages, and pinned memory.

ZONE_MOVABLE, under normal conditions, disallows most kernel allocations.

ZONE_MOVABLE does NOT make a *strong* guarantee of hut-unplug-ability.
The kernel and privileged users can cause long-term pinning to occur - 
even in ZONE_MOVABLE.  It should be seen as a best-attempt at providing
hot-unplug-ability under normal conditions.


Here's the take-away:

Any capacity marked SystemRAM but not Special Purpose during early boot
will be onlined into ZONE_NORMAL by default - making it available for
kernel-use during boot.  There is no guarantee of being hot-unpluggable.

Any capacity marked Special Purpose at boot, or hot-added (physically),
will be onlined into a user-selected zone (Normal or Movable).

There are (at least) 4 ways to select what zone to online memory blocks.

Build Time:
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_*
Boot Time:
  memhp_default_state (boot parameter)
udev / daxctl:
  user policy explicitly requesting the zone
memory sysfs
  online_movable > /sys/bus/memory/devices/memoryN/online


------------------------------------------
Nuance: memmap_on_memory and ZONE_MOVABLE.
------------------------------------------
As alluded to in the prior sections - hot-added ZONE_MOVABLE capacity
will consume ZONE_NORMAL capacity for its kernel resources.  This can
be problematic if vast amounts of ZONE_MOVABLE is added on a system
with limited ZONE_NORMAL capacity.

For example, consider a system with 4GB of ZONE_NORMAL and 256GB of
ZONE_MOVABLE.  This wouldn't work, as the entirety of ZONE_NORMAL would
be consumed to allocate `struct page` resources for the ZONE_MOVABLE
capacity - leaving no working memory for the rest of the kernel.

The `memmap_on_memory` configuration option allows for hotplugged memory
blocks to host their own `struct page` allocations... 

                   if they're placed in ZONE_NORMAL.

To enable, use the boot param: `memory_hotplug.memmap_on_memory=1`.

Sparsemem allocation of memory map resources ultimately uses a
`kzalloc_node` call, which simply allocates memory from ZONE_NORMAL with
a *suggested* node.

```
memmap_alloc
  memblock_alloc_try_nid_raw
    memblock_alloc_internal
      memblock_alloc_range_nid
        kzalloc_node(..., GFP_KERNEL, ...)
```

The node ID passed in as an argument is a "preferred node", which means
is insufficient space on that node exists to service the GFP_KERNEL
allocation, it will fall back to another node.

If all hot-plugged memory is added to ZONE_MOVABLE, two things occur:

  1) A portion of the memory block is carved out for to allocate memmap
     data (reducing usable size by 64b*nr_pages)

  2) The memory is allocated on ZONE_NORMAL on another node..

Result: Lost capacity due to the unused carve-out area for no value.

--------------------------------
The Complexity Story up til now.
--------------------------------
Platform and BIOS:
  May configure all the devices prior to kernel hand-off.
  May or may not support reconfiguring / hotplug.

BIOS and EFI:
  EFI_MEMORY_SP              - used to defer management to drivers

Kernel Build and Boot:
  CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG
  CONFIG_SPARSEMEM
  CONFIG_64BIT
  CONFIG_MEMORY_HOTPLUG
  CONFIG_ARCH_ENABLE_MEMORY_HOTREMOVE
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_OFFLINE
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_AUTO
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_KERNEL
  CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_MOVABLE
  CONFIG_MHP_MEMMAP_ON_MEMORY
  CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE
  CONFIG_MIGRATION
  CONFIG_MEMORY_HOTREMOVE
  CONFIG_EFI_SOFT_RESERVE=n  - Will always result in CXL as SystemRAM
  nosoftreserve              - Will always result in CXL as SystemRAM
  kexec                      - SystemRAM configs carry over to target
  memory_hotplug.memmap_on_memory

Driver Build Options Required
  CONFIG_CXL_ACPI
  CONFIG_CXL_BUS
  CONFIG_CXL_MEM
  CONFIG_CXL_PCI
  CONFIG_CXL_PORT
  CONFIG_CXL_REGION
  CONFIG_DEV_DAX
  CONFIG_DEV_DAX_CXL
  CONFIG_DEV_DAX_KMEM

User Policy
  CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE (<=v6.13)
  CONFIG_MHP_DEFAULT_ONLINE_TYPE       (>=v6.14)
  memhp_default_state                  (boot param)
  daxctl online-memory daxN.Y          (userland)

Nuances
  Early-boot resource re-use
  Memory Block Alignment
  memmap_on_meomry + ZONE_MOVABLE

----------------------------------------------------
Next up:
  RAS - Poison, MCE, and why you probably want CXL=ZONE_MOVABLE
  Interleave - RAS and Region Management

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from zg8tmtyylji0my4xnjqumte4.icoremail.net (zg8tmtyylji0my4xnjqumte4.icoremail.net [162.243.164.118])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 181CE233D99;
	Tue, 18 Feb 2025 10:13:10 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=162.243.164.118
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739873597; cv=none; b=mz61VDmPEyHL2TxoNuD98rUXnn7HpV10/SiwwCXzsu+or4P1n8E7k/1PYcvp8FUEH9DeScWB60azzTxxpyxBxc5QQuP2/qifqk6VhvemOj6TB6E0QdmvCTKfcqwJdtvN2iulSvbyfJ5HWZ1t/Zdxk8dWe0xpWM50Tk4y4IyLOOc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739873597; c=relaxed/simple;
	bh=FqZ3B+iP+z/ZDGuUJRIsR4T2jVsPEEwEmT3Vp3lUXRo=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=GMHm+8TMYS4OnvkTaqLYB5fxK4M420D7tZupIrw3gADointa5uOxi5D03r9zXLY3XFt0gDsuaDO1f86zrwxEDYONj/8nfNV2O1MDlPbyvyXPkn9Lujokhxst1thbWblnLu1wiUbEFz53tCNBlOAoi7HgwV+ExstCdx8fmey1kr0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn; spf=pass smtp.mailfrom=phytium.com.cn; arc=none smtp.client-ip=162.243.164.118
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=phytium.com.cn
Received: from prodtpl.icoremail.net (unknown [10.12.1.20])
	by hzbj-icmmx-7 (Coremail) with SMTP id AQAAfwCnrmoyXbRn47auAw--.24682S2;
	Tue, 18 Feb 2025 18:13:06 +0800 (CST)
Received: from localhost (unknown [123.150.8.50])
	by mail (Coremail) with SMTP id AQAAfwB3eYUvXbRnAQwrAA--.5979S2;
	Tue, 18 Feb 2025 18:13:04 +0800 (CST)
Date: Tue, 18 Feb 2025 18:12:47 +0800
From: Yuquan Wang <wangyuquan1236@phytium.com.cn>
To: Gregory Price <gourry@gourry.net>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early Boot
Message-ID: <Z7RdH7RGNivDjq6n@phytium.com.cn>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
X-CM-TRANSID: AQAAfwB3eYUvXbRnAQwrAA--.5979S2
X-CM-SenderInfo: 5zdqw5pxtxt0arstlqxsk13x1xpou0fpof0/1tbiAQAFAWezlaEDBQAAsj
Authentication-Results: hzbj-icmmx-7; spf=neutral smtp.mail=wangyuquan
	1236@phytium.com.cn;
X-Coremail-Antispam: 1Uk129KBjvJXoW7KFyUtFyDKr1Dtw4rur4rKrg_yoW8tFWkpF
	WfJry3Cr48tr1xAr48Ars5AFyjvw1kCa13Gr9rAr95C3W5C342vr15tw18ZFyUJryUJr17
	XayUJr12vw1UAaDanT9S1TB71UUUUUDqnTZGkaVYY2UrUUUUj1kv1TuYvTs0mT0YCTnIWj
	DUYxn0WfASr-VFAU7a7-sFnT9fnUUIcSsGvfJ3UbIYCTnIWIevJa73UjIFyTuYvj4RJUUU
	UUUUU
Status: O
Content-Length: 2405
Lines: 64

On Tue, Feb 04, 2025 at 09:17:09PM -0500, Gregory Price wrote:
> 
> ------------------------------------------------------------------
> Step 2: BIOS / EFI generates the CEDT (CXL Early Detection Table).
> ------------------------------------------------------------------
> 
> This table is responsible for reporting each "CXL Host Bridge" and
> "CXL Fixed Memory Window" present at boot - which enables early boot
> software to manage those devices and the memory capacity presented
> by those devices.
> 
> Example CEDT Entries (truncated) 
>          Subtable Type : 00 [CXL Host Bridge Structure]
>               Reserved : 00
>                 Length : 0020
> Associated host bridge : 00000005
> 
>          Subtable Type : 01 [CXL Fixed Memory Window Structure]
>               Reserved : 00
>                 Length : 002C
>               Reserved : 00000000
>    Window base address : 000000C050000000
>            Window size : 0000003CA0000000
> 
> If this memory is NOT marked "Special Purpose" by BIOS (next section),
> you should find a matching entry EFI Memory Map and /proc/iomem
> 
> BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] usable
> /proc/iomem: c050000000-fcefffffff : System RAM
> 
> 
> Observation: This memory is treated as 100% normal System RAM
> 
>    1) This memory may be placed in any zone (ZONE_NORMAL, typically)
>    2) The kernel may use this memory for arbitrary allocations
>    4) The driver still enumerates CXL devices and memory regions, but
>    3) The CXL driver CANNOT manage this memory (as of today)
>       (Caveat: *some* RAS features may still work, possibly)
> 

Hi, Gregory

Thanks for the in-depth introduction and analysis.  

Here I have some confusion:

1) In this scenario, does it mean users could not create a CXL region
dynamically after OS boot? 

2) A CXL region (interleave set) would influence the real used memory
in this memory range. Therefore, apart from devices, does platforms
have to configure CXL regions in this stage?

3) How bios/EFI to describe a CXL region?

> This creates an nuanced management state.
> 
> The memory is online by default and completely usable, AND the driver
> appears to be managing the devices - BUT the memory resources and the
> management structure are fundamentally separate.
>    1) CXL Driver manages CXL features
>    2) Non-CXL SystemRAM mechanisms surface the memory to allocators.
>


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f171.google.com (mail-qt1-f171.google.com [209.85.160.171])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1FF7226D5BC
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 16:11:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.171
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739895080; cv=none; b=LLywtwA8ktaCiFCN7uOCyc5CLDbz7IzOaXXX2XNZHSS1k8jRNF7Y/7YJtyU0xB6WXAF4JBP1HmxtpqkicElGygL3Q7puu2YgRrTXMPlA7tWZg44/AsDsBKZodDtLGlsvo5YXrYdA48A+N5LCPN7YOvso11oXadlaz2FlgUcSNmc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739895080; c=relaxed/simple;
	bh=PZOujvQ+MNaRhQOa2hN49EYGkUXw8bFhUJtY0Zoxzpc=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=Wm4M9DyaM4tzmZrrWD/tN6ykQRf68Nl/1irsEpT7RHk/ezNuaN0zv/FhHtQMdsxYU0MSWO1/XvWimx6gXi1djoYchNS7/5u2Pv/oXKLaX7C/6aZcJygDLs5sNrJbQzCFa/HZ76dKLciGD64D77Z10J/YS7Xac839fa2+d9b+cm0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=SxoQFEHl; arc=none smtp.client-ip=209.85.160.171
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="SxoQFEHl"
Received: by mail-qt1-f171.google.com with SMTP id d75a77b69052e-471b5372730so72226571cf.1
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 08:11:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739895076; x=1740499876; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=5cQGGMSgY8MGd0sxrw5WDxENgtEsj70+ROuTTP1PL5Y=;
        b=SxoQFEHlyn6CAmG7dHYNAUqmfSlcv6TWg9T0bVtXnFSq0uS4kOPY7gjy0WsxY0bBun
         ndHY9HQN52yErO1EIUgM8XZ1bWGLBeEbh0C+ft541Sb5fkWNAAvpvSTryAuyjCF4GU+1
         4Fj+B583Abl4/CnGmLOAFv8tfyC1UzVBDHeq1lrmSQ6K8DTpade2wR/pVl347bz2i43I
         D3iaubq32DqUfQPCe7cc9DIIxmMqG6o5t856vcFVSrTqmAnabARfaJvo2aUvQgJClvSR
         iAPStuvS0T6z12PFr1iD4VHzHO8VJuSYJ55IZeYwBm6skwF7NnT1THuxyq968E48F/3H
         JL1g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739895076; x=1740499876;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=5cQGGMSgY8MGd0sxrw5WDxENgtEsj70+ROuTTP1PL5Y=;
        b=TFU9Z4GoAgbtOxmnQgsVMEBSxNcy5EMy1GGIP6RJexVQq+O2ApxMJELIFTUsv74XvM
         GnIgtK2uekm1W/rBBgRjpF54L717EdAE/GwNj6OL3eIJ6y9T4c6DGpbNZw/XFyIP++Gs
         kphHx6jt+syr8Pz3sv+QDVwsVfPlnwDUvnsahRE7XvrsIPx/4IV6zLzVnk25v6f/wpsC
         yVkDGig9Eyu5ZBipFOg+inN4XWF2UdNn3vzCu5mcfyqDsM9B2Z8BT2IAAKgYS/8yDYHm
         lRYhjORt4l8b2/v6kmvcZAoT1xg7QdPTZeX9bbgsu5IJJ0uC4e2gcXq+8waVUpcFvGtu
         4FZw==
X-Forwarded-Encrypted: i=1; AJvYcCXet2sKVaAMOP/YSqjsfBbQBE1+RwuwrIsALsF+gGzjddpXHRQ9CwTiVXTaWQsLqIPN5FHRY02P/9Q=@vger.kernel.org
X-Gm-Message-State: AOJu0YwpCv7PLugv4s07pPMmESeUxo5xnAluTROtj4KiLjC4W0+I4pdc
	mhyfxJ0vYov0ixmnmTXgTRWyYR1SsSp7G8h88XhKERfX0ctEcXAMq+m5Tnf/vtI=
X-Gm-Gg: ASbGncsrSMns/s0cL1NrNguKA1cew+I73HbcO4hlNWGD1t78y1h0gYnWeG/m0yUgK7+
	Z8oW62UBhhN4WzXzZSrt1/e5jRKOgq/7d2k2/XssdnnxNKIfe60m1Or/jBOtck2nyKAKGJo760o
	9b6SzYKPx4Y7vCQQrbSUMfm+X55BhwdkN89DlfPRBelTTxuiS9XHIEO6faZL65OQq0w6FPHWbBc
	s2YsMHZOPWhvR3WJ/45vv30EuCGMAC81luBFPzf0+Evq2+j39JfmRgOn5vqgP3etshXJD1mZyXT
	5UNSNQf+Upm01Ob0NBxdb0ShtOz3rluUqLVgWDfPHzVKskqshE2gYJ0FWg2I8FgVrsgHjfc6+A=
	=
X-Google-Smtp-Source: AGHT+IHYr4BQwfAkYI4GpOjTNITJVFyEpNnF+z5lYLa4RM2UUxXYRmgvzKbGSZXT2OG53A5PVYI3XA==
X-Received: by 2002:a05:622a:148c:b0:46c:728c:8862 with SMTP id d75a77b69052e-471dbd6fe65mr167655371cf.31.1739895075791;
        Tue, 18 Feb 2025 08:11:15 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-471fe6c81e4sm12279921cf.44.2025.02.18.08.11.14
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 18 Feb 2025 08:11:14 -0800 (PST)
Date: Tue, 18 Feb 2025 11:11:12 -0500
From: Gregory Price <gourry@gourry.net>
To: Yuquan Wang <wangyuquan1236@phytium.com.cn>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early Boot
Message-ID: <Z7SxIBF-gkuBTqTJ@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
 <Z7RdH7RGNivDjq6n@phytium.com.cn>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z7RdH7RGNivDjq6n@phytium.com.cn>
Status: O
Content-Length: 2267
Lines: 62

On Tue, Feb 18, 2025 at 06:12:47PM +0800, Yuquan Wang wrote:
> On Tue, Feb 04, 2025 at 09:17:09PM -0500, Gregory Price wrote:
> > 
> >    1) This memory may be placed in any zone (ZONE_NORMAL, typically)
> >    2) The kernel may use this memory for arbitrary allocations
> >    4) The driver still enumerates CXL devices and memory regions, but
> >    3) The CXL driver CANNOT manage this memory (as of today)
> >       (Caveat: *some* RAS features may still work, possibly)
> > 
> 
> Hi, Gregory
> 
> Thanks for the in-depth introduction and analysis.  
> 
> Here I have some confusion:
> 
> 1) In this scenario, does it mean users could not create a CXL region
> dynamically after OS boot? 
> 

It helps to be a bit more precise here.

"A CXL Region" is a device managed by the CXL driver:

  /sys/bus/cxl/devices/regionN

In this setup, a "CXL region" is not required, because the memory has
already been associated with memory blocks in ZONE_NORMAL by the kernel.

The blocks themselves are not managed by the driver, they are created
during early boot - and are not related to driver operation at all.

The driver can still enumerate the fabric and the devices that back this
memory, but presently it does not manage the memory blocks themselves.

more explicitly:  There is no link between a memdev and memory blocks,
which would normally be created via a region+dax_region+dax device.


> 2) A CXL region (interleave set) would influence the real used memory
> in this memory range. Therefore, apart from devices, does platforms
> have to configure CXL regions in this stage?
> 

Again, you need to be more explicit about "CXL region".  A "CXL region
device" is a construct created by the driver.  In this scenario, the
platform configures the CXL memory for use as normal system RAM by
marking it EFI_CONVENTIONAL_MEMORY without EFI_MEMORY_SP.

Some platforms configure interleave in BIOS - how this is done is
platform specific but ultimately constrained by the CXL specification on
programming decoders throughout the fabric.

> 3) How bios/EFI to describe a CXL region?
> 

You would have to discuss this with the individual platform folks.

The main mechanism to communicate CXL configuration from BIOS/EFI to
kernel is the CEDT/CFMW and HMAT.

~Gregory.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 08F7326E622
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 16:24:41 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.133.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739895883; cv=none; b=Nh18LdUnXmk2DhgPR8R7K3FitfUxTuqTkEes+9u/Uhc3t2VSlVn8LY9sLXlKRRsIkqpgaxw32uHUX0LnSpHmsi4U7ce4wPUGLveWqwd+DiGVB1dow4PG5Ke8vfIC8j9Ie4YORwwxlkazN5LW+njBakv91SA6T6awAQp37JnaB6w=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739895883; c=relaxed/simple;
	bh=IKDoHpGUmfxPeBpjXsKYMmZ1A12qdzUwi/Q+qn7s55M=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=VXP6XpPuNjxLBNha5F1BFfDZldnbVXzbLKTyEY5g1A8mObPIGu+vMIUxRfoj5t4fEjDRU1OEc+LEALAadJMvhr9c8AZYCMteFNZpbujEJHqbLqtfSbdE7oWJ0QnE80sfAADhvcTttWkLsXRqFN9O++W1RCIdKl2v8xQPpC0Lnbc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=apVLdaiU; arc=none smtp.client-ip=170.10.133.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="apVLdaiU"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1739895880;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=hRUi+wRJ+uHkvYz2KdheOXmJhPADMqcYjplj5sCFL/w=;
	b=apVLdaiUTTSB31zXcOf+T7MEoBqPtG/NIZ17KH5wyN7GI1lOxP6F3yDS3617b4oT+R01tE
	qiDx7u+ipfISPh16hhZeTKURUhVhuhVYuYnBJyeOXkD2iAjHNl0NDEz1yjE3+eTo8qPPvl
	rDKN16d70fhqrpPSKqBjZWBO5u8r8Jw=
Received: from mail-wm1-f72.google.com (mail-wm1-f72.google.com
 [209.85.128.72]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-74-tKD8NybWOQatSBUMnK8OOA-1; Tue, 18 Feb 2025 11:24:34 -0500
X-MC-Unique: tKD8NybWOQatSBUMnK8OOA-1
X-Mimecast-MFC-AGG-ID: tKD8NybWOQatSBUMnK8OOA_1739895873
Received: by mail-wm1-f72.google.com with SMTP id 5b1f17b1804b1-4393e873962so31111825e9.3
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 08:24:34 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739895873; x=1740500673;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=hRUi+wRJ+uHkvYz2KdheOXmJhPADMqcYjplj5sCFL/w=;
        b=EJcsAxfy1T+WXytpial1qQzd14RbfTD/U40C6YRYHOpgwkUrhTdK9LqRIVpMXflcBw
         d+Y2YsUHe8q0njdLqnqCghNMPamz2ZKKOsZU6trfPCmUC+hHWL0wzuIVOLgUNSvdKAmL
         oLNwKOfHeAZdYhUgj2nOsIK4CjxcaBQ0ptzeZGe1Wh5IuRVBt1kfBbae81mvntn1Sf+n
         qDWPnTQLxmXPQERM4h6+5nZgJcx+SZrqWLgmlGGiiOKU02cmu7JwOcQdbsJGw3M3THo6
         +mHI/iO+ANQqGr6b4wC6HsUjK+BQpaf1gXZ6r+IxS+6nbV8ttq0tESdhRVXlj5N7SmXQ
         IvaA==
X-Forwarded-Encrypted: i=1; AJvYcCXfWXdcoXlcra4Tanu6rFWvK86I7SSXt+jY1gyXmJP1g0Sx6e1JcDl99dJdOcXq2Qj8GVTuHrD8wfk=@vger.kernel.org
X-Gm-Message-State: AOJu0YzrInChF4URi2zxYiDRgrIGFQb3kt8/fIe/ULYtKa8vR6Y65Hj2
	Pc51NZyRuX9znMiVy9p8DFkVIdStj7oxgaDWAK1VEOFamrweL92GDrhDS57kUyaPkIPnURrvKkb
	A3ldBurWJhE9cK8gCxWVpNKSNhE4nZLTl0R/5VzX//Yt/nJ0eeToNEzKBfg==
X-Gm-Gg: ASbGncsP/oTwWdXBa0knwZd1bE7orpS1SMZVh2MpAs33GMHEIpa6oAw5s9YyzszBqNU
	EQ7Z+bXZUf4gE1dt9MmNHojXEWx6r6EpKK9hcr4QMhIn8CgvfDm2oAp5T2SZWgV59ZXeBVhxia3
	EokUT/XUoUEzZ4Q3p2tIELeSFGVAkWq9+zcFUoKp7T5h89XkmPKUJQsJ2G6YE+/JUuwyFhgiCBa
	mkqKykaNjJga/W4Cb6/Fc/QPvym6LdqSGkqWlo7KehHoW5aSw7cYZ6iQRDD+yawDTc0u8UH/8Od
	Tf6LuAIsuZO2cMZpGfB2rIwUVKR0MRo47XJxSyFMfVKAyJSkTPg8fh7Q+4uveQLhG7YeXto7IDb
	DRF3KzoVkJg7Cr0TfBqB3NMS61z4aglmu
X-Received: by 2002:a05:600c:4f46:b0:436:e3ea:4447 with SMTP id 5b1f17b1804b1-4396e779e07mr137823875e9.30.1739895873309;
        Tue, 18 Feb 2025 08:24:33 -0800 (PST)
X-Google-Smtp-Source: AGHT+IEiZ5rxlHdxPXpFFPr+JzM3cpCvVqgrwjDbUwnKiH44aMUSFkhzJPtpNvmRTDQhv+wflaXtjA==
X-Received: by 2002:a05:600c:4f46:b0:436:e3ea:4447 with SMTP id 5b1f17b1804b1-4396e779e07mr137823665e9.30.1739895872917;
        Tue, 18 Feb 2025 08:24:32 -0800 (PST)
Received: from ?IPV6:2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af? (p200300cbc70dfb00d3ed5f441b2d12af.dip0.t-ipconnect.de. [2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af])
        by smtp.gmail.com with ESMTPSA id ffacd0b85a97d-38f258b4423sm15693969f8f.11.2025.02.18.08.24.30
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Tue, 18 Feb 2025 08:24:31 -0800 (PST)
Message-ID: <2f759351-a01f-4b1a-bf37-793a42a67c69@redhat.com>
Date: Tue, 18 Feb 2025 17:24:30 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>, lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: QnzSB0NVZR3ie5EePI6g9axgDBMLLS9hLLX2WarAfYo_1739895873
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 2008
Lines: 52

> ---------------------
> Step 9: Memory Zones.
> ---------------------
> We've alluded to "Memory Zones" in prior sections, with really the only
> detail about these concepts being that there are "Kernel-allocation
> compatible" and "Movable" zones, as well as some relationship between
> memory blocks and memory zones.
> 
> The two zones we really care about are `ZONE_NORMAL` and `ZONE_MOVABLE`.
> 
> For the purpose of this reading we'll consider two basic use-cases:
> - memory block hot-unplug
> - kernel resource allocation
> 
> You can (for the most part) consider these cases incompatible.  If the
> kernel allocates `struct page` memory from a block, then that block cannot
> be hot-unplugged.  This memory is typically unmovable (cannot be migrated),
> and its pages unlikely to be removed from the memory map.
> 
> There are other scenarios, such as page pinning, that can block hot-unplug.
> The individual mechanisms preventing hot-unplug are less important than
> their relationship to memory zones.
> 
> ZONE_NORMAL basically allows any allocations, including things like page
> tables, struct pages, and pinned memory.
> 
> ZONE_MOVABLE, under normal conditions, disallows most kernel allocations.
> 

In essence, only movable allocations (some kernel allcoations are movable).

> ZONE_MOVABLE does NOT make a *strong* guarantee of hut-unplug-ability.
> The kernel and privileged users can cause long-term pinning to occur -
> even in ZONE_MOVABLE.  It should be seen as a best-attempt at providing
> hot-unplug-ability under normal conditions.

Yes and no; actual long-term pinning is disallowed (FOLL_LONGTERM), but 
we have a bunch of cases that need fixing. [1]

Of course, new cases keep popping up. It's a constant fight to make 
hot-unplug as reliable as possible. So yes, we cannot give "strong" 
guarantees, but make it as reliable as possible in sane configurations.

[1] 
https://lkml.kernel.org/r/882b566c-34d6-4e68-9447-6c74a0693f18@redhat.com


-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f179.google.com (mail-qt1-f179.google.com [209.85.160.179])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E905826E17D
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 17:03:21 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.179
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739898203; cv=none; b=Rsfmabw7CnvRdpl/K1Fz24nXNAE6Pd5tSgyrpmnOlBCJiufBBd3fdSNyfGeBZyqxFzb1rqwUVaBi53+Lj8fSK8X+84d24a8wDR8w9x83qlkULcxT9xzBLELMRNXh7ZIUW7PBK4khusj1U73aV6QIaR1iyraWWMqzm21NZgBUK24=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739898203; c=relaxed/simple;
	bh=cnsd8EpnOn16yEFgDgdtWwyyKvvgFRZv/c/CSY2mbYw=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=neFvps3Ov7Ey968T3pK0eZEEtqomzMykDSN+MMAmqO6lPshozSfKsaN0v7KA5MBUNOm5T4jhEksNNlEoLLkN8mnoRx3Tuj0GBsHdxDhvUVXkCgoqUTcJ9SI9/KPlf7UofCDRPQUo7VPyqb3D2aHT+CgxBk1QdjOC2WWZdizaFJs=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=KfUzdVpB; arc=none smtp.client-ip=209.85.160.179
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="KfUzdVpB"
Received: by mail-qt1-f179.google.com with SMTP id d75a77b69052e-471b71421afso58399371cf.3
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 09:03:21 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739898201; x=1740503001; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=r5IjKt2g0Aczbmk6DQb62mxFGljXMyBLR0GqY9xsUMs=;
        b=KfUzdVpBQjDJmQcg7eD1HZBlUxpqGOT+/s+Q/HJjUk86zqm3f9EBC24atYlrvFGmDf
         lxPlF5COWAIQWwiNocYJ6X50f17ZzAge/wYV3aT9JeoiegGpEbMiV4QsELqMwv7uzt5F
         VXltHmj55qYsjanU4Mjl1C8G6aOpoKnHSj6q9HGh6Jg1pRqQhM+I3g12fcT9Wv2gHYUZ
         4Lw3Q25sJ3xoWctlhpm+E6zAvgS2oDObludzSK2LusI6+AY6wF9v+7FMH4PY/O8C8e8J
         YXt9IywvKrIADzy6un4xuCBdmtI/cR1f6wbw/aC7tp13tUvdTly477H1h+vDPsK67rG5
         CqJA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739898201; x=1740503001;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=r5IjKt2g0Aczbmk6DQb62mxFGljXMyBLR0GqY9xsUMs=;
        b=GNc7C53CL1kz1Kn3hQDf/zkDLG/QfxzkA/Qtx/+SqnxrF4lS68bPtHoZ4sYuDnCO5M
         gMKQRPkfSIH5BZL4OoIv4vl1beic5MtYWKlcymlPbcKzR7+/JOq6YTH7pb7yFTGArM4M
         9pK26Z4Kx313hnUzY1lNO/6ScozWlbPFipAi4g00tNlawnog3kFYRN/vqHgARdRDHzJI
         YpCnH3jVgr4AvDXAj+ecjzoV7jQTVCneImFxIijeUfzW2kfrfXrfGaiWLQAzCleCnTna
         QTf8W4fVGvWYHhdpIHloOFETtXsUAU3MOw1OUDFobHXZvB/jUmyN1heWx0eUkTms3W7c
         Irmg==
X-Forwarded-Encrypted: i=1; AJvYcCXYMML0SvAr04OoKOcc5MEfnrsGR2i2kjUt1zkBLFSIFQwHmsXQR+AqblzDUHFzUpMg7bDkE+lMfF8=@vger.kernel.org
X-Gm-Message-State: AOJu0YwuXIzqshXkkH7+pRCnfwFHYsw1HnEN3x+PUWitnOITjMC4qIQx
	lQ0WZ5VQp38eACr2PEvjuylbNa7ysQYCoOSTFGA8QRQPd9/ESlKAVFK5md4oQuo=
X-Gm-Gg: ASbGncva3RvuXqUN6oOxNKlUWVTWh8q2oWU1UjiGC1o/yeOjneJE2o042Z9dXuhnu/0
	v2yC0epGUiN6qKNIlWyeGZr2LGoyFTgg1Eu45DkyHLgz0MqbjJEFJ+KpkgWAfhYQJdh1bJV+9HC
	867dDrNo+rAbVpVNAXm6I3qroQoPito3TppKdkGTP5UrvegFswAhFbCB/NRwNEt5yejajZ8x7R+
	17flLeFUsca4E1CS7tDyyOWHHJNapiFGndC5E8c8apCgBViRaeaJ+hXqQfualiypAoom6+9NmjX
	OPyzuoF6Y0BfxGaLm4olm1tKzK4RQCrdY0hcSUP72pYnSj/J/W/NFMc0WcoxjwnPqHZpGPxyWQ=
	=
X-Google-Smtp-Source: AGHT+IF1SzujkTq1mVXdF0mN3j9aOrEvWov+7KusXIsFJUidxIy7uFMB65yUvaOtGlB3iMRdQAcQWw==
X-Received: by 2002:a05:622a:1985:b0:471:bf80:b47f with SMTP id d75a77b69052e-47208284a30mr4368251cf.24.1739898200781;
        Tue, 18 Feb 2025 09:03:20 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-471f0eba93dsm24748191cf.80.2025.02.18.09.03.18
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 18 Feb 2025 09:03:19 -0800 (PST)
Date: Tue, 18 Feb 2025 12:03:17 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7S9VUqjWOKGxLFi@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <2f759351-a01f-4b1a-bf37-793a42a67c69@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <2f759351-a01f-4b1a-bf37-793a42a67c69@redhat.com>
Status: O
Content-Length: 1201
Lines: 30

On Tue, Feb 18, 2025 at 05:24:30PM +0100, David Hildenbrand wrote:
> > 
> > ZONE_MOVABLE, under normal conditions, disallows most kernel allocations.
> > 
> 
> In essence, only movable allocations (some kernel allcoations are movable).
> 
> > ZONE_MOVABLE does NOT make a *strong* guarantee of hut-unplug-ability.
> > The kernel and privileged users can cause long-term pinning to occur -
> > even in ZONE_MOVABLE.  It should be seen as a best-attempt at providing
> > hot-unplug-ability under normal conditions.
> 
> Yes and no; actual long-term pinning is disallowed (FOLL_LONGTERM), but we
> have a bunch of cases that need fixing. [1]
> 
> Of course, new cases keep popping up. It's a constant fight to make
> hot-unplug as reliable as possible. So yes, we cannot give "strong"
> guarantees, but make it as reliable as possible in sane configurations.
> 
> [1]
> https://lkml.kernel.org/r/882b566c-34d6-4e68-9447-6c74a0693f18@redhat.com
> 

Appreciate the additional context, I missed your topic proposal.  I was
trying to be conservative about the claims ZONE_MOVABLE makes so that I
don't present it as a "This will fix all your hotplug woes" solution.

Looking forward to this LSF :]

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-ed1-f45.google.com (mail-ed1-f45.google.com [209.85.208.45])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C37C626A089;
	Tue, 18 Feb 2025 17:49:41 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.208.45
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739900983; cv=none; b=FB39DffMDHkucgzFdWb5hjxqjV3EpbuekGcKRL9mDQOSRvEZ3Y33oJDYRJdrw/vZh+4recEFF2F+3tt5oA3Wvw2glhIVoSRqBy7IukfVLDfhykKJAclNjCxfZK+/tzEAg4suirYoFBVAzU6x40223g6TtWgmUzHjwOa1RIqibbM=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739900983; c=relaxed/simple;
	bh=tx9lR4J/0twZmUF+Dp+C2tfT55xfRl1U3HIbbiUM4hw=;
	h=MIME-Version:References:In-Reply-To:From:Date:Message-ID:Subject:
	 To:Cc:Content-Type; b=J8H3QSvZM6tw5yibJO9tWy/92g80vOJgAXGQIBxnuwd8m+myDIA+D6kvE5o6TumpJMkQdaxgpVIGWgLPTeE3Sj7FTBeG3L5dd97OQFs3q+lQUxXt9H9iE8xGuwzrXO989gy5DIMCcYA1xrOkzHVoIoo6Tb6GQMcvR1BBKz78srE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=gmMcCbtl; arc=none smtp.client-ip=209.85.208.45
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="gmMcCbtl"
Received: by mail-ed1-f45.google.com with SMTP id 4fb4d7f45d1cf-5e0505275b7so4600767a12.3;
        Tue, 18 Feb 2025 09:49:41 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1739900980; x=1740505780; darn=vger.kernel.org;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:from:to:cc:subject:date
         :message-id:reply-to;
        bh=j4D3RkKdQuZIty+oDae4mcM33z7ITGGOJJS9/JjB6iQ=;
        b=gmMcCbtlLNZBYK62M7182Xp20bLnaeVr4e5UIdeZJTnYEyrTg2ju9ewcC9IAqiAwnV
         jdpI8XxnV+4lhx7RuTqjDFsR9J/wPCP1pxPw30lyHZoB9oDiF3BraZfJvu+duxLzuMRC
         ftLjGM9W+cKTAOCK9s5+iyqRX82aStblFPjnsbczyQ4YMxnNGOEkVIXepPURFVk0izn+
         0VjsmDZTL2NVGhEqsPhrTTVu6bZUceK5aQVKNu9OpF25BoN3VE1PxHmk3DHW0z4y3nUH
         jAJqz3Z/6nnPJcAKvryJETn+CoXKqgi8NXwgFjL3J8yowK2F6d/07o2a+ON9LezKdDp/
         zv+A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739900980; x=1740505780;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=j4D3RkKdQuZIty+oDae4mcM33z7ITGGOJJS9/JjB6iQ=;
        b=MnlLzuDpNJMr3bHZU6iB05xRg/P0sNbGwgGyYED089ZdtZLhihPfebRNo3Z2xJCked
         Q5AFyvkcBax0PcKyEI4xZDpyzR3biQjncmfgmj63OJIIcaQQLZI08LrtaMDSjlT6hE59
         R2aJaQni20xL+DxK0CViNhEjodegJH0hDSMs2YaghxTcdE5ANqXyvS8Qhcf2BgdcZ6M/
         PeM7BVxZ0rmtdM7yoILepPZYrCQeo2UjPo51l3eZ5hkSjfp0fHAsjfPSjkqlpJSXirZe
         5vHn/2g6vmSEKFFqakN5hgTZ6kP+gfcxCwVThZs7bgb5vdXAYA6vZwUiGDUtACmno/sg
         hF4g==
X-Forwarded-Encrypted: i=1; AJvYcCV48QVbccom+/pbt3GyGVlOEqYOyioPViETI1i1oeHxUi4hEiHuHI+dV4XXNCw2LAah11uvqX9PROWqSHbo@vger.kernel.org, AJvYcCWZAha9LqhoQy5fMRQXr/7FskNv543ngX1Kj6a3tj8BT4o5qHPM/02hl8GvpvyzrpZOQbw2/bw3pLo=@vger.kernel.org
X-Gm-Message-State: AOJu0YwRH87q7ngXMU2lv4LU+8/cizP5NVc1ZPguHllENgq+Io2zmOky
	s1/yKG2g+MyANuMd6d6B9583J+LbQSdSzRkMELvQHtZo4dL36cGhNaKr4QIaPMOsfHFY9lfpGNK
	F1TLvVw6kX5h47N6HTvXToYu1yp0=
X-Gm-Gg: ASbGncuC6MeB7vYZLn/+zC6XZs0bjCvI1+9ghN4M6JYM6lWFI/gmMYt3FV7AuxuvgRZ
	Y66whJaekx37II2F6bWZ99Tpzj5W25PPdmwEK/kJtPmOzM5CE/JstoWxe0GGhTqsgKBHOXcNz
X-Google-Smtp-Source: AGHT+IF30cO73ZHk8lsLdxM9JqGuET62bpvaxA4FoYYrORLv6LwGBx/g81X9jt1z3YnCkAfBvl04sCjPVR2uLixOjJ0=
X-Received: by 2002:a05:6402:26d2:b0:5e0:51a9:d425 with SMTP id
 4fb4d7f45d1cf-5e089f2b807mr283207a12.29.1739900979572; Tue, 18 Feb 2025
 09:49:39 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F> <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
In-Reply-To: <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
From: Yang Shi <shy828301@gmail.com>
Date: Tue, 18 Feb 2025 09:49:28 -0800
X-Gm-Features: AWEUYZmAPUBBn9Bihii5OezBwEt76xfUEg_WniyupQXJMNKXU2HRJVUhdQfRZ6E
Message-ID: <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org, 
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
Status: O
Content-Length: 10982
Lines: 289

On Mon, Feb 17, 2025 at 12:05=E2=80=AFPM Gregory Price <gourry@gourry.net> =
wrote:
>
>
> The story up to now
> -------------------
> When we left the driver arena, we had created a dax device - which
> connects a Soft Reserved iomem resource to one or more `memory blocks`
> via the kmem driver.  We also discussed a bit about ZONE selection
> and default online behavior.
>
> In this section we'll discuss what actually goes into memory block
> creation, how those memory blocks are exposed to kernel allocators
> (tl;dr: sparsemem / memmap / struct page), and the implications of
> the selected memory zones.
>
>
> -------------------------------------
> Step 7: Hot-(un)plug Memory (Blocks).
> -------------------------------------
> Memory hotplug refers to surfacing physical memory to kernel
> allocators (page, slab, cache, etc) - as opposed to the action of
> "physically hotplugging" a device into a system (e.g. USB).
>
> Physical memory is exposed to allocators in the form of memory blocks.
>
> A `memory block` is an abstraction to describe a physically
> contiguous region memory, or more explicitly a collection of physically
> contiguous page frames which is described by a physically contiguous
> set of `struct page` structures in the system memory-map.
>
> The system memmap is what is used for pfn-to-page (struct) and
> page(struct)-to-pfn conversions. The system memmap has `flat` and
> `sparse` modes (configured at build-time). Memory hotplug requires the
> use of `sparsemem`, which aptly makes the memory map sparse.
>
> Hot *remove* (un-plug) is distinct from Hot add (plug).  To hot-remove
> an active memory block, the pages in-use must have their data (and
> therefore mappings) migrated to another memory block. Hot-remove must
> be specifically enabled separate from hotplug.
>
>
> Build configurations affecting memory block hot(un)plug
>   CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG
>   CONFIG_SPARSEMEM
>   CONFIG_64BIT
>   CONFIG_MEMORY_HOTPLUG
>   CONFIG_ARCH_ENABLE_MEMORY_HOTREMOVE
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_OFFLINE
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_AUTO
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_KERNEL
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_MOVABLE
>   CONFIG_MHP_MEMMAP_ON_MEMORY
>   CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE
>   CONFIG_MIGRATION
>   CONFIG_MEMORY_HOTREMOVE
>
> During early-boot, the kernel finds all SystemRAM memory regions NOT
> marked "Special Purpose" and will create memory blocks for these
> regions by default.  These blocks are defaulted into ZONE_NORMAL
> (more on zones shortly).
>
> Memory regions present at boot marked `EFI_MEMORY_SP` have memory blocks
> created and hot-plugged by drivers.  The same mechanism is used to
> hot-add memory physically hotplugged after system boot (i.e. not present
> in the EFI Memory Map at boot time).
>
> The DAX/KMEM driver hotplugs memory blocks via the
>   `add_memory_driver_managed()`
> function.
>
>
> -------------------------------
> Step 8: Page Struct allocation.
> -------------------------------
> A `memory block` is made up of a collection of physical memory pages,
> which must have entries in the system Memory Map - which is managed by
> sparsemem on systems with memory (block) hotplug.  Sparsemem fills the
> memory map with `struct page` for hot-plugged memory.
>
> Here is a rough trace through the (current) stack on how page structs
> are populated into the system Memory Map on hotplug.
>
> ```
> add_memory_driver_managed
>   add_memory_resource
>     memblock_add_node
>       arch_add_memory
>         init_memory_mapping
>           add_pages
>             __add_pages
>               sparse_add_section
>                 section_activate
>                   populate_section_memmap
>                     __populate_section_memmap
>                       memmap_alloc
>                         memblock_alloc_try_nid_raw
>                           memblock_alloc_internal
>                             memblock_alloc_range_nid
>                               kzalloc_node(..., GFP_KERNEL, ...)
> ```
>
> All allocatable-memory requires `struct page` resources to describe the
> physical page state.  On a system with regular 4kb size pages and 256GB
> of memory - 4GB is required just to describe/manage the memory.
>
> This is ~1.5% of the new capacity to just surface it (4/256).
>
> This becomes an issue if the memory is not intended for kernel-use,
> as `struct page` memory must be allocated in non-movable, kernel memory
> `zones`.  If hot-plugged capacity is designated for a non-kernel zone
> (ZONE_MOVABLE, ZONE_DEVICE, etc), then there must be sufficient
> ZONE_NORMAL (or similar kernel-compatible zone) to allocate from.
>
> Matthew Wilcox has a plan to reduce this cost, some details of his plan:
> https://fosdem.org/2025/schedule/event/fosdem-2025-4860-shrinking-memmap/
> https://lore.kernel.org/all/Z37pxbkHPbLYnDKn@casper.infradead.org/
>
>
> ---------------------
> Step 9: Memory Zones.
> ---------------------
> We've alluded to "Memory Zones" in prior sections, with really the only
> detail about these concepts being that there are "Kernel-allocation
> compatible" and "Movable" zones, as well as some relationship between
> memory blocks and memory zones.
>
> The two zones we really care about are `ZONE_NORMAL` and `ZONE_MOVABLE`.
>
> For the purpose of this reading we'll consider two basic use-cases:
> - memory block hot-unplug
> - kernel resource allocation
>
> You can (for the most part) consider these cases incompatible.  If the
> kernel allocates `struct page` memory from a block, then that block canno=
t
> be hot-unplugged.  This memory is typically unmovable (cannot be migrated=
),
> and its pages unlikely to be removed from the memory map.
>
> There are other scenarios, such as page pinning, that can block hot-unplu=
g.
> The individual mechanisms preventing hot-unplug are less important than
> their relationship to memory zones.
>
> ZONE_NORMAL basically allows any allocations, including things like page
> tables, struct pages, and pinned memory.
>
> ZONE_MOVABLE, under normal conditions, disallows most kernel allocations.
>
> ZONE_MOVABLE does NOT make a *strong* guarantee of hut-unplug-ability.
> The kernel and privileged users can cause long-term pinning to occur -
> even in ZONE_MOVABLE.  It should be seen as a best-attempt at providing
> hot-unplug-ability under normal conditions.
>
>
> Here's the take-away:
>
> Any capacity marked SystemRAM but not Special Purpose during early boot
> will be onlined into ZONE_NORMAL by default - making it available for
> kernel-use during boot.  There is no guarantee of being hot-unpluggable.
>
> Any capacity marked Special Purpose at boot, or hot-added (physically),
> will be onlined into a user-selected zone (Normal or Movable).
>
> There are (at least) 4 ways to select what zone to online memory blocks.
>
> Build Time:
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_*
> Boot Time:
>   memhp_default_state (boot parameter)
> udev / daxctl:
>   user policy explicitly requesting the zone
> memory sysfs
>   online_movable > /sys/bus/memory/devices/memoryN/online
>
>
> ------------------------------------------
> Nuance: memmap_on_memory and ZONE_MOVABLE.
> ------------------------------------------
> As alluded to in the prior sections - hot-added ZONE_MOVABLE capacity
> will consume ZONE_NORMAL capacity for its kernel resources.  This can
> be problematic if vast amounts of ZONE_MOVABLE is added on a system
> with limited ZONE_NORMAL capacity.
>
> For example, consider a system with 4GB of ZONE_NORMAL and 256GB of
> ZONE_MOVABLE.  This wouldn't work, as the entirety of ZONE_NORMAL would
> be consumed to allocate `struct page` resources for the ZONE_MOVABLE
> capacity - leaving no working memory for the rest of the kernel.
>
> The `memmap_on_memory` configuration option allows for hotplugged memory
> blocks to host their own `struct page` allocations...
>
>                    if they're placed in ZONE_NORMAL.
>
> To enable, use the boot param: `memory_hotplug.memmap_on_memory=3D1`.
>
> Sparsemem allocation of memory map resources ultimately uses a
> `kzalloc_node` call, which simply allocates memory from ZONE_NORMAL with
> a *suggested* node.
>
> ```
> memmap_alloc
>   memblock_alloc_try_nid_raw
>     memblock_alloc_internal
>       memblock_alloc_range_nid
>         kzalloc_node(..., GFP_KERNEL, ...)
> ```
>
> The node ID passed in as an argument is a "preferred node", which means
> is insufficient space on that node exists to service the GFP_KERNEL
> allocation, it will fall back to another node.
>
> If all hot-plugged memory is added to ZONE_MOVABLE, two things occur:
>
>   1) A portion of the memory block is carved out for to allocate memmap
>      data (reducing usable size by 64b*nr_pages)
>
>   2) The memory is allocated on ZONE_NORMAL on another node..

Nice write-up, thanks for putting everything together. A follow up
question on this. Do you mean the memmap memory will show up as a new
node with ZONE_NORMAL only besides other hot-plugged memory blocks? So
we will actually see two nodes are hot-plugged?

Thanks,
Yang

>
> Result: Lost capacity due to the unused carve-out area for no value.
>
> --------------------------------
> The Complexity Story up til now.
> --------------------------------
> Platform and BIOS:
>   May configure all the devices prior to kernel hand-off.
>   May or may not support reconfiguring / hotplug.
>
> BIOS and EFI:
>   EFI_MEMORY_SP              - used to defer management to drivers
>
> Kernel Build and Boot:
>   CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG
>   CONFIG_SPARSEMEM
>   CONFIG_64BIT
>   CONFIG_MEMORY_HOTPLUG
>   CONFIG_ARCH_ENABLE_MEMORY_HOTREMOVE
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_OFFLINE
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_AUTO
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_KERNEL
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE_ONLINE_MOVABLE
>   CONFIG_MHP_MEMMAP_ON_MEMORY
>   CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE
>   CONFIG_MIGRATION
>   CONFIG_MEMORY_HOTREMOVE
>   CONFIG_EFI_SOFT_RESERVE=3Dn  - Will always result in CXL as SystemRAM
>   nosoftreserve              - Will always result in CXL as SystemRAM
>   kexec                      - SystemRAM configs carry over to target
>   memory_hotplug.memmap_on_memory
>
> Driver Build Options Required
>   CONFIG_CXL_ACPI
>   CONFIG_CXL_BUS
>   CONFIG_CXL_MEM
>   CONFIG_CXL_PCI
>   CONFIG_CXL_PORT
>   CONFIG_CXL_REGION
>   CONFIG_DEV_DAX
>   CONFIG_DEV_DAX_CXL
>   CONFIG_DEV_DAX_KMEM
>
> User Policy
>   CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE (<=3Dv6.13)
>   CONFIG_MHP_DEFAULT_ONLINE_TYPE       (>=3Dv6.14)
>   memhp_default_state                  (boot param)
>   daxctl online-memory daxN.Y          (userland)
>
> Nuances
>   Early-boot resource re-use
>   Memory Block Alignment
>   memmap_on_meomry + ZONE_MOVABLE
>
> ----------------------------------------------------
> Next up:
>   RAS - Poison, MCE, and why you probably want CXL=3DZONE_MOVABLE
>   Interleave - RAS and Region Management
>
> ~Gregory
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f169.google.com (mail-qk1-f169.google.com [209.85.222.169])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5A362270ECB
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 18:04:54 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.169
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739901896; cv=none; b=OCUIiSvrGlPYEoU0ITrl9VJjFI9O06NI4xF5paNSpJWF065yxzqTu63oLyTfrl0uW79AzJ8uXNY8qp2fcVTFUIVWdNScGEMj8w3KMB5skI8+PnzenmxHJmKqG8MB0A1pnpFCnUMTu0RNgUK0mW0rCDMB2iDDcA6m1a/kzSJfdBM=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739901896; c=relaxed/simple;
	bh=89YH2L66JdBDvc/z1zr776bVYkPkPpM/OI3XRKn7/0U=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=RXbRxkHMeKUCDEQ+ZTffR5/ss4gCFN8FTzMjc7UXqdfFYaNmaOACYoL07x4SBGuI0C5tIa7Il25lTldhfXWorQNISAKrtRnRzPvvQ/6jZJbmaAKMY6edTSRQUAtLsaqQjaQHxlno26rkvVX6xB1n1EmSrPTffgrTYScu2npbpM4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=K0a6GdIy; arc=none smtp.client-ip=209.85.222.169
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="K0a6GdIy"
Received: by mail-qk1-f169.google.com with SMTP id af79cd13be357-7c0a26b1c67so220889185a.3
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 10:04:54 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739901893; x=1740506693; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=/2QkXBrR+RLY2Ff/8MHFN38wGfIHYvjpwObZxuk5dJA=;
        b=K0a6GdIyb3ewk6pQ6b1xuyURq3XEdUo5m64DbGAV0y45eDuLj/MDS2BZr/oRNzUGYI
         aNTlQkGSqRtSIlnkQFJE2sgfpbqzP2GwBh8A6pqGXjAc4QRpDJvDEQGE91YVI+5NYS3H
         AJLRbV2a0dJ8goyv+69bJjzEUwC50EJZW7IxZcghhIOOpyQExcKymOWqTukXu7HoYNkh
         9h0hMGg0YMrW1u4OsLEbKDlC3vj1eokY3Hu2IeS1cD1sUphPpsd5ASwniV7mh7h1EyQh
         nCO/ihxAZDkhvkA72NNbr9nWP9u+hp5mAO6SFW1JAtCjamDrF0p6CQx/KoiWjvSfyBpG
         kyqg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739901893; x=1740506693;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=/2QkXBrR+RLY2Ff/8MHFN38wGfIHYvjpwObZxuk5dJA=;
        b=C7DY1BCQz4XYLiIVJhx6kdSnmnre9nN6DXPruWZHGJp1x1Xl7A76aav60uHK7FpD9y
         h8vuYDJ7k09WSQBgmSgyTcqK0g2m7ew++/CmLgFeT5rd6pCnY6YQF3fikcZnNOUdY4v2
         Lj35h6h1X8yMiYhZf24tVh8bEazdDzmkkfwyWvqgtsyCtQV0K4qvXjo5Z1J5wY9ZUnNC
         ZgPiqkVBblrqmpC91ybrwEEseMxsTfDKIwRBw7ldM0WnQywXwY0edhzWxj7+h+IaPbXE
         vTlX8J/P9ObMO0reboWz4iKoO21Ick10Sdllpu12lF/KXp/Ueog092YsFgAEfMrhH2hm
         Vu3g==
X-Forwarded-Encrypted: i=1; AJvYcCXRaATrZFGwDJHeeUG0JhuAHD3Ay96RyTQUW/dP37M6DvFoglXr2+PJni0toYgihKlw4c7QhVn6Jx4=@vger.kernel.org
X-Gm-Message-State: AOJu0Yz+gObPMG2Kw1ujTX8X5LsBC8/wkRuPZrfIOI+azJnkubjIRJh5
	0u3Clxu9m53PHZ7WUMXVgkHN7XJuyPlqSAiPUXg7lxa0Gs0Pmmy94zfpg2lKrXg=
X-Gm-Gg: ASbGncvESw6ozcE6xZ9z8KwG6oa7Llyn58qGmwSxMEj0CvsGFq3e7XYLgm9LKuB1J1b
	DBcF2ZhBF1rXKpEMd/0lWVfmeJtlPmU+O5spXdbfKYkNR5/9Ktnb7Q45k00IzQ8hi0d/WCoq3jr
	BdcK+LdVbJJIoGZ7WwC7p4VX32mmEIjOM473zHpSUTQLNbgnBtYLs1O0wkRWihkq6nh64Ll/Zey
	ji6cGdWe/VEBAijPB6d3sWPVzsgT1CHkV/molKo7xp6ofRpYh9Bt6SpBiugTC1T27XmeEmEGJk3
	csiFZoXLhmSlLbDcGx1Oj9fK4y4wh5BuHMXL4jUiWy9YbrWRni8K6CSUEwIIyAAfSuJJ5Joysg=
	=
X-Google-Smtp-Source: AGHT+IEprOBQSn3Ytg4X7qFQ2WbvhHazV+Lw3tNlJvmsytmgmsjBdXJWK9TXucgmcuhpw5lyap3g8A==
X-Received: by 2002:a05:620a:2b4a:b0:7c0:ae2e:62ff with SMTP id af79cd13be357-7c0ae2e6516mr464537585a.22.1739901893011;
        Tue, 18 Feb 2025 10:04:53 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c0a852b95fsm162892085a.116.2025.02.18.10.04.52
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 18 Feb 2025 10:04:52 -0800 (PST)
Date: Tue, 18 Feb 2025 13:04:50 -0500
From: Gregory Price <gourry@gourry.net>
To: Yang Shi <shy828301@gmail.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
Status: O
Content-Length: 1172
Lines: 31

On Tue, Feb 18, 2025 at 09:49:28AM -0800, Yang Shi wrote:
> On Mon, Feb 17, 2025 at 12:05PM Gregory Price <gourry@gourry.net> wrote:
> > The node ID passed in as an argument is a "preferred node", which means
> > is insufficient space on that node exists to service the GFP_KERNEL
> > allocation, it will fall back to another node.
> >
> > If all hot-plugged memory is added to ZONE_MOVABLE, two things occur:
> >
> >   1) A portion of the memory block is carved out for to allocate memmap
> >      data (reducing usable size by 64b*nr_pages)
> >
> >   2) The memory is allocated on ZONE_NORMAL on another node..
> 
> Nice write-up, thanks for putting everything together. A follow up
> question on this. Do you mean the memmap memory will show up as a new
> node with ZONE_NORMAL only besides other hot-plugged memory blocks? So
> we will actually see two nodes are hot-plugged?
> 

No, it creates 1 ZONE_MOVABLE memory block of size

                   (BLOCK_SIZE - memmap_size)

and as far as i can tell the actual memory map allocations still
occur on ZONE_NORMAL (i.e. not CXL).

So you just lose the capacity, it's just stranded and unused.

> Thanks,
> Yang
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E91AF21B9F6
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 19:26:05 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.133.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739906767; cv=none; b=IjjO1TPYqWjk4yvDMDkuKeW+TIFNXRzPIGZ7mvXVgKTzZvRsZh4unhIVLugmJ30gijwdapKHkSAJUsQcR4w9fgwDkE4SsPR4liR4pjnbYQUNRM4CP1p+RmESm2MI+sUke03Qiz7bmMWjx4FFH9w5FtFA2r1uDMlOou0A/3fzONA=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739906767; c=relaxed/simple;
	bh=nwJk52yHaYxvd/snVr31b0tcpHkXR77LuokApJ7Vcpg=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=CTGxKy8EydgLU7Cx/ibwn0ZyExZLVFyQ/7As2fCcXbJxzYII5TgSlNGINIDxN99SnCwT9FHPfMygXGnlm0kf2DyhjUbHf+NdI8ijWL6WiIGHA7XftufE6wceQgzvR4Ea+VPKOeG6HF3REo1+CYR/pkwIpdpPzb32kI8Fv78FNJ4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=LavVP5OP; arc=none smtp.client-ip=170.10.133.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="LavVP5OP"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1739906764;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=ZheJrrl/+szmf1Pt3zwPzLYDDz3uD8c7iU2qgn0Duac=;
	b=LavVP5OPfytaORura71gFylcvBgwm3Kdyub3wBmSQIUOf0FSBVN3uPkMSi+BAOtJ3RhPmm
	OYs4sLef5XNt2jVIJH/YtMuzNBT0k69torwe55ucrlX1q1mBJoAIS4vU/2czcGzNeYJjFO
	XxuURvcE4MblAn0jtxezNEPtLNr7lDk=
Received: from mail-wr1-f72.google.com (mail-wr1-f72.google.com
 [209.85.221.72]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-628-_XQriAHqOeqPEbIvbhvozw-1; Tue, 18 Feb 2025 14:26:03 -0500
X-MC-Unique: _XQriAHqOeqPEbIvbhvozw-1
X-Mimecast-MFC-AGG-ID: _XQriAHqOeqPEbIvbhvozw_1739906762
Received: by mail-wr1-f72.google.com with SMTP id ffacd0b85a97d-38f2ef5f0dbso2168708f8f.2
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 11:26:03 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739906762; x=1740511562;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=ZheJrrl/+szmf1Pt3zwPzLYDDz3uD8c7iU2qgn0Duac=;
        b=s/7NYy11sjuw6HODadiR8U/NGR+KXgNBT5D/DTjkxdz6JStvkefyI+3OgoL/SMnOZw
         ubuUGxauReuxQjbFA3EbyGMqbcT48tw9jSnrNsBQ+BL/4Jy3kxF8Nd5EXyT+mAu9fg/K
         3dJinGNeS9iIMfxuFahrFssWKrfOSDchfL1X7HhFKzXYLLoHVqNYnQ4ac6rwlJjlhMrE
         im4BEFXizeDvVUw76XjMLMFgxtIL5rY0gv2TBBW+1OPSW+zRRzFXOoxJ2onlTJYgF7Xg
         V6e94UARVtyz2FelSoWNSJHmz5K6oQh24/Uuu9n65FNN3Q/8XCTgm+sJaOM1nhu/pBpD
         56TA==
X-Forwarded-Encrypted: i=1; AJvYcCXnFICbY7GcfId5LuuGQF+PVTRJyHBZ29xkhrHHdylrSJqYcJgRH/zzZnudRKuxtAHilzbLievJFkk=@vger.kernel.org
X-Gm-Message-State: AOJu0YxQ4xjxtwaSltO3Ko2gPQO19u1OqRs0RNK636TCdN/GrnNM3ue5
	aZyZoT2Ca3gAYdv1nH5gv3MERKv5fqhqXCSoyJ83cBMO6oPL5bveeLmcWQdvyGZZr0YCV8QVGlC
	3+PnoL3BzzoLIHTL/jtJ5h+4agX7/oi6kuF9q0f2ZOqEguSX/6a3OKoYa8Q==
X-Gm-Gg: ASbGncsoM9LZ1N3rODMyxjk8eq2rzbtkIsoJ7wFcvk48fy71OZPUvdFZeHU5wtdxGDL
	K8OKyPG7rUXM96YcfPpSks6YPTn8TjriWeRkQmJqaJ32csOJWrYhQMYmViIcGnubwHYu+UqZdyA
	SlEQxxa2SaOPeYnnYS0GdQI66RXmgZfRAtZmGFHTRpuEMBBQ6bBaBR0m7m5rIIMGvIRsW6Kfdey
	Gf3Ib6AHEgp93zjBkn54x6k3wZ57WRAOldSvNRQhaJ0yoAlf0py7KXAnM/PBSLl2Ut63u801juE
	m2G/AJ9kMyCMMoon76NRNMvFwle5vnHxDCltxEWQJhYa6mOVcPJ9alajkmnAqA7zVYSPSN9T+jw
	UtPOigHXgW9kEhu6I9owL/amFQaunbsTI
X-Received: by 2002:a5d:6c63:0:b0:38f:4b2c:2475 with SMTP id ffacd0b85a97d-38f4b2c255amr6889150f8f.20.1739906762342;
        Tue, 18 Feb 2025 11:26:02 -0800 (PST)
X-Google-Smtp-Source: AGHT+IE2+TxYTALjdCrXK7nzVIJ9gqCfpVhvtmHfRY7+jlAoZQBF7tynDq9Tork1X9JveH8HiTXnNQ==
X-Received: by 2002:a5d:6c63:0:b0:38f:4b2c:2475 with SMTP id ffacd0b85a97d-38f4b2c255amr6889130f8f.20.1739906762005;
        Tue, 18 Feb 2025 11:26:02 -0800 (PST)
Received: from ?IPV6:2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af? (p200300cbc70dfb00d3ed5f441b2d12af.dip0.t-ipconnect.de. [2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af])
        by smtp.gmail.com with ESMTPSA id ffacd0b85a97d-38f258fc7ecsm15598329f8f.49.2025.02.18.11.25.59
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Tue, 18 Feb 2025 11:26:00 -0800 (PST)
Message-ID: <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
Date: Tue, 18 Feb 2025 20:25:59 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>, Yang Shi <shy828301@gmail.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
 linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: Fg9mefaKJ4BO6-Z_g_kj4S0oOyjCYn_gh3jlZPOG7n4_1739906762
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
Status: O
Content-Length: 1822
Lines: 49

On 18.02.25 19:04, Gregory Price wrote:
> On Tue, Feb 18, 2025 at 09:49:28AM -0800, Yang Shi wrote:
>> On Mon, Feb 17, 2025 at 12:05PM Gregory Price <gourry@gourry.net> wrote:
>>> The node ID passed in as an argument is a "preferred node", which means
>>> is insufficient space on that node exists to service the GFP_KERNEL
>>> allocation, it will fall back to another node.
>>>
>>> If all hot-plugged memory is added to ZONE_MOVABLE, two things occur:
>>>
>>>    1) A portion of the memory block is carved out for to allocate memmap
>>>       data (reducing usable size by 64b*nr_pages)
>>>
>>>    2) The memory is allocated on ZONE_NORMAL on another node..
>>
>> Nice write-up, thanks for putting everything together. A follow up
>> question on this. Do you mean the memmap memory will show up as a new
>> node with ZONE_NORMAL only besides other hot-plugged memory blocks? So
>> we will actually see two nodes are hot-plugged?
>>
> 
> No, it creates 1 ZONE_MOVABLE memory block of size
> 
>                     (BLOCK_SIZE - memmap_size)
> 
> and as far as i can tell the actual memory map allocations still
> occur on ZONE_NORMAL (i.e. not CXL).
> 
> So you just lose the capacity, it's just stranded and unused.

Hm?

If you enable memmap_on_memory, we will place the memmap on that 
carved-out region, independent of ZONE_NORMAL/ZONE_MOVABLE etc. It's the 
"altmap".

Reason that we can place the memmap on a ZONE_MOVABLE is because, 
although it is "unmovable", we told memory offlining code that it 
doesn't have to care about offlining that memmap carveout, there is no 
migration to be done. Just offline the block (memmap gets stale) and 
remove that block (memmap gets removed).

If there is a reason where we carve out the memmap and *not* use it, 
that case must be fixed.

-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f46.google.com (mail-qv1-f46.google.com [209.85.219.46])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CB1DC1E0DB0
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 20:25:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.46
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739910342; cv=none; b=Vt0HUX5uJUhTvhSBHDd727nKi0aSqJAbXIDVKKJLg0E9ATQsON9Id7LTlG0A6/j2WwRn+ylx1nI+OCG08Lzvbf39Ew/5P4zWIxNdbZKR08lPDQ0dZ0GpHi77OE748PYGT07uTYTXJc14OhN29Vtwfvdwf8HffGzeIHG/NxcHS2s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739910342; c=relaxed/simple;
	bh=cDkEeHC9gnLs+ohg4PIIyzg8RBeo4zppUQIu/rcKYug=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=ZANC3ETQN2lUvQRaGd4ySQ5VDkynYUmMWhCJ6P1Nv/zzOsmWNsPvTr1Rz7DnuP0IzG2tfLG25HXGhouHAGSScYCGQvXf24RLNbxIa4oDmjJMeaVhBUKGrgjYHCR3LDao53t+t75l+7k1+l8Abqv7IqWgpcdl7OydGUycr6DgHUE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=gHIkD4zo; arc=none smtp.client-ip=209.85.219.46
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="gHIkD4zo"
Received: by mail-qv1-f46.google.com with SMTP id 6a1803df08f44-6e6698667c7so53558036d6.2
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 12:25:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739910339; x=1740515139; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=22K3K8H/Z4VEtlmzFLZqURw4WdVHs3LP2poxDfotsZE=;
        b=gHIkD4zoR5M7kIF6gESfGO6ZGntALAOdRrImpbY/3pCxKxl33jSyuKS3rIEYXbvkHg
         PH2GkmoZbt6LPZO2zwiirLkna8cOA/Qk6l06Fo3fzq+htVrZX5Pp9RiL+0xrgD1Be2He
         AEtrJ/eTsaTSYzttNoZAef+eavyKoWSbY5Xl2iEgIMR+wYdS+O3IGAHtUpf6Yqh6Lh1P
         d+bbJfW3aqjY2j94gM9jW5XIBIFZkwwrRnRe09zZKbyTBZg9RYGYGxcO1ZHY0ZdBLEGp
         AL3ozj6SAdDq4Z8Hzzts/CnsmcIw43p/GZewaWKA+sLHV5jMniP8JLuPJMTCWJRS9ntw
         NUyg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739910339; x=1740515139;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=22K3K8H/Z4VEtlmzFLZqURw4WdVHs3LP2poxDfotsZE=;
        b=TXAiT2cpzF2FTyGprKQrMkS0IPYcek10fQmSghMybKr58Y2kSx37RHhHAZHRwCotIn
         NUPA02i5rQdcZzv+1eHGmV3Ut1zDPQZluCx3NJF+ADw7Fd+V2rUIsFG+PGLqtKwFVDQ4
         ofzzCZcNyXXJPyEzcQoGurJ8b77oL9Np1pt5jxmbaO2r6ufR3yh18akMg73fSM5QvS9v
         gQEzzdCKUXwoW0NxG0a7kU9arlemheMLy5iom+FIUs1BWV/vbIu5y9tKctPCWMlr/fB+
         2I3rRr3gSnOJbjNupUrv+p5Sjdmved1yy1M6imOVaBa87Xl+mJzHGk2G2Km0CA2SPjUM
         LjMw==
X-Forwarded-Encrypted: i=1; AJvYcCVD/P86BEzVY/SI3o58defxSt+t8UeTemexNrHNr7Mpz/e94Xq60stxDcHfJlcpRjtybn2HQ9NhDRA=@vger.kernel.org
X-Gm-Message-State: AOJu0YzHvJf+JayPG2LY1nOBkcnnPeBCs9JHoBrJX9ebx6kBQXmRwzhE
	iNhw+gvJJvplObWsFBOcXHTgG8xkx6lXOyTcbxLB7tCD+4ZQysKuPW2Hpy8T0JQ=
X-Gm-Gg: ASbGncsWOTnyireoZ5AjJGo81IkLBq9qpTRbOzq3XxK9FvPNCYmm80IExNq7eNakDHK
	sT5JRDpWOBUuUYoxhDr9p93JwVG5VaRUx4g30+NJ2zCO1BRPB+Lfa1J0kJBmD7rrAP5HfOnCOe6
	VHD+aCvNB+eixD9r4IhXRenUINDI33ztvqM5zLDUGv9m55sF2rpNtL5laMXNtft2jsjhr8847FI
	q8J2y3QMZl2jiXFjFvRUBX6jFSGSx9Jj8x1fSeadXVD58a57DNn/pJdJnqQwU3aHuCMr0nmdLne
	iiaOtVyXVcYUR6WAz11c0kwn16tuxS5Ij10IP9o0ZU2OtUOnQxA8roPqmUDw8Q3yBHGQwBD2IA=
	=
X-Google-Smtp-Source: AGHT+IEI19wWOEv8YZ18w+TjkiABH7btIaZS7NvAL6Op0w+BcszJCj70Cd8D/1/PYxxqGY2625dWkA==
X-Received: by 2002:a05:6214:300e:b0:6e6:5bb2:c1a6 with SMTP id 6a1803df08f44-6e66cd064f7mr220329296d6.28.1739910339666;
        Tue, 18 Feb 2025 12:25:39 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c09a14d45dsm308921585a.10.2025.02.18.12.25.38
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 18 Feb 2025 12:25:38 -0800 (PST)
Date: Tue, 18 Feb 2025 15:25:37 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
Status: O
Content-Length: 2077
Lines: 50

On Tue, Feb 18, 2025 at 08:25:59PM +0100, David Hildenbrand wrote:
> On 18.02.25 19:04, Gregory Price wrote:
> 
> Hm?
> 
> If you enable memmap_on_memory, we will place the memmap on that carved-out
> region, independent of ZONE_NORMAL/ZONE_MOVABLE etc. It's the "altmap".
>
> Reason that we can place the memmap on a ZONE_MOVABLE is because, although
> it is "unmovable", we told memory offlining code that it doesn't have to
> care about offlining that memmap carveout, there is no migration to be done.
> Just offline the block (memmap gets stale) and remove that block (memmap
> gets removed).
> 
> If there is a reason where we carve out the memmap and *not* use it, that
> case must be fixed.
> 

Hm, I managed to trace down the wrong path on this particular code.

I will go back and redo my tests to sanity check, but here's what I
would expect to see:

1) if memmap_on_memory is off, and hotplug capacity (node1) is
   zone_movable - then zone_normal (node0) should have N pages
   accounted in nr_memmap_pages

   1a) when dropping these memory blocks, I should see node0 memory
       use drop by 4GB - since this is just GFP_KERNEL pages.

2) if memmap_on_memory is on, and hotplug capacity (node1) is
   zone_movable - then each memory block (256MB) should appear
   as 252MB (-4MB of 64-byte page structs).  For 256GB (my system)
   I should see a total of 252GB of onlined memory (-4GB of page struct)

   2a) when dropping these memory blocks, I should see node0 memory use
       stay the same - since it was vmemmap usage.

I will double check that this isn't working as expected, and i'll double
check for a build option as well.

stupid question - it sorta seems like you'd want this as the default
setting for driver-managed hotplug memory blocks, but I suppose for
very small blocks there's problems (as described in the docs).

:thinking: - is it silly to suggest maybe a per-driver memmap_on_memory
setting rather than just a global setting?  For CXL capacity, this seems
like a no-brainer since blocks can't be smaller than 256MB (per spec).

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2B79C1C8622
	for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 20:57:12 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.133.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739912235; cv=none; b=qPxqOT3TL+p1VKKURCv9fIt6JcMibN7dr7n2CpIczgpMPwCRYqiOBmpRlezfhH0w1ypcFznCLi2YEKd9kWZELkISwn4ta9pyDR5FI24iHNBCQEz9KRBVMGN7RVhdLZ07zmafu4HrJcKP5ogd12ItLmp/Gq7d0vSvbM4tupH0kek=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739912235; c=relaxed/simple;
	bh=gpas5oUxzPV/XGxLFH15XGgXxDqbVNLYvjgja7B7R+E=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=fCoo7Vot3p95PhI1wOk+GScKUZiSt3RuwXHvyr7nYmOAt63SKOySW7mGX9+qw8Wx1rHmdv1NyPJjli2KPWzO7Ts6CnhadWfdBsVxp24+0ospEUy7yBVvasirhPFNddCYGGLqDSf55qO9h72UBKTBXIF+3yR7Syb34UPqlq+Se+k=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=OFWfhLVq; arc=none smtp.client-ip=170.10.133.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="OFWfhLVq"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1739912232;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=6FsbwLcxUhHZW9FHTie3Ead3JpCjVkROaSdeAT2Lgyo=;
	b=OFWfhLVqlKtFVi3EP/h1X72IgDwgaLxHKz0gf4+bs3m8PbWzEDvbLQ8Ft1W2cqF0nduXTh
	6GgOMtPGXMeVdDSBpozEP6ds7p81AKH3ENN6q+9Q+HfFYqKa09IHvxlC3eD5qLqOwMH/DC
	f6B+4+O+YMg/Q7jB/AXFeqJ4VsN0AiM=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-20-zTlKLvHzOsKNJ8fH7a9uOA-1; Tue, 18 Feb 2025 15:57:10 -0500
X-MC-Unique: zTlKLvHzOsKNJ8fH7a9uOA-1
X-Mimecast-MFC-AGG-ID: zTlKLvHzOsKNJ8fH7a9uOA_1739912230
Received: by mail-wr1-f71.google.com with SMTP id ffacd0b85a97d-38f44be93a8so1394195f8f.1
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 12:57:10 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739912229; x=1740517029;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=6FsbwLcxUhHZW9FHTie3Ead3JpCjVkROaSdeAT2Lgyo=;
        b=c5LwCJ1T+T27AyK2Hzk+pWShPUOWjV0MewNh6Cm0UK2ky8Ezl8J61rlSrLCocWfqzJ
         KPBsrXZo1KUnlEfPF8LEbQEJ1JmmYK1D+adFlQQ5KJtTIfkveY4KNFKIyLCLVSId4f49
         lfHo5hzOBMTYllb9cN1ZkT696SLAvj/bxbNPuwh8d/TdxNx4arXygi0waleEeL4gcAMs
         N6NSpI8sDn7KUwcEWsAdohwcwhU0s0Gwm7Emxu3YEYVXsAJEKpiNwATnAuF0hk2sq7IX
         MuJgvCvajAFCIQso5TPx8JN2LUIbkLUC+HQDYtOAVunoo1nEPI/+NaKz9ZRBr1CSNpqC
         VEUw==
X-Forwarded-Encrypted: i=1; AJvYcCVvc277EzUwYqPZwqmIjfPAPSstZwNoU6HyIUOAxu5EHXFqFkY2ZubweVd6c2iAzi0NUJkU2vjS1lc=@vger.kernel.org
X-Gm-Message-State: AOJu0YzAAZc+WLP3bb3gR971kevXsj4wAv6He78ri0PiK4l+dslxJ8Zj
	D6oBH8kfiV0QIvdTgm5IJN4MHjloX+EraWQ2Q4cMPbnGoRULo80E44OrvY959dRoR1ejoIwZLv7
	iKKWNw2jVCxwI0S1c+A/Ol2o3XkCP7u02+bTWjkHBESH7Kd7catWh/nC7hQ==
X-Gm-Gg: ASbGnctjAoLBQl3vladtO0TunBjB5IwO8DWhR7V3Y+JpW7Z7vIr0gUzh/07kP9ulSgC
	n8EYuczbfEocLDLQQ79w/7PbQEu5G4TGbGD/QPE38eyjOsZCpJd8n0MxISZueQdj2c1S2iuZAHk
	u3f4+3x1tpQSuNq+D9ghwwfRhlGLzwFO8isB2NOwrcRdU+tdhk+zXwd4LI8/v2si48k4r0vF6Iv
	yHC1OeZc3X/djvrc/d3wl2stjt+CE7dhlV4ZDMO6tQ1TYdELQGrxQRWFFvWOAG+4vXJvKxHePzE
	luDnjbwCzvTpXzhu/JFMlwHtRLCC3bI0wsTc0d8pio1mCUyd3DIskuVZNwy8kp24mxc0nh3AVaW
	l4RyU4RZfeZ5gzImgsgShfM3K2vSPCTZD
X-Received: by 2002:a05:6000:1faf:b0:38f:3392:9fd8 with SMTP id ffacd0b85a97d-38f5878dea4mr808588f8f.18.1739912229604;
        Tue, 18 Feb 2025 12:57:09 -0800 (PST)
X-Google-Smtp-Source: AGHT+IEhJl5VYJN1ZER6U6SOjF2yYBkVq3hxhtLzuzokjKHCH1grxuxyGuoLNfn8/aO4cMRuRSnstQ==
X-Received: by 2002:a05:6000:1faf:b0:38f:3392:9fd8 with SMTP id ffacd0b85a97d-38f5878dea4mr808574f8f.18.1739912229238;
        Tue, 18 Feb 2025 12:57:09 -0800 (PST)
Received: from ?IPV6:2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af? (p200300cbc70dfb00d3ed5f441b2d12af.dip0.t-ipconnect.de. [2003:cb:c70d:fb00:d3ed:5f44:1b2d:12af])
        by smtp.gmail.com with ESMTPSA id 5b1f17b1804b1-43987d1865asm62509405e9.3.2025.02.18.12.57.06
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Tue, 18 Feb 2025 12:57:08 -0800 (PST)
Message-ID: <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
Date: Tue, 18 Feb 2025 21:57:06 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
 linux-mm@kvack.org, linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: zngC0OOYj_5uwl5EEtc0txYT7ZCWenUk73r13D7mQc0_1739912230
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 3519
Lines: 102

On 18.02.25 21:25, Gregory Price wrote:
> On Tue, Feb 18, 2025 at 08:25:59PM +0100, David Hildenbrand wrote:
>> On 18.02.25 19:04, Gregory Price wrote:
>>
>> Hm?
>>
>> If you enable memmap_on_memory, we will place the memmap on that carved-out
>> region, independent of ZONE_NORMAL/ZONE_MOVABLE etc. It's the "altmap".
>>
>> Reason that we can place the memmap on a ZONE_MOVABLE is because, although
>> it is "unmovable", we told memory offlining code that it doesn't have to
>> care about offlining that memmap carveout, there is no migration to be done.
>> Just offline the block (memmap gets stale) and remove that block (memmap
>> gets removed).
>>
>> If there is a reason where we carve out the memmap and *not* use it, that
>> case must be fixed.
>>
> 
> Hm, I managed to trace down the wrong path on this particular code.
> 
> I will go back and redo my tests to sanity check, but here's what I
> would expect to see:
> 
> 1) if memmap_on_memory is off, and hotplug capacity (node1) is
>     zone_movable - then zone_normal (node0) should have N pages
>     accounted in nr_memmap_pages

Right, we'll allocate the memmap from the buddy, which ends up
allocating from ZONE_NORMAL on that node.

> 
>     1a) when dropping these memory blocks, I should see node0 memory
>         use drop by 4GB - since this is just GFP_KERNEL pages.

I assume you mean "when hotunplugging them". Yes, we should be freeing the memmap back to the buddy.

> 
> 2) if memmap_on_memory is on, and hotplug capacity (node1) is
>     zone_movable - then each memory block (256MB) should appear
>     as 252MB (-4MB of 64-byte page structs).  For 256GB (my system)
>     I should see a total of 252GB of onlined memory (-4GB of page struct)

In memory_block_online(), we have:

	/*
	 * Account once onlining succeeded. If the zone was unpopulated, it is
	 * now already properly populated.
	 */
	if (nr_vmemmap_pages)
		adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
					  nr_vmemmap_pages);

So we'd add the vmemmap pages to
* zone->present_pages
* zone->zone_pgdat->node_present_pages

(mhp_init_memmap_on_memory() moved the vmemmap pages to ZONE_MOVABLE)

However, we don't add them to
* zone->managed_pages
* totalram pages

/proc/zoneinfo would show them as present but not managed.
/proc/meminfo would not include them in MemTotal

We could adjust the latter two, if there is a problem.
(just needs some adjust_managed_page_count() calls)

So yes, staring at MemTotal, you should see an increase by 252 MiB right now.

> 
>     2a) when dropping these memory blocks, I should see node0 memory use
>         stay the same - since it was vmemmap usage.

Yes.

> 
> I will double check that this isn't working as expected, and i'll double
> check for a build option as well.
> 
> stupid question - it sorta seems like you'd want this as the default
> setting for driver-managed hotplug memory blocks, but I suppose for
> very small blocks there's problems (as described in the docs).

The issue is that it is per-memblock. So you'll never have 1 GiB ranges
of consecutive usable memory (e.g., 1 GiB hugetlb page).

> 
> :thinking: - is it silly to suggest maybe a per-driver memmap_on_memory
> setting rather than just a global setting?  For CXL capacity, this seems
> like a no-brainer since blocks can't be smaller than 256MB (per spec).

I thought we had that? See MHP_MEMMAP_ON_MEMORY set by dax/kmem.

IIRC, the global toggle must be enabled for the driver option to be considered.

-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f175.google.com (mail-qk1-f175.google.com [209.85.222.175])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id D79F1B66E
	for <linux-cxl@vger.kernel.org>; Wed, 19 Feb 2025 01:10:14 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.175
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739927416; cv=none; b=AzmKr2c7Dp5MZrOOg7J2K5PynEAVJ7f9u4AgjelHDRdoA+VqhF/Vv30RmJhZxglN0vqRXyg6i5Zy4JbT+xFJxQx5ueEZkJCP7Go/nCJvL/AmI/5Hm6sSN53rL0BEOtXIHmVzKgkbcjHLCSJL/qGicIZczWpTW+hGPA6b7HicIzo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739927416; c=relaxed/simple;
	bh=UGNs0ZW6hb7R/Hw/kagHqKOGU8gopsipQ9iM7x6k7x8=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=BZV/ClnHX1b0ykzk89Me8EC/8EnWjuj9waXpXt+nrdWIL9Jhfx2uPySOLI90EzfKo/NjgiGjrUexoc624QMfXxh5BtqhAdm3SS2Q1yOvbJn0AsFF4xA1mmswgkEzfpDbuWOvVCUSo/xrA3w5P5RvjhLipMxNo94MtDEjjc38T5o=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=bVWws8qO; arc=none smtp.client-ip=209.85.222.175
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="bVWws8qO"
Received: by mail-qk1-f175.google.com with SMTP id af79cd13be357-7c08fc20194so570915585a.2
        for <linux-cxl@vger.kernel.org>; Tue, 18 Feb 2025 17:10:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739927413; x=1740532213; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=mUpwLBw+Z1T0MkCckOh5bFyJys42TZYUDiEdEk41zSc=;
        b=bVWws8qOVDmI9nXMB6pK5actNUiveL/W2/iHsy+Z/fc8eCAAWrqiiXsLkc/ZmS6Kx6
         oFvwHK6caNJaGRYbOmRb6ALSbMC2bo/KGU72R0FYoCkHdWZF5YfwV3hEEM0ts0YNg8+4
         bvGJjovT8DfUFq5Meexte6gWyx1AHIQs/GhHUTAj9ni16VDf9y+LF6R6JYk78LyKTr5/
         MCwO2+MEmHnEeUm4nrPYSI1Ha0z4GF+/9D9hqM2LqVxc9cHCRhrS9tVWVSAVwdX0u4zp
         DOlMYKASr682j172f6uDWqQOkC4F/AbfhkYiEx0lAVCepdw/2q3FvLf/1r2QHmq6cbhl
         8KKw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739927413; x=1740532213;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=mUpwLBw+Z1T0MkCckOh5bFyJys42TZYUDiEdEk41zSc=;
        b=VeowLJUHBYqp6jmVixsi+GS7rYrbdtynG1lNfvs5nOLdbbIBeG+FNAL4oL16mcCVi5
         gm1MCYkxJN0200TEqid8CMr3zXo+MWtdZ/t0joS6cZNykQozFkG+3nLqXld+Luw/6DJZ
         edTBxEtNsfKsLpIARHQcaYbLdfvvDmjAOg4b5tctp7JSmWagvDdlDyHMGsCWnk8f2nab
         hp+YCTmpyUpZDG4kLr5UvvLNiZo2gg5DIUA2uDNM22qdS5R1iMPzMp7D4/1DGT8FbY1K
         eflja8ONH5p+ZftAZczTZyun0zBVnyKSJuan7UlLeg6rxmmKMiQHQGpZY+ia4dC+VyUj
         ys2A==
X-Forwarded-Encrypted: i=1; AJvYcCUuf0BY7IjnpXFxi9ASqaHLxgAV4KqZNm1dqo8vMN1a2MtA+4P1ZP0kPrMyzps70Wfog0PUSHlXl80=@vger.kernel.org
X-Gm-Message-State: AOJu0YwUuPl37oPfR2W/Qlee4IOv1AqnzkMXqD+vpcTmZnSTsk7j1AB2
	zwyS6E4Rp7k4lVFp8YiZIf5JNHhZ5HlfGXqXjdU0+ol46dGMQBZWiJbRDkIQHeg=
X-Gm-Gg: ASbGncuUR1w9pg/ffN7ofNX5EbkP0ymnmkjxFoqlvKA78MRh7QAPp1Udvqvn6VkSi5b
	hrOok1wZJ1UVQH8UwzYYioSMECnIRJgy4wcm+k63Y4pJk2Y9BfCPwdECs/Dht9SDinIpm2bGeew
	PxUPtjqefrXmdLmwbc06CzDXY6c7tDOnp4jARxtVJ9KcdjZzAzyGaxu2uiytegzsvnu8VcXKAui
	PMTFv5a60nGWlfD4girCIU/wm1BB7IEioZUhyLduDiQ6R3hgVJp4NI0eqCCBCRWOshttk0X84Ya
	WM6OkIfn6yauVSlCrLALCaVcFOqCi2f0sPAVfqfuTvVBclpkNykdf4dC/97OFSS+KMadMLPTRg=
	=
X-Google-Smtp-Source: AGHT+IH/AUdFwBNx24uUtaBVfN+n1JoWvhbYt0qh38JBEugYo+ybiMsaT1gcAkaQqXvSHqzz/jLiKA==
X-Received: by 2002:a05:620a:4626:b0:7c0:a28e:4970 with SMTP id af79cd13be357-7c0a28e4ae2mr1109600285a.29.1739927413662;
        Tue, 18 Feb 2025 17:10:13 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e65dce9f9csm69069206d6.104.2025.02.18.17.10.12
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 18 Feb 2025 17:10:12 -0800 (PST)
Date: Tue, 18 Feb 2025 20:10:10 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7UvchoiRUg_cnhh@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
Status: O
Content-Length: 3583
Lines: 101

On Tue, Feb 18, 2025 at 09:57:06PM +0100, David Hildenbrand wrote:
> > 
> > 2) if memmap_on_memory is on, and hotplug capacity (node1) is
> >     zone_movable - then each memory block (256MB) should appear
> >     as 252MB (-4MB of 64-byte page structs).  For 256GB (my system)
> >     I should see a total of 252GB of onlined memory (-4GB of page struct)
> 
> In memory_block_online(), we have:
> 
> 	/*
> 	 * Account once onlining succeeded. If the zone was unpopulated, it is
> 	 * now already properly populated.
> 	 */
> 	if (nr_vmemmap_pages)
> 		adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
> 					  nr_vmemmap_pages);
> 

I've validated the behavior on my system, I just mis-read my results.
memmap_on_memory works as suggested.

What's mildly confusing is for pages used for altmap to be accounted for
as if it's an allocation in vmstat - but for that capacity to be chopped
out of the memory-block (it "makes sense" it's just subtly misleading).

I thought the system was saying i'd allocated memory (from the 'free'
capacity) instead of just reducing capacity.

Thank you for clearing this up.

> > 
> > stupid question - it sorta seems like you'd want this as the default
> > setting for driver-managed hotplug memory blocks, but I suppose for
> > very small blocks there's problems (as described in the docs).
> 
> The issue is that it is per-memblock. So you'll never have 1 GiB ranges
> of consecutive usable memory (e.g., 1 GiB hugetlb page).
>

That makes sense, i had not considered this.  Although it only applies
for small blocks - which is basically an indictment of this suggestion:

https://lore.kernel.org/linux-mm/20250127153405.3379117-1-gourry@gourry.net/

So I'll have to consider this and whether this should be a default.
It's probably this is enough to nak this entirely.


... that said ....

Interestingly, when I tried allocating 1GiB hugetlb pages on a dax device
in ZONE_MOVABLE (without memmap_on_memory) - the allocation fails silently
regardless of block size (tried both 2GB and 256MB).  I can't find a reason
why this would be the case in the existing documentation.

(note: hugepage migration is enabled in build config, so it's not that)

If I enable one block (256MB) into ZONE_NORMAL, and the remainder in
movable (with memmap_on_memory=n) the allocation still fails, and:

   nr_slab_unreclaimable 43

in node1/vmstat - where previously there was nothing.

Onlining the dax devices into ZONE_NORMAL successfully allowed 1GiB huge
pages to allocate.

This used the /sys/bus/node/devices/node1/hugepages/* interfaces to test

Using the /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages with
interleave mempolicy - all hugepages end up on ZONE_NORMAL.

(v6.13 base kernel)

This behavior is *curious* to say the least.  Not sure if bug, or some
nuance missing from the documentation - but certainly glad I caught it.


> I thought we had that? See MHP_MEMMAP_ON_MEMORY set by dax/kmem.
> 
> IIRC, the global toggle must be enabled for the driver option to be considered.

Oh, well, that's an extra layer I missed.  So there's:

build:
  CONFIG_MHP_MEMMAP_ON_MEMORY=y
  CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE=y
global:
  /sys/module/memory_hotplug/parameters/memmap_on_memory
device:
  /sys/bus/dax/devices/dax0.0/memmap_on_memory

And looking at it - this does seem to be the default for dax.

So I can drop the existing `nuance movable/memmap` section and just
replace it with the hugetlb subtleties x_x.

I appreciate the clarifications here, sorry for the incorrect info and
the increasing confusing.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.129.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8B30B1E1041
	for <linux-cxl@vger.kernel.org>; Wed, 19 Feb 2025 08:53:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.129.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739955202; cv=none; b=OWQYIEoc5mOPbQZJNJAShWltQA7by3w/YFUXXjYzXTO1KczHKSbuNxpRhIa0BFAMm0WBxqM2aEbb/ri6vPPj2VGmMqx/zib9raPQMfXv1634j0cOa3diBitHumWq1YK2fWWjDpwXuU059Gm2tYau/8r85Dq/dac34f+N/ZHh6Ls=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739955202; c=relaxed/simple;
	bh=mxWh7ll8uxiPpIsYTT3ZtmhEUvYjQT1y5Uf0VRC+VX8=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=TwdADbtJf/2g0E2x3V+9U/U3jth02UmstyrZ63Q2YspqCBroi4iDOB4C4i7AgDKLmGxtVje5sobWxlRtyzl9L8w4HO78dCVpmCsX/IgclK9LoR50re8H+piYg20oGR0lwiHgU8IZjol60co3YavfKhe5hua7PIvG4qKPuXILmNA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=CduYxAYE; arc=none smtp.client-ip=170.10.129.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="CduYxAYE"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1739955195;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=Y3RTKbzPGzhYU0bOzSORSMZdnlNJ+TKlrPge/3JxlnU=;
	b=CduYxAYE0pLhgBCEAxHw/S0rUCWHZ0DYNHe4ZWjt7VGDddllBeGnalDFntjRDYo+85czhU
	DbUzxNGW97bc3auiDSUmbc88A2pCQg86RRMPT4Kkdvs/nqlmfKn1adO74t9ocbI9y1r9/7
	Nxxnopp/f4ju5Pi71G0ewgcw8YPdVrQ=
Received: from mail-wm1-f70.google.com (mail-wm1-f70.google.com
 [209.85.128.70]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-177-ulJlruG0N8SVGJU2g8Y84A-1; Wed, 19 Feb 2025 03:53:11 -0500
X-MC-Unique: ulJlruG0N8SVGJU2g8Y84A-1
X-Mimecast-MFC-AGG-ID: ulJlruG0N8SVGJU2g8Y84A_1739955191
Received: by mail-wm1-f70.google.com with SMTP id 5b1f17b1804b1-4399a5afc95so2622285e9.3
        for <linux-cxl@vger.kernel.org>; Wed, 19 Feb 2025 00:53:11 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739955190; x=1740559990;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=Y3RTKbzPGzhYU0bOzSORSMZdnlNJ+TKlrPge/3JxlnU=;
        b=aE0fViXNdJT4UytIZ40mvjj0zkJc0/CuhqSi+I60+JncJ4fEbsYb7lWxKPPrE9wmOC
         KVL4oxIOeY5cTMS1c8RMOj5RXKeAt8S+DT1OUr0UVfYXrOEqAJi1vsG2q34/WZqStjfx
         spVSA8XBZCdOkLbgOYzT7n+DwMrYX1UwIyI29lI+0+Fg7A/1qff5EFTpWmYXgbGa3Pof
         vw8VlHz/SG41vQFh8LZo8XmMSKl1QY137fxWJAVeh6JulqjL3JTCFsEmD00byfH6ybun
         ZAam7Sv9aIpTtR1V6M/aqnlPVS0y7EbXeX16XztbPYCLvgnZ/ib5RHWbIYvUWt6WoeAD
         kZfw==
X-Forwarded-Encrypted: i=1; AJvYcCUCUTWPnyPpD2inHnecK+Va8dniE2jjWP7vafLtmG81URJ5S+StwHBnEhnbeqSvq5KtHiYrK5HBnvc=@vger.kernel.org
X-Gm-Message-State: AOJu0YyGsvAn/NOttO7F3G+9S/JW7I51E9310PPw5/4a+VqNZYaJXJYS
	RH6YN4vI3P8D/pW0zrNHsnf7Pme+qZWyPJfpd9gSiMTWlYMbOEF4tjP6Wrehaag0vCQiuwK1o0N
	pDUoX+eAKmWRG8j9W22gNpvoylvk4BckmvGYMRTlWIYZ16Ev4h3VkiSdXNHtfOojbh6YL
X-Gm-Gg: ASbGncvcrZkqOsJ5kE1Vp1FArgyrFPrmiHTALW2G975+m/bf8u8K18Is11zW4Uh2M10
	fE+pxY8K/toLwfQcHdx8udzqar5d46f41MkcyMU3O2ZuMnkHdgvTgFrHBeWk+LzCYzKtyxYdHiV
	tT0UDu0H3mfHu5zHfTogYclN+o/mto/+9poS6dcrUkMB69StMKAX2VN8PAyewwOd0zSP+dD8VxR
	kYTqsYFG1hcvbiiQCNLYuIazIjJGrJNZwPd2TKvRxFtni1N0lVtuidJFWJhbF2LODSzxpZ6+yFw
	5TV/vxxJ2vQEaYMiTYIiSdS681MxwS17vs4=
X-Received: by 2002:a05:600c:468d:b0:439:91dd:cfa3 with SMTP id 5b1f17b1804b1-43991ddd1f7mr71014715e9.29.1739955190484;
        Wed, 19 Feb 2025 00:53:10 -0800 (PST)
X-Google-Smtp-Source: AGHT+IHx30RG+4JLoDz7Ka+fSqZ4eEfXF8qqBuHgGrd9WrXzZoAldBNNjBxMEAYKQO9+ocdK769P4w==
X-Received: by 2002:a05:600c:468d:b0:439:91dd:cfa3 with SMTP id 5b1f17b1804b1-43991ddd1f7mr71014465e9.29.1739955190069;
        Wed, 19 Feb 2025 00:53:10 -0800 (PST)
Received: from [192.168.3.141] (p5b0c68c8.dip0.t-ipconnect.de. [91.12.104.200])
        by smtp.gmail.com with ESMTPSA id 5b1f17b1804b1-4399c5f901bsm5799465e9.3.2025.02.19.00.53.07
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Wed, 19 Feb 2025 00:53:08 -0800 (PST)
Message-ID: <e332391c-30fb-49c3-9c05-574b0c486a81@redhat.com>
Date: Wed, 19 Feb 2025 09:53:07 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
 linux-mm@kvack.org, linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <Z7UvchoiRUg_cnhh@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7UvchoiRUg_cnhh@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: ClvJCnlca7su1GXAS8r-LLcwrZbs8G3bdeVbUbZNUCo_1739955191
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 6219
Lines: 164

> What's mildly confusing is for pages used for altmap to be accounted for
> as if it's an allocation in vmstat - but for that capacity to be chopped
> out of the memory-block (it "makes sense" it's just subtly misleading).

Would the following make it better or worse?

diff --git a/drivers/base/memory.c b/drivers/base/memory.c
index 4765f2928725c..17a4432427051 100644
--- a/drivers/base/memory.c
+++ b/drivers/base/memory.c
@@ -237,9 +237,12 @@ static int memory_block_online(struct memory_block *mem)
          * Account once onlining succeeded. If the zone was unpopulated, it is
          * now already properly populated.
          */
-       if (nr_vmemmap_pages)
+       if (nr_vmemmap_pages) {
                 adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
                                           nr_vmemmap_pages);
+               adjust_managed_page_count(pfn_to_page(start_pfn),
+                                         nr_vmemmap_pages);
+       }
  
         mem->zone = zone;
         mem_hotplug_done();
@@ -273,17 +276,23 @@ static int memory_block_offline(struct memory_block *mem)
                 nr_vmemmap_pages = mem->altmap->free;
  
         mem_hotplug_begin();
-       if (nr_vmemmap_pages)
+       if (nr_vmemmap_pages) {
                 adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
                                           -nr_vmemmap_pages);
+               adjust_managed_page_count(pfn_to_page(start_pfn),
+                                         -nr_vmemmap_pages);
+       }
  
         ret = offline_pages(start_pfn + nr_vmemmap_pages,
                             nr_pages - nr_vmemmap_pages, mem->zone, mem->group);
         if (ret) {
                 /* offline_pages() failed. Account back. */
-               if (nr_vmemmap_pages)
+               if (nr_vmemmap_pages) {
                         adjust_present_page_count(pfn_to_page(start_pfn),
                                                   mem->group, nr_vmemmap_pages);
+                       adjust_managed_page_count(pfn_to_page(start_pfn),
+                                                 nr_vmemmap_pages);
+               }
                 goto out;
         }
  
Then, it would look "just like allocated memory" from that node/zone.

As if, the memmap was allocated immediately when we onlined the memory
(see below).

> 
> I thought the system was saying i'd allocated memory (from the 'free'
> capacity) instead of just reducing capacity.

The question is whether you want that memory to be hidden from MemTotal
(carveout?) or treated just like allocated memory (allocation?).

If you treat the memmap as "just a memory allocation after early boot"
and "memap_on_memory" telling you to allocate that memory from the
hotplugged memory instead of the buddy, then "carveout"
might be more of an internal implementation detail to achieve that memory
allocation.


>>> stupid question - it sorta seems like you'd want this as the default
>>> setting for driver-managed hotplug memory blocks, but I suppose for
>>> very small blocks there's problems (as described in the docs).
>>
>> The issue is that it is per-memblock. So you'll never have 1 GiB ranges
>> of consecutive usable memory (e.g., 1 GiB hugetlb page).
>>
> 
> That makes sense, i had not considered this.  Although it only applies
> for small blocks - which is basically an indictment of this suggestion:
> 
> https://lore.kernel.org/linux-mm/20250127153405.3379117-1-gourry@gourry.net/
> 
> So I'll have to consider this and whether this should be a default.
> It's probably this is enough to nak this entirely.
> 
> 
> ... that said ....
> 
> Interestingly, when I tried allocating 1GiB hugetlb pages on a dax device
> in ZONE_MOVABLE (without memmap_on_memory) - the allocation fails silently
> regardless of block size (tried both 2GB and 256MB).  I can't find a reason
> why this would be the case in the existing documentation.

Right, it only currently works with ZONE_NORMAL, because 1 GiB pages are
considered unmovable in practice (try reliably finding a 1 GiB area to
migrate the memory to during memory unplug ... when these hugetlb things are
unswappable etc.).

I documented it under https://www.kernel.org/doc/html/latest/admin-guide/mm/memory-hotplug.html

"Gigantic pages are unmovable, resulting in user space consuming a lot of unmovable memory."

If we ever support THP in that size range, we might consider them movable
because we can just split/swapout them when allcoating a migration target
fails.

> 
> (note: hugepage migration is enabled in build config, so it's not that)
> 
> If I enable one block (256MB) into ZONE_NORMAL, and the remainder in
> movable (with memmap_on_memory=n) the allocation still fails, and:
> 
>     nr_slab_unreclaimable 43
> 
> in node1/vmstat - where previously there was nothing.
> 
> Onlining the dax devices into ZONE_NORMAL successfully allowed 1GiB huge
> pages to allocate.
> > This used the /sys/bus/node/devices/node1/hugepages/* interfaces to test
> 
> Using the /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages with
> interleave mempolicy - all hugepages end up on ZONE_NORMAL.
> 
> (v6.13 base kernel)
> 
> This behavior is *curious* to say the least.  Not sure if bug, or some
> nuance missing from the documentation - but certainly glad I caught it.

See above :)

> 
> 
>> I thought we had that? See MHP_MEMMAP_ON_MEMORY set by dax/kmem.
>>
>> IIRC, the global toggle must be enabled for the driver option to be considered.
> 
> Oh, well, that's an extra layer I missed.  So there's:
> 
> build:
>    CONFIG_MHP_MEMMAP_ON_MEMORY=y
>    CONFIG_ARCH_MHP_MEMMAP_ON_MEMORY_ENABLE=y
> global:
>    /sys/module/memory_hotplug/parameters/memmap_on_memory
> device:
>    /sys/bus/dax/devices/dax0.0/memmap_on_memory
> 
> And looking at it - this does seem to be the default for dax.
> 
> So I can drop the existing `nuance movable/memmap` section and just
> replace it with the hugetlb subtleties x_x.
> 
> I appreciate the clarifications here, sorry for the incorrect info and
> the increasing confusing.


No worries. If you have ideas on what to improve in the memory hotplug
docs, please let me know!


-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f176.google.com (mail-qt1-f176.google.com [209.85.160.176])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7E6651F9410
	for <linux-cxl@vger.kernel.org>; Wed, 19 Feb 2025 16:14:23 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.176
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1739981665; cv=none; b=jsfl8w4tlzPJ6oQSNvBtTAKFIbBslz7Vhl9+5aY6WsJseMvnOCVN/reFreqtXB1Lu14HMQzTHUIi8mzm8YVPAfmH9oaqOeR2m5V2HwqiN8Kk4HRj1HY30OEkx6BGRYR8kmslsFx6gRrZsqfIHaXMnZPMI+o/OK0+5ztUYxm4VCE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1739981665; c=relaxed/simple;
	bh=8zjFlNQlwV4+8TDhv5mKhNumLbCb5Hzx9gnY2KmtnRg=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=a5V5n4qHwRh+hHRrAfoLKBehRWwHZT+vCZO9h6Z5vm7mNTUtwlnImAroVIlrESd4N9OSlUsOkSCf2c0NNRANtenj2U7HiZE8pUyBtXxzFnjwFvKE94rIXBgZODEywFdSIZecD2mfoWTLWrXRuLrXqqs8yeli+FJR0ZFAUfKAOhA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=REMELqOK; arc=none smtp.client-ip=209.85.160.176
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="REMELqOK"
Received: by mail-qt1-f176.google.com with SMTP id d75a77b69052e-4721325e3b5so2477361cf.0
        for <linux-cxl@vger.kernel.org>; Wed, 19 Feb 2025 08:14:23 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1739981662; x=1740586462; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=lAEwvi0GBeXV5su+o42Sjw6+fX6vESKuWe1ByEzBoCM=;
        b=REMELqOKxjnd9SD7lEXN4lkKAjpSAWSJ+akcb9cLJaONLhA2vzhxRVfawzsSB2UmGg
         gsIF+FO6dw6okfS456/ARQfmmwPiGj19W9Lqya/AqKskHq9dAuQOTdfATPBBWJmqKpbF
         xwmdF/99zSy7xOqRpoiG5yGmx9mXLXaye6gSOvMd+xOQq0Ss073KGRDPq18bARToeS05
         8wyP7C7CkYi2a7BeMGAWWJmHAmKmwAnfB89fgGi7+MiWagSnTduxSwTgOojzoR+yOD6L
         CkI8ko+sJK5rNpOT8988NNpq2HdlmdwXGGUbN2ddPg+5W746l1Bsuoxus962RGTSj87i
         B5Gw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1739981662; x=1740586462;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=lAEwvi0GBeXV5su+o42Sjw6+fX6vESKuWe1ByEzBoCM=;
        b=mqLHT2yo6F8vz2wjzyWUQ+XYyTwtVVKoF/X5OtoUnzLY3/HBloDbZsQIbZ5I2osj1J
         MxqDiC/0RsBiOaZCbwBerEoNnbWtk2i02L0VTJ1M37OQE51PA0f26Mp45xcUfI04H1DY
         g/MQJMQi8NaiXVwrVStnQK+E2obeJqy0lVSU/Aa1j2aSdxQsyuRUMAA+g6n24EKmR7eU
         KSjHq1UcglKvV7RNIsKhOIOjzgjJbROvHbK8PdJjxO1Z6xE9aAiVbndoLCvsVssQGIjB
         /xADHBli2SToiZbWKIEKMhA6EbERGrnKsspRxRPRDbbbbcs96ifBORMpCiFJJwKZ3OEI
         iV7g==
X-Forwarded-Encrypted: i=1; AJvYcCX3V6eiN0XupxEKevA1tql8qiqEArzTbezOB/TOaVAPN2633/SKKu1XgzoPAyAIuOWDC49fZEzhPa4=@vger.kernel.org
X-Gm-Message-State: AOJu0Yx5TFEf0HXyqd9qKymcLDZLzsHpj1EFr5NqCBYy8RdvNOQKm2fa
	9/4piHx7m0wakVlecsgyh6xckmzvhjy5a1s1PwUT1zR6MNhTA0dtrkIRwXiCxMY=
X-Gm-Gg: ASbGncusZ8X5VmnQhi9EUOUsSXfDpVedsBp+BXiKphjD52uuOhI1ao/kP8ihPr63LY6
	OQZ3Wbq9r+ppVrCls1KyqFx2qgr5dIzjwX7+WV/fZEXc5UfYNuMZAaHDibyXb9hDeI6GoF8bINd
	2zORs10DQNvPRaFTcaGUAFUGSn2ibiwTxoEsSXoB0legJXaCzNUWzVnaJSWHdBVRypUDXrSmvrm
	QlEhTc+L6B8S9C5st3g8DzTNmOcnJIKdP9pabhWtnotRVmzOm1yVYxvdu2ZhdGqsE2BJlDf7lSM
	TZ/noIT0dOjaQ3rYA6G2FfOPbVzazS9KUzq5JEaOafvKObWN85BYLIcFSMuanMfhRWnAhFs/bw=
	=
X-Google-Smtp-Source: AGHT+IE6/v4wshXDrZEpD/MYfeRM134ORVrgYeRnyAz4JVMUV+BS4h0wbgOKih0/uNtmsb8QaJlVKw==
X-Received: by 2002:a05:622a:260e:b0:471:fc9e:8de2 with SMTP id d75a77b69052e-471fc9e9085mr118660761cf.8.1739981660311;
        Wed, 19 Feb 2025 08:14:20 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-4720624239csm14384451cf.11.2025.02.19.08.14.19
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 19 Feb 2025 08:14:19 -0800 (PST)
Date: Wed, 19 Feb 2025 11:14:17 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7YDWbhOyhNGa7jL@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <Z7UvchoiRUg_cnhh@gourry-fedora-PF4VCD3F>
 <e332391c-30fb-49c3-9c05-574b0c486a81@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <e332391c-30fb-49c3-9c05-574b0c486a81@redhat.com>
Status: O
Content-Length: 2231
Lines: 59

On Wed, Feb 19, 2025 at 09:53:07AM +0100, David Hildenbrand wrote:
... snip ...
> 
> Would the following make it better or worse?
> 

> The question is whether you want that memory to be hidden from MemTotal
> (carveout?) or treated just like allocated memory (allocation?).
> 
> If you treat the memmap as "just a memory allocation after early boot"
> and "memap_on_memory" telling you to allocate that memory from the
> hotplugged memory instead of the buddy, then "carveout"
> might be more of an internal implementation detail to achieve that memory
> allocation.
> 

Probably this is fine either way, but I'll poke at the patch you
provided and let you know.

> Right, it only currently works with ZONE_NORMAL, because 1 GiB pages are
> considered unmovable in practice (try reliably finding a 1 GiB area to
> migrate the memory to during memory unplug ... when these hugetlb things are
> unswappable etc.).
> 
> I documented it under https://www.kernel.org/doc/html/latest/admin-guide/mm/memory-hotplug.html
> 
> "Gigantic pages are unmovable, resulting in user space consuming a lot of unmovable memory."
>

Ah, I'm so used to seeing "1GiB Huge Pages" I missed that parts of the
kernel refer to them as "gigantic".  Completely missed this line in the
docs.  So a subtle choice being made by onlining memory into zone
movable is the exclusion of this memory region from being used for
gigantic pages (for now, assuming it never changes).

This is good to know.

> > I appreciate the clarifications here, sorry for the incorrect info and
> > the increasing confusing.
> 
> No worries. If you have ideas on what to improve in the memory hotplug
> docs, please let me know!
> 

I think that clears up most of my misconceptions.

The end-goal of this series is essentially 2-4 "basic choices" for
onlining CXL memory - the implicit decisions being made - while
identifying some ambiguity.  

For example: driver-setup into ZONE_MOVABLE w/o memmap_on_memory means
  1) ZONE_NORMAL page-struct use
  2) no gigantic page support
  3) limited kernel allocation support
  4) changeable configuration without reboot (in theory)
  5) Additioanl ras capabilities.

Thanks again for you patience and help as I work through this.
~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A344A1FECD0;
	Thu, 20 Feb 2025 16:30:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740069049; cv=none; b=OPJysfUzBJAaq/hsSaA1NrrTwLD82QaEss+SkW/tu6AXRSX8NhT7nkEezg6EVIeBlb/nnjpxNFA5lOi07RVXklnHbpwDD7BayUhSpi7YHiHgSTdSHZT6/+G2NW2prZSvT/F/kMUnHS+NpwGT0OwKKUjFjNMmvgEQuccI9HFqLCs=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740069049; c=relaxed/simple;
	bh=h7I4a1m+lKDemV4C/AVPCUByB+1VJoQjS1c/3WUoNkM=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=H4WqFihEr8YSY7zS11o/XXAfOzHy9SmADzz1sGu6/f79zsfE84Crpv+mIkPVstFoLKidu2s/R+7U5nkioixbpzWNFKZqjmfL38DtUgLgUgsA7I/RtwH135xA8spjBZCyoAEo91t1X0HOQIB6vzWswRQdDvk9v/pmQfb2MJX0vM4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.31])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4YzJZH19G7z6L4tx;
	Fri, 21 Feb 2025 00:27:19 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 355FB140257;
	Fri, 21 Feb 2025 00:30:45 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 20 Feb
 2025 17:30:44 +0100
Date: Thu, 20 Feb 2025 16:30:43 +0000
From: Jonathan Cameron <Jonathan.Cameron@huawei.com>
To: Gregory Price <gourry@gourry.net>
CC: <lsf-pc@lists.linux-foundation.org>, <linux-mm@kvack.org>,
	<linux-cxl@vger.kernel.org>, <linux-kernel@vger.kernel.org>
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early
 Boot
Message-ID: <20250220163043.000000cd@huawei.com>
In-Reply-To: <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
	<Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
X-Mailer: Claws Mail 4.3.0 (GTK 3.24.42; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100010.china.huawei.com (7.191.174.197) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 1531
Lines: 47


> 
> Example CEDT Entries (truncated) 
>          Subtable Type : 00 [CXL Host Bridge Structure]
>               Reserved : 00
>                 Length : 0020
> Associated host bridge : 00000005
> 
>          Subtable Type : 01 [CXL Fixed Memory Window Structure]
>               Reserved : 00
>                 Length : 002C
>               Reserved : 00000000
>    Window base address : 000000C050000000
>            Window size : 0000003CA0000000
> 
> If this memory is NOT marked "Special Purpose" by BIOS (next section),

Specific purpose.  You don't want to know how long that term took to
agree on...

> you should find a matching entry EFI Memory Map and /proc/iomem
> 
> BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] usable

Trivial but that's not the EFI memory map, that's the e820.
On some architectures this really will be coming from the EFI memory map.


> /proc/iomem: c050000000-fcefffffff : System RAM


> 
> 
> ---------------------------------------------------------------
> Step 3: EFI_MEMORY_SP - Deferring Management to the CXL Driver.
> ---------------------------------------------------------------
> 
> Assuming you DON'T want CXL memory to default to SystemRAM and prefer
> NOT to have your kernel allocate arbitrary resources on CXL, you
> probably want to defer managing these memory regions to the CXL driver.
> 
> The mechanism for is setting EFI_MEMORY_SP bit on CXL memory in BIOS.
> This will mark the memory "Special Purpose".

Specific purpose if we are keeping the UEFI naming.



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f177.google.com (mail-qk1-f177.google.com [209.85.222.177])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 413BA20DD6E
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 16:52:07 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.177
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740070329; cv=none; b=f6n0x+Lig00rpkmiNJQ22drh4MCiMFpiByd2eTLXq3MowodiRqEQ4zmJFE+34sztZB2SPzf1pKXwLOYWmxRCODWxiwS0nTFz7+Azl+wMyZnFh5upxmUZfFc4YcKDgVWCHDIkFr9ZhfW67Q/SfcOZ3UGFEtU9KS6hyJW4s4JsWEQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740070329; c=relaxed/simple;
	bh=tYdheaOLJdJc0aJkjKr0mWLYAbDjup5u9/8ud0zYRzA=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=dJpQseEWKN16LMUMiNDcgZKnOQmERBRI69SEos7xJAOuQh8pyNK3SEsLbQBf42rFE3kWgy+Xxwlw3gRhbLXrPMZZ8kP9PfbHW3fZh+L4nBaXuLYhd07hEMscn8+YraZIG3yW3pIKAK6O2GAqQRWEVNs8vcVaj5DtYDs8VoG2KqI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=r63gGWT/; arc=none smtp.client-ip=209.85.222.177
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="r63gGWT/"
Received: by mail-qk1-f177.google.com with SMTP id af79cd13be357-7be8efa231aso117417285a.2
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 08:52:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1740070327; x=1740675127; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=wkopH+knUrz+qRGQu25YwgeMxQonV40WdBmq0oHoa/M=;
        b=r63gGWT/SFOpTCY0gppD4s1+CTNUf/uM5IWZvstpJewST70YQ/L3ezSpWUo9GudEQV
         noT8vNyG+m8GrqPRRAANIPATBcclm3U6NY1L7P3N1ruLhELfPzVdo/aNhJxjOQbhto+4
         ecGw5nhE/ExC1jcOVeSIhqaJ6s24r3n3rrFcHFGnnpMMlslVuO1h65tBPcrRWtmh7tXQ
         zwJLtsX3QsafJlJbxJVux1NtBoIT83q8sP23U4VDTgjk3sr4qr3wA8J+WrosPJXxFzKi
         yI/yPdmGl36jbjOMZGBAG33OW85U/HQ6BjMmI6htiLwvrPdWRI+vIFm0s3Ff0gHL5aK8
         GWVA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740070327; x=1740675127;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=wkopH+knUrz+qRGQu25YwgeMxQonV40WdBmq0oHoa/M=;
        b=kxoujlvJVVF2Yhv3wLtOTXI3rk7syqVJ3MlOKAn7ELp+5r48RNhpA810VKpRUhCK3v
         b/duwMPbFdT2dng87HKigizRPoBiDEYLsv32QWru9yXlJmaQGDRqBgzbfsf9+Vj1TWis
         1IKQSE8qC92axy0vAdlDUrA4vG96k5JgNXym4/+4bILNndWz+DekGDOVuvUMCmBZxaYL
         K2ZL/ReTTT7zmUN03r2oGLbLrTWy7Wymlw144/HGWwo3agYfF3h1ZIyFqu7wbIu5mHAq
         vIVngtVQlnDr8CrzkAA6CU9tWjAir0YlYYAQhqTsMzWcVLX5PfbGEWRZdF3YEMlUYknt
         uepA==
X-Forwarded-Encrypted: i=1; AJvYcCVPQW7EPaQfh163TvGeWMLZPhEIjdCft5kXZ56Y9ebduazD8N+3/mZAj2Bs0JWuLqrRnUOMdd1cGAw=@vger.kernel.org
X-Gm-Message-State: AOJu0YyiwOfqAG2OqneutmickcChuUYMEywN8QKJ8FT+v+O9ToxGwpuq
	d49cCkqdPtMGlaDbVrBOh0gGmpm11isb02F+S6rUiHqVYIC/6uQzo+2j1VJOZNA=
X-Gm-Gg: ASbGncsj83tp7YPjZTAdKn+4qv8BMxTwsWJJ7FHhWWF9BMqJL4A4n1GjZXvpmlacD4/
	y+RWxMCcLYVV616q96F3eIGzImehWzIFA3fCkyuxI0gNyWP554BFflcaq2ZWLkOcsmLedk5yklK
	sOgDW7bEEHqa4pBos6E8HcOuXs2WhL6HvsYesrNd3Bg+VvM3lWuZ9U2uOnJxnE6X9o63lMh41TV
	zizbmR4N/IO0rJT9hwvZCdo7zUFEt+d1dzNT7Jw+bsXXKjCkLb2zTeLIORZegnDCEpoYEjvBSV3
	N9VzBA+/pQEeYmCzgXy3Eq052l7IHK3wEBQJ18AygUtp/Q4hY6YKGN1LvI1i6rATur14DBCzuQ=
	=
X-Google-Smtp-Source: AGHT+IGrbP+VpZmpnhWBu0RWPNsSrk995l/NeBFAzZWBe3mWGjHaZI5IiPF3bd9fa2T2Eki2fBv33Q==
X-Received: by 2002:a05:620a:4054:b0:7c0:b220:34f9 with SMTP id af79cd13be357-7c0b2203898mr1475385785a.36.1740070327005;
        Thu, 20 Feb 2025 08:52:07 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c09619fbfesm542181485a.18.2025.02.20.08.52.06
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 20 Feb 2025 08:52:06 -0800 (PST)
Date: Thu, 20 Feb 2025 11:52:05 -0500
From: Gregory Price <gourry@gourry.net>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early Boot
Message-ID: <Z7ddtZBHx28_HIPR@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
 <20250220163043.000000cd@huawei.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250220163043.000000cd@huawei.com>
Status: O
Content-Length: 1323
Lines: 41

On Thu, Feb 20, 2025 at 04:30:43PM +0000, Jonathan Cameron wrote:
> 
> > 
> > Example CEDT Entries (truncated) 
> >          Subtable Type : 00 [CXL Host Bridge Structure]
> >               Reserved : 00
> >                 Length : 0020
> > Associated host bridge : 00000005
> > 
> >          Subtable Type : 01 [CXL Fixed Memory Window Structure]
> >               Reserved : 00
> >                 Length : 002C
> >               Reserved : 00000000
> >    Window base address : 000000C050000000
> >            Window size : 0000003CA0000000
> > 
> > If this memory is NOT marked "Special Purpose" by BIOS (next section),
> 
> Specific purpose.  You don't want to know how long that term took to
> agree on...
>

Oh man how'd i muck that up.  Thanks for the correction.

I suppose I can/should re-issue all of these with corrections
accordingly.  Maybe even convert this into a documentation somewhere

:sweat:

> > you should find a matching entry EFI Memory Map and /proc/iomem
> > 
> > BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] usable
> 
> Trivial but that's not the EFI memory map, that's the e820.
> On some architectures this really will be coming from the EFI memory map.
> 

You're right, though on my system they're equivalent, just plucked the
wrong thing out of dmesg.  Will correct.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-ed1-f47.google.com (mail-ed1-f47.google.com [209.85.208.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5E0822B9AA;
	Thu, 20 Feb 2025 17:50:21 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.208.47
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740073823; cv=none; b=FR8HktQbCz4Z+6oKj3f4HQKCelZFG7iTnE63ltijFTI/Pdo+8MMOjqVays/i2oPrPUkvy35RlzUmGsYNvz6IETEakdug/Og3l/Y3kXexjhBgZNg66x05Y8EfIWNnuNQUQdzGe+vTCQh70PXhuOYsB06sY7vyTZ2juZfBIFDYmRM=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740073823; c=relaxed/simple;
	bh=IJ7M86wMSdxXMV52jPqJQwN18In/Fq4MAFTJcpgW8sI=;
	h=MIME-Version:References:In-Reply-To:From:Date:Message-ID:Subject:
	 To:Cc:Content-Type; b=t9p6UMcK4mY0hgXvq7V1Hf4UwtO1Zyu5xFMfbXW6KoC9vnOw+jhK3EaCoWWtg8x7QPvGgf956y9QAjhwz45+myY82w1NrPaUtZekT8YJuOqzeelQBkKQGV5kbRZYlliHJvccJo0RhklfWAjXHCBk4in2K3K6TzpdGAVcXWuKsGk=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=LUoloyaR; arc=none smtp.client-ip=209.85.208.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="LUoloyaR"
Received: by mail-ed1-f47.google.com with SMTP id 4fb4d7f45d1cf-5e05780509dso1729841a12.2;
        Thu, 20 Feb 2025 09:50:21 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1740073820; x=1740678620; darn=vger.kernel.org;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:from:to:cc:subject:date:message-id:reply-to;
        bh=ACbXZSJEeD7MSU+0ygnOG3CFUz1SHUqmj4uHUBUExvo=;
        b=LUoloyaRwf4WbEzVHt2I7vgQHXLMv4P+EY5Z6KTiNkf6jabEDyVAGWc0IrNDIwCYYX
         kddKaQr20gZ1t0jPtvbdo1wvgxptUtvvRmRBtnxQ3Jtid3mcCOk2I4vQmLz7q7Erov44
         FzTbdn0Su3KnydPxhinoU34Ku7HzGXgQ/bCqJVnMk2fZiTkqMhna/KtFox3Kb8hymcuN
         IhNZ/40gsuM8aTjxx9/Vf4EbKmC3GKF4/qlwUaVxR2YKA0xoDFZTrZLX6fjCNvrCBSiD
         nA/aWKQ+JCJ7UCuEmQVsDA/p5cL7+Vd5VBdqfwTxJUK5NW6/nSBdBty6sWl2TWiaBVr5
         0PAQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740073820; x=1740678620;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:x-gm-message-state:from:to:cc:subject:date:message-id
         :reply-to;
        bh=ACbXZSJEeD7MSU+0ygnOG3CFUz1SHUqmj4uHUBUExvo=;
        b=r5AeKplolqo28hFlwrmMLQg5Iaanv/pQ2V6jC/SNJ+iBgo3t6xqEIH5vaqNUahE12e
         hM6oHmlS3KUKhLLVqlUPSkB8H+VALHCSeIRNbOe+wVUor84TyEAulXrO8BQJ4P9snYzS
         PUBq3eMhZJn3Wv3OVvVBNGISOJf5t8gf/pjZ5eTb2zbWHf8IgU/jMnXXtGVPQ04HGYjt
         OQvcKr3a3po5VUTHPTrCYd9s/Zm+01fyPc/YAmm4s/MNLJsbQL8mzlb5eyf3p6VnRGRJ
         0JCOe7d/D6o0K/0bPIQFt0AzB/aOSN8XQw4hNj63FLTGegvaoN3oTBXoxpvwan3KQ2+o
         xvBw==
X-Forwarded-Encrypted: i=1; AJvYcCUQSPY1CJEFC2SWIqxSfZ09ZddxzYT9cBZlI7M72bpTrJsjs6p5Z4jnVu8gkwyyIQPYGaNpSEG8p54=@vger.kernel.org, AJvYcCWWov7Wm7gPMRZMSRwlGaGHgYkZwwTKvwgFBndsIFtCzdGbHGbkr2svLjz7WbDFg3hoQ4ANiwRwbIBuBbil@vger.kernel.org
X-Gm-Message-State: AOJu0YwqqAKj/HYXQPxawUS7YvW4IK5ZBQJK98pE/S2N6acuIqPQimrk
	VdkLdi9mZYwo9hmhL90jWWp2eHnu8hH/KdP6IErczYmqPtgl+7AwXBWkUz1iGZn5IOv3ZsWlNoh
	rAzVqS4sDjEkdm/FLL4rkzxcVdu4=
X-Gm-Gg: ASbGncu1APAETMnKYY0D0uvNYnazH02p8Np82lwu8r9Gtyr/kpytkviLma1/IESuoB5
	SbZ66No3zgUUlDCTbZGzAj+3CO7WmIbNTVbK9ukgyyTRryqkX2/F545PhufdrDCfGCPDZVkHe7J
	c=
X-Google-Smtp-Source: AGHT+IEoWXbWwTVuK2Nwv99J648YCts8QbcZyhvyRX5LPXJIREs0N43ohOkCkOhIjhQm5MU2a34de0JWy5oegIyzsg0=
X-Received: by 2002:a05:6402:268a:b0:5d9:a62:32b with SMTP id
 4fb4d7f45d1cf-5e0360440a0mr26146606a12.7.1740073819559; Thu, 20 Feb 2025
 09:50:19 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F> <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F> <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F> <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
In-Reply-To: <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
From: Yang Shi <shy828301@gmail.com>
Date: Thu, 20 Feb 2025 09:50:07 -0800
X-Gm-Features: AWEUYZkw36f3OEiXrlZX_cyPCOYpVkyNjb2lSz_Gn-SXQJshZlbv5FIQbCvDvP0
Message-ID: <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: David Hildenbrand <david@redhat.com>
Cc: Gregory Price <gourry@gourry.net>, lsf-pc@lists.linux-foundation.org, 
	linux-mm@kvack.org, linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Content-Type: text/plain; charset="UTF-8"
Status: O
Content-Length: 2334
Lines: 72

>
> >
> > 2) if memmap_on_memory is on, and hotplug capacity (node1) is
> >     zone_movable - then each memory block (256MB) should appear
> >     as 252MB (-4MB of 64-byte page structs).  For 256GB (my system)
> >     I should see a total of 252GB of onlined memory (-4GB of page struct)
>
> In memory_block_online(), we have:
>
>         /*
>          * Account once onlining succeeded. If the zone was unpopulated, it is
>          * now already properly populated.
>          */
>         if (nr_vmemmap_pages)
>                 adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
>                                           nr_vmemmap_pages);
>
> So we'd add the vmemmap pages to
> * zone->present_pages
> * zone->zone_pgdat->node_present_pages
>
> (mhp_init_memmap_on_memory() moved the vmemmap pages to ZONE_MOVABLE)
>
> However, we don't add them to
> * zone->managed_pages
> * totalram pages
>
> /proc/zoneinfo would show them as present but not managed.
> /proc/meminfo would not include them in MemTotal
>
> We could adjust the latter two, if there is a problem.
> (just needs some adjust_managed_page_count() calls)
>
> So yes, staring at MemTotal, you should see an increase by 252 MiB right now.
>
> >
> >     2a) when dropping these memory blocks, I should see node0 memory use
> >         stay the same - since it was vmemmap usage.
>
> Yes.
>
> >
> > I will double check that this isn't working as expected, and i'll double
> > check for a build option as well.
> >
> > stupid question - it sorta seems like you'd want this as the default
> > setting for driver-managed hotplug memory blocks, but I suppose for
> > very small blocks there's problems (as described in the docs).
>
> The issue is that it is per-memblock. So you'll never have 1 GiB ranges
> of consecutive usable memory (e.g., 1 GiB hugetlb page).

Regardless of ZONE_MOVABLE or ZONE_NORMAL, right?

Thanks,
Yang

>
> >
> > :thinking: - is it silly to suggest maybe a per-driver memmap_on_memory
> > setting rather than just a global setting?  For CXL capacity, this seems
> > like a no-brainer since blocks can't be smaller than 256MB (per spec).
>
> I thought we had that? See MHP_MEMMAP_ON_MEMORY set by dax/kmem.
>
> IIRC, the global toggle must be enabled for the driver option to be considered.
>
> --
> Cheers,
>
> David / dhildenb
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f52.google.com (mail-qv1-f52.google.com [209.85.219.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5A1DD214A9B
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 18:43:12 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.52
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740076993; cv=none; b=Ic21MJ3a3UYukN3Q4Blx0SzXWKIdcwNDEOgtQ8xvcZx6wq5dPrNI+u5WWCnfSDC/xe/UQHZeOGsn6UZCETBA8RUxVpRlq12QYyC60NP1CYsC3mPsIrYtnczu66uzS/Zm4MZNP4X2ps/69lqDGG61RBGTqhK6G15L7YvEESzhowo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740076993; c=relaxed/simple;
	bh=NGgRHDDGedIkLCbRWOHyqQOCNZ+JrdBTernCwcw6jCo=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=sVxpJHEdWltbnTkjfwSan0jQVLiDtioX/rwqvHpbbKeUJBXq1f5WmEUrnNhR6Yw6A6Ypby6qsAPXhHmvzU5vf6pvKMxKv8Tfi/t5+eCL9z6dwoW7hJUDdwC1YSuUMRZ+G2l5oR6H5AoKnD989vOVjbQ/hRuFgrxHMy0CQ5qXJzA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=QDattucv; arc=none smtp.client-ip=209.85.219.52
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="QDattucv"
Received: by mail-qv1-f52.google.com with SMTP id 6a1803df08f44-6dd43aa1558so10669916d6.0
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 10:43:12 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1740076991; x=1740681791; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=d3ocJQTmmz808+gv+xcTfLZcwjDZn2/TIc1rnG0DoJg=;
        b=QDattucvNS6moBrMSgaG5SsfkFzwVXed8XaI/41d5kZzUN4F7IQNv9DXw/fWu+oTmu
         sKGJAhO0+hDbCay1Bhjhd7tadu5RBj30v8G8Ns58nUBgj5FZP2c+5s3nFW+bBVsEGZ0G
         QRNtLyEqpL29QJVVKs4hz3/DIocUz9Kq7Wkb4h7AXcGR+mu9X5wxEapdPojpmpBO690T
         sZtloEG4y8k//BzeqZ+mvjkuQ4u0rtDE9pMWFv34PwDpKBRNm62qumAx69G2j43u4XwR
         avsfAIKx/EI9jpIs+tU//hlRE+f3PfRUYWUt4NcIJKdk+J1VnV7xeWwxSrmWZyYgPVjf
         +l7g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740076991; x=1740681791;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=d3ocJQTmmz808+gv+xcTfLZcwjDZn2/TIc1rnG0DoJg=;
        b=ceytDH+8iTcLyucSfaLdlFCy/ftreb2XnzhUq8vuOuEXvSZWHjXeQ++1mKNmjgXDep
         xWPz4cQ8XoAidI/27kQdSuwKPrAiVDjFDdmzmQZF3nXpId5tIOpFLjPpfHFr2Y29q07Y
         +M5MME5OW93hGEGIW5M1k3zTtq9KtPu+JENHhD1N1diDULpQ36ZeFDin576ueRsTBBiF
         fVup87lvBHTsBBJajUoDItn7hQlqcCqRxSccQ85/FEP47RJm3hQ1lQTf0ybTvR1XJSdb
         1Zsh3UUCd+8S6Qx68GiiNsJEFXz9atiyqm/UdrfT3s/eXtf9xDPMifilwy4Kw8MKwYax
         zhTQ==
X-Forwarded-Encrypted: i=1; AJvYcCWPm69nJ0F0ebHrCyYoSfmYZ8B1uhSfSaWOJBp+SCqq7F7xpvz8p1qv0YHNC7gJSylgvJ0yZhm4ebE=@vger.kernel.org
X-Gm-Message-State: AOJu0YxCZajrlBXd41tz5o2DxacvFbJD2/KNSOUS9aGXNPDuGOKltEQG
	JsHe1NGijczRXEbBZQyLLVuT/ZZHe5FL7nfm/eYLli+EL0+qPLv3c2zcEAzLaEbZvGFR7qLO8Om
	j
X-Gm-Gg: ASbGncvDogvB0CdDhBsKQnF+Z5Ydygt4TS5Ijv494lW0Zx9SfsQ9lW58qpT98hOXDDA
	VyQG5MYX6MIM8RpUAzGRjxF+QUyyxMipw6zqJmlYVzV7NnjXte/qSYECjUSWlzoxuJ5Knx91ee0
	gMkGAGo+W0vuTJkl9xi85oVDUiavcLqBAWEdS/dZvH6xK939nzYzoAYovN08O+1YgSD4n5YMK0o
	7QqarJBJQQiQDAedBdIuzBMRRxVrfcxWgVkm2XBWvALdRAj9lo5wh9OqlKEVt5rAqbBloP3cyRM
	X7L9UxygKmm9FcCt0FEYbwIUelmQnco8NjRrofpDkXffjltLssEmpCrsmc3ElvcaNhx0eGoS2A=
	=
X-Google-Smtp-Source: AGHT+IE6IpITASnEll2pNxcvCEXqhyJQ61kCnsAXUIqsUkMLSxo6fEasrPnRH6TZnjk08cEAdB+JcA==
X-Received: by 2002:a05:6214:d8a:b0:6e6:64a5:e18d with SMTP id 6a1803df08f44-6e6ae7f8290mr2793666d6.17.1740076991097;
        Thu, 20 Feb 2025 10:43:11 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e65d77a2bdsm88435726d6.11.2025.02.20.10.43.10
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 20 Feb 2025 10:43:10 -0800 (PST)
Date: Thu, 20 Feb 2025 13:43:09 -0500
From: Gregory Price <gourry@gourry.net>
To: Yang Shi <shy828301@gmail.com>
Cc: David Hildenbrand <david@redhat.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
Status: O
Content-Length: 651
Lines: 19

On Thu, Feb 20, 2025 at 09:50:07AM -0800, Yang Shi wrote:
> > > I will double check that this isn't working as expected, and i'll double
> > > check for a build option as well.
> > >
> > > stupid question - it sorta seems like you'd want this as the default
> > > setting for driver-managed hotplug memory blocks, but I suppose for
> > > very small blocks there's problems (as described in the docs).
> >
> > The issue is that it is per-memblock. So you'll never have 1 GiB ranges
> > of consecutive usable memory (e.g., 1 GiB hugetlb page).
> 
> Regardless of ZONE_MOVABLE or ZONE_NORMAL, right?
> 
> Thanks,
> Yang

>From my testing, yes.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.129.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 873C2213E61
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 19:26:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.129.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740079591; cv=none; b=szelo6OOiZvOq4kYWceVeMERJfYdhbFHfkgqMvvuQfBeEi2v/Kwtc/FeTPi/WSO6NtkiUHn7nv5wiAmOxs1R8WvJeO3UFA79rYqWjmwBE40aHEolDT+3Qttc5jhczXJe0uyMshKFfu1dG4Kt1G9k7xl5TFsOP7+NsFtgb3sS2Zs=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740079591; c=relaxed/simple;
	bh=8bCxreR7sk/IeNRpWmX/cXsQs0NvKoFazceujYFolhE=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=rFP24LToD0hmeYUruHXCzwuHKBwwgfxf+IWLW/rAZQjx0xgJxTBTVUQe4+bE13kNCHKUuFuaQMiL/vrWqrQx+4JAZFrsBzS3WE5HhcY2uOM43USxRZ65iW+lp7+yCOAZq0DgCU9wAgM3888q0kloZj+4lt93gF2QFu/8uaiTFKc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=YkYESgYW; arc=none smtp.client-ip=170.10.129.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="YkYESgYW"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1740079588;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=irSBqz7swEwN7V0gLT8/jmltTtJjErnbhzJ+tCBY6ps=;
	b=YkYESgYWXSMGGWLdGYWwxKec3vO6D+3pdpDHpxg7dWdUqqOnEM+IBFKzwfPC12OKes8X7a
	5jbTXuqzy25c5IPm9CW0nK1ERTCe09Br9wKxPrEoKYPTAG/i/hP5vcaQg9cv9bk62XFGcz
	kUgqA+8E+DyHSlkqto32eONXbFi+S7Y=
Received: from mail-wm1-f69.google.com (mail-wm1-f69.google.com
 [209.85.128.69]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-321-97lHqIhJMfaE6wYP4USBxw-1; Thu, 20 Feb 2025 14:26:27 -0500
X-MC-Unique: 97lHqIhJMfaE6wYP4USBxw-1
X-Mimecast-MFC-AGG-ID: 97lHqIhJMfaE6wYP4USBxw_1740079584
Received: by mail-wm1-f69.google.com with SMTP id 5b1f17b1804b1-4399a5afcb3so13523655e9.3
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 11:26:27 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740079584; x=1740684384;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=irSBqz7swEwN7V0gLT8/jmltTtJjErnbhzJ+tCBY6ps=;
        b=rqRzKlb5bOsIM+i2YaIw0H93TWz5EG/rsE4SEkJ4LEZUpsZ8cf7bl5nofQbl0bJM47
         igqYsJjZtWJRS5gsF2n/IP/xPK/FQYnHLy/AXlc+figPYuGab6gsnuTtgCRtX7OzWSgh
         Wr+gIV19zxShuh08X4Z0G+ttr3todcnT+4MoBAG6El+aosJ1SZUpdgHmqLMGVfvWKwGq
         AOky36F95J/c47tkFx5pSYkS2W1eMnWSCn6apBpigqrGGIlm2NAfSdWv4ZAQkhPJPBKf
         YxLjwYPrLk+LmG6klU41ZZ/dtzPZ/zSDvrem7xqyK0bYsL80FzILW/LLJ+xK8nXYLAIR
         5lRA==
X-Forwarded-Encrypted: i=1; AJvYcCWghnavzSTaRB096DcOdRxUMogotbE8tTF5//z7+4BSfcsro5TkxeP3wLshVK2XKQDXs5/Xx68l6D4=@vger.kernel.org
X-Gm-Message-State: AOJu0YwYIIlh6mNWUylfBl+ISYTCD8ilEmWPTUsb/W/h8EykQ2KpbZ44
	UXfiCA/lZqahqZ9PCiMQCpNTF9s9N7+bkiiPVo8zi6gyGApQeSBnwG6FgTgUvr8UPoIdpfal9JB
	j08a8l0xeLtwJrF0R1HGXgdm4HE3sLuhBw2LKPlUq3AkrkVY1OdymDw2U+w==
X-Gm-Gg: ASbGnctVE+/A6lCibg3vfa0Zr48dbe5y1sC/uvI7W72W/KUlJSRqEOQRqUiEnFsKBqd
	uve7idAtLqHGqeeJOoAvx6IabZC+1BeCAHPndo6ZaJ1spys6D4ilSlBhmS/0Qeek6EYNBJvP6iu
	WtKnbKwszht7HtXDzB4xD1t4cuLfWqoqFM6P9wvN67La0XGNaz/R+Y9ly7DjAXk1TI3DSSr3iMk
	5ROsYM+5bbhdNrVUF/Oh+Wuv6FNGf8IDnodflLkIW5FHNvgnP7+6IgNA+VhyonwfyFn42V+go7M
	ubC1ihowZcK37TxjSZ6AlxR43TiWWMsXOA==
X-Received: by 2002:a05:600c:5487:b0:439:9d75:9e92 with SMTP id 5b1f17b1804b1-439ae21e3cbmr4188315e9.28.1740079584581;
        Thu, 20 Feb 2025 11:26:24 -0800 (PST)
X-Google-Smtp-Source: AGHT+IF+Wi0kRb7c6ax7rMeY2G1XU3iiMUudXyvxM+EL6SvfggdqQd/SA+4o5SHVVPJRJVKIfhYdrQ==
X-Received: by 2002:a05:600c:5487:b0:439:9d75:9e92 with SMTP id 5b1f17b1804b1-439ae21e3cbmr4188125e9.28.1740079584237;
        Thu, 20 Feb 2025 11:26:24 -0800 (PST)
Received: from [192.168.3.141] (p5b0c6195.dip0.t-ipconnect.de. [91.12.97.149])
        by smtp.gmail.com with ESMTPSA id ffacd0b85a97d-38f259d5c36sm21652394f8f.67.2025.02.20.11.26.21
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Thu, 20 Feb 2025 11:26:23 -0800 (PST)
Message-ID: <4ae838ee-b079-408e-8799-e9530ca50417@redhat.com>
Date: Thu, 20 Feb 2025 20:26:21 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>, Yang Shi <shy828301@gmail.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
 linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
 <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: 2lW2QQ63wcW_yn_kUTPUZQp3qSA3H6M_UQrN7Snywy4_1740079584
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 1112
Lines: 34

On 20.02.25 19:43, Gregory Price wrote:
> On Thu, Feb 20, 2025 at 09:50:07AM -0800, Yang Shi wrote:
>>>> I will double check that this isn't working as expected, and i'll double
>>>> check for a build option as well.
>>>>
>>>> stupid question - it sorta seems like you'd want this as the default
>>>> setting for driver-managed hotplug memory blocks, but I suppose for
>>>> very small blocks there's problems (as described in the docs).
>>>
>>> The issue is that it is per-memblock. So you'll never have 1 GiB ranges
>>> of consecutive usable memory (e.g., 1 GiB hugetlb page).
>>
>> Regardless of ZONE_MOVABLE or ZONE_NORMAL, right?
>>
>> Thanks,
>> Yang
> 
>  From my testing, yes.

Yes, the only way to get some 1 GiB pages is by using larger memory 
blocks (e.g., 2 GiB on x86-64), which comes with a different set of 
issues (esp. hotplug granularity).

Of course, only 1x usable 1 GiB page for each 2 GiB block.

There were ideas in how to optimize that (e.g., requiring  a new sysfs 
interface to expose variable-sized blocks), if anybody is interested, 
please reach out.

-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f179.google.com (mail-qk1-f179.google.com [209.85.222.179])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 22EEB264625
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 19:35:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.179
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740080160; cv=none; b=WpQ2/HQa6qRrAJND5Jfi8E1/RvMkWeh0or0WKlFNsECKAFgjueuABii0OvxMgsimQ4WcFvRshf+xyeFpWwQ8633aLufDQO+vPVl12ehiBg/gwNkCVEj8JpD7jbi7q2I1QWeLczLTwyTiW+AtfrGrqNZjBohjWs10W4lOU4k6Ou4=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740080160; c=relaxed/simple;
	bh=r9sumPUkFDAwd49TGJqDeaX3rB6YkrFT+aTeUwfTG8Y=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=XwRQph57B3xr/2IyLDhU693nUI1PpelHH9Nxf0TJDud+D3/SPupa5fZF0nQFc1ETdFhbOIR9L78CImewipyapHZSikOPqSh0sMfoBX13+vlgXYxhkjrAA1yXQKbcZs5Z44emq+ORiLCanv9g4G1KJkks1hJviTM00jUpo2Fu4f4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=P6q3WhjE; arc=none smtp.client-ip=209.85.222.179
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="P6q3WhjE"
Received: by mail-qk1-f179.google.com with SMTP id af79cd13be357-7c0a159ded2so130072785a.0
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 11:35:58 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1740080158; x=1740684958; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=aq0auaV2gz0U2k7ZsV3xhtnt/Z87hJ6m6ZAx0KCC4ZY=;
        b=P6q3WhjEO/55iw+vaIfRatEQB8PzMI7Sbdu9qiLc5FG/+cLwtOerlJFRd9OEK+53Db
         7occM8KGTcT3DIMS9aL8TqznfurrCJXP1zCFfugEaUWK1cAjh3Nwn4X/Ru14M4btWkge
         LWf6bAA++h1G7lU3GDXjMUni0yRXV98FBb+i0qShXvl0LSnLiafi8aPdE4hQ0sQhfPDn
         15bIuL3wVrsM4kmYIo+xVdHsbw4+mfIQQhy8Ktsj8yNAX0sCZnePVMElM+tl2JrlkQQc
         pxaGudevsXhv2zxpcWJu23TvpheMiMFawHZUYuA0nHfVQh6IMorT8PfIRS1hzwTXTiGs
         nIVg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740080158; x=1740684958;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=aq0auaV2gz0U2k7ZsV3xhtnt/Z87hJ6m6ZAx0KCC4ZY=;
        b=nNkFFU1QSXO+KmcjLPDD/iVOi+haWvXpXw2fU+mWsDdmx9wgkCdohGPSRZVjMytxQU
         tOhuHy8xyr21ljh5ZOH65Usnmpss5Nr43laI7FgqNsNCx6IHHVWVviXWNyHKE9tDrZS+
         cNkLn6jqoLTgCdhFHIzZzdT1Na6aQssJLnr66VWTL/aXJ4gh1i7YZ5WmfBbrw6pr1ziC
         b6i/wR6QHt6150gDKHfk29Uidch2EeI70Af7oX8CHoAXbeMSpwAe517gE38bX37fKyLf
         TcnedHstMRKMCYPS3dg+VsjbLnOssushmKIaL8bnugxWB8JxSaWOuGW8Im5g/tEiKfut
         fwnQ==
X-Forwarded-Encrypted: i=1; AJvYcCVma/narNAlU8SId8pUTMMsgryVPFIapIkcpiW41k1gNPpQhFVhMMW5Q2lnHKIR+nsa4aWNIv2sDiI=@vger.kernel.org
X-Gm-Message-State: AOJu0YxNBvHiW556apurHQ3EHrEHN/kKdkl/n7G0iScI49Zif73UHzCT
	9aU3xTPoas96kd465cZE4wxE/ShjqsFHeq2R+PtzXdhrTkok2KGIEMi5JlFyY+g=
X-Gm-Gg: ASbGncstTVwQ5xKC0PlSXDrjd4m2tecmCaWUbYhGGIdi8bDCxQcFEJWyX21iqwsL+Cu
	EO2+nJ+MOvPiB8gA5yGgyoF0vK2a8AgRTEHkGdg+1g6tSxhFdfsmFfZL0GWVCi+bOGJ2kN0WuCD
	cz14a1Ce3RTNjfE+DCHckdE+182cfT4hsGKIqZsi4YxXTL5EGWvISOPNFLwAU1XZPXgx1UxC+tk
	0ryP3+fkHZn3vCRlmyq+RVIjA97heoi22z+M6ZQ2zSYUfbA453z18kY6mlWioNL+w0C4nzsbsfQ
	qerIDZ+Tgi/O1PG0zQX7wCjp1I+ZYhILXGuVEwpzksXfn9v4y80PPa1uFuJy7wz4VkfU+BKM1A=
	=
X-Google-Smtp-Source: AGHT+IH6lIxZerlRr77ih8We+DvTCu5urzGeLg20c0jFu0pBr5a/Hqe/QBdSDGwo66aHfXOcSlUTMQ==
X-Received: by 2002:a05:620a:2444:b0:7c0:9f12:2b9b with SMTP id af79cd13be357-7c0cef53633mr82056685a.35.1740080157909;
        Thu, 20 Feb 2025 11:35:57 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e65d7a4430sm89493726d6.65.2025.02.20.11.35.57
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 20 Feb 2025 11:35:57 -0800 (PST)
Date: Thu, 20 Feb 2025 14:35:55 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7eEGwFltjWaoX-r@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
 <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
 <4ae838ee-b079-408e-8799-e9530ca50417@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <4ae838ee-b079-408e-8799-e9530ca50417@redhat.com>
Status: O
Content-Length: 822
Lines: 19

On Thu, Feb 20, 2025 at 08:26:21PM +0100, David Hildenbrand wrote:
> On 20.02.25 19:43, Gregory Price wrote:
> 
> There were ideas in how to optimize that (e.g., requiring  a new sysfs
> interface to expose variable-sized blocks), if anybody is interested, please
> reach out.
> 

Multiple block sizes would allow managing the misaligned issues I
discussed earlier as well (where a memory region is not aligned to the
arch-preferred block size).  At least in that scenario, the misaligned
regions could be brought online as minimal block size (256MB) while the
aligned portions could be brought online in larger (2GB) chunks.

Do you think this would this require a lot of churn to enable? Last I dug
through hotplug, it seemed to assume block sizes would be uniform. I was
hesitant to start ripping through it.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 670A421480E
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 19:44:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=170.10.133.124
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740080685; cv=none; b=Tg4uvAylGbZcGrUlxMDPZaH5cROCJ8+a1NUUkIt10bRjfEVhkSlyBRABxaCNpcAUcVRnU1hzr7W4T0t1WDsKJsNX/UW1OVuN75Ett5TOi1zr6BCFCMUe739nCqbqQhl2X8QYM7nYq0Cmzw9XOfwZnWdMg+bVLbSj5/Qa2QsI53k=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740080685; c=relaxed/simple;
	bh=epM/mbQGx5bYcIYYnKhe8inHgl0+75yjKwuSm3koulk=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=RVd8k1LA/40ukNp864a99ICPqC0n0+dpOwwHVHkrwxXccvI3O+Z1aOyoojmJjUOeSarrBR4nLfdTTqK6yC8D7tNl6nUHUMqrKwYCewriz9FUejVA48UM02sq8MERoN0d3a1/STo2N44kCV9A6loy0vEqBkwhRYh+Zo7JUc2cIdY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com; spf=pass smtp.mailfrom=redhat.com; dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b=ilQ8PT1N; arc=none smtp.client-ip=170.10.133.124
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=redhat.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=redhat.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com header.b="ilQ8PT1N"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
	s=mimecast20190719; t=1740080682;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding:
	 in-reply-to:in-reply-to:references:references:autocrypt:autocrypt;
	bh=13tc3PZGlJhjHRFttOUYRjhUqm6ZIOA8cqgOLipjY0s=;
	b=ilQ8PT1Np+/Ebx8Pt6wtba03h+Mta53wtOleppdf8qW4Xky0KITjGApj+ueRa5ELfI13qK
	2zRZZ0C5wOhG4hESbHHDO0K0leNOJCvZSm0uIcdyKWDy2DZL9CoAmBG+2Ws22Mzp/fhNNU
	YB+SMM5m++54fvscJfbpyBXytwNBxRc=
Received: from mail-wm1-f69.google.com (mail-wm1-f69.google.com
 [209.85.128.69]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384) id
 us-mta-176-ATw_CzPwOL6kv2WyUnvYWA-1; Thu, 20 Feb 2025 14:44:41 -0500
X-MC-Unique: ATw_CzPwOL6kv2WyUnvYWA-1
X-Mimecast-MFC-AGG-ID: ATw_CzPwOL6kv2WyUnvYWA_1740080680
Received: by mail-wm1-f69.google.com with SMTP id 5b1f17b1804b1-4393ed818ccso8781335e9.3
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 11:44:40 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740080680; x=1740685480;
        h=content-transfer-encoding:in-reply-to:organization:autocrypt
         :content-language:from:references:cc:to:subject:user-agent
         :mime-version:date:message-id:x-gm-message-state:from:to:cc:subject
         :date:message-id:reply-to;
        bh=13tc3PZGlJhjHRFttOUYRjhUqm6ZIOA8cqgOLipjY0s=;
        b=hlz+sGIFCjYnK/GAgB2j17iSM0P+F4PPs8Sm7764S/TJLR9J48gZuOC2/D4JSinXU0
         vzMtgFK5SjQAKPSKT4jHA1nqex+FnHB7cJBHiZ3EysNNM1Olic/uMdQwLQbNbFmyelAR
         3LT2FkH6K9I4jZFDU4r447onHO+x+YN9IXdrcerg3+GCarFBfDNqsTEk4PCS8/SGhQAZ
         Hj/OYIkMYjf8gJu3sYIhM1oOP5kS3chEbhnBx28pNE0HWIe54i5j6UU+J12H6q10kFSV
         eg2/PKtUAP5kktVyu1CbT1xt+YOcB3eWg72uSuCkTpyTJz7N4vB3bnDxvGVJnxRHEwkg
         TP1Q==
X-Forwarded-Encrypted: i=1; AJvYcCUQEPkSd4mGXuVIHxaWmgSmhLUGcJ/JzSp1ZNJ5KmFW5W8eagsTtyi6/q6AuGVYcGQWC4p4lgHlE7k=@vger.kernel.org
X-Gm-Message-State: AOJu0YxGnp/uZJEmTNHBjd7T20DTRqmWXQ/8DwbZhguVwVZQt1NQU4MV
	h8aUgm1+t2fnen0s7l1DihyDFW7HblxZhZzdRMyXjrrepg7f4q5AQ33n9qzuhypLrgxJLe7Cxu+
	69vNKtL5DEGMtdTCRUsUGru2HPhWfSJZcJFkO5GHOOfOi9b2O8q2Gj2wseQ==
X-Gm-Gg: ASbGncvjA1yc7WH1RDue1boIFdhU1hfPLpzN6P7Fr8oyggz8z5/LzT2Tp53drav5NiS
	zwenEdXmLOXK+HeGo6I6qbeVu01+/uTGgZB3DnERn7MOTXMLypH4VHrIYBjTBA1vbr+kiphYpj7
	+FmCiwzxMsBPzpLnYy4PMVvv2hwPY8iYFj1CtE3TiD8llQ5ASQV9JW3z7wG9VHv0OibFled79jI
	37Xbn1i5RIHzCfUlQGAPlKl+Epeu66XdYjSQ4g6RRCRkGMjqSOTK7Ox9tJoSYSdOJ8GS42gKnhh
	QHc8M/l6R0H7BD4sbwzv7wDhwm9QWsWWEDLaRggEI6AAd4Q1P46mwgsGgirxeJFK9VZvEZExrUd
	t4W0kJg8o5au/XvtJoo7CB6eUOKCCqQ==
X-Received: by 2002:a05:600c:1d82:b0:438:a240:c63 with SMTP id 5b1f17b1804b1-439ae3bd798mr2636555e9.2.1740080679777;
        Thu, 20 Feb 2025 11:44:39 -0800 (PST)
X-Google-Smtp-Source: AGHT+IEFQ/oyfYBUK3fUiKh0XjQS+69Txr3N9lLGYrS/0bgP4TwCTcZvVA7yprzpMPBstpyFgr/mqg==
X-Received: by 2002:a05:600c:1d82:b0:438:a240:c63 with SMTP id 5b1f17b1804b1-439ae3bd798mr2636355e9.2.1740080679293;
        Thu, 20 Feb 2025 11:44:39 -0800 (PST)
Received: from ?IPV6:2003:cb:c706:2000:e44c:bc46:d8d3:be5? (p200300cbc7062000e44cbc46d8d30be5.dip0.t-ipconnect.de. [2003:cb:c706:2000:e44c:bc46:d8d3:be5])
        by smtp.gmail.com with ESMTPSA id ffacd0b85a97d-38f258ccef7sm21822570f8f.31.2025.02.20.11.44.36
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Thu, 20 Feb 2025 11:44:37 -0800 (PST)
Message-ID: <b4b312c8-1117-45cd-a3c3-c8747aca51bd@redhat.com>
Date: Thu, 20 Feb 2025 20:44:36 +0100
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
To: Gregory Price <gourry@gourry.net>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
 linux-mm@kvack.org, linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z7OWmDXEYhT0BB0X@gourry-fedora-PF4VCD3F>
 <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
 <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
 <4ae838ee-b079-408e-8799-e9530ca50417@redhat.com>
 <Z7eEGwFltjWaoX-r@gourry-fedora-PF4VCD3F>
From: David Hildenbrand <david@redhat.com>
Autocrypt: addr=david@redhat.com; keydata=
 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
 WNyWQQ==
Organization: Red Hat
In-Reply-To: <Z7eEGwFltjWaoX-r@gourry-fedora-PF4VCD3F>
X-Mimecast-Spam-Score: 0
X-Mimecast-MFC-PROC-ID: ugJ1h-hGk0qHPioOj_EssqsgSfbraRyBaPOHNvQULkA_1740080680
X-Mimecast-Originator: redhat.com
Content-Language: en-US
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 1370
Lines: 34

On 20.02.25 20:35, Gregory Price wrote:
> On Thu, Feb 20, 2025 at 08:26:21PM +0100, David Hildenbrand wrote:
>> On 20.02.25 19:43, Gregory Price wrote:
>>
>> There were ideas in how to optimize that (e.g., requiring  a new sysfs
>> interface to expose variable-sized blocks), if anybody is interested, please
>> reach out.
>>
> 
> Multiple block sizes would allow managing the misaligned issues I
> discussed earlier as well (where a memory region is not aligned to the
> arch-preferred block size).  At least in that scenario, the misaligned
> regions could be brought online as minimal block size (256MB) while the
> aligned portions could be brought online in larger (2GB) chunks.
> 
> Do you think this would this require a lot of churn to enable? Last I dug
> through hotplug, it seemed to assume block sizes would be uniform. I was
> hesitant to start ripping through it.

There were some discussions around variable-sized memory blocks. But we 
cannot rip out the old stuff, because it breaks API and thereby Linux 
user space. There would have to be a world switch (e.g., kernel cmdline, 
config option)

... and some corner cases are rather nasty (e.g., hotunplugging boot 
memory, where we only learn from ACPI which regions actually belong to a 
single DIMM; dlpar hotunplugging individual memory blocks of boot memory 
IIRC).

-- 
Cheers,

David / dhildenb


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f175.google.com (mail-qt1-f175.google.com [209.85.160.175])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5DC52214218
	for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 20:06:18 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.175
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740081980; cv=none; b=qsq80a5Y+tOfwilf9wzDriNdXdvnlorsrsVpSMwGpdOhUo5/5oNEJJyNM1YUDFc3eTd5Q14W9BXaLBgVv/SLt5vmxUT69kSKKehiUdb/YQfJeVhSAtaT9CTPFtJEgPQuQureAbnh5wsxjUiBEzMDMS0JXu4qSrMMLsJYi1nIFhk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740081980; c=relaxed/simple;
	bh=Lu62kKHMAjMzflS7Jlf2vQo4LhUNA22Sn176RTqDkwY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=X6ZeS2lRmIu86zW2ju7p9/ADYn+qT9b1Qk0MrFKeTmqjIPpW/7LM8b5zswDNBJc19U147RCN/55u0Fl/nZq6xEjn4twQR4hKA6A1I4FFfLDy/nxcUiFhvDTPMlh4Sr7tRgIeGVIzd0Zd3Tt4dqKIy6trptQRIjyS0eMs6QfwiGg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=ovXM+/vW; arc=none smtp.client-ip=209.85.160.175
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="ovXM+/vW"
Received: by mail-qt1-f175.google.com with SMTP id d75a77b69052e-46fd4bf03cbso19806851cf.0
        for <linux-cxl@vger.kernel.org>; Thu, 20 Feb 2025 12:06:18 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1740081977; x=1740686777; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=K1KlFOn7Hg/ku1RTZ3R0CMdwBj99t0GI1rv1OK6Mr2w=;
        b=ovXM+/vWrkZBcNky/EZT6KkymxwUILtIhEBx0FDrm8vblAWSmFGjy5ULAFdee9cRje
         tbazEfal6L57f22h9rWyzAv8H2A9QCb+nmqmqXQr3NCrC2XfU2Pi3bXToYY0Ah1E6mIx
         oIaamsoCRumKV7OSeAHSRde2D7PcstFsw0qBWjTXAP16RtXkpeW7yuKP5KXS2Hww6uh2
         Aj8ffWZBBdCW4hno5CPiRq8KiwS4TGxLJsuLltvsLGUohxJxyEkZsBOlutY53Xjtqb2R
         o3upJL9aPg4ItdXyf2MVyidvX/EjUVQ/0hwuzsvtTFzjLu1i/YiCbizzqGGlfrzHiOn/
         6+sQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740081977; x=1740686777;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=K1KlFOn7Hg/ku1RTZ3R0CMdwBj99t0GI1rv1OK6Mr2w=;
        b=WBn1a3cH1poQjllH3SVmrSNa7nXu8f+So194uGCRGRa3vZxQTcwoQjjyNyuUlRhpfY
         ggEO1j3PYOcxmLhlKoRYODiMMRZ7OlxbnWPjmu4QrHfrMJF87nXvA4VAMauNQN9hpjvh
         vki3JKNZArh2KdVyQE5eBrNCtDr6YXXpAkOD86bjwXwXc74CQhBtkISs1AxbItW3Rthq
         4OrHQ5vflq47Nn0w1f3eJWr2VF2Kn16te0dVeicVPHxT0NPsqgC2ooVCJ8lG8dXN2bPS
         qgckbSy+yER62JGcbYPUfY2m+venlcTBsUJgXXvj+knuwRYdrlT9OYKpjRGqP4dPS6H8
         nMAA==
X-Forwarded-Encrypted: i=1; AJvYcCX1WR2tDjQC+26OQzmGTfR2KrPYTjkOk9dveMKeRiOJtQx7bylPwBd5dqZjZ8VQe5Lmzp32ZJZZPR0=@vger.kernel.org
X-Gm-Message-State: AOJu0Yy5KQiltwG6DF2AA7/HEKpKSoHzMLBgK0uDan9OiGWHfVQUk/50
	otB3G1hqQQAP8IbOTKgLNh4rjOfzE8eMuEyYuH6mLpfa/cHdFuhCnUSlYf4UZdg=
X-Gm-Gg: ASbGncucdVpssNXQSq0cR58PuywPV9fVEYchcXP5JOvfdwqpuNO7VVbxHgD5D97Pzp8
	ZoBw+9e+L1UvRyT9EIulYjUvhc4zc9u/SA6yzZTLlya+edlg+XMJtmIlmp7ZV6lGO6dWz06TsIk
	5mjGe36qvQB8lGUiXkwejYS2kPKolXosmkqOPCBkGDX0MqjBL+p+77VyeAcgvWUulaSe2L2gn0f
	jxoTAKQFDhMtE7W5wGXHHccGWMOMXr0WVRqIWkP0gSM+zCcqNKD0b65iZVQSktXEIPdpAyaiDev
	6K0eLa76N4JE/ylXhYcVep6lku6pcedZtJ3WhKvu1/0UyKiWr5HeKfN0MH7uJzdkAtwScfWDVg=
	=
X-Google-Smtp-Source: AGHT+IFqBXc3noHLl5J5ssCf0WWyGmo3wgivenGX96bW8nMSdpZU57GvoBw1O5ge2vFl9td66zPrCg==
X-Received: by 2002:a05:622a:13c7:b0:471:f3f2:62eb with SMTP id d75a77b69052e-472228ce17amr8517751cf.19.1740081977267;
        Thu, 20 Feb 2025 12:06:17 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-471ead6bdeesm51910061cf.32.2025.02.20.12.06.16
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 20 Feb 2025 12:06:16 -0800 (PST)
Date: Thu, 20 Feb 2025 15:06:15 -0500
From: Gregory Price <gourry@gourry.net>
To: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>, lsf-pc@lists.linux-foundation.org,
	linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 3: Memory (block) Hotplug
Message-ID: <Z7eLNyB230-wYof-@gourry-fedora-PF4VCD3F>
References: <CAHbLzkq6Me6nRaL6b09YxJ_nFkxb+n+M3-q_aJwOs2ZO4q8VCg@mail.gmail.com>
 <Z7TLwtQY3vGUw2bO@gourry-fedora-PF4VCD3F>
 <1b4c6442-a2b0-4290-8b89-c7b82a66d358@redhat.com>
 <Z7TswQbpPV590ADr@gourry-fedora-PF4VCD3F>
 <bda4cf52-d81a-4935-b45a-09e9439e33b6@redhat.com>
 <CAHbLzkqDQcrHLPzk8n0SMgkidH2ByCqdwfYXX=uBPQfOArWf8A@mail.gmail.com>
 <Z7d3vVdJ8UWU5oex@gourry-fedora-PF4VCD3F>
 <4ae838ee-b079-408e-8799-e9530ca50417@redhat.com>
 <Z7eEGwFltjWaoX-r@gourry-fedora-PF4VCD3F>
 <b4b312c8-1117-45cd-a3c3-c8747aca51bd@redhat.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <b4b312c8-1117-45cd-a3c3-c8747aca51bd@redhat.com>
Status: O
Content-Length: 1212
Lines: 27

On Thu, Feb 20, 2025 at 08:44:36PM +0100, David Hildenbrand wrote:
> On 20.02.25 20:35, Gregory Price wrote:
> 
> There were some discussions around variable-sized memory blocks. But we
> cannot rip out the old stuff, because it breaks API and thereby Linux user
> space. There would have to be a world switch (e.g., kernel cmdline, config
> option)
> 
> ... and some corner cases are rather nasty (e.g., hotunplugging boot memory,
> where we only learn from ACPI which regions actually belong to a single
> DIMM; dlpar hotunplugging individual memory blocks of boot memory IIRC).
> 

Probably we just end back up between a rock and a hard place then.  Let
me finish this documentation series and cleaning up corrections and I'll
come back around on this and figure out if it's feasible.

If variable sized memory blocks in infeasible, then the only solution to
misaligned memory regions seems to be to wag a finger at hardware vendors
as Dan suggests.

Thinking about my current acpi/block size extension, it does seem bad
that the user can't choose to force a larger block sizes without a
boot parameter - but i hesitate to add *yet another* switch on top of
that. The problem is complicated enough.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f172.google.com (mail-qt1-f172.google.com [209.85.160.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1F0EC27713
	for <linux-cxl@vger.kernel.org>; Tue,  4 Mar 2025 00:32:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741048369; cv=none; b=ssC5LXwU2ZCu6DVf6xIWRkzd3imhIgR8P++wRUfldULClMS6gnAfYlLSpGxQ3B54sS+xJnYeEahz5MLHYbfpf/ke34Pw/ZqrEDLfWnlCXLi2SJZ19WQdlKMAT6zjYVKvAjXBDvOMoBQEmdFuUnqrcrZWeyQVrLFQ0WdEy+ye78U=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741048369; c=relaxed/simple;
	bh=bFQHniKIvSuR78w711suUM8eKtNcV3Kas3fecaB9ie0=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=nLOHMdSAbExvmwbsb1l1mBkNNyVfK1t/uVEomzwVlv9fmgYTa7YCkTJ9d92ooa+JC073l76Horug6yI/0eZmhXK2AkE3qjQwIHaMHNPAbdpo7YxHDTnK2cdzVsM9+oY0vdHMVXnFGLClPWZYt1DVuNA5AF2cgMhApqzdItbu/RI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=kpzoPATY; arc=none smtp.client-ip=209.85.160.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="kpzoPATY"
Received: by mail-qt1-f172.google.com with SMTP id d75a77b69052e-474bc1aaf5fso67897661cf.0
        for <linux-cxl@vger.kernel.org>; Mon, 03 Mar 2025 16:32:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741048367; x=1741653167; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=pw+9bjqD0Zwi6XTLWN9K32oaqVMQWYgDhTNGSzicq5Y=;
        b=kpzoPATYMbZMbPf0Vpx6VaacPuNow19UKVT3D+io/hffzg82D+2BeoihlnnvJ7tWRI
         rRpgg0YsX51CzWadboxgcN0QHb+LPea0YziNdQDcM+BM8PGtx1mqZ7bfU94Y/FFg54gN
         qbK/8OUYUmBD7vdXqmwhLkLr+MIKMHjKmOYL5Ic1Io8NITO5f7Xw0z5XoB2nd/+lUA2G
         mngb0Mu4PhVm/pVXnAQaPAAGyup+gPR2rlv/zysqBY+9vq7COrsD6nTS34wMBwd2DV0j
         zu3HCBhnYRZiKy+d++28RQIm31ueyV5kHYW223/A3JW0+Ku0SfknX0hGL5ErY1FPDI2d
         Z7lg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741048367; x=1741653167;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=pw+9bjqD0Zwi6XTLWN9K32oaqVMQWYgDhTNGSzicq5Y=;
        b=O5q9v9be2zRIU/1ISen929yMLjpvFvOp0cAkaLnQsBbHtkWPETJgux+EdPTegKUF/I
         GAuadEzcWQf/umiXgG2oxx8dbQjGzxHdBZbC8hmtXQs53iwKrM5BT+3LzZZ2XCEsQdEN
         dg06a+Cml3riBBvRfJEt+FlPYUnaJcchCqPCoBhj3Ya78wtiMclVfvHb8Mk4ZRjzDnty
         AjSV9kvkiEwUsqBGujn+LZMS9vfJLoHIO1W4rtcDaKz4OhyOpKShckZiSLpTT2CPSMWq
         FaOKbQ4VZV3jsjzLuim26UUpM2oG49sAyaJAoaYUyM/meslBk8Ql2S/IpdZ3ZgdCZE9i
         XKOw==
X-Forwarded-Encrypted: i=1; AJvYcCVZ48v2z7pCWYLDTJiPewuMdKWO0xi9NTR5Pf7HxaCuxkKeQuzFAXxiRyLoHTLCT7HYV1pc26e31lE=@vger.kernel.org
X-Gm-Message-State: AOJu0YxbKcNF+48SYlvXSmge7ZCzxZViBwCxM+78yU6nfeQ9KwmZ0wRm
	oH4mvVe4UcAQ2CZN2x/MSiMErtrqqxxcZGvuKPdZkrciXo39INoynRSEgt5wkDFnk2bU4KF63BM
	b
X-Gm-Gg: ASbGncuMkmgXOpgyEXbkxvgRLpECGp7m3NHL3DEF2OWX3N5O7gZ5tZMK7v6Tla7R7QQ
	jvRtvZKcb0X4xebSvi2nq+pZF4EXi2a+jb7z7i++6okrfzDg5r3MghDl0lz+OHXXODZTvUmNyVL
	L78XPdkJ4tz5yTMMPEL2J68kDXG3XgXWrdtfL06M3RVUysF83K2Zy6HNSMW9P+bY/bSzgX5XSSY
	KFCw6D5K/FxgwCSF1aJn97Xdud7W51/1sGTKoqMP2gCcvfEQeIMvasNSBxWIXiyiMSb+FU3Trot
	wxsQRJN8RkWSn5ZE2vC0LX9ODe3Ojltz0CY22Q9LOYgtBkM9DaK1gD6vbQTPXuXJYsmxDSQIRss
	di+iXKu8h1b0G5Z1IqevEpTwZPGU=
X-Google-Smtp-Source: AGHT+IEVAevyW2OR0o4+vVHk933xbD+rCHnDoRi5qyqfNQX2/sa4Qf+bjeIiSl09eve86dbBFG8pFA==
X-Received: by 2002:a05:622a:5c6:b0:472:1275:6967 with SMTP id d75a77b69052e-474bc08782dmr261346811cf.21.1741048366820;
        Mon, 03 Mar 2025 16:32:46 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-4747242fe2dsm64847301cf.75.2025.03.03.16.32.44
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 16:32:45 -0800 (PST)
Date: Mon, 3 Mar 2025 19:32:43 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 1: BIOS, EFI, and Early Boot
Message-ID: <Z8ZKKwDnuAjtyohz@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z6LKJZkcdjuit2Ck@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 4205
Lines: 106

On Tue, Feb 04, 2025 at 09:17:09PM -0500, Gregory Price wrote:
> ------------------------------------------------------------------
> Step 2: BIOS / EFI generates the CEDT (CXL Early Detection Table).
> ------------------------------------------------------------------
> 
> This table is responsible for reporting each "CXL Host Bridge" and
> "CXL Fixed Memory Window" present at boot - which enables early boot
> software to manage those devices and the memory capacity presented
> by those devices.
> 
> Example CEDT Entries (truncated) 
>          Subtable Type : 00 [CXL Host Bridge Structure]
>               Reserved : 00
>                 Length : 0020
> Associated host bridge : 00000005
> 
>          Subtable Type : 01 [CXL Fixed Memory Window Structure]
>               Reserved : 00
>                 Length : 002C
>               Reserved : 00000000
>    Window base address : 000000C050000000
>            Window size : 0000003CA0000000
> 
> If this memory is NOT marked "Special Purpose" by BIOS (next section),
> you should find a matching entry EFI Memory Map and /proc/iomem
> 
> BIOS-e820:   [mem 0x000000c050000000-0x000000fcefffffff] usable
> /proc/iomem: c050000000-fcefffffff : System RAM
> 
> 
> Observation: This memory is treated as 100% normal System RAM
> 
>    1) This memory may be placed in any zone (ZONE_NORMAL, typically)
>    2) The kernel may use this memory for arbitrary allocations
>    4) The driver still enumerates CXL devices and memory regions, but
>    3) The CXL driver CANNOT manage this memory (as of today)
>       (Caveat: *some* RAS features may still work, possibly)
> 
> This creates an nuanced management state.
> 
> The memory is online by default and completely usable, AND the driver
> appears to be managing the devices - BUT the memory resources and the
> management structure are fundamentally separate.
>    1) CXL Driver manages CXL features
>    2) Non-CXL SystemRAM mechanisms surface the memory to allocators.
> 

Adding some additional context here

-------------------------------------
Nuance X: NUMA Nodes and ACPI Tables.
-------------------------------------

ACPI Table parsing is partially architecture/platform dependent, but
there is common code that affects boot-time creation of NUMA nodes.

NUMA-nodes are not a dynamic resource.  They are (presently, Feb 2025)
statically configured during kernel init, and the number of possible
NUMA nodes (N_POSSIBLE) may not change during runtime.

CEDT/CFMW and SRAT/Memory Affinity entries describe memory regions
associated with CXL devices.  These tables are used to allocate NUMA
node IDs during _init.

The "System Resource Affinity Table" has "Memory Affinity" entries
which associate memory regions with a "Proximity Domain"

        Subtable Type : 01 [Memory Affinity]
               Length : 28
     Proximity Domain : 00000001
            Reserved1 : 0000
         Base Address : 000000C050000000
       Address Length : 0000003CA0000000

The "Proximity Domain" utilized by the kernel ACPI driver to match this
region with a NUMA node (in most cases, the proximity domains here will
directly translate to a NUMA node ID - but not always).

CEDT/CFMWS do not have a proximity domain - so the kernel will assign it
a NUMA node association IFF no SRAT Memory Affinity entry is present.

SRAT entries are optional, CFMWS are required for each host bridge.

If SRAT entries are present, one NUMA node is created for each detected
proximity domain in the SRAT. Additional NUMA nodes are created for each
CFMWS without a matching SRAT entry.

CFMWS describes host-bridge information, and so if SRAT is missing - all
devices behind the host bridge will become naturally associated with the
same NUMA node.


big long TL;DR:

This creates the subtle assumption that each host-bridge will have
devices with similar performance characteristics if they're intended
for use as general purpose memory and/or interleave.

This means you should expect to have to reboot your machine if a
different NUMA topology is needed (for example, if you are physically
hotunplugging a volatile device to plug in a non-volatile device).



Stay tuned for more Fun and Profit with ACPI tables :]
~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f176.google.com (mail-qk1-f176.google.com [209.85.222.176])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B66E513AA2F
	for <linux-cxl@vger.kernel.org>; Tue,  4 Mar 2025 01:32:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.176
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741051975; cv=none; b=j7WMN8K69+DcdlmXAJVZzPF4eYduR3dG3LWCm9BkhLg5ztMpdxuTTKAoaF8C5kqjFumI6n8klJ9dWmWFlh8E5maS8Q9vCs/zQkep5y6CPuN+VRKRGyips+BWX0MnlHCHd8cfiTUi8Ku5QzplEc83sWLARdxOXlXtlPaHavIksvo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741051975; c=relaxed/simple;
	bh=v5/bYUBFt7ixahljwJAw2cD9ksUIJ1iHD9P7j1AbFLo=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=jqsaGVjgSzUkFIf59Cj8m+XzWazLv6vBTPKGPHrNkM1fPC0U382kEwPd10+g/v+ZcYwMKNPyrC2+YtxAN0lqxQHzHCEQQSwgqhsPdqRtDkLShOUpHGvLKKPLrD+UX8PYhfHQpuLh4bIGCYQCGqW7pmTvVAkRnUj4rwxFh3+sAiQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=XdbBZg+I; arc=none smtp.client-ip=209.85.222.176
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="XdbBZg+I"
Received: by mail-qk1-f176.google.com with SMTP id af79cd13be357-7c08f9d0ef3so279059085a.2
        for <linux-cxl@vger.kernel.org>; Mon, 03 Mar 2025 17:32:53 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741051972; x=1741656772; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=r6xB6tZBkxBseJmMvpYQ2Hhx7HYfm01hEgI0/OHSmWI=;
        b=XdbBZg+I9bH7LQ2/qdjfVbSKeONUcg9+3Ft3PtqlqqIQzNPuRpi4vT2heztO9Dt9Lj
         v28fVEua0ENpzt+WOc/SIzO4GHA27iQZxgFsUk1Zt/Qf4CLuXZ18j0u7kq+AE+RcXuu1
         802V3MDWGbsQDe4Wja6bDtSJVfEkO6JakM7/60q2St0OF7drApZi+K1tXifkM5qPRUvD
         WJ91383hb1Z++nMsh6FKjmdBeS1QfA47FmkVrh0eYVeP50FjBsVRaVGk/+4RV3x6ivM4
         iXANkEKovhG0ZIOZPjtJrcDkALepTt2MBGff3N3bFosVoAcS29vwKqQrGlspRelpY+Q/
         9amQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741051972; x=1741656772;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=r6xB6tZBkxBseJmMvpYQ2Hhx7HYfm01hEgI0/OHSmWI=;
        b=juO+C//gZrQ2E7sA1PvHP/MwdyVktPHljb0G8EZB041Ft2bb/CuYhMkCCi7vbM/y7e
         dNEts4h38M/Ph5gNktYlP2zSs2K7cvo4UmzfTFPbzTIagb8VW5SVCQ5AcxmqnYwsMFYS
         80rhy8YpFD37MSE9mV3vlv+679AxXondjk+XMhgTh+z2k3d48yyMBmJ6P94LnyVEztdX
         +gXnJyf+/4QymlZcrb7RkhlxOlxAFhWR6PbiLYNYDdYru6+YIncneWvf+rIqGm8FLIax
         8i/4ud7L+JVAeFI0yayNNCxL3GFoqXbKqNBguJtsde089DtTQ5OglW/AtgOZmH5nAwmB
         BU3g==
X-Forwarded-Encrypted: i=1; AJvYcCWYKlAWN3RXXD7KopxHNdA0AmzomWOPSS7hisJsWGwxP6BCTgzioM915gYGsqL4p6ZxYMNA0bCjN80=@vger.kernel.org
X-Gm-Message-State: AOJu0Yw1EtH+EyjhGu7fc1IgkgK+/hc8l8jYBnJN3LwvUa/zv26eUTwh
	u4TQIS1ct0qBbGP2hTEM9j5TDYOGsoOQ33tiE340CuDx4yIt2VfuBfA18hLe25s=
X-Gm-Gg: ASbGncvFO+2GFk2pCQMOfo5OuYYpSg5TQ+I0qFOsj7jUqUg5ibeg6MCXV/IvE3l8Tos
	7dYZIq8rhJsa1ZkTq9Ri11l6nDx5xY7WZd3cX8vZAHup39w92u+3iSVPqQS2cVHpWGq3S3wMLzG
	9hWzZ70jzh/j5+aifqBmRCzNDE5ZPhIwLaT1a8EgF2/IQAFZXvTwlVdIDkcJGhyIvfNRYKyAK0u
	eeopg1BM0m+c6IvM0G7LApmXRxckWXWd06r1EHrEwkJqMzVKDUP/xkefRPEl/Fkgxod3SL7lRPA
	wwK557DVDx2qlQzSWqF5LTtfMc2TRMhNt7hMDh21nUE8NJeQOwNI0d+F4IK4n4F0+b5TYlNr+ss
	S0MoLVw5i6JoxaAyJiMV5564/Keg=
X-Google-Smtp-Source: AGHT+IG4dWln+CNbJieutk1fOc0kWi4nxKmsaP4G3WEAip9vevv4K/TkpbAdj3Eb+EfbBCSu65rNPQ==
X-Received: by 2002:a05:620a:4492:b0:7c0:9f12:2b7e with SMTP id af79cd13be357-7c39c49fa6emr2001696785a.11.1741051972460;
        Mon, 03 Mar 2025 17:32:52 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3b7366e26sm231363985a.87.2025.03.03.17.32.51
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 17:32:52 -0800 (PST)
Date: Mon, 3 Mar 2025 20:32:50 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: Re: CXL Boot to Bash - Section 2: The Drivers
Message-ID: <Z8ZYQqm_UxDDphSf@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 1818
Lines: 42

On Wed, Feb 05, 2025 at 11:06:08AM -0500, Gregory Price wrote:
> ---------------------------------------------------------
> Second bit of nuanced complexity: Memory Block Alignment.
> ---------------------------------------------------------
> In section 1, we introduced CEDT / CFMW and how they map to iomem
> resources.  In this section we discussed out we surface memory blocks
> to the kernel allocators.
> 
> However, at no time did platform, arch code, and driver communicate
> about the expected size of a memory block. In most cases, the size
> of a memory block is defined by the architecture - unaware of CXL.
> 
> On x86, for example, the heuristic for memory block size is:
>    1) user boot-arg value
>    2) Maximize size (up to 2GB) if operating on bare metal
>    3) Use smallest value that aligns with the end of memory
> 
> The problem is that [SOFT RESERVED] memory is not considered in the
> alignment calculation - and not all [SOFT RESERVED] memory *should*
> be considered for alignment.
> 
> In the case of our working example (real system, btw):
> 
>          Subtable Type : 01 [CXL Fixed Memory Window Structure]
>    Window base address : 000000C050000000
>            Window size : 0000003CA0000000
> 
> The base is 256MB aligned (the minimum for the CXL Spec), and the
> window size is 512MB.  This results in a loss of almost a full memory
> block worth of memory (~1280MB on the front, and ~512MB on the back).
> 
> This is a loss of ~0.7% of capacity (1.5GB) for that region (121.25GB).
> 

Some additional nuance adding here: Dynamic Capacity Devices will also
have problems with this issue unless the fabric manager is aware of the
host memory block size configuration.

Variable sized or sparse memory blocks may be possible in the future,
but as of today they are not.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f182.google.com (mail-qk1-f182.google.com [209.85.222.182])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 35714202C4F
	for <linux-cxl@vger.kernel.org>; Wed,  5 Mar 2025 22:20:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.182
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741213258; cv=none; b=skeyyHRuB1dlRXeA/I6gp7bJ9YBdSIixCIGgHpYQKVsMIGuHMmb53vlz94nizXtrgcGsaGWWSJ2BVourLJMV9pucVfIOE8meLyFFsRhwRSDkXnskjYZNs/GoXr3Eo8BGYb0xhik6iKmhnrCBJGvfSHvyi3GUaGEwkFk2d0bxoso=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741213258; c=relaxed/simple;
	bh=1D/zcCXONrzBkuomAV1YE06x7//rKwo5IXcy5VAGy2o=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=quNvr8WJ+L8tL6g9sn9xDswgXL3e3FxvkwO4vWzlza9pOB5+CIxMcR0c52iFMFy7u9jnLqR14ZtSbkS4bSv6VILK/fMlJ4RqyGZEX/04W1Z4ieYvUETT2/7lH21MkFg7nXYEa/8wn4/ZtxxqSpo7v01W7x4TTOqpDwsWbmCkEv8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=B8Hu/jNY; arc=none smtp.client-ip=209.85.222.182
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="B8Hu/jNY"
Received: by mail-qk1-f182.google.com with SMTP id af79cd13be357-7c3ca86e8c3so203358085a.1
        for <linux-cxl@vger.kernel.org>; Wed, 05 Mar 2025 14:20:55 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741213255; x=1741818055; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=BO0P4C0Cv5YPDEVOqjeYmeu2Ronxavw79A+lbaur1FI=;
        b=B8Hu/jNYESaO2xBBlqZsQtnEO0OCFY64t7NCW6WMMdbIr5uFUgdZswvEBdRCuXW0ON
         Ahp4DHajmO3tZ7D8o4h5/NiPqc6xFk1RceOOoyK9uVQj6rNfTGboHH/xV6m74B6Bv1lk
         LD4nAykNPsiQGcY0/ESnqnt6gXKU9IcrdGy934ImM1wru1xJB8FNSiR3AF0KTQ9oMEMw
         Ym5qaXv8ACCCrRJx05t1VWT4PhTvP3sUMaemB6VmTVqDe3mDBAAXVAaHNoCWWPh9Xx63
         YTikC6M5jw2HUXftv7jymgdTPVwTurBFh1OaYUdRRUfALLD0ps63IDKqk0Cwcg9mZ+US
         Jjqw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741213255; x=1741818055;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=BO0P4C0Cv5YPDEVOqjeYmeu2Ronxavw79A+lbaur1FI=;
        b=XMJ443YsuiLa+ADL4gO58KZQyyYdXY8b26PZ9QVu8S3CCfNeCwEbfr5PXwH4ZZfPUK
         4kk7tAK+idLLeD927jbEs8neBDcjFmbjmXEJKrFWeAmLL8SOb6mzmMPTR6Bq84hNh9mG
         ruPB03HyzajEY7YrXgXufnV0RTz2rP7r5BqsnhM817psDkfii/+IXwsOwUoRVTPBXGp7
         yCO85wAMTnlGa+9BH0n44lVxdfj/VfchHiz2QMztXERtnXSWSHmOI8+bqG5tRC47cuPe
         Aq5BlGZhFSi1EkyrK56Sum5I0rpRHWsDOdz0exMR/iTTFEa9XCCHZCTxMW9BicR/aMSV
         o8qg==
X-Forwarded-Encrypted: i=1; AJvYcCUUByB1hsm3A7zfzgIz0vXgP4p5gT2yk7GZ7RgqmAq7Fl9kNhrS6oJYoR7yWptTQQIhHY/krGrVNcE=@vger.kernel.org
X-Gm-Message-State: AOJu0YwlHHUr8jCKIYMY1RKDtQvMOLY/a8UwtiNl1DgO8IJfV1kFU4tf
	PiQe2yOjeiBxnsRDswa9kOf23Vw6L3eUMjA+FwwBUKDj3ELOHRrAVK8gMKLHbcI=
X-Gm-Gg: ASbGnctSvwcTN5SRFtaO+UvVB1ojXRELF0/NQU+q9t6UrWFtN6YOgxwwgsY5Z4ZxYfb
	D17wz+80+hu5hsv0kNkSWklBTQ64sxIWA/dR9Ocgq8JLK4pxobvza2QYcl8fyHTHMkvH9UO+25J
	afjjX1LsyEoOQCaaTcQDjqBrblr15uiia+Z8EPoqUj6J3/MNaPl7KMiB1lC6o5tPPzT5fD55nWs
	bNdR5/tUePlCccAPAueys8arl8uQHOwqh8A4kewwzQ1NVbbBtPzRcuRRamVl4dwnMOWYx4y4PAC
	GuSiW65s/KBWIV/0AITE56p8R96XIzzdrn8K7TO/j2GH8PbAKcNlZQDWq4QgyvbogoHMShvIum3
	hbcGfcP5ja2e0CqPxZHtTk+09C+I=
X-Google-Smtp-Source: AGHT+IE8tBIvqNkBR0RqVk3FB2EWb5Dyn3WBPJBwmSSlDY+T4y6mohYuJuZsV1nkfng7jl+opX/Cwg==
X-Received: by 2002:a05:620a:601c:b0:7c0:a63e:4622 with SMTP id af79cd13be357-7c3d8def6fcmr890597285a.31.1741213254811;
        Wed, 05 Mar 2025 14:20:54 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3b8cd9d36sm480280285a.104.2025.03.05.14.20.54
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 14:20:54 -0800 (PST)
Date: Wed, 5 Mar 2025 17:20:52 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
Status: RO
Content-Length: 10987
Lines: 317

--------------------
Part 0: ACPI Tables.
--------------------
I considered publishing this section first, or at least under
"Platform", but I've found this information largely useful in
debugging interleave configurations and tiering mechanisms -
which are higher level concepts.

Much of the information in this section is most relevant to
Interleave (yet to be published Section 4).

I promise not to simply regurgitate the entire ACPI specification
and limit this to necessary commentary to describe how these tables
relate to actual Linux resources (like numa nodes and tiers).

At the very least, if you find yourself trying to figure out why
your CXL system isn't producing NUMA nodes, memory tiers, root
decoders, memory regions - etc - I would check these tables
first for aberrations.  Almost all my personal strife has been
associated with ACPI table misconfiguration.


ACPI tables can be inspected with the `acpica-tools` package.
   mkdir acpi_tables && cd acpi_tables
   acpidump -b
   iasl -d *
   -- inpect the *.dsl files

====
CEDT
====
The CXL Early Discovery Table is generated by BIOS to describe
the CXL devices present and configured (to some extent) at boot
by the BIOS.

# CHBS
The CXL Host Bridge Structure describes CXL host bridges.  Other
than describing device register information, it reports the specific
host bridge UID for this host bridge.  These host bridge ID's will
be referenced in other tables.

Debug hint: check that the host bridge IDs between tables are
            consistent - stuff breaks oddly if they're not!

```
         Subtable Type : 00 [CXL Host Bridge Structure]
              Reserved : 00
                Length : 0020
Associated host bridge : 00000007    <- Host bridge _UID
 Specification version : 00000001
              Reserved : 00000000
         Register base : 0000010370400000
       Register length : 0000000000010000
```

# CFMWS
The CXL Fixed Memory Window structure describes a memory region
associated with one or more CXL host bridges (as described by the
CHBS).  It additionally describes any inter-host-bridge interleave
configuration that may have been programmed by BIOS. (Section 4)

```
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 000000C050000000   <- Memory Region
             Window size : 0000003CA0000000
Interleave Members (2^n) : 01               <- Interleave configuration
   Interleave Arithmetic : 00
                Reserved : 0000
             Granularity : 00000000
            Restrictions : 0006
                   QtgId : 0001
            First Target : 00000007         <- Host Bridge _UID
             Next Target : 00000006         <- Host Bridge _UID
```

INTER-host-bridge interleave (multiple devices on one host bridge) is
NOT reported in this structure, and is solely defined via CXL device
decoder programming (host bridge and endpoint decoders).  This will be
described later (Section 4 - Interleave)


====
SRAT
====
The System/Static Resource Affinity Table describes resource (CPU,
Memory) affinity to "Proximity Domains". This table is technically
optional, but for performance information (see "HMAT") to be enumerated
by linux it must be present.


# Proximity Domain
A proximity domain is ROUGHLY equivalent to "NUMA Node" - though a
1-to-1 mapping is not guaranteed.  There are scenarios where "Proximity
Domain 4" may map to "NUMA Node 3", for example.  (See "NUMA Node Creation")

# Memory Affinity
Generally speaking, if a host does any amount of CXL fabric (decoder)
programming in BIOS - an SRAT entry for that memory needs to be present.

```
        Subtable Type : 01 [Memory Affinity]
               Length : 28
     Proximity Domain : 00000001          <- NUMA Node 1
            Reserved1 : 0000
         Base Address : 000000C050000000  <- Physical Memory Region
       Address Length : 0000003CA0000000
            Reserved2 : 00000000
Flags (decoded below) : 0000000B
             Enabled : 1
       Hot Pluggable : 1
        Non-Volatile : 0
```

# Generic Initiator / Port
In the scenario where CXL devices are not present or configured by
BIOS, we may still want to generate proximity domain configurations
for those devices.   The Generic Initiator interfaces are intended to
fill this gap, so that performance information can still be utilized
when the devices become available at runtime.

I won't cover the details here, for now, but I will link to the
proosal from Dan Williams and Jonathan Cameron if you would like
more information.
https://lore.kernel.org/all/e1a52da9aec90766da5de51b1b839fd95d63a5af.camel@intel.com/

====
HMAT
====
The Heterogeneous Memory Attributes Table contains information such as
cache attributes and bandwidth and latency details for memory proximity
domains.  For the purpose of this document, we will only discuss the
SSLIB entry.

# SLLBI
The System Locality Latency and Bandwidth Information records latency
and bandwidth information for proximity domains. This table is used by
Linux to configure interleave weights and memory tiers.

```
Heavily truncated for brevity
              Structure Type : 0001 [SLLBI]
                   Data Type : 00         <- Latency
Target Proximity Domain List : 00000000
Target Proximity Domain List : 00000001
                       Entry : 0080       <- DRAM LTC
                       Entry : 0100       <- CXL LTC

              Structure Type : 0001 [SLLBI]
                   Data Type : 03         <- Bandwidth
Target Proximity Domain List : 00000000
Target Proximity Domain List : 00000001
                       Entry : 1200       <- DRAM BW
                       Entry : 0200       <- CXL BW
```


---------------------------------
Part 00: Linux Resource Creation.
---------------------------------

==================
NUMA node creation
===================
NUMA nodes are *NOT* hot-pluggable.  All *POSSIBLE* NUMA nodes are
identified at `__init` time, more specifically during `mm_init`.

What this means is that the CEDT and SRAT must contain sufficient
`proximity domain` information for linux to identify how many NUMA
nodes are required (and what memory regions to associate with them).

The relevant code exists in: linux/drivers/acpi/numa/srat.c
```
static int __init
acpi_parse_memory_affinity(union acpi_subtable_headers *header,
                           const unsigned long table_end)
{
... heavily truncated for brevity
        pxm = ma->proximity_domain;
        node = acpi_map_pxm_to_node(pxm);
        if (numa_add_memblk(node, start, end) < 0)
            ....
        node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
}

static int __init acpi_parse_cfmws(union acpi_subtable_headers *header,
                                   void *arg, const unsigned long table_end)
{
... heavily truncated for brevity
        /*
         * The SRAT may have already described NUMA details for all,
         * or a portion of, this CFMWS HPA range. Extend the memblks
         * found for any portion of the window to cover the entire
         * window.
         */
        if (!numa_fill_memblks(start, end))
                return 0;

        /* No SRAT description. Create a new node. */
        node = acpi_map_pxm_to_node(*fake_pxm);
        if (numa_add_memblk(node, start, end) < 0)
	        ....
        node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
}

int __init acpi_numa_init(void)
{
...
    if (!acpi_table_parse(ACPI_SIG_SRAT, acpi_parse_srat)) {
        cnt = acpi_table_parse_srat(ACPI_SRAT_TYPE_MEMORY_AFFINITY,
                                    acpi_parse_memory_affinity, 0);
    }
    /* fake_pxm is the next unused PXM value after SRAT parsing */
    acpi_table_parse_cedt(ACPI_CEDT_TYPE_CFMWS, acpi_parse_cfmws,
                          &fake_pxm);

```

Basically, the heuristic is as follows:
1) Add one NUMA node per Proximity Domain described in SRAT
2) If the SRAT describes all memory described by all CFMWS
   - do not create nodes for CFMWS
3) If SRAT does not describe all memory described by CFMWS
   - create a node for that CFMWS

Generally speaking, you will see one NUMA node per Host bridge, unless
inter-host-bridge interleave is in use (see Section 4 - Interleave).


============
Memory Tiers
============
The `abstract distance` of a node dictates what tier it lands in (and
therefore, what tiers are created).  This is calculated based on the
following heuristic, using HMAT data:

```
int mt_perf_to_adistance(struct access_coordinate *perf, int *adist)
{
 ...
    /*
     * The abstract distance of a memory node is in direct proportion to
     * its memory latency (read + write) and inversely proportional to its
     * memory bandwidth (read + write).  The abstract distance, memory
     * latency, and memory bandwidth of the default DRAM nodes are used as
     * the base.
     */
    *adist = MEMTIER_ADISTANCE_DRAM *
        (perf->read_latency + perf->write_latency) /
        (default_dram_perf.read_latency + default_dram_perf.write_latency) *
        (default_dram_perf.read_bandwidth + default_dram_perf.write_bandwidth) /
        (perf->read_bandwidth + perf->write_bandwidth);
    return 0;
}
```

Debugging hint: If you have DRAM and CXL memory in separate numa nodes
                but only find 1 memory tier, validate the HMAT!


============================
Memory Tier Demotion Targets
============================
When `demotion` is enabled (see Section 5 - allocation), the reclaim
system may opportunistically demote a page from one memory tier to
another.  The selection of a `demotion target` is partially based on
Abstract Distance and Performance Data.

```
An example of demotion targets from memory-tiers.c
/* Example 1:
 *
 * Node 0 & 1 are CPU + DRAM nodes, node 2 & 3 are PMEM nodes.
 *
 * node distances:
 * node   0    1    2    3
 *    0  10   20   30   40
 *    1  20   10   40   30
 *    2  30   40   10   40
 *    3  40   30   40   10
 *
 * memory_tiers0 = 0-1
 * memory_tiers1 = 2-3
 *
 * node_demotion[0].preferred = 2
 * node_demotion[1].preferred = 3
 * node_demotion[2].preferred = <empty>
 * node_demotion[3].preferred = <empty>
 */
```

=============================
Mempolicy Weighted Interleave
=============================
The `weighted interleave` functionality of `mempolicy` utilizes weights
to distribute memory across NUMA nodes according to some set weight.
There is a proposal to auto-configure these weights based on HMAT data.

https://lore.kernel.org/linux-mm/20250305200506.2529583-1-joshua.hahnjy@gmail.com/T/#u

See Section 4 - Interleave, for more information on weighted interleave.



--------------
Build Options.
--------------
We can add these build configurations to our complexity picture.

CONFIG_NUMA        - req for ACPI numa, mempolicy, and memory tiers
CONFIG_ACPI_NUMA   -- enables srat and cedt parsing
CONFIG_ACPI_HMAT   -- enables hmat parsing


~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 44C9D2E339F;
	Wed,  5 Mar 2025 22:44:14 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.10
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741214657; cv=none; b=qQoIMXPVOrR25+Q+RBetprXxJRCxfW9xYb47+vi6m9J8XzirMBF4nHXUf7ZwsUxuWl9198nZHjxTFiboTtMsEmlGdz2JrQzUG2/f17xmvf22xgb1lc/j4KX4pzAF99OWaz9hQn0Ic6qIeSeHfzZQGKFm0tOCMI0Nd3ytUS4EUZA=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741214657; c=relaxed/simple;
	bh=sIWPNe1sDkCNXWyhYlSpIXOLZLQV67vXvBhITwEc69I=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=LpSgD4DFSOr6WTZNzkY3dSnJ+barUtqKHmazT84A5iv4G3pccjo2JiOMKppcGTJIm7iFc2FSaJ46QfTtKdwxQT6YxIgWPF6uMKkJGctNEJqICQyK6gl1XfX5rs9uEeUio+Hzn+JiSRIjI+ey9Q54LaIX7eBVrzPIa3m8ZEyc2B4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=X6GXA3bj; arc=none smtp.client-ip=198.175.65.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="X6GXA3bj"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1741214656; x=1772750656;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=sIWPNe1sDkCNXWyhYlSpIXOLZLQV67vXvBhITwEc69I=;
  b=X6GXA3bjTfMa0K/LJupHySeCgTRULp9eTlEXoAPX6Jl+jBQ4MtZvtC7p
   PI2tKMFNLGLev6ic3S2b0onyKL/hWomuA6NU67pcmWPvpOite8a/oJotJ
   O38VpsKvxU498SH8Gf2S1YzANnqtyK/gq+2Hrb0GSdOSRxcAgqRsyX95P
   bFlplCh5ksFX5ytJ8APRoZtEsV4frlsWbgXko7PRi+PesMqQ+pFUtiUsc
   qXqX0JWySQWizAl/X+Fo9RIsfyapcf5XNEcql2i2GPhHHSZc8pGUtr44b
   ToOaRCyvmUxPjaoBhMeoNemIcOBXfTFnrZiycnpQgfEzCWWOy2N7c5ycH
   g==;
X-CSE-ConnectionGUID: HBDUAkbcSCKIFrKKMNPLqg==
X-CSE-MsgGUID: J2rziOB7TVaRuwnSVm0QKw==
X-IronPort-AV: E=McAfee;i="6700,10204,11363"; a="59610183"
X-IronPort-AV: E=Sophos;i="6.14,224,1736841600"; 
   d="scan'208";a="59610183"
Received: from orviesa007.jf.intel.com ([10.64.159.147])
  by orvoesa102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Mar 2025 14:44:15 -0800
X-CSE-ConnectionGUID: KlF0OOMuQtS4DJ7Z5kCdXQ==
X-CSE-MsgGUID: xuJLBWHUTHWxHqd+neYSwg==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.12,224,1728975600"; 
   d="scan'208";a="119330537"
Received: from dnelso2-mobl.amr.corp.intel.com (HELO [10.125.109.222]) ([10.125.109.222])
  by orviesa007-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Mar 2025 14:44:14 -0800
Message-ID: <04e77063-5676-4435-854c-9488075114c5@intel.com>
Date: Wed, 5 Mar 2025 15:44:13 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
To: Gregory Price <gourry@gourry.net>, lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 12069
Lines: 330



On 3/5/25 3:20 PM, Gregory Price wrote:
> --------------------
> Part 0: ACPI Tables.
> --------------------
> I considered publishing this section first, or at least under
> "Platform", but I've found this information largely useful in
> debugging interleave configurations and tiering mechanisms -
> which are higher level concepts.

Hi Gregory,
Thanks for detailing all this information. It has been a really good read.

Do you intend to also add CDAT information and device performance data calculation related to that? The SRAT/HMAT info only covers CXL memory that are already setup by the BIOS as system memory. Otherwise it only contains performance data for the Generic Port and not the rest of the path to the endpoint.

DJ  

> 
> Much of the information in this section is most relevant to
> Interleave (yet to be published Section 4).
> 
> I promise not to simply regurgitate the entire ACPI specification
> and limit this to necessary commentary to describe how these tables
> relate to actual Linux resources (like numa nodes and tiers).
> 
> At the very least, if you find yourself trying to figure out why
> your CXL system isn't producing NUMA nodes, memory tiers, root
> decoders, memory regions - etc - I would check these tables
> first for aberrations.  Almost all my personal strife has been
> associated with ACPI table misconfiguration.
> 
> 
> ACPI tables can be inspected with the `acpica-tools` package.
>    mkdir acpi_tables && cd acpi_tables
>    acpidump -b
>    iasl -d *
>    -- inpect the *.dsl files
> 
> ====
> CEDT
> ====
> The CXL Early Discovery Table is generated by BIOS to describe
> the CXL devices present and configured (to some extent) at boot
> by the BIOS.
> 
> # CHBS
> The CXL Host Bridge Structure describes CXL host bridges.  Other
> than describing device register information, it reports the specific
> host bridge UID for this host bridge.  These host bridge ID's will
> be referenced in other tables.
> 
> Debug hint: check that the host bridge IDs between tables are
>             consistent - stuff breaks oddly if they're not!
> 
> ```
>          Subtable Type : 00 [CXL Host Bridge Structure]
>               Reserved : 00
>                 Length : 0020
> Associated host bridge : 00000007    <- Host bridge _UID
>  Specification version : 00000001
>               Reserved : 00000000
>          Register base : 0000010370400000
>        Register length : 0000000000010000
> ```
> 
> # CFMWS
> The CXL Fixed Memory Window structure describes a memory region
> associated with one or more CXL host bridges (as described by the
> CHBS).  It additionally describes any inter-host-bridge interleave
> configuration that may have been programmed by BIOS. (Section 4)
> 
> ```
>            Subtable Type : 01 [CXL Fixed Memory Window Structure]
>                 Reserved : 00
>                   Length : 002C
>                 Reserved : 00000000
>      Window base address : 000000C050000000   <- Memory Region
>              Window size : 0000003CA0000000
> Interleave Members (2^n) : 01               <- Interleave configuration
>    Interleave Arithmetic : 00
>                 Reserved : 0000
>              Granularity : 00000000
>             Restrictions : 0006
>                    QtgId : 0001
>             First Target : 00000007         <- Host Bridge _UID
>              Next Target : 00000006         <- Host Bridge _UID
> ```
> 
> INTER-host-bridge interleave (multiple devices on one host bridge) is
> NOT reported in this structure, and is solely defined via CXL device
> decoder programming (host bridge and endpoint decoders).  This will be
> described later (Section 4 - Interleave)
> 
> 
> ====
> SRAT
> ====
> The System/Static Resource Affinity Table describes resource (CPU,
> Memory) affinity to "Proximity Domains". This table is technically
> optional, but for performance information (see "HMAT") to be enumerated
> by linux it must be present.
> 
> 
> # Proximity Domain
> A proximity domain is ROUGHLY equivalent to "NUMA Node" - though a
> 1-to-1 mapping is not guaranteed.  There are scenarios where "Proximity
> Domain 4" may map to "NUMA Node 3", for example.  (See "NUMA Node Creation")
> 
> # Memory Affinity
> Generally speaking, if a host does any amount of CXL fabric (decoder)
> programming in BIOS - an SRAT entry for that memory needs to be present.
> 
> ```
>         Subtable Type : 01 [Memory Affinity]
>                Length : 28
>      Proximity Domain : 00000001          <- NUMA Node 1
>             Reserved1 : 0000
>          Base Address : 000000C050000000  <- Physical Memory Region
>        Address Length : 0000003CA0000000
>             Reserved2 : 00000000
> Flags (decoded below) : 0000000B
>              Enabled : 1
>        Hot Pluggable : 1
>         Non-Volatile : 0
> ```
> 
> # Generic Initiator / Port
> In the scenario where CXL devices are not present or configured by
> BIOS, we may still want to generate proximity domain configurations
> for those devices.   The Generic Initiator interfaces are intended to
> fill this gap, so that performance information can still be utilized
> when the devices become available at runtime.
> 
> I won't cover the details here, for now, but I will link to the
> proosal from Dan Williams and Jonathan Cameron if you would like
> more information.
> https://lore.kernel.org/all/e1a52da9aec90766da5de51b1b839fd95d63a5af.camel@intel.com/
> 
> ====
> HMAT
> ====
> The Heterogeneous Memory Attributes Table contains information such as
> cache attributes and bandwidth and latency details for memory proximity
> domains.  For the purpose of this document, we will only discuss the
> SSLIB entry.
> 
> # SLLBI
> The System Locality Latency and Bandwidth Information records latency
> and bandwidth information for proximity domains. This table is used by
> Linux to configure interleave weights and memory tiers.
> 
> ```
> Heavily truncated for brevity
>               Structure Type : 0001 [SLLBI]
>                    Data Type : 00         <- Latency
> Target Proximity Domain List : 00000000
> Target Proximity Domain List : 00000001
>                        Entry : 0080       <- DRAM LTC
>                        Entry : 0100       <- CXL LTC
> 
>               Structure Type : 0001 [SLLBI]
>                    Data Type : 03         <- Bandwidth
> Target Proximity Domain List : 00000000
> Target Proximity Domain List : 00000001
>                        Entry : 1200       <- DRAM BW
>                        Entry : 0200       <- CXL BW
> ```
> 
> 
> ---------------------------------
> Part 00: Linux Resource Creation.
> ---------------------------------
> 
> ==================
> NUMA node creation
> ===================
> NUMA nodes are *NOT* hot-pluggable.  All *POSSIBLE* NUMA nodes are
> identified at `__init` time, more specifically during `mm_init`.
> 
> What this means is that the CEDT and SRAT must contain sufficient
> `proximity domain` information for linux to identify how many NUMA
> nodes are required (and what memory regions to associate with them).
> 
> The relevant code exists in: linux/drivers/acpi/numa/srat.c
> ```
> static int __init
> acpi_parse_memory_affinity(union acpi_subtable_headers *header,
>                            const unsigned long table_end)
> {
> ... heavily truncated for brevity
>         pxm = ma->proximity_domain;
>         node = acpi_map_pxm_to_node(pxm);
>         if (numa_add_memblk(node, start, end) < 0)
>             ....
>         node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
> }
> 
> static int __init acpi_parse_cfmws(union acpi_subtable_headers *header,
>                                    void *arg, const unsigned long table_end)
> {
> ... heavily truncated for brevity
>         /*
>          * The SRAT may have already described NUMA details for all,
>          * or a portion of, this CFMWS HPA range. Extend the memblks
>          * found for any portion of the window to cover the entire
>          * window.
>          */
>         if (!numa_fill_memblks(start, end))
>                 return 0;
> 
>         /* No SRAT description. Create a new node. */
>         node = acpi_map_pxm_to_node(*fake_pxm);
>         if (numa_add_memblk(node, start, end) < 0)
> 	        ....
>         node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
> }
> 
> int __init acpi_numa_init(void)
> {
> ...
>     if (!acpi_table_parse(ACPI_SIG_SRAT, acpi_parse_srat)) {
>         cnt = acpi_table_parse_srat(ACPI_SRAT_TYPE_MEMORY_AFFINITY,
>                                     acpi_parse_memory_affinity, 0);
>     }
>     /* fake_pxm is the next unused PXM value after SRAT parsing */
>     acpi_table_parse_cedt(ACPI_CEDT_TYPE_CFMWS, acpi_parse_cfmws,
>                           &fake_pxm);
> 
> ```
> 
> Basically, the heuristic is as follows:
> 1) Add one NUMA node per Proximity Domain described in SRAT
> 2) If the SRAT describes all memory described by all CFMWS
>    - do not create nodes for CFMWS
> 3) If SRAT does not describe all memory described by CFMWS
>    - create a node for that CFMWS
> 
> Generally speaking, you will see one NUMA node per Host bridge, unless
> inter-host-bridge interleave is in use (see Section 4 - Interleave).
> 
> 
> ============
> Memory Tiers
> ============
> The `abstract distance` of a node dictates what tier it lands in (and
> therefore, what tiers are created).  This is calculated based on the
> following heuristic, using HMAT data:
> 
> ```
> int mt_perf_to_adistance(struct access_coordinate *perf, int *adist)
> {
>  ...
>     /*
>      * The abstract distance of a memory node is in direct proportion to
>      * its memory latency (read + write) and inversely proportional to its
>      * memory bandwidth (read + write).  The abstract distance, memory
>      * latency, and memory bandwidth of the default DRAM nodes are used as
>      * the base.
>      */
>     *adist = MEMTIER_ADISTANCE_DRAM *
>         (perf->read_latency + perf->write_latency) /
>         (default_dram_perf.read_latency + default_dram_perf.write_latency) *
>         (default_dram_perf.read_bandwidth + default_dram_perf.write_bandwidth) /
>         (perf->read_bandwidth + perf->write_bandwidth);
>     return 0;
> }
> ```
> 
> Debugging hint: If you have DRAM and CXL memory in separate numa nodes
>                 but only find 1 memory tier, validate the HMAT!
> 
> 
> ============================
> Memory Tier Demotion Targets
> ============================
> When `demotion` is enabled (see Section 5 - allocation), the reclaim
> system may opportunistically demote a page from one memory tier to
> another.  The selection of a `demotion target` is partially based on
> Abstract Distance and Performance Data.
> 
> ```
> An example of demotion targets from memory-tiers.c
> /* Example 1:
>  *
>  * Node 0 & 1 are CPU + DRAM nodes, node 2 & 3 are PMEM nodes.
>  *
>  * node distances:
>  * node   0    1    2    3
>  *    0  10   20   30   40
>  *    1  20   10   40   30
>  *    2  30   40   10   40
>  *    3  40   30   40   10
>  *
>  * memory_tiers0 = 0-1
>  * memory_tiers1 = 2-3
>  *
>  * node_demotion[0].preferred = 2
>  * node_demotion[1].preferred = 3
>  * node_demotion[2].preferred = <empty>
>  * node_demotion[3].preferred = <empty>
>  */
> ```
> 
> =============================
> Mempolicy Weighted Interleave
> =============================
> The `weighted interleave` functionality of `mempolicy` utilizes weights
> to distribute memory across NUMA nodes according to some set weight.
> There is a proposal to auto-configure these weights based on HMAT data.
> 
> https://lore.kernel.org/linux-mm/20250305200506.2529583-1-joshua.hahnjy@gmail.com/T/#u
> 
> See Section 4 - Interleave, for more information on weighted interleave.
> 
> 
> 
> --------------
> Build Options.
> --------------
> We can add these build configurations to our complexity picture.
> 
> CONFIG_NUMA        - req for ACPI numa, mempolicy, and memory tiers
> CONFIG_ACPI_NUMA   -- enables srat and cedt parsing
> CONFIG_ACPI_HMAT   -- enables hmat parsing
> 
> 
> ~Gregory
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f172.google.com (mail-qk1-f172.google.com [209.85.222.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 76C671E7C20
	for <linux-cxl@vger.kernel.org>; Wed,  5 Mar 2025 23:34:38 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741217680; cv=none; b=s6zZwRbKYKwXW0fae7vXaQJBfZWtUfu5sF7SK+7PBCP7F7/99giVdIqk6B/3gLTuvt9W7k/l/mqcBwdV3rPILVm11RghbvT133grSuFUJj3UnE0zwxUkXmi+2Qhyp3FKcOMkVbMEN4R5xeDrQJp6IBQM+KVmS0MaVg9kNmvPNag=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741217680; c=relaxed/simple;
	bh=D0G3orN0FV57c/IEBWFnVWoFV7eaqnMV66Yy9wrY8tE=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=ZzwHgvtVeybYEyDXumMnDVEnBi+kNJuUSdWCArRuUTsy6LUKJoJvvFc5H003/vdwr6WHgP9EZ68NjdKjlNPN3eNLkA9Hl9L0JO9FKdmSJVkWbmiZiGwRCD9whC+1Y9+HUaOGTscOgbzIqdfsOv3pD3ZVAYtPyhTxWerNOYV5RtI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=EOtUQ7G5; arc=none smtp.client-ip=209.85.222.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="EOtUQ7G5"
Received: by mail-qk1-f172.google.com with SMTP id af79cd13be357-7c3b63dfebfso5014785a.3
        for <linux-cxl@vger.kernel.org>; Wed, 05 Mar 2025 15:34:38 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741217677; x=1741822477; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=l3To9d5/aMTyINoeQC3tRz8KDnflLypArjPix9jjnpE=;
        b=EOtUQ7G5VdaEjAVgErsms7+1vND7Ggf132L57q5yyIR7/YJP+rZkFOgSncU+bJv5If
         A40gDYrAEgdcMcXvdPEm4sCKanivfe5yHgqCScADJ70WQItUP7FDQuQ4WDBN1IqO3bQy
         myrAAl1rFroFW6E2yPH4Aw2JRxEVaXtmyvj8G5VByy6OA+cTnqRhZgzZDrA2isU6ZeHO
         2cTZZ62rw6RlpweqG9W97D5lRfy4AeZljSYyZypqGR2TIjl6/PNJgaZDvnXsN5qCdx4s
         bT0de/x4IGiwI3oEVx9kL+/LoQLdFie62haqK6DUADnJy7fKR/1p5dm/HpFcWJ+BA5Vi
         BaYw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741217677; x=1741822477;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=l3To9d5/aMTyINoeQC3tRz8KDnflLypArjPix9jjnpE=;
        b=osL394YenoWO5K2Ni+HvkskkMd/eP3HTw81HzC+ft+ZnDyDNsjddFwsI0DejNKd6EE
         V7nwY+WzADJgG4/1f81iW+NGvlElqYy+qpCjts/MOnO4rAjmhIyTECGkUX+mw2Iw1vhw
         htbyxSlmpJAEHkBX2AKEMVc1oANNxx2q0RbFGKCDaFQPLbBDGiBVPDfHf0UMPAAKICj5
         409qQiv/UUYc3ii9TV/CiCcjBPoKgnnbGGe2C/P0NuP2GmJPQBdFZmP8x3wLwUsH/nn2
         cM2Xs1AwZ9Tct8RpzT3UCHEThgtqPAMSOy4RTSJ4+ELrMY8B5gdZOBhe8KZ/+fqNg5kH
         wf3w==
X-Forwarded-Encrypted: i=1; AJvYcCVciB4w8k6pqg1KTN2MeefgwdEd0wRNIfeZ+EDJoz6AT9Ol03V3ei9XEDBt5vIv9+0GIZrhRYjiOi4=@vger.kernel.org
X-Gm-Message-State: AOJu0YyK/+Kl58qX9jKo75Jz0RYJJ0xv01s8giXWcs56sWQ+FV1YwGRS
	hpWwUnHGuJOGShgkIaKkzMP5GQHgrJ9hxVLZyhLhuoF1/oNdSIYa8myZBmS4DYwK9KebPdgYnkC
	Y
X-Gm-Gg: ASbGncu87WPGE/YqvZ42dnMJysvDQxwhqblMxVEPWi6iY6SQ7w73AnXc3zktaRXECTt
	cka5PHRfJynQg4aUrnieL2JmC9ekLA3CVVHCIqQGXqJa+eWMyS26tKDMp8FvOwXdcvruPTNg/xL
	KgKsLGhZ6AcOCfjS1XP5CBD6o1mO3D7wLVGqaLgPkeFXS8p1yWTQumAHRPqmQuMEGkLEA08D6yr
	dPCPcM+ndpwYyNhAtNB/39gxbpHqOoTcVX4ZiKgoFn4OqPF0EGQR9EwM+gSrVNca6FAfMW+Wevi
	Mk35/4Oz9RgxfUONg9/HJ61VYz0NfanGVJvvwwAMs3+hfNnlvoaechU4NOSJv0C99DY8eOjfbBs
	T6rkXLJR+HdyoOTElyKMra4hUj5o=
X-Google-Smtp-Source: AGHT+IGa5Xbbltz240JyaJqJHDwVfX/4+rVmQ/jVLJ23LieI4+LZ3OVgysoT1v/qozkzc4U2h+acdQ==
X-Received: by 2002:a05:620a:688a:b0:7c3:cc36:b5a7 with SMTP id af79cd13be357-7c3d8e7a2acmr842523585a.27.1741217677301;
        Wed, 05 Mar 2025 15:34:37 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3e5389d57sm8108885a.64.2025.03.05.15.34.36
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 15:34:36 -0800 (PST)
Date: Wed, 5 Mar 2025 18:34:34 -0500
From: Gregory Price <gourry@gourry.net>
To: Dave Jiang <dave.jiang@intel.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8jfigfHaTVR4bLj@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <04e77063-5676-4435-854c-9488075114c5@intel.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <04e77063-5676-4435-854c-9488075114c5@intel.com>
Status: O
Content-Length: 1468
Lines: 31

On Wed, Mar 05, 2025 at 03:44:13PM -0700, Dave Jiang wrote:
> 
> 
> On 3/5/25 3:20 PM, Gregory Price wrote:
> > --------------------
> > Part 0: ACPI Tables.
> > --------------------
> > I considered publishing this section first, or at least under
> > "Platform", but I've found this information largely useful in
> > debugging interleave configurations and tiering mechanisms -
> > which are higher level concepts.
> 
> Hi Gregory,
> Thanks for detailing all this information. It has been a really good read.
> 
> Do you intend to also add CDAT information and device performance data calculation related to that? The SRAT/HMAT info only covers CXL memory that are already setup by the BIOS as system memory. Otherwise it only contains performance data for the Generic Port and not the rest of the path to the endpoint.
>

Probably CDAT should land in here as well, though in the context of
simple volatile memory devices it seemed a bit overkill to include it.

I also don't have a ton of exposure to the GenPort flow of operations,
so i didn't want to delay what I do have here.  If you have a
recommended addition - I do intend to go through and edit/reformat most
of this series after LSF/MM into a friendlier format of documentation.

I wanted to avoid dropping a 50 page writeup all at once with hopes of
getting feedback on each chunk to correct inaccuracies (see hotplug). So
I'm certainly open to adding whatever folks think is missing/important.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.11])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 09EE9207675;
	Wed,  5 Mar 2025 23:41:08 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.11
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741218071; cv=none; b=B8PVnTQF6MzZaiMvmaK8nAbCqgt8jB9pUwkiet6QBkMyCchjfw0EvMDW/jSToI9lhD/Gmsm8i/O5dlmb2/s1QyngeCaADGN30Gs7C7EcsOS8dAebqK1Y3MXHt4cTpcbnI6mcpNhN/t/Bjn6ewg+idM4dzQWmD2yq2JGMibJcagI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741218071; c=relaxed/simple;
	bh=LD8ZGvL40HLoK65jjCMTAOR0GJiJLVbwO6x1787IsaA=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=H3Dnja6RJG7rVu2JVLUnUlpJRcgHaFo4hVx9xThDJ84zCANi9U7dIGBtGSWHKjF+TGP/fpezoWMBMDpasJM6jiqVmVVHMxCEaDqozc2QE5opiMNTePk8Obql7B0nd/GmJOdSQgvpoOUa0LZB3iZhOVleKNSwjVdw7q4k2ANmU1w=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=VkgHLaC+; arc=none smtp.client-ip=198.175.65.11
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="VkgHLaC+"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1741218069; x=1772754069;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=LD8ZGvL40HLoK65jjCMTAOR0GJiJLVbwO6x1787IsaA=;
  b=VkgHLaC+eJonxu+c6q0GzWnLWgZVKk09WcDSdHzR8b7pPhrqHclk60Kr
   QV3aTNO2gsqYE5XIKbdRosnt3NXOGdDa1zHlWRiKt7AorXonyWPyX7UZ3
   EFoAfQvoQL3FChmgwwCGaaiXM/x3OKT0ZrfGQdM+7dJFkCQf0V3KFneKx
   Tj7kxylvkV1Cch7jQjthbxS4IUtTvAUr/uaCcnhmVqSECW8GQm1HNemMT
   9UqwwdBtcT/cuxGd82n4ZfwgM4RZ3WjCVSvzpf+v2vlR2aRWQalz6Fc4g
   zxXFHGaIMl62PIrf/JDcvNtlW7Hdl/wzqZI8Pfb2sohqSaajD/d99zE+4
   A==;
X-CSE-ConnectionGUID: 0FQmIRIoQs259Zd9GKSzYQ==
X-CSE-MsgGUID: AAFMjed3T0KiErqz6WuzWw==
X-IronPort-AV: E=McAfee;i="6700,10204,11363"; a="52416423"
X-IronPort-AV: E=Sophos;i="6.14,224,1736841600"; 
   d="scan'208";a="52416423"
Received: from orviesa008.jf.intel.com ([10.64.159.148])
  by orvoesa103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Mar 2025 15:41:08 -0800
X-CSE-ConnectionGUID: YyV9Ox0tQNmHk/uZ97MIBw==
X-CSE-MsgGUID: r0kd4sCOQPmImpuxN7RFLw==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.12,224,1728975600"; 
   d="scan'208";a="119757725"
Received: from dnelso2-mobl.amr.corp.intel.com (HELO [10.125.109.222]) ([10.125.109.222])
  by orviesa008-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Mar 2025 15:41:09 -0800
Message-ID: <d34016a1-e834-417c-ba2a-028e4e0e9573@intel.com>
Date: Wed, 5 Mar 2025 16:41:05 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
To: Gregory Price <gourry@gourry.net>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
 linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <04e77063-5676-4435-854c-9488075114c5@intel.com>
 <Z8jfigfHaTVR4bLj@gourry-fedora-PF4VCD3F>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <Z8jfigfHaTVR4bLj@gourry-fedora-PF4VCD3F>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 1667
Lines: 40



On 3/5/25 4:34 PM, Gregory Price wrote:
> On Wed, Mar 05, 2025 at 03:44:13PM -0700, Dave Jiang wrote:
>>
>>
>> On 3/5/25 3:20 PM, Gregory Price wrote:
>>> --------------------
>>> Part 0: ACPI Tables.
>>> --------------------
>>> I considered publishing this section first, or at least under
>>> "Platform", but I've found this information largely useful in
>>> debugging interleave configurations and tiering mechanisms -
>>> which are higher level concepts.
>>
>> Hi Gregory,
>> Thanks for detailing all this information. It has been a really good read.
>>
>> Do you intend to also add CDAT information and device performance data calculation related to that? The SRAT/HMAT info only covers CXL memory that are already setup by the BIOS as system memory. Otherwise it only contains performance data for the Generic Port and not the rest of the path to the endpoint.
>>
> 
> Probably CDAT should land in here as well, though in the context of
> simple volatile memory devices it seemed a bit overkill to include it.
> 
> I also don't have a ton of exposure to the GenPort flow of operations,
> so i didn't want to delay what I do have here.  If you have a
> recommended addition - I do intend to go through and edit/reformat most
> of this series after LSF/MM into a friendlier format of documentation.

I can help write it if there's no great urgency. I'll try to find some time creating a draft and send it your way.

DJ

> 
> I wanted to avoid dropping a 50 page writeup all at once with hopes of
> getting feedback on each chunk to correct inaccuracies (see hotplug). So
> I'm certainly open to adding whatever folks think is missing/important.
> 
> ~Gregory


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f182.google.com (mail-qk1-f182.google.com [209.85.222.182])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9BF46367
	for <linux-cxl@vger.kernel.org>; Thu,  6 Mar 2025 00:09:07 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.182
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741219749; cv=none; b=l6Yk+gqhX42lWxZjF3LJ3bz7NLaPWAszILxoBDF06M8F/VQGL6ogm88Kj51d+JqXgXV0qpuw0PAf2b9f5UZ39kNjBoo3tflwl0FZrVDVW1no3uOza9k59uoDcJcs/gkz+ddJZkIg6i2c0a/9xtrssOoxEsiA2YXTvwQTwxY8Lrk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741219749; c=relaxed/simple;
	bh=/PL/yCTjIRpzVCj9p4+Qh3kC17MW74dAnh1pilULjIY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=goWO7JuQkTgT99wOEUM1o1by9PB48RoEk691gD56Dw/fuIP68Cj78umagNcEiP7WjWOXtv7rUWkbL9+D6uB/g7SgYXq7nG5FdJ/zCKCQUj3BKUchG9emZOnXzZgrWIymfBR+SfuIXr3pWdbDzKkUbBDZDUNw/FZlYPKjeswIHMc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=kmyXbeke; arc=none smtp.client-ip=209.85.222.182
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="kmyXbeke"
Received: by mail-qk1-f182.google.com with SMTP id af79cd13be357-7be6fdeee35so13201385a.1
        for <linux-cxl@vger.kernel.org>; Wed, 05 Mar 2025 16:09:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741219746; x=1741824546; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=e7n30QZh5MqHhg61ngoUpNHMLZG6JDNKypDXU8n1zfY=;
        b=kmyXbekeOYkv2JlANgMiGQmghxn5r31kP3BnYzrog1g6ADPZhsPtIULpfEQfZwzBg1
         9h3tdvqViS0UKv8IOn+EB8sF3Plag1qARXHOFFAce55ZOTtDe0h9AEHbMC8jfGK1+0Fa
         Qq63vk0Y0kH70PmSlRwCrgYc7IMfy0/gqozN6W6Gos9srdC4M7QfkhOuJG64BLqi5CJH
         OW6Nqukg03pZrJfWq01Kl8JsMVai7aCdhSPIt4h+PSIbe4XvpAZFZvt+2f+2TgKkOnid
         y/Yi7ZwYc5OSQVQkprIFzkg8jO6hdNkfKBesGAXE/RWu5B+65Flw/pCP6VtGyi0BZKZM
         LvBg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741219746; x=1741824546;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=e7n30QZh5MqHhg61ngoUpNHMLZG6JDNKypDXU8n1zfY=;
        b=mUO0xW2puY9PJz+MAuo/CCXEcXyVIAX7u0eyLXD5N0r+4TvcyHvVk+CzYdzV6mHZHI
         /LdZ16gdWu90DalOPJc6qdlKr6AOzIYYDwX/mZMJKRaI62IN967hdj77gTE2lcv/9gtG
         1JO3cHm4ist4BJE4iT/IB9NH1DHqkcQ6IumTyTxFhuurQrir7APyhxseHyzmKBaNZnCo
         pZyfAIRaIX8+h0bVUNr1Basytq5yaK5u1hKPKi/b6PxAr+im2kb/T1qahu5+C9G0p/qb
         HYHB9n8uL6fcO4CK4bFTyTCpTUpE24aQguHlZACvl9tvz3+m4O0vbPuUC2T0jkLwopQm
         sYag==
X-Forwarded-Encrypted: i=1; AJvYcCURteVfk4yd4e5Q1M1qbFmdazdx0B2d1VV5jM5saB5Ky4sbJv3MZZWUo/1XoxFQWes1B2WKTgW7YH8=@vger.kernel.org
X-Gm-Message-State: AOJu0YxqBiv8r6CvwP+g0yP2sR09YXAlVQ83kG2mKgeV9jlQ3meJxfql
	2SrJ6mosKuGQzVu9pLH0Ayzk8/DUx1XScyvXBwf9dzqwYykgo00BDGyuolZ6Sus=
X-Gm-Gg: ASbGnctZ1O2TMjgVTBmMbTNBUxyQlpbnpBXesLZzummvZBDrvD/eUmQU8T+VTFBNo6U
	1kVJpjgJuT710kYPO03utQnGjrpqoy+InC7CoT/YTjTDieaKkxJbqRon/5Ua/eLLnfmEhMD6jqo
	wnLscgUv0LmyjGPt6byiSidrjdc5Ivyv/+2OSw0bxE87ZogoQiES0REcGxXW9mJhkZc6uY26Q/4
	xgLbVrdYCs127gaNUSlqV0PWt+epbnijtSST3lbLwKsTjlXPCDDighXM/CULCWaS89yL3j5OYKh
	4yxY1KU5jwswNj2nwwi5dQLni0nnhHt9W5dMO1CqmYHBJW48NcTVMK7xc0v77veSJ7JWZ7fPQGe
	0yGMwlHVDJeS6arco5KnOHGvJxMs=
X-Google-Smtp-Source: AGHT+IFFxLUQ+KkgPN4iyQlqlwI1Rw/OwtnKQnaDZ4DimWoqed71Ad0cB0V3qblwvHmUbeOh65lMNg==
X-Received: by 2002:a05:620a:2841:b0:7c3:cde7:a685 with SMTP id af79cd13be357-7c3d8de96d9mr870869585a.13.1741219746455;
        Wed, 05 Mar 2025 16:09:06 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3e534e915sm11780685a.46.2025.03.05.16.09.03
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 16:09:05 -0800 (PST)
Date: Wed, 5 Mar 2025 19:09:02 -0500
From: Gregory Price <gourry@gourry.net>
To: Dave Jiang <dave.jiang@intel.com>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8jnnn7OLa6rwkG1@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <04e77063-5676-4435-854c-9488075114c5@intel.com>
 <Z8jfigfHaTVR4bLj@gourry-fedora-PF4VCD3F>
 <d34016a1-e834-417c-ba2a-028e4e0e9573@intel.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <d34016a1-e834-417c-ba2a-028e4e0e9573@intel.com>
Status: O
Content-Length: 879
Lines: 20

On Wed, Mar 05, 2025 at 04:41:05PM -0700, Dave Jiang wrote:
> I can help write it if there's no great urgency. I'll try to find some time creating a draft and send it your way.
>

No major urgency, this is a best-attempt at background info before LSF.

My goal at LSF is to simply talk about some of the rough edges and
misunderstandings and subtleties associated with "bringing up CXL
memory in XYZ ways". (e.g. what set of constraints you're actually
agreeing to when you bring up CXL in ZONE_MOVABLE or ZONE_NORMAL).

On the back half, I imagine re-working this whole thing.  The structure
here is getting a bit unwieldly - which is to be expected, lots of
moving parts from boot to bash :P

Maybe we can look at converting this into a set of driver docs or
something - though i've been careful not to aggressively define
driver-internal operation since it's fluid.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from zg8tmja5ljk3lje4ms43mwaa.icoremail.net (zg8tmja5ljk3lje4ms43mwaa.icoremail.net [209.97.181.73])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 8C90F17E473;
	Thu,  6 Mar 2025 01:38:26 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.97.181.73
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741225119; cv=none; b=lwlWqpNq+z5SLEpImLCMF4z30Xofao9gAnvg9uCnjjeTw7pPCKWhP38f6qSqL2NBQkmcdirjE6e/nqjWilgdncawDU26bKvJwPru97xlCPIQUEhpb/YmvRxUpDq9PdvWalqIoOPN8o1ZrXCUbXzfAlpq8CY1LT/l1wguff52+VY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741225119; c=relaxed/simple;
	bh=n37GYU1TrA94POxtjoQVj6BwqVafhkocGlcUk6vjz1U=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=FWq923YOB7Yxx1iftrz7zf/PE+nmzKskJpBcU46/FY2pk/jvdHT6fNIKvl36xL9zCrMsC2pUZvoKsM1tWlqsOn+uUVhdCw8T1QOdNrdQgB1XQ2vpWDAFQ2Ood6ilvTRPFRPGU9T5JoBfxs3QSC9AtVNnsBfH+rxaOlDv6AoCywU=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn; spf=pass smtp.mailfrom=phytium.com.cn; arc=none smtp.client-ip=209.97.181.73
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=phytium.com.cn
Received: from prodtpl.icoremail.net (unknown [10.12.1.20])
	by hzbj-icmmx-7 (Coremail) with SMTP id AQAAfwA3vS2L_MhnlAzuBg--.29477S2;
	Thu, 06 Mar 2025 09:38:19 +0800 (CST)
Received: from localhost (unknown [123.150.8.50])
	by mail (Coremail) with SMTP id AQAAfwBHS4d9_MhnaOY7AA--.2066S2;
	Thu, 06 Mar 2025 09:38:15 +0800 (CST)
Date: Thu, 6 Mar 2025 09:37:49 +0800
From: Yuquan Wang <wangyuquan1236@phytium.com.cn>
To: Gregory Price <gourry@gourry.net>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8j8bZ5TS+gDV8+M@phytium.com.cn>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
X-CM-TRANSID: AQAAfwBHS4d9_MhnaOY7AA--.2066S2
X-CM-SenderInfo: 5zdqw5pxtxt0arstlqxsk13x1xpou0fpof0/1tbiAQABAWfIrdcBhQAAsQ
Authentication-Results: hzbj-icmmx-7; spf=neutral smtp.mail=wangyuquan
	1236@phytium.com.cn;
X-Coremail-Antispam: 1Uk129KBjvJXoW3Ww1UWr1UZryxGFW3Kr48WFg_yoWfJF4fpF
	s3JrZ7Krs3GrWxCw1xtay09w1fJa4xCayUJryxGryxCws09ryjvr43K3W8ZFWDGryUCF15
	Xa17tF1jvay8AaDanT9S1TB71UUUUU7qnTZGkaVYY2UrUUUUj1kv1TuYvTs0mT0YCTnIWj
	DUYxn0WfASr-VFAU7a7-sFnT9fnUUIcSsGvfJ3UbIYCTnIWIevJa73UjIFyTuYvj4RJUUU
	UUUUU
Status: O
Content-Length: 9346
Lines: 264

On Wed, Mar 05, 2025 at 05:20:52PM -0500, Gregory Price wrote:
> ====
> SRAT
> ====
> The System/Static Resource Affinity Table describes resource (CPU,
> Memory) affinity to "Proximity Domains". This table is technically
> optional, but for performance information (see "HMAT") to be enumerated
> by linux it must be present.
> 
> 
> # Proximity Domain
> A proximity domain is ROUGHLY equivalent to "NUMA Node" - though a
> 1-to-1 mapping is not guaranteed.  There are scenarios where "Proximity
> Domain 4" may map to "NUMA Node 3", for example.  (See "NUMA Node Creation")
> 
> # Memory Affinity
> Generally speaking, if a host does any amount of CXL fabric (decoder)
> programming in BIOS - an SRAT entry for that memory needs to be present.
> 
> ```
>         Subtable Type : 01 [Memory Affinity]
>                Length : 28
>      Proximity Domain : 00000001          <- NUMA Node 1
>             Reserved1 : 0000
>          Base Address : 000000C050000000  <- Physical Memory Region
>        Address Length : 0000003CA0000000
>             Reserved2 : 00000000
> Flags (decoded below) : 0000000B
>              Enabled : 1
>        Hot Pluggable : 1
>         Non-Volatile : 0
> ```
> 
> # Generic Initiator / Port
> In the scenario where CXL devices are not present or configured by
> BIOS, we may still want to generate proximity domain configurations
> for those devices.   The Generic Initiator interfaces are intended to
> fill this gap, so that performance information can still be utilized
> when the devices become available at runtime.
> 
> I won't cover the details here, for now, but I will link to the
> proosal from Dan Williams and Jonathan Cameron if you would like
> more information.
> https://lore.kernel.org/all/e1a52da9aec90766da5de51b1b839fd95d63a5af.camel@intel.com/
> 
> ====
> HMAT
> ====
> The Heterogeneous Memory Attributes Table contains information such as
> cache attributes and bandwidth and latency details for memory proximity
> domains.  For the purpose of this document, we will only discuss the
> SSLIB entry.
> 
> # SLLBI
> The System Locality Latency and Bandwidth Information records latency
> and bandwidth information for proximity domains. This table is used by
> Linux to configure interleave weights and memory tiers.
> 
> ```
> Heavily truncated for brevity
>               Structure Type : 0001 [SLLBI]
>                    Data Type : 00         <- Latency
> Target Proximity Domain List : 00000000
> Target Proximity Domain List : 00000001
>                        Entry : 0080       <- DRAM LTC
>                        Entry : 0100       <- CXL LTC
> 
>               Structure Type : 0001 [SLLBI]
>                    Data Type : 03         <- Bandwidth
> Target Proximity Domain List : 00000000
> Target Proximity Domain List : 00000001
>                        Entry : 1200       <- DRAM BW
>                        Entry : 0200       <- CXL BW
> ```
> 
> 
> ---------------------------------
> Part 00: Linux Resource Creation.
> ---------------------------------
> 
> ==================
> NUMA node creation
> ===================
> NUMA nodes are *NOT* hot-pluggable.  All *POSSIBLE* NUMA nodes are
> identified at `__init` time, more specifically during `mm_init`.
> 
> What this means is that the CEDT and SRAT must contain sufficient
> `proximity domain` information for linux to identify how many NUMA
> nodes are required (and what memory regions to associate with them).
> 
Hi, Gregory.

Recently, I found a corner case in CXL numa node creation.

Condition:
1) A UMA/NUMA system that SRAT is absence, but it keeps CEDT.CFMWS
2Enable CONFIG_ACPI_NUMA

Results:
1) acpi_numa_init: the fake_pxm will be 0 and send to acpi_parse_cfmws()
2If dynamically create cxl ram region, the cxl memory would be assigned
to node0 rather than a fake new node.

Confusions:
1) Does CXL memory usage require a numa system with SRAT? As you
mentioned in SRAT section: 

"This table is technically optional, but for performance information
to be enumerated by linux it must be present."

Hence, as I understand it, it seems a bug in kernel.

2) If it is a bug, could  we forbid this situation by adding fake_pxm
check and returning error in acpi_numa_init()?

3If not,  maybe we can add some kernel logic to allow create these fake
nodes on a system without SRAT?

Yuquan
> The relevant code exists in: linux/drivers/acpi/numa/srat.c
> ```
> static int __init
> acpi_parse_memory_affinity(union acpi_subtable_headers *header,
>                            const unsigned long table_end)
> {
> ... heavily truncated for brevity
>         pxm = ma->proximity_domain;
>         node = acpi_map_pxm_to_node(pxm);
>         if (numa_add_memblk(node, start, end) < 0)
>             ....
>         node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
> }
> 
> static int __init acpi_parse_cfmws(union acpi_subtable_headers *header,
>                                    void *arg, const unsigned long table_end)
> {
> ... heavily truncated for brevity
>         /*
>          * The SRAT may have already described NUMA details for all,
>          * or a portion of, this CFMWS HPA range. Extend the memblks
>          * found for any portion of the window to cover the entire
>          * window.
>          */
>         if (!numa_fill_memblks(start, end))
>                 return 0;
> 
>         /* No SRAT description. Create a new node. */
>         node = acpi_map_pxm_to_node(*fake_pxm);
>         if (numa_add_memblk(node, start, end) < 0)
> 	        ....
>         node_set(node, numa_nodes_parsed);    <--- mark node N_POSSIBLE
> }
> 
> int __init acpi_numa_init(void)
> {
> ...
>     if (!acpi_table_parse(ACPI_SIG_SRAT, acpi_parse_srat)) {
>         cnt = acpi_table_parse_srat(ACPI_SRAT_TYPE_MEMORY_AFFINITY,
>                                     acpi_parse_memory_affinity, 0);
>     }
>     /* fake_pxm is the next unused PXM value after SRAT parsing */
>     acpi_table_parse_cedt(ACPI_CEDT_TYPE_CFMWS, acpi_parse_cfmws,
>                           &fake_pxm);
> 
> ```
> 
> Basically, the heuristic is as follows:
> 1) Add one NUMA node per Proximity Domain described in SRAT
> 2) If the SRAT describes all memory described by all CFMWS
>    - do not create nodes for CFMWS
> 3) If SRAT does not describe all memory described by CFMWS
>    - create a node for that CFMWS
> 
> Generally speaking, you will see one NUMA node per Host bridge, unless
> inter-host-bridge interleave is in use (see Section 4 - Interleave).
> 
> 
> ============
> Memory Tiers
> ============
> The `abstract distance` of a node dictates what tier it lands in (and
> therefore, what tiers are created).  This is calculated based on the
> following heuristic, using HMAT data:
> 
> ```
> int mt_perf_to_adistance(struct access_coordinate *perf, int *adist)
> {
>  ...
>     /*
>      * The abstract distance of a memory node is in direct proportion to
>      * its memory latency (read + write) and inversely proportional to its
>      * memory bandwidth (read + write).  The abstract distance, memory
>      * latency, and memory bandwidth of the default DRAM nodes are used as
>      * the base.
>      */
>     *adist = MEMTIER_ADISTANCE_DRAM *
>         (perf->read_latency + perf->write_latency) /
>         (default_dram_perf.read_latency + default_dram_perf.write_latency) *
>         (default_dram_perf.read_bandwidth + default_dram_perf.write_bandwidth) /
>         (perf->read_bandwidth + perf->write_bandwidth);
>     return 0;
> }
> ```
> 
> Debugging hint: If you have DRAM and CXL memory in separate numa nodes
>                 but only find 1 memory tier, validate the HMAT!
> 
> 
> ============================
> Memory Tier Demotion Targets
> ============================
> When `demotion` is enabled (see Section 5 - allocation), the reclaim
> system may opportunistically demote a page from one memory tier to
> another.  The selection of a `demotion target` is partially based on
> Abstract Distance and Performance Data.
> 
> ```
> An example of demotion targets from memory-tiers.c
> /* Example 1:
>  *
>  * Node 0 & 1 are CPU + DRAM nodes, node 2 & 3 are PMEM nodes.
>  *
>  * node distances:
>  * node   0    1    2    3
>  *    0  10   20   30   40
>  *    1  20   10   40   30
>  *    2  30   40   10   40
>  *    3  40   30   40   10
>  *
>  * memory_tiers0 = 0-1
>  * memory_tiers1 = 2-3
>  *
>  * node_demotion[0].preferred = 2
>  * node_demotion[1].preferred = 3
>  * node_demotion[2].preferred = <empty>
>  * node_demotion[3].preferred = <empty>
>  */
> ```
> 
> =============================
> Mempolicy Weighted Interleave
> =============================
> The `weighted interleave` functionality of `mempolicy` utilizes weights
> to distribute memory across NUMA nodes according to some set weight.
> There is a proposal to auto-configure these weights based on HMAT data.
> 
> https://lore.kernel.org/linux-mm/20250305200506.2529583-1-joshua.hahnjy@gmail.com/T/#u
> 
> See Section 4 - Interleave, for more information on weighted interleave.
> 
> 
> 
> --------------
> Build Options.
> --------------
> We can add these build configurations to our complexity picture.
> 
> CONFIG_NUMA        - req for ACPI numa, mempolicy, and memory tiers
> CONFIG_ACPI_NUMA   -- enables srat and cedt parsing
> CONFIG_ACPI_HMAT   -- enables hmat parsing
> 
> 
> ~Gregory


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f177.google.com (mail-qk1-f177.google.com [209.85.222.177])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 514642561DB
	for <linux-cxl@vger.kernel.org>; Thu,  6 Mar 2025 17:08:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.177
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741280937; cv=none; b=SdhgrIoiOL+QaGStlELxqps9L863Ox7g4XsfjUZH3AYPsef4p8elMGjxnOLncGOm2NllaiDtx4M4TmQYBPUizWiq0age6SmnW4AQnixRpc19/b2MXdor5OsQLnkgLElcS/XIRfbqkcBt0BHSefaIQxpsCC6H8Ra/HKWrKhek+Dc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741280937; c=relaxed/simple;
	bh=RUEhFfWhM5UlQ2uov74uy48HBJc5JClctmAaFgriwI4=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=uom/m3iuRqc4oEVgNYSoAgW1r+l/QCdcWxD5k/rMRi/X5UuUNwTNifjK3V4CAoMYICjNE7MPGc2XXai2fsu4Dw/qoWobrLVk4DhoddetENuXqL6+GMZPzE1TvSvQgvba6ifC6egDqPkXO8t0MBOz8DMXa+dr4OfzMbqSti180HY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=fS5Df75Q; arc=none smtp.client-ip=209.85.222.177
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="fS5Df75Q"
Received: by mail-qk1-f177.google.com with SMTP id af79cd13be357-7c07cd527e4so81415085a.3
        for <linux-cxl@vger.kernel.org>; Thu, 06 Mar 2025 09:08:54 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741280934; x=1741885734; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=1wNyXxcCEsmV3rMjIVb7Etw5fSJV7UEopsGd2j/hR1s=;
        b=fS5Df75QuIH6V1NtwQfhY3gI1AGXkZgDYKU3TWbo9wvxTgPt6+hROtfoopNLJvkDXP
         Mrh1crW1CoQqR3DPB0eFN8P+1XYQdHqf7Xm03r0uvUk6Zg4XD27SWkmWovW8FXobEMwg
         2z0bjXX8yqXhgvROywDk6eDLjas4Rk/HEje+hDZTp/bwkJ/WXw06LZJfurnm8ARq7fWw
         8yf3RVIFo11lsQq3N3QcNIS4smPiPetodYzP4x4vNJx8L1PS4N6CEVJHmsLsea7XSO3u
         wJP0Yh7BpABFQ50Z3xCLIx1gz+P07hh6NS8l8rxL+a//dssZpyZu+/9mch4/YIdPAXS5
         u4Gg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741280934; x=1741885734;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=1wNyXxcCEsmV3rMjIVb7Etw5fSJV7UEopsGd2j/hR1s=;
        b=e3Bd+4kNs+JT2WVkcbFtyFb0BjMaTgrrzE9BGHgEhFjGUGwx4RZMdJ/Y/7/hz7EEnc
         RWrOXth//sHSqjLDZ4DykU7sKWrholeefDQ96eCjEpb9J0+OV4/zg2VB9RwPRc+ekFvr
         lQ6oWTPpkVn1rT7mIyhw5ghDH8WCoO/MUacW7EP5ZI4zMcwqkij+IXbmdIYv4MDzujUK
         9hYFbzaF/fkgmYeyNRB2RLMn6btmuDGnGHWAhHdodBJRp9V1KkWEc8k9Jp5RI2E1a8GE
         Y9LKY7T8t3s3MJ162U4OIqNnWsAf4q+X5HJaGMnmO2VpuNhgzHRZFzSKjZNHyNVgJntP
         XLqw==
X-Forwarded-Encrypted: i=1; AJvYcCUT9QJPVCzTNLX65bMu6CKR2SSnwR8hAxsLt0p7LQKaJXSrtRaLdS+xCowx8BnnsMkX1JshNrqvfko=@vger.kernel.org
X-Gm-Message-State: AOJu0YyhLMvoTUDdumLE1+uGhid/jkSvYMlBEeXnU4sel6NgHFAsvY9q
	JqqCX5t1NAMyL8+A3c6GNzUGRCU7cgznH5dmj3bYlyZpXLHfBuO2DudeaYhqAGFhgZBGdqf0/HC
	O
X-Gm-Gg: ASbGncvpUrtiy5zFPqhaJZhkuxVO5grwbrn6scdOqTOlvCMw/YXr5605/YHa6kDxRIz
	3aIM3J9UZNl2MdxM8SvP8FhEXjQtOWMBI0NJCSr3fA5MoJg+hmf7d822BPdUje8g7cJj9ape/cK
	o/gjxqVExWA0NwGvB6R8Ix3RHZsHOiVY2Kxo726NhRCyFQRiYsvXbXN+sMY+rJIxVviCwR9rhDF
	f2laxEpuUUPGj+k7lwfMZBnONFSKcq2KyLcrYrRG8VNvTMgiRP1YtO7UayGk+PUasQ9KVBHiT0s
	V1i3pjRvppX82TDW+wGN+saVzrZC/W3F/1mMedQ9xd4oUDOHa1ErYPX2Gq3vBHRr/ljqs5foyO8
	ItO9YYcMxbyLuL8OjAGY4zVD3Y34=
X-Google-Smtp-Source: AGHT+IGzXdo+ayTPw4Ob64P9xw3wnYIZAQKLG2XeMD/1+CZlCiHLJrym6jweO9Vd+DG+fYhwPqgi2w==
X-Received: by 2002:a05:620a:8806:b0:7c0:a357:fe62 with SMTP id af79cd13be357-7c3d8e65564mr986859185a.19.1741280932574;
        Thu, 06 Mar 2025 09:08:52 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3e55116a5sm111483085a.106.2025.03.06.09.08.51
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 06 Mar 2025 09:08:51 -0800 (PST)
Date: Thu, 6 Mar 2025 12:08:49 -0500
From: Gregory Price <gourry@gourry.net>
To: Yuquan Wang <wangyuquan1236@phytium.com.cn>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8nWobZXQwhtE1nK@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <Z8j8bZ5TS+gDV8+M@phytium.com.cn>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z8j8bZ5TS+gDV8+M@phytium.com.cn>
Status: O
Content-Length: 2234
Lines: 62

On Thu, Mar 06, 2025 at 09:37:49AM +0800, Yuquan Wang wrote:
> On Wed, Mar 05, 2025 at 05:20:52PM -0500, Gregory Price wrote:

First, thank you for bringing this up, this is exactly the type of
ambiguiuty i was hoping others would contribute.  It's difficult to
figure out if the ACPI tables are "Correct", if there's unimplemented
features, or we're doing something wrong - because some of this is
undocumented theory of operation.

> > ==================
> > NUMA node creation
> > ===================
> > NUMA nodes are *NOT* hot-pluggable.  All *POSSIBLE* NUMA nodes are
> > identified at `__init` time, more specifically during `mm_init`.
> > 
> > What this means is that the CEDT and SRAT must contain sufficient
> > `proximity domain` information for linux to identify how many NUMA
> > nodes are required (and what memory regions to associate with them).
> > 
> Condition:
> 1) A UMA/NUMA system that SRAT is absence, but it keeps CEDT.CFMWS
> 2Enable CONFIG_ACPI_NUMA
> 
> Results:
> 1) acpi_numa_init: the fake_pxm will be 0 and send to acpi_parse_cfmws()
> 2If dynamically create cxl ram region, the cxl memory would be assigned
> to node0 rather than a fake new node.
>

This is very interesting.  Can I ask a few questions:

1) is this real hardware or a VM?
2) By `dynamic creation` you mean leveraging cxl-cli (ndctl)?
2a) Is the BIOS programming decoders, or are you programming the
    decoder after boot?


> Confusions:
> 1) Does CXL memory usage require a numa system with SRAT? As you
> mentioned in SRAT section: 
> 
> "This table is technically optional, but for performance information
> to be enumerated by linux it must be present."
> 
> Hence, as I understand it, it seems a bug in kernel.
>

It's hard to say if this is a bug yet.  It's either a bug, or your
system should have an SRAT to describe what the BIOS has done.

> 2) If it is a bug, could  we forbid this situation by adding fake_pxm
> check and returning error in acpi_numa_init()?
> 

> 3If not,  maybe we can add some kernel logic to allow create these fake
> nodes on a system without SRAT?
> 

I think we should at least provide a warning (if the SRAT is expected
but missing) - but lets get some more information first.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f169.google.com (mail-qt1-f169.google.com [209.85.160.169])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1ED9823C8AA
	for <linux-cxl@vger.kernel.org>; Thu,  6 Mar 2025 23:56:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.169
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741305380; cv=none; b=EifAUm9XN8ylrXV9/epQX6KzyoWH20NZPze3Br57TgW/IuC+hZudmr/uqvWDaDhCl9IKIv59hqkT3s0d7H1d/97vYBFjjN0yLZBeuvnjoqNQ+/kyyE4RtFGZP1JI+8cJSqrGTUd/yJUlBZ5lXqnPsNQbhkVm8ntPhqqB6HA8HNc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741305380; c=relaxed/simple;
	bh=EDnut2JJw9QS/vdLIDWZgoog/uv+W8+/FbSRiwqOeC4=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=OAl76lV6Pjc71HdNWDHX/o6ZjLvgIvgF5AIcdMQLMUk8iG+vTt6JsKUbOjQKH8Sz92gmfbQHnYBuxwbxlkZW1fXzNDneO419DopFZzZmmXiFRKb1pVuSs8+c+m5xuraofM1jE1HLbSuYemYDIt8Mbg4RtnNlxok2qyr2uJNDNuM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=lDVTKEa+; arc=none smtp.client-ip=209.85.160.169
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="lDVTKEa+"
Received: by mail-qt1-f169.google.com with SMTP id d75a77b69052e-474e0bd966dso10767811cf.0
        for <linux-cxl@vger.kernel.org>; Thu, 06 Mar 2025 15:56:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741305376; x=1741910176; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=8SxknEtouNK3Zjilzhs/nL72q1E1f2BQDuWYXogJJkI=;
        b=lDVTKEa+F3tj7cXw2K6Bghl1Dg1D/gefEUD5zdYV/+TT8Kmzhpl6GTlKFoFVnK18Rr
         am+jPCJodvCnlInvcXyJELD8aGYd0LZ8aseV44WWoiHYlVOJwniZSYJqgCknAkZor2j7
         /f9CyA7Vz8ACTT+5giPPOeqt4zuvKRzl210uQHTTuqKRxq8oII740r8AEB4QtMRE66Uq
         9bIkl91YKqOFqcw7LuxzxuZeK6Ce59ne0uzXlhddu1euHHcQ5lC5nmK2xDvoTZ3i/Oge
         rXfk8ZBliB+LMe+u25nnXU2dLNgX5u1Rle147QuxLKhBtGlRcz7AbO39ihiuaCzPNUQ8
         puFg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741305376; x=1741910176;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=8SxknEtouNK3Zjilzhs/nL72q1E1f2BQDuWYXogJJkI=;
        b=RbmuzyH3SOR8KtdQuVB7gSJxxErpEbmS3xBX/PgjAOEuF52f5m0drkaQaLU/I5/0pj
         f5/0k1UN6K09r+FeUP4T0icuRKpM4twutUwtKZU+crujIKgzUp/wubFPf1gGxMBaUyHN
         8ieKZlyeZkLzZMcmWxToJLTwFLlwYOH9hWpmDQwjp/msaa4I+BZHvBbqdvFi7s+9mmVI
         UcuOkDGMebWswesemkdJzC1EisOW/D6DYYurqdrINoDZJ7pOM3W1XM0muSTXQOzA3k8A
         e/PzUnmbsJlKzLOcS//7bj35IM/CBDAYqhbjTm84QLGnOEVjvf9Q0d2kJzkjQFkHfAG2
         OxAQ==
X-Forwarded-Encrypted: i=1; AJvYcCWqzW6hJqeXb93BwC8merNz/6DgBTf3v2sZhSI0SEMa8a3CgtXk44miemB5Aoy3Dd6eoSEg1GJwRK4=@vger.kernel.org
X-Gm-Message-State: AOJu0Yx6T8XsjT7GR18sXNDLTDRWDaYEkUufKNZ9uoGwNzCeJ3zg+7GA
	vI7i98GgGzmfVVsjZ7+XB5QJpP5JXkj5jpydvbm3UwCmM7CtcsS+Q3gWiOpzzaNuS5a2agbl4tm
	p
X-Gm-Gg: ASbGncuddAQ8AYKi74nDFIDF3NcNnUVASzZxVuQya/eLQnoS88qSmE40n7U0yClgRL/
	tdxZTkoNvsRShejKIwm1E8XUAbjvQL0qZB1yO6PC1m69jOc6BQeqMT2MAlpm9NUM3SBedy9GHQL
	JkIlPWAIhsCCf+6e49NP0tMIIDDnQcj3KphkQglzxRGb+BfFnxDzwzGjl8SzpLkkrDi+Eg4jeJb
	C5fQ6V2SX+AqCPcX0Z0cg8ua8f53+RjGMJzVymPNwwX0Izt9VBWjILGn08BPZNp6EU4Fk1C8LTw
	8mwSSCvQSPrCj8Kh6p3oIOU2jOOzTrjycjOE18rp8KIO2Na0aFEEQxuxzELrdWGFVPoppXOqETu
	R/eCdQyVHmDlSRESqNFMvL/ZwLzw=
X-Google-Smtp-Source: AGHT+IHMfvSB5jDUQA+ycqlh2nLaumrbN/QnnIspplIKXIwSEH68cURXntQcFrU/O3HWCHFOeXosag==
X-Received: by 2002:ad4:500c:0:b0:6e6:6c7c:984a with SMTP id 6a1803df08f44-6e9006776admr10608846d6.29.1741305375656;
        Thu, 06 Mar 2025 15:56:15 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e8f707c39dsm12780056d6.23.2025.03.06.15.56.14
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 06 Mar 2025 15:56:15 -0800 (PST)
Date: Thu, 6 Mar 2025 18:56:13 -0500
From: Gregory Price <gourry@gourry.net>
To: lsf-pc@lists.linux-foundation.org
Cc: linux-mm@kvack.org, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: CXL Boot to Bash - Section 2a (Drivers): CXL Decoder Programming
Message-ID: <Z8o2HfVd0P_tMhV2@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
Status: O
Content-Length: 12774
Lines: 328

I decided to dig into decoder programming as as an addendum to the
Driver section - where I said I *wouldn't* do this. It's important
though, when discussing interleave. So alas, we should at least have
some base understanding of what the heck decoders are actually doing.

This is not a regutitation of the spec, you can think of it closer to
a "Theory of Operation" or whatever.  I will show discrete examples of
how ACPI tables, system memory map, and decoders relate.

----------------------------------------
Definitions: Addresses and HDM Decoders.
----------------------------------------

An HDM Decoder can be thought shorthand as a "routing" mechanism,
where the a Physical Address is used to determine one of:

  1) Fabric routing (i.e. which pipe to send a request down)
  2) Address translation (Host to Device Physical Address)

In section 2, I referenced a simple device-to-decoder mapping:

    root    ---  decoder0.0   -- Root Port Decoder
     |               |
   port1    ---  decoder1.0   -- Host Bridge Decoder
     |               |
  endpoint0 ---  decoder2.0   -- Endpoint Decoder

Barring any special innovations (cough) - endpoint decoders should
be the only decoders that actually "Translation" addresses - at least
for basic volatile memory devices.

All other decoders (Root, Host Bridge, Switch, etc) should simply
forward DMA requests with the original Physical Address intact to
the correct downstream device.

For extra confusion, there are now 3 "Physical Address" domains

System Physical Address (SPA)
  The physical address of some location according to linux.
  This is the address you see in the system memory map.

Host Physical Address   (HPA)
  An abstract address used by decoders (I'll explain later)

Device Physical Address (DPA)
  A device-local physical address (e.g. if a device has 1TB of
  memory, it's DPA range might be 0-0x10000000000)


----------------------------
DMA Routing (No Interleave).
----------------------------
Ok, we have some decoders and confusing physical address definitions,
how does a DMA actually go from processor to DRAM via these decoders?

Lets consider our simple fabric with 256MB of memory at SPA base 4GB.

Lets assume this was all set up statically by BIOS.  We'd have the
following CEDT CFMWS (See Section 0 - ACPI) and decoder programming.

```
CEDT
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000100000000   <- Memory Region
             Window size : 0000000010000000   <- 256MB
Interleave Members (2^n) : 00                 <- Not interleaved

Memory Map:
  [mem 0x0000000100000000-0x0000000110000000] usable    <- SPA

Decoders
  root    ---  decoder0.0   -- range=[0x100000000, 0x110000000]
   |               |
 port1    ---  decoder1.0   -- range=[0x100000000, 0x110000000]
   |               |
endpoint0 ---  decoder2.0   -- range=[0x100000000, 0x110000000]
```

When the CPU accessed an address in this range, the memory controller
will send the request down the CXL fabric. The following steps occur:

  0) CPU accesses SPA(0x101234567)

  1) root decoder identifies HPA(0x101234567) is valid and forwards
     to host bridge associated with that address (port 1)

  2) host bridge decoder identifies HPA(0x101234567) is valid and
     forwards to endpoint associated with that address (endpoint0)

  3) endpoint decoder identifies HPA(0x101234567) is valid and
     translates that address to DPA(0x01234567).

  4) The endpoint device uses DPA(0x01234567) to fulfill the request.

In this scenario, our endpoint has a DPA range of (0, 0x10000000),
but technically DPA address space is device-defined and may be sparse.

As you can see, the root and host bridge decoders simply "route" the
access to the next appropriate hop, while the endpoint decoder actually
does the translation work.


What if instead, we had two 256MB endpoints on the same host bridge?

```
CEDT
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000100000000   <- Memory Region
             Window size : 0000000020000000   <- 512MB
Interleave Members (2^n) : 00                 <- Not interleaved

Memory Map:
  [mem 0x0000000100000000-0x0000000120000000] usable  <- SPA

Decoders
                            decoder0.0
                  range=[0x100000000, 0x120000000]
                                |
                            decoder1.0
                  range=[0x100000000, 0x120000000]
                  /                              \
            decoded2.0                        decoder3.0
  range=[0x100000000, 0x110000000]   range=[0x110000000, 0x120000000]
```

We still only have a single root port and host bridge decoder that
covers the entire 512MB range, but there are now 2 differently
programmed endpoint decoders.

This makes the routing a little more obvious.  The root and host bridge
decoders cover the entire SPA space (512MB), while the endpoint decoders
only cover their own address space (256MB).

The host bridge in this case is responsible for routing the request to
the correct endpoint.


What if we had 2 endpoints, each attached to their own host bridges? 
In this case We'd have 2 root ports and host bridge decoders.

```
CEDT
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000100000000   <- Memory Region 1
             Window size : 0000000010000000   <- 256MB
Interleave Members (2^n) : 00                 <- Not interleaved
            First Target : 00000007           <- Host Bridge _UID

           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000110000000   <- Memory Region 1
             Window size : 0000000010000000   <- 256MB
Interleave Members (2^n) : 00                 <- Not interleaved
            First Target : 00000006           <- Host Bridge _UID

Memory Map - this may or may not be collapsed depending on Linux arch
  [mem 0x0000000100000000-0x0000000110000000] usable  <- System Phys Address
  [mem 0x0000000110000000-0x0000000120000000] usable  <- System Phys Address

Decoders
            decoder0.0                     decoder1.0   - roots
    [0x100000000, 0x110000000]     [0x110000000, 0x120000000]
                |                              |
            decoder2.0                     decoder3.0   - host bridges
    [0x100000000, 0x110000000]     [0x110000000, 0x120000000]
                |                              |
            decoder4.0                     decoder5.0   - endpoints
    [0x100000000, 0x110000000]     [0x110000000, 0x120000000]
```

This scenario looks functionally same as the first - with two distinct,
non-overlapping sets of decoders (any given SPA may only be services by
one device).  The platform memory controller is responsible for routing
the address to the correct root decoder.

In Section 4 (Interleave) we'll discuss a bit how the interleave is
accomplished - as this depends whether you are interleaving across
host bridges (aggregation) or within a host bridge (bifurcation).



---------------------------------------------
Nuance: Host Physical Address... translation?
---------------------------------------------

You might have noticed that all the addresses in the examples I showed
are direct subsets of their parent decoder address ranges.  The root is
assigned a System Physical Address according to the system memory map,
and all decoders under it are a subset of that range.

You may have even noticed routing steps suddenly change from SPA to HPA

  0) CPU accesses SPA(0x101234567)

  1) root decoder identifies HPA(0x101234567) is valid and forwards
     to host bridge associated with that address (port 1)

So what the heck is a "Host Physical Address"?
Why isn't everything just described as a "System Physical Address"?

CXL HDM decoders *definitionally* handle HPA to DPA translations.

That's it, that's the definition of an HPA.

On MOST systems, what you see in the memory map is an SPA, and SPA=HPA,
so all the decoders will appear to be programmed with SPA.  The platform
MAY perform translation before a request is routed to decoder complex.

I will cover an example of this in-depth in an interleave addendum.

So the answer is that some ambiguity exists regarding whether platforms
can/should do translation prior to HDM decoders even being utilized.  So
for the sake of making everything more complicated and confusing for very
little value:

1) decoders definitionally do "HPA to DPA" translation
2) most of the time "SPA=HPA"
3) so decoders mostly do "SPA to DPA" translation

If you're confused, that's ok, I was too - and still am.  But Hopefully
between this section and Section 4 (Interleave) we can be marginally
less confused together.


-----------------------------------------------
Nuance: Memory Holes and Hotplug Memory Blocks!
-----------------------------------------------
Help, BIOS split my memory device across non-contiguous memory regions!

```
CEDT
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000100000000   <- Memory Region 1
             Window size : 0000000080000000   <- 128MB
Interleave Members (2^n) : 00                 <- Not interleaved
            First Target : 00000007           <- Host Bridge _UID

CEDT
           Subtable Type : 01 [CXL Fixed Memory Window Structure]
                Reserved : 00
                  Length : 002C
                Reserved : 00000000
     Window base address : 0000000110000000   <- Memory Region 1
             Window size : 0000000080000000   <- 128MB
Interleave Members (2^n) : 00                 <- Not interleaved
            First Target : 00000007           <- Host Bridge _UID

Memory Map
  [mem 0x0000000100000000-0x0000000107FFFFFF] usable  <- SPA
  [mem 0x0000000108000000-0x000000010FFFFFFF] reserved
  [mem 0x0000000110000000-0x0000000118000000] usable  <- SPA
```

Take a breath. Everything will be ok. 

You can have multiple decoders at each point in the decoder complex!
(Most devices should implement for multiple decoders).

```
Decoders
                              Root Port 0
                             /          \
                    decoder0.0          decoder0.1
    [0x100000000, 0x108000000]          [0x110000000, 0x118000000]
                             \          /
                            Host Bridge 7
                             /          \
                    decoder1.0          decoder1.1
    [0x100000000, 0x108000000]          [0x110000000, 0x118000000]
                             \          /
                              Endpoint 0
                             /          \
                    decoder2.0          decoder2.1
    [0x100000000, 0x108000000]          [0x110000000, 0x118000000]
```

If your BIOS adds a memory hole, it better also use multiple decoders.

Oh, wait, Section 2 and Section 3 allude to hotplug memory blocks
having size and alignment issues!

If your BIOS adds a memory hole, it better also do it on Linux hotplug
memory block alignment (2GB on x86) or you'll lose 1 hotplug memory
block of capacity per CFMWS.

Oi, talk about some rough edges, right? :[

---------------------------------------
Nuance: BIOS vs OS Programmed Decoders.
---------------------------------------
The driver can (and does) program these decoders.  However, it's
entirely normal for BIOS/EFI to program decoders prior to OS init.

Earlier in section 2 I said:
  Most associations built by the driver are done by validating decoders

What I meant by this is the driver does one of two things with decoders:

   1) Detects BIOS programmed decoders and sanity checks them.
      If an unexpected configuration is found, it bails out.
      This memory is not accessible if EFI_MEMORY_SP is set.

   2) Provide an interface for user policy configuration of the decoders

For the most part, the mechanism is the same.  This carve-out is to tell
you if something isn't working, you should check whether the BIOS/EFI or
driver programmed the decoders. It will help debug the issue quicker.

        In my experience, it's USUALLY a bad ACPI table.

This distinction will be more important in Section 4 (Interleave) when
we discuss Inter-Host-Bridge and Intra-Host-Bridge interleave.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from esa9.fujitsucc.c3s2.iphmx.com (esa9.fujitsucc.c3s2.iphmx.com [68.232.159.90])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id DF12F13D897;
	Fri,  7 Mar 2025 00:58:34 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=68.232.159.90
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741309117; cv=fail; b=j1/fPj1njpFYOw58DlQPEvGngIJbdVd1lMXoyL/UBzKyCDXDzVsmHDbZAt/5NpNMJJCplGIR3qQ0jf+xSnjLuwzh+qJ84n5ahHYDvGAnCFLNTOIdS78rPb2Ff+KOONG0f8cCLgjqM+w+fDzhU/uXIRQ4hd4g52aToPVHgRFku18=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741309117; c=relaxed/simple;
	bh=TLfE86aDEU+TnDUVHQJ3FVvsEtTIglawS9MtpE7+jkE=;
	h=From:To:CC:Subject:Date:Message-ID:References:In-Reply-To:
	 Content-Type:MIME-Version; b=gQoN+c8j4PRXvLPaN5nd40i2DFtRVMift4mvFvTFUDT1tTbJizUI5rD7Wz6Kc5kL/fDcrpQ/xsV8VBErw+if+IfODKmr6zZ9X84VHoz0vsjNW4Obk72YMA1cZOpIylg78fEMgeYOSvBkvAT3bUkZywmpBkV9XKmvhi0n+AoNC6o=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=reject dis=none) header.from=fujitsu.com; spf=pass smtp.mailfrom=fujitsu.com; dkim=pass (2048-bit key) header.d=fujitsu.com header.i=@fujitsu.com header.b=Af5GX2/t; arc=fail smtp.client-ip=68.232.159.90
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=reject dis=none) header.from=fujitsu.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=fujitsu.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=fujitsu.com header.i=@fujitsu.com header.b="Af5GX2/t"
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
  d=fujitsu.com; i=@fujitsu.com; q=dns/txt; s=fj1;
  t=1741309115; x=1772845115;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=TLfE86aDEU+TnDUVHQJ3FVvsEtTIglawS9MtpE7+jkE=;
  b=Af5GX2/tkwIwBTomiISgNst9mgHJsep/Lzwr1on+AmheSJOfZ2yq5H+t
   r53y6mpiSWKviHQAyAJhZHaA/zEU+lzR7Piqr+BkyhNA3a9adP7XiZ2SE
   heo/GcGgxSxIjh2we/WWEXJ0EbtYdR2EvmQUGkVq3XDWBLQ4vIhhVs7Tw
   nUqATssI45jVPGOL8rvEvng14oWK+1SpsK00MPKl+FhTQSev8yBCwnPdB
   cA61uywD+a+wK9mK9sv/tzN+fqqc0T1lUluM06tk5UJ12WIvszl6l/sBG
   PhQwXkSgxDoa8BGSRhZxoCJ5F6qum7CGg5FjRBsoheL9u2xObO4+oXcpC
   Q==;
X-CSE-ConnectionGUID: /9ZyOYpNQN+/lGUcYIvkXw==
X-CSE-MsgGUID: dl/A1KjfRSexQNEHwnV9sg==
X-IronPort-AV: E=McAfee;i="6700,10204,11365"; a="148693510"
X-IronPort-AV: E=Sophos;i="6.14,227,1736780400"; 
   d="scan'208";a="148693510"
Received: from mail-japanwestazlp17010002.outbound.protection.outlook.com (HELO OS0P286CU011.outbound.protection.outlook.com) ([40.93.130.2])
  by ob1.fujitsucc.c3s2.iphmx.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 07 Mar 2025 09:57:21 +0900
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=puYr/8IUy9gK5vKf3YVR+sc6uzS7WPcgSPJeKILsO3be0M1Djot2uY3lHhTprEvzr4e8JyNtGvEV7E5lOS2WUYLS703JtKdlqHaJ4oIj5Cg1e0FiASqIURRL4vEVtApSGzsXV8RPP46ddYWMCgn7BT8HqNJG201fB4eTHF4LeHpreLFMTGevrK5EfzwLN/XSJGbzHPoiXUYTjglRDkpMis3+DCVDjyTOcp8cXoPf0aaPuP52rLe++zvzlMqCc7SasbpPQ7YKm2fPJGOTbJmsgxFQ4AkesVM6qTt2HzNwyrLXMBlNB6XRYNSzDs1s0OmFC373D9PzgCsyBDzlwnHNNg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=TLfE86aDEU+TnDUVHQJ3FVvsEtTIglawS9MtpE7+jkE=;
 b=mIQaHULFt+glwKZ3tSbtObn1lPsgbOuq6dgOtx6H2MYzKtl7bwaCKReLzbID8hxqZGN9gTyd/aTUaqRchjcUkFmLKYlM0ZyALYi+CKl4uEfoimTnEPjHDObhehIdJXOR7P1mLQiT+T/EOaK1FuFHfe4rwtAQWVOkijpb2TwkYjCGL8UVwyjHFIIORuhHQ4mubRMEBak2MFBfCJnXZm3HEF4qqJtkujDiFntO5lO+ntsBkej/12JBu/7dF31fVNA/2jNR2WRJK1dgbgHzTt8Ep8F6yV0tZjUPLl28FiXksPea/6x9rwhEEFslRaxhHgrsUYkXRcFqk31S6AdpzsZDTQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=fujitsu.com; dmarc=pass action=none header.from=fujitsu.com;
 dkim=pass header.d=fujitsu.com; arc=none
Received: from TY1PR01MB1562.jpnprd01.prod.outlook.com (2603:1096:403:6::12)
 by OS9PR01MB13289.jpnprd01.prod.outlook.com (2603:1096:604:30f::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8511.19; Fri, 7 Mar
 2025 00:57:19 +0000
Received: from TY1PR01MB1562.jpnprd01.prod.outlook.com
 ([fe80::d9ba:425a:7044:6377]) by TY1PR01MB1562.jpnprd01.prod.outlook.com
 ([fe80::d9ba:425a:7044:6377%5]) with mapi id 15.20.8489.025; Fri, 7 Mar 2025
 00:57:18 +0000
From: "Zhijian Li (Fujitsu)" <lizhijian@fujitsu.com>
To: Gregory Price <gourry@gourry.net>, "lsf-pc@lists.linux-foundation.org"
	<lsf-pc@lists.linux-foundation.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>, "linux-cxl@vger.kernel.org"
	<linux-cxl@vger.kernel.org>, "linux-kernel@vger.kernel.org"
	<linux-kernel@vger.kernel.org>
Subject: Re: CXL Boot to Bash - Section 2a (Drivers): CXL Decoder Programming
Thread-Topic: CXL Boot to Bash - Section 2a (Drivers): CXL Decoder Programming
Thread-Index: AQHbjvNia1PhMmp5z06r6vu5ANRYCrNm2dYA
Date: Fri, 7 Mar 2025 00:57:18 +0000
Message-ID: <570b18f4-3790-4e57-8d80-a5301e5d8af2@fujitsu.com>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
 <Z8o2HfVd0P_tMhV2@gourry-fedora-PF4VCD3F>
In-Reply-To: <Z8o2HfVd0P_tMhV2@gourry-fedora-PF4VCD3F>
Accept-Language: en-US, zh-CN
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Mozilla Thunderbird
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=fujitsu.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: TY1PR01MB1562:EE_|OS9PR01MB13289:EE_
x-ms-office365-filtering-correlation-id: e45002c8-c8c0-4a2b-1e52-08dd5d130272
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;ARA:13230040|376014|1800799024|366016|38070700018|1580799027;
x-microsoft-antispam-message-info: =?utf-8?B?RThYQnV1RWlzdmtBN3hoS2dXcDFQbGpTNnkyR2Q2ZitOZEdNVHN0dzlRSmMy?=
 =?utf-8?B?dWRFNzZ4K1o5MTJmQVdSbEV5bi9GWXpUT3RidzFBZWk3a0R0blFMbGh0M2NK?=
 =?utf-8?B?WCtNaHJOWk0rYkczdkhvZzZ3Z1kzcmRpMmxkQ2VwdkRoeHBpaXROaFZGaDVV?=
 =?utf-8?B?MlN6U09VcWlvT1pyU1lRZmdvSlkrdHJYbk5Qb3REQ3ZsN2VodDdEcnVYOEJL?=
 =?utf-8?B?M3JhbzJsb1BEeUEydmpzS0gvSW0wWldaZ1hCL1pPS25Ed250eHdETWFibk85?=
 =?utf-8?B?d0l2NkoxVjRuOTQ3dDNiaVRpTzRPYU9Wb0pUa1dEVmw3aVQ4WUpqRHFuVVlK?=
 =?utf-8?B?ZE1YWldoYkNOSGhuWXJyMUhjbWgxaXo3cStvNnFHT3pHZmdaTlJRdDNxZEtz?=
 =?utf-8?B?ZXJSOTNZbklORlZMVFJxdjhGamNFUExPNktZN2h4azlXQnlNZml6ekpMVGRL?=
 =?utf-8?B?NnRETzVHMmYwSzV1ZmNyZEc1cnBETXZyYWhKZUVYMkh2V1g2aTZQaThjeW95?=
 =?utf-8?B?L1d2aU91TlhZNlhYcmc1QnV6cWhmVk9wK3ZQeHFqdUI5bHBPT00vTGJkUkhC?=
 =?utf-8?B?MlpLL05seWZuTTZ4T0N1T2pab090ZElqeHFHY3E0VDZUZy96M3BLUVJibXNP?=
 =?utf-8?B?K1RRdVRtM0tWUzVaY2NNSkQzUHJaWkNpNDdkWnR6QW1LbzNHcWVoaHVlRExK?=
 =?utf-8?B?MXNwNUJlUkFUVmxTV083K2JydE9QYmpBSDZEZWRkM1ROVWFxMXNnZWZvVThp?=
 =?utf-8?B?UXgrL1FDVFowS2kwUU9ST2FPVC90TFpzejZVOFR4MC8vdlV1TVZXYU5EdjVB?=
 =?utf-8?B?TWpEYjgyVmhYV3FzTkIxUDJIdzB5OUMwczJXakpDV0lTZHB0M2VUSkVMdzNL?=
 =?utf-8?B?bTRuUzFJajZ0cWFPa1NwclJuWHZsbW9Pb0RwOGxENnQ5SVJpeW02NnEwbzBN?=
 =?utf-8?B?QVNrVG1xMVdNRWRBSXlYTGs4R0pQWS9nTkpkRWFaNS92R0xndkpteER3a2cy?=
 =?utf-8?B?cW1wenVHV1ViSkF5WG8vWS8xV1NKZWtkWTFMN2ZiUXdHZUo2T1d3aXd2eGJy?=
 =?utf-8?B?VjN1ZnhnSHVYRkxERzZVc3RZWGxNY2wrTitXWlJJemRKYmpLTURhbDU2VXp1?=
 =?utf-8?B?cXlnN0pOeHN5WkZHcFYzV3JVNVllcmxOL3F6UUhxMUZQN3hNZEc1eEFRd1Qv?=
 =?utf-8?B?NVpRZXFxT3BMWnJaTTRxZnZJdmxBRGVkTW5aMXhKakVBNzJmK3RYcFU3VGJs?=
 =?utf-8?B?SEtoUjBoNm85S2dINy9ycmJLVnlUREh3Tlo0MFVtaDU5U2p3Y0ZVLzJZcjBU?=
 =?utf-8?B?T1AxMnJqWTBEODJNZFNUWDJiNUp3Q1oxOVhiQ09kZmtmbklIc013QzdvNXBT?=
 =?utf-8?B?L0MwVjEvMXZyMHhrdmhqWmtNeHZYTWg5SGxFTlUrbVhLSEhPME9wY1RDSjFK?=
 =?utf-8?B?aXV2LzJ1eUFKS0ZockpUUjJ2NjVMemZEUlZYdkRlNGprNURKNGJ6NGlTaEpL?=
 =?utf-8?B?TFJiWW1nLzNZUkZzc21PUUl4WTIrOGF2S0wrTlQ2WkF1b2Y0TzQ0WFNWMWdh?=
 =?utf-8?B?VU5XRU1scVA5NlN4L0s4ZTRaazVYL2tRTGxNa3RCdndVbnJLQ3BQNkNvQTNz?=
 =?utf-8?B?SDIyY1N3ZFJ3UC9JaFlHV1I2ZU9pdDYzdjlhbUlkbG9PTldmUURENE1PcG81?=
 =?utf-8?B?RVEwWjRPVytTY04xSmk5c2pidjVRUkRlb25lYk9LYkQ3eHBTVmRqaXJoQ09r?=
 =?utf-8?B?UXZpSlFRU25xdWgrcnNDRjlqT0NkTVVGTmVjZzlGN2k1aUpTTCtXYjlJZDR1?=
 =?utf-8?B?Z2FVZnZqU2pCaHpXUUhNU0VXMmlZL0hVUmxwaTBpcXZBaFRQNnNUVm9MNzBv?=
 =?utf-8?B?Z2xDUGIzL25YYmYzUmVVWXhLSXJUN3NyMWRMTERrN3U0TXdaRllRVy96Q1Bo?=
 =?utf-8?B?bndPWUtQdkRDc201ZXZyM1lqUVlWZWx6dzlLTUtnU3JBZGkwNkRRekR3RHVQ?=
 =?utf-8?B?dkRyZGRqWURnPT0=?=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:TY1PR01MB1562.jpnprd01.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(1800799024)(366016)(38070700018)(1580799027);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?eUJ0SHc2SEVhcEZ5ODdxdkV0MFI5SG5OTE5lWFVveHdmaUZTOTQySmVJRS9W?=
 =?utf-8?B?c0ppUGxGbDl0aVdjUTBFOW14ZmcrOCt6ejRHcWlJRlNacUd6QlphMjNMOVZD?=
 =?utf-8?B?eGNGYVdhNzdIOTJnYVByeXRMcGxiREVaNWxaem9xU0VtKzVxY2VDRGFQblRE?=
 =?utf-8?B?eEFianc3ZnI2NElLVzJzMi9OTDdsWVhiMElhZjRQd2pCUFpwdzVTSzR5ZG5k?=
 =?utf-8?B?NnVrK0Jod0w1QmEzdXdFbVkyaFc1WkhSdjFiL0lKT3NGR0V5Sko3STB0MEtQ?=
 =?utf-8?B?SlpSNUlYNjNobkxDZkQ2ME85aFQrRmE0TFhRM3UvTGViYVBFckRxaTZxNENr?=
 =?utf-8?B?enJMbmRpMlN3SThCakNlck12VzBmbmZlVVNQdXFGTkVTOXgwaUJ5ZGc2VS9J?=
 =?utf-8?B?cy9YemRqOHQ2dEpaZzFCdkZmd09PaFBXWk9rcnlIZmNVUEx4dXBjamt6UEYz?=
 =?utf-8?B?UGN3OTg2K0k2UjYwYWI3aHBmNlJQTk4zWDhTR1dqaERYUW52c3BiQWR0dFhp?=
 =?utf-8?B?SEtrMEtiUG9ZUHZSdEFOYnJmRkNmMis4eTVoZzNlaHpadTEvZExncEp6RWZ4?=
 =?utf-8?B?WW9iQ3FQRWNRMzZZSGpjbTFSeHA0bHVST2lEanZCa3ArYXpCeTBwWkJqenJR?=
 =?utf-8?B?YitSSUNuNDBHS1NXQVN6UmhKdEV5NkRKTWNScUdqUjl3bXNmRmVLOWNNTVcz?=
 =?utf-8?B?d2xRWGxUWWpwdHY3K1hxSXdidmplempDSTFmRGc5ZVVmNXB4bHFHTHAxTlFV?=
 =?utf-8?B?MVhDTmFKMm9tSXVrcG5UTkpGOGhCM0tLaHdva0VOeVhURXE4bS9FQVQrT1pz?=
 =?utf-8?B?eHhMRjF2dHBoRUFDbzdRMzJhMFl3YUFub2VZU3hPKzJRckpYSHBPVDJYalc3?=
 =?utf-8?B?djhjZVQ5NnVBaUl3dXgrQkR4M005TDBoUzZoNU1yTHlrZmorQkhOeU9uUkJl?=
 =?utf-8?B?Z3p2UENQWDgyYWgyeWtFdjhkTXcrbXlxT2Fha0JNVkdCZGdLc0ZGR1JRQVpT?=
 =?utf-8?B?WmdGNVJSSUt6dDFrUksvNWNRS1RpQkQ1bFpxRU1COTFLWWEydDJYV2VqUFZv?=
 =?utf-8?B?SHRXQThNQnRHNWVFZkZGVlZPMlJGckRnZnYvOFpaR2kzQmJUT1NTdEQzd2po?=
 =?utf-8?B?ZFV2K1JOcTRLcnF2MFNtOFM2a3FSUkNoUjBBb0d0Z2Z5ZnQrdEd4NWhKL1Bp?=
 =?utf-8?B?WFJYOU52d3ZDSVpPODVYR3c2eXVhd09icnpybUZVWjlzTU5YTHVJaXZ3bndi?=
 =?utf-8?B?aEdQY1Q2Q0JJcXRqYlRuN2lNaXZ5Ukxua09hTFRuaVpTMXRuaEhCMTNqUHJM?=
 =?utf-8?B?NnB4ZFN2N3BtejZiNFllbnNzOFQvdEFVUUdBdjRqaW9LTmNVTVNmV1lqVVFt?=
 =?utf-8?B?dWh5ZHZiSHNIMlFQVjA2TXdpYXE4V2t0cW5qcVlTSEQwT0w4TGpFNXhuNjhF?=
 =?utf-8?B?RTViM1hlUkZJLzNEN3k2aEYyQkVrTytaYTRLenBYRVdkbkdzdEpFekh1L3BE?=
 =?utf-8?B?aFdpbmkvRnU1SDJCbWZ0ZXFybCt1ZW8xRy80QldudXkyb2htWVhTcUJhQm90?=
 =?utf-8?B?L3dDKzB0UGd0UnhhZGlScTFCUUhmTGNsNlJOOXRGeFNyV3NhdGpRaG1HNDhV?=
 =?utf-8?B?V1I5OUxsRzFrQVJzN3lwa3RQOFdCQVJqaU1tUzIvemtQQ2swUGxydnhtZFhN?=
 =?utf-8?B?ZzhLTnpZSW5TaThIU2dTTnE1Q2VhbVZTSFkrS2s3SHNQTnhFbmJ1VkhQMzRQ?=
 =?utf-8?B?MDJyOTBMVTRrc2xGMkRHR2pWSzNiYWxEM0YvWDVKWG9nT01xOXFlMjRzR25M?=
 =?utf-8?B?ZDBHYzlCU1dxellyUVZvMGRGVFBLVFQzREpWYW1EYmxvbUpsY1VGdjRwY0xi?=
 =?utf-8?B?bUFYMTkrRnc3ZHl5S1pVN0o2ejQzSUJpN3Z6eW5MbVkwSlI3dStQSUpXT0pB?=
 =?utf-8?B?aW1JeGlBTFhWUmFpaFN6Q3Q1NDV4WkYxT1p6alg3OEJiV3FkL1F4akJteFE0?=
 =?utf-8?B?NlBYRmR6OUFBcTN2TExFWG1aYlFaZlBtTzFGUnBkQVQ0ZFRtYklmMUtaMWV5?=
 =?utf-8?B?V005ZmdRdHpsK2ZMY2x4UnRia3pucDhKK3RqbE1FRDc3a01DaHlUUnllMGRt?=
 =?utf-8?B?OWU2NlVsTUozRTBVa2JGa1VEeExSZk5rZGt2UDRIVjd2WTJUNWdmOE5Qb2Fv?=
 =?utf-8?B?anc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <F10172D2926D53469CE94A302C0A7B78@jpnprd01.prod.outlook.com>
Content-Transfer-Encoding: base64
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-Exchange-AntiSpam-ExternalHop-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-ExternalHop-MessageData-0: J4rbvWAnHNzB0HXJ32BXZk6z8XN5/vTtbb6FXUiB8Gj6iA7A9nfR8I8o9geDB6PSC+6MrYBIXI+lidUbrdRWa9xr2+rLc9Q4eMgz+wWfu68qabjplKlgYxp6ugncCPMilxYHb+pIT1w5/uVmjV7G5I2minbkBRi5RMfZIzd2HhWND/pimJYdYcGv8Mvq6mSeRSK+ICSeXoGC7azthtgnCnw+tCjbAEIULddRhIotZsjOa0dh9Ups2nwAweMsJNTkkAYk/Zgk5D7M8/Gxs+tRrVrac1oRPrX3DqJAd2DdXkBarF/WJsCwHlUbF0YexcWBUBuDxFOPG/l0JaQIb6Sou1mFvDmTr0z6E2f54SCSorx5nHSvQOKdC/sx4RTydPk7vTXsNByrecZjahjxwbel7JhieV17VIWnfji0riaI7S8EixkMZ54zlc/mJCOm/mKrQHOGFvDYrB+wm3qEjS3Rl+GkKhUHGkMLupHC5ym83iMnTnu/tA3pIKo+wBeePIjILMWea0PwF3hDRt2FixbMV5ER4RQfafOgBv3xEux2ZmNEMMvYAYSd+Zd6GT2ViCme3n7QpAeShx/zYECeUQvakZV+BCn+LmppWvlTaAsu7hn7bjj+ADmsFMPPXkhSohgZ
X-OriginatorOrg: fujitsu.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: TY1PR01MB1562.jpnprd01.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: e45002c8-c8c0-4a2b-1e52-08dd5d130272
X-MS-Exchange-CrossTenant-originalarrivaltime: 07 Mar 2025 00:57:18.3146
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: a19f121d-81e1-4858-a9d8-736e267fd4c7
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: SFTi5JbxUr+5qcTBpn5OOOafkADc22ay8dYkWZj3yLdeHLwhP/gBkKUMNuG5VEvWsNOQN4WiTlWzEVa1+q7eeA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: OS9PR01MB13289
Status: O
Content-Length: 19652
Lines: 256

SGV5IEdyZWdvcnksDQoNClRoYW5rIHlvdSBzbyBtdWNoIGZvciB5b3VyIGRldGFpbGVkIGludHJv
ZHVjdGlvbiB0byB0aGUgZW50aXJlIENYTA0Kc29mdHdhcmUgZWNvc3lzdGVtLCB3aGljaCBJIGhh
dmUgdGhvcm91Z2hseSByZWFkLiBZb3UgYXJlIHRydWx5IGV4Y2VsbGVudC4NCg0KDQpPbiAwNy8w
My8yMDI1IDA3OjU2LCBHcmVnb3J5IFByaWNlIHdyb3RlOg0KPiBJIGRlY2lkZWQgdG8gZGlnIGlu
dG8gZGVjb2RlciBwcm9ncmFtbWluZyBhcyBhcyBhbiBhZGRlbmR1bSB0byB0aGUNCj4gRHJpdmVy
IHNlY3Rpb24gLSB3aGVyZSBJIHNhaWQgSSAqd291bGRuJ3QqIGRvIHRoaXMuIEl0J3MgaW1wb3J0
YW50DQo+IHRob3VnaCwgd2hlbiBkaXNjdXNzaW5nIGludGVybGVhdmUuIFNvIGFsYXMsIHdlIHNo
b3VsZCBhdCBsZWFzdCBoYXZlDQo+IHNvbWUgYmFzZSB1bmRlcnN0YW5kaW5nIG9mIHdoYXQgdGhl
IGhlY2sgZGVjb2RlcnMgYXJlIGFjdHVhbGx5IGRvaW5nLg0KPiANCj4gVGhpcyBpcyBub3QgYSBy
ZWd1dGl0YXRpb24gb2YgdGhlIHNwZWMsIHlvdSBjYW4gdGhpbmsgb2YgaXQgY2xvc2VyIHRvDQo+
IGEgIlRoZW9yeSBvZiBPcGVyYXRpb24iIG9yIHdoYXRldmVyLiAgSSB3aWxsIHNob3cgZGlzY3Jl
dGUgZXhhbXBsZXMgb2YNCj4gaG93IEFDUEkgdGFibGVzLCBzeXN0ZW0gbWVtb3J5IG1hcCwgYW5k
IGRlY29kZXJzIHJlbGF0ZS4NCj4gDQo+IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0NCj4gRGVmaW5pdGlvbnM6IEFkZHJlc3NlcyBhbmQgSERNIERlY29kZXJzLg0KPiAt
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQo+IA0KPiBBbiBIRE0gRGVj
b2RlciBjYW4gYmUgdGhvdWdodCBzaG9ydGhhbmQgYXMgYSAicm91dGluZyIgbWVjaGFuaXNtLA0K
PiB3aGVyZSB0aGUgYSBQaHlzaWNhbCBBZGRyZXNzIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIG9uZSBv
ZjoNCj4gDQo+ICAgIDEpIEZhYnJpYyByb3V0aW5nIChpLmUuIHdoaWNoIHBpcGUgdG8gc2VuZCBh
IHJlcXVlc3QgZG93bikNCj4gICAgMikgQWRkcmVzcyB0cmFuc2xhdGlvbiAoSG9zdCB0byBEZXZp
Y2UgUGh5c2ljYWwgQWRkcmVzcykNCj4gDQo+IEluIHNlY3Rpb24gMiwgSSByZWZlcmVuY2VkIGEg
c2ltcGxlIGRldmljZS10by1kZWNvZGVyIG1hcHBpbmc6DQo+IA0KPiAgICAgIHJvb3QgICAgLS0t
ICBkZWNvZGVyMC4wICAgLS0gUm9vdCBQb3J0IERlY29kZXINCj4gICAgICAgfCAgICAgICAgICAg
ICAgIHwNCj4gICAgIHBvcnQxICAgIC0tLSAgZGVjb2RlcjEuMCAgIC0tIEhvc3QgQnJpZGdlIERl
Y29kZXINCj4gICAgICAgfCAgICAgICAgICAgICAgIHwNCj4gICAgZW5kcG9pbnQwIC0tLSAgZGVj
b2RlcjIuMCAgIC0tIEVuZHBvaW50IERlY29kZXINCg0KDQoNCkhlcmUsIEkgbm90aWNlZCBzb21l
dGhpbmcgdGhhdCBkaWZmZXJzIHNsaWdodGx5IGZyb20gbXkgdW5kZXJzdGFuZGluZzoNCiJyb290
IC0tLSBkZWNvZGVyMC4wIC0tIFJvb3QgUG9ydCBEZWNvZGVyLiINCg0KIEZyb20gdGhlIHBlcnNw
ZWN0aXZlIG9mIHRoZSBMaW51eCBEcml2ZXIsIGRlY29kZXIwLjAgdXN1YWxseSByZWZlcnMgdG8N
CmFzc29jaWF0ZWQgYSBDRk1Xcy4gTW9yZW92ZXIsIGFjY29yZGluZyB0byBTcGVjIHIzLjEgVGFi
bGUgOC0yMiBDWEwgSERNIERlY29kZXIgQ2FwYWJpbGl0eSwNCnRoZSBDWEwgUm9vdCBQb3J0IChh
bHNvIGtub3duIGFzIFIgaW4gdGhlIHRhYmxlKSBpcyBub3QgcGVybWl0dGVkIHRvIGltcGxlbWVu
dA0KdGhlIEhETSBkZWNvZGVyLg0KDQpJZiBJIGhhdmUgbWlzdW5kZXJzdG9vZCBzb21ldGhpbmcs
IHBsZWFzZSBsZXQgbWUga25vdy4NCg0KDQpUaGFua3MNClpoaWppYW4NCg0KPiANCj4gQmFycmlu
ZyBhbnkgc3BlY2lhbCBpbm5vdmF0aW9ucyAoY291Z2gpIC0gZW5kcG9pbnQgZGVjb2RlcnMgc2hv
dWxkDQo+IGJlIHRoZSBvbmx5IGRlY29kZXJzIHRoYXQgYWN0dWFsbHkgIlRyYW5zbGF0aW9uIiBh
ZGRyZXNzZXMgLSBhdCBsZWFzdA0KPiBmb3IgYmFzaWMgdm9sYXRpbGUgbWVtb3J5IGRldmljZXMu
DQo+IA0KPiBBbGwgb3RoZXIgZGVjb2RlcnMgKFJvb3QsIEhvc3QgQnJpZGdlLCBTd2l0Y2gsIGV0
Yykgc2hvdWxkIHNpbXBseQ0KPiBmb3J3YXJkIERNQSByZXF1ZXN0cyB3aXRoIHRoZSBvcmlnaW5h
bCBQaHlzaWNhbCBBZGRyZXNzIGludGFjdCB0bw0KPiB0aGUgY29ycmVjdCBkb3duc3RyZWFtIGRl
dmljZS4NCj4gDQo+IEZvciBleHRyYSBjb25mdXNpb24sIHRoZXJlIGFyZSBub3cgMyAiUGh5c2lj
YWwgQWRkcmVzcyIgZG9tYWlucw0KPiANCj4gU3lzdGVtIFBoeXNpY2FsIEFkZHJlc3MgKFNQQSkN
Cj4gICAgVGhlIHBoeXNpY2FsIGFkZHJlc3Mgb2Ygc29tZSBsb2NhdGlvbiBhY2NvcmRpbmcgdG8g
bGludXguDQo+ICAgIFRoaXMgaXMgdGhlIGFkZHJlc3MgeW91IHNlZSBpbiB0aGUgc3lzdGVtIG1l
bW9yeSBtYXAuDQo+IA0KPiBIb3N0IFBoeXNpY2FsIEFkZHJlc3MgICAoSFBBKQ0KPiAgICBBbiBh
YnN0cmFjdCBhZGRyZXNzIHVzZWQgYnkgZGVjb2RlcnMgKEknbGwgZXhwbGFpbiBsYXRlcikNCj4g
DQo+IERldmljZSBQaHlzaWNhbCBBZGRyZXNzIChEUEEpDQo+ICAgIEEgZGV2aWNlLWxvY2FsIHBo
eXNpY2FsIGFkZHJlc3MgKGUuZy4gaWYgYSBkZXZpY2UgaGFzIDFUQiBvZg0KPiAgICBtZW1vcnks
IGl0J3MgRFBBIHJhbmdlIG1pZ2h0IGJlIDAtMHgxMDAwMDAwMDAwMCkNCj4gDQo+IA0KPiAtLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQo+IERNQSBSb3V0aW5nIChObyBJbnRlcmxlYXZlKS4N
Cj4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KPiBPaywgd2UgaGF2ZSBzb21lIGRlY29k
ZXJzIGFuZCBjb25mdXNpbmcgcGh5c2ljYWwgYWRkcmVzcyBkZWZpbml0aW9ucywNCj4gaG93IGRv
ZXMgYSBETUEgYWN0dWFsbHkgZ28gZnJvbSBwcm9jZXNzb3IgdG8gRFJBTSB2aWEgdGhlc2UgZGVj
b2RlcnM/DQo+IA0KPiBMZXRzIGNvbnNpZGVyIG91ciBzaW1wbGUgZmFicmljIHdpdGggMjU2TUIg
b2YgbWVtb3J5IGF0IFNQQSBiYXNlIDRHQi4NCj4gDQo+IExldHMgYXNzdW1lIHRoaXMgd2FzIGFs
bCBzZXQgdXAgc3RhdGljYWxseSBieSBCSU9TLiAgV2UnZCBoYXZlIHRoZQ0KPiBmb2xsb3dpbmcg
Q0VEVCBDRk1XUyAoU2VlIFNlY3Rpb24gMCAtIEFDUEkpIGFuZCBkZWNvZGVyIHByb2dyYW1taW5n
Lg0KPiANCj4gYGBgDQo+IENFRFQNCj4gICAgICAgICAgICAgU3VidGFibGUgVHlwZSA6IDAxIFtD
WEwgRml4ZWQgTWVtb3J5IFdpbmRvdyBTdHJ1Y3R1cmVdDQo+ICAgICAgICAgICAgICAgICAgUmVz
ZXJ2ZWQgOiAwMA0KPiAgICAgICAgICAgICAgICAgICAgTGVuZ3RoIDogMDAyQw0KPiAgICAgICAg
ICAgICAgICAgIFJlc2VydmVkIDogMDAwMDAwMDANCj4gICAgICAgV2luZG93IGJhc2UgYWRkcmVz
cyA6IDAwMDAwMDAxMDAwMDAwMDAgICA8LSBNZW1vcnkgUmVnaW9uDQo+ICAgICAgICAgICAgICAg
V2luZG93IHNpemUgOiAwMDAwMDAwMDEwMDAwMDAwICAgPC0gMjU2TUINCj4gSW50ZXJsZWF2ZSBN
ZW1iZXJzICgyXm4pIDogMDAgICAgICAgICAgICAgICAgIDwtIE5vdCBpbnRlcmxlYXZlZA0KPiAN
Cj4gTWVtb3J5IE1hcDoNCj4gICAgW21lbSAweDAwMDAwMDAxMDAwMDAwMDAtMHgwMDAwMDAwMTEw
MDAwMDAwXSB1c2FibGUgICAgPC0gU1BBDQo+IA0KPiBEZWNvZGVycw0KPiAgICByb290ICAgIC0t
LSAgZGVjb2RlcjAuMCAgIC0tIHJhbmdlPVsweDEwMDAwMDAwMCwgMHgxMTAwMDAwMDBdDQo+ICAg
ICB8ICAgICAgICAgICAgICAgfA0KPiAgIHBvcnQxICAgIC0tLSAgZGVjb2RlcjEuMCAgIC0tIHJh
bmdlPVsweDEwMDAwMDAwMCwgMHgxMTAwMDAwMDBdDQo+ICAgICB8ICAgICAgICAgICAgICAgfA0K
PiBlbmRwb2ludDAgLS0tICBkZWNvZGVyMi4wICAgLS0gcmFuZ2U9WzB4MTAwMDAwMDAwLCAweDEx
MDAwMDAwMF0NCj4gYGBgDQo+IA0KPiBXaGVuIHRoZSBDUFUgYWNjZXNzZWQgYW4gYWRkcmVzcyBp
biB0aGlzIHJhbmdlLCB0aGUgbWVtb3J5IGNvbnRyb2xsZXINCj4gd2lsbCBzZW5kIHRoZSByZXF1
ZXN0IGRvd24gdGhlIENYTCBmYWJyaWMuIFRoZSBmb2xsb3dpbmcgc3RlcHMgb2NjdXI6DQo+IA0K
PiAgICAwKSBDUFUgYWNjZXNzZXMgU1BBKDB4MTAxMjM0NTY3KQ0KPiANCj4gICAgMSkgcm9vdCBk
ZWNvZGVyIGlkZW50aWZpZXMgSFBBKDB4MTAxMjM0NTY3KSBpcyB2YWxpZCBhbmQgZm9yd2FyZHMN
Cj4gICAgICAgdG8gaG9zdCBicmlkZ2UgYXNzb2NpYXRlZCB3aXRoIHRoYXQgYWRkcmVzcyAocG9y
dCAxKQ0KPiANCj4gICAgMikgaG9zdCBicmlkZ2UgZGVjb2RlciBpZGVudGlmaWVzIEhQQSgweDEw
MTIzNDU2NykgaXMgdmFsaWQgYW5kDQo+ICAgICAgIGZvcndhcmRzIHRvIGVuZHBvaW50IGFzc29j
aWF0ZWQgd2l0aCB0aGF0IGFkZHJlc3MgKGVuZHBvaW50MCkNCj4gDQo+ICAgIDMpIGVuZHBvaW50
IGRlY29kZXIgaWRlbnRpZmllcyBIUEEoMHgxMDEyMzQ1NjcpIGlzIHZhbGlkIGFuZA0KPiAgICAg
ICB0cmFuc2xhdGVzIHRoYXQgYWRkcmVzcyB0byBEUEEoMHgwMTIzNDU2NykuDQo+IA0KPiAgICA0
KSBUaGUgZW5kcG9pbnQgZGV2aWNlIHVzZXMgRFBBKDB4MDEyMzQ1NjcpIHRvIGZ1bGZpbGwgdGhl
IHJlcXVlc3QuDQo+IA0KPiBJbiB0aGlzIHNjZW5hcmlvLCBvdXIgZW5kcG9pbnQgaGFzIGEgRFBB
IHJhbmdlIG9mICgwLCAweDEwMDAwMDAwKSwNCj4gYnV0IHRlY2huaWNhbGx5IERQQSBhZGRyZXNz
IHNwYWNlIGlzIGRldmljZS1kZWZpbmVkIGFuZCBtYXkgYmUgc3BhcnNlLg0KPiANCj4gQXMgeW91
IGNhbiBzZWUsIHRoZSByb290IGFuZCBob3N0IGJyaWRnZSBkZWNvZGVycyBzaW1wbHkgInJvdXRl
IiB0aGUNCj4gYWNjZXNzIHRvIHRoZSBuZXh0IGFwcHJvcHJpYXRlIGhvcCwgd2hpbGUgdGhlIGVu
ZHBvaW50IGRlY29kZXIgYWN0dWFsbHkNCj4gZG9lcyB0aGUgdHJhbnNsYXRpb24gd29yay4NCj4g
DQo+IA0KPiBXaGF0IGlmIGluc3RlYWQsIHdlIGhhZCB0d28gMjU2TUIgZW5kcG9pbnRzIG9uIHRo
ZSBzYW1lIGhvc3QgYnJpZGdlPw0KPiANCj4gYGBgDQo+IENFRFQNCj4gICAgICAgICAgICAgU3Vi
dGFibGUgVHlwZSA6IDAxIFtDWEwgRml4ZWQgTWVtb3J5IFdpbmRvdyBTdHJ1Y3R1cmVdDQo+ICAg
ICAgICAgICAgICAgICAgUmVzZXJ2ZWQgOiAwMA0KPiAgICAgICAgICAgICAgICAgICAgTGVuZ3Ro
IDogMDAyQw0KPiAgICAgICAgICAgICAgICAgIFJlc2VydmVkIDogMDAwMDAwMDANCj4gICAgICAg
V2luZG93IGJhc2UgYWRkcmVzcyA6IDAwMDAwMDAxMDAwMDAwMDAgICA8LSBNZW1vcnkgUmVnaW9u
DQo+ICAgICAgICAgICAgICAgV2luZG93IHNpemUgOiAwMDAwMDAwMDIwMDAwMDAwICAgPC0gNTEy
TUINCj4gSW50ZXJsZWF2ZSBNZW1iZXJzICgyXm4pIDogMDAgICAgICAgICAgICAgICAgIDwtIE5v
dCBpbnRlcmxlYXZlZA0KPiANCj4gTWVtb3J5IE1hcDoNCj4gICAgW21lbSAweDAwMDAwMDAxMDAw
MDAwMDAtMHgwMDAwMDAwMTIwMDAwMDAwXSB1c2FibGUgIDwtIFNQQQ0KPiANCj4gRGVjb2RlcnMN
Cj4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNvZGVyMC4wDQo+ICAgICAgICAgICAg
ICAgICAgICByYW5nZT1bMHgxMDAwMDAwMDAsIDB4MTIwMDAwMDAwXQ0KPiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICB8DQo+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVj
b2RlcjEuMA0KPiAgICAgICAgICAgICAgICAgICAgcmFuZ2U9WzB4MTAwMDAwMDAwLCAweDEyMDAw
MDAwMF0NCj4gICAgICAgICAgICAgICAgICAgIC8gICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBcDQo+ICAgICAgICAgICAgICBkZWNvZGVkMi4wICAgICAgICAgICAgICAgICAgICAgICAgZGVj
b2RlcjMuMA0KPiAgICByYW5nZT1bMHgxMDAwMDAwMDAsIDB4MTEwMDAwMDAwXSAgIHJhbmdlPVsw
eDExMDAwMDAwMCwgMHgxMjAwMDAwMDBdDQo+IGBgYA0KPiANCj4gV2Ugc3RpbGwgb25seSBoYXZl
IGEgc2luZ2xlIHJvb3QgcG9ydCBhbmQgaG9zdCBicmlkZ2UgZGVjb2RlciB0aGF0DQo+IGNvdmVy
cyB0aGUgZW50aXJlIDUxMk1CIHJhbmdlLCBidXQgdGhlcmUgYXJlIG5vdyAyIGRpZmZlcmVudGx5
DQo+IHByb2dyYW1tZWQgZW5kcG9pbnQgZGVjb2RlcnMuDQo+IA0KPiBUaGlzIG1ha2VzIHRoZSBy
b3V0aW5nIGEgbGl0dGxlIG1vcmUgb2J2aW91cy4gIFRoZSByb290IGFuZCBob3N0IGJyaWRnZQ0K
PiBkZWNvZGVycyBjb3ZlciB0aGUgZW50aXJlIFNQQSBzcGFjZSAoNTEyTUIpLCB3aGlsZSB0aGUg
ZW5kcG9pbnQgZGVjb2RlcnMNCj4gb25seSBjb3ZlciB0aGVpciBvd24gYWRkcmVzcyBzcGFjZSAo
MjU2TUIpLg0KPiANCj4gVGhlIGhvc3QgYnJpZGdlIGluIHRoaXMgY2FzZSBpcyByZXNwb25zaWJs
ZSBmb3Igcm91dGluZyB0aGUgcmVxdWVzdCB0bw0KPiB0aGUgY29ycmVjdCBlbmRwb2ludC4NCj4g
DQo+IA0KPiBXaGF0IGlmIHdlIGhhZCAyIGVuZHBvaW50cywgZWFjaCBhdHRhY2hlZCB0byB0aGVp
ciBvd24gaG9zdCBicmlkZ2VzPw0KPiBJbiB0aGlzIGNhc2UgV2UnZCBoYXZlIDIgcm9vdCBwb3J0
cyBhbmQgaG9zdCBicmlkZ2UgZGVjb2RlcnMuDQo+IA0KPiBgYGANCj4gQ0VEVA0KPiAgICAgICAg
ICAgICBTdWJ0YWJsZSBUeXBlIDogMDEgW0NYTCBGaXhlZCBNZW1vcnkgV2luZG93IFN0cnVjdHVy
ZV0NCj4gICAgICAgICAgICAgICAgICBSZXNlcnZlZCA6IDAwDQo+ICAgICAgICAgICAgICAgICAg
ICBMZW5ndGggOiAwMDJDDQo+ICAgICAgICAgICAgICAgICAgUmVzZXJ2ZWQgOiAwMDAwMDAwMA0K
PiAgICAgICBXaW5kb3cgYmFzZSBhZGRyZXNzIDogMDAwMDAwMDEwMDAwMDAwMCAgIDwtIE1lbW9y
eSBSZWdpb24gMQ0KPiAgICAgICAgICAgICAgIFdpbmRvdyBzaXplIDogMDAwMDAwMDAxMDAwMDAw
MCAgIDwtIDI1Nk1CDQo+IEludGVybGVhdmUgTWVtYmVycyAoMl5uKSA6IDAwICAgICAgICAgICAg
ICAgICA8LSBOb3QgaW50ZXJsZWF2ZWQNCj4gICAgICAgICAgICAgIEZpcnN0IFRhcmdldCA6IDAw
MDAwMDA3ICAgICAgICAgICA8LSBIb3N0IEJyaWRnZSBfVUlEDQo+IA0KPiAgICAgICAgICAgICBT
dWJ0YWJsZSBUeXBlIDogMDEgW0NYTCBGaXhlZCBNZW1vcnkgV2luZG93IFN0cnVjdHVyZV0NCj4g
ICAgICAgICAgICAgICAgICBSZXNlcnZlZCA6IDAwDQo+ICAgICAgICAgICAgICAgICAgICBMZW5n
dGggOiAwMDJDDQo+ICAgICAgICAgICAgICAgICAgUmVzZXJ2ZWQgOiAwMDAwMDAwMA0KPiAgICAg
ICBXaW5kb3cgYmFzZSBhZGRyZXNzIDogMDAwMDAwMDExMDAwMDAwMCAgIDwtIE1lbW9yeSBSZWdp
b24gMQ0KPiAgICAgICAgICAgICAgIFdpbmRvdyBzaXplIDogMDAwMDAwMDAxMDAwMDAwMCAgIDwt
IDI1Nk1CDQo+IEludGVybGVhdmUgTWVtYmVycyAoMl5uKSA6IDAwICAgICAgICAgICAgICAgICA8
LSBOb3QgaW50ZXJsZWF2ZWQNCj4gICAgICAgICAgICAgIEZpcnN0IFRhcmdldCA6IDAwMDAwMDA2
ICAgICAgICAgICA8LSBIb3N0IEJyaWRnZSBfVUlEDQo+IA0KPiBNZW1vcnkgTWFwIC0gdGhpcyBt
YXkgb3IgbWF5IG5vdCBiZSBjb2xsYXBzZWQgZGVwZW5kaW5nIG9uIExpbnV4IGFyY2gNCj4gICAg
W21lbSAweDAwMDAwMDAxMDAwMDAwMDAtMHgwMDAwMDAwMTEwMDAwMDAwXSB1c2FibGUgIDwtIFN5
c3RlbSBQaHlzIEFkZHJlc3MNCj4gICAgW21lbSAweDAwMDAwMDAxMTAwMDAwMDAtMHgwMDAwMDAw
MTIwMDAwMDAwXSB1c2FibGUgIDwtIFN5c3RlbSBQaHlzIEFkZHJlc3MNCj4gDQo+IERlY29kZXJz
DQo+ICAgICAgICAgICAgICBkZWNvZGVyMC4wICAgICAgICAgICAgICAgICAgICAgZGVjb2RlcjEu
MCAgIC0gcm9vdHMNCj4gICAgICBbMHgxMDAwMDAwMDAsIDB4MTEwMDAwMDAwXSAgICAgWzB4MTEw
MDAwMDAwLCAweDEyMDAwMDAwMF0NCj4gICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgfA0KPiAgICAgICAgICAgICAgZGVjb2RlcjIuMCAgICAgICAgICAgICAg
ICAgICAgIGRlY29kZXIzLjAgICAtIGhvc3QgYnJpZGdlcw0KPiAgICAgIFsweDEwMDAwMDAwMCwg
MHgxMTAwMDAwMDBdICAgICBbMHgxMTAwMDAwMDAsIDB4MTIwMDAwMDAwXQ0KPiAgICAgICAgICAg
ICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8DQo+ICAgICAgICAgICAgICBk
ZWNvZGVyNC4wICAgICAgICAgICAgICAgICAgICAgZGVjb2RlcjUuMCAgIC0gZW5kcG9pbnRzDQo+
ICAgICAgWzB4MTAwMDAwMDAwLCAweDExMDAwMDAwMF0gICAgIFsweDExMDAwMDAwMCwgMHgxMjAw
MDAwMDBdDQo+IGBgYA0KPiANCj4gVGhpcyBzY2VuYXJpbyBsb29rcyBmdW5jdGlvbmFsbHkgc2Ft
ZSBhcyB0aGUgZmlyc3QgLSB3aXRoIHR3byBkaXN0aW5jdCwNCj4gbm9uLW92ZXJsYXBwaW5nIHNl
dHMgb2YgZGVjb2RlcnMgKGFueSBnaXZlbiBTUEEgbWF5IG9ubHkgYmUgc2VydmljZXMgYnkNCj4g
b25lIGRldmljZSkuICBUaGUgcGxhdGZvcm0gbWVtb3J5IGNvbnRyb2xsZXIgaXMgcmVzcG9uc2li
bGUgZm9yIHJvdXRpbmcNCj4gdGhlIGFkZHJlc3MgdG8gdGhlIGNvcnJlY3Qgcm9vdCBkZWNvZGVy
Lg0KPiANCj4gSW4gU2VjdGlvbiA0IChJbnRlcmxlYXZlKSB3ZSdsbCBkaXNjdXNzIGEgYml0IGhv
dyB0aGUgaW50ZXJsZWF2ZSBpcw0KPiBhY2NvbXBsaXNoZWQgLSBhcyB0aGlzIGRlcGVuZHMgd2hl
dGhlciB5b3UgYXJlIGludGVybGVhdmluZyBhY3Jvc3MNCj4gaG9zdCBicmlkZ2VzIChhZ2dyZWdh
dGlvbikgb3Igd2l0aGluIGEgaG9zdCBicmlkZ2UgKGJpZnVyY2F0aW9uKS4NCj4gDQo+IA0KPiAN
Cj4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQo+IE51YW5j
ZTogSG9zdCBQaHlzaWNhbCBBZGRyZXNzLi4uIHRyYW5zbGF0aW9uPw0KPiAtLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCj4gDQo+IFlvdSBtaWdodCBoYXZlIG5v
dGljZWQgdGhhdCBhbGwgdGhlIGFkZHJlc3NlcyBpbiB0aGUgZXhhbXBsZXMgSSBzaG93ZWQNCj4g
YXJlIGRpcmVjdCBzdWJzZXRzIG9mIHRoZWlyIHBhcmVudCBkZWNvZGVyIGFkZHJlc3MgcmFuZ2Vz
LiAgVGhlIHJvb3QgaXMNCj4gYXNzaWduZWQgYSBTeXN0ZW0gUGh5c2ljYWwgQWRkcmVzcyBhY2Nv
cmRpbmcgdG8gdGhlIHN5c3RlbSBtZW1vcnkgbWFwLA0KPiBhbmQgYWxsIGRlY29kZXJzIHVuZGVy
IGl0IGFyZSBhIHN1YnNldCBvZiB0aGF0IHJhbmdlLg0KPiANCj4gWW91IG1heSBoYXZlIGV2ZW4g
bm90aWNlZCByb3V0aW5nIHN0ZXBzIHN1ZGRlbmx5IGNoYW5nZSBmcm9tIFNQQSB0byBIUEENCj4g
DQo+ICAgIDApIENQVSBhY2Nlc3NlcyBTUEEoMHgxMDEyMzQ1NjcpDQo+IA0KPiAgICAxKSByb290
IGRlY29kZXIgaWRlbnRpZmllcyBIUEEoMHgxMDEyMzQ1NjcpIGlzIHZhbGlkIGFuZCBmb3J3YXJk
cw0KPiAgICAgICB0byBob3N0IGJyaWRnZSBhc3NvY2lhdGVkIHdpdGggdGhhdCBhZGRyZXNzIChw
b3J0IDEpDQo+IA0KPiBTbyB3aGF0IHRoZSBoZWNrIGlzIGEgIkhvc3QgUGh5c2ljYWwgQWRkcmVz
cyI/DQo+IFdoeSBpc24ndCBldmVyeXRoaW5nIGp1c3QgZGVzY3JpYmVkIGFzIGEgIlN5c3RlbSBQ
aHlzaWNhbCBBZGRyZXNzIj8NCj4gDQo+IENYTCBIRE0gZGVjb2RlcnMgKmRlZmluaXRpb25hbGx5
KiBoYW5kbGUgSFBBIHRvIERQQSB0cmFuc2xhdGlvbnMuDQo+IA0KPiBUaGF0J3MgaXQsIHRoYXQn
cyB0aGUgZGVmaW5pdGlvbiBvZiBhbiBIUEEuDQo+IA0KPiBPbiBNT1NUIHN5c3RlbXMsIHdoYXQg
eW91IHNlZSBpbiB0aGUgbWVtb3J5IG1hcCBpcyBhbiBTUEEsIGFuZCBTUEE9SFBBLA0KPiBzbyBh
bGwgdGhlIGRlY29kZXJzIHdpbGwgYXBwZWFyIHRvIGJlIHByb2dyYW1tZWQgd2l0aCBTUEEuICBU
aGUgcGxhdGZvcm0NCj4gTUFZIHBlcmZvcm0gdHJhbnNsYXRpb24gYmVmb3JlIGEgcmVxdWVzdCBp
cyByb3V0ZWQgdG8gZGVjb2RlciBjb21wbGV4Lg0KPiANCj4gSSB3aWxsIGNvdmVyIGFuIGV4YW1w
bGUgb2YgdGhpcyBpbi1kZXB0aCBpbiBhbiBpbnRlcmxlYXZlIGFkZGVuZHVtLg0KPiANCj4gU28g
dGhlIGFuc3dlciBpcyB0aGF0IHNvbWUgYW1iaWd1aXR5IGV4aXN0cyByZWdhcmRpbmcgd2hldGhl
ciBwbGF0Zm9ybXMNCj4gY2FuL3Nob3VsZCBkbyB0cmFuc2xhdGlvbiBwcmlvciB0byBIRE0gZGVj
b2RlcnMgZXZlbiBiZWluZyB1dGlsaXplZC4gIFNvDQo+IGZvciB0aGUgc2FrZSBvZiBtYWtpbmcg
ZXZlcnl0aGluZyBtb3JlIGNvbXBsaWNhdGVkIGFuZCBjb25mdXNpbmcgZm9yIHZlcnkNCj4gbGl0
dGxlIHZhbHVlOg0KPiANCj4gMSkgZGVjb2RlcnMgZGVmaW5pdGlvbmFsbHkgZG8gIkhQQSB0byBE
UEEiIHRyYW5zbGF0aW9uDQo+IDIpIG1vc3Qgb2YgdGhlIHRpbWUgIlNQQT1IUEEiDQo+IDMpIHNv
IGRlY29kZXJzIG1vc3RseSBkbyAiU1BBIHRvIERQQSIgdHJhbnNsYXRpb24NCj4gDQo+IElmIHlv
dSdyZSBjb25mdXNlZCwgdGhhdCdzIG9rLCBJIHdhcyB0b28gLSBhbmQgc3RpbGwgYW0uICBCdXQg
SG9wZWZ1bGx5DQo+IGJldHdlZW4gdGhpcyBzZWN0aW9uIGFuZCBTZWN0aW9uIDQgKEludGVybGVh
dmUpIHdlIGNhbiBiZSBtYXJnaW5hbGx5DQo+IGxlc3MgY29uZnVzZWQgdG9nZXRoZXIuDQo+IA0K
PiANCj4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCj4g
TnVhbmNlOiBNZW1vcnkgSG9sZXMgYW5kIEhvdHBsdWcgTWVtb3J5IEJsb2NrcyENCj4gLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCj4gSGVscCwgQklPUyBz
cGxpdCBteSBtZW1vcnkgZGV2aWNlIGFjcm9zcyBub24tY29udGlndW91cyBtZW1vcnkgcmVnaW9u
cyENCj4gDQo+IGBgYA0KPiBDRURUDQo+ICAgICAgICAgICAgIFN1YnRhYmxlIFR5cGUgOiAwMSBb
Q1hMIEZpeGVkIE1lbW9yeSBXaW5kb3cgU3RydWN0dXJlXQ0KPiAgICAgICAgICAgICAgICAgIFJl
c2VydmVkIDogMDANCj4gICAgICAgICAgICAgICAgICAgIExlbmd0aCA6IDAwMkMNCj4gICAgICAg
ICAgICAgICAgICBSZXNlcnZlZCA6IDAwMDAwMDAwDQo+ICAgICAgIFdpbmRvdyBiYXNlIGFkZHJl
c3MgOiAwMDAwMDAwMTAwMDAwMDAwICAgPC0gTWVtb3J5IFJlZ2lvbiAxDQo+ICAgICAgICAgICAg
ICAgV2luZG93IHNpemUgOiAwMDAwMDAwMDgwMDAwMDAwICAgPC0gMTI4TUINCj4gSW50ZXJsZWF2
ZSBNZW1iZXJzICgyXm4pIDogMDAgICAgICAgICAgICAgICAgIDwtIE5vdCBpbnRlcmxlYXZlZA0K
PiAgICAgICAgICAgICAgRmlyc3QgVGFyZ2V0IDogMDAwMDAwMDcgICAgICAgICAgIDwtIEhvc3Qg
QnJpZGdlIF9VSUQNCj4gDQo+IENFRFQNCj4gICAgICAgICAgICAgU3VidGFibGUgVHlwZSA6IDAx
IFtDWEwgRml4ZWQgTWVtb3J5IFdpbmRvdyBTdHJ1Y3R1cmVdDQo+ICAgICAgICAgICAgICAgICAg
UmVzZXJ2ZWQgOiAwMA0KPiAgICAgICAgICAgICAgICAgICAgTGVuZ3RoIDogMDAyQw0KPiAgICAg
ICAgICAgICAgICAgIFJlc2VydmVkIDogMDAwMDAwMDANCj4gICAgICAgV2luZG93IGJhc2UgYWRk
cmVzcyA6IDAwMDAwMDAxMTAwMDAwMDAgICA8LSBNZW1vcnkgUmVnaW9uIDENCj4gICAgICAgICAg
ICAgICBXaW5kb3cgc2l6ZSA6IDAwMDAwMDAwODAwMDAwMDAgICA8LSAxMjhNQg0KPiBJbnRlcmxl
YXZlIE1lbWJlcnMgKDJebikgOiAwMCAgICAgICAgICAgICAgICAgPC0gTm90IGludGVybGVhdmVk
DQo+ICAgICAgICAgICAgICBGaXJzdCBUYXJnZXQgOiAwMDAwMDAwNyAgICAgICAgICAgPC0gSG9z
dCBCcmlkZ2UgX1VJRA0KPiANCj4gTWVtb3J5IE1hcA0KPiAgICBbbWVtIDB4MDAwMDAwMDEwMDAw
MDAwMC0weDAwMDAwMDAxMDdGRkZGRkZdIHVzYWJsZSAgPC0gU1BBDQo+ICAgIFttZW0gMHgwMDAw
MDAwMTA4MDAwMDAwLTB4MDAwMDAwMDEwRkZGRkZGRl0gcmVzZXJ2ZWQNCj4gICAgW21lbSAweDAw
MDAwMDAxMTAwMDAwMDAtMHgwMDAwMDAwMTE4MDAwMDAwXSB1c2FibGUgIDwtIFNQQQ0KPiBgYGAN
Cj4gDQo+IFRha2UgYSBicmVhdGguIEV2ZXJ5dGhpbmcgd2lsbCBiZSBvay4NCj4gDQo+IFlvdSBj
YW4gaGF2ZSBtdWx0aXBsZSBkZWNvZGVycyBhdCBlYWNoIHBvaW50IGluIHRoZSBkZWNvZGVyIGNv
bXBsZXghDQo+IChNb3N0IGRldmljZXMgc2hvdWxkIGltcGxlbWVudCBmb3IgbXVsdGlwbGUgZGVj
b2RlcnMpLg0KPiANCj4gYGBgDQo+IERlY29kZXJzDQo+ICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBSb290IFBvcnQgMA0KPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvICAg
ICAgICAgIFwNCj4gICAgICAgICAgICAgICAgICAgICAgZGVjb2RlcjAuMCAgICAgICAgICBkZWNv
ZGVyMC4xDQo+ICAgICAgWzB4MTAwMDAwMDAwLCAweDEwODAwMDAwMF0gICAgICAgICAgWzB4MTEw
MDAwMDAwLCAweDExODAwMDAwMF0NCj4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCAg
ICAgICAgICAvDQo+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSG9zdCBCcmlkZ2UgNw0K
PiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvICAgICAgICAgIFwNCj4gICAgICAgICAg
ICAgICAgICAgICAgZGVjb2RlcjEuMCAgICAgICAgICBkZWNvZGVyMS4xDQo+ICAgICAgWzB4MTAw
MDAwMDAwLCAweDEwODAwMDAwMF0gICAgICAgICAgWzB4MTEwMDAwMDAwLCAweDExODAwMDAwMF0N
Cj4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCAgICAgICAgICAvDQo+ICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBFbmRwb2ludCAwDQo+ICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIC8gICAgICAgICAgXA0KPiAgICAgICAgICAgICAgICAgICAgICBkZWNvZGVyMi4w
ICAgICAgICAgIGRlY29kZXIyLjENCj4gICAgICBbMHgxMDAwMDAwMDAsIDB4MTA4MDAwMDAwXSAg
ICAgICAgICBbMHgxMTAwMDAwMDAsIDB4MTE4MDAwMDAwXQ0KPiBgYGANCj4gDQo+IElmIHlvdXIg
QklPUyBhZGRzIGEgbWVtb3J5IGhvbGUsIGl0IGJldHRlciBhbHNvIHVzZSBtdWx0aXBsZSBkZWNv
ZGVycy4NCj4gDQo+IE9oLCB3YWl0LCBTZWN0aW9uIDIgYW5kIFNlY3Rpb24gMyBhbGx1ZGUgdG8g
aG90cGx1ZyBtZW1vcnkgYmxvY2tzDQo+IGhhdmluZyBzaXplIGFuZCBhbGlnbm1lbnQgaXNzdWVz
IQ0KPiANCj4gSWYgeW91ciBCSU9TIGFkZHMgYSBtZW1vcnkgaG9sZSwgaXQgYmV0dGVyIGFsc28g
ZG8gaXQgb24gTGludXggaG90cGx1Zw0KPiBtZW1vcnkgYmxvY2sgYWxpZ25tZW50ICgyR0Igb24g
eDg2KSBvciB5b3UnbGwgbG9zZSAxIGhvdHBsdWcgbWVtb3J5DQo+IGJsb2NrIG9mIGNhcGFjaXR5
IHBlciBDRk1XUy4NCj4gDQo+IE9pLCB0YWxrIGFib3V0IHNvbWUgcm91Z2ggZWRnZXMsIHJpZ2h0
PyA6Ww0KPiANCj4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQo+IE51
YW5jZTogQklPUyB2cyBPUyBQcm9ncmFtbWVkIERlY29kZXJzLg0KPiAtLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCj4gVGhlIGRyaXZlciBjYW4gKGFuZCBkb2VzKSBwcm9n
cmFtIHRoZXNlIGRlY29kZXJzLiAgSG93ZXZlciwgaXQncw0KPiBlbnRpcmVseSBub3JtYWwgZm9y
IEJJT1MvRUZJIHRvIHByb2dyYW0gZGVjb2RlcnMgcHJpb3IgdG8gT1MgaW5pdC4NCj4gDQo+IEVh
cmxpZXIgaW4gc2VjdGlvbiAyIEkgc2FpZDoNCj4gICAgTW9zdCBhc3NvY2lhdGlvbnMgYnVpbHQg
YnkgdGhlIGRyaXZlciBhcmUgZG9uZSBieSB2YWxpZGF0aW5nIGRlY29kZXJzDQo+IA0KPiBXaGF0
IEkgbWVhbnQgYnkgdGhpcyBpcyB0aGUgZHJpdmVyIGRvZXMgb25lIG9mIHR3byB0aGluZ3Mgd2l0
aCBkZWNvZGVyczoNCj4gDQo+ICAgICAxKSBEZXRlY3RzIEJJT1MgcHJvZ3JhbW1lZCBkZWNvZGVy
cyBhbmQgc2FuaXR5IGNoZWNrcyB0aGVtLg0KPiAgICAgICAgSWYgYW4gdW5leHBlY3RlZCBjb25m
aWd1cmF0aW9uIGlzIGZvdW5kLCBpdCBiYWlscyBvdXQuDQo+ICAgICAgICBUaGlzIG1lbW9yeSBp
cyBub3QgYWNjZXNzaWJsZSBpZiBFRklfTUVNT1JZX1NQIGlzIHNldC4NCj4gDQo+ICAgICAyKSBQ
cm92aWRlIGFuIGludGVyZmFjZSBmb3IgdXNlciBwb2xpY3kgY29uZmlndXJhdGlvbiBvZiB0aGUg
ZGVjb2RlcnMNCj4gDQo+IEZvciB0aGUgbW9zdCBwYXJ0LCB0aGUgbWVjaGFuaXNtIGlzIHRoZSBz
YW1lLiAgVGhpcyBjYXJ2ZS1vdXQgaXMgdG8gdGVsbA0KPiB5b3UgaWYgc29tZXRoaW5nIGlzbid0
IHdvcmtpbmcsIHlvdSBzaG91bGQgY2hlY2sgd2hldGhlciB0aGUgQklPUy9FRkkgb3INCj4gZHJp
dmVyIHByb2dyYW1tZWQgdGhlIGRlY29kZXJzLiBJdCB3aWxsIGhlbHAgZGVidWcgdGhlIGlzc3Vl
IHF1aWNrZXIuDQo+IA0KPiAgICAgICAgICBJbiBteSBleHBlcmllbmNlLCBpdCdzIFVTVUFMTFkg
YSBiYWQgQUNQSSB0YWJsZS4NCj4gDQo+IFRoaXMgZGlzdGluY3Rpb24gd2lsbCBiZSBtb3JlIGlt
cG9ydGFudCBpbiBTZWN0aW9uIDQgKEludGVybGVhdmUpIHdoZW4NCj4gd2UgZGlzY3VzcyBJbnRl
ci1Ib3N0LUJyaWRnZSBhbmQgSW50cmEtSG9zdC1CcmlkZ2UgaW50ZXJsZWF2ZS4NCj4gDQo+IH5H
cmVnb3J5DQo+IA==

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from zg8tmja5ljk3lje4ms43mwaa.icoremail.net (zg8tmja5ljk3lje4ms43mwaa.icoremail.net [209.97.181.73])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 5330954F8C;
	Fri,  7 Mar 2025 02:20:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.97.181.73
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741314051; cv=none; b=VfTDM0m/bed8NPh1rvins9FPb4smiatWiP4lljfNw3IJKEjXdqWc3OEe0HafjyKqXDqMGvteokd+dA2R1MyemlaKvBMcU1mZAzGPVEc8u2zNEsMJFeorMTCruDsAasZHmNWA5qm5vd7GK0wjMAF4MAt+aTsdNwx2z2Qd8wdEsZo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741314051; c=relaxed/simple;
	bh=+6tLDls9EW0FXKL38bYFqrjcRNcCPuJlju4ebK2g2rQ=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=GZhlpbHmk32YpxNtQm9kkynH6H0KKfMthlrolhlEJSfb7V0zfvZkUBNfuIrzNJ+s4AA3iHcdjlycik1hVnwToFObXGrjlTg6b4MDTXXe3Y61aoycCI3BV9RuIptB8nFuzNNxyW1j1M8Neq/pGo571m++ozlF4jquzy2Dfy2TTiI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn; spf=pass smtp.mailfrom=phytium.com.cn; arc=none smtp.client-ip=209.97.181.73
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=phytium.com.cn
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=phytium.com.cn
Received: from prodtpl.icoremail.net (unknown [10.12.1.20])
	by hzbj-icmmx-7 (Coremail) with SMTP id AQAAfwAnL2vxV8pnbl5XBw--.55623S2;
	Fri, 07 Mar 2025 10:20:33 +0800 (CST)
Received: from localhost (unknown [123.150.8.50])
	by mail (Coremail) with SMTP id AQAAfwBXW4fwV8pnU589AA--.4347S2;
	Fri, 07 Mar 2025 10:20:32 +0800 (CST)
Date: Fri, 7 Mar 2025 10:20:31 +0800
From: Yuquan Wang <wangyuquan1236@phytium.com.cn>
To: Gregory Price <gourry@gourry.net>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8pX786s+1DQIMDy@phytium.com.cn>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <Z8j8bZ5TS+gDV8+M@phytium.com.cn>
 <Z8nWobZXQwhtE1nK@gourry-fedora-PF4VCD3F>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z8nWobZXQwhtE1nK@gourry-fedora-PF4VCD3F>
X-CM-TRANSID: AQAAfwBXW4fwV8pnU589AA--.4347S2
X-CM-SenderInfo: 5zdqw5pxtxt0arstlqxsk13x1xpou0fpof0/1tbiAQABAWfIrdcBhQBJsZ
Authentication-Results: hzbj-icmmx-7; spf=neutral smtp.mail=wangyuquan
	1236@phytium.com.cn;
X-Coremail-Antispam: 1Uk129KBjvJXoWxGw4xXr1rJrW5Zw4rZr4kXrb_yoW5Gw18pr
	WDKF92kFs8try7CFn2gw42g34FyFWvkFWUJryFgrWUGF98ur1Fqr4rKF1q9Fyxur4UAF1j
	v3yktw13Xa4Y9aDanT9S1TB71UUUUU7qnTZGkaVYY2UrUUUUj1kv1TuYvTs0mT0YCTnIWj
	DUYxn0WfASr-VFAU7a7-sFnT9fnUUIcSsGvfJ3UbIYCTnIWIevJa73UjIFyTuYvj4RJUUU
	UUUUU
Status: O
Content-Length: 2743
Lines: 70

On Thu, Mar 06, 2025 at 12:08:49PM -0500, Gregory Price wrote:
> On Thu, Mar 06, 2025 at 09:37:49AM +0800, Yuquan Wang wrote:
> > On Wed, Mar 05, 2025 at 05:20:52PM -0500, Gregory Price wrote:
> 
> First, thank you for bringing this up, this is exactly the type of
> ambiguiuty i was hoping others would contribute.  It's difficult to
> figure out if the ACPI tables are "Correct", if there's unimplemented
> features, or we're doing something wrong - because some of this is
> undocumented theory of operation.
> 
Thank you for your patience in replying my questions. :)
> > > ==================
> > > NUMA node creation
> > > ===================
> > > NUMA nodes are *NOT* hot-pluggable.  All *POSSIBLE* NUMA nodes are
> > > identified at `__init` time, more specifically during `mm_init`.
> > > 
> > > What this means is that the CEDT and SRAT must contain sufficient
> > > `proximity domain` information for linux to identify how many NUMA
> > > nodes are required (and what memory regions to associate with them).
> > > 
> > Condition:
> > 1) A UMA/NUMA system that SRAT is absence, but it keeps CEDT.CFMWS
> > 2Enable CONFIG_ACPI_NUMA
> > 
> > Results:
> > 1) acpi_numa_init: the fake_pxm will be 0 and send to acpi_parse_cfmws()
> > 2If dynamically create cxl ram region, the cxl memory would be assigned
> > to node0 rather than a fake new node.
> >
> 
> This is very interesting.  Can I ask a few questions:
> 
> 1) is this real hardware or a VM?
Qemu VM (arm64 virt).
> 2) By `dynamic creation` you mean leveraging cxl-cli (ndctl)?
Yes. After boot, I used "cxl create-region". 
> 2a) Is the BIOS programming decoders, or are you programming the
>     decoder after boot?
Program the decoder after boot. It seems like currently bios for qemu could
not programm cxl both on x86(q35) and arm64(virt). I am trying to find a
cxl-enable bios for qemu virt to do some test.
> 
> 
> > Confusions:
> > 1) Does CXL memory usage require a numa system with SRAT? As you
> > mentioned in SRAT section: 
> > 
> > "This table is technically optional, but for performance information
> > to be enumerated by linux it must be present."
> > 
> > Hence, as I understand it, it seems a bug in kernel.
> >
> 
> It's hard to say if this is a bug yet.  It's either a bug, or your
> system should have an SRAT to describe what the BIOS has done.
> 
> > 2) If it is a bug, could  we forbid this situation by adding fake_pxm
> > check and returning error in acpi_numa_init()?
> > 
> 
> > 3If not,  maybe we can add some kernel logic to allow create these fake
> > nodes on a system without SRAT?
> > 
> 
> I think we should at least provide a warning (if the SRAT is expected
> but missing) - but lets get some more information first.
> 
> ~Gregory


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f53.google.com (mail-qv1-f53.google.com [209.85.219.53])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 66E4A21C185
	for <linux-cxl@vger.kernel.org>; Fri,  7 Mar 2025 15:08:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.53
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741360085; cv=none; b=urgW1GDhgL6n2+wgfcBUnlE/BNIrlVV3M5TfSTqZ1TL619R0xTUF2y1GeYrVjxdc+/uxZ8rBr/FsN6AouFKVUpTrp1GzdnS07/f2LANvq3nHDn5CXGNZg/KcwFRV/Snedq/LNd9ofZlUg5zF3HYp5mQvPtr2O1ipEiP22Dx/2GY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741360085; c=relaxed/simple;
	bh=1J/ql49X6Ezkg4wdoqe/stSQpbv40JqkSw4Ir5aIPhY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=p+a/fHVSA8y7te1wjABtAsxHpf2oYvTQb0HK6nQwSlc0klHDYBi67U2dB96p1Je4RE9lZaCP/1cpmxUIRhw3WfEaEiv/OTqH9ndD6da9BjfgVaIr75ctrAZtvLA4eewjRdyE7JO15DUqBQnECVkFpoVYLc2z+vpbje5Bi1+S5DE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=UytmtL+R; arc=none smtp.client-ip=209.85.219.53
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="UytmtL+R"
Received: by mail-qv1-f53.google.com with SMTP id 6a1803df08f44-6e41e17645dso17540516d6.2
        for <linux-cxl@vger.kernel.org>; Fri, 07 Mar 2025 07:08:02 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741360082; x=1741964882; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=AwqxWi0iWrXCwX2xmbnqF8uYYDlpSjPvCpbbjIDyPjI=;
        b=UytmtL+R6s5NNmC0nGk7OLaoQw/wzi+qRAjNsvG/pFGvjbwlVQTyQxLbIVowUCfYEp
         NmSp4IzQRN7BxzDdCTGU5S6QGVf6co6exRSWL8u6HIa/unBFHh2CDifmBwFNPmuu8abu
         gst5Cxpga6TRvn5bl9/vzblDpm/xvWtEvr8CjpfDjFAkC7853Ys8UIlhed9Y+NSMALaq
         Y1XrJ2r1FSyHq/R8ZyCG0sdtgxb20B8JJ+pE2lXPdgHuxWw41drGMYpsuGkKEzhDxPAT
         CvtOVRVUDEXfegow0GA1V8FCbzoGfzpfmXOwMG/FmKf1alWL8WhoCoT/opzmo8urmEga
         /uLw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741360082; x=1741964882;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=AwqxWi0iWrXCwX2xmbnqF8uYYDlpSjPvCpbbjIDyPjI=;
        b=tM78ciPqRmRIv2PucjcmeVJBA5536xNBr5UaZUWZR3aWYVWmfBTaoAWiLPlWRQWkBR
         j1DyeIH7QIRtBivXj+i/r3q78GiuF8gz5KdMx1AQ5LOxaecEVFKGDfJTJHOMqhpO4/RN
         IFemDIfJm9232YreMMHeV3hqEDbyyj1UtEvGAoYinZVS0fJYvHWhc7CZRyvDhpXKfUJs
         LRbXLDqCgFVCKgYTIqVN5RzX23ZlCSbhmQYaNguT5kPLSWS024SyhEmhvQiCauOfjRdM
         7DKhpU64s3MeMcGgl7htcn1fwUkBNaQWaOfDL3A45DCOm/Sh/wD+bahmM9Ez32/H6VUB
         Cv4g==
X-Forwarded-Encrypted: i=1; AJvYcCXJ8kMUmzRBAJlDZdzyasFTPkdc/ivQvogYSm4GAIICnA7xfNrVrG+x53DZQBDRplB8kzfvQKZTeQg=@vger.kernel.org
X-Gm-Message-State: AOJu0YzSpKZ4FEFk6lTfdanBVsIMVTWcdh+ZPqMzw+iadnerlSlWb4PY
	3CQMF8TaWjjg2ueQZhG938y58dc9t+X6lt6BGvD2NZRpNbPcVree+1naUd8I+DU=
X-Gm-Gg: ASbGncsRONEvsSYfPCrHUh+FX3zhCF9Fosh54+WAsVD4zCgmnw8zp9twUttfIecWSOm
	obZh6OElSLH7Qbxc5XCAkzm5JdWJlLQ5FPkf8mp7u2RuSDDWzb+iP/QIPh48+JoZ0sCmmCgfs1q
	+VL888SX8WFZ76DN0Hm+mrjjXTFVnsrfLJv+XpH7UWrr2hGaJ/bVX0C6JGAeGB3sD1shwzjhROb
	kDub5CRbkCAUHoAqdV2vS1XawAeplUrUV1t840khNgda09pr34h5DVus+8YvEh3k9zITMydwJY1
	g/Q9c9haOjKdJF5CQ47zTUmWo5IVuBz3fxF8oegmeA6iYy/F179s7ttiolUIhdqYjIoG5unTmUm
	ISzTno4orkjhMo/Xz76Z8Ljd950I=
X-Google-Smtp-Source: AGHT+IHFXN/P02s1v98zyEbqxwhlOPUAeqTTE2dEMUqC5SvXHpnKWulc9lagDpP21FJm9Hmt5sZqBQ==
X-Received: by 2002:a05:6214:daa:b0:6e6:646e:a0f8 with SMTP id 6a1803df08f44-6e9005f899emr45138866d6.16.1741360081484;
        Fri, 07 Mar 2025 07:08:01 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e8f70a447asm20414876d6.54.2025.03.07.07.08.00
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 07 Mar 2025 07:08:01 -0800 (PST)
Date: Fri, 7 Mar 2025 10:07:58 -0500
From: Gregory Price <gourry@gourry.net>
To: "Zhijian Li (Fujitsu)" <lizhijian@fujitsu.com>
Cc: "lsf-pc@lists.linux-foundation.org" <lsf-pc@lists.linux-foundation.org>,
	"linux-mm@kvack.org" <linux-mm@kvack.org>,
	"linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
	"linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Subject: Re: CXL Boot to Bash - Section 2a (Drivers): CXL Decoder Programming
Message-ID: <Z8sLznxBkJHWeTvQ@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z6OMcLt3SrsZjgvw@gourry-fedora-PF4VCD3F>
 <Z8o2HfVd0P_tMhV2@gourry-fedora-PF4VCD3F>
 <570b18f4-3790-4e57-8d80-a5301e5d8af2@fujitsu.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <570b18f4-3790-4e57-8d80-a5301e5d8af2@fujitsu.com>
Status: O
Content-Length: 3003
Lines: 87

On Fri, Mar 07, 2025 at 12:57:18AM +0000, Zhijian Li (Fujitsu) wrote:
> > In section 2, I referenced a simple device-to-decoder mapping:
> > 
> >      root    ---  decoder0.0   -- Root Port Decoder
> >       |               |
> >     port1    ---  decoder1.0   -- Host Bridge Decoder
> >       |               |
> >    endpoint0 ---  decoder2.0   -- Endpoint Decoder
> 
> Here, I noticed something that differs slightly from my understanding:
> "root --- decoder0.0 -- Root Port Decoder."
> 
>  From the perspective of the Linux Driver, decoder0.0 usually refers to
> associated a CFMWs. Moreover, according to Spec r3.1 Table 8-22 CXL HDM Decoder Capability,
> the CXL Root Port (also known as R in the table) is not permitted to implement
> the HDM decoder.
> 
> If I have misunderstood something, please let me know.

You're indeed right that in the spec it says root ports do not have
decoder capability.  What we have here may be some jumbling of CXL
spec languange and Linux CXL driver language.

The decoder0.0 is a `root decoder`.

The `root_port` is a logical construct belonging to the CXL root

struct cxl_root {
        struct cxl_port port;  <--- root_port
}


A root_decoder is added to the CXL drivers `root_port` when
we parse the cfmws:

static int __cxl_parse_cfmws(struct acpi_cedt_cfmws *cfmws,
                             struct cxl_cfmws_context *ctx)
{
...
        struct cxl_root_decoder *cxlrd __free(put_cxlrd) =
                cxl_root_decoder_alloc(root_port, ways);
...
}


And the `root_port` is a port with downstream ports - which are
presumably the host bridges


static int cxl_acpi_probe(struct platform_device *pdev)
{
        cxl_root = devm_cxl_add_root(host, &acpi_root_ops);
        ^^^^^^^^ - Create "The CXL Root"

        root_port = &cxl_root->port;
        ^^^^^^^^^ - The Root's "Port"

        rc = bus_for_each_dev(adev->dev.bus, NULL, root_port,
                              add_host_bridge_dport);
        ^^^^^^^^^ - Add host bridges "downstream" of The Root's "Port"
        ...
        ctx = (struct cxl_cfmws_context) {
                .dev = host,
                .root_port = root_port,
                .cxl_res = cxl_res,
        };
        rc = acpi_table_parse_cedt(ACPI_CEDT_TYPE_CFMWS, cxl_parse_cfmws, &ctx);
        ^^^^^^^^^ - Add "root decoders" to The Root's "Port"
}


If we look at what a root decoder is defined as in cxl/cxl.h:

 * struct cxl_root_decoder - Static platform CXL address decoder


So this is just some semantic confusion - and the reality is the driver
simply refers to the first device in the fabric as "The Root", and every
device has "A Port", and so the "Root Port" just means it's the Root's
"Port" not a "CXL Specification Root Port".

Whatever the case, from the snippets above, you can see the CFMWS adds 1
"root decoder" per CFMWS - which makes sense, as a CFMWS can describe
multi-host-bridge interleave - i.e. whatever the actual root device is
must be upstream of the host bridges themselves.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qk1-f178.google.com (mail-qk1-f178.google.com [209.85.222.178])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9012B21CC77
	for <linux-cxl@vger.kernel.org>; Fri,  7 Mar 2025 15:13:00 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.178
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741360382; cv=none; b=hn/ZSwN9rRzCbZr0ypEO6zHWc0dVV+HLFUlJzM+2NSELnDvnbn02DeYsyXbn7V5BmgXauXvPfsU9k1QQeZIgl5afVXMVNpWlWr2qUwzizXDnxkzIUTwhaAjMKODXBhYlaeZaJtuaGZsvswBdUwxvJoCb5yJgcNotdeugkya0h+U=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741360382; c=relaxed/simple;
	bh=2wMX+dMAk5OZF+yCTsbRVFzfhhV1PUCth+hni04YDPY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=WIYqAgFIbqcLZqFQgeIVHzzh29ZRIA8ec69IJhglphIopaKndwd25pniT+KleNUiqPq0jiOf2OawR4+ZoAFc1M6L9nAnhnD4ug9c2stAN+49RwpfsIIGdEN5amdUUZnnsO3y73ACl7R7uLG9QpevH6kIwI9nsFvWJ1FXbtM2Jg8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net; spf=pass smtp.mailfrom=gourry.net; dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b=AO77NOoX; arc=none smtp.client-ip=209.85.222.178
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=gourry.net
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gourry.net
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gourry.net header.i=@gourry.net header.b="AO77NOoX"
Received: by mail-qk1-f178.google.com with SMTP id af79cd13be357-7c3cb761402so384513985a.0
        for <linux-cxl@vger.kernel.org>; Fri, 07 Mar 2025 07:13:00 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gourry.net; s=google; t=1741360379; x=1741965179; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:from:to:cc:subject:date:message-id:reply-to;
        bh=vNr4ntECNtNIMvxVKv6TWdyQSFpn2hDLZaLcHO+bzIY=;
        b=AO77NOoXJBfPlExQuRnKEaWsOzBdXm2Axv0DEqDZChBcM3Cl2RHWDm48r1SUg01GO8
         qLA9aY4bqaF+sx3JToR8HCG9sNxqQ38GvYG8HyaEl/TczLRk3CedFkH5Ke3qMq75M2s+
         iaUzR4t7shhI5Zzm5Dvs4Dq7AOPtUUHPL0E+ybyYgBhS2n9R9jgJGfFlV2Gt1vVtDWkT
         Q+6GEi+6O/GboV+iLJMzY4RLQDFMBBIiMoYp7f8zknCVd65Mb1gDrCWQd3or8Ui/8Li0
         KKAeu3Q6X3z1boDBxJuogIwhJPIlS+cKhUmmi37W2AbPAdt043GBaVMG98GHvq2pkRpJ
         9FNg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741360379; x=1741965179;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=vNr4ntECNtNIMvxVKv6TWdyQSFpn2hDLZaLcHO+bzIY=;
        b=C9PiciY8yO8UJiSUkEvz5AMblbkC9drl18cHa6OJYlP8xbSCrp5h00EvcmM71gDeJD
         jRMoV5sYUD4CQLJ9R7xW2FiHOvY3cFufZWveDsrfL7mvFm7AJBqw62yp878P1u0UAFJp
         EoVDLF2idwWyxxkmNKoY35TGxeTKyRHpiPyE1EL+edE9QzyRz04e35KLmfAiwBGZtz5W
         C6mLmaoOeqJ/SRq3pRE4Y+fKQOJlHTgFYPd3P17gw6U2Z0cq3wOdXpYpCAH7YH2y7L0h
         HGvKT0V47J5xeNUX/nun7Zwy3HeqMFZ9KrUeVg1RGl3zqQDEiVzmtHEc5intbWfuBx+x
         VPYA==
X-Forwarded-Encrypted: i=1; AJvYcCVDVrKGaZ33jpTCbbXqCDtuVyxFSdnr+zvn/ymDeHyWFm4eCijZukL+yTppUZkRuqImFfg4WH9IYyU=@vger.kernel.org
X-Gm-Message-State: AOJu0YzgX58s8fRQtkamPocAzH1q0oscjZzWPggjveevJylJ3XwsCRCz
	qF+uC3SSPW9mMqtEmEu9ttKFg+79hYlIik3A1EpdUbgaocHBBvebtO6BWlZSI50J0rQpkxRALSh
	f
X-Gm-Gg: ASbGncsLvg+niYXuGvcKPQd2w9h/wPaBwW9MttcXARSEFb3UEPdy/5ll7nBOzg3V1A3
	WDrvRepsOBXkT7peRYcW5KrdvxUiGUtOO6DMaGsB92+Eb4/61zzlmLRnJCmTnaF+NyfH5yfsKFA
	jFOmK9jAjJZCaTs5eB5fNDeWIkuNAmYT6cTic1h8Qmr7+1BIWkQrNk5VN4Pl1IFlLsUdyvQlZ1G
	Mh5aB4k0pgOeL6yg9/16CjtY0r8Ap5nsdBxfafQR/W44khAktTn5SmIxJ/q10ikB8ttgwUfrgDj
	wmDRSWvlCmgGP6uGq2E/Ek9HPVRv6y6IcK7vQtFldh3wh79rREhqVOVOhXZBqQPUM9taLHuwYJb
	4gecniwshntss6BM2ua2ioPYHOh4=
X-Google-Smtp-Source: AGHT+IF1GDg63LmfyEarUB00FtiXShcOK8KVLiCcUDagJpfOb04hfBNYSrYPbaJ5e8IJKwahRj+kBA==
X-Received: by 2002:a05:620a:8806:b0:7c3:cd38:9be0 with SMTP id af79cd13be357-7c4e61ec9damr536785185a.56.1741360379462;
        Fri, 07 Mar 2025 07:12:59 -0800 (PST)
Received: from gourry-fedora-PF4VCD3F (pool-173-79-56-208.washdc.fios.verizon.net. [173.79.56.208])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c3e533a9f9sm252426185a.23.2025.03.07.07.12.58
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 07 Mar 2025 07:12:59 -0800 (PST)
Date: Fri, 7 Mar 2025 10:12:57 -0500
From: Gregory Price <gourry@gourry.net>
To: Yuquan Wang <wangyuquan1236@phytium.com.cn>
Cc: lsf-pc@lists.linux-foundation.org, linux-mm@kvack.org,
	linux-cxl@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: Re: [LSF/MM] CXL Boot to Bash - Section 0: ACPI and Linux Resources
Message-ID: <Z8sM-W1F6-TIZcGa@gourry-fedora-PF4VCD3F>
References: <Z226PG9t-Ih7fJDL@gourry-fedora-PF4VCD3F>
 <Z8jORKIWC3ZwtzI4@gourry-fedora-PF4VCD3F>
 <Z8j8bZ5TS+gDV8+M@phytium.com.cn>
 <Z8nWobZXQwhtE1nK@gourry-fedora-PF4VCD3F>
 <Z8pX786s+1DQIMDy@phytium.com.cn>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z8pX786s+1DQIMDy@phytium.com.cn>
Status: O
Content-Length: 701
Lines: 15

On Fri, Mar 07, 2025 at 10:20:31AM +0800, Yuquan Wang wrote:
> > 2a) Is the BIOS programming decoders, or are you programming the
> >     decoder after boot?
> Program the decoder after boot. It seems like currently bios for qemu could
> not programm cxl both on x86(q35) and arm64(virt). I am trying to find a
> cxl-enable bios for qemu virt to do some test.

What's likely happening here then is that QEMU is not emitting an SRAT
(either because the logic is missing or by design). 

>From other discussions, this may be the intention of the GenPort work,
which is intended to have placeholders in the SRAT for the Proximity
Domains for devices to be initialized later (i.e. dynamically).

~Gregory

