From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2044.outbound.protection.outlook.com [40.107.243.44])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 23D7A199389;
	Thu, 25 Jul 2024 11:59:44 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.44
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721908788; cv=fail; b=sY7uFAYG6ZeJWddrx2YYj4zHgZgPKYpLHTCDKnNyIG6zQ1DRZ7JYXa2yvzHzzMdutYlwisPm9GMAI6Ll0HD8iLB97aXTb/sfcgkul3Gpl13lv/TQzKvdumRsqZJE/i8Q++Gc2FKknmK2j1ccq7maccleBd/DdK3BXW4nQcPmD5M=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721908788; c=relaxed/simple;
	bh=BMvvD/TQQAD31xkIjwLBafQBj/1j2YMhk5qArd63g8Q=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=affFXB3BqYSL9fabL4t/JVIJyuB4zJ8Zturk6pt9r5a8ZwY197lvzJBCD7yzNGdBjEgTOCZFrH9R3XgXlgzDC4GDA0MsuyVhcJcSyBMWpo1bQEkaLt6tsLT6s3/9aTYWB4sRruFmRtetZjoOudCNvc/HZyHlqqguuQ5g99K4MQw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=OZcPT8ET; arc=fail smtp.client-ip=40.107.243.44
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="OZcPT8ET"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=Dcxjk6V1chlkAxLYPrVRgRydGeKBIF073uLlVAX8i51XQIcj4Ths0UY+4/v+ZZZB0Ivac4B14u++ThXqQffMW17fTxdbi4NVAFt/D7A1YmTw77AbpzQyCVbKLiGGcV7Ia7RMTkuccw9a2PnTZiEGepH5akof9naAVyPVJxA0rbrPhMCqyCxZHtdWZua33xPinSD4C6HeyjZRJFp6QL5bmIlAIBIMWj/j7eJtdjlbR+d/6FlbI4R/ONE0khGIcA2AeQP6Od1InGV6z0mPlvIrlRXODCyT9P6FL96fx61qssMR/1RET7or6Jni7/k0uEODxfAP6Cs/0Np/91vz2XXevg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=6QOaWMfpGGipSpoAkTTZvnklpD8HcTCs8yu5cJSojRk=;
 b=rFiAKRpzqwmtg8PKOiDM+zaIn+rEE52YSnvNnr2mnzmbmzYjASDMfmnMhaeq7FifUzHlv+5TmmZe5uZ88jPCzhsvcFK1VBrTOe3BsnXK3tGnMKhIQtC+A8QkI3UliEbNseW+fhmnvVo3VYNorigJsvnhNzWfpug7QVxJMIx8OZIw25DZZFTAnLUoJ+YZ0pWMPGi4ZNsSrmuZqt1DGr/AyMB1XwQfAJNwZ9LRXCgrIhd+ormBOzUWv1zLag9lpVhAq4cwYLeOWJHKgSPnlUqNYIyNtEFKE0wFS3ltOp+BhoqU9i6Uhrzfp0SIE9FkKuR7VddlrEkPUz8n5IcAdu1ZXQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=6QOaWMfpGGipSpoAkTTZvnklpD8HcTCs8yu5cJSojRk=;
 b=OZcPT8ETu4ZzN9xESFBKKZrCxFQTN1yqTPLCFWOVMD4kuyXYStNmi7+pfhXo93L5tYbmbxkOr4cy4OTtJmTNz2vkRAK+yyrIv09SEkieWi3m9+H+dlC1mKKMEl5TSklBvl0RzLUjdk2V7js0B4WpOs/QOm7uqBLsaumJqEAntzE=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by CH3PR12MB7690.namprd12.prod.outlook.com (2603:10b6:610:14e::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.28; Thu, 25 Jul
 2024 11:59:42 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Thu, 25 Jul 2024
 11:59:42 +0000
Message-ID: <3e8b9c3e-f533-8eab-d560-0afe68108e10@amd.com>
Date: Thu, 25 Jul 2024 12:59:07 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 09/15] cxl: define a driver interface for HPA free
 space enumaration
Content-Language: en-US
To: "Li, Ming4" <ming4.li@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
 <73311003-6b8e-4140-935a-55bd63a723e6@intel.com>
 <f40312b1-8ac7-973b-5519-ee185eec8560@amd.com>
 <85432fe0-b9be-4892-89b6-3e986838c5d2@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <85432fe0-b9be-4892-89b6-3e986838c5d2@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P302CA0001.GBRP302.PROD.OUTLOOK.COM
 (2603:10a6:600:2c2::6) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|CH3PR12MB7690:EE_
X-MS-Office365-Filtering-Correlation-Id: f6b25c23-82e7-4b3c-b139-08dcaca144ab
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|376014|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?OTRrdjVWOGk1UjQrR2hUZWVGR2toWlZrajNlOEJ1bTVuN0tBRFdYWjRodDNW?=
 =?utf-8?B?ZEo4UUh5U1RNaWM3ZmMxSzdRSTJlQ3JIVXNrYlpjUTc4QjFEOFJhYm9XOWFi?=
 =?utf-8?B?bWhMRU56SW5iR2xUR2lpSStIOEIzUUxhMlhHWkcrb3BwR2hOWllDYjN1YWxY?=
 =?utf-8?B?NUlSZTBoWUtpSkgzcHlIdXBQZDlweGN0UlErNk9ZeG5mTno4WEVOQkRNWFll?=
 =?utf-8?B?VXhWZVQ5amJldDB2SlB5K0pGTnRUR2M5YXZnZnh1aDI5aytSMGo3WnJYSmRU?=
 =?utf-8?B?WkZQSnBSTFlGNWc4MVdLWVNOUHhzWm5oUjB3Qkpwai85T3BycnFYR2FqbU1l?=
 =?utf-8?B?SGFsVWxQdXpFRXp5dlFUTjZubXk4TVBlbWdEVFFCcGJLcW1RRndvaW56ZUZG?=
 =?utf-8?B?bG1DL3ZXRjUwRGlHckFuenM4YytqVDQxcG0zR1U4MnlvbzdUN2VlaEJCRm1Z?=
 =?utf-8?B?UFJrd2NNeU9CZkczemRUa2JGTXFIeStKSTQ0T0Jwb29mWnl5OFNSTFp1RzB0?=
 =?utf-8?B?eTc2aUNhcUV0REhNcjBPWFNGMWdvbUhSaEhzWE5ENWN3b0gwa3RyRXdrR0tY?=
 =?utf-8?B?VWVDUzZ0NjFMUmQzRmk0Y2ZZZGlIbUhLZ01Ic2hCWURScnIrRjdwYkRUUThw?=
 =?utf-8?B?YVF0MHBwMUxlYWpudEhOamVUTytsTnVDUi9HL0NHSjUwS0NLaDZtL3FWbGlQ?=
 =?utf-8?B?MU1JSWlTQnR0S1ZJNnF4SnVlUExOZ3FQNmF0cGJtSW5UTE5XenpSNzZ4eFdD?=
 =?utf-8?B?ZHBmSjdPa2wyT3NmNEtpcFZEa3ZKSFh2T0hBSzdGcjBNTmFKeVpXODg5OE53?=
 =?utf-8?B?RzBBVTFXZ1pTNVpOV2pVTk9VY3JIV2s2REkwRm5YdDZXQlpmL2NOYzV4cmNl?=
 =?utf-8?B?QzR4bU9iTU4vRit6QnluTFplMzR3d3ZLakM1dWdqWjVMS0o1dlAxUE1qcFdj?=
 =?utf-8?B?SW4rQzhlSGhiZ0c1U0xGZjM4b21VV2ppSTNpZDg0dFVtUEZqdVNtbFJ0bWQw?=
 =?utf-8?B?MVA2bDE2T080dzlsc0dWcjFkRmhFQVhEUmdqZHpXTjVEU1lDdmxjZ0h2OTRF?=
 =?utf-8?B?dnBhQWZqbVBEcS9odVFQdWZUaHRpN2YyOWtwRVhuMTN4cWFiN3BQVkxFU2xF?=
 =?utf-8?B?N3VyamJVMzRtYVhrNFZ3bnlrRXAySFZ1YWZkdkZ6N1hpNzBUcW9mRkJmeXpa?=
 =?utf-8?B?MkdBTEJ3K1hzUVZ5M3NnNW9ZNHc1SStJbVFsZklocFMzL0huMnhkeFRqc0Nt?=
 =?utf-8?B?WjhNS01Eb2diOHI0NG15WlNVcng1b3NBYnpjb3FTOVZseUkvRUtISnQvNkc0?=
 =?utf-8?B?ZzErSGE5b3FBMTZrZWEwVE1ObDhmeWtlREdpemUzdFY2QzB5S01Za1dlMURi?=
 =?utf-8?B?NDZvYXpPcGZHWGtQRlFEek4xS2YvdHlKamZXbEo0Z0s5Ky83SFdSVUIxTWNs?=
 =?utf-8?B?dkxsWlJxaUltQndpNmN0MkpBbUxnM1FxMHJHOS9XR0lZOUh5ejhiNzk1bEdy?=
 =?utf-8?B?YjdGOGxSckVFN3JrVjhDeHRzU3FrQTVpY3JsMllVcUlmNVlPUnd0bElwRnJi?=
 =?utf-8?B?WEthMzhaRUNhb1VZK1NUS3JDaUVBdUFLL0NhaGFVVTZIaHpOdm5zMzhBZjB6?=
 =?utf-8?B?N0EyKzhCb25tbUpBaTdYL2FiMzFTb0VvZFM0Q0RVS3hSSHB6N1hmZ0tGRFcv?=
 =?utf-8?B?UndQMm15OWFjblFjYkRPNVlHaGFnc2VpU0lIbVRRTWRHRTU4VjgwbnVzemNN?=
 =?utf-8?B?STlNdFE0ZG15aVJHdkpzUHVqZE5PVDlpSmk0ZXFmanNNUEFwN3FWRHpJRE5S?=
 =?utf-8?B?bDRvZlFWM3ViVys5WEovdz09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(376014)(1800799024)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?T1l3TE1UQVJReW9ucEg5SEl5dDJnZ2ZDT1Y3K0tPb2ZnQnA0Z2p6ZnBzSmMw?=
 =?utf-8?B?S3BOdElRM0JLTDg4WmV3STNGV0U5akFINjEySWRRU1VZZGIxcGRzOEdpWEVl?=
 =?utf-8?B?dlpWc29NbEFCVERoQURueXhQQnBLRTFTKzU3RHhrSVlQWVJ4c0tSd0ZhL0g0?=
 =?utf-8?B?K3FKbFdLL1B6aWNpbEVxaXpNYm0wSWpNbXJOTW13aW9xYjBPOE8rNmo1S2Nw?=
 =?utf-8?B?OW5SQWxKdWJVUm5sV3hBODhQK0NBT21DalhFSUM4T1pvbnB0SWoxSHFxcU5M?=
 =?utf-8?B?UnhTckZwUnRTUnJTclBmLzY2SVQ2eHcxQ0FNRWxSRzRaSE1NMjdWYXVDVXlS?=
 =?utf-8?B?OEVici9mVDZMdHAwSGdHRW41WGc5UUVsWDU3c21JaDRNNUtPWUt1dnJ6eXpQ?=
 =?utf-8?B?QkpCVk5sallPVHpqL1VyWTNwSFpicW94TVpnUFhkYWVlZjNWUXNwajIwWHZu?=
 =?utf-8?B?V1FCaS9nWDc3RnVUVGdaRHZOcElSNklBRFBURDZ1LytLSWFGcncvVzNWOUJz?=
 =?utf-8?B?UFQvakttZkoyQzUyQ0pZZGhoYnJVckhrV2tQOFA2UklwRmlYNElUT3VaVGgy?=
 =?utf-8?B?ajBaMTJSYlhDZEJFbXE5YTJHZFlkLzBFV2oxR0gveXRwbnZvMWp1Vi9iSkEw?=
 =?utf-8?B?d3NrTG9VTVFvdzQ0ZW96b1dHQ1I5ckRNempjSUM5d2NpWG1aNDBZcmtMQ29O?=
 =?utf-8?B?VWFiYi94VGIwdkJMaGE1anhrY1YrallYT0c1ZWNaZlVkeEVzMm41ZkRGQ0dv?=
 =?utf-8?B?dGFHeVBGbTZQd0VPOTZhYVJUNGVKdjA5eEt3TFRuV1RvNFZhVnZtT1NLQ3JO?=
 =?utf-8?B?UW5JblhSTDdtbEJsMVF5blRBV09wazI5WmpzKzFDSEYrQnVtcnIzdjBPbnQ2?=
 =?utf-8?B?UUtLUHcyRWdQQU1nYzRLMUZoNTZhaStkWm43ang4ZWVaMS8vcUVyalppWWU1?=
 =?utf-8?B?OEpqV1ltVmNpNFZaNlVPeUZQOS96MEduZlJnRlFJZ1JVRERRdk4yZ1hhRnJD?=
 =?utf-8?B?cHVWVHhja3VFcEVJT001eGp5UU5EZWh5NDhKUTU5YzEzdU41cmc4OGl3aEpG?=
 =?utf-8?B?RmdabUdQUlEzRUtScTFJOGFQN0hJNk4wc3pGdFMwSXY2dTVmdjRrd1lCQ3A3?=
 =?utf-8?B?cUVKOTZMVktPcFBRcnlpdWlGWkxVNExiZjYwQzFsTU52SzMvdnpGUGNsUmlP?=
 =?utf-8?B?TnExemV6SnJUdXNUQVJxKzBhZnVKTzh2elVteVcxMkdKVlJjeUVmZlZrMzdl?=
 =?utf-8?B?YmlDVHJKSUxnZlhYUXczVXpaeW50bkJhMnUvRHMvdk0rRkxNdjRzWGRvdkNV?=
 =?utf-8?B?SnczNzhQOGlEZ09ucThiSWtyT0pKcnFSZ3BCNzlHZ0o5QUQ1eXprRGpxNjR0?=
 =?utf-8?B?Smpjd2xDQThJVXpPbXJiNDhOWHB4cVpid0pONHpYY1k4RzhyaWNmcW94Z2tq?=
 =?utf-8?B?UXVzcFQrZ1VhYmJaU2FrbjRrVmN4YUk5bXdxWUg3akZKaWVOZWJ3cnJNVktN?=
 =?utf-8?B?YzRmTTRMMy9PMDBuRmwyQU5jWENlKzNaYkJkRHAwWHlHVjY2NEJkV3hTYkNL?=
 =?utf-8?B?ZTJoUTlLVHhjVWZIWkh3R1ViMjRvRTdKSmthVlZrWElac0hNTUc2MkZ2QXhN?=
 =?utf-8?B?OXBPRmFHYVJsOEkrZ2JKd1B0aGlDZUx3RWZhdmg1WUtQbEZWcHlZUUtubWFN?=
 =?utf-8?B?c0E1Lzh5MHkxcTViTjdaQmtxbEcraFE2YlhsR28xMXR4ZlZiVWFEMmQ4QWhX?=
 =?utf-8?B?MXVvU3VIQklySHdlM1ROR3IzN2pEQnJrTjVQNnpqQnBadkxEeW5lS3RhOTdj?=
 =?utf-8?B?S042OURoWlpnaVFyZ3pWekxRdDJTVWRvRkVIRzBlZ0FJRHBxa25CQ2haa04w?=
 =?utf-8?B?RkIvbXFXYlhYamtzNnhJczdLcDhUN0NDUjAyVi9jNDJKMWVCNTRkT2toeHJC?=
 =?utf-8?B?L1g0TElueDJraVVYTlVDSlJrczRqTC9hTUcrc3ZMd2ZuNnVFaFlDZ2VCdTNN?=
 =?utf-8?B?UHpBbW02WEtCUGs2cDNGeXh4VlU3cC9BTTZJcFFLM2M1cWx2bkdjblA3a0dD?=
 =?utf-8?B?SnZKSzNLZ3dnRDFETmZnWVozWEZUNS9uMGdSTlgyT0U2N2gzcy9mYVVlbGR1?=
 =?utf-8?Q?iZK2HvgxVsKywcRGeb2oODLIb?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: f6b25c23-82e7-4b3c-b139-08dcaca144ab
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 25 Jul 2024 11:59:42.3850
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: cqZBySw7yy3rXqzDX71jpTWs61fnxPuR+WHgD8V6gkARP7cwdvjB+Q2PTw4H0/uNKVVBDQEuDZ6HrSnd+NxkzQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR12MB7690
Status: O
Content-Length: 1499
Lines: 32


On 7/25/24 06:51, Li, Ming4 wrote:
> On 7/24/2024 4:24 PM, Alejandro Lucero Palau wrote:
>> On 7/16/24 07:06, Li, Ming4 wrote:
>>> On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
>>>> From: Alejandro Lucero <alucerop@amd.com>
>>>>
>>>>
>>> Could use scope-based resource management  __free() here to drop below put_device(&root_port->dev);
>>>
>>> e.g. struct cxl_root *cxl_root __free(put_cxl_root) = find_cxl_root(endpoint);
>>>
>> I need to admit not familiar yet with scope-based macros, but I think these are different things. The scope of the pointer is inside this function, but the data referenced is likely to persist.
>>
>>
>>   get_device, inside find_cxl_root, is needed to avoid the device-related data disappearing while referenced by the code inside this function, and at the time of put_device, the data will be freed if ref counter reaches 0. Am I missing something?
>>
> Yes, get_device() is to avoid the device-related data disappearing, __free(put_cxl_root) will help to release the reference of cxl_root->port.dev when cxl_get_hpa_freespace() finished, so that you don't need a put_device(&root_port->dev) in the function.
>
> I think that your case is similar to this patch
>
> https://lore.kernel.org/all/170449247353.3779673.5963704495491343135.stgit@djiang5-mobl3/
>

OK. It makes sense. I was blinded assuming it was just about freeing 
memory, but the function to call for cleaning up can do other things as 
well.

I will use it in next version.

Thanks


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 861771CD32;
	Thu, 25 Jul 2024 05:51:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.10
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721886702; cv=fail; b=nptaD6wmmcA8v6XElxA87wkiRvNgWXL6SVlQ2xsuRuOxKs+0Dy49tryWoFkorula2NqiPw1p1GE/tiabsOKghkmF4kQVSIj/gmDDKsukM8mm3EcsZYRyT+UwqOzK04u8jo2nHbFRRZFMe6U8qQZn4FTsyn2H/lUsExKSQuQN9Xc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721886702; c=relaxed/simple;
	bh=C1SLK+Hkk9aARkyg/dh3sCtS+R8Xjwr5/WUtFrTkVfc=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=CbDjq13F8aKkwyv0X0lJ8hTGyeHv7H/wJN4S+bggPwOxEz/dN+XCN+Dk2gqPWwEYEuD2tRT9+AU9NQnhl1gFSF614JPb+r0lo2N2ncWncc5XDE5I4BAwKXHM66zLDuivXceDAyu0W1PbqT3bgXAf188M+PI7heDSnT1VPJFeKP0=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=SCLrhDsg; arc=fail smtp.client-ip=192.198.163.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="SCLrhDsg"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721886700; x=1753422700;
  h=message-id:date:subject:to:references:from:in-reply-to:
   content-transfer-encoding:mime-version;
  bh=C1SLK+Hkk9aARkyg/dh3sCtS+R8Xjwr5/WUtFrTkVfc=;
  b=SCLrhDsgEH2qw/RpHSO7XJ12BHa8jifDBJ5DASmdhdVLGAQ4IhAQsgkw
   6iFtADwsvy0giNPP6jlpTPzljYhUghqgjt/r5kHXnPY2P6FwEa4Hx2iqP
   +dU+tiqmusxzVKgg5FnsYon1ZmUDTVrM8QIA6U4AfiPooXjftqvl2uXaZ
   XzHWnWcNOuROm0nWhUFElsuKdvLHPC303XPmlUuTkJg7sdAE06f6k7oan
   o+7+9a8pqyX5xgkeWlbhPUyZES/5bVFszLjo/sZHr755/+Ws7pAAHcVvP
   wXe5ynmBeTCEYPgj8XVui7UPXfkuR8thjE7jjzOfmwxt/ujtWZVZBYf1T
   w==;
X-CSE-ConnectionGUID: fZIgxXj/SZOCL91BadltRA==
X-CSE-MsgGUID: aozJ//jHTV+vQMVz/DOqyA==
X-IronPort-AV: E=McAfee;i="6700,10204,11143"; a="31018885"
X-IronPort-AV: E=Sophos;i="6.09,235,1716274800"; 
   d="scan'208";a="31018885"
Received: from fmviesa006.fm.intel.com ([10.60.135.146])
  by fmvoesa104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 24 Jul 2024 22:51:39 -0700
X-CSE-ConnectionGUID: QFsqd8ZXRcSNB20RPH5ZOQ==
X-CSE-MsgGUID: zJmKcRS1TC+t5gt70kyTig==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,235,1716274800"; 
   d="scan'208";a="52505485"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmviesa006.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 24 Jul 2024 22:51:38 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Wed, 24 Jul 2024 22:51:38 -0700
Received: from fmsmsx603.amr.corp.intel.com (10.18.126.83) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Wed, 24 Jul 2024 22:51:37 -0700
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Wed, 24 Jul 2024 22:51:37 -0700
Received: from NAM02-BN1-obe.outbound.protection.outlook.com (104.47.51.45) by
 edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Wed, 24 Jul 2024 22:51:37 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=L6PWGt25aRNbvHRjA/6ve9QNo/DvvkMOPfBRHp72q5swT/XvQLlJQP/OdfqaiPdDdULRJtqAhD4OqUOORb7DodhzLMBqYOhYxkEtnRsPU2MaIJ9HlY0r0VE+bGQA3dBa4rkWcpylbnBbOoDrp9rnsuA1LgPAj+dfT9T33/gy7IlNWWX3VQhaYNq2A3natKsaKwDMIwMnoKIOoRpm7cCyrQwSykyb4ftUBVAdN4qBU67Xh6Ep7n1EX6bmyu7QYyDnvRGySRBAJcnSklwxCxhVwpzTrIo8AHURLBVgyr6PXKF4UBMURCR2sX2/48wW9UuD+jjXqfIXkhatbIdcqnR//A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=C1SLK+Hkk9aARkyg/dh3sCtS+R8Xjwr5/WUtFrTkVfc=;
 b=uUVCvX82OzcGyCtrSSaLIBQUkkvYNtdxtnOTlab/wahX+2HbHdAMwWDFesQ8ZO/IlToDQixJdxbmCIyqf/iFcN6jww2QlTI2yiRaxtbzNyZsjZ/bkzYHnCt7i8FKPzU8q30S5MOmZlQuP/PfC3d1K5nQWYcpWGxvYcZ1WvaaW8XpcdCAgAMq1nuwjkhrXC4L3684zGFQmon4HjcGAyEM6jF/owAFmKHMcnKTV6CDy5fG/dkFThnX5JpTxFVvPz6+SPnWu1ILosv1Yw1+hgZnIUqV06d9sN6PKdRxdDt3DYI/o6slU0hY3hYTVfGqFjLdx2gBHBNLIc5nnPOfVqWseQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
 by DM4PR11MB7280.namprd11.prod.outlook.com (2603:10b6:8:108::8) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.16; Thu, 25 Jul
 2024 05:51:34 +0000
Received: from IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0]) by IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0%6]) with mapi id 15.20.7784.017; Thu, 25 Jul 2024
 05:51:34 +0000
Message-ID: <85432fe0-b9be-4892-89b6-3e986838c5d2@intel.com>
Date: Thu, 25 Jul 2024 13:51:22 +0800
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 09/15] cxl: define a driver interface for HPA free
 space enumaration
To: Alejandro Lucero Palau <alucerop@amd.com>,
	<alejandro.lucero-palau@amd.com>, <linux-cxl@vger.kernel.org>,
	<netdev@vger.kernel.org>, <dan.j.williams@intel.com>,
	<martin.habets@xilinx.com>, <edward.cree@amd.com>, <davem@davemloft.net>,
	<kuba@kernel.org>, <pabeni@redhat.com>, <edumazet@google.com>,
	<richard.hughes@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
 <73311003-6b8e-4140-935a-55bd63a723e6@intel.com>
 <f40312b1-8ac7-973b-5519-ee185eec8560@amd.com>
Content-Language: en-US
From: "Li, Ming4" <ming4.li@intel.com>
In-Reply-To: <f40312b1-8ac7-973b-5519-ee185eec8560@amd.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: SG2P153CA0029.APCP153.PROD.OUTLOOK.COM (2603:1096:4:c7::16)
 To IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: IA1PR11MB7200:EE_|DM4PR11MB7280:EE_
X-MS-Office365-Filtering-Correlation-Id: 833af959-bbda-4cc4-76fa-08dcac6dd73a
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|376014|7416014|1800799024|921020;
X-Microsoft-Antispam-Message-Info: =?utf-8?B?czVyVFZBdlMvNXU0eThSd0VLa2tydmhIZVlVVU81R0E2R25HWDZKTmZlQXlr?=
 =?utf-8?B?UHhQL3lWTjNiZ3ZuNmxHRU9NcDVZeG83SG1ZOHlvcnVJS0RxUDhpR1E4c24z?=
 =?utf-8?B?bm1XNUMyS2pCZm5UaUNaMlVCYjAyZU9vVTRZc0xsSGZsQmhLVndsOC85QkQ1?=
 =?utf-8?B?Uy9IZmc0UlE5QnZGdi9CQWRTNEhBcW9yN0djNHBQdE00djUyOFZvL2xLOHFZ?=
 =?utf-8?B?MWgxMXFWbHV5WGRvQ3RiUThJZDZOVjhOc0g5OWpKM1lVd093QzVoKzhPenBU?=
 =?utf-8?B?cXRYcEpwQ1R4RlNiaXc1YjNudm9WWEIxMmRaKzBBak9EbjlmeVNCSy9aNFlC?=
 =?utf-8?B?RjhQYjBkR0ZaN0VGOUlNL0x0L1Y0YXI0bnpSTkc1TmhQSVZZZXA4NEs0a0Fo?=
 =?utf-8?B?VW1wenBiYitVSkcvTy9WL204K2g0NTlrMTdOQXhPRndxUldqQmRCQUUvck5o?=
 =?utf-8?B?N2FpdlJBSXBLLzh2RXB1K0tJUkhpTGRrVFVhNUtZS2owNjg2RHFHaWZtOHZE?=
 =?utf-8?B?THNRKzhpYXROaUhhSFkwSm8rYitqV0theHVqOXRQZWs3ZERLUCtvc3ZWN0Jw?=
 =?utf-8?B?SjU3MGFoMlBoWG5uS2QwQnpXVVRKNXhacU5KVWYyVzkyYlRqYitFZkFOWi9H?=
 =?utf-8?B?K2I1ckVXUEVKdlZMUnNMWndzaTlneUR6ZGYxM0hDa2lvZ2ZnY0VobHRuNGFM?=
 =?utf-8?B?RG1JaVo2WFV2MVY4eXR5L0RHanlDRVQvUC80RFVDQVRSTWpQeTJ4SzJDczg5?=
 =?utf-8?B?a2haVVdVYVlCT1ViZ0FEY3ptajFxZnFLbDloOU1nQU5qdDRuL0RoYXNxOFEr?=
 =?utf-8?B?cE9HdlFoOFNDV3JEWTNuU0VrejBIV2dsUzI5N1RYNjNqSVQwWWh4V0tJNHBi?=
 =?utf-8?B?cmZmVlFCZXRoRzRpLzYwZTV4bUI3Z2VpTGVqSzhoSDhxWkNWenpvOUFpNWQ2?=
 =?utf-8?B?eVJSYW5WNTlISXVyZUhHeHA1cHBvK3puQ0QwMUJValVoOTBXaWE2LzFaSXJ2?=
 =?utf-8?B?Zi8xc2xsUnd6UjI5YVB0ZmFuL0QycUZpb2Z3OUFhdWtLcGlYTlVVbWJ5bkFF?=
 =?utf-8?B?ZTkzRVZmQ0U4aGIyRmY0dTEwU1h5cTRoVDdnblFwSHdvd0REa3BQRkVtazdZ?=
 =?utf-8?B?NGYzRDFVU0RISlZ5YjJ0azZZelNaeUQxbFJwQWNUWTlrNTRWcm4rR0ZzQm5p?=
 =?utf-8?B?S1M2QkZkQTZnSGxDeEM1Vm1RSURNc0FkUU1kbGxub0ZmeXcrMTJ6WjQ0TmJ3?=
 =?utf-8?B?ZjJsSGpkTnlvNDdNVEhOLzhwdnQyTHJIR2RBL1dTUG1uSnlpQWN5bm1pR295?=
 =?utf-8?B?ZEluTWZzakFkcHY1NEtEWi9KcXAxL05vSTdHWVI4K3piQkM5OFBOMURHM3Ax?=
 =?utf-8?B?VzVkc1h0YWJOeWRMTWduRWZqSFBXZkpnRVN5b1NmS21nTitDckZ1b1RjVTRk?=
 =?utf-8?B?emthdG5CdDJ2a1ZoVyszVUsxd1lDK2lpT2JzN2s0VEY5QXlla2NMZTNLejdX?=
 =?utf-8?B?WW1XT1BNR2JNUXgweWd2Y1ZZK2thN2pQNkhOZmV2ZzFhbHhETC85b1BLSENM?=
 =?utf-8?B?QUhXODBCUUI2SW1HYXJJL2t4czd3am42djdUSHNFS29QRC9lZjYxUk14OWNx?=
 =?utf-8?B?dWF1WDNwVVVBQTlmU0orNnVFT1pGT2Z6TDB3RFFUZm9wMVgzNjdQMmNBN3VJ?=
 =?utf-8?B?MGhTOUhIT3M4dlczelF0alZ2Rmo3MEZWaVpBSWhtU3RRSlRPZzRhRGV4QXZN?=
 =?utf-8?B?Q2Q1azVWUGhMQk8yTzhKR1NCUjBSRDhESVg1ZUpFRUR6SXZUdE1DeUZ2T3lu?=
 =?utf-8?Q?wrE7r33Rv/jjVByINlmq0iQ4F0sAqfOHd+SYQ=3D?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:IA1PR11MB7200.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(376014)(7416014)(1800799024)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?L0hzcHQzL1BVYnRnZk5HMkkzUi9qcUlmZC9JMDF2MW9SVjhCeUw5a1dwcFoz?=
 =?utf-8?B?Y2lrV3BmajVUb1FidE9GNDl6S3Jsay84Lzc4L3RVUWNoOGg0bW11NjB3KzFi?=
 =?utf-8?B?UmJDakwwelliRTl0SmdJK1l2Q0JIcVM3MTVjeGZ2U2NZcTI4QnZzWXhsczF0?=
 =?utf-8?B?QkZ4UlNGWXl0VXJnWG9sV0gxSmsxQ2huL1h0dUFrZ0xUY3l3dWdtUlZkandE?=
 =?utf-8?B?ZDJHbnJmeXJxWlEvUkU1UHZxd3psaGszcWtqSk8xZ0l3bVltNmNmcWRabHp6?=
 =?utf-8?B?alpQRUZSU1N4V3Bsd3hVaW92eE9xWXdFMmxzTUNMYVc0cjQrK21WR0o0Qi9I?=
 =?utf-8?B?bWkyOTBESUx3TEVjekZ2Ym1PWDl0b25obHZLWDJlVC90c1hHYUllcU5iT0pn?=
 =?utf-8?B?THZMN2ZaV204clQ2Q0VhVjNvQ0dDbHpwK3RaTFpTZktyc1RQVWM1L1JIMlBq?=
 =?utf-8?B?LzVsVkxxNGdwSUxqMytUT0lVbTJndG5OcEVFZXVwVVhjUWU3M0FWMTFjM0d6?=
 =?utf-8?B?L3ZyeFNKRzZIK2p4YjV1WXgrYjhtR2NjSWRQZitsRUttV0lxZmF0V3N1TUJY?=
 =?utf-8?B?RGYvRmN4V01LY2xuZ0FFd2hkSGNqb2RWSnBPdVVPMDVtTzh2NWRQQmFNbXpt?=
 =?utf-8?B?bDdLSUY1Q0tDc0lWcjU5dS9zWVcxb2RzVjRJK2pZTFgrcGJhUU45VVhOQ2s5?=
 =?utf-8?B?aTRETG9TblpVMDdmSjZFUzBhR09nUHV6bDlNWFMvTTlrMkp5UXFaZEVyaGFL?=
 =?utf-8?B?c0YzNXFDTHNNaWZtYVdnRzlwTW81RFBKd2tiR0h3UzF0V1d1RzJjRjZVV1h0?=
 =?utf-8?B?c3V3ZklSRGUxcEd5R09kSGozUTNEakR2MTFoaWVEd0htZXEvWnBRWWdzOUZv?=
 =?utf-8?B?SlNBTlpUOWxUaFlLQjdBUWJiQmI0Q3ZMSUZHSjRNbzFWMGZINHNYT2tRamFP?=
 =?utf-8?B?UkJSS1ZZK3paM3ZSbUUzSC9QNEFubW9wOGNBRFRCUzYxTUtCNXZPV29iVkRC?=
 =?utf-8?B?UXBCMldRNzViR0g2U1N0bUprMzYvMTBIU0RuN0dkN3NvbEVPb0d3dGJxanc2?=
 =?utf-8?B?QllBaC9lTmhoUGtYTEdZVUthR3FxcUxaejVTdjJ5TURDMGxVMzRzVVYzMTd3?=
 =?utf-8?B?V1ppVDZwOGQwNFJ6TUNFNG9VeU9ncVAwRllmY282QzlISUY0REp5Sy9nN242?=
 =?utf-8?B?cVdCMFMxZm0rMDJndE9PU0dKVmx6NnEwemNDNStSYjNIb2RCRkJqSGVIZDI3?=
 =?utf-8?B?WVArK2x0ajBhRGo0V3gwUUlTV3VHSm1iRGN6YVE4a3RIRE95UUhkSE1TSUtJ?=
 =?utf-8?B?c3BIdy9VT3lRS0lubjFNTUJhb202VnV2NXVUSUh2L2JZNHBJSGVKWUlIdVp2?=
 =?utf-8?B?Ukl6dzdZNTFVUmNtMGI5cUpYL0xjcU83TUNQM0hrRHNWTU1qT0tJbE13TEFI?=
 =?utf-8?B?b0ZkVlpJVis1Y1pOWE9keFNneVBXNEUvL2ErYkFGV0szQ0dncE1Udm1LY0po?=
 =?utf-8?B?RzAzbzVURjNUUnRvbTBtT1I3VGhHREtQTUlGc0t0cml4ajM0NEZ4ajN5N2Rh?=
 =?utf-8?B?QzIxRVljMEkzR25MY1VPb0piWm9zTGwzTEZ1NVRWTklzMVpFcGRnUEo3M3Fu?=
 =?utf-8?B?SUdIVFQ1TFgwNDJ5Z2xjYVQ3bWhFaGpaUytyRUxSRE16VmZpM1A5NFFVMnVh?=
 =?utf-8?B?MkZPS3FSdW13ZmJ5czl5SFhSdkNmTEhrNDN5bVNFR3pEam5rU3BMTXhyaitM?=
 =?utf-8?B?NWE3ZXVXSzkyejJBY2ZtcEhsUytpSUNMQUFadTVpNnptTjZGcDl3VjAzN3kz?=
 =?utf-8?B?Rjl3Q3BmeWl4WG04VzRBM3JDWmpYNDNHeDR4U2lpcGdBTElNNDBuOVF4c1hz?=
 =?utf-8?B?RE81eXI1cGorSWVSNHNmalh3SHp4U2tKWDRXZzE4K0lyTUYzcmZEUUZ6NVgw?=
 =?utf-8?B?eGpLa2ZJajUrRkVTOGw3enZxdHE0YUlFendya1I3ZkYrZ1dPYWVFczB0ZlJG?=
 =?utf-8?B?MWIvZ3BXQXpCNURFZU94eFNERHhuUm4vZ053ZXBUOE4vNHJ2M0l4dDZ5eE5s?=
 =?utf-8?B?dGVNeSswZHpRL3U5TnpBdFlzZWx0TGgxN1B2L2ZXczFRTVJWc0FFN0pvSTdU?=
 =?utf-8?Q?EFEtY/iw//o5ny1MSgbjDeCJL?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 833af959-bbda-4cc4-76fa-08dcac6dd73a
X-MS-Exchange-CrossTenant-AuthSource: IA1PR11MB7200.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 25 Jul 2024 05:51:34.5231
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: e/QZSiaGRm3OsVfBbObbBslL/Eb6m3CWP54cBYSOvoPf32K4MCBgdxoexBqfUgl7+R8bp5Nsa9/cYAwra6PcDw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR11MB7280
X-OriginatorOrg: intel.com
Status: O
Content-Length: 13401
Lines: 302

On 7/24/2024 4:24 PM, Alejandro Lucero Palau wrote:
>
> On 7/16/24 07:06, Li, Ming4 wrote:
>> On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
>>> From: Alejandro Lucero <alucerop@amd.com>
>>>
>>> CXL region creation involves allocating capacity from device DPA
>>> (device-physical-address space) and assigning it to decode a given HPA
>>> (host-physical-address space). Before determining how much DPA to
>>> allocate the amount of available HPA must be determined. Also, not all
>>> HPA is create equal, some specifically targets RAM, some target PMEM,
>>> some is prepared for device-memory flows like HDM-D and HDM-DB, and some
>>> is host-only (HDM-H).
>>>
>>> Wrap all of those concerns into an API that retrieves a root decoder
>>> (platform CXL window) that fits the specified constraints and the
>>> capacity available for a new region.
>>>
>>> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m6fbe775541da3cd477d65fa95c8acdc347345b4f
>>>
>>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>>> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
>>> ---
>>>   drivers/cxl/core/region.c          | 161 +++++++++++++++++++++++++++++
>>>   drivers/cxl/cxl.h                  |   3 +
>>>   drivers/cxl/cxlmem.h               |   5 +
>>>   drivers/net/ethernet/sfc/efx_cxl.c |  14 +++
>>>   include/linux/cxl_accel_mem.h      |   9 ++
>>>   5 files changed, 192 insertions(+)
>>>
>>> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
>>> index 538ebd5a64fd..ca464bfef77b 100644
>>> --- a/drivers/cxl/core/region.c
>>> +++ b/drivers/cxl/core/region.c
>>> @@ -702,6 +702,167 @@ static int free_hpa(struct cxl_region *cxlr)
>>>       return 0;
>>>   }
>>>   +
>>> +struct cxlrd_max_context {
>>> +    struct device * const *host_bridges;
>>> +    int interleave_ways;
>>> +    unsigned long flags;
>>> +    resource_size_t max_hpa;
>>> +    struct cxl_root_decoder *cxlrd;
>>> +};
>>> +
>>> +static int find_max_hpa(struct device *dev, void *data)
>>> +{
>>> +    struct cxlrd_max_context *ctx = data;
>>> +    struct cxl_switch_decoder *cxlsd;
>>> +    struct cxl_root_decoder *cxlrd;
>>> +    struct resource *res, *prev;
>>> +    struct cxl_decoder *cxld;
>>> +    resource_size_t max;
>>> +    int found;
>>> +
>>> +    if (!is_root_decoder(dev))
>>> +        return 0;
>>> +
>>> +    cxlrd = to_cxl_root_decoder(dev);
>>> +    cxld = &cxlrd->cxlsd.cxld;
>>> +    if ((cxld->flags & ctx->flags) != ctx->flags) {
>>> +        dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
>>> +                  cxld->flags, ctx->flags);
>>> +        return 0;
>>> +    }
>>> +
>>> +    /* A Host bridge could have more interleave ways than an
>>> +     * endpoint, couldn´t it?
>>> +     *
>>> +     * What does interleave ways mean here in terms of the requestor?
>>> +     * Why the FFMWS has 0 interleave ways but root port has 1?
>>> +     */
>>> +    if (cxld->interleave_ways != ctx->interleave_ways) {
>>> +        dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
>>> +        return 0;
>>> +    }
>>> +
>>> +    cxlsd = &cxlrd->cxlsd;
>>> +
>>> +    guard(rwsem_read)(&cxl_region_rwsem);
>>> +    found = 0;
>>> +    for (int i = 0; i < ctx->interleave_ways; i++)
>>> +        for (int j = 0; j < ctx->interleave_ways; j++)
>>> +            if (ctx->host_bridges[i] ==
>>> +                    cxlsd->target[j]->dport_dev) {
>>> +                found++;
>>> +                break;
>>> +            }
>>> +
>>> +    if (found != ctx->interleave_ways) {
>>> +        dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
>>> +        return 0;
>>> +    }
>>> +
>>> +    /*
>>> +     * Walk the root decoder resource range relying on cxl_region_rwsem to
>>> +     * preclude sibling arrival/departure and find the largest free space
>>> +     * gap.
>>> +     */
>>> +    lockdep_assert_held_read(&cxl_region_rwsem);
>>> +    max = 0;
>>> +    res = cxlrd->res->child;
>>> +    if (!res)
>>> +        max = resource_size(cxlrd->res);
>>> +    else
>>> +        max = 0;
>>> +
>>> +    for (prev = NULL; res; prev = res, res = res->sibling) {
>>> +        struct resource *next = res->sibling;
>>> +        resource_size_t free = 0;
>>> +
>>> +        if (!prev && res->start > cxlrd->res->start) {
>>> +            free = res->start - cxlrd->res->start;
>>> +            max = max(free, max);
>>> +        }
>>> +        if (prev && res->start > prev->end + 1) {
>>> +            free = res->start - prev->end + 1;
>>> +            max = max(free, max);
>>> +        }
>>> +        if (next && res->end + 1 < next->start) {
>>> +            free = next->start - res->end + 1;
>>> +            max = max(free, max);
>>> +        }
>>> +        if (!next && res->end + 1 < cxlrd->res->end + 1) {
>>> +            free = cxlrd->res->end + 1 - res->end + 1;
>>> +            max = max(free, max);
>>> +        }
>>> +    }
>>> +
>>> +    if (max > ctx->max_hpa) {
>>> +        if (ctx->cxlrd)
>>> +            put_device(CXLRD_DEV(ctx->cxlrd));
>>> +        get_device(CXLRD_DEV(cxlrd));
>>> +        ctx->cxlrd = cxlrd;
>>> +        ctx->max_hpa = max;
>>> +        dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
>>> +    }
>>> +    return 0;
>>> +}
>>> +
>>> +/**
>>> + * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
>>> + * @endpoint: an endpoint that is mapped by the returned decoder
>>> + * @interleave_ways: number of entries in @host_bridges
>>> + * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
>>> + * @max: output parameter of bytes available in the returned decoder
>>> + *
>>> + * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
>>> + * is a point in time snapshot. If by the time the caller goes to use this root
>>> + * decoder's capacity the capacity is reduced then caller needs to loop and
>>> + * retry.
>>> + *
>>> + * The returned root decoder has an elevated reference count that needs to be
>>> + * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
>>> + * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
>>> + * does not race.
>>> + */
>>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>>> +                           int interleave_ways,
>>> +                           unsigned long flags,
>>> +                           resource_size_t *max)
>>> +{
>>> +
>>> +    struct cxlrd_max_context ctx = {
>>> +        .host_bridges = &endpoint->host_bridge,
>>> +        .interleave_ways = interleave_ways,
>>> +        .flags = flags,
>>> +    };
>>> +    struct cxl_port *root_port;
>>> +    struct cxl_root *root;
>>> +
>>> +    if (!is_cxl_endpoint(endpoint)) {
>>> +        dev_dbg(&endpoint->dev, "hpa requestor is not an endpoint\n");
>>> +        return ERR_PTR(-EINVAL);
>>> +    }
>>> +
>>> +    root = find_cxl_root(endpoint);
>> Could use scope-based resource management  __free() here to drop below put_device(&root_port->dev);
>>
>> e.g. struct cxl_root *cxl_root __free(put_cxl_root) = find_cxl_root(endpoint);
>>
>
> I need to admit not familiar yet with scope-based macros, but I think these are different things. The scope of the pointer is inside this function, but the data referenced is likely to persist.
>
>
>  get_device, inside find_cxl_root, is needed to avoid the device-related data disappearing while referenced by the code inside this function, and at the time of put_device, the data will be freed if ref counter reaches 0. Am I missing something?
>
Yes, get_device() is to avoid the device-related data disappearing, __free(put_cxl_root) will help to release the reference of cxl_root->port.dev when cxl_get_hpa_freespace() finished, so that you don't need a put_device(&root_port->dev) in the function.

I think that your case is similar to this patch

https://lore.kernel.org/all/170449247353.3779673.5963704495491343135.stgit@djiang5-mobl3/


>
>>> +    if (!root) {
>>> +        dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
>>> +        return ERR_PTR(-ENXIO);
>>> +    }
>>> +
>>> +    root_port = &root->port;
>>> +    down_read(&cxl_region_rwsem);
>>> +    device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
>>> +    up_read(&cxl_region_rwsem);
>>> +    put_device(&root_port->dev);
>>> +
>>> +    if (!ctx.cxlrd)
>>> +        return ERR_PTR(-ENOMEM);
>>> +
>>> +    *max = ctx.max_hpa;
>>> +    return ctx.cxlrd;
>>> +}
>>> +EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
>>> +
>>> +
>>>   static ssize_t size_store(struct device *dev, struct device_attribute *attr,
>>>                 const char *buf, size_t len)
>>>   {
>>> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
>>> index 9973430d975f..d3fdd2c1e066 100644
>>> --- a/drivers/cxl/cxl.h
>>> +++ b/drivers/cxl/cxl.h
>>> @@ -770,6 +770,9 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
>>>   struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
>>>   struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>>>   struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
>>> +
>>> +#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
>>> +
>>>   bool is_root_decoder(struct device *dev);
>>>   bool is_switch_decoder(struct device *dev);
>>>   bool is_endpoint_decoder(struct device *dev);
>>> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
>>> index 8f2a820bd92d..a0e0795ec064 100644
>>> --- a/drivers/cxl/cxlmem.h
>>> +++ b/drivers/cxl/cxlmem.h
>>> @@ -877,4 +877,9 @@ struct cxl_hdm {
>>>   struct seq_file;
>>>   struct dentry *cxl_debugfs_create_dir(const char *dir);
>>>   void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
>>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>>> +                           int interleave_ways,
>>> +                           unsigned long flags,
>>> +                           resource_size_t *max);
>>> +
>>>   #endif /* __CXL_MEM_H__ */
>>> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
>>> index 2cf4837ddfc1..6d49571ccff7 100644
>>> --- a/drivers/net/ethernet/sfc/efx_cxl.c
>>> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
>>> @@ -22,6 +22,7 @@ void efx_cxl_init(struct efx_nic *efx)
>>>   {
>>>       struct pci_dev *pci_dev = efx->pci_dev;
>>>       struct efx_cxl *cxl = efx->cxl;
>>> +    resource_size_t max = 0;
>>>       struct resource res;
>>>       u16 dvsec;
>>>   @@ -74,6 +75,19 @@ void efx_cxl_init(struct efx_nic *efx)
>>>       if (IS_ERR(cxl->endpoint))
>>>           pci_info(pci_dev, "CXL accel acquire endpoint failed");
>>>   +    cxl->cxlrd = cxl_get_hpa_freespace(cxl->endpoint, 1,
>>> +                        CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
>>> +                        &max);
>>> +
>>> +    if (IS_ERR(cxl->cxlrd)) {
>>> +        pci_info(pci_dev, "CXL accel get HPA failed");
>>> +        goto out;
>>> +    }
>>> +
>>> +    if (max < EFX_CTPIO_BUFFER_SIZE)
>>> +        pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
>>> +                  max, EFX_CTPIO_BUFFER_SIZE);
>>> +out:
>>>       cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
>>>   }
>>>   diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
>>> index 701910021df8..f3e77688ffe0 100644
>>> --- a/include/linux/cxl_accel_mem.h
>>> +++ b/include/linux/cxl_accel_mem.h
>>> @@ -6,6 +6,10 @@
>>>   #ifndef __CXL_ACCEL_MEM_H
>>>   #define __CXL_ACCEL_MEM_H
>>>   +#define CXL_DECODER_F_RAM   BIT(0)
>>> +#define CXL_DECODER_F_PMEM  BIT(1)
>>> +#define CXL_DECODER_F_TYPE2 BIT(2)
>>> +
>>>   enum accel_resource{
>>>       CXL_ACCEL_RES_DPA,
>>>       CXL_ACCEL_RES_RAM,
>>> @@ -32,4 +36,9 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>>>     struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
>>>   void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
>>> +
>>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>>> +                           int interleave_ways,
>>> +                           unsigned long flags,
>>> +                           resource_size_t *max);
>>>   #endif
>>
>


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-yw1-f169.google.com (mail-yw1-f169.google.com [209.85.128.169])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B3A0C2AE6C;
	Wed, 24 Jul 2024 21:32:24 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.128.169
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721856746; cv=none; b=jnXmJKqOYDojScDZr1GxINLrROLRJ87iSHhz9tidY3juDbH/gFpwC8hFxU3WEUhnCVaFseXj5acTYscRPOd7P36XtiYysRdpFvZad8O1ZepHStbnk6OnGq07b4AenP6wjfwezpIafVKg1vFiDSZIidHKqhrQdFuvC2Bj9lwF3SU=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721856746; c=relaxed/simple;
	bh=+ceRbvkOAsiXk+0vxG/RnajAafcgaRWEjhFXGM+A8OQ=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=UreRbXsIMCCjkEhbiYklmxVuJYVbQ13wxDzqTpCI0pC+0o7OChgrUfpeot9VmG0cJhgwQsIb1SNkhHbZVKahy0lXOoEjh3jxEqS9Iv/dBVKJAequRfe0e7m+yOsJoTTq6G7rBASos8XbGi3QRCJD9MCXrGOa1QgIicgMaxbFiZM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=G1P64xPd; arc=none smtp.client-ip=209.85.128.169
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="G1P64xPd"
Received: by mail-yw1-f169.google.com with SMTP id 00721157ae682-64f4fd64773so3182397b3.0;
        Wed, 24 Jul 2024 14:32:24 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1721856743; x=1722461543; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=gkBRhoPvjuzb7AB9u4D8EiiPMWnQNiwyXDpxcHy1w2U=;
        b=G1P64xPdl/N85hUSvOvRggW4/tq7uCTzUjy/XF6z2PvriKFtyNLt1A6LCbu21vivWc
         RjHqKehbRjFLzvB2QykPbyefF4xyx+8TdOZvP2PH2l1iMBsYxW1G+gRfTfiyDInsTY2K
         soI+gnhSLeoa06g+LN8jNNRDReg8IDlrp2zMTkos6DA+zlNav/zfz2UySE5ork0HlDIv
         Wm306zupqKj0Fg3oJWLmKQpEg9U0TrC67OOlkJWZn3TbNR+Ob0ojlAkKZfwy2X5h6/O5
         MLtGSb6EyJANv94BMV5zPSkpSMWluiD9BeowigFGRwFLxYBB0wGi1uK3EXM8dnXUeAoM
         Xkeg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1721856743; x=1722461543;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=gkBRhoPvjuzb7AB9u4D8EiiPMWnQNiwyXDpxcHy1w2U=;
        b=tTH9sq7PUHAXIHWo934tU/V3GIhJd04w6qzE7A73+qbLLstLYzf6SQ/ddlThbFWEwb
         Sutblv8+Sdbyo7nme6VC4Yry73HgnEikXT9nJKFbsEQ4v6E3EK+fsAA5JVxHDsrgZE5W
         ZDfXXEafL5QFZyIjc1BX/+5Z4nS8bLMcmP/gHOWETAeyx/B+fK6IHfjPrnRN6gNgL7tw
         FSf/nNtJ5aIXZn13oMniE7d+yHTNvBdpKoXLsAuBLVs/6tm9Ay0V8kOnCPJUxZQ0CSiq
         uG+p5T9ALEDOme+6zlV/2aH/VmMRjPvySHFMdcX5jPy0j3/sx8ezMBAiNcgN10bNgJeI
         fRXQ==
X-Forwarded-Encrypted: i=1; AJvYcCXhG/THSQZA4FOKX3yvRGYGGfOXEBcXcp1SlxCjh20cR349DoyRiGM84vpy1ZsLwzH01pmHJBM6NfXSNPu6lf8/WSinnZP8
X-Gm-Message-State: AOJu0YyQGidVgvT5hLHNI8lKmSDrZxV9d2wDQn0V/Qhl6iaYZnkLy/2I
	iOJ1eVAS9mFYJwX21mfKDLG/7vgScEin8/5tMmix2C/bj8A23caE
X-Google-Smtp-Source: AGHT+IHsG9cid3UIa2iQSmsvwOYgxNuZ9ZpoicAuwYcMFu9F6qhyGAPDsb3jX8kEpNCxMXz4f3KA4A==
X-Received: by 2002:a81:8541:0:b0:61a:d30f:a9c4 with SMTP id 00721157ae682-67510736cf5mr9345347b3.8.1721856743552;
        Wed, 24 Jul 2024 14:32:23 -0700 (PDT)
Received: from debian ([50.205.20.42])
        by smtp.gmail.com with ESMTPSA id 00721157ae682-67566dd9000sm389127b3.27.2024.07.24.14.32.22
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 24 Jul 2024 14:32:23 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Wed, 24 Jul 2024 14:32:21 -0700
To: alejandro.lucero-palau@amd.com
Cc: linux-cxl@vger.kernel.org, netdev@vger.kernel.org,
	dan.j.williams@intel.com, martin.habets@xilinx.com,
	edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
	pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 07/15] cxl: support type2 memdev creation
Message-ID: <ZqFy5Qsg_uLncLRr@debian>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-8-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-8-alejandro.lucero-palau@amd.com>
Status: RO
Content-Length: 5687
Lines: 146

On Mon, Jul 15, 2024 at 06:28:27PM +0100, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Add memdev creation from sfc driver.
> 
> Current cxl core is relying on a CXL_DEVTYPE_CLASSMEM type device when
> creating a memdev leading to problems when obtaining cxl_memdev_state
> references from a CXL_DEVTYPE_DEVMEM type. This last device type is
> managed by a specific vendor driver and does not need same sysfs files
> since not userspace intervention is expected. This patch checks for the
> right device type in those functions using cxl_memdev_state.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/cdat.c            |  3 +++
>  drivers/cxl/core/memdev.c          |  9 +++++++++
>  drivers/cxl/mem.c                  | 17 +++++++++++------
>  drivers/net/ethernet/sfc/efx_cxl.c | 10 ++++++++--
>  include/linux/cxl_accel_mem.h      |  3 +++
>  5 files changed, 34 insertions(+), 8 deletions(-)
> 
> diff --git a/drivers/cxl/core/cdat.c b/drivers/cxl/core/cdat.c
> index bb83867d9fec..0d4679c137d4 100644
> --- a/drivers/cxl/core/cdat.c
> +++ b/drivers/cxl/core/cdat.c
> @@ -558,6 +558,9 @@ void cxl_region_perf_data_calculate(struct cxl_region *cxlr,
>  	};
>  	struct cxl_dpa_perf *perf;
>  
> +	if (!mds)
> +		return;
> +
>  	switch (cxlr->mode) {
>  	case CXL_DECODER_RAM:
>  		perf = &mds->ram_perf;
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 58a51e7fd37f..b902948b121f 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -468,6 +468,9 @@ static umode_t cxl_ram_visible(struct kobject *kobj, struct attribute *a, int n)
>  	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
>  	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
>  
> +	if (!mds)
> +		return 0;
> +
>  	if (a == &dev_attr_ram_qos_class.attr)
>  		if (mds->ram_perf.qos_class == CXL_QOS_CLASS_INVALID)
>  			return 0;
> @@ -487,6 +490,9 @@ static umode_t cxl_pmem_visible(struct kobject *kobj, struct attribute *a, int n
>  	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
>  	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
>  
> +	if (!mds)
> +		return 0;
> +
>  	if (a == &dev_attr_pmem_qos_class.attr)
>  		if (mds->pmem_perf.qos_class == CXL_QOS_CLASS_INVALID)
>  			return 0;
> @@ -507,6 +513,9 @@ static umode_t cxl_memdev_security_visible(struct kobject *kobj,
>  	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
>  	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
>  
> +	if (!mds)
> +		return 0;
> +
>  	if (a == &dev_attr_security_sanitize.attr &&
>  	    !test_bit(CXL_SEC_ENABLED_SANITIZE, mds->security.enabled_cmds))
>  		return 0;
> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
> index 2f1b49bfe162..f76af75a87b7 100644
> --- a/drivers/cxl/mem.c
> +++ b/drivers/cxl/mem.c
> @@ -131,12 +131,14 @@ static int cxl_mem_probe(struct device *dev)
>  	dentry = cxl_debugfs_create_dir(dev_name(dev));
>  	debugfs_create_devm_seqfile(dev, "dpamem", dentry, cxl_mem_dpa_show);
>  
> -	if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
> -		debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
> -				    &cxl_poison_inject_fops);
> -	if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
> -		debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
> -				    &cxl_poison_clear_fops);
> +	if (mds) {
> +		if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
> +			debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
> +					    &cxl_poison_inject_fops);
> +		if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
> +			debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
> +					    &cxl_poison_clear_fops);
> +	}
>  
>  	rc = devm_add_action_or_reset(dev, remove_debugfs, dentry);
>  	if (rc)
> @@ -222,6 +224,9 @@ static umode_t cxl_mem_visible(struct kobject *kobj, struct attribute *a, int n)
>  	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
>  	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
>  
> +	if (!mds)
> +		return 0;
> +
>  	if (a == &dev_attr_trigger_poison_list.attr)
>  		if (!test_bit(CXL_POISON_ENABLED_LIST,
>  			      mds->poison.enabled_cmds))
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index a84fe7992c53..0abe66490ef5 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -57,10 +57,16 @@ void efx_cxl_init(struct efx_nic *efx)
>  	if (cxl_accel_request_resource(cxl->cxlds, true))
>  		pci_info(pci_dev, "CXL accel resource request failed");
>  
> -	if (!cxl_await_media_ready(cxl->cxlds))
> +	if (!cxl_await_media_ready(cxl->cxlds)) {
>  		cxl_accel_set_media_ready(cxl->cxlds);
> -	else
> +	} else {
>  		pci_info(pci_dev, "CXL accel media not active");
pci_warning() ??
> +		return;
> +	}
> +
> +	cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
> +	if (IS_ERR(cxl->cxlmd))
> +		pci_info(pci_dev, "CXL accel memdev creation failed");
pci_err()

Fan
>  }
>  
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index b883c438a132..442ed9862292 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -26,4 +26,7 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
>  int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram);
>  void cxl_accel_set_media_ready(struct cxl_dev_state *cxlds);
>  int cxl_await_media_ready(struct cxl_dev_state *cxlds);
> +
> +struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
> +				       struct cxl_dev_state *cxlds);
>  #endif
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-yw1-f169.google.com (mail-yw1-f169.google.com [209.85.128.169])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 12D066F068;
	Wed, 24 Jul 2024 21:25:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.128.169
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721856334; cv=none; b=V3oK/vGH/hhuQ+AQDFD8M3yGic7ne5FBpStBYePfenaeavlLZs3C6nbIOs/uZyEuwS+wyUJj8crr8HQ/VO0b0pS/XB7N8vx09uihWJltBAIncrVofZXFZP8GN0pRGzXuJVKMkdStNvwNdB/nd6SSVAGNzrJiytdW2t5BFRZPudI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721856334; c=relaxed/simple;
	bh=1NH08U6BGBVe8khrqnXgkPBVMo9qPyuXxOiZxEmiL7A=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=QrgCDhHxpnzz71UONj0ZyiP+TaUl8xgvU5S2t5qpdOh7U9CEmFtPoSgxLidTtIRFE8PO7y18CmRYIyupQVJWlsOpkMMAYVojUCaUHvuWKULbuQPnxGTqVVJhLL2b3Xw13ZZ6UNqzvrl2f5Xk2ymwTEKvWrTgjtbSprGlqAB+Ycc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=aA4uWSIz; arc=none smtp.client-ip=209.85.128.169
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="aA4uWSIz"
Received: by mail-yw1-f169.google.com with SMTP id 00721157ae682-65cd720cee2so2553747b3.1;
        Wed, 24 Jul 2024 14:25:32 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1721856332; x=1722461132; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=wXMzawJgF7d8QM1EjmcWHU4EhRglJETzEU0mZ5bhStg=;
        b=aA4uWSIzAUCOXQchhHRvt/llWp76jYldvn7AGn6J4sJTJ7txIQdu9WlRjaXW4KeRUY
         AF0tPNQBZtQcsePtVT3ck0mSm0vt8cDgwaGemETMxs4bJQ9PTgqPu5ztBEQzoFX45+fA
         GiIZo0137D7CiWFZ8m/z6j/6R3eHPiOeBu2ef7QZXq9+bqbH5IpFU6arkw8Dloeh5yl6
         5st2i4Vz6UxZYIPUjrpLW+9b2D2FFZNtexlqjBapVF1sXP8o+T4AVa7vjTOkXcJhp60I
         oSyfK1/Z/HC38ZXtkGNxTo6/FjHVZG8tOJw16MBWvS34Ptq3TfkL09ngx29v9BcIlyAq
         IVTw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1721856332; x=1722461132;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=wXMzawJgF7d8QM1EjmcWHU4EhRglJETzEU0mZ5bhStg=;
        b=wtwEH+qjFY9e15AUXgvgxMr441wyUlcMy4ec4LVJzCQtFKztvjo0GMj73Cq5IofdpD
         5Akvcqev5vl+avHYJgk1w3GXtPjgT1I6jQ9WUHrodGruyuAlA7zLHrveT2N55YbIr2q2
         xVMLa984p9530fTPSzHi2zKxEQKAYLJEn8mLdf5Qt3BK7TSSwkihGR5auSXe6vEuhMeu
         ViF9OD4I0/bXvObBKI2l3ldFu98zZOwhGx6TNNNlOx1cc20qMPWiiDrksqB0mvQAdMzv
         mYiBkv3I8kH1fZJWi9m0OAQAWEbKkJbBzFcL/opJc1QC0VJspFdKgRJqDFe6/ovJD4u2
         xy/Q==
X-Forwarded-Encrypted: i=1; AJvYcCVKVRgprx0bQ2fmTUQBErMJFs8qL8Vah0CBVUTvRUMZouK+gQRKq3puKN183PaLIDj37zRINek9zAd/anWG6yaLgX93SmL5
X-Gm-Message-State: AOJu0Yyp3VIgj2Lp0zlpF+KVOTMYhEfF6tTI1QLUybrvWOsSmOEwu5sD
	cVve4a7L0JnmQEs5EtQUGYqY+a6V5jpukPta6l0Mg5mt3bmPTMe4
X-Google-Smtp-Source: AGHT+IEoAl+CJ57tB/r7tBH2TfairOoFqMQSaQgbYQvoiKceckzLiGz7uqh8WrlpD1uYZnNUeHpSvg==
X-Received: by 2002:a81:6e02:0:b0:61a:d846:9858 with SMTP id 00721157ae682-67511b60918mr8104047b3.20.1721856331852;
        Wed, 24 Jul 2024 14:25:31 -0700 (PDT)
Received: from debian ([50.205.20.42])
        by smtp.gmail.com with ESMTPSA id 00721157ae682-67566dd9000sm360627b3.27.2024.07.24.14.25.30
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 24 Jul 2024 14:25:31 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Wed, 24 Jul 2024 14:25:14 -0700
To: alejandro.lucero-palau@amd.com
Cc: linux-cxl@vger.kernel.org, netdev@vger.kernel.org,
	dan.j.williams@intel.com, martin.habets@xilinx.com,
	edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
	pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 05/15] cxl: fix use of resource_contains
Message-ID: <ZqFxOge1S654X4Uf@debian>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-6-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-6-alejandro.lucero-palau@amd.com>
Status: RO
Content-Length: 1418
Lines: 40

On Mon, Jul 15, 2024 at 06:28:25PM +0100, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> For a resource defined with size zero, resource contains will also
> return true.

s/resource contains/resource_contains/

Fan
> 
> Add resource size check before using it.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/hdm.c | 7 +++++--
>  1 file changed, 5 insertions(+), 2 deletions(-)
> 
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index 3df10517a327..4af9225d4b59 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -327,10 +327,13 @@ static int __cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>  	cxled->dpa_res = res;
>  	cxled->skip = skipped;
>  
> -	if (resource_contains(&cxlds->pmem_res, res))
> +	if ((resource_size(&cxlds->pmem_res)) && (resource_contains(&cxlds->pmem_res, res))) {
> +		printk("%s: resource_contains CXL_DECODER_PMEM\n", __func__);
>  		cxled->mode = CXL_DECODER_PMEM;
> -	else if (resource_contains(&cxlds->ram_res, res))
> +	} else if ((resource_size(&cxlds->ram_res)) && (resource_contains(&cxlds->ram_res, res))) {
> +		printk("%s: resource_contains CXL_DECODER_RAM\n", __func__);
>  		cxled->mode = CXL_DECODER_RAM;
> +	}
>  	else {
>  		dev_warn(dev, "decoder%d.%d: %pr mixed mode not supported\n",
>  			 port->id, cxled->cxld.id, cxled->dpa_res);
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2067.outbound.protection.outlook.com [40.107.244.67])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 81C63AD23;
	Wed, 24 Jul 2024 08:25:18 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.67
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721809520; cv=fail; b=imLhgyGhrUpfrjn/asPevUXAXMV4rrQtv5bceEYgLxN3nLQ5FeGlXe7NAUw/LuY1vHKKH8Ih7ZDgqM6GY3z5rPZtruofWDq/odNEH83i6nS5WZIiTIJORijxB3ub+JAGU9COa3KjMIl0NvOBnaOwplVk9h7lfQq2zBRxnp6onr0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721809520; c=relaxed/simple;
	bh=3/UV+RWmCe8UJdZaT8sPrEHgV0yhPgKs3SFsysnasS4=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=sIuuyz9Jt3//p3Y1QGaVClUxldaZ7yVWH+SpFxHEofdesMS8Ll+dqs7zt++TYUHWFoi4JVlsoLimg+F4dhTZqjIxKCsZ4B5ECVkWUjyWy8yRSEDIxXm3mChAOHHHCXIuJFHyOwHEdVnNCdsAEa2dLveJkpnIbid2CFunw1O1avg=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=Tn/Ldqv2; arc=fail smtp.client-ip=40.107.244.67
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="Tn/Ldqv2"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=I8Hn2NWOv4XV4OFUp/4RP+JZDsdWEj/vgQmHwVXr7cnt98f+7Oy9uUq6Y14GID4ANQ7SbYrRJtGjEYEQldFYkl+YZvaQOJtKWIZBccCncGciA9ock6pLPtxclvmzRgWUHs2CrqNQHxqM/+YP9NyejEiiOw37P3OfQqVZI+Dt/tPBAnBRJlecKkT3e28hjfDgL9w0fMxxn37E2b0l1q1v/SbdoNt1S3eOAD6ct366X1a41F0xisOEp0XUs6OrZ9fs3+2D0XY1Kub9IxokFC5Q2F29TfIoKX3ANcNJ0zTHvTs3oOAyhgKTPz0q3oWdoVfzHYuj4dt3sZMjQz52RFAJlg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=w71eBTfLtYSGYpS+Qw1AggejR1MoUEQe6+4NQvKhbf0=;
 b=klDoPE/JD6d23CQkj0xa2trFsffgmaiTtOsWPMnG8siGJdtx6fdNSLVmmweCEp8JCNe+9ucBki++3oRZ75Rips+6NGirtQjvU11M20orKFXQ88zm+LKsKueCqJmPhmfIkD8+8U7tnbJx1SXyqIgVZDJU+fAmY3jAdlZ6ZQGENEt3pl1d4u+UtVJjlEWl7L6nS0Xb71BBVPz1wZAzpPAFHyVsZRdLfKEhlZ5Higs5I2o0d/90WGi0nC1PeSTmWqgbGv/ewNmzBdddXUmoGRgoq2Sq/WQ4EP3jWTdOle369m/r5rbkFZ5oaXNEtgMIDv/NQvHogSuLOn/lBnHEsDK7RQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=w71eBTfLtYSGYpS+Qw1AggejR1MoUEQe6+4NQvKhbf0=;
 b=Tn/Ldqv2WIbklQKJ+bCi+5xLtmLd2L7e9mtU5TkdiuIhDfwExKyY4LN/80M0sCfb0NXXmybnHGrVww6xfg7LRzUl21TV0+iewhVnJjGsJizeZVtZHHGE7UGIz4/2GZLRVkDjUuj/SiHYeFDbpfmFjRQyKOY9Ws55yyIl7M6LTLA=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by IA0PR12MB8086.namprd12.prod.outlook.com (2603:10b6:208:403::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.16; Wed, 24 Jul
 2024 08:25:14 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Wed, 24 Jul 2024
 08:25:12 +0000
Message-ID: <f40312b1-8ac7-973b-5519-ee185eec8560@amd.com>
Date: Wed, 24 Jul 2024 09:24:40 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 09/15] cxl: define a driver interface for HPA free
 space enumaration
Content-Language: en-US
To: "Li, Ming4" <ming4.li@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
 <73311003-6b8e-4140-935a-55bd63a723e6@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <73311003-6b8e-4140-935a-55bd63a723e6@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P123CA0663.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:316::10) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|IA0PR12MB8086:EE_
X-MS-Office365-Filtering-Correlation-Id: b35dffa3-c33b-44a8-5eda-08dcabba235b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|1800799024|366016|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?REwvRENiZzcwVWhvK3gyR0V4N2tkd2JWZWwyVmlIbTEzVnp4cUJFN3hDajRG?=
 =?utf-8?B?dDR1L1RTeWNPQVF3dlo0MnBEQVR4Wnp1WTJSd0Q3TjUrdHlYMGJQWkZMeHhS?=
 =?utf-8?B?eisrZzh4Y3BNNFVhaUk1MnNZUkkwYXBhY0l6VTl5c0NEdkJXWFJWclVFR2dG?=
 =?utf-8?B?L3crNGV0cjFvUXVNRk1xcjllYnJvUzBtT3YycGMrU1BhWjBSdlVmTzZEYkM2?=
 =?utf-8?B?ZGFzcmRFa0IrakxjTFE0YTZHUVdjR05BTktXazc1WEo5NjV0RDJHRjd0RlFu?=
 =?utf-8?B?ajZBeW1HRzQ2SmROK0VUaWFhNk9iY0hFZVkxMG9QZlB3WTY1My9PVm1QaU9L?=
 =?utf-8?B?NVdxOGlrZlpKb1RmM1dJMUh5TVEvTHpCRjNHbng0dXl0WEgvaDF3ZmxNVFpv?=
 =?utf-8?B?d2NlZkFuY1N4SzJwQzhKUDlKeHdMTTg5amVXWldwc3VLaGxnMXBDK3p0K1J3?=
 =?utf-8?B?akNrbEw0ckgrdFk0a3NDQjJWMHFuT2taWFh3aXlxdEtXZ2o5OWtBcEVsUE9F?=
 =?utf-8?B?NXQ5TGhFMWg4VVp1aTd4RStuUW84T1NWN0p0UTJHc21LQ1pvR1g0UHdYRFlm?=
 =?utf-8?B?c2drVnBqY2NEcjhUbGtweUxtMEpjSFNRL0FYNzZpblBLekl5RFo4VG1ueXV5?=
 =?utf-8?B?aG5Jd0xVdEttMksxR1BLLzgwbU8yZ0ZwTWp2bzBQL2NiTG52cW1GVGdwNkpa?=
 =?utf-8?B?TElEb1VPWjh6TWJYL29JTHJSVXptNEMwRGlkZ253L3FldlZpK2ZaSmdzbXdE?=
 =?utf-8?B?cjRHdGJzTnUzRU9WT3RMUlU2RjdOSm9KS2ZvbkQzQ1dJUDgrTnlWa3QxOERv?=
 =?utf-8?B?YnI1Mjh3blFPSzdJTFhNbHkrdnUvT0hlU3Q5YjhTakJ5ME1mV0NTb1dNaVc4?=
 =?utf-8?B?ai9vSHR3N0VwbS8yMHFoOEI1RnJxV3FIWVlLbFZDNjF2Zlk1UnMxZVlmVytK?=
 =?utf-8?B?eGRvVmRCeXFPTFFDNUxqbmcyUU9NNGRUTEhZSDd0M1pUY25LTXA5YjQ0Nkdo?=
 =?utf-8?B?dEwwaVg2ZFNRcHRMdkdjaDcvUkJETGxXSkZPeWlkWEQxZ2ZVNGZBSEFuVFNa?=
 =?utf-8?B?dnhYUm5EaXZPc0tiNHd5ZWJEOHNYcW02NVJGNzVPeEtJTkxpdFg1TllSR2dL?=
 =?utf-8?B?R2NBWnVmL3hLMVFNREI4emo1ZStoTTVxemNrUU9iU3JWbDlzRENHYUorc3pR?=
 =?utf-8?B?eHk5emhxYnFIMTNSUStrcjhIbWQ1c0R1REpPNHJ5ZE1BR0l5TTlGNjVWWGln?=
 =?utf-8?B?UUJ6WG5zdjVPZVlGWnR2K0I5RnBsYWV5MTRWL2gxUFpXcytVLzNpRXozV0h4?=
 =?utf-8?B?cXpPbmlPRTZlSEx1NCtVNDFmaExBb2dybnVPR1MwNWN5RW1RT0ZtWjQzaElW?=
 =?utf-8?B?WHlCQThyS3NYSk02bEN1L2lyNGczN1JwUm1BVGx5U2FpckhtMm4zMWtBeUlR?=
 =?utf-8?B?TUJ1c05TWDJmNXZQam1iVDEvb1I3bEZGRjdmRUY0VFl5ZjdrOVlEQ2hhZHdK?=
 =?utf-8?B?bkdkWTY3dFNBOURleTVwcjFkYkQ4eFV0cUpQci9zeVV5aFdYcm1IWkgrYzda?=
 =?utf-8?B?K2JlL2M4cGt4UU1BUzBObjlYcHBOSDhHTUZyTFIzUCtMRHMrS3dZY3dMY3NY?=
 =?utf-8?B?V3pRZ1pjbllQVmJuSkJCenYxUmZRWGg5My9QQnhuZ0lhODU1bmRNZXpaYVph?=
 =?utf-8?B?MFJHSU93ek1SWmJqU0NyK0kwWVlyQ1hPUDJqU21aeFZhNkE4cEZPZjNOdlBC?=
 =?utf-8?B?WmluR2hrUFBIZXNhNzlYVFNXWmVQd01sV1gyOHpqMmR6VTlyQTE1aFU5WVl0?=
 =?utf-8?B?N3dOemZITnRiRXdaTkR6UT09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(1800799024)(366016)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?VHhHQ0JCM2VIV3ZzNmNwcmdNVlBzUCtIV1JCbGFVSi9IOWhlMFZTRStuemNO?=
 =?utf-8?B?YXpmaC9JNkEwZitPaVRVWVRLUmZwV0VhT01PL3ZuczRad1ZRVXBucjNiSXp4?=
 =?utf-8?B?ckhmbjd6YTBBNjhDd2tzc3IwYWNsZC9vNkNZckluc3g5eUdPajBMQ1d0NmRS?=
 =?utf-8?B?T29MU0ZnQ3A3czFHczJrblgrZ3VGUjBvcWNjcGxSSk9MbTRCZUFnZElwRWhH?=
 =?utf-8?B?d1ZlMDlpbGhCTkx5WWJnUXRHSmRjaTNFeHRYVVBtK2RHUnpSKzY3TDRwdE1F?=
 =?utf-8?B?cEhJREVoZEFPQmR6ZlJhclA3Umo4amN1dUQyQUZ1QjNsbS96VU5rcFZNZ0Vp?=
 =?utf-8?B?ZXZjbHVxZWVZRWNlVmM5RG51SVhIejV3OXBFbTRaY0NCWGZ5c0VJZ0k1elVF?=
 =?utf-8?B?NWNIM2RNNjF4QThlNUNZVllYQVdTZWhaU1dhaTA5ZVhZeEtiVXJjeHQ0Mmx1?=
 =?utf-8?B?NzN2WEQvbGlDWllVRUNRK1d5UVVaazBIWWtJMmFEYy9lRW0xSC9MN2UrK2tC?=
 =?utf-8?B?YWllVmk4OUV6aFRrMk9YRG5VZjVXV2w5NURsVWtZbmZsMXc1UjBzRTluUmc0?=
 =?utf-8?B?SGRVYVRNa1JhdjdGQk01eHFpaDdCOUd2K25PTjdESjJFdkcrUUI3WjBiYlJF?=
 =?utf-8?B?YlVodG1mdmdsbWtBZEpIaTluSVd5eG0rVDFYYXcrMlFsNUptUE9PeXkvSUJu?=
 =?utf-8?B?b3NZSDRUQkQyQlhtNk1HS2RFOXBuOGRSakZYdGtJR3I2bk04c3NnMWRVSHN6?=
 =?utf-8?B?ZWZIUG5LZVFqMEg0RDZJTUVZdzNqL1lxWVdFN2VFZWhZalpWdE1Ea2Y3SXNE?=
 =?utf-8?B?RVhyblJZMjN6a2FWQmhDVVNVR1dwMUZXekZGV0VmRVZNRTFXZXorS1FFSmdn?=
 =?utf-8?B?bndVSEI4NHRZVnhWMUdKUUErbHIxcEo4Yy9rMWtxTkJGOHZ5SVpmQStZTWdP?=
 =?utf-8?B?V3Y3RldYdWJza3c3VTFLeHdmSUxiOWFKeWhXZWIvajdkenAwUW1ZaHpLck9n?=
 =?utf-8?B?NXRsSDNxY3JxaWhwMHNGSmF2Qm01aGsyMnRiZllRd010Ti9hNmJxdmsyeXll?=
 =?utf-8?B?Lzk2MmtGcVJIWWNkZUJsUHMvamRnTVJrazAxZTl0a0t1OU5nUTRLUVVyM0tS?=
 =?utf-8?B?Tmx4Y00wck1VM2ZpZXBBZmxlc2VHMDZhMjVCOGhWNmNvT3pmNEZzei9jNU9x?=
 =?utf-8?B?dXlSMC9QTHlnYnB4NkFFRHNFY0xWVC9xQnRUWWFNL080dm5xRHdHek4yUHRY?=
 =?utf-8?B?L083UnI0clUxVkFwd0RvOC9nQWpvdmdMcEdyVC9hMWlCR1FSdmpkb1VBK0dl?=
 =?utf-8?B?R0tzcXhsTUd4TnRONnp2Y2FCMXZMOWc5Q0tpMlFuazVRRmJsTnFmRHZ2YWNV?=
 =?utf-8?B?RldpYXhMVlFqdGJ2ZXdRa055cVl6M2V5YXFReWFrYTYyY1BWZDlvejZ1Y054?=
 =?utf-8?B?NFFRR3B1cVdzdXRrUklDOVJFV1BKNkRmcnN6Sm1VWHorR1YzQjIyaW10ZFhh?=
 =?utf-8?B?RHNsWUpDZ3hVL0lQdWpLd1U4NnZwSHhOTjBtS1ZHMEJoeXowbFJheFM0bUZm?=
 =?utf-8?B?ZjRnejRQSjhNSVVSWXlUZyttclJXWmYxUkpTNWZaUzJBYnU3a05scDBHMEVU?=
 =?utf-8?B?K3c2cHBOOGo5MzVpMFlkNC9IZkYvTS9lZzM0QmpmbXkzSG56Z2wwbkFWNzVR?=
 =?utf-8?B?cHk5K01NTVBKdVROYm0yZmRudVQ1a1dCcnZUbXNTYU5hSGkwUHlSZ2tOMWZt?=
 =?utf-8?B?MXFjcVVPclFIc2Z1MllrR24zUHU1ZVRQK2ZsN09rRVVNdTcxbVJ1R1NJTm5N?=
 =?utf-8?B?aUVpL1ZhT2RhZzAydUlBY0owNHJWZHkvc2k2SXBLZVZRS2U1eXNMc3JBUXg4?=
 =?utf-8?B?R2RHN3plRmlrLzBiT1ZQdWQ1R0xJN3dady95cWMyUVNFcEJPQVdoNzZ6RlJK?=
 =?utf-8?B?S0hDWUlzZ2FEcVcrR04zcDBFVjljTzNtUVpOQ0V0Q1V1bDN1SlNwZmZwTytj?=
 =?utf-8?B?V0wrV1kwMmVFeXpqeCtSeEQzUVZDdi8vM3JMS3JtdjRNNWpRZzIyQTl0cEZK?=
 =?utf-8?B?Uk56T2FRWjVnSmZRdzc2K25WbkRPQUw2eFh4dS9CbGprWjRVM0lvK3lpTHBu?=
 =?utf-8?Q?3PLyCFu7b9b2NQYyv3RffEwLo?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b35dffa3-c33b-44a8-5eda-08dcabba235b
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 24 Jul 2024 08:25:12.8092
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: aKLszZkHb5bVH8wtLR3YKyp5Xavp0PkEGMwmcn9KUXsijOnHPY9FcGc7nGhM7kRe1rFhcARMVqHyI7fR8L+MUw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB8086
Status: O
Content-Length: 10790
Lines: 303


On 7/16/24 07:06, Li, Ming4 wrote:
> On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> CXL region creation involves allocating capacity from device DPA
>> (device-physical-address space) and assigning it to decode a given HPA
>> (host-physical-address space). Before determining how much DPA to
>> allocate the amount of available HPA must be determined. Also, not all
>> HPA is create equal, some specifically targets RAM, some target PMEM,
>> some is prepared for device-memory flows like HDM-D and HDM-DB, and some
>> is host-only (HDM-H).
>>
>> Wrap all of those concerns into an API that retrieves a root decoder
>> (platform CXL window) that fits the specified constraints and the
>> capacity available for a new region.
>>
>> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m6fbe775541da3cd477d65fa95c8acdc347345b4f
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
>> ---
>>   drivers/cxl/core/region.c          | 161 +++++++++++++++++++++++++++++
>>   drivers/cxl/cxl.h                  |   3 +
>>   drivers/cxl/cxlmem.h               |   5 +
>>   drivers/net/ethernet/sfc/efx_cxl.c |  14 +++
>>   include/linux/cxl_accel_mem.h      |   9 ++
>>   5 files changed, 192 insertions(+)
>>
>> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
>> index 538ebd5a64fd..ca464bfef77b 100644
>> --- a/drivers/cxl/core/region.c
>> +++ b/drivers/cxl/core/region.c
>> @@ -702,6 +702,167 @@ static int free_hpa(struct cxl_region *cxlr)
>>   	return 0;
>>   }
>>   
>> +
>> +struct cxlrd_max_context {
>> +	struct device * const *host_bridges;
>> +	int interleave_ways;
>> +	unsigned long flags;
>> +	resource_size_t max_hpa;
>> +	struct cxl_root_decoder *cxlrd;
>> +};
>> +
>> +static int find_max_hpa(struct device *dev, void *data)
>> +{
>> +	struct cxlrd_max_context *ctx = data;
>> +	struct cxl_switch_decoder *cxlsd;
>> +	struct cxl_root_decoder *cxlrd;
>> +	struct resource *res, *prev;
>> +	struct cxl_decoder *cxld;
>> +	resource_size_t max;
>> +	int found;
>> +
>> +	if (!is_root_decoder(dev))
>> +		return 0;
>> +
>> +	cxlrd = to_cxl_root_decoder(dev);
>> +	cxld = &cxlrd->cxlsd.cxld;
>> +	if ((cxld->flags & ctx->flags) != ctx->flags) {
>> +		dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
>> +			      cxld->flags, ctx->flags);
>> +		return 0;
>> +	}
>> +
>> +	/* A Host bridge could have more interleave ways than an
>> +	 * endpoint, couldn´t it?
>> +	 *
>> +	 * What does interleave ways mean here in terms of the requestor?
>> +	 * Why the FFMWS has 0 interleave ways but root port has 1?
>> +	 */
>> +	if (cxld->interleave_ways != ctx->interleave_ways) {
>> +		dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
>> +		return 0;
>> +	}
>> +
>> +	cxlsd = &cxlrd->cxlsd;
>> +
>> +	guard(rwsem_read)(&cxl_region_rwsem);
>> +	found = 0;
>> +	for (int i = 0; i < ctx->interleave_ways; i++)
>> +		for (int j = 0; j < ctx->interleave_ways; j++)
>> +			if (ctx->host_bridges[i] ==
>> +					cxlsd->target[j]->dport_dev) {
>> +				found++;
>> +				break;
>> +			}
>> +
>> +	if (found != ctx->interleave_ways) {
>> +		dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
>> +		return 0;
>> +	}
>> +
>> +	/*
>> +	 * Walk the root decoder resource range relying on cxl_region_rwsem to
>> +	 * preclude sibling arrival/departure and find the largest free space
>> +	 * gap.
>> +	 */
>> +	lockdep_assert_held_read(&cxl_region_rwsem);
>> +	max = 0;
>> +	res = cxlrd->res->child;
>> +	if (!res)
>> +		max = resource_size(cxlrd->res);
>> +	else
>> +		max = 0;
>> +
>> +	for (prev = NULL; res; prev = res, res = res->sibling) {
>> +		struct resource *next = res->sibling;
>> +		resource_size_t free = 0;
>> +
>> +		if (!prev && res->start > cxlrd->res->start) {
>> +			free = res->start - cxlrd->res->start;
>> +			max = max(free, max);
>> +		}
>> +		if (prev && res->start > prev->end + 1) {
>> +			free = res->start - prev->end + 1;
>> +			max = max(free, max);
>> +		}
>> +		if (next && res->end + 1 < next->start) {
>> +			free = next->start - res->end + 1;
>> +			max = max(free, max);
>> +		}
>> +		if (!next && res->end + 1 < cxlrd->res->end + 1) {
>> +			free = cxlrd->res->end + 1 - res->end + 1;
>> +			max = max(free, max);
>> +		}
>> +	}
>> +
>> +	if (max > ctx->max_hpa) {
>> +		if (ctx->cxlrd)
>> +			put_device(CXLRD_DEV(ctx->cxlrd));
>> +		get_device(CXLRD_DEV(cxlrd));
>> +		ctx->cxlrd = cxlrd;
>> +		ctx->max_hpa = max;
>> +		dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
>> +	}
>> +	return 0;
>> +}
>> +
>> +/**
>> + * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
>> + * @endpoint: an endpoint that is mapped by the returned decoder
>> + * @interleave_ways: number of entries in @host_bridges
>> + * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
>> + * @max: output parameter of bytes available in the returned decoder
>> + *
>> + * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
>> + * is a point in time snapshot. If by the time the caller goes to use this root
>> + * decoder's capacity the capacity is reduced then caller needs to loop and
>> + * retry.
>> + *
>> + * The returned root decoder has an elevated reference count that needs to be
>> + * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
>> + * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
>> + * does not race.
>> + */
>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>> +					       int interleave_ways,
>> +					       unsigned long flags,
>> +					       resource_size_t *max)
>> +{
>> +
>> +	struct cxlrd_max_context ctx = {
>> +		.host_bridges = &endpoint->host_bridge,
>> +		.interleave_ways = interleave_ways,
>> +		.flags = flags,
>> +	};
>> +	struct cxl_port *root_port;
>> +	struct cxl_root *root;
>> +
>> +	if (!is_cxl_endpoint(endpoint)) {
>> +		dev_dbg(&endpoint->dev, "hpa requestor is not an endpoint\n");
>> +		return ERR_PTR(-EINVAL);
>> +	}
>> +
>> +	root = find_cxl_root(endpoint);
> Could use scope-based resource management  __free() here to drop below put_device(&root_port->dev);
>
> e.g. struct cxl_root *cxl_root __free(put_cxl_root) = find_cxl_root(endpoint);
>

I need to admit not familiar yet with scope-based macros, but I think 
these are different things. The scope of the pointer is inside this 
function, but the data referenced is likely to persist.


  get_device, inside find_cxl_root, is needed to avoid the 
device-related data disappearing while referenced by the code inside 
this function, and at the time of put_device, the data will be freed if 
ref counter reaches 0. Am I missing something?


>> +	if (!root) {
>> +		dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
>> +		return ERR_PTR(-ENXIO);
>> +	}
>> +
>> +	root_port = &root->port;
>> +	down_read(&cxl_region_rwsem);
>> +	device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
>> +	up_read(&cxl_region_rwsem);
>> +	put_device(&root_port->dev);
>> +
>> +	if (!ctx.cxlrd)
>> +		return ERR_PTR(-ENOMEM);
>> +
>> +	*max = ctx.max_hpa;
>> +	return ctx.cxlrd;
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
>> +
>> +
>>   static ssize_t size_store(struct device *dev, struct device_attribute *attr,
>>   			  const char *buf, size_t len)
>>   {
>> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
>> index 9973430d975f..d3fdd2c1e066 100644
>> --- a/drivers/cxl/cxl.h
>> +++ b/drivers/cxl/cxl.h
>> @@ -770,6 +770,9 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
>>   struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
>>   struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>>   struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
>> +
>> +#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
>> +
>>   bool is_root_decoder(struct device *dev);
>>   bool is_switch_decoder(struct device *dev);
>>   bool is_endpoint_decoder(struct device *dev);
>> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
>> index 8f2a820bd92d..a0e0795ec064 100644
>> --- a/drivers/cxl/cxlmem.h
>> +++ b/drivers/cxl/cxlmem.h
>> @@ -877,4 +877,9 @@ struct cxl_hdm {
>>   struct seq_file;
>>   struct dentry *cxl_debugfs_create_dir(const char *dir);
>>   void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>> +					       int interleave_ways,
>> +					       unsigned long flags,
>> +					       resource_size_t *max);
>> +
>>   #endif /* __CXL_MEM_H__ */
>> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
>> index 2cf4837ddfc1..6d49571ccff7 100644
>> --- a/drivers/net/ethernet/sfc/efx_cxl.c
>> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
>> @@ -22,6 +22,7 @@ void efx_cxl_init(struct efx_nic *efx)
>>   {
>>   	struct pci_dev *pci_dev = efx->pci_dev;
>>   	struct efx_cxl *cxl = efx->cxl;
>> +	resource_size_t max = 0;
>>   	struct resource res;
>>   	u16 dvsec;
>>   
>> @@ -74,6 +75,19 @@ void efx_cxl_init(struct efx_nic *efx)
>>   	if (IS_ERR(cxl->endpoint))
>>   		pci_info(pci_dev, "CXL accel acquire endpoint failed");
>>   
>> +	cxl->cxlrd = cxl_get_hpa_freespace(cxl->endpoint, 1,
>> +					    CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
>> +					    &max);
>> +
>> +	if (IS_ERR(cxl->cxlrd)) {
>> +		pci_info(pci_dev, "CXL accel get HPA failed");
>> +		goto out;
>> +	}
>> +
>> +	if (max < EFX_CTPIO_BUFFER_SIZE)
>> +		pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
>> +				  max, EFX_CTPIO_BUFFER_SIZE);
>> +out:
>>   	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
>>   }
>>   
>> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
>> index 701910021df8..f3e77688ffe0 100644
>> --- a/include/linux/cxl_accel_mem.h
>> +++ b/include/linux/cxl_accel_mem.h
>> @@ -6,6 +6,10 @@
>>   #ifndef __CXL_ACCEL_MEM_H
>>   #define __CXL_ACCEL_MEM_H
>>   
>> +#define CXL_DECODER_F_RAM   BIT(0)
>> +#define CXL_DECODER_F_PMEM  BIT(1)
>> +#define CXL_DECODER_F_TYPE2 BIT(2)
>> +
>>   enum accel_resource{
>>   	CXL_ACCEL_RES_DPA,
>>   	CXL_ACCEL_RES_RAM,
>> @@ -32,4 +36,9 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>>   
>>   struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
>>   void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
>> +
>> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>> +					       int interleave_ways,
>> +					       unsigned long flags,
>> +					       resource_size_t *max);
>>   #endif
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2082.outbound.protection.outlook.com [40.107.92.82])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 372A9152DED;
	Tue, 23 Jul 2024 13:43:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.82
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721742240; cv=fail; b=pgUKxV3T3O/wBAN0hGM/i0KAdBkyp4vnuzjnaHRj8mjQGgVmcsiIr5lGokm1J/L9KUyv1/Y8vki7/ZFXxXzgqjGlFLtNvJI+adOWYAKnCE2erQqXlNqLNHb3yFl5b6XXCRL/K5gK/CUUerz3xvnW5rq4Q70jo2J30uUq/nit58Q=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721742240; c=relaxed/simple;
	bh=sypmGApwBWct34q8rSXQGMX7Z9mrNqS3lt5sg5rmD80=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=uEKTzrwsAwWwvWXFG0oVQBDhbC/ecQPVP9PRspNkvxDYb4rOIq/NHEk9lAYxyBVZd6wubZHqOwcCIw9ASJbuAOX7mXqdp/NB+0D5GE2lmyalc27A41RtSnRw1IoALkuh9fewUHe0ywOEBGdIQf3BCjJtDeOKCbTOYnseXwKEPS4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=yx2WrW1v; arc=fail smtp.client-ip=40.107.92.82
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="yx2WrW1v"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=oBZFTiNvcwijuwhf+mUfJNISvzb/OqZP4ugPk7JV4VUDpo4xKJf+hAeZOn2u0ig5az0J0B8gQOaX6xXdwzFVJ17lSLZyAec7yqC/yzPeLoJkmhWgtrbAz98HV8IaYoJxWecYX4DLBXycEf4EFeVAhIO04wVUz4H9SgYtV6zpun2bU0nakzBtDxJOCHnowHfW/a9eSCrUkAGp1rBx5r2Yf9mz5FG4WrS21VmPvvj+3KIsHBD4FO5sanTNX2Ll30rMfv2nFMMsuhf2XJtrLfEFmzUZR+iwXl351sgfHtfj3OaQ3PMZdNmlMiHCDR/CQ6ltSxporypL7zp+n7muokVucw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3b+a9QyXm8VPQdg3Q282L5MgszBJHCuRbTnv73j6YkQ=;
 b=BMjUeciATgJNwTJBMB8oIWOEzczoqxgdCbpeoNtvI0pBtiz6BFs8ohRcP5ZHWsVVXYMm4a4L61X/jQHCUcVWfZrFxE0V6xcTRSyPMVQkacEpTSQ7ZDp1U14BjytL7Rpv8KExXOiI0cOb3jLTaKe5f6iR+929nev+OWWZAkJTSXqrAu9bfBiBJMaQERfd00nh5/JI1Wm8AFVlK+QGmflllTHWKGp2V8kWtlXKjRhf7/tjCoiEljrFoxY+z6l1f8glc10DyKDUGoNreubWjQbT+yF2RpnzyTtT8qbowxoCNJe4o36lKx6cJC3BgQg5XTK9LYajpyJkpfQTU4eUuoj5TA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=3b+a9QyXm8VPQdg3Q282L5MgszBJHCuRbTnv73j6YkQ=;
 b=yx2WrW1vNyRwqbNzTr2TH726bS8+kFD8UkMdBy9n8EX/EppqXqv2u0chlNOp1OMKMNEX4U7wMbYm5pIqNf7QDCp2QW872yWdXeJSyTFiwmUWLmz+sHSksINA6/rjqGKucf4s3zBvuVDQMhET3f1oKKQyDHMGRT9AT6kFFS5ixX8=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB5975.namprd12.prod.outlook.com (2603:10b6:510:1da::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.18; Tue, 23 Jul
 2024 13:43:54 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Tue, 23 Jul 2024
 13:43:53 +0000
Message-ID: <7dbcdb5d-3734-8e32-afdc-72d898126a0c@amd.com>
Date: Tue, 23 Jul 2024 14:43:24 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 04/15] cxl: add capabilities field to cxl_dev_state
Content-Language: en-US
To: Dave Jiang <dave.jiang@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-5-alejandro.lucero-palau@amd.com>
 <e3ea1b1a-8439-40c6-99bf-4151ecf4d04f@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <e3ea1b1a-8439-40c6-99bf-4151ecf4d04f@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: DUZPR01CA0241.eurprd01.prod.exchangelabs.com
 (2603:10a6:10:4b5::24) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB5975:EE_
X-MS-Office365-Filtering-Correlation-Id: c396c0dc-289b-46f6-fa11-08dcab1d7dbd
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|1800799024|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?RjNrYWV1NnU4VDJuaitRems4U0kvMWwxdzFhU2Q2dFhGQUdLVmgvQ3JuTmhn?=
 =?utf-8?B?bjZKMWpxbzB4azRRVmEzMDRJOVQ3bDNETFZLdGZMTlRQa1hBSExoQkZQRXpN?=
 =?utf-8?B?NzlacnRqWk1nQnNUVDR1V3VYVEZQRkVwZEFDZXFCM0ZzRlBERFIvUi82MzJh?=
 =?utf-8?B?Nnc2eTh0RGsxMmM1ZHJiWlBnWVUzRFdTSkpKaDlpK0tUQ3ZudVQ1K2tabVll?=
 =?utf-8?B?Mm05VzI0YkE0aUFteHdKM2pyajlOdVZZZnFEWGlDT05qVGpIZnZqVk1Ic2Vy?=
 =?utf-8?B?WnZFTVBqOTRoaDlCdE9LTzZ3cWNHaTc0ZDZKbWVUSCsvaTA4djN4TFRJNzRk?=
 =?utf-8?B?Y1luR0JpNEtaR2tpOFRIbUppWEZVOEd4K1RVbjIyNk5kSGdMS0k3akhDeEti?=
 =?utf-8?B?RXUvQVZ1UkorK3NnenFPajBoRWUzVTVRY2pnRkYvOUVwdGo1UUpvSVg4L3RL?=
 =?utf-8?B?NFhvVE1KUTFnd1YxblN2Y2VEZWM4VTJoR1RiSXoxNXYxcXFwUmZGcGZYNVoy?=
 =?utf-8?B?KzE3Ty9LQXV0RndSeURFSEJiSm9NdTZKaFFoaDZiRzZGWU1jcGovdFUzWGxH?=
 =?utf-8?B?c3N1eW43Z2FVNEg5czFQUlFwR2FMRE1LREVuWFJWSlNuZDNOMG01dnQrNTVo?=
 =?utf-8?B?Uk5NNEkyLzBLa1dmdUR2OENaUExRR1NVK05ESG81NUpwNFNqREZIdmdEV3k1?=
 =?utf-8?B?ZTRDcnNSdjl6WUxrVE54YlVpKzZ5WUxLS3c4Y2IyUFZPbXhTZXU1MUNkVWRa?=
 =?utf-8?B?RmNmdEpDcXZiTWwzTFIwMWFNeGtCS2RmVG5DWDBZWHBrUmUxT01PMC9WblB0?=
 =?utf-8?B?MUI5bzBjYzlxejlGUjYzdXQvTGxMOG0wRDFDUGFSaGd2L3hncnpuS0dlNDJu?=
 =?utf-8?B?aFY1WnNHTmJiL20yUFFCZ3F5SHpnZXlWWWdjVTgybzZ5d0FScGgwVGlVQmxT?=
 =?utf-8?B?citpOFlQWjMzcFZ1QmI5N3FwQU16T2pHS1ZvV0FnUjVjdzNGUFk0UVZtOElF?=
 =?utf-8?B?emZCWTBuOWR4T3pHNE01Q05sQS9JMmsyZ2NGY0hCQ1RvRUk5ek1WWU4zcVlK?=
 =?utf-8?B?UzdoMHNpUVo0ZGZTUFpsMHhDODRkMG5yaDhyckIrMEU3MXFWVW5uVzJWSnVH?=
 =?utf-8?B?U0xHbkNtQnhhcys5c3loMkhoL2Z4SGkvdU9DeTBKQjJTZWJpbFZEKzZ3ejZh?=
 =?utf-8?B?c2FUV2dRcjdzTnZGZE5QWE13Tng4dFhsNUcvNERuZ3BQZUhKY3gxanBINGl1?=
 =?utf-8?B?R0dNWEt0M0d0Nk5uVUNUYjlsTUpUbTBldTBtUUhMR3I0bmE5MVczcVRoVU5W?=
 =?utf-8?B?WXpQSnREVkRlMXhNelNBdHRvdW9tWnl6WnlYUmRTaVh0alRtdXNkTC93MDdo?=
 =?utf-8?B?ZkpacENOWXlsL05ucWR3eUlwSGVDcWY2Vlp6d3VuMitRUHc1QmRLeElpck1N?=
 =?utf-8?B?MnAzR2ZJbDBVWHJUUWxveVN0T1dESzIxUnIzZWFxSms2SlFLeStoTEIxVjg0?=
 =?utf-8?B?cmFiMWF2U2U5UXl2U1FWRWJDMFZybnBHUEJ2L09UN2Zsckh0K3p0cW5rR0to?=
 =?utf-8?B?dGlmYk9Hclp1QzJjdHk5cWkzVHZOMUFEeHhnSlYrRW54ZnVTUlBsOTZJNW1y?=
 =?utf-8?B?dnZobkZ3ZWQ5aHlCQldXcmlsY1F0d1BVREVjdlhKMUhYVHdSRWc1Y0d6SEJ3?=
 =?utf-8?B?TlpjUXVMSldsdW10RHB1cHBINHp6bjR1T21BdnFUZ3VmWnhUeGI1aTZJQng0?=
 =?utf-8?B?djVGbzRhKzJ0dndXUGVac0JMUDhYc1B4THNWZSttYmdXOHJlMXQvcmtoNEJp?=
 =?utf-8?B?ay9BMnFsMm1JRGZoeWpzdWphR09Bb3FzMWFGSmZLdE40RERMRGx1VkV4Vith?=
 =?utf-8?Q?KIfgrU3jb/Qa9?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(1800799024)(376014)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?c01BMG9kdFhUVmdrUFlxMGN5bzFNd3FnMC90Z3FJTzltYmJQME9PbnlGNnZK?=
 =?utf-8?B?a243Zjh6RWFmSWF3dy9HVmpoZTFmc201ZC9TRGZqZEhZTzVoQlozZHFINDlv?=
 =?utf-8?B?V3JheUpoeUJRSjJvSU9KM045aUdWL0pLSGc5VU5iaXVRZFozZmUwR3VBTU01?=
 =?utf-8?B?dEh1NHMwOXBFV0FRdjZ5VFlGaFNqMm5nenU5WWQwZFFvdFFpZWw0UjJTcDgx?=
 =?utf-8?B?N3hocG45NDBCZnRINVdFQmIvUDhzZ3JuRmVGNjFiMHBXckZMMkJ3QUlySFVU?=
 =?utf-8?B?LzRFZE5QeHM4TmZiQkhMdGRiV3VyVmpUWDN0bFp1Y0lkVnJYM1A3ejcrNlQ2?=
 =?utf-8?B?bEhTUWUrWlBETmNrWlJ2eERZVHZ2M1JKdGl2dGgxTFJGdDV5bkt6TTVmOUxU?=
 =?utf-8?B?SzdWZnRKdWJNMllXcXJRWGVTdy91MkV2V0VkSlZhSzlEZGlTVVJtZHp2ZHNG?=
 =?utf-8?B?dkNWWHZNcWNrQWdSSXIwSzBnSTJHSFIzcnFMUTBLYkZZeXBJRW9ROEhYYXJk?=
 =?utf-8?B?d3BDbVgrQXQ5TVRHTkFlQUc2WFdVQVpqaWhVYkdTM0pLSldpUkdnSXRxcndG?=
 =?utf-8?B?TTNJeWZaU0ZtaSs0QkhlUkRldzFyN0tSc0NUM2REQ2JDQ0lvdmRXd3g2ZVpo?=
 =?utf-8?B?QVg1cks2TjAwbzQxWjBibEtoOGI1Mjl4bXY1N3NJelI1Zm1ITW5NU3N1VEw0?=
 =?utf-8?B?YVRkTzdQQXBZWU9hb2FIZ2hyYmZad2wyUXFGdEtlc3ZhaGR6b2hmRG9ubjAz?=
 =?utf-8?B?N2R1WGFIMWVYVURTYzFIYVMxSGNkMmdtTHRnVWFLcEhIejNyRm14MkkxQ2RO?=
 =?utf-8?B?U0M1UzlqZ3NERXVvMXdNU3MxeFlQM0pWd1dOeWpOWnp6aXZhamFmLzV5eFBO?=
 =?utf-8?B?OHVRWFkxWi9zM3MwYzd4c3NjanhxdCtLK2NrKzhMdzVocjRmYk1aQ2RqMnNT?=
 =?utf-8?B?SjRLVnBtcnh0dWxxTEV5QTIvckJtNGZneDd5QnVuNDBWR2x1NEJ1U1dlbUwz?=
 =?utf-8?B?TzNoWkxNRTAzc01QUTJiRnpiQnBldlFsRk9hdEVyWHBrRExRUDFXYmRiZXBh?=
 =?utf-8?B?T3IwMDZUVEZjMTZzaE9HajlrdmlnaXVua0dUbEppeXMwWTA5VjdFa2Q2RUM1?=
 =?utf-8?B?YVJoa3F6aEFJSXV6ZVBmeVNIUzZRekRlNWVqTWxsUytkYSs3cVh6TkFaeUIr?=
 =?utf-8?B?bUw4QXE2djIvRzdPOFUvbG9CQjJzTTR6RU1JYXdUOFBaMEgyYUpPU1AwaTRZ?=
 =?utf-8?B?Q2hhc1JXczduQ0xURUpuR2hYY0dPYjJhTlp2ZmJSZmxpaHZ3WjNDdlNuMFIz?=
 =?utf-8?B?L21lU2tKMjNyUFFyVytDNXk1ZVpMaVp5WmhMcnpnTjBkbXExMlRTRTRMaUo3?=
 =?utf-8?B?QzQ0TGREcUl2SGxTZjE3ZEQ3Z0cxendReWVPczMvRXRNaVNQSUFRTy96TCtG?=
 =?utf-8?B?TGR1ZkdHMTBvdGJwQVhkRVc3SE8rdDJZUzZUNTFuQStmb2dScDJMd3NlcVV3?=
 =?utf-8?B?WGI1VVFhSVRna0tXVkJ1ZXN4by9hOVViT0xUc0pmS0JhM3NxYi95aTVSb0Ey?=
 =?utf-8?B?TXdkZVdhbEdZVzhLMlNLQjFnNzh5aWxFMk5WdndqaVVXSllLL2dRWVQ5SW9v?=
 =?utf-8?B?aGlqOTlIcmpJTFhWcnpyZlp6V3B3WVVGQ0FzamlGaTArU0hNRGxJYmFpdDdU?=
 =?utf-8?B?RHRQTlhlL1ZZMTBSUktUTkNBejNacmErd2J2WC82M21EdXVPTm9neitRc2ZT?=
 =?utf-8?B?YVAxRnVEazFTMTRyNUwwVGhaK0RCR05MV2F2MTMvZHpSVndRcWhmZ3JGZ3Bm?=
 =?utf-8?B?WVU2b3VOaGxzWVV2dmFzSWVQT2NJMjUycjBmUXBxenhBTlBzR3E4eGMyMnlq?=
 =?utf-8?B?N0QyTVZyalZJdGtuNVRxUExvVzViU0lLTGRFeU1yZk5lLzFGL2g4TXFObjl6?=
 =?utf-8?B?L2ZCUEgvWWtiMlVSbFFmS3B1ZjhQdU9sZkdLSG1pNUJlWURJM1hKVTZTYlFU?=
 =?utf-8?B?TzlHUEsxNUVXRGJYV0ErK1Uva2wvd0Rta3A0MnhPV2lXZDBqYlpIVFVhMmFB?=
 =?utf-8?B?OGpWZXU0a0lBcFd1NEhhcWtJeWtQcVFkbzBIOUxkVk10TGYxZE54TENLenE2?=
 =?utf-8?Q?v6jGNkYRgsVYgn9PXNxXSx0qr?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: c396c0dc-289b-46f6-fa11-08dcab1d7dbd
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 23 Jul 2024 13:43:53.5031
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: HNtgZyd0MBAurh4ax8LxgWiS7vxrWaVmnRqiau46TxUD+kwQ6QQdp/EVYNFXFu2VDrgwS+SH7/4WD9Wx5XR5jQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB5975
Status: O
Content-Length: 1844
Lines: 41


On 7/19/24 20:01, Dave Jiang wrote:
>
>>   
>> -static int cxl_probe_regs(struct cxl_register_map *map)
>> +static int cxl_probe_regs(struct cxl_register_map *map, uint8_t caps)
>>   {
>>   	struct cxl_component_reg_map *comp_map;
>>   	struct cxl_device_reg_map *dev_map;
>> @@ -437,11 +437,12 @@ static int cxl_probe_regs(struct cxl_register_map *map)
>>   	case CXL_REGLOC_RBI_MEMDEV:
>>   		dev_map = &map->device_map;
>>   		cxl_probe_device_regs(host, base, dev_map);
>> -		if (!dev_map->status.valid || !dev_map->mbox.valid ||
>> +		if (!dev_map->status.valid ||
>> +		    ((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ||
>>   		    !dev_map->memdev.valid) {
>>   			dev_err(host, "registers not found: %s%s%s\n",
>>   				!dev_map->status.valid ? "status " : "",
>> -				!dev_map->mbox.valid ? "mbox " : "",
>> +				((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ? "mbox " : "",
> According to the r3.1 8.2.8.2.1, the device status registers and the primary mailbox registers are both mandatory if regloc id=3 block is found. So if the type2 device does not implement a mailbox then it shouldn't be calling cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map) to begin with from the driver init right? If the type2 device defines a regblock with id=3 but without a mailbox, then isn't that a spec violation?
>
> DJ


Right. The code needs to support the possibility of a Type2 having a 
mailbox, and if it is not supported, the rest of the dvsec regs 
initialization needs to be performed. This is not what the code does 
now, so I'll fix this.


A wider explanation is, for the RFC I used a test driver based on QEMU 
emulating a Type2 which had a CXL Device Register Interface defined 
(03h) but not a CXL Device Capability with id 2 for the primary mailbox 
register, breaking the spec as you spotted.


Thanks.



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.9])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 216FB8C06;
	Fri, 19 Jul 2024 19:01:21 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.9
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721415684; cv=none; b=cmYvzXof64grxolZCX4WuJ3LCiGS/UiYBFgstwevunLMpiTa+Sm9OWwGHE0A7DrdOWqQELk2jTX4qQOTvD9A54FgdtV9AkZzKhkYHpBbwQ1CoyArquAynM5v8XCViwiFSUNN++z90tVA0wW/z1kMy385TpOTCJEnJLx8N6HErt4=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721415684; c=relaxed/simple;
	bh=t8wJxfySrx9yT+L43uDzmQbZIng5UQmL699Jdm9hlDs=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=hlIcu2VjQpxwX5MFIHiiRmsQfzjpv+9sXy+sZR1vt4k54ppddmN7vusEb7QRvfG59JkJMw9B6dAdOKHR4i81mOuG/xrA29U4YDVSgZw+3S70w+A+fl1VVabPtUy6oV7xWhbx56r1v3uWstLpOnHoQocnXOWTpqrUhb8aVPj7KtU=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=GXjt3SrC; arc=none smtp.client-ip=198.175.65.9
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="GXjt3SrC"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721415682; x=1752951682;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=t8wJxfySrx9yT+L43uDzmQbZIng5UQmL699Jdm9hlDs=;
  b=GXjt3SrCJDrYaxpmYplcHw+LCkwXy1afUOErDQZvpy0kyemwM2hls5/E
   FFxu82739P3e7IFvISRj0hrkuoLa+AkT5b1tZhelKrOz58cA+42SBlVXM
   C3pf0oND2GVlo4EMTMgWMHp3vo837ckUMsZgHKNKAwZm/cI6CuLCinH1v
   Qnl8wKSdy2DZGY10NPHR/R3leLzad6IKHU3TK8ZMvwGzWv/wqBRfBxfIV
   MiHGPV7JU3lxilaad6cGwMKiIKdDcIEZTbBTUcmZt+VnBn7qwnBrFhb3r
   Fz9voag7mMKl3MGp3hN19IWfJetbrcWLaWmg5tJWl0UsYw6nCMqck/RNm
   A==;
X-CSE-ConnectionGUID: kg4VJkajRS6x+5n89laq+A==
X-CSE-MsgGUID: dns5tlWfQZ+DDarDMb5QKA==
X-IronPort-AV: E=McAfee;i="6700,10204,11138"; a="41574091"
X-IronPort-AV: E=Sophos;i="6.09,221,1716274800"; 
   d="scan'208";a="41574091"
Received: from orviesa005.jf.intel.com ([10.64.159.145])
  by orvoesa101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 19 Jul 2024 12:01:21 -0700
X-CSE-ConnectionGUID: rCxvpFuyRYCM0C2p0GJP4w==
X-CSE-MsgGUID: wZlS/KHrRiacth6tuS/O9g==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,221,1716274800"; 
   d="scan'208";a="56046735"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.125.109.46]) ([10.125.109.46])
  by orviesa005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 19 Jul 2024 12:01:20 -0700
Message-ID: <e3ea1b1a-8439-40c6-99bf-4151ecf4d04f@intel.com>
Date: Fri, 19 Jul 2024 12:01:19 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 04/15] cxl: add capabilities field to cxl_dev_state
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
 netdev@vger.kernel.org, dan.j.williams@intel.com, martin.habets@xilinx.com,
 edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
 pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com
Cc: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-5-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <20240715172835.24757-5-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 9688
Lines: 250



On 7/15/24 10:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Type2 devices have some Type3 functionalities as optional like an mbox
> or an hdm decoder, and CXL core needs a way to know what a CXL accelerator
> implements.
> 
> Add a new field for keeping device capabilities to be initialised by
> Type2 drivers. Advertise all those capabilities for Type3.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/mbox.c            |  1 +
>  drivers/cxl/core/memdev.c          |  4 +++-
>  drivers/cxl/core/port.c            |  2 +-
>  drivers/cxl/core/regs.c            | 11 ++++++-----
>  drivers/cxl/cxl.h                  |  2 +-
>  drivers/cxl/cxlmem.h               |  4 ++++
>  drivers/cxl/pci.c                  | 15 +++++++++------
>  drivers/net/ethernet/sfc/efx_cxl.c |  3 ++-
>  include/linux/cxl_accel_mem.h      |  5 ++++-
>  9 files changed, 31 insertions(+), 16 deletions(-)
> 
> diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> index 2626f3fff201..2ba7d36e3f38 100644
> --- a/drivers/cxl/core/mbox.c
> +++ b/drivers/cxl/core/mbox.c
> @@ -1424,6 +1424,7 @@ struct cxl_memdev_state *cxl_memdev_state_create(struct device *dev)
>  	mds->cxlds.reg_map.host = dev;
>  	mds->cxlds.reg_map.resource = CXL_RESOURCE_NONE;
>  	mds->cxlds.type = CXL_DEVTYPE_CLASSMEM;
> +	mds->cxlds.capabilities = CXL_DRIVER_CAP_HDM | CXL_DRIVER_CAP_MBOX;
>  	mds->ram_perf.qos_class = CXL_QOS_CLASS_INVALID;
>  	mds->pmem_perf.qos_class = CXL_QOS_CLASS_INVALID;
>  
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 04c3a0f8bc2e..b4205ecca365 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -616,7 +616,7 @@ static void detach_memdev(struct work_struct *work)
>  
>  static struct lock_class_key cxl_memdev_key;
>  
> -struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev, uint8_t caps)
>  {
>  	struct cxl_dev_state *cxlds;
>  
> @@ -631,6 +631,8 @@ struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
>  	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, 0, "ram");
>  	cxlds->pmem_res = DEFINE_RES_MEM_NAMED(0, 0, "pmem");
>  
> +	cxlds->capabilities = caps;
> +
>  	return cxlds;
>  }
>  EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 887ed6e358fb..d66c6349ed2d 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -763,7 +763,7 @@ static int cxl_setup_comp_regs(struct device *host, struct cxl_register_map *map
>  	map->reg_type = CXL_REGLOC_RBI_COMPONENT;
>  	map->max_size = CXL_COMPONENT_REG_BLOCK_SIZE;
>  
> -	return cxl_setup_regs(map);
> +	return cxl_setup_regs(map, 0);
>  }
>  
>  static int cxl_port_setup_regs(struct cxl_port *port,
> diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
> index e1082e749c69..9d218ebe180d 100644
> --- a/drivers/cxl/core/regs.c
> +++ b/drivers/cxl/core/regs.c
> @@ -421,7 +421,7 @@ static void cxl_unmap_regblock(struct cxl_register_map *map)
>  	map->base = NULL;
>  }
>  
> -static int cxl_probe_regs(struct cxl_register_map *map)
> +static int cxl_probe_regs(struct cxl_register_map *map, uint8_t caps)
>  {
>  	struct cxl_component_reg_map *comp_map;
>  	struct cxl_device_reg_map *dev_map;
> @@ -437,11 +437,12 @@ static int cxl_probe_regs(struct cxl_register_map *map)
>  	case CXL_REGLOC_RBI_MEMDEV:
>  		dev_map = &map->device_map;
>  		cxl_probe_device_regs(host, base, dev_map);
> -		if (!dev_map->status.valid || !dev_map->mbox.valid ||
> +		if (!dev_map->status.valid ||
> +		    ((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ||
>  		    !dev_map->memdev.valid) {
>  			dev_err(host, "registers not found: %s%s%s\n",
>  				!dev_map->status.valid ? "status " : "",
> -				!dev_map->mbox.valid ? "mbox " : "",
> +				((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ? "mbox " : "",

According to the r3.1 8.2.8.2.1, the device status registers and the primary mailbox registers are both mandatory if regloc id=3 block is found. So if the type2 device does not implement a mailbox then it shouldn't be calling cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map) to begin with from the driver init right? If the type2 device defines a regblock with id=3 but without a mailbox, then isn't that a spec violation?

DJ

>  				!dev_map->memdev.valid ? "memdev " : "");
>  			return -ENXIO;
>  		}
> @@ -455,7 +456,7 @@ static int cxl_probe_regs(struct cxl_register_map *map)
>  	return 0;
>  }
>  
> -int cxl_setup_regs(struct cxl_register_map *map)
> +int cxl_setup_regs(struct cxl_register_map *map, uint8_t caps)
>  {
>  	int rc;
>  
> @@ -463,7 +464,7 @@ int cxl_setup_regs(struct cxl_register_map *map)
>  	if (rc)
>  		return rc;
>  
> -	rc = cxl_probe_regs(map);
> +	rc = cxl_probe_regs(map, caps);
>  	cxl_unmap_regblock(map);
>  
>  	return rc;
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index a6613a6f8923..9973430d975f 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -300,7 +300,7 @@ int cxl_find_regblock_instance(struct pci_dev *pdev, enum cxl_regloc_type type,
>  			       struct cxl_register_map *map, int index);
>  int cxl_find_regblock(struct pci_dev *pdev, enum cxl_regloc_type type,
>  		      struct cxl_register_map *map);
> -int cxl_setup_regs(struct cxl_register_map *map);
> +int cxl_setup_regs(struct cxl_register_map *map, uint8_t caps);
>  struct cxl_dport;
>  resource_size_t cxl_rcd_component_reg_phys(struct device *dev,
>  					   struct cxl_dport *dport);
> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
> index af8169ccdbc0..8f2a820bd92d 100644
> --- a/drivers/cxl/cxlmem.h
> +++ b/drivers/cxl/cxlmem.h
> @@ -405,6 +405,9 @@ struct cxl_dpa_perf {
>  	int qos_class;
>  };
>  
> +#define CXL_DRIVER_CAP_HDM	0x1
> +#define CXL_DRIVER_CAP_MBOX	0x2
> +
>  /**
>   * struct cxl_dev_state - The driver device state
>   *
> @@ -438,6 +441,7 @@ struct cxl_dev_state {
>  	struct resource ram_res;
>  	u64 serial;
>  	enum cxl_devtype type;
> +	uint8_t capabilities;
>  };
>  
>  /**
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index b34d6259faf4..e2a978312281 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -502,7 +502,8 @@ static int cxl_rcrb_get_comp_regs(struct pci_dev *pdev,
>  }
>  
>  static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
> -			      struct cxl_register_map *map)
> +			      struct cxl_register_map *map,
> +			      uint8_t cxl_dev_caps)
>  {
>  	int rc;
>  
> @@ -519,7 +520,7 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>  	if (rc)
>  		return rc;
>  
> -	return cxl_setup_regs(map);
> +	return cxl_setup_regs(map, cxl_dev_caps);
>  }
>  
>  int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
> @@ -527,7 +528,8 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
>  	struct cxl_register_map map;
>  	int rc;
>  
> -	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map,
> +				cxlds->capabilities);
>  	if (rc)
>  		return rc;
>  
> @@ -536,7 +538,7 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
>  		return rc;
>  
>  	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
> -				&cxlds->reg_map);
> +				&cxlds->reg_map, cxlds->capabilities);
>  	if (rc)
>  		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
>  
> @@ -850,7 +852,8 @@ static int cxl_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
>  		dev_warn(&pdev->dev,
>  			 "Device DVSEC not present, skip CXL.mem init\n");
>  
> -	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map,
> +				cxlds->capabilities);
>  	if (rc)
>  		return rc;
>  
> @@ -863,7 +866,7 @@ static int cxl_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
>  	 * still be useful for management functions so don't return an error.
>  	 */
>  	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
> -				&cxlds->reg_map);
> +				&cxlds->reg_map, cxlds->capabilities);
>  	if (rc)
>  		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
>  	else if (!cxlds->reg_map.component_map.ras.valid)
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 9cefcaf3caca..37d8bfdef517 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -33,7 +33,8 @@ void efx_cxl_init(struct efx_nic *efx)
>  
>  	pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
>  
> -	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev);
> +	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev,
> +					    CXL_ACCEL_DRIVER_CAP_HDM);
>  	if (IS_ERR(cxl->cxlds)) {
>  		pci_info(pci_dev, "CXL accel device state failed");
>  		return;
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index c7b254edc096..0ba2195b919b 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -12,8 +12,11 @@ enum accel_resource{
>  	CXL_ACCEL_RES_PMEM,
>  };
>  
> +#define CXL_ACCEL_DRIVER_CAP_HDM	0x1
> +#define CXL_ACCEL_DRIVER_CAP_MBOX	0x2
> +
>  typedef struct cxl_dev_state cxl_accel_state;
> -cxl_accel_state *cxl_accel_state_create(struct device *dev);
> +cxl_accel_state *cxl_accel_state_create(struct device *dev, uint8_t caps);
>  
>  void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
>  void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2068.outbound.protection.outlook.com [40.107.93.68])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4526A38FA0;
	Fri, 19 Jul 2024 06:04:19 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.93.68
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721369062; cv=fail; b=cFyXejnPAE2FuHL8rH+zATsfBXKUkib+adly7knSTqGhYx03d/vof+zOxgD+wSnkKWKKcRY6VpuAEWcNM7IssucSejkg3xxAnH0NtKCZ3GPPFCVE9C5wCmggYch5KEzvUshqLviz4cqi5PqkSVslTttCOO1YKARinGM3IniG3xA=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721369062; c=relaxed/simple;
	bh=H3OYa0JGwt5zlmTfCaxYNkSyL5cKjby2EPPQbYUr+Uo=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=Z5usIJweHguqDh7QuSNNJVEUsbXpXTkCRUu0QOpcJ7297znO6/eVWaUo0khEKt52rp9vO9CeLFQgeKHPUlNDX9Ih9DII9491tdVVj7nHP6VvnUPSY6GD5Cdw4q1YGJ2qWHLNk3tmZgu7plkA9lqmAIWi7xl+tJLBtHN/PKXhP/g=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=48JqrG4+; arc=fail smtp.client-ip=40.107.93.68
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="48JqrG4+"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=rw90SD2Pk2AburF7fEuHFw9ApI3jsR5IxisEI1uG7zo9OQAV6lPfeAeixehW1tuMcRFkzGapptfcCBtFQGlJHSV5c6qkj/Bdi9g2VHe939KATJXC2OjVnPyRhUMyMqLEaxzUJo4y3g8gS30JVh4ivWnmfi+3iLfGA59HZ1BDDNnwYLn7GedyEP5rlgQc6BTYzRZ9LxS0mU7PjRHQz4Ul7c5Wi5uVrfZbQfYbQkjZNI/t3vGKnd3orfWwWUWkN1J3gh2LLvOvfZ10iRiocWbzHDsx8sb0GfHCVh20s0wU25Ows/9XjWw4xkjviY5/kK0xsersI3y3ZMUQLfJVNi4Oqw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Od1895//0taMBRV1jEjumzUGEdNodF75YJwFZNY56EU=;
 b=HPFfjRvd2xfCOiMwy+2Li7lyjI1a/qwe3GlSrCAZeO0uE8H1IM9vWFRYy9Lm3iQI/WVn3M83whdAztY7llev2EplmrpnnxAFuD9uf1W8xDpmsRUu75fGhPt1BBxFnTWTu+g2fYetyLNT8tnMKJ/uWIm3D81lTCoxKtjIvztqtlhZmq6C5PDWUkdsvIkGMrHW8rJEFGttDxdsSNy1gqM0UQeegVEZ2VOIqmze6RRyv58lm1mrfVcb2ntv8nFqYRiR/tJHeW9xEwEUfEW+SiGxXF+uEYXVX2o5qG0zP0DmqUASV4THdnBDPNcES2ot5wAy15ccW/Dc5qZfiXIromszhg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Od1895//0taMBRV1jEjumzUGEdNodF75YJwFZNY56EU=;
 b=48JqrG4+Fnqueb436ov0sE605OKbdeTh9BEQLlR/8RK0oRkdWB7zoAT0v54ehtXLl3NirnA7OoAO9nE7gXCaRhsfaA5DOXEq3IafIIPo/D4Qj+Aq85W3oHV4voCLnYEeTpTyLdGfpV5IodgwHp25GgvMCw6AQQLSfV9Ud4VfCFc=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by IA0PR12MB7580.namprd12.prod.outlook.com (2603:10b6:208:43b::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.19; Fri, 19 Jul
 2024 06:04:16 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Fri, 19 Jul 2024
 06:04:15 +0000
Message-ID: <e5a4836d-a405-5b12-62a7-e45b39fb12ad@amd.com>
Date: Fri, 19 Jul 2024 07:03:58 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 01/15] cxl: add type2 device basic support
Content-Language: en-US
To: Dave Jiang <dave.jiang@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
 <936eecad-2e98-4336-b775-d28fa1d87d76@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <936eecad-2e98-4336-b775-d28fa1d87d76@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LNXP265CA0015.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:5e::27) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|IA0PR12MB7580:EE_
X-MS-Office365-Filtering-Correlation-Id: 6765e7ef-80be-42ce-e962-08dca7b89e38
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|1800799024|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?dmVQWDkyNHNaTGhXdU4wNEhRRThLRElXem0xdFltUWlpb2E3ZEFNTFIvTGNx?=
 =?utf-8?B?K1F6a25DNWs3akdlMUxtMWNMSjFQbmt0Nnk3MjFFVUdtR2xrWlZXQWZzOWUv?=
 =?utf-8?B?VlRGV3pKRXF2S2FzSTZpNnVlUWRQODRKcHI2cnZKV1E4UHkvSTY3U2cwOVBt?=
 =?utf-8?B?b3hyTzNrTDc3Sm4rbVVnNzRFUjV4alBTV1IzdmJNQVpDZ0NjYndPQ3IzeCtz?=
 =?utf-8?B?dHBnbGJYV1pKcFVZendEYXk2TCtVNzlDa2thT016cm9La3NieHM3Wnd5UjVv?=
 =?utf-8?B?VmtieGhrNTB0NUVsSHNqYWI3bWpqR0dzVE1WcXk5a3NRYTlUVFB5OFVSbWti?=
 =?utf-8?B?RktkcklLcjVKcjJoLzlsWVlvUkJrTzd3QWY4UnhHNkJ4WlZkYU9SUFdxRzMy?=
 =?utf-8?B?b0U4TUg1NUpKQ1VjVVFhRWFZRUd3RDVNYWhPWnNzTEwvRU1QYzRkVkZvcElu?=
 =?utf-8?B?eXhkOUVGc1lIM0pRMGZXS09za2xzQTJ0NStyazN3MkRRdnJQOHlBTDFYUGVj?=
 =?utf-8?B?SG5nZjhXSjhXZ280V2ZiSGd1UnJPeUhZRnZ2ZlVJTGcwNGZCYjJETXdXREhy?=
 =?utf-8?B?cXg5SE1kZUVocFI2ZHhRVnFTTjZ1TE5YTjVCaUw1ckppdlVjWHQxSkMzWlJt?=
 =?utf-8?B?ZW9ackVOTStaQXk4NkZ1SUZSWEgzQkxPbGxCNEhXcTNRNHgvZCtrYm1oa1RN?=
 =?utf-8?B?V1N2SEVkVC9pSzhoL0ovMWRiQVpTZDIvTjhsbGplZk1BL292QlBCMXgwcDJP?=
 =?utf-8?B?S3F1aUFGUDZmekZPYWRsTFlNdW03UjJ6K1Q2UXFPMFFzc0lobURKN1dYdEcz?=
 =?utf-8?B?OVFGMUpwcnRyRXhaU0tVVEhJbjR5dHNOTzZ0aCt0NEJ3ZlhiTHVqaGtIQy85?=
 =?utf-8?B?dmZwQmtRbDBzLy9ZWlZQTHpQNVloWEhQTVVjNk5neDFURldDWXp3YTBxRmgx?=
 =?utf-8?B?NUxDWm5oWEpJZUhrZmJ0VDhtMTJBd1R4czBYYUtrQkFFeW5odXBqSFdmdHRa?=
 =?utf-8?B?NXMrMmlqQUdTNk9GNFVQd2ZNb3NsR3l0dmUyZWYxQSs0czJNcWpvSUtxRmVM?=
 =?utf-8?B?cW00RnFaNFNVQk5yZ1UvYVEzK1M4OFFOcW92WUhodlBROEV6OERKN2hmWGJP?=
 =?utf-8?B?eXB1cFpjd2lIWWtzSXc0QjA2aXFObzg2cUs3TDhIenZ5Qm9ab0JtaGVEOHYx?=
 =?utf-8?B?bGZQR1BFYlBmaUl5ZlFKRXZXM0JUK25NOVh3M1pBNU1IY3UzcFVJekNRNVU3?=
 =?utf-8?B?bzIxdGdROHVuRmVrNFZIaFRhdVd1dVdxMUVPY2FBcEtwalkrcCthSXkvRG15?=
 =?utf-8?B?WGpmbVhTY1dwNVBlQ29JbzFNbm9tcDBCQU9MbEU2SGY4ZkQydDg2eGE3eTJF?=
 =?utf-8?B?L1NoVTZIcjVybVpEVG4xK2xGQlFNR0YvY0RGUDBZN2t0ODRqa0JubDJtWUln?=
 =?utf-8?B?WVRlcGF3RCtyajJ3TDZUNENrbHcxVmgveUcvZkIwSE55MmxlYmhYQ0EwZnNj?=
 =?utf-8?B?alp2dSs5S1psZGd3d2E2SDNYakllcldvd3p2WCtMOVBHaUhnbUhzdmVWUmFL?=
 =?utf-8?B?YUpJSnlMaFRmRTk1dTJzYTBuVWluVHNQLzlmRU1BcjRZQmRsdzhoL2ZBL1kw?=
 =?utf-8?B?cURCazhrcW5sTnNzUWo0WnBQbk8zWnVrR090QXFoQ3JDQm5FS09VTXNkOGJa?=
 =?utf-8?B?V1k2azMySWppYUZyNy9GTlZNSmRQSTRHYmxybjVxaWtsZmUzb1NTdGdoY212?=
 =?utf-8?B?Q3ViRkEyNXRaV2UrS3ZqWWJKdms2Y3N3bzhveUhUOU1oSDlQYUhNdnZxL3BQ?=
 =?utf-8?B?MGIyZjN3TGVZZVNBNnRqQT09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(1800799024)(376014)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?bU9VTGFPWjJFMm1TYWxKaXY2MDZPM2NNN0ZGdGVzTEdRdmk1cVpsZzV5Z0RS?=
 =?utf-8?B?cjRTV2Vrd2djRFRmV1BmeS9nbmNIR2hrYXlzaFYyc2RBa2U1T2liVHN1aWZR?=
 =?utf-8?B?cHpFUW9qbmlTL2RUQVhtNnp5TlBmRVVNRUIzQ3FtUVhvT0pHSE9qcDlEOGw2?=
 =?utf-8?B?V0c1TFpqakhxaERqVm9kYmxDY0tIdHVmYUpDM3cvdUREcDBUME1vL3FnME1R?=
 =?utf-8?B?MmplbFFSeTFDRjFoWlZsdjZvRjQxTjlWQWZyUDVKUVlacVMyUmpFZElYeFpa?=
 =?utf-8?B?c09QZ2pRTnRQQWoyMi9nck9xVXU4UzhzcTdSTzl3ellaR2ZYUGtvWHdHQ2w1?=
 =?utf-8?B?aHJXTk1jcXNINHpraUVnQ3NJcUZMOHJWS2hoZ3BDYlMvUFYwTVhZa3BvZW9s?=
 =?utf-8?B?d2w0Y0dCMGhiaVVhOTYrdXN6ZVVKZEZvc1RmWGh3aDU3NTdFUWNod3RIeDVN?=
 =?utf-8?B?UHhMbjBuR05wL1djcjV6M0c1RGhjSXZ4K01HdU5xMEZBd2pWSThhKzZoSjFo?=
 =?utf-8?B?dDd5WE5MdmxZN2xwejlxaUZqWHRJY0MxRU9oQVRrOVhNMWZybEV3OElRL0Rv?=
 =?utf-8?B?ekx1NjdZVG9UVUlZY2xHOXp1M3hNU2I3cTJSWkNUdTNQaXdySkMvejEzbTJH?=
 =?utf-8?B?V0dJR3p4MklrcFFjNlcxOXJScnpzOHordEJWWjN3Tk5zaHZKNEFuRzEwclZy?=
 =?utf-8?B?SEtXZ2diODdWcmo4MXdPRUVGZ1dXVmJyeUNYRXFGQXcvbmZueWF2Ry9STjc1?=
 =?utf-8?B?VDFWc21UUno0alliRUFpR1VvKzdqUGpweDI0Q2tyVS81ekZQOHJmbk0zalI2?=
 =?utf-8?B?VmtoMW9RV2M4MFQ2NW9nNHhhTkRTdC9HMVVvTjFXaWh2Q0EwbFVBQ2Q2MkUw?=
 =?utf-8?B?VzlFZElNUUl0R0F3eDFWSTZvbnFJbnhGVE1JaHBSdHpKbXMyYTVNckR1NHVM?=
 =?utf-8?B?UGxvRk9qVHQ0SEVxV21pODhKQmF6NktpdFV6TFROY09vQlIvbDFtU1dxUUY2?=
 =?utf-8?B?ckFqZmhUZDUwQVpnZm4zWkFYREMyWU9yaUcwWlQrN2RnSzI3dmwyWEZ4WkJE?=
 =?utf-8?B?MWh6YjRwSVo1SzRiRHQranhtWVZJS21rTzB4SzErSU9pZUc1MkVHd3M0YW8v?=
 =?utf-8?B?b2pkNEhDby9aYU9IQVNPQ0lNSVFVTFAwVzVUakpkZmdaaitvY2kwaG1SbXlx?=
 =?utf-8?B?bnlmYjdGSmNIRjFaYWFEU004MC9rcG9rdTlNLzJyeDZKODJnQUtYSFFiMnRt?=
 =?utf-8?B?dkxhSE9OTWdPTW5aYytUQ0xmRjkwUmNDUy9hK2xxSGJhV2tGKy82cWxEcDUv?=
 =?utf-8?B?cktuWU5TYkk3c2FkWW5kNFNCNlZHWWQvSy9LNVJIZk9NNkx3YkZyL3lTaFp0?=
 =?utf-8?B?THRhQjBLUkliUm8wc2xpUGdUUS84Yy9selNxS1lyWTQyL1V1SUV0WGYwTVR3?=
 =?utf-8?B?dzBjcjVoYWZrNGxUVlNVVHBBdmlLMENYbm02M3lZdUd5WHNKWW1TQXFaSllV?=
 =?utf-8?B?YjdYM29yNlRNN1NSOGxoaVZhTWkrWWJTSitNNWpRMlhaY3pQZG05dkUvVDd4?=
 =?utf-8?B?dmNOc1Fsa3pLcVZaUndVSlQ4WnVVd2IycmpYdTJEb21MK2IwUFY3N1ZVV3Ir?=
 =?utf-8?B?eE1zbkgxWmFuRzNvYVcvcCtsVFd0TzZDSSt5RU1MTHhHYmZqZU1Ld2s5QVdK?=
 =?utf-8?B?N2x6WUJUZ2MvUFBFajIwQ0FQOEhGZ2tCN3JPMkR2NUo0UzE4dSt1V21yMUIr?=
 =?utf-8?B?Qlg0bkZuU3ZYb2EzYjVKcVFYWmo3VHBqMUVJb0dUL1BlaTRhNTlIMEl3SVpS?=
 =?utf-8?B?LzhydnhqaVNyMmZ6K2VENDJwMVA4U0NBbTdNYXpUZjB5MjNWcjN1eFFSUklv?=
 =?utf-8?B?SzQ0c3BUb1hhK01EVTNoVmVOK0tVOTVQS1BnTWZ1OTJDQjEyNmRxQmdsS1g0?=
 =?utf-8?B?UUd3U3FtU0g0UFhWM3VwU1l0QlQ3UVlZblN1ZFhvWHNiUS9nQnR3NFBHSXc0?=
 =?utf-8?B?ZWV4MnpkWFNWU2VIdFNNcmhDZzJMYzd3K1pzS1NweDVIQ3BiSmorSjZlc3RW?=
 =?utf-8?B?K1daQ005RFBDaXd2VkVBZXY1KzdpQkliYjF3WlNwT0ZCKzQ2MEFZTDVpdUMz?=
 =?utf-8?Q?63WA0BEC23PlgL2lok4v3C4GX?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 6765e7ef-80be-42ce-e962-08dca7b89e38
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 19 Jul 2024 06:04:15.3029
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: bRmXouki8cb/J7oqNxdZHE4r9a9s05fu39HJWFERRQ9f6qpqCOwA1YqFoJ0DbGy+ONk8nlgaFTu6UDsf489NDw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB7580
Status: O
Content-Length: 14272
Lines: 401


On 7/19/24 00:12, Dave Jiang wrote:
>
> On 7/15/24 10:28 AM, alejandro.lucero-palau@amd.com wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> Differientiate Type3, aka memory expanders, from Type2, aka device
>> accelerators, with a new function for initializing cxl_dev_state.
>>
>> Create opaque struct to be used by accelerators relying on new access
>> functions in following patches.
>>
>> Add SFC ethernet network driver as the client.
>>
>> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m52543f85d0e41ff7b3063fdb9caa7e845b446d0e
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
>> ---
>>   drivers/cxl/core/memdev.c             | 52 ++++++++++++++++++++++++++
>>   drivers/net/ethernet/sfc/Makefile     |  2 +-
>>   drivers/net/ethernet/sfc/efx.c        |  4 ++
>>   drivers/net/ethernet/sfc/efx_cxl.c    | 53 +++++++++++++++++++++++++++
>>   drivers/net/ethernet/sfc/efx_cxl.h    | 29 +++++++++++++++
>>   drivers/net/ethernet/sfc/net_driver.h |  4 ++
>>   include/linux/cxl_accel_mem.h         | 22 +++++++++++
>>   include/linux/cxl_accel_pci.h         | 23 ++++++++++++
> Maybe create an include/linux/cxl and then we can put headers in there.
>
>>   8 files changed, 188 insertions(+), 1 deletion(-)
>>   create mode 100644 drivers/net/ethernet/sfc/efx_cxl.c
>>   create mode 100644 drivers/net/ethernet/sfc/efx_cxl.h
>>   create mode 100644 include/linux/cxl_accel_mem.h
>>   create mode 100644 include/linux/cxl_accel_pci.h
>>
>> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
>> index 0277726afd04..61b5d35b49e7 100644
>> --- a/drivers/cxl/core/memdev.c
>> +++ b/drivers/cxl/core/memdev.c
>> @@ -8,6 +8,7 @@
>>   #include <linux/idr.h>
>>   #include <linux/pci.h>
>>   #include <cxlmem.h>
>> +#include <linux/cxl_accel_mem.h>
>>   #include "trace.h"
>>   #include "core.h"
>>   
>> @@ -615,6 +616,25 @@ static void detach_memdev(struct work_struct *work)
>>   
>>   static struct lock_class_key cxl_memdev_key;
>>   
>> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
>> +{
>> +	struct cxl_dev_state *cxlds;
>> +
>> +	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
> Naked cxlds. Do you think you'll need an accel_dev_state to wrap around cxl_dev_state similar to cxl_memdev_state in order to store accel related information? I also wonder if 'struct cxl_dev_state' should be a public definition. Need to look at the rest of the patchset to circle back.
>

Not sure I understand your concern. Are you saying we need to introduce 
an cxl_accel_state struct? Fro my work and I guess from Dan's original 
patch, it seems it is not needed, although I have already raised my 
concerns about, maybe, current structs requiring a refactoring due to 
the optional capabilities for Type2.

Regarding if cxl_dev_state needs to be public, this patchet version 
defines it as opaque for addressing the concerns about accel drivers 
need to be "controlled".


>> +	if (!cxlds)
>> +		return ERR_PTR(-ENOMEM);
>> +
>> +	cxlds->dev = dev;
>> +	cxlds->type = CXL_DEVTYPE_DEVMEM;
>> +
>> +	cxlds->dpa_res = DEFINE_RES_MEM_NAMED(0, 0, "dpa");
>> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, 0, "ram");
>> +	cxlds->pmem_res = DEFINE_RES_MEM_NAMED(0, 0, "pmem");
>> +
>> +	return cxlds;
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
> I do wonder if we should have a common device state init helper function to init all the common bits:
> int cxlds_init(struct *dev, enum cxl_devtype devtype)
>
>
>> +
>>   static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>>   					   const struct file_operations *fops)
>>   {
>> @@ -692,6 +712,38 @@ static int cxl_memdev_open(struct inode *inode, struct file *file)
>>   	return 0;
>>   }
>>   
>> +
>> +void cxl_accel_set_dvsec(struct cxl_dev_state *cxlds, u16 dvsec)
>> +{
>> +	cxlds->cxl_dvsec = dvsec;
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_dvsec, CXL);
>> +
>> +void cxl_accel_set_serial(struct cxl_dev_state *cxlds, u64 serial)
>> +{
>> +	cxlds->serial= serial;
> Missing space before '='
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_serial, CXL);
>> +
>> +void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>> +			    enum accel_resource type)
>> +{
>> +	switch (type) {
>> +	case CXL_ACCEL_RES_DPA:
>> +		cxlds->dpa_res = res;
>> +		return;
>> +	case CXL_ACCEL_RES_RAM:
>> +		cxlds->ram_res = res;
>> +		return;
>> +	case CXL_ACCEL_RES_PMEM:
>> +		cxlds->pmem_res = res;
>> +		return;
>> +	default:
>> +		dev_err(cxlds->dev, "unkown resource type (%u)\n", type);
>> +	}
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_resource, CXL);
>> +
>>   static int cxl_memdev_release_file(struct inode *inode, struct file *file)
>>   {
>>   	struct cxl_memdev *cxlmd =
>> diff --git a/drivers/net/ethernet/sfc/Makefile b/drivers/net/ethernet/sfc/Makefile
>> index 8f446b9bd5ee..e80c713c3b0c 100644
>> --- a/drivers/net/ethernet/sfc/Makefile
>> +++ b/drivers/net/ethernet/sfc/Makefile
>> @@ -7,7 +7,7 @@ sfc-y			+= efx.o efx_common.o efx_channels.o nic.o \
>>   			   mcdi_functions.o mcdi_filters.o mcdi_mon.o \
>>   			   ef100.o ef100_nic.o ef100_netdev.o \
>>   			   ef100_ethtool.o ef100_rx.o ef100_tx.o \
>> -			   efx_devlink.o
>> +			   efx_devlink.o efx_cxl.o
>>   sfc-$(CONFIG_SFC_MTD)	+= mtd.o
>>   sfc-$(CONFIG_SFC_SRIOV)	+= sriov.o ef10_sriov.o ef100_sriov.o ef100_rep.o \
>>                              mae.o tc.o tc_bindings.o tc_counters.o \
>> diff --git a/drivers/net/ethernet/sfc/efx.c b/drivers/net/ethernet/sfc/efx.c
>> index e9d9de8e648a..cb3f74d30852 100644
>> --- a/drivers/net/ethernet/sfc/efx.c
>> +++ b/drivers/net/ethernet/sfc/efx.c
>> @@ -33,6 +33,7 @@
>>   #include "selftest.h"
>>   #include "sriov.h"
>>   #include "efx_devlink.h"
>> +#include "efx_cxl.h"
>>   
>>   #include "mcdi_port_common.h"
>>   #include "mcdi_pcol.h"
>> @@ -899,6 +900,7 @@ static void efx_pci_remove(struct pci_dev *pci_dev)
>>   	efx_pci_remove_main(efx);
>>   
>>   	efx_fini_io(efx);
>> +
> stray blank line
>
>>   	pci_dbg(efx->pci_dev, "shutdown successful\n");
>>   
>>   	efx_fini_devlink_and_unlock(efx);
>> @@ -1109,6 +1111,8 @@ static int efx_pci_probe(struct pci_dev *pci_dev,
>>   	if (rc)
>>   		goto fail2;
>>   
>> +	efx_cxl_init(efx);
> No error checks? Does the device expect to work whether CXL is setup or not?
>

Right. The netdev functionality will not be jeopardized because CXL 
initialization errors. If it is all fine, the PIO buffers will be mapped 
using the created CXL region, if not, PIO buffers will be used mapping 
at specific BAR offset.


>> +
>>   	rc = efx_pci_probe_post_io(efx);
>>   	if (rc) {
>>   		/* On failure, retry once immediately.
>> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
>> new file mode 100644
>> index 000000000000..4554dd7cca76
>> --- /dev/null
>> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
>> @@ -0,0 +1,53 @@
>> +// SPDX-License-Identifier: GPL-2.0-only
>> +/****************************************************************************
>> + * Driver for AMD network controllers and boards
>> + * Copyright (C) 2024, Advanced Micro Devices, Inc.
>> + *
>> + * This program is free software; you can redistribute it and/or modify it
>> + * under the terms of the GNU General Public License version 2 as published
>> + * by the Free Software Foundation, incorporated herein by reference.
>> + */
>> +
>> +
>> +#include <linux/pci.h>
>> +#include <linux/cxl_accel_mem.h>
>> +#include <linux/cxl_accel_pci.h>
>> +
>> +#include "net_driver.h"
>> +#include "efx_cxl.h"
>> +
>> +#define EFX_CTPIO_BUFFER_SIZE	(1024*1024*256)
>> +
>> +void efx_cxl_init(struct efx_nic *efx)
>> +{
>> +	struct pci_dev *pci_dev = efx->pci_dev;
>> +	struct efx_cxl *cxl = efx->cxl;
>> +	struct resource res;
>> +	u16 dvsec;
>> +
>> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_VENDOR_ID_CXL,
>> +					  CXL_DVSEC_PCIE_DEVICE);
>> +
>> +	if (!dvsec)
>> +		return;
>> +
>> +	pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
> Seem like unnecessary kern log emission
>

Uhmm, yes, maybe something more linked to how PIO buffer end up being 
used at a later time.

>> +
>> +	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev);
>> +	if (IS_ERR(cxl->cxlds)) {
>> +		pci_info(pci_dev, "CXL accel device state failed");
> pci_err()? or maybe pci_warn() given it's ignoring error returns.


Right. I will change this and other similar ones.


>> +		return;
>> +	}
>> +
>> +	cxl_accel_set_dvsec(cxl->cxlds, dvsec);
>> +	cxl_accel_set_serial(cxl->cxlds, pci_dev->dev.id);
>> +
>> +	res = DEFINE_RES_MEM(0, EFX_CTPIO_BUFFER_SIZE);
>> +	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_DPA);
>> +
>> +	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
>> +	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
>> +}
>> +
>> +
>> +MODULE_IMPORT_NS(CXL);
>> diff --git a/drivers/net/ethernet/sfc/efx_cxl.h b/drivers/net/ethernet/sfc/efx_cxl.h
>> new file mode 100644
>> index 000000000000..76c6794c20d8
>> --- /dev/null
>> +++ b/drivers/net/ethernet/sfc/efx_cxl.h
>> @@ -0,0 +1,29 @@
>> +// SPDX-License-Identifier: GPL-2.0-only
>> +/****************************************************************************
>> + * Driver for AMD network controllers and boards
>> + * Copyright (C) 2024, Advanced Micro Devices, Inc.
>> + *
>> + * This program is free software; you can redistribute it and/or modify it
>> + * under the terms of the GNU General Public License version 2 as published
>> + * by the Free Software Foundation, incorporated herein by reference.
>> + */
>> +
>> +#ifndef EFX_CXL_H
>> +#define EFX_CLX_H
>> +
>> +#include <linux/cxl_accel_mem.h>
>> +
>> +struct efx_nic;
>> +
>> +struct efx_cxl {
>> +	cxl_accel_state *cxlds;
>> +	struct cxl_memdev *cxlmd;
>> +	struct cxl_root_decoder *cxlrd;
>> +	struct cxl_port *endpoint;
>> +	struct cxl_endpoint_decoder *cxled;
>> +	struct cxl_region *efx_region;
>> +	void __iomem *ctpio_cxl;
>> +};
>> +
>> +void efx_cxl_init(struct efx_nic *efx);
>> +#endif
>> diff --git a/drivers/net/ethernet/sfc/net_driver.h b/drivers/net/ethernet/sfc/net_driver.h
>> index f2dd7feb0e0c..58b7517afea4 100644
>> --- a/drivers/net/ethernet/sfc/net_driver.h
>> +++ b/drivers/net/ethernet/sfc/net_driver.h
>> @@ -814,6 +814,8 @@ enum efx_xdp_tx_queues_mode {
>>   
>>   struct efx_mae;
>>   
>> +struct efx_cxl;
>> +
>>   /**
>>    * struct efx_nic - an Efx NIC
>>    * @name: Device name (net device name or bus id before net device registered)
>> @@ -962,6 +964,7 @@ struct efx_mae;
>>    * @tc: state for TC offload (EF100).
>>    * @devlink: reference to devlink structure owned by this device
>>    * @dl_port: devlink port associated with the PF
>> + * @cxl: details of related cxl objects
>>    * @mem_bar: The BAR that is mapped into membase.
>>    * @reg_base: Offset from the start of the bar to the function control window.
>>    * @monitor_work: Hardware monitor workitem
>> @@ -1148,6 +1151,7 @@ struct efx_nic {
>>   
>>   	struct devlink *devlink;
>>   	struct devlink_port *dl_port;
>> +	struct efx_cxl *cxl;
>>   	unsigned int mem_bar;
>>   	u32 reg_base;
>>   
>> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
>> new file mode 100644
>> index 000000000000..daf46d41f59c
>> --- /dev/null
>> +++ b/include/linux/cxl_accel_mem.h
>> @@ -0,0 +1,22 @@
>> +/* SPDX-License-Identifier: GPL-2.0 */
>> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
>> +
>> +#include <linux/cdev.h>
> Don't think this header is needed?
>
>> +
>> +#ifndef __CXL_ACCEL_MEM_H
>> +#define __CXL_ACCEL_MEM_H
>> +
>> +enum accel_resource{
>> +	CXL_ACCEL_RES_DPA,
>> +	CXL_ACCEL_RES_RAM,
>> +	CXL_ACCEL_RES_PMEM,
>> +};
>> +
>> +typedef struct cxl_dev_state cxl_accel_state;
> Please use 'struct cxl_dev_state' directly. There's no good reason to hide the type.


That is what I think I was told to do although not explicitly. There 
were concerns in the RFC about accel drivers too loose for doing things 
regarding CXL and somehow CXL core should keep control as much as 
possible.  I was even thought I was being asked to implement auxbus with 
the CXL part of an accel as an auxiliar device which should be bound to 
a CXL core driver. Then Jonathan Cameron the only one explicitly giving 
the possibility of the opaque approach and disadvising the auxbus idea.


Maybe I need an explicit action here.


>> +cxl_accel_state *cxl_accel_state_create(struct device *dev);
>> +
>> +void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
>> +void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
>> +void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>> +			    enum accel_resource);
>> +#endif
>> diff --git a/include/linux/cxl_accel_pci.h b/include/linux/cxl_accel_pci.h
>> new file mode 100644
>> index 000000000000..c337ae8797e6
>> --- /dev/null
>> +++ b/include/linux/cxl_accel_pci.h
>> @@ -0,0 +1,23 @@
>> +/* SPDX-License-Identifier: GPL-2.0 */
>> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
>> +
>> +#ifndef __CXL_ACCEL_PCI_H
>> +#define __CXL_ACCEL_PCI_H
>> +
>> +/* CXL 2.0 8.1.3: PCIe DVSEC for CXL Device */
>> +#define CXL_DVSEC_PCIE_DEVICE					0
>> +#define   CXL_DVSEC_CAP_OFFSET		0xA
>> +#define     CXL_DVSEC_MEM_CAPABLE	BIT(2)
>> +#define     CXL_DVSEC_HDM_COUNT_MASK	GENMASK(5, 4)
>> +#define   CXL_DVSEC_CTRL_OFFSET		0xC
>> +#define     CXL_DVSEC_MEM_ENABLE	BIT(2)
>> +#define   CXL_DVSEC_RANGE_SIZE_HIGH(i)	(0x18 + (i * 0x10))
>> +#define   CXL_DVSEC_RANGE_SIZE_LOW(i)	(0x1C + (i * 0x10))
>> +#define     CXL_DVSEC_MEM_INFO_VALID	BIT(0)
>> +#define     CXL_DVSEC_MEM_ACTIVE	BIT(1)
>> +#define     CXL_DVSEC_MEM_SIZE_LOW_MASK	GENMASK(31, 28)
>> +#define   CXL_DVSEC_RANGE_BASE_HIGH(i)	(0x20 + (i * 0x10))
>> +#define   CXL_DVSEC_RANGE_BASE_LOW(i)	(0x24 + (i * 0x10))
>> +#define     CXL_DVSEC_MEM_BASE_LOW_MASK	GENMASK(31, 28)
> This looks like a copy/paste of drivers/cxl/cxlpci.h definition. I suggest create a include/linux/cxl/pci.h and stick it in there and delete the copy in cxlpci.h. Also update the CXL spec version to latest (3.1) if you don't mind if we are going to move it.


That makes sense. I'll do it.

Thanks


>> +
>> +#endif

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8FB362AF18;
	Thu, 18 Jul 2024 23:36:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.10
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721345764; cv=none; b=kwXMJbG2WXlgE+Nka3lHu5uIxUMjwftdSLCXFkHRJoAtwyhJwNCakiIIb9IsjNLZNLxUZeUwrAc+TBMTmCmaP94LoHzKMEPTaoh8p5FnpraEU8p8CoEAUl359Wce5HZIbHHbc8GXOoB+NjzJAVIeXpIUC1zfE9IgawuowUwRcxk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721345764; c=relaxed/simple;
	bh=ep5eWrhAXKMT3a1EI4DLi3Mu5MhwEqP3OAgzzQUi5xo=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=aDn1TeEURlJZn3Ce9+IhzJoO/9M0XlRKaZJR0urmObEhn7aJizGFyWjCy5dUOOErdg0ikBSqLFwXWyh5fOmyJf43lwvglvpaJzjz1eOp05zlauPJ2o1FsW0HN2Xdg7CcR0eoAfDMSzgKRlvn3fEwhkCXbM2k6MwAHS9HKljRiZM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=a3azep9B; arc=none smtp.client-ip=198.175.65.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="a3azep9B"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721345762; x=1752881762;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=ep5eWrhAXKMT3a1EI4DLi3Mu5MhwEqP3OAgzzQUi5xo=;
  b=a3azep9BRUj2UMLjvO/9JwBqtl+s/QaHK45i1wQEFceLUfztPQAypG6X
   G3aH7mffTPwaQr5KP9dSfuuxguTzIoLNG9/tSEwv09wpB7Z6Y8hj0LCMB
   0yXCXDTMyKtrTFALgFAuiUla6/jTaTwDbuBjMnVcn1ZUagiEsJyPmeswt
   symHVH4UUl8XlXshBgr1ljf0AYsh8rle6Jnyv5Gfpn05pzCwW9Nqe6RF0
   x3CWeoGiX3BFSmzEK5nT2aNiHxxAhHSE/+6B9xmdG/ylVThhnusmifbno
   wmGOYSDyac4YdY80OLPGJwFFVpriSW0YBqfUuwYUItV+mErxEDQ/KvUmv
   g==;
X-CSE-ConnectionGUID: 1oSghVNnR8aLdFwz8ZOXQw==
X-CSE-MsgGUID: DtWISr8sQoe7H4JNnamjog==
X-IronPort-AV: E=McAfee;i="6700,10204,11137"; a="36380985"
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="36380985"
Received: from orviesa003.jf.intel.com ([10.64.159.143])
  by orvoesa102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:36:01 -0700
X-CSE-ConnectionGUID: 9QbGHwy+Q/GOIGQqvzaYcw==
X-CSE-MsgGUID: rIBhblh5QxWij0HjDc9PXA==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="55786036"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.125.108.184]) ([10.125.108.184])
  by ORVIESA003-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:36:00 -0700
Message-ID: <abff9def-a878-47e9-b9c8-27cf3c008c29@intel.com>
Date: Thu, 18 Jul 2024 16:36:00 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 03/15] cxl: add function for type2 resource request
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
 netdev@vger.kernel.org, dan.j.williams@intel.com, martin.habets@xilinx.com,
 edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
 pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com
Cc: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-4-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <20240715172835.24757-4-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 2732
Lines: 73



On 7/15/24 10:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Create a new function for a type2 device requesting a resource
> passing the opaque struct to work with.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/memdev.c          | 13 +++++++++++++
>  drivers/net/ethernet/sfc/efx_cxl.c |  7 ++++++-
>  include/linux/cxl_accel_mem.h      |  1 +
>  3 files changed, 20 insertions(+), 1 deletion(-)
> 
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 61b5d35b49e7..04c3a0f8bc2e 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -744,6 +744,19 @@ void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>  }
>  EXPORT_SYMBOL_NS_GPL(cxl_accel_set_resource, CXL);
>  
> +int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram)
Maybe declare a common enum like cxl_resource_type instead of 'enum accel_resource' and use here instead of bool?

> +{
> +	int rc;
> +
> +	if (is_ram)
> +		rc = request_resource(&cxlds->dpa_res, &cxlds->ram_res);
> +	else
> +		rc = request_resource(&cxlds->dpa_res, &cxlds->pmem_res);
> +
> +	return rc;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_request_resource, CXL);
> +
>  static int cxl_memdev_release_file(struct inode *inode, struct file *file)
>  {
>  	struct cxl_memdev *cxlmd =
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 10c4fb915278..9cefcaf3caca 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -48,8 +48,13 @@ void efx_cxl_init(struct efx_nic *efx)
>  	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
>  	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
>  
> -	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds))
> +	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds)) {
>  		pci_info(pci_dev, "CXL accel setup regs failed");
> +		return;
> +	}
> +
> +	if (cxl_accel_request_resource(cxl->cxlds, true))
> +		pci_info(pci_dev, "CXL accel resource request failed");

pci_warn()? also emitting the errno would be nice. 

>  }
>  
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index ca7af4a9cefc..c7b254edc096 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -20,4 +20,5 @@ void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
>  void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>  			    enum accel_resource);
>  int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
> +int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram);
>  #endif

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.13])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CC1FB80C07;
	Thu, 18 Jul 2024 23:28:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.13
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721345284; cv=none; b=iuF/ufhuWoSVEJcBDrGohz40UWr6noWQNA9C6ZGdSmXkzvNkojLcgGtSBivpkKn6zf1ACJkOKFY4k/roGmqNx+v7VpZRcDuMdiJxk+eD4aRCQgzdF9uTbrztN+5DzOEczu0/uFxzYksH5ycJZev7GBJRTg2Svm1KsFibNao2gyE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721345284; c=relaxed/simple;
	bh=QD1QghOQFNrENYCU65uuFoB5yjsiBE3UL5/XQnpp6rU=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=Vqp30NdQWDBsR209q0xPzPb6vfwPfZjixOCTVqFcUy/gcL2MNyvon0r4I5i1+SR+tUBIXR+87Fixx0q0vdx2dCK37C6xTENsDr4G1X0UxNy2yicgI28gAPVQ9VHJy0KBBOuiJeSHhbXKYvXvtnTtO01Yipzl8NNPz/EN+N1ahos=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=aXAqyHjV; arc=none smtp.client-ip=198.175.65.13
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="aXAqyHjV"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721345282; x=1752881282;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=QD1QghOQFNrENYCU65uuFoB5yjsiBE3UL5/XQnpp6rU=;
  b=aXAqyHjVBUJR1PSwyNbf4XGQgoO79wDIrIYsD+wGEVoJP6eLWnrNmrcu
   ngZrnPXaRiPuMBeF1RYiWEYFbBc8vHPKe+5WZX8G9pq6/PRmRpXziKxnJ
   /kYQuEJjUzomUZv4XLWqcf0o6QKR9pX2wbTZ4/bFq4U+f2/V3RGcjoAJI
   11ClTkZA/hC3uWk+cW5QtyBdzd0x2L1Lh/BBJlaxzwbdw+zAWm2hqQbC7
   GPDA853JsS8ELIaIR7XPaOJoWHbrllAbrwloyEOgwdUscNezPr7OAVpki
   eqem0ePKtegXyeXL/NcjC0Meg9x8FxmAoWKbD+WBQz8GHd483jQrrwQvK
   w==;
X-CSE-ConnectionGUID: GHpCuspEQ0mEk8W/3qGhbA==
X-CSE-MsgGUID: DKmuK59dRJidK7j0KPW5gg==
X-IronPort-AV: E=McAfee;i="6700,10204,11137"; a="30098696"
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="30098696"
Received: from orviesa007.jf.intel.com ([10.64.159.147])
  by orvoesa105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:28:01 -0700
X-CSE-ConnectionGUID: 2r360qDhToK1XvF2+XOO/Q==
X-CSE-MsgGUID: U1Yp8Jb/RDenoJcqYspsSA==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="51532661"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.125.108.184]) ([10.125.108.184])
  by orviesa007-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:28:00 -0700
Message-ID: <33c34f2d-55cb-4b50-888d-1293ea2fa67d@intel.com>
Date: Thu, 18 Jul 2024 16:27:59 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 02/15] cxl: add function for type2 cxl regs setup
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
 netdev@vger.kernel.org, dan.j.williams@intel.com, martin.habets@xilinx.com,
 edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
 pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com
Cc: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-3-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <20240715172835.24757-3-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 3150
Lines: 94



On 7/15/24 10:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Create a new function for a type2 device initialising the opaque
> cxl_dev_state struct regarding cxl regs setup and mapping.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/pci.c                  | 28 ++++++++++++++++++++++++++++
>  drivers/net/ethernet/sfc/efx_cxl.c |  3 +++
>  include/linux/cxl_accel_mem.h      |  1 +
>  3 files changed, 32 insertions(+)
> 
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index e53646e9f2fb..b34d6259faf4 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -11,6 +11,7 @@
>  #include <linux/pci.h>
>  #include <linux/aer.h>
>  #include <linux/io.h>
> +#include <linux/cxl_accel_mem.h>
>  #include "cxlmem.h"
>  #include "cxlpci.h"
>  #include "cxl.h"
> @@ -521,6 +522,33 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>  	return cxl_setup_regs(map);
>  }
>  
> +int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)

Function should go into cxl/core/pci.c

> +{
> +	struct cxl_register_map map;
> +	int rc;
> +
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
> +				&cxlds->reg_map);
> +	if (rc)
> +		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
> +
> +	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
> +				    BIT(CXL_CM_CAP_CAP_ID_RAS));
> +	if (rc)
> +		dev_dbg(&pdev->dev, "Failed to map RAS capability.\n");

dev_warn()? also maybe add the errno in the error emissioni. 

> +
> +	return rc;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_pci_accel_setup_regs, CXL);
> +
>  static int cxl_pci_ras_unmask(struct pci_dev *pdev)
>  {
>  	struct cxl_dev_state *cxlds = pci_get_drvdata(pdev);
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 4554dd7cca76..10c4fb915278 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -47,6 +47,9 @@ void efx_cxl_init(struct efx_nic *efx)
>  
>  	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
>  	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
> +
> +	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds))
> +		pci_info(pci_dev, "CXL accel setup regs failed");

pci_warn()? although seems unnecesary since error emitted in cxl_pci_accel_setup_regs(). 

>  }
>  
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index daf46d41f59c..ca7af4a9cefc 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -19,4 +19,5 @@ void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
>  void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
>  void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>  			    enum accel_resource);
> +int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
>  #endif

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.9])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 25D04145A1C;
	Thu, 18 Jul 2024 23:12:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.9
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721344352; cv=none; b=a/30WU9BfE8kIXxQk6V2kB5fL/UqpSC368p7g4Lv8NY8R+NIVgUE1o0oT5lhPxzHkeggN0i8pe7r/AvxCwtKm6h15MwJzPeHV546UPq6GoepENSP3WaM8RgnbZ2q9fOgBWnPqSj/0xmiCcW26SR+yoDX/pHjgGnYla4PduVuxrk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721344352; c=relaxed/simple;
	bh=vW1p0Rkqd6tUlF+S/3y/oWhnFBHM8+eaOf6HiZXXmCE=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=oFzhbend6GKgp/wnvjOU8bKAQU/FJMVpt7OjYWzZTKLGy9CbKtpgqzsK7DtEI+JTksK18YqIBb+ayJFMBe9KerB2+4aDOQx3VAQcicHNU/iW33lIKG55NDdfJ0/3mYC0yWc2O6AaDNlxD8C0hHVyCuXmxo5cNUP6oUXS5d3BKUQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=icQuaz3/; arc=none smtp.client-ip=198.175.65.9
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="icQuaz3/"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721344350; x=1752880350;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=vW1p0Rkqd6tUlF+S/3y/oWhnFBHM8+eaOf6HiZXXmCE=;
  b=icQuaz3/zC5Z3dDNu6AYeWpXcc+Z2derkplPm5QfrK1eKK/5qW/6eDSf
   KOnm9zqwBc/ASbmYS8KdL6M9WIUgI9SzpPVPFjhOxom+IFVH9AWhP02K/
   ULbbnGZjDIofkYo3IiTjpjmI0U7sXc8ox9wAYbeNXc/W5rvZlSVBCb+xA
   h4hcmvl6X92tKGHqDDfCRzwn/msR2mPxa1kPydkiLQk5gc74p/CffICVH
   b2Vj3q2OUgEzUa5cwO28J/0MXmdmwgULMoFrQVDTPPs29RaUtYaWH6jxv
   Efzyv6hyukT7FYlknmpufT1BqyeOpxJ2mG3AzdlIG9UYYzQpzhVprl8Vu
   Q==;
X-CSE-ConnectionGUID: oL7+gE76SceOHKZPyfhR/Q==
X-CSE-MsgGUID: fK4p23+YSQK6lHmlziV7Ew==
X-IronPort-AV: E=McAfee;i="6700,10204,11137"; a="41467618"
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="41467618"
Received: from orviesa002.jf.intel.com ([10.64.159.142])
  by orvoesa101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:12:30 -0700
X-CSE-ConnectionGUID: zPFmW2snSpyKYG2kXfhp9g==
X-CSE-MsgGUID: qKjTw1cJSlaJX5vLN9WzuQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,219,1716274800"; 
   d="scan'208";a="81557677"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.125.108.184]) ([10.125.108.184])
  by orviesa002-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 18 Jul 2024 16:12:29 -0700
Message-ID: <936eecad-2e98-4336-b775-d28fa1d87d76@intel.com>
Date: Thu, 18 Jul 2024 16:12:27 -0700
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 01/15] cxl: add type2 device basic support
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
 netdev@vger.kernel.org, dan.j.williams@intel.com, martin.habets@xilinx.com,
 edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
 pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com
Cc: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Status: O
Content-Length: 12350
Lines: 362



On 7/15/24 10:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Differientiate Type3, aka memory expanders, from Type2, aka device
> accelerators, with a new function for initializing cxl_dev_state.
> 
> Create opaque struct to be used by accelerators relying on new access
> functions in following patches.
> 
> Add SFC ethernet network driver as the client.
> 
> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m52543f85d0e41ff7b3063fdb9caa7e845b446d0e
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/memdev.c             | 52 ++++++++++++++++++++++++++
>  drivers/net/ethernet/sfc/Makefile     |  2 +-
>  drivers/net/ethernet/sfc/efx.c        |  4 ++
>  drivers/net/ethernet/sfc/efx_cxl.c    | 53 +++++++++++++++++++++++++++
>  drivers/net/ethernet/sfc/efx_cxl.h    | 29 +++++++++++++++
>  drivers/net/ethernet/sfc/net_driver.h |  4 ++
>  include/linux/cxl_accel_mem.h         | 22 +++++++++++
>  include/linux/cxl_accel_pci.h         | 23 ++++++++++++

Maybe create an include/linux/cxl and then we can put headers in there.

>  8 files changed, 188 insertions(+), 1 deletion(-)
>  create mode 100644 drivers/net/ethernet/sfc/efx_cxl.c
>  create mode 100644 drivers/net/ethernet/sfc/efx_cxl.h
>  create mode 100644 include/linux/cxl_accel_mem.h
>  create mode 100644 include/linux/cxl_accel_pci.h
> 
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 0277726afd04..61b5d35b49e7 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -8,6 +8,7 @@
>  #include <linux/idr.h>
>  #include <linux/pci.h>
>  #include <cxlmem.h>
> +#include <linux/cxl_accel_mem.h>
>  #include "trace.h"
>  #include "core.h"
>  
> @@ -615,6 +616,25 @@ static void detach_memdev(struct work_struct *work)
>  
>  static struct lock_class_key cxl_memdev_key;
>  
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
> +{
> +	struct cxl_dev_state *cxlds;
> +
> +	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);

Naked cxlds. Do you think you'll need an accel_dev_state to wrap around cxl_dev_state similar to cxl_memdev_state in order to store accel related information? I also wonder if 'struct cxl_dev_state' should be a public definition. Need to look at the rest of the patchset to circle back. 

> +	if (!cxlds)
> +		return ERR_PTR(-ENOMEM);
> +
> +	cxlds->dev = dev;
> +	cxlds->type = CXL_DEVTYPE_DEVMEM;
> +
> +	cxlds->dpa_res = DEFINE_RES_MEM_NAMED(0, 0, "dpa");
> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, 0, "ram");
> +	cxlds->pmem_res = DEFINE_RES_MEM_NAMED(0, 0, "pmem");
> +
> +	return cxlds;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);

I do wonder if we should have a common device state init helper function to init all the common bits:
int cxlds_init(struct *dev, enum cxl_devtype devtype)


> +
>  static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>  					   const struct file_operations *fops)
>  {
> @@ -692,6 +712,38 @@ static int cxl_memdev_open(struct inode *inode, struct file *file)
>  	return 0;
>  }
>  
> +
> +void cxl_accel_set_dvsec(struct cxl_dev_state *cxlds, u16 dvsec)
> +{
> +	cxlds->cxl_dvsec = dvsec;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_dvsec, CXL);
> +
> +void cxl_accel_set_serial(struct cxl_dev_state *cxlds, u64 serial)
> +{
> +	cxlds->serial= serial;

Missing space before '='
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_serial, CXL);
> +
> +void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
> +			    enum accel_resource type)
> +{
> +	switch (type) {
> +	case CXL_ACCEL_RES_DPA:
> +		cxlds->dpa_res = res;
> +		return;
> +	case CXL_ACCEL_RES_RAM:
> +		cxlds->ram_res = res;
> +		return;
> +	case CXL_ACCEL_RES_PMEM:
> +		cxlds->pmem_res = res;
> +		return;
> +	default:
> +		dev_err(cxlds->dev, "unkown resource type (%u)\n", type);
> +	}
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_set_resource, CXL);
> +
>  static int cxl_memdev_release_file(struct inode *inode, struct file *file)
>  {
>  	struct cxl_memdev *cxlmd =
> diff --git a/drivers/net/ethernet/sfc/Makefile b/drivers/net/ethernet/sfc/Makefile
> index 8f446b9bd5ee..e80c713c3b0c 100644
> --- a/drivers/net/ethernet/sfc/Makefile
> +++ b/drivers/net/ethernet/sfc/Makefile
> @@ -7,7 +7,7 @@ sfc-y			+= efx.o efx_common.o efx_channels.o nic.o \
>  			   mcdi_functions.o mcdi_filters.o mcdi_mon.o \
>  			   ef100.o ef100_nic.o ef100_netdev.o \
>  			   ef100_ethtool.o ef100_rx.o ef100_tx.o \
> -			   efx_devlink.o
> +			   efx_devlink.o efx_cxl.o
>  sfc-$(CONFIG_SFC_MTD)	+= mtd.o
>  sfc-$(CONFIG_SFC_SRIOV)	+= sriov.o ef10_sriov.o ef100_sriov.o ef100_rep.o \
>                             mae.o tc.o tc_bindings.o tc_counters.o \
> diff --git a/drivers/net/ethernet/sfc/efx.c b/drivers/net/ethernet/sfc/efx.c
> index e9d9de8e648a..cb3f74d30852 100644
> --- a/drivers/net/ethernet/sfc/efx.c
> +++ b/drivers/net/ethernet/sfc/efx.c
> @@ -33,6 +33,7 @@
>  #include "selftest.h"
>  #include "sriov.h"
>  #include "efx_devlink.h"
> +#include "efx_cxl.h"
>  
>  #include "mcdi_port_common.h"
>  #include "mcdi_pcol.h"
> @@ -899,6 +900,7 @@ static void efx_pci_remove(struct pci_dev *pci_dev)
>  	efx_pci_remove_main(efx);
>  
>  	efx_fini_io(efx);
> +

stray blank line

>  	pci_dbg(efx->pci_dev, "shutdown successful\n");
>  
>  	efx_fini_devlink_and_unlock(efx);
> @@ -1109,6 +1111,8 @@ static int efx_pci_probe(struct pci_dev *pci_dev,
>  	if (rc)
>  		goto fail2;
>  
> +	efx_cxl_init(efx);

No error checks? Does the device expect to work whether CXL is setup or not?

> +
>  	rc = efx_pci_probe_post_io(efx);
>  	if (rc) {
>  		/* On failure, retry once immediately.
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> new file mode 100644
> index 000000000000..4554dd7cca76
> --- /dev/null
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -0,0 +1,53 @@
> +// SPDX-License-Identifier: GPL-2.0-only
> +/****************************************************************************
> + * Driver for AMD network controllers and boards
> + * Copyright (C) 2024, Advanced Micro Devices, Inc.
> + *
> + * This program is free software; you can redistribute it and/or modify it
> + * under the terms of the GNU General Public License version 2 as published
> + * by the Free Software Foundation, incorporated herein by reference.
> + */
> +
> +
> +#include <linux/pci.h>
> +#include <linux/cxl_accel_mem.h>
> +#include <linux/cxl_accel_pci.h>
> +
> +#include "net_driver.h"
> +#include "efx_cxl.h"
> +
> +#define EFX_CTPIO_BUFFER_SIZE	(1024*1024*256)
> +
> +void efx_cxl_init(struct efx_nic *efx)
> +{
> +	struct pci_dev *pci_dev = efx->pci_dev;
> +	struct efx_cxl *cxl = efx->cxl;
> +	struct resource res;
> +	u16 dvsec;
> +
> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_VENDOR_ID_CXL,
> +					  CXL_DVSEC_PCIE_DEVICE);
> +
> +	if (!dvsec)
> +		return;
> +
> +	pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");

Seem like unnecessary kern log emission

> +
> +	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev);
> +	if (IS_ERR(cxl->cxlds)) {
> +		pci_info(pci_dev, "CXL accel device state failed");

pci_err()? or maybe pci_warn() given it's ignoring error returns. 
> +		return;
> +	}
> +
> +	cxl_accel_set_dvsec(cxl->cxlds, dvsec);
> +	cxl_accel_set_serial(cxl->cxlds, pci_dev->dev.id);
> +
> +	res = DEFINE_RES_MEM(0, EFX_CTPIO_BUFFER_SIZE);
> +	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_DPA);
> +
> +	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
> +	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
> +}
> +
> +
> +MODULE_IMPORT_NS(CXL);
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.h b/drivers/net/ethernet/sfc/efx_cxl.h
> new file mode 100644
> index 000000000000..76c6794c20d8
> --- /dev/null
> +++ b/drivers/net/ethernet/sfc/efx_cxl.h
> @@ -0,0 +1,29 @@
> +// SPDX-License-Identifier: GPL-2.0-only
> +/****************************************************************************
> + * Driver for AMD network controllers and boards
> + * Copyright (C) 2024, Advanced Micro Devices, Inc.
> + *
> + * This program is free software; you can redistribute it and/or modify it
> + * under the terms of the GNU General Public License version 2 as published
> + * by the Free Software Foundation, incorporated herein by reference.
> + */
> +
> +#ifndef EFX_CXL_H
> +#define EFX_CLX_H
> +
> +#include <linux/cxl_accel_mem.h>
> +
> +struct efx_nic;
> +
> +struct efx_cxl {
> +	cxl_accel_state *cxlds;
> +	struct cxl_memdev *cxlmd;
> +	struct cxl_root_decoder *cxlrd;
> +	struct cxl_port *endpoint;
> +	struct cxl_endpoint_decoder *cxled;
> +	struct cxl_region *efx_region;
> +	void __iomem *ctpio_cxl;
> +};
> +
> +void efx_cxl_init(struct efx_nic *efx);
> +#endif
> diff --git a/drivers/net/ethernet/sfc/net_driver.h b/drivers/net/ethernet/sfc/net_driver.h
> index f2dd7feb0e0c..58b7517afea4 100644
> --- a/drivers/net/ethernet/sfc/net_driver.h
> +++ b/drivers/net/ethernet/sfc/net_driver.h
> @@ -814,6 +814,8 @@ enum efx_xdp_tx_queues_mode {
>  
>  struct efx_mae;
>  
> +struct efx_cxl;
> +
>  /**
>   * struct efx_nic - an Efx NIC
>   * @name: Device name (net device name or bus id before net device registered)
> @@ -962,6 +964,7 @@ struct efx_mae;
>   * @tc: state for TC offload (EF100).
>   * @devlink: reference to devlink structure owned by this device
>   * @dl_port: devlink port associated with the PF
> + * @cxl: details of related cxl objects
>   * @mem_bar: The BAR that is mapped into membase.
>   * @reg_base: Offset from the start of the bar to the function control window.
>   * @monitor_work: Hardware monitor workitem
> @@ -1148,6 +1151,7 @@ struct efx_nic {
>  
>  	struct devlink *devlink;
>  	struct devlink_port *dl_port;
> +	struct efx_cxl *cxl;
>  	unsigned int mem_bar;
>  	u32 reg_base;
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> new file mode 100644
> index 000000000000..daf46d41f59c
> --- /dev/null
> +++ b/include/linux/cxl_accel_mem.h
> @@ -0,0 +1,22 @@
> +/* SPDX-License-Identifier: GPL-2.0 */
> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
> +
> +#include <linux/cdev.h>

Don't think this header is needed?

> +
> +#ifndef __CXL_ACCEL_MEM_H
> +#define __CXL_ACCEL_MEM_H
> +
> +enum accel_resource{
> +	CXL_ACCEL_RES_DPA,
> +	CXL_ACCEL_RES_RAM,
> +	CXL_ACCEL_RES_PMEM,
> +};
> +
> +typedef struct cxl_dev_state cxl_accel_state;
Please use 'struct cxl_dev_state' directly. There's no good reason to hide the type.

> +cxl_accel_state *cxl_accel_state_create(struct device *dev);
> +
> +void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
> +void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
> +void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
> +			    enum accel_resource);
> +#endif
> diff --git a/include/linux/cxl_accel_pci.h b/include/linux/cxl_accel_pci.h
> new file mode 100644
> index 000000000000..c337ae8797e6
> --- /dev/null
> +++ b/include/linux/cxl_accel_pci.h
> @@ -0,0 +1,23 @@
> +/* SPDX-License-Identifier: GPL-2.0 */
> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
> +
> +#ifndef __CXL_ACCEL_PCI_H
> +#define __CXL_ACCEL_PCI_H
> +
> +/* CXL 2.0 8.1.3: PCIe DVSEC for CXL Device */
> +#define CXL_DVSEC_PCIE_DEVICE					0
> +#define   CXL_DVSEC_CAP_OFFSET		0xA
> +#define     CXL_DVSEC_MEM_CAPABLE	BIT(2)
> +#define     CXL_DVSEC_HDM_COUNT_MASK	GENMASK(5, 4)
> +#define   CXL_DVSEC_CTRL_OFFSET		0xC
> +#define     CXL_DVSEC_MEM_ENABLE	BIT(2)
> +#define   CXL_DVSEC_RANGE_SIZE_HIGH(i)	(0x18 + (i * 0x10))
> +#define   CXL_DVSEC_RANGE_SIZE_LOW(i)	(0x1C + (i * 0x10))
> +#define     CXL_DVSEC_MEM_INFO_VALID	BIT(0)
> +#define     CXL_DVSEC_MEM_ACTIVE	BIT(1)
> +#define     CXL_DVSEC_MEM_SIZE_LOW_MASK	GENMASK(31, 28)
> +#define   CXL_DVSEC_RANGE_BASE_HIGH(i)	(0x20 + (i * 0x10))
> +#define   CXL_DVSEC_RANGE_BASE_LOW(i)	(0x24 + (i * 0x10))
> +#define     CXL_DVSEC_MEM_BASE_LOW_MASK	GENMASK(31, 28)

This looks like a copy/paste of drivers/cxl/cxlpci.h definition. I suggest create a include/linux/cxl/pci.h and stick it in there and delete the copy in cxlpci.h. Also update the CXL spec version to latest (3.1) if you don't mind if we are going to move it. 
> +
> +#endif

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2073.outbound.protection.outlook.com [40.107.244.73])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4A4244206A;
	Tue, 16 Jul 2024 08:50:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.73
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721119859; cv=fail; b=OJxBlpx6ciPrBrCPYRUUv1MItdFZYHJKEeG4rK8n1ZI5xmEIeMrNjX2Ku9wqa536Akw2PniawFOFYbPAasfHD0fHWjJbpMd/MGW7PMSx6FxdOrQ8Yd8fm5BCrXkXWHMGD8d53z/APVdTV5rYf40GBIJbc+Smw3F6nCKC2hmh8ks=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721119859; c=relaxed/simple;
	bh=Jg6Zrmv4GJOCAx3A0I5ocFFp31aaSmOEj2qQcRHIgmA=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=rLNR41ASvtKJj4K6qXwfmZIgNTm7yAIr5+FF9OAD/o+Oq/NjOMNnLPp4NUD037unsLFOQmZxZKGANkfJ3XOhESjfI3MMU91wiO+KsLBFQirVVRTsBCdHC5TL3SbA8x1A+MF+ELfIXqhr14TPSUi0Vvlbq2RaZNT3EXtvzl4JIbI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=nB1v5qCB; arc=fail smtp.client-ip=40.107.244.73
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="nB1v5qCB"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=t6lOvWCCVrLT3ZoL1uPbdGjnqjmbk5oJnKDmnCZdc/eEz7FH+kRGjspSWWiKf4mzOfctcu1pGbGTMAUVYGBFB+JI2eRQiu6iwP+Y9Rum4aCCAJA9WPLKI7Z9QyH49N0mQst9mQ1PUkaVfQnGMmZZv7xaJRhtOlJCniG4hUx0zWPf+BKELSjfYXB2/XNKq284smko/hH6AtXdylwurII6JMvxcp1wHTRchac/pEemmerjfHiiuq4rLE+6tTAK0qb9NN/WUY6cltRxJGbnMVJBwj0jGIWzaZuwVYhBB7olfX9717iZ5bY6ImqTe7QDTcR4pVrXaEkPtX6a2uEB4sKFtg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=gPz+7ZSMil65FY4Pea2a1s1pqrjx5D9ihw4O9o0KGds=;
 b=d/FTm+1ItAUyU1H4KFV19e+0no7uDK1TvYrw1Wx5F8dSWxIT2iTTP0MIgMfQaKhilINWJ1JCULEf8W3ZN07ghz2WodELogP1H3M7kEsmZksSQi+zKCbxoMpSsp1vQrCoCNL5EkkWGx/n5cGvl4/nP97Akl47HfXhnwg3mpDF1CDyAPlYKHgPiQBx9hqoR5McQ2Y4g0iEhYlndbIENeyReoHwqyOtTWtetXKFgLwL3+yn7OnQhl1xZ6OeohPq/IciADjcQoPTqsz6cUCZa702eli3R68pkNocIjrh/ZsyAMfEvXiYHOXwI/5wDHgVjVtHuqXfgeb3u02vYF+U9nfoCA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=gPz+7ZSMil65FY4Pea2a1s1pqrjx5D9ihw4O9o0KGds=;
 b=nB1v5qCBZKttCnXsE5CHUCEK29Cy8+tGW1gESYNEZs78H5NttSU3lms1EECxB9bVBpcDx46GhDJ7i5/nDljDzozMYrO03HG0EZXxuP97fss22LLdMGsCYOtQBZW9k91MPiFv98Rs2LqGxJtcurQDNCp6GuvZ6S2ZAbZkaV01B4w=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB6740.namprd12.prod.outlook.com (2603:10b6:510:1ab::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.27; Tue, 16 Jul
 2024 08:50:55 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Tue, 16 Jul 2024
 08:50:55 +0000
Message-ID: <799c897d-facf-e6d1-6c13-ccbc09630389@amd.com>
Date: Tue, 16 Jul 2024 09:50:47 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 01/15] cxl: add type2 device basic support
Content-Language: en-US
To: Andrew Lunn <andrew@lunn.ch>, alejandro.lucero-palau@amd.com
Cc: linux-cxl@vger.kernel.org, netdev@vger.kernel.org,
 dan.j.williams@intel.com, martin.habets@xilinx.com, edward.cree@amd.com,
 davem@davemloft.net, kuba@kernel.org, pabeni@redhat.com,
 edumazet@google.com, richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
 <72858182-c0e6-4c05-a11b-fc137f8f1edb@lunn.ch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <72858182-c0e6-4c05-a11b-fc137f8f1edb@lunn.ch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P265CA0153.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:2c7::16) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB6740:EE_
X-MS-Office365-Filtering-Correlation-Id: a70a123a-704b-4a8a-f9bc-08dca5746749
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|1800799024|366016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?djFNUXlRVS9mZWN4WlpLTm9DVjU0M0JjdERYTHpJd2UxWHkrM1R3b3dKSlRv?=
 =?utf-8?B?QlJZZTdaM0VqWWk2aEVVL1hiK0ozNWZkZGE5UC9VUDRIMkFWTlQrcnkwNGIr?=
 =?utf-8?B?OXZmYzR3clYwMnpQL2YrbStaMDNKTzJWNU8vS2RtUG1GSkRZREdXNFhKUlg3?=
 =?utf-8?B?T01wVnNxMTVXREVPYzFIaitWQkNsRHQ5L3hlZnEvTk05VlNCdTBMVFhUeEht?=
 =?utf-8?B?dEpHVWRONVBva2h2em5MQTVIMGhvdFhkQVA1cXdQQ1l6YXN5OXFwZHg0RjBV?=
 =?utf-8?B?eUtkVU5NNnZXNTVwS3lYb3JXSTJsL3dXWUlTeEM2RjNwMlpSTGo5NUZBRHdG?=
 =?utf-8?B?Q0NQUHFlVXY0NGpTMnpIK0VWdGdLZU1PU3E4V0JhanA5cTJpNDNQWXZ3V0tO?=
 =?utf-8?B?aTFtaXRDbTN5b0lxNm1oTFEzalYvZWY3STRGbmhQY0dLVXJVcHh4WUkrcVh3?=
 =?utf-8?B?eGJNYzkrRVNKRTVOZytVczZUaUNGYVQ0UnJueXNJNjBuYlN5Q2U4d014d29P?=
 =?utf-8?B?V2VHSVhFZVd2amk5L1IvaEErN3huN1JPM05SS0FreFUvTE5Rd1E1d3NNSStk?=
 =?utf-8?B?UUpVVGlyVjk0M2t4WEwwYThkajBSWHlmS0RtY1FERytROTRIQTlsVHFmditY?=
 =?utf-8?B?SUt2cmdIeVA0OFBIcjl4SkRwNVVOUk9iS0dMUWcrd3JOaFU2ekh2dFU5VVJH?=
 =?utf-8?B?K3dSTjdEVGlNU0syVzYxd2t5dEFObUhXZkorR3A5eFJUdEhtU1hpWFJNZFc2?=
 =?utf-8?B?L0JiM2J0b3UxVkFuU0t6M29oeGtWTFM0LzBGdSs5WEk4NDdGdjlXZnJFOE1M?=
 =?utf-8?B?MnlwV3g1OGk2Z0lEREk3NWNwaGxHZ0xoMXd2WWF0NTNVY3laMHM4TkRYUTYr?=
 =?utf-8?B?YW4xbDVRVkRpRnlzUUdMWjRjbW9QUWliYkpkUW9mSmlyOTJMVnU2NnRQY1Vy?=
 =?utf-8?B?dUQ0VDJVdmtOMnFkU0NIcnUrMW1tSy94L05kYisrcGpZWUFFRHprdGhxK0d5?=
 =?utf-8?B?WU5ocDl4QzZJNkhEUmN3SlVSbDNoZ0FFNFhpVzJBY2xHWFZCcHFiMkt3RDlQ?=
 =?utf-8?B?U2dVUk42M1N0Vmp5V0NYQmFPUzlVZFhtTTNCc0lGOVhvWXRidnZGaGxZb1J2?=
 =?utf-8?B?dTA2REJKRFFHanVYeUpycGFwL0h4T2dybmttQW1nYjZSWWJ0M0MvNHlGcmEw?=
 =?utf-8?B?ZDRScVJDOVpZWW84aWtMdU5NWmZUQlJOQmtub3lxVHhpUHVGUTk2VGxJbWRn?=
 =?utf-8?B?aElwaWcwMElWMFFnNG01TEh1MWVDVkVzaXBkemlSZlZhTEVxRmlmeUpaUHNi?=
 =?utf-8?B?YmVHaG9rTEhOcy9CVnFseTZJbG9mRFdkN2ltM08rSWloZDIrM21QQnJLMHZi?=
 =?utf-8?B?SE1wSlpqTlREZisvSmppaG9nYkZ5dFIxbWxicGQ4bDJGb2czUjBuaUUrcnFC?=
 =?utf-8?B?MVhublFtTGV5WW5EWTE5TXhyUkRMQk90RjlwS2crN1ZBcHZvYXdyQldlWGU1?=
 =?utf-8?B?T0RSMEpiOTN1TW1mTXFMNW4xdmRUNEVrMHB1aktYOVp0Ynh0d1cxaXNWR052?=
 =?utf-8?B?ZmhGMDZHalpGSlhqM3g4RTFYY1I4d3NCSlRZQzFwUjVrSW9qdy9pSU5wSlNN?=
 =?utf-8?B?d3JuMEl2U0MrZlBSd215QUEzS2ZaSGp5MzNHOGhGK29yK1F3eC8wMXBtYnEx?=
 =?utf-8?B?aG9wMjdvTFBmR3p2WWtBcWFXYnd0UG53OEVDYnJrbFBkb3JhL253QnJrNWdW?=
 =?utf-8?B?Yi9nbThteFZlZUhlVjJPczRHLzM1bC90RWJOMFJBUDRVOHM5L2R2VDQ2ZEQr?=
 =?utf-8?B?bldVS0xOdFkyclAxb0NGdz09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(1800799024)(366016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?TjJxS1FJOWdCQ2xRajNkVmFoWGFHL0xpS0NWZnZuYlR5SnFYUy9vNWZnSzl4?=
 =?utf-8?B?TnJXTnNqck9ueXEvQzZNM0xsd2Vua2lCMEtUTHhZeitvYUVibVZmaHMwRTd0?=
 =?utf-8?B?Qm9Gcm5Gc0lGMWhFcytPK1RaUHRUOVRocS9uUDlqVW8xSGN4RS9FYzhTV2Ew?=
 =?utf-8?B?WnRyR0JxRitiZ3dLMG03Wk15ckNLNTU0ZWg4a0ZPMlBWM0JNWnVyS05HSWl3?=
 =?utf-8?B?TmdWRDNrRnNpZWIzQU9oS2RSTnVDNTRyc2xQWFdzQ2VYd1lDbEhDMlhGdkxP?=
 =?utf-8?B?cytGZ0dLYVl3RmtKUVZ0L2Jrd08xazBydnB3YmJMWGUwNmVCak5aL1laYVdM?=
 =?utf-8?B?TElKMFdKN2Z4NnhNWVpRa2xIMCtibUx0TXljZ3FjaGNiQlFmclJKeWdyaTZU?=
 =?utf-8?B?cGlPMnZyYU81QmJmdHhIeFFjNVZRSlBLU2NWQXdxUlBqU3ZJREtYcDFZcFVW?=
 =?utf-8?B?RmtDNHYxVXlleE9YNEZUaUdRcXRtTHYyU2xCa3ZERUI2eUpzUS9OUHE3K2I1?=
 =?utf-8?B?dnJlRnVSaFNaQnpBNU40ZEZNaTUyNDVJRlEwR2pWbUpHNzBEeHJQMHFEQU9n?=
 =?utf-8?B?UVlaRitCcTJ0WVl6THFBd2dWOUR4UHNSa01Qb21vRGFES1lGZWJ3MGdGU2o4?=
 =?utf-8?B?TnFIL1NiaGxmT1VBZW56Y2VUZVhhdVFPTHNJS1RadkIxVG9HWkQrS2lTTGpa?=
 =?utf-8?B?TmJ3OE1UdGxoSUl2Q2ZSNEx0aVdCLzlvN0RlRzVNT3plMEw0SnhpNWlyWFBC?=
 =?utf-8?B?ODl6REkvUHQ1cks5SkdvOUhURHgxeHhMWnJBUmxFdHhnbEVYdVJLdHlJV2lI?=
 =?utf-8?B?eXEwenpMbFlvMnlUMmJHK2Q1ZjAremhFT2JySTdKMUlQTjdCK3JEOThVWW5t?=
 =?utf-8?B?R3ViMVVkUzJVakxnaFAzTzZxaTZlaDk3dkZHWnBZVDVjV0Q2Y3hmV3FjZFU1?=
 =?utf-8?B?S3Q3N0VMZFFNMjFjMjNYc3hwSFUvYWt2OEVEald5SnhDbnZES3hkaXZwcXc1?=
 =?utf-8?B?SFc4VTlCYjhjMkVRK0FJaXJ5TjBNenBSZGVtbHorRkxjcEVSZ3dHMGdZUEtN?=
 =?utf-8?B?VUk1UVNQc3VCWS9CMnhuWDM0cFBjbTR1alRBVVFlVWk2aGVWMXJtdVc4Q3Iy?=
 =?utf-8?B?NUc0YXpYQmRmWkZ2WUt1VnJIcllNWENMYU01SXUzU3AxbzVzNE16REQ4VWF2?=
 =?utf-8?B?dUxQdnZFL1N3aC9CcmJlZzlzNktpUUs5MGZmM05tMHBQeGZCZ3ZjaXk4S2Rp?=
 =?utf-8?B?ZkxyVDQ5RThWLy85MkdRZUFiRDcvRGNHUTl4aUFZK2VTWVJKNUFvVjlBSWNj?=
 =?utf-8?B?T05jUVFFR1hPcFZidE9xWUtXNWtQTWM4T2FGeHdHL1hNZlRCWGx0K2prVUxY?=
 =?utf-8?B?SzhOcE02N1k0QzRtWTNKeHMxMTU4R3NBK2FqNG5hRzhISGVjeFlVcklTcVVB?=
 =?utf-8?B?T3NVNHQ4SnhqdWRNek83SXBHa3hjcFNZMGtlTVYyUVVGeHo1RUt2bGR2YUo4?=
 =?utf-8?B?Q25FZDl6Slhrc3ZCL0plTWo4b1pBLzBZbzRoUlYzdFY4MCtUVkdycldPQmZt?=
 =?utf-8?B?RG84ckhlN3pZTkdlSW95VFcyU0hTSnoydzZtL0l5emRxcXc4WkdjYUJTVVlM?=
 =?utf-8?B?amxKMjFRcTBwTmhsNXhPWHhYNElGd0ZaWE1NNzZ2SHZHUUhpUzdvdFB3KzNw?=
 =?utf-8?B?S1FGQnlPS1FBM3Awb1dsWWk3TTlxTUp2UTZ0VEp4bWxOODhrUlV5VzRaclpD?=
 =?utf-8?B?VGdlczkwWldZMmtTVFcwL2VEMmVHZzE0MkJrRk9laVpmWmNKSXgyQXR1RzUy?=
 =?utf-8?B?TTV5UXVzUjdvQlpvdXllNCt4ZC9FVjZXSmFrTWY5RVV2Y3l5M3lGSjkxNEZ6?=
 =?utf-8?B?TmhGN0ZlTGZLcWJhTE1OVVFxM1FjT2xkUllKU3BTTE01Kzh4V2c4MnlZYkFL?=
 =?utf-8?B?bUF0RmtnUkpFS2VJSXpTUjYzZktIN3NsZzhpWWJsc1ptVTRiOG5YYkVGVEpK?=
 =?utf-8?B?TjNsU2MxYlNMZ3IzNTN2dHRRaUFNSGplZWhiZDhPTDdsV3p4T1dCck9KS3Yz?=
 =?utf-8?B?WGtrYUQ5ZlpzKzVsTDh4KytEbkhPL3M5YW5IZ1NzR3pQOFdZUkhSSk9ocm5a?=
 =?utf-8?Q?LPsQBxE8tq2Crj/YzAHHZkB87?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: a70a123a-704b-4a8a-f9bc-08dca5746749
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 08:50:54.9421
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: Y7qW6jCOVQZ5nk/Pc/7ngnId29SCfPPmymbfYLh4xHTJqWurjOGejjA1yVZzMSOJ2hI0WHETkrCd5g/Y7h5r9g==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB6740
Status: O
Content-Length: 588
Lines: 23


On 7/15/24 19:48, Andrew Lunn wrote:
>> +++ b/include/linux/cxl_accel_mem.h
>> @@ -0,0 +1,22 @@
>> +/* SPDX-License-Identifier: GPL-2.0 */
>> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
>> +
>> +#include <linux/cdev.h>
> That is generally a red flag that something not good is about to be
> found. But it does not appear to be used in this patch....
>
>         Andrew
>

I have no explanation about how it ended up there. I suspect it comes 
from V1 --> V2 transition. cxlmem.h includes it and V1 was moving that 
file to include/linux.


Anyway, I'll get rid of it.

Thanks


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2074.outbound.protection.outlook.com [40.107.94.74])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B551457888;
	Tue, 16 Jul 2024 08:13:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.74
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721117611; cv=fail; b=EI0wg98zU8pxR3wYpMkYrIPgniYwfiMNScl2GtnHpAYIUV5BGl43QcLoH+hZtCxOY/3Lp3wwnOU1SHz03JgAHJ/jtRiFhPDIqCvJqlj2bXNvm6Yd0gwrJvhqrZi6mLoQVP8FMuNRjEcFgttbRP+dzrnTwDPbXvW27P2b5XQDXtQ=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721117611; c=relaxed/simple;
	bh=fpOTZPoD6Wn9M/G73DvF35FW8NQF9DpNdPKb/4erBg0=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=WqsEAvsb9Y6OeJlMJQ1rNjwtIIXxpHszxbCujSJyhwG4f9e/zqidfsU/2jLTnJALDFUh+fLXV/raoA0zTybMVk3os+gLN0344YC7CzyMaS6UBIC9yuDxDFl6Fe+UwTPupRVUr8cMlIAbHmrFXs7b8xDdH1zDdDmE2l/Rx+E9etM=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=pTASlASo; arc=fail smtp.client-ip=40.107.94.74
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="pTASlASo"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=YuWojO3XLfQF35Hgi8oAqg6ev1oXeyS2Z5b7aXcMAphvnRsvEnwHbzDTy5QmDvhmEg25PdG2Z3a07i1yj2MJ4SxAHhqutsGYXNtPnlRGTcGzfZICLZOMfqJnJQBoSXriWlz+sXsQ495Bv4/LHc0CklR7fU0bh+3q/Fgnl12cfw7Z6Z2vY3f1JFU55gO7DfoYbwneoBU+6ce23eJBYTBodnd8dtVAIfgxak+apEQt5Kuwk5FD9WwavedsH2Dp33wvuZCVGjNQS/SWTXv3BKCoSnNpU+iyQxxSnBsYarSNM0AfEZ9dTgzJlIYA69S3YfmqVHbVUMB+a+mQLGojO/0DpA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=FWuhMWNKZJopAo/kX1ef4hrkJD51Ehbe9yW/RNY7i34=;
 b=ZeTAyixEtRHLs72WyftnDZYrmhdK98W7CHgI7W7bGE+uDwBVi/BnPp585FbmCe9FVF6bYatqnPd7VRhObGlqp6+Uy/nmWQkr8OJ9w9ZaXjXunxaOSPDFnVl0dubYYZEmkfQAr7UYWnS3PTs5M2nuuVhLc8RawIMZmX6b99OhH6Cy001GSy1yZZnp7ZLHQuaz/ouA/HvVJ/MQy3wD+Y+jaEQzXgUzOfOyS5hAswHh40V4cwb0xBkWkyV64T/w51VCNja/wa9hEfLabckyiF11YjyahzY1ZJLFncXCd8OwxVyugBDcse3oUcU2rRqYpmxKpYlje2Vv5WLUo6/9rZ+ClA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=FWuhMWNKZJopAo/kX1ef4hrkJD51Ehbe9yW/RNY7i34=;
 b=pTASlASo5J1g+cIV+BwJsZcTJ5dOczxVo9TMJSiOVkXkwhD0F7CepdXOwKujDdq7pnQ7sUNZmkpoXvpP9OaoZtRyBH1MRJK1hToRKg6KwLUe2jWmf8EV/Xykq/sdFIZSrcEQ9UzuHxxzMiFTuoCujT462+gTt83Z5lW+tU8Xlz0=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH8PR12MB6964.namprd12.prod.outlook.com (2603:10b6:510:1bf::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.24; Tue, 16 Jul
 2024 08:13:27 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Tue, 16 Jul 2024
 08:13:27 +0000
Message-ID: <1cd50929-35f5-d0f1-9a68-d22e28cdf1b6@amd.com>
Date: Tue, 16 Jul 2024 09:13:18 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 11/15] cxl: make region type based on endpoint type
Content-Language: en-US
To: "Li, Ming4" <ming4.li@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-12-alejandro.lucero-palau@amd.com>
 <1f082012-1ad6-4b12-8eb4-96bcc61704a0@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <1f082012-1ad6-4b12-8eb4-96bcc61704a0@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0352.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:18d::15) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH8PR12MB6964:EE_
X-MS-Office365-Filtering-Correlation-Id: 795adb95-805a-4e06-ec1b-08dca56f2b16
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|366016|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?YXl5RXhsMytCaGJuS1RGekVlaEZqZXhkSnova3FlbkNacTVFUGc5UUtvVzZH?=
 =?utf-8?B?SEV0Q2grRklQTXUrWXJLaXlPNGlMWWd3dG5IbzV2Zjk0WXBLbC9xb2EzWldy?=
 =?utf-8?B?NjhGR2xhOEZaOFd2bWxSbXR3RkRRYWQ3ekcxTkJUUHRqUUFreHZYMmI4dysw?=
 =?utf-8?B?N2dMdkFGZ3MyVFJTUEpnTTEwaU1EKzgyTmxPT3BhL056bitvMG5mRWVBTTVm?=
 =?utf-8?B?Qmp3NWdjZ0cvM0tYNG45b0Z6RmN6MVk1czFNQktKRndrMFUvWEVsN2lkZ1Zy?=
 =?utf-8?B?RTBqN0tuVStNYU1TZHV0QzRhT21POGlHN1JCVmc0ZjNENkoyZzlQZDlBVDVB?=
 =?utf-8?B?b0dZTmxKZnpPUWFLd2JjOXJ0bXFWYWpRKzRWcUY4endBSDJtUlpwL3R5V3dN?=
 =?utf-8?B?SktqbVZ5RitXa1dZeDdzOEd2WlBsaTByQ1QxTkt1WDFGNlZRRWUyakR6M2tH?=
 =?utf-8?B?YnhtSW5jYUttUmx5RkkyY3MrdlN2Z3ROZjRPZ0tIT3dnamllSkNKNWNFdnBB?=
 =?utf-8?B?cGVlS3o0UXllZGtKQ2lTcHY3dVRyakNldVNtY1ZnazROdVRjbTUrZWtpUWpl?=
 =?utf-8?B?T1hYL2xOblhIa3gya0FVVzJlcTdZNExPT2FQcTlVNVZlUnBkSkYxdENIZ0FE?=
 =?utf-8?B?ZzZnNk4vNHZWUnVwZ1BqeUdTVWpSWnlsU3RSYlhOUERtZlY2N252ajFCR2NJ?=
 =?utf-8?B?d3ljU2FUK1FScjdZa0lteDlGUDJoK3gzUlYzdjVkVCtJTzF3VHhGY3pmQmNL?=
 =?utf-8?B?RnRTY2NUanRkcmZzSkJubkk4OWNxMTQyS2ZsSHg5aVdZWkdCSVRjVWJzeWpD?=
 =?utf-8?B?azRSekNwSDhoOGloQXZEeTI0aVdsa0x4Y09GVFNZb29VVlpxQ09tUEdmalcv?=
 =?utf-8?B?NXdOaElacjNadEJUdld0MmVrdUFXdy84TUtMUFhVRmRDZVRsS3J0djd0dm5a?=
 =?utf-8?B?REpJUkUzR3NMNEVEaHpjanM1MFBYL0Y4ZUVjcXNiMi9JRTd0NHZzZVM0Y1J6?=
 =?utf-8?B?UVh2SlhyMFFJV0F4Z3RrSklCbW1haHFZTGdHSGhuRXpDMmlLQTJqSzlCZGlK?=
 =?utf-8?B?ZUV6RnhLc2RoVktPWmxXZ0hteFBkWk4xWTZXeS9yV3JKclJydTlqdW1uUEM2?=
 =?utf-8?B?TlVJSk9KMnI0aHE3Y0ZldXV1b0oyWDE5VVFiNVZXcHl3TlhWckQ2bko1U0dU?=
 =?utf-8?B?TnNXdEJmTTV4a3hzLzZ5MEt6M3RHQXIzaVNWc214RitCNVUxQVNMR3RpS29G?=
 =?utf-8?B?YmFRbitPLzh0VHk1bWIrSUg0b3RvOWMwMFJhN3o2U2pHT09Wd0pFU1J0OXZD?=
 =?utf-8?B?ZHE4bEhRdE01SmEwM3ZVRGhwRXZnUkd3eHlQWUFiaENLaEtKU2FWSlF0QXdH?=
 =?utf-8?B?M0xMaG1aOGlkdjZubXhqbHJtWUJ2dWV0WVZCSFZFN05xU3kyZS9la1p1UVFP?=
 =?utf-8?B?dWlmMTJlRVgvRXphU2VtcHN5bGZnS3ZnaXBsZlMybFBxQ1orUk1DQkdjQUVy?=
 =?utf-8?B?VnBEWmNnOUVaYkJvMWl2ck95TlptbGR0MkpmVWJrR3dhQUV2bGNHTjRabDZw?=
 =?utf-8?B?UGQ5K0JWRmhqays2MXRkcnJGaml4TkpSc1ArczVPTDlHMUZ3UVZpYXVmb1h0?=
 =?utf-8?B?d05CZVR2d1RKV3hMSW0xOTluaGgzSEpIUkJ1SlBhYjBKYjYwNTBSdGgvYVc2?=
 =?utf-8?B?UVhOdGE1STJnS1g5aFhIeFBnbkZqeGM4bjBidDRETFpuVjRpT2p2cmhIb3B3?=
 =?utf-8?B?SzBkVi9GcEwraS9Kem55Q1BTQmZSZDFmMjh2OEtoQXBzOTAyeDhoTllaUVdL?=
 =?utf-8?B?MUpRTkprTGdyeEFueUtHRUdySHh3MU53dkZORWFJT0JqT3hLWkZKMGhXbHVj?=
 =?utf-8?Q?mSE3CoLF8d48T?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(366016)(376014)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?QkxJSlF4NzBiT1RNYWVsaVBjdlZFeGxubW9SR0V4eHEyY0JhQzhkVWF6N2xl?=
 =?utf-8?B?MWRjd3lPV1FkYkNzajVCdVZRSDdlL0VGNzU4MVRpMjE1V0tXMkxwdm9mLzkz?=
 =?utf-8?B?WElUSG8yWURyNlVuVVVYR05WYlVLMDlJTVJmWWxTSS9FOTl0Z2tSeFBmcFNQ?=
 =?utf-8?B?WlVQOFhIOTBodjlmcTdjM244Y2RSeTVvRjlSU1BLa05zdU1OTndWRk5OK3Uy?=
 =?utf-8?B?aDBZMXB2NzN2N0kvYi9ycitCenRVZHVsRS9YaXdMa0hHYm9Oa1kybVB6djFo?=
 =?utf-8?B?a3JBMEJNUVI4MFlnMUlQL1ZnekQ0eU03aEJXSzlEQ2pWQ3VvZjlxcmdSTkwy?=
 =?utf-8?B?MGtId2hMWmlwZUtVVXFDWmY1YVBkYll3OHFjTFJOMndCZFl2YVJDdVR5OUZR?=
 =?utf-8?B?Y0VrL0JhV0dTTDRXZTFveGtrSFVLSEVMbTdnMTA4K25tR2IzVDZRc09MVmZH?=
 =?utf-8?B?N1FaLytFYXMvUDRhejBXUzN1Y1VHNW5uellpZ1hyc1pFWFBzZS9rVUxJTmpF?=
 =?utf-8?B?S1pEYjR3RysvbUlESW1nRjlkUFI3anhyd3Q3dStxcDdhRXFpSy91WVZHVXpB?=
 =?utf-8?B?cWpKSVEwTkdSYnpwdDZja3JzcE9DMmtRRVloZnQraHYyTm5KZnNnSnI5SS9m?=
 =?utf-8?B?TlRGOU9TNVFTR05lcWFhcUxoOVRKMFNCQ29wMEp5aE5wZkZxZzAySU9ibDRz?=
 =?utf-8?B?czZmU0twMTRaZ1MrMFRzREszNzQrWVg3cjNWekpxL2wzTktnaDMyMXM2YUUx?=
 =?utf-8?B?bnY0Ni9VaDF5TmxTWng2cEtrTlU2clNvRHE0YWR5TzF4UzZMMHdyVTM3eWZ1?=
 =?utf-8?B?dldnVDN3aDZERUlyZ2lPL0xIY3p4RGtwVTE0NC9jZTlBVWdLRzg0aVRnTXIv?=
 =?utf-8?B?MDRPVlVCSXdqaWp3R01WUmZYYXRSckhoNzZsQndXeHB3TVVQMnVqZ2dIY3J3?=
 =?utf-8?B?QkxuVUhvSXY1K016S1Nzb2xURWpkaWh2NFh1WkFwM1d4S1p3b3lmelowc0JR?=
 =?utf-8?B?Uk8zdDNRWUN3NEF5NWRaVHFONGF4SHBsNHU4RVRwZi90V0E1SzB2Z0R1QUdU?=
 =?utf-8?B?WkpnZkc4Wm5MbUI0SXRqWENUemROaWNIRDBhWi95b3Q0eS83UmlUSjVRN0lY?=
 =?utf-8?B?QStVYnhMTFV6ODVVRFV5RUdDUzdFdDFNYTRqOFBkVnJiSGxUM3N5U1I3ZkhR?=
 =?utf-8?B?UEZnQzNCZ0lNQXlSYzNSeGFVcndWNjF3bFZBL3doUmRsL1hzWFFadTVsRStk?=
 =?utf-8?B?ZktxTCs2Y2FoL3J5UjErUWNSLzJIL1BVaEJvQ29JckhwcGYwSWY2clJiRUZv?=
 =?utf-8?B?SXBKRFNKN3hEdDArZmtZNEFFaU1QSnh4ZGFncXNQUlZIVmhBVG1zQVJXOEVG?=
 =?utf-8?B?T0IrQ01naERnT1NwWDVWemQyKzdLbDBodFBvWi9yVm00RXZVajIvYndHUGtj?=
 =?utf-8?B?L2t0clQ5Y3JFVDR6bHIyYW13a2VoZXA2WHp2TndWOVllY0FlNllwSFBydWhQ?=
 =?utf-8?B?NUQyT3hpRDc2bWw4Mm8xS3BBS3g1NGtiSldZZEV6alUzN20yRXVEM2t1bnNL?=
 =?utf-8?B?VkltRUR0amFGSHRtTnlXUU10NkR5VEZ1clgzTnlEOHFNNkluZ2doNElWTk13?=
 =?utf-8?B?T08zb09GVE1QSUF3dk93dHllVUNlR0hRUmdJWmV1bVQvendhUnYxZ09SSE9Y?=
 =?utf-8?B?KzB6WC93RFNVN0NqVlBkZDlySWtabEU0bzZLT05YODhvZ09iNkJzcmEzN0I3?=
 =?utf-8?B?RytZa2xGTEZNSmUxakVweXRxQzFEcEdpbk1wZXJxY25TU3dPbVIvU09zcW1I?=
 =?utf-8?B?R2pVV0ZJbm04aElwRS96UU0xZ1B4S0xQR3M2bGV6R29udDNsN1VieklyWjk0?=
 =?utf-8?B?T2hUQUZ4NVhPeVdxZDJ4NHJGbG5DYmhDNjJSVURSREhkZ0Z6Q3NSVFNzUXJu?=
 =?utf-8?B?QU1xRGYrbmp2U2ZaVVFmMHJJMzRLRnlTekZxNEpRbTlvbXZlUGNzTFpQV1RF?=
 =?utf-8?B?MGFpSUI4RllOVjRRWnJKUkRCK01VbmprVVYwZ3N0TENtcnlDWHU3U28xRUZ5?=
 =?utf-8?B?WHgycEVHaDk2K2haRFQvclBnWEJWZzdFckVqUWJjMmRnWEROaXNqZVBJTFBq?=
 =?utf-8?Q?pCe2bpf0rF3eUbMx1c9OI1/XX?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 795adb95-805a-4e06-ec1b-08dca56f2b16
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 08:13:27.0186
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: aUtUZPbyFs/hwSvZY7ksKRTSIxgy5OALUw93+1PQCgrUJfFW9N7jhkHC2W6uYuBy6e6S+b001VbFTjfWT8xe7g==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB6964
Status: O
Content-Length: 2834
Lines: 78


On 7/16/24 08:14, Li, Ming4 wrote:
> On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> Current code is expecting Type3 or CXL_DECODER_HOSTONLYMEM devices only.
>> Suport for Type2 implies region type needs to be based on the endpoint
>> type instead.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> ---
>>   drivers/cxl/core/region.c | 14 +++++++++-----
>>   1 file changed, 9 insertions(+), 5 deletions(-)
>>
>> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
>> index ca464bfef77b..5cc71b8868bc 100644
>> --- a/drivers/cxl/core/region.c
>> +++ b/drivers/cxl/core/region.c
>> @@ -2645,7 +2645,8 @@ static ssize_t create_ram_region_show(struct device *dev,
>>   }
>>   
>>   static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
>> -					  enum cxl_decoder_mode mode, int id)
>> +					  enum cxl_decoder_mode mode, int id,
>> +					  enum cxl_decoder_type target_type)
>>   {
>>   	int rc;
>>   
>> @@ -2667,7 +2668,7 @@ static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
>>   		return ERR_PTR(-EBUSY);
>>   	}
>>   
>> -	return devm_cxl_add_region(cxlrd, id, mode, CXL_DECODER_HOSTONLYMEM);
>> +	return devm_cxl_add_region(cxlrd, id, mode, target_type);
>>   }
>>   
>>   static ssize_t create_pmem_region_store(struct device *dev,
>> @@ -2682,7 +2683,8 @@ static ssize_t create_pmem_region_store(struct device *dev,
>>   	if (rc != 1)
>>   		return -EINVAL;
>>   
>> -	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id);
>> +	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id,
>> +			       CXL_DECODER_HOSTONLYMEM);
>>   	if (IS_ERR(cxlr))
>>   		return PTR_ERR(cxlr);
>>   
>> @@ -2702,7 +2704,8 @@ static ssize_t create_ram_region_store(struct device *dev,
>>   	if (rc != 1)
>>   		return -EINVAL;
>>   
>> -	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id);
>> +	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id,
>> +			       CXL_DECODER_HOSTONLYMEM);
>>   	if (IS_ERR(cxlr))
>>   		return PTR_ERR(cxlr);
>>   
>> @@ -3364,7 +3367,8 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>>   
>>   	do {
>>   		cxlr = __create_region(cxlrd, cxled->mode,
>> -				       atomic_read(&cxlrd->region_id));
>> +				       atomic_read(&cxlrd->region_id),
>> +				       cxled->cxld.target_type);
>>   	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
>>   
>>   	if (IS_ERR(cxlr)) {
> I think that one more check between the type of root decoder and endpoint decoder is necessary in this case. Currently, root decoder type is hard coded to CXL_DECODER_HOSTONLYMEM, but it should be CXL_DECODER_DEVMEM or CXL_DECODER_HOSTONLYMEM based on cfmws->restrictions.
>

I think you are completely right.

I will work on this looking also for other implications.

Thanks


>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2046.outbound.protection.outlook.com [40.107.220.46])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 28E6A2D05E;
	Tue, 16 Jul 2024 08:10:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.46
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721117431; cv=fail; b=PqgUZReizs50ml8APYoqvONwd4PKjXW2yjOgSOQT8hdfM+zeb/8+1eXGW5gCku2Y10120I4ozttraz1XQ9zk+IT+VPcOZyFpJmFyYS5blTobMjdJ8/wKz8SyDK+Zs7JU0KKu8GuebhzNjnOwY/uwVJNNPrmMQAvzkUEr8h6Oalk=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721117431; c=relaxed/simple;
	bh=uYcT2X6w5mgOwINRPIVWMWNjVywqTziuZUN+J9sfrEo=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=Zy+8BrFKMcBEBgdRrpJfKZ3neoI0LpDpQHbnVcD0zU9Jm6+VBWrUHyT7Rk2/O55BKTEroPyIeVBy2R04ceez1DYhLgjjzMcR2XsTk6Ut+ojNxFkZdLbzskaOA3KEaCiSkgPBdKIKq7MzwncKyEtvYG7EmgJSAX7qCn9GpFE5yB0=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=A8hkiaX/; arc=fail smtp.client-ip=40.107.220.46
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="A8hkiaX/"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=nAYdnvLBBG4YgzQQM4lypp1AHe4CxvVEHhTvIlN1ZC/gM9o0UNA3lNX0L969A+6Z8vVl3N0lx83h+FP0TGGAqGyMupkH4TCS00yv0TDU6aGd4oHwKV/7rWxmXXWsMbCQq9j4g7+sKLbah2BWsAnAtXvBUSnVxA4Jh15Scz6nDog90LIv6aiDucS3z93jHNcXtGnfW7fJRd7INyylhW+cyiryKHrEcVhRFjmoyPGgrB7tfh+mZtgoCijYMy4fe0C/pSfHa3wXBvUV8DO5ebERnr2bdcqfzrPo56vZMsNqxE21YpbeROah49uHSFFo/1ZF4ieFNrjdrQ0slX7ezQglKA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=7IkvKQ3h+BRao8/pFW36dFPLSenVVWv4/PXRwC3xf/A=;
 b=F0VsqSt5XuiURU3deZ3WYwqMbylboqPjOvmLn/Dr4PrjmbJ+TkVgB+bkMPnMqTUjLve2skdyC1Sr86LFfryJIe6Q2MRegsVdramwNkaFEO/MP8X3C5DthajBqYPm3ej0Ms57L8LD/Dl7k35nuvbyBEewuOq4mufDoFMLWHAZ+gg+M4gwBpiidIhWSGopYFyN8BMCi9DcvinEdbxw4I/D8cnja0z+jqSr/XsJgBT2KSu73DdHul5zqgN+ImmqV6M95RKLB2Gc6givIZYNdcHy/vJ8Q5hFaZcCcURX4l/n6c9N4TJLG7akdgPSwN/hdK/DsfU9OoE5Byai5obPbqykdw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=7IkvKQ3h+BRao8/pFW36dFPLSenVVWv4/PXRwC3xf/A=;
 b=A8hkiaX/AWxh9SQ+J8VqirdfF3mZ9mpESLDAaT6YumIdNPtTVUAr+nWeieLhuvxz21KUKC2KKEO6rZlas62LwyQXUKZlCGtRmgGxvbLOjwO6lnmPZHrXkf/y4Uj7JUny9OKIpjbQe53UlqTNblwWig7Ubi9EcnZ6n6DiCtEQlPY=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by DM6PR12MB4417.namprd12.prod.outlook.com (2603:10b6:5:2a4::12) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7784.14; Tue, 16 Jul
 2024 08:10:26 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7784.013; Tue, 16 Jul 2024
 08:10:26 +0000
Message-ID: <f618e6df-d296-23e4-8fd1-94256afd4612@amd.com>
Date: Tue, 16 Jul 2024 09:10:18 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [PATCH v2 08/15] cxl: indicate probe deferral
Content-Language: en-US
To: "Li, Ming4" <ming4.li@intel.com>, alejandro.lucero-palau@amd.com,
 linux-cxl@vger.kernel.org, netdev@vger.kernel.org, dan.j.williams@intel.com,
 martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
 kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
 richard.hughes@amd.com
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-9-alejandro.lucero-palau@amd.com>
 <b2a99894-9c20-49e2-8c76-6e53aa390d9f@intel.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <b2a99894-9c20-49e2-8c76-6e53aa390d9f@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P265CA0196.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:318::6) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|DM6PR12MB4417:EE_
X-MS-Office365-Filtering-Correlation-Id: dfccb142-6cbd-4a1e-0422-08dca56ebfb3
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|1800799024|366016|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?Wnh3ZGNMRHRzSkhRUXhwY1FXVitCMTI3cmNHTWkrNDdNbVJZWkJpaHBmbnlz?=
 =?utf-8?B?QkgxemhpWUVxcnkzRUZ0Q3lBcDdYUEx0SzV0Y1dOZ1NscGl5UE5hbndvMUR3?=
 =?utf-8?B?d0RJdjNrb2xKL2doYjNHTC9SNEZBdG1XMVl5enR2UER6a1EvdHVZY1NSOUpQ?=
 =?utf-8?B?UVBCVVlZYTlReXVVREEvaWxQcXJQaTF5NVdQRTh6T0lwM01hYi9yRzFnazNT?=
 =?utf-8?B?andWdjJWOW0vd1FEbTd4L1ArZ1dweC9KQW5OcnltWHBVRzZRaWcwaVVhUFR4?=
 =?utf-8?B?aE1Zcmwxd1h6Y2lWUkgrNXpONnMvMzRjU281QlBCOEFzZmJQUjk4N2t2N1lY?=
 =?utf-8?B?d1dYUHcyWSt5Zk5VUlUxbEdsYnVMZkhXcjBEbnZNR2ZuZm1QWFBPd3dKNFBI?=
 =?utf-8?B?QThlcm1xUXN3TWVFWlNCa2RiV2tlL05DejFUT1hPRHczWkNNajhLcG9rNGYy?=
 =?utf-8?B?ekl3bUxSN0NOWXFYdWI3SENEby9XR0dBY0pxWndQQUQzbWtLSmpRMUh4L0gx?=
 =?utf-8?B?dHB0NHRyR2kyZ0FUT1VpdERGaXJ4ZGQ5SkN2MSs3cWwwK2U4Zi9SZFZObmo4?=
 =?utf-8?B?SENPemZnQ1hGbjArM0s0WUlLanN6aklOTWhrc2hNd2gzR1o3RHhHZ2t3MitU?=
 =?utf-8?B?Wmcwa1Q5Zzd6bzZDa2QzeEEwSWo3Zyt2R0grRjdVQ3BqWVgzWG9nbmFFcFg5?=
 =?utf-8?B?MnoxLzZmSSttYUxWeTRmVmFpcEQzQW1QWm5IOS8xVXl6czdKQ3FINmdMU3NP?=
 =?utf-8?B?dm1VL0hSUERZd3pYS3JsRUVWOXBDWmlua2k3NXQvV1daQWFaYkJjWmlMTkZl?=
 =?utf-8?B?S2N6eGZDd3ZkVUpjdjZsckVmdjFYS0cyOUkwYVhZdnMrb2tBeE9JLzZXOUZs?=
 =?utf-8?B?NklFSDF4ODcwZ1JuZDFXaTUwNnZzdnF0b3Urc3p1QXdiT3krbXJGNnJERElK?=
 =?utf-8?B?UG1lV3dCSFV2WTB0amdOZHd6R2NaWlhCMUZ2Q3krSGZkTTZxdi9CNk9xNnZw?=
 =?utf-8?B?QVBJRVJ1R1R1dzNVMkZtZHp5NGFyZ1M2VUYxaE9SWmNjZjI2dEtQNTJNKzZB?=
 =?utf-8?B?emJVSXBCaXVVaW5GZEZUUitvZzVqU3AxNHo5SXZDM1k3WHZNWlJ3U21xWEw1?=
 =?utf-8?B?WGRUdGZtQ2NkV0NHVEpSUUFyQnh5QUhiNzR5VGVDK05UMGJhY25YRzFsSE5l?=
 =?utf-8?B?VVdqbXJXUVBwbDZBL0pmWWhjekN6c0pRMkJzK1NweXNVTmd4cVVNUkFJb1c2?=
 =?utf-8?B?dWZBQTF3SVdYeGN6dE5aT2M5cXQ1MGk4MlV0U2tYSnJFc0VrMjJwVVNuUXpS?=
 =?utf-8?B?UmpEUk05T1hESnQ3VmwyNlQ1M2tza2hwWjEyRUR4TU9ZUGkvWFNqclR1cVdE?=
 =?utf-8?B?QnJRVHMwUGNFNHI5REw3aEovYTBqOU11MFp0UTlzSkIvUkF6YnJZL1N2NmM3?=
 =?utf-8?B?elk4WFltNHlCa0VlSmo3RE1kejBYRGQvMm1vd2VYWmFzOTZ0M2JQYVJuMHZ2?=
 =?utf-8?B?VVcwZVYydy9wblNrbnhGN3J4THFQMHNwUmVaemF6VkhzeGNoaGdoRmM3dzU2?=
 =?utf-8?B?ckhCY2N5V2J5bHN5MWoxaGI2blJYYURuMWRlM0tLdXNHU0lCVkUwL1hQYTY3?=
 =?utf-8?B?WFZreURHdEJhZHF4SFNYc3FRc2N5dSs2UUJmK29jMldLZXA2UzlVT3dEUk1y?=
 =?utf-8?B?MmxKZW4yKzkvRUI5aDd0UHhCZzZlY1RBelZUbmdIMkFtTkxOak53TG5JdHhj?=
 =?utf-8?B?MmJDVnhCUHhaZ0hTOVFkSS9ZTEJtWU5XODliNDBlbFRrNUpZQkVWRkVMcFhq?=
 =?utf-8?B?R2I3YzlDMzBrREJJUmlXdz09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(1800799024)(366016)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?cGNXMThTZGxVRklzS0MrbGZJbDIyWC9FVVlVWTF0UGgzS1g2K2x3WjNMaTA3?=
 =?utf-8?B?K3NjTUUvbnNZSUo2bExrVUgzaTBqcnBUQzA3ejc4VmZxaWZ3ZkdaeWc4L2lK?=
 =?utf-8?B?NFRxMk04M0ZzTzlXMmdyaE16RFlzMEpoOFVrWUlEOStVMExMMUQ3TXdlNlhD?=
 =?utf-8?B?c3ZrOEhOWmZQcThaWGxaRTZpSHVVTXRYU1ZZY09JRTNwSm8wRnZCaDhiLzBR?=
 =?utf-8?B?SGxGcDREaEdYWHk2STNNOFBqTUNmSlRVZXhPcXBDUUQ2L3FPYk9pWUcyNElM?=
 =?utf-8?B?aW1xMWxvMmNMTHo5VXdqUkJhTHRnYTMvd0RzY2Y4VzJNT2dadkxER0hQOHZU?=
 =?utf-8?B?WGtnMi91RzV3NUlEUVA1WGRWQWlMUTZrSjU3Ymk3TlBYWmxNQVpCUjhjY3dQ?=
 =?utf-8?B?a2c3Zjg2Z3Y2RktmK3IzeXFYQVRLRXd2eXFmSlhMQUhpQ09WcG9GMUlTRDhW?=
 =?utf-8?B?TTlpZnZoWlRINFdSSUtRQ0ROSCsrZ1o3WmlTdjBIN01yclFqUWJOMVpSekR5?=
 =?utf-8?B?RFBDRGhBM294cXBaUUxOUW9VRUpuQXY2STRuVDFOVUhPcVZHbHhaZFdLb2Nh?=
 =?utf-8?B?WHRManV1d29OUmU1WmRJZ2FyU2t4MEFqYXFURGk5VXgyMnFLd3ZJMHQ0RWRq?=
 =?utf-8?B?d2xVTVlPRWZNWWM5RGh5MVdaMXErWE16ZERRaDd3TlR5VVdRTnVZM1c3MkdV?=
 =?utf-8?B?L1N2cGpxVkJjWG4rcURORDdHVmxTK0RqQVlrSCtyRjUyTzNSaVUrc3ViOXYv?=
 =?utf-8?B?Y0V5ZFBrMjZYV21mSHFjM21QKzZBMWVnU29LL2tlQTZJUm0vd1YybjlHdElo?=
 =?utf-8?B?RytvRjk2azA4THpBVUlmRVFQSnZxclB0bmFuUGZ5aER2enc4VmMzSFFRL21P?=
 =?utf-8?B?UC9pdldVdjM3R3NsNTV4NmxMR1g1TGpIMCtvOGpkbVZmMlp4VTFKK1F1N2lC?=
 =?utf-8?B?TkRxOS9JSVJaOUlaam9ZUWtETEJJUHE1UHdwT2JGamhLbVVOWWRnU1VaRWp4?=
 =?utf-8?B?a24rd1BMd1M4K2lGNEFVRk1yQ3g1bW5xdzBKVHkvTUdiekdycWM4NVk2K1JB?=
 =?utf-8?B?Q3BOZkpXOTRxb0NkcGU0eDVIejVDRk5FcFpGeXBheHI4TEZNdnFDWS9mWDUx?=
 =?utf-8?B?T0FRRFhpS2NjU2Y0YWxJY1FuMU1vK0orT015Qmxldm9LdyszaWtWeTlaU3Zi?=
 =?utf-8?B?bXZhVWFPUlNDTXVveUhjTUIySEs4RGZmWXRENXdiMGV6R2VabWE5M3JOb09y?=
 =?utf-8?B?WlBHQk1iZ01KdFdhUjZxMzNyM3ozcmdtMzVwRElsdmVUM2ZCcmp3Mzh3YUsz?=
 =?utf-8?B?eTF4UXFTQTljYVBJdkZjcnB3UDhUUFdQMnN6dEtOTVR0aUZUR0cvTUFSRkxG?=
 =?utf-8?B?Yy94a1ZLOUUrQU1BV21XdjRTTFlEQTJycGhGcXhqb3JYdDE0UzdDV1I4cE1Y?=
 =?utf-8?B?aXMwTUxpeU5NczlyMU1pbHVMRTU0WW0za3JYRlNxM1pYOVRlTVFmY29jQ3E4?=
 =?utf-8?B?R0Y3ZTlMUEdleGNGKytQa1R0NmdNb0NxVHVvSmNuTnRDdHlrK3JmYVBZSnQ4?=
 =?utf-8?B?NEZPSDV5R3prT3NkNEg0SS9SNW1mMER5Uno0K2w5a1d1alkrcXlBYUQvY04v?=
 =?utf-8?B?R0lNaUJzbjUxdEVBUVBlWGdUcVpBTGcrcjdOMzdyMzJQZ280aHdhVnpIbWJt?=
 =?utf-8?B?QkV2d2I3UnJ1ZGRwcUNZekhBODN2QzRkS3h4NU1WZ3pFN00zR1UzNGtTOUZN?=
 =?utf-8?B?VzdEYUYrWnhvdGE4anhpOU9EK3QvOW1mV1pmMm1RdjZsR3h2YW12YnFCYkV5?=
 =?utf-8?B?MFE5blIvTE5HSmMvRmhKTlh4T1V3bWtRcFRodnlDZ2JzSU1lS3Z2NURLUjgy?=
 =?utf-8?B?Q1RhaStkMjRnR1EvNVBIOG5VbXNoRzlUWlJ1SW9mSXJjd3l4cjU1WWEydENP?=
 =?utf-8?B?MmhNQjNOUWNKVlQya1N3Znc3b3ArdXpOdmJlNVQ4d2oyWDhHVzY2TmVtT3pl?=
 =?utf-8?B?ZzZHM2hIdFVoL1hJeThmODAyTmtsZFp1cXJ0OTQ5bGFncDZXRlRJc0NKb3FO?=
 =?utf-8?B?a3R5cWZvSGNsdUV5aTZMUXh1YkJGN2Nvak9RRnFVT0ZJM0RzQ3hMMTRWYjAr?=
 =?utf-8?Q?eBaMC8wE7Y0r+3SfsxlBTd6zU?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: dfccb142-6cbd-4a1e-0422-08dca56ebfb3
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 08:10:26.3309
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: gMhNNpz61T/M+tQuJxuulMAck5jb/u8kjHEAffzzG7gfTqkkI3diAQdvN9l13Hr2oL13WBcANErkUcVAnTh/yg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4417
Status: RO
Content-Length: 5972
Lines: 171


On 7/16/24 06:52, Li, Ming4 wrote:
> On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> The first stop for a CXL accelerator driver that wants to establish new
>> CXL.mem regions is to register a 'struct cxl_memdev. That kicks off
>> cxl_mem_probe() to enumerate all 'struct cxl_port' instances in the
>> topology up to the root.
>>
>> If the root driver has not attached yet the expectation is that the
>> driver waits until that link is established. The common cxl_pci_driver
>> has reason to keep the 'struct cxl_memdev' device attached to the bus
>> until the root driver attaches. An accelerator may want to instead defer
>> probing until CXL resources can be acquired.
>>
>> Use the @endpoint attribute of a 'struct cxl_memdev' to convey when
>> accelerator driver probing should be defferred vs failed. Provide that
>> indication via a new cxl_acquire_endpoint() API that can retrieve the
>> probe status of the memdev.
>>
>> The first consumer of this API is a test driver that excercises the CXL
>> Type-2 flow.
>>
>> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m18497367d2ae38f88e94c06369eaa83fa23e92b2
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
>> ---
>>   drivers/cxl/core/memdev.c          | 41 ++++++++++++++++++++++++++++++
>>   drivers/cxl/core/port.c            |  2 +-
>>   drivers/cxl/mem.c                  |  7 +++--
>>   drivers/net/ethernet/sfc/efx_cxl.c | 10 +++++++-
>>   include/linux/cxl_accel_mem.h      |  3 +++
>>   5 files changed, 59 insertions(+), 4 deletions(-)
>>
>> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
>> index b902948b121f..d51c8bfb32e3 100644
>> --- a/drivers/cxl/core/memdev.c
>> +++ b/drivers/cxl/core/memdev.c
>> @@ -1137,6 +1137,47 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>>   }
>>   EXPORT_SYMBOL_NS_GPL(devm_cxl_add_memdev, CXL);
>>   
>> +/*
>> + * Try to get a locked reference on a memdev's CXL port topology
>> + * connection. Be careful to observe when cxl_mem_probe() has deposited
>> + * a probe deferral awaiting the arrival of the CXL root driver
>> +*/
>> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd)
>> +{
>> +	struct cxl_port *endpoint;
>> +	int rc = -ENXIO;
>> +
>> +	device_lock(&cxlmd->dev);
>> +	endpoint = cxlmd->endpoint;
>> +	if (!endpoint)
>> +		goto err;
>> +
>> +	if (IS_ERR(endpoint)) {
>> +		rc = PTR_ERR(endpoint);
>> +		goto err;
>> +	}
>> +
>> +	device_lock(&endpoint->dev);
>> +	if (!endpoint->dev.driver)
>> +		goto err_endpoint;
>> +
>> +	return endpoint;
>> +
>> +err_endpoint:
>> +	device_unlock(&endpoint->dev);
>> +err:
>> +	device_unlock(&cxlmd->dev);
>> +	return ERR_PTR(rc);
>> +}
>> +EXPORT_SYMBOL_NS(cxl_acquire_endpoint, CXL);
>> +
>> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
>> +{
>> +	device_unlock(&endpoint->dev);
>> +	device_unlock(&cxlmd->dev);
>> +}
>> +EXPORT_SYMBOL_NS(cxl_release_endpoint, CXL);
>> +
>>   static void sanitize_teardown_notifier(void *data)
>>   {
>>   	struct cxl_memdev_state *mds = data;
>> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
>> index d66c6349ed2d..3c6b896c5f65 100644
>> --- a/drivers/cxl/core/port.c
>> +++ b/drivers/cxl/core/port.c
>> @@ -1553,7 +1553,7 @@ static int add_port_attach_ep(struct cxl_memdev *cxlmd,
>>   		 */
>>   		dev_dbg(&cxlmd->dev, "%s is a root dport\n",
>>   			dev_name(dport_dev));
>> -		return -ENXIO;
>> +		return -EPROBE_DEFER;
>>   	}
>>   
>>   	parent_port = find_cxl_port(dparent, &parent_dport);
>> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
>> index f76af75a87b7..383a6f4829d3 100644
>> --- a/drivers/cxl/mem.c
>> +++ b/drivers/cxl/mem.c
>> @@ -145,13 +145,16 @@ static int cxl_mem_probe(struct device *dev)
>>   		return rc;
>>   
>>   	rc = devm_cxl_enumerate_ports(cxlmd);
>> -	if (rc)
>> +	if (rc) {
>> +		cxlmd->endpoint = ERR_PTR(rc);
>>   		return rc;
>> +	}
>>   
>>   	parent_port = cxl_mem_find_port(cxlmd, &dport);
>>   	if (!parent_port) {
>>   		dev_err(dev, "CXL port topology not found\n");
>> -		return -ENXIO;
>> +		cxlmd->endpoint = ERR_PTR(-EPROBE_DEFER);
>> +		return -EPROBE_DEFER;
>>   	}
>>   
>>   	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
>> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
>> index 0abe66490ef5..2cf4837ddfc1 100644
>> --- a/drivers/net/ethernet/sfc/efx_cxl.c
>> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
>> @@ -65,8 +65,16 @@ void efx_cxl_init(struct efx_nic *efx)
>>   	}
>>   
>>   	cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
>> -	if (IS_ERR(cxl->cxlmd))
>> +	if (IS_ERR(cxl->cxlmd)) {
>>   		pci_info(pci_dev, "CXL accel memdev creation failed");
>> +		return;
>> +	}
>> +
>> +	cxl->endpoint = cxl_acquire_endpoint(cxl->cxlmd);
>> +	if (IS_ERR(cxl->endpoint))
>> +		pci_info(pci_dev, "CXL accel acquire endpoint failed");
>> +
>> +	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
> there is no need to invoke cxl_release_endpoint() if cxl_acquire_endpoint() failed. right?
>
>

Right. BTW,  I do that in a following patch.

I should just add the functions to the CXL core here, and to use them in 
a subsequent patch where it makes sense.

Thanks


>>   }
>>   
>>   
>> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
>> index 442ed9862292..701910021df8 100644
>> --- a/include/linux/cxl_accel_mem.h
>> +++ b/include/linux/cxl_accel_mem.h
>> @@ -29,4 +29,7 @@ int cxl_await_media_ready(struct cxl_dev_state *cxlds);
>>   
>>   struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>>   				       struct cxl_dev_state *cxlds);
>> +
>> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
>> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
>>   #endif
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.14])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3C0044C74;
	Tue, 16 Jul 2024 07:16:09 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=198.175.65.14
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721114171; cv=fail; b=qRDYhBvxi7YoHc6oMynb1t6rSr9NYJxi5mvRa0KTG/O7M01qBPbWWdU3wZh7+dSZxGWrZXO9WcuzITJ2sZ40xJWyT0IvoSmRQEZfjvyb0cBZ5bgCvhwEMl3LDq7+dgeu6icYC11J5mgIQCe19EefJ3Ri7gb+hmzPOsMFUjNgKfU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721114171; c=relaxed/simple;
	bh=Fo2iVo2q7iKMWWWDdFAXM20T/Rclo0LHxZKJ3FaDnqw=;
	h=Message-ID:Date:Subject:To:CC:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=QCJW05oqg3gVvdesyqLhsgfpv3EaPy3IzOjHziTuORq+cpsGhSlPHVhwN3CZj1Ss22UCnmsW/qEnI8mlkLv5hQ8XDqnvAoRF4UHDMOJjW5g8R3BlZTs5U67+2cWXF2SzJeb3qF6Z0SK6ItfGpEvu4jcSqBXcpoLQwNMTq14lKSo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=bXdhLx7a; arc=fail smtp.client-ip=198.175.65.14
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="bXdhLx7a"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721114169; x=1752650169;
  h=message-id:date:subject:to:cc:references:from:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=Fo2iVo2q7iKMWWWDdFAXM20T/Rclo0LHxZKJ3FaDnqw=;
  b=bXdhLx7aOUzszGGBTaQ2hSlDQ/ab4FMcTpQGYhtRRFOpHDt0/E+MCKz7
   KEanOLdPgcj0Svc4dcvxj+IaJ8Ux22k/KtyK/IpPhkLgfewL8J22GUPg0
   VLr0Tx/Sa88hGLxa/hcw3wmcDs5ivReaOQRky4Brm6RMVTWbDpBlgRII1
   6iJT5yTQHJpfpsiHWt3cr2aPomvipI24RSihbLAyqRYiscMJjbUWNo11V
   RRloGvQeZkoiG85ggaipFI+wFjyfLZDZLDAp0IKtrC2JCxiuApX+FLUWo
   0wYcKQJySaOLBvvOf70vmBc/Wx/UZKgUvqIfkXqSiE5GEWFtOn/h0F7oQ
   w==;
X-CSE-ConnectionGUID: TmHbJDnsT0i2+qxJG+ln0g==
X-CSE-MsgGUID: 0BDpUCxFR5WYfwnMRfUjwQ==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="22342771"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="22342771"
Received: from fmviesa007.fm.intel.com ([10.60.135.147])
  by orvoesa106.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 16 Jul 2024 00:16:08 -0700
X-CSE-ConnectionGUID: z6FZMx1xTGu6wGlEWF06SA==
X-CSE-MsgGUID: xBNKTlrISUuB0Fep3oqDBQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="49752651"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmviesa007.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 16 Jul 2024 00:16:08 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Tue, 16 Jul 2024 00:16:07 -0700
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Tue, 16 Jul 2024 00:16:07 -0700
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (104.47.57.168)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Tue, 16 Jul 2024 00:16:07 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=dF3iV9rtIh1ZrJfCRcY7mMBvZNYsVzxkTUHvcqsldgIsiHfyUUV4QoA7ydJ8e+I367IG3agpeTXvPj5Qpn0usLpvNpJWJJ5nUSfsDH6MCFFZTE20+ULWErAo9iVPHhaI3c7IKZnHx4JEvArf0S3U6jyEqbwL9BBUtITSDuZOD+L05k8mNYhyXzgNeEF6AnleKaKeSBGKrk8NAIU1HZMQ01yQc/2Ut5EhfIA4jNKhg4bil40k1ZTN+oQpwjFNX6KpjM4Yf+TDyIA84hoajFqzujft52jBjq1m2+GIoAuOX1Ptgsqxv45RdRMnzmR5WpkMNpykuR+Vopcia5mNh15NOw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=cNQ27ziyQoIeVDV0AzGbQkXB03wdwqWCza0pV78+xZg=;
 b=dY+rSX74cBVJt7wo8AOF4Lu9CcbgrM6p9DrSzctGblG7R+RolIRT/8s/EkRcjizWN3Y9i4duXUl7orlA/nzneLiO4jV2WCo0Et3mFPkDZbDpm0pcELrU/8WdThisvUFEeyCqHiDyZNBOxxghpqDVPdQXUwJm3GYjYV3jDrzrzW4Jb8nYVVQrkOqMORYheJ6cNFO9TIR6E5nsWy8GBP+aJazv+fXXBcqwq8ITLqJGjO3oAdfvL+oVqQzY/9P+dpu4GMu4YM/9ut/vxVU/w9VAW01LpGPnQaiDapAYVB2OERh61+/XLUOC3TM3ufuVtsaKbjjdX8MqqwnWKlPNr7B4ug==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
 by DM4PR11MB6432.namprd11.prod.outlook.com (2603:10b6:8:ba::8) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.7762.20; Tue, 16 Jul 2024 07:16:05 +0000
Received: from IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0]) by IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0%5]) with mapi id 15.20.7762.027; Tue, 16 Jul 2024
 07:16:05 +0000
Message-ID: <1f082012-1ad6-4b12-8eb4-96bcc61704a0@intel.com>
Date: Tue, 16 Jul 2024 15:14:41 +0800
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 11/15] cxl: make region type based on endpoint type
To: <alejandro.lucero-palau@amd.com>, <linux-cxl@vger.kernel.org>,
	<netdev@vger.kernel.org>, <dan.j.williams@intel.com>,
	<martin.habets@xilinx.com>, <edward.cree@amd.com>, <davem@davemloft.net>,
	<kuba@kernel.org>, <pabeni@redhat.com>, <edumazet@google.com>,
	<richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-12-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: "Li, Ming4" <ming4.li@intel.com>
In-Reply-To: <20240715172835.24757-12-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SG2PR01CA0198.apcprd01.prod.exchangelabs.com
 (2603:1096:4:189::7) To IA1PR11MB7200.namprd11.prod.outlook.com
 (2603:10b6:208:42f::11)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: IA1PR11MB7200:EE_|DM4PR11MB6432:EE_
X-MS-Office365-Filtering-Correlation-Id: 5b2bb5f6-93d0-4dad-403a-08dca567281e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|1800799024|376014|366016|921020;
X-Microsoft-Antispam-Message-Info: =?utf-8?B?eVRaRGdTWXBkQ1lSb3VuLzFacUZVMjA5YVg1cGVlbjduWWRxc1lBKzNaMFBE?=
 =?utf-8?B?YzNpcktnQWcyK1RkNmY4cVA3eXRUUVYzZjh3TUtaeHQ5MHpTc1V3MGFuSFF1?=
 =?utf-8?B?R3k1dHpkUmNmVE9nZnExR1hlQndzWE1tdTRnR0orRVlERzh4WTJPb2ZFbFA4?=
 =?utf-8?B?alduK0FGRzU1RVNWWDZncC9PeWUySUxGdTNvU05tNitua1FOdjd0bTJ2Znh2?=
 =?utf-8?B?VnpzQXFKWG53L2xra1E5Y3Z0MXdJbUNqMTBDbWZ5enpyaWV5YmlXT0tUSjd4?=
 =?utf-8?B?dzlyM3IwdzIvelcxV0dNKzU5aDg2cmZYT0w2d1V0OG55OGZRN3Y5c21IOUow?=
 =?utf-8?B?MlAxMm83SG9RUG1kaWRmK25manlYZDJOb25iNzR6QTFlOHc4anpWakZIV25R?=
 =?utf-8?B?dkREdnluTmIzeXMyNTRFVGRJL2FqeGpLU3BjUGYzY3ZyVnFCU2RGcWdVR1JJ?=
 =?utf-8?B?VStvbjRaN1N4NlRCQWxhSlpNUGhybXVjY2JId2lRUFpUY2czYUlvdXJuTEdI?=
 =?utf-8?B?SEY5bXZsQVJoOUorOW81VkFScTYwNEhOQXFXc3h4Z2dWWno0RXhWdG03aS9p?=
 =?utf-8?B?T0U1ZG5HY3hsaVRVbEdIcDh3V1dDakc3V1RwVU5XRWYweTBlbGxzYTJiTldj?=
 =?utf-8?B?Rlc3c1FJazZlSjF6NnBYY3FVSHJHdTA3TmtZTHdlU2ZRL0xNdlBBMkJ6dy9i?=
 =?utf-8?B?Yi9COVk5aGhuMnFscFVjTG9Vd2ZzS3lCcldyWHVhNGVEcmw2dWlsQTNnL3pt?=
 =?utf-8?B?QzZJWVBzVmRiTUtsQ0xPdVFPcHErdDhOOHpQS2pIR2tjK0JsMzBxdUlCK3Qx?=
 =?utf-8?B?WFdaejNwNDh6S2VqMHVIOGFBNXVhU1dCUlhBc2U2Z2trTjdMdEhmMStjaHZO?=
 =?utf-8?B?YTkzcG9pU0NZLzQxdUZoQ3JtUUROQnZuMXNDVEM3TGZRMUdYSHVEUzl2anJ2?=
 =?utf-8?B?UWdWTUh1QzR6YnI2NHdZaXAxS3hsV0FyazJvMUoxWUZ2K2l2MmFBQjdBeGI5?=
 =?utf-8?B?UkhiVThqUlFBNmFoMGZSdVp2QkJwMzFBd0orSHRubDlRbFdGWW1QUCsyRG1x?=
 =?utf-8?B?cy9UTk1sWXhyb1c2YUQ2WnQxd3R1ZkhhSGlER0ZmWjlwdHFBbmNmWGlKOUtL?=
 =?utf-8?B?SGE1Q05aNmJtQjYxMVdMTmNQOHBOcUR5L1BRa2U4UDYwRFlyQWpOdmE4Mmha?=
 =?utf-8?B?amQxK3pjRnBpZU1Lc2NJVXJMb3QrbnVSVXN5MWFSakR1K3dzZ0tjcXlueDVP?=
 =?utf-8?B?bVhkaU5FY0JpNlFXbWk0SnlPTndSZVVoRG9lM3pTcUI1cTdwQlFxRTIwQWRJ?=
 =?utf-8?B?TmxHTDk0MUw3by9uSXZBSHlZcTUrSHQyUUZVMXErVWY4MTVjT1p4Y0Y5aHl2?=
 =?utf-8?B?N2JiWU0yb3JhTWQxRUVLcGI4OVVTRGZKWGNabm50MDBpeU44ZUk4RnFSWHVI?=
 =?utf-8?B?OWdQS1NaVHNtTEM2Y0lmQ3lrczlPMFJ0N2tBejFZcFQ5ZW9qakdWd2llRkxI?=
 =?utf-8?B?LzdyQlYwZ1dEbGYzN21SeEtSZ1h2REJaYy9rK1RiV1I3Qlc4S1dlQnBtWk9p?=
 =?utf-8?B?T0dTcm01OUxScGw2MEpkSEphWmdWdDdGRjBOa3p3Q3l2MTB5ZU44WGRYa2l4?=
 =?utf-8?B?KzhadUlwVkF3bGpWWmo5RXExb1Y4L3V2eHR3VXZJbHRlRG9VYkJ0ampkVTNp?=
 =?utf-8?B?MmIvbTlmY05QaVkvajBySFBqNFFnMmRGS0FJQTlrempzc0RCVEJYWnBoQm5M?=
 =?utf-8?B?SU9MRFBxSitXY2M0aWJMUFFqY3NDaXlmMTF2Mzk5dVFZN1dRZnpvQ0ltM1RM?=
 =?utf-8?B?Y1duZThSdXJMOHlMRzdIcC9vL1JPR2hjUDhpcTN0dzVnQ3RBL2s0WURZbkhs?=
 =?utf-8?Q?tmNyP95BWjwCZ?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:IA1PR11MB7200.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(1800799024)(376014)(366016)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?UUZJamlYZmswOHhjYk9TMmhIeGxzTHkrdHV0YVpsaTZWaDhNVHdRNGc4aVFW?=
 =?utf-8?B?Skc5Z2lHQkJ3THJUWm4ralFLSTBPRmk3NTBjYjF0YmdUdVY4am9HRjNTcThT?=
 =?utf-8?B?VmI0V3BDWXNaK0Yvb01RdzViK1BzcG1hRXN5djNRdUpaRThtN05BV1MwZzh2?=
 =?utf-8?B?QWRFSHRobG9NLzBSeXpIYzRIOXcxcHpZRG1vNTY2emlQeXlQdG1uWHoxNzJT?=
 =?utf-8?B?UW5kTWc3bHdabXZzY3B3eE92NHREeXZMSTJTemVsa3YxRGZQdGt1bkxBVjlw?=
 =?utf-8?B?aGJEU3FDZlZwMVJNcjBwTzlQV2FjTTlSdkZGZTl1UzlvVlF1ZUtSMmtWU2JJ?=
 =?utf-8?B?eEdDTG9vQkNDcUZHNkc3ajk3UXR0aEJsTmZGMjFKQW0wenQxaE1CNWVMVVBE?=
 =?utf-8?B?SFJxTU9lRnBWNlhvd1cxVEc1TitSVklFbk51OWxtbitna1FaU0JrR2NBcVlG?=
 =?utf-8?B?NmJSN2cvS2JMNHBhMUo5K2daTnVBL3BYOEhSWk93cXI0RENDaCtuOTkwSXYw?=
 =?utf-8?B?R2l1S0RyQjdFZnNKVHVDSkJzY3hwYkt6cFk5NCttR2RYNUlZRFVWc3BsZmxB?=
 =?utf-8?B?b1lGejRvNWRRMVJKYVluU1lleW5PZDQ1MVZodHROaUQzQWVPRFpzUmVsdE9k?=
 =?utf-8?B?UWR0QW1Ebzh3Qzh3MVFpYzF4R2NmbXIvSndlQ3B1bXNObFNmdnZWSjRzVStj?=
 =?utf-8?B?aTllVzRrbVJOUkNXMUJrWjh5SVc4RnBBN2R5b0VPRzZEeXFKaGw0bmRBVzZw?=
 =?utf-8?B?dXdqOHBrRElkK2I4aFRFNzdjMnIyb01DL011Z0VHdm1BcjV2MHh4ZFN5QVcz?=
 =?utf-8?B?dTFGcWZQanZya0N1N0FkUVAwMGdhWGVNVU90ZnFmMGx1UTBidFNEQ1UzSjhj?=
 =?utf-8?B?b1dtTmVkZlF3WW9mSHJJL2RubWNtWTIxMUE4U055dThqZDJ6Tk5XV1hDZzFq?=
 =?utf-8?B?MHc2Nnc5RFZhVGUxckM5aHZhVGxjZWNZa2NiR2ZGb01MeVJTNTBweFVUaEp4?=
 =?utf-8?B?RVBUcTJjbDNiR1cyanlCZ0hOZHdvM04zRUpZYXkydGZrK1ZLYVc0L1pObjQ5?=
 =?utf-8?B?cmgvOHBLRm1zbkZZQkFDR2twMnNzcW9XeExSK1R5RWNqd0w3dUsrWkNNSVAv?=
 =?utf-8?B?MlpPQWV2ME55a2t5RGdIKzJJWFlQUWVaaVZHdS9QWnpiMlpkeFRMM3N6Mmpa?=
 =?utf-8?B?QVVyNzAvOW1HeHVtNjhrYVdNTlZkcjBSQVhraGlwVGZBUmpIeDdQQVR0VXJt?=
 =?utf-8?B?Qk00TDBKcU05QmRSS29xZ1hDcGJjZEZUQ2ZPbEZ2VlBDZDdEUjUvOWtoRTVV?=
 =?utf-8?B?Mm1pQXNqVVF2cmEyMFo2M0JoNmJWV21pbmtINFBtb0U4eGVDbEVOQlNHUjlh?=
 =?utf-8?B?MHNJQzcvbzlTUWNUbkpKVlFUdVRHTXgwOVhtSEpwNlBkNDAzeVBUbnBmbEJt?=
 =?utf-8?B?RUd4TmZhTGFJUWd1WEpZdEtvcWpYSUFmMS82Ui94SWwvc293cUtkRWZYRzNY?=
 =?utf-8?B?bEUzMnl1dzFCNlRIL29jY2JwSXNKYjY3RWw2M3pWUWUyczUvZkdJcDIrNDJG?=
 =?utf-8?B?SGs3b1p2R1NOYWdEbU9HUjFVaTJDeGlOMzhmbnd3UEpYOVhwNHo2UWxLZzFx?=
 =?utf-8?B?a2t4cnM1Q2dRWnBaTW5JbUIrU2lQR09oOERkYWFTaUdGZjVQNUZIT28xN1cx?=
 =?utf-8?B?elk1ai92UnRHYWtQWHlHWFAyNTY0WEoxWkpteEo0TzBQNlFzZkN0dkluRE5B?=
 =?utf-8?B?M0hoQ2JaeHgwK0dSb3haUEYxTURGV29YampWSjY4eVBWTitFTjR6NWkrY3dR?=
 =?utf-8?B?K3RpOW9xN1I3d08zbFpZYURJNVlaaWdJS2VobTgxYjV1S1hBZ253VEpzdW40?=
 =?utf-8?B?MFNWUXFscUM0UitvNkhTN1gwZXMyN2E0SVJ1YXNXamdhYkdiUmZyK2ZCSHRC?=
 =?utf-8?B?dmpxWSt0VXU2MXdLRlZBVE9yWDd3bm93MTQ1SnBYalgwYTBEZkE5U2kzR2I1?=
 =?utf-8?B?ZU0rYWdlOHdkZEd6UWxDSXhXQy9yOWtubDRUNnFSbmdBamR5eU9yMDAvTGdQ?=
 =?utf-8?B?TDZ6c2hDODR0YU5qOVNWRXVTeTA2bk5VTGdJTlNvbXkwK2krb2hzT3RSd3FE?=
 =?utf-8?Q?D6CF1+24CyowuE54Ph0NV1aWi?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 5b2bb5f6-93d0-4dad-403a-08dca567281e
X-MS-Exchange-CrossTenant-AuthSource: IA1PR11MB7200.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 07:16:05.6392
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: a2VrUTsEhlSB3KGnZSwOalVR4SKQMVJgyXNRxGf7imRVfvuUUl52rglAlkTdJTIqcEuIWyqZto1KazGxjCGG4A==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR11MB6432
X-OriginatorOrg: intel.com
Status: O
Content-Length: 2595
Lines: 70

On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Current code is expecting Type3 or CXL_DECODER_HOSTONLYMEM devices only.
> Suport for Type2 implies region type needs to be based on the endpoint
> type instead.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/region.c | 14 +++++++++-----
>  1 file changed, 9 insertions(+), 5 deletions(-)
>
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index ca464bfef77b..5cc71b8868bc 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -2645,7 +2645,8 @@ static ssize_t create_ram_region_show(struct device *dev,
>  }
>  
>  static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
> -					  enum cxl_decoder_mode mode, int id)
> +					  enum cxl_decoder_mode mode, int id,
> +					  enum cxl_decoder_type target_type)
>  {
>  	int rc;
>  
> @@ -2667,7 +2668,7 @@ static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
>  		return ERR_PTR(-EBUSY);
>  	}
>  
> -	return devm_cxl_add_region(cxlrd, id, mode, CXL_DECODER_HOSTONLYMEM);
> +	return devm_cxl_add_region(cxlrd, id, mode, target_type);
>  }
>  
>  static ssize_t create_pmem_region_store(struct device *dev,
> @@ -2682,7 +2683,8 @@ static ssize_t create_pmem_region_store(struct device *dev,
>  	if (rc != 1)
>  		return -EINVAL;
>  
> -	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id);
> +	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id,
> +			       CXL_DECODER_HOSTONLYMEM);
>  	if (IS_ERR(cxlr))
>  		return PTR_ERR(cxlr);
>  
> @@ -2702,7 +2704,8 @@ static ssize_t create_ram_region_store(struct device *dev,
>  	if (rc != 1)
>  		return -EINVAL;
>  
> -	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id);
> +	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id,
> +			       CXL_DECODER_HOSTONLYMEM);
>  	if (IS_ERR(cxlr))
>  		return PTR_ERR(cxlr);
>  
> @@ -3364,7 +3367,8 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>  
>  	do {
>  		cxlr = __create_region(cxlrd, cxled->mode,
> -				       atomic_read(&cxlrd->region_id));
> +				       atomic_read(&cxlrd->region_id),
> +				       cxled->cxld.target_type);
>  	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
>  
>  	if (IS_ERR(cxlr)) {

I think that one more check between the type of root decoder and endpoint decoder is necessary in this case. Currently, root decoder type is hard coded to CXL_DECODER_HOSTONLYMEM, but it should be CXL_DECODER_DEVMEM or CXL_DECODER_HOSTONLYMEM based on cfmws->restrictions.




From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.15])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2063E1862C;
	Tue, 16 Jul 2024 06:27:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.15
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721111239; cv=fail; b=gZsvb8z4SWaXt5Mojoc8h4y8HeBFLFU+WXxCzCsZGuPsmJ9n0wK2Y/yNsWYb2LE/hUHaOjOtktGVciHN7mYek3L2pj354SWbLojc+38hhnYsB798gXaVUHvnDr4zJQKft1MJnSIES5Z6xGHUdtfU8aeXkm4/Zt/sMbFXcJ1cpX8=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721111239; c=relaxed/simple;
	bh=10XxLXijEy7CUSO6VN4N+UH/A4UgxqVIlrmZLLw10mg=;
	h=Message-ID:Date:Subject:To:CC:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=Mez+VixpI9cZDCjkwsicW9tpYN2UMifdndQisyNKarpgA77FcTGZe/szK5y4DmdpLaDVKGdkq7V4dVGy8LaqJnYXGp+PUQqGZny+WqKUCVkIFCDnD7+HNfCQQvyHKlTOMrs/LZFcBfNrbNvoQ3DcSNse70pnlAvsPI8ePpI3WYc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=VseL8GFc; arc=fail smtp.client-ip=192.198.163.15
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="VseL8GFc"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721111237; x=1752647237;
  h=message-id:date:subject:to:cc:references:from:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=10XxLXijEy7CUSO6VN4N+UH/A4UgxqVIlrmZLLw10mg=;
  b=VseL8GFc+MNtAKoRfyR22POyOrBvQHYUtJn+zVj+eTptL++vNRIIO5Vh
   KV/4rbztQZff9l5vcIovzMvqi7bRA0HwzCuy/zBZuErPZhBiD/EBfFlv2
   GmqfJkUIMiFt3RNbxmiUzKV6Pj7Mk/WvESjvmwO+UCfpuWHNFOxR0JY2B
   b/1LreT8Coa7faMX9ME7kkR0Qp4Qbx3pjDswnvUhRBpvdyIKlutooaQVh
   zfCLy7FatHbEJKIhTir353o4lo2fOal3tOA7WN2HNQEaaiYqPfT66ERGd
   NKsRkpJMCNT5ah2Ix6UAd2gPrcYoWzJNAadWDF4wVuConOdsuyGCgnWg8
   g==;
X-CSE-ConnectionGUID: 2TPvKe0BRHyD+v34TURB5A==
X-CSE-MsgGUID: DnxwpkqxS0CWbAMSzGUbuw==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="18679226"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="18679226"
Received: from fmviesa009.fm.intel.com ([10.60.135.149])
  by fmvoesa109.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 23:27:14 -0700
X-CSE-ConnectionGUID: RYxLauNlRJCdqufe1+TwWA==
X-CSE-MsgGUID: IjoV55qKTnaR+WRPzKL25g==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="49825151"
Received: from orsmsx602.amr.corp.intel.com ([10.22.229.15])
  by fmviesa009.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 15 Jul 2024 23:27:14 -0700
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX602.amr.corp.intel.com (10.22.229.15) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Mon, 15 Jul 2024 23:27:13 -0700
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Mon, 15 Jul 2024 23:27:12 -0700
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 23:27:12 -0700
Received: from NAM02-DM3-obe.outbound.protection.outlook.com (104.47.56.41) by
 edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Mon, 15 Jul 2024 23:27:12 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=Wl0RULRO2FdEnoAlfB2FL/ctz8hcbewyva7M8f2OxhjpBGyYSLXA5zJwztgJ9W5aBQHRDcRrEKB5ZhJq67Bf9om0Lr/iZrN+vKwQr6O8MdRM88ufL5E0eXEuB8Jn/9KdjIr8SYH9JY/yblt5OgPvD0gGqIN3CBfWvOb1nkCmGznnwQVvJ76dWFJgNEjJUDgfAHWlXsfynjTm82E7UKhAw115wlD2ZYChAj8T3sTBkj8xDF71J+UjDTBC9XqpyYbR8RzrOFCb05zIsYui/fyeWA3Obf3JrKK2246xlqQLwkIqD0N0bQWwTC/H8gXmMPJM87AeGk1k8sVlprqH1NAvhg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xzuWnIuquulskHeuth31UreCSp+OzbPrShJ/L6Ha9/U=;
 b=q7kvAF3SF+2LH2XtqSScrN/N8GDanZLjWU9phfBHEoRaJg+qVQsWyRRQtP7gu6/vXM2R8qGakpZCa9FdKLFB3rn659RAOL8uK1b5e/rAxBAMWWyILacobaWx1j9fF1KDy6jEuxE83igYyLO0wTpNSGcBM4k0L+tDD9BBD6EPcNpnf1bIrBrAa4D4xZoJYDee38yY5vz01ZwucsWR9gXAuIgRIXgeGX1vo3mdvVGieGSTp0oAWU5FyFxuz2kJ9QSR804eDOQ64WStRWpsYTPg4VEiBUWo/0IGPX3qnaEEbEkxxKZKSInl1qS3cUzitg0FCrGxRTtH01cvA1mAUmUl/A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
 by CY8PR11MB7314.namprd11.prod.outlook.com (2603:10b6:930:9d::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Tue, 16 Jul
 2024 06:27:04 +0000
Received: from IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0]) by IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0%5]) with mapi id 15.20.7762.027; Tue, 16 Jul 2024
 06:27:04 +0000
Message-ID: <da346636-a458-4ec3-a065-6ce56a985573@intel.com>
Date: Tue, 16 Jul 2024 14:26:52 +0800
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 02/15] cxl: add function for type2 cxl regs setup
To: <alejandro.lucero-palau@amd.com>, <linux-cxl@vger.kernel.org>,
	<netdev@vger.kernel.org>, <dan.j.williams@intel.com>,
	<martin.habets@xilinx.com>, <edward.cree@amd.com>, <davem@davemloft.net>,
	<kuba@kernel.org>, <pabeni@redhat.com>, <edumazet@google.com>,
	<richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-3-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: "Li, Ming4" <ming4.li@intel.com>
In-Reply-To: <20240715172835.24757-3-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SI2PR01CA0034.apcprd01.prod.exchangelabs.com
 (2603:1096:4:192::9) To IA1PR11MB7200.namprd11.prod.outlook.com
 (2603:10b6:208:42f::11)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: IA1PR11MB7200:EE_|CY8PR11MB7314:EE_
X-MS-Office365-Filtering-Correlation-Id: a565bd9e-fcad-4890-e60f-08dca5604f29
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|7416014|366016|376014|921020;
X-Microsoft-Antispam-Message-Info: =?utf-8?B?ZEFVWGtUV1lmaTVoM3BGdnNZWmNEaU9GZEpnTVJaVTlmRlBsR2dSTUEzV2p6?=
 =?utf-8?B?QmEvS1lQd0MvR3dmSXc0eHZZSC8xSlQwNTRFSWdvZUY3bkxOQXF0M2Q1NlpS?=
 =?utf-8?B?VFJQa2VsRkRoWlhzNEUwZVRTTmlwam1TZFpDV2x3aGRYc1RDSHd5ZzdOcXFt?=
 =?utf-8?B?VGU3UXU5dXVKbmJCd1ZOYVNJMjZJeUlGdmdkaktkVHlGN3VNNTNYajc2cGhu?=
 =?utf-8?B?bWZDS1hYWE0vS1JQeEowbGo4WDhabGdoSkRZckZGUEZ2RkdMakJabDNNN1Iy?=
 =?utf-8?B?OGN6Ylg2OUFSaW5KM0RwVXozMUx4Q0ZaQjk1OG5YRUtBdDRvUjBJRXAyTkh6?=
 =?utf-8?B?dHovV2FmTGc2SlpEV1ZBYWRPczYyZ2gwbjk2b1cxRUtJbmR1RXRSb2UrejE5?=
 =?utf-8?B?UlZhT2c2TEEwMGpMV3ZqT3RoeHQ3YUpaWmhrbXA2QWMwb2sxU1hnM0pKVVZj?=
 =?utf-8?B?T1B4aVVrY292a2RJZFdZajZPQ3NKMjJCN1F6bmFOSmk0NTdZYTdpRWRzQ0dI?=
 =?utf-8?B?TllBdmNSYjB4YlpVSjk4V0ZqOXpmc1U3akRSTS84Sk5BZ0pQdDRoOFY0OUlx?=
 =?utf-8?B?V3BoSkd1aE0yb2RRNzV1NGg2WGlUZlZZaTZGTkloWmRaT3BrWXp3M005ZFNx?=
 =?utf-8?B?SVpKRUNDTVlpbVhzSi9sd3UyUkxoR1dUajhjc0ZhNkUrWUlUemIzcFQvbG1M?=
 =?utf-8?B?azZnb1RoMWJvcHVZR2Y0VTRTRm56ZWNMTWtTNTRSVThlck1abDdSekV3cUVh?=
 =?utf-8?B?VXdncW44aC9aTDcwRDZ0aDVKSmlPWStnbWNZM1ZsV2krT3dZMnRUaGF6T2sr?=
 =?utf-8?B?Q3RqZ0l0ZExMaENhaEgwaUVYRkk4NExPTmpVOUxZV0VldWt0cE1yQ1VjZGhY?=
 =?utf-8?B?WG8wZnJDSm11UXVCUExldndTQ3RHQndQMUFEb1lXRnIyNkpRakpoZ3J3anBu?=
 =?utf-8?B?YnBRWUcvemI0c3R4SVFRbXFPSFJEVFE3UkNFSFR5Z1ZvbFNyallsajZRcU41?=
 =?utf-8?B?NFhPZncrUDdINXNRaWkrODRjTkJacjd4ZWJaTDlnenVZSHhQV0dnTmptQjJi?=
 =?utf-8?B?NXQvTTF3Rk9oU1lXRzdLZkVYM2NjNmJybVptV0NCTHFUaFZwL2FuV0cwK0tU?=
 =?utf-8?B?UDVidUFweGFtVUZwaFpsZkxsbWV1a3dnY0lsVk5INGY5cXRwa3JUNDFVR0RJ?=
 =?utf-8?B?WGhwTThPN2tpSGhEV3hoa3ZaUGNseDZQVW1kdStxblhSNlArMTFRMVhOdDFR?=
 =?utf-8?B?bVp2Vkx4S2NCZFAvWWE1bmhoNHBtL2hxdi85OERuSEpjYWhjelNlUUNCVmd4?=
 =?utf-8?B?L1YvemxkZFBkTDR6UkZDMC93VEQ2S285VjdPemU2d1VEeUxEQlU2MW9hNXd3?=
 =?utf-8?B?Z3lKMWJOTy9yYWVtOVZTTGNwZ0VXMnp3SHU0OHhDOXVVM0VobFAwSDl4M0xu?=
 =?utf-8?B?T1VaRHI3Yy9zeGVnVWJiNHZ5aFpqbS9zbHNvSnRVMTJVY2tPTGVQSjFERXNY?=
 =?utf-8?B?RXFlMXpFSkxMdGIzeWFDZzBLWWdDTEE4WTQzdTVtb1NiWC9MUVYyTmlGZHpT?=
 =?utf-8?B?SVpjQ09Ub3ZJVk1HT0xnYlg2M3R2L3Y0ekIzaFVRdmlzYktpTms0V0tydE96?=
 =?utf-8?B?Y0VDZkJvVnJxRUlyYnBHWVR0MEEzbGl6Zk9TYlc0c0NUbGM1cU1pVXl5TVFD?=
 =?utf-8?B?VjVFeWpteEpmNm1aVEJtaE5JTHZiRnJqODBuQ1FBNXVYR0hOdlNLVFU2enha?=
 =?utf-8?B?L2RvOHQrb1F4amZZWEhpODByY0V0b205T3p4RmUwQjZKN0VGTVBzNFJ3Q3hy?=
 =?utf-8?B?VzYvbitlU3VIMG5XUTVpVFlwTS96aXh5UWVSTVRjRnY4RUdrNGYvSDl1emRw?=
 =?utf-8?Q?ku4QsqmY8Z2HN?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:IA1PR11MB7200.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(7416014)(366016)(376014)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?TjhiVmgrTmxkTG4wY0FqbWw2RHJVT2VHS2s3ZDNHTU85NUZ5YXUzYnpUVWJK?=
 =?utf-8?B?bkVFQTI3Qm9mSGVQdW9nNkxnUm9EakFyQjMxSTUrOThrV0I5dkt6cXdYcEZj?=
 =?utf-8?B?UkYyc3kzWkhnZ1MxQUh2NTlBUFdWdzZIbXFiZVBPMi9LY2FzaDkyOW1ZT282?=
 =?utf-8?B?SmFuNDhKK2VvaGxSdkFCWUJCQ3o0dkFsdVU1eXJYcEhCcUdXZzd5elMwQWo3?=
 =?utf-8?B?djFtV3VlbFZPU09PcWVSVHJKS3JnMGlac2Z3VCtTdjNub0c1bFByOTQrQnpS?=
 =?utf-8?B?VXBOZTBzdWM3T3VCS0xiaXBEVWlPcEZtK3N1M0MwSzdvRnQ3ck9kQXpjaGd1?=
 =?utf-8?B?MUU5NXMvcEhLcTlVcFd0OEp3dDZLOG9PbnZrYlNtZXptWjFkSWFIMmtFSzEw?=
 =?utf-8?B?YjBCaFhYSW1FWXZlN25nWjRzYlBkS1ZJTE5pY3JsMkxQd1VKNEFLaWg4Z3ZZ?=
 =?utf-8?B?K2hrRXZnQk45M0xld0wxZ0x1NE1waEo4cDlPcUg0U2xIWXYvWWFhTFJBL3BK?=
 =?utf-8?B?UkVQN3kzYlI2Z2hObGU0UXI4RFplOU8wNFpubnJzT291eGZ6SDNqcnJ6VVJG?=
 =?utf-8?B?N3pOQ2FBWkJaOFZZbGhrT0ZEL1ZXWE8zUmpHMzJwcFZDSVNRNnUrS2JqTGdN?=
 =?utf-8?B?MXVhd3czcUJ0bVNoSTE0YWFvQWhOd3MvKzFTbUhjWVZzbWhUWDlONmIvU0Zj?=
 =?utf-8?B?enRQZWZDczUzZWorZjJJeUFseTFROGo2R0ErN3NZMHlqNG8ySDFPTllFSHRH?=
 =?utf-8?B?UnMyaFUyeldjWUZSeHJldCtsZmR1UTdYcmljclZCeitkSTBPWVdnYk5iekhO?=
 =?utf-8?B?VXFNQ3h1QkRNRXl1djJ3aVJJNVVWdGZBSks4dVVvUmVTb2pTRUsvVmNXYXBE?=
 =?utf-8?B?bm1TV2Z2aXpuS2ZqdnJpOFo5cXdyeGQ1TWJqdWFYS0ZMaW9WWVBzSTBDNVJY?=
 =?utf-8?B?WmpnMWRmZjJpUDA5VGlKYmpQdlcraEIvT0N3SGcrRWtBME1pZ1VqUldQMVlx?=
 =?utf-8?B?SWQyTnNuaUlmMTIwTVNzbHlYRTMvMFlwbk1FMEU1amRUTUgwN3Ywa0VRNjFF?=
 =?utf-8?B?T3N3K2FxUWJWcUFza2YzZVA2by9FTVBnVFZFT0pvVHlwbmRtYlljS1I1Q0Rs?=
 =?utf-8?B?UEttNnpRZ3NOdVNhWDdMcEFVUmJ0aUdTUW91dWNhZFBNREl4RktxdytLQysv?=
 =?utf-8?B?eDhNeVJOSG9nQXVqWGJ1T3JTQzF6cVcrWUd3eURxbHpsY3RnREVFS29wZ1Fy?=
 =?utf-8?B?Y2FXVG42TXhGL0tYRStucUd4b2RMdU9SUkoyK25YTTVTVThxNTUya0V0Mk1F?=
 =?utf-8?B?SE92aFltK1k4T1BrbmVQSi9xblRJY2RGRmYrQ0FmQWZHM3hlZjVDRjVTbEtG?=
 =?utf-8?B?NUpmU3YxUjhiNDFTRlZ1WmFFUWdLNTMvbEpVb0J2T0pUQmpOLzVBTEFLTTQ4?=
 =?utf-8?B?ODFzVUg1bkFLMlN0bkhrRU9xdFZOOXBUNTNjMm1tQmNoQlJPa0p6blBSQzl1?=
 =?utf-8?B?bW5nNzVXVThTRk5GRndzR0FwWmhYenNVSUJ1Q0VydGtSY3c2V01ZWnhiUzhX?=
 =?utf-8?B?OTdsQ1FacnB6elozcW54OXVuaWk0TnhGYkpzSVdGK3BRMDNsR1ZjTG9KT3hD?=
 =?utf-8?B?WkdXVGJQZmNKODZPVlVrVjBxcnkrbTREOG4yVHVYa1grSmRQL2pCZnJkcTJw?=
 =?utf-8?B?M3U1TU5XZHBKQ0VuRFVwbGZQcFpDUWR3SDVnV3Y1MWFCcW1FVFBaZU9zZldC?=
 =?utf-8?B?ZGthNytxNWE5WFNDeVR4RStISyt0QVRzOUJsOWhsRlo5d1BVZVo3em15eEF2?=
 =?utf-8?B?Vm1VSzdRSHVjYTBHQzBNVzJTMnZ0OUpGdk83OHdPeE9uaXl5QWhhaTB3NlZa?=
 =?utf-8?B?WkdqcDNGZmR1L1JqUktQd0xXdCtHVkFDSzFlNlMyVUNUWTh1bzQzMEx0TEpP?=
 =?utf-8?B?VkM5NERqcFNIQ0lQMjZkRmgxWlNOM0llUDBKMk51U0RCOFhDd3QvN0cza3Fp?=
 =?utf-8?B?L1IxR3g1Q2MzbWUxTlQ4T0ZwOTBnaEJMbWpvNENtWUxyOEJkVkNRc2h2TnRr?=
 =?utf-8?B?RG1SZDBxT2VyTUh3U3laamxYaWJCeG5JaTFGSGRnZWs5TWZIQk1tRS9BeHhr?=
 =?utf-8?Q?Qzkgjx0858tCmgZ64E9XtUUmN?=
X-MS-Exchange-CrossTenant-Network-Message-Id: a565bd9e-fcad-4890-e60f-08dca5604f29
X-MS-Exchange-CrossTenant-AuthSource: IA1PR11MB7200.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 06:27:04.6532
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: OqsvtUkJjVYzrUqfLNFsFHvX/wA1OmW6vLtrNxYmf7hEouOmQc2nNe5CRHQzE/jKSwKrFJB6Zt7E7qQDnoINiQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY8PR11MB7314
X-OriginatorOrg: intel.com
Status: O
Content-Length: 3086
Lines: 91

On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Create a new function for a type2 device initialising the opaque
> cxl_dev_state struct regarding cxl regs setup and mapping.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/pci.c                  | 28 ++++++++++++++++++++++++++++
>  drivers/net/ethernet/sfc/efx_cxl.c |  3 +++
>  include/linux/cxl_accel_mem.h      |  1 +
>  3 files changed, 32 insertions(+)
>
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index e53646e9f2fb..b34d6259faf4 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -11,6 +11,7 @@
>  #include <linux/pci.h>
>  #include <linux/aer.h>
>  #include <linux/io.h>
> +#include <linux/cxl_accel_mem.h>
>  #include "cxlmem.h"
>  #include "cxlpci.h"
>  #include "cxl.h"
> @@ -521,6 +522,33 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>  	return cxl_setup_regs(map);
>  }
>  
> +int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
> +{
> +	struct cxl_register_map map;
> +	int rc;
> +
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
> +				&cxlds->reg_map);
> +	if (rc)
> +		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
> +
> +	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
> +				    BIT(CXL_CM_CAP_CAP_ID_RAS));
> +	if (rc)
> +		dev_dbg(&pdev->dev, "Failed to map RAS capability.\n");
> +
> +	return rc;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_pci_accel_setup_regs, CXL);
> +

My first feeling is that above function should be provided by cxl_core rather than cxl_pci.

Let's see if Dan has comments on that.


>  static int cxl_pci_ras_unmask(struct pci_dev *pdev)
>  {
>  	struct cxl_dev_state *cxlds = pci_get_drvdata(pdev);
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 4554dd7cca76..10c4fb915278 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -47,6 +47,9 @@ void efx_cxl_init(struct efx_nic *efx)
>  
>  	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
>  	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
> +
> +	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds))
> +		pci_info(pci_dev, "CXL accel setup regs failed");
>  }
>  
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index daf46d41f59c..ca7af4a9cefc 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -19,4 +19,5 @@ void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
>  void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
>  void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
>  			    enum accel_resource);
> +int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
>  #endif



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id DF88522309;
	Tue, 16 Jul 2024 06:06:57 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=198.175.65.10
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721110020; cv=fail; b=bh4+5lxA8GtQySXDU8J92azLKP7cN7Aye78v97UIRgcozJQ/PLdZmBeeRrT5PAvpol6KMHf/CeklEONbfKGT3c4RAyD3DdbWp7iTiF0ksBlBQ/q2L2Y1AnAfcHSBqDiUyB+xzMvh6BDYZAPdcGjUAGbEEZIED4mDnAL0yt+Bp3U=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721110020; c=relaxed/simple;
	bh=Yt2ZXH3Xw8Ha2LRAzjaU8xKnurvHvbyuK7Lk/9MpwmE=;
	h=Message-ID:Date:Subject:To:CC:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=meLKCqFFog8dayzFbea9SyrmzNhqxlmfgd5AfGAhCxNi5fSi2AYiyht2Kvsr1/sXIbv8rVVPBKRV9DuMdYOYjlC4VDlRVz+CJl/wQh7q/cKFVsP+RPQfwDfyIeXH3g6ev296U9YbtaCFIUoKkjBgKm4QaSrWEHL1iz2h5hJilg4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=VnfEq32O; arc=fail smtp.client-ip=198.175.65.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="VnfEq32O"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721110018; x=1752646018;
  h=message-id:date:subject:to:cc:references:from:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=Yt2ZXH3Xw8Ha2LRAzjaU8xKnurvHvbyuK7Lk/9MpwmE=;
  b=VnfEq32ORs8y9JHhQwIZdK2FDL3l9OUwgekaP788RVaxcCJ0TsUdin5x
   1XQtKJwmEHCcS0t26v//+UlewXI4wEpcBjGIH4/JTtjA5UoX1UL/Gv93T
   CbNdB+oKNobvdTh2qzotpx2Ty0LbJPhKG9gU9iLvYvSsNEQvonegepirH
   fqjV0tsV2cvTDf/Glc02IfQ8XLDHo+MopQGduvyl8Z7CxCErNZI0/Ulq3
   CYZJlU81tuUj1G2BkvpAhQAm0Y/g2vAyU/TtQGjwVkClJPeH7Ivqliu3J
   frulL2xd6fIruIFCQKghZ/UbicOJODajeHyjCZTRa1Qo/jvay/u6lfRZ0
   g==;
X-CSE-ConnectionGUID: G4B0MWGrSaKkmEDiyiyL1g==
X-CSE-MsgGUID: gsYBHpdITc6FIgvifodjDA==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="35958344"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="35958344"
Received: from fmviesa007.fm.intel.com ([10.60.135.147])
  by orvoesa102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 23:06:55 -0700
X-CSE-ConnectionGUID: jCu0wPK1Rq6/b7hUJMqXuQ==
X-CSE-MsgGUID: 0+pzlXYGSNmNzBkiV0wlbQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="49725214"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by fmviesa007.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 15 Jul 2024 23:06:55 -0700
Received: from fmsmsx602.amr.corp.intel.com (10.18.126.82) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Mon, 15 Jul 2024 23:06:54 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 23:06:54 -0700
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (104.47.55.44) by
 edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Mon, 15 Jul 2024 23:06:54 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=iSzUo15GmgR+SSMnz0IY6IxZ9wKyIQTc40RL2Eaml7QyPMB/OnGenWd9BjOYURqs5rXWfQ2Jb45qtyqPnafkoKcOyowR8UrZas67xZKQqY2FZG4KrFcipD6PSLLJZy+7/fzdNIsTvxjRCDTZ7jmN7ckPELb72Xs7Gzh7PLx6uKMda2c+RlPE1pjXnCOJYzMJ7wq3LCRj15NDqJ1ColUP0yRGI8VjGcysZvYmvFLXH57eReA4/bi1xyGQG/uBItMSZCb7euKNiREM39w8ob9aFsh0TldDiRt6iXVVLMCx5oNcoyeTFKBAuwmaDM/+snsgEpvM2jYmiRCPkIbTRd0oNA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=wje6hhcaAh0xdrEHNg+42H6hmk7K/qPV3w0pe2qXkJY=;
 b=qRC5Pglrqwp+rdrSF4JoSZs4rehpG9Pj3uicZHNqJrmwycN66mcHaIPEcx5mzjipb1JS9DOwWNQjp/oHRhaIaTAFoWximXLe6+xgKaDt/C9ZCn0rVJ14UgZ1HorE8QdfeLeAfrXPLaAxrslhWYzzx0AnpVrA76ODAKjYcYvjsaC+VHFPa6pa/Emw/TsAWrgIOx0GSJobt8xx9eoy9bJH/SS2KDcxueknzbndiTgVqCWgcjlI9Plj2fb7Izyu8hbeJKe43SV2F0llwCA3WSHTM9x94l5osjeFBomskgQ9lTcGGNcQveanxk/QDawbUINTzIs41zkQRiT7sV7/Q2JjlA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
 by MW3PR11MB4667.namprd11.prod.outlook.com (2603:10b6:303:53::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29; Tue, 16 Jul
 2024 06:06:52 +0000
Received: from IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0]) by IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0%5]) with mapi id 15.20.7762.027; Tue, 16 Jul 2024
 06:06:52 +0000
Message-ID: <73311003-6b8e-4140-935a-55bd63a723e6@intel.com>
Date: Tue, 16 Jul 2024 14:06:41 +0800
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 09/15] cxl: define a driver interface for HPA free
 space enumaration
To: <alejandro.lucero-palau@amd.com>, <linux-cxl@vger.kernel.org>,
	<netdev@vger.kernel.org>, <dan.j.williams@intel.com>,
	<martin.habets@xilinx.com>, <edward.cree@amd.com>, <davem@davemloft.net>,
	<kuba@kernel.org>, <pabeni@redhat.com>, <edumazet@google.com>,
	<richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: "Li, Ming4" <ming4.li@intel.com>
In-Reply-To: <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: SI2PR02CA0027.apcprd02.prod.outlook.com
 (2603:1096:4:195::14) To IA1PR11MB7200.namprd11.prod.outlook.com
 (2603:10b6:208:42f::11)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: IA1PR11MB7200:EE_|MW3PR11MB4667:EE_
X-MS-Office365-Filtering-Correlation-Id: 94155970-5960-4067-3522-08dca55d7cbc
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|376014|1800799024|366016|921020;
X-Microsoft-Antispam-Message-Info: =?utf-8?B?REZISzNvZkxrRHV4TTZnWWNkUzE1WHU1eEp3SjJyM2RaRVdwdmdBeVNyZ1NB?=
 =?utf-8?B?aHZoTVVLaVV2Q1cvOEpKS0o0K0kzdlh5WGxxVEFCN3ZtRGd2OWNlbGlEU0FG?=
 =?utf-8?B?TldzK0NUR0hCcWg0SXgyZXB5b1pXRlh0eUVxdXVmZUxiNHFqZFlaNEdpdnlW?=
 =?utf-8?B?MHhySnpFY1M2QXhrbVlFVlpmaWJMN0c1djQ4YUgxc2ovc2RPV0JWYy9VcTdk?=
 =?utf-8?B?VnBtU2tjZEluL1pjQm9GemxqeFRKU05waHRiUjg1OTZaSHM1RXNoY1BNaC93?=
 =?utf-8?B?WFF4bmwweTJ4cjJ2TUtlcFhpaXRYaTBRTVQyY0NkZjlOS0ZxZW1EZjJKK3Z0?=
 =?utf-8?B?UkJpZnFpazh6MUsvYjNoTzdQcjZRQi9lMk5kM3NCSS9iQkd3K2VZZ1pqcm5K?=
 =?utf-8?B?M2NIdFhYdGwvUFJ1S2tyOHUySkZoUjZBN0o3alp2ZkdodmFZQ3ZmUUNjMlF5?=
 =?utf-8?B?a2JWOWJPVTQvZHVKM09tK2hFbHB5R29RUHFGL3V0bDlncXFyczI4K1lBcE16?=
 =?utf-8?B?dnd1aVNuak5jejRCcGVUblZIcW96ektGMzBLVW5WenhLWFB5QUYrYU1WcHRk?=
 =?utf-8?B?aDhFMk1xbnduS20yRnJGdk1WVXZheHVrSW01MDVYKzFFNmd2TmlWOTQ5NzVh?=
 =?utf-8?B?Yzl1RFJaUkM1T3d3RDI0YnhDN1hKMVlwMTJlVndCUXhtR3BLcDJsWDhUek94?=
 =?utf-8?B?b2h2R1lwckp5V09RcG5aYnI1eW5QSW9JMjMwYXAzdGNIOFdFVU1DQjdqcUQ3?=
 =?utf-8?B?eHBLbEM1TmNYS1BmRXRuczJTKzJpQjYyYm1vWnNsK2ErMitPaVFvTUdKRWdv?=
 =?utf-8?B?UHV6UklqMi9tVWZpeFhUVVkxTE9IS3A5eStpeFY5V25PUTRmdGFaYzlMNkxG?=
 =?utf-8?B?SnpRMS9KT2poNWJseWtJdEJ0cW5GMjR6Y0cxNGhpeDRUWFZXT0lObHdkTXNm?=
 =?utf-8?B?bHpPeDJjd2dZMkJMY1pVdEFML1ZkY1VVTlAvR2hoWU12amlCMXFZaU5uRHIy?=
 =?utf-8?B?V1Z1MS9PY05HYzRFZ2dyVklhOE9CbXBMUlFQRjl4NlZENGlnalJ1YTAzUTMx?=
 =?utf-8?B?N1NIdkZyNnZUQm9ObWZXNW4yVHVRUlQwK3BLNnFzK1J0QU4xdWpqK3NPREFr?=
 =?utf-8?B?cEFVU1BaNDNHejAreksrZExYRG83RDFZb283LzQwSFBTZUxuNnJieDFDOTRF?=
 =?utf-8?B?VTk2WlBzMGFkbTZhTkpzYUdhaCtUeU9Pb2o3OUFaK2lydy84Q0F2bWtBdkw2?=
 =?utf-8?B?dmk2bVcrZ2QrbnZzQ0ZqNHVRbENQbE9SdDA0c0dVYWpkeVU0QS9UZmZYVklB?=
 =?utf-8?B?QjJ3aXVPSlJCbUJDWUE4QVNGRHd3d2FtMUdJRmhLR3BVWEtwaXFCUkl3L1BO?=
 =?utf-8?B?VWVzK2ZrdlhQQjN3RGM0VW5RT2diNFkvS2JEcVIzT3dPcG0vaGFjZk1ZUzdN?=
 =?utf-8?B?QS9JWHpQMEFGdHhWTmo4SE1NYVRQTGdyR0w2RUdTempBZS9QNFZMMjhjdXl4?=
 =?utf-8?B?SERrTHZlUVMva3l2OS9ZWUl2bG9nckphdlRZaDZlN0FxNkhUTExCT1RTTnJL?=
 =?utf-8?B?Y3NSYnBsWWQxYlkrQkNoOE5LeXd6M0R1VmMrMlZ4SUpwODZsdSsyVXdtVnYw?=
 =?utf-8?B?b0lCcmQ5YU5WOWgwTlNpN0E2WFROUHkzbG9uN3VxVWlDdTlKNXRpb0kyWGI0?=
 =?utf-8?B?TnZWNlBkQW5FRktMaFNZTC9RT0tIRUFvTmM4aVU2blZtbC9iZGhFU2NNUnAx?=
 =?utf-8?B?ZzVvVnVjdEpnRDFnSWJuK0l6ajcvdDExZUdmVkRrODA4MnVsUWFQN3ovY3JH?=
 =?utf-8?B?Sis2VHBXRFZIUkdrUitkZz09?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:IA1PR11MB7200.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(376014)(1800799024)(366016)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?WnlsVXRQSGtaMUFnVTlDdFZZUlNRZHpHVFZFNXcwODdtTFkvVG13SXVzbzNK?=
 =?utf-8?B?aW1tM2F3QWdLWnVPcnA0VEJzOVZrRktxM3FlelpWKzJZWVkzaDBELys2VEkr?=
 =?utf-8?B?VlVkd3ZuTEJ5WmdJK3ArdTlNcXFid3JDMmlpajVvQU1yU21PR0I1OXJKQWVV?=
 =?utf-8?B?UEVzWG9VcG5DRWI3VGlVNUVQdm1IL1BvY21tcXZLQURTS3c2cWtmYUg1dzBk?=
 =?utf-8?B?NTExaFljaW0weVI4NEcrdUFPWUM3MUxJT0RsRHpXanRYSUM5QXJ3SjZzdG5t?=
 =?utf-8?B?TDJiUmY5bnlYelYrT1h5RmFKdUJjdVA3ZVY2U3NvbmsvREk5bUZVVG0wNU1v?=
 =?utf-8?B?MVFIR0FVK0NSYldIRjlGdUdMY0Y1L2VKY0RNaHlrT1p6dnRRRXhGUjl2UjVK?=
 =?utf-8?B?MC9JY05BVFRpOGxwRDBrUVNET1NyN0s3SFVTS2NGdDYrT2g1TWtBOGFYeUxr?=
 =?utf-8?B?RzVxS1hoS1lqT3JkQ2EvN3dacmVVeGJyK1YzK2NvbmVPYnEzQTFMOTljUEM2?=
 =?utf-8?B?Z29zWWdhcm9VcWkxdUhjRWxxSWg1MC94SGdIODhZdDlPYXY0SEIwc2ZLQlo4?=
 =?utf-8?B?VFc1eG12bzc5b1ZNbkFjbmFFOW1KMEJEQmpSM2kyVmdnWk1DY0VycUxVcWNm?=
 =?utf-8?B?bG9FcHdsRUU2c2w3VldsL3pSZ0dLQStiUzNabWFkOXJRaTB5QjhNUkpBZkNB?=
 =?utf-8?B?S3h3ZEtzdjFtSzBhOUVtSTF4MFJxTDBJa3RmaW1QY1FUeHVOLzNzeGRHWUMx?=
 =?utf-8?B?UjdqdTlHK1dINHFJV1E3WktFUU9JN3orWXViU1JsdEdtNmRvR3hDUllLNWxt?=
 =?utf-8?B?bk5jTkZNR1pZRzlUbGMxdCtHdVBWMkJSUnVCc3JlUnF3Y3ZQdG9HVjBKb0Fv?=
 =?utf-8?B?MjNYM1B4WnFXZU1CYVBBbVpLZmZOUlNweWxYR1BGVUt4dHI2TWpUN0R4S25k?=
 =?utf-8?B?Mkszd2NvMytBTGxJdnA1ZlNOcVNTOUxrVnVQN0d3QmJQRzlCQlJ1NjhpNGor?=
 =?utf-8?B?dm9Ka3VJZ0dRdWhFTnRHTmJLUGw1bUd2MGFyZW94QkhKS0tGbmxxc3EvQ25p?=
 =?utf-8?B?bmwyT2R6VGdYZHphM2MzUFVUK0h4QlpaYWVFRkpPdUY1KzVQZjY4Sk50OHNL?=
 =?utf-8?B?dVFhWE44eGMwYUJ5Y2pyakVsdVBSVnBQZDd6TGs4RDlXbmZhSTBzb25wQUx3?=
 =?utf-8?B?V05QR0sraU51UVhqYXpYeDFxRE43enlEbzJidm12MG81TVhVc0FFdEw4RVpO?=
 =?utf-8?B?VjV0RG9aalBTcWdaNDE0QnIrcHYzbXdaTmFFeWM2UDB2QmppR3JLUTg3Y0lr?=
 =?utf-8?B?YXdYbzVVblU2amtOVDIxZlYvVzh6SkZVUXBiODU4dkp4N1NLdU1KUkI3WmlG?=
 =?utf-8?B?UFNWdHFNU0wyMDdrNkNZa1hSM0xOZjF1dVZkT3ZrMWIvN0F0QWdMamVGSG1m?=
 =?utf-8?B?d1luSGcxSmVySW9ZV2lndFB6anNPUVREaC9OaGhiK3ZrYTExdjNxMWdreHR3?=
 =?utf-8?B?czhpRXU0ZGZqdnB5VFNnVmFxV3Yxdm8rTS9mL3BQWjNqY2MvbmpVNW1SK1J0?=
 =?utf-8?B?Z1RZckFxclkwbW4rNzd1REp1NlRid1g4Q0JHdTJCSW1wc0dNSURIUjY5Zitj?=
 =?utf-8?B?cUxpQ01FemhFTnpYa0N1dkJjV1cvbUZpeFAwaWltenJicVFMNHVQMHNNYlRN?=
 =?utf-8?B?aThlK3QrUVg0RnVCVXp5eXA3Qmh6R0ZuSmRQY0VKMERZM3FSekUyTmpCckFD?=
 =?utf-8?B?VC9LZlZGOTVEcDNLSnRaV0FiOFNEd0l1dktnN01DWVJmdnMycGlJZXdVb2xR?=
 =?utf-8?B?Z01ObEFVbkphQ1BDMmZwaVdoTmo0MDl1a093REVHZndyNUUyOFVDLzloSTJM?=
 =?utf-8?B?WGI3bDF5M1FPQUlsQzJHc0dsQnNpR0NBcXBGUGN5S0RvOVdSZGdyYzUzNXJk?=
 =?utf-8?B?VjZKaEI3RVpJbzF3djg2LzlLTnRRelliNm5sM1ZXZGZkWk03cXRMV2c5eTUy?=
 =?utf-8?B?ZXV5OHhaYUZXZ1BwRVk3WnByUnBnUDNDL0JEMGtmR1pldVhWTVEwckFRK293?=
 =?utf-8?B?S05POENONmwvVzczNG41SUxJak9RR1MyVHpQNDR6R1VuRzlTczczaE5sLzRv?=
 =?utf-8?Q?GMViENVCXbrPolh0nJRkHEh+O?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 94155970-5960-4067-3522-08dca55d7cbc
X-MS-Exchange-CrossTenant-AuthSource: IA1PR11MB7200.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 06:06:52.6077
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: TGvJq4JWcJiedmp7sI7S7tV+PTzFJbFlK7A6a/1j0iMvCdBKnAG2WlyhBeCnARcAWPRdOOSft/AWpITj8/G7Sw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW3PR11MB4667
X-OriginatorOrg: intel.com
Status: O
Content-Length: 9969
Lines: 292

On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> CXL region creation involves allocating capacity from device DPA
> (device-physical-address space) and assigning it to decode a given HPA
> (host-physical-address space). Before determining how much DPA to
> allocate the amount of available HPA must be determined. Also, not all
> HPA is create equal, some specifically targets RAM, some target PMEM,
> some is prepared for device-memory flows like HDM-D and HDM-DB, and some
> is host-only (HDM-H).
>
> Wrap all of those concerns into an API that retrieves a root decoder
> (platform CXL window) that fits the specified constraints and the
> capacity available for a new region.
>
> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m6fbe775541da3cd477d65fa95c8acdc347345b4f
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/region.c          | 161 +++++++++++++++++++++++++++++
>  drivers/cxl/cxl.h                  |   3 +
>  drivers/cxl/cxlmem.h               |   5 +
>  drivers/net/ethernet/sfc/efx_cxl.c |  14 +++
>  include/linux/cxl_accel_mem.h      |   9 ++
>  5 files changed, 192 insertions(+)
>
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 538ebd5a64fd..ca464bfef77b 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -702,6 +702,167 @@ static int free_hpa(struct cxl_region *cxlr)
>  	return 0;
>  }
>  
> +
> +struct cxlrd_max_context {
> +	struct device * const *host_bridges;
> +	int interleave_ways;
> +	unsigned long flags;
> +	resource_size_t max_hpa;
> +	struct cxl_root_decoder *cxlrd;
> +};
> +
> +static int find_max_hpa(struct device *dev, void *data)
> +{
> +	struct cxlrd_max_context *ctx = data;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct cxl_root_decoder *cxlrd;
> +	struct resource *res, *prev;
> +	struct cxl_decoder *cxld;
> +	resource_size_t max;
> +	int found;
> +
> +	if (!is_root_decoder(dev))
> +		return 0;
> +
> +	cxlrd = to_cxl_root_decoder(dev);
> +	cxld = &cxlrd->cxlsd.cxld;
> +	if ((cxld->flags & ctx->flags) != ctx->flags) {
> +		dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
> +			      cxld->flags, ctx->flags);
> +		return 0;
> +	}
> +
> +	/* A Host bridge could have more interleave ways than an
> +	 * endpoint, couldn´t it?
> +	 *
> +	 * What does interleave ways mean here in terms of the requestor?
> +	 * Why the FFMWS has 0 interleave ways but root port has 1?
> +	 */
> +	if (cxld->interleave_ways != ctx->interleave_ways) {
> +		dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
> +		return 0;
> +	}
> +
> +	cxlsd = &cxlrd->cxlsd;
> +
> +	guard(rwsem_read)(&cxl_region_rwsem);
> +	found = 0;
> +	for (int i = 0; i < ctx->interleave_ways; i++)
> +		for (int j = 0; j < ctx->interleave_ways; j++)
> +			if (ctx->host_bridges[i] ==
> +					cxlsd->target[j]->dport_dev) {
> +				found++;
> +				break;
> +			}
> +
> +	if (found != ctx->interleave_ways) {
> +		dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
> +		return 0;
> +	}
> +
> +	/*
> +	 * Walk the root decoder resource range relying on cxl_region_rwsem to
> +	 * preclude sibling arrival/departure and find the largest free space
> +	 * gap.
> +	 */
> +	lockdep_assert_held_read(&cxl_region_rwsem);
> +	max = 0;
> +	res = cxlrd->res->child;
> +	if (!res)
> +		max = resource_size(cxlrd->res);
> +	else
> +		max = 0;
> +
> +	for (prev = NULL; res; prev = res, res = res->sibling) {
> +		struct resource *next = res->sibling;
> +		resource_size_t free = 0;
> +
> +		if (!prev && res->start > cxlrd->res->start) {
> +			free = res->start - cxlrd->res->start;
> +			max = max(free, max);
> +		}
> +		if (prev && res->start > prev->end + 1) {
> +			free = res->start - prev->end + 1;
> +			max = max(free, max);
> +		}
> +		if (next && res->end + 1 < next->start) {
> +			free = next->start - res->end + 1;
> +			max = max(free, max);
> +		}
> +		if (!next && res->end + 1 < cxlrd->res->end + 1) {
> +			free = cxlrd->res->end + 1 - res->end + 1;
> +			max = max(free, max);
> +		}
> +	}
> +
> +	if (max > ctx->max_hpa) {
> +		if (ctx->cxlrd)
> +			put_device(CXLRD_DEV(ctx->cxlrd));
> +		get_device(CXLRD_DEV(cxlrd));
> +		ctx->cxlrd = cxlrd;
> +		ctx->max_hpa = max;
> +		dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
> +	}
> +	return 0;
> +}
> +
> +/**
> + * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
> + * @endpoint: an endpoint that is mapped by the returned decoder
> + * @interleave_ways: number of entries in @host_bridges
> + * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
> + * @max: output parameter of bytes available in the returned decoder
> + *
> + * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
> + * is a point in time snapshot. If by the time the caller goes to use this root
> + * decoder's capacity the capacity is reduced then caller needs to loop and
> + * retry.
> + *
> + * The returned root decoder has an elevated reference count that needs to be
> + * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
> + * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
> + * does not race.
> + */
> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
> +					       int interleave_ways,
> +					       unsigned long flags,
> +					       resource_size_t *max)
> +{
> +
> +	struct cxlrd_max_context ctx = {
> +		.host_bridges = &endpoint->host_bridge,
> +		.interleave_ways = interleave_ways,
> +		.flags = flags,
> +	};
> +	struct cxl_port *root_port;
> +	struct cxl_root *root;
> +
> +	if (!is_cxl_endpoint(endpoint)) {
> +		dev_dbg(&endpoint->dev, "hpa requestor is not an endpoint\n");
> +		return ERR_PTR(-EINVAL);
> +	}
> +
> +	root = find_cxl_root(endpoint);

Could use scope-based resource management  __free() here to drop below put_device(&root_port->dev);

e.g. struct cxl_root *cxl_root __free(put_cxl_root) = find_cxl_root(endpoint);


> +	if (!root) {
> +		dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
> +		return ERR_PTR(-ENXIO);
> +	}
> +
> +	root_port = &root->port;
> +	down_read(&cxl_region_rwsem);
> +	device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
> +	up_read(&cxl_region_rwsem);
> +	put_device(&root_port->dev);
> +
> +	if (!ctx.cxlrd)
> +		return ERR_PTR(-ENOMEM);
> +
> +	*max = ctx.max_hpa;
> +	return ctx.cxlrd;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
> +
> +
>  static ssize_t size_store(struct device *dev, struct device_attribute *attr,
>  			  const char *buf, size_t len)
>  {
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index 9973430d975f..d3fdd2c1e066 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -770,6 +770,9 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
>  struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
>  struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>  struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
> +
> +#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
> +
>  bool is_root_decoder(struct device *dev);
>  bool is_switch_decoder(struct device *dev);
>  bool is_endpoint_decoder(struct device *dev);
> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
> index 8f2a820bd92d..a0e0795ec064 100644
> --- a/drivers/cxl/cxlmem.h
> +++ b/drivers/cxl/cxlmem.h
> @@ -877,4 +877,9 @@ struct cxl_hdm {
>  struct seq_file;
>  struct dentry *cxl_debugfs_create_dir(const char *dir);
>  void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
> +					       int interleave_ways,
> +					       unsigned long flags,
> +					       resource_size_t *max);
> +
>  #endif /* __CXL_MEM_H__ */
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 2cf4837ddfc1..6d49571ccff7 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -22,6 +22,7 @@ void efx_cxl_init(struct efx_nic *efx)
>  {
>  	struct pci_dev *pci_dev = efx->pci_dev;
>  	struct efx_cxl *cxl = efx->cxl;
> +	resource_size_t max = 0;
>  	struct resource res;
>  	u16 dvsec;
>  
> @@ -74,6 +75,19 @@ void efx_cxl_init(struct efx_nic *efx)
>  	if (IS_ERR(cxl->endpoint))
>  		pci_info(pci_dev, "CXL accel acquire endpoint failed");
>  
> +	cxl->cxlrd = cxl_get_hpa_freespace(cxl->endpoint, 1,
> +					    CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
> +					    &max);
> +
> +	if (IS_ERR(cxl->cxlrd)) {
> +		pci_info(pci_dev, "CXL accel get HPA failed");
> +		goto out;
> +	}
> +
> +	if (max < EFX_CTPIO_BUFFER_SIZE)
> +		pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
> +				  max, EFX_CTPIO_BUFFER_SIZE);
> +out:
>  	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
>  }
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index 701910021df8..f3e77688ffe0 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -6,6 +6,10 @@
>  #ifndef __CXL_ACCEL_MEM_H
>  #define __CXL_ACCEL_MEM_H
>  
> +#define CXL_DECODER_F_RAM   BIT(0)
> +#define CXL_DECODER_F_PMEM  BIT(1)
> +#define CXL_DECODER_F_TYPE2 BIT(2)
> +
>  enum accel_resource{
>  	CXL_ACCEL_RES_DPA,
>  	CXL_ACCEL_RES_RAM,
> @@ -32,4 +36,9 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>  
>  struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
>  void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
> +
> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
> +					       int interleave_ways,
> +					       unsigned long flags,
> +					       resource_size_t *max);
>  #endif



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.14])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 20D8518029;
	Tue, 16 Jul 2024 05:53:13 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.14
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721109196; cv=fail; b=R1hvolDpVi6KJN9F6cVTKbTN7VmW+8JM8jmvUPtuXTTxF1sNRMrs8D1W22oKmGvehvaY/RoX79EPX7b4puFOxiBJpbWQ6DimqBbdlF1JJ4pfVXxeocmAnHtGMSTIYfdNRY8apuvrY0iEH+ocy9SCwOdpN8fC8qAC+JzCiD2+8Yg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721109196; c=relaxed/simple;
	bh=ADGT0znT2U9O8/++8OFPnglODzT87mJl412gOIy4J2M=;
	h=Message-ID:Date:Subject:To:CC:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=YFTtmOpIHtuD/yvEsGK4uZvEJ9mxIBP1oGeBhvgfkzcsypYrEeIWoOe4b5gpbOK5xZhTlGRQHy8p5B3Zf33yx9P1/yaMeX3lk/WJpeXMtJI7Dmqxb2anad4D2zH80sgJ2X4MzigQPYue1D5mI7Y2HkEOhrRcLBbJYEG/k7zf/rE=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=KbSIYVzz; arc=fail smtp.client-ip=192.198.163.14
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="KbSIYVzz"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721109194; x=1752645194;
  h=message-id:date:subject:to:cc:references:from:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=ADGT0znT2U9O8/++8OFPnglODzT87mJl412gOIy4J2M=;
  b=KbSIYVzz2sxG80ealYYkbm0yCPKoeIH1uj/AuFyCAzHFUckva+t6v6s3
   spKzklsC+nIlKBrAkYDDHJ+NRK3ePZcO5EOyqNzYfUsHT3nDMGSYs1amk
   /gZ7qlq6q+fZnS7G7ahaWINHZn3Gi4e1F9pq0XwxvPUYo/OADklV03Ha6
   rJJBrkIoNbPVVt8v8uAKlyjsiqIFvRDtxMR8N9UTOpW+lEX3mCRdmbjD5
   bH4r8TtJGFT6J3iCGsjKPqr+Q4bLcBLyq2J6zM4ijr6u4khS/q+B7AI0E
   qmzNHKZ61sjLBB2rbR35tGyvuMFfXpLbTGVi2oHMbwsTqOoo94OWpYjQh
   w==;
X-CSE-ConnectionGUID: +O6XdhJzRC29f6h0BCJdOQ==
X-CSE-MsgGUID: J3B8uTViSzC1DqMe5HXO7w==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="18717321"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="18717321"
Received: from fmviesa005.fm.intel.com ([10.60.135.145])
  by fmvoesa108.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 22:53:13 -0700
X-CSE-ConnectionGUID: TpeEj1uySiGZbnLL7Q9u6A==
X-CSE-MsgGUID: NTr/GZ1CSsCM/32MIsAcZg==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="54239917"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by fmviesa005.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 15 Jul 2024 22:53:12 -0700
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Mon, 15 Jul 2024 22:53:09 -0700
Received: from ORSEDG601.ED.cps.intel.com (10.7.248.6) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 22:53:09 -0700
Received: from NAM04-DM6-obe.outbound.protection.outlook.com (104.47.73.41) by
 edgegateway.intel.com (134.134.137.102) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Mon, 15 Jul 2024 22:53:09 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=QHTznROV/dHtTCUbgRETW6fXG2gaOIYxFsUuTUo/3w3X3LMghCb0a+CZ/07smT26Zt1PPhsUAXwPrzVF2KFeFNEpwBgo1t/AAeBVLDdY49eMgqw56SHo9hEdpZlPK5NlyuQkabb46CDHy0wHYDzLyQFWB+fe/VgqZftQgFXlCzQLxa3ImEj+TkdVBM9scyI2oPAvq9v06K0yX7zsDnNYcYzB1BpEJMptB6sutH+9u/Y31vLBvG+Zxoe7OtsR8fwkaDEqR6v7IeuFgmwbg4VFsrmRWrIzti5SSLcykVAE0zNZfopR3WwiillqqED/coJdH+FQcAuFZlLY4SLxDnP0Ng==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Eq28jS6NVqNgxR9mcQIPhrZgnG40HnlQ9UgJbKqjsSY=;
 b=v/1qRFsH+u5f4vbSew7PlX9P+vCIjXadPq8CDChzt+eH74NA/1MMYCERTz60y7bhvvSxt4vfkK+y2rhF7KQgc/U8c7yM4zhEF4uloVGhZYcB2DWRLmQnlDa7kBW++3jsyOTLkTG3n0+plWX1lEpUx+BHnY3Q+RObYxePlWnr1xDbGpAF346isvkJCcRvG28jDtG4scMg3gad0eWZk2SIkOd6aOQHs69uvFYZdJaM/h9j//V9Id1DPswCX3KEvUM+ArtJuU94mBV0Urzvzin0ar/qWYPooaNd4tETkMtKPe4XBLB4VQwMHvWCvzGHHn37aTAFPdgt0lTxlY4K99OsJA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
 by SA1PR11MB8574.namprd11.prod.outlook.com (2603:10b6:806:3b1::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Tue, 16 Jul
 2024 05:53:07 +0000
Received: from IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0]) by IA1PR11MB7200.namprd11.prod.outlook.com
 ([fe80::8f47:b4ca:ec7f:d2c0%5]) with mapi id 15.20.7762.027; Tue, 16 Jul 2024
 05:53:07 +0000
Message-ID: <b2a99894-9c20-49e2-8c76-6e53aa390d9f@intel.com>
Date: Tue, 16 Jul 2024 13:52:55 +0800
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v2 08/15] cxl: indicate probe deferral
To: <alejandro.lucero-palau@amd.com>, <linux-cxl@vger.kernel.org>,
	<netdev@vger.kernel.org>, <dan.j.williams@intel.com>,
	<martin.habets@xilinx.com>, <edward.cree@amd.com>, <davem@davemloft.net>,
	<kuba@kernel.org>, <pabeni@redhat.com>, <edumazet@google.com>,
	<richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-9-alejandro.lucero-palau@amd.com>
Content-Language: en-US
From: "Li, Ming4" <ming4.li@intel.com>
In-Reply-To: <20240715172835.24757-9-alejandro.lucero-palau@amd.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SG3P274CA0007.SGPP274.PROD.OUTLOOK.COM (2603:1096:4:be::19)
 To IA1PR11MB7200.namprd11.prod.outlook.com (2603:10b6:208:42f::11)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: IA1PR11MB7200:EE_|SA1PR11MB8574:EE_
X-MS-Office365-Filtering-Correlation-Id: c67394c7-500f-4bbc-251f-08dca55b90ef
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|376014|366016|7416014|921020;
X-Microsoft-Antispam-Message-Info: =?utf-8?B?cGtHSHhrU0lCTWx2cHZJWkdpWHBaWXUxeVlRUGZaVjRvSVhoZVcySmpoOUJt?=
 =?utf-8?B?anNQTDhscVIxSk9NZFVmQTVtdlhJSDJnZFVKaG56ck1WWG50TUZ1UENkc25Q?=
 =?utf-8?B?VDlqeTJoUnpsQlZVUFNvT3N3cVhoVlowU2JOVmoyMkgrS1hSdXh4NTYzdEh1?=
 =?utf-8?B?NVY4SU45b2lJN1BuRkNDUWdma2ZxTmdXRDdXUjd6Z09heE1NMThwMzJOQklP?=
 =?utf-8?B?QWxSS1JxUDNmcVpockxzWnB6NytwM2xWbUdmK3RvRVZ3YXVYQTVZanVueHY1?=
 =?utf-8?B?UWxRcUJlK3pad0tuWS9kUUkrTDZDNFRQNmE4Q3hveGFrZU5jczBqUzJWcVI4?=
 =?utf-8?B?SW5pSlkwUHVzSk11QUNtbHpGR3cweWpLQnM4L0NUY3QxcnljQXgrR1ltVlhJ?=
 =?utf-8?B?VGF5UFJmeXc2NDhvSXJJNmVaOVJ0MHNQSklCcVpHM3BoZGR0eWZPeTU1UVF6?=
 =?utf-8?B?Q0JVUVRSMUJSV3RUZUFveEpSNkpwNXkxQUVZb1JIbVc3aS9EeTNrWDRJcmFt?=
 =?utf-8?B?cUttcGJ6dGU4MndZV2RhVUhJcUpyOGI1SG9sTi81NzVRYU5qaGVzTFBIUWNB?=
 =?utf-8?B?M2plbHFZZStqL29UNWJEYURZV3NKK3Q1clpLa3dUMGVUeTlkYkRrY0hxVDdx?=
 =?utf-8?B?UUJpSGp1MytTUnpPTVRoeG00dWFVeXNpZURXOTlNdS9YSmdLdENiZ1pMOVps?=
 =?utf-8?B?TkZRMFArUDA0V2M4UWU0OUExanRBWG0xQWpUbkpqeDRZeXRtZEwxaitjVTNM?=
 =?utf-8?B?elpBZXlhTDBnMjZRUURIM2M1Y3M5NTByM3RCb1R1UjlzSXRmS2sxKysxSmht?=
 =?utf-8?B?dVF3cndzbEpqYnZuUytWNWZOdWtEcXN2UGxFVzZQQ1JIa2Z1VERJVkc5c1RN?=
 =?utf-8?B?TWZWcGdHNDVZY0dzMDIxU0JZVWM1Qk5wRzZJekMrUEVoM1c3dXc2dGNpZFBx?=
 =?utf-8?B?WDBlVWdXT0V6R1NEYU8zbzdIRitHck1LZWhhZHhBVnpOMVE3OUFzakJBL1RX?=
 =?utf-8?B?LzNmcVFpcGVvNmNyZGNUazZTVWFwVmx2N0N2VTNNK1F6b2dEUnJZSFkvRTdH?=
 =?utf-8?B?aTB4U2thK1hCMkt5VGtwMkt3T1JsSTdZS1g1cWJ1cUtmdCtuL292cy92YU1j?=
 =?utf-8?B?YlY1TGNpMzBuVFUxWE9hd1lHUW1NRmJ0SW4wb2ozY3RGL0N0WGd6bkxRRWxm?=
 =?utf-8?B?ZkZENmNsTUNNeExKRjF6cXBFT0cvVHBFNnVrTUZ6SXZFTmU3Qy85bkc0Ykow?=
 =?utf-8?B?L01xVEdVUVlNLys2UEtDOGFXMUdKWUVOVVdDM0x2NitSY29Sc2F0Tm9RMmVI?=
 =?utf-8?B?UFVuZExTWDB3SDZxZDRQT1VtTFV3SXdDQjJJanZkOGJUdml1MFRyeUdqN3Uw?=
 =?utf-8?B?N1hMQmpoalhKdytSZjNqcGNwdkdxN2pHbzVLU0crY2ZPYUNiY0JzZmFyb0JC?=
 =?utf-8?B?Wm4vOHpvTCtHQW16cVIzZjhSUXdPOVRtTEpNTXJHaDhSNUdXdkI0c1VWVHRq?=
 =?utf-8?B?eTZlU29tVy9oVk1jQ3hoYVpuejNXcWV6eXVEUEZ4VjdwblRUdC9oaUplRXc1?=
 =?utf-8?B?ZDJYaFdGL0M1dnFNQVNNeGUzVStxc2d1Z2tXWm05bUt2MzRlNmJJSVE1cHp0?=
 =?utf-8?B?SW5TVlpoSVpOcnc1WHZkcGVLcEhUNWtKM2lYZVVJYm1vbStOSmVnT3BPTm5v?=
 =?utf-8?B?UExwbXNTZjltTHY1YnJNYVA5OHJBYUdKYlJvWDN1UDkvNEloa3dZOC9jSllq?=
 =?utf-8?B?RFZXZ05EU0U1enpHcjhpdUNGaE8zTm84eDdWak5OOGVBOFlCMjdXM0NnZ1R2?=
 =?utf-8?B?WDc4RVpNalExMlZPZEZXZz09?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:IA1PR11MB7200.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(376014)(366016)(7416014)(921020);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?L1psS2VvS1NkcWcxRjBNdjFRUmhwbHJBSm1pSmxXT3FQMk85SHhGR0w1anhN?=
 =?utf-8?B?WUlMaUYyT2UyNmNNRnJ1Z2NtTW9pMjBtRXVTT3YzcXYwMlRZUktNeHUxWHpD?=
 =?utf-8?B?OXo0WS9hN0FBSmMyYmVWbTVsQk9rak91Q3lQQjlFQ3ZZRHk0Q25wL2c5bFdz?=
 =?utf-8?B?KzllT25rZGp1RjRYUnMycjBXZ3hOUlhxSnprM25ZSDNnUVloaFd4cXNGcWxI?=
 =?utf-8?B?OWVCRnFHK1R6bnY5WE12VWRjSEUvKzVnR1VlRUxpRFExUWV1R3JiUlB5K3h2?=
 =?utf-8?B?WDRIc3hNL0ZzMHZ6V041cGpXNm5RN3RqVzlta3lJSUVZekN3OVJ6WkJVSmpj?=
 =?utf-8?B?dXNQN0ltWW1ZUkgzNmhRSjEwTHltUjZLbmFabmJ5dVdubWFEYlpMM0YrV1Zi?=
 =?utf-8?B?L2ZLWGxZWjd2WWk3amJMTjVMcncrTGtQa1ZEdFBnWjRvbm9rZ0pjRHBvVnlU?=
 =?utf-8?B?TS9NS0JrSzFaaHRTK3FXY1B1Nm90WmtaQ0hiVDlvaXI4dlFKRmI2Y1pPbXJa?=
 =?utf-8?B?RE1kR1pCaDZNd2JhVGVpVFpaTkdnLzJOYWhIUGx2NDZtSkxsVkxQMnpUSHdM?=
 =?utf-8?B?ZmVsVGRGZjV3OEZVaG12c2VZell0NzZyMVIrTzFBdldSOUg2T0VnQmRyREZx?=
 =?utf-8?B?WXZudDF5M3JKOEl0VjlyYVNScW4yNEthRFJPKzlWS0x5MDFCb3VqdlBOY3Nt?=
 =?utf-8?B?YlQrZVJSMmxXd2FUYlRXU3NzZnY2UHl3WEF3T3NIYnJIUXRlR1lNMm1vWmZ3?=
 =?utf-8?B?a3hSTk1rUmlGbEt4Um9pVUtUQ01rckxMNUh4RExvczREQWtLVHlpdUZLMjZK?=
 =?utf-8?B?TkZ1NURvV3l2ckhtdG5nZTFOWXJja21vTEtxb3Q1RGlXcEpXZEN3OUFoK2Nl?=
 =?utf-8?B?eCsyVlAwTWVYN1h4QjlxNmpCMHUzMldSQ3EzT2tJalRrRUJ0T0E2TEd0TmVt?=
 =?utf-8?B?RzYyb0tsNTFSWDVMdnZSVWFnUDlabUp5UHA0TTY3N3VIU01SVlg4UmdJOEEv?=
 =?utf-8?B?N1ZxV3VmOFZDWDdaZndPMUdBMzd6RmRscEFNbHQxMEVtdGhEWWVaTHpoUDdB?=
 =?utf-8?B?T2pSNGZyMlFYdE05TDViazdjVnBZVTFpb1R0VlIwMVg4WW84UUFEZmh0eFFI?=
 =?utf-8?B?TFlua0lTZUdRQnczM04rMFlZMXBPLzhOSHpTbERMV3RUdjV4MXY1R1dqdkox?=
 =?utf-8?B?ZFpRQ1E0clNqSWRlTHpOelc3VWFVbmduRThlQXhqQ1JPaWtRMExubW1XTXVl?=
 =?utf-8?B?TitoN0QzQjBWV2tYREdtY2NNckxYdnFNQmY0SGJGL0crUE5IQytsYjFZRzkx?=
 =?utf-8?B?cEp6bmhmY3RHTkVBSzFpamFrNTZaQldPMkprTE1FUld4U0VWQTVvbS9XRDdh?=
 =?utf-8?B?MnB1b0V3SFgvaTQ4ekVraTh4eVB3Y3Y0QzR2VGY1WFE0dE9hNzhoTjlMWmgy?=
 =?utf-8?B?S2tXMEljd0JrcW1DUmczMWI1NE1zUHQxWm16T3hTSVpGSWRWN1hSY04yR1dn?=
 =?utf-8?B?aDFaQWZFNFZpM0hTVm5LNnhyWTB3dUFucTVlL0RIem5vV3NWNWllUWZUL3FS?=
 =?utf-8?B?dmJnUU1wMHlORTN4REFpMkhSR3dNdTdSKzFsUCtBZ0h0V1ZVUUNUeURqU1BY?=
 =?utf-8?B?M2UwTWQ4MnZYUHBScDBWMnA1TjlCeDVVSER1Ynp1blBQZWxOMHdoVzIzaHpi?=
 =?utf-8?B?VHJ1SUJsZ0ppRGpGdVhXNkk2dkl3WUduTlZLTHJxcXh4V0xkRmhyK1RyL1p3?=
 =?utf-8?B?Y20rRTRVK3hnQ2tSYy84YmpHVE9BdFBSQkM2RHh0UjdSQWdMS1VGSm90Z1Y1?=
 =?utf-8?B?emFyTTNQTGtQbStUVXpNbTdZU3Zia1FyU3d6NzFKZytITGs5Smd6eFVaeGdS?=
 =?utf-8?B?dkZWQWwzVEk2WFozejNEbmc3MXhlaUtTWnppZkhiRjFQYmxnMGlYbXo3eXVT?=
 =?utf-8?B?ekFxUGpIeW1FcngxZ0V5cEhWS3JnVjJuMTJUVjdEQmtJYXFmQ2JBMEdYc0dp?=
 =?utf-8?B?cEVUbzVTUTVON3VlNkoxZkhQeGNTQU5nMlc0Q0ZMaUZBLzA3cUNkamI5SUc2?=
 =?utf-8?B?VndrQjFyclZXNVcxa1VibnBUdi9Za29UOW9ESVJPL1Zzc21TV2UxczBuVW0x?=
 =?utf-8?Q?pqvkOGCi/oMTNuiPlkuApt2tu?=
X-MS-Exchange-CrossTenant-Network-Message-Id: c67394c7-500f-4bbc-251f-08dca55b90ef
X-MS-Exchange-CrossTenant-AuthSource: IA1PR11MB7200.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Jul 2024 05:53:07.5238
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: z+d9+92SQjBpXoPrmK4ZSGi8y/6+aMsZ+JEWE/dtiGGGy4qIreSOa3t3StpbXx4oW9Uy0QC4aap0JkQyGgfHyg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR11MB8574
X-OriginatorOrg: intel.com
Status: RO
Content-Length: 5563
Lines: 162

On 7/16/2024 1:28 AM, alejandro.lucero-palau@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> The first stop for a CXL accelerator driver that wants to establish new
> CXL.mem regions is to register a 'struct cxl_memdev. That kicks off
> cxl_mem_probe() to enumerate all 'struct cxl_port' instances in the
> topology up to the root.
>
> If the root driver has not attached yet the expectation is that the
> driver waits until that link is established. The common cxl_pci_driver
> has reason to keep the 'struct cxl_memdev' device attached to the bus
> until the root driver attaches. An accelerator may want to instead defer
> probing until CXL resources can be acquired.
>
> Use the @endpoint attribute of a 'struct cxl_memdev' to convey when
> accelerator driver probing should be defferred vs failed. Provide that
> indication via a new cxl_acquire_endpoint() API that can retrieve the
> probe status of the memdev.
>
> The first consumer of this API is a test driver that excercises the CXL
> Type-2 flow.
>
> Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m18497367d2ae38f88e94c06369eaa83fa23e92b2
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/memdev.c          | 41 ++++++++++++++++++++++++++++++
>  drivers/cxl/core/port.c            |  2 +-
>  drivers/cxl/mem.c                  |  7 +++--
>  drivers/net/ethernet/sfc/efx_cxl.c | 10 +++++++-
>  include/linux/cxl_accel_mem.h      |  3 +++
>  5 files changed, 59 insertions(+), 4 deletions(-)
>
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index b902948b121f..d51c8bfb32e3 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -1137,6 +1137,47 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>  }
>  EXPORT_SYMBOL_NS_GPL(devm_cxl_add_memdev, CXL);
>  
> +/*
> + * Try to get a locked reference on a memdev's CXL port topology
> + * connection. Be careful to observe when cxl_mem_probe() has deposited
> + * a probe deferral awaiting the arrival of the CXL root driver
> +*/
> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd)
> +{
> +	struct cxl_port *endpoint;
> +	int rc = -ENXIO;
> +
> +	device_lock(&cxlmd->dev);
> +	endpoint = cxlmd->endpoint;
> +	if (!endpoint)
> +		goto err;
> +
> +	if (IS_ERR(endpoint)) {
> +		rc = PTR_ERR(endpoint);
> +		goto err;
> +	}
> +
> +	device_lock(&endpoint->dev);
> +	if (!endpoint->dev.driver)
> +		goto err_endpoint;
> +
> +	return endpoint;
> +
> +err_endpoint:
> +	device_unlock(&endpoint->dev);
> +err:
> +	device_unlock(&cxlmd->dev);
> +	return ERR_PTR(rc);
> +}
> +EXPORT_SYMBOL_NS(cxl_acquire_endpoint, CXL);
> +
> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
> +{
> +	device_unlock(&endpoint->dev);
> +	device_unlock(&cxlmd->dev);
> +}
> +EXPORT_SYMBOL_NS(cxl_release_endpoint, CXL);
> +
>  static void sanitize_teardown_notifier(void *data)
>  {
>  	struct cxl_memdev_state *mds = data;
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index d66c6349ed2d..3c6b896c5f65 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -1553,7 +1553,7 @@ static int add_port_attach_ep(struct cxl_memdev *cxlmd,
>  		 */
>  		dev_dbg(&cxlmd->dev, "%s is a root dport\n",
>  			dev_name(dport_dev));
> -		return -ENXIO;
> +		return -EPROBE_DEFER;
>  	}
>  
>  	parent_port = find_cxl_port(dparent, &parent_dport);
> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
> index f76af75a87b7..383a6f4829d3 100644
> --- a/drivers/cxl/mem.c
> +++ b/drivers/cxl/mem.c
> @@ -145,13 +145,16 @@ static int cxl_mem_probe(struct device *dev)
>  		return rc;
>  
>  	rc = devm_cxl_enumerate_ports(cxlmd);
> -	if (rc)
> +	if (rc) {
> +		cxlmd->endpoint = ERR_PTR(rc);
>  		return rc;
> +	}
>  
>  	parent_port = cxl_mem_find_port(cxlmd, &dport);
>  	if (!parent_port) {
>  		dev_err(dev, "CXL port topology not found\n");
> -		return -ENXIO;
> +		cxlmd->endpoint = ERR_PTR(-EPROBE_DEFER);
> +		return -EPROBE_DEFER;
>  	}
>  
>  	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
> diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
> index 0abe66490ef5..2cf4837ddfc1 100644
> --- a/drivers/net/ethernet/sfc/efx_cxl.c
> +++ b/drivers/net/ethernet/sfc/efx_cxl.c
> @@ -65,8 +65,16 @@ void efx_cxl_init(struct efx_nic *efx)
>  	}
>  
>  	cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
> -	if (IS_ERR(cxl->cxlmd))
> +	if (IS_ERR(cxl->cxlmd)) {
>  		pci_info(pci_dev, "CXL accel memdev creation failed");
> +		return;
> +	}
> +
> +	cxl->endpoint = cxl_acquire_endpoint(cxl->cxlmd);
> +	if (IS_ERR(cxl->endpoint))
> +		pci_info(pci_dev, "CXL accel acquire endpoint failed");
> +
> +	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);

there is no need to invoke cxl_release_endpoint() if cxl_acquire_endpoint() failed. right?


>  }
>  
>  
> diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
> index 442ed9862292..701910021df8 100644
> --- a/include/linux/cxl_accel_mem.h
> +++ b/include/linux/cxl_accel_mem.h
> @@ -29,4 +29,7 @@ int cxl_await_media_ready(struct cxl_dev_state *cxlds);
>  
>  struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>  				       struct cxl_dev_state *cxlds);
> +
> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
>  #endif



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.17])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0351F4A24;
	Tue, 16 Jul 2024 01:57:22 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=192.198.163.17
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721095046; cv=none; b=TH82yGT1p/akG0EMSAOeupZdrRH0lsrI6FQQJKWpVQB4NmtBZneJc4kfhaJqKK4cDbyEFBYBy/ICo8B2f14YbA/7mH/IHieigYah2SP317Uj+AnJ8zPJ7h6PCFSdkNsnoX2xqyT7nPkb/75fdNFk0jDOeUyoCesKSx4YYpzj4RQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721095046; c=relaxed/simple;
	bh=t0XlaqT1tDT/nsM6KCVFb/nb2016vFMXOdVznDehQak=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=M3bRavAj7MKI2zt6HzmyCqeufPlUJ6EB2WM1gg6BT55o1kgSnpZ/nZ30OXA8o6nyvFJOD+tC0QhxJLXKhUIZVUyQOSXVaaQG5rAXHr4pWsjwo5k9r0owi0hA8FvC5UpDw1vCiytHbTSyT8Sfw7yPTsM6leWXQ/Kbftl2x8QdDxI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=fIBKteLS; arc=none smtp.client-ip=192.198.163.17
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="fIBKteLS"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721095043; x=1752631043;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=t0XlaqT1tDT/nsM6KCVFb/nb2016vFMXOdVznDehQak=;
  b=fIBKteLSPhZWakjlGU2celfaXfB845tbzVF7DeSc9j4Sr0PSgQcX2AZY
   AXAatQ4++rRQNLDQoggDj+V/7yYXbWTLUYktD6b3sn9vwH7dVjSHTa9rX
   ULA0ty7kDlhwH7YfF5rfg8S7E+ZiPuYx1MFh4i+dfpFsGljgSRLr3KSjd
   yCZEEAJ8TGV/S+4KN6+TleoA+SCtHdkAKcNYGY0dUwmS5XYeY+tphP/dY
   oR1QHRFMPTdr7ZLm3oVl4oRO4gHGED6iRYqbh4Hujhgz/E0zQDVHssjQy
   7JNaVfraSN0tGNtoPeQFtqw1KG/F2IhMJyOQfR2VH4GDvKIHGYqkkQVZR
   Q==;
X-CSE-ConnectionGUID: WpzpiDI4THex67W/mnqi6Q==
X-CSE-MsgGUID: 5mCEcgNyQcuXxr3Ys8v/KQ==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="18377041"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="18377041"
Received: from orviesa002.jf.intel.com ([10.64.159.142])
  by fmvoesa111.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 18:57:22 -0700
X-CSE-ConnectionGUID: Sy4ZL5sRSuSVdTh3priDpA==
X-CSE-MsgGUID: vtkZ1LHFRvePulM3uhH8xA==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="80509954"
Received: from lkp-server01.sh.intel.com (HELO 68891e0c336b) ([10.239.97.150])
  by orviesa002.jf.intel.com with ESMTP; 15 Jul 2024 18:57:19 -0700
Received: from kbuild by 68891e0c336b with local (Exim 4.96)
	(envelope-from <lkp@intel.com>)
	id 1sTXRM-000ekw-0M;
	Tue, 16 Jul 2024 01:57:16 +0000
Date: Tue, 16 Jul 2024 09:57:00 +0800
From: kernel test robot <lkp@intel.com>
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
	netdev@vger.kernel.org, dan.j.williams@intel.com,
	martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
	kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
	richard.hughes@amd.com
Cc: llvm@lists.linux.dev, oe-kbuild-all@lists.linux.dev,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 01/15] cxl: add type2 device basic support
Message-ID: <202407160957.L4mIOUtI-lkp@intel.com>
References: <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: llvm@lists.linux.dev
List-Id: <llvm.lists.linux.dev>
List-Subscribe: <mailto:llvm+subscribe@lists.linux.dev>
List-Unsubscribe: <mailto:llvm+unsubscribe@lists.linux.dev>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Status: O
Content-Length: 9603
Lines: 144

Hi,

kernel test robot noticed the following build warnings:

[auto build test WARNING on linus/master]
[also build test WARNING on cxl/pending v6.10 next-20240715]
[cannot apply to cxl/next horms-ipvs/master]
[If your patch is applied to the wrong git tree, kindly drop us a note.
And when submitting patch, we suggest to use '--base' as documented in
https://git-scm.com/docs/git-format-patch#_base_tree_information]

url:    https://github.com/intel-lab-lkp/linux/commits/alejandro-lucero-palau-amd-com/cxl-add-type2-device-basic-support/20240716-015920
base:   linus/master
patch link:    https://lore.kernel.org/r/20240715172835.24757-2-alejandro.lucero-palau%40amd.com
patch subject: [PATCH v2 01/15] cxl: add type2 device basic support
config: s390-allmodconfig (https://download.01.org/0day-ci/archive/20240716/202407160957.L4mIOUtI-lkp@intel.com/config)
compiler: clang version 19.0.0git (https://github.com/llvm/llvm-project a0c6b8aef853eedaa0980f07c0a502a5a8a9740e)
reproduce (this is a W=1 build): (https://download.01.org/0day-ci/archive/20240716/202407160957.L4mIOUtI-lkp@intel.com/reproduce)

If you fix the issue in a separate patch/commit (i.e. not just a new version of
the same patch/commit), kindly add following tags
| Reported-by: kernel test robot <lkp@intel.com>
| Closes: https://lore.kernel.org/oe-kbuild-all/202407160957.L4mIOUtI-lkp@intel.com/

All warnings (new ones prefixed by >>):

   In file included from drivers/net/ethernet/sfc/efx.c:8:
   In file included from include/linux/filter.h:9:
   In file included from include/linux/bpf.h:20:
   In file included from include/linux/module.h:19:
   In file included from include/linux/elf.h:6:
   In file included from arch/s390/include/asm/elf.h:173:
   In file included from arch/s390/include/asm/mmu_context.h:11:
   In file included from arch/s390/include/asm/pgalloc.h:18:
   In file included from include/linux/mm.h:2258:
   include/linux/vmstat.h:500:43: warning: arithmetic between different enumeration types ('enum zone_stat_item' and 'enum numa_stat_item') [-Wenum-enum-conversion]
     500 |         return vmstat_text[NR_VM_ZONE_STAT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~ ^
     501 |                            item];
         |                            ~~~~
   include/linux/vmstat.h:507:43: warning: arithmetic between different enumeration types ('enum zone_stat_item' and 'enum numa_stat_item') [-Wenum-enum-conversion]
     507 |         return vmstat_text[NR_VM_ZONE_STAT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~ ^
     508 |                            NR_VM_NUMA_EVENT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~~
   include/linux/vmstat.h:514:36: warning: arithmetic between different enumeration types ('enum node_stat_item' and 'enum lru_list') [-Wenum-enum-conversion]
     514 |         return node_stat_name(NR_LRU_BASE + lru) + 3; // skip "nr_"
         |                               ~~~~~~~~~~~ ^ ~~~
   include/linux/vmstat.h:519:43: warning: arithmetic between different enumeration types ('enum zone_stat_item' and 'enum numa_stat_item') [-Wenum-enum-conversion]
     519 |         return vmstat_text[NR_VM_ZONE_STAT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~ ^
     520 |                            NR_VM_NUMA_EVENT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~~
   include/linux/vmstat.h:528:43: warning: arithmetic between different enumeration types ('enum zone_stat_item' and 'enum numa_stat_item') [-Wenum-enum-conversion]
     528 |         return vmstat_text[NR_VM_ZONE_STAT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~ ^
     529 |                            NR_VM_NUMA_EVENT_ITEMS +
         |                            ~~~~~~~~~~~~~~~~~~~~~~
   In file included from drivers/net/ethernet/sfc/efx.c:8:
   In file included from include/linux/filter.h:12:
   In file included from include/linux/skbuff.h:28:
   In file included from include/linux/dma-mapping.h:11:
   In file included from include/linux/scatterlist.h:9:
   In file included from arch/s390/include/asm/io.h:93:
   include/asm-generic/io.h:548:31: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     548 |         val = __raw_readb(PCI_IOBASE + addr);
         |                           ~~~~~~~~~~ ^
   include/asm-generic/io.h:561:61: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     561 |         val = __le16_to_cpu((__le16 __force)__raw_readw(PCI_IOBASE + addr));
         |                                                         ~~~~~~~~~~ ^
   include/uapi/linux/byteorder/big_endian.h:37:59: note: expanded from macro '__le16_to_cpu'
      37 | #define __le16_to_cpu(x) __swab16((__force __u16)(__le16)(x))
         |                                                           ^
   include/uapi/linux/swab.h:102:54: note: expanded from macro '__swab16'
     102 | #define __swab16(x) (__u16)__builtin_bswap16((__u16)(x))
         |                                                      ^
   In file included from drivers/net/ethernet/sfc/efx.c:8:
   In file included from include/linux/filter.h:12:
   In file included from include/linux/skbuff.h:28:
   In file included from include/linux/dma-mapping.h:11:
   In file included from include/linux/scatterlist.h:9:
   In file included from arch/s390/include/asm/io.h:93:
   include/asm-generic/io.h:574:61: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     574 |         val = __le32_to_cpu((__le32 __force)__raw_readl(PCI_IOBASE + addr));
         |                                                         ~~~~~~~~~~ ^
   include/uapi/linux/byteorder/big_endian.h:35:59: note: expanded from macro '__le32_to_cpu'
      35 | #define __le32_to_cpu(x) __swab32((__force __u32)(__le32)(x))
         |                                                           ^
   include/uapi/linux/swab.h:115:54: note: expanded from macro '__swab32'
     115 | #define __swab32(x) (__u32)__builtin_bswap32((__u32)(x))
         |                                                      ^
   In file included from drivers/net/ethernet/sfc/efx.c:8:
   In file included from include/linux/filter.h:12:
   In file included from include/linux/skbuff.h:28:
   In file included from include/linux/dma-mapping.h:11:
   In file included from include/linux/scatterlist.h:9:
   In file included from arch/s390/include/asm/io.h:93:
   include/asm-generic/io.h:585:33: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     585 |         __raw_writeb(value, PCI_IOBASE + addr);
         |                             ~~~~~~~~~~ ^
   include/asm-generic/io.h:595:59: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     595 |         __raw_writew((u16 __force)cpu_to_le16(value), PCI_IOBASE + addr);
         |                                                       ~~~~~~~~~~ ^
   include/asm-generic/io.h:605:59: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     605 |         __raw_writel((u32 __force)cpu_to_le32(value), PCI_IOBASE + addr);
         |                                                       ~~~~~~~~~~ ^
   include/asm-generic/io.h:693:20: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     693 |         readsb(PCI_IOBASE + addr, buffer, count);
         |                ~~~~~~~~~~ ^
   include/asm-generic/io.h:701:20: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     701 |         readsw(PCI_IOBASE + addr, buffer, count);
         |                ~~~~~~~~~~ ^
   include/asm-generic/io.h:709:20: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     709 |         readsl(PCI_IOBASE + addr, buffer, count);
         |                ~~~~~~~~~~ ^
   include/asm-generic/io.h:718:21: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     718 |         writesb(PCI_IOBASE + addr, buffer, count);
         |                 ~~~~~~~~~~ ^
   include/asm-generic/io.h:727:21: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     727 |         writesw(PCI_IOBASE + addr, buffer, count);
         |                 ~~~~~~~~~~ ^
   include/asm-generic/io.h:736:21: warning: performing pointer arithmetic on a null pointer has undefined behavior [-Wnull-pointer-arithmetic]
     736 |         writesl(PCI_IOBASE + addr, buffer, count);
         |                 ~~~~~~~~~~ ^
   In file included from drivers/net/ethernet/sfc/efx.c:36:
>> drivers/net/ethernet/sfc/efx_cxl.h:11:9: warning: 'EFX_CXL_H' is used as a header guard here, followed by #define of a different macro [-Wheader-guard]
      11 | #ifndef EFX_CXL_H
         |         ^~~~~~~~~
   drivers/net/ethernet/sfc/efx_cxl.h:12:9: note: 'EFX_CLX_H' is defined here; did you mean 'EFX_CXL_H'?
      12 | #define EFX_CLX_H
         |         ^~~~~~~~~
         |         EFX_CXL_H
   18 warnings generated.


vim +/EFX_CXL_H +11 drivers/net/ethernet/sfc/efx_cxl.h

  > 11	#ifndef EFX_CXL_H
    12	#define EFX_CLX_H
    13	

-- 
0-DAY CI Kernel Test Service
https://github.com/intel/lkp-tests/wiki

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.16])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 523874A2F;
	Tue, 16 Jul 2024 00:54:20 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.16
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721091262; cv=none; b=XFaGxAhX7XgPDMSByDn071NjAwnz4EcycC8eYkguZmG6M/zrvd4Z1GxxtsIfhYG5RtuaTKlw7S/iNwROw73j42t1uEbfeNfrrPIDkubQsit3G1F6W99Wrij1xcUftzbYnxOnhLZlO5ouSdgHkprxnUkFfteiTO+z7+nwvwyE/IE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721091262; c=relaxed/simple;
	bh=AlcLkl3ZckSTetDqtkbewgaIlrmC0fd1HpPyOnPIDOY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=jpVPqVe7iCrlh3YDbvHd+bLgmVEf4hB12qktHNbyUuKaW84O8qkrtS2XxQc3lNXXD6lGoHczOXpfXQYaA+8RXP7kXNgD7OF0hppQnA81Kxbt3A/noe5yJA/BK+8SABhGxi7yOwgoYdIaU7X1dsusI2iXMv4AZd26EKZmHlz3m+0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=n0f7rM5L; arc=none smtp.client-ip=198.175.65.16
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="n0f7rM5L"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721091260; x=1752627260;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=AlcLkl3ZckSTetDqtkbewgaIlrmC0fd1HpPyOnPIDOY=;
  b=n0f7rM5LQCiaK+ndZzU9tQ3UPFnnfy/fVE+GcHxaCEXvgDGHqf7uE9f5
   TuEwcr9s0FoSyulbWfBrcymhSXEZrYsCgtC+yziKavUCDoiN/oFdDnzKQ
   b7KMtErNscRcH7KXqVIXVLUziLlUF4r8l03stUqnuMgcYzAWrC7Pm6t7f
   adBPFNSyb4yCKmkmyj0VykUreiS80gWxGlv5EFZBw20ZYh/XuMFNOjF5i
   yxyGi6WKUB/y5rvnnbHE/JukYlojPHCf9cDpBvTj74wd3kFGHYZPojhqU
   44ZXpO+aPu6d0RESgj4ThGHbv6rWnKVUYPq93T0hRle40IAqpuIpeBxaq
   A==;
X-CSE-ConnectionGUID: 15W2N+d8TB+PXPlxkbRQUg==
X-CSE-MsgGUID: FCGLv+HATw6GjusZzo6Mqw==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="18642255"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="18642255"
Received: from fmviesa010.fm.intel.com ([10.60.135.150])
  by orvoesa108.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 17:54:20 -0700
X-CSE-ConnectionGUID: lF6M1kDsQcupE5CgB6cnNw==
X-CSE-MsgGUID: EmctZzIbRMavmTAEQvtPpQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="49900247"
Received: from lkp-server01.sh.intel.com (HELO 68891e0c336b) ([10.239.97.150])
  by fmviesa010.fm.intel.com with ESMTP; 15 Jul 2024 17:54:16 -0700
Received: from kbuild by 68891e0c336b with local (Exim 4.96)
	(envelope-from <lkp@intel.com>)
	id 1sTWSM-000eiJ-1i;
	Tue, 16 Jul 2024 00:54:14 +0000
Date: Tue, 16 Jul 2024 08:53:30 +0800
From: kernel test robot <lkp@intel.com>
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
	netdev@vger.kernel.org, dan.j.williams@intel.com,
	martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
	kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
	richard.hughes@amd.com
Cc: llvm@lists.linux.dev, oe-kbuild-all@lists.linux.dev,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 09/15] cxl: define a driver interface for HPA free
 space enumaration
Message-ID: <202407160818.7GrterxM-lkp@intel.com>
References: <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: llvm@lists.linux.dev
List-Id: <llvm.lists.linux.dev>
List-Subscribe: <mailto:llvm+subscribe@lists.linux.dev>
List-Unsubscribe: <mailto:llvm+unsubscribe@lists.linux.dev>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
Status: O
Content-Length: 5995
Lines: 137

Hi,

kernel test robot noticed the following build warnings:

[auto build test WARNING on linus/master]
[also build test WARNING on v6.10 next-20240715]
[cannot apply to cxl/next cxl/pending horms-ipvs/master]
[If your patch is applied to the wrong git tree, kindly drop us a note.
And when submitting patch, we suggest to use '--base' as documented in
https://git-scm.com/docs/git-format-patch#_base_tree_information]

url:    https://github.com/intel-lab-lkp/linux/commits/alejandro-lucero-palau-amd-com/cxl-add-type2-device-basic-support/20240716-015920
base:   linus/master
patch link:    https://lore.kernel.org/r/20240715172835.24757-10-alejandro.lucero-palau%40amd.com
patch subject: [PATCH v2 09/15] cxl: define a driver interface for HPA free space enumaration
config: i386-buildonly-randconfig-004-20240716 (https://download.01.org/0day-ci/archive/20240716/202407160818.7GrterxM-lkp@intel.com/config)
compiler: clang version 18.1.5 (https://github.com/llvm/llvm-project 617a15a9eac96088ae5e9134248d8236e34b91b1)
reproduce (this is a W=1 build): (https://download.01.org/0day-ci/archive/20240716/202407160818.7GrterxM-lkp@intel.com/reproduce)

If you fix the issue in a separate patch/commit (i.e. not just a new version of
the same patch/commit), kindly add following tags
| Reported-by: kernel test robot <lkp@intel.com>
| Closes: https://lore.kernel.org/oe-kbuild-all/202407160818.7GrterxM-lkp@intel.com/

All warnings (new ones prefixed by >>):

   In file included from drivers/net/ethernet/sfc/efx_cxl.c:17:
   drivers/net/ethernet/sfc/efx_cxl.h:11:9: warning: 'EFX_CXL_H' is used as a header guard here, followed by #define of a different macro [-Wheader-guard]
      11 | #ifndef EFX_CXL_H
         |         ^~~~~~~~~
   drivers/net/ethernet/sfc/efx_cxl.h:12:9: note: 'EFX_CLX_H' is defined here; did you mean 'EFX_CXL_H'?
      12 | #define EFX_CLX_H
         |         ^~~~~~~~~
         |         EFX_CXL_H
>> drivers/net/ethernet/sfc/efx_cxl.c:89:7: warning: format specifies type 'unsigned long long' but the argument has type 'resource_size_t' (aka 'unsigned int') [-Wformat]
      88 |                 pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
         |                                                                        ~~~~
         |                                                                        %u
      89 |                                   max, EFX_CTPIO_BUFFER_SIZE);
         |                                   ^~~
   include/linux/pci.h:2683:67: note: expanded from macro 'pci_info'
    2683 | #define pci_info(pdev, fmt, arg...)     dev_info(&(pdev)->dev, fmt, ##arg)
         |                                                                ~~~    ^~~
   include/linux/dev_printk.h:160:67: note: expanded from macro 'dev_info'
     160 |         dev_printk_index_wrap(_dev_info, KERN_INFO, dev, dev_fmt(fmt), ##__VA_ARGS__)
         |                                                                  ~~~     ^~~~~~~~~~~
   include/linux/dev_printk.h:110:23: note: expanded from macro 'dev_printk_index_wrap'
     110 |                 _p_func(dev, fmt, ##__VA_ARGS__);                       \
         |                              ~~~    ^~~~~~~~~~~
   2 warnings generated.


vim +89 drivers/net/ethernet/sfc/efx_cxl.c

    15	
    16	#include "net_driver.h"
  > 17	#include "efx_cxl.h"
    18	
    19	#define EFX_CTPIO_BUFFER_SIZE	(1024*1024*256)
    20	
    21	void efx_cxl_init(struct efx_nic *efx)
    22	{
    23		struct pci_dev *pci_dev = efx->pci_dev;
    24		struct efx_cxl *cxl = efx->cxl;
    25		resource_size_t max = 0;
    26		struct resource res;
    27		u16 dvsec;
    28	
    29		dvsec = pci_find_dvsec_capability(pci_dev, PCI_VENDOR_ID_CXL,
    30						  CXL_DVSEC_PCIE_DEVICE);
    31	
    32		if (!dvsec)
    33			return;
    34	
    35		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
    36	
    37		cxl->cxlds = cxl_accel_state_create(&pci_dev->dev,
    38						    CXL_ACCEL_DRIVER_CAP_HDM);
    39		if (IS_ERR(cxl->cxlds)) {
    40			pci_info(pci_dev, "CXL accel device state failed");
    41			return;
    42		}
    43	
    44		cxl_accel_set_dvsec(cxl->cxlds, dvsec);
    45		cxl_accel_set_serial(cxl->cxlds, pci_dev->dev.id);
    46	
    47		res = DEFINE_RES_MEM(0, EFX_CTPIO_BUFFER_SIZE);
    48		cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_DPA);
    49	
    50		res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
    51		cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
    52	
    53		if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds)) {
    54			pci_info(pci_dev, "CXL accel setup regs failed");
    55			return;
    56		}
    57	
    58		if (cxl_accel_request_resource(cxl->cxlds, true))
    59			pci_info(pci_dev, "CXL accel resource request failed");
    60	
    61		if (!cxl_await_media_ready(cxl->cxlds)) {
    62			cxl_accel_set_media_ready(cxl->cxlds);
    63		} else {
    64			pci_info(pci_dev, "CXL accel media not active");
    65			return;
    66		}
    67	
    68		cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
    69		if (IS_ERR(cxl->cxlmd)) {
    70			pci_info(pci_dev, "CXL accel memdev creation failed");
    71			return;
    72		}
    73	
    74		cxl->endpoint = cxl_acquire_endpoint(cxl->cxlmd);
    75		if (IS_ERR(cxl->endpoint))
    76			pci_info(pci_dev, "CXL accel acquire endpoint failed");
    77	
    78		cxl->cxlrd = cxl_get_hpa_freespace(cxl->endpoint, 1,
    79						    CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
    80						    &max);
    81	
    82		if (IS_ERR(cxl->cxlrd)) {
    83			pci_info(pci_dev, "CXL accel get HPA failed");
    84			goto out;
    85		}
    86	
    87		if (max < EFX_CTPIO_BUFFER_SIZE)
    88			pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
  > 89					  max, EFX_CTPIO_BUFFER_SIZE);
    90	out:
    91		cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
    92	}
    93	

-- 
0-DAY CI Kernel Test Service
https://github.com/intel/lkp-tests/wiki

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from vps0.lunn.ch (vps0.lunn.ch [156.67.10.101])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 49287179BD;
	Mon, 15 Jul 2024 18:49:06 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=156.67.10.101
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721069347; cv=none; b=r19Cm8HVLgXfkXOXRGsB6HZKBa0ju1GdZ5b55t3WjUcq0AKWkSDrYbyWwyhPDJK4Wevhr1sdGMjUjPg8Wu+g39QrE3luhKgJvqaDoOs7U6B80+vU+Xt0yP3j+/lw6rI/+dYA4zZjYY/xiNuGgxgErUjhEvJ+qoK+JnhaD9TZIAE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721069347; c=relaxed/simple;
	bh=AmJtrJOYkheRvLPk7KDBMoq9AXd0A+zPJpe9ewJsmqE=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=b966CRBHei1pkB9spfVx5w4Pu1NyNpbPLPo7WbRi08K53EdQwoqROlcJmZmhjehUch5zDOu0wYGzpup+Xc0Bo57FplfNxr5zYSlfyBq80o6BlfzqxzaXlRe9XTo+hzSVuHCKVvvZE/FT6yzgwJKPZXWRy6vfGZtTeCzPjLQCZho=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=lunn.ch; spf=pass smtp.mailfrom=lunn.ch; dkim=pass (1024-bit key) header.d=lunn.ch header.i=@lunn.ch header.b=Yf8druRL; arc=none smtp.client-ip=156.67.10.101
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=lunn.ch
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=lunn.ch
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=lunn.ch header.i=@lunn.ch header.b="Yf8druRL"
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=lunn.ch;
	s=20171124; h=In-Reply-To:Content-Disposition:Content-Type:MIME-Version:
	References:Message-ID:Subject:Cc:To:From:Date:From:Sender:Reply-To:Subject:
	Date:Message-ID:To:Cc:MIME-Version:Content-Type:Content-Transfer-Encoding:
	Content-ID:Content-Description:Content-Disposition:In-Reply-To:References;
	bh=U/gaZ/UKVQ7nvvz75les85SF/WsWU7ztDSAN1VO2/gU=; b=Yf8druRLtaSPmhDfRfMjJMvWhc
	pNyZl7IQLM7zIYHeRJXwn7ilbIK6wwoMAXrddKmga4S2JvVYABMnPHMfg9ysSU1NPm1mZVNWnAAZN
	TDt1nVlCiwBUxdhpKaUGt+09vonwk2D2pAPEIpjmZ7BtPt1Lg4IW4B8l727aigduMojg=;
Received: from andrew by vps0.lunn.ch with local (Exim 4.94.2)
	(envelope-from <andrew@lunn.ch>)
	id 1sTQkt-002akv-Gf; Mon, 15 Jul 2024 20:48:59 +0200
Date: Mon, 15 Jul 2024 20:48:59 +0200
From: Andrew Lunn <andrew@lunn.ch>
To: alejandro.lucero-palau@amd.com
Cc: linux-cxl@vger.kernel.org, netdev@vger.kernel.org,
	dan.j.williams@intel.com, martin.habets@xilinx.com,
	edward.cree@amd.com, davem@davemloft.net, kuba@kernel.org,
	pabeni@redhat.com, edumazet@google.com, richard.hughes@amd.com,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 01/15] cxl: add type2 device basic support
Message-ID: <72858182-c0e6-4c05-a11b-fc137f8f1edb@lunn.ch>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
 <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
Status: O
Content-Length: 329
Lines: 11

> +++ b/include/linux/cxl_accel_mem.h
> @@ -0,0 +1,22 @@
> +/* SPDX-License-Identifier: GPL-2.0 */
> +/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
> +
> +#include <linux/cdev.h>

That is generally a red flag that something not good is about to be
found. But it does not appear to be used in this patch....

       Andrew

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2053.outbound.protection.outlook.com [40.107.243.53])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8001082486;
	Mon, 15 Jul 2024 17:29:13 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.53
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064555; cv=fail; b=HDb4SN2FkQLx6/e2cobBkrRhIStdg93IUNAWMVLV/8nfbqcCbA1IBgGQmbYvBnzsUjYfgDmij0EFvVvEw7yoVdNPLN5ofWnXTwch85lpbiQ9pwBaFAw7GEBlGYaA8SHcXkdGpDb66FL6xeJApb3bQdYLA8hHdFhzyT/cnr8BIOI=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064555; c=relaxed/simple;
	bh=l/+FmP7W4y9wt+tPE2M28dGJ00elP29yEJE2jwO9fiQ=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=QTH1XuTUzLoUH+hJYgUfn0hkq8+X6LhiB5hYXv0IZx3otwhDLElOtFR3CBLv9qm7RGpEzyte5Nz1GyNBHVAavfs0CX8xwW0Lb0hxOaGqu8tw/XTthjF6DB1oj3h0wvQHQddZke6MN/oIwPVR7x6u2QZyMMy9pV+B6C5ckR4BAGo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=nzVqBfxL; arc=fail smtp.client-ip=40.107.243.53
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="nzVqBfxL"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=CGXO476LWRzpLfWpfyQvm28yANeWbEdtwXHp6g+SQ9wxfcT85zH3HUdUKHjaDtz7Nwv98KJ4FblKnz3vcfGTCmmt42Ynmtz41UjoweJq2PB2Xka+ObHyHLQHtVIuDltOn0hWHJsdRJ464vDIQz03qz4QA104V0/cuGX7HWuLYHgEvWwntM0kd8VqBYu1nZJEqWcfDf+b+0+Lg504NvHlpydBllDngOgi2ZIgltI77d7Pec0OuUyOcI4trwoX3ZLt3XsDPGKNZq+q3BDydbx6+Nyyt+51sYBZM1Nm0eI3Gjj7amEGkM75dpfuz8Oi3FjVo0w+5QIMaQ3dPImAeFt02w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=SdujPSOjy/j4GFMNo1rdfTLRyXkFQ36MUwtV/GPAJUU=;
 b=P4p6SEUQmuDoh0RkGUrnyoTQ7S+ydfOuUOkmznBL/bLW5yaHMdzeSiEgHTwnjwERsUIH5tzbkR5VohhaCjWdLteqFmAASQxnQVaPZxoBL0E7uVtUUtf6kZJ21OpFN3YkiNdK2aSzRtWU1/eiOFKKRmvpzh8nPu02tBpmmUx5yNSnMspp6QEztjitADTGbAYbO7wdbrc5Glx6cSVUj+u9nqcZWHGEzGA+EDngkInIMb5a72JLG3Bi0ZsojFQcsj8pk0mhmqUzdqYYNXlso8HL2zqPQWJC4dKUEyb1pLJCNL6I3MqyBT+bfcf4faxjRRcWUVImEz+3SLkTz1gBjZIV1A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=SdujPSOjy/j4GFMNo1rdfTLRyXkFQ36MUwtV/GPAJUU=;
 b=nzVqBfxLYQUFF7kMIKM1HMjmxEmAbijydqeeVS6dxPhaHayWRKZRmk0EdlAvczE1rioKoXPiE/pVTPHEIU2eRrVbYHfBV6v33ENUOYZHlCAmLomF9C6s6qcBbfK5TJlia+dUpjSBg2z6jtAoTEY4yL8/4/3qjQNHghQmaG33bsc=
Received: from BYAPR02CA0021.namprd02.prod.outlook.com (2603:10b6:a02:ee::34)
 by IA0PR12MB8424.namprd12.prod.outlook.com (2603:10b6:208:40c::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29; Mon, 15 Jul
 2024 17:29:06 +0000
Received: from SJ1PEPF000023DA.namprd21.prod.outlook.com
 (2603:10b6:a02:ee:cafe::f3) by BYAPR02CA0021.outlook.office365.com
 (2603:10b6:a02:ee::34) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:29:05 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 SJ1PEPF000023DA.mail.protection.outlook.com (10.167.244.75) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.5 via Frontend Transport; Mon, 15 Jul 2024 17:29:05 +0000
Received: from SATLEXMB05.amd.com (10.181.40.146) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:04 -0500
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB05.amd.com
 (10.181.40.146) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:03 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:29:02 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 14/15] cxl: add function for obtaining params from a region
Date: Mon, 15 Jul 2024 18:28:34 +0100
Message-ID: <20240715172835.24757-15-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB05.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SJ1PEPF000023DA:EE_|IA0PR12MB8424:EE_
X-MS-Office365-Filtering-Correlation-Id: de1c62ff-e12e-4af6-6625-08dca4f3a08d
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|376014|1800799024|36860700013|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?c85xg5TBlfyDHjEsvF0J8UTozPGpoYQyk+Crwva4Fq5UMXJGh3zgaYyhSqy7?=
 =?us-ascii?Q?/ax+uYN+iqXKJcaGafA7ynAygVpGzmDtw8tk4pLXw+tOSUMxdMp9lH/XGBuo?=
 =?us-ascii?Q?Ni9Qvs/BQUNneiwWRfA6PrLqYJx5x4SsLantV7D2D9+cdvPWisTkcuBkD1/4?=
 =?us-ascii?Q?BiRP5R8y8YLZtmnxOJUlZgB3obV61k1SacTBpW2WnE1+AfwYneXZLwkn/xLv?=
 =?us-ascii?Q?FksG0aAWMk1EbkDscSTawd47iB/L0RPb+MrQlIzh6vELDIbi/OHLoRtC6riP?=
 =?us-ascii?Q?uXePleRn5cflXSDVwqstKm5kIRs1G31KnAEw8dR720XVd41g0fV5Xws9Lx34?=
 =?us-ascii?Q?TGHQ0mpFLCVK1tNYH75zDm3TudgKspraHaVHXzQeu71rW9seQADEmuDqQzOI?=
 =?us-ascii?Q?rMw6NdQteDQueYMK5+fqukY3YxD2DzG2flY38FGfqti3vsffVOVw5SHqkPTQ?=
 =?us-ascii?Q?HwO93HWX6xxEnyhrFIOIpfraGNmExwQ3g2HUt64GtrNj5wEdQL6NX8MltMEw?=
 =?us-ascii?Q?U/hhzrU3xHQj4zVfB3EBWd1YGqAWr2xqIGp5G4IO2muR4uFjh7nv+9HYTOXp?=
 =?us-ascii?Q?1Q+63Cpj31n9iWveAlpC0gkqkkUjqmAKOJEA/UiI7rjM5YtKF8m+mhAA+Z6d?=
 =?us-ascii?Q?IdMX/xCPIKFvrECPl4PAA1YBvMAl70NaKjvk8BTwTOVlX47ySlwiTRHMUrvH?=
 =?us-ascii?Q?4shjAYpe8FmsL6jMkQtjjYp1uqIz2lJxLPH7sUhzEsHy0s296SeKns+UpCD+?=
 =?us-ascii?Q?ttIHjrLRw9Z9kkw7KWsZgtQR6aOHhc7dQxytrBAxH+GAV2L6LeSdYg5zjxbi?=
 =?us-ascii?Q?sEgwl891tY8V26Mw8YCA45ZRmzsrZQ2NUh4uHkb6x6rnqcdUAUnuYTr1Rhig?=
 =?us-ascii?Q?xAiPQXM6PvkDRsquyyplNSRWpKIJMj1srmSusTJzr1rXugQrm9Nryq/qNfO1?=
 =?us-ascii?Q?5cE9crcHXMJAxDatyq5R0fNoI9xeP/yN8kN99huD6XAiUm+Y52Y5DaUcv6Rg?=
 =?us-ascii?Q?VtNY1NV2Ooeu6xPXS+cCcRnQYODvrUQ3cdudM6Ig3W/eJrVqs702lmGz+oUY?=
 =?us-ascii?Q?88t3mEqW5FBGVyGfAtnxT7JdWH8A6G0SHUBD0tNHEaAmAhiiTooKpuQ6KjCH?=
 =?us-ascii?Q?GZ0sBqIfrcxevr14/Duv63cf0ZMPDp3P5zhi3QKaliX3Y9oSA5F70p0NFee5?=
 =?us-ascii?Q?ct5R8sJH2WhmeN9lhw9zfGJDAG+KdCQCopZvxl2XOc3yZ91kx2BOEkhU9ihe?=
 =?us-ascii?Q?/3r6QXwzwy8+e3dTKkndvMekFUpi3R/Rjlej2xvka/eKPe5NSynk5VQHrQaF?=
 =?us-ascii?Q?RvCgx/uPRYBses4D4AHq/EKCONKhv7r8rkrNzEIXUQkt6gGaV/iGzF3ZblJ4?=
 =?us-ascii?Q?n5oWztllzNHGf7Cyfr1OgmLeS8/esyFUUkzMvx+btR0mPOzGZxUZx7joXz1A?=
 =?us-ascii?Q?Ovpezc/Xo9o=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(376014)(1800799024)(36860700013)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:29:05.5991
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: de1c62ff-e12e-4af6-6625-08dca4f3a08d
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	SJ1PEPF000023DA.namprd21.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB8424
Status: O
Content-Length: 2245
Lines: 69

From: Alejandro Lucero <alucerop@amd.com>

A CXL region struct contains the physical address to work with.

Add a function for given a opaque cxl region struct returns the params
to be used for mapping such memory range.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/region.c     | 16 ++++++++++++++++
 drivers/cxl/cxl.h             |  3 +++
 include/linux/cxl_accel_mem.h |  2 ++
 3 files changed, 21 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index c8fc14ac437e..9ff10923e9fc 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -3345,6 +3345,22 @@ static int devm_cxl_add_dax_region(struct cxl_region *cxlr)
 	return rc;
 }
 
+int cxl_accel_get_region_params(struct cxl_region *region,
+				resource_size_t *start, resource_size_t *end)
+{
+	if (!region)
+		return -ENODEV;
+
+	if (!region->params.res) {
+		return -ENODEV;
+	}
+	*start = region->params.res->start;
+	*end = region->params.res->end;
+
+	return 0;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_get_region_params, CXL);
+
 static int match_root_decoder_by_range(struct device *dev, void *data)
 {
 	struct range *r1, *r2 = data;
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index 1bf3b74ff959..b4c4c4455ef1 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -906,6 +906,9 @@ void cxl_coordinates_combine(struct access_coordinate *out,
 bool cxl_endpoint_decoder_reset_detected(struct cxl_port *port);
 
 int cxl_region_detach(struct cxl_endpoint_decoder *cxled);
+
+int cxl_accel_get_region_params(struct cxl_region *region,
+				resource_size_t *start, resource_size_t *end);
 /*
  * Unit test builds overrides this to __weak, find the 'strong' version
  * of these symbols in tools/testing/cxl/.
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index a5f9ffc24509..5d715eea6e91 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -53,4 +53,6 @@ struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
 				     int ways);
 
 int cxl_region_detach(struct cxl_endpoint_decoder *cxled);
+int cxl_accel_get_region_params(struct cxl_region *region,
+				resource_size_t *start, resource_size_t *end);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2065.outbound.protection.outlook.com [40.107.93.65])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 572F44D8B1;
	Mon, 15 Jul 2024 17:29:11 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.93.65
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064553; cv=fail; b=rV64B//3DS35k06378TaJvmuucTzLF0RHVZhdhbVo8MQZBmMJYd/josNYQU5Go6CJQ0oXIBYssKRFJ9p/ewTLZ82++Z/OZg72X2yVY2Bh38uTgpYsf91gL43uM8NzjYwRy5XWspiWCAa1JI/wsAFnpt2n59yGbQX2DZ4jMu/5Sg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064553; c=relaxed/simple;
	bh=pPvdLyUcZvGHXVqIIg6J0VgU0IqwiNdrrcApl/+iJiQ=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=PRQsMeBmJai0q6Q7C5GiStijcIDFjRnZnn4TGE8l9rbrbryZuunRAxqqc4hgZyA55nzmeUGd/hbm0PWULKzb4bzEjtEgbK0VzST2JqXDLUxbTGeHTLSYZZOiQHN4OFB1iJEAWvHPDLVKiVdt0LIaF25H04fZyHDvPyktSXB4KX4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=HFqTMk9Y; arc=fail smtp.client-ip=40.107.93.65
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="HFqTMk9Y"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=XkF6PcS4ZkRsU46lcTB3g23YhpiMsomhZ2jr191TfaTNFklQagI/N4vUXNKxe8d8Du3ixybeIM5JAbHVkqAxgQmulw5vENttJ2iLw0xPA2VYir7r/rTsmkBTHitsFvr4qKurlbLkXQVlc8Wv3KWBEcZR92FFni5iU5ymIM7D4qE/vMvF213IpibUNyMO7AOWa7ViOinGlhp6veZVauLeE5xdxnJfnSfyq0Rw/Q8xU+1JizMSoO64NZH5tpaawrWBDK1iTzXLYDJr7PfWHjBHEgx5S+MhevqqLJpUHAOOaO6+Z0ehD1ioIMiY7CdESvCb1SEX+jwUZTmihzv+5ctTrA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=qGyrIBQHmZoiBbIwHpDxe4I8NUNz2zk037VCCPCvC+I=;
 b=MfmK1tE7IyKSylHBFl51Tc/vJUY+Xv4SZHo4Db4Wb3cJETwDorE/fUeoJ0mXqhhtYzv+UN7wM3sPb/2jp7CCMBcYYjk8ruKb9bkYk9Sajo2UMVJpEwlbeGer2DdtVlOgsJbRDlyUEZA4MZvu0fZInxUj/nce+70vkIC7JhBcRRE8jKWE8GVIJqyatW9Z2m44+mSwPdyj2Z2zqXZ7qZGJ1XlfaerK9Pm3EenxvGtlW/MrgGdtWhCfiFi4gPlbruEs+yAeOidBOcvUDxsoFtgqf1Q1gadur1rr8rCSjmuakIzGwr03e+NeKB2JmTpkj78QOMBUA6IOZXh53nV/KO6fmQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=qGyrIBQHmZoiBbIwHpDxe4I8NUNz2zk037VCCPCvC+I=;
 b=HFqTMk9Y8CvElFh9FtKGnlvUiEOK5No3fcHUoM9DciaWLxWe2KxxnPuYntQGjErm4l73M39VHFMMvlH5wejpnMSBwldXm/nINwXvHQumRnI4YzwPdnv0eKUis7to49PP3joxCl5m+xe+NYrXMspgWFDlOYU5gOdRLVBHcf6BmQk=
Received: from CY8PR12CA0045.namprd12.prod.outlook.com (2603:10b6:930:49::16)
 by MN0PR12MB6341.namprd12.prod.outlook.com (2603:10b6:208:3c2::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:29:08 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::ce) by CY8PR12CA0045.outlook.office365.com
 (2603:10b6:930:49::16) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:29:08 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:29:08 +0000
Received: from SATLEXMB05.amd.com (10.181.40.146) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:05 -0500
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB05.amd.com
 (10.181.40.146) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:05 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:29:04 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 15/15] efx: support pio mapping based on cxl
Date: Mon, 15 Jul 2024 18:28:35 +0100
Message-ID: <20240715172835.24757-16-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB05.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|MN0PR12MB6341:EE_
X-MS-Office365-Filtering-Correlation-Id: 562b48ef-12ae-491d-450b-08dca4f3a20e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|36860700013|376014|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?mCDPWET5iNheMoZRwCq0M7jcwO/xrnGScXe1OkUxn+AOBdv1+ZbF9KG9lpCj?=
 =?us-ascii?Q?vxzIBjXyEjxGEge1iitHP1IMbUBU6J6c+bchulrk5CK+Aut3aPegkD23b0gK?=
 =?us-ascii?Q?eBek3CU6buZ+iQZrwOZEox8DLVQB7eiDyf7rT4MY/+OI1OV1PlMXIVXwtPXP?=
 =?us-ascii?Q?parztCCRJk/aTFBBiRmnKU+aOLTTUxDN0KMMv+w5HURD/RGmXHSQmee+XmQp?=
 =?us-ascii?Q?JP6M6RzpYgB1hcoqyCkTnMniQ+p54cq10ZSx4TIeDf2SxwAxAkPMOdrDSPYy?=
 =?us-ascii?Q?R8CusD4v9cXlauWqwntPdLpuqTbbzQlD5QkLp7lbo2zsqCddFYLr4lY0/Cvx?=
 =?us-ascii?Q?mSdhwdw19z0lpdtaKReBjFleJj8T1anO2yJZ8r0scDLvqwHMXom5GFrGjMns?=
 =?us-ascii?Q?b491j/yqxnAmYmrGFs59Y/kuhmwWjK+sv1wEShH1oteInJNLkUQVdieZMP3a?=
 =?us-ascii?Q?SokyNcLpmUT9HIXxEUBG2wKrkmNvu21op/byJdmNi24OA+zHP/CoqtWgxlTw?=
 =?us-ascii?Q?haEiTAAxYsdKTfRxE56D0N8XbODInOe6PNMlQWVSpUjuuezvDFfyWSmT3s+H?=
 =?us-ascii?Q?jg8BeSve+ySTYOBVnoBr1azM41+jf1V6awfMgIbORAVMbUvQaQc1upx/RqeI?=
 =?us-ascii?Q?aBgD/rUv7s2kQuGfHzs5nxpNJsxr2wBq3rjoMX0TrVCzkxT3mYHUWA5JMmP7?=
 =?us-ascii?Q?hmr3M3soktaAeWT0nJlWuIAJ37Clz9W34T0J2PIm2uuoH5tP711PAEfPKvr+?=
 =?us-ascii?Q?eiozDdbx10aNmwM4G9MgEbhoTCip1ppCoJzCzzrCgNhhqEwXWie8ysKaHpqC?=
 =?us-ascii?Q?H4H0lnkwVAhgBeo6I+oMH4s8gpvNl74fklZQFwil98lleCmCk1whyU2ROlkS?=
 =?us-ascii?Q?BMlJUgaI3UV73yQBkiqStI58O4qq154HTVv5fg4xRPw/OhBRtxCf44BlELYf?=
 =?us-ascii?Q?KrCtVCPmgvfwLjQi95KujQb5P2JEIWBbzNsI6NY28c2hNFBt87cmd+dXFEN1?=
 =?us-ascii?Q?lArCf6JKYz2KpolaR46X1v3JH/I8vKu9eyS/LT5cCHsJeu6hAcljsPMo7yqm?=
 =?us-ascii?Q?knk9CBkQrqvn30BxfN+jf632WsTPhlcA2Ev8SavvAVBx3cRVqLAR8gvmbmx6?=
 =?us-ascii?Q?fIEu9YzSxummx6C5bJzadZTaNOAqoJ4zIVllZ3/iTx5tUtcIfF1v0uOYzhe4?=
 =?us-ascii?Q?j/Jqt8/xr7mLEbadxi40IyMY+8EpkotrEpQDTKDa1/8jeklsgQy6A+tADkNy?=
 =?us-ascii?Q?QAZsfS4GmPW4YfHurUvvhoGGnLxwIfhb4PcsHy3YPhXSEXP2qyeB289RNXWS?=
 =?us-ascii?Q?VLTgU2ydL8cbuqNxjpbSaWBkpMg4F3sPQDhi9RqWxVdRtucj8mWjVsw1eWzB?=
 =?us-ascii?Q?XgdIMXu3bJo37Kfugoo0MBZEmBFbL/rx1xLvQvh5jhgxLLfUPLchqanNjcz/?=
 =?us-ascii?Q?5GVGoWgP6BE/nYE8WI7C9zAzhmG2FbBfozD1mVcqzcB1ec4tGy8aqQ=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(36860700013)(376014)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:29:08.1370
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 562b48ef-12ae-491d-450b-08dca4f3a20e
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN0PR12MB6341
Status: O
Content-Length: 4333
Lines: 130

From: Alejandro Lucero <alucerop@amd.com>

With a device supporting CXL and successfully initialised, use the cxl
region to map the memory range and use this mapping for PIO buffers.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/net/ethernet/sfc/ef10.c      | 25 +++++++++++++++++++++----
 drivers/net/ethernet/sfc/efx_cxl.c   | 12 +++++++++++-
 drivers/net/ethernet/sfc/mcdi_pcol.h |  3 +++
 drivers/net/ethernet/sfc/nic.h       |  1 +
 4 files changed, 36 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/sfc/ef10.c b/drivers/net/ethernet/sfc/ef10.c
index 8fa6c0e9195b..3924076d2628 100644
--- a/drivers/net/ethernet/sfc/ef10.c
+++ b/drivers/net/ethernet/sfc/ef10.c
@@ -24,6 +24,7 @@
 #include <linux/wait.h>
 #include <linux/workqueue.h>
 #include <net/udp_tunnel.h>
+#include "efx_cxl.h"
 
 /* Hardware control for EF10 architecture including 'Huntington'. */
 
@@ -177,6 +178,12 @@ static int efx_ef10_init_datapath_caps(struct efx_nic *efx)
 			  efx->num_mac_stats);
 	}
 
+	if (outlen < MC_CMD_GET_CAPABILITIES_V7_OUT_LEN)
+		nic_data->datapath_caps3 = 0;
+	else
+		nic_data->datapath_caps3 = MCDI_DWORD(outbuf,
+						      GET_CAPABILITIES_V7_OUT_FLAGS3);
+
 	return 0;
 }
 
@@ -1275,10 +1282,20 @@ static int efx_ef10_dimension_resources(struct efx_nic *efx)
 			return -ENOMEM;
 		}
 		nic_data->pio_write_vi_base = pio_write_vi_base;
-		nic_data->pio_write_base =
-			nic_data->wc_membase +
-			(pio_write_vi_base * efx->vi_stride + ER_DZ_TX_PIOBUF -
-			 uc_mem_map_size);
+
+		if ((nic_data->datapath_caps3 &
+		    (1 << MC_CMD_GET_CAPABILITIES_V10_OUT_CXL_CONFIG_ENABLE_LBN)) &&
+		    efx->cxl->ctpio_cxl)
+		{
+			nic_data->pio_write_base =
+				efx->cxl->ctpio_cxl +
+				(pio_write_vi_base * efx->vi_stride + ER_DZ_TX_PIOBUF -
+				 uc_mem_map_size);
+		} else {
+			nic_data->pio_write_base =nic_data->wc_membase +
+				(pio_write_vi_base * efx->vi_stride + ER_DZ_TX_PIOBUF -
+				 uc_mem_map_size);
+		}
 
 		rc = efx_ef10_link_piobufs(efx);
 		if (rc)
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 4012e3faa298..8e65ef42a572 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -21,8 +21,8 @@
 void efx_cxl_init(struct efx_nic *efx)
 {
 	struct pci_dev *pci_dev = efx->pci_dev;
+	resource_size_t start, end, max = 0;
 	struct efx_cxl *cxl = efx->cxl;
-	resource_size_t max = 0;
 	struct resource res;
 	u16 dvsec;
 
@@ -104,6 +104,13 @@ void efx_cxl_init(struct efx_nic *efx)
 		return;
 	}
 
+	cxl_accel_get_region_params(cxl->efx_region, &start, &end);
+
+	cxl->ctpio_cxl = ioremap(start, end - start);
+	if (!cxl->ctpio_cxl) {
+		pci_info(pci_dev, "CXL accel create region failed");
+		cxl_dpa_free(cxl->cxled);
+	}
 out:
 	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
 }
@@ -112,6 +119,9 @@ void efx_cxl_exit(struct efx_nic *efx)
 {
 	struct efx_cxl *cxl = efx->cxl;
 
+	if (cxl->ctpio_cxl)
+		iounmap(cxl->ctpio_cxl);
+
 	if (cxl->efx_region)
 		cxl_region_detach(cxl->cxled);
 
diff --git a/drivers/net/ethernet/sfc/mcdi_pcol.h b/drivers/net/ethernet/sfc/mcdi_pcol.h
index cd297e19cddc..05fd5e021142 100644
--- a/drivers/net/ethernet/sfc/mcdi_pcol.h
+++ b/drivers/net/ethernet/sfc/mcdi_pcol.h
@@ -18374,6 +18374,9 @@
 #define        MC_CMD_GET_CAPABILITIES_V10_OUT_DYNAMIC_MPORT_JOURNAL_OFST 148
 #define        MC_CMD_GET_CAPABILITIES_V10_OUT_DYNAMIC_MPORT_JOURNAL_LBN 14
 #define        MC_CMD_GET_CAPABILITIES_V10_OUT_DYNAMIC_MPORT_JOURNAL_WIDTH 1
+#define        MC_CMD_GET_CAPABILITIES_V10_OUT_CXL_CONFIG_ENABLE_OFST 148
+#define        MC_CMD_GET_CAPABILITIES_V10_OUT_CXL_CONFIG_ENABLE_LBN 16
+#define        MC_CMD_GET_CAPABILITIES_V10_OUT_CXL_CONFIG_ENABLE_WIDTH 1
 /* These bits are reserved for communicating test-specific capabilities to
  * host-side test software. All production drivers should treat this field as
  * opaque.
diff --git a/drivers/net/ethernet/sfc/nic.h b/drivers/net/ethernet/sfc/nic.h
index 1db64fc6e909..cd635f4f7f94 100644
--- a/drivers/net/ethernet/sfc/nic.h
+++ b/drivers/net/ethernet/sfc/nic.h
@@ -186,6 +186,7 @@ struct efx_ef10_nic_data {
 	bool must_check_datapath_caps;
 	u32 datapath_caps;
 	u32 datapath_caps2;
+	u32 datapath_caps3;
 	unsigned int rx_dpcpu_fw_id;
 	unsigned int tx_dpcpu_fw_id;
 	bool must_probe_vswitching;
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2054.outbound.protection.outlook.com [40.107.223.54])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BDE3E4D8AE;
	Mon, 15 Jul 2024 17:29:09 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.54
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064552; cv=fail; b=YFTFakeBsLfcXJ8BPoaLa5VJsj42FjLwmVTxLJ3toC/VzYTDvbyoNlRtYbWlCIqgaujdlNllOdSU+I51L/fnKbyKmqRXCGoQL0njS1wDBCBfv4WHlrMycLw39O+cfFsBtA2l9+sviW2I8oQXFAYoZX0FX5YORzB9M93PUFO/rZY=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064552; c=relaxed/simple;
	bh=Pcx01+JoQy6MNS1OD9L/ItqN/D6WPwR+kVqAFX56bI0=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=ewBU6gUwCEjhO5mzIl2XByN2VxCLuC8YnmNy40lVHuaub9TFbX6oQ0qRMH3Epn9PRjhedNYUmLJb+J7et7b/6xjrMdqcn9f3dOKMJQFbsCqZfzpboBQ8ypQljL+XoUsOujl82y1mwc6FqC8sGzuICtSxJ8oDhbJsnXe8w1Lgd0A=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=463E++Es; arc=fail smtp.client-ip=40.107.223.54
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="463E++Es"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=dtnkmjIUY5nM4yjrt+JqYVNesP6la7hDx/Pv0DvCcQ0hQKKwCzN5VDnWzIdJqrn+PjGJEUbUEqW7blwfIlJN8OIdKWvcY361HsvCmHC+rc5KrJdaGVN4Uy1bWcpFtR4YdvyYl/bb7f5xYOIXvs9e8aEJHQ4NMPR9EmWY+7bBDFmEgg5j05WUjQIdtVdGGmPWY6IBp+Obbtm/eBk+KDqJ+Bw3slCTmYdbQgk/PH+X0SmE0mWh5KwPzAvGQoXh7CYAssC30qm2BUbaYIF3sAIFYFL0NrGcoNpV3JcadNPfdowekMqvqkcMj+2ktHzxl5N0Gsvht23CJNziqhn2mQ9qNw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=cgbzVYdE6aZLPnVX/enqasFlmXjMj4PxplaAW0wb364=;
 b=HJEXDJThtBYdTU2Mbwp/xGv/1s8DzC1dOze78UjPsQZC7VlH7zwLq7NG1BqIsFwz81vtKIxHb9yD0RdG+RvEPJ2Iam7+rY0xezKcA0xk/Jvgk/foV02LbrH26mDTPGr0tm6vltUprPfsE3o5OuxW+DagrYLrDCEhX7QcxeAb2mZAu0VBi6edRmoCHYc4n+Vc7EoCQz/m/v6k142BsHCdMx/oFxwVokGcqMoO6jhyqWsWkIM1wgXVCWptCTlo94jCDQXSvzEwYxwC3zPxIGbxXvIF0xxdV9YC72xVgEHZim5IxQv5+9dZc5FguPu2lsmUlcw3vsOTtlZNkpgOms+6Ug==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=cgbzVYdE6aZLPnVX/enqasFlmXjMj4PxplaAW0wb364=;
 b=463E++EsLX8O5d+JbBLSwhAhDu+L1GGHJtBmw+50uKDSk344uNuOeO6Sg8xyYcBRFri51w/bn0OqslwXo335fwTbJc72jSachQZ3lMAQ0dQCcrpyA1yWJMI/mtnq53B6O+jrY5yv3XeI+3XoX1zwL5Nm46cEdklW6/Y7yo4+3kI=
Received: from CY8PR12CA0042.namprd12.prod.outlook.com (2603:10b6:930:49::21)
 by SA1PR12MB6775.namprd12.prod.outlook.com (2603:10b6:806:25a::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7741.36; Mon, 15 Jul
 2024 17:29:05 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::b) by CY8PR12CA0042.outlook.office365.com
 (2603:10b6:930:49::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:29:02 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:29:02 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:00 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:59 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 12/15] cxl: allow region creation by type2 drivers
Date: Mon, 15 Jul 2024 18:28:32 +0100
Message-ID: <20240715172835.24757-13-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|SA1PR12MB6775:EE_
X-MS-Office365-Filtering-Correlation-Id: 61351246-6a4a-4e1e-d30d-08dca4f39e6e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|36860700013|1800799024|82310400026|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?6GBtQwBt2irAOf8Jey778/OFrw7qQRA7wAuvlzYckqD1Cu6XnG6l8uOkkvI1?=
 =?us-ascii?Q?ns8kz00ro9f31kuonr1KhkAKd2RIg1swpKm5x5ZTRrhKDXRBQSo6phBKBee8?=
 =?us-ascii?Q?Inm61OiFAwwqo8jQR0yewGYc46asMtAcobA8nBTHy2ajaWrhknAIJegUBdF2?=
 =?us-ascii?Q?ZVbH1T3JkfyUKiT5ZUlZ8liSEkXYTp0Jx8tyrqP6ivXPyYMwvhF1w9019cOc?=
 =?us-ascii?Q?39IR+cugrrL50KfT0MFXpuinqH1M4q3N5FAv9Yc2FQneVU2jih+7/u+1yrp0?=
 =?us-ascii?Q?M6Ep+aBggm801TqoNi0R/D73FPmjIUl/2tStSnfV5iDTHR+ym1EBLukl1qfg?=
 =?us-ascii?Q?yes+88CE6ZQB5fmCLchUDsDPxu5fLRSxorU7ZSherVo3JNtioEn8662wDXz+?=
 =?us-ascii?Q?IsLP4d8W6FROmxciiFM3BRg7EMt/ZTwIb3gWKUHaciBChT43c0943TlqUb6D?=
 =?us-ascii?Q?ahZ0h8Kvw2tJhq+hG6j01hSNjp6zdOMhrKWWyV4godmE7tyCfDhuIpI52kTU?=
 =?us-ascii?Q?vJDBXd80LBjpsmTeVyp43xrXccvhSlqP20MKCl5mptp8p4PNqXDDJME6uuDX?=
 =?us-ascii?Q?TeN4qestG1sUJln/kqYQw2onhdR2DhHOZWkErcoyQ+YVtSLEL4Tq4CVyxcw0?=
 =?us-ascii?Q?2B2QefOQiJM/lCkTNGOntB2aG1YWReNA3n4qMIPy9ftiib0fYwd+hbEefGhi?=
 =?us-ascii?Q?+J+bbg//cKSSkR4XlMSGyu4cBu2uTI06gYKTLkLNETPHrdXuBHdkEca9ou75?=
 =?us-ascii?Q?Q8X7RVJU6ZJal138mixsutXBU6dtLMeNwlYw3vJeFgLIVeRgV1C+SuKLY1K7?=
 =?us-ascii?Q?tL+FiW6Ge24eL7Eq96xZes6cLkauDAVsgJMTK6Gpt17ZT9T4JEan1VkgCUUc?=
 =?us-ascii?Q?bIfh597sz/v3XetafanpVamsgJbfj5TvF0Cn9mBdfEU6ImQJzvADYEYegq8H?=
 =?us-ascii?Q?cMoWGuG6MNQbBVkUe69Ucvp3LfScZH5+IcAFgt1LJf+04PpKwJ63GYZZfil8?=
 =?us-ascii?Q?EmTsrs876p76AtDpc7kFKRyydtpETcz+TUqQneUpSyuyIgGSh+KZ5GsGlYh7?=
 =?us-ascii?Q?V3pUp3HNM8r1EtyxTWzw73Ep0iFBrcEa3wFpQo5TIPlzn+oP++dcB1gax4Jk?=
 =?us-ascii?Q?+5WadVC6ikdHxXpE8IrXlknWw4B+RBRHjnl9e3861UX1KMSPM9LBhAQTec2W?=
 =?us-ascii?Q?8tnpfqYLUophNX2fKUcuhBty8g5sbe0rzDr1FzQXG9mJx6ZrzRGe1oaVwKa7?=
 =?us-ascii?Q?4bRSFK1qiBK/YY5lUS0hZDTuPn/oZi8m5oHTB+vLgdKGXUAv1xJMdftp9Foc?=
 =?us-ascii?Q?VqjM8fIviPmOy6GsSEcY6Xr2053qOiWVTUBE+CTvz7vFfk2DoKEe9P9Z5XCq?=
 =?us-ascii?Q?lnKjVjsvWDAiuoZorYzE89YnUrEPF9sE4jrgUaTyHIqKJiV27Q=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(36860700013)(1800799024)(82310400026)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:29:02.0589
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 61351246-6a4a-4e1e-d30d-08dca4f39e6e
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB6775
Status: O
Content-Length: 14597
Lines: 506

From: Alejandro Lucero <alucerop@amd.com>

Creating a CXL region requires userspace intervention through the cxl
sysfs files. Type2 support should allow accelerator drivers to create
such cxl region from kernel code.

Adding that functionality and integrating it with current support for
memory expanders.

Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m84598b534cc5664f5bb31521ba6e41c7bc213758
Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c          | 265 ++++++++++++++++++++++-------
 drivers/cxl/cxl.h                  |   1 +
 drivers/cxl/cxlmem.h               |   4 +-
 drivers/net/ethernet/sfc/efx_cxl.c |  15 +-
 include/linux/cxl_accel_mem.h      |   5 +
 5 files changed, 231 insertions(+), 59 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 5cc71b8868bc..697c8df83a4b 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -479,22 +479,14 @@ static ssize_t interleave_ways_show(struct device *dev,
 
 static const struct attribute_group *get_cxl_region_target_group(void);
 
-static ssize_t interleave_ways_store(struct device *dev,
-				     struct device_attribute *attr,
-				     const char *buf, size_t len)
+static int set_interleave_ways(struct cxl_region *cxlr, int val)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
 	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
-	struct cxl_region *cxlr = to_cxl_region(dev);
 	struct cxl_region_params *p = &cxlr->params;
-	unsigned int val, save;
-	int rc;
+	int save, rc;
 	u8 iw;
 
-	rc = kstrtouint(buf, 0, &val);
-	if (rc)
-		return rc;
-
 	rc = ways_to_eiw(val, &iw);
 	if (rc)
 		return rc;
@@ -509,25 +501,42 @@ static ssize_t interleave_ways_store(struct device *dev,
 		return -EINVAL;
 	}
 
-	rc = down_write_killable(&cxl_region_rwsem);
-	if (rc)
-		return rc;
-	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		rc = -EBUSY;
-		goto out;
-	}
+	lockdep_assert_held_write(&cxl_region_rwsem);
+	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
+		return -EBUSY;
 
 	save = p->interleave_ways;
 	p->interleave_ways = val;
 	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
 	if (rc)
 		p->interleave_ways = save;
-out:
+
+	return rc;
+}
+
+static ssize_t interleave_ways_store(struct device *dev,
+				     struct device_attribute *attr,
+				     const char *buf, size_t len)
+{
+	struct cxl_region *cxlr = to_cxl_region(dev);
+	unsigned int val;
+	int rc;
+
+	rc = kstrtouint(buf, 0, &val);
+	if (rc)
+		return rc;
+
+	rc = down_write_killable(&cxl_region_rwsem);
+	if (rc)
+		return rc;
+
+	rc = set_interleave_ways(cxlr, val);
 	up_write(&cxl_region_rwsem);
 	if (rc)
 		return rc;
 	return len;
 }
+
 static DEVICE_ATTR_RW(interleave_ways);
 
 static ssize_t interleave_granularity_show(struct device *dev,
@@ -547,21 +556,14 @@ static ssize_t interleave_granularity_show(struct device *dev,
 	return rc;
 }
 
-static ssize_t interleave_granularity_store(struct device *dev,
-					    struct device_attribute *attr,
-					    const char *buf, size_t len)
+static int set_interleave_granularity(struct cxl_region *cxlr, int val)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
 	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
-	struct cxl_region *cxlr = to_cxl_region(dev);
 	struct cxl_region_params *p = &cxlr->params;
-	int rc, val;
+	int rc;
 	u16 ig;
 
-	rc = kstrtoint(buf, 0, &val);
-	if (rc)
-		return rc;
-
 	rc = granularity_to_eig(val, &ig);
 	if (rc)
 		return rc;
@@ -577,21 +579,36 @@ static ssize_t interleave_granularity_store(struct device *dev,
 	if (cxld->interleave_ways > 1 && val != cxld->interleave_granularity)
 		return -EINVAL;
 
+	lockdep_assert_held_write(&cxl_region_rwsem);
+	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
+		return -EBUSY;
+
+	p->interleave_granularity = val;
+	return 0;
+}
+
+static ssize_t interleave_granularity_store(struct device *dev,
+					    struct device_attribute *attr,
+					    const char *buf, size_t len)
+{
+	struct cxl_region *cxlr = to_cxl_region(dev);
+	int rc, val;
+
+	rc = kstrtoint(buf, 0, &val);
+	if (rc)
+		return rc;
+
 	rc = down_write_killable(&cxl_region_rwsem);
 	if (rc)
 		return rc;
-	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		rc = -EBUSY;
-		goto out;
-	}
 
-	p->interleave_granularity = val;
-out:
+	rc = set_interleave_granularity(cxlr, val);
 	up_write(&cxl_region_rwsem);
 	if (rc)
 		return rc;
 	return len;
 }
+
 static DEVICE_ATTR_RW(interleave_granularity);
 
 static ssize_t resource_show(struct device *dev, struct device_attribute *attr,
@@ -2193,7 +2210,7 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 	return 0;
 }
 
-static int cxl_region_detach(struct cxl_endpoint_decoder *cxled)
+int cxl_region_detach(struct cxl_endpoint_decoder *cxled)
 {
 	struct cxl_port *iter, *ep_port = cxled_to_port(cxled);
 	struct cxl_region *cxlr = cxled->cxld.region;
@@ -2252,6 +2269,7 @@ static int cxl_region_detach(struct cxl_endpoint_decoder *cxled)
 	put_device(&cxlr->dev);
 	return rc;
 }
+EXPORT_SYMBOL_NS_GPL(cxl_region_detach, CXL);
 
 void cxl_decoder_kill_region(struct cxl_endpoint_decoder *cxled)
 {
@@ -2746,6 +2764,14 @@ cxl_find_region_by_name(struct cxl_root_decoder *cxlrd, const char *name)
 	return to_cxl_region(region_dev);
 }
 
+static void drop_region(struct cxl_region *cxlr)
+{
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
+	struct cxl_port *port = cxlrd_to_port(cxlrd);
+
+	devm_release_action(port->uport_dev, unregister_region, cxlr);
+}
+
 static ssize_t delete_region_store(struct device *dev,
 				   struct device_attribute *attr,
 				   const char *buf, size_t len)
@@ -3353,17 +3379,18 @@ static int match_region_by_range(struct device *dev, void *data)
 	return rc;
 }
 
-/* Establish an empty region covering the given HPA range */
-static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
-					   struct cxl_endpoint_decoder *cxled)
+static void construct_region_end(void)
+{
+	up_write(&cxl_region_rwsem);
+}
+
+static struct cxl_region *construct_region_begin(struct cxl_root_decoder *cxlrd,
+						 struct cxl_endpoint_decoder *cxled)
 {
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
-	struct cxl_port *port = cxlrd_to_port(cxlrd);
-	struct range *hpa = &cxled->cxld.hpa_range;
 	struct cxl_region_params *p;
 	struct cxl_region *cxlr;
-	struct resource *res;
-	int rc;
+	int err = 0;
 
 	do {
 		cxlr = __create_region(cxlrd, cxled->mode,
@@ -3372,8 +3399,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
 
 	if (IS_ERR(cxlr)) {
-		dev_err(cxlmd->dev.parent,
-			"%s:%s: %s failed assign region: %ld\n",
+		dev_err(cxlmd->dev.parent,"%s:%s: %s failed assign region: %ld\n",
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
 			__func__, PTR_ERR(cxlr));
 		return cxlr;
@@ -3383,23 +3409,47 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 	p = &cxlr->params;
 	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
 		dev_err(cxlmd->dev.parent,
-			"%s:%s: %s autodiscovery interrupted\n",
+			"%s:%s: %s region setup interrupted\n",
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
 			__func__);
-		rc = -EBUSY;
-		goto err;
+		err = -EBUSY;
+	}
+
+	if (err) {
+		construct_region_end();
+		drop_region(cxlr);
+		return ERR_PTR(err);
 	}
+	return cxlr;
+}
+
+
+/* Establish an empty region covering the given HPA range */
+static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
+					   struct cxl_endpoint_decoder *cxled)
+{
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct range *hpa = &cxled->cxld.hpa_range;
+	struct cxl_region_params *p;
+	struct cxl_region *cxlr;
+	struct resource *res;
+	int rc;
+
+	cxlr = construct_region_begin(cxlrd, cxled);
+	if (IS_ERR(cxlr))
+		return cxlr;
 
 	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
 
 	res = kmalloc(sizeof(*res), GFP_KERNEL);
 	if (!res) {
 		rc = -ENOMEM;
-		goto err;
+		goto out;
 	}
 
 	*res = DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
 				    dev_name(&cxlr->dev));
+
 	rc = insert_resource(cxlrd->res, res);
 	if (rc) {
 		/*
@@ -3412,6 +3462,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 			 __func__, dev_name(&cxlr->dev));
 	}
 
+	p = &cxlr->params;
 	p->res = res;
 	p->interleave_ways = cxled->cxld.interleave_ways;
 	p->interleave_granularity = cxled->cxld.interleave_granularity;
@@ -3419,24 +3470,124 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 
 	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
 	if (rc)
-		goto err;
+		goto out;
 
 	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
-		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
-		dev_name(&cxlr->dev), p->res, p->interleave_ways,
-		p->interleave_granularity);
+				   dev_name(&cxlmd->dev),
+				   dev_name(&cxled->cxld.dev), __func__,
+				   dev_name(&cxlr->dev), p->res,
+				   p->interleave_ways,
+				   p->interleave_granularity);
 
 	/* ...to match put_device() in cxl_add_to_region() */
 	get_device(&cxlr->dev);
 	up_write(&cxl_region_rwsem);
+out:
+	construct_region_end();
+	if (rc) {
+		drop_region(cxlr);
+		return ERR_PTR(rc);
+	}
+	return cxlr;
+}
+
+static struct cxl_region *
+__construct_new_region(struct cxl_root_decoder *cxlrd,
+		       struct cxl_endpoint_decoder **cxled, int ways)
+{
+	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
+	struct cxl_region_params *p;
+	resource_size_t size = 0;
+	struct cxl_region *cxlr;
+	int rc, i;
+
+	/* If interleaving is not supported, why does ways need to be at least 1? */
+	if (ways < 1)
+		return ERR_PTR(-EINVAL);
+
+	cxlr = construct_region_begin(cxlrd, cxled[0]);
+	if (IS_ERR(cxlr))
+		return cxlr;
+
+	rc = set_interleave_ways(cxlr, ways);
+	if (rc)
+		goto out;
+
+	rc = set_interleave_granularity(cxlr, cxld->interleave_granularity);
+	if (rc)
+		goto out;
+
+	down_read(&cxl_dpa_rwsem);
+	for (i = 0; i < ways; i++) {
+		if (!cxled[i]->dpa_res)
+			break;
+		size += resource_size(cxled[i]->dpa_res);
+	}
+	up_read(&cxl_dpa_rwsem);
+
+	if (i < ways)
+		goto out;
+
+	rc = alloc_hpa(cxlr, size);
+	if (rc)
+		goto out;
+
+	down_read(&cxl_dpa_rwsem);
+	for (i = 0; i < ways; i++) {
+		rc = cxl_region_attach(cxlr, cxled[i], i);
+		if (rc)
+			break;
+	}
+	up_read(&cxl_dpa_rwsem);
+
+	if (rc)
+		goto out;
+
+	rc = cxl_region_decode_commit(cxlr);
+	if (rc)
+		goto out;
 
+	p = &cxlr->params;
+	p->state = CXL_CONFIG_COMMIT;
+out:
+	construct_region_end();
+	if (rc) {
+		drop_region(cxlr);
+		return ERR_PTR(rc);
+	}
 	return cxlr;
+}
 
-err:
-	up_write(&cxl_region_rwsem);
-	devm_release_action(port->uport_dev, unregister_region, cxlr);
-	return ERR_PTR(rc);
+/**
+ * cxl_create_region - Establish a region given an array of endpoint decoders
+ * @cxlrd: root decoder to allocate HPA
+ * @cxled: array of endpoint decoders with reserved DPA capacity
+ * @ways: size of @cxled array
+ *
+ * Returns a fully formed region in the commit state and attached to the
+ * cxl_region driver.
+ */
+struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
+				     struct cxl_endpoint_decoder **cxled,
+				     int ways)
+{
+	struct cxl_region *cxlr;
+
+	mutex_lock(&cxlrd->range_lock);
+	cxlr = __construct_new_region(cxlrd, cxled, ways);
+	mutex_unlock(&cxlrd->range_lock);
+
+	if (IS_ERR(cxlr))
+		return cxlr;
+
+	if (device_attach(&cxlr->dev) <= 0) {
+		dev_err(&cxlr->dev, "failed to create region\n");
+		drop_region(cxlr);
+		return ERR_PTR(-ENODEV);
+	}
+	return cxlr;
 }
+EXPORT_SYMBOL_NS_GPL(cxl_create_region, CXL);
 
 int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
 {
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index d3fdd2c1e066..1bf3b74ff959 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -905,6 +905,7 @@ void cxl_coordinates_combine(struct access_coordinate *out,
 
 bool cxl_endpoint_decoder_reset_detected(struct cxl_port *port);
 
+int cxl_region_detach(struct cxl_endpoint_decoder *cxled);
 /*
  * Unit test builds overrides this to __weak, find the 'strong' version
  * of these symbols in tools/testing/cxl/.
diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
index a0e0795ec064..377bb3cd2d47 100644
--- a/drivers/cxl/cxlmem.h
+++ b/drivers/cxl/cxlmem.h
@@ -881,5 +881,7 @@ struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
 					       int interleave_ways,
 					       unsigned long flags,
 					       resource_size_t *max);
-
+struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
+				     struct cxl_endpoint_decoder **cxled,
+				     int ways);
 #endif /* __CXL_MEM_H__ */
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index b5626d724b52..4012e3faa298 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -92,8 +92,18 @@ void efx_cxl_init(struct efx_nic *efx)
 
 	cxl->cxled = cxl_request_dpa(cxl->endpoint, true, EFX_CTPIO_BUFFER_SIZE,
 				     EFX_CTPIO_BUFFER_SIZE);
-	if (IS_ERR(cxl->cxled))
+	if (IS_ERR(cxl->cxled)) {
 		pci_info(pci_dev, "CXL accel request DPA failed");
+		return;
+	}
+
+	cxl->efx_region = cxl_create_region(cxl->cxlrd, &cxl->cxled, 1);
+	if (!cxl->efx_region) {
+		pci_info(pci_dev, "CXL accel create region failed");
+		cxl_dpa_free(cxl->cxled);
+		return;
+	}
+
 out:
 	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
 }
@@ -102,6 +112,9 @@ void efx_cxl_exit(struct efx_nic *efx)
 {
 	struct efx_cxl *cxl = efx->cxl;
 
+	if (cxl->efx_region)
+		cxl_region_detach(cxl->cxled);
+
 	if (cxl->cxled)
 		cxl_dpa_free(cxl->cxled);
  
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index d4ecb5bb4fc8..a5f9ffc24509 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -48,4 +48,9 @@ struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
 					     resource_size_t min,
 					     resource_size_t max);
 int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
+struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
+				     struct cxl_endpoint_decoder **cxled,
+				     int ways);
+
+int cxl_region_detach(struct cxl_endpoint_decoder *cxled);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (mail-mw2nam04on2089.outbound.protection.outlook.com [40.107.101.89])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 50C764D5BD;
	Mon, 15 Jul 2024 17:29:10 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.101.89
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064551; cv=fail; b=k5BLQbSXqvjh7vCkwH59EiazdOU/qlAnfTyzYB/flGHgUa4JwF98Q2AZrKdv8BsBlqT4y8mhdFB5WIiSl6ZpDv2c0bx3fnVhUQsloWwlv4xo8SGdLxp49k0Kw5D623HcPSGESOsVLxwL3ZkGcCcIFKeuuv16XLSdIpCR1m4o4CA=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064551; c=relaxed/simple;
	bh=BakCz81xtmBSGDdcYNKcYSvgjSlGriobi6063kHj8mo=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=trh2OTDQ9PrryDhBynzcYBrFOjfBomWj3F0PlkNlTu5t79TyFSr0yZtLhn2JYUzMc7sDZ8Sgyf0MOu3A/pGPyqPBxr+ZN4fZi8dGqQclkLJBz+dI8jqyhTbEBmL6YobKR92+WPf9joit8nORDIz8eTKHSRCSU9AlQXKH0omRhSw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=4NOj26nT; arc=fail smtp.client-ip=40.107.101.89
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="4NOj26nT"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=LcOl9HVIjC/fsWVQva8HQAbA6DcmUqGNMj37oszPwFTbWTie3VMF369g3A0vA09QBQBkYNTdILqCZAXXCzltK3cMd2uw2ilN9wMuszH99t9KmtReBdh8Fb2TOjhVLQqnTd9PW2WKvBCU2jIV6IllbLFZQgeep3wArKSZXIl9TvEw2H713CjkqDfUCbuaJBKOPLwCEmxi08wKAFVjNVT7Y8fNMZ1iwq4Kehji/iJhcc5DypIaLh+WbYuWwC5eL2gJXyueLgrjVmtxOThordqSufQ7/cR2TRURiXFtqVLqtbmlJrArhs5sqzToLPUxr30wcN5zJ6YidyIQEp0uxrfMiQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=N/Fw9yqq9m7TDHJciSAzr376wo3U1OJY+js4w4DOIRs=;
 b=VYjRjFtawXFuJ/YGOBqHw/Wh0f32IwHxdUtYs/nzuurmmglVRAO4qcgzjh+kPkDle/dthbVF/FuUxw6OdBrKwYUB/jOd0UksewQ5kIHW/JOEf18sMIjQMcuKOAWtImAakl7lkVFgHQMJpXDjXpPXysQodOunuvb28IjJoZ05rB8CESvsN4dvYbagB3XcA7lO42AdzBHIjSWlieX5nHRRY68eT0j+fhV8gg+jncDQyZ2Ub8YeZw6+zPYPHEYLqN6B13ER1PJBz5hhKPX0PDNKW0UtwilFuBHriKMrul3CuK66lmbKOaI5pASPyP9vA9m6kiseqFdph3wr/4dzQv+XCw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=N/Fw9yqq9m7TDHJciSAzr376wo3U1OJY+js4w4DOIRs=;
 b=4NOj26nT+TqObBe8JSJuZXoeFeSARESEyGXTDI4ZaDxqZHRvmYLhL8rZMV7gBoYdOLgt0x9gOAzrVrQWWks31JmwKhIwPxfAfJvs4KvSOgtkgGaKRmTeIkDHi05Ap/c4rLqPqzknPXmKBgy5FzxbRi3FCQ+2az8xj08RL0auR3w=
Received: from CY8PR12CA0042.namprd12.prod.outlook.com (2603:10b6:930:49::21)
 by IA0PR12MB9047.namprd12.prod.outlook.com (2603:10b6:208:402::8) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29; Mon, 15 Jul
 2024 17:29:06 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::67) by CY8PR12CA0042.outlook.office365.com
 (2603:10b6:930:49::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:29:06 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:29:06 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:29:02 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:29:00 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucero@os3sl.com>, Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 13/15] cxl: preclude device memory to be used for dax
Date: Mon, 15 Jul 2024 18:28:33 +0100
Message-ID: <20240715172835.24757-14-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|IA0PR12MB9047:EE_
X-MS-Office365-Filtering-Correlation-Id: 3420371f-7b18-4c8f-1820-08dca4f3a0dd
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|1800799024|36860700013|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?Uv8GkJkq5mQhqOCKJu6QRGRq2dDWukNvo7C6//Kniraw1mXt/5vHGbmjcz56?=
 =?us-ascii?Q?g1qfHIhhrzELVMDviQWNNKr5kvnLc0YRm9Smr9TalaypElrytVHQy3Me9yIS?=
 =?us-ascii?Q?oEUUDtdhvA3EUGMpfsZ8A/vPG1KvCujc8UKtelpMhvnYx1/TBQgwgB8M+f33?=
 =?us-ascii?Q?pqK6DabuZXeqNsQ+QNfAxFtFuEF6l5ar45bHojzJtqG3pu6nSbcWNZZG3UXr?=
 =?us-ascii?Q?86rIdIx1Dn6mPH4vJA3HaKUFsbsBYOZiys0SEjIUxD5dDCykgsVG6D9IZV5a?=
 =?us-ascii?Q?AGnJ3sIg9/tmlFEuEt7i9kVxU9sciKgpgzqEfXiHyVOj5fFuXJ8UtDGOaswn?=
 =?us-ascii?Q?5SQZ73id5V/m5h4QIwOFG43dJbXRhUbJZnj1EdHUx7dS+kHT7lpwmX84Jr80?=
 =?us-ascii?Q?MUKwwzCzbj8WzjXrLLRyXG4ud6MY8wB626hcMESq9oEHgrv1fi9AlTLqw/3a?=
 =?us-ascii?Q?yOYZ6a/R+zmpgwVomQAPYFVUqYURoEeFDjlaIxelPT8VBzX25WpGNw889IHJ?=
 =?us-ascii?Q?WH7P7OqZVVbQshFH8VV2/JfZffCvZMuZBuPhsIQMsgBTYnPeSSaQ8LMv0Ruw?=
 =?us-ascii?Q?s+OPMeSk7yfqsE43dmS8I6KwVd8iT+xZ55LKjgeAPb/HDqLZdT2oyC8eoFur?=
 =?us-ascii?Q?ME8Mcofh4EAXn3UtTPWFkh1dYMrhiyP2x+Snt9oQzAmf+3jaiJfIozGNd5UF?=
 =?us-ascii?Q?e/NzS5IFpRUe0hON4FllllQMRK6UNKlPbi3+Tm3eZe26RM3v5EhbUpN9W7wj?=
 =?us-ascii?Q?/Er2yzWKwgkGhuvXr6EN2oCbW7mc8pRDfCQRcNYz65xTJe9gzlVVoOUl3fiU?=
 =?us-ascii?Q?52bq1I+W7ca1mt/FofTjSYPGZkEaPoOtLDCFvP9+E23XTChPE+LTwn962ShO?=
 =?us-ascii?Q?rIldOzR+r9wLLiVca3lRxycqNNpsTKLPtVF8aPmlRM5FUiLaiWacX1QLWrUZ?=
 =?us-ascii?Q?WZ1smYpsfpSRDWe3iNWq9WtMI6/6Y9AJXX0xWmgJaajt+PXyqaWbcIm/Fybi?=
 =?us-ascii?Q?Sbe3xvTthrA1CwaUngT9Suq1FGkTp+KY90AJryuBQnd4WPLfYstS113zEjiw?=
 =?us-ascii?Q?nTKWgP27dCgtXYToYiyWNABFMlXiKRkTuBTQbfTl/dSvJAk2VXDjsek/m1fZ?=
 =?us-ascii?Q?2aIM9ud7oSyxX2gI8C0xrbnHuCpWizmnOpPtzMM9JNVFQXR7HIj8FUmqU7mn?=
 =?us-ascii?Q?Ziw88aNseLi0wDrsonQ+Mo4YaOaL8GrQJWjdRsThkGwwFLp3NXrlZxqOsJli?=
 =?us-ascii?Q?KTlDi5mnOnJSKQqQSrcJUHEZtvohlJkjCCVNuZu3XOsIxRWAgqJeGSlZWdtz?=
 =?us-ascii?Q?NcwUH/TmBYCORlVjToAaZw0RmQX6n3V3obUGJKAtDa9Tfmu4FTPJxcmT/hMG?=
 =?us-ascii?Q?rYqz6at/77OopeZB3t0Vh5nGSwtPmHEXHQdJ5t2gWyz+Cvpz8MUHNN5c/ig1?=
 =?us-ascii?Q?ko0A1isSZr7AjZge/zAzU8FeP7kARH55+jxHZHIjElbmSeQZ2K8d3Q=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(1800799024)(36860700013)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:29:06.1370
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 3420371f-7b18-4c8f-1820-08dca4f3a0dd
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB9047
Status: O
Content-Length: 830
Lines: 28

From: Alejandro Lucero <alucero@os3sl.com>

By definition a type2 cxl device will use the host managed memory for
specific functionality, therefore it should not be available to other
uses.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/region.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 697c8df83a4b..c8fc14ac437e 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -3704,6 +3704,9 @@ static int cxl_region_probe(struct device *dev)
 	case CXL_DECODER_PMEM:
 		return devm_cxl_add_pmem_region(cxlr);
 	case CXL_DECODER_RAM:
+		if (cxlr->type != CXL_DECODER_HOSTONLYMEM)
+			return 0;
+
 		/*
 		 * The region can not be manged by CXL if any portion of
 		 * it is already online as 'System RAM'
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2074.outbound.protection.outlook.com [40.107.223.74])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 20A5171B3A;
	Mon, 15 Jul 2024 17:29:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.74
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064545; cv=fail; b=XYL+FU5toyWZ//C+dawXbRt8eSLbO/jLOjMucf5mZSr5yZ4NFlozLlruhseVTFci7hHdIeFcZR7g1gsJbXE+kpEWUnIzitPpwTC4cAOrWd9uFtoMKB2jLsE9rqNJMXddUaLM5opgJyMCSxWXCAfdPXaeMX/161tTAk03B9py910=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064545; c=relaxed/simple;
	bh=qgWS3BfT14ZBavTF8bZ0VMsweurB3s2FqgLcm22BZr8=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=M248xshtNQTr0CGoQT8UoekE7nRcRm6Fl7mc/wTusyrnG4E08L5YjJxuIWrgET52ujiLOVEPtWF3SfFhbfYNCqQqg3n9rgEd/3P5ImLWbBto+u8Y0oyxTcFq34BwwQBZ9IT6gFRGj0Dvhr3nYCog9XK2UOFRwv81jpcU4qKqtHo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=lQkuLVOQ; arc=fail smtp.client-ip=40.107.223.74
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="lQkuLVOQ"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=RXQf5tCwLd6waYAu799YkA1IbM4FAS4YTs+X71jkNyIAfi6+ZfwtIhHNpug8Csv4gQtIIc8nEq2j/3w1OtE1Xk7Sps4/BePayzTFi2INozBYPVCx8yEQWRzE79n0VAAdQSBdRthxwvUU+iRtj1qkbaFd5C+HsiuLz8Qu+w1Z3iBPynYXv84sfUFmHBLyLB7Xc3tdmNwJzu8WsO0iRTZkXG3ASyVlDY4Cc98UKOJh7bndcavQA2kqzZnMT/sAOlJIvuvyjiZXc4mPfy4XpZaCWJOvRmDrWVIIwm7Zvce4EA5/FDAl2bKvE5NAPaUYj7yZis7Fv3ClZPxwyYvgFrXvCg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Dizz2TTkzDjjd1y2eDQGqIAEiQuyoYn0IDgCcbZi8F4=;
 b=MqOe0Lz43X7WO+Ho4u/eJBRdL3tl8Uz/q7GWs4Ef5AF3/NTI4kCSX6aEw9jkgrbAp4nQqzhYCMBqWFlHLqxmZxqpb1jtjQ4qh2nfTa2R82XegnRC7msDv7fZDR/rV4xd4QGxTZosSjx1c7hOcCIszSbN75c20mf+ysFk4i5WLePqKL4dAeepT7Us2HkGI/j7e25GnlSEbxFxPtEOIMeH6/Drjiuz/neNONJfmKii414lVyBuRDPI73MpmFTLXu3dulwqMu5hSTpdEN5BUtcpxy7H/kNNAKbv14gnh/dLhW0lDYkjwb52R4O3DzaUisCa+E1lvnzOb2gukaq9hMzjGA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Dizz2TTkzDjjd1y2eDQGqIAEiQuyoYn0IDgCcbZi8F4=;
 b=lQkuLVOQq+RDmO2KuRFHBlqw7rVODxLROkzEO0cQS9vq2Ta+ddqtSzBBfheTs8WmO+B5sE9jUqULB5zgE12LEtRXXJl9gXh61DW7KIweftCUWWyTNpzmdrmJrZJsV7SIrzWMgzpKtwYJ1wryR124aYCkWvXDneXNAf0lBz4ahyc=
Received: from CY8PR12CA0047.namprd12.prod.outlook.com (2603:10b6:930:49::20)
 by DM4PR12MB5939.namprd12.prod.outlook.com (2603:10b6:8:6a::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29; Mon, 15 Jul
 2024 17:28:58 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::e) by CY8PR12CA0047.outlook.office365.com
 (2603:10b6:930:49::20) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:58 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:58 +0000
Received: from SATLEXMB06.amd.com (10.181.40.147) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:56 -0500
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB06.amd.com
 (10.181.40.147) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:56 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:55 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 09/15] cxl: define a driver interface for HPA free space enumaration
Date: Mon, 15 Jul 2024 18:28:29 +0100
Message-ID: <20240715172835.24757-10-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|DM4PR12MB5939:EE_
X-MS-Office365-Filtering-Correlation-Id: 1e34b7c1-e34f-4764-a086-08dca4f39c13
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|376014|1800799024|36860700013|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?TWVncFB5WCtvTXpRdWR6UHRNb0dFeFhYajBLUVZTYUZuT2VGSjJKQm1xVXI4?=
 =?utf-8?B?WUVSRFFYc2ZpVys2dmFySDVtbC8xbS9xbjRuU3pTaXUxTGo0Vy9zcU5UTUlG?=
 =?utf-8?B?b2VQdmdhY1BjWUp2SkpXTTAxM3Q5cW00WWhXTllpd0d6R3BNd2QwYzdScVdJ?=
 =?utf-8?B?YUJsTDhUa0JRaVJERDB1bjJkM2VITUovK0RpdlFNcUVsbjFxQ1F4TG13OGg5?=
 =?utf-8?B?ZVl2QlV6c1ZsamV3bXgwdzV6Q1UrcnZoYmZzdVVhSTBZR1pvd1Q3aFl1VFN4?=
 =?utf-8?B?dmM3bkFld1EvSEVvbEIzUG9hRFYvdkhHS2FURWsxNE82RGVqTXlZNHdVU2g0?=
 =?utf-8?B?cjBLVHo0Z2hhcFl2Zy9mVjhZTU14a1JocUVEMWkvam0wZGVQakdjdVI4NHB4?=
 =?utf-8?B?M1ovOWU4Z3BJY0FGWVBnOFVXejFHYjVWT0xYdVVZZGRhSmt3VXdBL3BBdzc2?=
 =?utf-8?B?RlpzOEV2WS9RRi9laDAweTdNaDJPeFNaaUl4TktkNHhkZFg2eG5aWU1aK2pP?=
 =?utf-8?B?WllkVmhIeUxVekNzQXEzVk1xd1dycmZVampXWG0xNSsxdDRSYXc0Y1ZiL1lH?=
 =?utf-8?B?ZUtEZ3JubndSYlNYZHZxeDNJTTg1MWZwSER0YVpVUnJGUzBYQWVTOU1vR0U0?=
 =?utf-8?B?dTNVUWVuUE4wSGZGU3NrSEt3WlRjK1NmR0pCYWVLdXN4WEpxSFB3ZGpSalB2?=
 =?utf-8?B?aU5NUXUxSHpMTnJGTDRsZ1ZIS2FzWEpVZFNtdTNnZFQ4dkVNNEszUGdKa0hX?=
 =?utf-8?B?TXdCMGprRXNpQ3p6NnFFbEx6QUY5V08xYU5EamF0cU5mZG9ybUorOHJkTjRi?=
 =?utf-8?B?bVluZ041bkRHZDEwYlExRitPQk5WcFdzcDYvQk5DL3l6d0ZLUDUxVVRrUEEr?=
 =?utf-8?B?S0g4ZTJwa256Z2RJTWQ5bUdBNU5pREpkWjNmSW16MkE0WW9ONDlRTWR5SFc3?=
 =?utf-8?B?NFlNazFzRTVKS0I5eStUR2Q5YXRHSERXYlQwR0tMQ3JYbjZwWTZSTEYrR1Fx?=
 =?utf-8?B?VlZnQ0R1aEIrd0lzemRZbHZGT3hJZGo3eTluaTBRWFFnZm5QRTh0U05mc2NM?=
 =?utf-8?B?dUQzV3NEUXJOUTBsVVJrTWhiRGo4NmxQUjJldC8vSFY3UmRxOUVGSTl3TFV6?=
 =?utf-8?B?SUVSYnRlS1E2Z2huZlZkamdjUUZOU3k1UnZaRFF1K29zSUpTNk9DVjRzaXkw?=
 =?utf-8?B?RDVBemxySGx4L3R6WUZud1dkWEgwVEVwclZENFhvdHlRTkpsdkRSWHVLdzF3?=
 =?utf-8?B?dDJMa1BlUGZpSndRK1hZM3RCR2pGOHJtRUJGUzJKaGFUR1VCMUgrTFdwUzlr?=
 =?utf-8?B?N2VZcGFIWVhDdTZhYk9EQkx0SlpkZVdJcGdWRUNhYmczZkExRDJQRlFjaXBo?=
 =?utf-8?B?UUcxcXp6Mm5GRG9ycVNDQlRZNkhkRVc0andaM0JWS1dxSWh6N2NqWU9vYkFD?=
 =?utf-8?B?NndNbEVOOUZJS0V5U05XS05tSWNnR0pGVW9NMUdxMWNGczNzaDJzTUJ4bmdH?=
 =?utf-8?B?cU0zcm5VKzVDaGhrSldqTTRYS3Y3Z0J2QWdhS1laMC90aDNkclRKZjdhYTlH?=
 =?utf-8?B?eGhPL25NR2ZMdG5UcHpDd09iOC9BbVRnYTdWbGdIT0JDcmxTeXhUTG0zbUpw?=
 =?utf-8?B?UXUram8xRHdrQ3VrVG5jdE85cXpOUzFtSmNNd29zRFE1N0lCZmk2Yk9DdVM1?=
 =?utf-8?B?SVFRbTdCUWpzbXlDeFQ0YmM2NEVVOUxUY2RObWFxR2RsNTV0N3FNbUlhTEV4?=
 =?utf-8?B?bDU4N3N1Vk5XNTc3L2NaTkFoRkVMT3lGQjhOdTIrd1F4aGptVGtrYTVBazVq?=
 =?utf-8?B?cjJtclh4L1p2RDlIcTRCTkFsN3cyemxsWkV5TDMzSnYweG1DYkdiNG82cW5U?=
 =?utf-8?B?bEVjSTJtdEhzV0NGZTRRQW9pTlh4eVk4aHFjVkdZckVWSHc9PQ==?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(376014)(1800799024)(36860700013)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:58.1057
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 1e34b7c1-e34f-4764-a086-08dca4f39c13
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR12MB5939
Status: RO
Content-Length: 9174
Lines: 286

From: Alejandro Lucero <alucerop@amd.com>

CXL region creation involves allocating capacity from device DPA
(device-physical-address space) and assigning it to decode a given HPA
(host-physical-address space). Before determining how much DPA to
allocate the amount of available HPA must be determined. Also, not all
HPA is create equal, some specifically targets RAM, some target PMEM,
some is prepared for device-memory flows like HDM-D and HDM-DB, and some
is host-only (HDM-H).

Wrap all of those concerns into an API that retrieves a root decoder
(platform CXL window) that fits the specified constraints and the
capacity available for a new region.

Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m6fbe775541da3cd477d65fa95c8acdc347345b4f

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c          | 161 +++++++++++++++++++++++++++++
 drivers/cxl/cxl.h                  |   3 +
 drivers/cxl/cxlmem.h               |   5 +
 drivers/net/ethernet/sfc/efx_cxl.c |  14 +++
 include/linux/cxl_accel_mem.h      |   9 ++
 5 files changed, 192 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 538ebd5a64fd..ca464bfef77b 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -702,6 +702,167 @@ static int free_hpa(struct cxl_region *cxlr)
 	return 0;
 }
 
+
+struct cxlrd_max_context {
+	struct device * const *host_bridges;
+	int interleave_ways;
+	unsigned long flags;
+	resource_size_t max_hpa;
+	struct cxl_root_decoder *cxlrd;
+};
+
+static int find_max_hpa(struct device *dev, void *data)
+{
+	struct cxlrd_max_context *ctx = data;
+	struct cxl_switch_decoder *cxlsd;
+	struct cxl_root_decoder *cxlrd;
+	struct resource *res, *prev;
+	struct cxl_decoder *cxld;
+	resource_size_t max;
+	int found;
+
+	if (!is_root_decoder(dev))
+		return 0;
+
+	cxlrd = to_cxl_root_decoder(dev);
+	cxld = &cxlrd->cxlsd.cxld;
+	if ((cxld->flags & ctx->flags) != ctx->flags) {
+		dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
+			      cxld->flags, ctx->flags);
+		return 0;
+	}
+
+	/* A Host bridge could have more interleave ways than an
+	 * endpoint, couldn´t it?
+	 *
+	 * What does interleave ways mean here in terms of the requestor?
+	 * Why the FFMWS has 0 interleave ways but root port has 1?
+	 */
+	if (cxld->interleave_ways != ctx->interleave_ways) {
+		dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
+		return 0;
+	}
+
+	cxlsd = &cxlrd->cxlsd;
+
+	guard(rwsem_read)(&cxl_region_rwsem);
+	found = 0;
+	for (int i = 0; i < ctx->interleave_ways; i++)
+		for (int j = 0; j < ctx->interleave_ways; j++)
+			if (ctx->host_bridges[i] ==
+					cxlsd->target[j]->dport_dev) {
+				found++;
+				break;
+			}
+
+	if (found != ctx->interleave_ways) {
+		dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
+		return 0;
+	}
+
+	/*
+	 * Walk the root decoder resource range relying on cxl_region_rwsem to
+	 * preclude sibling arrival/departure and find the largest free space
+	 * gap.
+	 */
+	lockdep_assert_held_read(&cxl_region_rwsem);
+	max = 0;
+	res = cxlrd->res->child;
+	if (!res)
+		max = resource_size(cxlrd->res);
+	else
+		max = 0;
+
+	for (prev = NULL; res; prev = res, res = res->sibling) {
+		struct resource *next = res->sibling;
+		resource_size_t free = 0;
+
+		if (!prev && res->start > cxlrd->res->start) {
+			free = res->start - cxlrd->res->start;
+			max = max(free, max);
+		}
+		if (prev && res->start > prev->end + 1) {
+			free = res->start - prev->end + 1;
+			max = max(free, max);
+		}
+		if (next && res->end + 1 < next->start) {
+			free = next->start - res->end + 1;
+			max = max(free, max);
+		}
+		if (!next && res->end + 1 < cxlrd->res->end + 1) {
+			free = cxlrd->res->end + 1 - res->end + 1;
+			max = max(free, max);
+		}
+	}
+
+	if (max > ctx->max_hpa) {
+		if (ctx->cxlrd)
+			put_device(CXLRD_DEV(ctx->cxlrd));
+		get_device(CXLRD_DEV(cxlrd));
+		ctx->cxlrd = cxlrd;
+		ctx->max_hpa = max;
+		dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
+	}
+	return 0;
+}
+
+/**
+ * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
+ * @endpoint: an endpoint that is mapped by the returned decoder
+ * @interleave_ways: number of entries in @host_bridges
+ * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
+ * @max: output parameter of bytes available in the returned decoder
+ *
+ * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
+ * is a point in time snapshot. If by the time the caller goes to use this root
+ * decoder's capacity the capacity is reduced then caller needs to loop and
+ * retry.
+ *
+ * The returned root decoder has an elevated reference count that needs to be
+ * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
+ * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
+ * does not race.
+ */
+struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
+					       int interleave_ways,
+					       unsigned long flags,
+					       resource_size_t *max)
+{
+
+	struct cxlrd_max_context ctx = {
+		.host_bridges = &endpoint->host_bridge,
+		.interleave_ways = interleave_ways,
+		.flags = flags,
+	};
+	struct cxl_port *root_port;
+	struct cxl_root *root;
+
+	if (!is_cxl_endpoint(endpoint)) {
+		dev_dbg(&endpoint->dev, "hpa requestor is not an endpoint\n");
+		return ERR_PTR(-EINVAL);
+	}
+
+	root = find_cxl_root(endpoint);
+	if (!root) {
+		dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
+		return ERR_PTR(-ENXIO);
+	}
+
+	root_port = &root->port;
+	down_read(&cxl_region_rwsem);
+	device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
+	up_read(&cxl_region_rwsem);
+	put_device(&root_port->dev);
+
+	if (!ctx.cxlrd)
+		return ERR_PTR(-ENOMEM);
+
+	*max = ctx.max_hpa;
+	return ctx.cxlrd;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
+
+
 static ssize_t size_store(struct device *dev, struct device_attribute *attr,
 			  const char *buf, size_t len)
 {
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index 9973430d975f..d3fdd2c1e066 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -770,6 +770,9 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
 struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
 struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
 struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
+
+#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
+
 bool is_root_decoder(struct device *dev);
 bool is_switch_decoder(struct device *dev);
 bool is_endpoint_decoder(struct device *dev);
diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
index 8f2a820bd92d..a0e0795ec064 100644
--- a/drivers/cxl/cxlmem.h
+++ b/drivers/cxl/cxlmem.h
@@ -877,4 +877,9 @@ struct cxl_hdm {
 struct seq_file;
 struct dentry *cxl_debugfs_create_dir(const char *dir);
 void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
+struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
+					       int interleave_ways,
+					       unsigned long flags,
+					       resource_size_t *max);
+
 #endif /* __CXL_MEM_H__ */
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 2cf4837ddfc1..6d49571ccff7 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -22,6 +22,7 @@ void efx_cxl_init(struct efx_nic *efx)
 {
 	struct pci_dev *pci_dev = efx->pci_dev;
 	struct efx_cxl *cxl = efx->cxl;
+	resource_size_t max = 0;
 	struct resource res;
 	u16 dvsec;
 
@@ -74,6 +75,19 @@ void efx_cxl_init(struct efx_nic *efx)
 	if (IS_ERR(cxl->endpoint))
 		pci_info(pci_dev, "CXL accel acquire endpoint failed");
 
+	cxl->cxlrd = cxl_get_hpa_freespace(cxl->endpoint, 1,
+					    CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
+					    &max);
+
+	if (IS_ERR(cxl->cxlrd)) {
+		pci_info(pci_dev, "CXL accel get HPA failed");
+		goto out;
+	}
+
+	if (max < EFX_CTPIO_BUFFER_SIZE)
+		pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
+				  max, EFX_CTPIO_BUFFER_SIZE);
+out:
 	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
 }
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index 701910021df8..f3e77688ffe0 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -6,6 +6,10 @@
 #ifndef __CXL_ACCEL_MEM_H
 #define __CXL_ACCEL_MEM_H
 
+#define CXL_DECODER_F_RAM   BIT(0)
+#define CXL_DECODER_F_PMEM  BIT(1)
+#define CXL_DECODER_F_TYPE2 BIT(2)
+
 enum accel_resource{
 	CXL_ACCEL_RES_DPA,
 	CXL_ACCEL_RES_RAM,
@@ -32,4 +36,9 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
 
 struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
 void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
+
+struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
+					       int interleave_ways,
+					       unsigned long flags,
+					       resource_size_t *max);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2089.outbound.protection.outlook.com [40.107.236.89])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B38CA446D1;
	Mon, 15 Jul 2024 17:29:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.89
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064545; cv=fail; b=eIp0Yoc/GuxTqTx5zxYhSDfaYnJfA+Z4ktcY+S2brfaxPg4bP/fK0bv0G1KxIGXsJtbXhaO9g7SEETD8oXzHPQt7w6brnd+tnnvM0DwbzcXkpJ2XWzFXNim/0fcZXwXejphq1CuZza8lv97isUx9BpUVBtB481O5VXcGt/SLbbk=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064545; c=relaxed/simple;
	bh=FOW6J+oQinweZYW2Y3V1Roo+XlJheeLT/W5x4VsppN8=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=j09qdy4v7MFM4TxhPDMQv6L1FMLRxTVN1adV4CVv/wU4l/8VD+7jZy8Ofd8TJp4N4X+M71RwB2Hd1nPHZ5lCHMQd/K+nyRx4x2sayl96zBz3jIGAfL2mlsDblBG6Q/hXzgWdXAFkEoWlav7d6ZchAMFaNEP1Ca6+BMQO2WybMYc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=IRsVo9Cr; arc=fail smtp.client-ip=40.107.236.89
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="IRsVo9Cr"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=gdBWpCKSDQ2PzVkhlp8SEEtgtUL6cuOkk1ajcGMQLLC+QUql7vHgCQ6er4WpJTqwKNMiTsPrRQZ1OrQ4Wz7fg8FgeerfelV2nD3sLbSwwfLSWwt3HJ8ncU9Kjqzuw4qI7GozBff7PW8W5M4ik+BsLRf9cEBVPKT8vfeFNI72JjKPsH8EZiiYvXg3nRPrvmm8h4yGe5EK4Hv7qpZHpLnz6T0wOLbyzuylmGLlYwYXrrELpMfMJmSYfEuYCSV61QIDXkvqO5/mZnDlIV90KvTl7z6NRclRZWMLP+L2v18vNj9IinVIDy90kk+PDggIXgAIfoX4ju/bw/U39mt1s43W4w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=6htK/OoKboLNfKt5yS2v8d8VTCpFP6cnDFWCkr4RKAo=;
 b=PUTCogWtz8pnaOUNGdRJ/Sm9/KedngR/neWGC6d33qW6to6fMlvtqzfwjyiRr1KRdkVTWkfd3yrUDohY1akP4N17nZgIUMBgk4wkkasYosVSgvhNMKi/+gCglIblH9JmMmuKJ6Sd+J/5gGlZDLowZls04F/0YrLuQgh1Y4GlrY8zqu/hnVg/CVhSCH/TsCm9BO89fblc0EoUCE/MDuzoxQmcdpl8rUmLeaR/wDeaZnNSbxuc+pO+FQdNKmexmJ6hUdbBsS26mQGq3gDvZDSBqXd/d3cEcjN3mpFr9SSp5b6dYY+jo/th5Ya1b7Mp377cWzyWO0kQ1vjXBw0eMyLIpw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=6htK/OoKboLNfKt5yS2v8d8VTCpFP6cnDFWCkr4RKAo=;
 b=IRsVo9CrVNsZh6tvBHLUWI8eugZpVm2PGVuPaYY44u45DLJLTy4cZGvFcci/Co6bhSwNjyOCyMXeh+ITB02PlGgIU645thiPTxwu5RX2Y9acyRI+fkZRfdzhQJqXsFIK+OHjuAp4OLPa07l1bCyXvXiYGPIEbFIjkhGpXwWWqt0=
Received: from CY8PR12CA0044.namprd12.prod.outlook.com (2603:10b6:930:49::10)
 by DS0PR12MB8342.namprd12.prod.outlook.com (2603:10b6:8:f9::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29; Mon, 15 Jul
 2024 17:29:00 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::7b) by CY8PR12CA0044.outlook.office365.com
 (2603:10b6:930:49::10) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:29:00 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:59 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:59 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:57 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 11/15] cxl: make region type based on endpoint type
Date: Mon, 15 Jul 2024 18:28:31 +0100
Message-ID: <20240715172835.24757-12-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|DS0PR12MB8342:EE_
X-MS-Office365-Filtering-Correlation-Id: 224f4914-48d6-4966-09ee-08dca4f39d21
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|376014|36860700013|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?q4z2NQyT/YXkftEo6LAGc/zB7cQfQr+WU57LOrar8E4iLPXd980nAiobm2fm?=
 =?us-ascii?Q?4Wmn/6H2xM0wCpfkhtDUHgDRrpXMjt260Q11sSa06dZWdheqE/9e0lA02YTy?=
 =?us-ascii?Q?AQIAnomUeY9IENz61ITl5udFyMgy3mUR2nN4yGoHN6ht9JIpq6HSsACcOTth?=
 =?us-ascii?Q?EmIS3fvHRCDlitgHu+cOM9UgKn4G8xBoM4khpEh69GYxYz00CtZa3REU7yO1?=
 =?us-ascii?Q?dYB7xGbGTuQdnK604CbO4Oz0SX8mFUCi/VlUCQHWprgPpqXUX63NE4xKibam?=
 =?us-ascii?Q?npRbg8NcvqrYJ0CdE0Fk8jOgS62oDmQBpgYhbvH6Q9XNPsW8CfpMqyOaMTPk?=
 =?us-ascii?Q?9VfStoei0ok53SSD6mch/AD+V9rFAZFGQjIAton/5euCoJYXOBLyFYOc4xhm?=
 =?us-ascii?Q?Tvpyh3oc77U28mA330UL1lDa3SmZHo6Ng/oTochaPrnfwry2DyOdjsUCzhCx?=
 =?us-ascii?Q?nJYnk0pmQW7EXIWwUeDaToKGr8fiD5dKUrjZJDetno6XehdMQZ0HQzSm9Dr9?=
 =?us-ascii?Q?N2bnJSoAVyJWVePVrCk+0g+YarAj+G9TpAe/pdmyGVm42QQwLODB67+rA9g/?=
 =?us-ascii?Q?GBMprtpb5zG20suWHUqcfYKFr59Y2bRDLoXXGbDlhewS8uRqYmcuRADmleyU?=
 =?us-ascii?Q?hdqvDGBlNkPYlMlj9kDuuMVuqmlxZFp0E9+xgM1ZAKCxzy6lMmt3Ml3VwJk4?=
 =?us-ascii?Q?UdlmVzkqiLz/cm14KRFC/LuHPZI97K2+xRxQi1FF0br9IRPU+9ezQMbXXBD3?=
 =?us-ascii?Q?fBWrMP/qddk+2oyyTVm6vJvCuY9d3kXvcyn59ZnldU6ekoD21fm+IWTVX64J?=
 =?us-ascii?Q?1LG6JM8GbFcXs0lOM3z5THAWBgZBcJ0ugxwjpDdboEG0HtJH8Z2i8gGRzzYB?=
 =?us-ascii?Q?Z8INoGGhIcWpqwb5P4vJUK1iPfNzW4SThw5hc3TsZZ24RfKYsK3WgpgZuV8H?=
 =?us-ascii?Q?s1GX9z6G8w/GFk8cNPjK1R04k58M+pcJKtdZJaGFQO1Zoy2hWSGwZsjVgVOE?=
 =?us-ascii?Q?wjKh1kUcZhmj+HrpbVdguKADj//UuJt+e59EtmDXGTCIzy8ADRmEX6i/VGaF?=
 =?us-ascii?Q?M9Uh92KBVaVoy4TDGjqCDT8GOHP+RSQc/AefV2Lsert82QO93vz5nh+/8iD8?=
 =?us-ascii?Q?bz/7Zbx41bbaBDRPIn42W4YW8gM+7Pi9OZWjTb5PMD9cAl/OMazwuEHP9ZMO?=
 =?us-ascii?Q?2jebwk7MtJBhEl/+m1FtjAt1wdG1kjoH9u8suOsK2J9dIkQon8x6Hbs/dMo/?=
 =?us-ascii?Q?sefaGvO7+ov4x1Myvjf2ND8wKfB9SNkD5YwYfcOZVQ5ssZl32GXn43wIW9/t?=
 =?us-ascii?Q?CvAgemtISaQuPj3RavReI2MIy2q/kDTnU5xR48VHPtPbdDJG+O21SoOYP1Bu?=
 =?us-ascii?Q?p4hrryhQ4LbQwBcHgYki4VXegduESLZ7UXxCCdqD/TqU+OOaWWfHBGL0nKCG?=
 =?us-ascii?Q?fk3P5PodDoiaGVbqogq4XN5BvPvLIdSepfFT085wM27UFoorYA1cAA=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(376014)(36860700013)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:59.8714
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 224f4914-48d6-4966-09ee-08dca4f39d21
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR12MB8342
Status: O
Content-Length: 2145
Lines: 67

From: Alejandro Lucero <alucerop@amd.com>

Current code is expecting Type3 or CXL_DECODER_HOSTONLYMEM devices only.
Suport for Type2 implies region type needs to be based on the endpoint
type instead.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/region.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index ca464bfef77b..5cc71b8868bc 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -2645,7 +2645,8 @@ static ssize_t create_ram_region_show(struct device *dev,
 }
 
 static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
-					  enum cxl_decoder_mode mode, int id)
+					  enum cxl_decoder_mode mode, int id,
+					  enum cxl_decoder_type target_type)
 {
 	int rc;
 
@@ -2667,7 +2668,7 @@ static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
 		return ERR_PTR(-EBUSY);
 	}
 
-	return devm_cxl_add_region(cxlrd, id, mode, CXL_DECODER_HOSTONLYMEM);
+	return devm_cxl_add_region(cxlrd, id, mode, target_type);
 }
 
 static ssize_t create_pmem_region_store(struct device *dev,
@@ -2682,7 +2683,8 @@ static ssize_t create_pmem_region_store(struct device *dev,
 	if (rc != 1)
 		return -EINVAL;
 
-	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id);
+	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id,
+			       CXL_DECODER_HOSTONLYMEM);
 	if (IS_ERR(cxlr))
 		return PTR_ERR(cxlr);
 
@@ -2702,7 +2704,8 @@ static ssize_t create_ram_region_store(struct device *dev,
 	if (rc != 1)
 		return -EINVAL;
 
-	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id);
+	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id,
+			       CXL_DECODER_HOSTONLYMEM);
 	if (IS_ERR(cxlr))
 		return PTR_ERR(cxlr);
 
@@ -3364,7 +3367,8 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 
 	do {
 		cxlr = __create_region(cxlrd, cxled->mode,
-				       atomic_read(&cxlrd->region_id));
+				       atomic_read(&cxlrd->region_id),
+				       cxled->cxld.target_type);
 	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
 
 	if (IS_ERR(cxlr)) {
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2078.outbound.protection.outlook.com [40.107.223.78])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 37EED7173C;
	Mon, 15 Jul 2024 17:29:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.78
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064544; cv=fail; b=KwDaTPwe1DvuGZYJgN/2qG5g4HqHG7g0qfNfKOtehQvF7ElXWv3PRoOudX2lIGzW2r0bDbq0zA6W0UxLsvvdacZovLypzYXqLCt7veFvOB8WMHvitzdOPl6IuEk6e4k9OmBA/3YaXGD23FE6jV+t3EIG3BMYfi/FwRECgLNuF2Y=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064544; c=relaxed/simple;
	bh=pU6ylkH8U/vWKVgxV1dXn2pBW2C/ATOuIpeV7kiKAPI=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=GhFsNf0xR2mRGkNJt+B4JdoNsJzcWXcVDZlSB/bJER2U1QpX6x/RWLQ5MUYIFHNII4JhrIiOid6lubYVtrEDTd4YwU6ch0eem7uY87hSNONxIjBlw+YyJ0XWb8/H+20Op+iaMnR/cBb7QocWwWikJgTcZ55jHhcXSQLMsq8P1EY=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=EqasE+L5; arc=fail smtp.client-ip=40.107.223.78
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="EqasE+L5"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=sIiod1/egHUNNqR5cEM0JBjuNEB8sYXNtX0XNRkzKNp3Aqu1S29CIMOjLcBux6cGtQiR4QbAijog9N3Dl8bJgKnoan20FIUYVWQsDebguzmWvWkVoZpflyYAvaZyOAfE7GtjBjBxNEmoP6xxlL66iAnJb/xNP3Qnbnh2obbqfycfNSM50+FdpCMHMoF0BAZNP2hL0wto5mqAPEJyv/H/MQKEOoTmfxx8ed/gIBAjotImcipuWtI8YWAfrkkYLe9i6aqwEt3y1ey75QjaAyUmcFdOwVi1swijb86Nhcq2w9Vv8l8ZOCAce2N7nqZZkeuPzBwHj2sWEZQrKW+8Pl5hvA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ZjXnjXwhOwLS5GKsMstS8ETSnnG0c+V+5JINt7DPHbQ=;
 b=wCl4tLwdFWk5uN8FtD83HmMN+LyXBhgqjIpHeKQCFhNIvXs1FFDTedQ0nV7sF8n8fHH92hNARlFdDBE/eeTpsko6q/x6UXVstfuiA8HxbXp46hWQT32jxuuBEX0L5fP0UMeqXhgvo+D/pXSPA+42C4D+DoOZKFXtjA3m2+bIn/yZS/exnyp5L5dm7lJEjTxA9O9uZgUpQ8F665tJ45poVPxR5J0rl0jURlduuKSKCv3hGoMzlrWL4KxWWIZOOHLBhPbpulAx8nnvGAELrJDVt4DsP1virKsTGRBS0bvRyCd1mkaPpyJjp+e7bOE/agedYQvd9U8FvOg303X4hpor7w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ZjXnjXwhOwLS5GKsMstS8ETSnnG0c+V+5JINt7DPHbQ=;
 b=EqasE+L5XdDISp7204Hp0AsN5CEx+7h+S6QwbMMBuqY8HInDjebBS5d3ecQmEIA3dxrcoK1pwaRMQaSPxABmEk9jMkFEG0Ok0mGxnGzKauhmpOIt/oWx4bHiSoq1pPH6TG6LXo8QRGrN4lF+zbGF2x857CdQkudyzD5YaS+1k64=
Received: from BYAPR02CA0024.namprd02.prod.outlook.com (2603:10b6:a02:ee::37)
 by PH7PR12MB7793.namprd12.prod.outlook.com (2603:10b6:510:270::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:28:59 +0000
Received: from SJ1PEPF000023DA.namprd21.prod.outlook.com
 (2603:10b6:a02:ee:cafe::81) by BYAPR02CA0024.outlook.office365.com
 (2603:10b6:a02:ee::37) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:58 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 SJ1PEPF000023DA.mail.protection.outlook.com (10.167.244.75) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.5 via Frontend Transport; Mon, 15 Jul 2024 17:28:58 +0000
Received: from SATLEXMB06.amd.com (10.181.40.147) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:58 -0500
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB06.amd.com
 (10.181.40.147) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:57 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:56 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 10/15] cxl: define a driver interface for DPA allocation
Date: Mon, 15 Jul 2024 18:28:30 +0100
Message-ID: <20240715172835.24757-11-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SJ1PEPF000023DA:EE_|PH7PR12MB7793:EE_
X-MS-Office365-Filtering-Correlation-Id: 43d8f4c3-424a-481f-0742-08dca4f39c85
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|36860700013|376014|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?CfMT5XW+m0bI0jWoz7ZHNx3qsgRK8pSvjdyB0nZCGBBHdu7W+90djFTaA9is?=
 =?us-ascii?Q?Q2rZ8DUB9Y+gCHvXPZl2DiAghsgW7uiZXYJaQrN8bdNUgy0j43RHYpJL9Iei?=
 =?us-ascii?Q?t1uQ0nfHOfNZYqdPZwhgU9xFfntn5bhey22y5g7SyOTYTz/9i2B8M8W55n2R?=
 =?us-ascii?Q?ZJ8DnDJemI6JfoT8I9YTXiomWxNccojgrGtYPvQU8gaQX4gjppoH3BHp9bku?=
 =?us-ascii?Q?7n9hk/L5z6cckDyXzsxr2OFgfK2s0RRtvDkDz/qaoB5z2QMJhNKlvoKgnj+H?=
 =?us-ascii?Q?6MofnplfAqyZYOHHXYJtubGIMQa6J/eb5R8Xp2AptJhtnw5DW5uUNiDODjzG?=
 =?us-ascii?Q?P2ZYtaEPaUvbzkuF4vjd9a5DwrHVuZH+HCJhJh3SjGsjJb6Qp5ZLN4vBX0a3?=
 =?us-ascii?Q?Uoj3hgAT+moDs0FL+mp6+OF0v7xSWakv2aYsFCv18SF7aaH0WRdQnx5VHAAs?=
 =?us-ascii?Q?e3zh3AnC6BD9djZWPO9iU1LEUq0qpCT2gHbfiE0H8Kjd+S/JhDuu5vSMzeKp?=
 =?us-ascii?Q?+KpM+93tjANyRf+Dn4I6ePhhRM8BaV2uLnnXWbSCBA9OZ+X9eG2JTNXZU1HK?=
 =?us-ascii?Q?lYOtaBZwkppa3xEcir6clVGR7zhzlXHSBEda7jrZWA2MGiVVkaV/PiFPYvyK?=
 =?us-ascii?Q?8ISCcBYUCcJIaKmOwldFFHVmIg7LDPpNRI+/9sdSwNO/wkwcHV8zTptkHVU8?=
 =?us-ascii?Q?nZ//2BRGlgSJ0ZokLB3R1BjIFJeITDKcdDFXJCe+xdDVP0GrZ8tGgkhRCYGS?=
 =?us-ascii?Q?OXNDERN4QFeTRpRyN88aPpZRpMdiGwL6bC5DAjw21J8cUjA1vavcGQrZbJWz?=
 =?us-ascii?Q?JUtWbcIsWUxSygONo9JslQrzFclJmFcn0j3WXCDr7+dwzepv60B55uu1vzpX?=
 =?us-ascii?Q?fZ/sLDzUn+akxppVYIJfNCK2wyL+jMFhk/PPUU/sRAeiSrcziHoWqe4P1NJQ?=
 =?us-ascii?Q?1f3CWaulCCuajUqe3cOY0jziDunvYNbbMgakcU3SidG5kjCHJZa5EJBZuyPI?=
 =?us-ascii?Q?/vzNJRoxo+IvqW/THAp0vBGE/O+kuoYygx42SLy/BBglejEoksmGXsvFEn/x?=
 =?us-ascii?Q?1S3ylSTUUJR/eJ+aaJPh46mTzWHC9u0TXdXHjI/KUoyf2lUPZnyPzbSh/mOn?=
 =?us-ascii?Q?GZrsvhhOfHKon3+HtC71sgfYWx/32tPos1BliGmqz5o8pA/5psCle9f0LgA3?=
 =?us-ascii?Q?Z4b73JwXsrzYCiTIWbuwUFAYqieFz0/9RUl41VG0GxIFv3yaEp1PbcOww7ne?=
 =?us-ascii?Q?7T3IHYaz09P8iKGtvKh2Ibg5wbrH5l/CRDwNk0WDXaZ93Vmg1gN9KnpYDzXA?=
 =?us-ascii?Q?3GLiH9pvEVbx5aYFH5jlRawZyiUWRSlaZp6B7iTElVITfx09aLnHEOoIqgFb?=
 =?us-ascii?Q?Lbg6e3G9gjLMUCcZnxWL+ZmDDvXi?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(36860700013)(376014)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:58.8333
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 43d8f4c3-424a-481f-0742-08dca4f39c85
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	SJ1PEPF000023DA.namprd21.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB7793
Status: O
Content-Length: 9803
Lines: 324

From: Alejandro Lucero <alucerop@amd.com>

Region creation involves finding available DPA (device-physical-address)
capacity to map into HPA (host-physical-address) space. Given the HPA
capacity constraint, define an API, cxl_request_dpa(), that has the
flexibility to  map the minimum amount of memory the driver needs to
operate vs the total possible that can be mapped given HPA availability.

Factor out the core of cxl_dpa_alloc, that does free space scanning,
into a cxl_dpa_freespace() helper, and use that to balance the capacity
available to map vs the @min and @max arguments to cxl_request_dpa.

Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m4271ee49a91615c8af54e3ab20679f8be3099393

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/core.h            |   1 +
 drivers/cxl/core/hdm.c             | 153 +++++++++++++++++++++++++----
 drivers/net/ethernet/sfc/efx.c     |   2 +
 drivers/net/ethernet/sfc/efx_cxl.c |  18 +++-
 drivers/net/ethernet/sfc/efx_cxl.h |   1 +
 include/linux/cxl_accel_mem.h      |   7 ++
 6 files changed, 161 insertions(+), 21 deletions(-)

diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index 625394486459..a243ff12c0f4 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -76,6 +76,7 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 		     enum cxl_decoder_mode mode);
 int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size);
 int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
+int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
 resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
 resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
 
diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index 4af9225d4b59..3e53ae222d40 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -3,6 +3,7 @@
 #include <linux/seq_file.h>
 #include <linux/device.h>
 #include <linux/delay.h>
+#include <linux/cxl_accel_mem.h>
 
 #include "cxlmem.h"
 #include "core.h"
@@ -420,6 +421,7 @@ int cxl_dpa_free(struct cxl_endpoint_decoder *cxled)
 	up_write(&cxl_dpa_rwsem);
 	return rc;
 }
+EXPORT_SYMBOL_NS_GPL(cxl_dpa_free, CXL);
 
 int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 		     enum cxl_decoder_mode mode)
@@ -467,30 +469,17 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 	return rc;
 }
 
-int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
+static resource_size_t cxl_dpa_freespace(struct cxl_endpoint_decoder *cxled,
+					 resource_size_t *start_out,
+					 resource_size_t *skip_out)
 {
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
 	resource_size_t free_ram_start, free_pmem_start;
-	struct cxl_port *port = cxled_to_port(cxled);
 	struct cxl_dev_state *cxlds = cxlmd->cxlds;
-	struct device *dev = &cxled->cxld.dev;
 	resource_size_t start, avail, skip;
 	struct resource *p, *last;
-	int rc;
-
-	down_write(&cxl_dpa_rwsem);
-	if (cxled->cxld.region) {
-		dev_dbg(dev, "decoder attached to %s\n",
-			dev_name(&cxled->cxld.region->dev));
-		rc = -EBUSY;
-		goto out;
-	}
 
-	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
-		dev_dbg(dev, "decoder enabled\n");
-		rc = -EBUSY;
-		goto out;
-	}
+	lockdep_assert_held(&cxl_dpa_rwsem);
 
 	for (p = cxlds->ram_res.child, last = NULL; p; p = p->sibling)
 		last = p;
@@ -528,14 +517,45 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
 			skip_end = start - 1;
 		skip = skip_end - skip_start + 1;
 	} else {
-		dev_dbg(dev, "mode not set\n");
-		rc = -EINVAL;
+		avail = 0;
+	}
+
+	if (!avail)
+		return 0;
+	if (start_out)
+		*start_out = start;
+	if (skip_out)
+		*skip_out = skip;
+	return avail;
+}
+
+int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
+{
+	struct cxl_port *port = cxled_to_port(cxled);
+	struct device *dev = &cxled->cxld.dev;
+	resource_size_t start, avail, skip;
+	int rc;
+
+	down_write(&cxl_dpa_rwsem);
+	if (cxled->cxld.region) {
+		dev_dbg(dev, "EBUSY, decoder attached to %s\n",
+			     dev_name(&cxled->cxld.region->dev));
+		rc = -EBUSY;
 		goto out;
 	}
 
+	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
+		dev_dbg(dev, "EBUSY, decoder enabled\n");
+		rc = -EBUSY;
+		goto out;
+	}
+
+	avail = cxl_dpa_freespace(cxled, &start, &skip);
+
 	if (size > avail) {
 		dev_dbg(dev, "%pa exceeds available %s capacity: %pa\n", &size,
-			cxl_decoder_mode_name(cxled->mode), &avail);
+			     cxled->mode == CXL_DECODER_RAM ? "ram" : "pmem",
+			     &avail);
 		rc = -ENOSPC;
 		goto out;
 	}
@@ -550,6 +570,99 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
 	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
 }
 
+static int find_free_decoder(struct device *dev, void *data)
+{
+	struct cxl_endpoint_decoder *cxled;
+	struct cxl_port *port;
+
+	if (!is_endpoint_decoder(dev))
+		return 0;
+
+	cxled = to_cxl_endpoint_decoder(dev);
+	port = cxled_to_port(cxled);
+
+	if (cxled->cxld.id != port->hdm_end + 1) {
+		return 0;
+	}
+	return 1;
+}
+
+/**
+ * cxl_request_dpa - search and reserve DPA given input constraints
+ * @endpoint: an endpoint port with available decoders
+ * @mode: DPA operation mode (ram vs pmem)
+ * @min: the minimum amount of capacity the call needs
+ * @max: extra capacity to allocate after min is satisfied
+ *
+ * Given that a region needs to allocate from limited HPA capacity it
+ * may be the case that a device has more mappable DPA capacity than
+ * available HPA. So, the expectation is that @min is a driver known
+ * value for how much capacity is needed, and @max is based the limit of
+ * how much HPA space is available for a new region.
+ *
+ * Returns a pinned cxl_decoder with at least @min bytes of capacity
+ * reserved, or an error pointer. The caller is also expected to own the
+ * lifetime of the memdev registration associated with the endpoint to
+ * pin the decoder registered as well.
+ */
+struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
+					     bool is_ram,
+					     resource_size_t min,
+					     resource_size_t max)
+{
+	struct cxl_endpoint_decoder *cxled;
+	enum cxl_decoder_mode mode;
+	struct device *cxled_dev;
+	resource_size_t alloc;
+	int rc;
+
+	if (!IS_ALIGNED(min | max, SZ_256M))
+		return ERR_PTR(-EINVAL);
+
+	down_read(&cxl_dpa_rwsem);
+
+	cxled_dev = device_find_child(&endpoint->dev, NULL, find_free_decoder);
+	if (!cxled_dev)
+		cxled = ERR_PTR(-ENXIO);
+	else
+		cxled = to_cxl_endpoint_decoder(cxled_dev);
+
+	up_read(&cxl_dpa_rwsem);
+
+	if (IS_ERR(cxled))
+		return cxled;
+
+	if (is_ram)
+		mode = CXL_DECODER_RAM;
+	else
+		mode = CXL_DECODER_PMEM;
+
+	rc = cxl_dpa_set_mode(cxled, mode);
+	if (rc)
+		goto err;
+
+	down_read(&cxl_dpa_rwsem);
+	alloc = cxl_dpa_freespace(cxled, NULL, NULL);
+	up_read(&cxl_dpa_rwsem);
+
+	if (max)
+		alloc = min(max, alloc);
+	if (alloc < min) {
+		rc = -ENOMEM;
+		goto err;
+	}
+
+	rc = cxl_dpa_alloc(cxled, alloc);
+	if (rc)
+		goto err;
+
+	return cxled;
+err:
+	put_device(cxled_dev);
+	return ERR_PTR(rc);
+}
+EXPORT_SYMBOL_NS_GPL(cxl_request_dpa, CXL);
+
 static void cxld_set_interleave(struct cxl_decoder *cxld, u32 *ctrl)
 {
 	u16 eig;
diff --git a/drivers/net/ethernet/sfc/efx.c b/drivers/net/ethernet/sfc/efx.c
index cb3f74d30852..9cfe29002d98 100644
--- a/drivers/net/ethernet/sfc/efx.c
+++ b/drivers/net/ethernet/sfc/efx.c
@@ -901,6 +901,8 @@ static void efx_pci_remove(struct pci_dev *pci_dev)
 
 	efx_fini_io(efx);
 
+	efx_cxl_exit(efx);
+
 	pci_dbg(efx->pci_dev, "shutdown successful\n");
 
 	efx_fini_devlink_and_unlock(efx);
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 6d49571ccff7..b5626d724b52 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -84,12 +84,28 @@ void efx_cxl_init(struct efx_nic *efx)
 		goto out;
 	}
 
-	if (max < EFX_CTPIO_BUFFER_SIZE)
+	if (max < EFX_CTPIO_BUFFER_SIZE) {
 		pci_info(pci_dev, "CXL accel not enough free HPA space %llu < %u\n",
 				  max, EFX_CTPIO_BUFFER_SIZE);
+		goto out;
+	}
+
+	cxl->cxled = cxl_request_dpa(cxl->endpoint, true, EFX_CTPIO_BUFFER_SIZE,
+				     EFX_CTPIO_BUFFER_SIZE);
+	if (IS_ERR(cxl->cxled))
+		pci_info(pci_dev, "CXL accel request DPA failed");
 out:
 	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
 }
 
+void efx_cxl_exit(struct efx_nic *efx)
+{
+	struct efx_cxl *cxl = efx->cxl;
+
+	if (cxl->cxled)
+		cxl_dpa_free(cxl->cxled);
+ 
+ 	return;
+ }
 
 MODULE_IMPORT_NS(CXL);
diff --git a/drivers/net/ethernet/sfc/efx_cxl.h b/drivers/net/ethernet/sfc/efx_cxl.h
index 76c6794c20d8..59d5217a684c 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.h
+++ b/drivers/net/ethernet/sfc/efx_cxl.h
@@ -26,4 +26,5 @@ struct efx_cxl {
 };
 
 void efx_cxl_init(struct efx_nic *efx);
+void efx_cxl_exit(struct efx_nic *efx);
 #endif
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index f3e77688ffe0..d4ecb5bb4fc8 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -2,6 +2,7 @@
 /* Copyright(c) 2024 Advanced Micro Devices, Inc. */
 
 #include <linux/cdev.h>
+#include <linux/pci.h>
 
 #ifndef __CXL_ACCEL_MEM_H
 #define __CXL_ACCEL_MEM_H
@@ -41,4 +42,10 @@ struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
 					       int interleave_ways,
 					       unsigned long flags,
 					       resource_size_t *max);
+
+struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
+					     bool is_ram,
+					     resource_size_t min,
+					     resource_size_t max);
+int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (mail-sn1nam02on2089.outbound.protection.outlook.com [40.107.96.89])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 035F76CDC0;
	Mon, 15 Jul 2024 17:28:59 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.96.89
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064541; cv=fail; b=Xak9eXewzwP6uyK2BAx42Dk2K/ebBlYUIzUjAFj7Q6PQXPIccrQFVNg1qopisvXmL1WSjPTrNLmOMtdjlzXiPoCQIKbdhpJWWxdQCO/TSZK9xQVI9XmMFrKRO/ohARmswUwuUeOx2bgFq3k2GTsgeCWHPR7FPamnAZNe1dVdKjU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064541; c=relaxed/simple;
	bh=gv8IqeUd/PvmEVS7FXkAfTqWkvW5R7riZvLEbUSb8ss=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=uookPFpdVcZbg2x5AVtMf8N2esx69BYLVmqOzsq/eL096yuTRSGdOPNPSoLx9gwPljlT5GS48g8eoBVTdhOgA4yGpHCfPR3KZRyWmV7WoW/iHTPzf2nG3AVgpR1cEz29jTEUJZ4VxbiazHkFilz1PhxjgeaeKSaHjebQReJ+YC4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=V25qE8Mp; arc=fail smtp.client-ip=40.107.96.89
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="V25qE8Mp"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=SwPSO7g8n3UhU4QmLivk0bumNs02cn5idemFwxPg6A/z11ydXtIiIduPSBphGarlXKQmyU/KekwDV0kj5CtSD8/KLZWVQR62L7SzEfYczUXKa8Iy+SjvV+CpyzYwiejxuaQ2MvmKLrZJ8Y26fvGKIQBw+ag5nsMXq7bCTXUk8W9OpQw66p3Qs0vMaZ0OxwdWq00j5n9Ww2cgLfQinPKJ4cbP5Ycslc2PIf2HqJlmSJJkinlHGJ9jbfR1f0mC+hpTmCAN7HC83fPjOAMT2Ri9vTYCUzLhhNtf53X7f3SpeILJyo3yH5dya+lB+IoouBgSXiGwJepriIh0MCty/TMzuQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=I1h2bTIlDVA5eUc+B8YwO9nUxz2ompCDE5qER87lyeg=;
 b=PwKrWeOOdgg1AeMRUdDjR0ehC4zi4Mx6OrQeNM2WRKst9byB3Ewc1Gn/kiC7u/HDbDlU/abGBxJ+i6A2lD/pZuScnfCR0Bc0wqZFRc2tCIsbLk+nbcZcjeGCIrj0e1sCwaR+sTaKZ7+9JuIrKjP5TuNTsLBYZJo+BLykFi9SySKl2IggnpiXtfX/dw7WOX3svsH/nmYJUD1/NdPQ4alZVuqefEw6nye79zvjWplw+PcDIaAkl+RQuOeVVmAyYgMyVGnXO8BMuMph4O41advq++efRKElQm8LNQy90ADaFbDsQfKrAzuBigM7+683T0AD2D90sZEYlLUU6qBuahgNJA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=I1h2bTIlDVA5eUc+B8YwO9nUxz2ompCDE5qER87lyeg=;
 b=V25qE8MpfYLTnfcQpNf3rrBE7Ll/Rt6MgkkGYp1yqcI9CrPMJilEfjeyxsge9xwN0rgRQvZBb58vrpKQb8tiVggo9eLWuInXw3M2Ite6P3AQpCZ5z/wjnBcRpreqUBFsq2PMC/fbkWYUXmSOF5T08sHZ+sylEf29ai4/GvlDlU4=
Received: from CY8PR12CA0034.namprd12.prod.outlook.com (2603:10b6:930:49::22)
 by MN6PR12MB8471.namprd12.prod.outlook.com (2603:10b6:208:473::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:28:57 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::a) by CY8PR12CA0034.outlook.office365.com
 (2603:10b6:930:49::22) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:56 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:56 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:54 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:53 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 08/15] cxl: indicate probe deferral
Date: Mon, 15 Jul 2024 18:28:28 +0100
Message-ID: <20240715172835.24757-9-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|MN6PR12MB8471:EE_
X-MS-Office365-Filtering-Correlation-Id: f5a4338f-ea7e-4089-d32d-08dca4f39b22
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|376014|36860700013|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?DDKE2x7QzmGz6gCFCyWzZjPishiAfOe/wkoV6Vi4hjanhZGgnDgwx5x0tMeW?=
 =?us-ascii?Q?93JcnvgXgnujVieGic7mNz+zZpACeu4xzN5mKSNmC7LrF0QyUDq1pPQOHs5w?=
 =?us-ascii?Q?43cXABYTz9+fLwINKbhU0cHxXWenwx+kbnQGhTrX4SoYdyE+VP3YlzuD+iZO?=
 =?us-ascii?Q?ZV2IbzM6939pRBSoufa0q6kHICXaMmjHVq1VoTZxd0+ewYvxHf/bawaSWnwO?=
 =?us-ascii?Q?D473SQ4Z65OgH6phIBNGQyaT94ocqcwc1Mm7Rw9lomD/CSj6ltLauEWLv7qq?=
 =?us-ascii?Q?YeyY3A5F9wn3pZ7Mhl9TzGKNNPiBXgx4iQHbUGp6Z/annrCUW4i6tVc2MiKQ?=
 =?us-ascii?Q?WcUOliY2+mO76IJQ1sBcJGUqkkQRXS39ndJU8ZzZhTb3HeT11ZGy5IVbUzzB?=
 =?us-ascii?Q?Gs26b64VBSeWse1+rHMpGjTuV+dVJTbWM82aui6DfXILyB8fz6I+4HvBNjfk?=
 =?us-ascii?Q?K7bFeI/6ZF0t939OsbbZk3q84YiDF9d2poB6dNExGvyhAEnEYJajBYtEpJPK?=
 =?us-ascii?Q?ofUAtvUyvGU4gsd8LV0pl6OX5YWqNNlNZ5g6ecBkD3clUKYkES+uyoKCg3N4?=
 =?us-ascii?Q?NU4A6jUE6z2LsIsF34QIya7RK2kScg/3uDR25xmLlcdXuVAYhXT3PW1uTDdq?=
 =?us-ascii?Q?fOmaIZFfrGdHYNpbPiT1Lt3kL/PTqhVMOyXX8zWZqczXdYJXBcua9m/Y68K6?=
 =?us-ascii?Q?gNbaZVObCPfEoxjQSyfuswEJZmnFh5MvKf/rn+mesNWKikNgjfkZdgudMbXC?=
 =?us-ascii?Q?MhJIvCx3q3tx5iZIfgZw8AVlKUKJ6plQeslRVymHXIr2s9sliuA2TDrjXcWu?=
 =?us-ascii?Q?HmmtFABhEAdDsLszMvWYQK3T7ovQHQGdCgORAugO2MMtJf++eG47j7S4A9xx?=
 =?us-ascii?Q?KUUPLDyhu8/DGEDT6ajSPKHMeS3srW5tS5yiPL+FMOD/8bS/0ZRDU33rnNLs?=
 =?us-ascii?Q?RVzc/GcW6z+PsIzOYvKvGRNa2aRH4QoPpNxM6nFf7Yo/8SgO1L5fegWbIV2A?=
 =?us-ascii?Q?szAcIW7eFFppwM7pjTz9nGpeTb/qn149MC9rbLXPXPJXGyN1aZQy00mQlc+H?=
 =?us-ascii?Q?yCBt+I4MIXeFLSq+a5lZJ+N1d5R1aQibLMZ5a5Vn9KRRWD2WLxFcMaO3WWFR?=
 =?us-ascii?Q?WAtLkPciQ8SjwCdH7/Ti7RU1RNM3ZSSlipMqm76pbUTvVYFQ+uGuJek/E+YW?=
 =?us-ascii?Q?i+19jwjs03EqDNKJSFJ1sRT6TTXEOCkazgZxGRsfcro2xKT5TkhAQSJLCFlq?=
 =?us-ascii?Q?fuT18xKSGXOykhpAe1nleaXWA0TUcPRuiEnYMbbIaxXKRamLUtLbffBhlRje?=
 =?us-ascii?Q?KQtVX60ckyRJfye7TIAQ7IZ+FZm6hpI0rbfU7cSVVltkPrlttGc5hTAQnRyV?=
 =?us-ascii?Q?Hrd8LngWX5LZW/91wB6NRDpW7Xj7Ez8jOqZkM5ELdh7t++VdZg=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(376014)(36860700013)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:56.5276
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: f5a4338f-ea7e-4089-d32d-08dca4f39b22
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN6PR12MB8471
Status: RO
X-Status: A
Content-Length: 5116
Lines: 158

From: Alejandro Lucero <alucerop@amd.com>

The first stop for a CXL accelerator driver that wants to establish new
CXL.mem regions is to register a 'struct cxl_memdev. That kicks off
cxl_mem_probe() to enumerate all 'struct cxl_port' instances in the
topology up to the root.

If the root driver has not attached yet the expectation is that the
driver waits until that link is established. The common cxl_pci_driver
has reason to keep the 'struct cxl_memdev' device attached to the bus
until the root driver attaches. An accelerator may want to instead defer
probing until CXL resources can be acquired.

Use the @endpoint attribute of a 'struct cxl_memdev' to convey when
accelerator driver probing should be defferred vs failed. Provide that
indication via a new cxl_acquire_endpoint() API that can retrieve the
probe status of the memdev.

The first consumer of this API is a test driver that excercises the CXL
Type-2 flow.

Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m18497367d2ae38f88e94c06369eaa83fa23e92b2

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/memdev.c          | 41 ++++++++++++++++++++++++++++++
 drivers/cxl/core/port.c            |  2 +-
 drivers/cxl/mem.c                  |  7 +++--
 drivers/net/ethernet/sfc/efx_cxl.c | 10 +++++++-
 include/linux/cxl_accel_mem.h      |  3 +++
 5 files changed, 59 insertions(+), 4 deletions(-)

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index b902948b121f..d51c8bfb32e3 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -1137,6 +1137,47 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
 }
 EXPORT_SYMBOL_NS_GPL(devm_cxl_add_memdev, CXL);
 
+/*
+ * Try to get a locked reference on a memdev's CXL port topology
+ * connection. Be careful to observe when cxl_mem_probe() has deposited
+ * a probe deferral awaiting the arrival of the CXL root driver
+*/
+struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd)
+{
+	struct cxl_port *endpoint;
+	int rc = -ENXIO;
+
+	device_lock(&cxlmd->dev);
+	endpoint = cxlmd->endpoint;
+	if (!endpoint)
+		goto err;
+
+	if (IS_ERR(endpoint)) {
+		rc = PTR_ERR(endpoint);
+		goto err;
+	}
+
+	device_lock(&endpoint->dev);
+	if (!endpoint->dev.driver)
+		goto err_endpoint;
+
+	return endpoint;
+
+err_endpoint:
+	device_unlock(&endpoint->dev);
+err:
+	device_unlock(&cxlmd->dev);
+	return ERR_PTR(rc);
+}
+EXPORT_SYMBOL_NS(cxl_acquire_endpoint, CXL);
+
+void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
+{
+	device_unlock(&endpoint->dev);
+	device_unlock(&cxlmd->dev);
+}
+EXPORT_SYMBOL_NS(cxl_release_endpoint, CXL);
+
 static void sanitize_teardown_notifier(void *data)
 {
 	struct cxl_memdev_state *mds = data;
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index d66c6349ed2d..3c6b896c5f65 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -1553,7 +1553,7 @@ static int add_port_attach_ep(struct cxl_memdev *cxlmd,
 		 */
 		dev_dbg(&cxlmd->dev, "%s is a root dport\n",
 			dev_name(dport_dev));
-		return -ENXIO;
+		return -EPROBE_DEFER;
 	}
 
 	parent_port = find_cxl_port(dparent, &parent_dport);
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index f76af75a87b7..383a6f4829d3 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -145,13 +145,16 @@ static int cxl_mem_probe(struct device *dev)
 		return rc;
 
 	rc = devm_cxl_enumerate_ports(cxlmd);
-	if (rc)
+	if (rc) {
+		cxlmd->endpoint = ERR_PTR(rc);
 		return rc;
+	}
 
 	parent_port = cxl_mem_find_port(cxlmd, &dport);
 	if (!parent_port) {
 		dev_err(dev, "CXL port topology not found\n");
-		return -ENXIO;
+		cxlmd->endpoint = ERR_PTR(-EPROBE_DEFER);
+		return -EPROBE_DEFER;
 	}
 
 	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 0abe66490ef5..2cf4837ddfc1 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -65,8 +65,16 @@ void efx_cxl_init(struct efx_nic *efx)
 	}
 
 	cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
-	if (IS_ERR(cxl->cxlmd))
+	if (IS_ERR(cxl->cxlmd)) {
 		pci_info(pci_dev, "CXL accel memdev creation failed");
+		return;
+	}
+
+	cxl->endpoint = cxl_acquire_endpoint(cxl->cxlmd);
+	if (IS_ERR(cxl->endpoint))
+		pci_info(pci_dev, "CXL accel acquire endpoint failed");
+
+	cxl_release_endpoint(cxl->cxlmd, cxl->endpoint);
 }
 
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index 442ed9862292..701910021df8 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -29,4 +29,7 @@ int cxl_await_media_ready(struct cxl_dev_state *cxlds);
 
 struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
 				       struct cxl_dev_state *cxlds);
+
+struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
+void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2087.outbound.protection.outlook.com [40.107.94.87])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6D2DD54279;
	Mon, 15 Jul 2024 17:28:57 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.87
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064539; cv=fail; b=uBXnLdvuuyvwTP1j9z+yOjH7w8BVxmO/IfjHt82jUVUNWvhrvJUfK9q0Gox30J4zbWJzIwHC8ylisJm1T+C7I3Xv+YvU0aDID/sdQ3fA5Bmd/5Z8ZrYX3fQGjpBvKJMFa44pgSOdp3vVnYVWma93OylG94ZgU7tXKMb+Ba+Mhfk=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064539; c=relaxed/simple;
	bh=vYBOFI2bT0XfO6WSIeRGLJWYCmAdV4Ge1NDI7L/Dj+4=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=P183NFcj9I9jo9+EgSkM55aFxackrnvq60vC7alfbUVp2INBZjZCkWpMOSMobKt9e2eEUmlXnIepXVLxKRFqn4B7Pwmpyd5rJQ20/YtCCJhnEIPrR/JoCXNBLMVN7QH+t2FRFSMD9PHBQTDkcz39Nw3V2Rqnf9t5ZkyPKAKy3lI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=aZRtPhyG; arc=fail smtp.client-ip=40.107.94.87
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="aZRtPhyG"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=WBSjLcUFFLumIRlsFaI9RRixHVByweFgrOd08KIK8187hJHt7K3kUTdaNrYMcwvU3c1UL5/43O365LQP1CPdO2k+xwXs5pVoJQpMcoiZTl7FelxrXL5qcohDe0vVOOexc3+ktWzBIwLRZKjkzO3RRqFIbMJihUPg8t7O/yDbnU8HjRTZQWdKXG4RL+ZoynOFbfZC2Q6BLq74KizoQ1ZP3TW+SJ51F/d0F99Q6TaGQhF+9RwiDmdD39LBJuVWoilkbyJlCgVSHUTrVqAVo0mTj/38BPPjPHR3vgKeCZ3RjHgmZ5hUyV6QcoxbYn3I3HahIHui78uuoSRqXTCYmo3Pbg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Wp5zQNnwdNVAo/zrWt6sVtKewFcNn61WN4rfGbpfDIQ=;
 b=uKDlvhk/lL8ehVK5cYND8zCkhC5GVRzlBEow7FVOM1uU2Y+iu+rL5QfaSD1YIK7SVLyz1LToI0YdY2qIy/ytZthRl0ZwCee5UWWAf30kIpWtZhHEF6V/MJruzRuW90Q1trZAnUyiRu3ySnPAWZJqOgKT5Fh28FJpZdppw7qlk1qTmqZJuPQNawsrFHsDK3tyXr7zLsUlCZjXscp6YSojYuNSIOVwb7v6J52gN7Wogx5WQfGhAiY635K1tq7JxT3K2t+SbfJX8QCqvVwWXlYGy8bbzTkPzPTOKV+d6kqlaFbh77c6sLyz7MK6XAVcpoxMzytY8DRmM3BdNw5rJNJpSw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Wp5zQNnwdNVAo/zrWt6sVtKewFcNn61WN4rfGbpfDIQ=;
 b=aZRtPhyG7JYCZeuhMDl5+qPQeAxnDzrfp3H9PNOQwy4YvT5tnDf1EhNQ4pGutmmGq9c2fl0/W2fnE8Wd0idESPVOUIM5nu0PnjH9ABMSM2oXaMwByB8yrLhQmdRAlAzs0SrSTtXuncF/IRzmN+uLmuPXh7S9xXO9D+aHd1Fz6Tc=
Received: from CY8PR12CA0046.namprd12.prod.outlook.com (2603:10b6:930:49::24)
 by DS7PR12MB6310.namprd12.prod.outlook.com (2603:10b6:8:95::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:28:54 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::4d) by CY8PR12CA0046.outlook.office365.com
 (2603:10b6:930:49::24) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:54 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:54 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:53 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:52 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 07/15] cxl: support type2 memdev creation
Date: Mon, 15 Jul 2024 18:28:27 +0100
Message-ID: <20240715172835.24757-8-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|DS7PR12MB6310:EE_
X-MS-Office365-Filtering-Correlation-Id: 49257c5c-dd99-4194-1d12-08dca4f399e8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|36860700013|82310400026|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?BQQ8IvjF7W81b734u3uEyUBDHwhEu4vwLCsTgelebOtd4hlnpGOjLfvt/3I2?=
 =?us-ascii?Q?hJOiI0G7mx8QU7NlfUWnLOYX6WI4kS4TH2oQaVEhueHvMlJyG1FY2di6rbb2?=
 =?us-ascii?Q?Vr6jCiZ6PGM3pDJO5hA7H2XBnhCAXkrKwCxUjdS30pSb9NYe5PBq2o3JglLV?=
 =?us-ascii?Q?K9hon6hv3eCQYzs0JACaT1u94d/nxwEuaYSFfXrAeg6k8pJTx6wpUyweLGVT?=
 =?us-ascii?Q?IS5RKRw3WCOvIuIc/b+pvYs3Q0ZA2cFl4/7dZ4OKAGDv5V7Oi9ESma0Y6K0Q?=
 =?us-ascii?Q?/8nOApt04RFm8/8iMGcAzRaApCf0iDazR8/xKUqNxW0bqHXAeSmr7h8pOcEw?=
 =?us-ascii?Q?oiZxD/XndGTlWT94WzIf9WkJ9Ql46ONUNy9q9XQ9KYNC3IWRp0JXQATwCd1j?=
 =?us-ascii?Q?5GHr9GKIm4Zg01qebdymDKeThmUmHODBMQrOcDemkYtbEjQBB1L3kJnT1flW?=
 =?us-ascii?Q?zDJ1z7PiCQtkmOthZ9LPz/IH6D2dLl2QBxQLA0e+jZ6LHoO7SCr/eSVo5Uug?=
 =?us-ascii?Q?y+TWPgf8axHuzobM7cwLhkr/L+9DIYyJUCjz+NqIP8M42XU949Zf65rPnee2?=
 =?us-ascii?Q?ZBhmAGUnskEzSzMWFLvGNKz/wLTi8W8VJft98It0t72IgbtyI4yB6EgG+nPo?=
 =?us-ascii?Q?h+ijfrmS12nlUz7CTevUVaUgveA1/11WE3xd0YkqFCydsLJNSm7O3Fe5wGfV?=
 =?us-ascii?Q?xMIEUI8GeXZXVseK9t/cOrO4i/H5ev5NdfHHq5gw+EIN1Nn7no7ksPQ5jivG?=
 =?us-ascii?Q?PJblYjxx4uEJEEwdoZyoBAnprbhZGfqRbwTWsDBYQ1UIS6UHyPZpeDED/WAd?=
 =?us-ascii?Q?1PVkzm/WeQJnKlwzUS7eA0TsMttBhYT34AOcbp/P3lHuo/s/jn7yAAvVLIKd?=
 =?us-ascii?Q?pOEeAUJnp7xFCTHJtuzF/6Kd7oeVTlSMl4JRKqbAAMEFGLN9T6skhUgUk6Y3?=
 =?us-ascii?Q?UODxuZuUkElx8CLRgL/PJqzFXpHTBgS7D1DlNH3DAF1gtuMcgDTvEfwn+wFJ?=
 =?us-ascii?Q?CjgYhrJU7aGfiqqu3+ZuYEftscdoxxcJTZGkv0FQ/vtrpRXAKVDAMPHPdLwi?=
 =?us-ascii?Q?Dd9VnKzLf0HyCRiO6QG3MfsIBqmt1cDfEl/c6Y0Gp2/6F1QM1VOKzJobbOfL?=
 =?us-ascii?Q?OaIx1m/lTwIFMI4DHMXvKFKxiCEF44MQwxkQF1PASeSJYiK1P/bWu9rRZD4d?=
 =?us-ascii?Q?uj+PKJmPs2Uxti6Xxp+2BIGNxGON92enxZYAyMqU43yPOEQYwBQLW31ki7PI?=
 =?us-ascii?Q?xUkhxsTPa8st1T5weJhNrWTfMd69+oZ11lE+6SCmvf2VVst+Vr9O28aThHPR?=
 =?us-ascii?Q?qJmzlDwQBYzvRGeydMIokbIG02Egc84PHxCM1YY06B//J+E0qiyxKVTljain?=
 =?us-ascii?Q?1OyRX9r4BkTz0ybXay2MDovIkm9riUKfR6OaD1NFLKv0VIpnkBp1g/qsxPFE?=
 =?us-ascii?Q?V+mL1ouOhLXRcBaOvjgWnMNwyKpVN2ttECpXzBi6X7DHHFOVPSTjwg=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(36860700013)(82310400026)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:54.4651
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 49257c5c-dd99-4194-1d12-08dca4f399e8
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS7PR12MB6310
Status: RO
Content-Length: 5293
Lines: 141

From: Alejandro Lucero <alucerop@amd.com>

Add memdev creation from sfc driver.

Current cxl core is relying on a CXL_DEVTYPE_CLASSMEM type device when
creating a memdev leading to problems when obtaining cxl_memdev_state
references from a CXL_DEVTYPE_DEVMEM type. This last device type is
managed by a specific vendor driver and does not need same sysfs files
since not userspace intervention is expected. This patch checks for the
right device type in those functions using cxl_memdev_state.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/cdat.c            |  3 +++
 drivers/cxl/core/memdev.c          |  9 +++++++++
 drivers/cxl/mem.c                  | 17 +++++++++++------
 drivers/net/ethernet/sfc/efx_cxl.c | 10 ++++++++--
 include/linux/cxl_accel_mem.h      |  3 +++
 5 files changed, 34 insertions(+), 8 deletions(-)

diff --git a/drivers/cxl/core/cdat.c b/drivers/cxl/core/cdat.c
index bb83867d9fec..0d4679c137d4 100644
--- a/drivers/cxl/core/cdat.c
+++ b/drivers/cxl/core/cdat.c
@@ -558,6 +558,9 @@ void cxl_region_perf_data_calculate(struct cxl_region *cxlr,
 	};
 	struct cxl_dpa_perf *perf;
 
+	if (!mds)
+		return;
+
 	switch (cxlr->mode) {
 	case CXL_DECODER_RAM:
 		perf = &mds->ram_perf;
diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 58a51e7fd37f..b902948b121f 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -468,6 +468,9 @@ static umode_t cxl_ram_visible(struct kobject *kobj, struct attribute *a, int n)
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_ram_qos_class.attr)
 		if (mds->ram_perf.qos_class == CXL_QOS_CLASS_INVALID)
 			return 0;
@@ -487,6 +490,9 @@ static umode_t cxl_pmem_visible(struct kobject *kobj, struct attribute *a, int n
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_pmem_qos_class.attr)
 		if (mds->pmem_perf.qos_class == CXL_QOS_CLASS_INVALID)
 			return 0;
@@ -507,6 +513,9 @@ static umode_t cxl_memdev_security_visible(struct kobject *kobj,
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_security_sanitize.attr &&
 	    !test_bit(CXL_SEC_ENABLED_SANITIZE, mds->security.enabled_cmds))
 		return 0;
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index 2f1b49bfe162..f76af75a87b7 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -131,12 +131,14 @@ static int cxl_mem_probe(struct device *dev)
 	dentry = cxl_debugfs_create_dir(dev_name(dev));
 	debugfs_create_devm_seqfile(dev, "dpamem", dentry, cxl_mem_dpa_show);
 
-	if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
-		debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
-				    &cxl_poison_inject_fops);
-	if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
-		debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
-				    &cxl_poison_clear_fops);
+	if (mds) {
+		if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
+			debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
+					    &cxl_poison_inject_fops);
+		if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
+			debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
+					    &cxl_poison_clear_fops);
+	}
 
 	rc = devm_add_action_or_reset(dev, remove_debugfs, dentry);
 	if (rc)
@@ -222,6 +224,9 @@ static umode_t cxl_mem_visible(struct kobject *kobj, struct attribute *a, int n)
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_trigger_poison_list.attr)
 		if (!test_bit(CXL_POISON_ENABLED_LIST,
 			      mds->poison.enabled_cmds))
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index a84fe7992c53..0abe66490ef5 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -57,10 +57,16 @@ void efx_cxl_init(struct efx_nic *efx)
 	if (cxl_accel_request_resource(cxl->cxlds, true))
 		pci_info(pci_dev, "CXL accel resource request failed");
 
-	if (!cxl_await_media_ready(cxl->cxlds))
+	if (!cxl_await_media_ready(cxl->cxlds)) {
 		cxl_accel_set_media_ready(cxl->cxlds);
-	else
+	} else {
 		pci_info(pci_dev, "CXL accel media not active");
+		return;
+	}
+
+	cxl->cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxl->cxlds);
+	if (IS_ERR(cxl->cxlmd))
+		pci_info(pci_dev, "CXL accel memdev creation failed");
 }
 
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index b883c438a132..442ed9862292 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -26,4 +26,7 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
 int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram);
 void cxl_accel_set_media_ready(struct cxl_dev_state *cxlds);
 int cxl_await_media_ready(struct cxl_dev_state *cxlds);
+
+struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
+				       struct cxl_dev_state *cxlds);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (mail-sn1nam02on2043.outbound.protection.outlook.com [40.107.96.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6AF1B535B7;
	Mon, 15 Jul 2024 17:28:57 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.96.43
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064539; cv=fail; b=DDoXpqQo0YftW/CkmBH6WhinqLlxXXusOsMed7xfeBvT9jSZKb+835XVUY7LfWUCZ6Xiw5CKG6nPXRrs8KkXIu7dzcgM6o3M09YiSTmWNN+2eAXq2Q/Rv2oXSutBygz/tykm9kC9GpjQUKhaVRCa2wEc5Qlp1B+tP6Ble8Pgdzg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064539; c=relaxed/simple;
	bh=3TifW9WFW7DjDvpsXYzB3X5fPqgcKoS+0+St87XYMNM=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=JTu2Hiwc+nQ79TTCr7c/GUw4QkVsfAZUI2NtWd3GApgdts67W1GmJ5D3sxpkESus8ek1tuHMVHmx1ov/67Ge/P6B+zsP+waur7oQCSTt5iL/Xyzf1bu2JousblYgStR4T8J6mW55o9GZHeXmTKELXOLnVlteagCFNQ+ZgNIEKMY=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=xgiQj5v2; arc=fail smtp.client-ip=40.107.96.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="xgiQj5v2"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=rJ/d585n89kFudGFDgcI0iaeVcGzga1KZGGIn0yTA9rjzpPtkzLApfru0iWvKvyFYecrnB0xoyY3WKPvLB3dXvTOE77PXQ2mdez5zTyyxhclNekRilNuwdXhtYDr6qySjms26IhtEntnj/UM8PY1TlytZOG3WwAMfyLTvLJ2nksvidiUojR28GFXtbJSKoXb+tOkbyILZZ46GVmMpf9mRC+uVm84Phfa6kc9BDOQeciuwh/PJECZdU4gDkeggjUGFLsTcU0ucXtivcuOmmm6rL6ZcaX1Om1CWU+4Nm3Hmv55Y1dSYz543qn4Hnxe92VYJ0QW13LpfFkvRkh7+ZBa5A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=k2QcRmqYhrwOkpEDbHI3M4kvRFcZfeVsePYkcK6LbgM=;
 b=FreNl4bL74rLusYJTk3OJKCHqds+Oyc7CHXBqGujmAFQhuEjfOqbct8nY6Wt8Kk3wLQDDEFdTmM3jf3S6zVhuauDX620rrT86RKo9UwV+++mXDNGj7LLyPGkx/0SLTce9FXMeFPM/44Cvizd6kdA1YrsLSKGpASVGbGa7tolxlJoxS3t/CghZyoSxLVYnEcCWNcbNg0a02b9p+oOObCc1dWL5uKJGbf0BUMqdgc15efhKyPRQSxvPRP8UrP/O7QpEdAEkLhh4MnSM3xUoXBElaLlTCdIf0bACLCZlm9F3ejv+xQG3CEaDNeQpDHUgt2fGG7y/OZErEbuckdqKSURKg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=k2QcRmqYhrwOkpEDbHI3M4kvRFcZfeVsePYkcK6LbgM=;
 b=xgiQj5v20ygqoIIfWFWyISZtsKp7VGMzj95AKO/D02Y6ffWnYafcP3PIYXWBOQ3QmXE+UDmgg/s/hv5aLQ2aSLFfZEPY9Emur3TmFtJ07QScX4RNEqbiN5dySUjXHR29sPUmqJwCEgaVd+9HXnnZ403RsoLZdy9Pl8L5Vbm+roE=
Received: from CY8PR12CA0032.namprd12.prod.outlook.com (2603:10b6:930:49::23)
 by CY8PR12MB8194.namprd12.prod.outlook.com (2603:10b6:930:76::5) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:28:54 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::57) by CY8PR12CA0032.outlook.office365.com
 (2603:10b6:930:49::23) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:54 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:54 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:51 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:50 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 06/15] cxl: add function for setting media ready by an accelerator
Date: Mon, 15 Jul 2024 18:28:26 +0100
Message-ID: <20240715172835.24757-7-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|CY8PR12MB8194:EE_
X-MS-Office365-Filtering-Correlation-Id: 12b2a20f-734c-4a10-bdbd-08dca4f399a7
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|376014|36860700013|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?Eb2alPltNkuP0t8NC9hc6nT0Q01LrUSZbqlxn9PhrUupClqNI701jzl+kDcR?=
 =?us-ascii?Q?NSxHwBHLvHSwnHrLJdVKQ+i84rYf3fbMez+bSzlMrtsdoV7WhZMRs7zAr4d8?=
 =?us-ascii?Q?Dh3243Sc5AAC6YGRxRNpW0UH5t4Bf9JYSzxySZdZ+/UPBh8bqRR7LdkXCnl5?=
 =?us-ascii?Q?kjYDT8LSdBOKcQt8MN/XuU1JeHFDp76/eH43oHtEMFtxRQ5LWluyMdDXwi5m?=
 =?us-ascii?Q?dwp9qNVqanhIh4sVgWiM2Nl5jeVTOzyavlCAUZH08+DCra+LtdxPJqwf4BZp?=
 =?us-ascii?Q?obgtL7ADe4OSIKzPucfqh6pcB9DQfspi8jxNoAmeF2/6ANyGLeGA0QrGQHmj?=
 =?us-ascii?Q?qL2GxC8BClB5Rec5PM5BKtffrbYN38k31aWo4gbtUrcBpzr+WH8CkifPejVK?=
 =?us-ascii?Q?Wjas2QY5I0lzunrJRe7OZjV/42ZbZm02Lf0NjRPZWaCggJcYsi1SWn9l5qea?=
 =?us-ascii?Q?N9zdWmZOjNWnNqedcFINJYwkRqKLNr17b3YVXmN07E9UxssafJWxrjKNBIdI?=
 =?us-ascii?Q?kvDdkMT8TSJ/K94j3OC62Y/rLB4BLk/DC2LGZ+In0Coxpbkt63OxlM7Xf7Dk?=
 =?us-ascii?Q?duMXm7paovaLzAd4riBb4Dq4Fc3h7MUWT42Vh5pEqNgFwdwlwNDcsk46W3MY?=
 =?us-ascii?Q?sgZ7OL5zsKg8jFddkExl/EonZjVQfMDAjWFycftmAiyZv/XB3n8xV9s3JBxV?=
 =?us-ascii?Q?nt8fXWF6agD/FYIp8GI4oMY5liuRppsaP7teUHL4q6goefWdEAdq8y7BR+bT?=
 =?us-ascii?Q?9K0qlmAH+slF46wKuNjiJ0aE1JGFh9i/Z8U+o2UQi/N8zyy7H9Fs+nR/raDa?=
 =?us-ascii?Q?+Rr6RpcBqku5TsNSrSpc2WsXLvpLUMcDilv5twxmsJQueIQ8MG/ydhftrJLz?=
 =?us-ascii?Q?jyq2JZm4UyFT0X1dcpgWZ+O/ZX7TF8M+C3b0t3XJ+cDlSLJyNMlIOH5rbScv?=
 =?us-ascii?Q?VnbKI++flcH4Bedw7Ch+SEei/xFEJ/p6Rnv2Sl3tFjT5lIMaLP8ShhStdcBq?=
 =?us-ascii?Q?j3u1pSukQzO5TBtOFzYGRC7+L7+hZ5FkYQCMGxHG0t4qpj93y1vWXIlamfGM?=
 =?us-ascii?Q?o2q5iJoOTB1nVyGWc4iTnuhS89wYXk3YtykYmLnQrS4Gm6qky+8Ep0rXjU+S?=
 =?us-ascii?Q?jDkhi1Zai6G5nharFECBdVvosj0X0/4/EIDiH3zPA2ButeaZ4tuARBygf0Yp?=
 =?us-ascii?Q?iEfupQBYDNrUnQ5hKbgs1q3LfsF9c8cetvUkwNk96HVTdsA4lev9GrFQdph6?=
 =?us-ascii?Q?1K58v66VVJfKPsvAJLBL1Hv3wV0UtaECuOSYCwSAe7otfl4eDBsaWNSrkXsu?=
 =?us-ascii?Q?8A+HT3Dv+NwK9DhiQOmwpS7MqBL64bi+mFd5bCg1AHzJz0gmhOnLprvLMYOB?=
 =?us-ascii?Q?INbpRiGpm69QMDCcJzOYMn0PsOfgR4wnETsiUMx4VQK0IO060fq6B5NyGNtK?=
 =?us-ascii?Q?0ZQePeMtaO5UDKtPjMYiu2UgnjZ33vcLdy+UKF/1q+ZiUrDKgBMWFQ=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(376014)(36860700013)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:54.0276
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 12b2a20f-734c-4a10-bdbd-08dca4f399a7
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY8PR12MB8194
Status: O
Content-Length: 2352
Lines: 68

From: Alejandro Lucero <alucerop@amd.com>

A Type-2 driver can require to set the memory availability explicitly.

Add a function to the exported CXL API for accelerator drivers.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/memdev.c          | 7 ++++++-
 drivers/net/ethernet/sfc/efx_cxl.c | 5 +++++
 include/linux/cxl_accel_mem.h      | 2 ++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index b4205ecca365..58a51e7fd37f 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -714,7 +714,6 @@ static int cxl_memdev_open(struct inode *inode, struct file *file)
 	return 0;
 }
 
-
 void cxl_accel_set_dvsec(struct cxl_dev_state *cxlds, u16 dvsec)
 {
 	cxlds->cxl_dvsec = dvsec;
@@ -759,6 +758,12 @@ int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram)
 }
 EXPORT_SYMBOL_NS_GPL(cxl_accel_request_resource, CXL);
 
+void cxl_accel_set_media_ready(struct cxl_dev_state *cxlds)
+{
+	cxlds->media_ready = true;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_set_media_ready, CXL);
+
 static int cxl_memdev_release_file(struct inode *inode, struct file *file)
 {
 	struct cxl_memdev *cxlmd =
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 37d8bfdef517..a84fe7992c53 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -56,6 +56,11 @@ void efx_cxl_init(struct efx_nic *efx)
 
 	if (cxl_accel_request_resource(cxl->cxlds, true))
 		pci_info(pci_dev, "CXL accel resource request failed");
+
+	if (!cxl_await_media_ready(cxl->cxlds))
+		cxl_accel_set_media_ready(cxl->cxlds);
+	else
+		pci_info(pci_dev, "CXL accel media not active");
 }
 
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index 0ba2195b919b..b883c438a132 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -24,4 +24,6 @@ void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
 			    enum accel_resource);
 int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
 int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram);
+void cxl_accel_set_media_ready(struct cxl_dev_state *cxlds);
+int cxl_await_media_ready(struct cxl_dev_state *cxlds);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2078.outbound.protection.outlook.com [40.107.93.78])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5528750285;
	Mon, 15 Jul 2024 17:28:56 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.93.78
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064537; cv=fail; b=ZcbqYCpJddVcAQb0B7KD2iZ+01BFWNnQ5jlS9jMN+Y0NncDmXO0oH8lpgC9RYekC7XgSGZqERcydAQNZy/0u5Fac5iQZNzi01/VC5ybPmlAKTQY/tNvwKolvYTVOsW50lfIVH5xqXvmJMJlEJJaChpF0qB+Soq5OqolmYqyoHfE=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064537; c=relaxed/simple;
	bh=jWl2LN9rAvMP12J+Jb5x05YIg2LLk0ytcompyghuznY=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=klJFXg/Yr0PCF3qFaQsuozSqdGahEnOErWjFU52f3JW1ssrt4wjeMoHJlmszxMU6IcBhMXZ+paELGzAGSIhAiYJXQnZ2OuW63G83Tem0LJgKtGb1z4ktU1kT6SlwK4LfyTDHkgBPr9/IFoPlZi2IwwJ/QxXpC09weQ3Iz8KVWSw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=4FlbBdEx; arc=fail smtp.client-ip=40.107.93.78
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="4FlbBdEx"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=u7M+pomQEIJTyZsALy5kk3BQHfB/fi/A7i0Qf5Lr3sbME0er5JkxotRyuNtjSvw4MiVA/aQgb/Hso9lStUORuh2wso58AjJh3EZok9ojL4HuRAs4ex4EQXSX9XrXJkj4IzzRbDvXi6AFtkzIck2tpnLCPSIGCFQ7VSfm4Smkv5bwMOq0RFNRKGr1+Zr0M/ygE0z1jNvVzHEuKNsR/wBCoyNMDu3Jsok5SPVL5rTe7Ax2aA6QsvvTgRc/QLm76ODo0NQ308ry/w+ek4DLa9l+8tdDuA2otHE8ovV7HDGmJ+Wk3VuPUmjhq83Y+Cbu1vaREXYAzu/jANcjgKGMdIPXCA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=L3vC5F3A/E95qWGqMXa9QOWGkI3xa+Vj8uXJAL6p01k=;
 b=sDDKOepsZeTybT+tU0FA9S16Vh9b3i0X1lnHCQkrhQXptWxZSDBQUg9QeUA3mm8RtGcdAOtPTbbtoQbUFVBtg3PHNEkgiUMT4MZVKaRYVuYAsZiNUFAwHEuOojM5fWSVWZ1LXomjRUGTVRdVC1PRalv1zTO8RiOcc6BIG4D6X/IAqVQ/sk/5M0eHzptkDhwShEVGh0nXc0RdQ0h5M33iKQ5AgDbmdihLa/tkT6RYamIcTsH+T0lMYgwA0vKMKyDlVTRRFWwwJMH93P9/ou3dXwfgAGAMLBaoLFhJ8YhnIppbHYK7znTi3TimcLQu7t/O/8IJNdH9WBIH9G/6fkc7XQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=L3vC5F3A/E95qWGqMXa9QOWGkI3xa+Vj8uXJAL6p01k=;
 b=4FlbBdEx1aiwEarsnwOU2OrCUcQYy+JTss0L7aPxPBm0rRjuGVknFE08DEmTOpxy/8Q0g5HASoUjBXdMqt9/Kxtqg3d6xm+7+IhDuQlTQF012DphX3nl+EiyS1I682/QZ8rLbLZ2vTjfklLCmXheC6KxYEeSfL9CwAOhpo0HP00=
Received: from CY8PR12CA0026.namprd12.prod.outlook.com (2603:10b6:930:49::27)
 by BY1PR12MB8448.namprd12.prod.outlook.com (2603:10b6:a03:534::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.22; Mon, 15 Jul
 2024 17:28:53 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::63) by CY8PR12CA0026.outlook.office365.com
 (2603:10b6:930:49::27) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:53 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:53 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:50 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:49 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 05/15] cxl: fix use of resource_contains
Date: Mon, 15 Jul 2024 18:28:25 +0100
Message-ID: <20240715172835.24757-6-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|BY1PR12MB8448:EE_
X-MS-Office365-Filtering-Correlation-Id: dd8b144b-87bd-463c-2494-08dca4f3994d
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|82310400026|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?O3b2mkGo20isTVj7WbO7mv2Oew3AnM8D/1JB58qFtWGPb9J3bkHjxQl+Dc4Q?=
 =?us-ascii?Q?jH2Bmb7HRzTD3+AdgYzlc2Brp0kv7Bqd9+mO0wbxV7WA7SqPV9D4S/yyy6uP?=
 =?us-ascii?Q?i074w5+dkOGz23IZKKXbUG804qEBTIRLa6IIWclc+c2ctScbqXhoE2t26KGM?=
 =?us-ascii?Q?E/4a+RO09whrxaLmtBDJj+TiTMq2hLo/1r5IoLq9eOZ9o7jUeq+b1H8Lo2BN?=
 =?us-ascii?Q?zaTBsNuSxxpi8fUrK6I2/PQxVzD+n+OFDCcyYgCincGnC9pxLHDhoYF0buuq?=
 =?us-ascii?Q?TYylBamiOyR+c7uf1m1E1eJErGd2BNlstk0vC0mmkB2g+5Gj49vx4UqXm3Mp?=
 =?us-ascii?Q?8eyKjJGutz4qzRlGsFH5lA8YKdaiqAn5tAaVtREPQNl0bFjUJzDXHBvJ4ftl?=
 =?us-ascii?Q?3rU0+DjbVtckyQErnPueXYRiWV9xZxi35LX+wo3rpbV62r7a7AH3WK4uONYt?=
 =?us-ascii?Q?itXuVvTX+KPIl9Ljo1hemymPl4lCvU3eMJ/a/VK+WKr3BSCLleNczGfo/Yxz?=
 =?us-ascii?Q?4Ptm6GQrqyGgXDSIhpidXPCvWRALoaS8Y52RcizPgktydFdvBYBnd5xrxzdm?=
 =?us-ascii?Q?mW6b8bOvblUJI5ODrmrB76EE0pcYK2STVBVKWJlV5sZoLttdwQwBzF4asW1M?=
 =?us-ascii?Q?bamUiOnQHVwPJYkFUJP1+vx5dvXHi8ikQxZ6vbk+AHfBXa3ncxilwdFlmpzi?=
 =?us-ascii?Q?Eu215wgVMcb6QaFXij4HopQupgMhB+kIOiiKqYNHPAtIGUAQNN/ZjKAZUP5T?=
 =?us-ascii?Q?9ZOg2jncTRrcQBLjUnH2PvSq9e4O8rQMKqY2EFtInQi4oKv6JZm3NOHYsf+7?=
 =?us-ascii?Q?G+9fqbgZAtsVLxZyJFdOQke6CUvCMtq5Ar9SjETVmyP84urDb8os8+BCPs5C?=
 =?us-ascii?Q?Q6uubxMHLRr5aBASEfhPOtsgy2t1lYvcy8RMNEPdOjWDc6HZQqKfnQpwdeMg?=
 =?us-ascii?Q?YjQsvAP6gbf7he6YbS4NnqWrqKABe4sXuajwVAXkjhyw1Ygiiq8+7y5laLbX?=
 =?us-ascii?Q?90gl4hsi1UJRLkmx/QGfBQI9dD+sazHVvsZvJHGyHJci4dcltgfrWyUrXvl6?=
 =?us-ascii?Q?B8nen1mkfEudJXyErsjgOvc9pBN3GqDN+Zwv0mN9fedDK53FVO8c6RpUr7W/?=
 =?us-ascii?Q?3SyHJxE/N+HrUc40kMVwEyUkU5fXsL47s9bfwOlQQLi32pxEAVZ+aVmfFIrV?=
 =?us-ascii?Q?+RJpk4xlWntTws/JLi7rSo30v0hG5Ag7SfWGRU+BCNjmPFFjOxLQ9LyMm/x/?=
 =?us-ascii?Q?dtUNot4vq8//l9EaA23LCO6o1kd8/4vEeQ7VEpt1QQIzI6sC9zoNPvMnINgj?=
 =?us-ascii?Q?0cnXFjpJ8gakGWtkJCDmzmCw0iM0/1UjGGUG+YO9wE8vtp+oYaQC2ZMvLlo4?=
 =?us-ascii?Q?Ek9EFlZQP09fz77kCFGOVPMlIxyTZ41BEb/QfjJTXc5L4zbjfpl/LdYOiUA1?=
 =?us-ascii?Q?5UEQScCk5a+bQi2jk0xHxvO7zzNHKHtG0LxT1dVeuT2TKgFabjIPlw=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(82310400026)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:53.4339
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: dd8b144b-87bd-463c-2494-08dca4f3994d
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BY1PR12MB8448
Status: O
Content-Length: 1223
Lines: 35

From: Alejandro Lucero <alucerop@amd.com>

For a resource defined with size zero, resource contains will also
return true.

Add resource size check before using it.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/hdm.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index 3df10517a327..4af9225d4b59 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -327,10 +327,13 @@ static int __cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
 	cxled->dpa_res = res;
 	cxled->skip = skipped;
 
-	if (resource_contains(&cxlds->pmem_res, res))
+	if ((resource_size(&cxlds->pmem_res)) && (resource_contains(&cxlds->pmem_res, res))) {
+		printk("%s: resource_contains CXL_DECODER_PMEM\n", __func__);
 		cxled->mode = CXL_DECODER_PMEM;
-	else if (resource_contains(&cxlds->ram_res, res))
+	} else if ((resource_size(&cxlds->ram_res)) && (resource_contains(&cxlds->ram_res, res))) {
+		printk("%s: resource_contains CXL_DECODER_RAM\n", __func__);
 		cxled->mode = CXL_DECODER_RAM;
+	}
 	else {
 		dev_warn(dev, "decoder%d.%d: %pr mixed mode not supported\n",
 			 port->id, cxled->cxld.id, cxled->dpa_res);
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2075.outbound.protection.outlook.com [40.107.92.75])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6F9B8481CD;
	Mon, 15 Jul 2024 17:28:54 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.75
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064536; cv=fail; b=CAQmnwglEJNhoJ++7cybPnYKs7YEZ/uTsxIt2xzG7DYokgTEvWHPPYJ5T4Q5JBfQdBLBIQV3evAO5qFcyJvjsxGWIjlim0BsqXJ37pEr/O8Tbj3BWxTrB0wLgoy0ruJNqJvcu/yCH5SrzxR7zstCODn4kznTppNZn7zWIUp7DS8=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064536; c=relaxed/simple;
	bh=Oa/e9wb5h3jNEP3DHIepxNpYhzzLgaOQrgbxp5b0rxo=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=g11mBdE6A8ticJ9AV40QbrkS6RYglWsAef9ImWm0fNDRNo6kbawkLCzZHI9REct1x4i8a7g8EKxUbTG45KvDeSv9L4y3XIAXXHQxTJsapt+EU2o+ekkZ3EYmMGrSa4fHJ7B+zqO3LVlss+TYTF3x62BS8GpW+xrPv/9lD8G3EEI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=S4YVMii4; arc=fail smtp.client-ip=40.107.92.75
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="S4YVMii4"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=BvrOLBh+0KT8qqIKFDwkNkiJeO7W/2/hxc7DwZrEhRhHouBNr/3IwcyzIN6xkQ492EaU7SW+JNp25F8lxEYaslQFqKBVbusLL+iLbacBwreL1T9tYghF+mAABTS+7eivYO9qFdt0E58RD7DGGyDhvd+NEMf5NHS9o2BX7ySA607VXugqVotHW4frxJBJQyVMlaPvTMOt831tyHIhhTOhFJn9utUJcMXF+wTovd2Dudaxc2xxGsLqV9yXof3Q/lwL3sEVSQ9gKJ4+Z1Fy2oMb1oHN6SHzCG3T8DSSkf5ohDuqw6VEk9l0SR1lJNiEg8dNzN2q1962Lf3PCaKf3ma67A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=YMNBtYKx5gHyDrtdQ/82TEODfgFpLHEKyB2LfAdsiOE=;
 b=fAmwZECaxz/Ftqe4iXUvJnXvCjTfW/0G0r6m9MqKafcKRKHnU8Rj9RbRXXmuAHF8G1xrNDzarcPCKBIaHHOYABjFCpZPIxqwt1L3QSYvaAR83cXHv+Yej2fM6XFEFaKCyNVkeRGsmv8ugFTF/ypgC/BKxC8sJ7Ak8GdHa/zBtOfLDo5gPxY6+xn+Fn2eOMWvkTCaRuNYHaMHy7FlXm0tGheddlF2HWQa4sdGp7nT/Bqynt/NW3vSEuaKjzWvDujMQoKyxyLStwPGPYYnEFC8wuDPm/dErzppcPfYB8Ms857BlsQECF60qWAFcvdxG1bPgF+teSliW1IPMSa4lgkZmQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=YMNBtYKx5gHyDrtdQ/82TEODfgFpLHEKyB2LfAdsiOE=;
 b=S4YVMii4fnlAWMBEumBC3i4o6m38+UdNtLxuYMgllrPgSe2ha1RkmUbfc6EXu+cfQq1VsUpDzc3mnyak6+IZK7TN++sHORAj4ArzFffTVKQligvkC+YsitHiZS771qOHspnu5kEGOTUgkCkGUTqxpu+ZPg6k5NeL0k5lPWMt7y0=
Received: from BYAPR07CA0064.namprd07.prod.outlook.com (2603:10b6:a03:60::41)
 by SJ1PR12MB6289.namprd12.prod.outlook.com (2603:10b6:a03:458::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.23; Mon, 15 Jul
 2024 17:28:45 +0000
Received: from SJ1PEPF000023D4.namprd21.prod.outlook.com
 (2603:10b6:a03:60:cafe::7d) by BYAPR07CA0064.outlook.office365.com
 (2603:10b6:a03:60::41) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:45 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 SJ1PEPF000023D4.mail.protection.outlook.com (10.167.244.69) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.5 via Frontend Transport; Mon, 15 Jul 2024 17:28:45 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:44 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:43 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 01/15] cxl: add type2 device basic support
Date: Mon, 15 Jul 2024 18:28:21 +0100
Message-ID: <20240715172835.24757-2-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SJ1PEPF000023D4:EE_|SJ1PR12MB6289:EE_
X-MS-Office365-Filtering-Correlation-Id: fd750184-5d36-402a-fecc-08dca4f3947f
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|1800799024|82310400026|36860700013|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?+nrcrbMOW95CQ8TL1MmdUFHHaKvqEVmnB7MH7swcVA22p2gbvAss2L0C8Nok?=
 =?us-ascii?Q?DXPKxSEhhFGnvCpUYWudKNHuxxu7GIpCoMrLhuaoK+lmza1hpxlS+B8u02EC?=
 =?us-ascii?Q?iLfCqDDnk8WsRjYjQCI/mop4Aisdb35nFlEHJ5pzl5M9mixzx/80MGBYoC/K?=
 =?us-ascii?Q?/tdtT6AAd6KVHVRy8Brq5Ve6886x0E5mJkNH7s97/NJr/xCgnI8rOGpB3guF?=
 =?us-ascii?Q?04IFChz4WlQ5vlVfkLfL8P0qUxRkJSPo8HhSO6cmfzA0QE/DItgyIb6XbZI5?=
 =?us-ascii?Q?8V8n4rNLais42Or+z0afseYYQkXdLjzWcjPlHMFI1+GKFmSjuB9HbMsAmSfX?=
 =?us-ascii?Q?ki9VS2vnPhmtweeU+QNvvtKYETCAWF/1FYXjqkgeUBwgeeayN+sOT88kyIQz?=
 =?us-ascii?Q?cqQygpHzELn+1dXQE/ju3lT+wm3bzLqvfMrgwA9EYUbCym1YQoTav+c7qUOy?=
 =?us-ascii?Q?KXg30nTTvucAj8iUjh5l5QD1At/MNJctgaoxGtf4Hb0fGSV7mbLoEwWUfvYZ?=
 =?us-ascii?Q?hygXC/fhv36iIEZGMauYLF607WLVN4bDL+BLZl0TfzypdhCIt1+hHkOCdlpz?=
 =?us-ascii?Q?dLs1djtnpr13fcgq8FYM+UUAkB9IYnZAnzNGWF1X6XHXankipk94Kf1TsCfD?=
 =?us-ascii?Q?n+oRBzESX3h1WeuPe3u/68asj+WIm3mgTHHDuHbIkHfZDiOIo4X9xvV0SaX1?=
 =?us-ascii?Q?qwG8XcMNlGaUGIjxLK/kxhZoONE0lsjgKlFWUYcaqWSybAgjzW0LQySoXyzd?=
 =?us-ascii?Q?1gfgJzxCZtX4/HLDgBV86EDyrUNi5V3ljOOx2smU+DeXP2TKgl578jl54qvu?=
 =?us-ascii?Q?KoQa9JbP7ti9NK03ywlj8NmBzgIpl3AtMtEJb+IY6QJJUA46luCTLekw2P75?=
 =?us-ascii?Q?rBipcLpW04HXL1+SCeEHrGCYsbTB1pLoHxJhmtHIF9+GyykC9evJqYG79ea9?=
 =?us-ascii?Q?WC9P90Mn3T3Dg3fXfkdGsYSoeQCZVt+AK2YNkvDbUrd7h8pS01M4brItde/S?=
 =?us-ascii?Q?DdE1keaMzYfF96/6JPv8k9LAG7ORQdWoayXe5STf2m05ilzHCSyw54PuBOZI?=
 =?us-ascii?Q?kw0buh2sAq5vY8KSV6flm6rMo9JjI5K4yfZx7CR8S7RJBi9umv/ETlY8tbay?=
 =?us-ascii?Q?g9Z2lw/vAQTo+5vUa37j6kCNpKEAC6qfT0+/ViOmm4AJLOJbETarDpquo3ph?=
 =?us-ascii?Q?FS7yp3gIt+1oX5lOT9svdS2CbWdC/HNhcLdefks3dNRNVYP9dwrhfvssIglV?=
 =?us-ascii?Q?TTUSPfJHg0ZzX6pb6uG/MqAE0lVcsEAp4+JzJTGg/apN5c+3NBaBi/sC8/eP?=
 =?us-ascii?Q?IaPb+ISXux1NfGARK6jPzQzfZK7jnrhauXpmaPgC+kf+SLN3/x+KwnRbKoMV?=
 =?us-ascii?Q?junCh8MsCXhBqHqhGEll7iuwVY7EHCeG025Hg+GSwao89o59wg=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(1800799024)(82310400026)(36860700013)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:45.3786
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: fd750184-5d36-402a-fecc-08dca4f3947f
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	SJ1PEPF000023D4.namprd21.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ1PR12MB6289
Status: O
Content-Length: 10505
Lines: 331

From: Alejandro Lucero <alucerop@amd.com>

Differientiate Type3, aka memory expanders, from Type2, aka device
accelerators, with a new function for initializing cxl_dev_state.

Create opaque struct to be used by accelerators relying on new access
functions in following patches.

Add SFC ethernet network driver as the client.

Based on https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m52543f85d0e41ff7b3063fdb9caa7e845b446d0e

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/memdev.c             | 52 ++++++++++++++++++++++++++
 drivers/net/ethernet/sfc/Makefile     |  2 +-
 drivers/net/ethernet/sfc/efx.c        |  4 ++
 drivers/net/ethernet/sfc/efx_cxl.c    | 53 +++++++++++++++++++++++++++
 drivers/net/ethernet/sfc/efx_cxl.h    | 29 +++++++++++++++
 drivers/net/ethernet/sfc/net_driver.h |  4 ++
 include/linux/cxl_accel_mem.h         | 22 +++++++++++
 include/linux/cxl_accel_pci.h         | 23 ++++++++++++
 8 files changed, 188 insertions(+), 1 deletion(-)
 create mode 100644 drivers/net/ethernet/sfc/efx_cxl.c
 create mode 100644 drivers/net/ethernet/sfc/efx_cxl.h
 create mode 100644 include/linux/cxl_accel_mem.h
 create mode 100644 include/linux/cxl_accel_pci.h

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 0277726afd04..61b5d35b49e7 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -8,6 +8,7 @@
 #include <linux/idr.h>
 #include <linux/pci.h>
 #include <cxlmem.h>
+#include <linux/cxl_accel_mem.h>
 #include "trace.h"
 #include "core.h"
 
@@ -615,6 +616,25 @@ static void detach_memdev(struct work_struct *work)
 
 static struct lock_class_key cxl_memdev_key;
 
+struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
+{
+	struct cxl_dev_state *cxlds;
+
+	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
+	if (!cxlds)
+		return ERR_PTR(-ENOMEM);
+
+	cxlds->dev = dev;
+	cxlds->type = CXL_DEVTYPE_DEVMEM;
+
+	cxlds->dpa_res = DEFINE_RES_MEM_NAMED(0, 0, "dpa");
+	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, 0, "ram");
+	cxlds->pmem_res = DEFINE_RES_MEM_NAMED(0, 0, "pmem");
+
+	return cxlds;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
+
 static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
 					   const struct file_operations *fops)
 {
@@ -692,6 +712,38 @@ static int cxl_memdev_open(struct inode *inode, struct file *file)
 	return 0;
 }
 
+
+void cxl_accel_set_dvsec(struct cxl_dev_state *cxlds, u16 dvsec)
+{
+	cxlds->cxl_dvsec = dvsec;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_set_dvsec, CXL);
+
+void cxl_accel_set_serial(struct cxl_dev_state *cxlds, u64 serial)
+{
+	cxlds->serial= serial;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_set_serial, CXL);
+
+void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
+			    enum accel_resource type)
+{
+	switch (type) {
+	case CXL_ACCEL_RES_DPA:
+		cxlds->dpa_res = res;
+		return;
+	case CXL_ACCEL_RES_RAM:
+		cxlds->ram_res = res;
+		return;
+	case CXL_ACCEL_RES_PMEM:
+		cxlds->pmem_res = res;
+		return;
+	default:
+		dev_err(cxlds->dev, "unkown resource type (%u)\n", type);
+	}
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_set_resource, CXL);
+
 static int cxl_memdev_release_file(struct inode *inode, struct file *file)
 {
 	struct cxl_memdev *cxlmd =
diff --git a/drivers/net/ethernet/sfc/Makefile b/drivers/net/ethernet/sfc/Makefile
index 8f446b9bd5ee..e80c713c3b0c 100644
--- a/drivers/net/ethernet/sfc/Makefile
+++ b/drivers/net/ethernet/sfc/Makefile
@@ -7,7 +7,7 @@ sfc-y			+= efx.o efx_common.o efx_channels.o nic.o \
 			   mcdi_functions.o mcdi_filters.o mcdi_mon.o \
 			   ef100.o ef100_nic.o ef100_netdev.o \
 			   ef100_ethtool.o ef100_rx.o ef100_tx.o \
-			   efx_devlink.o
+			   efx_devlink.o efx_cxl.o
 sfc-$(CONFIG_SFC_MTD)	+= mtd.o
 sfc-$(CONFIG_SFC_SRIOV)	+= sriov.o ef10_sriov.o ef100_sriov.o ef100_rep.o \
                            mae.o tc.o tc_bindings.o tc_counters.o \
diff --git a/drivers/net/ethernet/sfc/efx.c b/drivers/net/ethernet/sfc/efx.c
index e9d9de8e648a..cb3f74d30852 100644
--- a/drivers/net/ethernet/sfc/efx.c
+++ b/drivers/net/ethernet/sfc/efx.c
@@ -33,6 +33,7 @@
 #include "selftest.h"
 #include "sriov.h"
 #include "efx_devlink.h"
+#include "efx_cxl.h"
 
 #include "mcdi_port_common.h"
 #include "mcdi_pcol.h"
@@ -899,6 +900,7 @@ static void efx_pci_remove(struct pci_dev *pci_dev)
 	efx_pci_remove_main(efx);
 
 	efx_fini_io(efx);
+
 	pci_dbg(efx->pci_dev, "shutdown successful\n");
 
 	efx_fini_devlink_and_unlock(efx);
@@ -1109,6 +1111,8 @@ static int efx_pci_probe(struct pci_dev *pci_dev,
 	if (rc)
 		goto fail2;
 
+	efx_cxl_init(efx);
+
 	rc = efx_pci_probe_post_io(efx);
 	if (rc) {
 		/* On failure, retry once immediately.
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
new file mode 100644
index 000000000000..4554dd7cca76
--- /dev/null
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -0,0 +1,53 @@
+// SPDX-License-Identifier: GPL-2.0-only
+/****************************************************************************
+ * Driver for AMD network controllers and boards
+ * Copyright (C) 2024, Advanced Micro Devices, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License version 2 as published
+ * by the Free Software Foundation, incorporated herein by reference.
+ */
+
+
+#include <linux/pci.h>
+#include <linux/cxl_accel_mem.h>
+#include <linux/cxl_accel_pci.h>
+
+#include "net_driver.h"
+#include "efx_cxl.h"
+
+#define EFX_CTPIO_BUFFER_SIZE	(1024*1024*256)
+
+void efx_cxl_init(struct efx_nic *efx)
+{
+	struct pci_dev *pci_dev = efx->pci_dev;
+	struct efx_cxl *cxl = efx->cxl;
+	struct resource res;
+	u16 dvsec;
+
+	dvsec = pci_find_dvsec_capability(pci_dev, PCI_VENDOR_ID_CXL,
+					  CXL_DVSEC_PCIE_DEVICE);
+
+	if (!dvsec)
+		return;
+
+	pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
+
+	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev);
+	if (IS_ERR(cxl->cxlds)) {
+		pci_info(pci_dev, "CXL accel device state failed");
+		return;
+	}
+
+	cxl_accel_set_dvsec(cxl->cxlds, dvsec);
+	cxl_accel_set_serial(cxl->cxlds, pci_dev->dev.id);
+
+	res = DEFINE_RES_MEM(0, EFX_CTPIO_BUFFER_SIZE);
+	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_DPA);
+
+	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
+	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
+}
+
+
+MODULE_IMPORT_NS(CXL);
diff --git a/drivers/net/ethernet/sfc/efx_cxl.h b/drivers/net/ethernet/sfc/efx_cxl.h
new file mode 100644
index 000000000000..76c6794c20d8
--- /dev/null
+++ b/drivers/net/ethernet/sfc/efx_cxl.h
@@ -0,0 +1,29 @@
+// SPDX-License-Identifier: GPL-2.0-only
+/****************************************************************************
+ * Driver for AMD network controllers and boards
+ * Copyright (C) 2024, Advanced Micro Devices, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License version 2 as published
+ * by the Free Software Foundation, incorporated herein by reference.
+ */
+
+#ifndef EFX_CXL_H
+#define EFX_CLX_H
+
+#include <linux/cxl_accel_mem.h>
+
+struct efx_nic;
+
+struct efx_cxl {
+	cxl_accel_state *cxlds;
+	struct cxl_memdev *cxlmd;
+	struct cxl_root_decoder *cxlrd;
+	struct cxl_port *endpoint;
+	struct cxl_endpoint_decoder *cxled;
+	struct cxl_region *efx_region;
+	void __iomem *ctpio_cxl;
+};
+
+void efx_cxl_init(struct efx_nic *efx);
+#endif
diff --git a/drivers/net/ethernet/sfc/net_driver.h b/drivers/net/ethernet/sfc/net_driver.h
index f2dd7feb0e0c..58b7517afea4 100644
--- a/drivers/net/ethernet/sfc/net_driver.h
+++ b/drivers/net/ethernet/sfc/net_driver.h
@@ -814,6 +814,8 @@ enum efx_xdp_tx_queues_mode {
 
 struct efx_mae;
 
+struct efx_cxl;
+
 /**
  * struct efx_nic - an Efx NIC
  * @name: Device name (net device name or bus id before net device registered)
@@ -962,6 +964,7 @@ struct efx_mae;
  * @tc: state for TC offload (EF100).
  * @devlink: reference to devlink structure owned by this device
  * @dl_port: devlink port associated with the PF
+ * @cxl: details of related cxl objects
  * @mem_bar: The BAR that is mapped into membase.
  * @reg_base: Offset from the start of the bar to the function control window.
  * @monitor_work: Hardware monitor workitem
@@ -1148,6 +1151,7 @@ struct efx_nic {
 
 	struct devlink *devlink;
 	struct devlink_port *dl_port;
+	struct efx_cxl *cxl;
 	unsigned int mem_bar;
 	u32 reg_base;
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
new file mode 100644
index 000000000000..daf46d41f59c
--- /dev/null
+++ b/include/linux/cxl_accel_mem.h
@@ -0,0 +1,22 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
+
+#include <linux/cdev.h>
+
+#ifndef __CXL_ACCEL_MEM_H
+#define __CXL_ACCEL_MEM_H
+
+enum accel_resource{
+	CXL_ACCEL_RES_DPA,
+	CXL_ACCEL_RES_RAM,
+	CXL_ACCEL_RES_PMEM,
+};
+
+typedef struct cxl_dev_state cxl_accel_state;
+cxl_accel_state *cxl_accel_state_create(struct device *dev);
+
+void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
+void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
+void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
+			    enum accel_resource);
+#endif
diff --git a/include/linux/cxl_accel_pci.h b/include/linux/cxl_accel_pci.h
new file mode 100644
index 000000000000..c337ae8797e6
--- /dev/null
+++ b/include/linux/cxl_accel_pci.h
@@ -0,0 +1,23 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright(c) 2024 Advanced Micro Devices, Inc. */
+
+#ifndef __CXL_ACCEL_PCI_H
+#define __CXL_ACCEL_PCI_H
+
+/* CXL 2.0 8.1.3: PCIe DVSEC for CXL Device */
+#define CXL_DVSEC_PCIE_DEVICE					0
+#define   CXL_DVSEC_CAP_OFFSET		0xA
+#define     CXL_DVSEC_MEM_CAPABLE	BIT(2)
+#define     CXL_DVSEC_HDM_COUNT_MASK	GENMASK(5, 4)
+#define   CXL_DVSEC_CTRL_OFFSET		0xC
+#define     CXL_DVSEC_MEM_ENABLE	BIT(2)
+#define   CXL_DVSEC_RANGE_SIZE_HIGH(i)	(0x18 + (i * 0x10))
+#define   CXL_DVSEC_RANGE_SIZE_LOW(i)	(0x1C + (i * 0x10))
+#define     CXL_DVSEC_MEM_INFO_VALID	BIT(0)
+#define     CXL_DVSEC_MEM_ACTIVE	BIT(1)
+#define     CXL_DVSEC_MEM_SIZE_LOW_MASK	GENMASK(31, 28)
+#define   CXL_DVSEC_RANGE_BASE_HIGH(i)	(0x20 + (i * 0x10))
+#define   CXL_DVSEC_RANGE_BASE_LOW(i)	(0x24 + (i * 0x10))
+#define     CXL_DVSEC_MEM_BASE_LOW_MASK	GENMASK(31, 28)
+
+#endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2066.outbound.protection.outlook.com [40.107.237.66])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 825E44D599;
	Mon, 15 Jul 2024 17:28:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.66
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064535; cv=fail; b=CAJe0Ucleo5ail8q/HYl7m4VA91NzhphDw2FNfiD17Cs8pdW6Mv6vEeN74zQFE3uqT/GXp9kCmR5Iv3SHJYMJmnImjrxg/mz6pXYvEOyUJYCfcoad2pBO5EU8GXWP/F3teqXO73QIUN2xjyV+MIP+4jOdKLMTzq9zWSJ7A6n8aw=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064535; c=relaxed/simple;
	bh=KbvS0L2V6WUOenSh3BY8rwT1gN0n3MDbBGja9lJobfE=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=QMKQ/po7woJwAbLMS9Xw78EIhQ+UaBzJa4i7luJC9le/LdimW6ijr4iapGhfmWKjLPzdeWfZdjhS7KvjOUbR9+EmJ08NQcMHmwmDMCvyAw5go6JcTKb36KoKbMxDK8I17dcTmQNL8qeXq0tET6fAe7GpUF9MhezedUumCrtDRpw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=anyp9Gz6; arc=fail smtp.client-ip=40.107.237.66
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="anyp9Gz6"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=blLSIidqKWOxUODssdzmXP4dpwcyA3oyU1nJ1y1GaftowIKp28sQlFD9xWdc5hZ1/TLnOk3r8OxreoTjEeL9bcCbeitElu2rOC3hhBTF1quUVLHVLiXN0mifHTqYNmiL4u9v7mZEmCvBRoe8V+LjCCZ7kFFlwLfFb3yMiPO/mHzOSXiBCr7Dm8jTvtvHZ0MfPmiXTihV2t6w00lal6/zfyuArHdPqV6sp4sA8cehjp+QdHNUj+Q8WwHKzxj5UWtz5GSpK+oPnEImMDT0Xbq4AWDRhMUxwlIwBYkQaz4iHyKizhZWdZyr2KnIEIFOh2h4XgAXHRdvUjUroAYEiPHgWA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=VvurDS4JY07gUZudNXkHJINl7mq9EFEWTO8lAzDZTLA=;
 b=N9/q5RXbm5p0sAwyRBtRF+/zBZ+Q/VsErbYtAdK110xFARKYjj2rf+hxupwdmkkJStyBoni/5JJQx/VghyBJZLLQNm4KHlX0RAcH0YAaWiAmRliuXNrKFBkbnN09stx62zIcDxuq8aM0AyFfq8wjbreIQneV+YraQeJszlsyRRGnQd3rmm/KFQDkVE6keOUNsg+PhBC2nKivWNlP0LL1ICMf4QNqQ+AKBpLDDVF2GfvtZ2/Xg2QJ7pNb/Q3koyPbZ1TYHEEOWrDD8kCfSx0DbEkdIHMYGUHm0YUaHRbv46uvxc0c5LZkTz2zvonLwnfN/d2mLk/Ng/xV5PTbq2rbug==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=VvurDS4JY07gUZudNXkHJINl7mq9EFEWTO8lAzDZTLA=;
 b=anyp9Gz67ps92iiqhIa3MPQRs96I/MQWFUQtEiUjGwy67CJGLHP+cJX9fAXN0cRnR5hVYZzMeRFsDZC7/+OlILyKUpCpgEjAdI/IjXkaDGVqSYKS9T7/VVo5gSpj/dVHrropnzBlCFHftLL78qGsaTWs+J9DSHYY4X1NK+8CJxo=
Received: from CY8PR12CA0028.namprd12.prod.outlook.com (2603:10b6:930:49::28)
 by SN7PR12MB7833.namprd12.prod.outlook.com (2603:10b6:806:344::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7741.31; Mon, 15 Jul
 2024 17:28:49 +0000
Received: from CY4PEPF0000EDD7.namprd03.prod.outlook.com
 (2603:10b6:930:49:cafe::77) by CY8PR12CA0028.outlook.office365.com
 (2603:10b6:930:49::28) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:49 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD7.mail.protection.outlook.com (10.167.241.203) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:49 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:48 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:47 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 04/15] cxl: add capabilities field to cxl_dev_state
Date: Mon, 15 Jul 2024 18:28:24 +0100
Message-ID: <20240715172835.24757-5-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB04.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD7:EE_|SN7PR12MB7833:EE_
X-MS-Office365-Filtering-Correlation-Id: 9fec45c5-ffbe-49df-6726-08dca4f39707
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|82310400026|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?mfgIHKXP7DJtK04sGYoIvrCQ3tEa2lo+p/fEIcpMughz+Cx68fTCbDNvV85R?=
 =?us-ascii?Q?PlflBH3Tk3Yjoqyr4mcYA1ScAaV4bHbaupORuDv1hNyLQghYwBibz0TvhLK3?=
 =?us-ascii?Q?Q/W5WLuYYrBTcszOYeYxzXqsYxO8Kkg/OGWgJee0DoKJg7pvbngn1hsX53h/?=
 =?us-ascii?Q?VW6BNeUHOWH4y8FUTN4CD75lYssN+DagIzYGTLq2/0doOuLq74PfUYdip3ZA?=
 =?us-ascii?Q?iT16l/RXlf4trB8gkVujOJPJI1/KbjkjhY8l4+3cuhsYAWQa6YE+QFuTHK5s?=
 =?us-ascii?Q?dbnv9ngKMq9pZdYaKGnejUIPx7AUnEGOGyaxVeI2GCKsXVjlML8cg7/wkOJz?=
 =?us-ascii?Q?HiVDKz5nRxXh5xgbzuQ4Xnjfe/LaNHUgz9Wth3zgbMlgaJB2YwXAiXMXnweX?=
 =?us-ascii?Q?9gSz2P9nmnEydTbkFDdSU19REa+HnIDsEHmOnfW4w9bEi1Czup2RIZFnndD5?=
 =?us-ascii?Q?EMFhVvcuZ+rSS7gTDbjOlnlc02fF3rAKnu8zgUsovBc2NZGLCjYgutbr67XY?=
 =?us-ascii?Q?vhpi/slYO6a/ozGqvQ+q13P64pTOb6JxkVgY+pkzfnOITMftj7LuLdvGzcfM?=
 =?us-ascii?Q?XSeDdmCyyHg8f7yeczMlwQ7ONdYOEbU83+bAViSISPZ1Is5H6VoK9ipE2jl0?=
 =?us-ascii?Q?LAZac++Q2R+GYSXNMmSGiFVYZymaXRz5NW/f9gHXv7WNt4YZ+Mh4m0pLRvRZ?=
 =?us-ascii?Q?LR5kGGvQiicRorDw5KBMbEIzeTBZOf6W3KwKvziASeL/SqkP3USEorPZ6v3R?=
 =?us-ascii?Q?Tmxb1rapdjWZY+Mz2v7L7t5mvblZYRNI8xCFsH+EAYzUPnhuI1HzCKFmLcjZ?=
 =?us-ascii?Q?5UOG3ShRq1tqzHCbOgWVi9b5bEiLcxevZ4J3cj2CdoocHZ8vhjUXXzdHIh2Y?=
 =?us-ascii?Q?cAVohTVxJ+/r4VSwBSiG8DXAqXjm332MD03Z8b2NOtxUULn5x1Nq+76bDFx6?=
 =?us-ascii?Q?tUIZpfYdBAFRbxfdgGxNErNgybFOkhmWTRpXykaQ3z+Ky1zGKbGGb9AD8AEU?=
 =?us-ascii?Q?bzS/88f5skkwNHdtyoFxxHKhVHW07u6QK2ex7yDWJ0Y2jheeLs09F7ophvkB?=
 =?us-ascii?Q?pU6P2c1JTcNWtHomqhQsnrRPYrFnnz21gd5EWg5YRK60b+2K4pw7iMVkDWxy?=
 =?us-ascii?Q?ycxaIBBCYulv0vLUPctbnXp64upE7R6VkavzSoAh6O0TIAW3sbw+OzQZFqzh?=
 =?us-ascii?Q?ESiGb+nBY/Pws38m7tYW9s9GC/8YkRb4U1u9ij0nrij2tIfjU9c3p1b+SNJb?=
 =?us-ascii?Q?d4vQguoqDOCPTL19Hm+bYDQjM9pZZtwu4OSoHKX8h8GOixSH9M6h2M6gA0Mt?=
 =?us-ascii?Q?rxzg4Vj/EbzW1p/rPlmBPKAM8fUbz/QFEB6mydsil7jqoIc18jGV7TtJDMIx?=
 =?us-ascii?Q?IguDXV10KnfeAxE6g0GSwhkEgPAuznGb5YxjdaFzvRk7dZFWt6V+bXqoSnjP?=
 =?us-ascii?Q?p1jPIBzDhHdnimEks8wJbCnRH2AAdtaY?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(82310400026)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:49.6370
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9fec45c5-ffbe-49df-6726-08dca4f39707
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD7.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR12MB7833
Status: O
Content-Length: 8721
Lines: 245

From: Alejandro Lucero <alucerop@amd.com>

Type2 devices have some Type3 functionalities as optional like an mbox
or an hdm decoder, and CXL core needs a way to know what a CXL accelerator
implements.

Add a new field for keeping device capabilities to be initialised by
Type2 drivers. Advertise all those capabilities for Type3.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/mbox.c            |  1 +
 drivers/cxl/core/memdev.c          |  4 +++-
 drivers/cxl/core/port.c            |  2 +-
 drivers/cxl/core/regs.c            | 11 ++++++-----
 drivers/cxl/cxl.h                  |  2 +-
 drivers/cxl/cxlmem.h               |  4 ++++
 drivers/cxl/pci.c                  | 15 +++++++++------
 drivers/net/ethernet/sfc/efx_cxl.c |  3 ++-
 include/linux/cxl_accel_mem.h      |  5 ++++-
 9 files changed, 31 insertions(+), 16 deletions(-)

diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
index 2626f3fff201..2ba7d36e3f38 100644
--- a/drivers/cxl/core/mbox.c
+++ b/drivers/cxl/core/mbox.c
@@ -1424,6 +1424,7 @@ struct cxl_memdev_state *cxl_memdev_state_create(struct device *dev)
 	mds->cxlds.reg_map.host = dev;
 	mds->cxlds.reg_map.resource = CXL_RESOURCE_NONE;
 	mds->cxlds.type = CXL_DEVTYPE_CLASSMEM;
+	mds->cxlds.capabilities = CXL_DRIVER_CAP_HDM | CXL_DRIVER_CAP_MBOX;
 	mds->ram_perf.qos_class = CXL_QOS_CLASS_INVALID;
 	mds->pmem_perf.qos_class = CXL_QOS_CLASS_INVALID;
 
diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 04c3a0f8bc2e..b4205ecca365 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -616,7 +616,7 @@ static void detach_memdev(struct work_struct *work)
 
 static struct lock_class_key cxl_memdev_key;
 
-struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
+struct cxl_dev_state *cxl_accel_state_create(struct device *dev, uint8_t caps)
 {
 	struct cxl_dev_state *cxlds;
 
@@ -631,6 +631,8 @@ struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
 	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, 0, "ram");
 	cxlds->pmem_res = DEFINE_RES_MEM_NAMED(0, 0, "pmem");
 
+	cxlds->capabilities = caps;
+
 	return cxlds;
 }
 EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 887ed6e358fb..d66c6349ed2d 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -763,7 +763,7 @@ static int cxl_setup_comp_regs(struct device *host, struct cxl_register_map *map
 	map->reg_type = CXL_REGLOC_RBI_COMPONENT;
 	map->max_size = CXL_COMPONENT_REG_BLOCK_SIZE;
 
-	return cxl_setup_regs(map);
+	return cxl_setup_regs(map, 0);
 }
 
 static int cxl_port_setup_regs(struct cxl_port *port,
diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
index e1082e749c69..9d218ebe180d 100644
--- a/drivers/cxl/core/regs.c
+++ b/drivers/cxl/core/regs.c
@@ -421,7 +421,7 @@ static void cxl_unmap_regblock(struct cxl_register_map *map)
 	map->base = NULL;
 }
 
-static int cxl_probe_regs(struct cxl_register_map *map)
+static int cxl_probe_regs(struct cxl_register_map *map, uint8_t caps)
 {
 	struct cxl_component_reg_map *comp_map;
 	struct cxl_device_reg_map *dev_map;
@@ -437,11 +437,12 @@ static int cxl_probe_regs(struct cxl_register_map *map)
 	case CXL_REGLOC_RBI_MEMDEV:
 		dev_map = &map->device_map;
 		cxl_probe_device_regs(host, base, dev_map);
-		if (!dev_map->status.valid || !dev_map->mbox.valid ||
+		if (!dev_map->status.valid ||
+		    ((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ||
 		    !dev_map->memdev.valid) {
 			dev_err(host, "registers not found: %s%s%s\n",
 				!dev_map->status.valid ? "status " : "",
-				!dev_map->mbox.valid ? "mbox " : "",
+				((caps & CXL_DRIVER_CAP_MBOX) && !dev_map->mbox.valid) ? "mbox " : "",
 				!dev_map->memdev.valid ? "memdev " : "");
 			return -ENXIO;
 		}
@@ -455,7 +456,7 @@ static int cxl_probe_regs(struct cxl_register_map *map)
 	return 0;
 }
 
-int cxl_setup_regs(struct cxl_register_map *map)
+int cxl_setup_regs(struct cxl_register_map *map, uint8_t caps)
 {
 	int rc;
 
@@ -463,7 +464,7 @@ int cxl_setup_regs(struct cxl_register_map *map)
 	if (rc)
 		return rc;
 
-	rc = cxl_probe_regs(map);
+	rc = cxl_probe_regs(map, caps);
 	cxl_unmap_regblock(map);
 
 	return rc;
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index a6613a6f8923..9973430d975f 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -300,7 +300,7 @@ int cxl_find_regblock_instance(struct pci_dev *pdev, enum cxl_regloc_type type,
 			       struct cxl_register_map *map, int index);
 int cxl_find_regblock(struct pci_dev *pdev, enum cxl_regloc_type type,
 		      struct cxl_register_map *map);
-int cxl_setup_regs(struct cxl_register_map *map);
+int cxl_setup_regs(struct cxl_register_map *map, uint8_t caps);
 struct cxl_dport;
 resource_size_t cxl_rcd_component_reg_phys(struct device *dev,
 					   struct cxl_dport *dport);
diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
index af8169ccdbc0..8f2a820bd92d 100644
--- a/drivers/cxl/cxlmem.h
+++ b/drivers/cxl/cxlmem.h
@@ -405,6 +405,9 @@ struct cxl_dpa_perf {
 	int qos_class;
 };
 
+#define CXL_DRIVER_CAP_HDM	0x1
+#define CXL_DRIVER_CAP_MBOX	0x2
+
 /**
  * struct cxl_dev_state - The driver device state
  *
@@ -438,6 +441,7 @@ struct cxl_dev_state {
 	struct resource ram_res;
 	u64 serial;
 	enum cxl_devtype type;
+	uint8_t capabilities;
 };
 
 /**
diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index b34d6259faf4..e2a978312281 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -502,7 +502,8 @@ static int cxl_rcrb_get_comp_regs(struct pci_dev *pdev,
 }
 
 static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
-			      struct cxl_register_map *map)
+			      struct cxl_register_map *map,
+			      uint8_t cxl_dev_caps)
 {
 	int rc;
 
@@ -519,7 +520,7 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
 	if (rc)
 		return rc;
 
-	return cxl_setup_regs(map);
+	return cxl_setup_regs(map, cxl_dev_caps);
 }
 
 int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
@@ -527,7 +528,8 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
 	struct cxl_register_map map;
 	int rc;
 
-	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
+	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map,
+				cxlds->capabilities);
 	if (rc)
 		return rc;
 
@@ -536,7 +538,7 @@ int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
 		return rc;
 
 	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
-				&cxlds->reg_map);
+				&cxlds->reg_map, cxlds->capabilities);
 	if (rc)
 		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
 
@@ -850,7 +852,8 @@ static int cxl_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		dev_warn(&pdev->dev,
 			 "Device DVSEC not present, skip CXL.mem init\n");
 
-	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
+	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map,
+				cxlds->capabilities);
 	if (rc)
 		return rc;
 
@@ -863,7 +866,7 @@ static int cxl_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	 * still be useful for management functions so don't return an error.
 	 */
 	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
-				&cxlds->reg_map);
+				&cxlds->reg_map, cxlds->capabilities);
 	if (rc)
 		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
 	else if (!cxlds->reg_map.component_map.ras.valid)
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 9cefcaf3caca..37d8bfdef517 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -33,7 +33,8 @@ void efx_cxl_init(struct efx_nic *efx)
 
 	pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
 
-	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev);
+	cxl->cxlds = cxl_accel_state_create(&pci_dev->dev,
+					    CXL_ACCEL_DRIVER_CAP_HDM);
 	if (IS_ERR(cxl->cxlds)) {
 		pci_info(pci_dev, "CXL accel device state failed");
 		return;
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index c7b254edc096..0ba2195b919b 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -12,8 +12,11 @@ enum accel_resource{
 	CXL_ACCEL_RES_PMEM,
 };
 
+#define CXL_ACCEL_DRIVER_CAP_HDM	0x1
+#define CXL_ACCEL_DRIVER_CAP_MBOX	0x2
+
 typedef struct cxl_dev_state cxl_accel_state;
-cxl_accel_state *cxl_accel_state_create(struct device *dev);
+cxl_accel_state *cxl_accel_state_create(struct device *dev, uint8_t caps);
 
 void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
 void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2050.outbound.protection.outlook.com [40.107.237.50])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 33BA54C62A;
	Mon, 15 Jul 2024 17:28:52 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.50
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064535; cv=fail; b=BvEcXP8gh2+eSDZBAVnWpot3m9uouDyHHs/K3KWejbo6uwkwEPT/o7YVAxhFXFMbI4E8SSPyVsTSccpclF3e3fc+Q7BvINWpJ1MYTcmmZDD+NguiZ9CfhB/2ROXBOICcwrQWlGU6L34+4HVV2iiAQ1V5wlopGTocoAY3+A6OQP0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064535; c=relaxed/simple;
	bh=F8GS8p34b0XV0Mca70ix3TkEkexLAGl85pp7ZlgDGf4=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=sc6PTPv6hf/pu2twIH4cCILwonaRQ1FW5zBKHwR3sSZjXNLfnWTwt4eQML1y7FljUC2xHZECcDxJMK8Qkd8IX0zpzfpafyQGHvp9Z8QYy73uWdAX7zSF6SWPrdp7T1hVs4JhnQ37imGvfdntBkhrksg0UZOthN/tAqh3aNt9KzU=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=b8949fBq; arc=fail smtp.client-ip=40.107.237.50
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="b8949fBq"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=ZokcBjthEsfakMuIdGH4kBMPTd5+5PV/yky0d5l0iTenoxjUYZq5WSyv2G/BTZkE2fmeJORpkzIZq0iqF/KFqSh5BoD+QQRkzi5DHR/DME+IJS9Uk+3DdynwVgQRKgZ2mt7Mn0kgEJM6/Ces8AaGgkbrWIWPBsAIxbjb721LA8P+DSnOBTnDK+1cF8ewaUoVbZbKBdF6frIhH9Hy8qcruM0WgFhfmvecuBqYQIDBP+dYkX+3wPMKBTK7ze5lvcGnSszVHNksJSI/NOTqtBm1dbhhrvMVRikzkG00R+jrgyb77WSfyx5SP7GDwKZWJq+Badr3Y/9V8JfEiE7LB5MHOw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=OPUzow2Cq0ECdT/dOJDe38VC/lapsSkFdWjr+H1KO3Y=;
 b=kv3pMzOTOxE3bb3QbsXU1ZpqCGMC6DiWQ0diheOXhLCvi5tLBBUB+WxozL6NtTPWkS1TJEzVL5YIQql5S4Eenu498tGYZIbnPXcKEdIL+kDCSdu6wHTQW9VAQM3hCys/g7CnUXMYCflWBoA2OJbO/ap6Bo9kMzJBzhG6Zn1my6zy+ZVGOxDWUD6gxkvwViVpxP9AODvD+Rkqcko/78tdJeQ92o/gYcPVltA5JI+koaET6BvJpD8lggMgkeUjFrIGLE/9xxP5zz6QGS9n1lPEMdVrfZXaq4usdMURnel0CzX4aRqw/D9PJ5/T3OB47TGAooNxE2MedpMgrWm067zzKQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=OPUzow2Cq0ECdT/dOJDe38VC/lapsSkFdWjr+H1KO3Y=;
 b=b8949fBqZygVmlp9m1FDgdOa9VbDkIP+2ijvYAkvXljVEyV0SVXfYi4YOWji/fTTTn1ahkoRzt/bs7XGrg2CyR2jsQv2Tf5FxH8zYlSIla9+VRcWGQHye1oQ302CqFCHaQ7zQL5eJFX1q5pqz8ugSVtF058d55F7pO+0r75a4js=
Received: from MW4PR04CA0155.namprd04.prod.outlook.com (2603:10b6:303:85::10)
 by IA1PR12MB6649.namprd12.prod.outlook.com (2603:10b6:208:3a2::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.25; Mon, 15 Jul
 2024 17:28:49 +0000
Received: from SJ1PEPF000023D8.namprd21.prod.outlook.com
 (2603:10b6:303:85:cafe::d5) by MW4PR04CA0155.outlook.office365.com
 (2603:10b6:303:85::10) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:48 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 SJ1PEPF000023D8.mail.protection.outlook.com (10.167.244.73) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.5 via Frontend Transport; Mon, 15 Jul 2024 17:28:48 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:47 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:46 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 03/15] cxl: add function for type2 resource request
Date: Mon, 15 Jul 2024 18:28:23 +0100
Message-ID: <20240715172835.24757-4-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SJ1PEPF000023D8:EE_|IA1PR12MB6649:EE_
X-MS-Office365-Filtering-Correlation-Id: c4c7fbf3-99a1-4a1b-72cb-08dca4f39633
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|1800799024|36860700013|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?Z7BkGHQSmfSWlp2uUygq1exiXG0qpIrCEFKKUcjCwOEgZdQKdo77hYwam7SH?=
 =?us-ascii?Q?v0FuIiTqEj01w1DAYAQUNHx8wkOb1paTktc0ZgVXbr0kgkoKRzf+9HkzB55E?=
 =?us-ascii?Q?RamUYo105KDNfAift8vfZE8+nYs0zHW1OkyNW5hhdbHKEa8yJN2qRlpqTYZN?=
 =?us-ascii?Q?VmGBpL8mRDu6g4ezqtDZs4KurOCck7s407N2CCVXgeTQrMu0pqp6w1wA2VPf?=
 =?us-ascii?Q?qC2jrw+Z2MMSvfYxzZkUQhcEcvUcgMDMfG94J5vC3dEKtuV7LZHrhD+SYiCL?=
 =?us-ascii?Q?j8DX8WUBrGALQLF09+sE+Mj4ycBSCwBrqUcPWwa5N2clNJ13EVk2W1Cshwua?=
 =?us-ascii?Q?iaq4I5hf+qXJc/w+gcm2Llypbn4b5txxetMyylIxptbqmRqNwaDlDX67txBJ?=
 =?us-ascii?Q?OWooIWTAu/3qGVQz7B+LXBCIjUDCpDmTB7zO4kJ8rD22arMaOLgzP7br2wrR?=
 =?us-ascii?Q?zP6q2al1JeNQUE3QfCv6KbmzM6F7KjwoNA7IIzkWRfrTojyIfnWFPlUhL4L7?=
 =?us-ascii?Q?q4gCqxmHpEJNwlJZKBkyUhDdMMWCL+lqD8gpXiuRgVTZOonJxeTgmncrJ2nc?=
 =?us-ascii?Q?5K7OY216jJBgXeKU7cmSDuBhBfyVRwm6ADVEmKfyG2auvtDs+icIEwsEV8GB?=
 =?us-ascii?Q?kmUJMDuvV0fo7OXHKkFes0QiC8+jPPo44AgR3Cv4uPvrtx9n9KVAxL/seTQE?=
 =?us-ascii?Q?f6oOM3KNpUK4qKkXjnDfQDwg02+gR26x1qzFE74qlicL2AqdKVmEFKdEH8rj?=
 =?us-ascii?Q?FudAhKJtXwi1gTLTzld8ezJzzIbwqs5g9/wHzW+hTPWuYJNNLGINZv+DR+FX?=
 =?us-ascii?Q?MkGhqmJQpjNnJj5kYG3998Xf9UYjGp7wQLMLWdjxKx9jQOaYHGnn7JipLHZP?=
 =?us-ascii?Q?Za3Qm2MwiQmYhxu/zj1pLqn5DSATxgcHdNjshymOlNo27UtoWhaLL/G8Twfd?=
 =?us-ascii?Q?JC+N84KVBMTZirz+PHp+MiprTBonGyEHrEK4PnhsSwwuxaZyyWJNEzqgZmE8?=
 =?us-ascii?Q?WOuo5TUD0s+0h9Q0hxTBOB9QrrypzrbCZgA9qj/qgZEaF0KeQIbFhImv+1U+?=
 =?us-ascii?Q?ypLcUlYUiZKD4VpkgSJ4l85iRoxgyLsLt2YT0LLWmWEC2E2IHgHVw48HBmmB?=
 =?us-ascii?Q?F6lTv6nOseH976y7+tPMWFZjcFiULwTkkNEDyhyKsTn+lcltk1Utcupp2U3I?=
 =?us-ascii?Q?JaKHIaApjaF31lF+gGtswRJQN3Q+3VvqyvoChcixVV4/ef0RBnBh7dCgciXn?=
 =?us-ascii?Q?c9nQ+hcWW4/YUBzWtFoEkxgLBnWl0LsliznG+jTzmi+4Q7xnRdnQ4tzVmhFM?=
 =?us-ascii?Q?QBKw08xwn41SixOX6FGJixM5XXLkcqu/1OEVkfROHcYByXvZVbUypNYE1YAX?=
 =?us-ascii?Q?2Cp75UOo5ORtiw+Vu9p4NlN2CCaWAgHcMLgNzALjJ8u44/MXEjOSC18qUctB?=
 =?us-ascii?Q?IGU6iItrZaE=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(1800799024)(36860700013)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:48.2167
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: c4c7fbf3-99a1-4a1b-72cb-08dca4f39633
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	SJ1PEPF000023D8.namprd21.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA1PR12MB6649
Status: O
Content-Length: 2384
Lines: 68

From: Alejandro Lucero <alucerop@amd.com>

Create a new function for a type2 device requesting a resource
passing the opaque struct to work with.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/memdev.c          | 13 +++++++++++++
 drivers/net/ethernet/sfc/efx_cxl.c |  7 ++++++-
 include/linux/cxl_accel_mem.h      |  1 +
 3 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 61b5d35b49e7..04c3a0f8bc2e 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -744,6 +744,19 @@ void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
 }
 EXPORT_SYMBOL_NS_GPL(cxl_accel_set_resource, CXL);
 
+int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram)
+{
+	int rc;
+
+	if (is_ram)
+		rc = request_resource(&cxlds->dpa_res, &cxlds->ram_res);
+	else
+		rc = request_resource(&cxlds->dpa_res, &cxlds->pmem_res);
+
+	return rc;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_request_resource, CXL);
+
 static int cxl_memdev_release_file(struct inode *inode, struct file *file)
 {
 	struct cxl_memdev *cxlmd =
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 10c4fb915278..9cefcaf3caca 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -48,8 +48,13 @@ void efx_cxl_init(struct efx_nic *efx)
 	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
 	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
 
-	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds))
+	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds)) {
 		pci_info(pci_dev, "CXL accel setup regs failed");
+		return;
+	}
+
+	if (cxl_accel_request_resource(cxl->cxlds, true))
+		pci_info(pci_dev, "CXL accel resource request failed");
 }
 
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index ca7af4a9cefc..c7b254edc096 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -20,4 +20,5 @@ void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
 void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
 			    enum accel_resource);
 int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
+int cxl_accel_request_resource(struct cxl_dev_state *cxlds, bool is_ram);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2057.outbound.protection.outlook.com [40.107.223.57])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A5403482FF;
	Mon, 15 Jul 2024 17:28:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.57
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064532; cv=fail; b=Rzi816VMm2rn9NqoTpg02+vP+OdpIA7ET7awVmyvvNEuUH8sgP26tWLZIiRKCFZQDPEw9t9GymM6hFp8Pm6fVCNM9AZUKjMqmVJHq+eLJB8tMzKql/T9C0pYSXb63oKHlYO+yIEHizLC66AOWyDWL04Yh+eQzCVO8QxjVMqex1w=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064532; c=relaxed/simple;
	bh=JiZD/sVW0oMAP22Ldy3xtseUJoplCp0JQCJVzAEJrpQ=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=J+CG4QyIkucoeloeB0tS3afEbffofql5bsiQzYrmCZyAhbmWf942nrFbOMMl/Mhe8AJOBkonkRtiTil4KSDmiZeS6SRLK6Pn41R1Q7kqrFBuQuLo9zYGk3RCOHYUdocjjovwNPLbR/33vekFYkjrsksK0tQ2hQMtUb4e64KHttc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=C9badfe4; arc=fail smtp.client-ip=40.107.223.57
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="C9badfe4"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=D1s9u9NXJS+5Ju7309QqLCO6AprZlPdUPhCljezSV0drUbWoGfuEgwY2BQp4hKC5Btq+PTuTUXvLlRurjtFb9gVb+nJQfWZN+dweuQUpf96rGs4ssprWHovgN3dndIK0rTn4N0qwle+2vsiUgR2hEO1uJYQ3Sup8b4iCZgLUnkZbG1tFfktRmG2HiVUPfbn91jH4DX6OYOIbRNuo7fgSfJrqeDAggXLKmwzkxdG3fDmb76s5YNl2TazMBSO4zaHeAITCloAfY6FFucvLqRJo9plucQuP82OOpLUFq1TPDCtj4cRUs+GDONb3sPcJ1kpu8MT5KqW7n/s+wxUkpiAT1Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=KX2PANqmejnodiJ8QBVFxKSGeEKF7jqaqv/zITOH6i4=;
 b=NbQon9xZQki8yN1VehObGxbO//r7NPTpkcpPOXiccO9PRk64HQw/CckeBSgXGPKN7ih7Nx+8pKxcskPDi2mAPCSXYP1ctQf0wiv+vDkR5YTzlmpVY33gwyQlKeMluZXjZuhSk6b9wZWhrCgtwF1KuguQ9N3HoNpq/zP10ig5XlQDwJeSapDQNV0iOwmF5K/HWHmByWvWxj58wWu7yta9024QKR/aC29+oMtwgMXd0tjw6HHaFK2Z2vihnKxTFFts8UNSwpjPZe+t7Ai+6M8Jg314NfxwMJYJPAz8IpLX3XBnLxYGeqAmpIKzXrWIrekipfavJMQOWK+Yrsn8gTWcEA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=KX2PANqmejnodiJ8QBVFxKSGeEKF7jqaqv/zITOH6i4=;
 b=C9badfe4fpoCD7En26d2icJhCjPwZopuP43Zf/W+LQ7t5any65XMbI7gxcS5/vU8lYB2JzLudp7TqlmpfCbGocIFLPXu4u9ueBkbwrhAePBLW6KTGrAVOIY6D6ele5G6LoxwyBFZu/Gff0VOtNHv7XbH8B8pq88xiShJp486A+8=
Received: from DM5PR07CA0085.namprd07.prod.outlook.com (2603:10b6:4:ae::14) by
 SA0PR12MB4349.namprd12.prod.outlook.com (2603:10b6:806:98::21) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.7762.28; Mon, 15 Jul 2024 17:28:48 +0000
Received: from CY4PEPF0000EDD4.namprd03.prod.outlook.com
 (2603:10b6:4:ae:cafe::ac) by DM5PR07CA0085.outlook.office365.com
 (2603:10b6:4:ae::14) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:47 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CY4PEPF0000EDD4.mail.protection.outlook.com (10.167.241.200) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.11 via Frontend Transport; Mon, 15 Jul 2024 17:28:46 +0000
Received: from SATLEXMB05.amd.com (10.181.40.146) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:46 -0500
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB05.amd.com
 (10.181.40.146) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:45 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:44 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [PATCH v2 02/15] cxl: add function for type2 cxl regs setup
Date: Mon, 15 Jul 2024 18:28:22 +0100
Message-ID: <20240715172835.24757-3-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
References: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB05.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: CY4PEPF0000EDD4:EE_|SA0PR12MB4349:EE_
X-MS-Office365-Filtering-Correlation-Id: 13e8ae9f-2cb1-43b2-d1f6-08dca4f395bb
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|36860700013|82310400026|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?83hoWr5eG3agCsHUGtRgGFXzC2v58wvk8H/DTNdECfDWkdrn2Ic4bSCyWO5B?=
 =?us-ascii?Q?aCF3jKGSE2Ui7ouFhCdyAnk2zgAZW6UA1uMsl46mVM9Q12xgwKMvEHtx6SpO?=
 =?us-ascii?Q?DAsoctQ4pHUAv+Q1iLFZiR1RBD46ZmkIBHBF2gObjUmm2Kj55G76oTw238x6?=
 =?us-ascii?Q?VNaoNF8t5SRaDxmEJ3AOojD6whnaEIYYocg4P8V8krm8C4AYuUkgyIDAY1Jm?=
 =?us-ascii?Q?zIOTZmHvF8Y3AiqGH6OoyQHXTnKFOPKl5BYx9Q2FZfiLct7KL6Qy0bkm+juh?=
 =?us-ascii?Q?BZBQmqAesfk88L2w1xT98PA82TleiviQiD2gs4i49pByCIoYHBisvRgxAcxZ?=
 =?us-ascii?Q?/I0m3Pur9e1p7Mu842vb3xXsC8wnK46fphhpyxyBKUNhx+2T8TAE9YOZvxxB?=
 =?us-ascii?Q?goZ5hAc9/424xYRHZ6rAr4CBYkxV+f+4Etv+Es3so7036r5sfcXuWeFU/NB/?=
 =?us-ascii?Q?rGwU+g0lG2aspkbjS53hyxNh7vIFCH4yJllSJZsySkZME6GYxnhpyvQVqc8t?=
 =?us-ascii?Q?9rEjFKHhm9VEP/TpK6eWN/NA75uKTA61MJaVlX8TFReiInrAY57ih2SqQ/YH?=
 =?us-ascii?Q?LtIEf/8b1UkVXati0Go4MzuXGoR7407sWj53bYVBh1fba8IKr0dvSxDB/C2t?=
 =?us-ascii?Q?Do97mggaOjhZ96764FTvDrlfG5IzPylETFK60BPNBJSswvW5xQH6H6xVPTNC?=
 =?us-ascii?Q?6My3+tAwXPMj+1lYwKrQih39+MkPu26ftWYlDA7t85GYcX+K1vYq8ZHDzamR?=
 =?us-ascii?Q?6F1txQc6yIIcjiih4AXb7L0unX3kT8d1J7ZKcthNhW1ARwXJ7b0EtXQaIF4l?=
 =?us-ascii?Q?M7mf8sRiqNJBsmJrZU3g6HeYomN1IdCAJElM0Q1cFNP+k63UP9JrT+5RvOWD?=
 =?us-ascii?Q?YCX5PeWiIJbsc9dWmTmBY07aA+Hvp0ONyjO5cinqbjkiiPBFLP5cYgxCnMkH?=
 =?us-ascii?Q?GS0tQQ1qpZotQZvzURa8Kg1yj3oQqGxgKYyfZcx791nMLQDJhaYeFlmqy0Oo?=
 =?us-ascii?Q?86V34qTlw/KJvKJXAiQ8VjOxky9Tz7nobTGhEegdeWLuJZuMp1HUq3JIAMfb?=
 =?us-ascii?Q?GipyogJ7HrmxLb9Wj6roof7Nai/2htqV9qI1euQw44OmcmV/sWG/nOD0P58W?=
 =?us-ascii?Q?WFSQiVpwWzlE4TJiPYFCchtUph+YsZ5v9Yky9IH5LuFTuYvKQOiEiSDFdl0i?=
 =?us-ascii?Q?xmYgQ0+AV/+qoYcM/GuWbf6JOjkSjAbp/M0UW7wZqBTYZXxmLpaPAUW+aKWL?=
 =?us-ascii?Q?/n9Zb3jC375PD31mVpTipUzaEKKrjBylhjGFzIhtal+E0qto12qlBOz5G5nd?=
 =?us-ascii?Q?2Pzktr/ZLu/ObQ1Chvog6UkrPiz46kyQS553qmCMgXIEanl38eMjXZQgd+yd?=
 =?us-ascii?Q?YPzoaG4Sv/L+UK0Jfbd9kW98vrVOQURpXIsMtH3WRdadSwhlEioM8seFBYB+?=
 =?us-ascii?Q?5lsUUBXHDC1vg52+UhmOLKCbbQvzg6pxxQN4e5RQLmn34L/cRA2zhA=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(36860700013)(82310400026)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:46.9483
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 13e8ae9f-2cb1-43b2-d1f6-08dca4f395bb
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	CY4PEPF0000EDD4.namprd03.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA0PR12MB4349
Status: O
Content-Length: 2740
Lines: 85

From: Alejandro Lucero <alucerop@amd.com>

Create a new function for a type2 device initialising the opaque
cxl_dev_state struct regarding cxl regs setup and mapping.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/pci.c                  | 28 ++++++++++++++++++++++++++++
 drivers/net/ethernet/sfc/efx_cxl.c |  3 +++
 include/linux/cxl_accel_mem.h      |  1 +
 3 files changed, 32 insertions(+)

diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index e53646e9f2fb..b34d6259faf4 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -11,6 +11,7 @@
 #include <linux/pci.h>
 #include <linux/aer.h>
 #include <linux/io.h>
+#include <linux/cxl_accel_mem.h>
 #include "cxlmem.h"
 #include "cxlpci.h"
 #include "cxl.h"
@@ -521,6 +522,33 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
 	return cxl_setup_regs(map);
 }
 
+int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds)
+{
+	struct cxl_register_map map;
+	int rc;
+
+	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_MEMDEV, &map);
+	if (rc)
+		return rc;
+
+	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
+	if (rc)
+		return rc;
+
+	rc = cxl_pci_setup_regs(pdev, CXL_REGLOC_RBI_COMPONENT,
+				&cxlds->reg_map);
+	if (rc)
+		dev_warn(&pdev->dev, "No component registers (%d)\n", rc);
+
+	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
+				    BIT(CXL_CM_CAP_CAP_ID_RAS));
+	if (rc)
+		dev_dbg(&pdev->dev, "Failed to map RAS capability.\n");
+
+	return rc;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_pci_accel_setup_regs, CXL);
+
 static int cxl_pci_ras_unmask(struct pci_dev *pdev)
 {
 	struct cxl_dev_state *cxlds = pci_get_drvdata(pdev);
diff --git a/drivers/net/ethernet/sfc/efx_cxl.c b/drivers/net/ethernet/sfc/efx_cxl.c
index 4554dd7cca76..10c4fb915278 100644
--- a/drivers/net/ethernet/sfc/efx_cxl.c
+++ b/drivers/net/ethernet/sfc/efx_cxl.c
@@ -47,6 +47,9 @@ void efx_cxl_init(struct efx_nic *efx)
 
 	res = DEFINE_RES_MEM_NAMED(0, EFX_CTPIO_BUFFER_SIZE, "ram");
 	cxl_accel_set_resource(cxl->cxlds, res, CXL_ACCEL_RES_RAM);
+
+	if (cxl_pci_accel_setup_regs(pci_dev, cxl->cxlds))
+		pci_info(pci_dev, "CXL accel setup regs failed");
 }
 
 
diff --git a/include/linux/cxl_accel_mem.h b/include/linux/cxl_accel_mem.h
index daf46d41f59c..ca7af4a9cefc 100644
--- a/include/linux/cxl_accel_mem.h
+++ b/include/linux/cxl_accel_mem.h
@@ -19,4 +19,5 @@ void cxl_accel_set_dvsec(cxl_accel_state *cxlds, u16 dvsec);
 void cxl_accel_set_serial(cxl_accel_state *cxlds, u64 serial);
 void cxl_accel_set_resource(struct cxl_dev_state *cxlds, struct resource res,
 			    enum accel_resource);
+int cxl_pci_accel_setup_regs(struct pci_dev *pdev, struct cxl_dev_state *cxlds);
 #endif
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2044.outbound.protection.outlook.com [40.107.92.44])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A230E17753;
	Mon, 15 Jul 2024 17:28:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.44
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721064529; cv=fail; b=lTNqlWjUinwoNjoZn+mltwFrnZODOtwY89jXwoFCcsc/w7Bs8n1vm7pRF7EOkewo/VIdNRx3yJtlHpTQGf8Mdiv7cHuU0l+aZMfzCKHGNMijLY3gfw2CepYK+1dRVQLsgQgDm7aj8Y4yFrdXkmkjB6so6prYszoijEFT9Q6MjHI=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721064529; c=relaxed/simple;
	bh=D+uibmt4y1KE/vyPkyAV4M8OT1QDbIqjBVAk9cIZ+Gc=;
	h=From:To:CC:Subject:Date:Message-ID:MIME-Version:Content-Type; b=SS8/Jrpup27bl/yevHF3AKr9CjvB81eEqf+2hZ832V63jz9kQwBj6s3Qa2jAd132GmV/HNNN2OYfczGLjR7tdFbZRceYPy70t6MOxnhadytU85X1k0olb1kHzHHe2osyzU71M/olDTXFC059L9hOLgsjo922JjjzanA1MG3gZC0=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=cmCQhu9u; arc=fail smtp.client-ip=40.107.92.44
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="cmCQhu9u"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=dwwYo51jr1AlTMkyfMcHQ5BNtTTbT47xSWysP4hLYDOupcNDshA5yjOFeC6LsLwtgQ9nIpHgsvYNUzsYCCLlxSLk5QkhTOShWbDhgKSe4GxqSOUdk9x/E8ogRIv7z0PKLTx6jPGZtKeYjWFNlsqt7zU3f4DLYakbJ9+dNEgcPzhjuPXNVh1TE74rZnBVxwaFvHVMrN6H8R+qBsHfGIgfomB1zRPCV9olz8QnYUiBBiqATxEucw7lUZAipZf2VjX35FLNFyLRDpj7AH1NZiJWoPt5XCkh3Z73nCkbGPAY7Grqr3XwWTCt9Bu8Bil8WZ3EPsfYIsE7daj0mkqGlmiNtw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Sl/diJvG+QLXcaH2Op++o+G1PVA4ZiuPgvrtxuNtCj4=;
 b=PRq8X5iKBmfHPXeOgwJzMu1pgnVt47kguLrWK2jZzC9ALi4xygnMv0wzhfuUBVnSB6qK2SLrrhe4769g1KSZ9z79hd5Bio6ljHK/BRCl0rMguIqlHyyA11ovyMYrNBF8Ei1xcS7Mxzr2IAf11Hs9v856i1rrCy+k7ZN0bQHY3eVsCLQVys45Hv6jk7hy6X6XykdBYRXZEs3qOWRfFbPo9Z0f9y9Hbr4sTsqxBk9tCzLpH1Hu9dk/cxm34KDMYrwzpZDRgprU/ZNLRJlMHwvOJGUhFxlm9O+UpUn9XbjslifFHIh8+3gqHeyw7DmUoBVOSNJ6mS1bkBWuyUkXFimmEQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Sl/diJvG+QLXcaH2Op++o+G1PVA4ZiuPgvrtxuNtCj4=;
 b=cmCQhu9uTB6e/QThbvywpsnFQ12hlSMyNJHkckRNRDAThBEaTor/kuenGaEcZmPEZa80g+onwN2ZhlIhay+7b2ZceHsxm2xggdH0ptSxER5eH04HZOfEJoTPGHYlZqiWGslmtNuASzXZa+be186Sl1UoBx406OigNsMxCFKIudg=
Received: from BYAPR02CA0011.namprd02.prod.outlook.com (2603:10b6:a02:ee::24)
 by CH0PR12MB8461.namprd12.prod.outlook.com (2603:10b6:610:183::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.28; Mon, 15 Jul
 2024 17:28:44 +0000
Received: from SJ1PEPF000023DA.namprd21.prod.outlook.com
 (2603:10b6:a02:ee:cafe::79) by BYAPR02CA0011.outlook.office365.com
 (2603:10b6:a02:ee::24) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7762.29 via Frontend
 Transport; Mon, 15 Jul 2024 17:28:44 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 SJ1PEPF000023DA.mail.protection.outlook.com (10.167.244.75) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7784.5 via Frontend Transport; Mon, 15 Jul 2024 17:28:43 +0000
Received: from SATLEXMB04.amd.com (10.181.40.145) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Mon, 15 Jul
 2024 12:28:42 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB04.amd.com (10.181.40.145) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 15 Jul 2024 12:28:41 -0500
From: <alejandro.lucero-palau@amd.com>
To: <linux-cxl@vger.kernel.org>, <netdev@vger.kernel.org>,
	<dan.j.williams@intel.com>, <martin.habets@xilinx.com>,
	<edward.cree@amd.com>, <davem@davemloft.net>, <kuba@kernel.org>,
	<pabeni@redhat.com>, <edumazet@google.com>, <richard.hughes@amd.com>
CC: Alejandro Lucero <alejandro.lucero-palau@amd.com>
Subject: [PATCH v2 00/15] cxl: add Type2 device support
Date: Mon, 15 Jul 2024 18:28:20 +0100
Message-ID: <20240715172835.24757-1-alejandro.lucero-palau@amd.com>
X-Mailer: git-send-email 2.17.1
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Received-SPF: None (SATLEXMB03.amd.com: alejandro.lucero-palau@amd.com does
 not designate permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SJ1PEPF000023DA:EE_|CH0PR12MB8461:EE_
X-MS-Office365-Filtering-Correlation-Id: d2264491-cc8c-460a-a1da-08dca4f3938a
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|376014|36860700013|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?RnFPaFVXdEh6WENkdE9IN1ZZL3p1QUQ0YzdwOW10bzVJK2dDeVpBTkpqb0kv?=
 =?utf-8?B?alNlY2pTYzJXNmcxQklVcUxwTWplaTJyak9nSDM1TkdPQVdpZk14SlRReXJH?=
 =?utf-8?B?eWl5QXArZHhhUGliU1ZpTThpUXBWU1IxYmd4eFBQdFNHQVRoZlNXTkZJOEsv?=
 =?utf-8?B?V3pPVGVQQnFSNzh4NnAxbXg3ZGxpRG5xL1BybnR5WVB6ak1qUXFsWlN2Ykd2?=
 =?utf-8?B?Qi8wY3pPVHE2a3ZWdXo5N090RnB3WjJBZUVMOWo2SU9jOTdXRER2eFhvV3pU?=
 =?utf-8?B?dW1JSkhNOUZua3IweFVISUN5ZGRoWUt5OUQxYUVZVURvdHJOdXhLREtYLzFu?=
 =?utf-8?B?MkN2STQxejZES3YyQk5jS1pMb08wb0ZBUmg2ai9FNTFFWnIxaEJGWU5iczZP?=
 =?utf-8?B?aEJDMXlxbnlOWlBsTlRyTm53dDE3a1U5UjVrK0tYU2hqRUlONGtWMm11cHBv?=
 =?utf-8?B?WU0rWk8zMEx1Nk1SNVNWclQ1OTVqdkMwM1hOWS9rc1hqWE5OQWQydHBZMEkw?=
 =?utf-8?B?K2hYRWtiaGM0K1R2cXJnUDljNmhibUI5UHZVWkw3T1h1V0hkR2VYdlZiZzJh?=
 =?utf-8?B?UkwwTDQ2emJYVklIWUF4WDhEeXFVRHRIWGExalo1bi84RFlyb25DdTQrYmFS?=
 =?utf-8?B?ZVc2YUJYeU5jbVNxWmo4cWtQV1hDN2o0VDkzRGRzR0xCbnNsM1o5Vmx2bUxN?=
 =?utf-8?B?K0krRU9OOWYzcGZnUU9meWNaMnNjK3l6R2tBSkIzRjlId1VqWDY3b3ExVVBj?=
 =?utf-8?B?bE5ObVVRaGRlLzZTVmRlckZ5eFk2NVF5c0RTbjdZOXV1WjhhSlRUNWZSa2Vn?=
 =?utf-8?B?SXJrZnowYlpwS3k5YWR3SUVDU0Y2cmFXWEJDT3dvbmk1RldDMmxqSDJCU1NY?=
 =?utf-8?B?Q09kZnUraW9sWnR5VVFLVHFSc1h5bWlzNDlnZ0JnOUdLNWNtQ3B3Z1lZMmlQ?=
 =?utf-8?B?THc0VXVZNmpIUTFtTEFoQXRKK2RWSGV0SzZ3T1haYlN2UVlYMUl0OTE1UFhN?=
 =?utf-8?B?UnZkMjdGU0d3R2NZWkJ2QS9KY25sZW43ZjVKeTVlYjVzaU5QWVdzZkE3ckdP?=
 =?utf-8?B?SEVuT0NLSUN6QU1aYU01YWNJY09sRXpIb3FhcytkL1lJUWoyTEhqZkNqbVhY?=
 =?utf-8?B?dmFaa1Y2ekhnMU5yeDFBdGVqYmFpV3JJVnNWeG4wWXlOdUo4ekZxWWdsSFVZ?=
 =?utf-8?B?M2c2aWNoOThqQzhLMTlPQW5TS1VibDNXRUk3QUwzTmQzbTFsUXJjeWlURGpx?=
 =?utf-8?B?bitGblFUenptRlYzdHlJbUNjcHZiTm9GUHhkd0RuSm9uVDNCQ3JMYk11eTI3?=
 =?utf-8?B?OTNQWkcyQlJNUXJMVjE3QVpmSlBlVlBnUUMzUzhPQlN3aEE2Q2J6cXhkY1Bx?=
 =?utf-8?B?UUEvM3hnNThwMmJMQkovbExJM0s1ZG5KVk1ScU1zUzdwb3dCVWpDbzd6RFdz?=
 =?utf-8?B?QjZmMEpMYXgwdVpid05ORVRtc2ZxM2FvT1k0dXZ6T21vdnYybGdvcXFsN3RR?=
 =?utf-8?B?STZ5ZlFRTU9VRmYrMnRXMWRNb3VNMTFqZ3NwVUNuZDI5VlNjM2Qrd0l6aHYz?=
 =?utf-8?B?VUFReDZkSnFMc2ROQ2dxbktrN3hNNzNZSFZmZTFzU3VOdU1JYlhoZ0c1Y3BB?=
 =?utf-8?B?aFc5TkZQK1dhTnFaY0JOQnBjNVI1L1VNWnN5dUtQajZ0NFZIaXhhbXc5ZkF1?=
 =?utf-8?B?aSszbUpIT2lTVTV4SEQ5cXdrRlRzOWFJUFYwRVQwTlJWbUlNSWhNUVMzTmwr?=
 =?utf-8?B?TnVUcHpPNUpqR2JyY2ltSEFxRmxWY1lIWjJmVndvb1N1TERtQVRJTXJmZ3Fm?=
 =?utf-8?B?UzZkcC9WWllpdkVUMkNjWXdWd0VhNkNrNjVxZ01Xb1JGdHlyMmVoVmZSZUl0?=
 =?utf-8?Q?8OPqBW2Xk2bf+?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(376014)(36860700013)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 15 Jul 2024 17:28:43.7705
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: d2264491-cc8c-460a-a1da-08dca4f3938a
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	SJ1PEPF000023DA.namprd21.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH0PR12MB8461
Status: RO
Content-Length: 4681
Lines: 96

From: Alejandro Lucero <alejandro.lucero-palau@amd.com>

This is a second version for adding CXL Type2 support with changes from the
first RFC patchset.

I have removed the introduction about the concerns with BIOS/UEFI after the
discussion leading to confirm the need of the functionality implemented, at
least is some scenarios.

There are two main changes from the RFC:

1) Following concerns about drivers using CXL core without restrictions, the CXL
struct to work with is opaque to those drivers, therefore functions are
implemented for modifying or reading those structs indirectly.

2) The driver for using the added functionality is not a test driver but a real
one: the SFC ethernet network driver. It uses the CXL region mapped for PIO
buffers instead of regions inside PCIe BARs.

Current CXL kernel code is focused on supporting Type3 CXL devices, aka memory
expanders. Type2 CXL devices, aka device accelerators, share some functionalities
but require some special handling.

First of all, Type2 are by definition specific to drivers doing something and not just
a memory expander, so it is expected to work with the CXL specifics. This implies the CXL
setup needs to be done by such a driver instead of by a generic CXL PCI driver
as for memory expanders. Most of such setup needs to use current CXL core code
and therefore needs to be accessible to those vendor drivers. This is accomplished 
exporting opaque CXL structs and adding and exporting functions for working with
those structs indirectly.

Some of the patches are based on a patchset sent by Dan Williams [1] which was just
partially integrated, most related to making things ready for Type2 but none
related to specific Type2 support. Those patches based on Dan´s work have Dan´s
signing as co-developer, and a link to the original patch.

A final note about CXL.cache is needed. This patchset does not cover it at all,
although the emulated Type2 device advertises it. From the kernel point of view
supporting CXL.cache will imply to be sure the CXL path supports what the Type2
device needs. A device accelerator will likely be connected to a Root Switch,
but other configurations can not be discarded. Therefore the kernel will need to
check not just HPA, DPA, interleave and granularity, but also the available
CXL.cache support and resources in each switch in the CXL path to the Type2
device. I expect to contribute to this support in the following months, and
it would be good to discuss about it when possible.

[1] https://lore.kernel.org/linux-cxl/98b1f61a-e6c2-71d4-c368-50d958501b0c@intel.com/T/

Alejandro Lucero (15):
  cxl: add type2 device basic support
  cxl: add function for type2 cxl regs setup
  cxl: add function for type2 resource request
  cxl: add capabilities field to cxl_dev_state
  cxl: fix use of resource_contains
  cxl: add function for setting media ready by an accelerator
  cxl: support type2 memdev creation
  cxl: indicate probe deferral
  cxl: define a driver interface for HPA free space enumaration
  cxl: define a driver interface for DPA allocation
  cxl: make region type based on endpoint type
  cxl: allow region creation by type2 drivers
  cxl: preclude device memory to be used for dax
  cxl: add function for obtaining params from a region
  efx: support pio mapping based on cxl

 drivers/cxl/core/cdat.c               |   3 +
 drivers/cxl/core/core.h               |   1 +
 drivers/cxl/core/hdm.c                | 160 +++++++--
 drivers/cxl/core/mbox.c               |   1 +
 drivers/cxl/core/memdev.c             | 122 +++++++
 drivers/cxl/core/port.c               |   4 +-
 drivers/cxl/core/region.c             | 459 ++++++++++++++++++++++----
 drivers/cxl/core/regs.c               |  11 +-
 drivers/cxl/cxl.h                     |   9 +-
 drivers/cxl/cxlmem.h                  |  11 +
 drivers/cxl/mem.c                     |  24 +-
 drivers/cxl/pci.c                     |  39 ++-
 drivers/net/ethernet/sfc/Makefile     |   2 +-
 drivers/net/ethernet/sfc/ef10.c       |  25 +-
 drivers/net/ethernet/sfc/efx.c        |   6 +
 drivers/net/ethernet/sfc/efx_cxl.c    | 134 ++++++++
 drivers/net/ethernet/sfc/efx_cxl.h    |  30 ++
 drivers/net/ethernet/sfc/mcdi_pcol.h  |   3 +
 drivers/net/ethernet/sfc/net_driver.h |   4 +
 drivers/net/ethernet/sfc/nic.h        |   1 +
 include/linux/cxl_accel_mem.h         |  58 ++++
 include/linux/cxl_accel_pci.h         |  23 ++
 22 files changed, 1021 insertions(+), 109 deletions(-)
 create mode 100644 drivers/net/ethernet/sfc/efx_cxl.c
 create mode 100644 drivers/net/ethernet/sfc/efx_cxl.h
 create mode 100644 include/linux/cxl_accel_mem.h
 create mode 100644 include/linux/cxl_accel_pci.h

-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 891DC1862C;
	Tue, 16 Jul 2024 03:32:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.175.65.18
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1721100751; cv=none; b=lOrtOMFNZ05E7YUeLvXoPxjkNLAkwDr/YJOIcLMwDYR+N/jMcpcy2OmzaqSgjeFWN5ISLoTjEZtkNnCYnjNVpqgaF+sYZ9fpc/9MRC18fZ6VJSbGtzMSsyoYsHVNhkTFibRDVmZm1M452nIXmKKsBg74IWQR+zDlFf00S1GwZaE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1721100751; c=relaxed/simple;
	bh=GY/1zz50NBZ5rMHvmCnJe4c5+oCSLR2igpJJdQM9su0=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=CAR2dmXn7aJiQS7jXMA0OHg+BvfEYZh6/21V4IgqjFMc6jh2PJTTEe5fBCYGQ0f0onzDXAhszTFDrBX77GMJdNVjwmIgri52LQrwJDZar2mZmCy+kEiTVdD2g7TbqheAcy8GZEAi9B7LZuocykA0mEuOQN9B0mIiAHhcBElregU=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=Mmht6lpg; arc=none smtp.client-ip=198.175.65.18
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="Mmht6lpg"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1721100748; x=1752636748;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=GY/1zz50NBZ5rMHvmCnJe4c5+oCSLR2igpJJdQM9su0=;
  b=Mmht6lpg7SHxkVrodfYoG8hRF0g5QuhPTmEM8YrEqTHyXjnOqOF6R0mf
   RDJnUZfBnaj9fay/0gulaZYoaZgiwWrhOMCDVVKnXo24tCMycpItmDRRG
   9keF6DDKW9g9++aW9jga8AjM13oBWWMAR8hk3CvlepchJ5iY77nj3m4xh
   ey2dK5HKRldOIKikirltrd7bNvfrIeW773KnXBAC/gHC3fgLTfsaKmnZu
   PdtwQcutk9m8NtQVe66imOgj1dxqM8YGMMwNbgzH+JW4A6vUJDkkUOW7C
   7dSt817aIeKD9Kyw1DeFEeX17lqnYuefBc6dyid3UfOoCH5xWXTbEuAhE
   Q==;
X-CSE-ConnectionGUID: tHKC3dt4RYmo8sqhbH4bKA==
X-CSE-MsgGUID: bsfp3DzdSI+M2wnzPlM0Pw==
X-IronPort-AV: E=McAfee;i="6700,10204,11134"; a="18646217"
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="18646217"
Received: from orviesa007.jf.intel.com ([10.64.159.147])
  by orvoesa110.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 15 Jul 2024 20:32:28 -0700
X-CSE-ConnectionGUID: DyVHE1PWQhCwnPJdTEGnnA==
X-CSE-MsgGUID: sodaZD6uRwSgia+JRpf+oA==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.09,211,1716274800"; 
   d="scan'208";a="50482525"
Received: from lkp-server01.sh.intel.com (HELO 68891e0c336b) ([10.239.97.150])
  by orviesa007.jf.intel.com with ESMTP; 15 Jul 2024 20:32:24 -0700
Received: from kbuild by 68891e0c336b with local (Exim 4.96)
	(envelope-from <lkp@intel.com>)
	id 1sTYvO-000ery-05;
	Tue, 16 Jul 2024 03:32:22 +0000
Date: Tue, 16 Jul 2024 11:32:09 +0800
From: kernel test robot <lkp@intel.com>
To: alejandro.lucero-palau@amd.com, linux-cxl@vger.kernel.org,
	netdev@vger.kernel.org, dan.j.williams@intel.com,
	martin.habets@xilinx.com, edward.cree@amd.com, davem@davemloft.net,
	kuba@kernel.org, pabeni@redhat.com, edumazet@google.com,
	richard.hughes@amd.com
Cc: llvm@lists.linux.dev, oe-kbuild-all@lists.linux.dev,
	Alejandro Lucero <alucerop@amd.com>
Subject: Re: [PATCH v2 10/15] cxl: define a driver interface for DPA
 allocation
Message-ID: <202407161159.KA2METLk-lkp@intel.com>
References: <20240715172835.24757-11-alejandro.lucero-palau@amd.com>
Precedence: bulk
X-Mailing-List: llvm@lists.linux.dev
List-Id: <llvm.lists.linux.dev>
List-Subscribe: <mailto:llvm+subscribe@lists.linux.dev>
List-Unsubscribe: <mailto:llvm+unsubscribe@lists.linux.dev>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20240715172835.24757-11-alejandro.lucero-palau@amd.com>
Status: O
Content-Length: 4291
Lines: 113

Hi,

kernel test robot noticed the following build warnings:

[auto build test WARNING on linus/master]
[also build test WARNING on v6.10 next-20240715]
[cannot apply to cxl/next cxl/pending horms-ipvs/master]
[If your patch is applied to the wrong git tree, kindly drop us a note.
And when submitting patch, we suggest to use '--base' as documented in
https://git-scm.com/docs/git-format-patch#_base_tree_information]

url:    https://github.com/intel-lab-lkp/linux/commits/alejandro-lucero-palau-amd-com/cxl-add-type2-device-basic-support/20240716-015920
base:   linus/master
patch link:    https://lore.kernel.org/r/20240715172835.24757-11-alejandro.lucero-palau%40amd.com
patch subject: [PATCH v2 10/15] cxl: define a driver interface for DPA allocation
config: s390-allmodconfig (https://download.01.org/0day-ci/archive/20240716/202407161159.KA2METLk-lkp@intel.com/config)
compiler: clang version 19.0.0git (https://github.com/llvm/llvm-project a0c6b8aef853eedaa0980f07c0a502a5a8a9740e)
reproduce (this is a W=1 build): (https://download.01.org/0day-ci/archive/20240716/202407161159.KA2METLk-lkp@intel.com/reproduce)

If you fix the issue in a separate patch/commit (i.e. not just a new version of
the same patch/commit), kindly add following tags
| Reported-by: kernel test robot <lkp@intel.com>
| Closes: https://lore.kernel.org/oe-kbuild-all/202407161159.KA2METLk-lkp@intel.com/

All warnings (new ones prefixed by >>):

>> drivers/cxl/core/hdm.c:612: warning: Function parameter or struct member 'is_ram' not described in 'cxl_request_dpa'
>> drivers/cxl/core/hdm.c:612: warning: Excess function parameter 'mode' description in 'cxl_request_dpa'


vim +612 drivers/cxl/core/hdm.c

   589	
   590	/**
   591	 * cxl_request_dpa - search and reserve DPA given input constraints
   592	 * @endpoint: an endpoint port with available decoders
   593	 * @mode: DPA operation mode (ram vs pmem)
   594	 * @min: the minimum amount of capacity the call needs
   595	 * @max: extra capacity to allocate after min is satisfied
   596	 *
   597	 * Given that a region needs to allocate from limited HPA capacity it
   598	 * may be the case that a device has more mappable DPA capacity than
   599	 * available HPA. So, the expectation is that @min is a driver known
   600	 * value for how much capacity is needed, and @max is based the limit of
   601	 * how much HPA space is available for a new region.
   602	 *
   603	 * Returns a pinned cxl_decoder with at least @min bytes of capacity
   604	 * reserved, or an error pointer. The caller is also expected to own the
   605	 * lifetime of the memdev registration associated with the endpoint to
   606	 * pin the decoder registered as well.
   607	 */
   608	struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
   609						     bool is_ram,
   610						     resource_size_t min,
   611						     resource_size_t max)
 > 612	{
   613		struct cxl_endpoint_decoder *cxled;
   614		enum cxl_decoder_mode mode;
   615		struct device *cxled_dev;
   616		resource_size_t alloc;
   617		int rc;
   618	
   619		if (!IS_ALIGNED(min | max, SZ_256M))
   620			return ERR_PTR(-EINVAL);
   621	
   622		down_read(&cxl_dpa_rwsem);
   623	
   624		cxled_dev = device_find_child(&endpoint->dev, NULL, find_free_decoder);
   625		if (!cxled_dev)
   626			cxled = ERR_PTR(-ENXIO);
   627		else
   628			cxled = to_cxl_endpoint_decoder(cxled_dev);
   629	
   630		up_read(&cxl_dpa_rwsem);
   631	
   632		if (IS_ERR(cxled))
   633			return cxled;
   634	
   635		if (is_ram)
   636			mode = CXL_DECODER_RAM;
   637		else
   638			mode = CXL_DECODER_PMEM;
   639	
   640		rc = cxl_dpa_set_mode(cxled, mode);
   641		if (rc)
   642			goto err;
   643	
   644		down_read(&cxl_dpa_rwsem);
   645		alloc = cxl_dpa_freespace(cxled, NULL, NULL);
   646		up_read(&cxl_dpa_rwsem);
   647	
   648		if (max)
   649			alloc = min(max, alloc);
   650		if (alloc < min) {
   651			rc = -ENOMEM;
   652			goto err;
   653		}
   654	
   655		rc = cxl_dpa_alloc(cxled, alloc);
   656		if (rc)
   657			goto err;
   658	
   659		return cxled;
   660	err:
   661		put_device(cxled_dev);
   662		return ERR_PTR(rc);
   663	}
   664	EXPORT_SYMBOL_NS_GPL(cxl_request_dpa, CXL);
   665	

-- 
0-DAY CI Kernel Test Service
https://github.com/intel/lkp-tests/wiki

