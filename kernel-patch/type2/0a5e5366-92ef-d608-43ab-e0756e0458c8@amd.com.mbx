From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2044.outbound.protection.outlook.com [40.107.236.44])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 07C841C686
	for <linux-cxl@vger.kernel.org>; Sat, 18 May 2024 09:59:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.44
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716026390; cv=fail; b=X+la2sG6z2wzoZgXputDBliEhwBuLjtbc9NLVgm8gZZPmbIUGMe2vqlVmYajXESRnG+OKmZfFLW8vIHmDTvWQd/4Kq3nxLqExVdeLO6QNaSw4fwH/IhkiTzxtLXeO6huHzbMY+edH1X/w0+2ocrT/KsFP79eroondlWOkLY08QY=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716026390; c=relaxed/simple;
	bh=50DDT0SLh2bxyAxLjiFrlPHMy57/siEDMOuIJA0KAfA=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=AXCXHXzhb87KI5qDJVS8OciWtzbEXiazoaihQZbKceXyhrLkD8mzLdQZff2MDSXKl91pUj8IIRNxegjvmMZ7+9gMy3J7oBAU+S3wNYt56gP37h8Hi8R1m/KpmMu9d8qeeAz/vVQtBfv86HgGtPWY8Hu1MFswJJxtB9r9dHwVDkc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=4TLaZwBX; arc=fail smtp.client-ip=40.107.236.44
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="4TLaZwBX"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=HqyywfmKM9MB5rLN0AHCLjfkW2clPaIbdWJMJw326v9zgHwZoCZNt0q0rmP+acJzmcIiizH8ZTPihGaHRKyWfVUv1myofE7NlcQQPm5MVP+B5mMyPCXnGobopBO1RIJf+RzJ7xuROvJHvoqSf/bikscPfCw7WGatTyuE5CdN9oDR0sKxmCl+DJOantThMH8gllK5f+NO5PzIQJGOC/WmWhF3Ono9I1h3I4rtWSiss6SIUhFugLTJIgRQca67NwutMr6Y0Zaj+H5jyfbXBz+fdSSJOtP+s5t1j6qU/Og4rKToLFxdOhIRbvNccEAGgjI7b1PAYDQsHUB/VxUgQKgBEw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ZRDynFs3EQhgSW71hFTgm7r7HmVNGG9pUCwBylJZ1Mw=;
 b=gXzjfqO2cRp5bOJHtOWrqPsT6Ay6w3Vf+FuJkN3OAgZ89UtcFDXB127I+qw2X5PnUvNuhULZD+rLGrQOaGg1Q681c6AYQLJgxP+a1Pv/fbcvcA+jlfLHCJ/3c/g/E4LIQV8LF/vSWuAIBxG9AR2X0rLb8HrPMaTbzS5Q/spxko7k7Z1jpa4IbaA5Be/VtTQQppPkjNZ6CrZCsvJWPGltGcK9U7fZY7u2o818ZxKK7UW2QBpnz4kjitzK0dbnN7pi/rb/PJoS6zZsL4/pDUqSIb+51Py7l9kE0rwiIpywnS34iLsnmoUXgOgE8cSN3P39RTtalzoBAmLVw9su8MVqzQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ZRDynFs3EQhgSW71hFTgm7r7HmVNGG9pUCwBylJZ1Mw=;
 b=4TLaZwBXHOFmjuHd50pqn51BY8B78DkG7+vjVx3zq9TDbUy+S9SRjZ9f/wa/NpQhQn8aZe8JmkHKKrHRWZwu9POzQukX3rQdkGJuIR3pkfR2QTNKxSJq24ckxsjjMWsSv+wasUIDAfUJsVlIp1HkgawZAb7wouLqNyKFsu2OW3Y=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH8PR12MB6842.namprd12.prod.outlook.com (2603:10b6:510:1c9::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.30; Sat, 18 May
 2024 09:59:45 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7587.028; Sat, 18 May 2024
 09:59:44 +0000
Message-ID: <0a5e5366-92ef-d608-43ab-e0756e0458c8@amd.com>
Date: Sat, 18 May 2024 10:59:40 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 00/13] RFC: add Type2 device support
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
Cc: Alejandro Lucero <alejandro.lucero-palau@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
 <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO2P123CA0101.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:139::16) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH8PR12MB6842:EE_
X-MS-Office365-Filtering-Correlation-Id: d5f0f998-97e5-422f-57c3-08dc77213e84
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|376005|1800799015|366007;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?L2xOZzhIL0RsUVFWRmlQaFVsVWMrdlRyNkZJWXRsYUlRV0h6Y1Q4TndRMkhD?=
 =?utf-8?B?VmYzTmJJeTVEdE9SKy9vTnZkcEhyUDJBVmYweFZMdzFKNkZDM0FVb3FsY1lw?=
 =?utf-8?B?L08xMUhweWlCQXlDSGRYZTNTdFZadUxGWDZ5M2s5K0hLT05LSmxLMWxabzZH?=
 =?utf-8?B?RXdZcG1EU2tPbUNTcDlOTU4xd1pPUWtrd25UTjlQdjIyR1BGVFhCVmxkYk5D?=
 =?utf-8?B?MDZmMzFxM3B0bnd2VkJKc0NoZlVvU0NreS8wREdMM0hURkIya2t0MUxNcWxW?=
 =?utf-8?B?WHhIMGx3UkMyak0wdCtoYTgrcmVMSUYzT204YjVrS0p2Mlkvd21PN2tQNHMv?=
 =?utf-8?B?bHVYYU4xbHZUejRUcVZRUlAyZEduZWNBODFNZkNvUkg4di9IcWlvS3dvNDVk?=
 =?utf-8?B?ckpyczFwZ2YzQ0V3TkdJdE51SHdCNUF5NWtkVGljTSt4L3Y3WkJ0VlBMUFNG?=
 =?utf-8?B?cFNWcEhiNkU2Qm9mQ016blpaTEFBRjNLQUREcU1vS0NycWdpazk5bmh1OW9y?=
 =?utf-8?B?aXkwVEtDbE0reUk0NjR6c2ZORzRPM3VRUjRsTzBXTTdYMHVva3JGUVV4RVpo?=
 =?utf-8?B?OTg1L1Y2ZEVYbTZBclVCT0NEYWcxWXUvbFZoTFlOMlNlcmVhNG96LzV1Y3pV?=
 =?utf-8?B?aHhxcWJxcktYdUo3L05PdGhPM1o2eTdhUDl4VEk0b09SQVIzcTk5d3lMUFcy?=
 =?utf-8?B?ajRFQ2t0UHJ5R2ZBY0tzeWtvU3VGa2w0dXlWbU1TeWRQZW5ObjNNVHloMDF6?=
 =?utf-8?B?c1BxeGk5WnU4TlQ5TzZ2aGxtVUIyR0R4YXRSSHo5T3hKQlNkZFE5dXFMd2No?=
 =?utf-8?B?bW84cWxodzAyUUthVU5USjk0WUxvQXg4dStpeXdEN0RkVmFMYlFvU0g0QVNx?=
 =?utf-8?B?ckpna2k1b0JSQ1FDV3RPdFlBcnUvT2R4cUpYRHJxVFMxSUdUdSs1K29lcEJK?=
 =?utf-8?B?ZEI2bXF2UU94dTgwVzZuWWw5MVo1by9peGVwQVgxdTJTcEtCZWM1SVA2L2FZ?=
 =?utf-8?B?MWxWMkppRllJMHRsU2o1STdrUTFOekErbUkyVmhFdTdCa0o3N0RJNXl0bCty?=
 =?utf-8?B?b09kejdvb056Mk9PQm1UeGlHNkxScWc5L2RYczR0b2VuQzVqS01yWGlQMXVz?=
 =?utf-8?B?SnRXbkNNYm1PVTZPcExyd3BIcGI2QjVRNHdFUHQxWk0vQ3dvckJqejF3ejNw?=
 =?utf-8?B?YmJHZ3hBb1duR0Z6OGlESTNwZ0ZLMHVqNXpNN0hvNEhPTUovd1BUSmdmay9B?=
 =?utf-8?B?YmlzcTh2Q0RrMWZZS21lanljelZqbnk1NHVibVlhaHlCMjhoOWpFbDhQNlF1?=
 =?utf-8?B?NkdiSlpIK3BlUGV0alRlc3NaM0JIWjJMRlZyaHQ0N3B1Z1pIYk43NlBmQzRE?=
 =?utf-8?B?VXh0QVVvbjhxNjE4bnhmUGEvbDJYWjc5UTlaa2VNM1J3ZS9QZjlTdXp1MlI2?=
 =?utf-8?B?dXAvdzBNQ0tDNkdpNnZLelBoWStwbXRNaks0ZmgvTjlSSjlQYnRGMGV2Zk4v?=
 =?utf-8?B?L0Q3eUdGNlVmZHJuZlNMeWlTYlBlL1BpWjdJZ1ozenJDODlmZEtvRE9YNjcx?=
 =?utf-8?B?UStOWUdlWFJsVGhXSHJ3TnZIYnZpQ3JLYVM5aVd4blJzYm9QQzg2RVdoemtP?=
 =?utf-8?Q?S5/zvE3uUXx1ro74QsmeBTWvSjgPZXeuB4YFZcpABy4A=3D?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(376005)(1800799015)(366007);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?aHh3VXZZVHk4Z0pkOTJIa3lvZ094cDNESUNCNFI0NER0VmRIWXBDZmRMY1JE?=
 =?utf-8?B?Q1FFVHlGVDV6UFhFc3ZESm9lMjFLdDNHYXl6SUd2UjVPeDhjWVZYTEF0eVlJ?=
 =?utf-8?B?ODUrdUUwR1E5Y21qa3EybkVvK1JabUtzZ3dVbU1HcC9NczFGekZHeTF5QWNw?=
 =?utf-8?B?NVFiUDVuekFFa2J0a2pNK2Vhc1VPS25DbEtFdlpGdGRZSWp1UDgrYjJtNnV4?=
 =?utf-8?B?dHpMS3JZamh3eTRlSkFvZmREek9aSGFkOG9JTXM2ZUhsWGhPdElkZGh3WHRI?=
 =?utf-8?B?Ni9Xb2hJaGxRZVdPc0tEUTZISy9WQVVxei9kMDlXbTVlQy9QZVZQMDFGVXox?=
 =?utf-8?B?a3R4czNDNm1wNzhRalpxMkU5UktTT3p4SWV3Mi9KNTF6aEdCOHZ2bVVFMEE5?=
 =?utf-8?B?R0VTWk5VTDEvNHRiNDhrMUMvRzlSaHVzb1pTU2VacnVYQVdaTUxOZVlXQlV0?=
 =?utf-8?B?UFhVaGc3c3hidnhPMDZEQ1NZT21DcnN2K2RvTmQ3ZHZ0dlJkRFo5Wi9UcXpZ?=
 =?utf-8?B?YzllY1NHMm5YYy9sQzV3UC96dGdLNUM3ak9hRjIxOVRXVGplbGlTNU1nWnJK?=
 =?utf-8?B?dnlRM3Vyb2kvZWZnSVpXODFiVHJTVlNRYkZpV21ockp6ZHE5UE4yYWQyTkpN?=
 =?utf-8?B?ci9rT3RkZjlnNDdwU3h4c0syWDRmaXQvcE1jVCtZTUd4d2hOZHVHa2xoM0Nj?=
 =?utf-8?B?M0c3V24wTElFOEh1bmRqNWVhbEJmNTY1d1hEM1dvUVFsWnp4aXdhZEkwTysw?=
 =?utf-8?B?UUNnNThoMzVaVHJJc2U5RHhJVTBtNXJ1bmJDOVp6RzZxd2ZNZEtxamdWa3kv?=
 =?utf-8?B?c3Jqb0dab3pPMVdFRGwrVTZhUUNTZ0FESnFXdWlkbGVNUms3VmNmcnRtVktp?=
 =?utf-8?B?YzNOd0x5TFcrQ3Bwc0lQMnR2aGhMNGdjbk9RZHQvMUlhbTBhVVRFcHI4ZnZs?=
 =?utf-8?B?dCswYlYrQy85cHRLdTFJTUxZR0FZb1MzVklubjR1VXlRWFYreUdIM1pGcUg2?=
 =?utf-8?B?cG44V01lL1FiTUFBMzFHN2gyUnFwcHlVVFJFWHpvU2tlbGlqcnArWURRZVF0?=
 =?utf-8?B?U2xvcjdvT3ZieEcvNERIYWZicktVYzRRNXpnNTREV2RzMnVaNkNJT01UUEE5?=
 =?utf-8?B?QW1rWXpiNitzN0VIbTljaW12eG4wS000YWZFbU40M1pzQ2o1TFhwNmNjb0ZL?=
 =?utf-8?B?Tm5GdlJuY0kzMnV0OWE2OWM3UkVIM1lXLzF0N1RZbEpPdXZCVGFMVU5nMHZi?=
 =?utf-8?B?d3N0TmtMTHpqSGMzVlJiUmFVZjdQa3ZXMVBoMEppN0JqbkNkRk1mZ0ZoVWs1?=
 =?utf-8?B?Qy90YU5SV0hvbWVJMWhyVUdZaUJ6V0x3WXZlNndQd3l4a3BXUVpKaUc4b3RT?=
 =?utf-8?B?d3NNdXdCc3VGK2ExNFpzRkQ0VXdGL3JIRW04NWptcFpYWFd1S1ZpeklGNVNH?=
 =?utf-8?B?NVhscXRMQkxhaXJ6UTNOYzdkWVoxdm1DWmhQMVVKWDlMaFJpS3BTby9jS3Vl?=
 =?utf-8?B?SzlLbjBIcWNNVGZBS1NMdlo1SFFpNnVIeDVOT1M5bUdLUWxjWSs0SmVPR1JM?=
 =?utf-8?B?ZDVhU2FVL0JwRWZMRW0xanJ2Y3Rxa0VPUjVhTFZXZ2pmeE5iQ1U3YmFzamth?=
 =?utf-8?B?TmxIN1VYV0RPa1IwWm9sd1NLOUFBU1RWODNkdmhLZlJuZnRiWkNyREV1QzJ5?=
 =?utf-8?B?L1ZIYWE3c1pMMEMveUlmbHNpQktPdTMyaEJPaHQ5THE2QUFEbzJIeTVBMkNG?=
 =?utf-8?B?TDhQaHJNd1BqckNmUy9xODJETWZtczNrcHZZSk5ZdDBqNEV2Y09HWlFISnIr?=
 =?utf-8?B?Q3VDQnFGQjZGVVlpWmhqc1M3cjh1NW9PaGJ6TFVrTFhaNnZqVjM5cHZTRDNl?=
 =?utf-8?B?VllOSFJPU1FQSkRzd2VGSnM5bjlsRUJiOVBUVEVmVFIwYXhPa01sUXN6em94?=
 =?utf-8?B?NmZBa2FPSklZbTI5d2RpbWxPcUVIRzlhN2pJN093dnpNYVpPUUh0aFV2Vk1y?=
 =?utf-8?B?TDdCMStSbDdmSGR6L0dTUlhHTmhLQXB1UGY4dlpacmZ6R1dKekI5TnRETTFB?=
 =?utf-8?B?ekU1MkgwaWVCbGdSRG9Qb1I0bWl1WTJSSDBPTTJyWFBKdHRyVU43d2ZHc3F0?=
 =?utf-8?Q?R7NsFOBCjWhibLHo5w+vSTTbS?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: d5f0f998-97e5-422f-57c3-08dc77213e84
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 18 May 2024 09:59:44.7535
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: T5OoJ/3zwChhqzJMYx4b365B9/4KaxCmDm71e54XKH+HBdnjy4++fzoTKwkYTI02pbZn5FF23vJ30vISIpxbag==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB6842


On 5/17/24 01:08, Dan Williams wrote:
> alucerop@ wrote:
>> From: Alejandro Lucero <alejandro.lucero-palau@amd.com>
>>
>> I need to start this RFC explaining not what the patchset does, but what we
>> expected to obtain and currently is under doubt: to configure a CXL memory
>> range advertised by our CXL network device and to use it "privately".
>>
>> The main reason behind that privacy, but not the only one, is to avoid any
>> arbitrary use by any user-space "client" with enough privileges for using a
>> public interface to map the device memory and use it as regular memory. The
>> reason is obvious: the device expects writes to such a memory in a specific
>> format.
>>
>> The doubt comes from the fact that after implementing the functionality exposed
>> in this patchset, we realized the current expectation seems to be a BIOS/UEFI
>> configuring HDM decoders or HPA ranges and passing memory ranges to the kernel,
>> and with the kernel having a default action on that memory range based on the
>> flag EFI_MEMORY_SP being set or not.
> Lets clear up this confusion first.
>
> My expectation for CXL accelerator provided memory is that it is marked "EFI
> Reserved" in the memory map (or CDAT), not "EFI Conventional + Special Purpose
> Attribute". Recall that the EFI_MEMORY_SP attribute is just a *hint* that OS may
> *not* want to consider a memory range as part of the general purpose memory
> pool. CXL Accelerator Memory is far from that definition. If a driver needs to
> be loaded to effectively use a memory range that is not a range that can be
> transparently converted to "EFI Conventional Memory".

Well, that "EFI Reserved" is what we want. However, AFAIK, it is 
EFI_MEMORY_SP the only one being discussed with our BIOS/UEFI contacts.

Because how to assign those flags seems to be based on BIOS 
implementation, we count on some BIOS versions doing the wrong thing for 
our purposes, so I have been working on a workaround implying udev 
events and executing a modified daxctl for switching a dax device mode 
or even removing/destroying it.

Anyway, that "EFI Reserved" flag gives up hope.

>> If it is not set, the memory range will be part of the kernel memory
>> management, what we do not want for sure. If the flag is set, a DAX device
>> will be created which allows an user-space client to map such a memory through
>> the DAX device API, what we also prefer to avoid. I know this is likely going
>> to face opposition, but we see this RFC as the opportunity for discussing the
>> matter and, if it turns out to be the case, to be guided towards the proper
>> solution accepted by the maintainers/community. This patchset does not tackle
>> this default kernel behaviour although we already have some ideas and
>> workarounds for the short term. We'll be happy to discuss this openly.
> It may have been subtle, but even in my initial RFC [1]. I was explicitly
> skipping exposing accelerator memory via device-dax:


I did not see that. So, happy to know we are in the same page here.


> @@ -3085,6 +3183,15 @@ static int cxl_region_probe(struct device *dev)
>   					p->res->start, p->res->end, cxlr,
>   					is_system_ram) > 0)
>   			return 0;
> +
> +		/*
> +		 * HDM-D[B] (device-memory) regions have accelerator
> +		 * specific usage, skip device-dax registration.
> +		 */
> +		if (cxlr->type == CXL_DECODER_DEVMEM)
> +			return 0;
> +
> +		/* HDM-H routes to device-dax */
>   		return devm_cxl_add_dax_region(cxlr);
>   	default:
>   		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
>
> [1] https://lore.kernel.org/r/168592159835.1948938.1647215579839222774.stgit@dwillia2-xfh.jf.intel.com
>
>> So, this patchset assumes a BIOS/UEFI not programming the HDM decoder or HPA
>> ranges for a CXL Type2 device.
> At least for Linux it should not care whether BIOS maps it or not. The
> expectation is that whichever agent maps it, BIOS or Linux CXL core, that agent
> honors the memory type specified in the device CDAT. I.e. the "Device Scoped EFI
> Memory Type Structure (DSEMTS)" in the accelerator CDAT should pass "2" in the
> "EFI Memory Type and Attribute" field, where "2" indicates "EFI Reserved" memory
> type for any HPA that maps this device's DPA.
>
>> above, a Type2 device added after boot, that is hotplugged, will likely need the
>> changes added here. Exporting some of the CXL core for vendor drivers is also
>> required for avoiding code duplication when reading DVSEC or decoder registers.
>> Finally if there is no such HPA range assigned, whatever the reason, this patchset
>> offers some way of obtaining one and/or finding out what is the problem behind the
>> lack of such HPA range.
> Yes, that was the whole point of the "Device Memory Setup" thread [2] to show a
> plausible way to reuse the common core infrastructure for accelerators with
> CXL.mem capability.
>
> [2] https://lore.kernel.org/all/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/
>
> It would help me if you can summarize what you did and did not adopt from that
> proposal, i.e. where it helped and where it missed the mark for your use case.


I basically took your patchset referenced in the RFC, specifically the 
19th one, and tried to work with it from a pcie/CXL device driver. I did 
debug all the problems precluding the CXL invoked function to succeed 
and applying those changes from previous patches required and not 
committed yet. Patches 7, 8, 9 and 11 are based on your patchset, with 
just some minor change since I did not see a reason for changing them 
after studying them. The other patches are those fixes for having a 
Type2 finally able to create a dax region and map it.

> [..]
>> Keeping with kernel rules of having a client using any new functionality added,
>> a CXL type2 driver is increasingly added. This is not a driver supporting a real
>> device but an emulated one in QEMU, with the QEMU patch following this patchset.
> Lets start with the deltas compared to [2], the observation there is that much
> of the CXL core is reusable for this type-2 use case, and even improves the
> organization of the core. The consumer of the refactoring just ends up being a
> few new helpers around the core.
>
>> The reason for adding such a Type2 driver instead of changes to a current kernel
>> driver or a new driver is threefold:
>>
>> 1) the expected kernel driver to use the functionality added is a netdev one.
>>     Current internal CXL support is a codesign effort, therefore software and
>>     hardware evolving in lockstep. Adding changes to a netdev driver requires the
>>     full functionality and doing things following the netdev standard which is
>>     not the best option for this development stage.
> Not sure what "netdev standard" means, and not sure it matters for a discussion
> that is constrained to how the CXL core should evolve to accommodate
> accelerator-local memory.

You know I could not add to a netdev driver just those changes for CXL 
initialization, then mapping a CXL region and doing nothing else. Such a 
mapping needs to be linked to something inside the driver what is just 
under development and testing.

>> 2) Waiting for completing the development will delay the required Type2 support,
>>     and most of the required changes are unrelated to specific CXL usage by any
>>     vendor driver.
> Again, [2] already path cleared the idea that early plumbing of the CXL core for
> type-2 is in scope. Just need to make sure this effort is focused on general CXL
> specification use cases.
>
>> 3) Type2 support will need some testing infrastructure, unit tests for ensuring
>>     Type2 devices are working, and module tests for ensuring CXL core changes do
>>     not affect Type2 support.
>>
>> I hope these reasons are convincing enough.
> I am happy to have general specification discussions about core functionality
> that all CXL accelerators need and plumbing those ABIs to be exercised via
> something like cxl_test.
>
> I expect that cxl_test only covers coarse grained inter-module ABIs and that the
> fine details will need to wait until the accelerator specifics are closer to
> being disclosed and the real driver patches can start flowing. In other words, I
> am not keen to see QEMU used as a way to proxy features into the kernel without
> disclosing what the real world consumer actually needs.

Sure. FWIW, this will end up changing a internal driver mapping HW 
buffers which are now based on PCI BAR offsets by same mapping based on 
CXL region mapping.

This involves, PFs and VFs, and because CXL is only advertised by PF0, 
this all brings more complexity to those changes than could be expected.

I think taking the CXL core to the support needed, hopefully based on 
this RFC, should be started as soon as possible instead of waiting for 
our driver/device to be ready.

>
> Now, that said, there may also be opportunity for targeted extensions of the
> QEMU CXL memory-expander device, like DPA capacity that is mapped as "EFI
> Reserved" device-memory, but lets talk about the specifics here.
Yes. I'm actually using qemu hmem and kernel efi_fake_mem for some 
testing about those workarounds, so happy to help with new qemu support 
for the "EFI Reserved" case as well.
> Also recall that the current CXL driver does not yet support parsing CXL PMEM
> region labels. Support for that ends up looking quite similar to an accelerator
> asking for a specific DPA range to be dynamically mapped by the CXL core. So I
> think we can get quite far along the path to enabling type-2-CXL.mem just by
> flushing out some of the generic type-3-CXL.mem use cases.
OK. I'll take a look to those pmem needs.
>> I have decided to follow a gradual approach for adding such a driver using the
>> exported CXL functions and structs. I think it is easier to review the driver
>> when the new funcionality is added than to add the driver at the end, but not a
>> big deal if my approach is not liked.
>>
>> The patches are based on a patchset sent by Dan Williams [1] which was just
>> partially integrated, most related to making things ready for Type2 but none
>> related to specific Type2 support. Those patches based on DanÂ´s work have DanÂ´s
>> signing, so Dan, tell me if you do not want me to add you.
> It is fine to reuse those patches, but please do include:
>
> Co-developed-by: Dan Williams <dan.j.williams@intel.com>
> Link: <lore-link for copied code>

Ok. I'll do the changes for next versions.


> ...so I can try to remember if I still think the source patch was a good idea or
> not. Again, a summary analysis of what did and did not work for you from that
> posting would help me get a running start at reviewing this.
>
>> Type2 implies, I think, only the related driver to manage the CXL specifics.
>> This means no user space intervention and therefore no sysfs files. This makes
>> easy to avoid the current problem of most of the sysfs related code expecting
>> Type3 devices. If IÂ´m wrong in this regard, such a code will need further
>> changes.
> Not sure what you mean here, I am hoping that sysfs ABI for enumerating objects
> like memdevs, decoders, and regions "just works" and is hidden from the
> accelerator vendor driver.

If a Type2 is fully private, should be any sysfs files about it?

AFAIK, those files are mainly for user space able to create memories 
joining them, or for changing the dax mode. What do you think a Type2 
needs through sysfs apart from info? While writing this I realize I have 
not thought about power management ...

>
>> A final note about CXL.cache is needed. This patchset does not cover it at all,
>> although the emulated Type2 device advertises it. From the kernel point of view
>> supporting CXL.cache will imply to be sure the CXL path supports what the Type2
>> device needs. A device accelerator will likely be connected to a Root Switch,
>> but other configurations can not be discarded. Therefore the kernel will need to
>> check not just HPA, DPA, interleave and granularity, but also the available
>> CXL.cache support and resources in each switch in the CXL path to the Type2
>> device. I expect to contribute to this support in the following months, and
>> it would be good to discuss about it when possible.
> Yup, especially CXL 3.x Cache ID management. Lets talk about some ways to plumb
> that, because it is also a general CXL specification capability. Another topic
> is what is needed for CXL Protocol and Component error handling, I expect some
> of that to be CXL core common and some of that to be accelertor driver
> augmented.
>
> If you think we will still be talking about this driver enabling in September
> I would invite you to submit this as a topic for the CXL uConf.

That would be great!

If this RFC work is integrated by then with the CXL core, that would be 
fantastic, but the CXL.cache support will still be pending.

>
> https://lpc.events/event/18/contributions/1673/

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.16])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B6EB16125
	for <linux-cxl@vger.kernel.org>; Tue, 21 May 2024 04:56:18 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.16
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716267381; cv=fail; b=I8PAvgP48+lR2DDc8xXqrX9FWoqgD6D4M2jjaZ/2rGkGncfIz7zIP7SYOdGVOaYT7/OvIN9rZszaOUMGNYrNyPigZ/AV4aGWUgSkKcpImEzURf5cTDYVbvIg2fO9GHD7ns8BFIAplF6Xb7bF+PGCJH5S2Cn/UCCN85+okBuvvQk=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716267381; c=relaxed/simple;
	bh=0WWkaOsw48re0aQV4dsQq3Bki/4kxWw5V86WK4GWO70=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=oGARl2/ht7tKKqg5biYdWQWvNvtaX23ql+R5OZuw3fXsyar/yasWjXEhLJqp6SJcc9YRXKGE/Rh6eboU8u7umRcW/zSkciuX2t8o0gS+8vqZAiGkE0nYlBVDW5OS7Ny8TvvFk2teQte886ga3z+zmgIKCEPfOr05pNpBWLzSfoQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=lgLiRIvg; arc=fail smtp.client-ip=192.198.163.16
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="lgLiRIvg"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1716267379; x=1747803379;
  h=date:from:to:cc:subject:message-id:references:
   content-transfer-encoding:in-reply-to:mime-version;
  bh=0WWkaOsw48re0aQV4dsQq3Bki/4kxWw5V86WK4GWO70=;
  b=lgLiRIvg0UHWmSWf4P+r1SB80JURUYb3Tjhn7hx8UicME2cNbIqyAHhk
   n4QPkBp5+Zyevj8yi7t5hYNsnEybQudmqPaXI6Hd9iiYx+La+IO0B1XI3
   kY1GIafWre1plX2cEl9Co1kS3Dg6j/+a8U99u8mPFGhU+Dm6VKkVdL8MW
   1peawWMDYapXagqNjSCfQL0ZJZ9ZQycBB8n8+Qk0UZXZzQ6BJAH3M7Zf1
   ImzT7UuJlg8SjGWGmiRV4ntKAIDVYdVcKip27MB2yrNUW3wvyqCOJXmxr
   u1r2/f8sZFVCSY5gpmSbQRhPQzEq5O6WMNBGy/TfCuQGxr0M/f8doVdB9
   Q==;
X-CSE-ConnectionGUID: aAuauSRtQ7C34sfVQcSXYw==
X-CSE-MsgGUID: QzEnKSaxS/ymEl8Tlp+sTg==
X-IronPort-AV: E=McAfee;i="6600,9927,11078"; a="11623490"
X-IronPort-AV: E=Sophos;i="6.08,176,1712646000"; 
   d="scan'208";a="11623490"
Received: from orviesa009.jf.intel.com ([10.64.159.149])
  by fmvoesa110.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 20 May 2024 21:56:18 -0700
X-CSE-ConnectionGUID: fo/3ibEaTaqxQ6zYhjUcGw==
X-CSE-MsgGUID: CiDESXzpRpKvZksIUQB0kw==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,176,1712646000"; 
   d="scan'208";a="32953965"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orviesa009.jf.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 20 May 2024 21:56:17 -0700
Received: from fmsmsx602.amr.corp.intel.com (10.18.126.82) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Mon, 20 May 2024 21:56:16 -0700
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Mon, 20 May 2024 21:56:16 -0700
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.172)
 by edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Mon, 20 May 2024 21:56:16 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=QPf9p0q/9QmMWmW/3Ovgs4z40aGywWOXaGjO2cqz8TpMEEa1PqrQddiVINwk93PX1bDov3pN/LP0kAe51ZRxIhdBneNDwki5ZxAwdMwLUVAA/W8bDQNIIyAL9K3WnS6LLGGxI1gdxF4qp6I5WCdkI186+1MdSP6WAD9dwXC+MafL618zieZFsFgT9BRJK5Wtqk5ILtWioVFJgllsWGmTjoVaoUWCp0FvHLFPEVZV/Z0Jj4FccdasXTe+LVXe2p+O/7Rrt+mXLfXJmDuBAoFyP8iZf/WOPj0yymc0XjBeVjJNfxBB/QN7zw5u1rg8SpoJIPNWilESzh6pK98BEykFLw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=W69OkrX/ATk4LKn5EFmukcLNzUrR5qlHAykspPyMj4I=;
 b=DoGT5Xl04kHvotTsDdVMlfyY524S8mSUPXJqWmccmvS3eLj+X6cJr0tVeb8xrXDrfmsHCcho6IcLtMNokxvTRe4dKovb1HsYDJL2DxuOVVxXJRN0H4M6AZidv3Hq5IAMrKDclWDEWc432b0NErklACSh2KuanFStjEBVkOafVTrgMz596upbLnkzap4bygV0IQYLTbPg/mQ5GcEBSedGnLFFXSwgwCBmSmR/Qgn3VnuS5NGdfpBdLb+/iZTf452cIMjJAnLVWerPFAEkc5OH5ekTadSKGEfQIc7u5J2YR9HVP35O9uHRh/PlYNAT1eoBT+sCP7m72HLx7u42qu+B5A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by DS0PR11MB7682.namprd11.prod.outlook.com (2603:10b6:8:dc::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.36; Tue, 21 May
 2024 04:56:14 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7587.030; Tue, 21 May 2024
 04:56:14 +0000
Date: Mon, 20 May 2024 21:56:11 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: Alejandro Lucero Palau <alucerop@amd.com>, Dan Williams
	<dan.j.williams@intel.com>, <linux-cxl@vger.kernel.org>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alejandro.lucero-palau@amd.com>
Subject: Re: [RFC PATCH 00/13] RFC: add Type2 device support
Message-ID: <664c296bacb6f_a0282947a@dwillia2-mobl3.amr.corp.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
 <0a5e5366-92ef-d608-43ab-e0756e0458c8@amd.com>
Content-Type: text/plain; charset="iso-8859-1"
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <0a5e5366-92ef-d608-43ab-e0756e0458c8@amd.com>
X-ClientProxiedBy: MW2PR2101CA0024.namprd21.prod.outlook.com
 (2603:10b6:302:1::37) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|DS0PR11MB7682:EE_
X-MS-Office365-Filtering-Correlation-Id: c001bc6c-07f1-4da2-6fcb-08dc7952574c
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|376005|1800799015|366007;
X-Microsoft-Antispam-Message-Info: =?iso-8859-1?Q?9st7LDgpWMbrcLkrMUO2rn1SRwnJgNDI7Lmf/9ggQXgVs0NbQwa0G+ArLw?=
 =?iso-8859-1?Q?aRRPQCQwA74F14vm/jKjZbw+AnVDNA/zXBmy5SsnuQov2toO1JQQ5Qxk6G?=
 =?iso-8859-1?Q?ZyyG783RCXKJ6VCWBbb+eoVj7ushTR0zf8RJbMErKhpLiZEp2sgAzEnu+8?=
 =?iso-8859-1?Q?iARxH346bZ6UPgHJoUSVit2BX3caPnVP8RJjyytPpLCuEzw8ImTskIBTkS?=
 =?iso-8859-1?Q?fE5RfuxClpsF/CcqDgV6I/g2BT6n7QcbIQ5779zrXm8l0YgNWtU2LMCqYk?=
 =?iso-8859-1?Q?g7s3tiOk+XAyftWq+GWb/Dx9lTmwQwYxyXjunsZqok6YmBZx7gi8RriBBb?=
 =?iso-8859-1?Q?1tzR8OPdrr+L/0t+WB3dwY2yxCDtGXJy3QGch6a5TrSpX9QGPUSs67Shl4?=
 =?iso-8859-1?Q?lmTnW54xCst/PVnceRoJ+vCxyRFIpZjGfWLPbjIhQCUS57XC+AGX92mW6d?=
 =?iso-8859-1?Q?FZLjLBsLbGp3UAz+zn1M7cBZuRtra5uyEKYtVxnmWfPItomJKd7cQhHJjd?=
 =?iso-8859-1?Q?6H9BERR0oPbK6vLVoeCSppZ9zaVd0ydTO4jZAc+4cYmt8ImsRem1A/ngyg?=
 =?iso-8859-1?Q?f91HQclA80AlblWdqNYvCMnfejNLYeY+PqtOc5lQQ/KecLSgLuTxol3mJL?=
 =?iso-8859-1?Q?8GQtGird4aXRWF6+UpnhFY3i8+rFME6j8KtVhlgyNfWdHl6ROJZ8R/Kso0?=
 =?iso-8859-1?Q?Dqn50YDuwGhRecNl0+elW2w2MU4Jp1IijCRlzwnU6enLZM8xXmvHOGvxnr?=
 =?iso-8859-1?Q?k3yR5D+EHVRCtS+OlrU55fO5KdnhdZ4IHMun0c+g2VuPt76Mbi/MwvxZD+?=
 =?iso-8859-1?Q?c5igKJbFDV6pRyO9pzMOweTHTfVNpWyX513zVb4tHmzJSNhyjU3JNoxD/T?=
 =?iso-8859-1?Q?B7BqyT22CFWN91Cq5G2RwcfBxeGi2wfMPuPbkHbXQFBDJCfxHRvO+3nRWr?=
 =?iso-8859-1?Q?BrvcbPeyPoPw4WEJUqD/E4iQ9DKC0gI+gNFOhfwe4+lv3vpP06an+XYD5C?=
 =?iso-8859-1?Q?MtT9hxnKMb32aK5mbH8nbvQSDp+AstH6e7QD1SW6HHlNLxRnRtYN9cVmzv?=
 =?iso-8859-1?Q?0556h+AKte8OzCkzMGJj/8BgDmd3iogktwlM44EwZUrhTAP4P85AfLORC0?=
 =?iso-8859-1?Q?8PmOd+y/p0M68cnDwC/5FLvgcX9x6rb5RsvcFVLCFxn9+HAze8OmQ2XlGz?=
 =?iso-8859-1?Q?qAl9UYd93P/fdLbM/tnGt7E3fm/fiYwBeRsjHH81AjmzAOnP1ox37EPirp?=
 =?iso-8859-1?Q?TrQhwm4iYr+XvIP+WbtbL+us52bU4KRbapqsjfcHWhXU/1Ep6iraMQ3qTO?=
 =?iso-8859-1?Q?xH0uuGC+MA3FkVCKpvqERKyKhw=3D=3D?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(376005)(1800799015)(366007);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?iso-8859-1?Q?6gQtDtJIKJrjdWESl7aQnSPATht+znsRYJKNAjd+tavUf6DABSXe2Iyw9s?=
 =?iso-8859-1?Q?c+bnI+qJd5BmbZ1FD6lNZCp7LHyiv8tHwC/m5qYv/JWVz3t/vGVm4anL9N?=
 =?iso-8859-1?Q?qPpF1P3PRyIrslvoal9di8HsQflP6Ju0fs4zMCvfd4ewsITZqlf77/dEHB?=
 =?iso-8859-1?Q?HROJRAkWWO6RQ4svqDufKe5Pdblu4mlGOxYQV0AQQUBLZLUF8OlbPJZN87?=
 =?iso-8859-1?Q?lhxv0fPisG4DirwgBSQUQ7ta0u/MVmK4I2/hCWTQa4MiTqzPWqCszessHf?=
 =?iso-8859-1?Q?DuCUMYjFsiWPDse1LRq8ewJA5J2c/WN9bbzVrWdPEuXSPy2V+63kLc5tFE?=
 =?iso-8859-1?Q?VJzfe+ZWrpOnmdVzgy3cwkyIdlSWL7MOUcFGP68u1a1gKrhS9HEBpLT8ks?=
 =?iso-8859-1?Q?9+SjZILCnVbL27Xm++xcfoYJYeMDw/cz6ApADnnEnajfcnl9CUaPCnT/ng?=
 =?iso-8859-1?Q?yoL3g8ERL6y2L0RH5IRx2T+fPoQj0Iob8Wdj9dnQIcJPknLrmhLZhD8BgV?=
 =?iso-8859-1?Q?j5akA9KDXBp9r+OWxIjAQdWwarQSYhu/yxJq/VXVwyDToOYc3upCHW2tTP?=
 =?iso-8859-1?Q?PYZEKdtVmn8bE8CDGkcIQ3kmO/l/BHo92z3onLmO5M4ByWATfHO36WBlL7?=
 =?iso-8859-1?Q?lgWhnVdRgQYKq5l/cyNjmZ439IUodG03TVV0OfTczOwd6qTGptzTOQwqUk?=
 =?iso-8859-1?Q?kk30nfmq2HnsqZSVtMkc5xTe6n1l50akSMGnftFfqxmUKWiCznlH47BpLi?=
 =?iso-8859-1?Q?e5p9ehpPap+5vsgyNGGSTPY0MWI66sGQEybp5G3pyD7nsGcSfVUI/NewWP?=
 =?iso-8859-1?Q?ncSPwiVVaMsQSOKqHR16wrB+6pjuHU6EAwyeCptCs8Lvz1PVcowUTM3nUt?=
 =?iso-8859-1?Q?RYmmOKV9nadoa91NE5gHppdddQ57G1Y6DwtLKolu4/xo4TUCtkN6Kd6CFP?=
 =?iso-8859-1?Q?lGx7kJVelM1/i8rZOrNuTE+V39rOHyAUX6puu8pLMPXpe8efSaGbSXz71d?=
 =?iso-8859-1?Q?ooh4AadHnfDydIY0BiidsQGx0GB23RzvaIWA1s8xfxp9LWoaLNSGveR1sE?=
 =?iso-8859-1?Q?EObN0cV83rnsQCTcQS7t3oceT/sySJt6ADBDeWiIoF52lVHMFKe9alJm3c?=
 =?iso-8859-1?Q?ZCuyepVsSm0izQWe4KaF2KEHYJ4CgNHhFskT4wsI7ddxbLNWYPPSc7ba89?=
 =?iso-8859-1?Q?oyGyr8QxY00EvrgBphPWBy/pz1wqyq0GbndWabrjdMc6Zcu9Yk4yhVgHhO?=
 =?iso-8859-1?Q?SkxqcJejng6TOqAbsrqXWnIai6zaa5u3dslmzvOj7hiAq/H2okcEpJrBwF?=
 =?iso-8859-1?Q?3ABdtlZtf85f6FyXHQObYm/c+xb/y5d6jxR78cz9Fot52PLctONpkcNEU/?=
 =?iso-8859-1?Q?gi3PO3NodH/H81q+rtVRkXSu2TAiistW8By3/PYo9EkgYJW2OstELSpKFv?=
 =?iso-8859-1?Q?HXcDIkJkc94avykee6VSpr0Sq7HlQh5T5Ept6wMGwDnBuos1XUbAQbcYiw?=
 =?iso-8859-1?Q?AmvOODlKT4CRVBLDg8vIhcBr9lQb8Yddr8dnNDZyd14ssEaqFD7ufAvj6X?=
 =?iso-8859-1?Q?BdwaK40ryYZUSDKhr2EvlutOULy1Zybn+cSUMzemh79YbSA6+oJvGDldIj?=
 =?iso-8859-1?Q?/e1CQPZRw+yo1/dFHvCHdqt1F1xIWEXCGmFDjcN1aSOxh6L+ob934O+w?=
 =?iso-8859-1?Q?=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: c001bc6c-07f1-4da2-6fcb-08dc7952574c
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 21 May 2024 04:56:14.0402
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 2cLWZdTox3DpRvN1sPAH0F9ZIA4XhMw2rpStphza6nURS7pTRNQlcMzO+ZdHcjIkQTM/7S1ZSrXTzpGGwFpOlY1AbaDkQqODO+EO4PL/y4M=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR11MB7682
X-OriginatorOrg: intel.com

Alejandro Lucero Palau wrote:
> On 5/17/24 01:08, Dan Williams wrote:
[..]
> > My expectation for CXL accelerator provided memory is that it is marked "EFI
> > Reserved" in the memory map (or CDAT), not "EFI Conventional + Special Purpose
> > Attribute". Recall that the EFI_MEMORY_SP attribute is just a *hint* that OS may
> > *not* want to consider a memory range as part of the general purpose memory
> > pool. CXL Accelerator Memory is far from that definition. If a driver needs to
> > be loaded to effectively use a memory range that is not a range that can be
> > transparently converted to "EFI Conventional Memory".
> 
> Well, that "EFI Reserved" is what we want. However, AFAIK, it is 
> EFI_MEMORY_SP the only one being discussed with our BIOS/UEFI contacts.

Well, tell your BIOS contacts that they need to honor what the device
puts in the CDAT for the memory-type, not just make it up on their own.

>From the Linux side we can scream loudly with
WARN_TAINT_FIRMWARE_WORKAROUND every time we see a BIOS that has failed
to match EFI memory-type with whatever the device puts in the CDAT,
because that's clearly a broken BIOS.

> Because how to assign those flags seems to be based on BIOS 
> implementation, we count on some BIOS versions doing the wrong thing for 
> our purposes, so I have been working on a workaround implying udev 
> events and executing a modified daxctl for switching a dax device mode 
> or even removing/destroying it.

Yikes, no, lets not do that. Another thing we can do from the kernel
side, in case the CDAT is missing, is to never attach device-dax to
address ranges within CXL windows with the "Device Coherent Window
Restriction".

[..]
> > It would help me if you can summarize what you did and did not adopt from that
> > proposal, i.e. where it helped and where it missed the mark for your use case.
> 
> I basically took your patchset referenced in the RFC, specifically the 
> 19th one, and tried to work with it from a pcie/CXL device driver. I did 
> debug all the problems precluding the CXL invoked function to succeed 
> and applying those changes from previous patches required and not 
> committed yet. Patches 7, 8, 9 and 11 are based on your patchset, with 
> just some minor change since I did not see a reason for changing them 
> after studying them. The other patches are those fixes for having a 
> Type2 finally able to create a dax region and map it.

Ok, let's not add dax region's for this case, but the rest sounds
straightforward, I'll take a look.

[..]
> >> The reason for adding such a Type2 driver instead of changes to a current kernel
> >> driver or a new driver is threefold:
> >>
> >> 1) the expected kernel driver to use the functionality added is a netdev one.
> >>     Current internal CXL support is a codesign effort, therefore software and
> >>     hardware evolving in lockstep. Adding changes to a netdev driver requires the
> >>     full functionality and doing things following the netdev standard which is
> >>     not the best option for this development stage.
> > Not sure what "netdev standard" means, and not sure it matters for a discussion
> > that is constrained to how the CXL core should evolve to accommodate
> > accelerator-local memory.
> 
> You know I could not add to a netdev driver just those changes for CXL 
> initialization, then mapping a CXL region and doing nothing else. Such a 
> mapping needs to be linked to something inside the driver what is just 
> under development and testing.

Ok, you're just talking about pre-plumbing the CXL bits before getting
started on the netdev side. Makes sense to me.

> >> 2) Waiting for completing the development will delay the required Type2 support,
> >>     and most of the required changes are unrelated to specific CXL usage by any
> >>     vendor driver.
> > Again, [2] already path cleared the idea that early plumbing of the CXL core for
> > type-2 is in scope. Just need to make sure this effort is focused on general CXL
> > specification use cases.
> >
> >> 3) Type2 support will need some testing infrastructure, unit tests for ensuring
> >>     Type2 devices are working, and module tests for ensuring CXL core changes do
> >>     not affect Type2 support.
> >>
> >> I hope these reasons are convincing enough.
> > I am happy to have general specification discussions about core functionality
> > that all CXL accelerators need and plumbing those ABIs to be exercised via
> > something like cxl_test.
> >
> > I expect that cxl_test only covers coarse grained inter-module ABIs and that the
> > fine details will need to wait until the accelerator specifics are closer to
> > being disclosed and the real driver patches can start flowing. In other words, I
> > am not keen to see QEMU used as a way to proxy features into the kernel without
> > disclosing what the real world consumer actually needs.
> 
> Sure. FWIW, this will end up changing a internal driver mapping HW 
> buffers which are now based on PCI BAR offsets by same mapping based on 
> CXL region mapping.
> 
> This involves, PFs and VFs, and because CXL is only advertised by PF0, 
> this all brings more complexity to those changes than could be expected.
> 
> I think taking the CXL core to the support needed, hopefully based on 
> this RFC, should be started as soon as possible instead of waiting for 
> our driver/device to be ready.

I agree, but continued transparency on what the CXL use case looks like
in the final implementation helps make sure the right upstream CXL
mechanism is being built.

For example, just from that insight above I am wondering if we need some
centralized interface for VFs to lookup / allocate CXL resources from
their PF0.

[..]
> >> Type2 implies, I think, only the related driver to manage the CXL specifics.
> >> This means no user space intervention and therefore no sysfs files. This makes
> >> easy to avoid the current problem of most of the sysfs related code expecting
> >> Type3 devices. If I´m wrong in this regard, such a code will need further
> >> changes.
> > Not sure what you mean here, I am hoping that sysfs ABI for enumerating objects
> > like memdevs, decoders, and regions "just works" and is hidden from the
> > accelerator vendor driver.
> 
> If a Type2 is fully private, should be any sysfs files about it?
> 
> AFAIK, those files are mainly for user space able to create memories 
> joining them, or for changing the dax mode. What do you think a Type2 
> needs through sysfs apart from info? While writing this I realize I have 
> not thought about power management ...

They are primarily for userspace to enumerate resources, and they
provide kernel object names for CXL error events. For example userspace
could generically map a CXL switch error to impacted endpoints without
needing to know or care whether it was a type-2 or type-3 endpoint.

[..]
> > If you think we will still be talking about this driver enabling in September
> > I would invite you to submit this as a topic for the CXL uConf.
> 
> That would be great!
> 
> If this RFC work is integrated by then with the CXL core, that would be 
> fantastic, but the CXL.cache support will still be pending.

Sounds good.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2088.outbound.protection.outlook.com [40.107.237.88])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id F0CAE6AD7
	for <linux-cxl@vger.kernel.org>; Wed, 22 May 2024 16:38:17 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.88
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716395899; cv=fail; b=sZdJxMumObRKTYqNlhmcktlVY5GY+HxfOyrv9pzM1PfidM4aNQWWyEeAavqTDYitSx3ACvbpMv40PLwhg+md+HPfWycILlQXrBpgGPBkcnGVA7u6AikJQS/jjV5F1UNKn7ZgZu6Vw2MAE+9GUC2pShtHj0vwLm5WrJtLSzHxEOM=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716395899; c=relaxed/simple;
	bh=XQtsc4i4w8jLBU5PL1bmSIPktgdlYrmdErFqzlU/YxY=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=ZCFCEnNzfO9R8CEqjHBq5KYzGhk6InUkBuMsvohmKBtjjE+6xZKeyeka2QaiQdOaw9teoVzIB84SqR0oDilGa7Ldfa8WZ+LR6D2IZA+8vhVpdaF/Kfpo+JTWwwMRVNsKwQMpbiiQw4OZVf14iPzBwDxRFdF7qqzy3H+Msukwsxc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=3k9AWqd6; arc=fail smtp.client-ip=40.107.237.88
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="3k9AWqd6"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=M9bYTnFh7NTiDPy9OBpr5SUnY88/j9N2Z5GK5+k566lf1SiZAuSNEZSFUG+tcKOVYIEaJ5dIXqMQ0n8WyhxPLEj4HDqAzGOqpBTmT9Z/Cikm3CYENk/d0uA8AaBWhYhqgAV/jACnqCKWvTrdJ7QvmG/XLjhwbzMumhOE09ShgSmJM5DgaMAyk/WlvY/P6KQ4EAln5YzJpg7P67x16CHZNAh0oNeFKffSSR62hztmkqULWUuYOQ7+U+4lXB5l9BwLwB1E047f2WTh9iUiDb1NGaMiohivVEn/KpRU6R28LNBld6NysNFuJh7ndmAzP1FKY96okexwPJR0zcsT42v1ug==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=nm5OzUhiQiYTJ5hSs3PUBaf1DZOC+R6HQ0/qHdq+7J4=;
 b=d5o8Zo9Oi6REWp0LmKw0b+wIwgV+TrPSLECJYLFiQtmvwH3U7g+1Mmf3TZ5jjE1DEIy/iYY/6VyMQ4dFv/UdaX2iDQ85qj9Gv/1tPVUoAvEw6SqJQzsRtJbRq3UWkIGTy0SOLtESN40vYk9tQlf1RjukWFOg4CQWG4x1UwM8iRiOTMlRIELrRtqRnNJONNtpHspFqXV6NZrfFq07zO7qmw2Hn/Qv2Dh6fXfEGlg+nJuZNbNEbrcIYH/W6rNmYxYGvA7A93pgqddVzSf3kVXNz1l9iJiF7INh75PYEYCKTNGge7tHBVoWq6EA02BRh9tqcXzvALncJlCclkHUEc5lFQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=nm5OzUhiQiYTJ5hSs3PUBaf1DZOC+R6HQ0/qHdq+7J4=;
 b=3k9AWqd6ZTZfzhzKeWKxQu4ryJhaziEVob1xEBlF/tA1k9/AeRWTxSgahgTJIGWquhQm84ygGdoc0LpEYjg5lPwrtbe63D5GZ0Ozhp+gA8ffmPujpHeEyRYC4+SYKRf7BJ5LORCnTeXoXt82myM3O/RgXmltWo1/NV3tEa8bLMI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by MN0PR12MB6128.namprd12.prod.outlook.com (2603:10b6:208:3c4::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.35; Wed, 22 May
 2024 16:38:14 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7587.035; Wed, 22 May 2024
 16:38:14 +0000
Message-ID: <257e2959-5919-a847-d3e7-53f53bc0e131@amd.com>
Date: Wed, 22 May 2024 17:38:09 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 00/13] RFC: add Type2 device support
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
Cc: Alejandro Lucero <alejandro.lucero-palau@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
 <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
 <0a5e5366-92ef-d608-43ab-e0756e0458c8@amd.com>
 <664c296bacb6f_a0282947a@dwillia2-mobl3.amr.corp.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <664c296bacb6f_a0282947a@dwillia2-mobl3.amr.corp.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: DB7PR05CA0006.eurprd05.prod.outlook.com
 (2603:10a6:10:36::19) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|MN0PR12MB6128:EE_
X-MS-Office365-Filtering-Correlation-Id: 8b18bd81-b48c-4cc7-7c05-08dc7a7d9319
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|1800799015|366007|376005;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?RnVMOFY1WmI4MVY5cnhMdDNMUm5iOUwxV2syYmlOb1UycVVJSVExNGU5aElD?=
 =?utf-8?B?aEhQNUdFY0pMdGxNeDJuRjN2TENtQ0JvTXlmNlJJTW5jbllIYjVYWXFibURr?=
 =?utf-8?B?Rzd5Tk5CVHNvQVd0VXpKZTZZYkFRS2RNb2prK1gzK2VTYm9IbWZQemw3bDJq?=
 =?utf-8?B?Z3pnNjlpcS8rdk16dGdjNDY5VUQ1VzBGb1FnZERrcGhTQ1VwTDZDdURaUmcw?=
 =?utf-8?B?L3puR1oyM0luWjN0UXJJK2Rjd2Y3a2g1YVFJbHFLUUdDb1JibC9WZldPc3ZG?=
 =?utf-8?B?Rll0M251QkxJOGplSUZaNUtZZUJoZGtubUduendmVGVHTXl5Y3Z1ODZDZHVx?=
 =?utf-8?B?MnhZYk5RYkhkcmZUKzFLZE1Na1dyR0JhanRxNzBNalkxWVpOS2tENWNrZ1BR?=
 =?utf-8?B?bFIxdm1sbkZleDQ2U0pKV1kxTkhDaTVwRk8weWdHSHlSMG5TSmZ1dFNybDdn?=
 =?utf-8?B?TDdDYXpneEcrZ3A3QjFNMnhpWmpVUFI5cEk3OHZVUUp3R1ZDeFVWU3FBNS9N?=
 =?utf-8?B?U1NvcDNVaXk5cTBXQ2JmMmFBQjJ0WkpGd2k3NnEzR1B6Wnh6a1VJWDlyT0U4?=
 =?utf-8?B?NEpROE12ZXZobFBTK3Irc2YzRFJFbnh5VHhjVlVzYTFKVithMjJXZkdxNjRQ?=
 =?utf-8?B?NEt4VkZlSlpGVkNJT0QyRXJveEpYL2pLVy9xZVVFdm9FYXBHbGlNT0hRaU9B?=
 =?utf-8?B?Qng0YjlmdEJLOE50UjNiZWtDamw3N21VaVozNWthQTRCRzczaW5ZQlJveUsy?=
 =?utf-8?B?QkVLa3dxTTVzTlNXVm82ZmxZdDhKN21RdFVjQ2szV1ZLU1B3d09KU1EwSDhG?=
 =?utf-8?B?aEdzR0hSUzR6TFN6Qy9hMEUxbG1FVjFtYVc2UkJtSmZmZmdKOG5vbXBrZnNV?=
 =?utf-8?B?UXJEWk56Y2VvUStYMVpkLzdtbUxLTnVnRis2VFVwbVRaUzZUU1RSR1Zqd1Nn?=
 =?utf-8?B?VVI5eGF2RWtEVW4wWlQzZ2pGejh1bHZ2dHlvWnMwM0lMSGp1c2xoeHlXVXdR?=
 =?utf-8?B?VUZmY0xtcHgwWWZML1d4SENUV2pUM3VzQnJzNEhSRWt5Wml5bGNUYnFKdGVu?=
 =?utf-8?B?U25uVW9UZGtjak5wb3orbFA5ckg0K2FGdzBWVXV6TVV1VDVYZ3hGd2gvYkZG?=
 =?utf-8?B?c1lYS1Fqanc0RW1GaUlyMVpzMUpBQUQzQ0tLbVVxR1hIWWJsT1ROb3F6K3E4?=
 =?utf-8?B?emJvb0ZKbUUxeEdwSWNoMFZLcE5XaEk3eGRRWGE1Y2NQT0xNVlYxRWhobnF1?=
 =?utf-8?B?Y1RYWStpV0Fhb1p3bDZ3WnYxV2NPa3BDWWRHazJKNTQ2MUdFY0dDODF2VCtG?=
 =?utf-8?B?Vk5UWUx1aVE3OHpPU3lmNXV2ZmxYUktYbE1NS0Jhbkk3ZUlYUmpxWGY5azN0?=
 =?utf-8?B?U2E2azJVQXhvTXhCYnVDRi96VWJmcFZ4Rmx4c09YVHhTbVlRWWZuNmJqWlJu?=
 =?utf-8?B?dmx0b0Z2NWY2S1VyRkR2ZDdtVldMc2VWQ1gwVE5RNkJwT2d5eVJNT2c0SnFk?=
 =?utf-8?B?TlBTYTBha2Y3UHB3MnRwNUM4QkRUYnlpVUhFUU5WZUlSYUl1dlhHZTlXdklU?=
 =?utf-8?B?TlV3a0ZPUUh0REVsQkdoL05nR2RiYkM3SDZzYVdOZUpNb3ZsbGwvdmx5QXpQ?=
 =?utf-8?B?L1RZUmtxYkt1c3Nvc1N3RFc5UEszK001QjgzM3JnN3VPR1d3eU1FdHNrcXY5?=
 =?utf-8?B?OUZ1MEhNQVRZZStRNkpSbml5MS8rd3k0Q1lFbVdPdFhzNFBJTW5pV2ZBPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(1800799015)(366007)(376005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?d1VFVjU3Tnp0QlBXVkQ1OHVjUWcyVE9zOStvZ0FKbHVjVi9EQ0JieURKVFht?=
 =?utf-8?B?by9TUkpMcmxOZHNQN2ZTMTlBNmt6SlJPaFA3NWNnRklYTFArMzYxd2lZQUN4?=
 =?utf-8?B?ZlpqcUlsdGRJZFBlSDN2SjJ4bFRXWGdkaE41NzlJN0NaTERQTHB3WmdnNnda?=
 =?utf-8?B?M0VqZ3IzcTRRcDZFcStKOExHS1hQaEtrUmRnKzl5N08vR3NVQU0yYW5LOHgx?=
 =?utf-8?B?MGlWRWJsQXBNYS8rR0JETlJZVkk1eklLalRldVBnTDZRaVdkZUZvZXl3bVZm?=
 =?utf-8?B?T1VCT3pqWEVTRXRhV3k5bFdTZDZaeGdnK3ZnZkxyTnZsb1orWVh5ZVdISTYr?=
 =?utf-8?B?RjdIRGRQM2tVWUxob1dITGJKQnNYWU0rQVZzOHZyeFJxc3A5SHVVWU9pa0pY?=
 =?utf-8?B?ZjhKUnFObHpWazRCMkZyMVlSNStSVElieUJia0N5VlRJWUdJNVAyc0tFbW9G?=
 =?utf-8?B?R3phSG5SQTAyK2p0OCtqZmtGdDZWVlVMQnZ2a3ltMmcvWUJ3dkRzaVY0V1J3?=
 =?utf-8?B?eXVkc0tUamMyaE5PL0ljam1mWnNEaTZCcGpETGhCaUV6emU1Q3NmaW5QT0Zh?=
 =?utf-8?B?QTdpajNSVFgxa3hDWk52SjdiT2gyUXZON3Y3MHhQMzIrQ2haM0puejRZSEw1?=
 =?utf-8?B?NEhqWmxiN1hlSmNNS2ZlbFpGenpjQlRFaGhURU9sMWtReUxud0pwZEtLUm1H?=
 =?utf-8?B?V0JocWMwNDV5YzZxVDFrU0lQTmJNcDVWSlZVS1FMYW5sTGtaZCtNQ1RUV3Mr?=
 =?utf-8?B?Z0RjcXdWelBZRVZDeTRFK1NUeTJWdWRBb0FlcTMxSlZwcmZWVUg5WkdnM2Na?=
 =?utf-8?B?cGptUzNSWUhHZWpWM1lmT3FISDhrZyszaDN1ZVQ5N3BnR212NElXZkpZV3NT?=
 =?utf-8?B?N3lIWmdwK0dHQ1BoNmp4MXVhUkpPdUs5a1o3MkduWE56elptaVJqQXpFWE9x?=
 =?utf-8?B?TUkzeFNlMUh3TWhPeU0yRlZLZGZpcGdUSFZrbG9Xc2I1NmxBU2hPeEY2azZr?=
 =?utf-8?B?Mmd6VlR5RFltZlZNRG1tWS92Z243UlA4L2F1Q3l3V3lBUE9MQWh3d2tqQWtY?=
 =?utf-8?B?cnVQRDZ1bkFhVkg3Z3pVK1lCZW5NbTdMVFB6SE1ITmh6UzVnWVpWMXlLeFRY?=
 =?utf-8?B?SUR5b2laYkRPZ1J6a3A0RWlCek9hSmE5emkwbC9XanJ3aldkT2xlc1FON2Zs?=
 =?utf-8?B?RU9ObVV4ZW5KTDRyQmJCbkZpcGNidkY3dHRzcGdHNzZHS3hacldzZHBqdnF3?=
 =?utf-8?B?VDI1QjJ5b0dHTWZBWDF6c3JXa1YzRHFqVlJ1TGN1MUlZMEQvVXpBNnBBNk9h?=
 =?utf-8?B?d0lSRjJ0UEhWT0pCUkMzNzhtc1ZqK1BjWmIvYkErYXpPTDhNbEtWYU03VHhJ?=
 =?utf-8?B?cFAzanBzODRSWkp0ZjFGQjNrMFVkdXA2MFZObUl6QVhvS0hMTXV5UWdnTFRY?=
 =?utf-8?B?OFBlRUpiYVBkdHZ1clBYN0RsMGdybXYxKzVoN25DLy9ERHBaNFRCQTFCQjVO?=
 =?utf-8?B?TFJxZnRSUjZjQTFDcXA5NjJVZ3FQK3hnQmgwMVhQZE54eGJpSWduTEpoTVph?=
 =?utf-8?B?ZlhyZlZadmt0K0M0Wll0aWJHVXdkM1FtY3J5ZkVSNWt0SndkdmgveGQxMGlL?=
 =?utf-8?B?dnZZRmRJMndJVDBiTFhXRDdqT3lmcXpsTWd3aVQ3N2VjSXNqU1VVYjZUaVNa?=
 =?utf-8?B?YXZtZEJsb1B2VlB5TkY4N3RGR2JZZDcveFZvUXM2eUZOTlNEWlJzN1NVNmd0?=
 =?utf-8?B?cW9mQnl1OEFxMlBWSmRCMHJpN1IrZ3hYU1RrZnRsZUI1VFptQTFiVUVmcko0?=
 =?utf-8?B?eUQwWnNIK1NJUW1neXBsZDQ1WWVIRlQyZk1IN1dLNlNvV2NabGJKZE9wNmZ6?=
 =?utf-8?B?WlgxdnZrSnFISG5qalFXV3NtV2lIQ05IQm96N1NiYmdPeDZRQ0w3M0ZtMWpo?=
 =?utf-8?B?Q2FTclJOQ3NJWHIrZzllOXlzRGZ5T3JpOTczQW0zbG44emVGQktTSlZKdkVQ?=
 =?utf-8?B?MlBpTEErWTdKMGFKcldLVVJsVUYwMWtjUExPVWpnRzhSR09aYjFxRDY4dS9P?=
 =?utf-8?B?SnF1TEVBTDdtZ2tXTmt1c0ZjQ2pMMkdVUVdWQ1h4ZmZxdDJ3a1lGZy9qQTdC?=
 =?utf-8?Q?UEwfOk63EHZhpwJykVQF29V4n?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8b18bd81-b48c-4cc7-7c05-08dc7a7d9319
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 22 May 2024 16:38:14.0541
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: XpM0Fg5eJHEvO7Nje06LfhEjFF3O04SjlEJjeq4rdspdN8UOfqy1v5syNapRBYLIVb0x+J+UF9bnia/LyoEpJg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN0PR12MB6128


On 5/21/24 05:56, Dan Williams wrote:
> Alejandro Lucero Palau wrote:
>> On 5/17/24 01:08, Dan Williams wrote:
> [..]
>>> My expectation for CXL accelerator provided memory is that it is marked "EFI
>>> Reserved" in the memory map (or CDAT), not "EFI Conventional + Special Purpose
>>> Attribute". Recall that the EFI_MEMORY_SP attribute is just a *hint* that OS may
>>> *not* want to consider a memory range as part of the general purpose memory
>>> pool. CXL Accelerator Memory is far from that definition. If a driver needs to
>>> be loaded to effectively use a memory range that is not a range that can be
>>> transparently converted to "EFI Conventional Memory".
>> Well, that "EFI Reserved" is what we want. However, AFAIK, it is
>> EFI_MEMORY_SP the only one being discussed with our BIOS/UEFI contacts.
> Well, tell your BIOS contacts that they need to honor what the device
> puts in the CDAT for the memory-type, not just make it up on their own.
>
>  From the Linux side we can scream loudly with
> WARN_TAINT_FIRMWARE_WORKAROUND every time we see a BIOS that has failed
> to match EFI memory-type with whatever the device puts in the CDAT,
> because that's clearly a broken BIOS.


Yes, we need to sync with these guys :-)

EFI_MEMORY_SP was our/my only focus and that is probably the problem and 
the confusion.

BTW, How can the kernel warn about this? I guess this requires the 
driver raising it. doesn't it?


>> Because how to assign those flags seems to be based on BIOS
>> implementation, we count on some BIOS versions doing the wrong thing for
>> our purposes, so I have been working on a workaround implying udev
>> events and executing a modified daxctl for switching a dax device mode
>> or even removing/destroying it.
> Yikes, no, lets not do that. Another thing we can do from the kernel
> side, in case the CDAT is missing, is to never attach device-dax to
> address ranges within CXL windows with the "Device Coherent Window
> Restriction".


I do not want to put my reputation on this workaround, but I see it as a 
first and quick fallback and not requiring kernel changes to CXL/DAX. My 
idea is to add some interface between drivers and DAX for doing this if 
necessary, once the driver tries to get the resource and it fails. Maybe 
with some kernel boot param like dax_allow_change=drivername or 
something similar. What else could we do for the case of the BIOS/kernel 
doing the wrong thing?


> [..]
>>> It would help me if you can summarize what you did and did not adopt from that
>>> proposal, i.e. where it helped and where it missed the mark for your use case.
>> I basically took your patchset referenced in the RFC, specifically the
>> 19th one, and tried to work with it from a pcie/CXL device driver. I did
>> debug all the problems precluding the CXL invoked function to succeed
>> and applying those changes from previous patches required and not
>> committed yet. Patches 7, 8, 9 and 11 are based on your patchset, with
>> just some minor change since I did not see a reason for changing them
>> after studying them. The other patches are those fixes for having a
>> Type2 finally able to create a dax region and map it.
> Ok, let's not add dax region's for this case, but the rest sounds
> straightforward, I'll take a look.
>
> [..]
>>>> The reason for adding such a Type2 driver instead of changes to a current kernel
>>>> driver or a new driver is threefold:
>>>>
>>>> 1) the expected kernel driver to use the functionality added is a netdev one.
>>>>      Current internal CXL support is a codesign effort, therefore software and
>>>>      hardware evolving in lockstep. Adding changes to a netdev driver requires the
>>>>      full functionality and doing things following the netdev standard which is
>>>>      not the best option for this development stage.
>>> Not sure what "netdev standard" means, and not sure it matters for a discussion
>>> that is constrained to how the CXL core should evolve to accommodate
>>> accelerator-local memory.
>> You know I could not add to a netdev driver just those changes for CXL
>> initialization, then mapping a CXL region and doing nothing else. Such a
>> mapping needs to be linked to something inside the driver what is just
>> under development and testing.
> Ok, you're just talking about pre-plumbing the CXL bits before getting
> started on the netdev side. Makes sense to me.
>
>>>> 2) Waiting for completing the development will delay the required Type2 support,
>>>>      and most of the required changes are unrelated to specific CXL usage by any
>>>>      vendor driver.
>>> Again, [2] already path cleared the idea that early plumbing of the CXL core for
>>> type-2 is in scope. Just need to make sure this effort is focused on general CXL
>>> specification use cases.
>>>
>>>> 3) Type2 support will need some testing infrastructure, unit tests for ensuring
>>>>      Type2 devices are working, and module tests for ensuring CXL core changes do
>>>>      not affect Type2 support.
>>>>
>>>> I hope these reasons are convincing enough.
>>> I am happy to have general specification discussions about core functionality
>>> that all CXL accelerators need and plumbing those ABIs to be exercised via
>>> something like cxl_test.
>>>
>>> I expect that cxl_test only covers coarse grained inter-module ABIs and that the
>>> fine details will need to wait until the accelerator specifics are closer to
>>> being disclosed and the real driver patches can start flowing. In other words, I
>>> am not keen to see QEMU used as a way to proxy features into the kernel without
>>> disclosing what the real world consumer actually needs.
>> Sure. FWIW, this will end up changing a internal driver mapping HW
>> buffers which are now based on PCI BAR offsets by same mapping based on
>> CXL region mapping.
>>
>> This involves, PFs and VFs, and because CXL is only advertised by PF0,
>> this all brings more complexity to those changes than could be expected.
>>
>> I think taking the CXL core to the support needed, hopefully based on
>> this RFC, should be started as soon as possible instead of waiting for
>> our driver/device to be ready.
> I agree, but continued transparency on what the CXL use case looks like
> in the final implementation helps make sure the right upstream CXL
> mechanism is being built.
>
> For example, just from that insight above I am wondering if we need some
> centralized interface for VFs to lookup / allocate CXL resources from
> their PF0.


Not in our case, but it could be needed (or convenient) for more complex 
devices regarding CXL ranges or decoders.


> [..]
>>>> Type2 implies, I think, only the related driver to manage the CXL specifics.
>>>> This means no user space intervention and therefore no sysfs files. This makes
>>>> easy to avoid the current problem of most of the sysfs related code expecting
>>>> Type3 devices. If IÂ´m wrong in this regard, such a code will need further
>>>> changes.
>>> Not sure what you mean here, I am hoping that sysfs ABI for enumerating objects
>>> like memdevs, decoders, and regions "just works" and is hidden from the
>>> accelerator vendor driver.
>> If a Type2 is fully private, should be any sysfs files about it?
>>
>> AFAIK, those files are mainly for user space able to create memories
>> joining them, or for changing the dax mode. What do you think a Type2
>> needs through sysfs apart from info? While writing this I realize I have
>> not thought about power management ...
> They are primarily for userspace to enumerate resources, and they
> provide kernel object names for CXL error events. For example userspace
> could generically map a CXL switch error to impacted endpoints without
> needing to know or care whether it was a type-2 or type-3 endpoint.


That makes a lot of sense. Then I'm afraid I should work on this. I'll 
try to find out if it could be just modifying current patchset with 
minor changes.

Thanks


> [..]
>>> If you think we will still be talking about this driver enabling in September
>>> I would invite you to submit this as a topic for the CXL uConf.
>> That would be great!
>>
>> If this RFC work is integrated by then with the CXL core, that would be
>> fantastic, but the CXL.cache support will still be pending.
> Sounds good.
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2085.outbound.protection.outlook.com [40.107.244.85])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BB579156652
	for <linux-cxl@vger.kernel.org>; Fri, 31 May 2024 10:52:51 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.85
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1717152773; cv=fail; b=EOYBcDi15PYJ58mSWZh1UYwB1gLSJ702zEcSFoWbEIcad9n1Bx526IMP7v8NrzahPKGlIdWXwBSd9abGrxyvuZRPlA2yEdtKV8bUiZsegExCrFGH+FYrb3lpObUuthpPtWLvhjBnbNNOb4TbrHrcx8BCxXZlSHzFRWtGIQ6aEcw=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1717152773; c=relaxed/simple;
	bh=8y/Chv0GO3NN4NukvLKO+Hnj+bVAqj60u9VTCgMQn3o=;
	h=Message-ID:Date:Subject:From:To:Cc:References:In-Reply-To:
	 Content-Type:MIME-Version; b=k7FxJ4c3E7oepHkOSZdR+X3Fa5gff5fFO/pQi69Rp9zKdOHvwOjOBaSDBT5q9cBNYmUrc1UuaDaZ9/ZIQekA3tXWBUX8WsdIs4Wi33CgyY/mwtzFJqhg0PvPwLI0n/piD3Iza1XdXg2QEs4Z56eHO4zlVTZl38LSXZTAhhJ07Tw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=r5bL2/ku; arc=fail smtp.client-ip=40.107.244.85
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="r5bL2/ku"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=MqUnRbtbudV9hVnvgQm4iIijUHpL2lxuzMCvbgS9poFSjpVOOMbyzuKN/4R3ohHcXhdIu6DUXq+rokpdLu+iIxJiUoJqMzqeQYzU4h0iYK4z1VRzSx7sIuebQdXjfrfgFziFM6lgYnlV1L4e2sKDDtngZNt1BWWAb6WX41GkRUpV4CszxlvMWWSi/FDBJEBAhStA3M7xliFIzHV151jxwdZOX0l6lfxa8KbZwtpF5RxQ5TpftCmwnNHDr8oBKKeZTECfOHO5N3AHz92CVy631OPYMBz2NwBHK24vGh/URF/9bsyAb1DU6uBMmNVtmDvCaMQW6FEab9SFXmGHC1Lm/w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=nTH9cFRsD+55Do+ua/cLz4FLZhC2EF/SmrRjNUGhqoE=;
 b=n6EfQ5GVajQYihIn2/iPYpcNIhi2t2M2jlpvzls2jtfqZG+lKEWoq3uuwpTL16qBMMoGoxrpe0OAe2whEXMrUdpq2cfgNfAOskdpoxtYSqUoLm4tabgG32fbzG/25rTpmCGmIfEu8deFv3r7tQTznDvRfso0lcLOwauADhSRJhNaf949x4pyyE68djWUTavDWoIkeh7PsLS8PZQTyHwjAkdMnhSV7XKOrm+FnH+BzOAlomixnkzHJWi/79fG94E8ui9Ef0QBAFfUcvmNfBP4FhER8Djh2eCI/oZYjKM0cvnJK5wjptqfDnFY+DGr3la/6TfsQaSIiM0CjuhGjYk8ew==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=nTH9cFRsD+55Do+ua/cLz4FLZhC2EF/SmrRjNUGhqoE=;
 b=r5bL2/kue3OPk+ZQzdfLtRHWzoWPuKENEMwD+sXS04GwX9JxDU9Z54dt9HM/S+tswUw88NyIRAHHHjg+JvsDKynKecjIEwhc4EYj60kYcVLHzhtKSAdDdet4v21UMpkqZ4XlrufIn/LQ8KOnIBKY/hBkYTujHLdrXyt7PPOBRek=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by LV3PR12MB9093.namprd12.prod.outlook.com (2603:10b6:408:19d::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.24; Fri, 31 May
 2024 10:52:49 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%3]) with mapi id 15.20.7633.021; Fri, 31 May 2024
 10:52:48 +0000
Message-ID: <c6e88068-1eaa-d3c9-570f-7988b8cb846e@amd.com>
Date: Fri, 31 May 2024 11:52:44 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 00/13] RFC: add Type2 device support
Content-Language: en-US
From: Alejandro Lucero Palau <alucerop@amd.com>
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
Cc: Alejandro Lucero <alejandro.lucero-palau@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
 <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
 <0a5e5366-92ef-d608-43ab-e0756e0458c8@amd.com>
 <664c296bacb6f_a0282947a@dwillia2-mobl3.amr.corp.intel.com.notmuch>
 <257e2959-5919-a847-d3e7-53f53bc0e131@amd.com>
In-Reply-To: <257e2959-5919-a847-d3e7-53f53bc0e131@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P123CA0508.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:272::10) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|LV3PR12MB9093:EE_
X-MS-Office365-Filtering-Correlation-Id: 74a402d6-99c2-4928-3fa7-08dc815fcfab
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|376005|1800799015|366007;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?ODdnUlREQnBUbzFxS1F0a3lRQnhXWkhMemMyb2RuOS9HMUZjd1I0a1FzVEc1?=
 =?utf-8?B?RjJVcDdKQXpnL2ZDdFVRNnBZYUR3ZmJRUjlKL3JKSEppZERET2xNREx1S09I?=
 =?utf-8?B?ZytZc0xMRDZiY1BUZzQ3ZnZ2cHV5RHplOXZVUEFVQWZKWU04NFRodVJkS3Zo?=
 =?utf-8?B?SlNuUmRLSG9kVVp5YW1zMXd0VlNZdFVybkl0TFBIaXkvVjZOYitqMWtzK3RI?=
 =?utf-8?B?eXZYMFN2bEVXRU9SWjRqbG00QkpGNEkrSzNBVkdicU1oSitoYkZPTjRRS2tN?=
 =?utf-8?B?KzMxSlU1UXY2Yjg5YlJncExnT0t6WElZZjh5cVkySStvVy83ZCtZZEYwOEV3?=
 =?utf-8?B?eHozSy9SdjVoRlA3VklHcGprM2s0dXJuSFRhaXUweitMR3Axc2hvUytMYVpU?=
 =?utf-8?B?c0owMjBXWnJ6aWVyb25lK241NDU3NzlORWFqV0dvdmZESlZNTjY5OXNMbjFN?=
 =?utf-8?B?L1lkS09XMHNSMUljbDdYVVArYmlFVFNyQzV4Wm1GT2twcFdSRW1pRlpkWmRG?=
 =?utf-8?B?S3F3UzQyUmVCZS9PcDg1cGdoQ3RpUDVycXBzamdaYU9OeG8xV2JyWXFTb2lD?=
 =?utf-8?B?ZUgySTc4Vk41TmtJbE54dnhaa1VTWDdWR2RwOEhKS2R2VVh1eXVKcmlrdzZT?=
 =?utf-8?B?aWpOa2lxbDJ6Tk9paTg3bnZ0bFAxS05hTDEvOG4rclpwbVhidTdsaDd2UVpk?=
 =?utf-8?B?TTJ2bVQvN3V6U2psQlBycVc5YklGSnlyVko5MURob0tCZUJwRVBXQ2hnYTlo?=
 =?utf-8?B?NFV3VFpFWUpWRWJldHY4eFFXdzF0YkozSUNGZFVTQ3BVaVpZcUxQcGRSNmh4?=
 =?utf-8?B?bTROeVFNQmdHdk1zSVlENTd4UHRMQlI4UCtxRWhRUlczdjc1eGRBc1Fucm95?=
 =?utf-8?B?ZDRiREVyNzE2S3hYZFJ6YktMOUtOSGdIWW9nOWpxeHJVelVLSUF5NTh5Vmtx?=
 =?utf-8?B?djc2QjVDV1MwU2MyckpXU2VmNGJEMTZxSVFPaHFQNWdxN3REeTgxV3RhU2ho?=
 =?utf-8?B?TUpZQlJnb09oYmVGQVNNN0k4UHhVbllNbTlvOTVLa1Y3Sk1FcUF1Q1hERnhE?=
 =?utf-8?B?bE5tVmh2dVBzMzRZd1pqaVBaWGJKd1IxZXFjWC95bmFkUjdsYUpCL1N3dExJ?=
 =?utf-8?B?R1RPL3MzOXk2YUorT3JIV202aVQ0eFNKM2hxV205VTZIZng1VXVZN0ZoM013?=
 =?utf-8?B?dHE3SFQ4eGtGQkNSdnhrN1JlOXpZdHdjZDE2aTg3MkFoSG5rd2poZGQzckJ4?=
 =?utf-8?B?ejhTSjZSVjlkWFhXeXJqMElEMmpEb0ZvWTVYQVYvVXV1d1ZXV1NPRy8xeFZN?=
 =?utf-8?B?SDFWeDJBU3J4SkVJN2g5T3BnbE14WVZuZ1RvekkzVit0emFFWEt4TDg1Qlho?=
 =?utf-8?B?d2JaVUNQOVJwOTZMOFFNNkZZOGFzS0ovbGJ0QUlzSjltRXVoOUVOSXpTRUpY?=
 =?utf-8?B?ZHJLWmtsNUVRMkxydGU1TTdMOE1wdWsvd0ZJTkg1YWlsd3o3dHB0SnAzbUhK?=
 =?utf-8?B?UDhQYzFFNnJMYTlvK1I5T013c1R1bzJqS3BvMUkwM3VFdUpBUjZmUFFHUitr?=
 =?utf-8?B?ajJNTkUyU3pFZUhIcUVweEpjNHV6WVYvekJ4N1pYWUtnaGREcWJWZGlUOWxx?=
 =?utf-8?B?QzBIaHNRcEd3aVg2SlRzWm5UTHNoMXBIMHp5UjB6czZaVjlIdzN0QmNJcGhk?=
 =?utf-8?B?enptVk1aMFJ2RUovaUdydlVaUUZPdG95UjlRZHZEUGVZV1VhcUVGU0ZBPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(376005)(1800799015)(366007);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?K1llWWVldUU5WGowZWJja0NYSSs0N05WSm1WeW1ZcEJhUGRDVEhySml3aVA5?=
 =?utf-8?B?OTUxK0ZtU3lTN0VXNXc1ZzZ1bW9VVzJHekJpOVV6QTI5RU9jbkVVR1hieitG?=
 =?utf-8?B?WWRRNlNCOXVTWno5WFJ0TlhFRllxRHZwakJ6ZWlxVHpXb2dBVWJHcnFDRWdu?=
 =?utf-8?B?RHpLZUcvVG1PcjB6aHQ5MHp3M0s1M2lGU1ZpYURtdkNya1pqTFhXa3VMR3RX?=
 =?utf-8?B?SVd4RzhPZWtWRkJEMjB3NS9wSkZpNTFONjBaeDd4ajAveDZEVEh5dkJFUU1m?=
 =?utf-8?B?VVJQdkJlbjM3YXNWblVxaE0zQTFUWTdKSWxwL3lnNmF0NE96Mk1lWTNhUHNS?=
 =?utf-8?B?ZGl3K3MzVk9qVGpJV1pYbGNBazdLb1FtZU9PY0ZFT1hzMldlTVl5N0xHNGJl?=
 =?utf-8?B?NWFWcUhxVk9tbkdoUXdWckRtWmNnL2NuejNqRzdPcTY1Vkl5TlFyMitnYjZl?=
 =?utf-8?B?ZEtlZTM2QTZleFk5d1AzcllvVTBNeTdmRjZORUtNWGNtaTBxdnBNVWREa1BU?=
 =?utf-8?B?cGNnazJodjdPaXJHTU9KeGdQK0EvYVlGOVN2SVZKUEp4OE5vMkxWRXQ5YWlV?=
 =?utf-8?B?NS9HcWpYc3M5TFUzWlFzVEIwNVVXRWswRnQ0UFlodzNwblhNT0kzc0Jzai9R?=
 =?utf-8?B?d0xFa0I3WTltdnE1ajNVNDIzUXFlU0hJNnhkdDdJVmZiWmZRWUlaTCsrSzVJ?=
 =?utf-8?B?dTc3UG5FZ2cxZWdYenhnbDlhc0prcG9IeUx2TnE0Rjg0OUgyeDkrM25rbm9J?=
 =?utf-8?B?eVBtQWUzQkUrT0g5UkRxcXJYdmFOZWlXQU9yUjlHalFkeHFRNUhKamNBMHJq?=
 =?utf-8?B?RlJvR2tSd3ZOcGd6dGpMSlRnakMvM2JMU1kvZWJSRWNqaXVaSEswcnNSc09N?=
 =?utf-8?B?N1F1MmwxRlJwOTBEbVpGQWtRWUF3cGVxRjhsVGkxQXVvT09ucHhmNjMzRFdx?=
 =?utf-8?B?eHNHbWJxeVFZd1JEVXZHNWF2YUdCNFFuNDFTQ1FtZVdmYjRYdktBNmVNWGcx?=
 =?utf-8?B?SkNxdHJTUmxHTVl0OWlpamdpYi9LeEMvZlZuWUNaMEFwYVFsZ0NPY0NSVTAv?=
 =?utf-8?B?cEhHYUU1eWQ1azJhMkhadlNRdE1QQ0NoUlQzam1BSmFmRFFDcVgzQWVNTFcz?=
 =?utf-8?B?WUs0UU5nTU5GOGpGbXNabzNvOTZLdFpybS9rbjJQN2VydWdJL21oTTlnZnFJ?=
 =?utf-8?B?MEx0dXlvOUhUN1hDZzhabitDNTFuYi9KRGF5ZEtSSlQzMUlybVlhZUZQU0NY?=
 =?utf-8?B?Ui91ajREZWdpcnpDejVlSGV4MGZtQ251a2tQd1ExdnA1cWhBTVJZclViRzND?=
 =?utf-8?B?L1o2U3BlcHdPKzh6V0svbzFVZjdxZHhCKzA4SEdlZ00vZTZST000ZEo0Tlc4?=
 =?utf-8?B?R2E5SjJrQUJScGpQT0lQWmo5dFBpeVJnYmxUVGVYZGtQSlVGN0xnYlducFZ4?=
 =?utf-8?B?bEJBN0F5SXlkQUhyKzRMcnFiNWkra25uN2J1Wkd6SmxySE93T09EQzhySndQ?=
 =?utf-8?B?bXVnSnNkdGpndVNPZUo4Z1NXRjNSNW1MRWZad2VFQXZoOUlNTlNnYjJSYnZJ?=
 =?utf-8?B?K1JYaGpicTlidmk1aEpnNnN1OXBLRlRqY2h3aUFpY3hNYUlIWTB6Tzk0THVz?=
 =?utf-8?B?UzNIejR3d1pxYldBTElmQ2lGVWYreEFQaVBEenNjaUF4RWtQOEVUQVFPMWhB?=
 =?utf-8?B?MWhNUzNGMmVWMzU1T1dJa2JHMnAvUng3NldDOTVGa3JzYXZ0QklPNWx3T3dD?=
 =?utf-8?B?RGJKTVNOcjVwajBzc3ZWelYxT3BiVHlQeXQ1bXdTRkpkTG5acllOd2w5QnlL?=
 =?utf-8?B?QXpVZFpSYTdZUXRBamZnMGlCeFZKQmxLY2UxQkgvbHZBaVoxT2l2WEkyU0w0?=
 =?utf-8?B?Qnkrd1h4WDlFY05yOTJ1M2pxTmRxekU1S25jYzR2bEZDSUV6TUVZZDJXM0tU?=
 =?utf-8?B?MmFZM084Vmhid0lSMGFCNEZWVTVDdGNQSTlGaWdFV3FTbE9FQmdpWVI2Q2VP?=
 =?utf-8?B?TnRERW4zZ29rckNMMDRZS1o1WTFuWTRHcC9HdS9TOHZPN3ByZVpXYk1IUit6?=
 =?utf-8?B?b3dDN0lFcitsNWh0dEk2ZmFtNlh2OXhrSFc2NjdDZWJaNXIwVGtSWHBqVmVq?=
 =?utf-8?Q?Tu7yV5yCk8vPpo+JkqoJ2gMlR?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 74a402d6-99c2-4928-3fa7-08dc815fcfab
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 31 May 2024 10:52:48.8472
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: EuvIZvZUNSKwVxCUWsZWlp5dMYq/+3p7g4B4N6O+OOA6pa6l7KPoKFdWpaHcIQbmJi5reqPCX/7K6pWMsfoTvQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: LV3PR12MB9093

ping

...

and some new comments below.


On 5/22/24 17:38, Alejandro Lucero Palau wrote:
>
> On 5/21/24 05:56, Dan Williams wrote:
>> Alejandro Lucero Palau wrote:
>>> On 5/17/24 01:08, Dan Williams wrote:
>> [..]
>>>> My expectation for CXL accelerator provided memory is that it is 
>>>> marked "EFI
>>>> Reserved" in the memory map (or CDAT), not "EFI Conventional + 
>>>> Special Purpose
>>>> Attribute". Recall that the EFI_MEMORY_SP attribute is just a 
>>>> *hint* that OS may
>>>> *not* want to consider a memory range as part of the general 
>>>> purpose memory
>>>> pool. CXL Accelerator Memory is far from that definition. If a 
>>>> driver needs to
>>>> be loaded to effectively use a memory range that is not a range 
>>>> that can be
>>>> transparently converted to "EFI Conventional Memory".
>>> Well, that "EFI Reserved" is what we want. However, AFAIK, it is
>>> EFI_MEMORY_SP the only one being discussed with our BIOS/UEFI contacts.
>> Well, tell your BIOS contacts that they need to honor what the device
>> puts in the CDAT for the memory-type, not just make it up on their own.
>>
>> Â From the Linux side we can scream loudly with
>> WARN_TAINT_FIRMWARE_WORKAROUND every time we see a BIOS that has failed
>> to match EFI memory-type with whatever the device puts in the CDAT,
>> because that's clearly a broken BIOS.
>
>
> Yes, we need to sync with these guys :-)
>
> EFI_MEMORY_SP was our/my only focus and that is probably the problem 
> and the confusion.
>
> BTW, How can the kernel warn about this? I guess this requires the 
> driver raising it. doesn't it?
>
>
>>> Because how to assign those flags seems to be based on BIOS
>>> implementation, we count on some BIOS versions doing the wrong thing 
>>> for
>>> our purposes, so I have been working on a workaround implying udev
>>> events and executing a modified daxctl for switching a dax device mode
>>> or even removing/destroying it.
>> Yikes, no, lets not do that. Another thing we can do from the kernel
>> side, in case the CDAT is missing, is to never attach device-dax to
>> address ranges within CXL windows with the "Device Coherent Window
>> Restriction".
>
>
> I do not want to put my reputation on this workaround, but I see it as 
> a first and quick fallback and not requiring kernel changes to 
> CXL/DAX. My idea is to add some interface between drivers and DAX for 
> doing this if necessary, once the driver tries to get the resource and 
> it fails. Maybe with some kernel boot param like 
> dax_allow_change=drivername or something similar. What else could we 
> do for the case of the BIOS/kernel doing the wrong thing?
>
>
>> [..]
>>>> It would help me if you can summarize what you did and did not 
>>>> adopt from that
>>>> proposal, i.e. where it helped and where it missed the mark for 
>>>> your use case.
>>> I basically took your patchset referenced in the RFC, specifically the
>>> 19th one, and tried to work with it from a pcie/CXL device driver. I 
>>> did
>>> debug all the problems precluding the CXL invoked function to succeed
>>> and applying those changes from previous patches required and not
>>> committed yet. Patches 7, 8, 9 and 11 are based on your patchset, with
>>> just some minor change since I did not see a reason for changing them
>>> after studying them. The other patches are those fixes for having a
>>> Type2 finally able to create a dax region and map it.
>> Ok, let's not add dax region's for this case, but the rest sounds
>> straightforward, I'll take a look.
>>
>> [..]
>>>>> The reason for adding such a Type2 driver instead of changes to a 
>>>>> current kernel
>>>>> driver or a new driver is threefold:
>>>>>
>>>>> 1) the expected kernel driver to use the functionality added is a 
>>>>> netdev one.
>>>>> Â Â Â Â  Current internal CXL support is a codesign effort, therefore 
>>>>> software and
>>>>> Â Â Â Â  hardware evolving in lockstep. Adding changes to a netdev 
>>>>> driver requires the
>>>>> Â Â Â Â  full functionality and doing things following the netdev 
>>>>> standard which is
>>>>> Â Â Â Â  not the best option for this development stage.
>>>> Not sure what "netdev standard" means, and not sure it matters for 
>>>> a discussion
>>>> that is constrained to how the CXL core should evolve to accommodate
>>>> accelerator-local memory.
>>> You know I could not add to a netdev driver just those changes for CXL
>>> initialization, then mapping a CXL region and doing nothing else. 
>>> Such a
>>> mapping needs to be linked to something inside the driver what is just
>>> under development and testing.
>> Ok, you're just talking about pre-plumbing the CXL bits before getting
>> started on the netdev side. Makes sense to me.
>>
>>>>> 2) Waiting for completing the development will delay the required 
>>>>> Type2 support,
>>>>> Â Â Â Â  and most of the required changes are unrelated to specific 
>>>>> CXL usage by any
>>>>> Â Â Â Â  vendor driver.
>>>> Again, [2] already path cleared the idea that early plumbing of the 
>>>> CXL core for
>>>> type-2 is in scope. Just need to make sure this effort is focused 
>>>> on general CXL
>>>> specification use cases.
>>>>
>>>>> 3) Type2 support will need some testing infrastructure, unit tests 
>>>>> for ensuring
>>>>> Â Â Â Â  Type2 devices are working, and module tests for ensuring CXL 
>>>>> core changes do
>>>>> Â Â Â Â  not affect Type2 support.
>>>>>
>>>>> I hope these reasons are convincing enough.
>>>> I am happy to have general specification discussions about core 
>>>> functionality
>>>> that all CXL accelerators need and plumbing those ABIs to be 
>>>> exercised via
>>>> something like cxl_test.
>>>>
>>>> I expect that cxl_test only covers coarse grained inter-module ABIs 
>>>> and that the
>>>> fine details will need to wait until the accelerator specifics are 
>>>> closer to
>>>> being disclosed and the real driver patches can start flowing. In 
>>>> other words, I
>>>> am not keen to see QEMU used as a way to proxy features into the 
>>>> kernel without
>>>> disclosing what the real world consumer actually needs.
>>> Sure. FWIW, this will end up changing a internal driver mapping HW
>>> buffers which are now based on PCI BAR offsets by same mapping based on
>>> CXL region mapping.
>>>
>>> This involves, PFs and VFs, and because CXL is only advertised by PF0,
>>> this all brings more complexity to those changes than could be 
>>> expected.
>>>
>>> I think taking the CXL core to the support needed, hopefully based on
>>> this RFC, should be started as soon as possible instead of waiting for
>>> our driver/device to be ready.
>> I agree, but continued transparency on what the CXL use case looks like
>> in the final implementation helps make sure the right upstream CXL
>> mechanism is being built.
>>
>> For example, just from that insight above I am wondering if we need some
>> centralized interface for VFs to lookup / allocate CXL resources from
>> their PF0.
>
>
> Not in our case, but it could be needed (or convenient) for more 
> complex devices regarding CXL ranges or decoders.
>
>
>> [..]
>>>>> Type2 implies, I think, only the related driver to manage the CXL 
>>>>> specifics.
>>>>> This means no user space intervention and therefore no sysfs 
>>>>> files. This makes
>>>>> easy to avoid the current problem of most of the sysfs related 
>>>>> code expecting
>>>>> Type3 devices. If IÂ´m wrong in this regard, such a code will need 
>>>>> further
>>>>> changes.
>>>> Not sure what you mean here, I am hoping that sysfs ABI for 
>>>> enumerating objects
>>>> like memdevs, decoders, and regions "just works" and is hidden from 
>>>> the
>>>> accelerator vendor driver.
>>> If a Type2 is fully private, should be any sysfs files about it?
>>>
>>> AFAIK, those files are mainly for user space able to create memories
>>> joining them, or for changing the dax mode. What do you think a Type2
>>> needs through sysfs apart from info? While writing this I realize I 
>>> have
>>> not thought about power management ...
>> They are primarily for userspace to enumerate resources, and they
>> provide kernel object names for CXL error events. For example userspace
>> could generically map a CXL switch error to impacted endpoints without
>> needing to know or care whether it was a type-2 or type-3 endpoint.
>
>
> That makes a lot of sense. Then I'm afraid I should work on this. I'll 
> try to find out if it could be just modifying current patchset with 
> minor changes.
>
> Thanks
>
>

I've been looking at this, mainly alarmed by the error handling problem 
mentioned.

Firstly, my original comment in the cover letter is misleading. The 
patchset does not avoid kobjects to be created just some sysfs files 
related to kobjects attributes.

I think it is the right thing to do, although some of those attributes 
could in fact be shown, so I will fix that. However, I think some fields 
now in cxl_memdev_state should be inside clx_memdev, like 
ram_perf/pmem_perf, but moreover, I think we need a more flexible way of 
linking Type2 to those structs where the optional Type2 functionalities 
can be set or not. Not something to be faced in this patchset but by for 
some refactoring in the near future if my concern turns out to be a real 
one.


Secondly, there is another concern, maybe a more important one, and it 
is related to the error handling. I have to admit I did not think about 
this at all before Dan's comment, and I think it is something worth to 
discuss.

There are, at least, two error situations I'm concern with, although 
they (can) end up with the same action: a pcie/CXL slot reset. Assuming 
there could be cases where the system can recover from this situation, 
and noting that CXL.mem or CXL.cache could stall cpus and likely 
crashing the system, the concern is how the CXL device configuration 
like HDM should be done after the slot reset. While a FLR keeps that 
config, a slot reset does not. The current Type3 support inside the CXL 
pci driver does nothing when the device is detached (no release 
callback), what is happening when the system performs the slot reset, 
and cxl_error_resume is not trying anything. If I'm not wrong, it is in 
the resume callback where the device is probed again.

So here is my question: should not an endpoint slot reset be supported?


>> [..]
>>>> If you think we will still be talking about this driver enabling in 
>>>> September
>>>> I would invite you to submit this as a topic for the CXL uConf.
>>> That would be great!
>>>
>>> If this RFC work is integrated by then with the CXL core, that would be
>>> fantastic, but the CXL.cache support will still be pending.
>> Sounds good.
>>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.13])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AF5F1384
	for <linux-cxl@vger.kernel.org>; Fri, 17 May 2024 00:08:24 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=198.175.65.13
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715904507; cv=fail; b=FuuT7HaGlI+/D6ScouWvXt/o524mQOPNY2tM8mjde8IcaZMuLpzkvxunK2pddf1oogZpLZm/aKGKZFOUK7R0Vlcg+lffz39MipaJAXPkh8DyAuNz5AfcJYihzccjgfq36QwVdBz5edbSYmQvp1DGVQBFoqZTT3JVKCBCt4n0GU8=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715904507; c=relaxed/simple;
	bh=JOwDmcbKwfFWMPt/6H1OJFhCyKcseAbjPr/ZodNIbW4=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=ouXrN48qWrrimI9OtooIFJ5TinvR9YR+/uDSESqyycIiA96pPxpM+mA1tuUqTde7YWzBw4yK9PIqqUBB79r8bvjgVH3ZhFufGqMDAdqFbnkkVhYIHXCzkY1p+MJfeDSzpxGY/ii2BLXIQv/TlZFE9OPnG0oYXuCQI14WF1WG/ns=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=GybaRtw5; arc=fail smtp.client-ip=198.175.65.13
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="GybaRtw5"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1715904504; x=1747440504;
  h=date:from:to:cc:subject:message-id:references:
   content-transfer-encoding:in-reply-to:mime-version;
  bh=JOwDmcbKwfFWMPt/6H1OJFhCyKcseAbjPr/ZodNIbW4=;
  b=GybaRtw5PZc9UYHQh1sC5U2/gn1rGE6GA72p5J3AedWXClEKkXgqOnwf
   AI+hiPVRO4axQgvQpcz0JH2tL0R9qXq6/gFrG1S/3NZVXPBO1r8CMLSwR
   LGJlIgE7xOcGjbGTxVvWXvYQC7laGHyrdEiE4RHePhS8m99qhFq1JTE3Q
   DB7GHzmEhZ/OrSKhu2m6/WyuynTBcHwa+TPBiGwMVRNdSRQY5zBcOQBA+
   D7nAtoR7S9V/Ftu5c+fmntgzm+tHIZotR/ji3feZH+Qu+NQakF6qCepto
   LKRZQMIpkAPrCnCFhu6W1STI8ZyFOKriM8KjdPLmHMGEvFuHD9w/2sk4T
   A==;
X-CSE-ConnectionGUID: Wu//SkuYSnOUBNsEv37S4w==
X-CSE-MsgGUID: AW1360T+TwmwbvmHR3B9iw==
X-IronPort-AV: E=McAfee;i="6600,9927,11074"; a="23196379"
X-IronPort-AV: E=Sophos;i="6.08,166,1712646000"; 
   d="scan'208";a="23196379"
Received: from fmviesa008.fm.intel.com ([10.60.135.148])
  by orvoesa105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 16 May 2024 17:08:24 -0700
X-CSE-ConnectionGUID: KcuRStixTwSoDg6m8T017g==
X-CSE-MsgGUID: gZaE/zoWTCS7FZzdcbYpzQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,166,1712646000"; 
   d="scan'208";a="31602303"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmviesa008.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 16 May 2024 17:08:23 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35; Thu, 16 May 2024 17:08:23 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35; Thu, 16 May 2024 17:08:22 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Thu, 16 May 2024 17:08:22 -0700
Received: from NAM04-DM6-obe.outbound.protection.outlook.com (104.47.73.41) by
 edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.35; Thu, 16 May 2024 17:08:22 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=XyVuiFm/Szj5FSBf/P+E/GmYX6Rf4k6yPPZ7LHVUxOfSCPzJKYGqz2ce7bEqEnKJIMQnPukFZlbPmdFVjM/PKjXgwcIPpxMEw3P44EM5TinaLeO9KOQu4EIr36n68SQRaXXSIrTBGWnrq/T/PZ7pmTWObBa1LB5kYiGG5PNpSIpVrU3zJPNUHId0J4uFjFentyW1VqCeeqSaz1xVXIgRHuawze5A/VRVaE6O+yf2vPSsxCvgBCx7alX/LQC/jArgcg7LE6gMY0tntIRJlz+NaOQ/EyvnhOt7sSDHhsmrT3mwbb4LVuo5zz5adOg/RNaOYDIKb7Ytkwgtl8eQ2Y417w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=be2M8K5P4Df/GOBx8bDiggtSuR+Ne21+qpHUMEwK+5w=;
 b=ZBiZit0oI2E4SVeTwFnPIoVgfFAqGqdCfJWIncHqU7hc503CFty76nhjf/wbv8um6kPxg9Mi6GviC5gnsUtyF14LjDvxQi1V2VZg/q3JqjcU2qk6CDwPOu/F5GJOeTFWcj1Q9uos0FNFIA2WW/xdgJst1FcYo/2UMZ6NLdDC9ebsij/6v9vES+3l+IWxI6ayBpfe1IpJAVfT58Zd4QXXPHgx1azTKTg9F5k0xz02DxgqFxtJXCAUItUhXd2xcrib3362NW+qt0WYLNceN3SAjibiEbhZXV1ZDjIgS3p6dkyK2r5ES4dF/WzxqE6pKdGgHeTC3DEppRxw20ufsdfWNQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by SN7PR11MB7639.namprd11.prod.outlook.com (2603:10b6:806:32a::14) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Fri, 17 May
 2024 00:08:20 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7587.028; Fri, 17 May 2024
 00:08:20 +0000
Date: Thu, 16 May 2024 17:08:17 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<dan.j.williams@intel.com>, <pieter.jansen-van-vuuren@amd.com>,
	<richard.hughes@amd.com>, <dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alejandro.lucero-palau@amd.com>
Subject: RE: [RFC PATCH 00/13] RFC: add Type2 device support
Message-ID: <66469ff1b8fbc_2c2629427@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
Content-Type: text/plain; charset="iso-8859-1"
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
X-ClientProxiedBy: MW4PR04CA0364.namprd04.prod.outlook.com
 (2603:10b6:303:81::9) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|SN7PR11MB7639:EE_
X-MS-Office365-Filtering-Correlation-Id: 09c70567-b0da-421c-c666-08dc760575aa
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|366007|1800799015|376005;
X-Microsoft-Antispam-Message-Info: =?iso-8859-1?Q?xbQkiReNjEThyq1qIl1VaX+U1udtFdGfma70WXl6+vw42X0oxXw1dLEgvP?=
 =?iso-8859-1?Q?/gg+VvfTyR5t8FOzCzGP3XWW7l8K1iCbIg/TUc9qtYP/CqQXYpzX10/FEa?=
 =?iso-8859-1?Q?hcjgANnWex/v6KSgi2va0KbxaPcm/+iUv+ctiQzpgpiX/TdnmwtE6+2NsJ?=
 =?iso-8859-1?Q?7EGCff9bozt0wHMDt0wI58FAaDeK0o+A3R8/Yaf5/ALzDRHm24AAvDqTTg?=
 =?iso-8859-1?Q?D9OMEZqQQOBXtMtTKLcrxZC/67iSg/6X4wuZiYkB6yUPPIAc+0zw28LO3+?=
 =?iso-8859-1?Q?enx+bbVUb33ji3PL2tw0fFV2bJClb628uumT5+pnKz5MAQBVI+eKoFH4u0?=
 =?iso-8859-1?Q?3MDjIiKnFJ6KYNTiH5WMS0LnP8NG++wxXO9UlDcdiehemlBJ6Ya4sF+ymL?=
 =?iso-8859-1?Q?VYHtVI8ZWOf/An4hJ0iVPMZZ/tAFIIDvLolKVMoZ3wHKVv0NaqPUqY86yn?=
 =?iso-8859-1?Q?yZ3Mma7c0dDOb7TUQ6/aL7FIePSIOACkSb4NmpxVvUr9/Qi1UyYFk8CWJu?=
 =?iso-8859-1?Q?OjE3MoC8u0BHH7lWJSz+K6me52g8CdHdnI27fVl0KSfIoKuU+dPs0w4pRJ?=
 =?iso-8859-1?Q?UD3xjaz3snDms057AcJ9I/muy2oKG8/ESdRwz+m8DDbb4iutWq6S5IdqLp?=
 =?iso-8859-1?Q?wUltLDQBL89Av9zbnx8tReXHsli4jbQKBN98DCEtAjBiKwOAoo6CARW8XS?=
 =?iso-8859-1?Q?tgbvzhhrzFEAQqQbKxUIDMCg1iAsnpLHm97MfotTeUbh2AW7yA4kjaJ8Gw?=
 =?iso-8859-1?Q?qob3sUxZrTnu4381sJWQK2Xy7y3pZ0LMHpafM3DBNEirGiS/6KunOVRO+Y?=
 =?iso-8859-1?Q?KbDStD/2+os4hMTA6G1DS0EhPklUCzhlAReTsYV9jkU4iXf2EYQ4CDKHwd?=
 =?iso-8859-1?Q?cQTBEuKLNGjHPZtNZ44+OzVg7ccY2KdBJlPQVrCFC5dZZIhyObPWDrYPAy?=
 =?iso-8859-1?Q?PF1P3UxdsTIp5hEhFaDk9qiKzsJbIwZSUCTODIfmxaMtMNm5cCsx9CD7aE?=
 =?iso-8859-1?Q?d/HTG4tqAFhBb6AA1NyO/YiGk00iiP2bUbOJGp0INYYv40l/DWKR7HlOGJ?=
 =?iso-8859-1?Q?/eI3SqSW7sZu8DAB1zGmTT9ADx0lr/n7gd3Mhvzb38RrLLvR9wdE2739Qf?=
 =?iso-8859-1?Q?/jbgnYRShE/x9oz/BOqaWhSvuSfrbvemVVZqis30d91j0HSbw+npikQ4d0?=
 =?iso-8859-1?Q?vuxS9Iaz+P7Y9c1yadsbvMqeADxPBerHABOK8T4Zjg4JlhiqknmtgRmfBC?=
 =?iso-8859-1?Q?Uam3LDMasYy+Jd0g9mLLP9F7GjW9zStJ/1F8bvRvQ=3D?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(366007)(1800799015)(376005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?iso-8859-1?Q?fFtrpTtBa1rq4gakMz2HZ5z7Dx51kIVwfEGcEq9b10ODwlnGqVfDxOgjXz?=
 =?iso-8859-1?Q?KDkgut5Nrqd5PKIA/D/2vg6KdlQLAJNAFjK6Qtlzjwx/6VQ6Ck60qAeDXY?=
 =?iso-8859-1?Q?/dyZGMpgrlPmAcMNpr8t4nkWT7XKxpEIDDsli44hKZbdj7DDVb6FimvTJD?=
 =?iso-8859-1?Q?8PfI61tb2qZgi2oK9G6baQWTZ2ZeYu1mLLTSfDU9miZbJfD2Vtf3NaRXwS?=
 =?iso-8859-1?Q?g+xPd7uT8Aht5huF2RMbJeuPvOfQ4zPuJlvzch5TGTxg+/bupqwedhfJ0L?=
 =?iso-8859-1?Q?/vIk/+5mvXUhGBXkgIodQZ3YwV+QwdKyPGFu4Bnl3liXmOZGAMEWqnm09A?=
 =?iso-8859-1?Q?oZIIBaQxU2r2NKrJmZ5oZKLXZLX6jTOigyz6vpXNiKHPa3yxw1j8VdjNxM?=
 =?iso-8859-1?Q?s4I1odOOswUryMUNxQuYOrUgugxFeBMj67+Jwuo8nxuudvAd9WtLJCxpE2?=
 =?iso-8859-1?Q?AgkRW2ez8co4pnpeyokvgc9BUHQSXb0T3eBK5U4z001aE3XpHZmtJRLko6?=
 =?iso-8859-1?Q?Ae/DEi9j/V22SxjMPofBf/7fq1JC/2DjuhF6mCFjyoSFaOmf/gWyYXRAxE?=
 =?iso-8859-1?Q?I6GmF0vbzGSqai2ozavbSiYm+EINg1HrQarwjk8kLYCLzTJd3uS6OmdVSX?=
 =?iso-8859-1?Q?b6BqfjVBqi/yDBBv8JwTrUeV118evi303hGff4+VOorVByg2WRTFCsRT0m?=
 =?iso-8859-1?Q?jLaIaJZ6Fy2pBk6vYmDmgfOyWNMDy5g84WQ0sekzJxIdIrGFX1JOYtF+iB?=
 =?iso-8859-1?Q?+b3Nbsp92Sd5gGGwl+Eq1AEqtFOp22OGdkTdgu+FR00GwuvFCOGaSZG3kg?=
 =?iso-8859-1?Q?At1uWon4Bmm5PYEu/vVBuEL/I0t/X0Opp85V+fK6L5m1Q3GjooS2IG2gBb?=
 =?iso-8859-1?Q?P1PW6Hy0SLxunhnUnXPpbi3EVQkUT+M9905MEebJGncHOxlxAF8GzOujiC?=
 =?iso-8859-1?Q?m5ikLOKlVieeDQWqHutvWyLsfvW/JS/TFwR+2HPmJWdDP4GvndDcVv1kaN?=
 =?iso-8859-1?Q?hKjljCcG2xyi7173gzTYDoHiyBlyLcSc/4ysio6SVYOVh8zfBis10TMPxj?=
 =?iso-8859-1?Q?wjD+Own6w6wEIz1thcpYssQwj2DCKZ4qVsK2i2v46SKlTOt+wlgE3E5HzH?=
 =?iso-8859-1?Q?IR5qRFA2zVzr405siFiNmvsbVffi3BCGEChsYXgCklNt/YKx/NO5aUIqyl?=
 =?iso-8859-1?Q?H71R4CPyKTQbHDyruBNwb9W5ubouOb6o5Xbg9eNDdS3T1Yp13ROt19rREs?=
 =?iso-8859-1?Q?1cIk2MXdki6n/PzlH4U7torlbUXcaRux92Mqdk9lHDmKaLZ4beyKQHHDrD?=
 =?iso-8859-1?Q?cNq0og78R2cZJBAhBwvuvC7M7lvrLzgEfkArHXEzXqJ5rODhB5B7xQDryw?=
 =?iso-8859-1?Q?0+10QhbGNQlc7eS+WN88bXbLJiYbK32Ig0IsaxDnuC5BVd50sQAlpGs5zF?=
 =?iso-8859-1?Q?O3W6abfVInwKxbOoCpE5cM6QcwWC0AjPYHDbJuX143kwNelv0EQAQOuE7w?=
 =?iso-8859-1?Q?1b4Ie6XVP1K1zqzV49YWXduyBuPXzJvCLTYvGMUYWrl9quQKeJ0DsSCfkJ?=
 =?iso-8859-1?Q?DhjjvZO+Osydd0Ly5QS6LMkgaut/2otbY7D72ZtUEnY83a2Lygs59XJlWJ?=
 =?iso-8859-1?Q?4o8MX68eH0CzjyA6Ae+Ko/2DkQ4e62rXwH/jz01wtUuBNCj5w9VRzAfQ?=
 =?iso-8859-1?Q?=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 09c70567-b0da-421c-c666-08dc760575aa
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 May 2024 00:08:20.2045
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 6zz6FiKruLP7wvO9K9hGOiqIX2+U1G5vSd8sljpwCewJk2k1vCG8iA1YdEQ/rIqdoK1lLneKaiJYtAxiQW9f6vgRtt7xeFI12WFBC0vtFLw=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR11MB7639
X-OriginatorOrg: intel.com

alucerop@ wrote:
> From: Alejandro Lucero <alejandro.lucero-palau@amd.com>
> 
> I need to start this RFC explaining not what the patchset does, but what we
> expected to obtain and currently is under doubt: to configure a CXL memory
> range advertised by our CXL network device and to use it "privately".
> 
> The main reason behind that privacy, but not the only one, is to avoid any
> arbitrary use by any user-space "client" with enough privileges for using a
> public interface to map the device memory and use it as regular memory. The
> reason is obvious: the device expects writes to such a memory in a specific
> format.
> 
> The doubt comes from the fact that after implementing the functionality exposed
> in this patchset, we realized the current expectation seems to be a BIOS/UEFI
> configuring HDM decoders or HPA ranges and passing memory ranges to the kernel,
> and with the kernel having a default action on that memory range based on the
> flag EFI_MEMORY_SP being set or not.

Lets clear up this confusion first.

My expectation for CXL accelerator provided memory is that it is marked "EFI
Reserved" in the memory map (or CDAT), not "EFI Conventional + Special Purpose
Attribute". Recall that the EFI_MEMORY_SP attribute is just a *hint* that OS may
*not* want to consider a memory range as part of the general purpose memory
pool. CXL Accelerator Memory is far from that definition. If a driver needs to
be loaded to effectively use a memory range that is not a range that can be
transparently converted to "EFI Conventional Memory".

> If it is not set, the memory range will be part of the kernel memory
> management, what we do not want for sure. If the flag is set, a DAX device
> will be created which allows an user-space client to map such a memory through
> the DAX device API, what we also prefer to avoid. I know this is likely going
> to face opposition, but we see this RFC as the opportunity for discussing the
> matter and, if it turns out to be the case, to be guided towards the proper
> solution accepted by the maintainers/community. This patchset does not tackle
> this default kernel behaviour although we already have some ideas and
> workarounds for the short term. We'll be happy to discuss this openly.

It may have been subtle, but even in my initial RFC [1]. I was explicitly
skipping exposing accelerator memory via device-dax:

@@ -3085,6 +3183,15 @@ static int cxl_region_probe(struct device *dev)
 					p->res->start, p->res->end, cxlr,
 					is_system_ram) > 0)
 			return 0;
+
+		/*
+		 * HDM-D[B] (device-memory) regions have accelerator
+		 * specific usage, skip device-dax registration.
+		 */
+		if (cxlr->type == CXL_DECODER_DEVMEM)
+			return 0;
+
+		/* HDM-H routes to device-dax */
 		return devm_cxl_add_dax_region(cxlr);
 	default:
 		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",

[1] https://lore.kernel.org/r/168592159835.1948938.1647215579839222774.stgit@dwillia2-xfh.jf.intel.com

> So, this patchset assumes a BIOS/UEFI not programming the HDM decoder or HPA
> ranges for a CXL Type2 device.

At least for Linux it should not care whether BIOS maps it or not. The
expectation is that whichever agent maps it, BIOS or Linux CXL core, that agent
honors the memory type specified in the device CDAT. I.e. the "Device Scoped EFI
Memory Type Structure (DSEMTS)" in the accelerator CDAT should pass "2" in the
"EFI Memory Type and Attribute" field, where "2" indicates "EFI Reserved" memory
type for any HPA that maps this device's DPA.

> above, a Type2 device added after boot, that is hotplugged, will likely need the
> changes added here. Exporting some of the CXL core for vendor drivers is also
> required for avoiding code duplication when reading DVSEC or decoder registers.
> Finally if there is no such HPA range assigned, whatever the reason, this patchset
> offers some way of obtaining one and/or finding out what is the problem behind the
> lack of such HPA range.

Yes, that was the whole point of the "Device Memory Setup" thread [2] to show a
plausible way to reuse the common core infrastructure for accelerators with
CXL.mem capability.

[2] https://lore.kernel.org/all/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/

It would help me if you can summarize what you did and did not adopt from that
proposal, i.e. where it helped and where it missed the mark for your use case.

[..]
> Keeping with kernel rules of having a client using any new functionality added,
> a CXL type2 driver is increasingly added. This is not a driver supporting a real
> device but an emulated one in QEMU, with the QEMU patch following this patchset.

Lets start with the deltas compared to [2], the observation there is that much
of the CXL core is reusable for this type-2 use case, and even improves the
organization of the core. The consumer of the refactoring just ends up being a
few new helpers around the core.

> The reason for adding such a Type2 driver instead of changes to a current kernel
> driver or a new driver is threefold:
> 
> 1) the expected kernel driver to use the functionality added is a netdev one.
>    Current internal CXL support is a codesign effort, therefore software and
>    hardware evolving in lockstep. Adding changes to a netdev driver requires the
>    full functionality and doing things following the netdev standard which is
>    not the best option for this development stage.

Not sure what "netdev standard" means, and not sure it matters for a discussion
that is constrained to how the CXL core should evolve to accommodate
accelerator-local memory.

> 2) Waiting for completing the development will delay the required Type2 support,
>    and most of the required changes are unrelated to specific CXL usage by any
>    vendor driver.

Again, [2] already path cleared the idea that early plumbing of the CXL core for
type-2 is in scope. Just need to make sure this effort is focused on general CXL
specification use cases.

> 
> 3) Type2 support will need some testing infrastructure, unit tests for ensuring
>    Type2 devices are working, and module tests for ensuring CXL core changes do
>    not affect Type2 support.
> 
> I hope these reasons are convincing enough.

I am happy to have general specification discussions about core functionality
that all CXL accelerators need and plumbing those ABIs to be exercised via
something like cxl_test.

I expect that cxl_test only covers coarse grained inter-module ABIs and that the
fine details will need to wait until the accelerator specifics are closer to
being disclosed and the real driver patches can start flowing. In other words, I
am not keen to see QEMU used as a way to proxy features into the kernel without
disclosing what the real world consumer actually needs.

Now, that said, there may also be opportunity for targeted extensions of the
QEMU CXL memory-expander device, like DPA capacity that is mapped as "EFI
Reserved" device-memory, but lets talk about the specifics here.

Also recall that the current CXL driver does not yet support parsing CXL PMEM
region labels. Support for that ends up looking quite similar to an accelerator
asking for a specific DPA range to be dynamically mapped by the CXL core. So I
think we can get quite far along the path to enabling type-2-CXL.mem just by
flushing out some of the generic type-3-CXL.mem use cases.

> I have decided to follow a gradual approach for adding such a driver using the
> exported CXL functions and structs. I think it is easier to review the driver
> when the new funcionality is added than to add the driver at the end, but not a
> big deal if my approach is not liked.
> 
> The patches are based on a patchset sent by Dan Williams [1] which was just
> partially integrated, most related to making things ready for Type2 but none
> related to specific Type2 support. Those patches based on Dan´s work have Dan´s
> signing, so Dan, tell me if you do not want me to add you.

It is fine to reuse those patches, but please do include:

Co-developed-by: Dan Williams <dan.j.williams@intel.com>
Link: <lore-link for copied code>

...so I can try to remember if I still think the source patch was a good idea or
not. Again, a summary analysis of what did and did not work for you from that
posting would help me get a running start at reviewing this.

> Type2 implies, I think, only the related driver to manage the CXL specifics.
> This means no user space intervention and therefore no sysfs files. This makes
> easy to avoid the current problem of most of the sysfs related code expecting
> Type3 devices. If I´m wrong in this regard, such a code will need further
> changes.

Not sure what you mean here, I am hoping that sysfs ABI for enumerating objects
like memdevs, decoders, and regions "just works" and is hidden from the
accelerator vendor driver.

> A final note about CXL.cache is needed. This patchset does not cover it at all,
> although the emulated Type2 device advertises it. From the kernel point of view
> supporting CXL.cache will imply to be sure the CXL path supports what the Type2
> device needs. A device accelerator will likely be connected to a Root Switch,
> but other configurations can not be discarded. Therefore the kernel will need to
> check not just HPA, DPA, interleave and granularity, but also the available
> CXL.cache support and resources in each switch in the CXL path to the Type2
> device. I expect to contribute to this support in the following months, and
> it would be good to discuss about it when possible.

Yup, especially CXL 3.x Cache ID management. Lets talk about some ways to plumb
that, because it is also a general CXL specification capability. Another topic
is what is needed for CXL Protocol and Component error handling, I expect some
of that to be CXL core common and some of that to be accelertor driver
augmented.

If you think we will still be talking about this driver enabling in September
I would invite you to submit this as a topic for the CXL uConf.

https://lpc.events/event/18/contributions/1673/

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A2168384
	for <linux-cxl@vger.kernel.org>; Fri, 17 May 2024 14:30:51 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715956254; cv=none; b=aEARAoVfETezlAO48aaDh4IOj7Z3kUiJUe0aW3yxmHdiCc+go2g6hWVKlOSDVYtKBFbafAx2et016bSjLquLYPmDCv5V+3d/thHi8pGb4g8H4mWZ+UdXk3HIvphvdTAxhNnFMcr4RPtDuOPddv79f7T/H7t81iIDZg7AlcAgU44=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715956254; c=relaxed/simple;
	bh=QmtLAArR+9c2WbLrwXzaDzjGmXV4b0iLm51ViuR1u60=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=GlBvPiQuc8ZAlNkuOc6OsxIW4W1fnnoH8Jpc3EkwHcx2Va5+fJPX9WqtK75hplY3GRoOA5nDcTcMXkZuIM8qWvMcCsYZ1VGmcC7v0Z9H9vnIOYYr+z+qmQYvkzs5GElvLFX9i5I3ssE+sqfeFjTRuN93JtVTJmglw86d4drKRSc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Vgq9p4gv5z6D8XR;
	Fri, 17 May 2024 22:30:06 +0800 (CST)
Received: from lhrpeml500005.china.huawei.com (unknown [7.191.163.240])
	by mail.maildlp.com (Postfix) with ESMTPS id 46C4E140D1A;
	Fri, 17 May 2024 22:30:49 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Fri, 17 May
 2024 15:30:48 +0100
Date: Fri, 17 May 2024 15:30:48 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: <alucerop@amd.com>
CC: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Message-ID: <20240517153048.0000480f@Huawei.com>
In-Reply-To: <20240516081202.27023-3-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
	<20240516081202.27023-3-alucerop@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)

On Thu, 16 May 2024 09:11:51 +0100
<alucerop@amd.com> wrote:

> From: Alejandro Lucero <alucerop@amd.com>
> 
> Differientiating Type3, aka memory expanders, from Type2, aka device
> accelerators, with a new function for initializing cxl_dev_state.
> 
> Adding a type2 driver for a CXL emulated device inside CXL kernel
> testing infrastructure as a client for the functionality added.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

If you are going to keep Dan's sign-off it needs to be clear why.
Either put the author to Dan and swap these two, or use a
Co-developed tag.

A few drive my trivial comments.

> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> new file mode 100644
> index 000000000000..863ce7dc28ef
> --- /dev/null
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -0,0 +1,80 @@
> +#include <linux/module.h>
> +#include <linux/pci.h>
> +#include <linux/cxl.h>
> +#include <linux/cxlpci.h>
> +#include <linux/cxlmem.h>
> +
> +struct cxl_dev_state *cxlds;
> +
> +#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
> +
> +static int type2_pci_probe(struct pci_dev *pci_dev,
> +			   const struct pci_device_id *entry)
> +
> +{
> +	u16 dvsec;
> +
> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
Add a line break somewhere in there as no real reason it needs to be all in eonline.
> +

Trivial: Drop this blank line to keep error check associated with the call.

> +	if (!dvsec) {
> +		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
> +		return 0;

Returned, so no point in the else.

> +	} else {
> +		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
> +	}
> +
> +	cxlds = cxl_accel_state_create(&pci_dev->dev);
> +	if (IS_ERR(cxlds))
> +		return PTR_ERR(cxlds);
> +
> +	pci_info(pci_dev, "Initializing cxlds...");
> +	cxlds->cxl_dvsec = dvsec;
> +	cxlds->serial = pci_dev->dev.id;
> +
> +	/* Should not this be based on DVSEC range size registers */
> +	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
> +
> +	return 0;
> +}
> +
> +static void type2_pci_remove(struct pci_dev *pci_dev)
> +{
> +
> +}
> +
> +/* PCI device ID table */
> +static const struct pci_device_id type2_pci_table[] = {
> +	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
> +	{0}                     /* end of list */
{} is more common.
> +};
> +
> +static struct pci_driver type2_pci_driver = {
> +	.name           = KBUILD_MODNAME,
> +	.id_table       = type2_pci_table,
> +	.probe          = type2_pci_probe,
> +	.remove         = type2_pci_remove,

Add remove only when it does something.

> +};
> +
> +static int __init type2_cxl_init(void)
> +{
> +	int rc;
> +
> +	rc = pci_register_driver(&type2_pci_driver);
> +
> +	return rc;
> +}
> +
> +static void __exit type2_cxl_exit(void)
> +{
> +	pci_unregister_driver(&type2_pci_driver);

Unless you are adding more in here later in the series there is a macro
to cover all this. module_pci_driver()


> +}
> +
> +module_init(type2_cxl_init);
> +module_exit(type2_cxl_exit);
> +
> +MODULE_AUTHOR("Alejadro Lucero <alucerop@amd.com>");
> +MODULE_DESCRIPTION("CXL Type2 device support, driver test");
> +MODULE_LICENSE("GPL");
> +MODULE_IMPORT_NS(CXL);
> +MODULE_DEVICE_TABLE(pci, type2_pci_table);


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9B4F45D8E4
	for <linux-cxl@vger.kernel.org>; Fri, 17 May 2024 14:33:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715956430; cv=none; b=B4iTD2JBSo4AWoFAh1zZGF5G+ohKT6M/GyIckg7n6JOQaDlTOZYern+Whqo0CXCu2jL4vFeGZgbJTzazN+19po8WnYEMVZ+T33D8GF61BWes8mCnTpgWKjJagSsvM4LkRAKgvlxY46GnoyOKw4pjCRBcSLqAvYpM8++3+Asr/nI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715956430; c=relaxed/simple;
	bh=98j9NZjrfdN288mtFpMrVZUb+cjQtxrEHE/Xm1Ubv6Y=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=acHdtpnFfrhZBIbuHw281TN8rYYnegybTJwNYAoP3vG4zjYp6fr79AzXmIpFISbCXQVxZbfrlPyDKf3oZJaIclqcwS1K4MDBaSDR1gDoaMTf38mbAx8+YVoTR3qh8bxY85BM66d60iwD+sYrM1AM5Cf1oRwBzvV72R8qAaiJYo8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Vgq9s6RVFz6F94h;
	Fri, 17 May 2024 22:30:09 +0800 (CST)
Received: from lhrpeml500005.china.huawei.com (unknown [7.191.163.240])
	by mail.maildlp.com (Postfix) with ESMTPS id 11C16140B39;
	Fri, 17 May 2024 22:33:45 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Fri, 17 May
 2024 15:33:44 +0100
Date: Fri, 17 May 2024 15:33:43 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: <alucerop@amd.com>
CC: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 04/13] cxl: allow devices without mailbox capability
Message-ID: <20240517153343.000066e6@Huawei.com>
In-Reply-To: <20240516081202.27023-5-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
	<20240516081202.27023-5-alucerop@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)

On Thu, 16 May 2024 09:11:53 +0100
<alucerop@amd.com> wrote:

> From: Alejandro Lucero <alucerop@amd.com>
> 
> A device not implementing the CXL memory-device class code, aka Type2
> devices, has mailbox capability as optional. If the device registers
> mapping does not show such capability, do not treat that as an error.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
If you are removing this check from the shared code, it needs to be
in the more specific code, or you need to state why that isn't
a problem (i.e. it is caught later anyway)

Jonathan

> ---
>  drivers/cxl/core/regs.c | 5 ++---
>  1 file changed, 2 insertions(+), 3 deletions(-)
> 
> diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
> index fd165e718cf2..5434a7c899fd 100644
> --- a/drivers/cxl/core/regs.c
> +++ b/drivers/cxl/core/regs.c
> @@ -437,11 +437,10 @@ static int cxl_probe_regs(struct cxl_register_map *map)
>  	case CXL_REGLOC_RBI_MEMDEV:
>  		dev_map = &map->device_map;
>  		cxl_probe_device_regs(host, base, dev_map);
> -		if (!dev_map->status.valid || !dev_map->mbox.valid ||
> +		if (!dev_map->status.valid ||
>  		    !dev_map->memdev.valid) {
> -			dev_err(host, "registers not found: %s%s%s\n",
> +			dev_err(host, "registers not found: %s%s\n",
>  				!dev_map->status.valid ? "status " : "",
> -				!dev_map->mbox.valid ? "mbox " : "",
>  				!dev_map->memdev.valid ? "memdev " : "");
>  			return -ENXIO;
>  		}


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0F72654273
	for <linux-cxl@vger.kernel.org>; Fri, 17 May 2024 14:40:35 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715956838; cv=none; b=mkromwspH4cIWET9X8PtMe6YM0pS/5EQxWfo4B5pS20jiE9BE4xukOGM3V1UQJdUf6P+91q+E8YVk9pZY2112Yw+ToX7ayFIcu0m+qXSnuvXiL3CbzFsN9wDOcHpjAaxbFBTs+X7YicGtodwJiWoloLMV42RdqYHqbdudqo455o=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715956838; c=relaxed/simple;
	bh=44EfypqGTIRb7W/3B2tc5em9ODR9PGCZ3gBfB0/S26M=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=JKZD/QvLuO9LQqJ4rN+4Ko/4Qu2JrMHB+K6NiTqIPrbYdi5+gDU3syso9J3jR/7+dFLEVGN5mKqSl7IoQQt1vMUFYHuZZmEVsWBAmFYDLBWjYqiR7aL+fUFBxI9jHqIn0/b1Y5mMmWXM6VudECanASMYVODEbSucRPiK7WoxTIQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4VgqKv3FNkz6D8W5;
	Fri, 17 May 2024 22:37:07 +0800 (CST)
Received: from lhrpeml500005.china.huawei.com (unknown [7.191.163.240])
	by mail.maildlp.com (Postfix) with ESMTPS id 522FE140B39;
	Fri, 17 May 2024 22:40:33 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Fri, 17 May
 2024 15:40:32 +0100
Date: Fri, 17 May 2024 15:40:31 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: <alucerop@amd.com>
CC: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 05/13] cxl: fix check about pmem resource
Message-ID: <20240517154031.00007e35@Huawei.com>
In-Reply-To: <20240516081202.27023-6-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
	<20240516081202.27023-6-alucerop@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="ISO-8859-1"
Content-Transfer-Encoding: quoted-printable
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)

On Thu, 16 May 2024 09:11:54 +0100
<alucerop@amd.com> wrote:

> From: Alejandro Lucero <alucerop@amd.com>
>=20
> Current check is using resource_size which counts on a range bigger than
> 0. For a resource with start and end being 0, resource_size returns 1
> and implying a false positive. Use the end not being zero as the new chec=
k.
>=20
> Note: If I=B4m not missing anything here, this should be extended to the
> whole linux kernel where resource_size is being used in conditionals,
> and where the likely right fix is to modify resource_size itself
> checking for the range not being 0.

The start and end being 0 is a valid resource of length 1 so that
should not need fixing.

These should have been initialized with DEFINE_RES_MEM()
/ DEFINE_RES_NAMED()
That will happily set the .end to -1 resulting in a wrap around
so that you get all bits set.

Sometimes this gives slightly confusing range prints but otherwise
I think it is fine.

>=20
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/core/hdm.c    | 4 ++--
>  drivers/cxl/core/memdev.c | 8 ++++----
>  drivers/cxl/mem.c         | 2 +-
>  3 files changed, 7 insertions(+), 7 deletions(-)
>=20
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index 47d9faf5897f..c5f70741d70a 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -432,12 +432,12 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *c=
xled,
>  	 * Only allow modes that are supported by the current partition
>  	 * configuration
>  	 */
> -	if (mode =3D=3D CXL_DECODER_PMEM && !resource_size(&cxlds->pmem_res)) {
> +	if (mode =3D=3D CXL_DECODER_PMEM && !cxlds->pmem_res.end) {
>  		dev_dbg(dev, "no available pmem capacity\n");
>  		rc =3D -ENXIO;
>  		goto out;
>  	}
> -	if (mode =3D=3D CXL_DECODER_RAM && !resource_size(&cxlds->ram_res)) {
> +	if (mode =3D=3D CXL_DECODER_RAM && !cxlds->ram_res.end) {
>  		dev_dbg(dev, "no available ram capacity\n");
>  		rc =3D -ENXIO;
>  		goto out;
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 0336b3f14f4a..b61d57d0d4f4 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -197,14 +197,14 @@ static int cxl_get_poison_by_memdev(struct cxl_memd=
ev *cxlmd)
>  	int rc =3D 0;
> =20
>  	/* CXL 3.0 Spec 8.2.9.8.4.1 Separate pmem and ram poison requests */
> -	if (resource_size(&cxlds->pmem_res)) {
> +	if (cxlds->pmem_res.end) {
>  		offset =3D cxlds->pmem_res.start;
>  		length =3D resource_size(&cxlds->pmem_res);
>  		rc =3D cxl_mem_get_poison(cxlmd, offset, length, NULL);
>  		if (rc)
>  			return rc;
>  	}
> -	if (resource_size(&cxlds->ram_res)) {
> +	if (cxlds->ram_res.end) {
>  		offset =3D cxlds->ram_res.start;
>  		length =3D resource_size(&cxlds->ram_res);
>  		rc =3D cxl_mem_get_poison(cxlmd, offset, length, NULL);
> @@ -266,7 +266,7 @@ static int __cxl_dpa_to_region(struct device *dev, vo=
id *arg)
>  		return 0;
> =20
>  	cxled =3D to_cxl_endpoint_decoder(dev);
> -	if (!cxled->dpa_res || !resource_size(cxled->dpa_res))
> +	if (!cxled->dpa_res || !cxled->dpa_res->end)
>  		return 0;
> =20
>  	if (dpa > cxled->dpa_res->end || dpa < cxled->dpa_res->start)
> @@ -302,7 +302,7 @@ static int cxl_validate_poison_dpa(struct cxl_memdev =
*cxlmd, u64 dpa)
>  	if (!IS_ENABLED(CONFIG_DEBUG_FS))
>  		return 0;
> =20
> -	if (!resource_size(&cxlds->dpa_res)) {
> +	if (!cxlds->dpa_res.end) {
>  		dev_dbg(cxlds->dev, "device has no dpa resource\n");
>  		return -EINVAL;
>  	}
> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
> index 6dc2bf1e2b1a..a168343d2d4d 100644
> --- a/drivers/cxl/mem.c
> +++ b/drivers/cxl/mem.c
> @@ -174,7 +174,7 @@ static int cxl_mem_probe(struct device *dev)
>  	if (rc)
>  		return rc;
> =20
> -	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
> +	if (cxlds->pmem_res.end && IS_ENABLED(CONFIG_CXL_PMEM)) {
>  		rc =3D devm_cxl_add_nvdimm(cxlmd);
>  		if (rc =3D=3D -ENODEV)
>  			dev_info(dev, "PMEM disabled by platform\n");


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (mail-mw2nam04on2043.outbound.protection.outlook.com [40.107.101.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5F933FC01
	for <linux-cxl@vger.kernel.org>; Mon, 20 May 2024 15:42:05 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.101.43
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716219727; cv=fail; b=QpWD76kMLqTDNeVDMWVMhkCmoMSVC22zyuYUEATCQJNJ8r+rBZU78ImT9Jbxo+0vmXITkduiXAP7DDHp83Ma0wckqymV8qMxC4H92ft5XgYmPRa6QfTl9gLJZPCPJ450xfcqR1oFUI26Md8QXaqx8Tdn4t4Yw/N4JQ9bysbWBcU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716219727; c=relaxed/simple;
	bh=2q7WIKcvml+6nX2N/WwXVgzOBZwTPIlWBhNOMP5uz/A=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=WsENhfm8wXHSmp6ccZyrh/I4jeSttmft4ayyu1lcCSuA2mPrgDvBJydOJUloSFbhf46JD2cYbX79GmxU3wbV7/yE+MxGdhuf5JdmvOgH7bJmFxAL81gyNwNs3A0iUTyIkB+dfUrtHI7uDsNZPJLWCIn4vYh268wwzlc49V7NakQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=yDSGOwyc; arc=fail smtp.client-ip=40.107.101.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="yDSGOwyc"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=adyA5kqcsU1zgqGfA7IAIRexfmThlx3eUoDJYKnNBAF3rQFgFWyzBFmMbeCLL0j5JMkxGcGjnK+ye3mcyNeysf7SgOCj8fHKuCs4251DwpxUhNOGiVU8eqa2IecHxQvfz34jNEqs7fwJ9NofGZZBSZ34xgEcyivHnm6KPDU0pOlvk19aBx1/wIRkjGO1qyfhir0jO3piL3Ea4AvGND9Kd9B+NmLrtFgKAduEqdbr+htHKu2XW2bLVnnJwuC/icilmtm8IJD15GBsQhchfhTHva23C/GBZX3lJn66mOFF8bcoGrQkcuPYn47RplLv1rt8upOQiHQ4tp5FGMWy3vsGtA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=MTDMe375lbU1XXE7I9zBEWexLG25/GXu77CFFn0GOk4=;
 b=ScxwUFx6/0vm2q2M1WsVpzIiYgByScdQNDmdUEu6jFtbdi/G26iKFXgTdkKYVbQXG2Qa6y3UvDy5bo9P5fKuQScExoVNIKooyHlJa+IeMhOQq8/lTwZN6GvCWwAIpDBCIjhuhL+Cuv1Nl8fWkzDPBEWU+xsXBJlM6PivybsNEduYgO3o5Os/KjTDUYR3n1wtbzVobnRnM4vBIPSZawoyGMax65IXk5q35oeQ1B2Q+OuSNAiYcAT9eI016w1yP7jCs3Np6SEK66aXoFOb4qjpGn/MRzz5z3hW6kIDQCYvZONCv8Ewyrb8b+BUnWa2q3uPg4NmvSHipZe4NZ5bRJOJPQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=MTDMe375lbU1XXE7I9zBEWexLG25/GXu77CFFn0GOk4=;
 b=yDSGOwycaNj12s4ktdL9skLac4wVJzG7xTAQ8xfv9epy6mr3OXzbRZMmllC4df2/0iBC1ngHPKzQyOJnZ7UqwL7+qZ/glBjXIbkLwaUPfifhJGiOzrhfZpx/Z8k3tZ2LmV823SOLEFvHGhiSZWh+1Y0uCkJXU4ZG/7X7grBCenE=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by MW6PR12MB8705.namprd12.prod.outlook.com (2603:10b6:303:24c::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.35; Mon, 20 May
 2024 15:42:02 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7587.030; Mon, 20 May 2024
 15:42:02 +0000
Message-ID: <b176052b-200d-1583-bb86-759c1cd4a2ff@amd.com>
Date: Mon, 20 May 2024 16:41:57 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 05/13] cxl: fix check about pmem resource
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-6-alucerop@amd.com>
 <20240517154031.00007e35@Huawei.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240517154031.00007e35@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P123CA0083.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:190::16) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|MW6PR12MB8705:EE_
X-MS-Office365-Filtering-Correlation-Id: efe0b10e-ddb8-4f59-757e-08dc78e364b1
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|1800799015|366007|376005;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?QzRSWnE2NVAyRVFYUDBiWkYzVyt3anBRdkxqZ202Q2RzNkN3UVhoQWpSSHFB?=
 =?utf-8?B?SytyNmRPWHgxY1NpWGJvTVFTM1VFUmQ1a3VVSFZNN3pZa1dhdklodU5XZXl3?=
 =?utf-8?B?TWdxUmlVb2grM2taZkVuM1p2dDVlcFVQeUZpUndzTUhYY3NoM1BlbUZsYzNX?=
 =?utf-8?B?UXdudlVWWjBzc2MrTWlFak1OZkwwSUpQc0JiNEF5elV1Rm9oSENhSGhGeVZ6?=
 =?utf-8?B?UzhwQ0owTVlQb3FGOXBJdHI5VWRVbys2S0w2NWw2QUpOd1dMblRzT2E5elpt?=
 =?utf-8?B?TDNVTDdtbjVWSkMvek5yUlpZMVY1b25ERUtQTzM4d2I5aHE5ZHlNU2xpcWYv?=
 =?utf-8?B?UzhtclJYU1lPMlorYlZxODR3M3c4ZlpZeitHYUMwZFB0NUoyQVdlM2RGOHcr?=
 =?utf-8?B?UjduRHZDV2V3RHk1Q2ZEbFN1Y0h6NDNLTTJTcHFXRGNxZTNjZTVKTE1kbnNO?=
 =?utf-8?B?OWIwZ2FnOHZ2MHUrUEg3YWtSQWgvS0NqYnlMUlE3ekpjdUpzb0Fxay9pTlFH?=
 =?utf-8?B?eGhtOE9mYmx5M2xMaEs2Ui81ZHJ0ODVieUpBbnlsK2d1dTkxOEFmR1RLQzBS?=
 =?utf-8?B?WEdnRm5PL3Y5Mi8yRDY4T09IdDdaTUlTWHRpQ1A2a0hGOGdOcFhnR05KWEVG?=
 =?utf-8?B?dFVweldlYk9VbjBnT0I0QjFTb3JSUmRhcWlyMUZLajU0R1V1TzE2SDZnM1RX?=
 =?utf-8?B?R2FRaXFKUE55WUh5MllhSVRMWEFhSjZlVkE0d2cvM2ZydWtXS1NjY09YSUtE?=
 =?utf-8?B?MmtYRWFxNjV6ZDQweWZsRkIybTZPYVUwdmo5ZHIwenBFMzRxM2N0RjhlTDJ1?=
 =?utf-8?B?S2RLVUVpRElwMWwxcUFrRzhKanZxTmpRYkRaelV4NVNTTWFxYXdOSzRhTGJs?=
 =?utf-8?B?bm84WTE1Z1VISTFaSG16UTJSbFZvU2tXUk9hcUxncXpmVndZOFp3L3hmTFQx?=
 =?utf-8?B?RzRBTlFDMmpQKy9NRmorQlZkZzA4aEphRkIveUlzZ1dVdEVvYWwyMTZkM0pB?=
 =?utf-8?B?QU5xcWtjTlROVDkvRWhERW0xZ0oydlE0amlXZFZIcXR6SjN5dVNHcXpLTnVx?=
 =?utf-8?B?WDByUXR5OHkxTkR2c0ZmZ2NHYklUQytQTCtsQUZmam5zQld1QWEwQVhhVG1z?=
 =?utf-8?B?YkpRbkNUTVlMZmdmS29YRWhCRVdicGltNjRodi9jY1l1ZFFGRE1vZ1o5SVBK?=
 =?utf-8?B?elNXeDRPaC9hRVhXbjNuQ3JhM2VCSFpNTTFWRzBacGtuU3MxVDkxaDcyU21S?=
 =?utf-8?B?VEdaYjU0TmtPSmdvYU5zNWovNWV3OVg5ZnF3RHJubUJTSDNMblhEYW5jZ0Rl?=
 =?utf-8?B?MTJtRWNsWW1vWmZ2K0R5NytPVEVCVmZKUUpobXZFcFc0YTFDUk1icVZMRE5O?=
 =?utf-8?B?NTVYblpOV25vREJmTnBpaWFrVG1pbHNTdkhFS3JaUTZzY0ZEdHhpVnBZeUhr?=
 =?utf-8?B?SCs1STlURGtXWWdVd2txOXo3RHpqckt5TUorTEhsZjc5N1BZZjY0OHU1VWNQ?=
 =?utf-8?B?R3lYVnRPSDFVUEc2MUJSTlExcHNBWFBkd0xlZjZ2a3lKYy9MRklPOUp6VHlO?=
 =?utf-8?B?c240QjU3djk5R0hVc205VVV3aWZQOGJrSHhDT24vZmFxL09rM1F0aU0renU2?=
 =?utf-8?B?SWpSNjNFQ25PdmZpZ0FpelIzZmJCZU1wd1BSYmNyeUkwalc0SDR6ajU1czJ0?=
 =?utf-8?B?NjloRmdzWktOeGxBeTNIZ2U3VnI2ZnNQenpIdTJPU1lhM1FiMnBRMVNnPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(1800799015)(366007)(376005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?RzArVWpRRnE2Uyt6VkhqelVIWTZ4bkljMkFHMzNWR2FyOXIwSVRnTVp6a2Y3?=
 =?utf-8?B?WUpYQUVXK1FmcWhCaDhpUlV1Y0MySEEyeUNqYUs1eXUxaTVYNGpZR2h2bEJQ?=
 =?utf-8?B?aHdmMzVaWnNiUldiR3pENUp2RlNBKzFraDdkcVRQZ2w1bzBaeFhWQ1h4Vmt1?=
 =?utf-8?B?V3c1Z3Bqcy9PbFZzRnZtMGEwUVVTVWduZUpaNzlSY3pGNGl3azFORUUxU0Zu?=
 =?utf-8?B?WVgrYjNsb09qYU03YmFNbHQ2TlFpUGJaU2ZZSGVxbW5xbGw5alFZOWwvVWZt?=
 =?utf-8?B?VU1ySmd0NTZ0bDhwNFhFdys1R01STXpGcXJ0bmdSemxNeS9OYVE0ZHhONUY4?=
 =?utf-8?B?Zks3YlgvUXAxbGJPTjd1ZDJYWkJNVjVoTGZWWDhxMm4zOW9Eei9IcWEvQllH?=
 =?utf-8?B?TWJ1SDNEaUs1bUpqL2VaRnlGd3F3U2tPQzBGZEZHWlIrTEtxU2RPUjZycHpD?=
 =?utf-8?B?V3RNVHVUNkl4VlRxVTJEZStmSXhMeDFVbSsrZnJzRFJ4ZG5Ya2VSU29QSnNl?=
 =?utf-8?B?cXhFam9CRkdVNGxhS1BqSENGVjd6c1hSekc1ZzNLNkZlcXVuVXdTL0w0ZDVO?=
 =?utf-8?B?cVM0UjBrYzNoS2dOS1ZNR0NxbDNaN2NuQ2dWenorejE3dzhSZ0FNTUpkSlZW?=
 =?utf-8?B?YzZBSDdWRjNyL3hNMVEweVhVTnJPcVhQbzhIaEVDVkZ2c2NFYWs4MUhmT2xa?=
 =?utf-8?B?bmwxMkJnbzRJOU1PNi8zSStEbXNiNTlDNUs4ZnpXRldFU3AvWHMvQVhmTEFD?=
 =?utf-8?B?alptemJHek5qR3V4c251MkY4UnowNGRDTGpXNkNnbU1CVjFqOTR1ZTFBK2E5?=
 =?utf-8?B?NHRVWlZhdVJnd3hhOHE5Z0xSRENJcmUxcFN1UmpGdEdSY2NlNzdCWTBncmJM?=
 =?utf-8?B?aWxKNmErenhxMUhxUHR0ZWo2b3hsQkhrUXJWNTl0bUh2VmxCRGRGYWNNbk9r?=
 =?utf-8?B?SFBNRUk0dmVLbkU1RDliSWxsemhzQy82TkhpcUdXRzkxMTJZVmVOSk9PS2JN?=
 =?utf-8?B?aU4vUmpJK0QwMWpYVkp0bzBtVm96c3cxa1dVRHlmaGZkZWNFN05JaThjeUVw?=
 =?utf-8?B?d1R6WVZ0YS9FMS9YTURvWHJ4dFMzeGdIb1k2SEJmQkFUK3lyN0ZuSEFqTDUy?=
 =?utf-8?B?ZmVCTTh4MzlZZE4zYVI0bTl3d0pkaGttTlRXQnBHSHNsNkpPTFkrZFRMSW4z?=
 =?utf-8?B?TzdHRC9tQXRnU1pWOFpUaCt0emZhL2VJdGRud2VpL2FkaUsyNlcrelgrTTVH?=
 =?utf-8?B?ck8zb3hwbDhrbndYajZQWGVtNUZUZFk3bTF6amM0NmNhSDlHRzFmcDdlbzFG?=
 =?utf-8?B?eStkUTVsNGlIK2E0RWRlMEg4M1I0TEtGQmRRaXJmWmpyWUR3eW9md2xPR0Nu?=
 =?utf-8?B?eklWV1pEM2RvcVRxSmkvNnFoc1owVm5YNitFRG9vRzd2R3Q2QTdUSWRCdUI0?=
 =?utf-8?B?b2cxbWQrUFZURk1jQUYvWWlNMXM2TDJyMWVBOWJIZlI0WWNKK3dudG9uMmNk?=
 =?utf-8?B?cURjRlVyM2FHenJxYWR0ZVBhRU13UHBkMit0aTFseDFlY1BvMlBjVUtoTkxI?=
 =?utf-8?B?MUF0K09aNFVEajNFSU5NV0RyMEVaL0hHOXFrM3puQnZRTmJibzVOTHRKc3pz?=
 =?utf-8?B?UnVSNGM3bHRHalc5N3NIWnBQd3h6MENmaDBSbEhwZ2I1S2tjSGd0SWhYMnhV?=
 =?utf-8?B?ZGg1MHYxS0pEN3djSmk5YTdtOFdnekR2Y1ZUdzV1MWR4N3lkVWFvdmxrUy9h?=
 =?utf-8?B?dFFzSVdsZ3hOZmVaNjNKZmE2QlhyK2V3UFV4SklyZzBQd1R3TzhpMzMxbkd3?=
 =?utf-8?B?cWRlbXNpc3dyOTlydTM2OFlQRUN3UFFNYUpGNURNWUtEWllSV0hxQ3hDZFhy?=
 =?utf-8?B?YTFCNy81NTBCTWh6aWFyRGxnNVpQTGY5b3VPS0V1UGdpTTZFdWtqWjV4bFhN?=
 =?utf-8?B?Y1ZjSXc1dnc1WWgrNEZFZGI1U1BScWprbWkyRFR0RklxQm5sTjdzdEROUE5Q?=
 =?utf-8?B?RmlrNHBVUUhQM3lucDZsUWFiWWZvZ2NtRy9ENG5PSmhzd3drdVVVZk1ldzJE?=
 =?utf-8?B?SHVGcXdOSDQ2WVdaaG9rZVBlTVA0SU5xTTlLd0QrK3BYb1NWeGJhanJhS0V3?=
 =?utf-8?Q?1JzUPVJgBarTQUYR9pLrXTmaP?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: efe0b10e-ddb8-4f59-757e-08dc78e364b1
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 20 May 2024 15:42:02.4505
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: +caekmmPXY+vonQFUJbNbxROhAjlgp5a/0qZ8rau7kcsAF+WgKz5oiIZYZBYa9Hsxn8CDszHRECGEZI0cAdaJg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW6PR12MB8705


On 5/17/24 15:40, Jonathan Cameron wrote:
> On Thu, 16 May 2024 09:11:54 +0100
> <alucerop@amd.com> wrote:
>
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> Current check is using resource_size which counts on a range bigger than
>> 0. For a resource with start and end being 0, resource_size returns 1
>> and implying a false positive. Use the end not being zero as the new check.
>>
>> Note: If IÂ´m not missing anything here, this should be extended to the
>> whole linux kernel where resource_size is being used in conditionals,
>> and where the likely right fix is to modify resource_size itself
>> checking for the range not being 0.
> The start and end being 0 is a valid resource of length 1 so that
> should not need fixing.


Uhmmm ... I have problems understanding this but I guess there's a good 
reason for it.


> These should have been initialized with DEFINE_RES_MEM()
> / DEFINE_RES_NAMED()
> That will happily set the .end to -1 resulting in a wrap around
> so that you get all bits set.


That makes sense, but I wonder if we should have some function for doing 
default initialization of those fields like this which some users, like 
an accelerator with no pmem, will likely leave untouched.

Maybe inside cxl_accel_state_create in patch2 something like this:

 Â Â Â  cxlds->dpa_res = DEFINE_RES(0, -1);

 Â Â Â  cxlds->ram_res = DEFINE_RES(0, -1);

 Â Â Â  cxlds->pmem_res = DEFINE_RES(0, -1);


>
> Sometimes this gives slightly confusing range prints but otherwise
> I think it is fine.
>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> ---
>>   drivers/cxl/core/hdm.c    | 4 ++--
>>   drivers/cxl/core/memdev.c | 8 ++++----
>>   drivers/cxl/mem.c         | 2 +-
>>   3 files changed, 7 insertions(+), 7 deletions(-)
>>
>> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
>> index 47d9faf5897f..c5f70741d70a 100644
>> --- a/drivers/cxl/core/hdm.c
>> +++ b/drivers/cxl/core/hdm.c
>> @@ -432,12 +432,12 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
>>   	 * Only allow modes that are supported by the current partition
>>   	 * configuration
>>   	 */
>> -	if (mode == CXL_DECODER_PMEM && !resource_size(&cxlds->pmem_res)) {
>> +	if (mode == CXL_DECODER_PMEM && !cxlds->pmem_res.end) {
>>   		dev_dbg(dev, "no available pmem capacity\n");
>>   		rc = -ENXIO;
>>   		goto out;
>>   	}
>> -	if (mode == CXL_DECODER_RAM && !resource_size(&cxlds->ram_res)) {
>> +	if (mode == CXL_DECODER_RAM && !cxlds->ram_res.end) {
>>   		dev_dbg(dev, "no available ram capacity\n");
>>   		rc = -ENXIO;
>>   		goto out;
>> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
>> index 0336b3f14f4a..b61d57d0d4f4 100644
>> --- a/drivers/cxl/core/memdev.c
>> +++ b/drivers/cxl/core/memdev.c
>> @@ -197,14 +197,14 @@ static int cxl_get_poison_by_memdev(struct cxl_memdev *cxlmd)
>>   	int rc = 0;
>>   
>>   	/* CXL 3.0 Spec 8.2.9.8.4.1 Separate pmem and ram poison requests */
>> -	if (resource_size(&cxlds->pmem_res)) {
>> +	if (cxlds->pmem_res.end) {
>>   		offset = cxlds->pmem_res.start;
>>   		length = resource_size(&cxlds->pmem_res);
>>   		rc = cxl_mem_get_poison(cxlmd, offset, length, NULL);
>>   		if (rc)
>>   			return rc;
>>   	}
>> -	if (resource_size(&cxlds->ram_res)) {
>> +	if (cxlds->ram_res.end) {
>>   		offset = cxlds->ram_res.start;
>>   		length = resource_size(&cxlds->ram_res);
>>   		rc = cxl_mem_get_poison(cxlmd, offset, length, NULL);
>> @@ -266,7 +266,7 @@ static int __cxl_dpa_to_region(struct device *dev, void *arg)
>>   		return 0;
>>   
>>   	cxled = to_cxl_endpoint_decoder(dev);
>> -	if (!cxled->dpa_res || !resource_size(cxled->dpa_res))
>> +	if (!cxled->dpa_res || !cxled->dpa_res->end)
>>   		return 0;
>>   
>>   	if (dpa > cxled->dpa_res->end || dpa < cxled->dpa_res->start)
>> @@ -302,7 +302,7 @@ static int cxl_validate_poison_dpa(struct cxl_memdev *cxlmd, u64 dpa)
>>   	if (!IS_ENABLED(CONFIG_DEBUG_FS))
>>   		return 0;
>>   
>> -	if (!resource_size(&cxlds->dpa_res)) {
>> +	if (!cxlds->dpa_res.end) {
>>   		dev_dbg(cxlds->dev, "device has no dpa resource\n");
>>   		return -EINVAL;
>>   	}
>> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
>> index 6dc2bf1e2b1a..a168343d2d4d 100644
>> --- a/drivers/cxl/mem.c
>> +++ b/drivers/cxl/mem.c
>> @@ -174,7 +174,7 @@ static int cxl_mem_probe(struct device *dev)
>>   	if (rc)
>>   		return rc;
>>   
>> -	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
>> +	if (cxlds->pmem_res.end && IS_ENABLED(CONFIG_CXL_PMEM)) {
>>   		rc = devm_cxl_add_nvdimm(cxlmd);
>>   		if (rc == -ENODEV)
>>   			dev_info(dev, "PMEM disabled by platform\n");

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2070.outbound.protection.outlook.com [40.107.220.70])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E76124C66
	for <linux-cxl@vger.kernel.org>; Mon, 20 May 2024 15:46:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.70
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716220015; cv=fail; b=B6ZFsFCY4BzyyG4i1t4V5KEUbaSY/It2Ve1xcMckQLvFerclvQTov9t3ht89ycZEVkkyaThGSCBnoT2Fz1274K7OIOv1lm25N7bXGrawB6Tzl032DhDKSY/Ovy1nY/fK6zwq/OXvPE8GsAuFovuVVmzOm28i36Fcd5zMlAztMao=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716220015; c=relaxed/simple;
	bh=Uwv8iSc9ZwoBNyLutwkxC6lr8CZDLPL0Y8BQy7QfXII=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=SH7MfxgaqXoJrVWtOkFvkVhMQCozbN3v0912ancpnvAH26aPzHKQCjCIwRXbgetq58bq1o52T3Lbo6JrRL2aYsXNZgIFHxPMMSUSnpOy/0fJtY5Oc4Z73zsNJ2T2t6xL9bKAjnyUGbUhVnnyO8BHdWFlQL+qsxRp+77LQiju9ag=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=XWipvi82; arc=fail smtp.client-ip=40.107.220.70
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="XWipvi82"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=klPYmo67800th5zTpqEhe8h4dxVa+WjK2Ps4P+Aemg43gvR8V0GvQcJeitKTMSP4q86/lKubvAeKzDZusPdj9oGSlOUPIvKXgTnRVEXiLZex1ht729u9rPAujSE78bFQyVnTtZK40fAZRlv9vInbRlYImLUm54UEPQQF5qdtxaxgSZ+A5ToOhmtrNHksk/GmULaMJ/1xTBnQZGzIR7v8SfkCcCRlfPH0ban6N2dnsdkdKNSIkm69DtHzQk3WMLK3DCHMHzVZbxvlNRxafByWEZeb1EQFpzNSZdLzJCfd8sq4q/VkHswxs8isgbm/M7p9cNW2Hq3nK4HSI6Y92AkfKA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=dsnTPOWT1mUnZ46PzA6HPdFsE1+64A7ebG9l/93yCxQ=;
 b=hWZBVk0LF9eXr/0N7wNmfNyE71+QRVAbySUHQ/Twn6DGhM6AgYYhg3mzjqO6Y3Y5hlT8oNkFJg2o3lyRLs/MN4kJAsKDSwEUIV1FJjK05qNj447VtqQhuXogSKBZsqXp5R894zFJrg7pLmax4kI+PI/OQEHVWGOnT+jwDcWvfRblcRN9QSKLgBXsw4B5fAMi2IiDvKZxoiHMOugGEzirNvGiXqfIpuprBT2ICT9PqCuBPNLI+LZ/jJXOQp4RQNa+6KxyE/SyXnh614MyI/ucasZtp/IoWVnvjQ0Wyk1K0lSZPNVckIglUa1eefTSQGD76OKSHHeAFiR/8Q/JtpmpGQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=dsnTPOWT1mUnZ46PzA6HPdFsE1+64A7ebG9l/93yCxQ=;
 b=XWipvi82hUCz7fw6Nry7wTBRk/O0Ffh2VPZzZCrxnGigtljtG1i+DcA4UwmBCyqBlJSR0cUkspg1z7PMzEnCpBt1u0FTBePckpq9E4mS4MW5K6PmV0tL5abRE/kaW4vj+frLTXBmbplmE0HHi+IGAlOHnL2lfrFnYoD6URqhHko=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by CH3PR12MB9455.namprd12.prod.outlook.com (2603:10b6:610:1c1::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.30; Mon, 20 May
 2024 15:46:51 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7587.030; Mon, 20 May 2024
 15:46:51 +0000
Message-ID: <ad74c6c7-749b-4fa8-f0d9-94aaf07f4754@amd.com>
Date: Mon, 20 May 2024 16:46:46 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
 <20240517153048.0000480f@Huawei.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240517153048.0000480f@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO6P123CA0037.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:2fe::9) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|CH3PR12MB9455:EE_
X-MS-Office365-Filtering-Correlation-Id: 817a9696-ca74-4bb4-077a-08dc78e410f7
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|366007|1800799015|376005;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?S3JLeGpiZEdJM05MVWFUVVlTL1VBODNmYzJyY3ZCb3lvc1pXeVBCQVFSSmxP?=
 =?utf-8?B?K2RJaldDOWREUEQ5aHM2eUdvUXdGMW5jeVNEbFV2RTZxMGlBcUl3VzRJNWpP?=
 =?utf-8?B?b2FYcFFQV05odUt4TEVPd1F2NmQraStMYSs2ZWtQVkh4cGJ2OEJINWtZZzlv?=
 =?utf-8?B?YTNrU2ZlaTZDalBLWWQzWWg5Ky9Yb0RjUnFtZXZkMCtKN1A3ZXQxd0FsTFNQ?=
 =?utf-8?B?OUR4TzJRYXk3VktKTHJHZXRndXl4L2ZmaGIrN2E3UkU2UDJSL3Y1THpzSm1t?=
 =?utf-8?B?UU9kRnI5NlpRZ1Z5MlNaaXpPNXVxUUQwcVVvSWJ2SzVxMU5FdW9yZk1Cb2ov?=
 =?utf-8?B?QVlpZTVmSDFRcXQ5cVZENThmdnhzZmliMVVVMmM0ZnY1Ykt4VTB4bm8rUnFR?=
 =?utf-8?B?RVlpc2hpV2Fna0EwVCttR3lvcXBHWWd0b0RFWTVkaGMxUGJwdGpUeGJFb0ds?=
 =?utf-8?B?ajBRVkdQb05kQ0x1SFJDMVBnTGUwWnpsUFM4aHNTeXE0d01yZHVLeGcwbXY4?=
 =?utf-8?B?NlFTS3RrY0dkYnAyZlZSQlJBVHFXTEhxdWZza3pYaVd5VEkrUWZLNlhDa3R4?=
 =?utf-8?B?aE5WWXFPWHNySk0xQ1ZqaWRWMnhGS0ovTEJta0JXSE92dS9FVkZDQ3g3Zm45?=
 =?utf-8?B?aUlxU2t0K2w1bU1HOE5oc3RqL0tzNmphaVFtWHpJbkN2NHpiaHBKQWxRL1Br?=
 =?utf-8?B?YnFTWUtRUWMxR0ozUDJNU0J2OEo1VU94N0NKcEhWeFVCcjlUc05QcStMRUdk?=
 =?utf-8?B?MmZHWUJhekJPVStBWmc1ZmFkOGo3RkJXQUY2L3llT0J3SlZzWUJBb0F1aE5p?=
 =?utf-8?B?dFZtTDRzMUtqQThGQzN4V0Y3OTRna0ZFQUhWZ1ovZFkxZXEyUCtXUHJURXEz?=
 =?utf-8?B?Mmw0bVJwZnJzREhkRmFrdDYxR1dWSjVFOXdHTTBkbU5aWTFjdm4vMVNleWhB?=
 =?utf-8?B?NnJQaWhQSE5pTXdqZzJVeE13UG5ncUNUNU5UM1FnWUJoMEhKbUljMWxGUzdS?=
 =?utf-8?B?ZUNoK01DaVljeEhob1RIRXFEWjdKZHpySzJkSngzb1A4UGovZmtwODNQMkFX?=
 =?utf-8?B?S043RFlOTVhCdEZlSisvNi9uVWNvV0tPYUJsc0R3Wmp1QjF3ejIrS25jUUU3?=
 =?utf-8?B?SDM3K2RoYlN4Qmk5SjJZVUhKMnhyeWNTdlBrL0Jka25Ydzg3ejNReHNnY1E2?=
 =?utf-8?B?M1R2d0pEOXlGbzRoTUlRT0FmNEdVRFJhR2k5bXZpSW5Da0ErbThYY2NsYWZP?=
 =?utf-8?B?MGk3aDJ2V1Y0ZURFV0c1L3M1T3ltczZiSVJhMGh6RzRvbnNGOGI3OG56Mi9z?=
 =?utf-8?B?S1VKcTR3Yk5zZ1UzUUNKVWxuZTNIU0lJWk1xNnIvOUk3YVp6dHF3T0pHdlRt?=
 =?utf-8?B?TnA3NWJjZmNmdzBTNUg0Zjdka2E1a3ZMWHU3NXJEL01Db3J6dGQ2TUlwMEtw?=
 =?utf-8?B?YnVtb2ZRbDBGRkdJWXI4Q2l6MkpvSGk0SEI2M0FvaDdVb0czMXZaWk5NN1hw?=
 =?utf-8?B?MjEzM2E4U0w4cW9jTXRKWS95eWFERlF2S21kUEphbUY4eFVhK2g2RW1sSTg5?=
 =?utf-8?B?VG9Kdk1TdGIxU2tOaTN0TkU5M0RDa0x0aGZ4cnZsZm5tODhRT0lLM3FISWtk?=
 =?utf-8?B?TFpUaU9ud01WR0ErdDdHbTVDUG5YNWh0dm1hMG41QjBzS1lNNC9wQndUb2dO?=
 =?utf-8?B?MlNCeXFneDlYQ2l3YURVWVlTY2dlMURqZTlMTWJ3U3hMTUpXTHB6d3VRPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(366007)(1800799015)(376005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?ZCtRczlxRmFvREh1QkVWdUtWNVozN2ZKT1NyanFsUE41bTJEVkYzWFNwNWlm?=
 =?utf-8?B?SkFBNitxOTJEWWdMMUVsSFlwTmRlUnZjRXJ6cFcwL1Nab3o2Sk0zNUVkcVYw?=
 =?utf-8?B?dVpYUzhmYlNDZ2dGcmw1V0JpS3pnalo0bDJ3OGVsOGs3MUEramJCdVRvMmVS?=
 =?utf-8?B?Wk5QTlEwcmJCRDd0d1ZPamdCS3ZldGlZbnpuWjlCV0E2aFFackd6bDREbGw1?=
 =?utf-8?B?SHBRdEliTFpsZ1UvSEZDV3BiQW51Q2VNeGFIVEtETVNseHpHQ0VFMEVKTmVy?=
 =?utf-8?B?eVlCSE55T081aVpxMXBkQmovZ2pZUWM2OG5LYzhFOU96Lzl3dlh3UkdvY09Z?=
 =?utf-8?B?b3RJS1I4VVFDOE5sMW1nWk95M0tDMC8yMkJHWnFLVlBmbmVLZ0xNVUM5VTgv?=
 =?utf-8?B?ZkNIakhwdjlkZlR1SmlQUlBENWhWRyt3V3dWNGxtQXFZYzMyL2NMZjdodFBH?=
 =?utf-8?B?cnFHcU1TSkNjY0loMGU4Mm9nQ09ndzlMS2VGYVE5K21jdUN5bmo1NWxka2wx?=
 =?utf-8?B?YkJnZzJDWHNUSkJJcU9uTmlJZzM5OEt2RUJFNjIxQ2liWHhncVFEUVRKYml6?=
 =?utf-8?B?d1ZpTjZLbXFVaUlUU25TamFybVUzQVlTam9YZGl0djVLN01MOEhsZXlsY3VK?=
 =?utf-8?B?NHBQMlh5Z1F2VWFuYm5ZSUE1WmlzcHZGaUIxeXgrMnhjNjIrMTdmU0ZvV0xy?=
 =?utf-8?B?U09sdWhuYUI1RW1SWDdvRjFyRXI3ZVIvbFZlT1BqMW5Dcm02UFdmRkFGY09D?=
 =?utf-8?B?cGFsNnEzSEt2L21pTVhQVWdmNnozbENjSlhwZmVLZjdpMHF5TG1jb09rVXND?=
 =?utf-8?B?aGdOU1hjS3UwTUdmV3V0QXdqRFpja29SWVR5ZHVOS3JRZUpxaDMwd0krT3pJ?=
 =?utf-8?B?Mk1ORmFrUlNURHlVdndMeU1nblpEblFTQ2dkWFdDUW9XblNCUy9USlRQUjZk?=
 =?utf-8?B?K3VsczBlUm5tTDNoRUNXWWFNTlRTaFVyeEFCVzVxSG9yQXA1MDV2VXo1M0sz?=
 =?utf-8?B?SkxsNDZmNFY3NXlTN3JnS0JrZC9DT0ZGMFdQZVNlZ01EZ1p0dGZLN0V3UG1I?=
 =?utf-8?B?YUFOOS8yRzhybm84N2JBK05uRmFockRReW5UcHFhL1VQKzN4RDNjZXlUYndD?=
 =?utf-8?B?ZFV4VVlTTitOU2pZamswZjVRSXZ1S3M0YXNTWGtPK1hHcnU0aEhjQXRZSWpL?=
 =?utf-8?B?OWhhNFhXemg0WHFnSjMxVW5xU1JoVVR0MW1pT2RvOUhPdFdlNTdTZ1VrR0Fp?=
 =?utf-8?B?VG1VNGg0Mnp1bEdIYWc3YzdVRklIL3NpaGQ2VElWSFNJU2d2dDhmMmZKcitY?=
 =?utf-8?B?bnI1cFpDZVRWdjAzcWpqam8yY056OGRVSk1NaTdhK1dSempES0VhdnJvOTRl?=
 =?utf-8?B?N2NXaXhpeEwyMllVdm1pdVNwYVJQRk9FTnZGemFHdFNTYlk4eVdQL0xiaDFQ?=
 =?utf-8?B?MHByVnVVZ2dvSjEwSkR2U1pZb3RpMmpwVjU4bDQrYzcyY2NIRDlMYml0SUtr?=
 =?utf-8?B?bmQrTURxbnp3UmhZZ0ZmTmNWWmRIVGFaSnhrZ053U2czWjdLU0w1MUlKc0FB?=
 =?utf-8?B?aXdHckpHeGk5YkljaVZTajh6YStEbElhQWk5MGwvWDVUb2R4a3pDV2tVM3Fu?=
 =?utf-8?B?RXBhOVllQnNTdTc5cHhFcnpVcnFjbFd5UmQzNVlPQkZJZHFjOHZ6dkdzK0JB?=
 =?utf-8?B?ODc4dFR6akU1OWNKYU5WNk5TTEJZZXFHY3o0ZTJpR1Q4MDhCeld0SmU5MEJr?=
 =?utf-8?B?NlBFWkVhbjkrKzhuUytxN01RMnlNcWZXdDBFSVg2QktmMkIyYjFleVBIUDRB?=
 =?utf-8?B?dExNSDVVS1M2ZkkrZHFxeXZXMEdEUnZDcC94a1hjZzY5eUcwZ25vVWJSZFlZ?=
 =?utf-8?B?N0lRRDFqd0lCVmROM0cycGU5UXdhYUQzdFhUeUxsVkhEblBYSVIzTTBPRmRB?=
 =?utf-8?B?bGxEZ1pRbGYzSGp5ZDJURkYrb0gxdjhGa3dpaTZyR0dybUIxTFJSRVhWcGZq?=
 =?utf-8?B?V2RyOVpObTRHM3VueVo4dzJrY0dlcFUwOWR2K1VoZC9ueUhYd1hhZEVSbW00?=
 =?utf-8?B?NDBLNURwSTNBU0x6M1dhbVZUQ1k1NnVWdE1OenRJTzZ3V2NNcmlQVFFXVStl?=
 =?utf-8?Q?p33WuXfTMTn+tAnXJ8SfdUkxH?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 817a9696-ca74-4bb4-077a-08dc78e410f7
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 20 May 2024 15:46:51.4357
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: onq2mOQWju0+B3QNqKAocH7tlGnV53xdPXy7tu06oJCEJW9v4z421trgwMkqDwwwEg4UbhF/qB7K2j4cPKkHdw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR12MB9455


On 5/17/24 15:30, Jonathan Cameron wrote:
> On Thu, 16 May 2024 09:11:51 +0100
> <alucerop@amd.com> wrote:
>
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> Differientiating Type3, aka memory expanders, from Type2, aka device
>> accelerators, with a new function for initializing cxl_dev_state.
>>
>> Adding a type2 driver for a CXL emulated device inside CXL kernel
>> testing infrastructure as a client for the functionality added.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> If you are going to keep Dan's sign-off it needs to be clear why.
> Either put the author to Dan and swap these two, or use a
> Co-developed tag.


Yes, Dan commented on this an he prefers the co-developed flag, so I'll 
change to that.


> A few drive my trivial comments.
>
>> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
>> new file mode 100644
>> index 000000000000..863ce7dc28ef
>> --- /dev/null
>> +++ b/tools/testing/cxl/type2/pci_type2.c
>> @@ -0,0 +1,80 @@
>> +#include <linux/module.h>
>> +#include <linux/pci.h>
>> +#include <linux/cxl.h>
>> +#include <linux/cxlpci.h>
>> +#include <linux/cxlmem.h>
>> +
>> +struct cxl_dev_state *cxlds;
>> +
>> +#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
>> +
>> +static int type2_pci_probe(struct pci_dev *pci_dev,
>> +			   const struct pci_device_id *entry)
>> +
>> +{
>> +	u16 dvsec;
>> +
>> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
> Add a line break somewhere in there as no real reason it needs to be all in eonline.


Sure.


>> +
> Trivial: Drop this blank line to keep error check associated with the call.


OK


>> +	if (!dvsec) {
>> +		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
>> +		return 0;
> Returned, so no point in the else.


Right.


>> +	} else {
>> +		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
>> +	}
>> +
>> +	cxlds = cxl_accel_state_create(&pci_dev->dev);
>> +	if (IS_ERR(cxlds))
>> +		return PTR_ERR(cxlds);
>> +
>> +	pci_info(pci_dev, "Initializing cxlds...");
>> +	cxlds->cxl_dvsec = dvsec;
>> +	cxlds->serial = pci_dev->dev.id;
>> +
>> +	/* Should not this be based on DVSEC range size registers */
>> +	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
>> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
>> +
>> +	return 0;
>> +}
>> +
>> +static void type2_pci_remove(struct pci_dev *pci_dev)
>> +{
>> +
>> +}
>> +
>> +/* PCI device ID table */
>> +static const struct pci_device_id type2_pci_table[] = {
>> +	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
>> +	{0}                     /* end of list */
> {} is more common.


OK


>> +};
>> +
>> +static struct pci_driver type2_pci_driver = {
>> +	.name           = KBUILD_MODNAME,
>> +	.id_table       = type2_pci_table,
>> +	.probe          = type2_pci_probe,
>> +	.remove         = type2_pci_remove,
> Add remove only when it does something.


OK


>> +};
>> +
>> +static int __init type2_cxl_init(void)
>> +{
>> +	int rc;
>> +
>> +	rc = pci_register_driver(&type2_pci_driver);
>> +
>> +	return rc;
>> +}
>> +
>> +static void __exit type2_cxl_exit(void)
>> +{
>> +	pci_unregister_driver(&type2_pci_driver);
> Unless you are adding more in here later in the series there is a macro
> to cover all this. module_pci_driver()
>

I did not know about it. I'll use it.


Thanks


>> +}
>> +
>> +module_init(type2_cxl_init);
>> +module_exit(type2_cxl_exit);
>> +
>> +MODULE_AUTHOR("Alejadro Lucero <alucerop@amd.com>");
>> +MODULE_DESCRIPTION("CXL Type2 device support, driver test");
>> +MODULE_LICENSE("GPL");
>> +MODULE_IMPORT_NS(CXL);
>> +MODULE_DEVICE_TABLE(pci, type2_pci_table);

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2071.outbound.protection.outlook.com [40.107.92.71])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AD02454660
	for <linux-cxl@vger.kernel.org>; Mon, 20 May 2024 15:49:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.71
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1716220182; cv=fail; b=kZ3+/aujJX84ZdUq9delQ4BnjNexB4873VO73MZjyuOGobQolgY4Y2HFXHOCnr05XUehgEct2KZTgWGbERT9fvI7ojGyLOjmIQ7Z3S3pbng7pmJ5hV/6nJUycfIRipLueSLQbbzZmnDI0qyQBu5MeD9/SMbiRCnPxKC6GKJb/Yo=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1716220182; c=relaxed/simple;
	bh=KtPz9WC3Em4fuLcP2btTbZA0O7Up+VNOXNDj9jfZH1w=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=TGKJajqxY6eKv7Qg+rvp3blUtdVIciW+YmiyvPlJliQM7Fc4ed7wEnUaLm0Jz95Y8efHvbedbACTATgfekXPmjd6Ib1etn8h16n0HjdUyYkhfvlKiI4BWMSD2/xvPDmw0HtYekvSkd21fpM92eIpeOp73uTNgZUBmpCoZHVCTJw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=GKD7Gkdu; arc=fail smtp.client-ip=40.107.92.71
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="GKD7Gkdu"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=J4uVk3rWY5GyjAhDswplxqhn/TizZHRNAi845vbZ3sc/242eYx5cOgf/8iST2QOnPFvMH0sxkOY55qBoTzWJH985Ctvgs0pEhehNABmx3xGtUX8KS8c769OnKM2AG25zZQdQY1nsR/cULXLub6ddPOmHvhjUX71dcbnuLcJ9GQpZzbgtfHKMD4NtWF3CzRabHxoa7Z9Ot/zW4c1DIjElEnYxEISH8Idby09aNalMTp/MtzZybwzSFZcnDB5gd63nZ322lkCsuyfJW8ScmNQ0eYaUz0Bqu+5em4X1P/xY+oxQDGecAUGkulqreaklWwRtAeocHuez5tKArp5Lg5srnQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=zktJKHCJyVoDjBsSNoEZkzIHjDIREMxcmfO96WuaAcM=;
 b=nME0H0ThBm9amiR7QbFd4/CZcaRaRt4GguVtUSYcBcHLUgeokPrKwj2txOFz3iFqXhOXOsyxwwnQsdyy0xaLVfEjGNNBpIpbKPAKunZcfPx9G+xzAedkfD1RhppzR1Ew7zseoiNl/kmNOcIMveANkeZM9kB2iYrmKppupqIDdGsh/1/fvM3KSBIyWcKtU2MnhrGmxw92hQ0E2QiBmu+r/oUicRgEm0g1ITdZDhR7f4qWw3Wcf8ZBlHtiaC1D/wVsspFAPKUZ2WTC5VkH9brGYGtH1/I4iX1A1v+cTIyWodoukxwt5KSdGVrnm035zkAXNVSbw6pyRSebkMTLg+f8Dg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=zktJKHCJyVoDjBsSNoEZkzIHjDIREMxcmfO96WuaAcM=;
 b=GKD7GkduQOYvPtQ8s04P+jlzC+2wID+YgEdBeLF4EctR8B5mFow3Bz0ltvS2X510T/wweD3HGXek7O8cunBNuk7erxEjxL+wsI2TD9p4WRiFTHdJepd8Siu9nw+xjBiYqNwA4tS4e4v0+IZbZyMobxchEwfLeJGKrqKrry9PmGg=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH0PR12MB7792.namprd12.prod.outlook.com (2603:10b6:510:281::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.35; Mon, 20 May
 2024 15:49:37 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7587.030; Mon, 20 May 2024
 15:49:36 +0000
Message-ID: <9f58faaf-a15f-c7cc-8248-67ea6b311a31@amd.com>
Date: Mon, 20 May 2024 16:49:32 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 04/13] cxl: allow devices without mailbox capability
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-5-alucerop@amd.com>
 <20240517153343.000066e6@Huawei.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240517153343.000066e6@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P265CA0164.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:312::13) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH0PR12MB7792:EE_
X-MS-Office365-Filtering-Correlation-Id: b8494208-bcf2-41ec-f03c-08dc78e47373
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230031|1800799015|376005|366007;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?UjZwRDdVV0hZdE1DQzhFbGlMdE85SlpTMG9oYjROVldodW1YVjdCbW10Z3pu?=
 =?utf-8?B?d2l6Y1ZyZnVGV1IrY3o2QVl4WU5TNFhBZ2FBK0I2blVqZndablhDOVAzM0V1?=
 =?utf-8?B?UHMzcUpLV3RMTzJ5cTlEaUxtWVdpbldOY0FyZDNyajRmT09mbTVNQm92Y3Za?=
 =?utf-8?B?RFRHZXEralNlWTdxeDlMNEpMRmdIbVlLTi9nSkFrWXVKZGJSdERHTk92WWVN?=
 =?utf-8?B?b1lVMW1vS1FRL1dRVnhwMk0wRStaUUVOdVNxSXE1TzR2NjdDQXVqU2dxc0ZX?=
 =?utf-8?B?TFIraTB1dWZvaEJhMVBQNDl1VDc3RnRESHp6eitCemZmWmVnM1dObkwwMDJG?=
 =?utf-8?B?T3JQcU8vNWZqbDZqM3BTbHBKZWdJNXp1aXRBek5xODdqMERSbXdsZ2ZuL3Ar?=
 =?utf-8?B?RlN3eUZ2cjVvTzdIek1NSVErdjhLeFc1VjNXdzFGNXUweWRZb1pvRHNMK084?=
 =?utf-8?B?ZDhVOExFZVM2R3dFT1dIc3R3cUkrREJ2dEZJbFRhdDIvaXluNlVtWnora3hM?=
 =?utf-8?B?VWxIaVNOWG9YS3JSbzhReERlUFA3Y3orbzNMTjVVQTE3enluaXZpWU1OV3kw?=
 =?utf-8?B?ZWgyM01PekVRb0lBWHZlYjRFRE4xaTN6cHl1WXV2SExjdXlLQ0U3WE1MaWpj?=
 =?utf-8?B?QnVzbFhkTC9vejdNSEhZWmI3L3JudjEwaVJua2JKOWlxK0loQ3g3WmpkY3o4?=
 =?utf-8?B?MW9tZXk0aURtK1U2dExpNXRRMWMrcWt2NCtkZ01YcjFPMzVZMjJwWGxkYk9m?=
 =?utf-8?B?NCt4czRuaXZoS2pnT3JNOXMvcnl6MkNQbWtuSWxrK3h6V0pGdVpHMVM4QlVp?=
 =?utf-8?B?V0lZMGRRSUFiK3hKKzRWN2dMc2dIM1RXYVZKNWxkL1lPZ0JXdjJDdVFJaXNH?=
 =?utf-8?B?VGU1d0dPSzkrcXpQVytTbisyaEtIMTlEczc4UWdjaGVJeGRFY1NEZ1NNQ0NX?=
 =?utf-8?B?eTg1UTBOM045Y2pXem9JS1Rwb2g4UllwMnlPdklVK29YdEMxM1F4bU85Rk5H?=
 =?utf-8?B?TGt3UWVIMmdMekU4NkwvclcvU2tBcmkwdHJaWkVDTmlHWTd4Q05LZkdsWXYw?=
 =?utf-8?B?K0xZdHV3Nk5NMDJDOXF0eWFJbFJrc1dHM2NJTEFmZDdmSnZBWjZGYkwzK3NS?=
 =?utf-8?B?SEZuc2VKa1ZWUUNHeUZUWC9tUHNwMERaRnlRZWNFWktTeG9xNUtMRHpmL1Zn?=
 =?utf-8?B?aUZ4WGRvaURtTmEwSTdOUFhvQjgyMGJXM0NoWUtSa1hQdVlrdlU0R2RHbnB2?=
 =?utf-8?B?WHNjNmNJc1Y5Tm9yMTJsd3R1cVM3NXJ2dGI4c3F0MjIvMzk1WFV1dndPMG9O?=
 =?utf-8?B?Uitva0FxMkdOTEJkNWszNmNMSUE5T0IvV1ZadmlmaU5wYlltRStmeHpJMUs3?=
 =?utf-8?B?eU5OcDhVVEkwMndwUXAvVGl3cUVNU1RMaFY5bHZweG5WbTZmb01pcmhoRUhF?=
 =?utf-8?B?UWIzcENRT1haTy9JZjFlUUhGMGt2Qlp4U2M0OTR4aGxVMmN5K3B0ak8xdHBm?=
 =?utf-8?B?eGRjK3Y0aWxPM29VMUUveVNFR2hxa3JMZmFXSVRwRk81TjlrN1ZadGsrZWgx?=
 =?utf-8?B?cC9TUEJXVjIyV0E0NmV2Sk5jQ2p6VGZQVnJiL1RVVXYyNXpjNVBHTVEwUVo0?=
 =?utf-8?B?cGk3L21lSHdBQUlPbkcvUzhkRFJ3cXVoNTRLcHIyVVZjYkhoOWlFVzhqZnNI?=
 =?utf-8?B?eGVwVVNkalNYVmRXSUVQcFNsbjZtSnI5aWdQK2dTdnFTVFcvSlROSTdRPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(1800799015)(376005)(366007);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?b09XUzFNVVVDYnc3cVg4WW9OOG1VdDFaRVFSN1V3em5MbzI3R2NON2hWR2Jl?=
 =?utf-8?B?eDhXM2g1ZzZpVzd0K0N3Uld6RTlKdzV3bkNFeEtqTUI3ME9Tb3F0Y0JERVpN?=
 =?utf-8?B?djRvQXVOZWxoTjdrL2RIN2NsQ1E5Zy8yRUhSVFNoQVlDLzJ6dHY1eTVLZ3B1?=
 =?utf-8?B?RFdqUkUzSWo0bm9GSGxqYjFCZFlLNzNJd2pGMjFJc3gyNGZ1djIzTkIxeU1n?=
 =?utf-8?B?Q2NNeVJsQkNsdW9Iem9lUmthYkk2cXE2TUVOS0xMMXNqc3hVbjY5Qjh1eVFT?=
 =?utf-8?B?MnBYaE9hZWF6UXVXT25MSkNTaVpNREkzKzRDYTJDUEt3UUFETFZGMG5VMjRF?=
 =?utf-8?B?KzJRbzBlR3A0NWtUaVNTVG9mS2NEYU41VWd6YWhoWVB6cE0rak5ySHA5K1Jw?=
 =?utf-8?B?akQ4UG9XTFlPZ0ZZN0oxdEVodGg0MG5KWmVtL0ltOWEweTcrZjNtQmg3ZnQy?=
 =?utf-8?B?bDNmbGEwQkwxM2FzUXRETGlJZW5GOFJhQ0RSNnVYRjJoVStaTzl6OHAzWUla?=
 =?utf-8?B?VmpkUG93RzlDTTFyd3k0bGRjNXBodC9xVGZZZFl2UWpraEhvNHcwbWVHdGR3?=
 =?utf-8?B?VXNWb3pFUU81T2ZzVUxZOFJjejVMK1p6UE11Nm90NHVIWnhyaWNmQWZyYklk?=
 =?utf-8?B?c2RYN1czR05IVkF2bWl2dVJVOThmWTJvSzVSeVhMMTc3RHJPOW9QT3JOSFpv?=
 =?utf-8?B?dklWa0VHbWZoRXZsK3k1clNCaG1jdjRlTnU3MzZwRnhNWm5XV2lTanR1ZUlX?=
 =?utf-8?B?RVJ2TFRYTE0rMG8wNEZlaGhWdHpkV2lTUEFKbFlHbkpIQyt2dkVsK0kvMFI4?=
 =?utf-8?B?TlhBQkxlc1UrN3VpNFhDdEhoNnFVemhBc1hsOWcreGpkcTJBUmZuQkc0cUdi?=
 =?utf-8?B?RjVFaGlldWMrUjBEN3RYZFhVNHE5Nkt6ZElDOHhjcVkvS3ljcy9zYkxqa2pP?=
 =?utf-8?B?d3N4VmcyOHZ1S0tzdHVjR0tSb0xKenF1cC9CZHArNnNoOWJGZkVqdzhoVWVi?=
 =?utf-8?B?VG5wRFkyZ2NMR3hPMlRJejA1QUNiL0RQWGthQXNhOTN0NU1leVFvbkRzK2dS?=
 =?utf-8?B?RGhxallDdnBqVzRURlZHQWVvMy8raTVpYUhlMGtDZS9xOUxoQWlqNDlqdEt4?=
 =?utf-8?B?UVlheDlhaVlSNklEdUM5U2EycTNCMnNtUkJCVFpMM1I4by9PY0c1YkIxQWdx?=
 =?utf-8?B?UDNkSE5CNDdwdXgxbk1LZk1TVkZvdEs2NjlMeHNHcEkrWVBCbzlYNWZ4WitQ?=
 =?utf-8?B?akRtUDJvSHRQMDlIMTE4OGVlZ3ViOGRZZ0l5VDFiZm5ZdUtZdTBMR2liU2tI?=
 =?utf-8?B?d2xhczh3cHFldzdTVHl0bDEzU3JmMThGVHRhTEF5aVFiT0RDWGVPMTVqMWF3?=
 =?utf-8?B?aFFBZG0zU3pzT25NK1d4VnJkZXJhRzZmZkVrMDlvZEw0K0llaHJKcU0vRDI0?=
 =?utf-8?B?K2Z1UERiWlEvWlUwcFlEQTBrU3pLc1RIUTdIZnNOaklXWlBubFhsdEx2ZHJ0?=
 =?utf-8?B?dXZTTVppMW52RTFjZlkxVlM5TnNtRFNaV1ErSm82YWZKYkdQaXZjWGFoSUFl?=
 =?utf-8?B?UHBuMTBYazEwYkRxQVdjNWhkSTJFNTNJVjBFamI3OXU4d0F4ZThaSlJaazIw?=
 =?utf-8?B?NUFYckErZ2IrdFJsUlRqUnZIZHBNU2plRGdqUy9YL1dnVDFQSVpMSkpqaEVU?=
 =?utf-8?B?MW1sejZvL2g3Z3BJczkvRXhtenh0d2R3TXg3amxNblhRZjFETnNIOGtqQWlq?=
 =?utf-8?B?bnhEVWZ0MXBJaW1lZHAvR0d1R2FIeGNVNzU3WFgrS1lyR0RHRXJhOWZnSXdn?=
 =?utf-8?B?WTZLaGxuSXdsNHRZb2h1RjNKQ3lTc3lxZW01eXE3UkF2VDhsTUkrRVRhdWtJ?=
 =?utf-8?B?dGFhaTBqR0gvYlErK1grQmswdkxuNkhQMVU2Q0dVZ0tGcVRSdE11RzF4WmR6?=
 =?utf-8?B?NmxaUFRBZjEwdkQ0RzlIOTNyM1djeWFWU0h3Nmkvbmw2R2ZvMEhiQ3A4TjZU?=
 =?utf-8?B?SG9PbVFhK21HdnByZng3OHpSVkpKZlcxM3ZXbUlNZStid3gzQmhWZ3ZNZ2pP?=
 =?utf-8?B?VVc4VEMvY3duZENqb2RHeExvdUhZa295QU4vUzcxT0VzOHpYcUdmb2hQUnNI?=
 =?utf-8?Q?Yu6gKnZCi8UAzkH+ckTIFzrAJ?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b8494208-bcf2-41ec-f03c-08dc78e47373
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 20 May 2024 15:49:36.6583
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: zmAlCTIRzTjLVB/D3ALF3+9gtwWP0XcOiMXW1StkcLsebiFRG9AXIiuvz9MbGOpH7Ce9GTt+VKqlg4XTu+D31g==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH0PR12MB7792


On 5/17/24 15:33, Jonathan Cameron wrote:
> On Thu, 16 May 2024 09:11:53 +0100
> <alucerop@amd.com> wrote:
>
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> A device not implementing the CXL memory-device class code, aka Type2
>> devices, has mailbox capability as optional. If the device registers
>> mapping does not show such capability, do not treat that as an error.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> If you are removing this check from the shared code, it needs to be
> in the more specific code, or you need to state why that isn't
> a problem (i.e. it is caught later anyway)


Yes, I realize this is solving the Type2 problem but impacting on 
current behavior for Type3.

I'll change it for doing it without such impact.

Thanks.


>
> Jonathan
>
>> ---
>>   drivers/cxl/core/regs.c | 5 ++---
>>   1 file changed, 2 insertions(+), 3 deletions(-)
>>
>> diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
>> index fd165e718cf2..5434a7c899fd 100644
>> --- a/drivers/cxl/core/regs.c
>> +++ b/drivers/cxl/core/regs.c
>> @@ -437,11 +437,10 @@ static int cxl_probe_regs(struct cxl_register_map *map)
>>   	case CXL_REGLOC_RBI_MEMDEV:
>>   		dev_map = &map->device_map;
>>   		cxl_probe_device_regs(host, base, dev_map);
>> -		if (!dev_map->status.valid || !dev_map->mbox.valid ||
>> +		if (!dev_map->status.valid ||
>>   		    !dev_map->memdev.valid) {
>> -			dev_err(host, "registers not found: %s%s%s\n",
>> +			dev_err(host, "registers not found: %s%s\n",
>>   				!dev_map->status.valid ? "status " : "",
>> -				!dev_map->mbox.valid ? "mbox " : "",
>>   				!dev_map->memdev.valid ? "memdev " : "");
>>   			return -ENXIO;
>>   		}

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EB99B64A
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 04:27:44 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.10
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718166466; cv=fail; b=oKckp/zUHTZKJ3j1UXmBp1W4klWBygF6lJm4F78DJjVXjLP6Ma0oVIvjbLZcmj693kSV82tcgXsXAq7ZktgmM+yHflWULVrhto/+/IMTTWVMkKnvUkbPg727Asxb1Z/HtPd04jHKO8LGSbJlVQZo0VH/mpfb8uMuT/ziPisBeu0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718166466; c=relaxed/simple;
	bh=o+M60vKXdFt3AJ3BXe0INCoeXA4O9SeM6gX8HY0FhtI=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=PVnqGVRO1s48CR6BpzF5hcvTxKv30hHj8D03rRqF4lEOibb9ekTPh414PNTDB9i9vqDDKpgUaqzHRcn/m6cdAwvWdHUoKnIcVsDhsv6E6dL8xNrW+HsAtEh4vja0OqmBp5q6Z6cgpWHUqniMwps0WiPS2uSeTw/A66MELbGDVEY=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=RhZsb+Yb; arc=fail smtp.client-ip=192.198.163.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="RhZsb+Yb"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718166465; x=1749702465;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=o+M60vKXdFt3AJ3BXe0INCoeXA4O9SeM6gX8HY0FhtI=;
  b=RhZsb+YbL/lirV5wWTU0j96RrxBfGjLZJhQBwBNw8GT1Wpfcfnz5Snip
   CMGQroofGcgE1Jq3EfJe/1lA0NiyCecgFFEjHT8q91RjepWXxSyJNRNLZ
   RcFtizhqazebc70Y7Lw7R/azbCkeJq5/SY+2qnjGdTEtAw/fD9H5dJs5S
   xbKgtRb+/IWeZsFedQTwRKfhbyDQh3oJXeFKD5pLV5rM6yaFn1j4zHp81
   oE+rypttvtl3VADUJuMEKSrcIabGFAeYPD08riu2cmGWDdhpDqDYkztQq
   xQu1ddXPiku/cfgHDD7cXgptK1p5bt2809g+B1aLFwZyRNu7/qV4vQ5ab
   g==;
X-CSE-ConnectionGUID: 4pocnrqNQ1aRm8a9gCi2hA==
X-CSE-MsgGUID: wgPytuSKR4OMxaT1b2Ab7Q==
X-IronPort-AV: E=McAfee;i="6600,9927,11100"; a="26319708"
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="26319708"
Received: from orviesa002.jf.intel.com ([10.64.159.142])
  by fmvoesa104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 11 Jun 2024 21:27:44 -0700
X-CSE-ConnectionGUID: 57OGg0wGR9S+kZ3Rzpdw2A==
X-CSE-MsgGUID: gDZsOvVOT/WrMJDrnBw8pw==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="70451212"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by orviesa002.jf.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 11 Jun 2024 21:27:44 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Tue, 11 Jun 2024 21:27:43 -0700
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Tue, 11 Jun 2024 21:27:43 -0700
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (104.47.58.100)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Tue, 11 Jun 2024 21:27:43 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=LLUeY0JSWzsWJDu7mFRkhMVZIfOJeHq4q5b9cryFVJU0dtLquZNBYhhw27VK6G/L2X01YGTbRFA2F0asPHc0Xk3eW6iIYEfrcMbH7U/Y9b5N1mpOGNOUBwHR+fCHL49shNoNRPKdZWxPKiIHaYQ7Dst5Y2ne2KsSEg0xjzeIwtkw9JyyQQjxTXPEcHIyUsH0v4H7R7Vy1ITFuHvgC342mnIKBZJ8QOnE8pfLzImZ15VyZUqoOrqnX2Ct6tpoN2RsRUVl2Jl4sl6NG/CROHvIR4ELi/O/dYTIQeOcxu/OXcSvDfY/PNsAkfBxzh/t0uZa2FIaood2yv/g81Hdt50FSw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xtPRs35SLrxlHZvCiNVr12JWNwPPzXdoleFhEZ/QdBU=;
 b=VeKa51tFzYecSQihDcgUE8QD2biCgbpIuYGy7ZDUGZf0dXtp0nl69oCTNo4KVNUYob2chFWrXXbEcPrBFBTYJ7zPDzqCDLBK5R2pjPOib1uWOWbP8gX3CrmJMWj8XFASM460g+muK5xw2JYZM3LD5bqzgBXXnbc4DrzpN8Bs20qzcAXGNEYgHVMbGoOa/TFGSGXosSdrVnEApiGtvH9oB1ddTJemfftXSGMRqvsGU/6tqASchxs+PZZdaUSBDMarxN04/eLQR76BAb63Npll35HfDpKC0//1qaU0oLxNUUOVNb+eYqmq8cnV4ZDLYi+uXkmi69SXg4fff3yRjTyxeA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by BL1PR11MB5224.namprd11.prod.outlook.com (2603:10b6:208:30a::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 04:27:41 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Wed, 12 Jun 2024
 04:27:40 +0000
Date: Tue, 11 Jun 2024 21:27:38 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<dan.j.williams@intel.com>, <pieter.jansen-van-vuuren@amd.com>,
	<richard.hughes@amd.com>, <dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Message-ID: <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20240516081202.27023-2-alucerop@amd.com>
X-ClientProxiedBy: MWH0EPF00056D17.namprd21.prod.outlook.com
 (2603:10b6:30f:fff2:0:1:0:1b) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|BL1PR11MB5224:EE_
X-MS-Office365-Filtering-Correlation-Id: 99667566-b21d-47c9-3d98-08dc8a97fefe
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|366008|1800799016;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?r8lYrCfuuVho1T3uRK7lri9Qhf8QNNwjCPjJl4c8Bod091tbulEEhpc46qnR?=
 =?us-ascii?Q?qjar2RggGvJ8vphy2DomX/q3j2KU0/hO0YoO4orWC42rLHfvWH9ockkAHsxP?=
 =?us-ascii?Q?buI3k/6N14u5ug/Pr9Sh75zKA+RsojFcdtNttw0kjzkLO9EFkcEqT+PL8Sic?=
 =?us-ascii?Q?HBBfhtVJYcjE35yJ5LoEG8MdapdsOIfwTtqW4YmadsnNzBs4pPzuaJ8Vlyb0?=
 =?us-ascii?Q?jZW6VSbkuI0IfzhAHzRDLYE8u9lSlGOOHa8uHDE1UcYukSqJV+QGPYxgxwy0?=
 =?us-ascii?Q?nlX/+WJpX1JmR0pFVSb3KefsQMjMjLMRgwVzx37uvIWDouyZEiGGY1FKf/oe?=
 =?us-ascii?Q?7Lrbqz7OPXh0M/VPlAJYLsYXKqmPyj+LKUkQf8vIYuNjbDN2M0RLwdcLDSqe?=
 =?us-ascii?Q?yKr93aOv7eOElQ3mO90b3FU5OOvUNyd4zEzsQe/HnHbau/rfeNk6MGbLB+LP?=
 =?us-ascii?Q?c2ENyY8OoF1TJO98hoc5rdiUHNy7vM330/FB/5z7mgrJ6YdOr6vgrk/c3CxK?=
 =?us-ascii?Q?wX93l8TkY185/fhrR7P4z0agYSEC6PMtTX48aahrvB5bMyYu0UlBhGECwFfK?=
 =?us-ascii?Q?eZzDkjiufsLBBPvRmRXOBdbZpaTevuF07aZmVPRiCzf779HTamiVClW1qLFy?=
 =?us-ascii?Q?Agrt72aTePGM8unM5Oj2feoHpc1nWcld2KcdhV5bESmxjsKMW8xbMCctx2B8?=
 =?us-ascii?Q?3SlIoyksltx0E1BZb/bmGhrAbdF1ipq5fZ4Br//c7KUaVvz13C9zaYR5FJ4W?=
 =?us-ascii?Q?0CER3r0vxAfMvuaxY871n2nDjxjFrVE+OqnyglgMR0lkWEY4C44Ky3jQFL0O?=
 =?us-ascii?Q?ACwUeAC4jtQ9lh9KOktxuxw3YjFvvfPickgaAa8OjGToB2O+88im+I7+Ma2p?=
 =?us-ascii?Q?3Fs899gGqKT1nAyTT7etYFoL6VThNmhnSHQAj4oopYdJDZ3GlWqFHL9G1i1s?=
 =?us-ascii?Q?CTOLmbIu0WzYBCtkFvE3WHoi6GjpGxQuTM6Cx0bPAcWCGZYwTLTUAQvloG43?=
 =?us-ascii?Q?vBRBbFTYMIy1pp/sAu/qtq5kjn6d51BN6Q96+i0GilS8MLP8I0Kc/+fkrvfH?=
 =?us-ascii?Q?5eyBe3iS5McD+sVFDr8HlMjUvSSZdRUFFioxGTmrBkdf4ZjRlVqHisuaOgxn?=
 =?us-ascii?Q?Op0UYQozIhndPLDcto5H6l6G0JaT5nMkuSMJwOuHTFV6owHREe1t8hcIQ4m2?=
 =?us-ascii?Q?Bmv9U50DF0TwUJ7Iikk6OEO5pJ3m//rMdH4ZjS4GnrWQZQO2B2huMFrkMK5g?=
 =?us-ascii?Q?b9/a5if8TYdRjYB0FrrJMZrfL6kgGs0xQJTIciTpo4VIstLUXnaNYSh67ti8?=
 =?us-ascii?Q?p+c5HpcfVvFJbvTA/nLR8szB?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(366008)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?d0W3MZ2BMXPVoUllDuhq3raRjp+Z6dznKcQKwrUhhFSjKkIPoslU5cD5rV8F?=
 =?us-ascii?Q?eO6FkWaCUhAkydPLjkDQxpW3YpD/7+ddvp9LKUy5tF78WioqFOvTRj7Ou6Ye?=
 =?us-ascii?Q?yOc75dOVHya32CyHW7oRM6EcvcmKAp2prDX5dCvoaJ3zhE+RRV9TOqs1WEO4?=
 =?us-ascii?Q?90GrClGgYGytWbHJdQmJz12Sd0u3pbVPh9E+gybIjtpkLRxxYLU3sLuSj4Y3?=
 =?us-ascii?Q?6qywFtVteHz7jVUZfyErM1OLWF/78O/WhOjsk4jage5wZF6BElWMKRcCoMuj?=
 =?us-ascii?Q?Ge8RmwNgti2dpA0Oytlqk8pdNJx8TNUjwKXFdKigpfovBbIpfq/sELfZrp0Y?=
 =?us-ascii?Q?f5WesMnIG70w/O88cc1OBvhS6gUAJNSGAuSVv3RBkYDfUaM1djwkKGpeTCj1?=
 =?us-ascii?Q?UxdePUIESOcKTVO8G5f4b6qV4/x08l9m0N7B16urH+ZXzfqxv2pBrcuKcp35?=
 =?us-ascii?Q?sRcbX61/Y6mVy8GgF9dbBsYEO+/LTWJQF++VplIKaDZj0EqXHIBl5uWyd2wW?=
 =?us-ascii?Q?/QU2XxBpkg3oTnAqpte92UyAwTk7hSzHLdaQBAcrMSSebQ5E6SEXPm0EBVI5?=
 =?us-ascii?Q?ZyUh5qjawTzXw0tGRk1w6+JepvUOy6q3nLKJPbBOlRwkZ/kzvKbaVmG8sbwR?=
 =?us-ascii?Q?q92P+5+Ls60J2lLvGLyso920CL/Lr4Sq/CoXwP8S3Y39wE2CCedwH0u1R5us?=
 =?us-ascii?Q?pKJ3DGSAhf1CGcQrrxg7L0CvgjeWHkGGlGNy9vTl2KIeCzRiK5WNwuAqPIo4?=
 =?us-ascii?Q?BJ6uP7zR0LaT/LC24lO05f83/U9Khsmt56EVXUUPhRhDQ7hhtLv7wPqJHy/M?=
 =?us-ascii?Q?C+VmbTKA3yLsVGgKVSf1dUskLbpotDim7eS+rVFSwCWuxHfc0b4Ok+VyM4ya?=
 =?us-ascii?Q?m33oGE4ht4TJbvnZ8nlUlLWbo1k77qbvhGElMIG/Pu9vZTS1TzL6YXu+F6v9?=
 =?us-ascii?Q?BvxBCqZCsK3Kexr6+3caciriFoA6BN04SQNEzr/qvgyz7Cqm6ACT8TF4hCP7?=
 =?us-ascii?Q?khDeN8XyeYBfuC2QGcWA/dMvsBXxv2gY5sxQu3UpARdO6CfoFNMFgBZkEBBr?=
 =?us-ascii?Q?IK6ISISYAvy9bmNwUWlBUI3fQj/tkvAY1BT09D8uxACPHpP1GQ/a3KLiWKCR?=
 =?us-ascii?Q?jbOMkoovWWstPzWaeQ8ToVQjg/KNFmaNtjzKjoghiDOmGEmtr4j4uZauF64g?=
 =?us-ascii?Q?UWeaT+2MOAcBX4xhYvjPx5leRiAjbLgIyiLbkRlAulBkZNqAJdVu4axkiBWx?=
 =?us-ascii?Q?EQWCxFWju6uQph8blDmGpWwsFokSj+XEpr567q6UiUggWukfajujWnFpc3Va?=
 =?us-ascii?Q?pz2quAzaQfeeURRnD+sXKohzfjLZMWphC8CJQAiEKOQ6/n1WyIpvA5dTF14c?=
 =?us-ascii?Q?uyLqat1rqgSFe2V9sr3tKSD7UbNkotkzjMNQrK0PbugOh4gLYhXxcxVvKiyq?=
 =?us-ascii?Q?koGu/K2BR4WbK+qz3XB+Ewy5NRyIUUmvzZsF8+biBzYnUde6xYmhMI6QTUAo?=
 =?us-ascii?Q?z5MxLmCh8VuP9QxAQ5F1Ntt7ZcdpJdkZCtJ66Cvu+bzknOS6SJBOc8f4Hr+o?=
 =?us-ascii?Q?u25tTs72eGtYwzQRecdh1TMrIG71VpTrk9nX1pcElsUKFEmFN3L8bfItTmUK?=
 =?us-ascii?Q?OA=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 99667566-b21d-47c9-3d98-08dc8a97fefe
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 04:27:40.3809
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: Efp+HzzSXHJACqJmi1kIEDZ6eMvQybYPNnfV92ZcFQlqelF7k5Wx0a06fmEIZxs00Y+rGh/2zM7OMtTa52Fe6iH/ZfBAmVslUypZQWv4s+Y=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR11MB5224
X-OriginatorOrg: intel.com

alucerop@ wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> CXL Type 2 devices imply specific vendor drivers binding to those
> devices instead of generic ones offered by CXL core like the PCI driver.
> Those drivers need to use CXL core functions and structs for
> initialization, create memdevs and create CXL regions.
> 
> This patch avoids referencing those files based on relative paths from
> inside the kernel sources tree.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/acpi.c                      | 4 ++--
>  drivers/cxl/core/cdat.c                 | 6 +++---
>  drivers/cxl/core/hdm.c                  | 2 +-
>  drivers/cxl/core/mbox.c                 | 6 +++---
>  drivers/cxl/core/memdev.c               | 2 +-
>  drivers/cxl/core/pci.c                  | 6 +++---
>  drivers/cxl/core/pmem.c                 | 4 ++--
>  drivers/cxl/core/pmu.c                  | 4 ++--
>  drivers/cxl/core/port.c                 | 6 +++---
>  drivers/cxl/core/region.c               | 4 ++--
>  drivers/cxl/core/regs.c                 | 4 ++--
>  drivers/cxl/core/suspend.c              | 2 +-
>  drivers/cxl/core/trace.c                | 2 +-
>  drivers/cxl/core/trace.h                | 4 ++--
>  drivers/cxl/mem.c                       | 4 ++--
>  drivers/cxl/pci.c                       | 6 +++---
>  drivers/cxl/pmem.c                      | 4 ++--
>  drivers/cxl/port.c                      | 4 ++--
>  drivers/cxl/security.c                  | 4 ++--
>  drivers/dax/cxl.c                       | 2 +-
>  drivers/perf/cxl_pmu.c                  | 4 ++--
>  {drivers/cxl => include/linux}/cxl.h    | 0
>  {drivers/cxl => include/linux}/cxlmem.h | 2 +-
>  {drivers/cxl => include/linux}/cxlpci.h | 0

So I don't like this approach, there are details that are private to the
CXL generic memory-expander use case, and some that are suitable for
CXL.mem and CXL.cache capabilities in other drivers. That distinct
subset should move to include/linux/. I.e. I want to see the incremental
conversion of what 3rd party drivers need compared to the generic
expander case, and consider when and where new shared infrastructure
needs to be refactored.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from bombadil.infradead.org (bombadil.infradead.org [198.137.202.133])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4D3A163A
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 04:30:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=198.137.202.133
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718166635; cv=none; b=upIsgxB4uRE8anmaxaMfFVzmtt/KUBQF4CIZYs0szURh7eC6hLFBq9lEwLFTFj9Xnpk5dbXeCFTwtBD43QO1KrS5oF645WzdASD3kC+IUjPsSLhHeq/u6tlNPyNgKCWT7P50UxXMEMknb9bQuxJ7ZZOsIjYX8+1GEEYEn2rvtYw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718166635; c=relaxed/simple;
	bh=dK72FwHyVMrflsfHx1wc5rgKt3Z3l8KFGOARjGjv8WA=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=bSohPJoeDXPrdPwqz9SnBn7T6HyFaSDhciFlLLdjvb2A0RrgzTZ/EYYnMdoM/8/SV+OsmB7iiPdTinAtHjmALSpHnorLJkSDlToZYEdsJsOZtHZZZC8LU+sLQmQ8g8fSkuBCR2fYAePcq/gFXEpe3huxMjbyD+YrtMiZsME0pec=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=infradead.org; spf=none smtp.mailfrom=bombadil.srs.infradead.org; dkim=pass (2048-bit key) header.d=infradead.org header.i=@infradead.org header.b=rpqY5fqx; arc=none smtp.client-ip=198.137.202.133
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=infradead.org
Authentication-Results: smtp.subspace.kernel.org; spf=none smtp.mailfrom=bombadil.srs.infradead.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=infradead.org header.i=@infradead.org header.b="rpqY5fqx"
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=infradead.org; s=bombadil.20210309; h=In-Reply-To:Content-Type:MIME-Version
	:References:Message-ID:Subject:Cc:To:From:Date:Sender:Reply-To:
	Content-Transfer-Encoding:Content-ID:Content-Description;
	bh=lpHLTbGEf2GHRqyOnp5pYAE5eGXcckxXB3/QJ/GB9Es=; b=rpqY5fqx+nK4j7xTuJMIIYLJgs
	QrlA8awwA7XjljjyrT0NAI2Ltn69HSlUNdlXR+abRS6YhfnUo2FwJVGsbj1WAC7qhikxVoiga21F3
	6rZ6t+6UbKwb2RkpzhAazLlJ4Zo+KzF6iBu9cdtv/jhqFRvQ2mF+WNDrllRmvtCzumBjFFUgD67+d
	LxABar1JoOcVWkj5M0pHT4X7pV2mD8qdFxTxtEqW+V2v3+tD3KXzhyJC6LZmWGhUS4WgOvI/RAPt6
	/wzFia+lQH5XFG7OWnviR800dgwn+m6HRZq7+rE6SMoldFv3vKQ0xojFwJPjoNAxi19nrmP5/rPrW
	+rnlUtDQ==;
Received: from hch by bombadil.infradead.org with local (Exim 4.97.1 #2 (Red Hat Linux))
	id 1sHFd2-0000000B1k1-07aF;
	Wed, 12 Jun 2024 04:30:32 +0000
Date: Tue, 11 Jun 2024 21:30:32 -0700
From: Christoph Hellwig <hch@infradead.org>
To: Dan Williams <dan.j.williams@intel.com>
Cc: alucerop@amd.com, linux-cxl@vger.kernel.org,
	pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
	dinan.gunawardena@amd.com
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Message-ID: <ZmkkaOTUFuzIr2cG@infradead.org>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
X-SRS-Rewrite: SMTP reverse-path rewritten from <hch@infradead.org> by bombadil.infradead.org. See http://www.infradead.org/rpr.html

On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
> alucerop@ wrote:
> > From: Alejandro Lucero <alucerop@amd.com>
> > 
> > CXL Type 2 devices imply specific vendor drivers binding to those
> > devices instead of generic ones offered by CXL core like the PCI driver.

No, it absolutelt does not.  There is no such thing as a vendor driver
in Linux.

> So I don't like this approach, there are details that are private to the
> CXL generic memory-expander use case, and some that are suitable for
> CXL.mem and CXL.cache capabilities in other drivers. That distinct
> subset should move to include/linux/. I.e. I want to see the incremental
> conversion of what 3rd party drivers need compared to the generic
> expander case, and consider when and where new shared infrastructure
> needs to be refactored.

And I'd much rather keep all these drivers in drivers/cxl/ anyway so
that we can keep a tight control over them.


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A064028DB3
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 04:44:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.18
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718167444; cv=fail; b=mc7BoG+XZOWP8W5G8tsOMYZ2jez0z5oNsaLbeYHIV1YMSwILCmy6qsu4gppgC8QmHXJ+kzWhBP/AHJf5whHgbCRyVl+x4fh7j5Tzloz2zIae71ucLRr5gIp4AWrgWJBIrFI+eLlKn266guWwx7ls6IdxdgQGEHGupxlXMfTxlVk=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718167444; c=relaxed/simple;
	bh=bMgHY6EhnvekE1fx6JgkbgJSrJrO/sJfBtaVqxHhnus=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=UT02cC5dtdSzlwmtdIzeSIIJ+PZizjM2RvHIyvgDFhIl46lMNyMtGnS7SQVoQSvbPHblvDPodr0qi6r8YWCv6VRDoBk6nUuLzgPvACFP0i7APtPAvYHNbScZx6sE68gVYlOJwSc5u989UGjY/HvYK/6zSsJU4TEpf6/+MzlX7vI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=jV01lozL; arc=fail smtp.client-ip=192.198.163.18
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="jV01lozL"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718167443; x=1749703443;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=bMgHY6EhnvekE1fx6JgkbgJSrJrO/sJfBtaVqxHhnus=;
  b=jV01lozLJhV/lQfnIyukrXnD+Rld5gwnKwdMrbiiCG+gzsQ3J7qwS2SU
   8qJUlQ9MMQPIL1XpLXXIM+Z/bR9egH1zT0vSlXRpejAANF89ZaO4wjl+o
   MCpgZp72Pf2gcBMrt/48nTna3fj6iSe8Tz/Z8akubJuKuuaHOXtNpolp+
   Kcacwg/25RUO3pq4lo/CTWcFaWYpkaQDx/ydW7pXILkGS44vecmhXpgjZ
   9IyGXOEnfdPAzxcfRxqwAh3WcpKWACqF9A+me06NtsY3INFK692MFR3kW
   buUi4c1oGxqvCZ7pf05fd9knF4HwnGUq+TNepp7HcNeU+yHsRUxihw2s/
   w==;
X-CSE-ConnectionGUID: qv7xxHh5TsCqrZrU23nYfA==
X-CSE-MsgGUID: jC3EZ7gaRpWgwBS3hyWnFA==
X-IronPort-AV: E=McAfee;i="6600,9927,11100"; a="14636540"
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="14636540"
Received: from fmviesa001.fm.intel.com ([10.60.135.141])
  by fmvoesa112.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 11 Jun 2024 21:44:02 -0700
X-CSE-ConnectionGUID: ipi1/glLTtmBa0Wrr98Njw==
X-CSE-MsgGUID: /8LnEfvyTKGV6OveuVs5QQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="70859498"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by fmviesa001.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 11 Jun 2024 21:44:02 -0700
Received: from fmsmsx603.amr.corp.intel.com (10.18.126.83) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Tue, 11 Jun 2024 21:44:01 -0700
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Tue, 11 Jun 2024 21:44:01 -0700
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (104.47.70.40) by
 edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Tue, 11 Jun 2024 21:44:01 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=odtMyh69X5Msi5BVx32lT5nUnYjfXPJKESlz8Y7Ccw9EemrJIhLbYKVJ2ccSIJNSSSA4cfKhFGRKH8zn8NIIhiOknz5NH0FtRaGfZQMirIfUfKuN+RqJe9YaX2jOFEp5jK08nGhnT1ZlNzDBymsK+c6vfRzstRXdrP+63F6ziTNFsiLeOCizX+Nq9/+HXrQ0/5ZsbfPTnXhVo5uWKzKIz9NMAefNWeDKAV6gwbtUbJY8J/5AxEnE2Ea9W+z+DrZ9bdrgdJeyr1yDRR2mE2k35esoAiykee72zodkeormoFowCte/Wv9CSbZk8dUwCjWfTeKwxa9I8BExg3Wzq5Lncw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=0PXZMdiLVBDV09MvE/7AaczzZ+8rQupVuBfoc9GHbdk=;
 b=OBqKJqfzQpEj/gW9slQ7Ifgcridr3Ujxi45z00YeXm4+LrcZWwKFJ6OrX4DoT8m7kBmHXasNY5K4Pq7tQDinR4QpNj4X/4uf4X59HVgYqezlUJCQdO9H2tSE6ClEZ94rrbbx9bBjjlsJ9uVV+nqyio6NvJ3DMu9/zN5xnmc+CgH3D4YR/JUlbp/Od94/FmLr5hDtxs3cRJ2Qz2kUR+yi9NVIWzag2MqFmfwD8+qIRr2nUuiMq2bg2phipblbSg8/+GzrmJKVVtrpwpUt5CoTsOa4NVHb/CrGgGhTitTd1kiA2tkkFzuGPYkAjsvP0SjfxNSArEIXx+kti/JsACfesQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by SJ1PR11MB6083.namprd11.prod.outlook.com (2603:10b6:a03:48a::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 04:43:59 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Wed, 12 Jun 2024
 04:43:59 +0000
Date: Tue, 11 Jun 2024 21:43:57 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<dan.j.williams@intel.com>, <pieter.jansen-van-vuuren@amd.com>,
	<richard.hughes@amd.com>, <dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Message-ID: <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20240516081202.27023-3-alucerop@amd.com>
X-ClientProxiedBy: MW4PR03CA0155.namprd03.prod.outlook.com
 (2603:10b6:303:8d::10) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|SJ1PR11MB6083:EE_
X-MS-Office365-Filtering-Correlation-Id: 994cb7cc-f55e-433f-7f11-08dc8a9a4657
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|1800799016|366008|376006;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?JC/W3I7Zqf7tTBzfQsnURI4vMpdcPvLLpl6b4l7pUQFwfaSRBcdgxn206pT0?=
 =?us-ascii?Q?DXYyXvSmri00wPAH+S7GepHcP+lvdIazEadUubWlXcvZod7jYUThfLY8HG7l?=
 =?us-ascii?Q?7Vc32lj2adguSEtoJYPDv95Z9txNRKn2SNkpbz5yCoWCcUPbvPfxPvEdwNAg?=
 =?us-ascii?Q?XzQC7vfjC7PyINErDhZ1PbG3TK3EgGJ1PBa38qINtBne18b3xoIfzMbZLYip?=
 =?us-ascii?Q?ehelWj1Ajy11k7PXjkbEGYvfUFTEmZLTLJDYF4XlwvwxvyxGecxPU1LYNs9g?=
 =?us-ascii?Q?eDLWCObckdv+MLiLmtP8YaNk0z245OdVJ2HS+vUsbMAMK4XnvsvU4XU6TayT?=
 =?us-ascii?Q?9K0pqE+KT03uA7r7b5/lKOyL6cW/1jYO015FQtC2cxwSFB4Xw8NSqvgZa59N?=
 =?us-ascii?Q?GQUNN6DdbGHzput4T+3bijNvxuAaZ6SCptoxRct51Frp44otd0lMlHeAekz0?=
 =?us-ascii?Q?TPmhQsEt7nBEmF2kuQ0+VbjWb9+VVDjgba1kUc9AAKO9+xkd0Ye3DKS/YUTV?=
 =?us-ascii?Q?b52JzUfQotPdt9bTD1IiNcKKpbR0asKoorMF62Y/wVSzeDwNj3eaVWYON02M?=
 =?us-ascii?Q?/yf7GnZbUTkxsXPEm/fFjBcwPC/sHOQ7Wm1qla56YObzKLbkXYtK6J8ihNAU?=
 =?us-ascii?Q?fzQTxx5lFALTezUQHQI7IWdtqieZobzIR6A0RPfgJV+lb27BqEAsOU4yxV74?=
 =?us-ascii?Q?2Y/c+LnVopsmmDUeJRbbop1E1FZ5v1Dif1AD3TnqYZNPDERRj9SBJF/2jZ6r?=
 =?us-ascii?Q?kgHdnnvbyeS9m6l6YiMEaXDbC1cABgwFuqquESZVtvqWpKrHXo68DFusq0wK?=
 =?us-ascii?Q?mdnNATecomIFBg9Ancir+LDNdR3OG6aIWtdJe6JoXVp9QLAkDFFeJT1V2H08?=
 =?us-ascii?Q?IzVM0FDQYTfdio1klT5mCUlKAAkgqCM8oaxgJ13Iv9W7HtZ9LDDFiT/6d5cX?=
 =?us-ascii?Q?kVY7kMkNVr/Ab2CoEvtaoy57l2rYuHNeHBPttOW3kEKoFUgtnLjXRZoX5/QD?=
 =?us-ascii?Q?rZpUq3vP8sq+tKsOLxGJbJivHq4eZ/BlNpK42PCils6DAePz+2ewpivDaw7s?=
 =?us-ascii?Q?hLwpCqzKONku/4De6gq2vc102KQLg4qecibqfz51jM55R1m/tN+jVisesOPF?=
 =?us-ascii?Q?ZRi/MOvZ7ax/XXcMAAJUpA0iRX8w/0+gUIBknK8O1Izl9ATyTLR/3tpgSxo8?=
 =?us-ascii?Q?6xChlCSboJytkLaobqgRvaOk9qB4MEJzdxYqsFBFyuL9AHr1IBBNcbBPe6yf?=
 =?us-ascii?Q?sAfy2uFbq8t1WhkTWZ1C1xVSDPpLm8J1JzieHdCTPxYE5jdmBOgmEVeXOkfS?=
 =?us-ascii?Q?zPrk2NxppRUBl/vaVC9xKe+5?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(1800799016)(366008)(376006);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?MKMfb8ZkJw+itrFDLJPcRtZsfa1ePVGWHX2iqtkiEKHJbQPps6cJsrUJGGsn?=
 =?us-ascii?Q?wBWPa4ayOAMU55l5CJsbeipLyuOpgh5azC3UopKhH7OiZ4mih1tXA1b23KYA?=
 =?us-ascii?Q?ZiN4JC0DWrjIN1x/6j5kskXiEAGM/FMk5mjA46XUDzcOOmiOGHkepEPYAZFV?=
 =?us-ascii?Q?7hArrk/f2qPEZk2Z9qJx3Scug3fYXg7sbpZ3RVNbYyK+LjyPXUmDNIEqEwOu?=
 =?us-ascii?Q?+/dxM5PJ1ih4txgpZsxg+WP9p7pbg5uznAJlOPy07MAe37hmMg1qfsiCty8g?=
 =?us-ascii?Q?OcM+L+BQC69gWq06A888AZDbpU+oyW8d8D7WbPj+3QSlyfpLrYHzDPUG3/Hr?=
 =?us-ascii?Q?+ytUOu7xbdqvOMzWXjgSp+fMnNY7wPW7kx1OmJoF6xoG2MbxQ4OxftyqGZu2?=
 =?us-ascii?Q?LG0bORMntEWAZvKBVZ7tzoHJ00nda8x2qnBwYQfcqZc4RDmBtGgKTsI87STg?=
 =?us-ascii?Q?5yPQEeWNgnVwZRqx8G9Io9xDWJaIk4wQ3Qlgyb7gUp2vSz0QLpzPiU4aOpNL?=
 =?us-ascii?Q?JYfmRGiddvAswoiQA3hHKD2Y6yMeDLOUhzrHR73X/LZKjOjrMHTIdiWaNdOa?=
 =?us-ascii?Q?nBwpvvktbuf4iZDvP3iaOH8DcofQoB4//fcTF1iX98eSrERGDl1iEuYmNwJk?=
 =?us-ascii?Q?gTcfF5PQhmZIiLn9pngofyxUPqgDkQfCX5Zwo9uMopmQbIvDV2iRAyXHhu8e?=
 =?us-ascii?Q?eTk2I9+DMYlmCup73lxDH4voXYKJHz0JF1fmPQtwGUXN8hwtEufbaVnVk3qb?=
 =?us-ascii?Q?kdTKjyY0wjwgs7FTPTHRDJHifb3gdiVnnqBCPyUG21RJpAXOUFZNxpllXk6w?=
 =?us-ascii?Q?kNXh6pi9q5wufMwTesfEFCOdzQBneJ07fzbPN2GTIpqJV7uAoMFDT941rqrD?=
 =?us-ascii?Q?Q2vBDC2+hhbrLNjHrmGvrgPGnp5qDvCEZxsfpYKpOYH362FcB98VN9oCnnkg?=
 =?us-ascii?Q?Z7xc9Pgi4v8p9n4vd/Ct8mQc9N9NYtOzhW1fbi5UUJy5fClnBYM4EL5RFClr?=
 =?us-ascii?Q?D8XTo7Mplh8U4lR2VbM9xIU5I42aIUehREz/+9IsgRB0hSR0epEIMDfVXflM?=
 =?us-ascii?Q?OVMGSWEpWEuU8ORUtmVZv6pKGM93P5Pkv+LqueZYIC8dVaS/vr3Tj9WLTFpE?=
 =?us-ascii?Q?MNq8WNGI635BA+XRYSBs/DtgkXg8VbO68V+3k20IXU/T8j/oG+3uXFuZqHL+?=
 =?us-ascii?Q?Zc1wtsUZZah/DoAcpN3bU2TW6UwBlE/flUL3MwroxkJ/1QskQPpQ119sEjzW?=
 =?us-ascii?Q?lEI8SPn4JYMKixgXOqeT3/AqATA3nAg12h5CXL7jLil/7TOMp/Fwqivusrfy?=
 =?us-ascii?Q?rVeHNex8v7kIOLEZ5hKuQIp37ITLH3DglgNgfIAHfNFPnjEhNzi+BG7tS6v6?=
 =?us-ascii?Q?d2Hn4TpCAi2ZBbbnRcUiip5Xo6tuXQkLcY/QPuEXxsQ8qV7L0nLLbmSs8hpf?=
 =?us-ascii?Q?fLMz4Fqp5OjV+VLvL7peyvnIlLpbAOjQbTRSUrf8ccNB0Uxjs3ZF26jj+qqf?=
 =?us-ascii?Q?Sxw+JFbeeR5jbS6qA/lc2z7Rq1XvGCx5M/xELEb9kqWWlZjLH7fsNxTEVrTP?=
 =?us-ascii?Q?O9FzOiAYoTw7nwBdt2gqycSWtC8JCSDJx1giR7DFz5wBGM9PAHmWdT8L+1OA?=
 =?us-ascii?Q?CA=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 994cb7cc-f55e-433f-7f11-08dc8a9a4657
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 04:43:59.0288
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: xxvDRFDHlnajNS/FvGcp3eJ9KxnJ9KuR3ecoYoYSom7w5gFrxSa1T3XPjFkfsR0ibiadug9eRb8Q4e1J//VlPHxyrv0O2ECs+wMLqcrnEz4=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ1PR11MB6083
X-OriginatorOrg: intel.com

alucerop@ wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> Differientiating Type3, aka memory expanders, from Type2, aka device

s/Differientiating/Differentiating/

...actually to make this imperative tense don't use gerund phrases, so:

s/Differentiating/Differentiate/

This "imperative tense" preference is borrowed from the x86 tip tree
patch recommendations [1], which reminds me that CXL should create a
document like that to make the grammar expectations known.

[1]: https://www.kernel.org/doc/html/latest/process/maintainer-tip.html

> accelerators, with a new function for initializing cxl_dev_state.
> 
> Adding a type2 driver for a CXL emulated device inside CXL kernel

s/Adding/Add/

I will also note that ChatGPT does a decent job at converting patch
changelogs to imperative tense.

> testing infrastructure as a client for the functionality added.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

It would really help me out if the changelog mentions what you adopted
and what you modified. With a Link: to the patch where the code
originated.

I will still review the parts I wrote previously to see if I still agree
with them, but its taxing to come back to this patch cold and think "did
I write this routine, or is this new?". Can you repost with the
changelog commentary fixed up to reflect that?

> ---
>  drivers/cxl/core/memdev.c           | 15 ++++++
>  include/linux/cxlmem.h              |  2 +
>  tools/testing/cxl/Kbuild            |  1 +
>  tools/testing/cxl/type2/Kbuild      |  7 +++
>  tools/testing/cxl/type2/pci_type2.c | 80 +++++++++++++++++++++++++++++
>  5 files changed, 105 insertions(+)
>  create mode 100644 tools/testing/cxl/type2/Kbuild
>  create mode 100644 tools/testing/cxl/type2/pci_type2.c
> 
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 07cd0b8b026f..0336b3f14f4a 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -659,6 +659,21 @@ static void detach_memdev(struct work_struct *work)
>  
>  static struct lock_class_key cxl_memdev_key;
>  
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
> +{
> +	struct cxl_dev_state *cxlds;
> +
> +	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
> +	if (!cxlds)
> +		return ERR_PTR(-ENOMEM);
> +
> +	cxlds->dev = dev;
> +	cxlds->type = CXL_DEVTYPE_DEVMEM;
> +
> +	return cxlds;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
> +
>  static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>  					   const struct file_operations *fops)
>  {
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index 0d26a45a4af2..e8d12b543db1 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -859,4 +859,6 @@ struct cxl_hdm {
>  struct seq_file;
>  struct dentry *cxl_debugfs_create_dir(const char *dir);
>  void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
> +
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
>  #endif /* __CXL_MEM_H__ */
> diff --git a/tools/testing/cxl/Kbuild b/tools/testing/cxl/Kbuild
> index 030b388800f0..a285719c4db6 100644
> --- a/tools/testing/cxl/Kbuild
> +++ b/tools/testing/cxl/Kbuild
> @@ -69,3 +69,4 @@ cxl_core-y += cxl_core_exports.o
>  KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
>  
>  obj-m += test/
> +obj-m += type2/
> diff --git a/tools/testing/cxl/type2/Kbuild b/tools/testing/cxl/type2/Kbuild
> new file mode 100644
> index 000000000000..a96ad4d64924
> --- /dev/null
> +++ b/tools/testing/cxl/type2/Kbuild
> @@ -0,0 +1,7 @@
> +# SPDX-License-Identifier: GPL-2.0
> +
> +obj-m += pci_type2.o
> +
> +cxl_pci_type2-y := cxl_pci_type2.o
> +
> +KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> new file mode 100644
> index 000000000000..863ce7dc28ef
> --- /dev/null
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -0,0 +1,80 @@
> +#include <linux/module.h>
> +#include <linux/pci.h>
> +#include <linux/cxl.h>
> +#include <linux/cxlpci.h>
> +#include <linux/cxlmem.h>
> +
> +struct cxl_dev_state *cxlds;
> +
> +#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
> +
> +static int type2_pci_probe(struct pci_dev *pci_dev,
> +			   const struct pci_device_id *entry)

So to date, tools/testing/cxl/ has been for cxl_test which skips all the
PCI register emulation and just runs based on mocking core-kernel and
core-cxl interfaces. I would like to explore how far the cxl_test
approach can go and leave the PCI integration to when a driver can
reference real PCI ids.

Otherwise, I feel like too much development effort can be diverted to
this "proxy" and increase the timeline to seeing the real thing.

> +
> +{
> +	u16 dvsec;
> +
> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
> +
> +	if (!dvsec) {
> +		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
> +		return 0;
> +	} else {
> +		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
> +	}
> +
> +	cxlds = cxl_accel_state_create(&pci_dev->dev);
> +	if (IS_ERR(cxlds))
> +		return PTR_ERR(cxlds);
> +
> +	pci_info(pci_dev, "Initializing cxlds...");
> +	cxlds->cxl_dvsec = dvsec;
> +	cxlds->serial = pci_dev->dev.id;
> +
> +	/* Should not this be based on DVSEC range size registers */
> +	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");

Especially at this stage of the driver there is nothing that require
QEMU emulation versus cxl_test mocking.

> +
> +	return 0;
> +}
> +
> +static void type2_pci_remove(struct pci_dev *pci_dev)
> +{
> +
> +}
> +
> +/* PCI device ID table */
> +static const struct pci_device_id type2_pci_table[] = {
> +	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},

Real vendor-ids should have real device-ids, also that particular
device-id choice is not appropriate.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.14])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 47D9F2574D
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 04:51:39 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.14
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718167903; cv=fail; b=DC1akkDhMjzD6XtDiD365f/75w8gy1yKGcOroh3otcEEuW60cfDL+ex3IwQ+te9BCFpT4LipwSglRhLPnpvQ+qaNnGCYx6oKuM5R3BEbwFtUJpbbfekzqGvAy/UCulWxxT66lWcskpY0jv5VI6nO7jLpqt0BUMyohNzgO2Vq9GU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718167903; c=relaxed/simple;
	bh=Xw42f84j5gkjo6l1Pgh69NtjCRCKTh/L6rWnaXBiyzo=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=M5FcluBjSDr6R/7BNLVgtOFuxhB8FyMzKutQKWnmTm2s9gskaEw/bib04BRD8d6nhAYfPYMOVFzWhPaSRbmgc0V5zFvEUznWymEyw4iAByR3y4I7hb3dJWoYJTWYIYKA+PPttumcfbn+hvuv5ekMtRHzKSmmtkQ3U8ztj5ns3Zg=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=SkCCxxGz; arc=fail smtp.client-ip=192.198.163.14
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="SkCCxxGz"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718167900; x=1749703900;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=Xw42f84j5gkjo6l1Pgh69NtjCRCKTh/L6rWnaXBiyzo=;
  b=SkCCxxGzQd+xXO00OeEE955DwUOe2bCt5+WmUR6KsHwNh4kAV10u9uN9
   liPoAw3+61oAtLVt++lZSTxY+FRk00+kTM2sT7KV3qtK2WUDbg4Ssb/GL
   LqCbap9/RmWPhCuwxG9yIawj8ofN03J5oTJxi2nN5NX4hKURNEASydnGC
   FyuS+xo9hk0foRAE+Cp1sQzndH88rk2vzHEYG397XnHKlIduX8svTu6Z2
   vQqStl7WbSBJr9/tKFeqAYapii/9KbCVdAe47lDwwGtgIbDExEMFISU8l
   bdVkYNy30eeEXti0v2fBN9niDLg3yadsSl5EATiyHGCrI3C6cDB6JPC0a
   Q==;
X-CSE-ConnectionGUID: uma80B3lRs+ayIrCPo7koA==
X-CSE-MsgGUID: FOscK/hOTMO4KWf/t0SQUQ==
X-IronPort-AV: E=McAfee;i="6600,9927,11100"; a="15136985"
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="15136985"
Received: from fmviesa007.fm.intel.com ([10.60.135.147])
  by fmvoesa108.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 11 Jun 2024 21:51:40 -0700
X-CSE-ConnectionGUID: OuTJz2wBROCQjXEcRpB6hQ==
X-CSE-MsgGUID: cDlUzv2HRGibRo9mUsG1qA==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,232,1712646000"; 
   d="scan'208";a="39520647"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by fmviesa007.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 11 Jun 2024 21:51:40 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Tue, 11 Jun 2024 21:51:39 -0700
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Tue, 11 Jun 2024 21:51:39 -0700
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (104.47.58.101)
 by edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Tue, 11 Jun 2024 21:51:39 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ewu/yAmJoSjke0xP10hnDq3kLlIx+b1kYNhEPhMLjkZjp7b3Latpoq4SIwueWvtUnsf1j1UvQz5+dfxciLZLE7AOgUJqmA4NgekSvzLgE23uv6vYtLSBuvyDvCD/UCDOiX99j9BUx1HPA61JeZDZnIAsr0OuVMlx1Oajv0FlJ9gVn3d7WCSnT4h1OQ05zcXj/nvVSv4ZvA7e4obtioXe3YIl9AhsQ7GoSwAhXDNzSk9rErjCn21dcoBhpuJ+S7ZvDYbVJNeq0/DiTCYrp0JIOAE2dodOU3Ef8nIs5MjVT+BX++aNf0ptz+FyYOrFjU4g56bTi68AC3QjCoXwVfm2ww==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=il1ZTrRya3gxa4rRU37cEP+sYFtrg1+uxtC8efrPd14=;
 b=og0BIKspCRQBIUb54mgINuAp2P4tImZBIMVTs2naoB3Cbft+bC2U0aHCgDbDMIHMheWBQsSqQgyzYwVL6JCJyn8cJA+UBjn64xl2tty+Oa4WWCnApcN27ApIhCt8li9YXzdqgz6teIvqQ5f8uuYL7aYX6CVMixWXMsti2K88oLM5kac4dGR8CUJ1/9HNUQyT2zu1yfHvTsMs4obWt5+XTajF1Qi/2lTyNpyzJAd7hc1QzoiAUDUw3uaYRZx+wtK6urSsnXfPQV1hJp1VQDX30Rm49tK3+9RE1oE0f8BZh1PBBtoMjL2VPfnxTHZB/pudaj7UOQ0VNM76BwsyUdlFtA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by SJ1PR11MB6083.namprd11.prod.outlook.com (2603:10b6:a03:48a::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 04:51:37 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Wed, 12 Jun 2024
 04:51:37 +0000
Date: Tue, 11 Jun 2024 21:50:34 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<dan.j.williams@intel.com>, <pieter.jansen-van-vuuren@amd.com>,
	<richard.hughes@amd.com>, <dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: Re: [RFC PATCH 03/13] cxl: export core function for type2 devices
Message-ID: <666928a27eefc_3101294c6@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-4-alucerop@amd.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20240516081202.27023-4-alucerop@amd.com>
X-ClientProxiedBy: MW4PR03CA0276.namprd03.prod.outlook.com
 (2603:10b6:303:b5::11) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|SJ1PR11MB6083:EE_
X-MS-Office365-Filtering-Correlation-Id: 6b213390-ab54-489b-89ae-08dc8a9b5775
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|1800799016|366008|376006;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?AxMvkHwvCYPlWt0+rs5Ei//HkQAK79mVDzfwzHGL1QVrXAnluqfgDghvhy8k?=
 =?us-ascii?Q?HrbO2QiS4nCOZMNnmhaLMoI2ArkkrMewJLqkyNxEMSN34zzcX81JwHHBqbeg?=
 =?us-ascii?Q?ZrrMLEqCNCgYcd+RoSDK2pVgWU6YWZTZvxKgC0uqAh3/6uPwMVPrYBtsaO/a?=
 =?us-ascii?Q?pjbAIRj6R2QUMYdjNyijBQOfd4Qjdws5nf0IcAp8zVrTgzAGji/7JiJpoNQf?=
 =?us-ascii?Q?Hah4CJcnPChcjzWJgHmCQV7LdF7N04ITalFcXLsk0A1c/J09pT2g2swRttWA?=
 =?us-ascii?Q?9YByBEW+wG6SJcV3NF007GyV1lVVJPKXh/A2nhV0DCnDTLfM/KGKYn0U6tDD?=
 =?us-ascii?Q?hOWrKNXvPHj/P3g70hRqpFUXB0zsd/s5xo1ME9LQ+n8tJJ8S21ug/yoZSekn?=
 =?us-ascii?Q?0rDiLLebwb7NwpqxgHDGmV+zQYcMxuZb2qzCO7qjqYFqyXvLgm+9SSIiJ0IE?=
 =?us-ascii?Q?YSzwH+D+ld92PLLa7Jsjhs6MawvRmi/JK9Cd+feFIFz04wbcWoHayJ7jbyHF?=
 =?us-ascii?Q?6C6kQnT13iiaq6qFFJP8aH5YRC6uooai3Sh8qKRpcWzfH83UfajXhSuBVDyU?=
 =?us-ascii?Q?lEgZBk+1nBwvqNnUqh2GqJEdlkBkpUJ8a1rLt8YHKSsVykrAE+0IGMeM2Wsm?=
 =?us-ascii?Q?7fAxXB4exLNstczYCcseUJWhBpxWLCass/lf4mNjKHfCij7IRR7U21dVMEh6?=
 =?us-ascii?Q?fDBgWS2jasj9B1jCzIqI0fOfjs3pnCKJkXpjLq5aPLXVVMaXpJ067WObUIQZ?=
 =?us-ascii?Q?mvHKxemB/PLlh3aTjbclLriq9LZ/JqAFg40+P1ra7+rvoNpAt/KN0Mr8q2MC?=
 =?us-ascii?Q?LYLcO2S/INDGGvVi/g0GUkfa/yCjxp86mlElSZW5cwc/FjeGPE61g6SVi+Gm?=
 =?us-ascii?Q?Hq1KGGuFhR9/KcYdMMTL3xpclyakSuJMWrNCmARlzYBZn6Kct583uNmKpfDh?=
 =?us-ascii?Q?kMrIvEgTtkuKm7P0hPt7SEtMTz5J1ruh+irJ7K1zYhetKfTLfl/Rpn4saV8s?=
 =?us-ascii?Q?Zi/qghQNyd+5tDWneWaZ9qISXuL81F0OZ6QHQuze3lHGw1hT3kAymb/m23i6?=
 =?us-ascii?Q?raibM4LppEMB+lvtii1Cb4vrLDE2f8NhMZfCpaK8mDUSFWZ8/ukPTFvdjcua?=
 =?us-ascii?Q?sQ4R8hjvbBPvbzW92t/28XjvQhLyGNb+htwYfoqPLaR32dWDxCejhznDBjsx?=
 =?us-ascii?Q?VHCej43d48Ttl8pxcX9VYHq4XGsi8ixIRTB8SIxes8gAHnhmU24EQlGrvpE5?=
 =?us-ascii?Q?RRJsdNM8yoCnFcJYyHzVCzU5ViU9MHecuJh80vDbc+TMjv9rEqmHA2EroiDM?=
 =?us-ascii?Q?2GHDT+aKh6FUyLVdL/59RL4k?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(1800799016)(366008)(376006);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?qii3BbgxK3aA4n+F6Eu3QecnRhMoUVkkkviMMgoGIhd1OTy77GJxqU4x28fQ?=
 =?us-ascii?Q?K4PZyBgVwNp1rs+IHgA0Beb807QGSt9df+ndNk1+ovgFUX1rzO7Ffnc/Cucv?=
 =?us-ascii?Q?UgbgzaZ78/9aJ6NT/ehKdGF4DS9Cq//MJ5JPx8Os1RQ5P+u+FGwD1Vy4CCJV?=
 =?us-ascii?Q?d5lDl9NvkhjPmPsrZPhv+IscTLZCdgKu6M1Re8TdFyxKAPb2ze0DLEKXRiKw?=
 =?us-ascii?Q?J/EQH3Jfe/QZx4xei+omLmo3uoM0B/TUaQs58+QsRN3kChhIk1p8Q3FcCIx5?=
 =?us-ascii?Q?NKiZlqhcJY3HyfGNhVmlul/WyQk5Sx/U6h8CWtBpeILUoxPXiVpxl3E/EEqd?=
 =?us-ascii?Q?37+9Q3MaTtn2yBd/cQcuuxNIAZEXgZeSeanXx0cNjbN1ak1i5OTvRElOQcL/?=
 =?us-ascii?Q?FkMqtGdiYjGPYaM8pAe1kA8goZ/arAG62xP9RETc85wDbDlXJPGBsOLPe69e?=
 =?us-ascii?Q?sZ1H07lUVfHOZHAFS4hRvcivVUGGOdMtWRj+kcjTRy+KXj+PlXserpiOAeBb?=
 =?us-ascii?Q?Ngq96k6Vz3uOIFOuDjKe6swl0LtGpLxFHzrjoOg/i73k5NWTeCabvbPqHXP1?=
 =?us-ascii?Q?bGeGWCVsHHoBz5+l7TKppduMUokZfbI5qAwIJsbgXd1YPwyj65z4ZeUcJTY7?=
 =?us-ascii?Q?MMa4KanzEEJfqIe6yQnjSZqAX2t/ceRHUTdVEBPR/IiEI7soN6dIkGBuwIho?=
 =?us-ascii?Q?WD5LJMj6MX0WGqMu3ScrozSZf8IANewQv1fRtyhmWXT8BBpr3a7kyOsPt3pg?=
 =?us-ascii?Q?38DrBnmxENSzaM0H2EDfvjl8v9Gs/mDKC3e94/87uT4fWanAQCBT48oQlRJ4?=
 =?us-ascii?Q?LcXjcrq3TPiUDrXCtRPiOINahkAhI7ZqObpSt2tKI1+iVW2iRoNLVtoyVLuQ?=
 =?us-ascii?Q?PjM/8TqguKyHcNAMiRENdswGa7oDhTLCiB9MXA3FENkvsXqi8RNxWqilqtWO?=
 =?us-ascii?Q?NdqGso88hGXcKRQ5/rafLvZyuFnsF3wVlaIr30LdKwLweaY7VrwOaD30j9Zm?=
 =?us-ascii?Q?2WuDP8fj5qGs+mtEJHaoUqj8ESK1fa1hFaMdedv/JWX0CQPh9/G1OXObE9fO?=
 =?us-ascii?Q?NXIM90fwgHNS7TkmNttiTZPfgrJEZZS5mPHpUowj0EKAbP8QHa/6rdeXkjqB?=
 =?us-ascii?Q?K1m1ND/70A80jxD12rwXLJhaMZtDBCRdu3mvfcfnKNG7BAR9c1pr23bcf671?=
 =?us-ascii?Q?+XJjephk0AFm/+wenrkDD2fe2kFEZ4Z6DKhVwDO3RHQ6y0ZOoJOZ/3Fc+S9D?=
 =?us-ascii?Q?WOVhQHPnBmjwK258mVfZQOMvUVHKzcpLEbGuhINqFAc49o7kQZ2TLXDQsd4d?=
 =?us-ascii?Q?zGud2oe/apwxX8jZ5U7Es+fu0Js7VDw0SWpOZewzYoDW89J0ND9yxQ+kExFo?=
 =?us-ascii?Q?MAfjU5fAg5PwYS3iQPwqCSu/9o2e2Iuz7vgP8SBxBhlD4q8JqICt+sdVoRXV?=
 =?us-ascii?Q?byOcMsyD5QAV97fThmYRjPC5hZFrGz3roAqIudMf6/ddtSa9xllvstsVOxQK?=
 =?us-ascii?Q?lGNxIFZ5QFB5WqPWCdp1Lw9Cyuo69Uzz7a80dE0xRgFWsaoPNnr8H3GBFFa+?=
 =?us-ascii?Q?DcQcbQ+BLjAsnHBoZ526BwQG5d7aj8ARhdpF/eZYb2NuHkBQf97hyPLh+c0x?=
 =?us-ascii?Q?cw=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 6b213390-ab54-489b-89ae-08dc8a9b5775
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 04:51:37.2389
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: jscfT36ZRs9WWxQL+8cNp8ZjCWB5WxdZ7RKf/w6tDqrddEc4boF194DidU1/OlF8wzY7IYkXl63lDF+vmnVawhYFVulKTh2m/aBA67QMz0A=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ1PR11MB6083
X-OriginatorOrg: intel.com

alucerop@ wrote:
> From: Alejandro Lucero <alucerop@amd.com>
> 
> CXL initialization by type2 devices requires to use current CXL kernel
> infrastructure only available to such core code. Type2 devices are by
> definition owned by specific vendor drivers which need to use part of
> that infrastructure for initialization.
> 
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> ---
>  drivers/cxl/pci.c                   |  3 ++-
>  include/linux/cxlpci.h              |  2 ++
>  tools/testing/cxl/type2/pci_type2.c | 31 +++++++++++++++++++++++++++++
>  3 files changed, 35 insertions(+), 1 deletion(-)
> 
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index ccde33ac9c1c..497276302017 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -500,7 +500,7 @@ static int cxl_rcrb_get_comp_regs(struct pci_dev *pdev,
>  	return 0;
>  }
>  
> -static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
> +int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>  			      struct cxl_register_map *map)
>  {
>  	int rc;
> @@ -520,6 +520,7 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>  
>  	return cxl_setup_regs(map);
>  }
> +EXPORT_SYMBOL_NS_GPL(cxl_pci_setup_regs, CXL);

Any functionality in cxl_pci that you want to export to a 3rd party CXL
driver needs to move to drivers/cxl/core/pci.c

>  
>  static int cxl_pci_ras_unmask(struct pci_dev *pdev)
>  {
> diff --git a/include/linux/cxlpci.h b/include/linux/cxlpci.h
> index 93992a1c8eec..28fa4861a4f9 100644
> --- a/include/linux/cxlpci.h
> +++ b/include/linux/cxlpci.h
> @@ -130,4 +130,6 @@ void read_cdat_data(struct cxl_port *port);
>  void cxl_cor_error_detected(struct pci_dev *pdev);
>  pci_ers_result_t cxl_error_detected(struct pci_dev *pdev,
>  				    pci_channel_state_t state);
> +int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
> +		       struct cxl_register_map *map);
>  #endif /* __CXL_PCI_H__ */
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> index 863ce7dc28ef..b12f13e676fb 100644
> --- a/tools/testing/cxl/type2/pci_type2.c
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -12,7 +12,9 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>  			   const struct pci_device_id *entry)
>  
>  {
> +	struct cxl_register_map map;
>  	u16 dvsec;
> +	int rc;
>  
>  	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
>  
> @@ -35,6 +37,35 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>  	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
>  	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
>  
> +	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_MEMDEV, &map);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
> +	if (rc)
> +		return rc;
> +
> +	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_COMPONENT,
> +				&cxlds->reg_map);
> +	if (rc)
> +		dev_warn(&pci_dev->dev, "No component registers (%d)\n", rc);
> +
> +	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
> +				    BIT(CXL_CM_CAP_CAP_ID_RAS));
> +	if (rc)
> +		dev_dbg(&pci_dev->dev, "Failed to map RAS capability.\n");
> +
> +	pci_info(pci_dev, "requesting resource...");

Setting aside whether this driver moves forward vs a cxl_test mock, if
you want the driver to be chatty use pci_dbg() or dev_dbg() not pci_info().

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2058.outbound.protection.outlook.com [40.107.220.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7A9C679D8
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 05:42:23 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.58
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718170945; cv=fail; b=dx6txlJE3nw2T9NspspZlImcnMskYgg87lSgTS4tr2fqFrGhWv2KvPeJzFxfm7ux4N2PnLqiGGeW2SCcwDl7kK0DbPyNuG32f5Z0zmFBt4qLAV6Eh5WbCEQLMEI3iQelY9F0CrSZHpBcJMNz77fr3S3apDXAE6Z3Wob23BO3sZs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718170945; c=relaxed/simple;
	bh=NxcdgadjjQW1gcAZWV43AQFqjKpfMEqcviBfv4jUcII=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=n2wz2O1/ZlFBAxgCqorE08+qyTInX8gPxCYT9i4XkXJYNDTuisCPap0xm9d9AEt0nyoi+to84CuHaNmF4L4Sndd95XcIWmSiRdzhO4fiWGcALmb7+sEvbfdHJqO+k0+2TL0DKHCLltotqDSYB84gYDCRPJpLQmDF52OaM87quss=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=vsAfGAuQ; arc=fail smtp.client-ip=40.107.220.58
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="vsAfGAuQ"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=SFRygk7KH0P1qmCclvdTS5BQqkkL9SUsiwa5RyNpF2gPddjS22LLQ65Tvuvh0nCJXAnhGhNGcg2KICa5vS0CsjuApC7RZawPTZNI5dSRGIkQkKlNq4Uri2WfYCkOXIQpJWoUDOKlneTTH1zawETzZVulK/LgnGgA0Ap8hm7IT+QD7BKjZi8ZEdh4hIbRfODyuanTm3bSYc/dAz0R+FRgxGAJuhYK6t1L7DcSZbCnP73duTOOzup/Wd8KYbTgijS7gvC2jMXsbL9157ZNrLvk6nCzzrj7VwYH4mIDN6RGwJZxBmlTn1/s5gtl/56PBJ6C+wXpBnnOvNjFJnqKWTxw7A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=x8nqmFN9KbjV36gwQ5izIBLrjdo2UOsanZWmbHiJ1vM=;
 b=Ydoqx37jizdd36BS0M4fUl5owsxhhmpMaQspZrsC80vRM2dJcSzKCU8EuIsdyUEzaE1DBpCIqtJbwsxQSptOykcFgl3IEVqCOOyyAy04JC/+I7euXPmnLTZLlAqeFACREZ+ew9EuzaJyDUXebwr3A+JnZyEXJTpVnIlXiQ4k7g+5bsQ9GK4ZD2sGItyXJ6bCitoRZvPe+cvD0f1P+TzyNA9x48VVjEf4+AYWkHtI5E4plt2mtfZvV5iSHESptqiG9iLf6N/lfuMTIZEWuU44po81ff0jIbJ58BIgmr5q39ogtIWZycvyGMnRB4EXrKnL2yATk7PZvy16IsC0vM6GpA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=x8nqmFN9KbjV36gwQ5izIBLrjdo2UOsanZWmbHiJ1vM=;
 b=vsAfGAuQzz3kWYth0f07eHBkKm249N4qAe4LoVXAtNgAfM5nAwMLevwYWUFlMWLAEueZCrwzY8UQK3q/M71dur1EvwWNFLwCopJitBi54/zGXyc3qLvJW6WTBfLEkIsAwHYV9O0hlFZ1c9ZJk7YWafj8zyjPwyl5YD9/HpAoWzI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by DM3PR12MB9415.namprd12.prod.outlook.com (2603:10b6:8:1ac::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 05:42:21 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 05:42:21 +0000
Message-ID: <06320d18-5df2-5ae1-015c-f7aef13eb419@amd.com>
Date: Wed, 12 Jun 2024 06:42:17 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0499.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:1ab::18) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|DM3PR12MB9415:EE_
X-MS-Office365-Filtering-Correlation-Id: 2c3ea0e2-7936-4753-204b-08dc8aa26df9
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|366008|1800799016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?SDNPeE45bjM4S2hNUCtUdDhrWTdmbk5LOENpOEIzUHNjSHNFcWRNZXJtSVZL?=
 =?utf-8?B?SElwVzRFaFFyUVhyU2FkSisxd2tjWi9GUk5JaWI0N0pYWGNwMXVUSHpqTk1Q?=
 =?utf-8?B?K3hGcllFa0EzVjQ2ZDlGY2JZVTA2YVNqNTBGbGRzUW9ZT1h2bEFGZTBJdVZk?=
 =?utf-8?B?TmdvZmNpVmF1bG5DV2lkMFFwSU44d1A1RnZTWUVrRWNuVGhXZlVWMlRZdGhy?=
 =?utf-8?B?ZW1xL0d0aEJvUkIyY0IxcmhLbjhuTTFzbStuVGpXTndUaStGbDhXamtDNmJE?=
 =?utf-8?B?cmtyV1IrdVJrOXowLy85OHpOTnRVckxGWFlUTEhqbUZOMDV6L0Y5VmIvVVh0?=
 =?utf-8?B?WkkvWXhBTzNXdDJxR05DL2NFMk5tRXBmQ0wvNU51TDRCKzZBOVQwYkt4WnYv?=
 =?utf-8?B?Mm9tV2VlM1VzRTZzMHl2MHoyaWtKWWY3TnpYTENGUllabGNKYW9wem9wbC9n?=
 =?utf-8?B?NTk5RWdqNVZwSWtFUWJTVWtrMGRsTnhFZGwraUVod2YvVEY5TitTem9lUVg0?=
 =?utf-8?B?RG11dzJPdmpQOXUrSmJyLzQ1K2gwa3pKTkF0L1dRV0xDWldKcTV5NnZVY1RD?=
 =?utf-8?B?d0dxcmtWbldOTkF3NW1zd29jamRKZStWeVNZanBCb2RZY3MvZktmb1FyUDVQ?=
 =?utf-8?B?QXh1RGhwc1VVSU9oallnVG15Qjl2TnFCRFc1Vk9ScFpRZFNlYnJFSk9NSWRO?=
 =?utf-8?B?clk3aEIxRFBSb0g1a2ZyM2IzODViYTByOXhTVXpwYTNPWG8zNWtJa1JzYTRD?=
 =?utf-8?B?dlFqMGt0ODh0WWlrZVR1TmpNS08zdXBvNlVSZ09zZ0F6RlEydDZUUWJmSmtn?=
 =?utf-8?B?bEhiS1lWZDZicmVpY1M2S3JQclVzblEwbjB1bUI3ZUtxYi9XUTlWSUx1ZkMx?=
 =?utf-8?B?V25odS9TaGJ3ZDNvSFNIL1hRSnZBTytrMGVEZ3B1bkptOC9EM0ZqR01JSGxx?=
 =?utf-8?B?a09uNU5HSm5peHBVb21YTDVpUG5CcVFiRjlPM3MrbFBLdU4zdVRRRXlkVU4z?=
 =?utf-8?B?VUoxMXd1cnVBUjRPV05oZVNFZ0lhSzJFVGlKenFGYnI4ZCtkS0hXUGZnOGVB?=
 =?utf-8?B?enZya0JFSWxKZitsd3NBd0ZLY3V3NjlpRnR3THNBSjJBSHFBRHRrYXBNa1RZ?=
 =?utf-8?B?VUgyd2pQcmRzV2tacTNDUHBDMGNSSTl6bmorSnpzWWJhbHlQQTZWWjNpNjZk?=
 =?utf-8?B?a1FNMkMxMy83TmJTd2tlUzZ2TzFJTWJpV0dGa2VjK3pSbGZubXpWNU9PVTVF?=
 =?utf-8?B?aHlzdEVIMVV3T3l4c2hRS3ZSRFhjRjh1MndwaGlnaFptRWc1ZFdJMXJvdTIw?=
 =?utf-8?B?eFRiUTRna0V6WDJwQ2NUOTFFQXhtbE1WT0V2UWNSY2UvSEFKbG1XYnRqWXBW?=
 =?utf-8?B?dVJnWEV3RDNuaFpoNTZ6Wmg2WWRuL2JkRXJZRU5JMm5xbnVLQWFlRFBWSTBK?=
 =?utf-8?B?eFF2MTRqL1VSNy9hMEVzMnVoQWFIeUd6dFRwNmloL0dZejAzekpKK0l5ZGNW?=
 =?utf-8?B?UUFrbHdtUmZOTGppVUJSdXB4blBxTVdKc2llOVhPRXhMOUFDeHBmcnBsRTlY?=
 =?utf-8?B?QUFheHlmNTltZW5YblhJSUJOR25GUjA2Zk1QMEQyU0JVQ3hHRjlBM1EyeWo3?=
 =?utf-8?B?TTdrOGJZUDdtZTYvZFFscWhSSVdQOXhxNjRUeGhEM0JJb3FVMk1RMTB6dlBT?=
 =?utf-8?B?Q3BIWTFzYlllVnVFakpyV2dleXdjSWx2RmZ3YmYrOC9sRXZJRmFkUFRJOU4r?=
 =?utf-8?Q?RldRpYuk3krIhVw2ln/PDHjCdP2xowoF8ASbLbW?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(366008)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?VG5kd3U2ekxwOVkvSENsYkJiTXBKMzZoZDlvU0plTnlMbEdJZVVDS2tZMUhW?=
 =?utf-8?B?V254ejVlaDh0L21ObDFZSGdndm9ZS0MrMVQ1akp1MjczTFpnblVnR2wvbXZK?=
 =?utf-8?B?N0hjR3JtTHV3VXNXK2ZtZG92elUzb2hFWHFpSFlodnR4RlNzNlZ0Qzg3K2k4?=
 =?utf-8?B?MDU0WEJXbkZ6VWJrbE41clIxcUg3aG9yQXQwWU5IcGxEYlYxUG1DTlIyMlRQ?=
 =?utf-8?B?S3dMUEljZVRSWFNvQUxCQ2NOVnhJZis1aW53Y0Q4cHlZdG1teEJNcHQxZ3JT?=
 =?utf-8?B?NFBrVHVQcHRFZ0ZuVEVram5aa0RYSUUxMlUwalg4dkQwaFFyWWtUSGoyOVFh?=
 =?utf-8?B?eXFTcVhYQTROcVNpV01LQjUrNC9yL3phMnI1bHQyNUl6SGlZcUwxQ1p5WC9W?=
 =?utf-8?B?YjBiL0RBWlZpT0RXR2dnZ0pSN2xpVDUwSFR0MHV3cFg1WmI2MHZ2RWdUSjRp?=
 =?utf-8?B?bXM1Qnl4VkpRNjdkTzFIWUY1NEI3d0EwVFA3Wk1yU2MwcWh5VjVPcysrMzl1?=
 =?utf-8?B?UXJTQWNKWFFYNGl1OFF1aUNhYlNRNG9GN1hCQXdteVNRUTR0T25XbjNpUGNi?=
 =?utf-8?B?UFhFR2F3eHJHOGRqT013a3p6bStWRk5CaWpMNktkZnZFUHMxcWM2L0RwNnBz?=
 =?utf-8?B?YW1KajV1V2NvVEZYYWp1dmhHQkF3YkFaSXM3UEdQSHU0NzZzaHluM3krSnlM?=
 =?utf-8?B?cGJlZTdFV29VdFVWazE1RG9oWEU5TG51dERLc1FSYTZoL2ZCRzN5Nnh3STlW?=
 =?utf-8?B?bXdkU3puaFlMcERQOUgybUI2ZVRGZmlzYW0zKzJCUEZpcjVRTjlLRUVHVDdy?=
 =?utf-8?B?MFZVZFJxK01lLy9mTEcvcjd1MVcwUzNLUytReGtrM2pibHdhL2VwT2o1bzAv?=
 =?utf-8?B?enVSYnFrN0dEbmU3T2Q1V3Jrb1NpUExjcWxWSTdjM0VjUEpKcE9sa3VGZmZT?=
 =?utf-8?B?ZmJURnhSb1JXUGRVTENiUnpZTG12SHJJcGtSUFUrcU1KQ3FER1o2aVYvclVG?=
 =?utf-8?B?eXlRN28wRVJwNFZmak1pSlhXMDE3c21BRSsxZEkvV2QrL0RmUG1yOC9ZeDRr?=
 =?utf-8?B?V0x0R3E0N3QyZHFDMGlaWk5TaThUQkNmY1JwdFNvWUh3eXhYaXlRb1FVM08w?=
 =?utf-8?B?ZXYwdUlvZFNIaUF2UjZLWUprZWlTOG00cEpTcjhZZWd3ZkNaVUU2T2x6TXRp?=
 =?utf-8?B?NnZRNm5FdE8rbElrckNOaDhSL01pQ041cTEwMnFNNlNZRWQvcGdLNDIrUElN?=
 =?utf-8?B?ZU5qNlI1UFBmQ3l5bWJxbTdET3pJbURldHJoN3JDaHIvR1A1aVUzZkl3Z2J1?=
 =?utf-8?B?RlFZcmpxNmhOK3Q5TnhQSmFEM3RDOXl5OEZzZnJpa1pkd1h0WUdKUDJ3bXEr?=
 =?utf-8?B?ZUJycHZ0WXU0aGxvZ2xOalpsM3UxY1d5OFJQVlE4RXJ4S09FT0UweWFmMGF3?=
 =?utf-8?B?dThRa2ovK3hsbWxQYUlpRlgzTjJSZGcyakg2YjlqVnlxRXBrcWhpVFpQSGVs?=
 =?utf-8?B?cVQrMk0yMUZkb210cGlQRDB1czVGK3JCUW1DMnJsVlJndFBRQVU3bTNMeU9W?=
 =?utf-8?B?MGhwSjZEQW4xK2pwVkxvZU8ySXNsRFZOeEgyY2c4bUlkeVVoNGxRZ1ppai9t?=
 =?utf-8?B?WUVlWGRpMVhDbTBvQm1hamg2MWkrRzdvM2FpRnUvdklEZGdTbDRVSTk4VlN3?=
 =?utf-8?B?RW1INjZ3QWFLYlRLWkx5YUsxcWFRdnZZc1kxVnZua21yRjVMODErSEFDYVZm?=
 =?utf-8?B?aCtKNjBHOGh1VXBadEh5MEVtdy9jTHBHS2cxQlBRRHJaQkliRzZyMFJ4eVQv?=
 =?utf-8?B?R3pZSm5oR0NBK0dIQU0wRGdNdUM5SCtmUFNodndBY05XOXQvTkZKTnFROUlZ?=
 =?utf-8?B?cXdtQ216djFpY1pqZy95NHNTd2p1OUlSQUFkOEIxY1RKRVlFbzJ3bndiVm8r?=
 =?utf-8?B?TTJUQVRQb21YZ2dzN0FacEFiVkJGNTVucGpPZ3QySVdsZVlWYnVrUlJ1TnZq?=
 =?utf-8?B?eUdCY0grVWRBdTFMTURld0xMMi9CYXcyY2I3bExwakExZUc3TVlxNWNoY2J5?=
 =?utf-8?B?NVBldjZmSFJrSkFrOTB0aXJ2VFBPQ2U2MDdBOVFva0dVWHR0eldPSnlJN1dK?=
 =?utf-8?Q?vAywG3HeWDnC61pgCUd0P7wyK?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 2c3ea0e2-7936-4753-204b-08dc8aa26df9
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 05:42:21.6007
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 3YlMAFsqk8AtLwNu9/8ychg4AeyX7xQJ2AZDHaJZu1fvyaVX/l7BNlYU3goqmw9hqiLbhpATg+P+rzJ1akBi5Q==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM3PR12MB9415


On 6/12/24 05:27, Dan Williams wrote:
> alucerop@ wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> CXL Type 2 devices imply specific vendor drivers binding to those
>> devices instead of generic ones offered by CXL core like the PCI driver.
>> Those drivers need to use CXL core functions and structs for
>> initialization, create memdevs and create CXL regions.
>>
>> This patch avoids referencing those files based on relative paths from
>> inside the kernel sources tree.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> ---
>>   drivers/cxl/acpi.c                      | 4 ++--
>>   drivers/cxl/core/cdat.c                 | 6 +++---
>>   drivers/cxl/core/hdm.c                  | 2 +-
>>   drivers/cxl/core/mbox.c                 | 6 +++---
>>   drivers/cxl/core/memdev.c               | 2 +-
>>   drivers/cxl/core/pci.c                  | 6 +++---
>>   drivers/cxl/core/pmem.c                 | 4 ++--
>>   drivers/cxl/core/pmu.c                  | 4 ++--
>>   drivers/cxl/core/port.c                 | 6 +++---
>>   drivers/cxl/core/region.c               | 4 ++--
>>   drivers/cxl/core/regs.c                 | 4 ++--
>>   drivers/cxl/core/suspend.c              | 2 +-
>>   drivers/cxl/core/trace.c                | 2 +-
>>   drivers/cxl/core/trace.h                | 4 ++--
>>   drivers/cxl/mem.c                       | 4 ++--
>>   drivers/cxl/pci.c                       | 6 +++---
>>   drivers/cxl/pmem.c                      | 4 ++--
>>   drivers/cxl/port.c                      | 4 ++--
>>   drivers/cxl/security.c                  | 4 ++--
>>   drivers/dax/cxl.c                       | 2 +-
>>   drivers/perf/cxl_pmu.c                  | 4 ++--
>>   {drivers/cxl => include/linux}/cxl.h    | 0
>>   {drivers/cxl => include/linux}/cxlmem.h | 2 +-
>>   {drivers/cxl => include/linux}/cxlpci.h | 0
> So I don't like this approach, there are details that are private to the
> CXL generic memory-expander use case, and some that are suitable for
> CXL.mem and CXL.cache capabilities in other drivers. That distinct
> subset should move to include/linux/. I.e. I want to see the incremental
> conversion of what 3rd party drivers need compared to the generic
> expander case, and consider when and where new shared infrastructure
> needs to be refactored.
>

OK. It makes sense.

I'll work on that if there is a v2.

Thanks


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2082.outbound.protection.outlook.com [40.107.243.82])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7494236AF8
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 05:54:20 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.82
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718171662; cv=fail; b=k6We6PBrDuV7fYhXXi2jjONhyQYZi68NQJVY0LqLqcwLAT+6uLv3ydx3eEszPL2Ox6czqFoYOnb4XwozHMP6oGkuAzf9AV/jN22WaqSYIFgiRVZor/YgOL/QZ+6bLzyYd/Yj0h5vqIqFxUiEFLVAIRAxQwDaaqJax9m0nFjxqfs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718171662; c=relaxed/simple;
	bh=0ni5zwMQQTIgKx6CGiMTc22YGaEB6UQzFxSUNCJ0/uw=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=UmuiBs3pcSzW+LyqAO0W+SZyg7KhtvKGGHWHaqzn9SQWjX9qnqiTAcFS/H/JY/X5PPKaJ73rq2np2H8QQS7z1yCdhnW25RUoVSlsF9h5RRPNuD/FX/pdKz16TepAntzWfRX4xkL8s8AvDZ5ePdTEbfxJPtGe9jfeiU9KelO1OlQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=FEc8qhFv; arc=fail smtp.client-ip=40.107.243.82
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="FEc8qhFv"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=er9weQ5uNZECY9p9tKGsqrAhmv9G8ue9CF9O9a4/X2an4UNFXCqMzs+Y9sGK2FAzWuKolyna7Pe+E2uqJwjZlblqJkNrELkcJxanQSp2+3EPinq7s/3YonVgCD3aenvyh9ysLnXIIL4lqkGabtTLybt9Mx9TpD+Uk0UdfQVURcqmHoAhBudY52AR2jSYiyajRK8zoe4vJpEDfz/p3nDM2l1ql5uJq1Iq70VC2E8P3xoB7dAY7Mfi6wk1h4nZTxSm9IfT6DCxI75fw/mkh0dzsblWQL+olHfAuURIfYDcKFnakJy32AGqILGn3nBwQ8d6qcMhrm4uxSVpdE/V4UFwYQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xwL+AVrYcJSIPiXXJRaXXNsMO1Z1QRqxl+xnKQl7kbI=;
 b=C0A0S5pzeMyAvAzEFI7uAw+YELZauKqpujP3IUDQXq+pm+Ri0gzcclw33ooVxTMHwN9ULcDS+/f6BhlRDMJwAxY8zq5vw0SGUgGUQOW7N8cuToAqhrBvwshTiG99myplRHBfk3rk+icRaRcZGdjOw89SLfM19v3nncOtWZJuI7hPQJ6M8YowbrN4XWxXZLAUM0ujuEBdbF68HjPzmFRhB6f/QQozMVQQmX6hV92WuwREg6aU4waJLYT+7+qnwPahZaRaOCD7Vt2suKAf32JGo1gIGE9xZU6bBVPc8kH+aUAsX2nF6i7iZChxB7FA3wKx8XMU9AEaJFPFOwjHlYlkeg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=xwL+AVrYcJSIPiXXJRaXXNsMO1Z1QRqxl+xnKQl7kbI=;
 b=FEc8qhFvyUfAYpGakYl9GIHv1myuZ1s1VSDzLv5fKkTUjoZjyOYmDwG8fJ3v+i22Q65KqnzjdyI7bh4Vd7maWxmiJtOQWkDV/8f2tmCbM2ZagcUDmq5QHlIipZARsaZGy/Ctp0ElkiybKI59/XB9O4aQPS6IRemkPTrIsG/08vM=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by SA3PR12MB8801.namprd12.prod.outlook.com (2603:10b6:806:312::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Wed, 12 Jun
 2024 05:54:18 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 05:54:18 +0000
Message-ID: <4dadbadf-529d-6f50-b30e-8a428d8c6a19@amd.com>
Date: Wed, 12 Jun 2024 06:54:13 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Content-Language: en-US
To: Christoph Hellwig <hch@infradead.org>,
 Dan Williams <dan.j.williams@intel.com>
Cc: linux-cxl@vger.kernel.org, pieter.jansen-van-vuuren@amd.com,
 richard.hughes@amd.com, dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <ZmkkaOTUFuzIr2cG@infradead.org>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P265CA0274.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:37a::6) To MN2PR12MB4205.namprd12.prod.outlook.com
 (2603:10b6:208:198::10)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|SA3PR12MB8801:EE_
X-MS-Office365-Filtering-Correlation-Id: 5e2391fe-149e-4b0d-12b5-08dc8aa41892
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|1800799016|366008;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?QnB2eGZiRXI2czl6SCtEckFSVkZPYWdtbEM5NXhuSUM1ZzVoaGFnZWNlZ3pr?=
 =?utf-8?B?YkpZTHVLclEvamVabWNsSHJHQm5iT1N6TklmVTBLSjljeEhtd0hJWnp6YWJa?=
 =?utf-8?B?MGFKNlNWQlJaSXRXZEpHTlMvOW9pc1RUTFVzYmxDOGlrMm1kU0gwWFVaSWFZ?=
 =?utf-8?B?N1dtMk5BOXR2SU1sUVdtNzNlQUNJcFZCSVkxWFlDekFlOTYyeXVZSjhyNkRq?=
 =?utf-8?B?YTNDNGNvM0NMWkNGbmhiUUY2VUJqN1o4eHc2MzZ2a0VaVCtXdDNrT2NFNmU3?=
 =?utf-8?B?dmc0QUgxUXBENHUzeWI5K3NJTDJ6OFF4bWtteG9PVmtuTysrRllobjVmNTNq?=
 =?utf-8?B?QjgyQXNvQUtiRWFwcS9BMld3cmFFOWNlM1N5dkVmTzRVbmcraHdwUFpjcXEx?=
 =?utf-8?B?dEpIR2gyM1lxam9QMW9rdVROVGFWK3FCOC9lRU9XYS9hVy9PVnduMk9BZnpC?=
 =?utf-8?B?Z3dRMENSc01WYXFzWTcvTjBCbHRNRFk5SnNQUjNvRnJZRDJCNW82WFhHVy90?=
 =?utf-8?B?QmNLSzJOLzlzVEoybXl4QkdJMUY5YkpXVElIOXJuVTJ2MUliMmJjVWVYVlhr?=
 =?utf-8?B?WWw4R25GQ1BFaS9aSnFMTjk3UmZCSjRYd0Q1MTlRUEpPWXdwN3p6aDdCR1Vy?=
 =?utf-8?B?dm85aEVXaGJoTlJxOEtyb1FVM2U2UUhDWVl6Sjd4cWF1cjcwWmtaZFJQQXJj?=
 =?utf-8?B?TzFLWmw2RFlsQXdMbE04QkMwRzhuYjJid2Z6bE4xZGU4ZWx5RjJPMnNQMnV5?=
 =?utf-8?B?VUpLS1NjaTB0Zjl4YlRTWlZ4UGcrd3ZOVmpQTlZMWW4yanVROTQ3d0lqMnJQ?=
 =?utf-8?B?OGVsbExIYVNVNFhXRWlPbjdzOUtydURuekpqRGxDK00yUVJKME1YVjFLOWFm?=
 =?utf-8?B?NWVEYlcvNHp6YUQvZmhqY0dkTm5RcURxRkFIcnRJQTFFR01qcGVOcldxcTBj?=
 =?utf-8?B?b1dlQ0lIb3l1ZEY2VndTK1d2RWxhVGpoT3ZkTFBoclcydUNQR3VZYzRpQ0RN?=
 =?utf-8?B?ZDgzTTJNSGxjVnRaSWFLTHU0UkVTQXdJb0FIZXFnbDErWk9WcmxLQ1M0R09R?=
 =?utf-8?B?VjJQVEsrTVl2M1dTcnFGcXY1aysraVJ3bUxZbmFXcUYvRWZJcW9CZm1WNWIv?=
 =?utf-8?B?aTR0SHB1ME0ra3RqZnIzeXJHWGJrQzl4VDdKN1JuRWNGWENsZTk4MGpISjR5?=
 =?utf-8?B?MndBWU1pRzZ4TG9lZG15cDlITFJ6Q3A4Zy9TSlQxankvSEJ4bzZNZUY4TGk0?=
 =?utf-8?B?c1FSVGcrMmpzYVZraEFCUWtsNDBRcTJsOFZDTDF2Nk1xdDB4TnlaZnM2NXZQ?=
 =?utf-8?B?eU5kWmk5bW5DR1puZU1wc3RLN1N5UHA0cTNQUGUyOFBkVEFRTzNmenNVVGFJ?=
 =?utf-8?B?NHlnK3lNbXdhSzIwcVlsRTdUODJkSlpFV2ZXb281S1Q1bHJvcmtmbVpHTERU?=
 =?utf-8?B?Zkk5WXlZUWRTZ3NtNUtIUUNubkZwY0NTRWNMOGsrNnRRRGFLTUN1MkdURktx?=
 =?utf-8?B?WjZsSklVeG9JY3BaNDhPMTZrYWZ2am5vbHI1Sk9WRjdzYmdDNEg3em1GOEZu?=
 =?utf-8?B?enJ5Q2pKdWtsMGdic25IL3JRMUNXVjRzc2FKaEc0c2t5QlZLWlg4aGJDeXd0?=
 =?utf-8?B?clRoV2VSWi9KY0RDd3pmbUpwSDZETWZ6eTFKTzVVbEhmN2tXSTJUT0kvSEhi?=
 =?utf-8?B?eW9idFZhdVdDb1hoaTdRc3BKaGxaRE81RE1MbERTVUNaOXhaRTZWVUNKSWlD?=
 =?utf-8?Q?IpAKvKpoK/HEWAb+dGngv2AIxjlu5hoRePxhwRk?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(1800799016)(366008);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?TUtYSEpQSzk0dk9vOVNhKzhVMlI3MTJSQmlPdUNDSE5DOEZmd2hJajhxTzdG?=
 =?utf-8?B?akhiMEFnbmlXRUlkQjZ6cU52YXE0ditIYndscG5GaEZveGxseWpqT1g1ZXZV?=
 =?utf-8?B?S2hrQ1A1Rk12TS8wZ0ZTZU9xNnQ4OW10dUtralVEQnA5UEhSU2RMOFU5MXlT?=
 =?utf-8?B?dGl4WDVwaGx0RzNrOEhWaTMzMnVSWXpLbUlzalBpdEhEYnlpTVNPYnkxZ3lp?=
 =?utf-8?B?SXRCNTdGMHFaVnhUL3ZVOVVLNndld3E0Q0J0VzVQb3RTU3ZvNlJTQ0EyelpR?=
 =?utf-8?B?SGhsMFE3dld5MHA4cWg0TlVFekpKVllBeVBVaS9TTTRKRzFodDNnR0E0dXJ0?=
 =?utf-8?B?ODUxejhjYUtSZjZ4aTl5ZjZoVnBtN0x4ek52Rm9rT3dkUkhrOXhHV3FvRU5j?=
 =?utf-8?B?K0tqK3BJZnRNTzFYWlE0WVNuNGhzMVhwQ1FaQVRaVWkwZkg2Y0MxKzcyRVgz?=
 =?utf-8?B?RHBVd1orTG8rNEZjZUxoMVlrc1gyUlF3YVFmRXNFWS9RMjhqdkV5L2gvSEtV?=
 =?utf-8?B?SWNEczZCclY3S1Fwb20yWlg4WkJkSUFDR2tHWFBEaE1QOFpkckpuWEdBbDIx?=
 =?utf-8?B?bGhCcnRHWW91Z1Z1akMwbE5wTEhmV0JnSlZJamk1blhVUGlWaHFuOW5rUUd0?=
 =?utf-8?B?ZXZhd1B6b1lOdkM3RkRmMWJZZFR0d3F4dGxCbVRHUGZOQmdReG5Velo5eVRh?=
 =?utf-8?B?L3lGUGJYeUthWWFiUkNISnZtOFhHOFJvc01ueHVDWEtRV3ZHKzRyQzF3MUFu?=
 =?utf-8?B?WGx2NTM2Qk9LcmdwMXBRRG9PS0RXbVViSDdjUWU3emtuSnJxaTN5aXFLakpB?=
 =?utf-8?B?NHhLd0p5R0NMMjgxYlFNTUR2MTREeTVFZEpNNzZXc0gvVDFaUkZVTUtMdXNt?=
 =?utf-8?B?YTRxTnhoSS9ESUJUbDl5eEU4ajhuWVBLK2E3Y3lXTEkyckRRdjhxSTJ0bzAz?=
 =?utf-8?B?TzlUNnBla2wrYmZJVGdUaVRaWnc0SlkxYkhGV0pLM1VkNFAzZW1tQXRXKzAw?=
 =?utf-8?B?TDJtSzdEbmRPbFVHTnZxZm9pVFJ3YmZzQ0VUa2FzeXdoeGZqYUNiR0pNZWNV?=
 =?utf-8?B?NWI3USs4UmZ1Zjk1M0hGZkFVcXN0Y0NNL2p0VWVPb2RVcUpLelc2aWRTKzgr?=
 =?utf-8?B?SDdlVm9Va1A0UDZEQXJqYUN4dHhYTjJQcU01THBsODJnbk9pMjZxYTNpM2do?=
 =?utf-8?B?WjZnT3lGemZObllBcDhXMXZvSnR1QVFHT1ZPd3Y4YzRVS3pvVWFGTnVyTUxz?=
 =?utf-8?B?ZXlLSjlyYXBWT3JlVTc2WEVhYTBVU2czN0FUeE11bUZuNTRjOVhRbGYzOStS?=
 =?utf-8?B?ams5R2N3RzA1cG5walZDMGtuNTBkR2I3b3VpRjFNY1lNR0ZGbVNhL1FkMFN5?=
 =?utf-8?B?QlIwK2lWUitiYkw2cGp4M2FXUnNDNStZS2N1NEVhQ0w5M05aL2xFa2dRVHpF?=
 =?utf-8?B?aGpXTHRrUUhzcXlNM0I2d1BGRjFVVHZVNnhYUU5hNE4rWkQrYkl2R3VqOFIz?=
 =?utf-8?B?N0lVY0wxcmlTVnFXdmdYVXZNQk92VkM2ZXhTdVFQUTdsUDdWOUhodnFBbk9t?=
 =?utf-8?B?UjJvL2YvRjcyT2U1cktlbUgrb3N3TlU1cGpjay8vWHNhSE4rcTNDbzl0cHJU?=
 =?utf-8?B?RmN0SHdFWVh2WFlJSzNNR2MxYyt3QXZta0pkR1MvcmQ2aFVnaVhCRFF4SHR0?=
 =?utf-8?B?T05qMElmYzJCRm5DcStHYmV5dERDa1ZwTG5sdjlSQXBXaDRHVlI4MSs4NVBX?=
 =?utf-8?B?UjBobWN3TlhNZmNuOG1pUVdFU0I1Y09BMk5TUElxd3hHc0p1bjNuSW9yVnYx?=
 =?utf-8?B?WEhZOHVXS1hHTTM4WUxuZzhTREVGcmJKaWVYSERLSXU2OVhWbTljUkc1VVFq?=
 =?utf-8?B?WmR4TlJ4K0Vkc0ZiRlU2NVREWWRrVTFjNTZLSkxGUm1GZ202MC9jamgvUXla?=
 =?utf-8?B?c2VGbVZZRkFUOUl3RUluQktjb2pyaWh1QTI4Ui9NTmJhMjAzNHRET3Fia1kz?=
 =?utf-8?B?WFhuWjJwaktqT3RmM2hQQnVPQTAxQXl0MU1ZdzhEYXpTeXJmczhlUm9PREtt?=
 =?utf-8?B?K09Rb1Zvc0NhbTNYQ0ZKWS9wSXlFV29VWlh3V0NPQ01laEExdHJvcGhwaUNI?=
 =?utf-8?Q?LxZydjGiYl4jIZJgY96Y92tjs?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 5e2391fe-149e-4b0d-12b5-08dc8aa41892
X-MS-Exchange-CrossTenant-AuthSource: MN2PR12MB4205.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 05:54:18.0126
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 8ljgHaIhZRFyieFJdEq+W7ymsApbHA2Op27Oxt+y54AHgawl8RalBoF4q0jl3ASbGSMW6aHWUvridJ/p9rIh2A==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA3PR12MB8801


On 6/12/24 05:30, Christoph Hellwig wrote:
> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
>> alucerop@ wrote:
>>> From: Alejandro Lucero <alucerop@amd.com>
>>>
>>> CXL Type 2 devices imply specific vendor drivers binding to those
>>> devices instead of generic ones offered by CXL core like the PCI driver.
> No, it absolutelt does not.  There is no such thing as a vendor driver
> in Linux.


Well, yes, I see your point, and it is absolutely correct.

It was a bad way of explaining the need of a driver supporting a 
specific hardware.


>> So I don't like this approach, there are details that are private to the
>> CXL generic memory-expander use case, and some that are suitable for
>> CXL.mem and CXL.cache capabilities in other drivers. That distinct
>> subset should move to include/linux/. I.e. I want to see the incremental
>> conversion of what 3rd party drivers need compared to the generic
>> expander case, and consider when and where new shared infrastructure
>> needs to be refactored.
> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
> that we can keep a tight control over them.
>

My initial thought was drivers for ethernet, gpus, or any other kind of 
standard device binding to the CXL/PCIe.io and doing the CXL 
initialization. Your comment seems to suggest other approach, which I 
can only relate to using auxbus for the device CXL.mem and CXL.cache, 
andÂ  then being handled by a generic driver inside the CXL core. Is this 
what you are suggesting?

If so, I'm not against it, although it would require to study the 
implications.


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-BN1-obe.outbound.protection.outlook.com (mail-bn1nam02on2056.outbound.protection.outlook.com [40.107.212.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BDD0756458
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 06:04:38 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.212.56
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718172280; cv=fail; b=n51FXVNQeGeyqkYNUK5jfXRGicBxT/yE+zGWu6TVuOFrw5aAfre45lRXwb9fiYoSBpPlVhCsrGVlZziNU4HjHCCnZeAr3+KI+JIAHyYtKkmhwqmRpXvZBrGQi7pZEIZxHCG4l2KyAWROxLLC8E1luI/WZvSg+30SHrVBibpRN8M=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718172280; c=relaxed/simple;
	bh=Tm67+MYCrMhc5d6cCxTMJ0PVvjsJz8EuJIELLrS5FgQ=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=Atc6kXIoPkthu2XvwMgq493j6FuqdxyWKkZleEP9I00rHtggGFV+49m3/9UfCnOt5D8rWlwT/o/repoXpQV/UdshDHsPgyXbPxUzG4C5MFeAPEvNK2COPCpQPJnx3ES7eSayx4RdpwfnKMy4bW8w5Fc0aOlnXQyB9ImeLLJ1Sj8=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=eLq3ARvG; arc=fail smtp.client-ip=40.107.212.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="eLq3ARvG"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=JAm9bALOmFzdPUvFmwsp7iuEPN58YpZuyDGq3vWfBEkDO1YdEerRsfYcZFeNwNH6qA2dQt4tDdCqfouZUjo3KQV0nHvr8/p3MIcj0uhVfpWs/0WzzaSoDPKo1wjF7P22VIZtABflO6re4b3R4mXSS9voqR9rje4f17BaR1L9P9lLd6Bs+UBAG1Z1PxVUQe4jUU/h95AYyLUpvAFHpZA5wLr/SL601kqP2CAkJR2FRfbjrv7+xfGZVb8oDgUOl7pIyoq+FWKwk2zIQnchajBaTu218dNnnb7uJkHkBiRt7hvlpiq4idOgY3W7W/Z3N4Q6ix7VmGGcrM2wfA6aW2tR0Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=JEMOshjo9PZFBtUJwqG2UuLq4pxXYsiGt3xC0XRtJH8=;
 b=di5TadvPgREtzGtkotQ7xth+VCNnaA4FspK58waZKDzrSK/EyMGlc3jNk4mvh30o+nWzzUzJ3CrVGcQPuQ5CM+Mr8bfV1I1P/c+7+4BqwpUJaZ/tRL/6DDt1OBlqSincSQGVu3JveOVpxLQMZU7/KegKI6R+QfvqonEuSM6MfG4dzK5+qJbtUA5iAjMta505b7Q9y1NLV2/+mUcohwtSVIf6JT5c8t21rkonnpVLixXH6w1gS6cc1eXVv493HNUvNQW+G7pjaKDBxc0Ga83vd5YGeez5jcYfrV01pfySS0GxxHFXwDEu/jB7Zfc5wxyis7+xK3Q2qo4Kp1Dd6qBT6g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=JEMOshjo9PZFBtUJwqG2UuLq4pxXYsiGt3xC0XRtJH8=;
 b=eLq3ARvGngQux69Vt90K1DdUVGQa/16J1ztmRtBRffimNK+6FCSsGDROULv+I2AMRLKW4CEHFMM1SvbAPZSFyG6krliSr20iumvzl9LLoai0HIsq8+xKaKiQaiOPT/1GsH69E3wRBq7GEZsNwEX47I3ekOeXh4w8O/2w9JXcbuM=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB5655.namprd12.prod.outlook.com (2603:10b6:510:138::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Wed, 12 Jun
 2024 06:04:35 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 06:04:35 +0000
Message-ID: <b48e9bf1-ccf2-2ac9-3389-4175ae872983@amd.com>
Date: Wed, 12 Jun 2024 07:04:29 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
 <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P265CA0307.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:391::15) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB5655:EE_
X-MS-Office365-Filtering-Correlation-Id: 4545ebf5-b9ac-4628-4fe2-08dc8aa588b6
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|1800799016|366008;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?N2xVUTk2K3h2cDlTNzI4Nis0VEIyR0tKM291OGdncloxRSsxWnoxRmZJM3Q1?=
 =?utf-8?B?TnBaTXB3dnB4K0ZTSzdMVUt0akFORExxdmcvclV2OVRQWnN4R0R0ek9vMC9m?=
 =?utf-8?B?UDN0bzJpaFBRL0hJOTFPc04rVlBrQkJmMGQ1S2c0VldBdW55QjZqM0JMZzlL?=
 =?utf-8?B?bDNNaHJaa2JFRzd2V3dnTVFMNkx0M3JNekNVaHRBcjdSN2FrdkU0dEd3TjVS?=
 =?utf-8?B?TjA5NThCUm1CejNmVFloaXRNSFRCNjR0SEc4ZlREanYxWitXanowVE53SWNy?=
 =?utf-8?B?MWhOK0F4UzZsN0x2b1BscVI0OE5RYlpTWTFLbm04YWhMdTRNbjNRU2RDdHRy?=
 =?utf-8?B?STJxbVFXT3NKQkJQOWp6TWRaaERzMnRBektpZFpsZURLejdXWEZuVUtBZllh?=
 =?utf-8?B?SVZrOUVTU2QrNm5hc3cxTWtaNDgzWnAxUVJGMWhibTlLd1pGaFhxdTZzQU5Y?=
 =?utf-8?B?MnltKzl5K2VWTHBVVjNPbExMd1FFUEdRM0RWcndyc1NCUWFJaXU5OWtaa2dD?=
 =?utf-8?B?eTROSWNlQzlzRDNpLzFZVzRZUnhVUUZjRE93TmxyMktGM3RsWnlzQ2UySHBT?=
 =?utf-8?B?UExaUFJ2Y2ZxUUFMUFcwRWlaWWswRnFBV1c4Ujh1UUFkcUJMdVdWSzV3NVpQ?=
 =?utf-8?B?cGlqS3oweTJaZVA3MW51NytGSnk4R2ErOWkxSUZQZWJ2ZzFIbjBYdGN0TFE1?=
 =?utf-8?B?WlVDRTd3dG10QXorTE9KRmVCU3FYOU40RzIwUlpPK1l2bHNCdDh6eUZUcHdi?=
 =?utf-8?B?dlpreFd4RmRzREZpWnBGNXFmWmJlOThNZ2hOTUx5VFgvR050WjEwSXFVeHk1?=
 =?utf-8?B?dXpZa2FobW05Q2U1QTVGR21ia1JtcG91ZWlBQzZ2am9JZm5oZGJnM1dHWk9D?=
 =?utf-8?B?cGRjNVgrNVA1aC9nMmVhN04wUDdiRWF0L3VUZzVLRjNXSGVOWm1KK0duak5u?=
 =?utf-8?B?Nmc1Q2hVeWpkUDBlTkl5N2FwYzlOc2VTUmRreFphMTBFeUxHN0FVaEFVN1VG?=
 =?utf-8?B?NmZaM3VHa1ZpL1VQN3AxSUFjZllQaURwQWlMUGtyTWYxNjJ3cVQrNmZ0emJr?=
 =?utf-8?B?cE1QOC8vZmxYY0xwQktsU1ROTzJSbk9vc1ZoOW40YXpqU0dsZ3RnYXVvQW1M?=
 =?utf-8?B?NkZnUG1WaGlxRWtiWWpQenRKQThVVlpHS2hXSlhUTzB3Z3RYTjM4bU9KQ09Y?=
 =?utf-8?B?YVZSeUhlZ2lSL1pQNXBndGpEMkVob28vUDJWLzl4cFFrUHhJODFXbjBWZXNJ?=
 =?utf-8?B?SUJJSjlidmhlaXN1c2pOcnJwamVCdlhNZXhFRHkxb3FSQjZsdUpLR3IvMkl2?=
 =?utf-8?B?ekkxRFFCZHBBL3l0Q09TN3FGSlA0RlFhOUJkcm14QloybXNaSEkrZmpxTUFz?=
 =?utf-8?B?dUVWTlF3NVg1UGxnVDEvc1BYWGZURFZJdHFwWkN6V1FNK2VTRVNQd1ZNdmc0?=
 =?utf-8?B?aU80eWR6R1RPMmE0RWI2NzI0TXpEdWRQRXBRUlFNMmFWSnJ3R0FsTVJHbHBm?=
 =?utf-8?B?T29WVktURTF4RE42bGFaZ0FsVk8rcUw3RWtmVk1kaHh2d1doR3NVa3UydmtR?=
 =?utf-8?B?NEk2eFJqNytVNnZyQTNMbmVySDdJK1ZPMWpJK21BMUZxeUJtQ2p5Z2xMY3A5?=
 =?utf-8?B?TDh5SXAvYjRYQkJ6bTk1eWRac213Mi9YOHExUWZKbmJma1BBbjVNOFlGem5I?=
 =?utf-8?B?Zm5FeFhETGZnYnJ2WTAwTklsTFFyZTlleXI4elVrUEsxUGkzamVZTmhPcUNm?=
 =?utf-8?Q?MhWQTAJ9A9doCMZAOY51rwoNsiLqB46QvzLG1fA?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(1800799016)(366008);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?ZWJnUXpwUEhZa2lyN3ZYQ1VjZDJOUWZHaXJDSmNRdXFJUGk5TkVrQW5OZVVB?=
 =?utf-8?B?L1VBYVN5TFRsdW5VNG00eEw3Q2JQRDdzOGkweHpXVXRTdmV1OExSZHN1TzNv?=
 =?utf-8?B?ZUs3NUk3QVM0TFNyZVNlbWU5eVNSTHBXL242U0ZodVpMNDJQTVlmcm1GOUlw?=
 =?utf-8?B?dDJSRVhuWUxDYUVWUlpLcWUrUStSMEpVYmJtZEdPdDBQMTdoaXpKUCtsSzBH?=
 =?utf-8?B?ZURybGxuaUpUM3NWWFMxLzVPVjdpVk15K0ZSUGJqUU5LWCtvZjNDUndCWnQ1?=
 =?utf-8?B?RG8yaXlkc0RMNWtiaHA2VVk4K3BKd0Y1Qi9VdVA2UHJPSzRDaDRjMWNDMDFR?=
 =?utf-8?B?bzFIWkZ2Y050M1owdzNnNXkzQXE1VndCMDBhZHF1N0ZhdnBVcnFhRldtUGNN?=
 =?utf-8?B?SktHa3ZBcy9LN2FpeS83YU9xZmtkYnd0Z2x0elVscmtVUzV6SFlMeC9lYW10?=
 =?utf-8?B?SFVEQ1lhVmpaWXFVbjNUSStjc29kVGZuSVVRWXdlWGppTld0OC9VK2xxWlUr?=
 =?utf-8?B?SjQ0ZERscDdpbkg1NzlkSTNYb2hCY2xJbTMrUjRvVjh1WXpsUm5OU2lZZjJw?=
 =?utf-8?B?UmJEY2R3eFV3S0tXTUJiQXVJWkpXcVJ5NDMrbllsU1E1c09nV1FNMi9YRms4?=
 =?utf-8?B?R0ZNN0g4S094RDlDYTZBSWhTRGViK1UrZU1SY0hxZldlUHVNNXNiQUR4SElV?=
 =?utf-8?B?NVhMYmF6UDVOL3JqZlJkVm5kZnhyME5VYk5RZGpaUFpscjBGdytRV0s1Z0d0?=
 =?utf-8?B?ZjFUMjdvRmlKbnMyTWFKODQ1ODZJUWdHSUJoNWtiL1A4TWJHUnVCNWdXQktC?=
 =?utf-8?B?Y3ZlUXNCQ0VWYVk3L1NnYkxpMWc3LzY4OUtROHFBeXNma2dFY3ZndlVnQVV0?=
 =?utf-8?B?VWt5RGlFSnVJcFJIMTRXTTNzemdiRHRLWHdkSkg3aWFpTGlRbnB3bzRQTVA4?=
 =?utf-8?B?RkR6NVhDaTJCaEpMOVNCQ1czR0VLenBSZ0pnN01XTk5sT0lMaFBUYnE3UGky?=
 =?utf-8?B?STQ1UlhSM2p6TXRBNkdmM2VnWjlCbFpVSm95WHhDbGhLam5NMUpvdlRiVmlU?=
 =?utf-8?B?RE1UMDltSlhIaHdEQ0JuR1Y1SCt3VTVLNERwUW9abTluaEhYOVdselY1VTcv?=
 =?utf-8?B?Nk1VbktrOXY0ZStIT21kWGdKQ2o2b21aWTZ2bmlleHBGZ3VtdXlGb0YxU2x6?=
 =?utf-8?B?aHUrSnhNMDB3RVJKckk0dTA2UGFpZ0xuVTRxa1hjYTFIR2tNY3QremtCdHpL?=
 =?utf-8?B?bFhUcXpUSnpkUnRmbEQwc2svc3ZpclRQNUtFaW94WWtJRFVaT3ZiZEs3QUlZ?=
 =?utf-8?B?VnlJT3JCWTQ0ZUY0QkxCVk1pWlE1QTFVbHhxSFZERjBKMXpqM2xWcUFJOHNJ?=
 =?utf-8?B?S1pCUndvVDlwU0pDaWVFL3hWMks5cndHUmZNcmRGbzJPY3dSVDdLL2pTTXRL?=
 =?utf-8?B?T05TOHorQmRUZDdPc2gzYWc5R05xdVh5c1hOSDZmaGJHR3oxZGhEVytQZk9V?=
 =?utf-8?B?V0ROVVlzQitsZUdQaEt5WG9sR2dYbmRQTG53YTd1WDU2K1JMWVpDcjRENFJk?=
 =?utf-8?B?NWhIY3dzU29LcXVGUGxMM3Q1MTNrZjBQSGczUHJPN0xzZHpwTCtGeE0zckNX?=
 =?utf-8?B?VENUeUhTYU1neDk0YzZzTzhCWTZrRXJmek5UdDduQTV0VmNkVkNLUVAyNUlo?=
 =?utf-8?B?TjlMMHpqWGRwTUVuZkNORzkzZkJvRW1PT093U0tNQ3hxWkFOMGJSK0UwTUJQ?=
 =?utf-8?B?OUJocVkvaDRVeHpQTlRPSGtLNGxadDZrbWVoYkZ4d0xVcGt5b01oWktiUjNY?=
 =?utf-8?B?RDRibFpUVjBpdGpValoxQ3lVSGhNaWJ1bFU3bzZZeitPM1RyZ1BwdHB0US9p?=
 =?utf-8?B?UXRRY1ptV3lQUFJXV1FFSTEyNm5XMmU3TUNYU0Mxc20vV3NSbXZNeldZcVF3?=
 =?utf-8?B?eFZaeGV4NXJVNytTUDlTTjVSUVc0LzF4L2x1andIdWRoSWh3Vnp1Ung0MTla?=
 =?utf-8?B?cmxJUmh4NEFOL2gvTm1ka2tZVVh0bzV5bldJeWhhdUhRaWVieWU2cEluYjJZ?=
 =?utf-8?B?TDU5Y3BodHlSbGovcnlvajU2dy8rQ3JKZzZuZjQ2N1lXOVA1Z0N4anRKYTAx?=
 =?utf-8?Q?120nRfxbeFW8Hwjcg9Q8sFtGG?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 4545ebf5-b9ac-4628-4fe2-08dc8aa588b6
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 06:04:34.9575
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: rGP+SKtoHl0nuvL8turWLA2hG8EWYlfHHOT5yJmWLdmoYBa06RCLfloV0IkbaZZbSiJXwGsrtLr7/ytdwNJzRw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB5655


On 6/12/24 05:43, Dan Williams wrote:
> alucerop@ wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> Differientiating Type3, aka memory expanders, from Type2, aka device
> s/Differientiating/Differentiating/
>
> ...actually to make this imperative tense don't use gerund phrases, so:
>
> s/Differentiating/Differentiate/
>
> This "imperative tense" preference is borrowed from the x86 tip tree
> patch recommendations [1], which reminds me that CXL should create a
> document like that to make the grammar expectations known.


OK.


> [1]: https://www.kernel.org/doc/html/latest/process/maintainer-tip.html
>
>> accelerators, with a new function for initializing cxl_dev_state.
>>
>> Adding a type2 driver for a CXL emulated device inside CXL kernel
> s/Adding/Add/
>
> I will also note that ChatGPT does a decent job at converting patch
> changelogs to imperative tense.


OK.


>> testing infrastructure as a client for the functionality added.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> It would really help me out if the changelog mentions what you adopted
> and what you modified. With a Link: to the patch where the code
> originated.


The patchset is mentioned/referenced in the cover letter.

I will add individual references as well for any patch needing it.


> I will still review the parts I wrote previously to see if I still agree
> with them, but its taxing to come back to this patch cold and think "did
> I write this routine, or is this new?". Can you repost with the
> changelog commentary fixed up to reflect that?


I'll do.


>> ---
>>   drivers/cxl/core/memdev.c           | 15 ++++++
>>   include/linux/cxlmem.h              |  2 +
>>   tools/testing/cxl/Kbuild            |  1 +
>>   tools/testing/cxl/type2/Kbuild      |  7 +++
>>   tools/testing/cxl/type2/pci_type2.c | 80 +++++++++++++++++++++++++++++
>>   5 files changed, 105 insertions(+)
>>   create mode 100644 tools/testing/cxl/type2/Kbuild
>>   create mode 100644 tools/testing/cxl/type2/pci_type2.c
>>
>> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
>> index 07cd0b8b026f..0336b3f14f4a 100644
>> --- a/drivers/cxl/core/memdev.c
>> +++ b/drivers/cxl/core/memdev.c
>> @@ -659,6 +659,21 @@ static void detach_memdev(struct work_struct *work)
>>   
>>   static struct lock_class_key cxl_memdev_key;
>>   
>> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
>> +{
>> +	struct cxl_dev_state *cxlds;
>> +
>> +	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
>> +	if (!cxlds)
>> +		return ERR_PTR(-ENOMEM);
>> +
>> +	cxlds->dev = dev;
>> +	cxlds->type = CXL_DEVTYPE_DEVMEM;
>> +
>> +	return cxlds;
>> +}
>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
>> +
>>   static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>>   					   const struct file_operations *fops)
>>   {
>> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
>> index 0d26a45a4af2..e8d12b543db1 100644
>> --- a/include/linux/cxlmem.h
>> +++ b/include/linux/cxlmem.h
>> @@ -859,4 +859,6 @@ struct cxl_hdm {
>>   struct seq_file;
>>   struct dentry *cxl_debugfs_create_dir(const char *dir);
>>   void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
>> +
>> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
>>   #endif /* __CXL_MEM_H__ */
>> diff --git a/tools/testing/cxl/Kbuild b/tools/testing/cxl/Kbuild
>> index 030b388800f0..a285719c4db6 100644
>> --- a/tools/testing/cxl/Kbuild
>> +++ b/tools/testing/cxl/Kbuild
>> @@ -69,3 +69,4 @@ cxl_core-y += cxl_core_exports.o
>>   KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
>>   
>>   obj-m += test/
>> +obj-m += type2/
>> diff --git a/tools/testing/cxl/type2/Kbuild b/tools/testing/cxl/type2/Kbuild
>> new file mode 100644
>> index 000000000000..a96ad4d64924
>> --- /dev/null
>> +++ b/tools/testing/cxl/type2/Kbuild
>> @@ -0,0 +1,7 @@
>> +# SPDX-License-Identifier: GPL-2.0
>> +
>> +obj-m += pci_type2.o
>> +
>> +cxl_pci_type2-y := cxl_pci_type2.o
>> +
>> +KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
>> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
>> new file mode 100644
>> index 000000000000..863ce7dc28ef
>> --- /dev/null
>> +++ b/tools/testing/cxl/type2/pci_type2.c
>> @@ -0,0 +1,80 @@
>> +#include <linux/module.h>
>> +#include <linux/pci.h>
>> +#include <linux/cxl.h>
>> +#include <linux/cxlpci.h>
>> +#include <linux/cxlmem.h>
>> +
>> +struct cxl_dev_state *cxlds;
>> +
>> +#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
>> +
>> +static int type2_pci_probe(struct pci_dev *pci_dev,
>> +			   const struct pci_device_id *entry)
> So to date, tools/testing/cxl/ has been for cxl_test which skips all the
> PCI register emulation and just runs based on mocking core-kernel and
> core-cxl interfaces. I would like to explore how far the cxl_test
> approach can go and leave the PCI integration to when a driver can
> reference real PCI ids.
>
> Otherwise, I feel like too much development effort can be diverted to
> this "proxy" and increase the timeline to seeing the real thing.


Fair enough.

I think I could add the real driver in a new patchset version or maybe a 
completely new one.

 From my previous comment about potentially using something like 
auxbus,that would obviously mean a complete refactoring.


>> +
>> +{
>> +	u16 dvsec;
>> +
>> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
>> +
>> +	if (!dvsec) {
>> +		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
>> +		return 0;
>> +	} else {
>> +		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
>> +	}
>> +
>> +	cxlds = cxl_accel_state_create(&pci_dev->dev);
>> +	if (IS_ERR(cxlds))
>> +		return PTR_ERR(cxlds);
>> +
>> +	pci_info(pci_dev, "Initializing cxlds...");
>> +	cxlds->cxl_dvsec = dvsec;
>> +	cxlds->serial = pci_dev->dev.id;
>> +
>> +	/* Should not this be based on DVSEC range size registers */
>> +	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
>> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
> Especially at this stage of the driver there is nothing that require
> QEMU emulation versus cxl_test mocking.
>
>> +
>> +	return 0;
>> +}
>> +
>> +static void type2_pci_remove(struct pci_dev *pci_dev)
>> +{
>> +
>> +}
>> +
>> +/* PCI device ID table */
>> +static const struct pci_device_id type2_pci_table[] = {
>> +	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
> Real vendor-ids should have real device-ids, also that particular
> device-id choice is not appropriate.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2047.outbound.protection.outlook.com [40.107.92.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 75D1484D0F
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 06:07:15 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.47
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718172437; cv=fail; b=rana8jkNxUhbred5BJR2ti4+V8SHc/VVJBnx68JCgN8vR9nSTgr/IFwFJ3CH3OWXoA0O8e1AOWBXvI2E1QL0g0PURPrSEteMhWHmFyrYugl7WcGwlJ2U2mZnlrm1yyrR5spVeW0ZO0ztX6RQekEYP9bZ7ekodATG4J2cnJUkOz0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718172437; c=relaxed/simple;
	bh=qKgodqiP6hZCNBLIv2dsNH+rxqcmiVEmMeVRunKiIfM=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=ioxjqAkjqJZAC427rhvphO88Kn68oL6Fpgotm8zwm12ZeUkdgvk4ihDI40NObeHhGVUZvwPKALta6RAsWltSIMTFUD7Phow49NfQDIKsr8DZsJ+e+E/1PvoRyGm0xLgmsA7MdDvxbHPQu9eOda9aU1klRzxpWx8j40zC8CchDyQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=dfIwOMbW; arc=fail smtp.client-ip=40.107.92.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="dfIwOMbW"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=GH3lRnWAG9pBJmG3xDgjKnk3Q48NZL6sdOXIjrGpeU06CDTAWZ+JeeAnd4PT4aNu1IjFqLQ4Fpijif6xJv2fSLFyWs9FcsuIPJOwxHzt6nGOoM0IRhrN1JWWH3d/IUowO01kTgQt2+H+CXPUL5pBcX0391o/6J95IYg7qd4Gmk+V2v34Fh4dsbvbyJkeDYOfDxd7aYZf/51aI9men8MhrMQrrN3IU2OzZrALPWqEN8iudpl8K80FsT4o7LJzniNPPb34+rYYQ/rs9v+lrFUduXK0kIY2ESFBf2HN/Ng78VKs2EObIZS4ncvxjwmKG55z+hy7fu3k1k8kqzQNoXEoqA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=5Q2NBjJmJzY1W+T73cFv6kpnMlu4vsWDX7XPU+cBeSs=;
 b=AYqTkloaOis3SH6JqyASkqhHgeaLAcYXHk16SzhAA3ukyOiuJqWLz4WtMIjqqCYS10rQlfggb0KmOCIK0G7UAQWeaKkOT41Lg3jg32P8sNjCqKhNQQ/1spylT0WLL1huMQHYOoGlO6PhpAUE7OfKXOWUrazOItnjRA+HCkcvQF1P2CCqdE4ZgN6fZBRSI5Zx0iNxTfyRaCXCLuPU8KiRrHAP10F9rK8C/CT3MXspnffh/x7uQ7LCK7xTgR2ZiPTAH/zBz6/jUAb4k2QNI2UUDWCYwoKS6knCo431hX4SfSYlfscrAo+u7OpCEVSsUZ4z9e41t4N6qVijYTNRxY26IA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=5Q2NBjJmJzY1W+T73cFv6kpnMlu4vsWDX7XPU+cBeSs=;
 b=dfIwOMbW8iweaThwXNWhDmRDTf5qWPIxHgYijr0uyKbxJ64m/WjAfmy5LiujN3hZyD8H4MFEfLhORa5sTmnkl1gYaXLuf60qRgskqhTAfzPApYJNOegDMvOstTAFa+eyLWYa4yyPgm1uvoi0sfKa9lk7N9dlbeD1jVQb5ucBn9g=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB5655.namprd12.prod.outlook.com (2603:10b6:510:138::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Wed, 12 Jun
 2024 06:07:12 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 06:07:12 +0000
Message-ID: <30515d14-2cd6-1967-c656-e8b17ecfd8d7@amd.com>
Date: Wed, 12 Jun 2024 07:07:08 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 03/13] cxl: export core function for type2 devices
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-4-alucerop@amd.com>
 <666928a27eefc_3101294c6@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <666928a27eefc_3101294c6@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0344.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:18d::7) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB5655:EE_
X-MS-Office365-Filtering-Correlation-Id: b8280188-3fe4-4dee-8c6c-08dc8aa5e69e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|1800799016|366008;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?WWpOMWFrK0dubjhVOWZYYnNoRW1sR0lYaUYyNEZLelZLSEE1UldkODI4ZjZt?=
 =?utf-8?B?bU1ZT1pDeGNDQUxnZjVyMGRSbUpXNFcwb2tOMTVHVUxCb3NBWUZiREdBQzJ6?=
 =?utf-8?B?OHJaVXM5SE5VOWVIVHpKMTJybCthQm1MUzJ4SWRZV0w5b0RjdnZ0RUlLZjFV?=
 =?utf-8?B?UVBTcTZDVDA1MDRxK1hJVlZzUTFHdXIyZ2U5dGpVTi9vbThYcmRGd0FlYlNV?=
 =?utf-8?B?YWdkYytKVmtCNDRnN09oQWZ6WDdwenU1VWtYUkNrakRLdFc4cmoreldFZEwy?=
 =?utf-8?B?bDJ5cmRibHQrRzR6Vjd5cnZrdzNNTjdvMWl0SGxDRUpIZG5KVmxQM1grQklU?=
 =?utf-8?B?bS83Sk5kdUloTEFpbkJFSXVkdDRGYkdicWd1Z0hLaFZSRW92MnduTmttWDgr?=
 =?utf-8?B?WDZraHV6Z2EzTlhFNHI3YUlTVXVaeTJ4V0ZOV2JqRlYwU3Zia1pVZGF1SElH?=
 =?utf-8?B?YnU3NVpOQ1RNTjl3bHg0ZmI0N2YzNjFyS0wvRTZvczdLZFV3cGZPbkxSakx1?=
 =?utf-8?B?c2hCOWd1UEZDc29zbFNDTERvdTNTOFR1MjZyVlZOdldEZ20xcU5hTlBhZUN4?=
 =?utf-8?B?WlVjWCtqTVBVZnVyOW9FZE9zNVVsS2hkMUNHRitPcmhYTURPQzJvNUE3OEox?=
 =?utf-8?B?QWNwWkNqK2ZrRmJGMmdRTGNOSnRkVTZhK1Z0WDNnNUFORGh6bXhIeVdITDMy?=
 =?utf-8?B?cjZ3RlFGalpBRVFiZnpza0F2bjJuV3YwNW5GRUM5SXJBVERWRU9BcjViQ0pZ?=
 =?utf-8?B?TG04dHNEMDRuc3NGQWJHc2c1RXM3Z2paWFlyV0VNbmxDazVWcGZ2ZmRycy9N?=
 =?utf-8?B?NHZ1WXZhWjR2THROZGJjQ1cyR09lcjk3S2R2ZkJjQ3lFSEhlR0hSNlZhQVBq?=
 =?utf-8?B?RUFaYWxwWE0yZHJBOW5QTEpWSXo5TVVpTzJydGxPVEZBTkVMajFKc2drczB3?=
 =?utf-8?B?Vms0czg0Q011azl2Nkd1a0l1bkcxcVlLdFNRVmtyVklka0puNWRTZUZ4M29h?=
 =?utf-8?B?enpJNjJCOGhreHM4MnZkcnUzUHJCVEZNQWl5K3RRNVhIbVVjMkJCYXcydnhl?=
 =?utf-8?B?UXRCaGZodkZCZUp3bUJ0OXdDbG5CQ3Q5OERFOURkT2xBOSs0K3R3ZURXSEFL?=
 =?utf-8?B?QXlzSmdLdWN3Rk5oV0NEVWFNU2JTeEhSQjNjQmw4M1ZDeC9WWGlVb296V2Zl?=
 =?utf-8?B?Y3hXS0tsbVlWWEVCUkpJNWhORG5ieFFHdWFad1Z1ZmxHQkUxc2RzYXN0NVJi?=
 =?utf-8?B?S2pvSVdrVjhLRklEK2hOVk1VNXBqRDgrdVhsZGEyUXRaeW9pbFQ0QVZ2NWl6?=
 =?utf-8?B?dm1iNXV5ejY3Z2hXQU1tUlBtVXVFSE4zV2dESlc5aVc1WTQvTWR3dVFZbUxK?=
 =?utf-8?B?Y3p0Q0JreTVCNytNQUtxNnBCaGVJQVV6bk5LM2JPRjV3SktRbnJJTlI1V081?=
 =?utf-8?B?SGJMK0FIYlkrZXY2SFg5YW5qZmJXVUtxWVpEUHcvNzhYQlE2NEJpTXltUXpU?=
 =?utf-8?B?dHV5dkpIaDN3cUszbnRaaUlNRHlsSHlaSW5iTGxkMnEwK3ZkZnlNOWdtSnFr?=
 =?utf-8?B?dHBaTi9HaXhvS3pGM3JOU09WWUVxZlpUMUNLUExSeFkzd0U4a1gwYjI5U0FR?=
 =?utf-8?B?aThlYmNmb3VhYWFYdjQvTTlMZlMxVVNxajFkVTQ1MjVvWlNMZG51bU9aTEUy?=
 =?utf-8?B?QUo5K3B2MFFLQzcrOXVkcU1uVzRvcWhnbFNCai83aDlTQnpMcTRBTGVnR1Zj?=
 =?utf-8?Q?o0Ga6HEnOKJOzNrw4KyCBXfqansSnyfAy941Ce5?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(1800799016)(366008);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?a1VFelZSZjJHaTI3dHNvcEhVR25wbEtKMll2SUhuZE9kMGw1VGN1Mkhud1hE?=
 =?utf-8?B?clE2OHZNMnhCY1QrbE4xcHNBWlZDSkxoTFVuMFoyQmI3YkdtZmpMY1N1Ulk2?=
 =?utf-8?B?UzFIUnE3Q21pUE5wV1VCVG1nc1NiNjM5Tm5JT3hMdXZHTFgwS0t5dmkvd1FW?=
 =?utf-8?B?cjZDWU9TRmV3UldCTzVnUkxKd1EvdVBCWGJVbnFVTHJISVFGSUcwendYanA4?=
 =?utf-8?B?ZVdYOERhOTA5VzlpYTZ2Z2lwLytSOUk3K2VQcUJlYkVuYzR5YWRiU1V4RzZr?=
 =?utf-8?B?Q2JkMElGUTdiZENqSG5XZHJacWkxTG5HamM4Y2RtZU5EdEIvTkVqOVk2TjZQ?=
 =?utf-8?B?OE50c1FXRVRZbCsrVkM0NUNNWThaSy9PRFNhZSthb2VuaElTUU1waURKalRi?=
 =?utf-8?B?N2dxTWtuaGphd2ZGNDFzOEtEcXdPdjRUa0RXV0U0Q24xS3YzeisrNFVSWWdD?=
 =?utf-8?B?Sno3OURVM0wwQXZ1YUVuOUpQcWNrUUVWS1dXUW5KeWYwT3FFZlp3dHFHMXg5?=
 =?utf-8?B?ZE9maG9BR0lTeWVWR2xHQVlSYUVIQ2pXRWpuUTNSeXZGMnNlUFJKaHA1ZmNV?=
 =?utf-8?B?R2ZqcGtCUGdzUlJmZDQ3NGNhZFUxRXUvb2YwZ1cxd2NyN3B0S3ZXU3BDaWpO?=
 =?utf-8?B?QzhSRHVTZzBXTkJmMmxlbHdrUTMydXRzaHYvUWwycnlSenprNURHa2djSGtz?=
 =?utf-8?B?Q25ublppa1U1MjNyRExVWkNxQzFPOEJNd0l1S2NhK0p0WmlNKzhmNTU1aEc2?=
 =?utf-8?B?YWVQQUhDbjU4eW1TMlZwVEVkNVh1Uk9qMFNIY2YxN0NwaXZrYi9qcGw2c2th?=
 =?utf-8?B?aXRBZ2UwOWNmR0tHM1AzMTB3TDYvUm9xNDRBRzVJT1BLZWhOVGozYjJYRzBh?=
 =?utf-8?B?V0tlUkJwU0Z3WDRnZVFlbUhobExrYmFoNlV0TWRrQzVNVkFiWCtiYUxSbG93?=
 =?utf-8?B?QUlFakFMc05JMnBoN3BCTXU1YnJSeHZpdWpYSHNCV1phcUtOYS9Tcm1wSHJG?=
 =?utf-8?B?T0hQMWErUUtVVDMrZWNYVWs4T3JSYVNnYmtDbVNYZzVaNGw3ZGVKMjZiOEZp?=
 =?utf-8?B?bmN4MUVUUzNCLzZJOUZSaml1SG4wUkc2S3FSM0hWeEJHNFVkS01ZamVQcDFR?=
 =?utf-8?B?WXM2cG13WmNBcllRTlVubUxmRGoxSEluTHFLQ0d6VWtBUlBEWkVOYmFYaE5O?=
 =?utf-8?B?OStCMm5yc0NHbDVvOE9jWTR4QmwxMHc4cUVrQ2x0bE5mRGNEQjJsR21ZV1JT?=
 =?utf-8?B?N29ZeHNobTU1cFdTcDlHVWN3ZW5YWU1BVThpMEhMcUc5VWVYYU8rWlV0TWN5?=
 =?utf-8?B?RVZ6QlJVTThpenlyemlVTmZ3bjhzeWNDOVZBUlZ1WksvWktUMWlBWXQyK09Y?=
 =?utf-8?B?eHEyMDY4dGZZQXFpd0ZMRnBUWmRkQUh6MnJvcTFFTDJ5Mkx5U1IvelBQUUIz?=
 =?utf-8?B?b1pQNlVXaXpsYUV0OXM1QVMyRUNIblpYL3NNZW91cFVvaFlrRFQzZnc5TC9Z?=
 =?utf-8?B?U1lJM3l3ZHJ5NmYvNEtyUlF6R1ZIdHNIQzRaUnZkRUdLVFBoZjdrV2QxVnFu?=
 =?utf-8?B?cFEwWUkzS3UzTjZadnVjdTBLREpMaFU0UWVLT2kzdk1lVkcrSkRkRVgwNnE1?=
 =?utf-8?B?aGt3V1I4QnZUU0trbk9sYmRWTlhPTnYzTlNCTzRQYzNWSGk5MVV4T21yWjI5?=
 =?utf-8?B?dzhQWEk5aUlkRWRpNW5zU2JXYkFQVVF4a3VMV3g3SWwwZENEczBuaEhGMVZp?=
 =?utf-8?B?Z3JIT0t1NVZ2bzM0TWpiWVd5dUUxR2VZcExhbXBxV2xtZVFBTXQvZ2tmaGVq?=
 =?utf-8?B?cE9kU1p4ZW1wMUZkNmdoR0tmZ1pDQ21pdjVsK2UrVDNvZVRheVNZSUMwSmhG?=
 =?utf-8?B?ZzE2MHBnalc1ME1LUUpmdk12dE5NRUVNaUFJRnJUOVg1bEpYWlBCSzFXQjFm?=
 =?utf-8?B?ZWJZNDFlM0VCemxjZWsxN09xYlpRc2FYUVV5dHJJZno4dzd0NzFjQ2dObFNR?=
 =?utf-8?B?MGlXSjVnVEZYbjBpVWFwQVUrV1BQbUFrMktGc3RlSUpkNmhZeWxMTXZPS2dL?=
 =?utf-8?B?dTZhOXlpRC84RWV4a001Q2lGcEFIbm1sdk1ZT0hrdUlIMjBQcEw1aWE2YVhO?=
 =?utf-8?Q?5/B6y2C9KS0xNL8hNCcpMUX8L?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b8280188-3fe4-4dee-8c6c-08dc8aa5e69e
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 06:07:12.4852
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: TtYeuVG6P0WVHuD9d8/IIzICeILyEhmjV4KGF28hZ6CnoUHGRqTmsl9yfM9+oxc2kATdhwWfdoL0EAY4fyQd/w==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB5655


On 6/12/24 05:50, Dan Williams wrote:
> alucerop@ wrote:
>> From: Alejandro Lucero <alucerop@amd.com>
>>
>> CXL initialization by type2 devices requires to use current CXL kernel
>> infrastructure only available to such core code. Type2 devices are by
>> definition owned by specific vendor drivers which need to use part of
>> that infrastructure for initialization.
>>
>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>> ---
>>   drivers/cxl/pci.c                   |  3 ++-
>>   include/linux/cxlpci.h              |  2 ++
>>   tools/testing/cxl/type2/pci_type2.c | 31 +++++++++++++++++++++++++++++
>>   3 files changed, 35 insertions(+), 1 deletion(-)
>>
>> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
>> index ccde33ac9c1c..497276302017 100644
>> --- a/drivers/cxl/pci.c
>> +++ b/drivers/cxl/pci.c
>> @@ -500,7 +500,7 @@ static int cxl_rcrb_get_comp_regs(struct pci_dev *pdev,
>>   	return 0;
>>   }
>>   
>> -static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>> +int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>>   			      struct cxl_register_map *map)
>>   {
>>   	int rc;
>> @@ -520,6 +520,7 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>>   
>>   	return cxl_setup_regs(map);
>>   }
>> +EXPORT_SYMBOL_NS_GPL(cxl_pci_setup_regs, CXL);
> Any functionality in cxl_pci that you want to export to a 3rd party CXL
> driver needs to move to drivers/cxl/core/pci.c


OK.


>>   
>>   static int cxl_pci_ras_unmask(struct pci_dev *pdev)
>>   {
>> diff --git a/include/linux/cxlpci.h b/include/linux/cxlpci.h
>> index 93992a1c8eec..28fa4861a4f9 100644
>> --- a/include/linux/cxlpci.h
>> +++ b/include/linux/cxlpci.h
>> @@ -130,4 +130,6 @@ void read_cdat_data(struct cxl_port *port);
>>   void cxl_cor_error_detected(struct pci_dev *pdev);
>>   pci_ers_result_t cxl_error_detected(struct pci_dev *pdev,
>>   				    pci_channel_state_t state);
>> +int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
>> +		       struct cxl_register_map *map);
>>   #endif /* __CXL_PCI_H__ */
>> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
>> index 863ce7dc28ef..b12f13e676fb 100644
>> --- a/tools/testing/cxl/type2/pci_type2.c
>> +++ b/tools/testing/cxl/type2/pci_type2.c
>> @@ -12,7 +12,9 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>>   			   const struct pci_device_id *entry)
>>   
>>   {
>> +	struct cxl_register_map map;
>>   	u16 dvsec;
>> +	int rc;
>>   
>>   	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
>>   
>> @@ -35,6 +37,35 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>>   	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
>>   	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
>>   
>> +	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_MEMDEV, &map);
>> +	if (rc)
>> +		return rc;
>> +
>> +	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
>> +	if (rc)
>> +		return rc;
>> +
>> +	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_COMPONENT,
>> +				&cxlds->reg_map);
>> +	if (rc)
>> +		dev_warn(&pci_dev->dev, "No component registers (%d)\n", rc);
>> +
>> +	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
>> +				    BIT(CXL_CM_CAP_CAP_ID_RAS));
>> +	if (rc)
>> +		dev_dbg(&pci_dev->dev, "Failed to map RAS capability.\n");
>> +
>> +	pci_info(pci_dev, "requesting resource...");
> Setting aside whether this driver moves forward vs a cxl_test mock, if
> you want the driver to be chatty use pci_dbg() or dev_dbg() not pci_info().
>

It seems this driver will be removed in future versions or probably in a 
new patchset.

Thanks


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2053.outbound.protection.outlook.com [40.107.237.53])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id DEC0616B75C
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 07:13:20 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.53
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718176403; cv=fail; b=IOKkP9mYgkmxEmCTl+XqR09ALviTh+17TEyrfIR/WYyQILW7vFxsYwH9gggri2TvpHFcGZIvweXfVpZlF7FzAhX2tqGwn0qP0v78E2c5HxwGRaPHgXu9KHWeutOhcYVXiK0VqVI2THOZwWFRxqnbpxwNQb3cfbGWr7gCfrLsGeM=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718176403; c=relaxed/simple;
	bh=xrr8qKFAVZ/aozRa+LXrgl5gERc+hLTDMMSlyhrO3ao=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=rgrGMHrqG5wQID95x2PJGYhsWB/nkm6ebQ2tgNn094e0/YqoYGru1LSG7GbqFjDfP++hAitNKWxvIVYA9njWcOuViKLnLvS1tUk2ZptFwSPNffAtdq6y+/iqBg7uj5s/aZRVS8SF2swC+gDlKMw494sF+IP/xlXe6h5jiphU+OA=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=qeLsz+QI; arc=fail smtp.client-ip=40.107.237.53
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="qeLsz+QI"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=nV0AbCIxXserYdBPKr8+E3vGo6Cnkojpa0iE0C40uzpcqVtnhD7UZ07J8ptiHtAuJTk6JI0UP5R+bI5gwEP2arDwTQWtVKlRU+4sC6gjZj7j/kqOb2MEhddod/MzdWlB0IztrAm+SilcrFDjp9zxHyRoVG11YXo0YR+79FnjdwVai4Oazp0Dy/bYupHBUv0Z0nq6325pCzU6CcwUeTFDdOz9vQSJOYUSpDjahd7azs8hD+UXNI9SNjUDbLvjNqJISjePbE3UEsJkYWCA4iQhdDvir0JS6xrHJFNZjVSp40bxf+FwDfmHRTthgzbAokY9ebsoh7dvDYUc8qUzzQ45ug==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=szSJCrFaZVLpdkaqNtcuk+w2Ot2zV59wgGql9HJyrqM=;
 b=ipuKLmT9wzGJoMViSPlUw/cy1yQQGmil1+q+l7H1puJo9HG3LEAnugaQhcjW7vbH63jjdIu12W/SiKe/+aK7rNlLIkDFzKV4BDqzTkYZnk5F7gQOSvv9I+JwSNRLPoRYlj+MQi/yZrzdDxqaYYHJ7Wuy73VXjuiWB7b/BgP6aZGSzitsVp87MA3GMVKWXB8t/tLvKec7LfAHls9Xe+dQsBsXtRzXmD2lnUnseJ1z0XLOGl7bN7aDK7K3Mjm9et+L1WHV8JZ1rJrODSnp73SuVwLQVQQQK2GNUactfHKyV+kH1LRbHVMCvJiVFtdqNm1uteRJyfos5cs8p5/1Bg8H2g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=szSJCrFaZVLpdkaqNtcuk+w2Ot2zV59wgGql9HJyrqM=;
 b=qeLsz+QI4csyHbTpSq7kwZAfF2SZlxM1ZIjy435kyRgDVmrz8Z0pDcqjugMpZ/LjSDCID+7O9F0B2yrHZn+A/bcVFD1ZTLPzH/oGmlokOiC0dhfqjQXCtGAa0AD7CMWATdl5cLA18cKDf0sGfUV/OYjGTK8hRg+fn/pYUuGq1UI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by SJ0PR12MB6734.namprd12.prod.outlook.com (2603:10b6:a03:478::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7677.20; Wed, 12 Jun
 2024 07:13:18 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 07:13:17 +0000
Message-ID: <604ede40-c4ec-7fdf-234f-a67619136dc7@amd.com>
Date: Wed, 12 Jun 2024 08:13:13 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Content-Language: en-US
To: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240516081202.27023-3-alucerop@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0512.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:272::18) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|SJ0PR12MB6734:EE_
X-MS-Office365-Filtering-Correlation-Id: 964caff9-c0b6-48d0-0692-08dc8aaf2225
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|366008|376006|1800799016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?SXlPcFQvL0p1dnY3VmZ2MElEekE0QVpwTkYyWjFiTCt0bHRYODRnNXp1SkF6?=
 =?utf-8?B?Rmk0QzJ4NTVrdDNmVkd1K1U0b0JKV21yL2FoaGl0N1dNQ1FxMklEWWFHb2pD?=
 =?utf-8?B?bStXd2N5WGpvRWt4ZkdFdmRlYVl0Vk9teUtGUTUvTjVqWFN4UU5CZkNOVUsz?=
 =?utf-8?B?TmFWRkRCQkN3Rk1DWjcvckhIK2FlRUJFb3ZBSmhVQWw3dVpseEx4QlBMVTlo?=
 =?utf-8?B?ZittS1piTHRRWU4vcTVTMDNCMTk0Snp0NEE4ejZNVFVJL1NON0ZTTGY5Qi85?=
 =?utf-8?B?M0hZWUg4dFUvQkpxWlRMK0hHSVRNUDJja1oxbEMyZ01MMXNrVitoNjE1clhk?=
 =?utf-8?B?Mkw0amU0WW4wdThCeExyalp5T3Nmd2VTWCsrdjlLKzVtSVMyUGNqYURWRm93?=
 =?utf-8?B?Z0sxMnhNOHdRZCtvY0lyblRuWEx0WjdiaVRvSFgvODk2aXp3NytUVmN5VVU5?=
 =?utf-8?B?SWxNblZQbFhIelpQQ05PNTIwSFhVZzJCY09Xc2JWb0pReTMxTEwySmpOeXdT?=
 =?utf-8?B?b2k2WUI2dENVK1hLblB1c2lQRzFhVTRsWmlpekJ5ZDY0WGNFblkrZDkyOTBW?=
 =?utf-8?B?TnJkeHFvSm9mMzRXajJLckhMRk1IUEIxeGs4UzV5bVN5ZitVd2pXV2twZUk1?=
 =?utf-8?B?WFpYVHBkWFZTVm43UU9KOVFSeHBtb2FEMEVDTmN5bnVlMkVmeVVBNGVPZHk1?=
 =?utf-8?B?NnVsdUZ6ZUh2ZlNydUwzaGN1ZnZMbWFLK3lnVjBhVVZuZ1JJdkdBS1JZSUp6?=
 =?utf-8?B?MXZRcWNmNjhyeUJEWkZiV0Y3SW9sN09lQVFWSDltMlZ6WVFkNHc4OWdBMERR?=
 =?utf-8?B?TnhjTEt1M2g1dDY3Q2pVaUN1UFR2TGcxWXhtN2VXM041aE5hM3FBZFdINjBm?=
 =?utf-8?B?MkQrN2pyOUlDRjh1UC9GOWdzK0V5a2p2ZzQ5TlBCWTlNeStuREJkUUprcGg0?=
 =?utf-8?B?S1MwdVZiSS8zS0FxRllhWWtObWlDQWRjem1hdE11R20vUlY4eXM0Zk5mQUl0?=
 =?utf-8?B?ZUNCQ0xPRjkrOHhJZlZCamFWNlkxK3pNdWI2QmNYYmdMQS9aSExHMnE1RzZH?=
 =?utf-8?B?aEUwNlhrTWxVeTlNUzhVMm00YUVvbHZyNk1HaUlBUmo5V2lGcDJKWTRrZm1s?=
 =?utf-8?B?c1pmblJkdFN2WkJ1SHNCMmd3eGora3N2UUJOdXloM0EyV1lQZ2VCakdBOXpp?=
 =?utf-8?B?bjVZcUd1SUd0WGRxTnczVGpEV1AxSkM1UzNqRFk5dmNjazhKY21uemxOcHNo?=
 =?utf-8?B?ZVJWc09QQ3gxNmxOR0VlZThmRldScnJVeWQyWTArWSt3T2ZlTDI5b1o3WWE0?=
 =?utf-8?B?aUo3WHQzekF3QzRlQU12N2xDemhJbjlydUpsbDR2S3ZUR2s3MEVXZnZOYzNx?=
 =?utf-8?B?bUg2UEJkYWZnTkl4NkJNNmdKWTRTSkJXVE9ibDBMaDh1UGlvM1lnMElHK1ph?=
 =?utf-8?B?NzRpYjJ4RGdLOW03cjFneWtPZm1mMmxoc01jSzUwMmZ1MDUxRjVBVlI1bys1?=
 =?utf-8?B?bVM3WitwanhBRis3Ri9pc1RxWlBJODhTQ2w1YnA0dFJud2t4TTNScWZtcHRR?=
 =?utf-8?B?UFFpSFpFa1VNNFdtMURENko1cFVwVnBhb1BPU0ozd3NrQVRPS3ZvajA5cTFh?=
 =?utf-8?B?S3pEeXZDcnBQcHVLWnFsSmltMElNajRsc0RMNDcyTkdBTHhxdWMwNkY0UWcv?=
 =?utf-8?Q?hHH2IADOPnTzeb44pnwY?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(366008)(376006)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?dDVGMFVpTWhoVmRoa3dTQmtIbHBjbTlGWGgvM0xoWG85V1M5ald2VkZ6YmNG?=
 =?utf-8?B?OE02RHJsNVZMTDNKVHU0Wk84T3JaN2plTDdmUThpaENSemgyVDV3eDBMekJL?=
 =?utf-8?B?YU9HWDF4b09iV0gwNHEyV3BtcDJjUyt0SjQ4U1ByZ2FZejBndEdGUHp6cmZL?=
 =?utf-8?B?OW9Lcm9yazVCdE1TektUR1pMQ1hTNis2K3YvNzhPQ1JoSUVoOGRELzdDS1pw?=
 =?utf-8?B?TUlBNXlPa3pLRzBBOUNYQnBHOWtsb3hydDVxa01XVHNWRkcwMnYwV2dseVJu?=
 =?utf-8?B?d0RtRkZ4VTBkWm1zNHJydEZJaW9Yak1HcWtCK0dyT1g4Sy9mTlIvcDE3aTA2?=
 =?utf-8?B?bW9udm9HSDh2RlVoVE1pWjlRV1BSclNiSVJMYy9tZ3hkazhyVDF4NllmdTZU?=
 =?utf-8?B?TDRjMUxLVjFxNGR3Mkw1ZzJYeGs4Q3Y5MVBQVFp1OGpvUmxBNUdnVTgwL0FX?=
 =?utf-8?B?NzBqa1lIUjZPNFdxc1lyUlN6Rk1pNVB0cGVUWmRMOFhDSXBWRk44NkJYNWN5?=
 =?utf-8?B?bGpyb2pCaWxNRkp4MW9LM1BpSG9IVmVLYTFmZjJSaWd3bTRrOGJ1RXZFMUdw?=
 =?utf-8?B?MXZaTE9DNmVVL3ZWZkZYSE1DMXJudEg0MFBCd1E5SnZJS3lYb0dsaG04WmQv?=
 =?utf-8?B?NUxRV3RBN09ZVXZzbFg2bi9ROEVHYzg5dDJBYjZpTTJ0a1hwTC8ydzVVNzZG?=
 =?utf-8?B?ZVV5L29TcGs0aDF6d2dOek0rRXRGR1k5R0JEaVpLTlZicjlrQUlCZEg3c3dF?=
 =?utf-8?B?L0RBbkV4Z09McWdxY21rM2ZqTWJtdHIrd0ljcHJuSHhVSkJHQWJRczlnM0Yy?=
 =?utf-8?B?a01SRVk4aW1MQSs2WUpuMU9HNVlHajBINVN0QlBnUWJ6K040aDNvS3plbnlU?=
 =?utf-8?B?M3E4Ym43OGJYN2FWdVdBUWdlbE13MmRRTTE4RDlydlFOUTFNTnF5bnloT3Nq?=
 =?utf-8?B?NDRlWWVPM21MN1Qxak5GcnVtbmxkWG54NDU3R3RRRUZPWi9PYWpad3RDdW43?=
 =?utf-8?B?VkJveTNJb1ZhUGJmNVhvR3J0MXdGVUQyaTNnaGc3Zm9uYTYxaklDQUw3ZkJI?=
 =?utf-8?B?UWl0V1Y2bkw1NVVhM0RndWVKWi9sVWJ1aXFuZlNaanAxNlZmSEl1SEtKTXlB?=
 =?utf-8?B?TkY0Y0Q0amdHVXRBMjc3V2hqWFppV2c5OVM2NWVvaXNLTXRpRDJKdmVCNE5q?=
 =?utf-8?B?UHVPVXAyWlRlYXM2UFc4TFRidkhYNjlGMEF6SFR4T1lZTXNZV1pUZC90Nnhm?=
 =?utf-8?B?QkgxWW1FMnE3QXVTTXBMM0hrUml4OXd4WStCRDYxQUZwZW9MZU53R3JrZ1Bo?=
 =?utf-8?B?MXZJN2lqL2EwR3hzS0xNOWx2c0RyVEtyV0U2dXNrd3ZGcW4rZGJSSEZhZ1Za?=
 =?utf-8?B?L015NzE1Nm8rb1JTS2JDbjdaWWwxN0xCeHJ1V3ArZmg4YjF1d3dycjNVc05G?=
 =?utf-8?B?MHZMWnlNbElhN0UvTDh2OFRvNU8rYnVYMzJiM0M3a1U3bmlLb2JWekdjWXh4?=
 =?utf-8?B?OUZUTjczVGJBTC84QWk0NVorTDQxeDhxRlo0UnZ0UmtIclZDY2VlVjY3UHh0?=
 =?utf-8?B?VkdsaFdwZmdmUDI5SkpjR045T2g2bElnZVg4NWdWc3pKSmVLSkVlUFkyUGkx?=
 =?utf-8?B?dDlkaW1zVm0wK2xvRHE2Q1Y5VHRrOEcrOHdkSXQxTHI4Mit0SjdTa2Nxc0Zi?=
 =?utf-8?B?MzNmY0lIM1FLTHJ4anp1NVNqbmE4cG1taENIYzNTWDJSdGpGSDcybTNxRk5Q?=
 =?utf-8?B?VUNLRUEwRUo2ZUlpcEQ5N3J3eHZEdWdXOW90cGVzb0c5QzBzdUlrVnFHZDFl?=
 =?utf-8?B?UHY4NW1ndVN6dlNuL0dybkhLUTNzdmlROWt2V0FwaHdiZmxqUE5EeXQxeG5H?=
 =?utf-8?B?WCtRN0tCNkROSUROVzc5YXNvWVZ4YTg0ZnlXSzhtZmwvNFJ2QnBvYm4xdUky?=
 =?utf-8?B?U0pyTWNBSzRWdnY4ZGs0YkFUQ2RPbkxNc1h4N2pjZE5xZmlsd2tvZmRBV0tz?=
 =?utf-8?B?U2ZGeUJqN1ZVeHgwTVc0TW9MZlAzMkFlS056blRFeDd4Mk5qUzI0dGNBMVlZ?=
 =?utf-8?B?QlhDUGR4dWQ3Q3I2V1JnTW9IQ1ZNWVQxempsMXkvN1Bvd1dyVjVjUlBlU3M3?=
 =?utf-8?Q?4v0P0LbemPW7WZJvD3Lhb+6Ei?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 964caff9-c0b6-48d0-0692-08dc8aaf2225
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 07:13:17.8574
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: A4zr8+R8Er89f9Y8D6mauxut9tVUBhMDDRUqTG7eDOHPl5L50dbWrvCLsR9BU6aujefeZGZHEsmjx4V3CPPYkQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR12MB6734

Differentiate Type3, aka memory expanders, from Type2, aka device
accelerators, with a new function for initializing cxl_dev_state.

Add a type2 driver for a CXL emulated device inside CXL kernel
testing infrastructure as a client for the functionality added.

Based on: https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#mef63c11ff2ffc265b75785caeb2c2370953ccf44

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>

On 5/16/24 09:11, alucerop@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Differientiating Type3, aka memory expanders, from Type2, aka device
> accelerators, with a new function for initializing cxl_dev_state.
>
> Adding a type2 driver for a CXL emulated device inside CXL kernel
> testing infrastructure as a client for the functionality added.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>   drivers/cxl/core/memdev.c           | 15 ++++++
>   include/linux/cxlmem.h              |  2 +
>   tools/testing/cxl/Kbuild            |  1 +
>   tools/testing/cxl/type2/Kbuild      |  7 +++
>   tools/testing/cxl/type2/pci_type2.c | 80 +++++++++++++++++++++++++++++
>   5 files changed, 105 insertions(+)
>   create mode 100644 tools/testing/cxl/type2/Kbuild
>   create mode 100644 tools/testing/cxl/type2/pci_type2.c
>
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 07cd0b8b026f..0336b3f14f4a 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -659,6 +659,21 @@ static void detach_memdev(struct work_struct *work)
>   
>   static struct lock_class_key cxl_memdev_key;
>   
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
> +{
> +	struct cxl_dev_state *cxlds;
> +
> +	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
> +	if (!cxlds)
> +		return ERR_PTR(-ENOMEM);
> +
> +	cxlds->dev = dev;
> +	cxlds->type = CXL_DEVTYPE_DEVMEM;
> +
> +	return cxlds;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
> +
>   static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>   					   const struct file_operations *fops)
>   {
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index 0d26a45a4af2..e8d12b543db1 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -859,4 +859,6 @@ struct cxl_hdm {
>   struct seq_file;
>   struct dentry *cxl_debugfs_create_dir(const char *dir);
>   void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
> +
> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
>   #endif /* __CXL_MEM_H__ */
> diff --git a/tools/testing/cxl/Kbuild b/tools/testing/cxl/Kbuild
> index 030b388800f0..a285719c4db6 100644
> --- a/tools/testing/cxl/Kbuild
> +++ b/tools/testing/cxl/Kbuild
> @@ -69,3 +69,4 @@ cxl_core-y += cxl_core_exports.o
>   KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
>   
>   obj-m += test/
> +obj-m += type2/
> diff --git a/tools/testing/cxl/type2/Kbuild b/tools/testing/cxl/type2/Kbuild
> new file mode 100644
> index 000000000000..a96ad4d64924
> --- /dev/null
> +++ b/tools/testing/cxl/type2/Kbuild
> @@ -0,0 +1,7 @@
> +# SPDX-License-Identifier: GPL-2.0
> +
> +obj-m += pci_type2.o
> +
> +cxl_pci_type2-y := cxl_pci_type2.o
> +
> +KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> new file mode 100644
> index 000000000000..863ce7dc28ef
> --- /dev/null
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -0,0 +1,80 @@
> +#include <linux/module.h>
> +#include <linux/pci.h>
> +#include <linux/cxl.h>
> +#include <linux/cxlpci.h>
> +#include <linux/cxlmem.h>
> +
> +struct cxl_dev_state *cxlds;
> +
> +#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
> +
> +static int type2_pci_probe(struct pci_dev *pci_dev,
> +			   const struct pci_device_id *entry)
> +
> +{
> +	u16 dvsec;
> +
> +	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
> +
> +	if (!dvsec) {
> +		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
> +		return 0;
> +	} else {
> +		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
> +	}
> +
> +	cxlds = cxl_accel_state_create(&pci_dev->dev);
> +	if (IS_ERR(cxlds))
> +		return PTR_ERR(cxlds);
> +
> +	pci_info(pci_dev, "Initializing cxlds...");
> +	cxlds->cxl_dvsec = dvsec;
> +	cxlds->serial = pci_dev->dev.id;
> +
> +	/* Should not this be based on DVSEC range size registers */
> +	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
> +	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
> +
> +	return 0;
> +}
> +
> +static void type2_pci_remove(struct pci_dev *pci_dev)
> +{
> +
> +}
> +
> +/* PCI device ID table */
> +static const struct pci_device_id type2_pci_table[] = {
> +	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
> +	{0}                     /* end of list */
> +};
> +
> +static struct pci_driver type2_pci_driver = {
> +	.name           = KBUILD_MODNAME,
> +	.id_table       = type2_pci_table,
> +	.probe          = type2_pci_probe,
> +	.remove         = type2_pci_remove,
> +};
> +
> +static int __init type2_cxl_init(void)
> +{
> +	int rc;
> +
> +	rc = pci_register_driver(&type2_pci_driver);
> +
> +	return rc;
> +}
> +
> +static void __exit type2_cxl_exit(void)
> +{
> +	pci_unregister_driver(&type2_pci_driver);
> +}
> +
> +module_init(type2_cxl_init);
> +module_exit(type2_cxl_exit);
> +
> +MODULE_AUTHOR("Alejadro Lucero <alucerop@amd.com>");
> +MODULE_DESCRIPTION("CXL Type2 device support, driver test");
> +MODULE_LICENSE("GPL");
> +MODULE_IMPORT_NS(CXL);
> +MODULE_DEVICE_TABLE(pci, type2_pci_table);

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2081.outbound.protection.outlook.com [40.107.94.81])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 15CDB16D337
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 07:22:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.81
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718176954; cv=fail; b=SfD6L5E37P97usmLgQvuXUmi67yWkyQUE/QWYYXTnImv5pejPzhyPpu84fhJwwuBidumcgSh43nZ2fsBFMjZRlnIwcf+ezVtfobCUi7VSb5di3biYB8EB+M9tv1kIoNZfOfFEFfZ3/QI4B0X3t4D6t0+1FyZWlPmOw4qamf6Vg0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718176954; c=relaxed/simple;
	bh=0lwQ3o9jXs/PTuvhai04d0C6UcfGPEC1eczhhK9zF8Q=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=dRQ0x1O0+gKNPO2YZme+vhzMWu6zSwfC4V3g8PgiO8XBDXXUgW6Exnhddr5moIu8h8UuhgVkcivcud0IEVmoBmIlMnPU+HRsNzTl1TkMS8C+oNECAG6cZYQmRqpHR92QnZ6KLz5QX+RUs+FJTfvrpi+/KOfxkaszgZvzJ2LotP8=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=nghLeNGa; arc=fail smtp.client-ip=40.107.94.81
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="nghLeNGa"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=X3OZYcx8Gn5zHEEoi+ZGEmggw6H1MC9R8K2GjjZomtAYo3lVpwwGBIwWFJIK8KMTmKW3MAySPL1TbAJBB34X4T080HwWhGDrrNkGj/DFEBQ1/OfLXuYtrzOLtQb+ml8l4WMbWnxo0mwqz/76iQ9gQp+UV48rDkzx6rXKRXC+87g9wNDTocY8Wd+ks690yckcdnKKCmajAHpU9Z8nfKC3WrgrUtk43G+ot1OUCs777+wE9Wg31/zaIRdD9Y9pATBzNqyDED49vfnxWJIi9ws4kLqBfgsbPLKZLOsceKYXtPe/luexUiCgJHTEGmySFr9LkhSzzNNrTEFCwz3659O0tA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ofgrVTkwNzP3mcRuKqpoLaI/vNEMs6tII+PAZ0Mjay4=;
 b=PrmDk2MRY1Wq8NNY4LqN3Nw79qTRbWLI8lAmORlf+bv7EM/KG4cnDyCnVx5Q4xCTKJV+Obdq0hDYeMi5nocELg4pi3tVqwgLhofwt8++SUpKTYzYgnrGYLQKWHe6TaDowX7XFXgrj2ZpLmd2kJy1ljrNo4dPnAw5n4blcqGSfUocGmTuLwNM8bA+apNyN61A04XSdaB71NuaiaouASSQZtCt3H5oiDT8JoErCHY9DL22j3GhlYMrMYs4ODV/UqlVEHNkaFaYNs5mjoAspCMn+eedoE8DTH7epzmSzJbg+tjucl8AqPdPczGXFG9SehoB2vYmDZE2HaxUSgYD37FKHA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ofgrVTkwNzP3mcRuKqpoLaI/vNEMs6tII+PAZ0Mjay4=;
 b=nghLeNGa1CoNYFG/pCBfBSV3ZaFINE0Gr4RPpqK0kAYH1Lzj6mNqfKMqrpbB3JXHXUd11SLCTut/h1tJ6xShiKuHjox3hyJ7eJZB2O+EGjK9/KKqQdBk8TGNbjTSTk+VabtjaIUgDw5HamqRiRvp5YMA0wb04h4Pq5I3FvZBT2s=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by MW3PR12MB4475.namprd12.prod.outlook.com (2603:10b6:303:55::24) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 07:22:31 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 07:22:30 +0000
Message-ID: <6c692370-1259-4d7b-17d6-e5702b7322a6@amd.com>
Date: Wed, 12 Jun 2024 08:22:26 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 07/13] cxl: add functions for exclusive access to
 endpoint port topology
Content-Language: en-US
To: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-8-alucerop@amd.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240516081202.27023-8-alucerop@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0451.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:1aa::6) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|MW3PR12MB4475:EE_
X-MS-Office365-Filtering-Correlation-Id: 9d5bf6da-bf11-4207-25e7-08dc8ab06bcc
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|366008|1800799016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?SXM4U0ZnNVZJZGJTd24rQndnazJreDJyVDRjRTBkejJDUnhFRE5pcDI5TzVq?=
 =?utf-8?B?cEFVZVBtWEc5QTJ6cUhZSmNoSG54UEk0Q2hBMXQ5Vzd4akpVTTkxazZjeG8w?=
 =?utf-8?B?eFA1TTFsb0JYNFQzK2xTMFYySE1xeUtVRjhzL1VjUjdPeXJxSE4zSzREbEVr?=
 =?utf-8?B?K0Nrc1BSWlZVYWF2Nlp0WVUyQ1NHSkl4WkRMYjJkMS90ZGxqTDZqamtXZXhu?=
 =?utf-8?B?c3RKN1k4dnpqS3VTb1h2bHY5a0Q5UVNHZ1dUUWExdXVtZGhlWGNTVmdOWUdo?=
 =?utf-8?B?bk0vN0tBL1E1dWpNeVJKejJUeCtoVmxmREdTdm5QQWdHUm5QSFVpeFl4dEgr?=
 =?utf-8?B?dWxvV1kzeE1wL1BBY0FRb29SZndoczdEZjVQSlpCQTQ1MEhGbk52aFkzZWd3?=
 =?utf-8?B?a1ZXS2xFSnF1dDJtekJoQUI3U0ZhcUw2anNXK1ZGdVpRWE90NTcxNGpKZ3JF?=
 =?utf-8?B?R1kySXlSaHJOZy9RKzczU0dmT0dBTG15WnJ3QVRwNm8vZlIyZmxHK3QvSlhn?=
 =?utf-8?B?RkpTTmVyYUxlN21xS3p4S0tEUWYyU29tTTZSSXhzNzdKVVlMN0hhVERoUFlD?=
 =?utf-8?B?OFkrelN5RGdFTWFxT3ZaajNLaWFUY08xd3BVZWRaU2t0M3BlNUZlM2pIUXBD?=
 =?utf-8?B?dThsZVdxbVpmS3ZVMG4xZFhMQnlGZm5JdVJNYXVrRTlYTXZWSE1JbDdDZEJi?=
 =?utf-8?B?eTRHRWF5eHRYeWE3cGlMMDkxcjRQRkdyWnRXT2doQXJxRVhmWllET0xXdVBl?=
 =?utf-8?B?Zi9GQk92MmhBeFlVazJpU2ZSTmx0cnU2Mk92eDVMNHFHNkErQzZNYVoyTnRr?=
 =?utf-8?B?Z09tS2xwb0pncnUzTnhGajlnSjVEZVhvT2ZSYXZ5SnJaRFJlUHljRytvb2k4?=
 =?utf-8?B?Z2g5b1NMWGNxSDkxQ09aK0VLZHZjOGlmOWl4S3hYaVk2d1NDRGtrUmMxR25B?=
 =?utf-8?B?TmxqeGNjU1R2ZmhsZ2VvN0Z3UnNka1Fma2pWd2ZtRE9EYnd6QVl5MWVVeDJB?=
 =?utf-8?B?Ti8rM044S0swR2pGTnJvdHhlTHQzTUNwQmlQQ1QzY095QkFZZTVFSGt2QlZN?=
 =?utf-8?B?MnVEcE91OVNwM244UFdMRFN2ejFTYU5uS0Zwb3FYNXJVdFNrM2tSdTBzNWw5?=
 =?utf-8?B?VFdWTkFDeld4NlRUVTdVQUFERGc3dlowS0lwM2tKUnpIYUxxVEFPMVIyYkgz?=
 =?utf-8?B?d2JZT1ZEOXMrdzhtczFscndRcTNCclBrRG5wajNITkNMbjRPUStjSGZtdEJa?=
 =?utf-8?B?a3NIbTQrdlZNSHlQVk9iTFZQNmxwSWd0enRwOFlWUVZJNm5ZRGNCaDFzZWdK?=
 =?utf-8?B?cStmOUJmbWpyTTR5cnkxeHUvN0xNMDk4dlFlYVZSdmp3cUx6VWNXNEVZaHY0?=
 =?utf-8?B?VUw5RE5HenZqYkZRZjMwbkRsRVBucFBHaGpTSHg4TEMyMFdCV0VVN2lLcjFR?=
 =?utf-8?B?dzVPOEs5VGJIbTdyM0VBVkgvNFdnTTJMNC9XMVRMeWx6blB0dnB5alJUd2NT?=
 =?utf-8?B?Y0plTGJycjZMWjBQYW9LalBxc05UYlpxNi9ETE5wL3ZVbk9FRnVtNDdvYi9V?=
 =?utf-8?B?ZWlCdnVNVlZIamNUbkY3RWkzbHlEbVFoVzh1RlQwRDNvOUtldzZNVnorQm95?=
 =?utf-8?B?TXVKWU1ibyt2VmNYeEJQZENyKzdrRmMxMUZFb2R1QlhHSUZZWXZGbDRQSzE0?=
 =?utf-8?Q?4AI5YLGbs4aANqzWc6Ci?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(366008)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?Y2FQZit3S0ZpSjNSMDk3RDJscmh2TFQ3WllEeU1DcFhoaHpCeDRNbGpNamdJ?=
 =?utf-8?B?cTdReUIybCtqREJSaHVzejJHVzJHUUllNExaT3ZzbW9mMHRNWUQ1RXM4UUJN?=
 =?utf-8?B?U3d1K2xrM2F6TDUzTy9JRVBjY2hwb0VrdkduNW45eGlpaE93N0hpZ2dWZ2ww?=
 =?utf-8?B?eEIzdDJuV1BNU3ROajN6ZUdDZkNsOUZweTRkcXg1UDcwdVNoREdPR2N3Umpl?=
 =?utf-8?B?R2JrYzAvTEFubll5UzJ3NkVqcS9QVHFKM3B0ZmQyMW5IVEEyQ3hHSVBsSHZs?=
 =?utf-8?B?SzJ0Vm95eWxwK2tMR0EyRkc5WnJSZExwQ2d1WlA4bHhtU2xKaVlLZEFKNHBn?=
 =?utf-8?B?a1l3aFdqZ1hXeHlhNktrL0N6VGhMbTEyeHVkdDlMT3FTdHFxQ0xGMUNEVGZp?=
 =?utf-8?B?T3BlNjNscWFDRCtmVWRoN1NnTHVjRS9DT1Z5M1QzOVljNXdldVorOXpzbTk0?=
 =?utf-8?B?am1DV3NDOTc5ek5rTkNLRWFOdy9Yek1oWkV1ZjRabFQ2Q1NzTHhjaXNyeDZU?=
 =?utf-8?B?VmwrMjJLSlNkSlJpVjA1bWpCOVlaOW9CSXZIL2J6cTdTRFRYR01TKytBUVNz?=
 =?utf-8?B?UEFORHVRRlhiYWNXNkgrZ282eC90b0N0dU1KL2RUNlBlV3RCVk40RXlQcFdY?=
 =?utf-8?B?czBzQjJ1azJ5RmkzRlphWWM1b0lGM0dKd3NDejkrVU15cldHYVY0T09Ya3R1?=
 =?utf-8?B?bmUycWVqajNsYjk1eVRlMXZjMGEycjRXbVFZdkh2eVN3dTVwc29RNDZ2d0NI?=
 =?utf-8?B?NDFWallaeE41cXFPUTByd3drazh1T3BXc25QUUJweXR4NGo1U1pZVW5IRnEr?=
 =?utf-8?B?czkzL2ljUHBzWW9jb2xjckFTNmZ4OU13a05FKzFUWGx0a2tUMFcxenVXSHZ6?=
 =?utf-8?B?STJkU2orUEhpNDl6YklKRDVjOExVSG94aWlyekhUbG9xQ1lOZWphZ296THQr?=
 =?utf-8?B?TTAxMFhpRFRjVm83cUZnZnRaMnhZOXpXa2x4NEdiUWNsYng4d0VQZHBLWktP?=
 =?utf-8?B?UXI1Zm53UU9WL2FWSDE0NUpqMzUwUHB1aDhwTXM4NWUwWm8rS2s5QmZDWll6?=
 =?utf-8?B?R1pjTjY3QzZvbmJIeWZ1Y3psMmlvc3lFV1Z0TWpVblpUb0Y2by9tTm0yT0hv?=
 =?utf-8?B?cDljOUlqaVJIeVpKOElmN0NWazhQbUR6dDJ1blhTWnpnbmROcUNSUkpCWXJZ?=
 =?utf-8?B?ZlZIcEl3MmN3a3dpSDZJUEYvUGZYOHRuWFo4aTBvRFFnZTUvMEtuYUp1aXdo?=
 =?utf-8?B?Zno5eEc5aWJwUWNaM0dUNUQra2g1Q0QvYnhLMERKOEJTYU5Jc014WllMMXp3?=
 =?utf-8?B?bW9sSThDOXZzSzRDNGh6cHg0bStQWDZJeWpxZ2VQVlF1MTJBTGtRUGJaa1JJ?=
 =?utf-8?B?RTRoTzN3c1lIMTVMZVRCTjVmdVpMd1FrbURsNDNPUXBCM0V3RmplcnkveTlu?=
 =?utf-8?B?Sm9vR2dGUEt1VWNqNDJ2T3JqWnpOMjNzcnFhN1A4emJEdzdmc3dDaFNzK0Jo?=
 =?utf-8?B?R1drOE1Sa0ljdTh3TGwxOWZuclg4bVNwenNhUWp0VkN5WHdTVEVLVm1VTnR3?=
 =?utf-8?B?V2sybjU0Unp5NjRLRGRWQUg1dEZmZ2xBdE1INXhYbXV4VjFSdFNwb2tyNEVW?=
 =?utf-8?B?L2RIdWx2aUxXZHI4TnRCMjF3RGhXNEw2cmovZHJjcHBJcEFPVlROU2JhVFlm?=
 =?utf-8?B?U2x1SkRmaUtUY3hJa1BZNEw2R0gzUElJcmc5WnZhWGNPOHBHNkQ5bTlLckMw?=
 =?utf-8?B?c1Y0czFBUmFJTGc5T3FiWVV0U0dCUlM0UnVHYTczaWJPTjJnS2F6b2tNWjlT?=
 =?utf-8?B?V2VGRkF2cUVMRDYzK091TDlrU05reHZkRkUxVkRWNkljYVVZT0x2Y2gyNG96?=
 =?utf-8?B?ay92SmJXV05FS0V2N0RHNXI4ZGdpYkFiaUQyZnBWcUZ6eDQrSEhtSFo1bTl3?=
 =?utf-8?B?Ukp0U1E5TkZVZW1Kb2ZHMXdUNjFkMnJnMXNPM3JJa2pCUGN6WHVBdUFDaW1X?=
 =?utf-8?B?L3diTnZjdUNaS0tDL0VRS2VpZnQ4TEdISkk0dUFMblNiWHpQdXFvQUpUamRw?=
 =?utf-8?B?aHFuS1FpUXZqT0xVcyswL09MNVVGbkFidHA0U3g1aklJMGFxd0dEenZkSkdB?=
 =?utf-8?Q?J20u71Z0XbTjgdOsAR5beybq1?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 9d5bf6da-bf11-4207-25e7-08dc8ab06bcc
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 07:22:30.8800
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: RgOIVmnbzKAvK4h3A5pzxLBkIe1r7r8S/g5lav6QDVTzjJuK6Xz9/5j4STZbBP3kFPRQ7eLz6OWgQDq/SQM7LA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW3PR12MB4475

From: Alejandro Lucero <alucerop@amd.com>

Prevent concurrent access to endpoint port topology.

Based on: https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m18497367d2ae38f88e94c06369eaa83fa23e92b2

Note: I realize original patch is explaining what the code does while my explanation is ... really poor. I will use original changelog in future versions.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>

On 5/16/24 09:11, alucerop@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Prevent concurrent access to endpoint port topology.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>   drivers/cxl/core/memdev.c           | 41 +++++++++++++++++++++++++++++
>   include/linux/cxlmem.h              |  4 +++
>   tools/testing/cxl/type2/pci_type2.c |  9 +++++++
>   3 files changed, 54 insertions(+)
>
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index 27063cd4ea73..16e356ef5b6d 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -1124,6 +1124,47 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>   }
>   EXPORT_SYMBOL_NS_GPL(devm_cxl_add_memdev, CXL);
>   
> +/*
> + * Try to get a locked reference on a memdev's CXL port topology
> + * connection. Be careful to observe when cxl_mem_probe() has deposited
> + * a probe deferral awaiting the arrival of the CXL root driver
> +*/
> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd)
> +{
> +	struct cxl_port *endpoint;
> +	int rc = -ENXIO;
> +
> +	device_lock(&cxlmd->dev);
> +	endpoint = cxlmd->endpoint;
> +	if (!endpoint)
> +		goto err;
> +
> +	if (IS_ERR(endpoint)) {
> +		rc = PTR_ERR(endpoint);
> +		goto err;
> +	}
> +
> +	device_lock(&endpoint->dev);
> +	if (!endpoint->dev.driver)
> +		goto err_endpoint;
> +
> +	return endpoint;
> +
> +err_endpoint:
> +	device_unlock(&endpoint->dev);
> +err:
> +	device_unlock(&cxlmd->dev);
> +	return ERR_PTR(rc);
> +}
> +EXPORT_SYMBOL_NS(cxl_acquire_endpoint, CXL);
> +
> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
> +{
> +	device_unlock(&endpoint->dev);
> +	device_unlock(&cxlmd->dev);
> +}
> +EXPORT_SYMBOL_NS(cxl_release_endpoint, CXL);
> +
>   static void sanitize_teardown_notifier(void *data)
>   {
>   	struct cxl_memdev_state *mds = data;
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index e8d12b543db1..11fe8367b046 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -88,6 +88,10 @@ static inline bool is_cxl_endpoint(struct cxl_port *port)
>   
>   struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
>   				       struct cxl_dev_state *cxlds);
> +
> +struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
> +void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
> +
>   int devm_cxl_sanitize_setup_notifier(struct device *host,
>   				     struct cxl_memdev *cxlmd);
>   struct cxl_memdev_state;
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> index f157139b712f..948cc95c5780 100644
> --- a/tools/testing/cxl/type2/pci_type2.c
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -6,6 +6,7 @@
>   
>   struct cxl_dev_state *cxlds;
>   struct cxl_memdev *cxlmd;
> +struct cxl_port *endpoint;
>   
>   #define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
>   
> @@ -72,6 +73,14 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   	if (IS_ERR(cxlmd))
>   		return PTR_ERR(cxlmd);
>   
> +	endpoint = cxl_acquire_endpoint(cxlmd);
> +	if (IS_ERR(endpoint)) {
> +		dev_dbg(&pci_dev->dev, "cxl_acquire_endpoint failed\n");
> +		return PTR_ERR(endpoint);
> +	}
> +
> +	cxl_release_endpoint(cxlmd, endpoint);
> +
>   	return 0;
>   }
>   

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-DM6-obe.outbound.protection.outlook.com (mail-dm6nam04on2062.outbound.protection.outlook.com [40.107.102.62])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 81304167296
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 07:27:34 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.102.62
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718177256; cv=fail; b=W+KNLAwovxb5NkhsjUBIjLqk3Wgum4++eOiMkiNr6sjLcd9T+h8ZdBfzoYUpnFe7YUgY395DdpqtHEEnVJVfjEgxjnmMC1Eqjfy09KpD+cGQixtgo5LdO2rEOy+PnGY7JHAi4Yu+xLHFJxLtrmTEOGuL/a9XBxDmYZdNmGhPqxg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718177256; c=relaxed/simple;
	bh=zTjfoRI/IddVJ9kRhyEwz8hfAOpqCCZHbMwI6/oUXkU=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=OKPTQAdZUqpbU4kK5mtqbUt4vU73j6DNX4nv+4wgbb+4Y3YSGf9ogWiiz9Aj4+7e31UHbLMRtOBclEaqI0D6EWbksyqdllMethxFhXUjIBtqruQ3ih3Wo43NxCJAJ1/QjqrpVwT+5LvznoHQefQWqkw7A/0D/Z9S3HFwQ2khxSQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=16gGM0Ww; arc=fail smtp.client-ip=40.107.102.62
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="16gGM0Ww"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=N7A8aWYrG1CljL0PRyoqMQzICC6OhUeFmIMqL1PDFYPFgdiOQ1JmpTUoM8YAMfgHLXT/GuxeQvk21VeLSWW03oK6f+YdAe6eY4BcpIdAg5K12gJ8wTB0HSGFXdJVb/sUNl50fWwRhopFC2xQ+0hTUSbSTvPEWKIZ/HZqrTgGzofWBiil6xqZT99soGGvR9C3sPjhgHQ9CPf3YOwJsqOQ2EipaQ33ZdQduoiyEP4Oj31vhnpWktgiT7yVxXe3vhp7oo6KiE5wiPtC+MLhvUtgvZnyEe/gB6tOOlYA6VgHkQhvcAqhp+lp7+RlOcJG2gw1kYv/9wXad4SJJk7uAnLhqA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=a27NYscq3J69JnZdXTgEyeutk40yMoHyvaz0AvRAEuc=;
 b=QivswVY35PAWnD9X93YJr6sJ1sGXUF60SGPuDufeRZUxWy5RSFbygqoLnXwwFGN4UKB1Hc7inYKeRGQ7pS5XV7297rmWhL39kT7UXNGDPumTjbaxWIU6XjJ9gotd4IgSK7+OTyYYsC++4Ea30BNyESaShwTFfLudlw7f/dAplsrxLquzEFrZI1fbOXW+vrJx8ZCvNiDhj5UZWjrD6frLwVWTuMNXDJwlLqj8uKcsD+e6jKkn/6INWOqSxArsM2Gpwxk3N2/jXVzHE/z2KPTgUrd/DWxd/2JNwsyv+smjILBjUE8Ehp1wXJhy2jjzRSBmq+e8ffmAq3SGEx4WkmCzTw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=a27NYscq3J69JnZdXTgEyeutk40yMoHyvaz0AvRAEuc=;
 b=16gGM0Wwb6WDxE/AwRXtZYwkOK8xK0BoAfuoOtbtOr8EhFe5heHra0E1o96LGKVC0Qi9aHV0DQaEk3hplAVDLhYZEpZoRDeM7gIWnRNFiJuISIpnCgeuhVrN02NBzW96d7kWnwkvoQ52LpU/Cfjx9jFhkkw/rXFmOdLX1vkdHZU=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH8PR12MB7446.namprd12.prod.outlook.com (2603:10b6:510:216::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Wed, 12 Jun
 2024 07:27:30 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 07:27:24 +0000
Message-ID: <5264583b-d9f4-e36f-4d6c-46bdd1344ce6@amd.com>
Date: Wed, 12 Jun 2024 08:27:18 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 08/13] cxl: add cxl_get_hpa_freespace
Content-Language: en-US
To: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-9-alucerop@amd.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240516081202.27023-9-alucerop@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: DUZPR01CA0248.eurprd01.prod.exchangelabs.com
 (2603:10a6:10:4b5::21) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH8PR12MB7446:EE_
X-MS-Office365-Filtering-Correlation-Id: bcb0d13b-21e0-4533-5814-08dc8ab11a80
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|1800799016|366008|376006;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?bDh1Q0twMEFCUm1QTERVZzBqaXFhOERFUlkxeTBGNWJyVVJxR2N1a2FEbXlh?=
 =?utf-8?B?WmxTNHN3cUxZMUNNVUE5NkQ3aDNsWm1rcWEyanNhQmNXOXoyK0hma3k5aHcv?=
 =?utf-8?B?eVlEMXpDWG50ejRQalhpUDJ1R1F3cTN1RHJMVWx4YTk0c2c5eVR6NjRUaDlE?=
 =?utf-8?B?TWJ6WWVwWjhNTDB0QmVRL3BJekxZMHNFWm5jc1p6OFR5MG9qY2Y5ZGtqc3p2?=
 =?utf-8?B?eVBWWlNGRmx3WndSNUE3NXdHdjd2c1BhOUFJTUlpQU42d25aTldzR0U0OVRv?=
 =?utf-8?B?TUFaQWR5Q08wS1FqbUd5VlBpcFVuOHd2M0l5YnYzNHhORHdDaER0Z05hNVpJ?=
 =?utf-8?B?SjBFZHQ2dENIc2xyOERiSEZGU1FTdWFBMHNBWGdNanF4eVIxNXE1NXVZcUoy?=
 =?utf-8?B?YkJ0S3JQNnBZQnhZWUpGVkxNQWVYTXdScUsvTWJZdEp1R2N1dEprUlpzdkJa?=
 =?utf-8?B?dm96MldIM1Q0TW1ERGpYcVdGZFNmeVB6WUdLNlhwcHRCY1V5VWJ2Q3ROYmF2?=
 =?utf-8?B?ZUlRTUREMjhhTXhiYXhIUGJQOFBSQUVPYzZHa01QMHlITHY0Q0hmZXFXS2hM?=
 =?utf-8?B?L3NwYUFtY0l3WFhYbDNQSFNmTld4L282TUU0VnpFQkt6WTJ0ME5HWC91Rk1X?=
 =?utf-8?B?c1RmK3RhQ3BLUXJGcS9rajNZV3cxa0VDWUtnUmdWWlByZStmMXUxb3RiU1Ni?=
 =?utf-8?B?aHRKcnJlYlFTR1V0MTJzK0xVb2UvUFJteW5MUkxLSUF3OWkrN2MvakZ1QmJt?=
 =?utf-8?B?VXdOOHoxejNoa1ZFK2dFQlhkb2pyWXo1VWVvazFmMXNjVWoyZHQ5Zy9RbUZH?=
 =?utf-8?B?aE1JVTA5V213cVIvcmlFVzRJTm9Ja2J2Nm5aVzhsdHd1T29OQW1DV01PemNW?=
 =?utf-8?B?TU4rVDR3RFlGMitZMWpVd1YwYk42VmhCYzFNVmFKV1psTjY1UXd3cWsvbkZW?=
 =?utf-8?B?bkxXckJoMHk1K2VVY3l0eGlsQlFOTzBxeE0wZ2VJWG1CMVI3bm1yUkRveGpC?=
 =?utf-8?B?ZE1oaUxmRG9IQzZvNitwTzhkMGM0KzZLanhxdzBHQjlEdm80ejlQVFA4MmZj?=
 =?utf-8?B?TzBpUlcyVU9mYkh1MHUvenRwSUtKRHNpZzZYRmFvMDFGQU8vem9OT2N5VTh5?=
 =?utf-8?B?UCt6UWlUb3VPdUYvT1hMVTMyUkVSRVdGK1dsZ2pTRVkxaUpReWN0emJGSERI?=
 =?utf-8?B?N1lLcStLNjZtdlg0b3dNeW1uNXpCcWxzNlQ3a1VpT3FUZTRIUVdmaWJtb1R2?=
 =?utf-8?B?dWV3YTMzZzFsYVMzL2NRTmhSSWs4Y2ViMmQ4b0Jud2NPSERkSWcvekg5V01q?=
 =?utf-8?B?RDVKbVgzQTlGeFU2RmpZZ0tzR25MMUxUQmtKaHVmdUpHMElqYXRRUUUrK2lR?=
 =?utf-8?B?OWo2S29GOXZ4dmZBTVNCbnVQTXVoVnhxNCtSUTVpc1ZUeXEyYzJXZjFwOW1t?=
 =?utf-8?B?eEY2VHdvdWZQVXovSytkeWVielBKVVloRFRuVHNoNXhXcE1VOXJjNUNpaHYw?=
 =?utf-8?B?NVNtYldYNTZuTG5RV2pGR1VKWTBTQXNoZWlad2lLaGVWckkva1lyMk1RcE5p?=
 =?utf-8?B?ak5BQk16NmJjWTJkNkQxdEFHMzlKRDBsQ3BFTkNxOUZkSFBPL1Ixa1F0bWlw?=
 =?utf-8?B?UXRtZ2E5dlpjc2NaYTh4ZTJzVjFiYzRlWmJNS1picXF5Q0x5UVdMdCtMSUtQ?=
 =?utf-8?Q?DV8S9QRbLqoK8IKdhG+p?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(1800799016)(366008)(376006);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?aEFZK1ZwYnh0aEg4L3NaRDY3NGcwTEQ4MFRlWkU5bURTSXRWQ2pxVzR6UWpR?=
 =?utf-8?B?K1BlYzlacmVKM3ZEcC95MzhLK0VYUUdKSEpidHZHUmd6ZEtUZmVueklDWC8y?=
 =?utf-8?B?OGVyaTJQZkl4UWNnYXI1TVJFaDdkTVZUOVh3aWZsMCtJVUh0SC9ZeW5xSTZK?=
 =?utf-8?B?WEY4d1VWRitheXFTRUhqOTdjdjFROU5pQ3RGWmFKQjZoejFwSjhUdnFESi9v?=
 =?utf-8?B?TmxSZDk1QmlBYWhxR1hVNkQ3V0NCd2ZFQlJPNkxUcnZXajdiTGVVUWhpWVNu?=
 =?utf-8?B?cldaVHJqKzgxY2FwRHUvYzN6MGpsQjhHOGdkaDRmK3VIanVkMTNRNXRGcElh?=
 =?utf-8?B?YkNFMXQ4RHpnaG5kcmNpYm5mclZFamp3WjVMd0VMNVlXMDBvRk1JcGoxNVNJ?=
 =?utf-8?B?YVZTbkdobjk3ZThvMnVJc2VxYU16bWJRU2xCNytUTXFJNk1IRVh4dU43L2lF?=
 =?utf-8?B?TEJRNk1OczhDTlVtWU5JeWZIR0dlRDJXM2ZhRVIyOXpIOS9GVGlwbmhDZGxv?=
 =?utf-8?B?NUp2WC95Um5nd0RLRFdUd2c5SlIrZHNLZG5rSGdKMzdpb0hPcGNQR29iZDJ2?=
 =?utf-8?B?N2dFMUN6a2lBTDVOeGE1V2wwdTE2Q2FaUnA1ZFh1ZCtXdndrc29EM0c4cjBK?=
 =?utf-8?B?RENhUUJaR3g1OXJ2T0hGN0t3c05uUEwrQkVzWGJvbGsybGcxUzcrdXp4b2Ez?=
 =?utf-8?B?VmVQUUhWU0JaWm9XOHF2djZqOVZaNE1hWjlFck5VOFU5M0RCRkR4SUM3ZzBZ?=
 =?utf-8?B?ZVNXNlNjaTBNc3dJS3d4TEZTQ2twMXp0QkZLSHJoMFUweVVEYnhyaFdQcU1H?=
 =?utf-8?B?R1ZBU1BPNW1rVThtR28vaEtvRGRBcmlVUXh4NVFxT2lhQjJMQ05XRUlZV0k0?=
 =?utf-8?B?SGQxN3pReXZrNHlXVkpSYkhjNmNOMlczTXhGdFk2NzZQRDZLWWs1VjMrS2Fq?=
 =?utf-8?B?c0xzZEVDNUNZNXY0WThxM1crMktxTFpoYm1zMjU2K0ttN3NsS1dRT2Y3R3gy?=
 =?utf-8?B?bmpWNG1NeG1yUS9mUmFIWTVuVTFrMEs5YTlETHp5UHlJMys4blR3aFIxL2hn?=
 =?utf-8?B?VmZvZWZJOFVEbTEyRlJiZitIWm9PSGNXcDNWRDNwNE1wSlRvb2ZPL3d4SjU3?=
 =?utf-8?B?NEJ1OWU5WDczMmpFSnJIRVFvbHM5SHNUcTRybWo2RDFJczA0SHQ3NGE1Szda?=
 =?utf-8?B?V2tYN3MvbWtpRHBGdDNwR1JyK25lOGkxOUpjdzdhRmE1LzN5VllnMk90cStN?=
 =?utf-8?B?SW5kTlMvbzVnZVZNNmswdklxS3dHbmxtRlpLT3RHYk1mYlJzR3Q3VEJ1b1R0?=
 =?utf-8?B?cU8xcnhGejRJVEpQbTB6ZUtmUTdzNzhoWkhYVHdXVkM2cmNtRDBRdnl1Y2pT?=
 =?utf-8?B?M3NWMXdHM2xJU0VaQjdqK25ZU3M5TW5zS29ETlgwc2pSMlE2Z0tNa2pCcDR2?=
 =?utf-8?B?ZHM3d3YrNHMwd0V0RmI3N3lkMFpINGV3ZmNjSTdDS1gya1VsbU5ZcWZyOGVT?=
 =?utf-8?B?elUwc2tXT09tVkI0UklyTUFMRUJoRnFVc1kzQk15cjFBVENEdlJ5c2w4NE1Q?=
 =?utf-8?B?WDVuUnJuTjM0RGllaEF6dGRETW9QVWt0YkVHb0lIdlUzUFJKL2ZSUzd1NnRX?=
 =?utf-8?B?bzhBcWF4ZE9HNkluRWhJa0NWWC9RemcyaC9BaHRoaGhDRUNUcllVTisyaUlQ?=
 =?utf-8?B?TG1HY2Rzb3FySEloVTgrbTR3REZ4eE1kaEZtdDdtT3hVY3g4WGRrYzUva3Zs?=
 =?utf-8?B?U2V5czZNdWVwYnVBdUF2QjRaVVNGV0pDYWk3SjRraTVrYkVXSU9wZXg0M2dW?=
 =?utf-8?B?d2YxZGlZSDFkZmxtWFNYd1RuZzV0a0dPSEtFS0FWYUFlcmxEeEdraFFrZVpB?=
 =?utf-8?B?OXpOdXFjV1FGaWVsamxBbkVDZms3bm5OSWI1d1UrU09DTEhnYUNFRUY4M1V1?=
 =?utf-8?B?NXN5UzVEb3U2MVZHQW9US0J0Vzh4d1poanNrbHdTb0RtR3pPTHYwaDZIMlVQ?=
 =?utf-8?B?ZjE4ejRsSmdQSUJjOUJOM1NvYkpBMVRzVDB2cisrSXNxbld2dStuZnVvcEdF?=
 =?utf-8?B?U1o3VkZyZU00RlZWTDBZQUd1enJaTnhTekc3ckJFYkVTK3BtNGZXVFNma2Vz?=
 =?utf-8?Q?XuIENXuW9DsF9/3zpdi7/5fHx?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: bcb0d13b-21e0-4533-5814-08dc8ab11a80
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 07:27:23.9413
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: +bap8lBryTOfBCFqEPloaxu3jmUGw1yK9Aed6uT0uVOkt8V7c/n1mGzh5Ni2RSd5skRuMbjaFOBG72gDjA2ZSw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB7446

From: Alejandro Lucero <alucerop@amd.com>

Based on the requirements from the endpoint and the topology such an
endpoint is attached to, this function informs about maximum host
physical address space possible to request. This is not a reservation
but only information which could change at the point the request based
on this information is made.

Based on: https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m6fbe775541da3cd477d65fa95c8acdc347345b4f

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>

On 5/16/24 09:11, alucerop@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Based on the requirements from the endpoint and the topology such an
> endpoint is attached to, this function informs about maximum host
> physical address space possible to request. This is not a reservation
> but only information which could change at the point the request based
> on this information is made.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>   drivers/cxl/core/region.c           | 163 ++++++++++++++++++++++++++++
>   include/linux/cxl.h                 |   5 +
>   include/linux/cxlmem.h              |   5 +
>   tools/testing/cxl/type2/pci_type2.c |  23 +++-
>   4 files changed, 195 insertions(+), 1 deletion(-)
>
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 70e86a7c241d..2731fd4243a1 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -702,6 +702,169 @@ static int free_hpa(struct cxl_region *cxlr)
>   	return 0;
>   }
>   
> +
> +struct cxlrd_max_context {
> +	struct device * const *host_bridges;
> +	int interleave_ways;
> +	unsigned long flags;
> +	resource_size_t max_hpa;
> +	struct cxl_root_decoder *cxlrd;
> +};
> +
> +static int find_max_hpa(struct device *dev, void *data)
> +{
> +	struct cxlrd_max_context *ctx = data;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct cxl_root_decoder *cxlrd;
> +	struct resource *res, *prev;
> +	struct cxl_decoder *cxld;
> +	resource_size_t max;
> +	int found;
> +
> +	if (!is_root_decoder(dev))
> +		return 0;
> +
> +	cxlrd = to_cxl_root_decoder(dev);
> +	cxld = &cxlrd->cxlsd.cxld;
> +	if ((cxld->flags & ctx->flags) != ctx->flags) {
> +		dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
> +			      cxld->flags, ctx->flags);
> +		return 0;
> +	}
> +
> +	/* A Host bridge could have more interleave ways than an
> +	 * endpoint, couldnÂ´t it?
> +	 *
> +	 * What does interleave ways mean here in terms of the requestor?
> +	 * Why the FFMWS has 0 interleave ways but root port has 1?
> +	 */
> +	if (cxld->interleave_ways != ctx->interleave_ways) {
> +		dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
> +		return 0;
> +	}
> +
> +	cxlsd = &cxlrd->cxlsd;
> +
> +	guard(rwsem_read)(&cxl_region_rwsem);
> +	found = 0;
> +	for (int i = 0; i < ctx->interleave_ways; i++)
> +		for (int j = 0; j < ctx->interleave_ways; j++)
> +			if (ctx->host_bridges[i] ==
> +					cxlsd->target[j]->dport_dev) {
> +				found++;
> +				break;
> +			}
> +
> +	if (found != ctx->interleave_ways) {
> +		dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
> +		return 0;
> +	}
> +
> +	/*
> +	 * Walk the root decoder resource range relying on cxl_region_rwsem to
> +	 * preclude sibling arrival/departure and find the largest free space
> +	 * gap.
> +	 */
> +	lockdep_assert_held_read(&cxl_region_rwsem);
> +	max = 0;
> +	res = cxlrd->res->child;
> +	if (!res)
> +		max = resource_size(cxlrd->res);
> +	else
> +		max = 0;
> +
> +	for (prev = NULL; res; prev = res, res = res->sibling) {
> +		struct resource *next = res->sibling;
> +		resource_size_t free = 0;
> +
> +		if (!prev && res->start > cxlrd->res->start) {
> +			free = res->start - cxlrd->res->start;
> +			max = max(free, max);
> +		}
> +		if (prev && res->start > prev->end + 1) {
> +			free = res->start - prev->end + 1;
> +			max = max(free, max);
> +		}
> +		if (next && res->end + 1 < next->start) {
> +			free = next->start - res->end + 1;
> +			max = max(free, max);
> +		}
> +		if (!next && res->end + 1 < cxlrd->res->end + 1) {
> +			free = cxlrd->res->end + 1 - res->end + 1;
> +			max = max(free, max);
> +		}
> +	}
> +
> +	if (max > ctx->max_hpa) {
> +		if (ctx->cxlrd)
> +			put_device(CXLRD_DEV(ctx->cxlrd));
> +		get_device(CXLRD_DEV(cxlrd));
> +		ctx->cxlrd = cxlrd;
> +		ctx->max_hpa = max;
> +		dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
> +	}
> +	return 0;
> +}
> +
> +/**
> + * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
> + * @endpoint: an endpoint that is mapped by the returned decoder
> + * @host_bridges: array of host-bridges that the decoder must interleave
> + * @interleave_ways: number of entries in @host_bridges
> + * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
> + * @max: output parameter of bytes available in the returned decoder
> + *
> + * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
> + * is a point in time snapshot. If by the time the caller goes to use this root
> + * decoder's capacity the capacity is reduced then caller needs to loop and
> + * retry.
> + *
> + * The returned root decoder has an elevated reference count that needs to be
> + * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
> + * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
> + * does not race.
> + */
> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
> +					       struct device *const *host_bridges,
> +					       int interleave_ways,
> +					       unsigned long flags,
> +					       resource_size_t *max)
> +{
> +
> +	struct cxlrd_max_context ctx = {
> +		.host_bridges = host_bridges,
> +		.interleave_ways = interleave_ways,
> +		.flags = flags,
> +	};
> +	struct cxl_port *root_port;
> +	struct cxl_root *root;
> +
> +	if (!is_cxl_endpoint(endpoint)) {
> +		dev_dbg(&endpoint->dev, "hpa requestor is not an endpointr\n");
> +		return ERR_PTR(-EINVAL);
> +	}
> +
> +	root = find_cxl_root(endpoint);
> +	if (!root) {
> +		dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
> +		return ERR_PTR(-ENXIO);
> +	}
> +
> +	root_port = &root->port;
> +	down_read(&cxl_region_rwsem);
> +	device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
> +	up_read(&cxl_region_rwsem);
> +	put_device(&root_port->dev);
> +
> +	if (!ctx.cxlrd)
> +		return ERR_PTR(-ENOMEM);
> +
> +	*max = ctx.max_hpa;
> +	return ctx.cxlrd;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
> +
> +
>   static ssize_t size_store(struct device *dev, struct device_attribute *attr,
>   			  const char *buf, size_t len)
>   {
> diff --git a/include/linux/cxl.h b/include/linux/cxl.h
> index 036d17db68e0..1b2377062693 100644
> --- a/include/linux/cxl.h
> +++ b/include/linux/cxl.h
> @@ -766,6 +766,11 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
>   struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
>   struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>   struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
> +
> +#define CXLED_DEV(cxled)  &cxled->cxld.dev
> +
> +#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
> +
>   bool is_root_decoder(struct device *dev);
>   bool is_switch_decoder(struct device *dev);
>   bool is_endpoint_decoder(struct device *dev);
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index 11fe8367b046..342ccd5486d3 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -865,4 +865,9 @@ struct dentry *cxl_debugfs_create_dir(const char *dir);
>   void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
>   
>   struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
> +struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
> +					   struct device *const *host_bridges,
> +					   int interleave_ways,
> +					   unsigned long flags,
> +					   resource_size_t *max);
>   #endif /* __CXL_MEM_H__ */
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> index 948cc95c5780..deb5eeae501b 100644
> --- a/tools/testing/cxl/type2/pci_type2.c
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -4,6 +4,7 @@
>   #include <linux/cxlpci.h>
>   #include <linux/cxlmem.h>
>   
> +struct cxl_root_decoder *cxlrd;
>   struct cxl_dev_state *cxlds;
>   struct cxl_memdev *cxlmd;
>   struct cxl_port *endpoint;
> @@ -15,6 +16,7 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   
>   {
>   	struct cxl_register_map map;
> +	resource_size_t max = 0;
>   	u16 dvsec;
>   	int rc;
>   
> @@ -79,9 +81,28 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   		return PTR_ERR(endpoint);
>   	}
>   
> +	pci_info(pci_dev, "cxl hpa_freespace...");
> +	cxlrd = cxl_get_hpa_freespace(endpoint, &endpoint->host_bridge, 1,
> +				      CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
> +				      &max);
> +
> +	if (IS_ERR(cxlrd)) {
> +		dev_dbg(&pci_dev->dev, "cxl_get_hpa_freespace failed\n");
> +		rc = PTR_ERR(cxlrd);
> +		goto out;
> +	}
> +
> +	if (max < CXL_TYPE2_MEM_SIZE) {
> +		dev_dbg(&pci_dev->dev, "%s: no enough free HPA space %llu < %u\n",
> +				       __func__, max, CXL_TYPE2_MEM_SIZE);
> +		rc = -ENOMEM;
> +		goto out;
> +	}
> +
> +out:
>   	cxl_release_endpoint(cxlmd, endpoint);
>   
> -	return 0;
> +	return rc;
>   }
>   
>   static void type2_pci_remove(struct pci_dev *pci_dev)

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2084.outbound.protection.outlook.com [40.107.236.84])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C0510167270
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 07:29:49 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.84
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718177393; cv=fail; b=shOZSGpLKdoX4RbIIEP1NZq6gVS/yLROU3p6Un3WnTunllaAqjwdashChnJ9zOYvx29n6BodAnJe1rS5ZmbOB+FdetvDqVq5VcjTqI95Wt06PPZZ77XGnWZBGcX04fGOx+HstcKfgElPnuzvnOOL6FfWnxmVgg+zxcRhlOBuk+0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718177393; c=relaxed/simple;
	bh=skfnU6l7rYchEPxEapvLG/XSgIuU+vFx7PKJqdKT19Q=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=cZoshdfFJ9Z4MGOEq3H6gZ5mf/RO2pMDy7FjJ2ZwBLdNgkV6w53wBywH6KckUrmdj09rdcW36tixFeE5IBt1KTG5wWqBFaANW5G4KJxG7HlVLsIfbezsV9Tf7wdA5sHW4pnfNB60JBwBP22cep+XQXZ5PWxPxXUViXhJhgDokBM=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=ak5mejik; arc=fail smtp.client-ip=40.107.236.84
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="ak5mejik"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Ec1fgMAigPQvk3C5CO+8nWPs9EFhtt6Gc5qpzdcu/v7hGHZF44lVyDt7ruxKuIjfBM56t0Ei1qflnM9UXMwOVWvFzK9lmWGzs9pe5SrTiOTz0wSjb28+79dpg3JoZUp6vDWrJfehQt/dM4eImhKAlyTCL6HJ+6cas3w+91V4LMRBKIlwAuzoRs3B0PKwOl9mQGylTCgKy6ABc1dYysEfiKURLSVgeQN2FtFNQKEh3VadrTXl0xNJfKa9jK3uBNIhLZLBZ2P+ap4SVdO6WAHAC+4zbS4tPRDphKMTIl02CUmiB96KX3zMc2PyVq8qaePe6GAELYth66z5/IXvvr5H2A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=jIAEEWAQQA51UXWnnmxJAVAFkkPUCBa5j3HPVaRzboQ=;
 b=bAKfMk8S9mNKYE/1BvGLBXLplbyIxOOZhbgrT0quyV0G9PrKZutOUsJno1uTem/KXKqJcFEQrjClMPBtRP9FQGyUnI9qNkOPRbhCh+i6QjK7MAukIYv7v+c4xJBpE2NVPfvh1HtvorvuuKqnuMQgq6Nbrw6LMqE+4vxS6QII7RC+dPavc/z+xz7ABxTtQ5iofPU26mFHJA6Hl1RdVMnyPXIYf1E2bxrTYaxz700+l5PghR+h1nq57DS6i/wj4fd3OyXVbbKkazY3gwwklOC7w/nAO7Lvb2dPVXS2yb0b7S6fnJjGGV/4Y5jRquce7dYdIYrdLmlm5DravGGjjNNZ0g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jIAEEWAQQA51UXWnnmxJAVAFkkPUCBa5j3HPVaRzboQ=;
 b=ak5mejikuZpL1j6iDf1xxGSuYm1lgW9+jtJzUrV4ltNWqNJBV9hL7/4eT637HXrN2bXo7v/9pPlU8Ld3mDLv3uJf6TEeCgu+BnSr44jTXsmIeZI4dT/H9DI8WF1CqA4ofzl+N3e040tyvdoEgE6YoaTS5wBcvLws6Dc0CJR/Ny0=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH8PR12MB7446.namprd12.prod.outlook.com (2603:10b6:510:216::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Wed, 12 Jun
 2024 07:29:47 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 07:29:46 +0000
Message-ID: <709bd377-6f16-fc1e-4c54-29c196a21213@amd.com>
Date: Wed, 12 Jun 2024 08:29:43 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 09/13] cxl: add cxl_request_dpa
Content-Language: en-US
To: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-10-alucerop@amd.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240516081202.27023-10-alucerop@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO2P265CA0432.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:a0::36) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH8PR12MB7446:EE_
X-MS-Office365-Filtering-Correlation-Id: 2c95be7a-0fd6-45f0-2d2d-08dc8ab16f9b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|1800799016|366008|376006;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?THdmdG0rcUZDZWFkVjBzUXNNYUtyMnJwbExObktCSlBpNmhIWHNQKytERFZt?=
 =?utf-8?B?a0hQN04zdHZ0Y1ZPYmpYQnBuQjRMdHkzVVQ4aTAraVdobkhUYUVaeHFmMkoz?=
 =?utf-8?B?UlpUQ0g1dkNZZlV6S1l3djVKYnhzWjZUMk9DbmVtS1ZQdzBKVVRIb1Q3bHN1?=
 =?utf-8?B?RU9kclFxSnBRblltRW95L2hFSnNTQ0ZVMEQ5LzNXd201VDJRNXVIbC96aThy?=
 =?utf-8?B?MThUUVBrcHRDK0FSckwrd0tWNWZ3eVJHdmhOcTgvZmFVRHVaUGdUWmZ0YVlk?=
 =?utf-8?B?TnNpWTZqY0NmN1J1UjROd29QRWhsb3NHeDVTd0VtRE84NlJQbm5XWFJpaHRt?=
 =?utf-8?B?eG1mQmdYcWRJeTJ4T3pvWW50cTZhSDc4MjZXb0x6RG83NmNRd1A5V3FYTDBm?=
 =?utf-8?B?NFd2dnEzSTIxSEhxbDY2SEdKVGk2RDM1UEVBY3FlOEx6dmVHbUtIYlI2bFhy?=
 =?utf-8?B?QWZNa2hsL0lNYndwNk1Dd2l4Q1BiSjZhUVhxU0t2ckQvTjdMbXBZSFFRaVN6?=
 =?utf-8?B?NFc5UXhncVJIa1UzbVRmUWJUS3BEOG1kQUpZVC8vckpwaDc3cVJ6T1BBaGZh?=
 =?utf-8?B?a1JraFo4Y1dYNkU4b3dCZmdxL1JsekdiTS9jVmcxNTgzUU1IQ0xybThYak4v?=
 =?utf-8?B?TXZEdVNFcVJ4MGxZQkp0UVpERmVXZEZLbHJGYW5CeFVUSFU5a1pZQjdVNi9w?=
 =?utf-8?B?TzhoS2VwQlZVcndCc2RTTWsyZjI0VHZBdzFSUWlHMHN2cVNjOGVycmtMSTNx?=
 =?utf-8?B?eXFabW8xY1ZnWDdwenBDTXVnMjZPTU5zQkQ2VWswWEhuL2FaNE95aW83Y0dz?=
 =?utf-8?B?dkVzVE5tMzB3UWVyQXRFbno3R3VzY2pMK1hoRHdReWp0SnEwdTlrZ3hFSC92?=
 =?utf-8?B?RUJDU1o0TVN6NWIwWmcxM1RqRkg5RHJQVWlNb1loT2llc0ZzdW81bU96d3dX?=
 =?utf-8?B?WHUzbUxnL3k1Z3pPNUF1ekpFZi9hTHVhOEdEZW1udDAyczBLUnRtTG9SbEl5?=
 =?utf-8?B?WGowQ000bDRhbDhBdVJueUtLenpYbG5aVThOTzlGaXJBY05uS1NhRDMrZ3Vk?=
 =?utf-8?B?Umh4S00wMmplY3VpNzA3VCtTQW5GNzMrdFEwaFhna1Uyc2ZJU3Q2Z1BRalc3?=
 =?utf-8?B?MlFnaHpETXJJYmhoNTlycWs1QUxiTGJxaHc3VEJhUGJHN1BCK0ZrKy9WYTZ6?=
 =?utf-8?B?eWd0TW9rMkhMaXpEQm94c1RhTWFya25yWUx1UnNmWXlwYU5Qb2pQanVvSnAr?=
 =?utf-8?B?aHFqbU9aY0xCWWdsdWdtOTJQMVRPQjVmM3RHblVEc2RBUnkvSEdobDQ0Uy9B?=
 =?utf-8?B?ZlZmYUdEcEYrcEdXZGpBQWVqM0crOGtFRjJmdWZHR3NwaFB0Sk50VE42VkFz?=
 =?utf-8?B?a0JySHdWYVlodW1uS1BjNEdhWjd6QmtGK3hnZkZIRWRtV3dKTlo5MGhDd0VY?=
 =?utf-8?B?NUlNU1VJMXg4aFFNK3FiSWRvdU9LV1FEQmdVeGdoY0dab01YRzd5UXIzd0Za?=
 =?utf-8?B?UXc1SVdpOXhHL0RKZVFRNWtSRmRtODBWclcrQ2NISmcvR1hhcWlOQlJObWFP?=
 =?utf-8?B?MFV0d2U3a08rZzNnQ0JaNzVLbXVWcTcxdncyRHUyRXJLb1JRRlpXMnBUbHFF?=
 =?utf-8?B?Q2NHLzVDdG9xNFV5QklSc2JLWkRRdmlDNDJsdnRyMEpWKzFaUWQ2NWppTHNk?=
 =?utf-8?Q?rQPwyl0tL7MqLGWOHV6K?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(1800799016)(366008)(376006);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?Sy95ZjlPRUN0amZtbjBYc1dvS2RZQzR3TTdudi9ENHAxbzlheUlza1JlYURu?=
 =?utf-8?B?dkM5Q0t5OG1md0ZvTGpnMVp1a1UvaGg2aG9sWWZmMFRqanZ4b1FyUEE1WnMz?=
 =?utf-8?B?dXdOcjdQNU5obllDdjRQQ1R3anc3V1k4L0h4WENvdUY0c2NkOEtxNWNTQi9j?=
 =?utf-8?B?anBua2hnUkJFamI5ckhheGd4cE9jZ2grSit2MlVESFlkZW5JcEdZVzI0YVJX?=
 =?utf-8?B?ZHpwL1lwd0U1QjN0ZTA4TCtEeVFxWndlOVYwekJ1ZDUreVpqbUkyeGZZTnMy?=
 =?utf-8?B?cmI0Qm8rYTZQRzJVUDJnazdXdVpOYkRKWXcvcUhIcEwzOVlJOXcxays1RTR5?=
 =?utf-8?B?N01ubXZ0MDB3dXk4Zm9TMzBxZjNUS3N5cytpcVBZVnZ3bjBaRXl4aDRZNERl?=
 =?utf-8?B?RGJ0WlowRXRiWEpHSTh1eUt0MWxrRUt4S1lvWE5ycFlQZkRSUjFJTm9xdjBo?=
 =?utf-8?B?Nmt0cENJVng2YnNSK3hQV28wQVJsVXhvWm5rQTFRUGEyRy90UktSRFVUNTNJ?=
 =?utf-8?B?NmlCUVpFTmNmZ2VueStLQzJOMzJySTdua3FvUTUySHYzWUJ6TmRMdkJhTHFL?=
 =?utf-8?B?SkJnb0xLOW5JL3ZNUDdqV2l0VzE5VHVNQlE3cFgzL1FhZEdlS2o0NVdjTTBN?=
 =?utf-8?B?WjEzNDZBZy9tN0pvWit0L2xsQTlrOElWejVBb1lyU09kSkplbmRNRWFEclBT?=
 =?utf-8?B?dWx1aXhaOUg4NmxMbUxhRWlWWnhuZXhRc2pLN3pCUEttNkZVQXNNNkMvWlNZ?=
 =?utf-8?B?RVNlUndveHFNVnlvK1kvUFZBUXZxOHdtSTN1NUdJKytpN2NCb2VsNTl6VTdl?=
 =?utf-8?B?elhHVnZ3cy9SWFh4ZmZYTHF4WWg3ZG41QjhqYlFiZ0JPOVhRVUxGbkNYdzds?=
 =?utf-8?B?Uloydmx5VUxITldMcEFKaUY2WTZQdU9rVDNZUTZRdDYvVE9SWG5RN1RzN2lD?=
 =?utf-8?B?a3Q5VmdHQkxkd3l0UVY5QytrUlhzTlA0bElBVjIzY3VIS2RpQzFQaDQvUHJ6?=
 =?utf-8?B?cHRSMTU5N1JiNmxVbnowYXRBOVRGdVNoL1NScll0ejNhd3B3VFNxS2lsY0Rz?=
 =?utf-8?B?cU9iamViemwybjVJcnJlVVNOTXVZRXRtT3RRdFdQRjkwQUZ3aEcrdm1TL2xR?=
 =?utf-8?B?U1hqaW55RkxoUVlYTS9mYW5sWk12NHA1SUNUOXUxdTkyVWROOUJtNWZXQW9L?=
 =?utf-8?B?VnZxWmlMYTYzOG9yZloxZjVKYXhwcVVxLzI0QnpOOUI4dkJiWllFZm1MWTJr?=
 =?utf-8?B?QmI5U0w1elBUWEQySXFhQWJEN1N0akJDbmxxSGFJMjZUVXpYY25obEpMT1FF?=
 =?utf-8?B?Q2cwMGw2NDdsMForNTlIWGN2TXgrcVU2eFVpVEY1QnJiTlVSb3JaeW9SYkNS?=
 =?utf-8?B?L3dIVFZwTk5HTnNPK1g5ZkppZ0lndE5qS0NwSXNqUDlISDZoNEx3d3laVjN4?=
 =?utf-8?B?SWtqZUM5UnM0TjNZZ2Z0dExxNC96WUhqWGhZa0FuZE9LYjlrMllMcFVhbldz?=
 =?utf-8?B?SU5WZWVCZE80ZU5PMk1rVW1uL2RnQVhiTTFlUStxN2Yxa3pTWEYyZEx3YTlQ?=
 =?utf-8?B?WSt0SDBRcXBJbGZKUkxhaVVWYUlTZHhad2c1SjFtSTRtdVVhRk9hMEYybFRJ?=
 =?utf-8?B?U05HTjhCenhRaGhuTldHN3V1V2N0cjNLd2tpYTc5VWE1Q2ZwTjFnY3diVkli?=
 =?utf-8?B?YkdtUENSM1lMcmY3R3JPK2xUNzRYTElBeFV4dkl3aVhDU3NVNlNLdURrNER2?=
 =?utf-8?B?U2hKVkovQ3ZaWGtIMWJheURVL1dNY2orOFBaVUtTbUFIci9aWDdyWTltelNZ?=
 =?utf-8?B?Q0ZHemo2NklzRWVyV3Jwb1RnbktVdVAvTTNVUm1wR0FaUEN5a3FIUVVDeW1p?=
 =?utf-8?B?c252NXMxejZlM3FEbXhTaHhCbGZZVitvVTBKbkdJc29YUHhDMVU3OHlVS1B2?=
 =?utf-8?B?ODlJcGdnazhMaE5wSDZBS2d0a1ZXRDZZR1VOVWUycmNzZjlXT2tMZVNBSW5x?=
 =?utf-8?B?QjBobjBMZFpzYjJRVXBjN3hWR2xGMjh6aXlPbmtKWVNQL01QeTNuVHpXMDhT?=
 =?utf-8?B?NU00Q0JKbk96TjRmeDVDMENWNlRLelVIYnpDMUV6eFFWUzM5MEw0M0ZzaHZM?=
 =?utf-8?Q?Qp65Zo52zNUl1SlNYV46czIYp?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 2c95be7a-0fd6-45f0-2d2d-08dc8ab16f9b
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 07:29:46.7929
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: W6+DaALYhs5lmloi/SPu7U1VNbDu9bogg1gI5lokIdsP5BTD1kOxWN4dr99pHwbTVLmSrpUchP8pdW7+/yAHQg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB7446

From: Alejandro Lucero <alucerop@amd.com>

Search and reserve DPA given input constraints.


Based on: https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m4271ee49a91615c8af54e3ab20679f8be3099393

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>



On 5/16/24 09:11, alucerop@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Search and reserve DPA given input constraints.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>   drivers/cxl/core/core.h             |   1 -
>   drivers/cxl/core/hdm.c              | 153 +++++++++++++++++++++++-----
>   include/linux/cxlmem.h              |   5 +
>   tools/testing/cxl/type2/pci_type2.c |  12 ++-
>   4 files changed, 145 insertions(+), 26 deletions(-)
>
> diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
> index bc5a95665aa0..c0a2e2c1ccb3 100644
> --- a/drivers/cxl/core/core.h
> +++ b/drivers/cxl/core/core.h
> @@ -61,7 +61,6 @@ struct dentry *cxl_debugfs_create_dir(const char *dir);
>   int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
>   		     enum cxl_decoder_mode mode);
>   int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size);
> -int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
>   resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
>   resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
>   
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index c5f70741d70a..6459b6ecde88 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -404,6 +404,7 @@ int cxl_dpa_free(struct cxl_endpoint_decoder *cxled)
>   	up_write(&cxl_dpa_rwsem);
>   	return rc;
>   }
> +EXPORT_SYMBOL_NS_GPL(cxl_dpa_free, CXL);
>   
>   int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
>   		     enum cxl_decoder_mode mode)
> @@ -451,30 +452,17 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
>   	return rc;
>   }
>   
> -int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
> +static resource_size_t cxl_dpa_freespace(struct cxl_endpoint_decoder *cxled,
> +					 resource_size_t *start_out,
> +					 resource_size_t *skip_out)
>   {
>   	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
>   	resource_size_t free_ram_start, free_pmem_start;
> -	struct cxl_port *port = cxled_to_port(cxled);
>   	struct cxl_dev_state *cxlds = cxlmd->cxlds;
> -	struct device *dev = &cxled->cxld.dev;
>   	resource_size_t start, avail, skip;
>   	struct resource *p, *last;
> -	int rc;
> -
> -	down_write(&cxl_dpa_rwsem);
> -	if (cxled->cxld.region) {
> -		dev_dbg(dev, "decoder attached to %s\n",
> -			dev_name(&cxled->cxld.region->dev));
> -		rc = -EBUSY;
> -		goto out;
> -	}
>   
> -	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
> -		dev_dbg(dev, "decoder enabled\n");
> -		rc = -EBUSY;
> -		goto out;
> -	}
> +	lockdep_assert_held(&cxl_dpa_rwsem);
>   
>   	for (p = cxlds->ram_res.child, last = NULL; p; p = p->sibling)
>   		last = p;
> @@ -496,7 +484,6 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
>   		skip = 0;
>   	} else if (cxled->mode == CXL_DECODER_PMEM) {
>   		resource_size_t skip_start, skip_end;
> -
>   		start = free_pmem_start;
>   		avail = cxlds->pmem_res.end - start + 1;
>   		skip_start = free_ram_start;
> @@ -506,21 +493,50 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
>   		 * already handled the skip.
>   		 */
>   		if (cxlds->pmem_res.child &&
> -		    skip_start == cxlds->pmem_res.child->start)
> +				skip_start == cxlds->pmem_res.child->start)
>   			skip_end = skip_start - 1;
>   		else
>   			skip_end = start - 1;
>   		skip = skip_end - skip_start + 1;
>   	} else {
> -		dev_dbg(dev, "mode not set\n");
> -		rc = -EINVAL;
> +		avail = 0;
> +	}
> +
> +	if (!avail)
> +		return 0;
> +	if (start_out)
> +		*start_out = start;
> +	if (skip_out)
> +		*skip_out = skip;
> +	return avail;
> +}
> +
> +int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
> +{
> +	struct cxl_port *port = cxled_to_port(cxled);
> +	struct device *dev = &cxled->cxld.dev;
> +	resource_size_t start, avail, skip;
> +	int rc;
> +
> +	down_write(&cxl_dpa_rwsem);
> +	if (cxled->cxld.region) {
> +		dev_dbg(dev, "EBUSY, decoder attached to %s\n",
> +			     dev_name(&cxled->cxld.region->dev));
> +		rc = -EBUSY;
>   		goto out;
>   	}
>   
> +	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
> +		dev_dbg(dev, "EBUSY, decoder enabled\n");
> +		rc = -EBUSY;
> +		goto out;
> +	}
> +
> +	avail = cxl_dpa_freespace(cxled, &start, &skip);
>   	if (size > avail) {
>   		dev_dbg(dev, "%pa exceeds available %s capacity: %pa\n", &size,
> -			cxled->mode == CXL_DECODER_RAM ? "ram" : "pmem",
> -			&avail);
> +			     cxled->mode == CXL_DECODER_RAM ? "ram" : "pmem",
> +			     &avail);
>   		rc = -ENOSPC;
>   		goto out;
>   	}
> @@ -532,9 +548,98 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
>   	if (rc)
>   		return rc;
>   
> -	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
> +        return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
>   }
>   
> +static int find_free_decoder(struct device *dev, void *data)
> +{
> +	struct cxl_endpoint_decoder *cxled;
> +	struct cxl_port *port;
> +
> +	if (!is_endpoint_decoder(dev))
> +		return 0;
> +
> +	cxled = to_cxl_endpoint_decoder(dev);
> +	port = cxled_to_port(cxled);
> +
> +	if (cxled->cxld.id != port->hdm_end + 1) {
> +		return 0;
> +	}
> +	return 1;
> +}
> +
> +/**
> + * cxl_request_dpa - search and reserve DPA given input constraints
> + * @endpoint: an endpoint port with available decoders
> + * @mode: DPA operation mode (ram vs pmem)
> + * @min: the minimum amount of capacity the call needs
> + * @max: extra capacity to allocate after min is satisfied
> + *
> + * Given that a region needs to allocate from limited HPA capacity it
> + * may be the case that a device has more mappable DPA capacity than
> + * available HPA. So, the expectation is that @min is a driver known
> + * value for how much capacity is needed, and @max is based the limit of
> + * how much HPA space is available for a new region.
> + *
> + * Returns a pinned cxl_decoder with at least @min bytes of capacity
> + * reserved, or an error pointer. The caller is also expected to own the
> + * lifetime of the memdev registration associated with the endpoint to
> + * pin the decoder registered as well.
> + */
> +struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
> +					     enum cxl_decoder_mode mode,
> +					     resource_size_t min,
> +					     resource_size_t max)
> +{
> +	struct cxl_endpoint_decoder *cxled;
> +	struct device *cxled_dev;
> +	resource_size_t alloc;
> +	int rc;
> +
> +	if (!IS_ALIGNED(min | max, SZ_256M))
> +		return ERR_PTR(-EINVAL);
> +
> +	down_read(&cxl_dpa_rwsem);
> +
> +	cxled_dev = device_find_child(&endpoint->dev, NULL, find_free_decoder);
> +	if (!cxled_dev)
> +		cxled = ERR_PTR(-ENXIO);
> +	else
> +		cxled = to_cxl_endpoint_decoder(cxled_dev);
> +
> +	up_read(&cxl_dpa_rwsem);
> +
> +	if (IS_ERR(cxled)) {
> +               return cxled;
> +	}
> +
> +	rc = cxl_dpa_set_mode(cxled, mode);
> +	if (rc)
> +		goto err;
> +
> +	down_read(&cxl_dpa_rwsem);
> +	alloc = cxl_dpa_freespace(cxled, NULL, NULL);
> +	up_read(&cxl_dpa_rwsem);
> +
> +	if (max)
> +		alloc = min(max, alloc);
> +	if (alloc < min) {
> +		rc = -ENOMEM;
> +		goto err;
> +	}
> +
> +	rc = cxl_dpa_alloc(cxled, alloc);
> +	if (rc)
> +		goto err;
> +
> +	return cxled;
> +err:
> +	put_device(cxled_dev);
> +	return ERR_PTR(rc);
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_request_dpa, CXL);
> +
> +
>   static void cxld_set_interleave(struct cxl_decoder *cxld, u32 *ctrl)
>   {
>   	u16 eig;
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index 342ccd5486d3..caf1cd86421c 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -870,4 +870,9 @@ struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
>   					   int interleave_ways,
>   					   unsigned long flags,
>   					   resource_size_t *max);
> +struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
> +					     enum cxl_decoder_mode mode,
> +					     resource_size_t min,
> +					     resource_size_t max);
> +int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
>   #endif /* __CXL_MEM_H__ */
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> index deb5eeae501b..6499d709f54d 100644
> --- a/tools/testing/cxl/type2/pci_type2.c
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -4,6 +4,7 @@
>   #include <linux/cxlpci.h>
>   #include <linux/cxlmem.h>
>   
> +struct cxl_endpoint_decoder *cxled;
>   struct cxl_root_decoder *cxlrd;
>   struct cxl_dev_state *cxlds;
>   struct cxl_memdev *cxlmd;
> @@ -99,6 +100,15 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   		goto out;
>   	}
>   
> +	pci_info(pci_dev, "cxl request_dpa...");
> +	cxled = cxl_request_dpa(endpoint, CXL_DECODER_RAM, CXL_TYPE2_MEM_SIZE,
> +				CXL_TYPE2_MEM_SIZE);
> +	if (IS_ERR(cxled)) {
> +		dev_dbg(&pci_dev->dev, "cxl_request_dpa error\n");
> +		rc = PTR_ERR(cxled);
> +		goto out;
> +	}
> +
>   out:
>   	cxl_release_endpoint(cxlmd, endpoint);
>   
> @@ -107,7 +117,7 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   
>   static void type2_pci_remove(struct pci_dev *pci_dev)
>   {
> -
> +	cxl_dpa_free(cxled);
>   }
>   
>   /* PCI device ID table */

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2081.outbound.protection.outlook.com [40.107.244.81])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 36A4829413
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 07:32:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.81
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718177539; cv=fail; b=A86Q03ia/VhBtuFDnnbuXpdd0DRU/5TsBNE2J9NaSOcgMBL/JM9vB56UBibKSSiczafPMP87KRtx0OKREwUpK5MFUf6gveL6XT8epV3ZnKUkMyp0AI4FIvt40eoL10FU5jQI5359eojg6xAOmcTvMrpnGxSv+J2m8KFWqzvFgS8=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718177539; c=relaxed/simple;
	bh=WVWJrFQSm84bXDTBgwKRJZiEDto1GOTaMqiDm7G5OIY=;
	h=Message-ID:Date:Subject:To:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=eces+ZCFVq7X9tgYZ54beJdV+jbtGRFmLvAAbeZUeml/LloDPjZ0P/6AJcJjL/kKFmdlufb1MsuQVJUB4G7Xtwt+Sa0pi9kdQLMPsLAijQxfVd0oJKC+8oKFrC7+Dp2q9zZUkCiB6obGgsPt0r34WoRAzX87k+ijglMLvxy19+Y=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=LUPWlTcG; arc=fail smtp.client-ip=40.107.244.81
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="LUPWlTcG"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Xkdu1z3VYrCspDLstifjWZVKLuohWGckaj1Fo/2HItu5dr9ERZiA0RJI7JxzB88/6mhBAxnQw0YXgOb74ChbJiq4ATv0umhXP0FvYbWBGDijO6C3j4lxofcsLGTJYPh5CVziSisH5G9NiF5qlafRS6qpV6/BbqY4lxlxupqUtbG12g6tfMib/g2yycTm0NdB0Oc5LWp3T0UpXin8wi3+vaTTf8Q9D1qltKaDwt2riOGsJ2CEiDRnue/lfLoo+O+dHinBxg69jvwJ3mwZEbwPi3Ccb1iCmkHGGLnQT5wi7qQfNDvMyAqbsQAaXDdNgRIXqz1UbQjRYaAYR1p6ciNXsA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=HbpsONiUIGjBoo/To/ruyTQf1mgv5N/sLlu7+vf3Q0E=;
 b=WI6CQ+RPkczt06guCOu9JHTn4CPtc7SnMIeUopF/HhnaAvhMh29Is2Gn2mmA68zsfj8nNDCNDIkLXCMrvWeVfUqRhcG+MZUim2V1f8yYMDxLPP5K7xRVzkMVab2wB+cK/qMcGWjEixS6vLN9msZ329EIYmvYUxVaMexQI93kiljuNsTAVtEuy/wH1NI2xDGIDkPIt+K1JgZe6UPZ2l3YrHX/4XQAUtWMxqm5GOb/OThwpdwGkciQIgLCDZGX0Ai/WbjZiJFEFJUbQPa8lJ6KfXszgDVPc72py+5eCeHzgTiBFvBqkBGtI4/Pbo5ncrkFGAzXY5YGNCuGlJlqQvSsjQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=HbpsONiUIGjBoo/To/ruyTQf1mgv5N/sLlu7+vf3Q0E=;
 b=LUPWlTcGWRv0d/yVM8g9QESjgdDqmHBqWXk11gGr3NG13ZBNnpf2AmshlOCoLJ5/6ffyw+txxyTN8t2BZeXaiQZNhVBQc7hq1xq5Gq+UvjXnvTOM2+JxlYoJzWW5NI+ckrT65ZscqF1Qxif+4oUtcSpdr+93ZrVdtf8+Z2boibM=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by SA0PR12MB4478.namprd12.prod.outlook.com (2603:10b6:806:9c::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7677.21; Wed, 12 Jun
 2024 07:32:12 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 07:32:12 +0000
Message-ID: <8112d79e-d7fe-a13f-df08-bc2a460f264f@amd.com>
Date: Wed, 12 Jun 2024 08:32:08 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 11/13] cxl: allow automatic region creation by type2
 drivers
Content-Language: en-US
To: linux-cxl@vger.kernel.org, dan.j.williams@intel.com,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-12-alucerop@amd.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240516081202.27023-12-alucerop@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0446.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:1a9::19) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|SA0PR12MB4478:EE_
X-MS-Office365-Filtering-Correlation-Id: 76c7a3d5-4e10-41b8-9b9d-08dc8ab1c6b9
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|366008|376006|1800799016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?Y2QrbzhCOG14djJUajF0VTRrRlFYVkJuOFMwYmU2WlkyMUN3bVlQMWRmcEZx?=
 =?utf-8?B?NFpHeXFZSHovLzBVdnA5UXBaOW9vdk5aS1JOdm82bGV5VnJUdHlQcWJZMU1r?=
 =?utf-8?B?VjRBRFlHNjlmRlJrMDdhdVM2L0VJeWgvaGd4NFJ0bng0dUZhSHJud0xnV1lI?=
 =?utf-8?B?Y29UWUhVSXFLbkJhL1R5RktNUXp5Y29JNWpRQyszeUFHOFdKSk9hVHg2ekRi?=
 =?utf-8?B?cDUrVy9CRlRNdHkwUzMzNGZ6SGNEQjY4andnYjRzcEZseENxWmlKN2pkVDlU?=
 =?utf-8?B?aVNsazlrT2l6aVR1a3lVNGtpSjdJaEFQOWJ5U2p0bUJUMzg1Z05Sc0JkaGxM?=
 =?utf-8?B?b01QL21hQ1JvTnJtUWQrWVpBMXJpNk1JV3I4NHdKb09ZWlpNNGdZeWlHa0V1?=
 =?utf-8?B?VzQ5UGZWQ2o1S0VwMHV0ckxYaUErbjJuWXY4Z1N0bnNwVitCU25lVnBJQmt0?=
 =?utf-8?B?dFB1eWVWcUcrWVhzTDVsVERNb0xpL1hNSGltamdwangxQ2hKVUZOa1NtdTRZ?=
 =?utf-8?B?bmUzZW9sWEpZYmZ0MWNZYlhTdXprMUZ0dEtreUVPbmNiY0VYSXVxdmcxTDBJ?=
 =?utf-8?B?ekFEYnQwVXBXZlVtK1dYS2t0NGhDZnNRQ3V0MDB1ME5LMGFsbi90dFRMaDlh?=
 =?utf-8?B?RXVWeVo3VzBtQkt0TmxwZGNXdlN0TjkrL2QyV2ROTkVYeTEvcDZWN1B3MmRt?=
 =?utf-8?B?aHNoazc5ei9abk1aSURueDBJMmpXZDhnaU9Uby9GM3lsc1ZmMVA1QVlJMUF5?=
 =?utf-8?B?S21iNDZkNEo4bmZBb3RvQVNHSy9MekhUZFJtV0NxZUFSa1Q1Qll0NTAyd0p0?=
 =?utf-8?B?b3JkaTJxMW1nSXlPWVdoN09jdnh5eFRaczJSS1J1SzFxVk40Y3RpZkVlSVpn?=
 =?utf-8?B?dE1NOTY2b1kwMy85b2lMQmpLYVVXS1d4bjNzR0cwRXZhbU5VMzZJcjQ0Zkhr?=
 =?utf-8?B?LzVVZC9yM3JLKzViL25OR095Q3NpQXpOaXlnL2FST0ZueHdXMHBOSDJiK1dK?=
 =?utf-8?B?czBHU2xEamhLZDNLSzdNcjVVblY3ZWRremRlMUhySER4d0JYT21rbFZ1NVhG?=
 =?utf-8?B?R0NHeG04MTZvajVOTWI3bXQxYlkvMDl2Y1EwR3hDd3lnem02NUZBSkFrZFdP?=
 =?utf-8?B?L1NFUDc1Q0R0eHIvOS9CUzVNVzBXcmpEbHhXU0JRd1dKd3RnZUFSNkZaM0lk?=
 =?utf-8?B?VS9pQXk0dUxGNi8zSnJ4bnZoYlAySXMzNGRhUzRBbG1Ga0JYaDd5dlVxbU1a?=
 =?utf-8?B?L3lpQU8wcWVLYmdjOE1CTTR3M0o1d29FM3hkeWhmV0lWMW9wdHk4dGJBR1RR?=
 =?utf-8?B?VWtncFhFdzZXL0VXcStMMDErbFJFbm56MlZHYkpvb3g2YjdtRURtUzhxbGNH?=
 =?utf-8?B?RVhRclZtT0JVZlgyQ2g2RGFnQWVISnRTUHo0cEY0ZmpHNVA1ZGs3Ujd6V1NB?=
 =?utf-8?B?NXpVcm5wUDZXbVA3Q2dETlVkSHppSklrbzNSNjY5SFM4dTRhRVplOWxOcUpL?=
 =?utf-8?B?anJpUDJnN2luV1ROMUhQTllRMW9vdXpQaFNhQTc2RnA1WUFvdnloSzNMQkIy?=
 =?utf-8?B?eDR3UzZzcWc5Zm1MVkdSN0ZKQldTSnAxZ0MvRjRucUtVa1Z1ZmhNZHlNZmVH?=
 =?utf-8?B?djNGMXcvZzduYndHcmppUllDTXVpNHZweUZjODAxUElWQVh1d3BYdE5LWUdO?=
 =?utf-8?Q?f/m3XBZZIyQ4hMXC4xlU?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(366008)(376006)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?L2NiVEtMcWFSbnZsM21pU3VHQzZTeG1yU1RQMzVhbDFScjAyaG4xWkNZdHM4?=
 =?utf-8?B?VEVxNzhyK0FnZ3NQUUtac1FtaFM0YVBoa3BLUFpCSDBpUCs4K2xNb3drbVFX?=
 =?utf-8?B?bElINVgyYVhHYU9DeXFpQjZCdUJTUnNFUXNkUmJFWUU4N0VsZ2xlMlpzQ2JZ?=
 =?utf-8?B?OW1RSnFkbVo4RUJ3T29GU1lMc2xlOVQ1eUFYZXJzYVZJZVo1c2FucmsvNFdC?=
 =?utf-8?B?RHIrcU9RVjlkWUZpUE5OZjU3SlFWU0pvU1VVeVhiQVpUdDgwdTh4dFFuLzY4?=
 =?utf-8?B?Wm1jTmZzYXQ3WW5oMTlQK2hmOTJYZVZyZnFkWmh1YjNUNjIyejA3K0FiSFBo?=
 =?utf-8?B?WXEwM3o0TnJKSStnSWsyWDdwVVlSMFZsajV0MHNPWjk5cVZFZ3ZNZXh0eUEw?=
 =?utf-8?B?ZngrUHZvanVPU1A0OFNQQkt1aUJ2bkJYTXJqQzlZUjhMWG5BWjN1cmpPK1dm?=
 =?utf-8?B?WS9KVXRjTXl4QXNSWG5NYmlhV3NyZ0cyNmV4L2k0VE9iaG1RSEhGSzdBeU5t?=
 =?utf-8?B?TnJYMUd1Y1FwNWxyZWJmZ3NQMWV4ejFvbDJvUVIrU3k4LzJQN0FvY3RuN1Ey?=
 =?utf-8?B?N1pZRU9GRUlCUWh2WUJzS3FQMnIxTmpDV2h2Ykp0RlFuYXFVUDdUMEI4aGV2?=
 =?utf-8?B?c21KNEZJZmtjYVBVYkZwaW5QWUxZdUtwalJoRHljWXdDb0g2UE9UZG5Ja2hN?=
 =?utf-8?B?SG1WcXJNREg3Z2RKQ3hQN2tHeTBHODhlZUw3KzZScHZzcytXVkplUjIzV0wy?=
 =?utf-8?B?aVVQZWpmOFJzUm1WUU94bW9aZVJJM0lBMk5YVVIwdkpDSEZpTWxLMVpuR2xx?=
 =?utf-8?B?RnIreGJ0N0NHTmlOVmFBOXgrTURFYXRUZ3RCRlRFQXZKd3VmUE5FWDBtbWRQ?=
 =?utf-8?B?ZVVrcEQ2RTRna1J6UnFkN0ZUemdmM1RvNFdKZVdUYmphR1V1aVdqK1hNclU4?=
 =?utf-8?B?S0RBeG5PeFBqRVIwWFVkSU5CdVIrSlkwN05MZGs0d2RnYXNXOFBSM2lsMzdY?=
 =?utf-8?B?a3d6Znh1Z1VNU2MzMmFlK3d1U3dMZ2JUeVNDUWpnVGtFRDV4V2dDQ0lKZXA0?=
 =?utf-8?B?RndVaW51NTRTeGhoZytHUE1UbkhFMm1NM0pBREN2YXRVR0JjdUtwUGxtZ2sy?=
 =?utf-8?B?WW5OZnVjTER4SGY4dzFpeG11TzVvdGFQVnM5andpZWFHMWVxaUJMQTk0WDdx?=
 =?utf-8?B?VENvMmYwNnJIeHNndnBuT2llUWJBYktMWlU1dzgrSGxHS1A2SmQrYmltdGJp?=
 =?utf-8?B?RDdsbFhEMVM2QVdsVlNjYTlzL3E3bnBpY2hzWHl2cldwU3NJMkw0OFNRSTVo?=
 =?utf-8?B?TFdXMjV0bEJEYlRWVUt1ZXlzTmhqcUN5T01WSWZDUU9mNlBVY2syRFg2TFF0?=
 =?utf-8?B?NmRqYm45S3IvWjdMNklrc2ZqRFp1S2FoRm4vd3dNWUtPREdjc21ReHlFblBz?=
 =?utf-8?B?dnZ1MmVWaEdFMk9tUUYzK2w4RTUzUWJPQm1RT3Mwc0NaSk4veEVqUmtYMU8v?=
 =?utf-8?B?amFubmtlVFZ0UXpjMnIxSHdwNHd4WE56K00zdlVFWkpPbmVlQ01jNjNINzVZ?=
 =?utf-8?B?Q2kxMVphbEw3WWl0SUkrRDlnbklhTVpTajhmemRYTFptbVJpUUtJNHFYeGhO?=
 =?utf-8?B?NVRpRFhrYTRGYU42WFlla0NjcW1ucnRLRVRqNHd4dVFRVG9xZUtLZTl5Q2Z4?=
 =?utf-8?B?ZUpDR1k3Skg4Njd2ZU5FTHN2Kys2bVVQMU9JQnd2WWt3ZlVsK0I5S0FQQ3g2?=
 =?utf-8?B?ZjhKaDhxWDBYL0lFU3p5ZFNpS1VoamFkK09RR1V5T0oxNG00TVNGMllmSjlJ?=
 =?utf-8?B?NkdEWllCV2l3dlBXejV6KzRoTUdPWDMwTUw3SEtmQlZSdVYvZzAwL3JzdVl5?=
 =?utf-8?B?S1JDOWhtbU4zVWRVY0ZVRUQxSjBQVU8xb09hZmg0bXljV0d6VVZOUlhBMTMy?=
 =?utf-8?B?NG5CVkFCWnQ3NXg2cDNLSmh4TUVoeVhOV043NFJvd0dvVWhnTzI1b3k2cG5V?=
 =?utf-8?B?aTFOd0sycVRQRFp5ZFhaR1pVeC9SZEdXenp3TU9oQWZsTk5PdVdNUStHOXZw?=
 =?utf-8?B?Y0FDZkdjQmVRQVpKQkpjcW9aNjFrWkJSL3IrS05HcmtkTyt1WU4yV0h6QWpm?=
 =?utf-8?Q?qIbwv15Npdk04WJVBTmMCuQUo?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 76c7a3d5-4e10-41b8-9b9d-08dc8ab1c6b9
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 07:32:12.8644
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: m7mimKnio6+MJ8vf5mzElYSmMQis/Yj1GqFMaflq9ZJqS08+2+NTOIeEyPoWkxIlpJQ9WNe8Rq2lHRlbLCACbw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA0PR12MB4478

From: Alejandro Lucero <alucerop@amd.com>

Creating a CXL region requires userspace intervention through the cxl
sysfs files. Type2 support should allow accelerator drivers to create
such cxl region from kernel code.

Add that functionality and integrate it with current support for
memory expanders.

Based on: https://lore.kernel.org/linux-cxl/168592149709.1948938.8663425987110396027.stgit@dwillia2-xfh.jf.intel.com/T/#m84598b534cc5664f5bb31521ba6e41c7bc213758

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Co-developed-by: Dan Williams <dan.j.williams@intel.com>



On 5/16/24 09:12, alucerop@amd.com wrote:
> From: Alejandro Lucero <alucerop@amd.com>
>
> Creating a CXL region requires userspace intervention through the cxl
> sysfs files. Type2 support should allow accelerator drivers to create
> such cxl region from kernel code.
>
> Adding that functionality and integrating it with current support for
> memory expanders.
>
> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>   drivers/cxl/core/region.c           | 262 ++++++++++++++++++++++------
>   include/linux/cxlmem.h              |   4 +
>   tools/testing/cxl/type2/pci_type2.c |  18 ++
>   3 files changed, 228 insertions(+), 56 deletions(-)
>
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 8228b7e96d8d..014684ff4343 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -479,22 +479,14 @@ static ssize_t interleave_ways_show(struct device *dev,
>   
>   static const struct attribute_group *get_cxl_region_target_group(void);
>   
> -static ssize_t interleave_ways_store(struct device *dev,
> -				     struct device_attribute *attr,
> -				     const char *buf, size_t len)
> +static int set_interleave_ways(struct cxl_region *cxlr, int val)
>   {
> -	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
> +	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
>   	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
> -	struct cxl_region *cxlr = to_cxl_region(dev);
>   	struct cxl_region_params *p = &cxlr->params;
> -	unsigned int val, save;
> -	int rc;
> +	int save, rc;
>   	u8 iw;
>   
> -	rc = kstrtouint(buf, 0, &val);
> -	if (rc)
> -		return rc;
> -
>   	rc = ways_to_eiw(val, &iw);
>   	if (rc)
>   		return rc;
> @@ -509,25 +501,42 @@ static ssize_t interleave_ways_store(struct device *dev,
>   		return -EINVAL;
>   	}
>   
> -	rc = down_write_killable(&cxl_region_rwsem);
> -	if (rc)
> -		return rc;
> -	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
> -		rc = -EBUSY;
> -		goto out;
> -	}
> +	lockdep_assert_held_write(&cxl_region_rwsem);
> +	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
> +		return -EBUSY;
>   
>   	save = p->interleave_ways;
>   	p->interleave_ways = val;
>   	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
>   	if (rc)
>   		p->interleave_ways = save;
> -out:
> +
> +	return rc;
> +}
> +
> +static ssize_t interleave_ways_store(struct device *dev,
> +				     struct device_attribute *attr,
> +				     const char *buf, size_t len)
> +{
> +	struct cxl_region *cxlr = to_cxl_region(dev);
> +	unsigned int val;
> +	int rc;
> +
> +	rc = kstrtouint(buf, 0, &val);
> +	if (rc)
> +		return rc;
> +
> +	rc = down_write_killable(&cxl_region_rwsem);
> +	if (rc)
> +		return rc;
> +
> +	rc = set_interleave_ways(cxlr, val);
>   	up_write(&cxl_region_rwsem);
>   	if (rc)
>   		return rc;
>   	return len;
>   }
> +
>   static DEVICE_ATTR_RW(interleave_ways);
>   
>   static ssize_t interleave_granularity_show(struct device *dev,
> @@ -547,21 +556,14 @@ static ssize_t interleave_granularity_show(struct device *dev,
>   	return rc;
>   }
>   
> -static ssize_t interleave_granularity_store(struct device *dev,
> -					    struct device_attribute *attr,
> -					    const char *buf, size_t len)
> +static int set_interleave_granularity(struct cxl_region *cxlr, int val)
>   {
> -	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
> +	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
>   	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
> -	struct cxl_region *cxlr = to_cxl_region(dev);
>   	struct cxl_region_params *p = &cxlr->params;
> -	int rc, val;
> +	int rc;
>   	u16 ig;
>   
> -	rc = kstrtoint(buf, 0, &val);
> -	if (rc)
> -		return rc;
> -
>   	rc = granularity_to_eig(val, &ig);
>   	if (rc)
>   		return rc;
> @@ -577,21 +579,36 @@ static ssize_t interleave_granularity_store(struct device *dev,
>   	if (cxld->interleave_ways > 1 && val != cxld->interleave_granularity)
>   		return -EINVAL;
>   
> +	lockdep_assert_held_write(&cxl_region_rwsem);
> +	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
> +		return -EBUSY;
> +
> +	p->interleave_granularity = val;
> +	return 0;
> +}
> +
> +static ssize_t interleave_granularity_store(struct device *dev,
> +					    struct device_attribute *attr,
> +					    const char *buf, size_t len)
> +{
> +	struct cxl_region *cxlr = to_cxl_region(dev);
> +	int rc, val;
> +
> +	rc = kstrtoint(buf, 0, &val);
> +	if (rc)
> +		return rc;
> +
>   	rc = down_write_killable(&cxl_region_rwsem);
>   	if (rc)
>   		return rc;
> -	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
> -		rc = -EBUSY;
> -		goto out;
> -	}
>   
> -	p->interleave_granularity = val;
> -out:
> +	rc = set_interleave_granularity(cxlr, val);
>   	up_write(&cxl_region_rwsem);
>   	if (rc)
>   		return rc;
>   	return len;
>   }
> +
>   static DEVICE_ATTR_RW(interleave_granularity);
>   
>   static ssize_t resource_show(struct device *dev, struct device_attribute *attr,
> @@ -2666,6 +2683,14 @@ cxl_find_region_by_name(struct cxl_root_decoder *cxlrd, const char *name)
>   	return to_cxl_region(region_dev);
>   }
>   
> +static void drop_region(struct cxl_region *cxlr)
> +{
> +	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
> +	struct cxl_port *port = cxlrd_to_port(cxlrd);
> +
> +	devm_release_action(port->uport_dev, unregister_region, cxlr);
> +}
> +
>   static ssize_t delete_region_store(struct device *dev,
>   				   struct device_attribute *attr,
>   				   const char *buf, size_t len)
> @@ -3135,17 +3160,18 @@ static int match_region_by_range(struct device *dev, void *data)
>   	return rc;
>   }
>   
> -/* Establish an empty region covering the given HPA range */
> -static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
> -					   struct cxl_endpoint_decoder *cxled)
> +static void construct_region_end(void)
> +{
> +	up_write(&cxl_region_rwsem);
> +}
> +
> +static struct cxl_region *construct_region_begin(struct cxl_root_decoder *cxlrd,
> +						 struct cxl_endpoint_decoder *cxled)
>   {
>   	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
> -	struct cxl_port *port = cxlrd_to_port(cxlrd);
> -	struct range *hpa = &cxled->cxld.hpa_range;
>   	struct cxl_region_params *p;
>   	struct cxl_region *cxlr;
> -	struct resource *res;
> -	int rc;
> +	int err = 0;
>   
>   	do {
>   		cxlr = __create_region(cxlrd, cxled->mode,
> @@ -3154,8 +3180,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>   	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
>   
>   	if (IS_ERR(cxlr)) {
> -		dev_err(cxlmd->dev.parent,
> -			"%s:%s: %s failed assign region: %ld\n",
> +		dev_err(cxlmd->dev.parent,"%s:%s: %s failed assign region: %ld\n",
>   			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
>   			__func__, PTR_ERR(cxlr));
>   		return cxlr;
> @@ -3165,23 +3190,47 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>   	p = &cxlr->params;
>   	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
>   		dev_err(cxlmd->dev.parent,
> -			"%s:%s: %s autodiscovery interrupted\n",
> +			"%s:%s: %s region setup interrupted\n",
>   			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
>   			__func__);
> -		rc = -EBUSY;
> -		goto err;
> +		err = -EBUSY;
> +	}
> +
> +	if (err) {
> +		construct_region_end();
> +		drop_region(cxlr);
> +		return ERR_PTR(err);
>   	}
> +	return cxlr;
> +}
> +
> +
> +/* Establish an empty region covering the given HPA range */
> +static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
> +					   struct cxl_endpoint_decoder *cxled)
> +{
> +	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
> +	struct range *hpa = &cxled->cxld.hpa_range;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	struct resource *res;
> +	int rc;
> +
> +	cxlr = construct_region_begin(cxlrd, cxled);
> +	if (IS_ERR(cxlr))
> +		return cxlr;
>   
>   	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
>   
>   	res = kmalloc(sizeof(*res), GFP_KERNEL);
>   	if (!res) {
>   		rc = -ENOMEM;
> -		goto err;
> +		goto out;
>   	}
>   
>   	*res = DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
>   				    dev_name(&cxlr->dev));
> +
>   	rc = insert_resource(cxlrd->res, res);
>   	if (rc) {
>   		/*
> @@ -3194,6 +3243,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>   			 __func__, dev_name(&cxlr->dev));
>   	}
>   
> +	p = &cxlr->params;
>   	p->res = res;
>   	p->interleave_ways = cxled->cxld.interleave_ways;
>   	p->interleave_granularity = cxled->cxld.interleave_granularity;
> @@ -3201,24 +3251,124 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
>   
>   	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
>   	if (rc)
> -		goto err;
> +		goto out;
>   
>   	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
> -		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
> -		dev_name(&cxlr->dev), p->res, p->interleave_ways,
> -		p->interleave_granularity);
> +				   dev_name(&cxlmd->dev),
> +				   dev_name(&cxled->cxld.dev), __func__,
> +				   dev_name(&cxlr->dev), p->res,
> +				   p->interleave_ways,
> +				   p->interleave_granularity);
>   
>   	/* ...to match put_device() in cxl_add_to_region() */
>   	get_device(&cxlr->dev);
>   	up_write(&cxl_region_rwsem);
> +out:
> +	construct_region_end();
> +	if (rc) {
> +		drop_region(cxlr);
> +		return ERR_PTR(rc);
> +	}
> +	return cxlr;
> +}
> +
> +static struct cxl_region *
> +__construct_new_region(struct cxl_root_decoder *cxlrd,
> +		       struct cxl_endpoint_decoder **cxled, int ways)
> +{
> +	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
> +	struct cxl_region_params *p;
> +	resource_size_t size = 0;
> +	struct cxl_region *cxlr;
> +	int rc, i;
> +
> +	/* If interleaving is not supported, why does ways need to be at least 1? */
> +	if (ways < 1)
> +		return ERR_PTR(-EINVAL);
> +
> +	cxlr = construct_region_begin(cxlrd, cxled[0]);
> +	if (IS_ERR(cxlr))
> +		return cxlr;
> +
> +	rc = set_interleave_ways(cxlr, ways);
> +	if (rc)
> +		goto out;
> +
> +	rc = set_interleave_granularity(cxlr, cxld->interleave_granularity);
> +	if (rc)
> +		goto out;
> +
> +	down_read(&cxl_dpa_rwsem);
> +	for (i = 0; i < ways; i++) {
> +		if (!cxled[i]->dpa_res)
> +			break;
> +		size += resource_size(cxled[i]->dpa_res);
> +	}
> +	up_read(&cxl_dpa_rwsem);
> +
> +	if (i < ways)
> +		goto out;
> +
> +	rc = alloc_hpa(cxlr, size);
> +	if (rc)
> +		goto out;
> +
> +	down_read(&cxl_dpa_rwsem);
> +	for (i = 0; i < ways; i++) {
> +		rc = cxl_region_attach(cxlr, cxled[i], i);
> +		if (rc)
> +			break;
> +	}
> +	up_read(&cxl_dpa_rwsem);
> +
> +	if (rc)
> +		goto out;
> +
> +	rc = cxl_region_decode_commit(cxlr);
> +	if (rc)
> +		goto out;
>   
> +	p = &cxlr->params;
> +	p->state = CXL_CONFIG_COMMIT;
> +out:
> +	construct_region_end();
> +	if (rc) {
> +		drop_region(cxlr);
> +		return ERR_PTR(rc);
> +	}
>   	return cxlr;
> +}
>   
> -err:
> -	up_write(&cxl_region_rwsem);
> -	devm_release_action(port->uport_dev, unregister_region, cxlr);
> -	return ERR_PTR(rc);
> +/**
> + * cxl_create_region - Establish a region given an array of endpoint decoders
> + * @cxlrd: root decoder to allocate HPA
> + * @cxled: array of endpoint decoders with reserved DPA capacity
> + * @ways: size of @cxled array
> + *
> + * Returns a fully formed region in the commit state and attached to the
> + * cxl_region driver.
> + */
> +struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
> +				     struct cxl_endpoint_decoder **cxled,
> +				     int ways)
> +{
> +	struct cxl_region *cxlr;
> +
> +	mutex_lock(&cxlrd->range_lock);
> +	cxlr = __construct_new_region(cxlrd, cxled, ways);
> +	mutex_unlock(&cxlrd->range_lock);
> +
> +	if (IS_ERR(cxlr))
> +		return cxlr;
> +
> +	if (device_attach(&cxlr->dev) <= 0) {
> +		dev_err(&cxlr->dev, "failed to create region\n");
> +		drop_region(cxlr);
> +		return ERR_PTR(-ENODEV);
> +	}
> +	return cxlr;
>   }
> +EXPORT_SYMBOL_NS_GPL(cxl_create_region, CXL);
>   
>   int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
>   {
> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
> index caf1cd86421c..fc963c2c2dc4 100644
> --- a/include/linux/cxlmem.h
> +++ b/include/linux/cxlmem.h
> @@ -875,4 +875,8 @@ struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
>   					     resource_size_t min,
>   					     resource_size_t max);
>   int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
> +struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
> +				     struct cxl_endpoint_decoder **cxled,
> +				     int ways);
> +
>   #endif /* __CXL_MEM_H__ */
> diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
> index 6499d709f54d..0e7f17c0c920 100644
> --- a/tools/testing/cxl/type2/pci_type2.c
> +++ b/tools/testing/cxl/type2/pci_type2.c
> @@ -4,8 +4,10 @@
>   #include <linux/cxlpci.h>
>   #include <linux/cxlmem.h>
>   
> +struct cxl_region_params *region_params;
>   struct cxl_endpoint_decoder *cxled;
>   struct cxl_root_decoder *cxlrd;
> +struct cxl_region *efx_region;
>   struct cxl_dev_state *cxlds;
>   struct cxl_memdev *cxlmd;
>   struct cxl_port *endpoint;
> @@ -109,6 +111,22 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
>   		goto out;
>   	}
>   
> +	pci_info(pci_dev, "cxl create_region...");
> +	efx_region = cxl_create_region(cxlrd, &cxled, 1);
> +	if (!efx_region) {
> +		rc = PTR_ERR(cxled);
> +		goto out_dpa;
> +	}
> +
> +	region_params = &efx_region->params;
> +	pci_info(pci_dev, "CXL region: start=%llx, end=%llx\n", region_params->res->start,
> +			  region_params->res->end);
> +
> +	cxl_release_endpoint(cxlmd, endpoint);
> +	return 0;
> +
> +out_dpa:
> +	cxl_dpa_free(cxled);
>   out:
>   	cxl_release_endpoint(cxlmd, endpoint);
>   

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 551CF16E879
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 10:07:56 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718186879; cv=none; b=TP2clOAdf/IAjo3jTL9QNubWjwGAQm3/58yjKl5PhICmFOfDSj75GUul0o15uu6kQrX9I0SNvKnJLLgO5DOJUolSaEWCNKL9djIYw8SL4Qhz6ogaKdSPqWKGNOOzeQEy/XicrTRaWBv9bCOM346c1jr5Ozignob/JYvDMFJcJuw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718186879; c=relaxed/simple;
	bh=GvC/K7JVuybvDldmsQgxCWCoVtMR1UW6ILi18RGweV8=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=iMCTqCJxnQb2MxIz54iLd+BxEMbXwxOWBR8u3QveWsmI0g6Fz3jggZyvgwy0luVKn6BTxoSGWngjAl82An4Q5VJQpELX1GcM6Y9nfa6rm6YAtzHsWnLTH4hKN7m3qE+0K968ZZ+gqkl1j42FNrIdeX+8/KfSQQCZya/Kph5hijc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.31])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Vzh5h2Hzvz6K8wD;
	Wed, 12 Jun 2024 18:06:32 +0800 (CST)
Received: from lhrpeml500005.china.huawei.com (unknown [7.191.163.240])
	by mail.maildlp.com (Postfix) with ESMTPS id 7C01E140A87;
	Wed, 12 Jun 2024 18:07:53 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 12 Jun
 2024 11:07:53 +0100
Date: Wed, 12 Jun 2024 11:07:52 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Alejandro Lucero Palau <alucerop@amd.com>
CC: Christoph Hellwig <hch@infradead.org>, Dan Williams
	<dan.j.williams@intel.com>, <linux-cxl@vger.kernel.org>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute
 references
Message-ID: <20240612110752.00007442@Huawei.com>
In-Reply-To: <4dadbadf-529d-6f50-b30e-8a428d8c6a19@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
	<20240516081202.27023-2-alucerop@amd.com>
	<666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
	<ZmkkaOTUFuzIr2cG@infradead.org>
	<4dadbadf-529d-6f50-b30e-8a428d8c6a19@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="ISO-8859-1"
Content-Transfer-Encoding: quoted-printable
X-ClientProxiedBy: lhrpeml100002.china.huawei.com (7.191.160.241) To
 lhrpeml500005.china.huawei.com (7.191.163.240)

On Wed, 12 Jun 2024 06:54:13 +0100
Alejandro Lucero Palau <alucerop@amd.com> wrote:

> On 6/12/24 05:30, Christoph Hellwig wrote:
> > On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote: =20
> >> alucerop@ wrote: =20
> >>> From: Alejandro Lucero <alucerop@amd.com>
> >>>
> >>> CXL Type 2 devices imply specific vendor drivers binding to those
> >>> devices instead of generic ones offered by CXL core like the PCI driv=
er. =20
> > No, it absolutelt does not.  There is no such thing as a vendor driver
> > in Linux. =20
>=20
>=20
> Well, yes, I see your point, and it is absolutely correct.
>=20
> It was a bad way of explaining the need of a driver supporting a=20
> specific hardware.
>=20
>=20
> >> So I don't like this approach, there are details that are private to t=
he
> >> CXL generic memory-expander use case, and some that are suitable for
> >> CXL.mem and CXL.cache capabilities in other drivers. That distinct
> >> subset should move to include/linux/. I.e. I want to see the increment=
al
> >> conversion of what 3rd party drivers need compared to the generic
> >> expander case, and consider when and where new shared infrastructure
> >> needs to be refactored. =20
> > And I'd much rather keep all these drivers in drivers/cxl/ anyway so
> > that we can keep a tight control over them.
> > =20
>=20
> My initial thought was drivers for ethernet, gpus, or any other kind of=20
> standard device binding to the CXL/PCIe.io and doing the CXL=20
> initialization. Your comment seems to suggest other approach, which I=20
> can only relate to using auxbus for the device CXL.mem and CXL.cache,=20
> and=A0 then being handled by a generic driver inside the CXL core. Is thi=
s=20
> what you are suggesting?
>=20
> If so, I'm not against it, although it would require to study the=20
> implications.

I'd be very careful with that level of complexity.
So far I'm not seeing it as useful for this case (but I could be wrong)

Maybe just a case of well defined library code with only
opaque state etc being exposed by the CXL driver framework.

The bulk of any type2 driver needs to be in the appropriate subsystem
not drivers/cxl/  The non CXL parts will be more important to keep
aligned with appropriate subsystem than the CXL part.=20

Jonathan

>=20
>=20


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (mail-mw2nam04on2069.outbound.protection.outlook.com [40.107.101.69])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6888717B408
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 13:36:59 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.101.69
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718199421; cv=fail; b=tcVg69f848wY1ZUtU1tL7/kL8tslv2Qo1S4uCzJ2ukDIKhdIpwmSiKDAEy1Bi1Lt+HruRXHW5LPOyPoJRFZut8PXqvxrtHZ+ChA2ss5j6RG9jDKhuJscNfueRJkiuPOkNZYpxUgANOq+E7T7V1vWsAVupSAyuFLDlB0hFKtDZ00=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718199421; c=relaxed/simple;
	bh=7c0VWmCyMpblp7Gmor04bUTwyYDfIHhgwnL/j0Pi1E8=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=GWiU51M5t3SM29501rLyNEy6mngyY60+AgVBdVEwSTgrxM3ceK4ru7KLR58gJONaKxQqbKbrRaFdMQRBMDM1bfda/MeTJxrd7D4qN7K/GOgNJAgIw/rzq7DvbMBXjKTiSrSHtyYpFXxS3AnwgUieByUuqI/5v5I797jbYBc3K50=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=p2hnXrWP; arc=fail smtp.client-ip=40.107.101.69
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="p2hnXrWP"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=RT++XtCZA9tCCa3wjW6DzftubjSspsSbwOsF4BqQC6+lQz2ZInF05iAjhy+qAj0EpnsH2BCHZIfdA100DYiH4ApaBBjxr2g2Jl4rFZ+bqn8Pajt+kH1LnVC0bzwkCTOoYLpA6FLOd8tlrMR5cAOIbeSLBmB7sv/ED3m45xlNusfhr28C8KyVB17aCYv5habDC3HaTkUK8lATHE7qTYAirzieG1JpRGf4enQKpzTml8Fp8JDRtM9sO8w/YSwcyc+1s/5OxQ8zgybANXvMcwY8yj8YKkLTOBWLjC1LxFz/EtOsDCosKQroyNHTlC7d7qApybd73n17q+i266TR41vGJA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=qDUq/0puwZSfDvEkI4P4LxDmAjs9Irw/sfdcDvpgUTY=;
 b=JiPHwgZf2ZSaLubER9LrAc2xyYTGegtkqNnJXPvpxZT216l1pW4vexQPa8Oxt8LliFyWzJXF66B4Rwo5yolTAY5BHk4j1NXe+OUrH0HdP34/ARS0BUFBjiGk+oA0oDrm6C6OXneQilaADDeNeAT20IXsRu3fpl4Dww/OHQqbgUw8I3sxfuVDAWoD131eQj8BSuO3BzqiQcT1rK0nqjVv5vc/6fv5eHPfJGX1Kv00GKpfy1SXJ6Nqmc1E/fl3IgCp+QXM3KnARt2ZZBU7XTBtYdPCVntMI90QG0LRL4FiyfxYZDDOIvvEEg65E/kdYwsPPFb3utp/AfktZj6yN/r0YA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=qDUq/0puwZSfDvEkI4P4LxDmAjs9Irw/sfdcDvpgUTY=;
 b=p2hnXrWPnKnWlhbs8NwMSIuS2qSVV7fB9yVXmGAkSlOgoLMGXPlvWMJF1uvfSQZKm5TrD4Q5jTZ/1v147zkAceJch1F+WnnV3YGzPW1AyyzTbM52bEl6E8elhkjMVu8booPmiCL/vqM/e5IGEyOrevWNB3iscUN4eh341mZOUSY=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by SJ2PR12MB9238.namprd12.prod.outlook.com (2603:10b6:a03:55d::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 13:36:57 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 13:36:56 +0000
Message-ID: <d2cb84c9-384b-9afb-db8f-8b9db18fd291@amd.com>
Date: Wed, 12 Jun 2024 14:36:46 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: Christoph Hellwig <hch@infradead.org>,
 Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
 <4dadbadf-529d-6f50-b30e-8a428d8c6a19@amd.com>
 <20240612110752.00007442@Huawei.com>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <20240612110752.00007442@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LNXP123CA0020.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:d2::32) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|SJ2PR12MB9238:EE_
X-MS-Office365-Filtering-Correlation-Id: 47f998d9-1a38-4d8e-6fd9-08dc8ae4ba5a
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|1800799016|366008|376006;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?cDlFQzM4MGJIM1VjeTVRQUZLdlVYbG1TR3h2RVdpRHRVWkZhZEJaTlJwMDR1?=
 =?utf-8?B?RGtIMTg0YmYxWHM2d0tLazY1eGhYdmhETlA0TWJ5TGFXeTBjUFVoQk9PNjlM?=
 =?utf-8?B?ZTJNQUdrZlZ0WVlVU3FGazRyVSsvM1MzT0hOOFhxMU5YckY0UmJqbE9OdUo4?=
 =?utf-8?B?a2FJWllydGxscm5pcGtOZEhUYkVXTEFqN0ZZcEUwd00xUFQxMFZSV1ZwR01W?=
 =?utf-8?B?WFNRUEprbCtaTlV1MDVyRE01a1ZWZVgzYytuRWVwL09id0VxRVRMelFIN205?=
 =?utf-8?B?TFlVYksvaFRtcHVqV3MxczlVa0xETFRPelZCdURTQndFbTVNcmluWkRBenl6?=
 =?utf-8?B?d3cyRjdtRHBmMTd4dGlUK0NrRXFseStOUE9pZ1UrS0RiZmh2USs0b01CdmVq?=
 =?utf-8?B?UTQrdjJoN085RHR5SCsrOUluRElIb2JPbldoMlBmN0xMekJxb0pjK3NHN3VQ?=
 =?utf-8?B?Zkp6aXg2S0ZzZmN5bWp4TG9qOEtwbVJNMmp3a3ZXWUsvYXJ2V2d2VjJjWlJs?=
 =?utf-8?B?YmxTVXVwdFZuc040RW9xc2Z0YXF4cjRBcndxQzM1QTFNVzJQcWxjQ0tnbWFI?=
 =?utf-8?B?QnM0TnpGM2hRSG1jZFNScE9QaGl6V0cwZTFnV1J2VzJ4cERCb3B2S2VvUDFR?=
 =?utf-8?B?bFJvWllqbVBWV2g0aHR2Y2R0WHRuSTlTdnpCdzhodTBkRzBzTTBrcWhpYk1n?=
 =?utf-8?B?aUNFcnFEbG40bkdCSkFCTmVqM1B3clBxU0M1aUVYZC92MFJaazh3cVVDRC9H?=
 =?utf-8?B?S1lKamJJeEx0ODQ0eDNDSk9XRkI4UlI2ZmJFMFRWUk9qVkFvdkgzOGFzVCtD?=
 =?utf-8?B?SElNOGdTQ0lyN2pnNDE5cU5XWWVwUUFDais5OGF6dC9sZzNZZTlXRmphVUZL?=
 =?utf-8?B?VU9GL2NHZjM4SDdDNmp6MnZEb0MralNyMTIxWlJnTllLVW9tWkExL2RpMmcz?=
 =?utf-8?B?RzRkMXJTdGxOS3U1UC9Hc0t4ekpBcmsxMUMxWUEydEtzYmlyK1pteWZzMGJZ?=
 =?utf-8?B?Wms0M3VQK3Q2MjlzbVJPRTl6cmx3MDYwc3FrOGJMYi9VSDJCSlQ0YWQ5bVFT?=
 =?utf-8?B?dzFkOHI2Nk9TT3JnRC9MRDFpc0FtcElXWnZFTERsNnlvVHZUQ0dVODloN3hP?=
 =?utf-8?B?cCtWT2hiTmhDa2xWdjBpSVFpTGpPa3V5MERDZFFVMG5WUGIrL3l0SFZuTitG?=
 =?utf-8?B?ZzR4ZmZpMmwrVktDd3A5TVpvNnlxRk9pM2tCelhjTTM0d1I3dGNBOU9IVG5H?=
 =?utf-8?B?a0swRXVSZkd5UWNtMFdOY3F1TG9ZWHJrR05Xd2RvWDhsMEMxTUJPRy9EUGN0?=
 =?utf-8?B?SC84ZkpaSm8xZ2ZmVkVOTGdXYStUL1RGbHo3eVQzb2ZIY2NpNnQ0Tm1Nc0VK?=
 =?utf-8?B?cXkyYmRUMUZvWFhCRlRLRnZQMitnU0wzRHF1T0xJUzFoRTZQNXVzbGY0TmU0?=
 =?utf-8?B?Yi9Gdy9JZXpZVFJyL201WFJGZW43aU1ib2lab3VOUk96dnpuYWYwaXFCbi9h?=
 =?utf-8?B?V3YwRWlxbHpJaVlnOEZvVjVWUUVHMFZlMGxZQTBzYlh4dDVDdmM1cU5CUWR1?=
 =?utf-8?B?bkJBMmhOdmFpeXZoenpzb1hEaGlEcWROaHJORjA4Z1o0U042WTZIVHc5Rmlk?=
 =?utf-8?B?em0rTzF5ZWdvZGhNSk1VVTAyNmxMa2ZqT0xqczV4blpIVkxBUEtwVy9iMTF6?=
 =?utf-8?B?d3lyVFhtbndlQnRvV0JrYTB2ZXpUNGVjeFJZZk9RZUFHMGxHZksyMnh5U0wy?=
 =?utf-8?Q?CZtLTpJ+eSsEX09mMo7j4QSQ15/PdLf93GmoK5H?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(1800799016)(366008)(376006);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?ZW0yalhxSjErRDB6dG5LRHU3Zm1WZ2d4bnNRNTFMbzM1WjBJc3g1aVFuTjZV?=
 =?utf-8?B?ZXREV2JaekU2eTZlU3RuWEJuZElJZ1p3TENxOEd2ZW1aWTRVcFZqWEJ6c2Iy?=
 =?utf-8?B?eCtoYzd2Vk1zYmJOcjhXb0prQWtMUlFZWHdWaWlZbDNrK05mWlJTbWNVb04v?=
 =?utf-8?B?VUtqMUhUdkYyL01aWVNycSs4TUxvL1RVN1FLdmcrSzRhNmF2SWZIRGp5V1I1?=
 =?utf-8?B?TnpYdmpBTTBxY053cDVHS1JBYUZPQ2FoRU05SDEvOHJYU1dqL2FDaytwYUJw?=
 =?utf-8?B?R0RhbHZZTUR6UnFtcXFlSFVBbFl1d1haQmJuQzdWM2o1RFJBVE9rTVpVNUVE?=
 =?utf-8?B?SzVFVnlMRVN2WFZ1TEY0eW9yTFNIdTMyWE5VY0RrWW41NjMvb1RtMFNMby9h?=
 =?utf-8?B?SllJR0ltdndNa0pOc2s1UEtQOEszL2dwV29hK3RUNG1oa2RoaFlCb0QzWjBp?=
 =?utf-8?B?L3RjTnMxL1ZNdnNsY3E0MUdRWDU4QW9nek5oRmNkV1VTMmNYa2xteVlma3N2?=
 =?utf-8?B?cHN0TW9pbVVxVEpNazVBMDdBRm01eHpJM1NxZncrTit6N1MzckQ1Z3NsZzkx?=
 =?utf-8?B?T1lPZmYzNW1uV1ZrM1UxNXEvcDBBemNzRDh3NW40RG9idlc0RE9Pd2NrVEtJ?=
 =?utf-8?B?WUN2RUt5RlhMRkdLT2tWbVgvcldoSkdIZ2RtR0x0TFo1clN1eFp0a0FYdE1w?=
 =?utf-8?B?MnlXK1E4cVVxcmkvbkI5a3Z2ZTV0VEFiYVdzN0hvbnlQaDhPbjJiejBIa3RC?=
 =?utf-8?B?U2Y4OWVBWEgvVGdMNjhMK2tRUnpDNmNoYkZxa2VFcFhDbk5ueUtpbXJTMkJk?=
 =?utf-8?B?MHRocDFxekJUeTRIbGdGQk90TDNqL1piMnlZYUVmVjllVmx5MFFSL2hqTnFC?=
 =?utf-8?B?WkJPL3dGeVRnRVBrVFAyc3JVSFNYOVNxVVFFcnRnbFNQaXh3RHVKTnEwL3lP?=
 =?utf-8?B?UitYb0t2Kzdaai9uWFNaeXBwTmVxUGxGeDBPemRBaUFsN2wrc1g4SGE1MEVu?=
 =?utf-8?B?SEZTV0JxUEMxbE85V2tXRDVJR1hTTkVnQXFlZWhwYU9uN1dwOFZDMFovUTVk?=
 =?utf-8?B?YXJoUy9CN002WnpaUmNSUVZUYkI0RkViS09Ya0wvZlppZ3VnRll4UEg1aWlk?=
 =?utf-8?B?YzlXeTJud3Y3MjhEUkFqSFJVUmVXc3BXeGJ1ZXowejNwdkN0QUh6OFFlTnpJ?=
 =?utf-8?B?Y2NGZzFRZTUyZkJQWVZtZU5taEhRbGhzbUlTa2JSTzZtQUxLUThXb1NRMlEv?=
 =?utf-8?B?L3V2dVc1OGlHd2cyWUZHRG1UelZ3TGtzNi9GV3c5OTlqclVKdmlnOHIxVmR0?=
 =?utf-8?B?VzNLZWQ2RXlwOUY0Zm1ianFTYnh1ZGx0SjNBbVI3L1ZPdmwwZVVOd2R3cGlz?=
 =?utf-8?B?V1RINE5SOGw0Rnk0Q3JyU3BlUHVWTmpNOWtnQUxtbmNUYW4zVnhBbmFDeG9Z?=
 =?utf-8?B?TUJLcUl0K0FWVVlNa3RvUjNVV1V4SnMwUkVraVFQUitXZ3NYb0VWcGNpNEJr?=
 =?utf-8?B?bUlsaG5TUHoyNkJPMVVNbURldmE4L3RKMkIxYXJGcU1JT3lUY3cyckxJRitx?=
 =?utf-8?B?NjE1OHRPbVZxV3Z2cTBuMXRBdytvL292Yk1sUUhCd29CaksvakVtZkwxUU96?=
 =?utf-8?B?Z25hRktZcGlleHJXaDdWaldGWXkxSE1pNTlTclZEaE1wQ2krLzc4WnhoZW5M?=
 =?utf-8?B?ZElzZFNIZEtZWUs2WUJMdm5ncTNsQXc4QVQ5U2FXaEFnYmhKSmJxZFhyY3Bo?=
 =?utf-8?B?RWRKZGdGako2N3NoTGZmSHNRZnFnSkVicm5OcW1lMHVxaytuQzBMOWJaTXUw?=
 =?utf-8?B?UkMxTWN3SXJVbTdIQXgwWmZSTFFYd1NpY3I4Y05WcVFQZGZMWHRidDlDajUy?=
 =?utf-8?B?SEdFMW01cmxBZVVhYXAzREN1ZThyT04rdnNacVpQQ3lxMkpYeXhvWGFCNGRI?=
 =?utf-8?B?RTkrbTc2bnBCMFMxQzRXQWxHdndrKzVKdE9Nb05WaHpvK2x1K0ZjSkMvSjIr?=
 =?utf-8?B?WjZVZi9tU1NiZ1ZCcW1xMEdhRU1Bd2kwVXpSUXFxanNvemQybXV4Z0kzQURL?=
 =?utf-8?B?dDZVQWhHSHBESnZRdEI2MkFEdnVDVzNmT1NFeGhRY0I3R09ObGZNbXo3MjNX?=
 =?utf-8?Q?IkJX6rudPqSYAJdZublVFnJ0R?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 47f998d9-1a38-4d8e-6fd9-08dc8ae4ba5a
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 13:36:56.6543
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: IkqwIBj+dq6lZeqfeig3ne+YoJmHQQ6WrKr4mhoNFzNQzU+EyE7+ehCaeP0lscw4S2tktQczHIztNcwJmw7lfA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ2PR12MB9238


On 6/12/24 11:07, Jonathan Cameron wrote:
> On Wed, 12 Jun 2024 06:54:13 +0100
> Alejandro Lucero Palau <alucerop@amd.com> wrote:
>
>> On 6/12/24 05:30, Christoph Hellwig wrote:
>>> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
>>>> alucerop@ wrote:
>>>>> From: Alejandro Lucero <alucerop@amd.com>
>>>>>
>>>>> CXL Type 2 devices imply specific vendor drivers binding to those
>>>>> devices instead of generic ones offered by CXL core like the PCI driver.
>>> No, it absolutelt does not.  There is no such thing as a vendor driver
>>> in Linux.
>>
>> Well, yes, I see your point, and it is absolutely correct.
>>
>> It was a bad way of explaining the need of a driver supporting a
>> specific hardware.
>>
>>
>>>> So I don't like this approach, there are details that are private to the
>>>> CXL generic memory-expander use case, and some that are suitable for
>>>> CXL.mem and CXL.cache capabilities in other drivers. That distinct
>>>> subset should move to include/linux/. I.e. I want to see the incremental
>>>> conversion of what 3rd party drivers need compared to the generic
>>>> expander case, and consider when and where new shared infrastructure
>>>> needs to be refactored.
>>> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
>>> that we can keep a tight control over them.
>>>   
>> My initial thought was drivers for ethernet, gpus, or any other kind of
>> standard device binding to the CXL/PCIe.io and doing the CXL
>> initialization. Your comment seems to suggest other approach, which I
>> can only relate to using auxbus for the device CXL.mem and CXL.cache,
>> andÂ  then being handled by a generic driver inside the CXL core. Is this
>> what you are suggesting?
>>
>> If so, I'm not against it, although it would require to study the
>> implications.
> I'd be very careful with that level of complexity.
> So far I'm not seeing it as useful for this case (but I could be wrong)


I agree the complexity could not be justified.

Indeed I think the privacy of a CXL.mem, something I pointed out, will 
make things more complicated.


> Maybe just a case of well defined library code with only
> opaque state etc being exposed by the CXL driver framework.


+1


> The bulk of any type2 driver needs to be in the appropriate subsystem
> not drivers/cxl/  The non CXL parts will be more important to keep
> aligned with appropriate subsystem than the CXL part.


+1


> Jonathan
>
>>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2068.outbound.protection.outlook.com [40.107.93.68])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6AD9617DE25
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 14:17:15 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.93.68
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718201837; cv=fail; b=PUAZ+K8mUBAo5e2b5p9Q0l3yE2VuHjLg/SzdJf5WAuo7httJQixcy+Mdpo5T13JmvQ0BEoxn/xl55LEnETfmFx+3Fx+ec0dFl+0URgd4vAyiT7l6fFe/OBAgN066VUlh2O01KWQQ0FchoscXfcDfUt4BcIM0BaZVs8OMvT+UT5E=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718201837; c=relaxed/simple;
	bh=Pn8F0giGn6dZDWeMOQF2YHuEoYyAg1ITAMv5JzKifes=;
	h=Message-ID:Date:Subject:From:To:References:In-Reply-To:
	 Content-Type:MIME-Version; b=O3DZ3w8J5AY58NNbCfG8iDEYZxLR6baXXvouQj/B1zcRN7jY0rYTzupnolquHW/Nz1uTkNS8NvPqa4lOqUeOn8vfGjQDLn5cPOvgC97a+oe+XEzvYPH+Tbeyn7LNf74mcLShGTiVjjdbA++eXDZ7bhlFGUL48l24khuOJoo+zv4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=l+JIXq9j; arc=fail smtp.client-ip=40.107.93.68
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="l+JIXq9j"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=T0DOObTCiflk+mc3JNBbUDaibvg6MUNUqobyjZELmKE6qBO77NDT1kAF36q6z6FE6XnkXE1ggXOVmXue+j694sRK8Yt2YFUMrgZXPq9cDuduudvYIBl+HrjVA/7h50BTAxRAAvUKOHGOUJb42YVZYPybcXFVGRnBNDCEX66aUCNeXHNodaZ7WOClXcH3Qyo3dusTUfyTimhPOnarn/2Uxg96wIX71zw8U5Gjn0ZVo8TCgt/V68rxfCd9pSe4oBJZS5vx+C44gHSjnC7RScy9mSxjn1AcPrFPgweUOAgVtcd5UN9Zactx+nLDa1fpopf9lmFsvTFwLwKbYOPhpFN6XQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xOxolCbZSuGlV9+eaQXVecC0UJ9TXzDwrC/cI9tfr2g=;
 b=gDFBTfuMMzdhIY4VYOvxD9E9/YGw+PyCR7R0DOSxwUSCnKEI3Kf39VdCZKCJapgMFZqU63i1YP9tLPa53WUfkT9/AmXjSFfGFTKDi6BDflaf+06HMdFCNjJhFjajlV3dopbZMrZa1+ZY4HzHJ5lyUSAQlhzz8ArrZE+7t9xHvUNqfErviswO4Gdmj/Mt7b5cfXDwKHImPCCWmnO3Xnr1TXcI+XWKRgqm00a4xocPk7F9nMSExv2IBrEET6t9DcMt3tgtca/hzxVXJZYIn2ugHjNFN34/O43i9Io8xJSJH5DgYGRtX+6erju8OqVXoBavhzMfKtEhsqA6sjHdib4t9A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=xOxolCbZSuGlV9+eaQXVecC0UJ9TXzDwrC/cI9tfr2g=;
 b=l+JIXq9j+D0LoEkhkkjC3xrfIrOG/XGzyoAf6UDUlPTlaEDp0W8LAHSyNipqflphxx+KvXFPOqL0AGLT6uK51KE8YbvD/3vUykgnP9QNa22sLbzPf7DRdeRNNIvvhTy/K/n9HDS+hLjJupfXMHgOPxOGmW5mYNgDoXZgdeASTbw=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB6665.namprd12.prod.outlook.com (2603:10b6:510:1a7::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 14:17:09 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7633.036; Wed, 12 Jun 2024
 14:17:09 +0000
Message-ID: <6b062c90-e220-5e1f-1ef6-f1bbcdc8fb6e@amd.com>
Date: Wed, 12 Jun 2024 15:17:04 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Content-Language: en-US
From: Alejandro Lucero Palau <alucerop@amd.com>
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org,
 pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
 dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
 <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
 <b48e9bf1-ccf2-2ac9-3389-4175ae872983@amd.com>
In-Reply-To: <b48e9bf1-ccf2-2ac9-3389-4175ae872983@amd.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
X-ClientProxiedBy: LO4P123CA0170.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:18a::13) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB6665:EE_
X-MS-Office365-Filtering-Correlation-Id: 6c6b08bd-cb76-46ff-b58b-08dc8aea5828
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230032|376006|366008|1800799016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?UmZsellHK0czMS84YTA3WjJ1ZXB0R1ZXZnRnMUNoS21mVEJ1Tm9MbitwamhE?=
 =?utf-8?B?RE1tUnRmU2ppdnNUYjV1eWNCSCtiNW55NWhSNlZTRTc1S1I2U0RmaDl3VFhq?=
 =?utf-8?B?QzhYM2w1OG9Mbk9pNXpUN3YxbU1JaGVINFpNRlJSOEI4cnNybzJCUUxFSnFo?=
 =?utf-8?B?eEFGeFlCS1dDbGVYdHMrc0ZYMmxpbU9ObURKcUZrYVdreEVMN255MkZUL1JQ?=
 =?utf-8?B?K2VHQ01tT0ZDREs5RUVCdWFyT1ZpaFRndlowdG9aaVlyQ0xHV3QyL1NXdGpi?=
 =?utf-8?B?dzlGZnN0SGpLdEpXd3lMOGFIMW55OUhma3o1SEpQSGpubUx2MFRxckFNWXZj?=
 =?utf-8?B?QUZLeU41dnZVL05iamVYU0dHbjVkVm5FSVErS2lZVTBLNXI2cFViR1pvUDZj?=
 =?utf-8?B?cklYSXY3dnBld1NBQmJVWFhrY0hOOEE1WFZPUW9xajYrR2ZVRlIwQk53RGpR?=
 =?utf-8?B?ZWNBYXJheklqbjZBWnl6YjZiV1V3cFkzcGdYSlZlNTJqZ1JlWlZ2L1M4Sk9i?=
 =?utf-8?B?WGJxNmpkNjRQendPM2dKK1hoK3NZMUVxdWJONkczRFFCMGVGNnduSDJIUDRE?=
 =?utf-8?B?TW5jb0ZSS3dWaFZrLzd6ZEJSL293dEZSa0llbnFQS1hmRzRDbUszR3pobkcw?=
 =?utf-8?B?eUhKeHJBVm81Njk4ZE9nbkRNcllPdmJoenJ0VU9JMS81Q1BCS0ZRWUVqVStG?=
 =?utf-8?B?RU9KWjdJMkcvZ3JhYVVySEFvMDhGUXpscjNNZHJFY1Yvc1d6dGRMa0RPRDk1?=
 =?utf-8?B?bWNsN09mL1JCRmxzcEZwYzdzZjgzVkRXb1dPWWMrYUdoRWZndEtmUktnZFda?=
 =?utf-8?B?YlJDeEZZRnpjR2Q5ZVpsSGt2Z0NabWVqZFF5bW1kR1hMMXBFSkd0eWhab3JH?=
 =?utf-8?B?NzRNNGhqWWRaY3JhamZSdGxpZVUxa1REZWFtejAvSWdqWE4vUVpXdjNXTkVs?=
 =?utf-8?B?cW9pWkJ1MlpJVnpQNVpTYnZtaHh6WW1sZ3RBZjNXYUN1NGRRVDBSMm5tbHlB?=
 =?utf-8?B?c3FjZldLcXF3dUtvYUpzRUVDbXpTT2VSQ3k5ZFRsdHBnOTBNdTRQSituZFo0?=
 =?utf-8?B?NEh2emNIWVJ6VzJ4MHJmd1V0RlU4NnJaRmRZWmJXdTlLU1k0Qzl3d3VpV090?=
 =?utf-8?B?TXZNckdVNFRvU3NCZ3BKL0F6aVZlNk1YTTZpWWRTaXFIY3JDOE4wUVBjZG95?=
 =?utf-8?B?ZW9Sd0lRM1pBV0lZWmRRNHpZZ0U5SVhURlRvbldMRndwK0xoTlBOWVJlcXpG?=
 =?utf-8?B?eTNOUUVrcyt3ZXJ4QXA5bGlHMW9tY29OU2lnZC85YjZaV0c4S2RMZisyWCtL?=
 =?utf-8?B?UWlyV3djNC84VklYa2x0T0RHaGpBT0xXRHJZQ1Z1VkQ2WHVLeUNPTlpPc244?=
 =?utf-8?B?aGJWdHAwTEQ0c0tlYkluSG5yTjIzYU11VEUreDZpcy9NUXJXZU51TUF5K2pG?=
 =?utf-8?B?QVJXUWhDa2N1VS9zNzUxMG9YYnl5RUJuVkIxajBnZE95VVpTMTVCRWVpUWt5?=
 =?utf-8?B?NWRWcnVGbXhrUjNJdk5va1ZrMC9nMEM0Z3VkQWc4U3UxMDgrRDVsUklZSlZY?=
 =?utf-8?B?cVo1eE93ZUtHemdSVzZ0czloc1h6T2hNVjlPVkpkbjlHV0FRL2p3eW9Pd1Zy?=
 =?utf-8?B?WkVaTnc4cGhNY3pPLzVNc0JERnZ2Zm5lYmh1T3NMNXBWQjdLV3Z5NDBsRGVW?=
 =?utf-8?B?NUdTWUZCQ3VUOGhFR1Z3TXlJaGJBOTc0cnVuNmI1bHpWQUtIcHh1QU4xQjA2?=
 =?utf-8?Q?fYCurr2uWuKZIrz+jmr1dqgWXytiwBEIyyY1BPj?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230032)(376006)(366008)(1800799016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?dXZMZkRHQkhJTGlDdExoaGhRU3FGU1NBcmpFbEFQNjN4R21nanRpN09yS1Ny?=
 =?utf-8?B?UUlYaW1CM1Q5TmFhL0Y2K2d6MjNTc1FmU21VWnM3Q3lYTzFHOTBSYTdtMHFP?=
 =?utf-8?B?MDI5U3oxbEYvL0dmQzdiTjJXbXhmaHU5cGExVWJWeWJZWTh6QU51K0NmWjFm?=
 =?utf-8?B?TGR2YTdvSHpUbHp0Y2FVL1o2OCswc1BNV2xBUkxuMGNNYzU2MzVXaTBHL2NL?=
 =?utf-8?B?NVA0N1lqamEyK1l4VnA5dUt3Mko5MFQrWmswKzdBaU9pZ3R3Q3poRnJVL2Jo?=
 =?utf-8?B?Rk04UnVVdTBXdG94V09pb2ZIelF1akVwUnRsdi9HMGlSQU5JaE1TMTI0N1Qr?=
 =?utf-8?B?TThIazhWUTVMTmNYOWJlRWxkSGt6dzgzMWpaWGI0ZkZqbDZMNnZnOFNzZ2lo?=
 =?utf-8?B?NXlOZnlabGRtZEdTTE5oQkFFNXU0Q2N3Z1haa3dHeUpWQzZtWjZoQVNiN3Vo?=
 =?utf-8?B?dFFaVlhGWVY0NHVObThhcjdTU3JPcXNCQlJmWEcydENlZ3VqbmJ4MVFzNmlw?=
 =?utf-8?B?YUtwSElBOUxJRFhXMXcxRFNsT1EwdVVoNjhSL1JLZzg5OVZYSnoyWTJON0hS?=
 =?utf-8?B?SlF3dGx5MHR1aGM0ZlUzQ1JIM2UwbUhaaVkxUzJqN2l0ZkhvQjk3MnJMeWFE?=
 =?utf-8?B?YVRDS3RiT0tOSE5pdVlGd2x5dHNsY1FZT2lqd1c4eVhsNk5QQzN5Yms0d2xr?=
 =?utf-8?B?Mkw2N29IaWEzK1o4cUlBSk5GaVBpK3BWQXNzcEE2WHlsUHJxck5SZ1E0MWFB?=
 =?utf-8?B?YWNodjBRVlptMVVFYzQrQkpiMWF4Ky92RHNlNThtQmtRdTJQSWxrZENGbURx?=
 =?utf-8?B?cEZUTmtiU3dNRDhrNnJFR0pFUFJvUmVxWThkMFIxU09XYlRlQ2pwQVkvbERa?=
 =?utf-8?B?b2JXc3pidmt4djNUNkJFNEFldit0dFFEYWE1Q1lGWmZWK1RGa3EydFRvL1hq?=
 =?utf-8?B?MFlhMDIwR2Q3dlR5UERQenRIWTRzSEdtQks1blkyUEZ5S0hPY0JXcVAvYnFk?=
 =?utf-8?B?aXI5NmNmVW5yc3dRWkk3RG85Vmk1SHBkeklBQXVKVHlkR2t0VGJXQ0V6ajVN?=
 =?utf-8?B?SzNLU1NjN1R6Qm5JOTNjcXdidThLdG1pMnNwR3loN0tFVG1mVHlnNnJKK2wy?=
 =?utf-8?B?S2t4OXlac2pUVUJsdnRDRmdmbVJtZ3BOTCtXL00xMGt0MkUyLzVDNW5aRXVD?=
 =?utf-8?B?L2NkVURWQWl0Smd0SGgxekdVS2t4bWpDbk02RUl6ekRRTnRDdkNlS29JRmRE?=
 =?utf-8?B?d1YzTEpHdjBERi9qRW1HMFdmaFRoaHFCMTkyYVR5OExjZjhZNVV3ZngvUjda?=
 =?utf-8?B?cWRGVzg3VmhuZjVuOVhabHVWaUlGZlcrbG9QaG5WZ1M3Mk1QRzVBZjRuUlQy?=
 =?utf-8?B?cW9HT3RpSm50d2V5WnFRc0VXd284QnFFM2kzQ0RHTG1JVUJRN2tNQmJUYzdv?=
 =?utf-8?B?T2lpMW95QUFQdjdqcXp1MGhMVHRkNkx3Z0RMV3cyZWxYYTRtZXlraXE5RCs0?=
 =?utf-8?B?TlBucTYzVnJHVzJONkRnRVpqbm9WOXB1TTBSY2txaU1BWW9zR1RmU1IyQ2po?=
 =?utf-8?B?citzMFR2RU9ueENaUWduMWlvY3VOcFFaR3JlWXZ4MUUzcUNBc0tvWXVCRFFV?=
 =?utf-8?B?di96M0FOcDhyWi9MUm9CVE9jYlZ0dUl1a0lOUld3UTg5Q3NFYUFmbnpSRE1q?=
 =?utf-8?B?VCtMN3FtR3djS1VySjZjMCtIeFAwYWhKaHcrUDV3UnUvaWtwdlhCTmcwdWF2?=
 =?utf-8?B?ZnJvZkZETk45SlBGQnUzYW9sd3o0TVVJdzcxMXNJSnBTOENtQ01XVnd2L3dM?=
 =?utf-8?B?TndFS0pyUWZjVVRabHlMcnBLOUV4aUtWcUZvR0FCYVRMd0NvcVlSYUd4U0Ix?=
 =?utf-8?B?Yml3ZGhBeXF4dXJKOTlDTmQxcWxIOEZJNmJvRjYrSG4vcVozWC8xWXMrM0VZ?=
 =?utf-8?B?cVRLUUc5NHcyWWdCUFBxT0JtN1pNOW5PNzdwS0h5em1YTmJ4WUtVZnluOUNu?=
 =?utf-8?B?d3Y1TkFtSHFqSE1uNzlXQUtGcERxcURCR2tFUHlFZ2dXbnVwSHAzN2lzK2hm?=
 =?utf-8?B?SHpFSGg4b1Jic01hWXkwaWZ1NlE3NXZQT3lsOEtJOXdYMDBTbmVSbTVGY29n?=
 =?utf-8?Q?5sk26cRCwwhMnX21VxvBF1ALv?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 6c6b08bd-cb76-46ff-b58b-08dc8aea5828
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 14:17:08.8194
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: KX3Mug9lNes7+2d/Tn+cF/9T/G5//w+cjkP+rYARdj+wpSgBi3gVSEhj3bNBXnXA/XnVJRtqmyh6QS6fUxr6SQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB6665


On 6/12/24 07:04, Alejandro Lucero Palau wrote:
>
> On 6/12/24 05:43, Dan Williams wrote:
>> alucerop@ wrote:
>>> From: Alejandro Lucero <alucerop@amd.com>
>>>
>>> Differientiating Type3, aka memory expanders, from Type2, aka device
>> s/Differientiating/Differentiating/
>>
>> ...actually to make this imperative tense don't use gerund phrases, so:
>>
>> s/Differentiating/Differentiate/
>>
>> This "imperative tense" preference is borrowed from the x86 tip tree
>> patch recommendations [1], which reminds me that CXL should create a
>> document like that to make the grammar expectations known.
>
>
> OK.
>
>
>> [1]: https://www.kernel.org/doc/html/latest/process/maintainer-tip.html
>>
>>> accelerators, with a new function for initializing cxl_dev_state.
>>>
>>> Adding a type2 driver for a CXL emulated device inside CXL kernel
>> s/Adding/Add/
>>
>> I will also note that ChatGPT does a decent job at converting patch
>> changelogs to imperative tense.
>
>
> OK.
>
>
>>> testing infrastructure as a client for the functionality added.
>>>
>>> Signed-off-by: Alejandro Lucero <alucerop@amd.com>
>>> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
>> It would really help me out if the changelog mentions what you adopted
>> and what you modified. With a Link: to the patch where the code
>> originated.
>
>
> The patchset is mentioned/referenced in the cover letter.
>
> I will add individual references as well for any patch needing it.
>
>
>> I will still review the parts I wrote previously to see if I still agree
>> with them, but its taxing to come back to this patch cold and think "did
>> I write this routine, or is this new?". Can you repost with the
>> changelog commentary fixed up to reflect that?
>
>
> I'll do.
>
>
>>> ---
>>> Â  drivers/cxl/core/memdev.cÂ Â Â Â Â Â Â Â Â Â  | 15 ++++++
>>> Â  include/linux/cxlmem.hÂ Â Â Â Â Â Â Â Â Â Â Â Â  |Â  2 +
>>> Â  tools/testing/cxl/KbuildÂ Â Â Â Â Â Â Â Â Â Â  |Â  1 +
>>> Â  tools/testing/cxl/type2/KbuildÂ Â Â Â Â  |Â  7 +++
>>> Â  tools/testing/cxl/type2/pci_type2.c | 80 
>>> +++++++++++++++++++++++++++++
>>> Â  5 files changed, 105 insertions(+)
>>> Â  create mode 100644 tools/testing/cxl/type2/Kbuild
>>> Â  create mode 100644 tools/testing/cxl/type2/pci_type2.c
>>>
>>> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
>>> index 07cd0b8b026f..0336b3f14f4a 100644
>>> --- a/drivers/cxl/core/memdev.c
>>> +++ b/drivers/cxl/core/memdev.c
>>> @@ -659,6 +659,21 @@ static void detach_memdev(struct work_struct 
>>> *work)
>>> Â  Â  static struct lock_class_key cxl_memdev_key;
>>> Â  +struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
>>> +{
>>> +Â Â Â  struct cxl_dev_state *cxlds;
>>> +
>>> +Â Â Â  cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
>>> +Â Â Â  if (!cxlds)
>>> +Â Â Â Â Â Â Â  return ERR_PTR(-ENOMEM);
>>> +
>>> +Â Â Â  cxlds->dev = dev;
>>> +Â Â Â  cxlds->type = CXL_DEVTYPE_DEVMEM;
>>> +
>>> +Â Â Â  return cxlds;
>>> +}
>>> +EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
>>> +
>>> Â  static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state 
>>> *cxlds,
>>> Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const struct file_operations *fops)
>>> Â  {
>>> diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
>>> index 0d26a45a4af2..e8d12b543db1 100644
>>> --- a/include/linux/cxlmem.h
>>> +++ b/include/linux/cxlmem.h
>>> @@ -859,4 +859,6 @@ struct cxl_hdm {
>>> Â  struct seq_file;
>>> Â  struct dentry *cxl_debugfs_create_dir(const char *dir);
>>> Â  void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state 
>>> *cxlds);
>>> +
>>> +struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
>>> Â  #endif /* __CXL_MEM_H__ */
>>> diff --git a/tools/testing/cxl/Kbuild b/tools/testing/cxl/Kbuild
>>> index 030b388800f0..a285719c4db6 100644
>>> --- a/tools/testing/cxl/Kbuild
>>> +++ b/tools/testing/cxl/Kbuild
>>> @@ -69,3 +69,4 @@ cxl_core-y += cxl_core_exports.o
>>> Â  KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes 
>>> -Wmissing-declarations, $(KBUILD_CFLAGS))
>>> Â  Â  obj-m += test/
>>> +obj-m += type2/
>>> diff --git a/tools/testing/cxl/type2/Kbuild 
>>> b/tools/testing/cxl/type2/Kbuild
>>> new file mode 100644
>>> index 000000000000..a96ad4d64924
>>> --- /dev/null
>>> +++ b/tools/testing/cxl/type2/Kbuild
>>> @@ -0,0 +1,7 @@
>>> +# SPDX-License-Identifier: GPL-2.0
>>> +
>>> +obj-m += pci_type2.o
>>> +
>>> +cxl_pci_type2-y := cxl_pci_type2.o
>>> +
>>> +KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes 
>>> -Wmissing-declarations, $(KBUILD_CFLAGS))
>>> diff --git a/tools/testing/cxl/type2/pci_type2.c 
>>> b/tools/testing/cxl/type2/pci_type2.c
>>> new file mode 100644
>>> index 000000000000..863ce7dc28ef
>>> --- /dev/null
>>> +++ b/tools/testing/cxl/type2/pci_type2.c
>>> @@ -0,0 +1,80 @@
>>> +#include <linux/module.h>
>>> +#include <linux/pci.h>
>>> +#include <linux/cxl.h>
>>> +#include <linux/cxlpci.h>
>>> +#include <linux/cxlmem.h>
>>> +
>>> +struct cxl_dev_state *cxlds;
>>> +
>>> +#define CXL_TYPE2_MEM_SIZEÂ Â  (1024*1024*256)
>>> +
>>> +static int type2_pci_probe(struct pci_dev *pci_dev,
>>> +Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const struct pci_device_id *entry)
>> So to date, tools/testing/cxl/ has been for cxl_test which skips all the
>> PCI register emulation and just runs based on mocking core-kernel and
>> core-cxl interfaces. I would like to explore how far the cxl_test
>> approach can go and leave the PCI integration to when a driver can
>> reference real PCI ids.
>>
>> Otherwise, I feel like too much development effort can be diverted to
>> this "proxy" and increase the timeline to seeing the real thing.
>
>
> Fair enough.
>
> I think I could add the real driver in a new patchset version or maybe 
> a completely new one.
>
> From my previous comment about potentially using something like 
> auxbus,that would obviously mean a complete refactoring.
>
>
>>> +
>>> +{
>>> +Â Â Â  u16 dvsec;
>>> +
>>> +Â Â Â  dvsec = pci_find_dvsec_capability(pci_dev, 
>>> PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
>>> +
>>> +Â Â Â  if (!dvsec) {
>>> +Â Â Â Â Â Â Â  pci_info(pci_dev, "No CXL capability (vendor: %x\n", 
>>> pci_dev->vendor);
>>> +Â Â Â Â Â Â Â  return 0;
>>> +Â Â Â  } else {
>>> +Â Â Â Â Â Â Â  pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability 
>>> found");
>>> +Â Â Â  }
>>> +
>>> +Â Â Â  cxlds = cxl_accel_state_create(&pci_dev->dev);
>>> +Â Â Â  if (IS_ERR(cxlds))
>>> +Â Â Â Â Â Â Â  return PTR_ERR(cxlds);
>>> +
>>> +Â Â Â  pci_info(pci_dev, "Initializing cxlds...");
>>> +Â Â Â  cxlds->cxl_dvsec = dvsec;
>>> +Â Â Â  cxlds->serial = pci_dev->dev.id;
>>> +
>>> +Â Â Â  /* Should not this be based on DVSEC range size registers */
>>> +Â Â Â  cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
>>> +Â Â Â  cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, 
>>> "ram");
>> Especially at this stage of the driver there is nothing that require
>> QEMU emulation versus cxl_test mocking.
>>

I did use a slightly modified qemu hw/mem/cxl_type2.c for adding 
CXL.cache bits, and planned to submit it for anyone interested in Type2 
development ...


>>> +
>>> +Â Â Â  return 0;
>>> +}
>>> +
>>> +static void type2_pci_remove(struct pci_dev *pci_dev)
>>> +{
>>> +
>>> +}
>>> +
>>> +/* PCI device ID table */
>>> +static const struct pci_device_id type2_pci_table[] = {
>>> +Â Â Â  {PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
>> Real vendor-ids should have real device-ids, also that particular
>> device-id choice is not appropriate.
>
And this is the PCI IDs used by such emulation. It is emulating a 
non-existing CXL Type2 device what I guess is more problematic than 
emulating a memory expander.

My interested was to test configuration and not any kind of emulated 
acceleration related to CXL.mem writes or reads, what could be a project 
by itself but not sure if useful at all.

If this is valuable, I will submit it. I think extending qemu CXL 
support for helping development could be really useful for all those 
things hard to test like interleaving and sooner or later, complex 
fabrics with a good number of CXL switches, plus x-FAM support.





From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.10])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2814F47F6A
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 18:29:34 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=192.198.163.10
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718216976; cv=none; b=iJ+smtCxW89nxfbx/CCgPX1eCcYPMqxJwGnLGe7mxkubtEwhlCaPk0Rl6x0I2DtVx47dvs8pHed8MbgphDkec97SCXv/R/sNa+LSbfK/Ug5g4SwzRcSaXVgmuAG3MnoFt+IBgHEqvAYAvN5ojLYd1FcdkJlg+FjFKkBRAmmLSJc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718216976; c=relaxed/simple;
	bh=oKb41GYKfrLnqEe5UgPnXyUak8pJuc+TUCVitnq9tqQ=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=Trh3E9EqxBUOL8k7Keu7dstUuefg1qN7vhwUP4sdm0aRtFniL84ErCDZ+3ITtTcVqazG56PClEnaOzO/j3ojwUOx0HhbdMXsEh3Ymkte0Hx3dGqhM93zUAZ1IGLfSWaN/R6qTW6iNFxYF9TvDd347d/YO3y0+oLnRVKS0ED67wQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=IbYxCYbQ; arc=none smtp.client-ip=192.198.163.10
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="IbYxCYbQ"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718216975; x=1749752975;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=oKb41GYKfrLnqEe5UgPnXyUak8pJuc+TUCVitnq9tqQ=;
  b=IbYxCYbQOXNLMErLG6I/qAJDteyhGz18wYuroagkDHgqDTwF6E+2/Wka
   8TaQ4EHcXgqN02e+d1cHaz+P0ECABsHywNOpNO3LFiDXc3Kg2LtpofFSA
   RuEFzR3Um4LaqtCBkPRb2cVvUe8odJd4cb/qKEddKAKT9NoKrYalTyc2m
   Ih266lXb3X1zkrdByceSbmY2anQ05a+H51WOwprQEhk94PHuOhLYWgoYf
   5qb48oysMla3I3DLN1ZVZ0+YgCbzvQx/4KpWMDLU5rso9f309++qsNF5+
   U4iYAc6lPxdzHT47CpIVdNIMo9oIkJTj80E+NsTtiL8Gt7PcGk7C3TPim
   A==;
X-CSE-ConnectionGUID: s7runxmjS4eHM34QGk9mkg==
X-CSE-MsgGUID: eLbos6kPTy+26AQyGoOUig==
X-IronPort-AV: E=McAfee;i="6700,10204,11101"; a="26401978"
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="26401978"
Received: from orviesa005.jf.intel.com ([10.64.159.145])
  by fmvoesa104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Jun 2024 11:29:35 -0700
X-CSE-ConnectionGUID: GFKYvJ32TnKbvcuZMW8TLA==
X-CSE-MsgGUID: E6A0iZaOQW2NVqQvF/XFgw==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="44817925"
Received: from aschofie-mobl2.amr.corp.intel.com (HELO aschofie-mobl2) ([10.209.20.178])
  by orviesa005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Jun 2024 11:29:34 -0700
Date: Wed, 12 Jun 2024 11:29:32 -0700
From: Alison Schofield <alison.schofield@intel.com>
To: Dan Williams <dan.j.williams@intel.com>
Cc: alucerop@amd.com, linux-cxl@vger.kernel.org,
	pieter.jansen-van-vuuren@amd.com, richard.hughes@amd.com,
	dinan.gunawardena@amd.com
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Message-ID: <ZmnpDD94rMsfkOQs@aschofie-mobl2>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
 <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>

On Tue, Jun 11, 2024 at 09:43:57PM -0700, Dan Williams wrote:
> alucerop@ wrote:
> > From: Alejandro Lucero <alucerop@amd.com>
> > 
> > Differientiating Type3, aka memory expanders, from Type2, aka device
> 
> s/Differientiating/Differentiating/
> 
> ...actually to make this imperative tense don't use gerund phrases, so:
> 
> s/Differentiating/Differentiate/
> 
> This "imperative tense" preference is borrowed from the x86 tip tree
> patch recommendations [1], which reminds me that CXL should create a
> document like that to make the grammar expectations known.
> 
> [1]: https://www.kernel.org/doc/html/latest/process/maintainer-tip.html
> 

Hi Dan,

Imperative tense is the default expectation thoughout the kernel, so
'we' in CXL don't need to create any special rules around that.

https://www.kernel.org/doc/html/latest/process/submitting-patches.html#describe-your-changes

Describe your changes in imperative mood, e.g. "make xyzzy do frotz"
instead of "[This patch] makes xyzzy do frotz" or "[I] changed xyzzy
to do frotz", as if you are giving orders to the codebase to change
its behaviour.

-- Alison
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9199C7D096
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 18:58:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=198.175.65.18
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718218722; cv=fail; b=jZxYlqXh3mT4o9vhsaO1fvmcX/miQvgLrfr9R6kXJURMQBj91aKYYpP3+D85FOZl/Z7FEi1MsVzHUV4Ax86QJ3v5j8utqba9FICkGfzUv5bR12slj6wFwbBZaKnZb/aH7OMiPFHjzdEotAw6Qpk6tB5bFnGlEp7QBm9TuJ876AU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718218722; c=relaxed/simple;
	bh=FMA2fiLg9x4GCmT/24ieLJrYnTQ4gZG9IZf0asjG06c=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=ug1GLm26Wvc67vVWbxbXU/UaR4K4fgpZIyTEkG3Ooi4zoUI6LyPgus+0QH0qgoftym2LiC6hopPAVrt/A7m2arkeVi8/IQ2GoZLH4kMumvVTwIeo8Mzh1XF2KyjtbHDtTUYImlrhlpnwTR7gGTIhNAV0YCxSdhnvFDUkixguONI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=AsAjMRA1; arc=fail smtp.client-ip=198.175.65.18
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="AsAjMRA1"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718218721; x=1749754721;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=FMA2fiLg9x4GCmT/24ieLJrYnTQ4gZG9IZf0asjG06c=;
  b=AsAjMRA16FTv3jwdstwX+ZkU70ouGCL+jb4hhxTMkFhc38/aS8CO8iFK
   0pbVYoj3nWdw8TD3ShyXXXcCEKfJb8lw8kjQGRTbFaCmpN1vlwfJ0295d
   veWKn4ZUXz1uoQYYBctSCCBZxFzBk+NRGSMoj+F0SSTjye474aq+54mAO
   rIEvt5+gz0jh7E2hAKOUD5isSb/+1ASDyfQgybMiQqCjxSIswi8f3MuoT
   zN9AnqFNNrpR5T8q+rU3eyntF8XVG2FCMgjakK9bSeETkBeMrZTHEPPyP
   17uFNmAYo7GONpgwbKj1J7zf1kMzQbp1W2eQaG+IIqKNGVMnXBLRXiRp3
   g==;
X-CSE-ConnectionGUID: iqLtbbFDTa2Fh7Nu03/xFA==
X-CSE-MsgGUID: 3crPtgknQ1it9vfZljxmTQ==
X-IronPort-AV: E=McAfee;i="6700,10204,11101"; a="15156486"
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="15156486"
Received: from orviesa009.jf.intel.com ([10.64.159.149])
  by orvoesa110.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Jun 2024 11:58:40 -0700
X-CSE-ConnectionGUID: 7QXdgcSfRgaRY7orwjwZyQ==
X-CSE-MsgGUID: 5xyrVdqTRKW/tlNfKQUb0A==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="39997112"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orviesa009.jf.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 12 Jun 2024 11:58:40 -0700
Received: from orsmsx611.amr.corp.intel.com (10.22.229.24) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Wed, 12 Jun 2024 11:58:39 -0700
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX611.amr.corp.intel.com (10.22.229.24) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Wed, 12 Jun 2024 11:58:38 -0700
Received: from ORSEDG602.ED.cps.intel.com (10.7.248.7) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Wed, 12 Jun 2024 11:58:38 -0700
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (104.47.59.168)
 by edgegateway.intel.com (134.134.137.103) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Wed, 12 Jun 2024 11:58:38 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=kVFPpqFPF80hMBxOFH5LE0E/w8dcC03baK8bhPctZqk2cTfdSRtooARqRyjs1FFCiaDyoyjPxVdDoPDU+L2InFLDVTZXsXDi+rpI/p7nXsNP0kmJFwsG5jlUvoH0o4poHnozrl9zs4uB+cOrzFcd9Hiyrr3kbQmJpZ+AavB9i6VN7vxCvsWePCOGKXhO7NRVcDv30BlMcEuZ0ILIsKXMuuiVIOed69oEB5U8mBewg46tKc9fW2huenhfQz9G4gpcYAaJ5f0lcHTeQx9HvAULh7KI4uSANp3fmqdd1OdUZeLuaFX2k3g9jlxqtgp3nDrPscNneR4C5wLUAZH8+Puz+g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=L8m5AkrG6Vz2XsmrM18oThn59KsRj37pvDwRihuq620=;
 b=ofHVGtxdgcOIVl8+SgCXhWAabJXyekR3OuOGwMAvIffnSDkEX39DiHUXHQrec2FHYslLCY8FfhWhOjrrD9gTdW9V6X/FI5JINzi9ZHtpQ68N3OCqpraHCnsxHa5ysjUHWp0q9wxVwAi+4LuQ/hll+fdYiBsn1wBwHGkPut4VyTbjXQ+ZW5whOCKOG0hMVfCNnFQnegaIQuf9Gzq8f07H5+OPq46DXiZ6rBFPrweslhTN8tx5/xWYYo1eUhv4XgreDy6tnVYHvx7MARepJy7oc9l8DE71CPYszUl9QXZw6bmYJjdGNHV9YFK0sOMXfFob539H59dAj69CtqdqzX4GXA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by SA1PR11MB8319.namprd11.prod.outlook.com (2603:10b6:806:38c::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.36; Wed, 12 Jun
 2024 18:58:35 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Wed, 12 Jun 2024
 18:58:35 +0000
Date: Wed, 12 Jun 2024 11:58:32 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: Alison Schofield <alison.schofield@intel.com>, Dan Williams
	<dan.j.williams@intel.com>
CC: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 02/13] cxl: add type2 device basic support
Message-ID: <6669efd8a46a5_1fcf29492@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-3-alucerop@amd.com>
 <6669278d7fea_3101294e7@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmnpDD94rMsfkOQs@aschofie-mobl2>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <ZmnpDD94rMsfkOQs@aschofie-mobl2>
X-ClientProxiedBy: MW4PR03CA0189.namprd03.prod.outlook.com
 (2603:10b6:303:b8::14) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|SA1PR11MB8319:EE_
X-MS-Office365-Filtering-Correlation-Id: 3a812b13-7138-41f9-546f-08dc8b11a925
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230034|376008|1800799018|366010;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?R0yXDvXkxpCk+nTyt8DO6w919mC1ToUtpeHJs2alg8u8j9t1t7kSk2EOTeZS?=
 =?us-ascii?Q?rmyQTKoXqqqPVAvozcscCb5IPrBAsDzaV0I0z/2bl6iMEmjVbubZet5kRnJT?=
 =?us-ascii?Q?Qe571JLxZa0ox9zaZd2XItaGcAD13mU54m8MK2dcve728O0KfvIQ1+cm6D1k?=
 =?us-ascii?Q?/FLQr36LiFx46bIynmA4zWm/AVGkYPRclSRQ5wJnbFh9T3pg08G9oe3y1aUB?=
 =?us-ascii?Q?rf4lXhPfNQ0+75U9dy6BYxVClD3KsHlI6vt7lIMr7bKO8/Ew0048iV50veTd?=
 =?us-ascii?Q?6IT01vOg+eyeRMdZTIPlYOWTbyl0dUCO7ADkoaNb6zpUnrkZqexIrty+px4s?=
 =?us-ascii?Q?phh8ir/VTOD763LdpJZh7nTGlzGsVT71rMvy27WsmcXbXA5186MouoJgFvz5?=
 =?us-ascii?Q?d6/ZtqVhz+8cgw4TnBts6XeLKNirNQaDxZ49AXgYgNiKV8jZvFn0EJkl1JF4?=
 =?us-ascii?Q?6e5vwxI/S/PyCJZUk+em4OiC3d414QL8eWRvO1gjf6iIzJTOuReavsJEVchL?=
 =?us-ascii?Q?OKQ3Hk7m/xdo4VA62NTw4BblZ0SzUgCwB+GAcOkJVsz9cYJBbzfKzDd4l9qN?=
 =?us-ascii?Q?2Ura2VPNTMB4pov+SO7+oWzwh8WU0Il0zheW1FP3ILxrgWBprmBnNkzkyt4n?=
 =?us-ascii?Q?K/tm6J3g3/6N+x03D5wXUHEjFf+eRu7fXDMac5QxQAyDdZ1mou6VNbl7yi/O?=
 =?us-ascii?Q?Lj/LB8CWIwYAlK8u2umh5DgnNgwouFrDvhGPPSHJhZyuHjkHmL20xDsIXkih?=
 =?us-ascii?Q?8tQxRUDmYf9uuCHFprJ7LCBUxnTvQaRBKfyY7iFLKnvNH9mmANxl54W5JJ2+?=
 =?us-ascii?Q?oWBd044qAaJGoaUYLFQNk31lBeuyca1rAYWDNVjS9f7jsGEp6f1zhltUiNRQ?=
 =?us-ascii?Q?q8TnWWUQdzWT3Ds6IcyZG42DBmZfIcgZhQ5GsENOzsHp49okl9y0PptOcowE?=
 =?us-ascii?Q?Y+ODt/R8pmjJGKMrnWgQxeR3n8LnClDmn9aYQQDJUECygf2UPSOUC89wExtN?=
 =?us-ascii?Q?FPznndWfpiRNhOBPP+xH1RJxWdckMxt10leATwRH4UpCJU8qX368a32uD0X+?=
 =?us-ascii?Q?0HjEKMREca+8x8B23VDYYdp0ejDiNLjDPXOCC/Sv2z0F9aLBiHy0ja7yw0op?=
 =?us-ascii?Q?56TpoSa/RR8WdADDWdd/9v2nEpWIFzYyaInLVfFGfA8sbpJjhYgJePrwZhIq?=
 =?us-ascii?Q?8EMEpxLz60ZZ7SYlq+9nnbhtFkJJ042/mR9XvC/DlrSJ2KSItF+SXNFJIPPD?=
 =?us-ascii?Q?8FpEq1dxMEdZ6xEo8jUi1iSf2k48WQQ5Yt+jsgtiPw=3D=3D?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230034)(376008)(1800799018)(366010);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?gZNf33MsxbLK9dDhSVVv6Ul3UF99aTYHgBO5M2GQFmkocOUi/Hmu7ij0Lopg?=
 =?us-ascii?Q?8cg7YJvNi5FDPF5VgR31p5G0bEGb8pHSaiDlhk1XbiRiOWdljHw8enpBmdMY?=
 =?us-ascii?Q?g/BaSuK8w8XFBT8yUh6GxvuhyzH4yMMqQEKEqdix/7j5bqt+BIoOND351uqU?=
 =?us-ascii?Q?I602hmojKIHqBqQP3n3hDqhxllzdkBoyluvi7Z3ZrB4Egd9v5MiKxaegkrkx?=
 =?us-ascii?Q?weOoem6O3mzL+MG5n4eh1xxoEvlYxduK6HmlWe/ZzjTS+VymdGoei9/hK+SS?=
 =?us-ascii?Q?dKlu/MxsA5C/vXqssi9WGIUmDswdv2Xx9ChDQ8IQ5dcpAs8Supcw3pYKzXRK?=
 =?us-ascii?Q?czZSMzM+kFrhPn4iaYi1cB7DZscCVXOI3BVsdzj7vON7Di+jKp5R4HXq7DQw?=
 =?us-ascii?Q?0S1c0/DRaamFR2upx1SnKhKTLZmYcsHwKQ4QsMXYLb6Yjh3HHpkpeMrknVcr?=
 =?us-ascii?Q?LlDU4zFDXP35yNErtDihakiZ5FXFK4zLsijfnzkL7KNivv8gJB6KsN9S+3H8?=
 =?us-ascii?Q?sJoK4UGoibx9du4YXShyYEhsBHL25J07qJV2AhK457m3JuwN6ybWgWRQRK9p?=
 =?us-ascii?Q?3vdJDvNHSeTpNpReKcg+a+Fh+AQtvwG4jzfoNPejNcrEgFr6zyB0Fvog8Qyj?=
 =?us-ascii?Q?P8AU549YLZ+WQRwqdQA+XzEGvLNS+MtjV3L6XxL/S+hphiNGMtyNIlasy48n?=
 =?us-ascii?Q?TWLF3JaMHpbTgJFY3ACOiog3e90HhcdN5G7MM7OAeASNBurXvpDCCyFxof+w?=
 =?us-ascii?Q?kDJ2H2dpiFRb2EsL3/HlxM6TqzugH52D1APy3r2AxeK8Z1kvMgTbJuzOcEvN?=
 =?us-ascii?Q?FzxtdWdsdA7jw+MxSJ7HnPOqellNhPCWmFIl1n9jJ4obMmUII/pBYcRZJj+m?=
 =?us-ascii?Q?V2sPakDZ0mEUeLSgl4BvuojgQWxJPxqN0cKuld92k9iSl12VhR2f4OJH9OnG?=
 =?us-ascii?Q?TsHRSwyek/dHsCicocgbQbhuFt0VbyF7Wt64N0k8xcB7Xr1bwJ3ftDIie3UR?=
 =?us-ascii?Q?lsDOH49O0ktESEKR6cBRFCsh7EWq+NKVyQMNn7oAGR2jqxETAWv7OcLnGJz5?=
 =?us-ascii?Q?MchBsRm3Qbs5EsDxBscdBmMV21hl/N2lJlP3YUZrd1O9QflQfCYjiXiadVbW?=
 =?us-ascii?Q?Pb0UeeJcB2QuZkSGSHvalwGMND4GfD4NmTtctbIq6vZ4fxHiGVWBV53xpWNV?=
 =?us-ascii?Q?UWd8zdX38ECxaBXtwYigxegDSJ7HiPdh27d4a/iBAKKmJfHYcJMVBSJIKHx7?=
 =?us-ascii?Q?yHJDmRyC3/oJUf/xmEWOLHJZa8xsvi1oLzczhLJ9vy1itQG0AwPfuucH80A3?=
 =?us-ascii?Q?BODP99n51hMbCQwhQatGiNaOQzvj0JdovYNzmM1lNmLJlt9+0k4CziZ6Fqmx?=
 =?us-ascii?Q?nRMBj2f4TZW89WeFf8a6r7GulnuT/zXWYhjSOq/FM+2z+h04PUNh/S1aWPt7?=
 =?us-ascii?Q?VifpNRXk4WgaaCI90/g1K95Axe73l9R4q+5HaOMlXCuf/gQiDXN+E0kqcJFQ?=
 =?us-ascii?Q?HsBGwHO0akODV/oDnQ3/YI8zbcqJ0A9/kNFd4xpruxAcpIRQIXXska2zQr5r?=
 =?us-ascii?Q?8JSm9GpqOwSulERqWVPm52aU0Y2dtXJZ5GB/2HsT/f+qXNAyEkG74U1yh04w?=
 =?us-ascii?Q?HA=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 3a812b13-7138-41f9-546f-08dc8b11a925
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 18:58:34.9794
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: /RKc0p10k5qXn4HrovxvJytxNj8+hL9JZ5hr/lV6r9FkOXiYRhUFEEGxh0CJD2NufANwzpPR7QfhIBAa8xYZGJ3qEmBSEEwWyKqDqVbhrcM=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR11MB8319
X-OriginatorOrg: intel.com

Alison Schofield wrote:
> On Tue, Jun 11, 2024 at 09:43:57PM -0700, Dan Williams wrote:
> > alucerop@ wrote:
> > > From: Alejandro Lucero <alucerop@amd.com>
> > > 
> > > Differientiating Type3, aka memory expanders, from Type2, aka device
> > 
> > s/Differientiating/Differentiating/
> > 
> > ...actually to make this imperative tense don't use gerund phrases, so:
> > 
> > s/Differentiating/Differentiate/
> > 
> > This "imperative tense" preference is borrowed from the x86 tip tree
> > patch recommendations [1], which reminds me that CXL should create a
> > document like that to make the grammar expectations known.
> > 
> > [1]: https://www.kernel.org/doc/html/latest/process/maintainer-tip.html
> > 
> 
> Hi Dan,
> 
> Imperative tense is the default expectation thoughout the kernel, so
> 'we' in CXL don't need to create any special rules around that.
> 
> https://www.kernel.org/doc/html/latest/process/submitting-patches.html#describe-your-changes

Oh, yeah, forgot about that, thanks!

However, the motivation for a CXL maintainer-handbook entry would also
be to convey subsystem-local details like how often to ping on a series,
when the merge window cutoff typically lands, what baseline to use for
new patch submissions, do submissions need to worry about
reverse-xmas-tree variable declartations, etc...

Sidenote on that topic of formatting, I think it would also be useful to
declare "clang-format is good enough", i.e. even if clang-format spits
out something that could be made to look prettier by hand, the
auto-formatted patch is good enough. If someone really cares they can
update the clang-format template.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.16])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3FA9C83A12
	for <linux-cxl@vger.kernel.org>; Wed, 12 Jun 2024 21:18:23 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=198.175.65.16
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718227106; cv=fail; b=ff4K44Spt5fooqa26PFrayzMBpGw+7qBxjBcxrUtEOJ+zIJcq3IoUEM2QivdrYU6y1nGn6yRL3abWxDH0CYfG/FIeQ1YCEeLrilB6xFIzgAEHfba0ZxpMFvYu6lnoczhz8W9A7h4RdqGbUqETKbteYPmzyCMhpfv5irfTUpjlOs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718227106; c=relaxed/simple;
	bh=UT5lXKeLyZFUShHgYeBtykrsZ7ubxHYJqa5V9HAxud0=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=m3PVQIFeyEx6jID8lm4Tw5H0VTaaw/eJ0iZuH+kAFlgyMfupYagKpXo4So3bf15dOUBINjPYb56KzaeVN9Cng35SGuYPitTLL8si1V6SsS7bCVHjTip8ymICKEOnt2DA7Tb8+IIoZDoWCTr84d7GqCougy9tEvLP9Hy3cn5EUUA=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=U1nEORiW; arc=fail smtp.client-ip=198.175.65.16
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="U1nEORiW"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718227104; x=1749763104;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=UT5lXKeLyZFUShHgYeBtykrsZ7ubxHYJqa5V9HAxud0=;
  b=U1nEORiWfgw3Hd8AfHiKw9kYhBQ1aDW9JbcamPPGregYlpWysO4AL5tZ
   GkN1PlOVUBqu5qfG5YYCc+vygBZWzFpC/H9x+MiGQApMMBYT9pb4BNWlj
   mUXEWQZ6qt/Lb8gOA6R5jA2/7P4nBf3w8yUamaMe0v5ZA6A7SMiIPyxJF
   4Ledgta2AmxZknJEA4T0uyX5WMLB17xY3zTE4FslHYnm8xXB+N5LUp1hv
   v0D/OiK4pUNSMI5zDCnNtaDWe85+J69VdkP/DDpkSGukm+fOfQfy1ynPY
   lzwd8ZoHSfwNqDow7njaLDx4saRpVu4q0zU82ib5OIT/oz6tZpcnDzpf7
   Q==;
X-CSE-ConnectionGUID: OYeTAJrYTZuTJMm3MJ4xNw==
X-CSE-MsgGUID: 4mtUJ6+DQeSIWr4YoiaROw==
X-IronPort-AV: E=McAfee;i="6700,10204,11101"; a="15145004"
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="15145004"
Received: from orviesa004.jf.intel.com ([10.64.159.144])
  by orvoesa108.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Jun 2024 14:18:23 -0700
X-CSE-ConnectionGUID: pFnrBTm2Shiz26DLGy1TLg==
X-CSE-MsgGUID: AEgzOXghS+S9B39gvwgVjQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,234,1712646000"; 
   d="scan'208";a="45045111"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orviesa004.jf.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 12 Jun 2024 14:18:24 -0700
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Wed, 12 Jun 2024 14:18:23 -0700
Received: from ORSEDG601.ED.cps.intel.com (10.7.248.6) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Wed, 12 Jun 2024 14:18:23 -0700
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (104.47.59.169)
 by edgegateway.intel.com (134.134.137.102) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Wed, 12 Jun 2024 14:18:22 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=A5YOWwc1FsFRhV9p0jEr6x0bkmhWLhlKn3Hq5LcHVvhhyBcI+czUZ6b4QJW7UMa5x5A+XihRWQsUzVlW0fpwllcEja4XJqWkZgbgHjvh8cO3AVUCZLzNkZiWZzHouxDYREdDnmvt3dNP5uL78ebN0eu6Lj/jQaG4rwZHrfnnpzmY5vz2IvUOsUCb0Spfasn62TYMPnHsJ9Xl15mh8hHcmbLMkLKx0ainWIwQAoDR1KKFPCOERuUQ6BYWxOyEBPrGfQQ1qgp/Xrul0Q44cHrmE7uUQsua1aIaiksYOyfGYsxUDin/RMn2hKP4oLDrkQdunq+q+67/+I/bqr0aGEnO8Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=4tliFPYaedxcqPrn7I5lpyK3Snqbm+EAn8rGEmMEwWA=;
 b=g4H5f+1X4izwElWSCi0mnFj45evS/550gmqCXbJjB8NsXq0sm4nFZX0XObw7OF7OPjGLBR0X5ZnbJG90XpxfnDFc3taCIUAxdFG8ow2lMMT5JOrf6ZQsI5r9l5+/h0SnJEIjbBnueO8c6EgkhBpvOVXE6CrjjPpaAGGVd4+9fxQYO67lfjfCuc5MPlDV3GAS15oHnc34EJPOMRHQPqPunbr/WyBS2NTU477XTwe+l8tOH4BnnbViZHaR2P9/VzMuYh0kznFElhrw/3M+UFfBEEtb9k2bRwOmnFIHVXHeOE2YY7BDbzEXnVhOYX504am26Krr7qFfw//e+u8D8CEvyg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by IA0PR11MB7955.namprd11.prod.outlook.com (2603:10b6:208:3dd::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7677.20; Wed, 12 Jun
 2024 21:18:20 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Wed, 12 Jun 2024
 21:18:20 +0000
Date: Wed, 12 Jun 2024 14:18:17 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: Christoph Hellwig <hch@infradead.org>, Dan Williams
	<dan.j.williams@intel.com>
CC: <alucerop@amd.com>, <linux-cxl@vger.kernel.org>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Message-ID: <666a1099c94e6_1fcf294e9@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <ZmkkaOTUFuzIr2cG@infradead.org>
X-ClientProxiedBy: MW4PR04CA0173.namprd04.prod.outlook.com
 (2603:10b6:303:85::28) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|IA0PR11MB7955:EE_
X-MS-Office365-Filtering-Correlation-Id: a62a507c-cfc2-49d7-e4e7-08dc8b252f11
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230034|376008|1800799018|366010;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?h3howN/RWSs/uyIjGHqs8lcrwVbiZ8Xfdot1ySYuXuWLstwe9XjrmSX/MT9v?=
 =?us-ascii?Q?+KtZtjFfZhPn8+YHfIjovSwXmeKorFRqayu+j/V8tcuQ8vdNpI+eEtlPvS5C?=
 =?us-ascii?Q?saQNOQ86UL1BtlDnRfIqWu/kclekR+Jt8ztwKVPtl4SJDtnqKo1IyB2kzHsl?=
 =?us-ascii?Q?4PNJffJp1n4lBXWD9MU+77m/h3mTkmCNlzxySug9Gnkx0DmJCo7NoQsDWOsF?=
 =?us-ascii?Q?VWUp+MKndimOvT0Gc3rFSiMCuzdR6ipM/30G22Fv77vR3Ko7gWtXt+E6zDqd?=
 =?us-ascii?Q?ZhZ5zgT5hLG+QjwsSCPJyAsZNZJBgtY6TqEUK4eOrwRNBbDMxyEtColoQdMJ?=
 =?us-ascii?Q?RyiUR3JpSJEYLB9tNRUCmZ2sXIzARwfQEpsqFrrTYoIY67NBoTBSVNfYUli4?=
 =?us-ascii?Q?tCOBqCY/gF7qMz61BxANSf6jsYkLzD6iKTthpMoG12K8cxon5U18IQu+LpIU?=
 =?us-ascii?Q?iy+3ZuoXwZE7hOXJ49lZuF1JAa4YxOBEHbCruPdGzGoqRRTKq7lcpOClHROO?=
 =?us-ascii?Q?gLOjd+O47zxuUqTYyuxbcJWfiDl/bNXHP9fl9d6M3Z+vocs2abtUfiQ29qB+?=
 =?us-ascii?Q?3mpCHpmSDRkrLgdx0S9poba+sSljt2KvtGn2301GJAasbVt//vY6UG1mDCiJ?=
 =?us-ascii?Q?jlUea6Pv1HRQwSIi7dNvg1inewM8IkT/HDM1iUmpv+m+YrBoU5TrLXSXL9p1?=
 =?us-ascii?Q?gwkGanpV7Q3Bb7b/BnZayhgUDorzgYyzVNQX5j+xpjzqVQIr8vqEDQgXFggI?=
 =?us-ascii?Q?gzvecwVDgGRAukp65K7goAGmzamDEm2akTjcChsAuL7bNSA2HxniBqSMbNu1?=
 =?us-ascii?Q?tR8ux+L6xkX/ZuKiTGPEeg2jxcsOecBUfVDyN5TegCUxYaz58TyZdCBe2JpV?=
 =?us-ascii?Q?oxrHJAeWO90f28tTb4Wt47OQBsNf73vK0tL0dH0S+6fPeihCTe1f3QdsvOPJ?=
 =?us-ascii?Q?HyLAjCk3BGuPEhiGb94OScXZ8nifejEe7insjogC6ymDap0jd8R1R1HHrRXq?=
 =?us-ascii?Q?OiJDO2Ef2XujSyyFc/qN/cPpjghy2Rd7IL1nHIZdrzf6fmue1ITLNenSO9nI?=
 =?us-ascii?Q?pUa2XZWg/LXQXoZO54rd+y/W2w5go+Yp8DaDCqNqeFC1MowF20KSFGkE5zPQ?=
 =?us-ascii?Q?fLzE7HURskzAPe5upnj+FkBzjw1YPnvICFGgtzbQtgQjKij/oZamq3j4y/Du?=
 =?us-ascii?Q?BHh17RTjguynK0qmfoaByRFHMXXQ61sJ+V9SUih+fJ0nODhI/eCaW8uRULOu?=
 =?us-ascii?Q?2jfeWNYVtpOtBFJz0x7OC+0Jm+MXODtxqTWlR/FkP8N8mI9FbTuebSJSnfOw?=
 =?us-ascii?Q?OBWcS2NGRyrvZfY4XfqfBOR/?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230034)(376008)(1800799018)(366010);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?usfxa/emU352nz+QKjv6GRbPhWBrSHIxlg+UIzwsjhUVt00VjK4GDbEiiM3y?=
 =?us-ascii?Q?ocWMDcIorQp2UiOm81b0ObkCEw+6kMDK0+YNiOSEBFHkV9XxgYmtuRh2NKrw?=
 =?us-ascii?Q?0mNI02axmWHcuy4TJE2opjocn18OfZQ/z481Mudu7AV3ALlqgCaJnHgXweYC?=
 =?us-ascii?Q?jrBZVrJVZT2Bw+fNfBSo6auf9LCypAvQkBlyPiSTXWmZTLIVLaPpZ0JNKYRY?=
 =?us-ascii?Q?4UExkNubRzTep0PioLGgN4m4ZX4Gxw4Q5EhCyTMzWgq/tKoLC/Ax4u70jsKh?=
 =?us-ascii?Q?1Ns1RPDhy/cwKeVt9RjAz+NK+IgjfxOX6Wi8/yaWOdQiacrD5n+cRMO5ba9U?=
 =?us-ascii?Q?XpY9OHqFb82Q+B37Sh/tGhf486Z992AkvrEe4Ay2Hyzdo4zODq1ZBPrTvthS?=
 =?us-ascii?Q?UPurZ1NVe7egblboJ2aTAIEx5bCS/mulnLJVOHM58WzvwO/L6S8+tabp1p/c?=
 =?us-ascii?Q?u9MNxzEfu4R7iUSGWPpPdi4xWzEon6ftTNdCtFWIPYnwlLOT8JBCXxPYEbWg?=
 =?us-ascii?Q?cIYL1IV16J6CXG1diH9zEd/ftD+F+EuNNOXof0YZjwzgQ0Kz8N9O6sqe1ldn?=
 =?us-ascii?Q?FzCR+ER+w9XW5rr0935JGXXzQgqBIXWWkPNS9Ql/KTkHedS2If6UZ1tocdgm?=
 =?us-ascii?Q?jb+LW8W0r788bJYfMQ2fceRiCcUpJuCio3pm5kKeVYvA149UE1crkEu4V4y6?=
 =?us-ascii?Q?TsDX/9WUR7Lko5Zseexg/pd2NJ0BTJWWD3DTJdKPXdDpswWMkMfho5j31ALn?=
 =?us-ascii?Q?GPcp2BnULbuhZP2LPvxNJo920Sy92W/qcZtmIVn7HiTjXOnOji2fVdv7tW6R?=
 =?us-ascii?Q?wXX3u62EuFDGunDByD+uGtnxr5ZUtHwernD0GdFEQJ+Ameavjzxcf39fQ1d8?=
 =?us-ascii?Q?IdS4V5RDP4ns/MFj9uwZUBLm+CdErW6MalT3/xJFJsCNsbZNx5DQMLXs6W7B?=
 =?us-ascii?Q?d1ERjxUdZNvnUDqYsBEqqfKYucORQyzmI852VuZ7J6Z1CGbhuFMLtf0teAKl?=
 =?us-ascii?Q?GCsxcgMgmHh/nzs6M/fUFoAy+BBlZCu5NhKjSpxtRffxh+zvVDNCnqa/Yp1c?=
 =?us-ascii?Q?D2oGzzHxnCTMzZ1tqpSYoYmVDalSRlaKIrSCQSdhhwN6IroitowDcwXNuJhL?=
 =?us-ascii?Q?JMD1thE9yNVQkEE7FAgnxhJZO/S6lIWVnB8q2Q5Yi4DiB5Onb4zsC7zEUWJ2?=
 =?us-ascii?Q?0FMREu/i5goLJALOOYxQiNCHAJ3r3ItWN2vLsdfSGZEKATw0WNQIwzvAu1mp?=
 =?us-ascii?Q?AmrUmaC2K42OaH3n2hCohkPVFXm1v9+GzNGaaRp8b414W82lsRoWl8oRNVtV?=
 =?us-ascii?Q?xYHQqgx0ApPqTDZtd+yOMcRfPQHr0zvNhJQa0Cn4b2UqilJ1yH+YiJbR7u6G?=
 =?us-ascii?Q?UW3xszR9XRu76MsPFpg9t6JEzGyRraOnuQKNRR83T/K1aaN11+UqXZ8AifOn?=
 =?us-ascii?Q?9jd+RmEfkkkMjundNomCLJV2xX7DoZv62sO/Gtoiok43U+3IPxMDCF74byQR?=
 =?us-ascii?Q?qyRk935+2/Z1J5buWFFfNWS7MvkJtOsEktJ7UhMHDKZA1UDJfYyIkevD1UYL?=
 =?us-ascii?Q?FGf1k2evhv1q5RuiocYPFn4KUk3Bo64lIJySY8v57z+TbDLbZdoxCbTy1tuq?=
 =?us-ascii?Q?WA=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: a62a507c-cfc2-49d7-e4e7-08dc8b252f11
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 Jun 2024 21:18:20.1059
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: MHchIyBkZ1dCJ47tU+JBSadWWJmjaKuuHn8UjwUgf6/+knpnUCQrQlkxo8cDKDaRawEU/jcmPBMqWTvY6Aoc3++5rI+yssrq8eTkncRwH3k=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR11MB7955
X-OriginatorOrg: intel.com

Christoph Hellwig wrote:
> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
> > alucerop@ wrote:
> > > From: Alejandro Lucero <alucerop@amd.com>
> > > 
> > > CXL Type 2 devices imply specific vendor drivers binding to those
> > > devices instead of generic ones offered by CXL core like the PCI driver.
> 
> No, it absolutelt does not.  There is no such thing as a vendor driver
> in Linux.
> 
> > So I don't like this approach, there are details that are private to the
> > CXL generic memory-expander use case, and some that are suitable for
> > CXL.mem and CXL.cache capabilities in other drivers. That distinct
> > subset should move to include/linux/. I.e. I want to see the incremental
> > conversion of what 3rd party drivers need compared to the generic
> > expander case, and consider when and where new shared infrastructure
> > needs to be refactored.
> 
> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
> that we can keep a tight control over them.

Yeah, especially for the common pieces like CXL memory where the
endpoint driver is responsible for registering a 'struct cxl_memdev' and
the existing 'cxl_mem' driver just grows to accommodate device-memory
alongside host-only memory expansion.

For CXL accelerator use case that's where more specifics are needed
because CXL.cache operation gets entangled with IOMMU / DMA mapping
policy for ATS.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-BN8-obe.outbound.protection.outlook.com (mail-bn8nam04on2058.outbound.protection.outlook.com [40.107.100.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 72CB31428FC
	for <linux-cxl@vger.kernel.org>; Thu, 13 Jun 2024 11:46:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.100.58
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718279163; cv=fail; b=nP/2/gnBStYWyn6dbDRXkot0Eytd3vOmXjOEj87QaYEcTqVgJpPC6Pq51pBhRFzfi09T6rddd+aNd1xh8QyS82cdfbEfRjSWH9DbQ2Evphj5gHV9PU8jDt5hkQalXcia1dX5UI2NfL+1Yk3XcD6LZnp071WtbohSw5J2INJJPA8=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718279163; c=relaxed/simple;
	bh=p75v3QFUZyEYqd/PyUkl69Eayb1tVDaeha5THlmlgv0=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=QIOKBEI0RPD7WrKcY9FaGHI83OyR1V0GoYekPDCrN/NnSghFX4F0Zq1UxO6dF71DIrV5oX/bJLdzNJJFdmrons/dVc8zBjesgCISBloDXez9FsMZc1FcYWe4gPkAbdukj3yrlAMZHuFGpwqcllCA9ciF64Hmh9ZJgfdDNs5mTVM=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=3WmocXAr; arc=fail smtp.client-ip=40.107.100.58
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="3WmocXAr"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=aw5MlvSbaiJYD+oPcDNH209QFoLKecKrPVQFeqmt+DjyNk8dSIuHSa44kvsh9Xz57rYnp6bK3CrEqaKu/T6WwIS1DlC79QRMHyVe3NVwTS0xFkHfzSjSeI0G95zmnLuREHeNXnEaEnLybY12ZWzxfarOodqvijfWh4QU6Tqf+6nfipEcPzlOmFtt3d7rOALXxum+ssfhXXfQ5t/LE34OMynIIKG11G7wWL+UvtB+oN1V9feEEWF9HOYODekvTi8Y+KjFHJ5YzUFY81E6pJ3I3PtEsBC4wAkYsp1tZsTjOb9rgJN0PTDKrMaLquJmLBZYR+/DWoRT1VQSv0piY/zWKA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=J38qNYmehtpJm6C3Hec3ySo7U+feyRmuulzjEQ7WvJ4=;
 b=JHdSGkh7GRX6mSzpTF30j404lhGanKY6xcWQ8YqyCPBOdrI1lAQq+5lhRjytKkQcrgJxArnSlx1IY02GqLeyENEhhOXFZWSiG5z0hH4ZDGqr57YXXkDBR6W+Q8Atjqe72TmdkmjDQjhcWGv1uDrb6h2isJns2FN61kew/QoSu5X6LY+LeGAAdA5ztv+ahiyO1i3+kajDyVMFR0aQSpXxaMiaO5bP8P9rWUkMJ3WvhArShU67nvXMteDu3aS+iqimChdzHG7tQrJqKkCCONVRDaRqcsD7HiAqiY/G3xUcAKfNdVuR9VWwyv7oWvrWuF8AdbrsWnlT+XQT6rEmbSvphg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=J38qNYmehtpJm6C3Hec3ySo7U+feyRmuulzjEQ7WvJ4=;
 b=3WmocXArxDUEzMcFCJ0ocGAFacY45mUuLpu3VXG13jTKjxCxdn2mzYxRqJ6ES1T8ZY4AmLs0vERlKCkpVl0E+WFePDHGrcxV7TOUtWH+xwAIgGXdmRwArf/vNu8aQZLHukzxQSuToOG94qPNuR+hD+7xfOrhvQQ44LuJHl/A2Os=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by PH7PR12MB5805.namprd12.prod.outlook.com (2603:10b6:510:1d1::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Thu, 13 Jun
 2024 11:45:58 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7677.024; Thu, 13 Jun 2024
 11:45:58 +0000
Message-ID: <b51be5ca-cf7e-bd93-108f-1713e04301c3@amd.com>
Date: Thu, 13 Jun 2024 12:45:53 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>,
 Christoph Hellwig <hch@infradead.org>
Cc: linux-cxl@vger.kernel.org, pieter.jansen-van-vuuren@amd.com,
 richard.hughes@amd.com, dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
 <666a1099c94e6_1fcf294e9@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <666a1099c94e6_1fcf294e9@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO4P123CA0541.GBRP123.PROD.OUTLOOK.COM
 (2603:10a6:600:319::12) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|PH7PR12MB5805:EE_
X-MS-Office365-Filtering-Correlation-Id: 0b481a2e-e8f8-407b-ed40-08dc8b9e63f7
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230034|366010|376008|1800799018;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?S1pZbDZGTVFKcUdJb05vTEt4dW0raWZYSlRZSkQrVHZWZ1lUZno4emNIczIx?=
 =?utf-8?B?aG8yRXF3cHl0cWQ3MEprdW9ZVE9ndUFBMmNEeGZWcUJCOVNnK3JXYzhaT05u?=
 =?utf-8?B?LzIxaGpmM1paWWY2N2ZWcndzRFBmcDlnbGh6aDkxMUtmOEFRMVpTVWh6Ni9y?=
 =?utf-8?B?ZEhzNjJDUUZqVUpMZGc5ckZLMnMvTSt4UzFHajdkVm42L0xNdSsyNkVPb0RV?=
 =?utf-8?B?SEdQblFWZ1FTUytZUkdpeUdKRzBNTWFyU21tU0EyMzZVYXBCQ1UweDBNc2JR?=
 =?utf-8?B?MDFOc2F1ck5WODVjaHBSK0loVlZqYTRsQVdEeTRTTTJUcFRpcENBaEQwWnBo?=
 =?utf-8?B?TWpJVUxOU1M2c0NaTzBqSmE5UkhLVVFvSVdTYjBPRkQ0R2hiTU1XNFRTcTY4?=
 =?utf-8?B?NlhzNzFweGlhb2NkSk1GdVpEMHhveng3d3dVYTNNOGgrUXNSS2doSUludEx0?=
 =?utf-8?B?dWhuRmh2ek9VQ2hob21FTjZ0czI1V1B2eXd3c3BycjBBSWVSS1dHLzd2dk4v?=
 =?utf-8?B?OC8wdU1oaDE1TzUxM09rSWpVQUtmdDh2UTYydUlTcWtvYmRnbmo2ZmJaYkpu?=
 =?utf-8?B?N01JQmNOYWF3OUVnWDhNQkFBQ0s5WlFURjc1Y0t5U3BJMUtwdHlsU0pYenUr?=
 =?utf-8?B?czFTQXVjaS9BOHdZUGFOU01TcytsdGczR3dLTnlSZy9meXAzZVZFTmUyZ01T?=
 =?utf-8?B?NUorMWlPQVNyUFo1a1RON3M0aVVsR2VueHVFcEVPanhWclR3em1Gc1EwenUz?=
 =?utf-8?B?aVc5bnErWXJJVVgxdWdveDdHdVRMbVJRb0J6Z0l2aVNGQXBzWjI5WXppNGsy?=
 =?utf-8?B?S29BazNpODRQaXNlU1pCQTRMV201MUZveUhlTFFGZGhtbmlGcEE5N2NuNEZ4?=
 =?utf-8?B?V0dQMVcvSUtQaG8zdVd6M1JSRmFTZG92eTlnNWFXZUd4QUNLa0tCVmpjQ1JC?=
 =?utf-8?B?S2ZNVFhFZWtld0VHTXFLa0xpSUE5V2IxTjBnWUlhbTIwbVdHYVNES2Z2N0JQ?=
 =?utf-8?B?SUVyUUlIc3dadmtMbktpalpoeFNjZnJlZG1hVDF1bVhFbW8xK3FISCtRUUJX?=
 =?utf-8?B?OUcrcllJaUtpdHFVWVB4OTdZbTFxN05raUoyeTRWZGkwUUNtY0FldE5zQ0Yv?=
 =?utf-8?B?UmorR3k2TE1SMnFWR05wUlVvV1lUS3BLaXB0K2lQRjlHVGVrQXprWkhvajdN?=
 =?utf-8?B?dXJhdDhIdGtZUW10TUt3bjdQNTkrNnlHdlJINXhYa1E4TlV1cEgvTUtOb0hn?=
 =?utf-8?B?bFY2OWk5SFcramZ3MkRyZXgxbEU4Tjh1b3pFK0JiZ3FCTVRmMzNsUDJVN3FT?=
 =?utf-8?B?Y1dwTmRKcmhqUjVRcWtiZk04RG9iOUJsdzFPZGlySkdSeFEyaGJCa2hHZzNW?=
 =?utf-8?B?Z0d4S0tUN1l1MURIYVBDR1V0UGh2a2ppdityUjY2bGhpYlNGNHQ5SUFuNnY1?=
 =?utf-8?B?b1hFbmlUem04WUV3cUhnTVRqaUQ5MVRTTnc0MTNwaDRuYXhvL0ZraDFKNVRq?=
 =?utf-8?B?cWpNZWwxWFNGSis3QXVQUUIrc0lUQnZaYjJmMnprNmhDWmNEUk8vcVk2UWcr?=
 =?utf-8?B?cnJYcjRzb0tWK0l2UzFlSktkSVB5WWIxUnV6UFhYakQ2R2RyRnBwdGE4MGVL?=
 =?utf-8?B?RURSeThsRThoN0xSUnNKNzQ5S1ZtSGRVT3RkVTIrMFlYbnppc3JTZitRc04v?=
 =?utf-8?B?VGpDVXdGRlZnVHNTOWtGS05oUkd3OTRBR1ZwcHVMczU0OEN6dHRUQndETFY0?=
 =?utf-8?Q?UENTq0O+3Vc/MQAh3514H10JSUfH1/I1xef9EtT?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230034)(366010)(376008)(1800799018);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?ZFE0bzNpVlJXTVBibk00VFlFK0NxZVJDZlJmRms1T1V1S1BvMTNldGJ4Vkg1?=
 =?utf-8?B?K1ZjUVNDRld3VSs5U0o4SVIwVGZzbWdZbjNZS3FrYkx0aEtvN0N6dU5rUWRr?=
 =?utf-8?B?MFl3SzBidVBuajZaR1pxcXduRGlmVVc2VlBzRU9zeWIweGcrZzUvZjlTeG55?=
 =?utf-8?B?L2REb2xzV3hLR0JUQlJyOS9Jd0s3aDZNTjd3WUtnbHJZUFVpek0zMVhyQnpt?=
 =?utf-8?B?TTVlRUtNWU1jMXd5bElpcXBWcHFLUW5YNTh5UTAyZFB5bThPbTJxRmZUV3pL?=
 =?utf-8?B?dmQ1RzQ1cm1xZ1laZ0FVQis5V0pyOU9Vc0tYUXhyclNYZUh5d1JDRkZPOWhv?=
 =?utf-8?B?cXhRM29BQTgwaFRQNUFkd2VvMzhFczNCUWo3ZDdhMFpxOXZSTXFPREd0WjRF?=
 =?utf-8?B?YTNLSlpRcVhmMzkxWGhxMmcwdlA4cGZpV3RlQ3pESm9xWk9tTEd5N0R2OWVT?=
 =?utf-8?B?RzVuUTM0KzFsNE9kcTl4MlQ1eWxQWWIwV3MyWlJrdGVIQmpvRjl2M1NYK3hE?=
 =?utf-8?B?UDFkUXRBbUoyeTRKSDJqZ3BhQ25VbVh1N0htVVYzMHhza09HMHVpYk5SMDAx?=
 =?utf-8?B?YkNQRit2UXpHRGxFU1UzSW1XeWlGMEVPVVpIRjg4bndxSzR1VGVQd1NDK1ov?=
 =?utf-8?B?bzYvc0k5VjJxaCt1Q0NFdUZWQVdieVIrMWc5alAxQzRSVURlYmd2Y3NySnZZ?=
 =?utf-8?B?QS9JbVB1UVYrdHR5am5zK1hsRklsNHlhRGlzY1hocFdqdkQ2T3RsR1ZHR0x0?=
 =?utf-8?B?T09yWVJVTzdFTURzbzB0VHJjWFdneGorRGViaXA2Z3BwYzkyUjIyUHZPcEU3?=
 =?utf-8?B?dFhJMkhPZWp6L3kwRVFxVGc4L3h3Z0NyWDFtcThMNUJIRWErQ1FrVXNUUjZi?=
 =?utf-8?B?ZmUwQjh5R1UyZGdzbEpaR3FVWjNyZU5YWEcxM0lCU2hERFpnTTQ3amNTelFX?=
 =?utf-8?B?dXdwOVV4RjZteTY0RjhSR3NJVnpJQXNUSWxKUW1NR1lBUnhQQ1Q2NXpMUVVV?=
 =?utf-8?B?OFl6cGQvbWVNS1R5ZXc5OGJuUFNWZE54SlM2My8waEo3VU1KcFE0UVczOVFW?=
 =?utf-8?B?VTR1TEZhNDZxMWw1cytqYkllVncrZWdtdE1FVGUvSHMvTGdwRHk2VDJDRXYr?=
 =?utf-8?B?VUxBYk0vVzhsbjZ1MWlsODd0RHhDNjZwQVc2N2RQM0hRck12elp6ejhJWStM?=
 =?utf-8?B?aGdhNTYzVDhIdTkzSHRvc3lmejdlMXBzbG41dXB2U1pXaVJCaXZHb2Vkd1hp?=
 =?utf-8?B?T29IUm1mZXd5Qk9pUkp6TlFCeWk4VXNZdy9hRmdjU3QvSHhFR0FRZExLaU5r?=
 =?utf-8?B?MGRrWnMwYnZ5azN3WkNzRXZELzhHcnVwVERKV3FFd2szUWt4c2xQZUZhOWJN?=
 =?utf-8?B?cXY1S2JoYWZoSVhOWWZDNEZaODd4YlV2WEFpS1VsZ0pOZExTNmRrd2FXUXdJ?=
 =?utf-8?B?S2U4MzFXbHlIdVE3QVNLL0FGMXdjTWFENUpNaStXZDFDL0xTQUZZVmdCR1dr?=
 =?utf-8?B?N1JCNmlmY3p2dGtGWEQ5ZVFRbFR0a3A2cytZS1VGbWZHUmp5ejc1UHR6S2tO?=
 =?utf-8?B?ZU96QXBlbUJ2MnYyaXFjZzExOXM1aWdMcFRYdlVnQlNXTXQvb1VJWFRHRzc3?=
 =?utf-8?B?cmpJZG9YTEtSOE8xNzF4ZDA2blRVQXl0dVR5MzF3YXVaWXFyV0ZFMmdQRW05?=
 =?utf-8?B?dDl6SGoxMng0b21xdnB1dERWZ2dIT0p1VEhDcDQ1aVVaY3RQL05CTDdEYWlk?=
 =?utf-8?B?UG04Sk9zSm8yNWlkbGQ4ZzZiWlppQ3hiQlVjVXp0cDQwajROVEtBUTIrTzVx?=
 =?utf-8?B?bXIyd2JmQytrait4REJtRFFlQjFJVmF4Zm1QQzA4cHkyandsT0ZEbnpSNllX?=
 =?utf-8?B?Ujg3UERvZ1hnL1JYTUpUdG1kdFUvUi80ajJ1Y1hGeDlROTNPTU1WNEtjeVZr?=
 =?utf-8?B?SDE3WXpnUHFKcytRYmF4U1I3enY0Y3hPbk5yQjJ6aWprTTlIaVR0RkRtdVdy?=
 =?utf-8?B?TlNJclRBMjhUMVYyTUJKdVhLSnVuV3ZUUVhUN2ZFTDNoT1VxbTRYNlUrRmVI?=
 =?utf-8?B?NW9mOUYvY3FObkI5Sk5menFYcHJ2UXkvQjFMVzhIeFFKdmZibGJiajdYVG9j?=
 =?utf-8?Q?zWXQF8P49WLZRrv0TGZxY9bcx?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 0b481a2e-e8f8-407b-ed40-08dc8b9e63f7
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Jun 2024 11:45:58.0280
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 4E1WCzhZwLmZE3aRk115mrG0ycyAaYyLT0ZC5/7FLDWAN1Q6e4sBDORIFBnSocuasUAJeKfCle2NFLLkXyR45A==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB5805


On 6/12/24 22:18, Dan Williams wrote:
> Christoph Hellwig wrote:
>> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
>>> alucerop@ wrote:
>>>> From: Alejandro Lucero <alucerop@amd.com>
>>>>
>>>> CXL Type 2 devices imply specific vendor drivers binding to those
>>>> devices instead of generic ones offered by CXL core like the PCI driver.
>> No, it absolutelt does not.  There is no such thing as a vendor driver
>> in Linux.
>>
>>> So I don't like this approach, there are details that are private to the
>>> CXL generic memory-expander use case, and some that are suitable for
>>> CXL.mem and CXL.cache capabilities in other drivers. That distinct
>>> subset should move to include/linux/. I.e. I want to see the incremental
>>> conversion of what 3rd party drivers need compared to the generic
>>> expander case, and consider when and where new shared infrastructure
>>> needs to be refactored.
>> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
>> that we can keep a tight control over them.
> Yeah, especially for the common pieces like CXL memory where the
> endpoint driver is responsible for registering a 'struct cxl_memdev' and
> the existing 'cxl_mem' driver just grows to accommodate device-memory
> alongside host-only memory expansion.
>
> For CXL accelerator use case that's where more specifics are needed
> because CXL.cache operation gets entangled with IOMMU / DMA mapping
> policy for ATS.

I think we all agree the central pieces should be in CXL core and other 
drivers requiring CXL setup going through such central management.

But this can be implemented as I thought and tried, and Jonathan has 
also suggested, that is an API with opaque structs, or through a more 
disjointed way from a client/driver perspective using an approach like 
auxbus. Maybe there is another approach for "keep all these drivers in 
drivers/cxl/ anyway so that we can keep a tight control over them" which 
needs to be more explicitly elaborated.

My plan is for a v2 removing the test/mock driver and adding the sfc 
driver as a client, but only if the original approach with the CXL core 
exporting functions is the approved one. If auxbus or other way is the 
way to go, it will be just a new patchset and requiring more time.



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mgamail.intel.com (mgamail.intel.com [192.198.163.9])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 167C465C
	for <linux-cxl@vger.kernel.org>; Fri, 14 Jun 2024 01:22:34 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=192.198.163.9
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718328157; cv=fail; b=Ttu7MmwgIj8T5cwh1TORZijfHd13YQA8hKytXGr9/2BHjiSl51owp/le67o5TPPBVtaR6z4/ET1EUTmRqSftRIYHYn8b9hACCHGaaSulfKPZW5dH9gMZjtPCZeY8/eugrYvfisl4x3p2gIKOhjjEyfc76N/RHCJA8uIRqXYdv3Q=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718328157; c=relaxed/simple;
	bh=jvZPCEFcyCEq90SXJSdgxtL7jv7QCwrusD7I17fKKBg=;
	h=Date:From:To:CC:Subject:Message-ID:References:Content-Type:
	 Content-Disposition:In-Reply-To:MIME-Version; b=WcLijEI/b6qR78ihTyzUAdv70rkNe5e9dNIr984RzmixSfhw5f7i7plaZeDjz8YqzW5Fq/GL7NAFjaTUrNB0jog9wnN4ofvcz0Z/tvA2O9LZlHlI2izVhDgSR5fynqyUmoh14NO3nLOn/JPPT504OvfsUcXniMkbo0DtKf/pdzw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com; spf=pass smtp.mailfrom=intel.com; dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b=Nszyj5/y; arc=fail smtp.client-ip=192.198.163.9
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=intel.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=intel.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=intel.com header.i=@intel.com header.b="Nszyj5/y"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1718328155; x=1749864155;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=jvZPCEFcyCEq90SXJSdgxtL7jv7QCwrusD7I17fKKBg=;
  b=Nszyj5/yM3QeqgltWD4K94yrd6HQOk4A/jokGFUWeF0cGg5e6ND+0T5v
   /IA7JZseV2jCrWiORrXvo2S6BnsyPTjjNe6xVhEkA3msweCEZxutEkBoo
   a3TEOrtXcPBNKQgoXOPPh1BXUKYqB4k833IQCe7RNhzKrojSBuZUZMXkO
   9CIzJbbO5OwhOtppPui3aCm/kVCnTMFC6hNUfIaish2N6nZzgBNGby37Z
   I1413NfgxWuBsFZ0pA3nBCjfIQt18KvVR8fIvS11W7dwciWIuwcrqMGwE
   Xijv7Tl7h8DgUz8bBVYEohyVVDZ0BSmw20FkKmQBYUarLqFNPFXYvCZVd
   Q==;
X-CSE-ConnectionGUID: OMkVdnLrQJOp4ytRQCGpBg==
X-CSE-MsgGUID: 5uxxpOSjTti3dHoHfQVsWA==
X-IronPort-AV: E=McAfee;i="6700,10204,11102"; a="25872623"
X-IronPort-AV: E=Sophos;i="6.08,236,1712646000"; 
   d="scan'208";a="25872623"
Received: from fmviesa005.fm.intel.com ([10.60.135.145])
  by fmvoesa103.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 13 Jun 2024 18:22:34 -0700
X-CSE-ConnectionGUID: Eu+4CtwXRYiLRWPbUfsQ/g==
X-CSE-MsgGUID: BDqR4FJrQ8qtZzD8sFtfHQ==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.08,236,1712646000"; 
   d="scan'208";a="44763994"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by fmviesa005.fm.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 13 Jun 2024 18:22:34 -0700
Received: from fmsmsx612.amr.corp.intel.com (10.18.126.92) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Thu, 13 Jun 2024 18:22:34 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx612.amr.corp.intel.com (10.18.126.92) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39; Thu, 13 Jun 2024 18:22:33 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.39 via Frontend Transport; Thu, 13 Jun 2024 18:22:33 -0700
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (104.47.57.169)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.39; Thu, 13 Jun 2024 18:22:33 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=aHJkGoxJrirNKsrEBK38sRZAkaeRpqQouEQuWCSnOAtXN012kjItOznA1nY1dgv9BsAYYgH4LfjIxbcEzDwMxFSRxuy8T7cBF9VU1M18qlT1ANXtCA2EEI2fUvSkWttPhbSi2byqXen2yIaqvzmuS+njEjiD2TyTeR+i2K2+uCGfjQORpptMF9lMfmWSmBMEf/xA6n8RTygO9Wl9bzUMv1iSvrFe8wc2v9b/2o5M4AFThp6bfeA9jgwLgg0sRATnmSkXROQo8fxwttZxDeVOoBoH+PlT1Bh4PsMs3kNrkBp6Ea0ElWS+B5F0QCcDrHWdegP6v6i/UZlz88hB+Brx8g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=bWz3m5pZhQe/c1uiXtALTblweGOk0R+4o+WG0Vx0iyY=;
 b=bt3JktWHTFqBUtFpb5sLggnOh+TiXiY04e0h6ljkEni8B0w9DDnADn9DOv+jh4jXEy6IlOY5GojkFPuonCEUJGBsGFf2QbwF+LNVBVQQP1RpaLMU4h8ersH8s3ZrwnrykMU1R9KWFM3QMxbFA/uqveXlVSgJ/BUJCDng1r3Zde/RZqN9BYHvCt9ELl3ncZKgBu2Ii5g+9NeV+sUnjV2mcDhUtLCijJrs03rEP5Pp52e1pFxJAjzJwByTAsIdBn9pk/Sjh7gp86azqAxFyk+Cy5wfk0z5HSsipxy3NbCYa+cAtmzNDxu7JaIL5y0PHURHOXjD4a+EvIJ4qPorlE9lyQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by DS0PR11MB6397.namprd11.prod.outlook.com (2603:10b6:8:ca::12) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Fri, 14 Jun
 2024 01:22:31 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::6b05:74cf:a304:ecd8%6]) with mapi id 15.20.7633.021; Fri, 14 Jun 2024
 01:22:31 +0000
Date: Thu, 13 Jun 2024 18:22:28 -0700
From: Dan Williams <dan.j.williams@intel.com>
To: Alejandro Lucero Palau <alucerop@amd.com>, Dan Williams
	<dan.j.williams@intel.com>, Christoph Hellwig <hch@infradead.org>
CC: <linux-cxl@vger.kernel.org>, <pieter.jansen-van-vuuren@amd.com>,
	<richard.hughes@amd.com>, <dinan.gunawardena@amd.com>
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Message-ID: <666b9b54d59bf_1fcf29499@dwillia2-xfh.jf.intel.com.notmuch>
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
 <666a1099c94e6_1fcf294e9@dwillia2-xfh.jf.intel.com.notmuch>
 <b51be5ca-cf7e-bd93-108f-1713e04301c3@amd.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <b51be5ca-cf7e-bd93-108f-1713e04301c3@amd.com>
X-ClientProxiedBy: MW4P220CA0015.NAMP220.PROD.OUTLOOK.COM
 (2603:10b6:303:115::20) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|DS0PR11MB6397:EE_
X-MS-Office365-Filtering-Correlation-Id: efd8c8c1-48d3-42a1-e838-08dc8c107671
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230035|1800799019|366011|376009;
X-Microsoft-Antispam-Message-Info: =?us-ascii?Q?hJicBTnRRXCHBqnPAwcLkInp23QNfK72E7/xO4SEEr6yvdm5gTmWQE4iTx5H?=
 =?us-ascii?Q?Z/M0vaPI8yXZNpdjRzDwaCg0my/fJMg5V8yJZbc+rccKkHnovjTEJ9HxYrnI?=
 =?us-ascii?Q?sKgc/xlKXgGAgu8sLHIHxargugT/VCoQc0l117/uSLHhJb9hM0AEUQh4eY0P?=
 =?us-ascii?Q?f0ZXZmTW0gWEm148Z1gQ4LLVNa4bgBFNdj+/Iv2lNVFpWP/YFKi8r394A/mO?=
 =?us-ascii?Q?zEWPhqptaGXdS7POGFXAW1i7bHaRtyIYa0n+bNuQKw3Gg40rcDbUQTIUmqdS?=
 =?us-ascii?Q?PtpKrOib9RpJ7su4ni4OOxA+HmD8VL7MMJxxoX2MNBKywmmWqGy0ZOjn8PAI?=
 =?us-ascii?Q?2Ep6tnkJSiSvXHIjnK/zYqskO81a7LGBIGi00HyvbWbQUPMPZxvM2Djj6pOw?=
 =?us-ascii?Q?U9rWSn8tn5JI1X0njLhrGfBJreS59TSDAnLm0SBjPxKnewpZ6n6wyIRznvDl?=
 =?us-ascii?Q?4JHp4nhMmAOBbh6WypjUl3xM7ZfkQLKieAkFJKw93eV78pzB/HyrWX3qvy+w?=
 =?us-ascii?Q?IJzv56QK4UtN30NnUPhW06G2QG9+h6CO0ab4dqjc4ak39Rjpl+7O9v0udWbc?=
 =?us-ascii?Q?gwDibyfLhsxB/42Pgzc4HUij2Z4bQ9Hm3jr6SER4wCzY0wjSNvM7mZkZFdsm?=
 =?us-ascii?Q?LTn1bp85wvt9KsOMCVR7WLqjimYsvTNWkuq2lfOMrOpaZIb0IrFGUKzM7lHZ?=
 =?us-ascii?Q?YSe2rEXJkXquS29OqnHHXdDdbOoP2c+pJC0n8Mo6h6+M6z0AtEKNj5PwEZLU?=
 =?us-ascii?Q?mQSTHg+ORGXatMc+eozikEsai5wBS0CmpjoRZoWU6KC8TB1vo1m22hE2vKbv?=
 =?us-ascii?Q?DXFnODOATMHERmTos7qEfj4IPb+q3Rx662IoJkseGoI31sSftyT5hZR5IHm1?=
 =?us-ascii?Q?BrDXyap63dY2SZbioJEPvdj4W7ZSPLFa8ewkYaQ80FmyfbePs6aRfuE1J25/?=
 =?us-ascii?Q?Co1QSmmyIEd0yHbSVVrK24N4JynjAwyIO3xJBo3z5e6j2xLRgpQPKG9Kw1Zg?=
 =?us-ascii?Q?akgmo31O4RmheJoMgdOD5DB0Xf5dwzlpo+i3TlgSu7uAvns+rn6MdynVmjvk?=
 =?us-ascii?Q?2Kbz/mdyzw0BLX53S7SrbDXIRZ3ubqa1hkiM55ZLh82olHDmovkm8zAwdMf3?=
 =?us-ascii?Q?S1xaghCmt8D2+dh2jCVX5OWcyXstmSiOR3toCC1VAiji/zsqiAsPP+LC+cAx?=
 =?us-ascii?Q?zo/dcJ4q9+EGA7eDWOS3jtUMNRrrYxW55yMg3oFuvJ0OwlWZQCIogatAFlvN?=
 =?us-ascii?Q?vamCZY0vf6l178lNAtQ63Q/f9h9QCaVU4lTbafygE+tITQfFmeu2+BfCVxeC?=
 =?us-ascii?Q?ImWsGGV2fI8LCnsTAVnQ48+g?=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230035)(1800799019)(366011)(376009);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?/R1Uw1noK1fua4QP9Br8EpHxrZkL5Jr3AEDeyoQLrgjs2K6M3wekKte1WVKA?=
 =?us-ascii?Q?VsT1RLk8sp+T5RMPJvVIHCVVkdH4rcHlhxZXgbZH/kKLPw1NI2CKnc1vkO5k?=
 =?us-ascii?Q?t7gN2HfADdyroKjZc/JWqi/K1ZQZg2yg/oTVViqdkSItxcNZZ1rZVWMFwmmU?=
 =?us-ascii?Q?BPYeyopQF414qhhINAhzAhDyB6uTw9XcNMl4dxmdwaGPrikgmUDFZGEesE6U?=
 =?us-ascii?Q?z8R7CMaoOuYv07x5bwCc5LHYoWNnJTm5w8x5QDyc7FHb4myV3GDiA7TnOUkP?=
 =?us-ascii?Q?Gq2S6664zIeh4q7eA7YW4HeWJexLun5bCTFLRL3S8sUpogiQLhZ4ysqdlOB4?=
 =?us-ascii?Q?Fj1iuRFTlC/nj/+9XBAkaWdawZUHmoTjIJMXDA9FjP7Rmo7mxtUahFEMN1EA?=
 =?us-ascii?Q?TOrYyCt90H1OuFHf5rAyZZWOJqBuSZzT+g73+AIExh8Co8V31ztK7cPaV8gN?=
 =?us-ascii?Q?9JvfFVp/tn5FfI+IqG8i+1ItZgPVvBAqT292RahanyukEcVCUoKKAVjCaiEm?=
 =?us-ascii?Q?RGOMotvbMFr6X3mWTIk33TU2xmg7lQlfKm2zqWzOzFx+TllVucNafHG5N5Lx?=
 =?us-ascii?Q?nTvbasMio34idq3YcUs7ymwjSHZEXnbsa4bkiTG6PbTcxHqjhn3FX7a2h2mp?=
 =?us-ascii?Q?AyWpa3D2owXdRCaQWp+p/LREyYuATF7NCl5DlQaguoFNQvOSBqlCjAjgTIIz?=
 =?us-ascii?Q?i/jklvVlF9s4FzHi44qTXzsuLQ65CNtjOVE9QHxsJ3pDy1iPWYWBxGGwyxyL?=
 =?us-ascii?Q?Y7lHa1MIzo7W/4ZVrftGegcZk7Ot7uiXN0WUnK979qYOl8F/j6awlvkV2t/D?=
 =?us-ascii?Q?Faei1b/Y2oYBiG395uD0qPOfbzdP714bb8v9FDE8lxvoNAEQmK/ac6Nj6QWs?=
 =?us-ascii?Q?rbJm5MqzWRT75wU0YKWzTX05MX4jktwUTRCdxQzeyIkeV0XltuG3Wsaye1RC?=
 =?us-ascii?Q?XGhEMq2MqJs73O5t1bVrPF0DFROuGC1QvV293D9kzHhVslw3z009V7oUZGah?=
 =?us-ascii?Q?10bgg9tM8s1sWYH4+7p59g5TGrkI7q8KVdHF3sbD2p/iOBTqQ0HCVeLDhJ0Z?=
 =?us-ascii?Q?hSxDoIj06lPOwcd0su/RZIkdKosq4ACzuOzFhtEKsfmtTK2wzLzcg4GhkEjF?=
 =?us-ascii?Q?7C9xRdf7tnxe/bJHRJBygSMxIcBY15iJhYwPv1UOnZKCxMNPYsz0kDn28/B+?=
 =?us-ascii?Q?+/5PwfaWE4RW7lThHBcFEZAYnj0vUdFREtxHSSzuGIjPSmtMOjlSsF18kWd5?=
 =?us-ascii?Q?xbX5NTRH5Ygyd6T746m28XqScFLPUgDZKrrNWYef2+QnyH9pZ8Cp81j/hZIy?=
 =?us-ascii?Q?fp0WDmIeTL4jjgAYQ/r+j/Y8bg1hiikU07jBNn4KsWtWTMdHB4pTq9yerafQ?=
 =?us-ascii?Q?CcBixYJkEbmzc1d3eDs021a+uSj3BfS/jnBiFIhz1Bfi6sk/x1uaIeU+1q4Z?=
 =?us-ascii?Q?65RG2vrGC0QlzLrwd30pV5URdVpyu9zfPHXNysI82++WNwIeKL3Y0Wp/KsjF?=
 =?us-ascii?Q?JjYiwYu+MdXeWfezlzgxJLUA6TsXWtk0J6jV/U3OEPBENqUfAY0xXZcbUXPI?=
 =?us-ascii?Q?Nko1a5rejJbyrXO9ysR+/Xfx1L6oq0QEoOqqgtgC7yDhCSyOrJ42s9AkUUZ/?=
 =?us-ascii?Q?zQ=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: efd8c8c1-48d3-42a1-e838-08dc8c107671
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Jun 2024 01:22:31.5398
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: DbwIoyVjUoQ2k9vr8gDCUPr5CETPzAL4KRwCvgRpa2zYoqopG6WHDXqlV6SkVlhBl51zKT382bsyXjKBWvMClIhAbSwTjzdwVYiHapsPiEs=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR11MB6397
X-OriginatorOrg: intel.com

Alejandro Lucero Palau wrote:
[..]
> On 6/12/24 22:18, Dan Williams wrote:
> > Christoph Hellwig wrote:
> >> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
> >>> alucerop@ wrote:
> >>>> From: Alejandro Lucero <alucerop@amd.com>
> >>>>
> >>>> CXL Type 2 devices imply specific vendor drivers binding to those
> >>>> devices instead of generic ones offered by CXL core like the PCI driver.
> >> No, it absolutelt does not.  There is no such thing as a vendor driver
> >> in Linux.
> >>
> >>> So I don't like this approach, there are details that are private to the
> >>> CXL generic memory-expander use case, and some that are suitable for
> >>> CXL.mem and CXL.cache capabilities in other drivers. That distinct
> >>> subset should move to include/linux/. I.e. I want to see the incremental
> >>> conversion of what 3rd party drivers need compared to the generic
> >>> expander case, and consider when and where new shared infrastructure
> >>> needs to be refactored.
> >> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
> >> that we can keep a tight control over them.
> > Yeah, especially for the common pieces like CXL memory where the
> > endpoint driver is responsible for registering a 'struct cxl_memdev' and
> > the existing 'cxl_mem' driver just grows to accommodate device-memory
> > alongside host-only memory expansion.
> >
> > For CXL accelerator use case that's where more specifics are needed
> > because CXL.cache operation gets entangled with IOMMU / DMA mapping
> > policy for ATS.
> 
> I think we all agree the central pieces should be in CXL core and other 
> drivers requiring CXL setup going through such central management.
> 
> But this can be implemented as I thought and tried

Like I said earlier, start by minimizing the definitions to just what is
needed as that may trip over things that need to be refactored.

For example, we had a similar conversation about how to support the CXL
mailbox which appears to be showing up in more than just generic CXL
memory expanders. In that case the observation is that all the APIs that
currently assume a 'struct cxl_memdev_state *' probably need to be
refactored into something that takes a new 'struct cxl_mbox *'.

> and Jonathan has also suggested, that is an API with opaque structs,

Opaque structs is even nicer, but first step is "don't make the entirety
of the current definitions public" because that violates 'least
privilege' for many of these structures. 

> or through a more disjointed way from a client/driver perspective
> using an approach like auxbus.

What? No, I see no need for auxbus. "cxl" is already a bus.

> Maybe there is another approach for "keep all these drivers in
> drivers/cxl/ anyway so that we can keep a tight control over them"
> which needs to be more explicitly elaborated.

For now lets interpret that to mean that any driver that wants to
enumerate or provision a topology of CXL HDM decoders should be looking
to register a 'struct cxl_memdev' object which is driven by the cxl_mem
driver in drivers/cxl/. The client driver that registers that need not be
located in drivers/cxl/.

> My plan is for a v2 removing the test/mock driver and adding the sfc 
> driver as a client,

Oh, as in CONFIG_SFC? Can you say anything about the use case for
CXL.cache and CXL.mem so that we make sure the code architecture lines
are being drawn at the right level?

> but only if the original approach with the CXL core 
> exporting functions is the approved one.

Not sure what you mean here? Exporting common CXL core functions is how
the cxl_mem driver itself gets enabled. So there is no other path
besides refactoring the core to be useful outside of the general memory
expansion use case. This is analogous to how the PCI core provides
infrastructure for PCI drivers.

> If auxbus or other way is the way to go, it will be just a new
> patchset and requiring more time.

Mainline has the time to get it right.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2078.outbound.protection.outlook.com [40.107.237.78])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3A96D14B940
	for <linux-cxl@vger.kernel.org>; Fri, 14 Jun 2024 08:54:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.78
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1718355296; cv=fail; b=NAO6hASHQLrQhrED7QiCbV6yi5OzrBFIbVmu/pX39xi029zcr9FdOIXqhw/HI/84PMrBcDgqLyuNclKjm+vEMLxbmrctfqUm1QFuvrH3ABKLp1ocl2eXwswisPeRPq50jGR+uAJ39favI9YFNow3GtqV+L3Wpn7sJMzexe03IJg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1718355296; c=relaxed/simple;
	bh=+PqjbMfRKQ8JKP1QOa+ZLLmR7C09c5NgZssrKSckWnc=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=IH+LJWCjHfSkagHpBxiQCg7N6G9kabzOcGI9tsbLX1yXVQ1x/y89zVTogJq/UXxkf3n/V0kfhUVrFDXiaawjR7I3AdzcpsqgqnXYaDH6wXXRzVKs1f4PyzkZ3t8ob6aBwjNHlLzbRscUm0UWpJZqTtMx06Yq1OzYCff4bAsYp8o=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=EFM2SS5r; arc=fail smtp.client-ip=40.107.237.78
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="EFM2SS5r"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=cyw7Q/Kn8tRmW4CxhuML6NSwVJG7vb07RbGpbhHDrP2OUALSNULJarqU9cRIPUph8a1QBFu3STFdG/h9pqTVFtE8yplva/AXiEDMNxJOBLj5J4C/NT07BFgxaW4OIjRSsQTMjd1bWmwtl/N7grsS21CobnaiK4ZAU5n+/t8XKMMZWe6hV/qu4etRooj0NdMZz5WXoNA7k/vGqHqCIpG420HUg31ysSQyjIGcKKY9BlzHgMPdg+KwX0H4HA0aWUrBJ9tSk7mQi0+qUj+3MW4QAOhWg8PUaZiqgfxqC9KCyFVGnHO00yQovoLKqGFUocDKonJZyAJlLUvxow9vPtFFiw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=jRWoUpRjqoQAFQx7D3gIKdLW1e1jPjSvV7wIfnFB4lw=;
 b=au2a2ACDlA4cjbeXDD79oNXkvDZc6YJ7rX9TKwuPWIQPhH9InMTRhU4WL1vkIJKrRHNriIHf7GYz86uFwI4IYLUB305FFTA5ent8hT6qM+FQlEUbz87JJddYCB2HqF+47OQE4gnglx0i/mT3ZFQsf5ENUImndAmXHlYem9cwCC5rcUZxU4QgeuSaYTYUDQe8pxgA/Zt++LWPQ/cVRhC007vXxMnBWSjnmVNMAJnvRgAYvebxsRtTjshGe+QgrCP1EC6YGHD+JGk2C5FzTjqJBms7cjyHy66Ll8n/Vn2qcLI+ysuWWtAbcZTkoOOQ+CeKGEHl1Zb5CE/EM+oj2ZSrSg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jRWoUpRjqoQAFQx7D3gIKdLW1e1jPjSvV7wIfnFB4lw=;
 b=EFM2SS5rLXDI2tWwQaX+UNi8hFMR5ppOj6KPjfIsw8mLuwBdPA3Zc8ik+kpb6caZ8ALnGb/SLDk622hQzMj/fXiWoCe5mOGxUqgLT4wJHhQ2HacayVicG4SS7XYZkaPHw2meogtHBTAZyigRdncYgj8Prpfz6gFIUfElxN/u08Y=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DM6PR12MB4202.namprd12.prod.outlook.com (2603:10b6:5:219::22)
 by SA1PR12MB6703.namprd12.prod.outlook.com (2603:10b6:806:253::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7633.37; Fri, 14 Jun
 2024 08:54:51 +0000
Received: from DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79]) by DM6PR12MB4202.namprd12.prod.outlook.com
 ([fe80::f943:600c:2558:af79%6]) with mapi id 15.20.7677.024; Fri, 14 Jun 2024
 08:54:51 +0000
Message-ID: <c31ef5fe-43ac-f83a-d4a3-90982e2c9ff6@amd.com>
Date: Fri, 14 Jun 2024 09:54:46 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.11.0
Subject: Re: [RFC PATCH 01/13] cxl: move header files for absolute references
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>,
 Christoph Hellwig <hch@infradead.org>
Cc: linux-cxl@vger.kernel.org, pieter.jansen-van-vuuren@amd.com,
 richard.hughes@amd.com, dinan.gunawardena@amd.com
References: <20240516081202.27023-1-alucerop@amd.com>
 <20240516081202.27023-2-alucerop@amd.com>
 <666923ba32ac7_3101294dc@dwillia2-xfh.jf.intel.com.notmuch>
 <ZmkkaOTUFuzIr2cG@infradead.org>
 <666a1099c94e6_1fcf294e9@dwillia2-xfh.jf.intel.com.notmuch>
 <b51be5ca-cf7e-bd93-108f-1713e04301c3@amd.com>
 <666b9b54d59bf_1fcf29499@dwillia2-xfh.jf.intel.com.notmuch>
From: Alejandro Lucero Palau <alucerop@amd.com>
In-Reply-To: <666b9b54d59bf_1fcf29499@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: LO2P265CA0427.GBRP265.PROD.OUTLOOK.COM
 (2603:10a6:600:a0::31) To DM6PR12MB4202.namprd12.prod.outlook.com
 (2603:10b6:5:219::22)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DM6PR12MB4202:EE_|SA1PR12MB6703:EE_
X-MS-Office365-Filtering-Correlation-Id: f4ba4e3e-acbc-4bcc-dead-08dc8c4fa6e8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230035|376009|1800799019|366011;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?SnZKZE5QSjh0RlFnZFVXT1BKM3NkRjJXczFlRmFzSTJlTVUydFplMjZWTmJL?=
 =?utf-8?B?TXppV3FqVXhncmhaRTA2azNRYkFEdkc3TFlUTHljWWoxWGVFVnZnaFNkQ1dK?=
 =?utf-8?B?Y1dQdnFoY0hrYlV6czZidmw4LzEzcjhhZ0c2RFFCQXpPclZ2b2dCOUVabXZL?=
 =?utf-8?B?dVRhd1YxV1dNM0lSMTZHVVJ0S1dpdlllVVk5MmJBVXJsL1EzWG9tS0p6NjVT?=
 =?utf-8?B?WnFGWmZueVFpdDZ4a1BnUDZwU2MvcnZ3S0gydUZ5OHlmd0M0UGdVUDF4NGt5?=
 =?utf-8?B?SXRENVpWYXRXNy90dWQrZ1FEamFwZ0pJTXFTZkhvdXdScDVlM00xY3ZWUUgw?=
 =?utf-8?B?SGFhUi9YSG80NnNoTFA5MHZVSDNtUlBmbzBQdTA1a29SRkliRVF1R0kvU2VV?=
 =?utf-8?B?UkpBUlFJYldmQ3hmSlFzOEY4RXpBUXdKL0tXTm1ZcEpIR25QVGVKcjRFUldF?=
 =?utf-8?B?dVNlVis3dytwdCtQQjlHQjVDc3RCVS9FS0I2UUtnRFBQcDk3Z3N3Y2dyZjRS?=
 =?utf-8?B?S3NmUE5SR2JveHpiK1ZRSkRoNlp2dnlGMnBlRE9Ub0RwaXdQWm55Tko5aTF1?=
 =?utf-8?B?UVRtT1JSWmJ2NDhPOE9CQzNxMVhKcGhodFE1QUtITDkvaUxUZnVyVEhyTHFw?=
 =?utf-8?B?MTduOVpJVGFXVEdXR0s5NU1jeGlkZ0FlaW03MG5za2ZhM3hwZFQ0WG1id1NH?=
 =?utf-8?B?VStYdlpSVHAwLzVRSndndkdJakw2NEorVlZNWGNEdE1iL2FtOURJNWk2WnVy?=
 =?utf-8?B?aGhYbG1zNmlsbkRXT3dDWWd4NnV6emdmQVorck9DdDRqMUdhL2FXbk1zb3Br?=
 =?utf-8?B?dll5bFZMd0lVVHJJdzlrU2FLekxLR3RER25aT1JzMi93c0JYWVZ1N29CSmY4?=
 =?utf-8?B?WHdSL241RlN5RUN2UnpmTy9NUHBBWm1kbVFWc1hVQTZXcUhvdnNvVmNMdGJR?=
 =?utf-8?B?MXJKOEZ4aXBEbEkvcC9va2s1bUc2cFVmdnJnRTNQa2NMWDJad2FNdm5rbk5I?=
 =?utf-8?B?NmppRnBnL055dGY3UUJVNUxmTUQrdU45a2FkaTNxZ2tFZTM4MHlBNkNjN01z?=
 =?utf-8?B?VzlESU1SOW1GbmdlU0RFTFFYN2pneXl2WVE0LzNCOXBOMlBRbU1maVY2UlRC?=
 =?utf-8?B?ZzNNT0sxaW4xRDFadExZWWU1WHJqMGIyWDVkUGVEK2lpUW10eU1FVVU4SnA0?=
 =?utf-8?B?RktYeDRvMi9iaUMxQldDVFgvaHZTR2UrUnBtNWtwVS9BOTE0aitYQjdodnB0?=
 =?utf-8?B?djlhZVFNc1ByMWF0ekI5QkJ6bHUxMTMzS0ZVdXMyYS96cHZkZVRJV1B1OVJw?=
 =?utf-8?B?cFpTSS8vNTJVU1cyZWpKenJMSklqb240V0NvZzRuRlJTV1dGRTBvRTlKVUlC?=
 =?utf-8?B?NTN1Yll1bERwSEtLYVVvQVhzWERGbWNka0wxOVp3Q1pZeVAwRTdNc1dmdkNN?=
 =?utf-8?B?TGZVbTViNDE0dmFNMG8za201T1lIeHk1Q25OZmZIaEt2NzQwTWRzQ3dzMTBx?=
 =?utf-8?B?RnVDODJ1VG5xM3lOMGxXVEVhTlNsMlpwcDQvRWtrM0tJYkRUTDJhZjI3K0t1?=
 =?utf-8?B?U1d0QkQxa09UQVJ6UnZuTXhhMGJsQTRDVWU3MDgwalM1eE8zVUN6MElqZHdw?=
 =?utf-8?B?cDhZUGdreURoZklRMDBNNXNJM05aTHBPZ2JlQ2NoRTRURjlYVU1nenJqWC9E?=
 =?utf-8?B?MUV0RmhNS1FKNHY0cVl2WEhHWEU3SEtZVWhscHdKTEU0SXMra1o5NlFFL1Nz?=
 =?utf-8?Q?1SSRm4E4ZLPE8wHVat5024Ga+JyAerl+kMADFyg?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB4202.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230035)(376009)(1800799019)(366011);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?akUwTlNkNktjc2Uzd0lwTmhNYmlOWW5TMkltWUI5WjZMNlRhTjhqSmRBdkxh?=
 =?utf-8?B?UlViSEVQVnZBek5rOHlKRE5waU13UjBOOUJsRzkvVGRGVFB4OGRiVkxQeHk5?=
 =?utf-8?B?Y2lWRDI4RmdlSUNDVG9vR09qeVNqWXd3aDZjYU01MjlwMjN1Y09hLzVHUlcz?=
 =?utf-8?B?Uk5ieTE0cHQ5RmJxRzl5N092RFROaTRDT3BkNGl2RnQ1WGl1K1RQcXIzOHBn?=
 =?utf-8?B?YUVCQlI0Nk5rVXBUem1EeUV2S1FLc24vT2NoalVvYjJoNUpmZGEzdE5LaUtx?=
 =?utf-8?B?d2xYTFIyYXRoNGVhMTNtK0lJVVJ0aGZGOE5Ndk1YTm1YTGg4ZHF4d0JGR2Zp?=
 =?utf-8?B?WE1LMWNDTTRyWmduaEVkYUN3d0VFcEJra0ZkYm0wdmlRa29MMERqRzYvSXlW?=
 =?utf-8?B?SmdHQ0o5NExiSEFTUnROK1RKZFJxUTRJdDZNVkVtS2pJS0ZrRHl0RVQvZ0ZG?=
 =?utf-8?B?a2RqWjNHaEk0WnBoNUdLSHBnTXB2OVdySTVYOGFGdDAwS2NyQkRiNlRVMGQ5?=
 =?utf-8?B?ZU9HdEQxWWxXbDhCOG5mWW5FclRaYmN3bUc5cU85T1ZqaFFNNUh4aEVFVDVp?=
 =?utf-8?B?d1BPY2EveWM1Vm9IbkRrTzBNZ1ZqcDNna082RFkzZ3pPRllkL0NKUFo1ZTIy?=
 =?utf-8?B?VzQzVmxwVVM1MGt1T0NHV1Z0UWVySlFvMHJUWkE4QkM1STVUTGtLcC9PaUxC?=
 =?utf-8?B?N0Q2czhGRUpON2F2WVJKN1BnVEU0ZGlvNlpxWXRVZkdaZEpkMHhRNFRMbnk5?=
 =?utf-8?B?WUtETHpDQzl2U1crekViYWthZlY0SkIvN2J6djZNWGdjQVVrT3FWb2Fwa2Jk?=
 =?utf-8?B?UHRxU0VOcFFKODBFZ3RGSDRIdFJ2a21HRUI3WStudmFLSWpReGpsbDRYQUp6?=
 =?utf-8?B?ZW0zQ3pmdlFIaUlwdFlxNzd4NlNoSFJ1VHNkajhvdlZmTG1pa1B3S2l6Q0o0?=
 =?utf-8?B?RmppQ3pqS21tYTJTcGtUVkIwVmZKVUlLOWZRU1FOcGlmbm4wNVVRWUl2VVpG?=
 =?utf-8?B?Tk9xWS9sZEFRdmFnOXdtaFZQZWJUbkY4UTEvc21iaEFaQVBUbHNua3RjTVFM?=
 =?utf-8?B?cjdEV25rNFljTXE0Z2xwbi9zK1pPU29WbEZweVk3enBKTm5nVW5rOUxWeVZq?=
 =?utf-8?B?a2JTeUtJRjFrMnFlTFc2ZzhHR3dnN3RTMjZxcW92K21DYVBuSVBHUStsU2ph?=
 =?utf-8?B?SUJhcWtXc2t5cDZBV251a1ZjQkZoYmJWWmVLYWNRZENHRStrOFB6cklwQmxu?=
 =?utf-8?B?aVRsaWRvbXZkcEFhQTc3dm56RWI4Q2piVStqNmFOOXkyb245NC9CZjFvOW1F?=
 =?utf-8?B?aTRURnAzaXZMUDRTeU9ibm1FTXM3bWtnUFh6elppQzE5YjFoM1BNdXdoVUtR?=
 =?utf-8?B?WWNNdVZPWG5NczIrUllDT1ppb1FUUzE4NldIb3hSTjZGb1FibldFNDQ5by9O?=
 =?utf-8?B?dDRVUExsMjQ3RG9zN0pWRHo4ZThLYXBHa0tBUVQyV0twSnJZN0hGUC9FdDJC?=
 =?utf-8?B?b3Bra3V0cllCZU9UZDRuS0RtcjNzQ09GaVNtYm01M3JCcERHaS9obEw0K09J?=
 =?utf-8?B?NlQ4VGYrQVFETzFaL0hyaW9WWW5BcTVOV1plS0s0czZldGQ4eXJQU3VxaXhr?=
 =?utf-8?B?Y1R4cnFQaDdkM2tncEhBZElCbitYcWpsK0g4bnZRdHhNSzdBQlJ1M3NjN2VB?=
 =?utf-8?B?ZzNncWN6K0p2M0hEdHlLYnZGdlZpejRQTUhkZ05aY3p6KzJpQUhrWUxjWERS?=
 =?utf-8?B?V1lScTduVWJrRUU1MnNYYVFhY3ZZc0pIWGFMUXZFZHByUFBOVTlVTFh4L1l3?=
 =?utf-8?B?eVd2Q1YvZG1aTGw1MjkzbURHV2MyVzdub29lSHp2WUhzby9rL2FXdDNzY0Ru?=
 =?utf-8?B?djNQMC9ZMzRmUkZBbHNBWkdmRGNlbjZTdURWY0VoQ0REb0NjYjU5eExGVi8r?=
 =?utf-8?B?ZmhERENMSm9HOGFVVHZXb0Q1emdrVkV1MmJXdjVvQWtoZStjME9GVGF6U0ls?=
 =?utf-8?B?RmN5RHZwWGF1aEVVMTk3V3BrR1Z4bWxxaS8yVlBlSkZtMy9zWFQwMlVNeXp2?=
 =?utf-8?B?YmZEbDBzRTNZUDF0MlYvZ3NEVkt2andGRVpqTy83d0tGZGhQMUM1SWVXK1V4?=
 =?utf-8?Q?VpQ7PbbxI0WeUnKxhTEMb+79o?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: f4ba4e3e-acbc-4bcc-dead-08dc8c4fa6e8
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB4202.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Jun 2024 08:54:51.2773
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: GsKOJ93MAT8j2i0Y5cOuwlElR2OX2NJXKOgas+XSGXvJvsRotsug2j5L+Z5JCWSoxQ3Xc7rdzVe9XcNc2xCUbQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB6703


On 6/14/24 02:22, Dan Williams wrote:
> Alejandro Lucero Palau wrote:
> [..]
>> On 6/12/24 22:18, Dan Williams wrote:
>>> Christoph Hellwig wrote:
>>>> On Tue, Jun 11, 2024 at 09:27:38PM -0700, Dan Williams wrote:
>>>>> alucerop@ wrote:
>>>>>> From: Alejandro Lucero <alucerop@amd.com>
>>>>>>
>>>>>> CXL Type 2 devices imply specific vendor drivers binding to those
>>>>>> devices instead of generic ones offered by CXL core like the PCI driver.
>>>> No, it absolutelt does not.  There is no such thing as a vendor driver
>>>> in Linux.
>>>>
>>>>> So I don't like this approach, there are details that are private to the
>>>>> CXL generic memory-expander use case, and some that are suitable for
>>>>> CXL.mem and CXL.cache capabilities in other drivers. That distinct
>>>>> subset should move to include/linux/. I.e. I want to see the incremental
>>>>> conversion of what 3rd party drivers need compared to the generic
>>>>> expander case, and consider when and where new shared infrastructure
>>>>> needs to be refactored.
>>>> And I'd much rather keep all these drivers in drivers/cxl/ anyway so
>>>> that we can keep a tight control over them.
>>> Yeah, especially for the common pieces like CXL memory where the
>>> endpoint driver is responsible for registering a 'struct cxl_memdev' and
>>> the existing 'cxl_mem' driver just grows to accommodate device-memory
>>> alongside host-only memory expansion.
>>>
>>> For CXL accelerator use case that's where more specifics are needed
>>> because CXL.cache operation gets entangled with IOMMU / DMA mapping
>>> policy for ATS.
>> I think we all agree the central pieces should be in CXL core and other
>> drivers requiring CXL setup going through such central management.
>>
>> But this can be implemented as I thought and tried
> Like I said earlier, start by minimizing the definitions to just what is
> needed as that may trip over things that need to be refactored.


Yes, I agree the headers treatment in the patch was too much coarse 
work. I'll work on that for v2.


> For example, we had a similar conversation about how to support the CXL
> mailbox which appears to be showing up in more than just generic CXL
> memory expanders. In that case the observation is that all the APIs that
> currently assume a 'struct cxl_memdev_state *' probably need to be
> refactored into something that takes a new 'struct cxl_mbox *'.
>
>> and Jonathan has also suggested, that is an API with opaque structs,
> Opaque structs is even nicer, but first step is "don't make the entirety
> of the current definitions public" because that violates 'least
> privilege' for many of these structures.
>
>> or through a more disjointed way from a client/driver perspective
>> using an approach like auxbus.
> What? No, I see no need for auxbus. "cxl" is already a bus.
>> Maybe there is another approach for "keep all these drivers in
>> drivers/cxl/ anyway so that we can keep a tight control over them"
>> which needs to be more explicitly elaborated.
> For now lets interpret that to mean that any driver that wants to
> enumerate or provision a topology of CXL HDM decoders should be looking
> to register a 'struct cxl_memdev' object which is driven by the cxl_mem
> driver in drivers/cxl/. The client driver that registers that need not be
> located in drivers/cxl/.


Great. This needed clarification after your previous email.


>> My plan is for a v2 removing the test/mock driver and adding the sfc
>> driver as a client,
> Oh, as in CONFIG_SFC? Can you say anything about the use case for
> CXL.cache and CXL.mem so that we make sure the code architecture lines
> are being drawn at the right level?


I did briefly comment on that in the cover-letter discussion exchange.

We got some hardware buffers now mapped from BAR regions which are 
written by the driver for low latency sending versus descriptor + packet 
through DMA.

The idea is those buffers being CXL.mem mappings now.

CXL.cache will be for receiving. It will not be part of the first 
products though.


>> but only if the original approach with the CXL core
>> exporting functions is the approved one.
> Not sure what you mean here? Exporting common CXL core functions is how
> the cxl_mem driver itself gets enabled. So there is no other path
> besides refactoring the core to be useful outside of the general memory
> expansion use case. This is analogous to how the PCI core provides
> infrastructure for PCI drivers.


OK. This is all related to that comment/suggestion for keeping all CXL 
capable drivers in the CXL core directory.

The only way I could envision such an approach was through a driver 
creating auxiliary devices for CXL.mem and CXL.cache which could bind to 
generic CXL drivers (with the appropriate support in current CXL core). 
Doable but probably too much complicated.


I think it is all clear now.

Thanks


>> If auxbus or other way is the way to go, it will be just a new
>> patchset and requiring more time.
> Mainline has the time to get it right.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2047.outbound.protection.outlook.com [40.107.244.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AC55D4501A
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:22 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.47
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847144; cv=fail; b=npoZaXA5xHdi1mLzFscDHsGhzEhw/12W03aKnzyBwnzCaD7QUSElofttp0jTAVuaWzV3zD2FohZeRDMFwEeuUW/2JDQnkGDqw1aeLDIpjG88WDcz/hlr8y7dzPy3xHsjiOK+cxeYqCEr4mz1bBzwWfIU9XyRGn0IrDf34ZGC4vU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847144; c=relaxed/simple;
	bh=L5rwcxq52DZ3HDIhUpczRoEvzlwd1NSz/hjMxDj3k/M=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=jSxakXtYh0E4vS6jOLw4JBvRsKl/mxzzl9tFhgPQaOmnmZJ29QvJbEcqdthflDyRoJo0nAEJseDyt/Zjgre62Ft11m3l0/CVxk+ZevwwS/JgPFi7fxxlhD2gwG8SO6heq+aCA0x9HrRd0LulTIEwuWrcSIEOnhmqYiwJy9Jcr7k=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=wlljCLm1; arc=fail smtp.client-ip=40.107.244.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="wlljCLm1"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=O0uXkOojw49ySKWO9VhAr1oIHgnylg81vHXpndYYtM8mUg7wbjAOfXdZehPswM133ObtLg2JYS1OJlAHdB0H4DqZhps8QQ/4IjH48Rr2RxePgNdys5lfn1fUeTWiQKRLS1RMKo1+edPJAa29mxXYhxhdCZx5uhNJcHws7yZNbxM1ix9ijj/edN5ajhxVZVPPhNP5n8WnXnSYzynDHr3J9IFwbLI+BmjGC3/+y8TZmKq3OibwIf8Y9hgUdFhnZPYCVGNNnp31VX9S8r/8pFewkUCDAm7G0LlEhihVWzn94fS5BkQSo2YxlKFZlUbnjS8xssGFkdunf3IfHeCSmQf7rg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xI3sEr7+yzoRDOIhf+MrXn9VbK74X4PZKXx3JCtBwJ8=;
 b=KKDxXSqmFuVv8yLr5hKqOr2wMFoZ2A8dCPLLljQ+tw24fpfFqkIwqKNapHFrZsynAEkyWVytTZGwMdd9eZeNn8r2dKIaGLdTygFP6po6+CNFqsjn9bsL8HONz6pn/e54hCGJrDEQlsF6sZo2zE2qkKdWWh9FBIVM4zj2vNd2WvRwZN02ddu13TkwIV9rwAVIPl6zuaJebfSt9mmhQYE7mTbQM+ZYSYnjsQOh1fie9pr7iD2WXlkNPQQX7SVT0Nq85g8ub6mDihI9ImHFBe0/53NcccCbIHR5rjhwJdSOcP+z80QSpjo8tslehW6EYm3+u83jGHRiwO1p5x0IIr+8mw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=xI3sEr7+yzoRDOIhf+MrXn9VbK74X4PZKXx3JCtBwJ8=;
 b=wlljCLm1ngRdgUoGqS/Z5UYYs84jhUYMU2ZjBrwXMlJTkimrp2mz5Jlx0h9+0+yVsB09as5HycxTY6ph6Z8I4jTfpE2dU8DLutR6BZbCcrHUWeIuX8aIjCg1Y0RTVjKYIFZXrPUrP1kSe2LAWj4dWDNiK1/4ORgs5xrBScA0jB8=
Received: from BN8PR04CA0031.namprd04.prod.outlook.com (2603:10b6:408:70::44)
 by SJ0PR12MB5675.namprd12.prod.outlook.com (2603:10b6:a03:42d::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Thu, 16 May
 2024 08:12:20 +0000
Received: from BN2PEPF000044A7.namprd04.prod.outlook.com
 (2603:10b6:408:70:cafe::57) by BN8PR04CA0031.outlook.office365.com
 (2603:10b6:408:70::44) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.27 via Frontend
 Transport; Thu, 16 May 2024 08:12:19 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A7.mail.protection.outlook.com (10.167.243.101) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:19 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:19 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:18 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 03/13] cxl: export core function for type2 devices
Date: Thu, 16 May 2024 09:11:52 +0100
Message-ID: <20240516081202.27023-4-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A7:EE_|SJ0PR12MB5675:EE_
X-MS-Office365-Filtering-Correlation-Id: 6bf35c2a-2ab9-46dd-120a-08dc757fe848
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|36860700004|376005|1800799015|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?nWLAn1ZpnveOIHZqBqdlG/lqB6sxgJmA7JxjDcq72k+p2tEjK2Gl+y8XxSMS?=
 =?us-ascii?Q?BdCbo6OFRQLDOIT3wLPf0YcI4LrnlleSywziKgBg7D4qc2G7tFrhdYalJMU3?=
 =?us-ascii?Q?cDPnQO/2YdpWYEsWGcgkJy6V4WCjr1V4wGgTSOjAtpomEHWEkpL+JZ5zbQi4?=
 =?us-ascii?Q?YtDhiHKASvMiz8xn94re3SSUP2vQ5NyeWY9q3T3hflHFYrs3LEeHWQj4ulUa?=
 =?us-ascii?Q?OAzBAoSIkB7v0hpl5BNifbLMwljFMC5/chwipQF3l8xGhBoIJ1AoGT+XxgJG?=
 =?us-ascii?Q?9p0hJjFp5EY4TfW+6HG3q7e07ovnsb7TD3fkp71e/0Kzn7D19S7i2ZDN7Hb0?=
 =?us-ascii?Q?RAnnM1IlLtRxwk3MHpjxG95G11YmozxKooiJeebaJbdT6kgUEVh7FNcIxmgB?=
 =?us-ascii?Q?sAedf0EEvIwhz4KJSIvjYHXhcJK9WS+WlFRyZjd7H9rK+QKO1I8DJ3wi73n4?=
 =?us-ascii?Q?/FY9JweZ219pCNARVMDxiYtsj6sCy9pcFLZ1uCSfEWSos+K+tB9t1Gcuosi5?=
 =?us-ascii?Q?2FcIgGsta4IxJ24/Jf/genF3baDaKKXs69qE1pNiq46nOZ2mzzMzaXJiViRG?=
 =?us-ascii?Q?RpQwdv7haDyQeyCOgg99OhYNoMRx5xkmK/IRdKgwHImqhyGmKq1a8XVVbmbI?=
 =?us-ascii?Q?CV6IW5WzuTb5nkOXP/f2qXXw+JgBzcZpaZbylCDZ6OEPMXKhoICc3SctAdcN?=
 =?us-ascii?Q?Ijtd+fzwn7bZKUD8PrUPMLUBKnsiKuPza1CXN3hR2e0agNU+ni5bYNH/lBMl?=
 =?us-ascii?Q?8STiFbSx0DUEJ2K/6Yk+SUnmYFlVPc1TXbmhRbDeHQGoyxH6S2/nzm6g21j5?=
 =?us-ascii?Q?FD9pav9UfBCqlGsGXip0DhqmJ9QY+RBsAZA5w/RBtjiFSeu4+PRtQx9e0emY?=
 =?us-ascii?Q?tF+M+qah1PemiW1+dwXPBfVFQ+uq3EqpjuX2ZwPBivG0La4Lf9fS6Ewe+2U7?=
 =?us-ascii?Q?4oVKBrH5OHcBYFTgb5Gz9W1nzRrbeBNy6qOausbm8XO6ZUygtw21VycxpfXn?=
 =?us-ascii?Q?NKDjXU7we4K6eL3+M+PJBtTzJZTwfLMuw8+5OR64x0DcGG1duPtaKATOhvph?=
 =?us-ascii?Q?QE8zudOMRvIOoU4Jc+fVw6tPbNATtkLD6fXtF+XBD0PlpTDkB4AzgrUOwOK3?=
 =?us-ascii?Q?ZOydFNw35zNagZiDl4upwZcfu2lihdzgXVbsMf9E6l4ayeDYd2nA97r7ysA+?=
 =?us-ascii?Q?mvGucZ/Uh1N3KQbCzQP3eq65sJjC1l0btxSde2jo+RXbEOc9x8iwTIeOb0sp?=
 =?us-ascii?Q?A3b1VXhcbZzDYVrbn6o1rlZunmF5uz0a8CgGXTd2hclY2eNWs0vlw43CWyta?=
 =?us-ascii?Q?9vLbUssrFpu6LRGizoNFigAlsMeuVJb9D9n5ZHGWsXGQX5h7F32yJftFDKfr?=
 =?us-ascii?Q?648dmZLDZdKykBS6Sba0r4MB8dV7?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(36860700004)(376005)(1800799015)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:19.7632
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 6bf35c2a-2ab9-46dd-120a-08dc757fe848
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A7.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR12MB5675

From: Alejandro Lucero <alucerop@amd.com>

CXL initialization by type2 devices requires to use current CXL kernel
infrastructure only available to such core code. Type2 devices are by
definition owned by specific vendor drivers which need to use part of
that infrastructure for initialization.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/pci.c                   |  3 ++-
 include/linux/cxlpci.h              |  2 ++
 tools/testing/cxl/type2/pci_type2.c | 31 +++++++++++++++++++++++++++++
 3 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index ccde33ac9c1c..497276302017 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -500,7 +500,7 @@ static int cxl_rcrb_get_comp_regs(struct pci_dev *pdev,
 	return 0;
 }
 
-static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
+int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
 			      struct cxl_register_map *map)
 {
 	int rc;
@@ -520,6 +520,7 @@ static int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
 
 	return cxl_setup_regs(map);
 }
+EXPORT_SYMBOL_NS_GPL(cxl_pci_setup_regs, CXL);
 
 static int cxl_pci_ras_unmask(struct pci_dev *pdev)
 {
diff --git a/include/linux/cxlpci.h b/include/linux/cxlpci.h
index 93992a1c8eec..28fa4861a4f9 100644
--- a/include/linux/cxlpci.h
+++ b/include/linux/cxlpci.h
@@ -130,4 +130,6 @@ void read_cdat_data(struct cxl_port *port);
 void cxl_cor_error_detected(struct pci_dev *pdev);
 pci_ers_result_t cxl_error_detected(struct pci_dev *pdev,
 				    pci_channel_state_t state);
+int cxl_pci_setup_regs(struct pci_dev *pdev, enum cxl_regloc_type type,
+		       struct cxl_register_map *map);
 #endif /* __CXL_PCI_H__ */
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index 863ce7dc28ef..b12f13e676fb 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -12,7 +12,9 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 			   const struct pci_device_id *entry)
 
 {
+	struct cxl_register_map map;
 	u16 dvsec;
+	int rc;
 
 	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
 
@@ -35,6 +37,35 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
 	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
 
+	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_MEMDEV, &map);
+	if (rc)
+		return rc;
+
+	rc = cxl_map_device_regs(&map, &cxlds->regs.device_regs);
+	if (rc)
+		return rc;
+
+	rc = cxl_pci_setup_regs(pci_dev, CXL_REGLOC_RBI_COMPONENT,
+				&cxlds->reg_map);
+	if (rc)
+		dev_warn(&pci_dev->dev, "No component registers (%d)\n", rc);
+
+	rc = cxl_map_component_regs(&cxlds->reg_map, &cxlds->regs.component,
+				    BIT(CXL_CM_CAP_CAP_ID_RAS));
+	if (rc)
+		dev_dbg(&pci_dev->dev, "Failed to map RAS capability.\n");
+
+	pci_info(pci_dev, "requesting resource...");
+	rc = request_resource(&cxlds->dpa_res, &cxlds->ram_res);
+	if (rc)
+		return rc;
+
+	rc = cxl_await_media_ready(cxlds);
+	if (rc == 0)
+		cxlds->media_ready = true;
+	else
+		dev_warn(&pci_dev->dev, "Media not active (%d)\n", rc);
+
 	return 0;
 }
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-DM6-obe.outbound.protection.outlook.com (mail-dm6nam04on2079.outbound.protection.outlook.com [40.107.102.79])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7AB704120A
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:22 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.102.79
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847144; cv=fail; b=eb4sJUVMsvM2X0Iym5JfXs/C+CXeKx8DBDASOcsiNG2e//6U2abnKeu0X0lcYfYGlI9xrHmObgn4yNyUR97LLqMVOpmmkxJc+HPLfgyLZ8478pTi1cScn1o62hnDq+yhBU693xrof39hjLEPEJQylJw5jktWY8nmWh0o0hXMdjg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847144; c=relaxed/simple;
	bh=3mim04D8J61wAJIuz7LmH8qoRy3pcLReTPgHsxE78xU=;
	h=From:To:CC:Subject:Date:Message-ID:MIME-Version:Content-Type; b=Nft10rGL/5ug3/WHbBUuJUB1cXmxtwdn+IOrggbs50c5xPioBU/uABabh9o4ki1Mry/xLJUzqeYB3sj7vFDzNuiu1ZXVeMLZfC7PkgNEUqPEeV5KSJA7QR9aOuNzG5cD+VNpo0EAfZY5+mCVByLX3TlKoD97yIbIv7dp8tDmFj0=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=LdkGEFbI; arc=fail smtp.client-ip=40.107.102.79
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="LdkGEFbI"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=cxQh4y0VEtfDWBNhiMrcf75lZpzffGCsvS5UXQuMHVzTYlt/mSHgmJ6uDs//yPM8a0BoBnL3pHJ09DvBovJomcp13tgs7Q/Yh//NG+VnNKJVibUL1VzA/PoZ8nKD6FRwgzeVCJow5Do61l6pGBYQl0z4VJHbECeYV23x8T0IaBBbFQun6EJ/Hy1xCZ0NT4vJqLhto6B/229Orm8U4E0fagsUOz037+V0Bc899P40Jrr/cobplopW2jUWK1Mw0jyGNorOG7rAdrGaGcg49+tiv2aoHUhrP1eKQuUf8lOvdBjHijAQZGSL998Frym0AqOUW6SwmHYFASodKaVne8rBoQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=yBm6icIjGLXybySvS0bpENAs7x9LZfgKA/VsF7quKSg=;
 b=glGbyKN2stZS7YtSD7gCGR8byj35fyFr54PhKg/5dO5Tmikjaa+PXmf6kUbEDJXy6CnvgrneOGhxHaTbqq2dnWNTcDhCe1eCDc00RDImXdL3BpCImrYzOszEMAxhCfmcUcTorWmty8BhiE67cu6btgniMXMNbxIVeTVvqFgV6IqY4IjGwJcfS0L0HKIzlTUvk8Ip+D4sCep3ZZdbW0PV+AeQCophwIPYVw0ntrq9aEFUTqjr4CrgyO4H8H2AP8UF6HseFPS9X9OcQDFzokYnNzzsCkAE8ZpzaD2RQ/wemPFBrB6HG7N58ZmPmJKHwAXIcjLCGqeqFbfJZnjpN3MkHw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=yBm6icIjGLXybySvS0bpENAs7x9LZfgKA/VsF7quKSg=;
 b=LdkGEFbIDjLQe48KWHtaMZ6CFNhd9xVDrR8CITVVWpTuzW6wb6NGtohEGrDoxklVJ7INHCW5eykIZgouNXl5R2OgpIwABy3yQjXdYVOzJxThvOJQolHVZflpbeh8wdIhw96MNkpvXplj9Z64Rot/PVb6Qr6QlZRtVlsIU7IEDrw=
Received: from BN0PR03CA0043.namprd03.prod.outlook.com (2603:10b6:408:e7::18)
 by SN7PR12MB6982.namprd12.prod.outlook.com (2603:10b6:806:262::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.58; Thu, 16 May
 2024 08:12:18 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::a2) by BN0PR03CA0043.outlook.office365.com
 (2603:10b6:408:e7::18) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28 via Frontend
 Transport; Thu, 16 May 2024 08:12:17 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:17 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:15 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:15 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alejandro.lucero-palau@amd.com>
Subject: [RFC PATCH 00/13] RFC: add Type2 device support
Date: Thu, 16 May 2024 09:11:49 +0100
Message-ID: <20240516081202.27023-1-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|SN7PR12MB6982:EE_
X-MS-Office365-Filtering-Correlation-Id: 7b381f68-f6da-4e92-1001-08dc757fe712
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|376005|36860700004|82310400017|1800799015;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?dm1oVWdCaURkc0p6NmJNamNxd1c3L1ZxRlhFcE9vd3BNQUpsMS9NZU9lZTdE?=
 =?utf-8?B?a3gwMHUzMzZNNXhuTTdZTVpSaHh2RUJpeVRXK25Gd05TQzlsWk9LdGpZaDJD?=
 =?utf-8?B?cnNxTHk0a0hsZ2k3QnRXY1pMYVhGUnkrTkh3dDNYaEZWcFI3VWI3OWtjV2xP?=
 =?utf-8?B?RUlUK0F2V0RqVi9PUjZINTlLajhJK2cvV0RVcjN2RDBrbkt3V2R5RmlScHIw?=
 =?utf-8?B?RS8xTHQ3Z0NNSFhZUWNaOTBkSWlveDI3djNMWlVQaFRhTXAyckFMejIzQ1BQ?=
 =?utf-8?B?OE9qb0xuck1FakNzNkZqM1lLeWhtU2Iza3pKQkx5cVVVdGQ2emk4VlBReTRE?=
 =?utf-8?B?ZU9zSEx3NVlMN2N4QmxPSk5IK2pIMkg3aGxqU3hDa3J2QS9zMW1yaFp4VkNE?=
 =?utf-8?B?bU9sMU5VNmdqS25KclBPSnVpeG5oNlRjbC82ZUNXR3U3aGdVaXJ3c3lETkd2?=
 =?utf-8?B?NGVzeWZJZDY0eUN4d0FVcnNFOVNEVXBzOGR2MVNtTFhUbWMrUEIxaDRwTFFG?=
 =?utf-8?B?Vkpscit6c1ZualBiZE96S2ZPc1kvUlJoaWNHc3hnd2dTdyswa1cxeTEwNEgz?=
 =?utf-8?B?MTdlbm9NYnpHMzNSeEN6YkJmdFZ0MlN6UmRzWmd1OERiWTNGdzNPYyszZG90?=
 =?utf-8?B?UnZRQTdReGZYTkhZOFhnYjBoakdJWmpXNmxLWkZBZi9tUTVHelFGQU5DRVoz?=
 =?utf-8?B?aFRxbDZwVjE2c1VWcFpJU1lvaXpjSlhrWm9HUVIwVURLallSV2xUMVZ5ZEhj?=
 =?utf-8?B?M1JoR3U5c1lDeHpyeEN5VzV6V3hlUStjWnJzOFpvNDB0Q1NsSXorL2MrRXZD?=
 =?utf-8?B?aU9jaU02ZjdEVSt1M1VpWW1TcDVWTnp6T0lIQnFoQnJQUFVDblBOUUxjNUZq?=
 =?utf-8?B?TldiWEhwVC9uLzlEK0xzdlFSZWdxSGJJZzlJaklGNFZZb0hLditzWTFRZTBT?=
 =?utf-8?B?TUFheWVsdWliMFhZTkJwNW5xOGpIZHNnTXJwbmlILzhQWG1OWlo1bUZaWUU0?=
 =?utf-8?B?bDBZQ2IvazBUUm1FQ0pveUZ3S29Xd01nZWVwOFRBbW13YVBxbFZ0WFB1OTVM?=
 =?utf-8?B?cE52Y0RiS3dsYkVvdHpBVURUQWhoT0RwY2tzL1pwa3UzbWwvSlBRUCs4SFB1?=
 =?utf-8?B?WllnUVB3QW1yN2UvbXpEdlVBUGZtWG40UklTVlZLTy9zMEp6WDVtV3BudFZa?=
 =?utf-8?B?ZllLdmVLcVBLZnU1RnZVMWVzZDIrL0RYRGtsOXc2MUxnZmRqZHVRZi8zVlFV?=
 =?utf-8?B?ZEdQRC9pejFmSDFxczRkbEJxekJCYTQ2M2l0cGY0N3FsVWZUVmRHNjl1eks3?=
 =?utf-8?B?RU1uVEI2K2QzdWZnZ0RTVEN5WEgzaHowajdNeVdJT1RBdmt1NTJMTCtEMzJG?=
 =?utf-8?B?dTd6Y0gvSDFPSVluNWJBWGZLOHpCcTMxSlBYVTdISlFmaDFwNmNVc2lVdlkv?=
 =?utf-8?B?LysrMk05QmZjemdJbHN2TDRXOE1vZ0NCRFdiZk5Ma3dSN09zbDg1Z24reE5O?=
 =?utf-8?B?OHBvVnRUdkROeUZVVzVsemtBSGsvb3hRTnF2bzJHdnNVcVVvUjNXdnFxZmpi?=
 =?utf-8?B?Ukk0bUpFU2xYeGE2SnRrWGVscEE5alRBb1FVYklMdERZTTE2R2pZcmZvZG1Z?=
 =?utf-8?B?VzJqRmt0VlAxRDBZMU1TNlQ2emVMWTBGZlFXNEdWVUhxS2ErbW1uL1NXeHJG?=
 =?utf-8?B?T2FvdExtY29EQXJ4S2wrRHJGQ3FMN1ZNU2JTZEtwU3FYRml2Lzc1YW9DQlpv?=
 =?utf-8?Q?fl/mTDPo0dqdw7pygK0KasLu+Vle3dcCRjqOa/1?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(376005)(36860700004)(82310400017)(1800799015);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:17.7472
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 7b381f68-f6da-4e92-1001-08dc757fe712
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR12MB6982

From: Alejandro Lucero <alejandro.lucero-palau@amd.com>

I need to start this RFC explaining not what the patchset does, but what we
expected to obtain and currently is under doubt: to configure a CXL memory
range advertised by our CXL network device and to use it "privately".

The main reason behind that privacy, but not the only one, is to avoid any
arbitrary use by any user-space "client" with enough privileges for using a
public interface to map the device memory and use it as regular memory. The
reason is obvious: the device expects writes to such a memory in a specific
format.

The doubt comes from the fact that after implementing the functionality exposed
in this patchset, we realized the current expectation seems to be a BIOS/UEFI
configuring HDM decoders or HPA ranges and passing memory ranges to the kernel,
and with the kernel having a default action on that memory range based on the
flag EFI_MEMORY_SP being set or not. If it is not set, the memory range will
be part of the kernel memory management, what we do not want for sure. If the
flag is set, a DAX device will be created which allows an user-space client to
map such a memory through the DAX device API, what we also prefer to avoid. I
know this is likely going to face opposition, but we see this RFC as the
opportunity for discussing the matter and, if it turns out to be the case, to be
guided towards the proper solution accepted by the maintainers/community. This
patchset does not tackle this default kernel behaviour although we already have
some ideas and workarounds for the short term. We'll be happy to discuss this
openly.

So, this patchset assumes a BIOS/UEFI not programming the HDM decoder or HPA
ranges for a CXL Type2 device. Although maybe a weird assumption as explained
above, a Type2 device added after boot, that is hotplugged, will likely need the
changes added here. Exporting some of the CXL core for vendor drivers is also
required for avoiding code duplication when reading DVSEC or decoder registers.
Finally if there is no such HPA range assigned, whatever the reason, this patchset
offers some way of obtaining one and/or finding out what is the problem behind the
lack of such HPA range.

Current CXL kernel code is focused on supporting Type3 CXL devices, aka memory
expanders. Type2 CXL devices, aka device accelerators, share some functionalities
but require some special handling.

First of all, Type2 are by definition specific to vendor designs and a specific
vendor driver is expected to work with the CXL specifics. This implies the CXL
setup needs to be done by such a driver instead of by a generic CXL PCI driver
as for memory expanders. Most of such setup needs to use current CXL core code
and therefore needs to be accessible to those vendor drivers. This is
accomplished with the first patch and with extensions to the exported functions
in subsequent patches.

Keeping with kernel rules of having a client using any new functionality added,
a CXL type2 driver is increasingly added. This is not a driver supporting a real
device but an emulated one in QEMU, with the QEMU patch following this patchset.

The reason for adding such a Type2 driver instead of changes to a current kernel
driver or a new driver is threefold:

1) the expected kernel driver to use the functionality added is a netdev one.
   Current internal CXL support is a codesign effort, therefore software and
   hardware evolving in lockstep. Adding changes to a netdev driver requires the
   full functionality and doing things following the netdev standard which is
   not the best option for this development stage.

2) Waiting for completing the development will delay the required Type2 support,
   and most of the required changes are unrelated to specific CXL usage by any
   vendor driver.

3) Type2 support will need some testing infrastructure, unit tests for ensuring
   Type2 devices are working, and module tests for ensuring CXL core changes do
   not affect Type2 support.

I hope these reasons are convincing enough.

I have decided to follow a gradual approach for adding such a driver using the
exported CXL functions and structs. I think it is easier to review the driver
when the new funcionality is added than to add the driver at the end, but not a
big deal if my approach is not liked.

The patches are based on a patchset sent by Dan Williams [1] which was just
partially integrated, most related to making things ready for Type2 but none
related to specific Type2 support. Those patches based on DanÂ´s work have DanÂ´s
signing, so Dan, tell me if you do not want me to add you.

Type2 implies, I think, only the related driver to manage the CXL specifics.
This means no user space intervention and therefore no sysfs files. This makes
easy to avoid the current problem of most of the sysfs related code expecting
Type3 devices. If IÂ´m wrong in this regard, such a code will need further
changes.

A final note about CXL.cache is needed. This patchset does not cover it at all,
although the emulated Type2 device advertises it. From the kernel point of view
supporting CXL.cache will imply to be sure the CXL path supports what the Type2
device needs. A device accelerator will likely be connected to a Root Switch,
but other configurations can not be discarded. Therefore the kernel will need to
check not just HPA, DPA, interleave and granularity, but also the available
CXL.cache support and resources in each switch in the CXL path to the Type2
device. I expect to contribute to this support in the following months, and
it would be good to discuss about it when possible.

Alejandro.

[1] https://lore.kernel.org/linux-cxl/98b1f61a-e6c2-71d4-c368-50d958501b0c@intel.com/T/

Alejandro Lucero (13):
  cxl: move header files for absolute references
  cxl: add type2 device basic support
  cxl: export core function for type2 devices
  cxl: allow devices without mailbox capability
  cxl: fix check about pmem resource
  cxl: support type2 memdev creation
  cxl: add functions for exclusive access to endpoint port topology
  cxl: add cxl_get_hpa_freespace
  cxl: add cxl_request_dpa
  cxl: make region type based on endpoint type
  cxl: allow automatic region creation by type2 drivers
  cxl: preclude device memory to be used for dax
  cxl: test type2 private mapping

 drivers/cxl/acpi.c                      |   4 +-
 drivers/cxl/core/cdat.c                 |   9 +-
 drivers/cxl/core/core.h                 |   1 -
 drivers/cxl/core/hdm.c                  | 159 +++++++--
 drivers/cxl/core/mbox.c                 |   6 +-
 drivers/cxl/core/memdev.c               |  75 +++-
 drivers/cxl/core/pci.c                  |   6 +-
 drivers/cxl/core/pmem.c                 |   4 +-
 drivers/cxl/core/pmu.c                  |   4 +-
 drivers/cxl/core/port.c                 |   6 +-
 drivers/cxl/core/region.c               | 446 ++++++++++++++++++++----
 drivers/cxl/core/regs.c                 |   9 +-
 drivers/cxl/core/suspend.c              |   2 +-
 drivers/cxl/core/trace.c                |   2 +-
 drivers/cxl/core/trace.h                |   4 +-
 drivers/cxl/mem.c                       |  23 +-
 drivers/cxl/pci.c                       |   9 +-
 drivers/cxl/pmem.c                      |   4 +-
 drivers/cxl/port.c                      |   4 +-
 drivers/cxl/security.c                  |   4 +-
 drivers/dax/cxl.c                       |   2 +-
 drivers/perf/cxl_pmu.c                  |   4 +-
 {drivers/cxl => include/linux}/cxl.h    |   5 +
 {drivers/cxl => include/linux}/cxlmem.h |  22 +-
 {drivers/cxl => include/linux}/cxlpci.h |   2 +
 tools/testing/cxl/Kbuild                |   1 +
 tools/testing/cxl/cxl_core_exports.c    |   2 +-
 tools/testing/cxl/mock_acpi.c           |   2 +-
 tools/testing/cxl/test/cxl.c            |   2 +-
 tools/testing/cxl/test/mem.c            |   2 +-
 tools/testing/cxl/test/mock.c           |   4 +-
 tools/testing/cxl/test/mock.h           |   2 +-
 tools/testing/cxl/type2/Kbuild          |   7 +
 tools/testing/cxl/type2/pci_type2.c     | 201 +++++++++++
 34 files changed, 886 insertions(+), 153 deletions(-)
 rename {drivers/cxl => include/linux}/cxl.h (99%)
 rename {drivers/cxl => include/linux}/cxlmem.h (97%)
 rename {drivers/cxl => include/linux}/cxlpci.h (97%)
 create mode 100644 tools/testing/cxl/type2/Kbuild
 create mode 100644 tools/testing/cxl/type2/pci_type2.c

-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2055.outbound.protection.outlook.com [40.107.223.55])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3DEF6634E2
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:22 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.55
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847145; cv=fail; b=oxTCnM8IfSFa8LG0Ftr1u+c+23B57RevA9UCip7R0EusAE4m47Ybq7fV7oPbTaIR8pkej0r5yvH/FW6YQjx+FOYTz60tIFSvtATPfnQB8e6a5cgQNinvVkqhHfzxa4kBQW8+/EdkFlg+7PirGsGuWmQqYep4R3ro39CjZN2djFs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847145; c=relaxed/simple;
	bh=HFLthIfn9AtWJc5j+N2AHQ1h8gyFPwXbSGUFgQZBQcE=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=psHqCMNOLeXPJwBzPHqdOCV3kMQ2RdO+6q8o0BdLeESjHIf/o+ewBlSH/q98sg7yOTjvhABgxAcyX+iSfpJcvCYFQ7AR4BwnLQo8yLaUTI0U7LVRszu7PN/dBmMNtHA35hte2LNCBIC9UccgwDgLxC3GRQp+oHSR7JpkR1vadLg=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=nho5phFm; arc=fail smtp.client-ip=40.107.223.55
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="nho5phFm"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=J6AUk8ne+O4814rsxOdvgiey6UHKbHD4VwQhrticflYYdTprxkntuddSngBqNPj2FWqHBWrFf8egy2eelJxhk9o19dW/zkhTU/5xzwIn0CFcYnJNXcIcZDu70WK1uI11Ho1f/prqmPPNVQUT21nwCGGt1D5slEhWVWTuIpYzA6LFSHnt/eehYK0huTgMyL+ew5quBN+RH1Sx8uda5h1ATxyB8J5P43wHG2Y+VRjqrm9/n66h5MxaDwVJfyCnTa9dibc51DRNMwS3122MWfG7EYeseQvDPPnbNMahnI7BE/q8qNNvGReymyoCe9AYOZcDYjUcame1WRaqjohU7iDFwQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=07snWkj8/D+ofAWAJbmqaj/kX7dw5JkwPvwZeL36KWA=;
 b=W+nCJ3LY3EQ2R3J8o8cDhQKQW/yJf0F606z6u5uAxyB/hmXydWEP0ErPC39QYip4oXwS0KMs9n+RHK4x6obEkx3RuoIicM6R+thmc0nrrAVOs+c1L7mFVn/PfX7ZDzidmLmsZYP0/ufx4c/eCZt4Xz3BBaDslOvmq3cD0XFDlQnrv8XuZsQnl47tewfXUd+PV0/Eg/XsjC884eOTh3SS/QTICfhQ9J7pIZEixI/O49MX5JoixZmPeS9BoG3PSVoeJ3WkEa7kTum+yuBUpDqhmabJE1pYEtmsSTU1RqaHArhGJ5P5PEz7ccBSMRYAEVSkf2WDDqYETnvxBW8dJmbrQg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=07snWkj8/D+ofAWAJbmqaj/kX7dw5JkwPvwZeL36KWA=;
 b=nho5phFmgQ1qZyU5I5EQEW637+0Pc+3yNj4nQ2VEjwHKG8ZHivOYHZOjdWPfaYupkQtqwtrUSS8gCrxD6G39GCzd+3gAW2a1S9SbPlcjLb7gNcpW8M0Ghzi9LPRB3/LjsVPhZIHkKq7QsyNh3krG8EUUSQyCVtj3mwIMDyu1yWM=
Received: from BN0PR03CA0049.namprd03.prod.outlook.com (2603:10b6:408:e7::24)
 by DM6PR12MB4170.namprd12.prod.outlook.com (2603:10b6:5:219::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Thu, 16 May
 2024 08:12:19 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::65) by BN0PR03CA0049.outlook.office365.com
 (2603:10b6:408:e7::24) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.27 via Frontend
 Transport; Thu, 16 May 2024 08:12:19 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:19 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:18 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:17 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 02/13] cxl: add type2 device basic support
Date: Thu, 16 May 2024 09:11:51 +0100
Message-ID: <20240516081202.27023-3-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|DM6PR12MB4170:EE_
X-MS-Office365-Filtering-Correlation-Id: b14c2c3d-d01f-49cc-f11a-08dc757fe815
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|376005|36860700004|1800799015|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?B+k1AXiind9KpMpV0ucn4rzc8Yet3XTMSBmqcPenCXnWvBbyhVdP90exJqSK?=
 =?us-ascii?Q?rEYWUYGpHOI+sJP8rjo2wXQh4kwuRdiwdQ8Pga0Lmhje7VEUd16FqWU0mSKS?=
 =?us-ascii?Q?cODOLWmC4U2n+d2Fp8P0W9kgHVHncZG2CTExDRjnXYiToeovEcGqNS/fTCRM?=
 =?us-ascii?Q?UPrJwtgbXVsFVHK9r/ksczR7Lc66vgCnDs0Cms00pJcGy5VsbQbuiamRqQtl?=
 =?us-ascii?Q?daZjeW5xHENwMsFEM/8HtKvAcxui4M1mRN7M5vJJZEEzmtJK0uavgFIntKjw?=
 =?us-ascii?Q?OX+QFTAcyD5EkMDaKMgRua3M/vgL5FjJZ8LAS9hwlwnd1bVHWvAwlBHSQaIG?=
 =?us-ascii?Q?sbfbQqMEhEuMP7LZVNCQbjXPWYUC2Pt1JrKqeqzebSCi/YI1xjig8ghBcyuF?=
 =?us-ascii?Q?CDuhlBnGs3KYhx+ps2ezdgwZiYRlYsE0ODKRLvMz6f9dovSovb+WHfhtJEhM?=
 =?us-ascii?Q?M3oiv6+vb2EIb8k/4/bjq4HBpe3DijkJwuP5XITfOFDOBs36TKHeKACXlL2c?=
 =?us-ascii?Q?zaVgX4dQ0VbmIYiq2pwJDWg3G0OIzPvrzZRn7w/T0DE5G0S6+sasRERP5xZQ?=
 =?us-ascii?Q?7xPeq79L4yu3f7wlah6H++I12MpocNjKhMlVyhh6tnXbNxZ944FcZESYrPvk?=
 =?us-ascii?Q?C2g19PBVHvoXNQSeQz9AMqeaQx9v5ciItpI5ogYF5EkRbE7/vQ/vIe2NBmYt?=
 =?us-ascii?Q?9FLW3eyKMQz+a2vKkZuQxhJaV3m30InMW5YW99DZ0W7EPjF0pAXq/DYxHk/x?=
 =?us-ascii?Q?i/f6JvT+xomZEuxJa44JB0PccjmTlI5dBhWmEd8emMVvZFujquPV5AZDDlcr?=
 =?us-ascii?Q?fyikx2/2FX8BMF7icsvC+M/haoKnmeXEVQIICy3BmiJKQNoz244G9ojrHegg?=
 =?us-ascii?Q?e6srZEsNz1T5jYQlqZ05aTNPJESEX9gpuhSomjUA8RMwbQ5dKqgbaXkzjQux?=
 =?us-ascii?Q?ZflwKsWeubHH3bWy+rvFwX3Y+XFZ7NaRQDrrL3h5LjX+1kqLVwLnxY6sqgNd?=
 =?us-ascii?Q?w/T3kbs8UDORhxgjkuW4VE2c1vGxK9sPHrfCNCy5E8K37YSPQZjiGzlP6lEu?=
 =?us-ascii?Q?3o2LphFDxQtuIZ9dpwvIf2qrRwt1dFViX6NIFzv75fB+hu1z6Mx7D76R/6tg?=
 =?us-ascii?Q?2y2HyTjrvApHLjSgwvZumT3aaTvJAy/Euq1KzZEQ1dgO5VHqujiM8243MRS9?=
 =?us-ascii?Q?rsb413msZc9uXT2Bj/uQ6QUXIgshQjBocl0QPORDz0R6mTZa8OTGpK5q7CdQ?=
 =?us-ascii?Q?u8cVGHUoKVZktz72SJHZQc4NYoDdmkq/FNv+w84jfjO70LF21hfQ+Rf6LV1Y?=
 =?us-ascii?Q?D7xN33ZiAa/ACU8KpBRFmRCIMBb2LutqmilmyBzcCP+Dr6bQT3B0XoNSLcN2?=
 =?us-ascii?Q?qNxTnx6wOub7K4l5LWLquyi6XHiu?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(376005)(36860700004)(1800799015)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:19.4191
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: b14c2c3d-d01f-49cc-f11a-08dc757fe815
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4170

From: Alejandro Lucero <alucerop@amd.com>

Differientiating Type3, aka memory expanders, from Type2, aka device
accelerators, with a new function for initializing cxl_dev_state.

Adding a type2 driver for a CXL emulated device inside CXL kernel
testing infrastructure as a client for the functionality added.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/memdev.c           | 15 ++++++
 include/linux/cxlmem.h              |  2 +
 tools/testing/cxl/Kbuild            |  1 +
 tools/testing/cxl/type2/Kbuild      |  7 +++
 tools/testing/cxl/type2/pci_type2.c | 80 +++++++++++++++++++++++++++++
 5 files changed, 105 insertions(+)
 create mode 100644 tools/testing/cxl/type2/Kbuild
 create mode 100644 tools/testing/cxl/type2/pci_type2.c

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 07cd0b8b026f..0336b3f14f4a 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -659,6 +659,21 @@ static void detach_memdev(struct work_struct *work)
 
 static struct lock_class_key cxl_memdev_key;
 
+struct cxl_dev_state *cxl_accel_state_create(struct device *dev)
+{
+	struct cxl_dev_state *cxlds;
+
+	cxlds = devm_kzalloc(dev, sizeof(*cxlds), GFP_KERNEL);
+	if (!cxlds)
+		return ERR_PTR(-ENOMEM);
+
+	cxlds->dev = dev;
+	cxlds->type = CXL_DEVTYPE_DEVMEM;
+
+	return cxlds;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_accel_state_create, CXL);
+
 static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
 					   const struct file_operations *fops)
 {
diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
index 0d26a45a4af2..e8d12b543db1 100644
--- a/include/linux/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -859,4 +859,6 @@ struct cxl_hdm {
 struct seq_file;
 struct dentry *cxl_debugfs_create_dir(const char *dir);
 void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
+
+struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
 #endif /* __CXL_MEM_H__ */
diff --git a/tools/testing/cxl/Kbuild b/tools/testing/cxl/Kbuild
index 030b388800f0..a285719c4db6 100644
--- a/tools/testing/cxl/Kbuild
+++ b/tools/testing/cxl/Kbuild
@@ -69,3 +69,4 @@ cxl_core-y += cxl_core_exports.o
 KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
 
 obj-m += test/
+obj-m += type2/
diff --git a/tools/testing/cxl/type2/Kbuild b/tools/testing/cxl/type2/Kbuild
new file mode 100644
index 000000000000..a96ad4d64924
--- /dev/null
+++ b/tools/testing/cxl/type2/Kbuild
@@ -0,0 +1,7 @@
+# SPDX-License-Identifier: GPL-2.0
+
+obj-m += pci_type2.o
+
+cxl_pci_type2-y := cxl_pci_type2.o
+
+KBUILD_CFLAGS := $(filter-out -Wmissing-prototypes -Wmissing-declarations, $(KBUILD_CFLAGS))
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
new file mode 100644
index 000000000000..863ce7dc28ef
--- /dev/null
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -0,0 +1,80 @@
+#include <linux/module.h>
+#include <linux/pci.h>
+#include <linux/cxl.h>
+#include <linux/cxlpci.h>
+#include <linux/cxlmem.h>
+
+struct cxl_dev_state *cxlds;
+
+#define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
+
+static int type2_pci_probe(struct pci_dev *pci_dev,
+			   const struct pci_device_id *entry)
+
+{
+	u16 dvsec;
+
+	dvsec = pci_find_dvsec_capability(pci_dev, PCI_DVSEC_VENDOR_ID_CXL, CXL_DVSEC_PCIE_DEVICE);
+
+	if (!dvsec) {
+		pci_info(pci_dev, "No CXL capability (vendor: %x\n", pci_dev->vendor);
+		return 0;
+	} else {
+		pci_info(pci_dev, "CXL CXL_DVSEC_PCIE_DEVICE capability found");
+	}
+
+	cxlds = cxl_accel_state_create(&pci_dev->dev);
+	if (IS_ERR(cxlds))
+		return PTR_ERR(cxlds);
+
+	pci_info(pci_dev, "Initializing cxlds...");
+	cxlds->cxl_dvsec = dvsec;
+	cxlds->serial = pci_dev->dev.id;
+
+	/* Should not this be based on DVSEC range size registers */
+	cxlds->dpa_res = DEFINE_RES_MEM(0, CXL_TYPE2_MEM_SIZE);
+	cxlds->ram_res = DEFINE_RES_MEM_NAMED(0, CXL_TYPE2_MEM_SIZE, "ram");
+
+	return 0;
+}
+
+static void type2_pci_remove(struct pci_dev *pci_dev)
+{
+
+}
+
+/* PCI device ID table */
+static const struct pci_device_id type2_pci_table[] = {
+	{PCI_DEVICE(PCI_VENDOR_ID_AMD, 0xbabe)},
+	{0}                     /* end of list */
+};
+
+static struct pci_driver type2_pci_driver = {
+	.name           = KBUILD_MODNAME,
+	.id_table       = type2_pci_table,
+	.probe          = type2_pci_probe,
+	.remove         = type2_pci_remove,
+};
+
+static int __init type2_cxl_init(void)
+{
+	int rc;
+
+	rc = pci_register_driver(&type2_pci_driver);
+
+	return rc;
+}
+
+static void __exit type2_cxl_exit(void)
+{
+	pci_unregister_driver(&type2_pci_driver);
+}
+
+module_init(type2_cxl_init);
+module_exit(type2_cxl_exit);
+
+MODULE_AUTHOR("Alejadro Lucero <alucerop@amd.com>");
+MODULE_DESCRIPTION("CXL Type2 device support, driver test");
+MODULE_LICENSE("GPL");
+MODULE_IMPORT_NS(CXL);
+MODULE_DEVICE_TABLE(pci, type2_pci_table);
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2079.outbound.protection.outlook.com [40.107.220.79])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 17CCB6D1AF
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:23 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.79
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847146; cv=fail; b=W7hrfSlpaCoFBlG0Pd2z1ayX45lBtBRcWCgw87sm9NS+FCn3picYfRAK0hA8fW0KKzIsyRxps9o8zyIHXAdc901j5kCN6DGdNiei0o+DLhjEPvw8v12koa4Pj6AU3Cg1bgNXynsHvGxXIhi1I3K9pvS/QSiaq6ZRwa0NdjVEado=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847146; c=relaxed/simple;
	bh=sYtScOyt2+HUl8hlmRirCLGYcJyJ7c+fT2UyEdgaqww=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=R/oHacIAJT6ca4lEAhGsCZu99cSCh6N8gYbMSwHPcH4iJQkKluGNGrilUpICNy8LRS2njCXnAmdnRG92REODqDkn1Ua6kbfP5B2x01ar1lKVDITvHlmyEi3HmfFCU8nq2KDY3FC9ws+5ohdHvVt57ZkHCLX74OquweaVlvcqTik=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=K93DKNWn; arc=fail smtp.client-ip=40.107.220.79
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="K93DKNWn"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=cFdyzEd82VvyRyOSziNDETpwct+id8ZKiVM5nJXlp49Ph4YuxAf+a/R9dTMkYWs/9VGEbESRbg3Iyd60j1MkpkBiTRT5d7rDC7CmQB0hXejJXzM09n3cabIdCP5F9OGJcXFOs4Tu5+hPAaZqH85J+GI4oplXvQpzkWkFcVizffNfZObdFSMYoOJxNi0neEGe4d31n/YdvDaXtLXQFkdZmEFHvPAa6kl7BhO8N0wZ07Cw24k8c3AHK5HvjAh+ZzUg078fnLfxDAOibc+mQ/cd/yZsXLdth/GzHKW5Wj1SYZn9qRXGXsVPbeX/5gkwnupoSgqVUFgzb/HreFFoBOBiRw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3phZK3QgOJ4Pl9zYuH99pBW0qIbJp8+/7ufTT+RyRQw=;
 b=ZT1jSyOjenoRtiQJcyPED8VN7NladYHRVFeoOXVHcBuD0Fj8eqGKB3N6TutkwyP+58pz9SK67sImmj8veOTbC/VT/yVZIuhZNXW1ErdxYp3bX4nLara/vNuSOOlMWmyyHKKNUDntWGyVpL50amjEF8GVXKjnFefdcprwNjQF0FIaKUIA4ggBK5a2friZmQO9FBPOYOGD8t/xk+BQCh1F1siNEYoMHKzdUKepgAxm9hrafQ7S3kaYue2lQhK/+nJy0fgy2iZu1ENl0/XrshrZcS/hZ7+iYH2jRb3/exZ1YX2vmLS6GxJ5drwENzGeH0mORxvqtsljhUWUyzB1urY9EA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=3phZK3QgOJ4Pl9zYuH99pBW0qIbJp8+/7ufTT+RyRQw=;
 b=K93DKNWnvkvKNjoHnE0OdehHuSjWZCsYEidCRKl1stTTWE2dcetbzJeNr6vTXnagqOuwKECJ9ZsGvpffKKEIbdvhrsyRhsoxT4JY/t/ZkL6hrF3mDeHIJDDHZIjX5wGmlPFxhF11p6wY61fA7weqmHl4u0ittzJX3xQGS6bMOAc=
Received: from BN8PR04CA0036.namprd04.prod.outlook.com (2603:10b6:408:70::49)
 by DM4PR12MB6256.namprd12.prod.outlook.com (2603:10b6:8:a3::7) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.7587.30; Thu, 16 May 2024 08:12:19 +0000
Received: from BN2PEPF000044A7.namprd04.prod.outlook.com
 (2603:10b6:408:70:cafe::1) by BN8PR04CA0036.outlook.office365.com
 (2603:10b6:408:70::49) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.29 via Frontend
 Transport; Thu, 16 May 2024 08:12:19 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A7.mail.protection.outlook.com (10.167.243.101) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:19 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:16 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:16 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 01/13] cxl: move header files for absolute references
Date: Thu, 16 May 2024 09:11:50 +0100
Message-ID: <20240516081202.27023-2-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A7:EE_|DM4PR12MB6256:EE_
X-MS-Office365-Filtering-Correlation-Id: 7bd61ccd-481b-4824-78e0-08dc757fe7ed
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|1800799015|376005|36860700004;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?oXfbYf1hDgvY0Jqs+OIjs3RmYMUUgpl8cmfaZG7Xd9Ctuz37W/KRU7oboF8G?=
 =?us-ascii?Q?MPBQVqbm3+p34VTp4NeiXsTJdS6ALsrM+w++D7uEBA8JGXsR52qUqHj6AMK2?=
 =?us-ascii?Q?iCfXa3qabE71sK1x6LgSoFHystCTISGM7XDNGRGZ5/K30Qy/OOZ7a5Iomyjr?=
 =?us-ascii?Q?5556Jv7cp0SbNcEbpuApfskAjdjZUCMXbGKeX5OseZaT9nsqZqwcdcXyI3og?=
 =?us-ascii?Q?FTNmtlFqBtOFhCEvaRIIHl7Y98+/2FoQeyo+26kmfe/VXN+LXt3IgFGNrqw4?=
 =?us-ascii?Q?w84Wv8gK8SjBduEhWmQOxC0M1/LZ9YhYYXecBmzsmP/DK0Wifty6y3RQnLZ4?=
 =?us-ascii?Q?Ie8TijwmhmGI8+yOPbt9qWE+OeXr18WBeMSGwKZiwCHkK6H7yRgZwV5ousXM?=
 =?us-ascii?Q?u7APowFciHewZ+eFgubVOogw66l/C7IACAsfK7cuXyLmeKcrfJyrGAShLvNn?=
 =?us-ascii?Q?zd3TkXuJIZTnQ/Dc7CxgIERr673C5/Bgq4ei64mJwHwR4mGNKpsTjcZymCD2?=
 =?us-ascii?Q?LPcntL5M0H4C+bIkoyCZ9lsU4m8Lz1jqH8mZMpR5ZibdrdMzr3sAzeZk9Vpe?=
 =?us-ascii?Q?lr1n3WGuH/mK7ZbyM8Y94p8Oc+BS8q0Gh4bflCZpODDPo5pHho0L6ojo5BBr?=
 =?us-ascii?Q?AgVP0yYkrCV0Oi5+hvYwWd7OcfKR2LG5bCsAzsCtUVgac2VOf4lvytVcig53?=
 =?us-ascii?Q?6uwrPUrwo+mxs94143FYI81taEsmlVxaZAWbbLIEDungzq9zY5wGgl+Ld9J1?=
 =?us-ascii?Q?WOIEsOee8GBFNiW2VO0YNyswsM1oEpH01TpIfiRzdTDJZrgFI+8qXQ76f8yf?=
 =?us-ascii?Q?3mDDpzuj0WGEHaJ7h0OZW53vnZuCl+riR9Nwbdy2ZjIOMMct4Cwh6ncPdloL?=
 =?us-ascii?Q?XLa2DsOXbxevuGjNEbrmEsnzUvdhJhdP/id6jt/1t5zPlxoYncsI5p0vOeoM?=
 =?us-ascii?Q?gNnqIDZ+8I33sbDUX/jLORaqw1sqmY/rDb/ab2orFEQZ7nMYgcKeMbkBfvJi?=
 =?us-ascii?Q?vnEf5d3CCO80Mf8a13Qcqb0h0pO+ALngetotHXALXC7G23UU7Fd2YZayBRvL?=
 =?us-ascii?Q?N8V2r5DwKLVkLqy89V10wJdRjlzWHqgufZ07Bfl8quLxz9z9GBAcST6XuiDs?=
 =?us-ascii?Q?OwxCGwOlx6hgnGG62Y2ZAgiaPPLM0UXLszVS4u0iRC7bQKGIsVyTVBRCfQHJ?=
 =?us-ascii?Q?U9+Fm9loNwquN8fZE2/rYl044eitkdzBuwPFkvx0Drh/XrBtIb9Ytt9HFrS2?=
 =?us-ascii?Q?5G8YJ7LMaOtXJ/IfZtr5PjmbGf0sPGYQ5iSzkzpPGeRdVHnRHGwSdDs0V+3Q?=
 =?us-ascii?Q?bRH/+nO7pHFPkomf776mItgeyODOe1FMZ3C62+zxwmHmx/h0yzFIZ1awmDDI?=
 =?us-ascii?Q?K8KvYIO1GhWQ2UKiW3Jz+YksiLBN?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(1800799015)(376005)(36860700004);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:19.1382
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 7bd61ccd-481b-4824-78e0-08dc757fe7ed
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A7.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR12MB6256

From: Alejandro Lucero <alucerop@amd.com>

CXL Type 2 devices imply specific vendor drivers binding to those
devices instead of generic ones offered by CXL core like the PCI driver.
Those drivers need to use CXL core functions and structs for
initialization, create memdevs and create CXL regions.

This patch avoids referencing those files based on relative paths from
inside the kernel sources tree.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/acpi.c                      | 4 ++--
 drivers/cxl/core/cdat.c                 | 6 +++---
 drivers/cxl/core/hdm.c                  | 2 +-
 drivers/cxl/core/mbox.c                 | 6 +++---
 drivers/cxl/core/memdev.c               | 2 +-
 drivers/cxl/core/pci.c                  | 6 +++---
 drivers/cxl/core/pmem.c                 | 4 ++--
 drivers/cxl/core/pmu.c                  | 4 ++--
 drivers/cxl/core/port.c                 | 6 +++---
 drivers/cxl/core/region.c               | 4 ++--
 drivers/cxl/core/regs.c                 | 4 ++--
 drivers/cxl/core/suspend.c              | 2 +-
 drivers/cxl/core/trace.c                | 2 +-
 drivers/cxl/core/trace.h                | 4 ++--
 drivers/cxl/mem.c                       | 4 ++--
 drivers/cxl/pci.c                       | 6 +++---
 drivers/cxl/pmem.c                      | 4 ++--
 drivers/cxl/port.c                      | 4 ++--
 drivers/cxl/security.c                  | 4 ++--
 drivers/dax/cxl.c                       | 2 +-
 drivers/perf/cxl_pmu.c                  | 4 ++--
 {drivers/cxl => include/linux}/cxl.h    | 0
 {drivers/cxl => include/linux}/cxlmem.h | 2 +-
 {drivers/cxl => include/linux}/cxlpci.h | 0
 tools/testing/cxl/cxl_core_exports.c    | 2 +-
 tools/testing/cxl/mock_acpi.c           | 2 +-
 tools/testing/cxl/test/cxl.c            | 2 +-
 tools/testing/cxl/test/mem.c            | 2 +-
 tools/testing/cxl/test/mock.c           | 4 ++--
 tools/testing/cxl/test/mock.h           | 2 +-
 30 files changed, 50 insertions(+), 50 deletions(-)
 rename {drivers/cxl => include/linux}/cxl.h (100%)
 rename {drivers/cxl => include/linux}/cxlmem.h (99%)
 rename {drivers/cxl => include/linux}/cxlpci.h (100%)

diff --git a/drivers/cxl/acpi.c b/drivers/cxl/acpi.c
index cb8c155a2c9b..f023898382bc 100644
--- a/drivers/cxl/acpi.c
+++ b/drivers/cxl/acpi.c
@@ -8,8 +8,8 @@
 #include <linux/pci.h>
 #include <linux/node.h>
 #include <asm/div64.h>
-#include "cxlpci.h"
-#include "cxl.h"
+#include <linux/cxlpci.h>
+#include <linux/cxl.h>
 
 #define CXL_RCRB_SIZE	SZ_8K
 
diff --git a/drivers/cxl/core/cdat.c b/drivers/cxl/core/cdat.c
index bb83867d9fec..97ff1dfd63d6 100644
--- a/drivers/cxl/core/cdat.c
+++ b/drivers/cxl/core/cdat.c
@@ -5,10 +5,10 @@
 #include <linux/fw_table.h>
 #include <linux/node.h>
 #include <linux/overflow.h>
-#include "cxlpci.h"
-#include "cxlmem.h"
+#include <linux/cxlpci.h>
+#include <linux/cxlmem.h>
 #include "core.h"
-#include "cxl.h"
+#include <linux/cxl.h>
 #include "core.h"
 
 struct dsmas_entry {
diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index 7d97790b893d..47d9faf5897f 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -4,7 +4,7 @@
 #include <linux/device.h>
 #include <linux/delay.h>
 
-#include "cxlmem.h"
+#include <linux/cxlmem.h>
 #include "core.h"
 
 /**
diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
index f0f54aeccc87..d312b82f7f36 100644
--- a/drivers/cxl/core/mbox.c
+++ b/drivers/cxl/core/mbox.c
@@ -5,9 +5,9 @@
 #include <linux/ktime.h>
 #include <linux/mutex.h>
 #include <asm/unaligned.h>
-#include <cxlpci.h>
-#include <cxlmem.h>
-#include <cxl.h>
+#include <linux/cxlpci.h>
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 
 #include "core.h"
 #include "trace.h"
diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index d4e259f3a7e9..07cd0b8b026f 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -7,7 +7,7 @@
 #include <linux/slab.h>
 #include <linux/idr.h>
 #include <linux/pci.h>
-#include <cxlmem.h>
+#include <linux/cxlmem.h>
 #include "trace.h"
 #include "core.h"
 
diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 0df09bd79408..a494a03b4a83 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -7,9 +7,9 @@
 #include <linux/pci.h>
 #include <linux/pci-doe.h>
 #include <linux/aer.h>
-#include <cxlpci.h>
-#include <cxlmem.h>
-#include <cxl.h>
+#include <linux/cxlpci.h>
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 #include "core.h"
 #include "trace.h"
 
diff --git a/drivers/cxl/core/pmem.c b/drivers/cxl/core/pmem.c
index e69625a8d6a1..d1a5f8d9cf91 100644
--- a/drivers/cxl/core/pmem.c
+++ b/drivers/cxl/core/pmem.c
@@ -3,8 +3,8 @@
 #include <linux/device.h>
 #include <linux/slab.h>
 #include <linux/idr.h>
-#include <cxlmem.h>
-#include <cxl.h>
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 #include "core.h"
 
 /**
diff --git a/drivers/cxl/core/pmu.c b/drivers/cxl/core/pmu.c
index 5d8e06b0ba6e..aa02ea582184 100644
--- a/drivers/cxl/core/pmu.c
+++ b/drivers/cxl/core/pmu.c
@@ -4,9 +4,9 @@
 #include <linux/device.h>
 #include <linux/slab.h>
 #include <linux/idr.h>
-#include <cxlmem.h>
+#include <linux/cxlmem.h>
 #include <pmu.h>
-#include <cxl.h>
+#include <linux/cxl.h>
 #include "core.h"
 
 static void cxl_pmu_release(struct device *dev)
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 762783bb091a..fdd76306260d 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -11,9 +11,9 @@
 #include <linux/slab.h>
 #include <linux/idr.h>
 #include <linux/node.h>
-#include <cxlmem.h>
-#include <cxlpci.h>
-#include <cxl.h>
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
+#include <linux/cxl.h>
 #include "core.h"
 
 /**
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 5c186e0a39b9..70e86a7c241d 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -9,8 +9,8 @@
 #include <linux/uuid.h>
 #include <linux/sort.h>
 #include <linux/idr.h>
-#include <cxlmem.h>
-#include <cxl.h>
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 #include "core.h"
 
 /**
diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
index 3c42f984eeaf..fd165e718cf2 100644
--- a/drivers/cxl/core/regs.c
+++ b/drivers/cxl/core/regs.c
@@ -4,8 +4,8 @@
 #include <linux/device.h>
 #include <linux/slab.h>
 #include <linux/pci.h>
-#include <cxlmem.h>
-#include <cxlpci.h>
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
 #include <pmu.h>
 
 #include "core.h"
diff --git a/drivers/cxl/core/suspend.c b/drivers/cxl/core/suspend.c
index a5984d96ea1d..117b3398ee56 100644
--- a/drivers/cxl/core/suspend.c
+++ b/drivers/cxl/core/suspend.c
@@ -2,7 +2,7 @@
 /* Copyright(c) 2022 Intel Corporation. All rights reserved. */
 #include <linux/atomic.h>
 #include <linux/export.h>
-#include "cxlmem.h"
+#include <linux/cxlmem.h>
 
 static atomic_t mem_active;
 
diff --git a/drivers/cxl/core/trace.c b/drivers/cxl/core/trace.c
index d0403dc3c8ab..1e6ba0de237a 100644
--- a/drivers/cxl/core/trace.c
+++ b/drivers/cxl/core/trace.c
@@ -1,7 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0-only
 /* Copyright(c) 2022 Intel Corporation. All rights reserved. */
 
-#include <cxl.h>
+#include <linux/cxl.h>
 #include "core.h"
 
 #define CREATE_TRACE_POINTS
diff --git a/drivers/cxl/core/trace.h b/drivers/cxl/core/trace.h
index e5f13260fc52..e3b1156a01ad 100644
--- a/drivers/cxl/core/trace.h
+++ b/drivers/cxl/core/trace.h
@@ -10,8 +10,8 @@
 #include <linux/pci.h>
 #include <asm-generic/unaligned.h>
 
-#include <cxl.h>
-#include <cxlmem.h>
+#include <linux/cxl.h>
+#include <linux/cxlmem.h>
 #include "core.h"
 
 #define CXL_RAS_UC_CACHE_DATA_PARITY	BIT(0)
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index 0c79d9ce877c..6dc2bf1e2b1a 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -5,8 +5,8 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 
-#include "cxlmem.h"
-#include "cxlpci.h"
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
 
 /**
  * DOC: cxl mem
diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index 2ff361e756d6..ccde33ac9c1c 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -11,9 +11,9 @@
 #include <linux/pci.h>
 #include <linux/aer.h>
 #include <linux/io.h>
-#include "cxlmem.h"
-#include "cxlpci.h"
-#include "cxl.h"
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
+#include <linux/cxl.h>
 #include "pmu.h"
 
 /**
diff --git a/drivers/cxl/pmem.c b/drivers/cxl/pmem.c
index 7cb8994f8809..deadc5ffc2c2 100644
--- a/drivers/cxl/pmem.c
+++ b/drivers/cxl/pmem.c
@@ -8,8 +8,8 @@
 #include <linux/async.h>
 #include <linux/slab.h>
 #include <linux/nd.h>
-#include "cxlmem.h"
-#include "cxl.h"
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 
 extern const struct nvdimm_security_ops *cxl_security_ops;
 
diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
index 97c21566677a..928ebff774ce 100644
--- a/drivers/cxl/port.c
+++ b/drivers/cxl/port.c
@@ -4,8 +4,8 @@
 #include <linux/module.h>
 #include <linux/slab.h>
 
-#include "cxlmem.h"
-#include "cxlpci.h"
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
 
 /**
  * DOC: cxl port
diff --git a/drivers/cxl/security.c b/drivers/cxl/security.c
index 21856a3f408e..129b36928a05 100644
--- a/drivers/cxl/security.c
+++ b/drivers/cxl/security.c
@@ -6,8 +6,8 @@
 #include <linux/async.h>
 #include <linux/slab.h>
 #include <linux/memregion.h>
-#include "cxlmem.h"
-#include "cxl.h"
+#include <linux/cxlmem.h>
+#include <linux/cxl.h>
 
 static unsigned long cxl_pmem_get_security_flags(struct nvdimm *nvdimm,
 						 enum nvdimm_passphrase_type ptype)
diff --git a/drivers/dax/cxl.c b/drivers/dax/cxl.c
index c696837ab23c..89a5c8eb666e 100644
--- a/drivers/dax/cxl.c
+++ b/drivers/dax/cxl.c
@@ -3,7 +3,7 @@
 #include <linux/module.h>
 #include <linux/dax.h>
 
-#include "../cxl/cxl.h"
+#include <linux/cxl.h>
 #include "bus.h"
 
 static int cxl_dax_region_probe(struct device *dev)
diff --git a/drivers/perf/cxl_pmu.c b/drivers/perf/cxl_pmu.c
index 308c9969642e..9b93ba215bdb 100644
--- a/drivers/perf/cxl_pmu.c
+++ b/drivers/perf/cxl_pmu.c
@@ -20,8 +20,8 @@
 #include <linux/bug.h>
 #include <linux/pci.h>
 
-#include "../cxl/cxlpci.h"
-#include "../cxl/cxl.h"
+#include <linux/cxlpci.h>
+#include <linux/cxl.h>
 #include "../cxl/pmu.h"
 
 #define CXL_PMU_CAP_REG			0x0
diff --git a/drivers/cxl/cxl.h b/include/linux/cxl.h
similarity index 100%
rename from drivers/cxl/cxl.h
rename to include/linux/cxl.h
diff --git a/drivers/cxl/cxlmem.h b/include/linux/cxlmem.h
similarity index 99%
rename from drivers/cxl/cxlmem.h
rename to include/linux/cxlmem.h
index 36cee9c30ceb..0d26a45a4af2 100644
--- a/drivers/cxl/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -8,7 +8,7 @@
 #include <linux/rcuwait.h>
 #include <linux/cxl-event.h>
 #include <linux/node.h>
-#include "cxl.h"
+#include <linux/cxl.h>
 
 /* CXL 2.0 8.2.8.5.1.1 Memory Device Status Register */
 #define CXLMDEV_STATUS_OFFSET 0x0
diff --git a/drivers/cxl/cxlpci.h b/include/linux/cxlpci.h
similarity index 100%
rename from drivers/cxl/cxlpci.h
rename to include/linux/cxlpci.h
diff --git a/tools/testing/cxl/cxl_core_exports.c b/tools/testing/cxl/cxl_core_exports.c
index 077e6883921d..737b49ed3e46 100644
--- a/tools/testing/cxl/cxl_core_exports.c
+++ b/tools/testing/cxl/cxl_core_exports.c
@@ -1,7 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0
 /* Copyright(c) 2022 Intel Corporation. All rights reserved. */
 
-#include "cxl.h"
+#include <linux/cxl.h>
 
 /* Exporting of cxl_core symbols that are only used by cxl_test */
 EXPORT_SYMBOL_NS_GPL(cxl_num_decoders_committed, CXL);
diff --git a/tools/testing/cxl/mock_acpi.c b/tools/testing/cxl/mock_acpi.c
index 55813de26d46..4e440a9c0cb2 100644
--- a/tools/testing/cxl/mock_acpi.c
+++ b/tools/testing/cxl/mock_acpi.c
@@ -4,7 +4,7 @@
 #include <linux/platform_device.h>
 #include <linux/device.h>
 #include <linux/acpi.h>
-#include <cxl.h>
+#include <linux/cxl.h>
 #include "test/mock.h"
 
 struct acpi_device *to_cxl_host_bridge(struct device *host, struct device *dev)
diff --git a/tools/testing/cxl/test/cxl.c b/tools/testing/cxl/test/cxl.c
index 61c69297e797..848c42c2c158 100644
--- a/tools/testing/cxl/test/cxl.c
+++ b/tools/testing/cxl/test/cxl.c
@@ -8,7 +8,7 @@
 #include <linux/acpi.h>
 #include <linux/pci.h>
 #include <linux/mm.h>
-#include <cxlmem.h>
+#include <linux/cxlmem.h>
 
 #include "../watermark.h"
 #include "mock.h"
diff --git a/tools/testing/cxl/test/mem.c b/tools/testing/cxl/test/mem.c
index 35ee41e435ab..dcddb6affc0d 100644
--- a/tools/testing/cxl/test/mem.c
+++ b/tools/testing/cxl/test/mem.c
@@ -9,7 +9,7 @@
 #include <linux/bits.h>
 #include <asm/unaligned.h>
 #include <crypto/sha2.h>
-#include <cxlmem.h>
+#include <linux/cxlmem.h>
 
 #include "trace.h"
 
diff --git a/tools/testing/cxl/test/mock.c b/tools/testing/cxl/test/mock.c
index 6f737941dc0e..a1366a24677f 100644
--- a/tools/testing/cxl/test/mock.c
+++ b/tools/testing/cxl/test/mock.c
@@ -7,8 +7,8 @@
 #include <linux/export.h>
 #include <linux/acpi.h>
 #include <linux/pci.h>
-#include <cxlmem.h>
-#include <cxlpci.h>
+#include <linux/cxlmem.h>
+#include <linux/cxlpci.h>
 #include "mock.h"
 
 static LIST_HEAD(mock);
diff --git a/tools/testing/cxl/test/mock.h b/tools/testing/cxl/test/mock.h
index d1b0271d2822..bf7ec147ea80 100644
--- a/tools/testing/cxl/test/mock.h
+++ b/tools/testing/cxl/test/mock.h
@@ -2,7 +2,7 @@
 
 #include <linux/list.h>
 #include <linux/acpi.h>
-#include <cxl.h>
+#include <linux/cxl.h>
 
 struct cxl_mock_ops {
 	struct list_head list;
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (mail-mw2nam04on2070.outbound.protection.outlook.com [40.107.101.70])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BDCDF6BFBF
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.101.70
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847150; cv=fail; b=NK45Bpfe/aUmbrLneq/RUggDWsj710ZFZRGeYgHQhQEtbsBLJm5YgeMEag2RqUzS30+1wj0A9fa7kScKY91b2JBY9LReCDaoriaYs2nw83lBAqiHS7KwD7bzFx0MTf3BlyH2foOMxI1AsVaNI/lwRUnULVSRtiwFZQvmJui6C2I=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847150; c=relaxed/simple;
	bh=c0KtIH8yXvmwOdQjrS40942Z0AGQeBj6m2JzQu3YBFQ=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=GxClE3AKiIsBJFgRAufUEunsPDHwl3I4zh0qPM/JwcJ1EFDTACA8Tg7+edXs2OYL+MqgNivrY0hAfbBEJz+mFi7/o16gZxVvNLh3xXPha2jUbwo/TlOHKq229thyPwYs5aT4033g+JfdsNTttMryxq501FLR/bRYrFynS0s8Y88=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=tXoKygoB; arc=fail smtp.client-ip=40.107.101.70
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="tXoKygoB"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=j2GnsdKxRvSHDkMNEdp4NX96Az9SOiLLCgPLVqmTk0XkWMu56fiky2TshyCqJacuDmM4xIq3aBPz/URvdEW9LA/BuzLe/r7WT1BSN8ADgzvooPyX4htzug7+IS2Zv7Kamv0xgY4XeuFK5moBS9NefVHyVXMPMNfhQfkqF2e0nyBn4cIKgHcYERLPNt0tt2t5DGI1xgF4GaTPGMD1SJnMabL23d3WuL61QiGDaAF1jIytByKggvopem4VHMxMxv/Ew2/Jldx0z41U/x1tFuozVC3KPmpoWY6ZO/KOEq430+zPZW8fFaIzKub88VNzBNBNwdQCyoOJUiYqToUW+oOsbA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=JR1A5+VgjuB09UPRqcWpkzGStEfOuEU44vbDaafBhiE=;
 b=fxhCRLuhZh72tJsE0vSAoRVWXCAURa/gu9KBAJdkU2FY36fNCnTANHxbmIavIfiZj3vbmBIB4g8U5ucuXt7jeReBf//kJD+V9cVOPV1myRlm+VZ5KJqn7HELmyyjHqWUIFe9Bvq/OdaQWaidLn2PIOtFk6jIGrvLHtB9OgSwSMsCBBWotq4IzyWWd3U8ceHF+BS71c4OKIDqqlJdGWog3z6gHNHl0pG0KYnAH5N0XoZWRH2emRFIuQ90Gz0iYAUr5jZbA2T1xsAxo79+YJmI7hON7h+vHkI9OVJnF7dV5ZDH7IMJ8lWFZceQbg/cquBx8+qk2TPQiLGz8fQCU12Xow==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=JR1A5+VgjuB09UPRqcWpkzGStEfOuEU44vbDaafBhiE=;
 b=tXoKygoBtb0JMm+2Nt5NWGd+sBRWiBu3YQ148wplam76VwcnWxtAeLi1l/AdyTciCusvTt3gJquKMvURt78kQrJR5VEFWrCO/mZRAkDX83KvH5rIq5PMa8ypxu3s6YJa4mQKinlrN9CuMJ1TR7sVD22hor9H6qK7ywccWd7kE2g=
Received: from BN0PR03CA0032.namprd03.prod.outlook.com (2603:10b6:408:e7::7)
 by CY5PR12MB6321.namprd12.prod.outlook.com (2603:10b6:930:22::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Thu, 16 May
 2024 08:12:26 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::92) by BN0PR03CA0032.outlook.office365.com
 (2603:10b6:408:e7::7) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28 via Frontend
 Transport; Thu, 16 May 2024 08:12:26 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:26 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:21 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:20 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 05/13] cxl: fix check about pmem resource
Date: Thu, 16 May 2024 09:11:54 +0100
Message-ID: <20240516081202.27023-6-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|CY5PR12MB6321:EE_
X-MS-Office365-Filtering-Correlation-Id: 9f72d333-6daa-45e6-25bb-08dc757fec36
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|376005|1800799015|36860700004|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?N2Vlb013bk9GblZPTXMzYXByK0Q2OFgrc2ZNNlNBNERPejM5NzBPYW1paXl0?=
 =?utf-8?B?WWZsRndyZWtWZWRDL2paRkJ6QzVqTnJoWWRCZXJ2MkFvc1BrRlVCWCt3TVcr?=
 =?utf-8?B?R0JHT3BHZXBDUjBpaXFJajFKUFJxeFlxNUh3bDZpM1hOeGdtMlk1bXU1YWtE?=
 =?utf-8?B?Z0RaaGVtTzlvUE1wSTVkd1ZGR0Y4Wi9QM0FnSUx5MkhURG0waWZMaEJTVWxk?=
 =?utf-8?B?dGVQZDBLT1BGOXNtNlpwcmgvRGNVKzFlb3lwajdPenN2YTZ6N0RCU0RoeGVp?=
 =?utf-8?B?S1RuMU84WXQvWGQzUWZEM3FMRU52S3YyQUFTb1cvRHdsekt4bUhaZDdtdmNE?=
 =?utf-8?B?dnpLTGFkdjFESi91SUY2RVJIQzZFSWZCcmFqY2c2OW43U3FleE9HVlZia1lu?=
 =?utf-8?B?YnNZRHhUU0hzTUFoK3NYME0xeDRRdVJLaVpvQU1RL2M4ZXl2Q1oyUEMyUW84?=
 =?utf-8?B?QktCd0p5NDA3a3dEUXhDd0NySkJmWFdKdldQVHN1dmExM2FBaStIeEk4TFlN?=
 =?utf-8?B?VnNkL3hOenVQUlYxaHorSitCaEd5U04zZlVNNUkyNEZUWnlTb2VYOW9QUndz?=
 =?utf-8?B?RE5kQUtkcm1EK2syZWprZmNrV2ZlbWU3UHhkcFZDSHBWNkNQTU5uZkNCZTB4?=
 =?utf-8?B?ZW1naENXQ2t4akIxVXFZQjhDaEhjS2RRSm5lTk1IeVF6SzdjWTE0ckI2QmFr?=
 =?utf-8?B?VDg0YXNEN25jSy9DVm1EbXBiOTV4Zy9nK2xnam1TQzA3Uk9xTVlkSnArWVJs?=
 =?utf-8?B?VlJEeExuc1RQUGRnWFhhTkR3Q2h2OUUzR1ZlRytjMjBmbDFZNVZ1Qm15QVFT?=
 =?utf-8?B?LzNXak1pTWlDOHYyYmk5cW13bmZnWXpmQndJdVhGNjYyWW56VnFRVGpVQUh6?=
 =?utf-8?B?T1I3WitLd3BDSjNPZkg3WmlEaG10ZEl0eGowUDkrdTJMNEo2UHZiQnlaUG9v?=
 =?utf-8?B?cXQ4aDl0RjhUYTgzdGJXNldqYVgxeWFPbEhZTWpRUU1jbXZFR3c0S1hZeno4?=
 =?utf-8?B?TkRYTEpvbmhqRi9lYkN5OEJYR1NjQjF2amJuUy9TQzltM2hTcHNLYlJ2d3ZN?=
 =?utf-8?B?UTNnaUtnQkppN0prOHFMWDBkTXdhcitDWC9YcDdzTWo1eWxXT1V5RXlBckpW?=
 =?utf-8?B?RjRqOHR4VE9Db2ovOHpzYWpLRWlxRnFIZllCTUNZRVgzejBxOXV6dWk0Q0VY?=
 =?utf-8?B?VzNrWmsyREszb0tPeWo2Tmloa05RL0RTSmtleFh0eGdYb2RxZVVEQ3ZMNm1E?=
 =?utf-8?B?YVI3ZUpsWVRmSEE5K2oyK2QrK0tKWEVId1FNYWRSd3lpY0d4UXMvZHNONEhu?=
 =?utf-8?B?NE9KRUlvWHpZaGhZckJCZER4WThldWZIRnRpeXlWNzB6MEZ5QzVDS2JPUHA1?=
 =?utf-8?B?dGFVR1dQSC8vWXpWclJSZEplR0gxblUyYmZaT091REN1cUR1UmEyc2FtN3JI?=
 =?utf-8?B?Ti9LaUZpcDNHTTJ5NXhiK2pURURrbENBTnVDQVN1RU9uU1lPTTJ1bGpMRThi?=
 =?utf-8?B?TkFGajd1cDZDcjlLWjk3VktjYkNZZWljQVA1ZzFVamQwYjdZZGYrNHFYcXVW?=
 =?utf-8?B?cGYvLzBEK3k2RU1rOElMMmhQNVdRVUk2N1dOVGp4ZjJIWnd0Wnkvbks3cW9y?=
 =?utf-8?B?VGFTbjhJZ21uQk93b0hmSlZnNmhUMldIZnJpQjAvdGJROHNuRGZBTm5TZzNR?=
 =?utf-8?B?SnFNc3l3Y1dlM2NFZ0tvUWYxZytmSWtjSHkvYWxDRm5xTUN2UjFIdEU3a3R2?=
 =?utf-8?B?aEFqTVE3MnMwQlNTTXZCaHFJSExXekdBMkZTeHhtVUZGT2FVbVoraDFpUDA1?=
 =?utf-8?B?bEwzL2F3TlQwRktZR0dYVkxSUGRJNUNhT0RFSWZoRGlIcWxKRVgvTVFsOVdS?=
 =?utf-8?Q?0gH8IdNZ2srnz?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(376005)(1800799015)(36860700004)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:26.3567
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9f72d333-6daa-45e6-25bb-08dc757fec36
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY5PR12MB6321

From: Alejandro Lucero <alucerop@amd.com>

Current check is using resource_size which counts on a range bigger than
0. For a resource with start and end being 0, resource_size returns 1
and implying a false positive. Use the end not being zero as the new check.

Note: If IÂ´m not missing anything here, this should be extended to the
whole linux kernel where resource_size is being used in conditionals,
and where the likely right fix is to modify resource_size itself
checking for the range not being 0.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/hdm.c    | 4 ++--
 drivers/cxl/core/memdev.c | 8 ++++----
 drivers/cxl/mem.c         | 2 +-
 3 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index 47d9faf5897f..c5f70741d70a 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -432,12 +432,12 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 	 * Only allow modes that are supported by the current partition
 	 * configuration
 	 */
-	if (mode == CXL_DECODER_PMEM && !resource_size(&cxlds->pmem_res)) {
+	if (mode == CXL_DECODER_PMEM && !cxlds->pmem_res.end) {
 		dev_dbg(dev, "no available pmem capacity\n");
 		rc = -ENXIO;
 		goto out;
 	}
-	if (mode == CXL_DECODER_RAM && !resource_size(&cxlds->ram_res)) {
+	if (mode == CXL_DECODER_RAM && !cxlds->ram_res.end) {
 		dev_dbg(dev, "no available ram capacity\n");
 		rc = -ENXIO;
 		goto out;
diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 0336b3f14f4a..b61d57d0d4f4 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -197,14 +197,14 @@ static int cxl_get_poison_by_memdev(struct cxl_memdev *cxlmd)
 	int rc = 0;
 
 	/* CXL 3.0 Spec 8.2.9.8.4.1 Separate pmem and ram poison requests */
-	if (resource_size(&cxlds->pmem_res)) {
+	if (cxlds->pmem_res.end) {
 		offset = cxlds->pmem_res.start;
 		length = resource_size(&cxlds->pmem_res);
 		rc = cxl_mem_get_poison(cxlmd, offset, length, NULL);
 		if (rc)
 			return rc;
 	}
-	if (resource_size(&cxlds->ram_res)) {
+	if (cxlds->ram_res.end) {
 		offset = cxlds->ram_res.start;
 		length = resource_size(&cxlds->ram_res);
 		rc = cxl_mem_get_poison(cxlmd, offset, length, NULL);
@@ -266,7 +266,7 @@ static int __cxl_dpa_to_region(struct device *dev, void *arg)
 		return 0;
 
 	cxled = to_cxl_endpoint_decoder(dev);
-	if (!cxled->dpa_res || !resource_size(cxled->dpa_res))
+	if (!cxled->dpa_res || !cxled->dpa_res->end)
 		return 0;
 
 	if (dpa > cxled->dpa_res->end || dpa < cxled->dpa_res->start)
@@ -302,7 +302,7 @@ static int cxl_validate_poison_dpa(struct cxl_memdev *cxlmd, u64 dpa)
 	if (!IS_ENABLED(CONFIG_DEBUG_FS))
 		return 0;
 
-	if (!resource_size(&cxlds->dpa_res)) {
+	if (!cxlds->dpa_res.end) {
 		dev_dbg(cxlds->dev, "device has no dpa resource\n");
 		return -EINVAL;
 	}
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index 6dc2bf1e2b1a..a168343d2d4d 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -174,7 +174,7 @@ static int cxl_mem_probe(struct device *dev)
 	if (rc)
 		return rc;
 
-	if (resource_size(&cxlds->pmem_res) && IS_ENABLED(CONFIG_CXL_PMEM)) {
+	if (cxlds->pmem_res.end && IS_ENABLED(CONFIG_CXL_PMEM)) {
 		rc = devm_cxl_add_nvdimm(cxlmd);
 		if (rc == -ENODEV)
 			dev_info(dev, "PMEM disabled by platform\n");
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2046.outbound.protection.outlook.com [40.107.220.46])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3F4467E58D
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.46
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847150; cv=fail; b=A/vhUyJu9OHwpNqfF/DwEzblshayeouWYsmqg6L5ZW5oh5D34w2ZdwVCBJJyEsZAd09UMdTJFSsj+yDfBlwM9iStf2ELkJrbSy2MNagMTBqH5SGckaYjdtor1hriX3XhTsR/qAuB6BTli67hisPHlkrQE+KjyzhltZmtz0GmgEs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847150; c=relaxed/simple;
	bh=kN9IZQ7T7E4n63OS7vREzH3d82jNHckgtnRm4o1yZKE=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=NDEEmswlfhKYS9VRna56VCPOogMph5yn0yl/yS1UkTQRhD4ttfQLAH11onmkqoFu/4bbYSCCvmtE4j+Qw88h1uED7kwhpee8nFndAmslUlLJJn2uW31oc0l8dhqwnOVSmg1P0lxJLL/9CruSoQfAxOa24CtHqxrYnyiMg7MvecY=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=lVKM3FhH; arc=fail smtp.client-ip=40.107.220.46
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="lVKM3FhH"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=FCP/9Wvxj93WwBszt9ceNQbv1gYrOZYmpr4tqM5c2Miw7E0m5gdgfrYqqh8FkC3r9v7x3RuXcczRdNlmIgpQ4rKsq7gEo5h2UQWZ/5nBvSX11L4/YnZ5Lv3AKe3uEgHQ+7xZjkalPiW+w7ByAon+uwZHZHppg+SSLi7EG5ZL/zRIBgaaPwNqlIa9G1TPp0hzPcCRmV6J9dDjsaO6Zxmp0DpYk2brYp/Sp/RycoKuw8wNwOD4QkZAec+PWxhYAc5aailrLMETFhjAnwfu9kZY4SSPNVFbCcvl86BwY8VLkePrr6k141Leia0u+Bpcq0qaJ8UTG21sYmawj5ZX6sH31Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=TVn1IW9P2sa5eVgPMqQ6DaYw311Qqeh5957jWgj3pKM=;
 b=C84giUHOeYqRXfDg7znp/bPCUHwzAl2LuY1V2umA09g8xgFl9N1uHkuGG6S+RMPQuQzb2+y8scyYYs9PS86+DIxvOT4Fivh5ioQtZK1d3GMdI/9Xia4Z8IUCi74Q/GtI2q/U17jzILiVlP+y94mKE+bTpe6Vk3f2tGlN3/Nxo5dj0MtDc7v00hQ/24my3FjJ2qzHNmSAE/mSNlvAh4Cq5UAavmkVoqk2S2udvOQXKrUAKIVB984ZdrAJWWwZ+/tCGom6DOSEIG4XhU5aSVaYU4X9WPO9SS089J6wqdaXgK6gTqP9AQljldPVRynUk92kmyF3w38I69Kcps5qylHfJw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=TVn1IW9P2sa5eVgPMqQ6DaYw311Qqeh5957jWgj3pKM=;
 b=lVKM3FhHsiF8nD5riNsOkeelr8ryAUV9Txb94FUqTYn/ddryS6L0X057eeECk7jGcgd2alKnI/7o+9hT6xZvbznZli4vIi7VGk+xtGrrtQ1g0qImRdF4bTkTU+lJvVP0cZb3K1DYdLw5EV+fjfDI85jsW6Lvimvd7fC7NNofPjM=
Received: from BN0PR03CA0044.namprd03.prod.outlook.com (2603:10b6:408:e7::19)
 by MW4PR12MB7287.namprd12.prod.outlook.com (2603:10b6:303:22c::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.27; Thu, 16 May
 2024 08:12:25 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::c3) by BN0PR03CA0044.outlook.office365.com
 (2603:10b6:408:e7::19) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55 via Frontend
 Transport; Thu, 16 May 2024 08:12:24 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:24 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:20 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:19 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 04/13] cxl: allow devices without mailbox capability
Date: Thu, 16 May 2024 09:11:53 +0100
Message-ID: <20240516081202.27023-5-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|MW4PR12MB7287:EE_
X-MS-Office365-Filtering-Correlation-Id: c0ee4924-b57f-45f7-ba31-08dc757feb47
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|1800799015|376005|36860700004;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?RO94yRxgfXg6wnNZ4Bw9CYFyGZOdPWryy1KcMej59m9VfhX3mlRTU+4tYOuq?=
 =?us-ascii?Q?QTQH3j9g6x5514kXmnsoKiuMoOsN0ExLGFnD2FpbUYekuNHrpR9SrOpE8gNF?=
 =?us-ascii?Q?lW0DajzUcJxZJiWLhAfUG8mBagL5eP+kBx+0QTLu+orqzzlro5nhCGsZFbeL?=
 =?us-ascii?Q?foUNfZHQUb+GEM1w4WxV3Bbon4feuGmTsyXb307etbYJmxju6gevc/jWYiM4?=
 =?us-ascii?Q?NrXvB7ESZxXmbfuQA1uS3k+pqQuNcZx7zp2nt1MWZ/Ft2JO4sVM7WTplxWKd?=
 =?us-ascii?Q?Hk5cwcRmOUWEDhALxK4LGbGGjfWfAGNnlhLVt+WQ6OwqCvOgZStwuX469tJ5?=
 =?us-ascii?Q?xYfb951iBILzoa6RRxhJCnAIIMcuPIfKhJgf7d6jOx6CK290Ut8/eLDiXDMw?=
 =?us-ascii?Q?+gdZ5QCxEJv57hQF3OvosrUpcv6eoxYlg0Iyb9PSv4UfRT5knjSwIbXOxfNn?=
 =?us-ascii?Q?zQxxjkzxL7iEH7GSgKBPp33Fv+QqAQ3jNaFnCecD5/ajsIOEBexqDy7BbvI8?=
 =?us-ascii?Q?BZWPNLNthRJTYdACwTk4Cld9Nd4yPTI8s+eQ7zpXLiSB1GD9nxjBsTjA69ZN?=
 =?us-ascii?Q?ER6AxmwxbaDaJqMqFFUOCOgKaIcEwT3LYWMIMQY62Ay/KLwl1EOPiitj20Ug?=
 =?us-ascii?Q?v941sWZzfmBqmClNe7qgKL/+kIdH/pHiapvndHtYlLzb2J/KWlBfIya9KzG3?=
 =?us-ascii?Q?krBB0VWsTRdHI+OQk6ZMVl9WK+R6qBm1cgsipLB3iBEuDaoeizYe/kJtaEPx?=
 =?us-ascii?Q?GBEE0WRA33qdpOliAUduMmrA8oJ9/pQm9zXHJcyoM10bQ7y0H5NG+YvHEGIN?=
 =?us-ascii?Q?OVVTHdeNvbOa/V/v9jp76xlXCSSpQpVVJi7MZJKtbO4e5b0k936Q6QT5sb87?=
 =?us-ascii?Q?gJPMwP2FOncfi04ZosNppw8xdokuQdKCsCa26opScfR+ftcGE85TykrO/kw/?=
 =?us-ascii?Q?H02LjfjKQDkaDEgIOX9S4OK8I3mD4wEQbc/f8IFNv/czXdTKEXYWFqCVvCjz?=
 =?us-ascii?Q?lLZngOOo7w9uZ45X1DvYumJtJYRF/dC0+Nc/aS8aY8Q6HOzc6twi/atQd6zj?=
 =?us-ascii?Q?PbJRGHGybQBrTGe/doxH0nktDr0VbfI07vHNaZSi0QeX5W8as3lSS3jJVZIF?=
 =?us-ascii?Q?MfWj/JOvPcvLfrI/QzLfnuJLg0xPTG+0lcSWKf+sarzDlLOll7PLcIprrVYx?=
 =?us-ascii?Q?eHs3sILQ5HVQxyhPwTYrnJ4BQX7bVV6w0rRKIJj4i6aGH1974jiHwBUr4+j/?=
 =?us-ascii?Q?WQtbV8r2r3zUnSlkWPg7jcLscG/U9lQ1R1Wyqv5xidmGGHgKmQ0SxVMK6HOv?=
 =?us-ascii?Q?GnhLJGaF016nMNvOLFzbfEv3s39dtF5NxEQbwJZzU10ShSSexuaylOOf9dXx?=
 =?us-ascii?Q?tZokxyxCIfe/bPDqGGKR1vDr7yXy?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(1800799015)(376005)(36860700004);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:24.7941
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: c0ee4924-b57f-45f7-ba31-08dc757feb47
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR12MB7287

From: Alejandro Lucero <alucerop@amd.com>

A device not implementing the CXL memory-device class code, aka Type2
devices, has mailbox capability as optional. If the device registers
mapping does not show such capability, do not treat that as an error.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/regs.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/drivers/cxl/core/regs.c b/drivers/cxl/core/regs.c
index fd165e718cf2..5434a7c899fd 100644
--- a/drivers/cxl/core/regs.c
+++ b/drivers/cxl/core/regs.c
@@ -437,11 +437,10 @@ static int cxl_probe_regs(struct cxl_register_map *map)
 	case CXL_REGLOC_RBI_MEMDEV:
 		dev_map = &map->device_map;
 		cxl_probe_device_regs(host, base, dev_map);
-		if (!dev_map->status.valid || !dev_map->mbox.valid ||
+		if (!dev_map->status.valid ||
 		    !dev_map->memdev.valid) {
-			dev_err(host, "registers not found: %s%s%s\n",
+			dev_err(host, "registers not found: %s%s\n",
 				!dev_map->status.valid ? "status " : "",
-				!dev_map->mbox.valid ? "mbox " : "",
 				!dev_map->memdev.valid ? "memdev " : "");
 			return -ENXIO;
 		}
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2069.outbound.protection.outlook.com [40.107.223.69])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B44AB4120A
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:31 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.69
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847153; cv=fail; b=T4gUMHx1YPWw0xW30EMhlVCd+SDrry60Mm2YzwS1T4VmOnoyd/BBWkkzgkUyP7m5T1OdqldxJaGFPJ3oGyFVdJ0FtTe41sadndzFrGvsJaPKSfQoK4ctxwi+mniZsjmvM9dcp7ADjQRMP1KvG28VJcd5fnRAT0rsGZZhM7I+b9I=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847153; c=relaxed/simple;
	bh=WC7FN9Njh3OvX/07BRiPIrApL3IN3y5Gp70aL53pujE=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=Y6HJSgL3U03u+PBznL0YbqL5qSgApskx9w5bRFxw6GGYsRNA3HQSPtSncZMw0yfn26piDqoJ2+63RYAOHVdU9nPz9AXS49nqUoAhVRGv0/50vzzXDsu1X680Ya1gNSGHOHoWBNzUbMjPvDisBq3hWcSW2v2wU6CvgyIPSmJQvmQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=YdLqnbuC; arc=fail smtp.client-ip=40.107.223.69
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="YdLqnbuC"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=SnFieR4zXG2nWoFEGjkGrG5H5qzVNFxOPp3wOOLw0hSTeYDKSfadD6gNpeWqoheYwBEAlyHX0X04xSvDs43vcLM5W3RkrO00KbxwyrnMSfocVuE5qcXf6ach0FRDOh5gAuC6KVMW/5vVaILAf4zOhB/AypOwAOoP78bOgO3oyuEC0dE9Na/0iU1QDL7PLSE4WTj9aExI75zlUdjORIBOLb0Jd4cH8KX4lhm2/ssFdMXtCdb5QCbZx1VLhO4PDijpjtg65ct/bxox2ZajJbYLPZEgWu8Mz4pLUdu7FgvmB+8IhKoH7GlWRoHvpvBjKDjcFrh5+gk1QnsVkMXnYZjZEg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=jdDtBRFT8l9xNV6Jr9toFs3vsXJOLYFBrMNBu6ZYRYk=;
 b=WX7/0kgwGUaOSrFW5Hh3doMnnUmszWTnAbX29/C5DHWc9IWmkLLT6ER/x2kWowISMn7aaT9b3IpX41VTgiMvdh58hjx0rwNSUuY8XB++8L4KmO2aEba/xJAbWS2FuQcH1zgn/wzzWTdNp1YGzmb4M/emC9Evgn7OsdFbAA2wSEryRJEZsZpN/XudGRkm6/gHMQ7Z+7o0SDuUodJ7SHNy4Mzl5VbP9iWlPKkIGICsVSxtJl9KoyPWf0bOsEM6jNZSSQrNtMI5vRdEHFe8OdtN1Df6xxgmk/gililuM0fSsZdUi6F3ogZ9Sj4gY6W8L/GqSrrOstQFPmcUKoQqyYmaig==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jdDtBRFT8l9xNV6Jr9toFs3vsXJOLYFBrMNBu6ZYRYk=;
 b=YdLqnbuC8hfLzRXwlakVVB4+jTwbvurwWqAGuqZMut52Ux3VNBh+oyPopeWRI1vmwYwRqw3hPZMDjYrr6Xli212U47YZNa+Viq4VXouVrPFfsybGlGU2QDw5kqxfProx3WCVBkPv64Ra7hSqU41mwcEozrqCZZ0kWUhTVssCDhw=
Received: from BN0PR03CA0038.namprd03.prod.outlook.com (2603:10b6:408:e7::13)
 by PH0PR12MB8125.namprd12.prod.outlook.com (2603:10b6:510:293::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28; Thu, 16 May
 2024 08:12:29 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::cc) by BN0PR03CA0038.outlook.office365.com
 (2603:10b6:408:e7::13) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.27 via Frontend
 Transport; Thu, 16 May 2024 08:12:29 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:29 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:26 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:26 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 10/13] cxl: make region type based on endpoint type
Date: Thu, 16 May 2024 09:11:59 +0100
Message-ID: <20240516081202.27023-11-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|PH0PR12MB8125:EE_
X-MS-Office365-Filtering-Correlation-Id: eca808e9-783f-45cb-9b09-08dc757fee10
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|376005|36860700004|1800799015;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?v5+IAAT1b+NFtN3dvarSUDLMWJjJJVgr1LIouEcFqPPhtKYKQkgZBuvXpzd3?=
 =?us-ascii?Q?JaUur1Pnevq13FL7GtlI20HjyIKlF28blJ6Cjjjm31lhyoAO2HDbHGZOrHlx?=
 =?us-ascii?Q?Fouma0ALkocGk8NW0Ffu08OoQuSxoHMugM0a7ecC7tUUCwd1ko6ntMFJvJP6?=
 =?us-ascii?Q?Kf/O0ma75LDshnDgVCnTG4hxfT4M0PYoIwpX8mf1XDLE+/p1ELYNiu/7Wnx+?=
 =?us-ascii?Q?LuBrZ6w+i9W8KO8O/RIafbR6kMfChrx3UhnHbixThjzlkr81jan0h8+c5cSF?=
 =?us-ascii?Q?bezD5YXpUsOhqiTN2vRVdwZXZzL5scseQ+oNo/GphNr1MSKtiQO6NbkIfb6+?=
 =?us-ascii?Q?HYPFt+cmCtFlO3vNMyC0ymHSti5WBTG0IoTdEDJKtQDjlFPIUE46Edwessy5?=
 =?us-ascii?Q?Cjuq18IH3rQVjXImWSHlziRXAT5NVRb97+HCEi6LydG0vyKTa8J8MGu2lJnI?=
 =?us-ascii?Q?QFjQF7Lx8wCdvbFGUYUkjcxmmcDzcuyZcQc0WL/ALCoXIXdTVHruXvDa1mFF?=
 =?us-ascii?Q?C5L/5eb5TgWLjee7L8te/lRWuVO5tUa08SuYUUaZL/fiMS/Ndv5STxya1VMl?=
 =?us-ascii?Q?Oqrk4mXnYZba++7ufWb6I79RLJ6rl7dBN57zZUDkYHyNPznJlzyJmVgmdD3L?=
 =?us-ascii?Q?j+vaPNtoQ8IyY8p2+3lApWVgMGnaTtjpn4EIhhYi65m6pQmGZp7fyowP9sFX?=
 =?us-ascii?Q?4In+EoG4VjqL//SMess6dm4+Qmf75wrT+EChslck8cHT0Rvg8xAQIMiby3nX?=
 =?us-ascii?Q?teEZxSRDQGXIn1zbMd5nittluyTZ5GddBDlHNQXOHgvCvZiP8B12wM9ORm3y?=
 =?us-ascii?Q?RScI/B05zXgeBeuy7IAda0Z3aWwVxfGjKbfPcsBLmDe5+6X6W0x9Ok8i4wBh?=
 =?us-ascii?Q?YkFjZtZ8e17B3nlQzdMBkQHkSqQNp+xP2GBAikE1wkq7O7RA/8XMH34X/nOG?=
 =?us-ascii?Q?NOG96tPkaJ6lB4fmq31z9bwa7U1pSkWCptsX1crWgwIooA7L1lDvYCFKeC/y?=
 =?us-ascii?Q?Sh82Yq6ihjDeUZXmX4b7hmwHvGZLu5fGzgcCayDT6BSl3lvMwQDQEzaIQ96B?=
 =?us-ascii?Q?vUJ1fHqopEfwZzqVMXRY8+l3HHEZxwmflmXSGlO6MIpWLlvdm2whfWX17fjw?=
 =?us-ascii?Q?EVW1aaAO/lek9qMfcw+0ckJATNYAxZInC3W7CXg9wOV5LBqyYJZVJ4mG8ovN?=
 =?us-ascii?Q?hvWfZgPPSPGkYb+azqVgrQbFEA3RAskwNeUPeWxactujUyInXtB7UCpv9KOA?=
 =?us-ascii?Q?gyW8PZ2wzyrqUzrSSQtH1z0S6jDB6x7Wmqe8OAOn8wUOCFezzDR1mxDsvo+Q?=
 =?us-ascii?Q?UL0FNhuWzbn4JRuEboNbEVhc41EYIGKDE6oqWlh35rWpt5UaChr9zuclZBmU?=
 =?us-ascii?Q?YYDgPtAinuA7a05hywZIHF1vtmf8?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(376005)(36860700004)(1800799015);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:29.4661
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: eca808e9-783f-45cb-9b09-08dc757fee10
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH0PR12MB8125

From: Alejandro Lucero <alucerop@amd.com>

Current code is expecting Type3 or CXL_DECODER_HOSTONLYMEM devices only.
Suport for Type2 implies region type needs to be based on the endpoint
type instead.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/region.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 2731fd4243a1..8228b7e96d8d 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -2574,7 +2574,8 @@ static ssize_t create_ram_region_show(struct device *dev,
 }
 
 static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
-					  enum cxl_decoder_mode mode, int id)
+					  enum cxl_decoder_mode mode, int id,
+					  enum cxl_decoder_type target_type)
 {
 	int rc;
 
@@ -2587,7 +2588,7 @@ static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
 		return ERR_PTR(-EBUSY);
 	}
 
-	return devm_cxl_add_region(cxlrd, id, mode, CXL_DECODER_HOSTONLYMEM);
+	return devm_cxl_add_region(cxlrd, id, mode, target_type);
 }
 
 static ssize_t create_pmem_region_store(struct device *dev,
@@ -2602,7 +2603,8 @@ static ssize_t create_pmem_region_store(struct device *dev,
 	if (rc != 1)
 		return -EINVAL;
 
-	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id);
+	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id,
+			       CXL_DECODER_HOSTONLYMEM);
 	if (IS_ERR(cxlr))
 		return PTR_ERR(cxlr);
 
@@ -2622,7 +2624,8 @@ static ssize_t create_ram_region_store(struct device *dev,
 	if (rc != 1)
 		return -EINVAL;
 
-	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id);
+	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id,
+			       CXL_DECODER_HOSTONLYMEM);
 	if (IS_ERR(cxlr))
 		return PTR_ERR(cxlr);
 
@@ -3146,7 +3149,8 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 
 	do {
 		cxlr = __create_region(cxlrd, cxled->mode,
-				       atomic_read(&cxlrd->region_id));
+				       atomic_read(&cxlrd->region_id),
+				       cxled->cxld.target_type);
 	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
 
 	if (IS_ERR(cxlr)) {
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-CO1-obe.outbound.protection.outlook.com (mail-co1nam11on2072.outbound.protection.outlook.com [40.107.220.72])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 520124501A
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.220.72
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847153; cv=fail; b=njqDLY57Jzvj701jUgeIjJtmd/9Ex+g77H6/hS3IVQDM4V4rbVqsZYH7mrpxRz9Ls8cveL3J93BFxlfB6humRSpLR/gKI/8Xh5R1KEk7tEFmekdit9KKSEdeYrM5cpC1oT1GXdT8iy7mdlnd6oQFHZLV0PWEDiRtTmM9fRYhyZ4=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847153; c=relaxed/simple;
	bh=4ENH8M/svyPBhozMWmUfxr8bSZwHnL8k/bme3JNYbI8=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=QsyRqK9I4NXNnU2kMLK3YTRjiNoNtxYpt0JX1/cDorHM/1T+PLsHY97u3i+ZUVlO33KJRSUKDMCEEEGyLnjNctVbzEBXN2OfOT9JZENr+0JkdoKBvelRVIboZ5UePKzrdqwYe3v1N5y9QHhZxUVbFbGIpFiAgeLgAM248CGzuqo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=IyTu4gJV; arc=fail smtp.client-ip=40.107.220.72
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="IyTu4gJV"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=EnOX/doajjW/rKm+vI6zNzOPQDLGUFkDNsvC644I4j/GEwt+khr5qesOldITWiHbMHHlS8QKP9tVtkNOI2RvWziUnfqikL9QhEqTyDnprXrqqzPbyx3b0JXipYMiDaG55bRlU+XsDjJHj9c4IyaJgnLDozw6QkcQ/+UYLqgnt772hLzoXBQ9cmz3ZxbkKQq4LfpBaCbsNKhFHUrsRjCd4P8YNbYw2FwUJH2BKDIBsY5OLkCBhPziSMZX501OYZRbOzh60tVe05jvbWpMqMatSqDd/BWfCR65P2shUKZp+2P6MPxtbJrCVxLYyHAO4ZpRUg8s5Cc7uY1PYPjHTjDQsw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=LmnjvseB8bTB3S4md4pa9zy/uapqJ9cY4/yJ+TPhQlY=;
 b=nG2GHjT0EwkdSil41X2u+5Q/XzlNUiCdKXfRTP7ZWm6n2Ed6QOlTESprgK6rIaRhCGqzZ4SGpBkFWk5mENe+PCn8wcfgP97ABWpIbMbeufn7k4CNWrY6+9GMjnFUdVCyruEqhSj94Njf5r1BYeKGnwvt/b2HMcwfw6b8KwGRIqoecDmdJEVArydj1G0U6L+SPmo9fASZbH0LhNbj8g4mU9x4NBEIvyNFL47AAk+XuzNKf6OwK+JkbOSpQmJE/6mpmIKRJA3V4Izra1RaTHrF5u0C1DnF3fDpkDpkmdgJHHv0GaBO3+UprDToSDakAkhbQlZBMNF4lP7h7aoepxnqxg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=LmnjvseB8bTB3S4md4pa9zy/uapqJ9cY4/yJ+TPhQlY=;
 b=IyTu4gJVXNVgtTwWAPx/yPyziUjs6Q86ona/6RL8fWDSDGYGl3VRuz1muR1y2dR/AnSVtopNW9vyQdRI1CF+TUjaiF3jdD1C17epR8Xed169EiqSHD3k9LIub812a93N+HVzI3f5Z9qtNnXB5sqcof6bsxYsWE3ukkIzDP5v1Js=
Received: from BN9PR03CA0495.namprd03.prod.outlook.com (2603:10b6:408:130::20)
 by SN7PR12MB7274.namprd12.prod.outlook.com (2603:10b6:806:2ad::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Thu, 16 May
 2024 08:12:28 +0000
Received: from BN2PEPF000044A8.namprd04.prod.outlook.com
 (2603:10b6:408:130:cafe::a3) by BN9PR03CA0495.outlook.office365.com
 (2603:10b6:408:130::20) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28 via Frontend
 Transport; Thu, 16 May 2024 08:12:28 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A8.mail.protection.outlook.com (10.167.243.102) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:28 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:23 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:22 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 07/13] cxl: add functions for exclusive access to endpoint port topology
Date: Thu, 16 May 2024 09:11:56 +0100
Message-ID: <20240516081202.27023-8-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A8:EE_|SN7PR12MB7274:EE_
X-MS-Office365-Filtering-Correlation-Id: 40de3214-9247-4957-4baa-08dc757fed68
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|36860700004|1800799015|376005|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?y7qN0+16Alv+6EkOqGHC4KBl2Wh2xJnkgje8RjqilDgPrPQ/FCEe+DhM0h7J?=
 =?us-ascii?Q?+RL5iWcYSTNIhZ7zX+MpSwoi/ivzIEAvQ2YqGkXITAprVv6jP5TZizUYCqRE?=
 =?us-ascii?Q?vTUS2RGrtCpnDNq0FNqLbOLhZ16gLpmd+dXsONNRA0yKVjByAyPNCvceFnw9?=
 =?us-ascii?Q?5L5t6/RF79YWVaMBl0kXPbS5Nzu6w19MYVKg7PynX3Bqpj6lUrymD9qaxXnY?=
 =?us-ascii?Q?fYq2XeN0SJXE0TuOvRuJW8JVGqS/aYwU19OgRAoVAl3UGdnGrBoe7FxtIO1z?=
 =?us-ascii?Q?wyYGhnUIhDmuTgvo7QAbVOWoHw1vMR56CBHCEoGgw8dORfJQp4vlXdZv5GzS?=
 =?us-ascii?Q?5nSHRNIU2qgIZwSr3F63RDgkImU2wlXHcxb0bhm6miynpwv3PNC17OHIi9hV?=
 =?us-ascii?Q?mK0Kfi6czznnTEq/QxPCzGfAfCk/aV+2BkKFKQ/8zQBJ7cdsGTutTsVznUJK?=
 =?us-ascii?Q?jogJpzt6k9YkF05a6jxxVKQRWQcoQkz4UmjJQbCIwebWp6YWskjN/gbCBnEw?=
 =?us-ascii?Q?mEW2q2v158C0mcuMp3bVyv/9TL1Yis0+035vYP3ViHxh17eLLK7WLXnAt6i3?=
 =?us-ascii?Q?cXX/n6SXu6wRJSMEM6IjuHftTm4FWFXkAFpVwabsImQNKY9ihVUJ9oe/DJ/x?=
 =?us-ascii?Q?X9TQWMnZgYIPVPfDpbhvw427pOYNFk87VaMrYfSEgMAxJBeyuTKgqtmLoh0v?=
 =?us-ascii?Q?S/5rsARgP3RrQ3H0ve/Pv3Zzs/A7HjDWBb7bLWDS4vxSO98cZAGUgr5qG9Qw?=
 =?us-ascii?Q?Hq4StN5PWaowyLQz/s1MigP/bEYVm6VQvoQEk6Jlju5B+xcbuIaX1Dg1FBIY?=
 =?us-ascii?Q?72NaN5S9R0M8ssFoRgTWy1i4J3OzhXOMKDXUjkNGXehw7knrQ1wTC/sjrdRo?=
 =?us-ascii?Q?sRqGute0hA5m8VzrwAk+xfprcrRco4nZnhjKVAj1XB5dLpNCZytC5wsOZjVR?=
 =?us-ascii?Q?ijVZraC4x5t+HEP4HpAjsXnmqdwSNOYmyyUGa6PfW9CEw8dZ4a2AHj/p/AoX?=
 =?us-ascii?Q?rsP2aOaiS8StBEN2BXtLh/s1pqJ1wyTPg7pzjGusmnxcmK2toZHDFwqyhaKL?=
 =?us-ascii?Q?eEQa+zIZnjTz8WSOECY4N20cPlmnk/to7tcQhi/TypCFCgsskv3LKjgBsLIS?=
 =?us-ascii?Q?zpQBN2iTIMC8p7ioFXD9Z3EZqZWa3UGtbMCRhhdxVMa6QERkbMOX3cPgRk1t?=
 =?us-ascii?Q?9J9UpNt6/F2Z4X8izaqLWE6UEwaxKBPHOPSRPQbbAZuo/lJoXu0lZwJ+Nuju?=
 =?us-ascii?Q?68IzItyykHDHoCoU4DD5K5bsPqKHQLe//eD60Xu2743DV4S3bU4wQJZBorCn?=
 =?us-ascii?Q?nNE6oEuXnDzZNujA5pchUsytiLgXXuq9sx9y01puP4EGRUjzks15UjC1I/1Y?=
 =?us-ascii?Q?i48DE/qB+FlrKnegexJd3BQ8Hogf?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(36860700004)(1800799015)(376005)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:28.3630
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 40de3214-9247-4957-4baa-08dc757fed68
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A8.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR12MB7274

From: Alejandro Lucero <alucerop@amd.com>

Prevent concurrent access to endpoint port topology.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/memdev.c           | 41 +++++++++++++++++++++++++++++
 include/linux/cxlmem.h              |  4 +++
 tools/testing/cxl/type2/pci_type2.c |  9 +++++++
 3 files changed, 54 insertions(+)

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index 27063cd4ea73..16e356ef5b6d 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -1124,6 +1124,47 @@ struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
 }
 EXPORT_SYMBOL_NS_GPL(devm_cxl_add_memdev, CXL);
 
+/*
+ * Try to get a locked reference on a memdev's CXL port topology
+ * connection. Be careful to observe when cxl_mem_probe() has deposited
+ * a probe deferral awaiting the arrival of the CXL root driver
+*/
+struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd)
+{
+	struct cxl_port *endpoint;
+	int rc = -ENXIO;
+
+	device_lock(&cxlmd->dev);
+	endpoint = cxlmd->endpoint;
+	if (!endpoint)
+		goto err;
+
+	if (IS_ERR(endpoint)) {
+		rc = PTR_ERR(endpoint);
+		goto err;
+	}
+
+	device_lock(&endpoint->dev);
+	if (!endpoint->dev.driver)
+		goto err_endpoint;
+
+	return endpoint;
+
+err_endpoint:
+	device_unlock(&endpoint->dev);
+err:
+	device_unlock(&cxlmd->dev);
+	return ERR_PTR(rc);
+}
+EXPORT_SYMBOL_NS(cxl_acquire_endpoint, CXL);
+
+void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
+{
+	device_unlock(&endpoint->dev);
+	device_unlock(&cxlmd->dev);
+}
+EXPORT_SYMBOL_NS(cxl_release_endpoint, CXL);
+
 static void sanitize_teardown_notifier(void *data)
 {
 	struct cxl_memdev_state *mds = data;
diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
index e8d12b543db1..11fe8367b046 100644
--- a/include/linux/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -88,6 +88,10 @@ static inline bool is_cxl_endpoint(struct cxl_port *port)
 
 struct cxl_memdev *devm_cxl_add_memdev(struct device *host,
 				       struct cxl_dev_state *cxlds);
+
+struct cxl_port *cxl_acquire_endpoint(struct cxl_memdev *cxlmd);
+void cxl_release_endpoint(struct cxl_memdev *cxlmd, struct cxl_port *endpoint);
+
 int devm_cxl_sanitize_setup_notifier(struct device *host,
 				     struct cxl_memdev *cxlmd);
 struct cxl_memdev_state;
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index f157139b712f..948cc95c5780 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -6,6 +6,7 @@
 
 struct cxl_dev_state *cxlds;
 struct cxl_memdev *cxlmd;
+struct cxl_port *endpoint;
 
 #define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
 
@@ -72,6 +73,14 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 	if (IS_ERR(cxlmd))
 		return PTR_ERR(cxlmd);
 
+	endpoint = cxl_acquire_endpoint(cxlmd);
+	if (IS_ERR(endpoint)) {
+		dev_dbg(&pci_dev->dev, "cxl_acquire_endpoint failed\n");
+		return PTR_ERR(endpoint);
+	}
+
+	cxl_release_endpoint(cxlmd, endpoint);
+
 	return 0;
 }
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2073.outbound.protection.outlook.com [40.107.94.73])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 158E87829C
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.73
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847154; cv=fail; b=DSfgD5v9pTTr5Clz1evzsSybYN0v2tYycojengd24bs0Tc7hauJFdzkKTIcatFftOGKONTLcsAst0RHGmaFa3g2gEXkq7j1p9NKkJpRUGhDOCYMcKKY1Tzuy3GfXZbr6hEj0szxVy+2VlQQRvJBgLoGbKz9G7A/szKVRNk/ISsw=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847154; c=relaxed/simple;
	bh=cl2LMZk15VbkBnEVPN+nFgKcs3JpRqwlZfBty5GJKcs=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=Rm00w1tGdRW8kR4hRsted7zdQ8LTAXqTTkU1aQ9t6vuFatRgJHu8eJmFVOKVGXcqUanuzvVllirT7PkqcT5GN24fgSc+A0Gbn4OMM5HzsD9OsoZ8GhUxOa5KdnKQ/a36FhSxtdk56UZbybEbIaCmAwRHIAkIPs5XVn+GYV9XCUw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=RoRdWxbx; arc=fail smtp.client-ip=40.107.94.73
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="RoRdWxbx"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=jqNDSUHHL2on95msdFBqel9WrZyG6uVbpalQ0dyxViuEjraUtv7vkczhm6F2LRjc0GXIBO3C6MpU0CDrTZkdMyc6Y0oewtbvHa/8NA1YGBeOXpAsDoA6dhYCQbHCw01MvRBiy3UXKSXgE4R6+gOiRa/zqSUPy3ktwgyos9ZgLVStx7iUH2HOv8uy6FVVsnJdKtZc6e23Gw0EvfaBn2qEVcqZ9dAZJcQhfjAGHozATrn6M2L3cv4QpeITn3/2Bvs9SOEFoazgQpEq+Uo39k0/09LaxPT8Zg0yWiteCKhp7YYc750az2fhm9n+wCqRp4Fx/egiiCXcSNpTKjqhFO6zqw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=/697oYtt8RicuAJzPpJl1ttkQvJ1w9h+6D1LUcHd8gY=;
 b=oGSW9JkbrDSelsZJDkTxB2BPTbek3GsWritjfrBenwPe0GH8lc4M8Xyo+k/gUmuVCruy0+d5sP1p1hqNiD+dC3yPiXFg6PejtR0p6KOP/RkZJiN313l55L9Rnn6LKkgL3XQDZnqRKpba7Wt6arz0k7OF61/BamqZ+cPUv70H7TFzMlHEomlLVOiFFOO1CiFTEl2x9TdpvOR8IAK2+4tEeVeIk2lwzQHtLZdastB6iH04O8XoJM709S0IT3iEUJCGZRPCY/CiH9Lrh+rsmuJpVN5dKJMM6/TfwogWOu63v56Db4rU7qitUKcmgyTHcP2uvUmgrvZvqVKzgsqY4RDclA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=/697oYtt8RicuAJzPpJl1ttkQvJ1w9h+6D1LUcHd8gY=;
 b=RoRdWxbx7Cz226BlV+wuzs4ash1lcYBz7k7bveW9qp1VWdkqEaBYRMXOkZg5MLtgJD4rkDNEX9DD+unfjIbgizF8uGXKBHIldL+PDUzYPUxvDKhN2O5GjKU6DgipG1+h4owg5ooc/N5ZbbW/ewRvsuFbeD6sA46Uf500/z3aP7A=
Received: from MN2PR19CA0060.namprd19.prod.outlook.com (2603:10b6:208:19b::37)
 by SA3PR12MB8045.namprd12.prod.outlook.com (2603:10b6:806:31d::5) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.26; Thu, 16 May
 2024 08:12:30 +0000
Received: from BN2PEPF000044AB.namprd04.prod.outlook.com
 (2603:10b6:208:19b:cafe::a3) by MN2PR19CA0060.outlook.office365.com
 (2603:10b6:208:19b::37) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28 via Frontend
 Transport; Thu, 16 May 2024 08:12:30 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044AB.mail.protection.outlook.com (10.167.243.106) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:30 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:30 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:29 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 13/13] cxl: test type2 private mapping
Date: Thu, 16 May 2024 09:12:02 +0100
Message-ID: <20240516081202.27023-14-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044AB:EE_|SA3PR12MB8045:EE_
X-MS-Office365-Filtering-Correlation-Id: 74b1d7b1-ab02-41af-bf6e-08dc757feed9
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|376005|36860700004|1800799015|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?r3nIfupQT26doNSZ2YH5AIGdNToPKA/j8WoroawPEpqYQRSU+N/f0j+ZG/ha?=
 =?us-ascii?Q?wEAuEt+mDvUzOyeet3lEywFaNit7yp3JIVLqTyFqVgKpyJNkluRyeT5T5LY4?=
 =?us-ascii?Q?k9T70kEQznWEEKYuz4nHqVa27JNrj7653MnJYucS2ivMH3GmAwE+cx9oHQfH?=
 =?us-ascii?Q?WWweONYTvNsgGjEpL1m+FAoRG1EYR9yLDge8MiojPjjnYWOANhDmI+vFGbur?=
 =?us-ascii?Q?JGuXSXJ+nw9q+Wl+x2kBt7jYXHj+GUPJ8niogusiKhZO4JQnQ9eUCgTVKNwJ?=
 =?us-ascii?Q?NrSWpE0X/WNkCT1CeL/b+iStRA1wIhEN4CEXs5KUd0aqQp8LoITaS6ANqpWL?=
 =?us-ascii?Q?4X/ngy+6uV/JS9eP6rxyxMv+at+BECi0QuIq5oQUBS/6sO9VP57TqXUr/uFH?=
 =?us-ascii?Q?/ALpK8RunxtFMWuZkO5ANHsAno8uMtf/VRpnuvkNfGzyVwoNhMMPFt2+8PAy?=
 =?us-ascii?Q?p2dk6Xzsg1M3B3JaUl35VSIvFN++BIwnHmedc4HIS6SMI/IkeimVCbsPM4b9?=
 =?us-ascii?Q?V7BUsj348UgEOBnszDC9oJjMhHP2w2EoneYw4TV1Z1C2UR/uedGe5eOWWdiE?=
 =?us-ascii?Q?h5+OE2i2zgW74jQcSQuh8s3TqcRmlGPYugj4OSfNOg5Jd+0BW+6dQB4WM7ry?=
 =?us-ascii?Q?YSWQq26AFjR5E1keU9A4f2Xp0gkcY5kl1gOY/SpdfhMb3DRU23a1SVI5EGKh?=
 =?us-ascii?Q?BwrsnW2fLOmcQKgx+gefr4M+1TxyBWcSr6mPRwk3zYishPtIKW8LcnCdW/vR?=
 =?us-ascii?Q?DjfHJ+peg4hthJgd8i4eonU3PhfaA9WhGtfQELZwp8Od/5ipQwwLX009GisE?=
 =?us-ascii?Q?iFvVO4eL1d8pIipRSaNv7mrzV8ONNVUqIfO9Wowf6+XpXYy+Wj5qVmknq2l7?=
 =?us-ascii?Q?KfyUL1S63Hislf0nl6ZilRYjSkRZdEYJTLbfRLaV8LEbaPk1DErlzeZjBHk1?=
 =?us-ascii?Q?BnmvCYrOkIdBfFaIMJb/+ptnjCHvaipsmQOaRLHNFgBEc8/xL5bYwqeU3BgU?=
 =?us-ascii?Q?XuPp/voFwWfmWl3cvsGclMr4IABRcBJhT1J8Qy5USd3HuYYPo6S3ro6QjOsk?=
 =?us-ascii?Q?u0CDRJAtGH2CQYgE6RX+hmx/w8SxkQ8xOe5q6PYv76uj2xLm2DaRgzNEhBYq?=
 =?us-ascii?Q?TU2Gzh87732Jq1YVevqkmn4pw8JZYpUoS5gehuSbm0tpgwmTrNiJOTQRmzbt?=
 =?us-ascii?Q?Yn83vz9r0hIdfQaTXMo3EudWnhHlDrF83LOhG4kfVZytf3Yr5bKw3qken/0p?=
 =?us-ascii?Q?bdEkZXYoyEAMF6sLYDYqNR6tXyXbz6bbI5cgLjfPBbDkVMxRLzcOrTq43HDv?=
 =?us-ascii?Q?e4TE0rULaqdos8YyQPX2D33iHcy68IURoVG2zBvz9i6LAwPaSjYbM7vgkdkN?=
 =?us-ascii?Q?xZzLEU3TxvKlggP++xz241DUfK7i?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(376005)(36860700004)(1800799015)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:30.7843
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 74b1d7b1-ab02-41af-bf6e-08dc757feed9
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044AB.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA3PR12MB8045

From: Alejandro Lucero <alucerop@amd.com>

Based on the cxl region allocated, map it internally and do
a write and read to a random offset.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 tools/testing/cxl/type2/pci_type2.c | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index 0e7f17c0c920..4bd71e444ab4 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -4,6 +4,7 @@
 #include <linux/cxlpci.h>
 #include <linux/cxlmem.h>
 
+void __iomem *ctpio_cxl = NULL, *ctpio_target = NULL;
 struct cxl_region_params *region_params;
 struct cxl_endpoint_decoder *cxled;
 struct cxl_root_decoder *cxlrd;
@@ -20,6 +21,8 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 {
 	struct cxl_register_map map;
 	resource_size_t max = 0;
+	u32 data_read;
+	u32 offset;
 	u16 dvsec;
 	int rc;
 
@@ -122,6 +125,28 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 	pci_info(pci_dev, "CXL region: start=%llx, end=%llx\n", region_params->res->start,
 			  region_params->res->end);
 
+	ctpio_cxl = ioremap(region_params->res->start, region_params->res->end -
+			    region_params->res->start);
+	if (!ctpio_cxl) {
+		printk("%s: ioremap failed\n", __func__);
+	} else {
+		printk("%s: ioremap OK. ctpio_cxl=%p\n", __func__, ctpio_cxl);
+	}
+
+	get_random_bytes(&offset, sizeof(offset));
+
+	offset &= (CXL_TYPE2_MEM_SIZE - 1);
+	offset &= ~0xf;
+	ctpio_target = ctpio_cxl + offset;
+	printk("%s: ctpio_target=%p\n", __func__, ctpio_target);
+
+	*(uint32_t *)ctpio_target = 0xdeadbeef;
+
+	data_read = 0;
+	data_read = *(uint32_t *)ctpio_target;
+
+	printk("%s: ctpio_target=%p read back, %08x\n", __func__, ctpio_target, data_read);
+
 	cxl_release_endpoint(cxlmd, endpoint);
 	return 0;
 
@@ -135,6 +160,7 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 
 static void type2_pci_remove(struct pci_dev *pci_dev)
 {
+	iounmap(ctpio_cxl);
 	cxl_dpa_free(cxled);
 }
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2074.outbound.protection.outlook.com [40.107.244.74])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 419D4282EF
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.74
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847154; cv=fail; b=UMfye4da4uR3HmGRueKzkftDWouN1dlBEP1c1qux0k136t+iswL5F3PsOF4ZmavMV7xuOr8aJLEDG6H0OEYO/Y66syMzfQfoNj8ko4uqiD8eVksJwhQp3+XRsl7b6RPONA83nvUakbwyurrpzrCximbkOA9CVg6cIxPul3N8RJU=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847154; c=relaxed/simple;
	bh=M3xBaVfzBrErpywI7/7Ux+dirFtEhqPtP2+rV5qvyhE=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=kuoW/KBox/tgerYoTYRi7CQWK2ZXOkaldgZJQoWaYn9pm0ekLskR5HQDuqUptJiMuFwR1gl083qt6Xp4Z9oJE7tT0gANad9xfbUz8Uxt89WRkMBOcelC8lz6Zs6AWcsMEXfup/BwNRruOZky60EU4oGM4GmNEnDeg3TYBx8ZyBo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=Z8NhVlm6; arc=fail smtp.client-ip=40.107.244.74
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="Z8NhVlm6"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=eW0z6tHuhaL/Qn0L6WEVff/Y+6wNrO7VisdN8/DYpq+agNpknoo+Dltz4AKXWd6KHqoEotLuCMCh7X+l6vrBHGKxMgEKDoK1G/tGKBeHp9Nv9hId7TXWdRyevcNTkXPNDLwvxpg5GxDyQCIjtMVjy/LA0tNSHXVmmwFQkXjNuypxmxnb2gk/ERW3+QFcMcR2dfQZnkHV87gpFVm3+xs7lnGPmQqdTQIJnFk8RPUS7VMFFh53j94xiIUyxtRYcvC1c9Mh3kNRwUFIt97X+IQZrK79m4hH5wBNsCjtLeG903t9YOv7dmGDSTqo6kepTB2FeJKZGeElVWLMSyrc/jJpkQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=xT/RB9ryVF08gkJdJMAJGdHUIHo69u7LqVqsVPODEbA=;
 b=UnNohxa/aq7b501jFS6YwFvqTlwHG4m/1z2AI4bQ/x9+PtHyJ8sssshR1EdncVrNQ6tlWLpBcEvYbuVzdEMonotOMv8YQh8rnSwMkKFaQqEXEPTkPZDn0J2L110EGMoXdl0lcQsrueMmXxdLdshFayIyOfzrZcm2IA9eaXRPwrzw7yVGEFRqJcFHMDpbwjc/iSmzcNlvwttqGw0/bNJdcumSAdW7rWTqmYmDbMxJpBOAU/jWGeMvSqSIPzvIV0pOE5QnVTOwrpLa/yPTFF+hYL3b88sZFsNnKtNJm2ycjIB0KDuCAiY9UO3PWrl4TFCwLN6iALvUWCFfXwYyKgfopQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=xT/RB9ryVF08gkJdJMAJGdHUIHo69u7LqVqsVPODEbA=;
 b=Z8NhVlm6QAwxtCTTU19IIF+ZyxqzbyoqI/B1DnxRcNrSyRMQX31QHh4STPbKsTU05xKyXvul5Obl+4042BuQxnYBcPiv92njLvHWEgvzZIT1Y7UWyhaMYHEl0Y5AO8dccjbbmJd/NBK0kcxiV38oyBBup2plWC/Bl+P8Z5ITEg8=
Received: from BN0PR03CA0048.namprd03.prod.outlook.com (2603:10b6:408:e7::23)
 by DM4PR12MB8449.namprd12.prod.outlook.com (2603:10b6:8:17f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28; Thu, 16 May
 2024 08:12:28 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::a1) by BN0PR03CA0048.outlook.office365.com
 (2603:10b6:408:e7::23) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55 via Frontend
 Transport; Thu, 16 May 2024 08:12:27 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:27 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:22 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:21 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 06/13] cxl: support type2 memdev creation
Date: Thu, 16 May 2024 09:11:55 +0100
Message-ID: <20240516081202.27023-7-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|DM4PR12MB8449:EE_
X-MS-Office365-Filtering-Correlation-Id: 92e4be0e-cd53-40ec-4374-08dc757fed16
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|1800799015|376005|36860700004;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?BUKzBOUubHPiE5DHrQLKBbpG21favUAhN8J1NGEaBcFTRAprYUUi27lak4mE?=
 =?us-ascii?Q?SGtrsY2PrDVBnfQReTE8e5hb5FhZ72Cid/tl15EO91HvUGWq/UzJ4xh2L3vP?=
 =?us-ascii?Q?574M6545+Zgr2JUGXfLWzIFhQr/4sAr6rLNxyywiCYFFLrUpd1weZegB27EV?=
 =?us-ascii?Q?n0QWlnguP3hwI8io2ER1NQgBVFQ6m0uOnJsaUsWMrR8UJcOhxUF7aiYM7Zwd?=
 =?us-ascii?Q?XVM5QGg8ThqY2Zj3HrD7/bH/v8X6PdEJq0RtH6nJHPaYmL+yliWbIrcBtq5w?=
 =?us-ascii?Q?l2f8RHSeEItBPokkFSeAIQs/aEUlgtnX/VE8z3icti9emS3ZLERENbV+nvlq?=
 =?us-ascii?Q?3kkO/tRaI/Mt7yYX+u261SQQz59xIG7HT7NTjzgqO3vSMICgVT5IYvkOBKCm?=
 =?us-ascii?Q?4552BOlvi3vS+yoEx86pvK1wOvprTJB/2uds2mTW9i8YGt98ZGVhb0MWC7In?=
 =?us-ascii?Q?owAY5heTN8mtQ7HnZ3w6cxmBeRlOsuIqQId7aKdY9dyfDUTppVO+4fI4D1Mk?=
 =?us-ascii?Q?C1o9hjRiyiC7I9yqQ3rWzHchv+9ZhIwFO+KAT7tel3KQwIi2cXq20s7WrHHt?=
 =?us-ascii?Q?4+Vs5fu0NOzA2MhS4qUneHpj27XOl/iwAATRFBbsgllbe/x9nGqKsH4sEMO0?=
 =?us-ascii?Q?oB1QYuabApeNDjS1Sd8A0GMWZSDKD28qGsDEzcLISP35ZnnfU74dfmnjpFmT?=
 =?us-ascii?Q?6bV8Q77Ks5LI7sumwYuVJWiKLVV46faMPpnTuXOLjsZubcFCxZIBMWjo8+GS?=
 =?us-ascii?Q?8hRQTZTF/TzkCBJwZV1s8V1iFvc4PXVdiDB6F/COsHDd0Nr+EQMNSisQe8pb?=
 =?us-ascii?Q?MS8sdqM5mYLY/JEMv/D04fZWLdwkNrBVlibGjFNVAhHiuRRPmKn7xkHWWwRy?=
 =?us-ascii?Q?NF0LAIomq3bFL5+PQ+C3MoQG2FO3QHBiHpkvePoR7hIwh7M5MbwC+QdwsohN?=
 =?us-ascii?Q?DvIWxoUPNva1hGi174wTIvuAT4bHPMGqxoMRrphuJJ1g36+H2lDN0b5DJD3Q?=
 =?us-ascii?Q?0VxpmGJYPIPyZMijmmCR3QfhZbb1PwFzOQRSDRQdtulEGuOmhYORXZFQmxHE?=
 =?us-ascii?Q?sO1jdP+8Z7T9rJ0xuoXZ8rUHGzQ/6lm5fmFYwzQlbUf3HnX14v5vtAyI22vx?=
 =?us-ascii?Q?3HjUeX0O5522ldfLOmL1HpHjByFIHza32ov2pRKO/r+H93Y2z2hmSl3txVe1?=
 =?us-ascii?Q?pz1hzADrMGYZZcY7FGryH+CHe+8eVsh7p4Hs77IALQxOsaghFGSw7lV/4PMb?=
 =?us-ascii?Q?FvQ753KlSgq4O8HO3v1WCIGApXWsfi10KZsxfDtQhM3A2VHYFECeaXXZjaB9?=
 =?us-ascii?Q?SZMCR4p/iOzzikwFnK7NINMqafcpF7uK+/O1klOUpqMwUPue7R4USvz6vl7H?=
 =?us-ascii?Q?Ha+8QlkcG0QNaOw79jlK2fUnf7FC?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(1800799015)(376005)(36860700004);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:27.8098
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 92e4be0e-cd53-40ec-4374-08dc757fed16
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR12MB8449

From: Alejandro Lucero <alucerop@amd.com>

Adding memdev creation to the cxl type2 test driver.

Current cxl core is relying on a CXL_DEVTYPE_CLASSMEM type device when
creating a memdev leading to problems when obtaining cxl_memdev_state
references from a CXL_DEVTYPE_DEVMEM type. This last device type is
managed by a specific vendor driver and does not need same sysfs files
since not userspace intervention is expected. This patch checks for the
right device type in those functions using cxl_memdev_state.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/cdat.c             |  3 +++
 drivers/cxl/core/memdev.c           |  9 +++++++++
 drivers/cxl/mem.c                   | 17 +++++++++++------
 tools/testing/cxl/type2/pci_type2.c |  6 ++++++
 4 files changed, 29 insertions(+), 6 deletions(-)

diff --git a/drivers/cxl/core/cdat.c b/drivers/cxl/core/cdat.c
index 97ff1dfd63d6..292efd7e68ad 100644
--- a/drivers/cxl/core/cdat.c
+++ b/drivers/cxl/core/cdat.c
@@ -558,6 +558,9 @@ void cxl_region_perf_data_calculate(struct cxl_region *cxlr,
 	};
 	struct cxl_dpa_perf *perf;
 
+	if (!mds)
+		return;
+
 	switch (cxlr->mode) {
 	case CXL_DECODER_RAM:
 		perf = &mds->ram_perf;
diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index b61d57d0d4f4..27063cd4ea73 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -511,6 +511,9 @@ static umode_t cxl_ram_visible(struct kobject *kobj, struct attribute *a, int n)
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_ram_qos_class.attr)
 		if (mds->ram_perf.qos_class == CXL_QOS_CLASS_INVALID)
 			return 0;
@@ -530,6 +533,9 @@ static umode_t cxl_pmem_visible(struct kobject *kobj, struct attribute *a, int n
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_pmem_qos_class.attr)
 		if (mds->pmem_perf.qos_class == CXL_QOS_CLASS_INVALID)
 			return 0;
@@ -550,6 +556,9 @@ static umode_t cxl_memdev_security_visible(struct kobject *kobj,
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_security_sanitize.attr &&
 	    !test_bit(CXL_SEC_ENABLED_SANITIZE, mds->security.enabled_cmds))
 		return 0;
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index a168343d2d4d..da63ce486e1a 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -131,12 +131,14 @@ static int cxl_mem_probe(struct device *dev)
 	dentry = cxl_debugfs_create_dir(dev_name(dev));
 	debugfs_create_devm_seqfile(dev, "dpamem", dentry, cxl_mem_dpa_show);
 
-	if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
-		debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
-				    &cxl_poison_inject_fops);
-	if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
-		debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
-				    &cxl_poison_clear_fops);
+	if (mds) {
+		if (test_bit(CXL_POISON_ENABLED_INJECT, mds->poison.enabled_cmds))
+			debugfs_create_file("inject_poison", 0200, dentry, cxlmd,
+					    &cxl_poison_inject_fops);
+		if (test_bit(CXL_POISON_ENABLED_CLEAR, mds->poison.enabled_cmds))
+			debugfs_create_file("clear_poison", 0200, dentry, cxlmd,
+					    &cxl_poison_clear_fops);
+	}
 
 	rc = devm_add_action_or_reset(dev, remove_debugfs, dentry);
 	if (rc)
@@ -221,6 +223,9 @@ static umode_t cxl_mem_visible(struct kobject *kobj, struct attribute *a, int n)
 	struct cxl_memdev *cxlmd = to_cxl_memdev(dev);
 	struct cxl_memdev_state *mds = to_cxl_memdev_state(cxlmd->cxlds);
 
+	if (!mds)
+		return 0;
+
 	if (a == &dev_attr_trigger_poison_list.attr)
 		if (!test_bit(CXL_POISON_ENABLED_LIST,
 			      mds->poison.enabled_cmds))
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index b12f13e676fb..f157139b712f 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -5,6 +5,7 @@
 #include <linux/cxlmem.h>
 
 struct cxl_dev_state *cxlds;
+struct cxl_memdev *cxlmd;
 
 #define CXL_TYPE2_MEM_SIZE   (1024*1024*256)
 
@@ -66,6 +67,11 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 	else
 		dev_warn(&pci_dev->dev, "Media not active (%d)\n", rc);
 
+	pci_info(pci_dev, "cxl adding memdev...");
+	cxlmd = devm_cxl_add_memdev(&pci_dev->dev, cxlds);
+	if (IS_ERR(cxlmd))
+		return PTR_ERR(cxlmd);
+
 	return 0;
 }
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (mail-mw2nam04on2047.outbound.protection.outlook.com [40.107.101.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C13596CDA8
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.101.47
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847154; cv=fail; b=BOAd0YyrwAlGsrM3VKIm6WP0UYvtABtO2vVBAQHEDz7ajIQ5f5/t7ERgW5xJryYUuTq4IrsEZ07Qcw7OcgAqwI+TpUdGI4fmr1/jadjMrPIifCUPWdTH9wplQoJonSLZ/LSrowjPXeKs06TDqOTvbcyhX2m7+kWaT2LTQe1GCFM=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847154; c=relaxed/simple;
	bh=zWniedtFUPzl0E11HR7iGxGdL1Juxo/80C4yAXA9b/o=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=VPeSA2wM8KZCa/W0j6P+KvWAmklR1wE8SXcpKwTFnX4HbSTJ4pBUm2+SfLEATS93VN1FFhjqvr2yHfC+ehOOwhu/MN4/vTAZaDRlR544eMk+1NlB0aVdsbB56l2CF57PrcEDJvhh6QpFvTfLRnOJbPuA2ux28HT3X/xaAUhz8Eg=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=gPatzai9; arc=fail smtp.client-ip=40.107.101.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="gPatzai9"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=lULLiB/lhZwGHQlH+ZT+q8ZVCiyYtWD6FmfLv6DpBk6kcyW/QGSIzwc1Sb4asaJsn1qnXBb4FaUcD2fXCAdri2ZAZXbQAuNXg/L4Fipg1QG6eLF4Jy0I08v9ewQ0xPVL0PoeOwTdaT00e6gG/1fOl02u1Uk/PMg3g4wvpKeo34xdZekeYin2Zc2kVOhFteEvG6PSEHHrd0JYDxvZV+YdAaBVpGuviKFDc6m3S7rsVH4nxF1LVw/UJxlu9FFknKiAfA+Nm1AP5BZQG//kVjdaS6aSCg2JGo/MSBcyrIaW/ZPC9HvEZBjHFL/3s9Dxd14PGRR1RKOTDEDwIHJraxSkuA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ZcWDwP022Mxfy9oYIZXBqD/mFXuQt8zU0PrNQs3Db2Q=;
 b=lZDxVjx2xZ1P/lIqnE4qBgi4p92hd/VFpffQKB55F4bTU4prUX611BmHQx5blndbLDWHqqyHmR0iNrZqBpwKSFGNIdwCVNv1mRBC0MKCAgk9DLnW3b9vJI9wZyJEP/Y6ZfDJyq+oNWxp4h7eDTA+9qF19vvQRMKJkGYS4KBDhVLXClGu/JJ/CbgUjWb2bfRD6kjHRabNDFKuC2x1LMK+zgptTspx4Vu6fSHuR564aQTjUPmRHkWZgxuakIBo5OBi3V5PvgyS7TpP8RU22M48qaJOpHzlOAK6dOJJW8x4ZCYNfDwkWI38eJaM5Tx4dqiLSo5CxvEv61jSZujBHBInMg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ZcWDwP022Mxfy9oYIZXBqD/mFXuQt8zU0PrNQs3Db2Q=;
 b=gPatzai9Xc7kv2467X+29bTLs84EmmExvYfBInAeFeYLRStT8LpC1fd7TgFeux+9yj470+YvryzBNUpB+XpdKS1lgTeRZ1RWW0VDraVA5qarP2918kfA3rXglqoK0WLfoD7PRia8XxH9zqAohFlYW2tJZPZJ8Fnd7L2onA9vH2c=
Received: from MN2PR19CA0065.namprd19.prod.outlook.com (2603:10b6:208:19b::42)
 by LV8PR12MB9336.namprd12.prod.outlook.com (2603:10b6:408:208::12) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.26; Thu, 16 May
 2024 08:12:29 +0000
Received: from BN2PEPF000044AB.namprd04.prod.outlook.com
 (2603:10b6:208:19b:cafe::1f) by MN2PR19CA0065.outlook.office365.com
 (2603:10b6:208:19b::42) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.28 via Frontend
 Transport; Thu, 16 May 2024 08:12:29 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044AB.mail.protection.outlook.com (10.167.243.106) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:29 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:27 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:27 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 11/13] cxl: allow automatic region creation by type2 drivers
Date: Thu, 16 May 2024 09:12:00 +0100
Message-ID: <20240516081202.27023-12-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044AB:EE_|LV8PR12MB9336:EE_
X-MS-Office365-Filtering-Correlation-Id: 4f98d85c-b48a-4d7d-8b5b-08dc757fee43
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|1800799015|376005|36860700004;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?0fDlsnWgLwHkMSFm1ey1W+Tjm8Szm0VmWBRxB9ukArFNMUZBkNVM2SgVoGqT?=
 =?us-ascii?Q?rRttYBt/jtn4ec2eAQbuLndwxkX6YCHFJR6D9h9hr2TKZSVn9N3uyxkCqDEJ?=
 =?us-ascii?Q?FWRSL9z2LmpKtqiAW/Q0X2I6FtEfkZVH3/qYHAIu8HzH0ssjB8mtIZ28MOFG?=
 =?us-ascii?Q?p0/KW+rWW8oL0pkX0h5j80VmZOa2Lfiz6fqgtUNe7VcCXatcRbYmmInBB2HE?=
 =?us-ascii?Q?oO1Z31gCJMWgCK/ImVF8gSFbuOgtPk62Djq/pMaDmBFfnch14uUYuUNNV2Md?=
 =?us-ascii?Q?MH+4M/GFlF/FmquqlTdfVfj/OcoYnpkXwn3eGrazcN7pI95rNkwYqxQJ2zqD?=
 =?us-ascii?Q?+1KO/30DQLMAdvY6+SOq5Ygongwhv24SlbMDl/or7Sh/9ywOBeesot0cTAE1?=
 =?us-ascii?Q?PQDNJYnrVUrFSoeogbxiDszq47nRKYmN4g0yTPVRQdStLNRdJZyWCWv0rn7o?=
 =?us-ascii?Q?77OsYK3L8HPZNAl9MfqVbvumIFAdTzrPnbDVrx2bTsXo2bgBfwjpHQFU/7Ka?=
 =?us-ascii?Q?yR08KR5g7CGrYCbS313Av3MQ9Yy1D5f5+q10AXRoH3ynkJSSu7KvnUNGyUOO?=
 =?us-ascii?Q?BqskqYt3pwEhSZyxVAODQ5eCx58CdF8ky926dVxUKjvYAkNf2xcKE12+CrQu?=
 =?us-ascii?Q?Xs1gUYmw3skp0GbHuKSLJcCLVnvFhdvPFKUbGdRK+BVX39rCEQLu69pes0Sc?=
 =?us-ascii?Q?Cxd8r5+U/lcXp+W4I7eepzaOmhl0JWtxvuQjidoA/iK5+TjSTCn08v7u+zpG?=
 =?us-ascii?Q?nrS/bIboUx/3S8YI33rrIEFsvOuPGzGFGtAcE+m1AgpmoYMqkS32PPSNCQLm?=
 =?us-ascii?Q?cYX3Ybl4O08Hg3CtZ2GEc/nIu1R9P8zc/6wA5+u+HVZA7JX6Qnug59G/Csrk?=
 =?us-ascii?Q?N31fCh85fqe0mFHewxmw8eecLzeQTlJ9zzIHyfexLoih0wTNxKLhe8X9v8KE?=
 =?us-ascii?Q?xakILz/3U9y/tiwRZQbktoSrKS+gSbSG5u2Y5GSryzSMbZEu126EIMiki98P?=
 =?us-ascii?Q?OzIkChqx+fFzy7PFibIhnqAgwC1UzeIF+4ryrwhLiC2N7msHJsaAYEnCRClX?=
 =?us-ascii?Q?1mZeHvrnyvHmmb33TedwzZEaGlhQ7mzsXeFMOmfV8HNhT5VNgJ3Zu9zLx+q0?=
 =?us-ascii?Q?CTKBKRwKjClfrj2julG/40ElD9TvKgaIkqgUWjKPTFE7X/FZC76yGJZYZj3f?=
 =?us-ascii?Q?w1o+BGqdcwdmAVrHUEpMpHfNhHkMqrxAmTOGORbr5+50dy0fL5XYrzkYi2d8?=
 =?us-ascii?Q?C+d1ZVd2bgSuxviGuYGswTxuf1xhp0iuwPKQAAhNLC37dwTty0fOZoGRykOY?=
 =?us-ascii?Q?Luc0nkV+hmf/buOyZe0dTYMbwc440O1RRof/AakEbTFHhzTzIBLffc18RjAv?=
 =?us-ascii?Q?LUJyDGHYdQwQn0YaexFggzdC/6f+?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(1800799015)(376005)(36860700004);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:29.7843
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 4f98d85c-b48a-4d7d-8b5b-08dc757fee43
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044AB.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: LV8PR12MB9336

From: Alejandro Lucero <alucerop@amd.com>

Creating a CXL region requires userspace intervention through the cxl
sysfs files. Type2 support should allow accelerator drivers to create
such cxl region from kernel code.

Adding that functionality and integrating it with current support for
memory expanders.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c           | 262 ++++++++++++++++++++++------
 include/linux/cxlmem.h              |   4 +
 tools/testing/cxl/type2/pci_type2.c |  18 ++
 3 files changed, 228 insertions(+), 56 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 8228b7e96d8d..014684ff4343 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -479,22 +479,14 @@ static ssize_t interleave_ways_show(struct device *dev,
 
 static const struct attribute_group *get_cxl_region_target_group(void);
 
-static ssize_t interleave_ways_store(struct device *dev,
-				     struct device_attribute *attr,
-				     const char *buf, size_t len)
+static int set_interleave_ways(struct cxl_region *cxlr, int val)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
 	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
-	struct cxl_region *cxlr = to_cxl_region(dev);
 	struct cxl_region_params *p = &cxlr->params;
-	unsigned int val, save;
-	int rc;
+	int save, rc;
 	u8 iw;
 
-	rc = kstrtouint(buf, 0, &val);
-	if (rc)
-		return rc;
-
 	rc = ways_to_eiw(val, &iw);
 	if (rc)
 		return rc;
@@ -509,25 +501,42 @@ static ssize_t interleave_ways_store(struct device *dev,
 		return -EINVAL;
 	}
 
-	rc = down_write_killable(&cxl_region_rwsem);
-	if (rc)
-		return rc;
-	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		rc = -EBUSY;
-		goto out;
-	}
+	lockdep_assert_held_write(&cxl_region_rwsem);
+	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
+		return -EBUSY;
 
 	save = p->interleave_ways;
 	p->interleave_ways = val;
 	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
 	if (rc)
 		p->interleave_ways = save;
-out:
+
+	return rc;
+}
+
+static ssize_t interleave_ways_store(struct device *dev,
+				     struct device_attribute *attr,
+				     const char *buf, size_t len)
+{
+	struct cxl_region *cxlr = to_cxl_region(dev);
+	unsigned int val;
+	int rc;
+
+	rc = kstrtouint(buf, 0, &val);
+	if (rc)
+		return rc;
+
+	rc = down_write_killable(&cxl_region_rwsem);
+	if (rc)
+		return rc;
+
+	rc = set_interleave_ways(cxlr, val);
 	up_write(&cxl_region_rwsem);
 	if (rc)
 		return rc;
 	return len;
 }
+
 static DEVICE_ATTR_RW(interleave_ways);
 
 static ssize_t interleave_granularity_show(struct device *dev,
@@ -547,21 +556,14 @@ static ssize_t interleave_granularity_show(struct device *dev,
 	return rc;
 }
 
-static ssize_t interleave_granularity_store(struct device *dev,
-					    struct device_attribute *attr,
-					    const char *buf, size_t len)
+static int set_interleave_granularity(struct cxl_region *cxlr, int val)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev->parent);
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
 	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
-	struct cxl_region *cxlr = to_cxl_region(dev);
 	struct cxl_region_params *p = &cxlr->params;
-	int rc, val;
+	int rc;
 	u16 ig;
 
-	rc = kstrtoint(buf, 0, &val);
-	if (rc)
-		return rc;
-
 	rc = granularity_to_eig(val, &ig);
 	if (rc)
 		return rc;
@@ -577,21 +579,36 @@ static ssize_t interleave_granularity_store(struct device *dev,
 	if (cxld->interleave_ways > 1 && val != cxld->interleave_granularity)
 		return -EINVAL;
 
+	lockdep_assert_held_write(&cxl_region_rwsem);
+	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)
+		return -EBUSY;
+
+	p->interleave_granularity = val;
+	return 0;
+}
+
+static ssize_t interleave_granularity_store(struct device *dev,
+					    struct device_attribute *attr,
+					    const char *buf, size_t len)
+{
+	struct cxl_region *cxlr = to_cxl_region(dev);
+	int rc, val;
+
+	rc = kstrtoint(buf, 0, &val);
+	if (rc)
+		return rc;
+
 	rc = down_write_killable(&cxl_region_rwsem);
 	if (rc)
 		return rc;
-	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		rc = -EBUSY;
-		goto out;
-	}
 
-	p->interleave_granularity = val;
-out:
+	rc = set_interleave_granularity(cxlr, val);
 	up_write(&cxl_region_rwsem);
 	if (rc)
 		return rc;
 	return len;
 }
+
 static DEVICE_ATTR_RW(interleave_granularity);
 
 static ssize_t resource_show(struct device *dev, struct device_attribute *attr,
@@ -2666,6 +2683,14 @@ cxl_find_region_by_name(struct cxl_root_decoder *cxlrd, const char *name)
 	return to_cxl_region(region_dev);
 }
 
+static void drop_region(struct cxl_region *cxlr)
+{
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
+	struct cxl_port *port = cxlrd_to_port(cxlrd);
+
+	devm_release_action(port->uport_dev, unregister_region, cxlr);
+}
+
 static ssize_t delete_region_store(struct device *dev,
 				   struct device_attribute *attr,
 				   const char *buf, size_t len)
@@ -3135,17 +3160,18 @@ static int match_region_by_range(struct device *dev, void *data)
 	return rc;
 }
 
-/* Establish an empty region covering the given HPA range */
-static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
-					   struct cxl_endpoint_decoder *cxled)
+static void construct_region_end(void)
+{
+	up_write(&cxl_region_rwsem);
+}
+
+static struct cxl_region *construct_region_begin(struct cxl_root_decoder *cxlrd,
+						 struct cxl_endpoint_decoder *cxled)
 {
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
-	struct cxl_port *port = cxlrd_to_port(cxlrd);
-	struct range *hpa = &cxled->cxld.hpa_range;
 	struct cxl_region_params *p;
 	struct cxl_region *cxlr;
-	struct resource *res;
-	int rc;
+	int err = 0;
 
 	do {
 		cxlr = __create_region(cxlrd, cxled->mode,
@@ -3154,8 +3180,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
 
 	if (IS_ERR(cxlr)) {
-		dev_err(cxlmd->dev.parent,
-			"%s:%s: %s failed assign region: %ld\n",
+		dev_err(cxlmd->dev.parent,"%s:%s: %s failed assign region: %ld\n",
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
 			__func__, PTR_ERR(cxlr));
 		return cxlr;
@@ -3165,23 +3190,47 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 	p = &cxlr->params;
 	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
 		dev_err(cxlmd->dev.parent,
-			"%s:%s: %s autodiscovery interrupted\n",
+			"%s:%s: %s region setup interrupted\n",
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
 			__func__);
-		rc = -EBUSY;
-		goto err;
+		err = -EBUSY;
+	}
+
+	if (err) {
+		construct_region_end();
+		drop_region(cxlr);
+		return ERR_PTR(err);
 	}
+	return cxlr;
+}
+
+
+/* Establish an empty region covering the given HPA range */
+static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
+					   struct cxl_endpoint_decoder *cxled)
+{
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct range *hpa = &cxled->cxld.hpa_range;
+	struct cxl_region_params *p;
+	struct cxl_region *cxlr;
+	struct resource *res;
+	int rc;
+
+	cxlr = construct_region_begin(cxlrd, cxled);
+	if (IS_ERR(cxlr))
+		return cxlr;
 
 	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
 
 	res = kmalloc(sizeof(*res), GFP_KERNEL);
 	if (!res) {
 		rc = -ENOMEM;
-		goto err;
+		goto out;
 	}
 
 	*res = DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
 				    dev_name(&cxlr->dev));
+
 	rc = insert_resource(cxlrd->res, res);
 	if (rc) {
 		/*
@@ -3194,6 +3243,7 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 			 __func__, dev_name(&cxlr->dev));
 	}
 
+	p = &cxlr->params;
 	p->res = res;
 	p->interleave_ways = cxled->cxld.interleave_ways;
 	p->interleave_granularity = cxled->cxld.interleave_granularity;
@@ -3201,24 +3251,124 @@ static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
 
 	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
 	if (rc)
-		goto err;
+		goto out;
 
 	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
-		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
-		dev_name(&cxlr->dev), p->res, p->interleave_ways,
-		p->interleave_granularity);
+				   dev_name(&cxlmd->dev),
+				   dev_name(&cxled->cxld.dev), __func__,
+				   dev_name(&cxlr->dev), p->res,
+				   p->interleave_ways,
+				   p->interleave_granularity);
 
 	/* ...to match put_device() in cxl_add_to_region() */
 	get_device(&cxlr->dev);
 	up_write(&cxl_region_rwsem);
+out:
+	construct_region_end();
+	if (rc) {
+		drop_region(cxlr);
+		return ERR_PTR(rc);
+	}
+	return cxlr;
+}
+
+static struct cxl_region *
+__construct_new_region(struct cxl_root_decoder *cxlrd,
+		       struct cxl_endpoint_decoder **cxled, int ways)
+{
+	struct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;
+	struct cxl_region_params *p;
+	resource_size_t size = 0;
+	struct cxl_region *cxlr;
+	int rc, i;
+
+	/* If interleaving is not supported, why does ways need to be at least 1? */
+	if (ways < 1)
+		return ERR_PTR(-EINVAL);
+
+	cxlr = construct_region_begin(cxlrd, cxled[0]);
+	if (IS_ERR(cxlr))
+		return cxlr;
+
+	rc = set_interleave_ways(cxlr, ways);
+	if (rc)
+		goto out;
+
+	rc = set_interleave_granularity(cxlr, cxld->interleave_granularity);
+	if (rc)
+		goto out;
+
+	down_read(&cxl_dpa_rwsem);
+	for (i = 0; i < ways; i++) {
+		if (!cxled[i]->dpa_res)
+			break;
+		size += resource_size(cxled[i]->dpa_res);
+	}
+	up_read(&cxl_dpa_rwsem);
+
+	if (i < ways)
+		goto out;
+
+	rc = alloc_hpa(cxlr, size);
+	if (rc)
+		goto out;
+
+	down_read(&cxl_dpa_rwsem);
+	for (i = 0; i < ways; i++) {
+		rc = cxl_region_attach(cxlr, cxled[i], i);
+		if (rc)
+			break;
+	}
+	up_read(&cxl_dpa_rwsem);
+
+	if (rc)
+		goto out;
+
+	rc = cxl_region_decode_commit(cxlr);
+	if (rc)
+		goto out;
 
+	p = &cxlr->params;
+	p->state = CXL_CONFIG_COMMIT;
+out:
+	construct_region_end();
+	if (rc) {
+		drop_region(cxlr);
+		return ERR_PTR(rc);
+	}
 	return cxlr;
+}
 
-err:
-	up_write(&cxl_region_rwsem);
-	devm_release_action(port->uport_dev, unregister_region, cxlr);
-	return ERR_PTR(rc);
+/**
+ * cxl_create_region - Establish a region given an array of endpoint decoders
+ * @cxlrd: root decoder to allocate HPA
+ * @cxled: array of endpoint decoders with reserved DPA capacity
+ * @ways: size of @cxled array
+ *
+ * Returns a fully formed region in the commit state and attached to the
+ * cxl_region driver.
+ */
+struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
+				     struct cxl_endpoint_decoder **cxled,
+				     int ways)
+{
+	struct cxl_region *cxlr;
+
+	mutex_lock(&cxlrd->range_lock);
+	cxlr = __construct_new_region(cxlrd, cxled, ways);
+	mutex_unlock(&cxlrd->range_lock);
+
+	if (IS_ERR(cxlr))
+		return cxlr;
+
+	if (device_attach(&cxlr->dev) <= 0) {
+		dev_err(&cxlr->dev, "failed to create region\n");
+		drop_region(cxlr);
+		return ERR_PTR(-ENODEV);
+	}
+	return cxlr;
 }
+EXPORT_SYMBOL_NS_GPL(cxl_create_region, CXL);
 
 int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
 {
diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
index caf1cd86421c..fc963c2c2dc4 100644
--- a/include/linux/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -875,4 +875,8 @@ struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
 					     resource_size_t min,
 					     resource_size_t max);
 int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
+struct cxl_region *cxl_create_region(struct cxl_root_decoder *cxlrd,
+				     struct cxl_endpoint_decoder **cxled,
+				     int ways);
+
 #endif /* __CXL_MEM_H__ */
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index 6499d709f54d..0e7f17c0c920 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -4,8 +4,10 @@
 #include <linux/cxlpci.h>
 #include <linux/cxlmem.h>
 
+struct cxl_region_params *region_params;
 struct cxl_endpoint_decoder *cxled;
 struct cxl_root_decoder *cxlrd;
+struct cxl_region *efx_region;
 struct cxl_dev_state *cxlds;
 struct cxl_memdev *cxlmd;
 struct cxl_port *endpoint;
@@ -109,6 +111,22 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 		goto out;
 	}
 
+	pci_info(pci_dev, "cxl create_region...");
+	efx_region = cxl_create_region(cxlrd, &cxled, 1);
+	if (!efx_region) {
+		rc = PTR_ERR(cxled);
+		goto out_dpa;
+	}
+
+	region_params = &efx_region->params;
+	pci_info(pci_dev, "CXL region: start=%llx, end=%llx\n", region_params->res->start,
+			  region_params->res->end);
+
+	cxl_release_endpoint(cxlmd, endpoint);
+	return 0;
+
+out_dpa:
+	cxl_dpa_free(cxled);
 out:
 	cxl_release_endpoint(cxlmd, endpoint);
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2070.outbound.protection.outlook.com [40.107.223.70])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C85966D1AF
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:31 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.70
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847155; cv=fail; b=Kwr8JfWfVyiZwsMu+AM0ovnXgzssp67wY5Nu+stQM5pa3rFx0ZMQRwf7jd0xAHlMM9zCOoD2cQ12KsdGUwkSgmF9Y70YNa212IFlEWWRvg/qi6JzUEMj6H/YX5WqGeIGD1T+HbjsRDwtb+ZFhiJf5PoCDJblyeKG8KrAmj9zNvg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847155; c=relaxed/simple;
	bh=d1UgFdx6n698+MZvZ0KRcE28EnUCsUVGrR2aVFAo5JY=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=EcLz7EOaFlvjsDFxvy1nrPvpFJ0YI5OfyWMd4o8LmGLMoqSmrIW4vCIdoo7YyFP7PU4VVqMdsr1t02ilqDy46INgX3i9dg17VMeperFSZNJXAXzgNdvOYeBoZeTVzbRecTLupoHepaKUlmx7gd+ir/2x1M4E2hNycqkyAsXekJI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=TdKO4KGl; arc=fail smtp.client-ip=40.107.223.70
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="TdKO4KGl"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=GXy0gsiJB1jmdvsXSjdns7vuFOeuzZhH58I37x/CmNHCrYGbio+1+VWuRMqIrJs4GtfPcVa+S2eQDd5R4nj/xP54DzMQ2i9GB6rKI0Rx7fRDGwdBj+LKraxg4EbHF4j+ZEdkaVDRDVHPCdKBhCPTLIGkRmb1xxGw/yFvPwv36bw2LeM0SJzQ8UXBbBehtGQucK5SYFJG/a5JcXY3jz2seGBGzWfV6ugGlSRfJTZ0sqsb2o1hyi7dP34qw83dTlQjlgov64eE+2mRIR8EEX/UprXPUYz8sD+c5d9CAKChG3xxJ/zf7a8B808Sy4spJDbqQF2n6keOZ3uwtQjlqsOuQg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=8U947/xOg81oQsK5saZT33sZnO1Pan0/p75dO8s/pZ4=;
 b=Z4oL7+bgl0yU4Qlt8NmpY7R5Eu8VjKHXd4KlhgRwhNYPLP3XewWRZrSubznlif4pJ5Bc3omLMiBb937SV0BXs731MF7fwmcijfdPmNaKTx1D4JjKTKHKWDZyjpIRtFtVTELsvF8eKYPiU5Pn04B8fXZ1WE31MjWkhmruSkSID8lNXdXQPykQ52gk9SMDC5PIV5RlNpaQ7hSpySJEUyvJQ5Qa3gET07qX34OLxcI+TohMasx6fPVBPXn3VYK5LyNH5XRaorQKLcTIMFaQeUWAkpDbQG2U4jKUw+qcxYSrrfAtWFp6bX6TaYKrxmRP0NRSpdBQiVa06qkGHMGMZW7Yng==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=8U947/xOg81oQsK5saZT33sZnO1Pan0/p75dO8s/pZ4=;
 b=TdKO4KGlCAJ62ASB/s+LU1Pe+CqHvsuASk0Rs/8D+2V533FGh0lojKv4HX1PUpu91kOJYyQSNYtvxmBHUDKM08Orlo452sMZLP2S/e0ebgG8Z+YkyTRKl8Netcr/vT1A6Ta5SSf+2tKnVmox9yKoph0lDg/LGHDCzzhqR1SSp4g=
Received: from MN2PR19CA0046.namprd19.prod.outlook.com (2603:10b6:208:19b::23)
 by CY8PR12MB7516.namprd12.prod.outlook.com (2603:10b6:930:94::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.26; Thu, 16 May
 2024 08:12:29 +0000
Received: from BN2PEPF000044AB.namprd04.prod.outlook.com
 (2603:10b6:208:19b:cafe::37) by MN2PR19CA0046.outlook.office365.com
 (2603:10b6:208:19b::23) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55 via Frontend
 Transport; Thu, 16 May 2024 08:12:29 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044AB.mail.protection.outlook.com (10.167.243.106) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:29 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:24 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:23 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 08/13] cxl: add cxl_get_hpa_freespace
Date: Thu, 16 May 2024 09:11:57 +0100
Message-ID: <20240516081202.27023-9-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044AB:EE_|CY8PR12MB7516:EE_
X-MS-Office365-Filtering-Correlation-Id: 582bd528-eb4e-4d66-7cd3-08dc757fedd3
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|1800799015|82310400017|36860700004|376005;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?YXJ1ZDFzZTEvVm5TbCtISXJqelRSMUdURkJNekdvSERRNHN3SGRKNlpkS0pv?=
 =?utf-8?B?cGhTaEJnVWtEaXpkeUtSSWdpQzdKeUlsSjFacUpHOVhJNUpiSVN5bis0dUJT?=
 =?utf-8?B?ZlFtRUFpaWJoeHl2WkZSWFFIK3RSU1lmbmVEbHVIKzNsaklrRkE0WFFKSnNT?=
 =?utf-8?B?dzI0WEdIcDRYNVlEcHBkWjNJM3QxMmRqSFZCTTBRWEkrR09jcXM3dVg5TXVx?=
 =?utf-8?B?eXFqdkRzbld6b2VocVJiK3NDQzNocW03WVpwbmtsK1VQQzAwVTJKSStrZ09J?=
 =?utf-8?B?d1JFcjBLUnRxamFoZkEydDVheGszaFJlRDB4YU9Ed1ZwbEZmeUJpck90a1lv?=
 =?utf-8?B?dEFGcVZLQmtNNDhkSVE4d1dTV1gyeUoyY284SjZ3c2lOODRzQUEyMjVLVFdD?=
 =?utf-8?B?cTUyRTIrbEUxaDFURXMxc3g2UjhoVkVzNUxJVkJVWlo2QXpsTTZTVWpEN2xF?=
 =?utf-8?B?RXYxa21PYzBFMjZORlZmZGpKalROcXJoSnFSSngrbXJVNGRURytzOWpPMFh6?=
 =?utf-8?B?bmhwL2dKVHFFSnJxK2lxaVlVRFYvcU9lSnFFRWdDYkptbXdZcUlSQitjMDll?=
 =?utf-8?B?bDg2eDF3S1d6Vjl4cGRoaURiK2tCQXMwa0RURlFQYjVUWG9ub1ZpWlgybmtT?=
 =?utf-8?B?eE9wU1h4ZlJaaFlKK0JXRStQMUlFbnk1QmpWZlQzdHhQV1NQYWJmZ3NGRlo1?=
 =?utf-8?B?SGltSC95M3ZnSXJ5d2pTMVhLS0dpRW5OM0h1K0pYLzVJeDdRNnA0RWlxVUJN?=
 =?utf-8?B?eWVmSFFnVmxEWUNlbFlZa25zWFR3SmlTRk04ejVNQlprczBIL0hmRE1QSlJL?=
 =?utf-8?B?QVR6UGFHdDFKbzRpUmJsZkVEb0RiK042MStYYkFOYzlLUHpXNnVXd2ZxS2l5?=
 =?utf-8?B?UFdNR09GMHNFalpnSlFwcTR4Y1Nmem9hSGJXbDF0eVdTa25DT0d2eEswemls?=
 =?utf-8?B?ZWxxOW5HQTFhSDFVK21kMjRIazFxMmpyTklQUk5wcEVoQ3l5UFFLZlBFbjBn?=
 =?utf-8?B?ZDlnd3IrU3d6aFB5cjhjRWRnSzVzUThSSHF3S0JDS3M4Q0lSRjRESEhaZWJN?=
 =?utf-8?B?bG1PRll1YUtjWlVzNUtjSFJ1bm1Rem9OaVg3ZlZYaG1LYWdjMWFHbktKV2hz?=
 =?utf-8?B?bTV6ZXBsRlE3eGpodWRHRVBBRWJaYjlmOGl6dXgrcURpTHRERFVIckNNM2py?=
 =?utf-8?B?R2FPQnFRbEtDNHhKUkcwMDhmR2EycjZzL2MyQ0RBT1BGQWYyNXgzS0VURXhD?=
 =?utf-8?B?NEJML2c2S0t5czBPcXNheEVYUFR3K2ZhNlh0YnZ4OUdPYXRXL2FDU1dmTVJh?=
 =?utf-8?B?SVFTalBRdC9KdDRXNmZWQUtxSVM5YzNnYWk0cENLTnp4ZGwxZk8rVjFrNkps?=
 =?utf-8?B?L0wweER1azVsQmNFTTVXNEsxM3JMZXFMSFhycFNwNmJjOHV5UkRPTkQxZ09i?=
 =?utf-8?B?cEUyWkVNbWFyczBEOHVoYTRna0wxUkFkZk9sbzc2R01JaFlkM2pTeUtrbm9R?=
 =?utf-8?B?NUdMclhoS29YUnhuQ0lJbm1DcThnTDlOZExDTVZqeUpiS0QyMGFSRk41TFB5?=
 =?utf-8?B?UUJMWE9MYjF2ckNuRmZkQTlwaEZRTjY2amlqZTdWSnJkTjc1c1M5Q0pmZHNP?=
 =?utf-8?B?R0M1bU9BYjZ4SGhvbmYrNEZiS0lJQzNoVnhLLzBwUStCMkNSL3BXOXdHN05l?=
 =?utf-8?B?MG5WVE03Ti9rQTRZUUNmUWV4cTYvS3V6ajM2bzRpc3pHNDhFUytPMWNuRklj?=
 =?utf-8?B?M3c2czlielJMU1FnTXNLajdhZjUxTEwyaWs0cXM2eUhnRlBJcC8vNFhyZjgy?=
 =?utf-8?B?NmNXN0FMWWV1ZDFDTndvbHI0YWJvdW0rQ3RNWkNOcDNCMlFZQzc0OHRLeXRk?=
 =?utf-8?Q?uxjBmF6PJtmAp?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(1800799015)(82310400017)(36860700004)(376005);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:29.0499
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 582bd528-eb4e-4d66-7cd3-08dc757fedd3
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044AB.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY8PR12MB7516

From: Alejandro Lucero <alucerop@amd.com>

Based on the requirements from the endpoint and the topology such an
endpoint is attached to, this function informs about maximum host
physical address space possible to request. This is not a reservation
but only information which could change at the point the request based
on this information is made.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c           | 163 ++++++++++++++++++++++++++++
 include/linux/cxl.h                 |   5 +
 include/linux/cxlmem.h              |   5 +
 tools/testing/cxl/type2/pci_type2.c |  23 +++-
 4 files changed, 195 insertions(+), 1 deletion(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 70e86a7c241d..2731fd4243a1 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -702,6 +702,169 @@ static int free_hpa(struct cxl_region *cxlr)
 	return 0;
 }
 
+
+struct cxlrd_max_context {
+	struct device * const *host_bridges;
+	int interleave_ways;
+	unsigned long flags;
+	resource_size_t max_hpa;
+	struct cxl_root_decoder *cxlrd;
+};
+
+static int find_max_hpa(struct device *dev, void *data)
+{
+	struct cxlrd_max_context *ctx = data;
+	struct cxl_switch_decoder *cxlsd;
+	struct cxl_root_decoder *cxlrd;
+	struct resource *res, *prev;
+	struct cxl_decoder *cxld;
+	resource_size_t max;
+	int found;
+
+	if (!is_root_decoder(dev))
+		return 0;
+
+	cxlrd = to_cxl_root_decoder(dev);
+	cxld = &cxlrd->cxlsd.cxld;
+	if ((cxld->flags & ctx->flags) != ctx->flags) {
+		dev_dbg(dev, "find_max_hpa, flags not matching: %08lx vs %08lx\n",
+			      cxld->flags, ctx->flags);
+		return 0;
+	}
+
+	/* A Host bridge could have more interleave ways than an
+	 * endpoint, couldnÂ´t it?
+	 *
+	 * What does interleave ways mean here in terms of the requestor?
+	 * Why the FFMWS has 0 interleave ways but root port has 1?
+	 */
+	if (cxld->interleave_ways != ctx->interleave_ways) {
+		dev_dbg(dev, "find_max_hpa, interleave_ways  not matching\n");
+		return 0;
+	}
+
+	cxlsd = &cxlrd->cxlsd;
+
+	guard(rwsem_read)(&cxl_region_rwsem);
+	found = 0;
+	for (int i = 0; i < ctx->interleave_ways; i++)
+		for (int j = 0; j < ctx->interleave_ways; j++)
+			if (ctx->host_bridges[i] ==
+					cxlsd->target[j]->dport_dev) {
+				found++;
+				break;
+			}
+
+	if (found != ctx->interleave_ways) {
+		dev_dbg(dev, "find_max_hpa, no interleave_ways found\n");
+		return 0;
+	}
+
+	/*
+	 * Walk the root decoder resource range relying on cxl_region_rwsem to
+	 * preclude sibling arrival/departure and find the largest free space
+	 * gap.
+	 */
+	lockdep_assert_held_read(&cxl_region_rwsem);
+	max = 0;
+	res = cxlrd->res->child;
+	if (!res)
+		max = resource_size(cxlrd->res);
+	else
+		max = 0;
+
+	for (prev = NULL; res; prev = res, res = res->sibling) {
+		struct resource *next = res->sibling;
+		resource_size_t free = 0;
+
+		if (!prev && res->start > cxlrd->res->start) {
+			free = res->start - cxlrd->res->start;
+			max = max(free, max);
+		}
+		if (prev && res->start > prev->end + 1) {
+			free = res->start - prev->end + 1;
+			max = max(free, max);
+		}
+		if (next && res->end + 1 < next->start) {
+			free = next->start - res->end + 1;
+			max = max(free, max);
+		}
+		if (!next && res->end + 1 < cxlrd->res->end + 1) {
+			free = cxlrd->res->end + 1 - res->end + 1;
+			max = max(free, max);
+		}
+	}
+
+	if (max > ctx->max_hpa) {
+		if (ctx->cxlrd)
+			put_device(CXLRD_DEV(ctx->cxlrd));
+		get_device(CXLRD_DEV(cxlrd));
+		ctx->cxlrd = cxlrd;
+		ctx->max_hpa = max;
+		dev_info(CXLRD_DEV(cxlrd), "found %pa bytes of free space\n", &max);
+	}
+	return 0;
+}
+
+/**
+ * cxl_get_hpa_freespace - find a root decoder with free capacity per constraints
+ * @endpoint: an endpoint that is mapped by the returned decoder
+ * @host_bridges: array of host-bridges that the decoder must interleave
+ * @interleave_ways: number of entries in @host_bridges
+ * @flags: CXL_DECODER_F flags for selecting RAM vs PMEM, and HDM-H vs HDM-D[B]
+ * @max: output parameter of bytes available in the returned decoder
+ *
+ * The return tuple of a 'struct cxl_root_decoder' and 'bytes available (@max)'
+ * is a point in time snapshot. If by the time the caller goes to use this root
+ * decoder's capacity the capacity is reduced then caller needs to loop and
+ * retry.
+ *
+ * The returned root decoder has an elevated reference count that needs to be
+ * put with put_device(cxlrd_dev(cxlrd)). Locking context is with
+ * cxl_{acquire,release}_endpoint(), that ensures removal of the root decoder
+ * does not race.
+ */
+struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
+					       struct device *const *host_bridges,
+					       int interleave_ways,
+					       unsigned long flags,
+					       resource_size_t *max)
+{
+
+	struct cxlrd_max_context ctx = {
+		.host_bridges = host_bridges,
+		.interleave_ways = interleave_ways,
+		.flags = flags,
+	};
+	struct cxl_port *root_port;
+	struct cxl_root *root;
+
+	if (!is_cxl_endpoint(endpoint)) {
+		dev_dbg(&endpoint->dev, "hpa requestor is not an endpointr\n");
+		return ERR_PTR(-EINVAL);
+	}
+
+	root = find_cxl_root(endpoint);
+	if (!root) {
+		dev_dbg(&endpoint->dev, "endpoint can not be related to a root port\n");
+		return ERR_PTR(-ENXIO);
+	}
+
+	root_port = &root->port;
+	down_read(&cxl_region_rwsem);
+	device_for_each_child(&root_port->dev, &ctx, find_max_hpa);
+	up_read(&cxl_region_rwsem);
+	put_device(&root_port->dev);
+
+	if (!ctx.cxlrd)
+		return ERR_PTR(-ENOMEM);
+
+	*max = ctx.max_hpa;
+	return ctx.cxlrd;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_get_hpa_freespace, CXL);
+
+
 static ssize_t size_store(struct device *dev, struct device_attribute *attr,
 			  const char *buf, size_t len)
 {
diff --git a/include/linux/cxl.h b/include/linux/cxl.h
index 036d17db68e0..1b2377062693 100644
--- a/include/linux/cxl.h
+++ b/include/linux/cxl.h
@@ -766,6 +766,11 @@ struct cxl_decoder *to_cxl_decoder(struct device *dev);
 struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
 struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
 struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
+
+#define CXLED_DEV(cxled)  &cxled->cxld.dev
+
+#define CXLRD_DEV(cxlrd) &cxlrd->cxlsd.cxld.dev
+
 bool is_root_decoder(struct device *dev);
 bool is_switch_decoder(struct device *dev);
 bool is_endpoint_decoder(struct device *dev);
diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
index 11fe8367b046..342ccd5486d3 100644
--- a/include/linux/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -865,4 +865,9 @@ struct dentry *cxl_debugfs_create_dir(const char *dir);
 void cxl_dpa_debug(struct seq_file *file, struct cxl_dev_state *cxlds);
 
 struct cxl_dev_state *cxl_accel_state_create(struct device *dev);
+struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
+					   struct device *const *host_bridges,
+					   int interleave_ways,
+					   unsigned long flags,
+					   resource_size_t *max);
 #endif /* __CXL_MEM_H__ */
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index 948cc95c5780..deb5eeae501b 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -4,6 +4,7 @@
 #include <linux/cxlpci.h>
 #include <linux/cxlmem.h>
 
+struct cxl_root_decoder *cxlrd;
 struct cxl_dev_state *cxlds;
 struct cxl_memdev *cxlmd;
 struct cxl_port *endpoint;
@@ -15,6 +16,7 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 
 {
 	struct cxl_register_map map;
+	resource_size_t max = 0;
 	u16 dvsec;
 	int rc;
 
@@ -79,9 +81,28 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 		return PTR_ERR(endpoint);
 	}
 
+	pci_info(pci_dev, "cxl hpa_freespace...");
+	cxlrd = cxl_get_hpa_freespace(endpoint, &endpoint->host_bridge, 1,
+				      CXL_DECODER_F_RAM | CXL_DECODER_F_TYPE2,
+				      &max);
+
+	if (IS_ERR(cxlrd)) {
+		dev_dbg(&pci_dev->dev, "cxl_get_hpa_freespace failed\n");
+		rc = PTR_ERR(cxlrd);
+		goto out;
+	}
+
+	if (max < CXL_TYPE2_MEM_SIZE) {
+		dev_dbg(&pci_dev->dev, "%s: no enough free HPA space %llu < %u\n",
+				       __func__, max, CXL_TYPE2_MEM_SIZE);
+		rc = -ENOMEM;
+		goto out;
+	}
+
+out:
 	cxl_release_endpoint(cxlmd, endpoint);
 
-	return 0;
+	return rc;
 }
 
 static void type2_pci_remove(struct pci_dev *pci_dev)
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2073.outbound.protection.outlook.com [40.107.243.73])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0F08E6DCE3
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.73
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847155; cv=fail; b=mg3ryuTaAmxnNb8mg+Qz2eQVyjkGw8mvLehGSeHyfdQPIA6Sy9R+Y9iHq3/5KpJ6t0bE7MPiXy2PiveE7J8x+SkuSj8hzl5W4NW8vvsUjH3ccoieM1Drs2qkUD1F0GyVlj3A6DnHbrTmYtM6biG8/dVsqoA7sBD034UYllXKOyI=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847155; c=relaxed/simple;
	bh=tCqLT0SoYMQus09BOqacnF1AJxUoKYIXDjtpqTsjYtI=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=f73eZR5EfrHCDOZIt8Nj5o26ItF9kFewk1KdBzFbyZh1cc87KPJFQIMbutqlymy1Dfj/Uc6EN+dQvac0F1T90Asp72KKMA1Sc4/M3xixmSKpSyv8kooj8aMVTK7uVe4HsdK3pEisUu7feUTeD/dnwCmTaZTFT9CPZPKm50xZdfc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=BT9N5D04; arc=fail smtp.client-ip=40.107.243.73
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="BT9N5D04"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Jty1BRusGiFSB5Kvnv6rXCyP7ySbSQW7w4w/96hw7sP3oLDa4s8MizgrmApHDaDFjpUm8TKHBU4TFpXdVpPdrDuBQH/hFpSTwa3iS0k20pv3qFovP7SGtQoIEa1mIgFJWh2ZY5JOuNLhl9VDpG9xuSsFfs4pCxOZFRzqCh/1OsguOrPq8L+h9IYGxv9QGK1EIrF++R7rUyiOJH3SI6iXJIhPd3QA1TQ0GCIepOdA2l+MHCTxYUo2W0JL4Evzg5xr7MEBxS5ct650baMIoI9m4rOqRcF8m4jeJcurhrQp4UeCm8C+l6MGUcwzvROQCsQZIY7C1Rox7SEdXDNrP/ItsA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3yxDj4NnejIpoplpXR0m5pKsGMQ4eEXMkPk/rqHgz8k=;
 b=OqoA+4QPeN0ZVITxBumk8Qac19uuZngBFx7j2HHl0ffJWk9toqmKeKDRtpKXrt4wm96jqltDmYAqKVxtzQe6QhSWcbdhOM+hxO9HayFKYvwlM6d2C9Pv0SgmNJJyCZaSyKtEJXAivGdHyk1kIKZ7c+5383ElhINijeMlDWJ+8x5f7BN9hxtmi2jEqWVAt+ep7vVnxsglVmt0WpL14vzMq/lsfr4WpaVJPv9ljWCsAJhgVUA27g0EhxSsFcynJfFrUkSgdkekYzF3SvnO9H+SHFq7HIpgPuhsaSCNUwhaqgz9dk+fcIfh2HrcETgr095eIL5QP8KernqtolemzOINHQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=3yxDj4NnejIpoplpXR0m5pKsGMQ4eEXMkPk/rqHgz8k=;
 b=BT9N5D04YKRC2aGbFWyioBoO4Uokto8Ttn4k3KSgaDGT4Fd/mS8za1SFtoNfVYkJJfuZ5pqk7KLDb8WJigqNjBoZr3KZQmTGlqgXhea5dISTkQRgTZwj13DMQ5Lbd3gljQGvChfxZ+0kyf72rPf+mzXjn6Vd/AjIlxSx73qHXQU=
Received: from BN9PR03CA0502.namprd03.prod.outlook.com (2603:10b6:408:130::27)
 by PH8PR12MB6844.namprd12.prod.outlook.com (2603:10b6:510:1cb::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55; Thu, 16 May
 2024 08:12:29 +0000
Received: from BN2PEPF000044A8.namprd04.prod.outlook.com
 (2603:10b6:408:130:cafe::f6) by BN9PR03CA0502.outlook.office365.com
 (2603:10b6:408:130::27) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7544.55 via Frontend
 Transport; Thu, 16 May 2024 08:12:29 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A8.mail.protection.outlook.com (10.167.243.102) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:29 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:25 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:24 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 09/13] cxl: add cxl_request_dpa
Date: Thu, 16 May 2024 09:11:58 +0100
Message-ID: <20240516081202.27023-10-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A8:EE_|PH8PR12MB6844:EE_
X-MS-Office365-Filtering-Correlation-Id: b28783f2-2146-451c-6cfe-08dc757fedeb
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|36860700004|1800799015|376005|82310400017;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?Ax3BLshqly1zP3JOpmySGkj+aZQIYgYTEq5Zn2awjQ1GOqWJxmlIgSimyl0N?=
 =?us-ascii?Q?1PUfvoTE0XdfZGLwClh1nYa/C6H2FczDas4f4R67vSQgFCD7V4U0OnaoiN3b?=
 =?us-ascii?Q?z0BtPiIKo1Sw/1r+u3V8G1GDEEVqar9/G+5PJV7Omt1wmch2juPdhE2RM8ae?=
 =?us-ascii?Q?wbGRlt9xjSODuONbjwBTdJ9Rm/gqHblzp8vy516jvY2YZbVgZKrCi5jfaunM?=
 =?us-ascii?Q?Z7sIYfmBOx4k6V10hvyuRlYaVu4UgkiNOnHd0ektCsKtuLnXkbnAs/pJ9rmw?=
 =?us-ascii?Q?PQ9TM+cNeJQX2r+1+eMyStL9/EoSScB9X0Vvomvjfbac812ms+Dg7tL8fl2J?=
 =?us-ascii?Q?gFy7M+CmXEIa1cfUrS4hVc1zHvdwuC3+5fX6ubCuRP9qQCio+MiHGe9fPVsT?=
 =?us-ascii?Q?Ir5a3kA6w5HOjAYW8gEks6zwE6bXOjaVqDmUrcGnm57fazlJcR+2ZTc21EmY?=
 =?us-ascii?Q?2g5TF4DB9qmZ3BQmJ8z+gJ0DlhQTX2Kryh0Xax9txMHTAIa4bZQBye3p7qbi?=
 =?us-ascii?Q?sGQK5J04QhfnO0S4N1KTMfIob/PgCEzhV3kb0L0T3uSQ5YFtkUiC68HQHf4u?=
 =?us-ascii?Q?ugM/YT2/55JNek44iGKvASS8XjlYuFfwi0jYNMxEmrGWPpRaatPC1zfeBVxd?=
 =?us-ascii?Q?Xr9T/jjzGphXI7n7A9iCkacEUqjELUfM24MUxjFXI2OZtLyfVnmDqs0xgpnb?=
 =?us-ascii?Q?IsGb1CMD5Mzf2ReAPxHxBTCtowLnfcT14vGKkVnfjxbdKW8e/SzmX72WEbf6?=
 =?us-ascii?Q?s3gKWlilBW+gddipF08nOdAg0FJGlDQIp7EgLF5MQOLaM6+UED1+SUU6/ZQU?=
 =?us-ascii?Q?LQi1eKZ7qsMnrTJsl1Hf/4uUnq8L4yCH6/TBUldy6Q4MiLGO7qOWXtoe4y1o?=
 =?us-ascii?Q?ZWFLzStZmuU/uYI9K0RCXpfrW9yJpYlaR3r0heTJpFHXM/G2x5YO1N+ISdOM?=
 =?us-ascii?Q?N4+8A+6sSs4QcWUhm3UccG9tqp99+XvYuV+50JL0KP6s7Tln3l/D+DE6AjIS?=
 =?us-ascii?Q?B2ifAqNA8keyj5AYSrz4UdGs8Rl9K/4Tyv2+5N1MInx8EZJbIzZCrqVuaBbq?=
 =?us-ascii?Q?Q/d+35ZGLBMWpK65qI5zOCrA/xXqUvhKOsvzu3Yfo7uhVEUZpUyNppE4MQQg?=
 =?us-ascii?Q?osMIIsDIpSevzYPdUgtv7dMd8R8Q2HHQHGYoQKTAJWiRUCOW3+2GS7QKimZB?=
 =?us-ascii?Q?hGOeLktWdxhwLz5PnIv94n4dDzCERX+ZY90DjC7m31ynWa4foZM4A6nkRHze?=
 =?us-ascii?Q?8EilsPdQQQY9tlFUaz71BKn/0xLO/mNI/itA0lX3ywWFro/ho25UeLcuHj7Q?=
 =?us-ascii?Q?utY+GS8GO9m3ugCrcEo+upB4yovWDNm+aiRbniW/5gX+I71YzFqclhzTjMIS?=
 =?us-ascii?Q?IYB1MzovFcuE7CMTqfmu6v2lw28R?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(36860700004)(1800799015)(376005)(82310400017);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:29.2224
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: b28783f2-2146-451c-6cfe-08dc757fedeb
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A8.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB6844

From: Alejandro Lucero <alucerop@amd.com>

Search and reserve DPA given input constraints.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/core.h             |   1 -
 drivers/cxl/core/hdm.c              | 153 +++++++++++++++++++++++-----
 include/linux/cxlmem.h              |   5 +
 tools/testing/cxl/type2/pci_type2.c |  12 ++-
 4 files changed, 145 insertions(+), 26 deletions(-)

diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index bc5a95665aa0..c0a2e2c1ccb3 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -61,7 +61,6 @@ struct dentry *cxl_debugfs_create_dir(const char *dir);
 int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 		     enum cxl_decoder_mode mode);
 int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size);
-int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
 resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
 resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
 
diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index c5f70741d70a..6459b6ecde88 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -404,6 +404,7 @@ int cxl_dpa_free(struct cxl_endpoint_decoder *cxled)
 	up_write(&cxl_dpa_rwsem);
 	return rc;
 }
+EXPORT_SYMBOL_NS_GPL(cxl_dpa_free, CXL);
 
 int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 		     enum cxl_decoder_mode mode)
@@ -451,30 +452,17 @@ int cxl_dpa_set_mode(struct cxl_endpoint_decoder *cxled,
 	return rc;
 }
 
-int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
+static resource_size_t cxl_dpa_freespace(struct cxl_endpoint_decoder *cxled,
+					 resource_size_t *start_out,
+					 resource_size_t *skip_out)
 {
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
 	resource_size_t free_ram_start, free_pmem_start;
-	struct cxl_port *port = cxled_to_port(cxled);
 	struct cxl_dev_state *cxlds = cxlmd->cxlds;
-	struct device *dev = &cxled->cxld.dev;
 	resource_size_t start, avail, skip;
 	struct resource *p, *last;
-	int rc;
-
-	down_write(&cxl_dpa_rwsem);
-	if (cxled->cxld.region) {
-		dev_dbg(dev, "decoder attached to %s\n",
-			dev_name(&cxled->cxld.region->dev));
-		rc = -EBUSY;
-		goto out;
-	}
 
-	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
-		dev_dbg(dev, "decoder enabled\n");
-		rc = -EBUSY;
-		goto out;
-	}
+	lockdep_assert_held(&cxl_dpa_rwsem);
 
 	for (p = cxlds->ram_res.child, last = NULL; p; p = p->sibling)
 		last = p;
@@ -496,7 +484,6 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
 		skip = 0;
 	} else if (cxled->mode == CXL_DECODER_PMEM) {
 		resource_size_t skip_start, skip_end;
-
 		start = free_pmem_start;
 		avail = cxlds->pmem_res.end - start + 1;
 		skip_start = free_ram_start;
@@ -506,21 +493,50 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
 		 * already handled the skip.
 		 */
 		if (cxlds->pmem_res.child &&
-		    skip_start == cxlds->pmem_res.child->start)
+				skip_start == cxlds->pmem_res.child->start)
 			skip_end = skip_start - 1;
 		else
 			skip_end = start - 1;
 		skip = skip_end - skip_start + 1;
 	} else {
-		dev_dbg(dev, "mode not set\n");
-		rc = -EINVAL;
+		avail = 0;
+	}
+
+	if (!avail)
+		return 0;
+	if (start_out)
+		*start_out = start;
+	if (skip_out)
+		*skip_out = skip;
+	return avail;
+}
+
+int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
+{
+	struct cxl_port *port = cxled_to_port(cxled);
+	struct device *dev = &cxled->cxld.dev;
+	resource_size_t start, avail, skip;
+	int rc;
+
+	down_write(&cxl_dpa_rwsem);
+	if (cxled->cxld.region) {
+		dev_dbg(dev, "EBUSY, decoder attached to %s\n",
+			     dev_name(&cxled->cxld.region->dev));
+		rc = -EBUSY;
 		goto out;
 	}
 
+	if (cxled->cxld.flags & CXL_DECODER_F_ENABLE) {
+		dev_dbg(dev, "EBUSY, decoder enabled\n");
+		rc = -EBUSY;
+		goto out;
+	}
+
+	avail = cxl_dpa_freespace(cxled, &start, &skip);
 	if (size > avail) {
 		dev_dbg(dev, "%pa exceeds available %s capacity: %pa\n", &size,
-			cxled->mode == CXL_DECODER_RAM ? "ram" : "pmem",
-			&avail);
+			     cxled->mode == CXL_DECODER_RAM ? "ram" : "pmem",
+			     &avail);
 		rc = -ENOSPC;
 		goto out;
 	}
@@ -532,9 +548,98 @@ int cxl_dpa_alloc(struct cxl_endpoint_decoder *cxled, unsigned long long size)
 	if (rc)
 		return rc;
 
-	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
+        return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
 }
 
+static int find_free_decoder(struct device *dev, void *data)
+{
+	struct cxl_endpoint_decoder *cxled;
+	struct cxl_port *port;
+
+	if (!is_endpoint_decoder(dev))
+		return 0;
+
+	cxled = to_cxl_endpoint_decoder(dev);
+	port = cxled_to_port(cxled);
+
+	if (cxled->cxld.id != port->hdm_end + 1) {
+		return 0;
+	}
+	return 1;
+}
+
+/**
+ * cxl_request_dpa - search and reserve DPA given input constraints
+ * @endpoint: an endpoint port with available decoders
+ * @mode: DPA operation mode (ram vs pmem)
+ * @min: the minimum amount of capacity the call needs
+ * @max: extra capacity to allocate after min is satisfied
+ *
+ * Given that a region needs to allocate from limited HPA capacity it
+ * may be the case that a device has more mappable DPA capacity than
+ * available HPA. So, the expectation is that @min is a driver known
+ * value for how much capacity is needed, and @max is based the limit of
+ * how much HPA space is available for a new region.
+ *
+ * Returns a pinned cxl_decoder with at least @min bytes of capacity
+ * reserved, or an error pointer. The caller is also expected to own the
+ * lifetime of the memdev registration associated with the endpoint to
+ * pin the decoder registered as well.
+ */
+struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
+					     enum cxl_decoder_mode mode,
+					     resource_size_t min,
+					     resource_size_t max)
+{
+	struct cxl_endpoint_decoder *cxled;
+	struct device *cxled_dev;
+	resource_size_t alloc;
+	int rc;
+
+	if (!IS_ALIGNED(min | max, SZ_256M))
+		return ERR_PTR(-EINVAL);
+
+	down_read(&cxl_dpa_rwsem);
+
+	cxled_dev = device_find_child(&endpoint->dev, NULL, find_free_decoder);
+	if (!cxled_dev)
+		cxled = ERR_PTR(-ENXIO);
+	else
+		cxled = to_cxl_endpoint_decoder(cxled_dev);
+
+	up_read(&cxl_dpa_rwsem);
+
+	if (IS_ERR(cxled)) {
+               return cxled;
+	}
+
+	rc = cxl_dpa_set_mode(cxled, mode);
+	if (rc)
+		goto err;
+
+	down_read(&cxl_dpa_rwsem);
+	alloc = cxl_dpa_freespace(cxled, NULL, NULL);
+	up_read(&cxl_dpa_rwsem);
+
+	if (max)
+		alloc = min(max, alloc);
+	if (alloc < min) {
+		rc = -ENOMEM;
+		goto err;
+	}
+
+	rc = cxl_dpa_alloc(cxled, alloc);
+	if (rc)
+		goto err;
+
+	return cxled;
+err:
+	put_device(cxled_dev);
+	return ERR_PTR(rc);
+}
+EXPORT_SYMBOL_NS_GPL(cxl_request_dpa, CXL);
+
+
 static void cxld_set_interleave(struct cxl_decoder *cxld, u32 *ctrl)
 {
 	u16 eig;
diff --git a/include/linux/cxlmem.h b/include/linux/cxlmem.h
index 342ccd5486d3..caf1cd86421c 100644
--- a/include/linux/cxlmem.h
+++ b/include/linux/cxlmem.h
@@ -870,4 +870,9 @@ struct cxl_root_decoder *cxl_get_hpa_freespace(struct cxl_port *endpoint,
 					   int interleave_ways,
 					   unsigned long flags,
 					   resource_size_t *max);
+struct cxl_endpoint_decoder *cxl_request_dpa(struct cxl_port *endpoint,
+					     enum cxl_decoder_mode mode,
+					     resource_size_t min,
+					     resource_size_t max);
+int cxl_dpa_free(struct cxl_endpoint_decoder *cxled);
 #endif /* __CXL_MEM_H__ */
diff --git a/tools/testing/cxl/type2/pci_type2.c b/tools/testing/cxl/type2/pci_type2.c
index deb5eeae501b..6499d709f54d 100644
--- a/tools/testing/cxl/type2/pci_type2.c
+++ b/tools/testing/cxl/type2/pci_type2.c
@@ -4,6 +4,7 @@
 #include <linux/cxlpci.h>
 #include <linux/cxlmem.h>
 
+struct cxl_endpoint_decoder *cxled;
 struct cxl_root_decoder *cxlrd;
 struct cxl_dev_state *cxlds;
 struct cxl_memdev *cxlmd;
@@ -99,6 +100,15 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 		goto out;
 	}
 
+	pci_info(pci_dev, "cxl request_dpa...");
+	cxled = cxl_request_dpa(endpoint, CXL_DECODER_RAM, CXL_TYPE2_MEM_SIZE,
+				CXL_TYPE2_MEM_SIZE);
+	if (IS_ERR(cxled)) {
+		dev_dbg(&pci_dev->dev, "cxl_request_dpa error\n");
+		rc = PTR_ERR(cxled);
+		goto out;
+	}
+
 out:
 	cxl_release_endpoint(cxlmd, endpoint);
 
@@ -107,7 +117,7 @@ static int type2_pci_probe(struct pci_dev *pci_dev,
 
 static void type2_pci_remove(struct pci_dev *pci_dev)
 {
-
+	cxl_dpa_free(cxled);
 }
 
 /* PCI device ID table */
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2050.outbound.protection.outlook.com [40.107.92.50])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EF4A16D1AF
	for <linux-cxl@vger.kernel.org>; Thu, 16 May 2024 08:12:35 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.50
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1715847157; cv=fail; b=igwkWeZeBXl1Gf0mZEeMs0ttiS8MbRY6S78oQhsuIppSe3zyiOn9z/JXS5N9Dr2kwsyWOEP6t/C/chr5/SDO1lG5EuSepcBi/B5yg7tYZdKXm8JY7twLNtYG6E+OxPaOqaGaJ4KFds8aG0/M24ss9/FLuIKGl+dIpaoSQ60kHXQ=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1715847157; c=relaxed/simple;
	bh=SbFhcvNUuJ0DPXQqf/ZWa3JIoYTMp+MZ9a56yfwEtXY=;
	h=From:To:CC:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=ViRLs/f1h3gyLg0QhpiOK0SufOeIxXJf7oz1nubXg+P0EsJA9OjX6+N2H/kMhDoY8lneZNThQM+vOR3tV2vRHKxCO0vh/gkU/JLR5jS889Bf7m6c0e9lj6yJstUqReYNZkDg/IcvPiBVynDPqnT+288L4KFLSxqvAto2K/a1ekk=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=ne54+u/u; arc=fail smtp.client-ip=40.107.92.50
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="ne54+u/u"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=E9pLLawsbWqYgOTkbnBNvFCERb4MtjOKsprpir16tFnyI5WvlTEOl6iX6YRTNlWF56fUD924i6Ug2w4YcVy5TdzWUNeXaJgEvRIYy4lwdsyEroTfwQ45O3OYo+a4zvMY5sRBT5GWCdBV0kkGjeWQG7O8PYPLJZyFmSxlNXC8LUrBcPhgvovZlyOXg41s+w9gM2CiykKz83ovEasWWJF9AkN5FmppIctFXEoW7HNCUGf3+JAt1+0Q5R1d/i4l7yHIGNctU5/+98rU+zC3FlW7drU4qK/w4f2dzT6A5NYaDbQ/+7oPYG4nGh9K+kwE7ZWUeu3OgEURc423W0tvcLh7iw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=MFrAspxP+4El5sWxFHEQ9Sov+BayPt8OsR1QraQ/OsA=;
 b=AAwmAl8c64sx52UcYU1YRwvH/ZSeIqW1o6vnQChnIQhXBQhxKBFGLMkTPWBpr5TKzj1iZwpvZ9sZESiD/RiW3IeCnoSrY7EquqDRoMWnpPeAW/HN8tzxUHcCAalczAGhm8RkTWDJ2cxAlL2HmuGxvgTFXwLlX6ZKyxkP0kRxMY8UwSYKp0Cs8qsHYcS/Uj3+bAIXv/nrcVQpuRhR1OU4TFZP6Izh4hRiwY4sK78aKmFW/tOHnBpdJjHSyrCo639WZw23g+iyrKUE/AEx9oitGmGoA/B3Cgf7h9UKghFImUv/6Ngf2URvufnx7Pcz2drl6qmC9xRtl+3uiwi4O2izrQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=vger.kernel.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=MFrAspxP+4El5sWxFHEQ9Sov+BayPt8OsR1QraQ/OsA=;
 b=ne54+u/uJneRRUPUdFEdxflod4h0WzEFKQr0AFcF981/MtopQe9/bqbKfOHSaZNvssu45rQABcnhYQ419ipo9GDP5NylgiqS+YwfDYTgF0sU9ak0/He6JKc0IM7Dy/mF2aWwxYHzA1J8w6BRymZp6UAXldVdJzhu+IFYkTCTEeo=
Received: from BN0PR03CA0046.namprd03.prod.outlook.com (2603:10b6:408:e7::21)
 by PH7PR12MB6907.namprd12.prod.outlook.com (2603:10b6:510:1b9::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.27; Thu, 16 May
 2024 08:12:30 +0000
Received: from BN2PEPF000044A9.namprd04.prod.outlook.com
 (2603:10b6:408:e7:cafe::7e) by BN0PR03CA0046.outlook.office365.com
 (2603:10b6:408:e7::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7587.25 via Frontend
 Transport; Thu, 16 May 2024 08:12:29 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB03.amd.com; pr=C
Received: from SATLEXMB03.amd.com (165.204.84.17) by
 BN2PEPF000044A9.mail.protection.outlook.com (10.167.243.103) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.7587.21 via Frontend Transport; Thu, 16 May 2024 08:12:29 +0000
Received: from SATLEXMB03.amd.com (10.181.40.144) by SATLEXMB03.amd.com
 (10.181.40.144) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.35; Thu, 16 May
 2024 03:12:28 -0500
Received: from xcbalucerop41x.xilinx.com (10.180.168.240) by
 SATLEXMB03.amd.com (10.181.40.144) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.35 via Frontend Transport; Thu, 16 May 2024 03:12:28 -0500
From: <alucerop@amd.com>
To: <linux-cxl@vger.kernel.org>, <dan.j.williams@intel.com>,
	<pieter.jansen-van-vuuren@amd.com>, <richard.hughes@amd.com>,
	<dinan.gunawardena@amd.com>
CC: Alejandro Lucero <alucerop@amd.com>
Subject: [RFC PATCH 12/13] cxl: preclude device memory to be used for dax
Date: Thu, 16 May 2024 09:12:01 +0100
Message-ID: <20240516081202.27023-13-alucerop@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20240516081202.27023-1-alucerop@amd.com>
References: <20240516081202.27023-1-alucerop@amd.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain
Received-SPF: None (SATLEXMB03.amd.com: alucerop@amd.com does not designate
 permitted sender hosts)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN2PEPF000044A9:EE_|PH7PR12MB6907:EE_
X-MS-Office365-Filtering-Correlation-Id: 77d4dac0-a24e-4b9c-5d18-08dc757fee53
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230031|82310400017|1800799015|36860700004|376005;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?CuoNLg1ySzUA/KVoo3RNMg7TRYKna7Otwb6EIBJ+YElfhEkNf1EBMtOA0T+i?=
 =?us-ascii?Q?UyMWyRhOZR/p7o9RNG/jDVj8Vw+/oNwCNyJnPRInYZworUM4gfNi0wMmFz0G?=
 =?us-ascii?Q?kPHREuKk8AykjLfC4wky6s95Tcm4ovcZnuxkiAIAak0mbrs5dCtliewEl9wy?=
 =?us-ascii?Q?9GX4a3imngRlnIk/2UeGh9SPWIJ3ynAhqRwgxu0viyb03yZOl8qtaQLm/6zG?=
 =?us-ascii?Q?YaUrrVyk9vfkD8ZssSUyOFUxRFKf0wpzXueHrRoIfIO3LT3mMPVI9QP8Hd5B?=
 =?us-ascii?Q?XW8h20rMkfCs5X3ZXmcUk6afQgHUd3InNNCyhNAABKBlXCYOlCVeEdYz7Fag?=
 =?us-ascii?Q?IFcmKxgEuwpoHjEWmhVljbY3c6WdSip/XZUfLs0oRzvDIx5Adlh32Lic94ND?=
 =?us-ascii?Q?T5q9ZMe03lsV8EehYmaypNbY73dgafY9aTt5q3Sr9sq9bPXmyr9AQanhoQNo?=
 =?us-ascii?Q?5CfhWHccH4iGkbG77LH1i5crCMkwCe1q2oNPDZvVqBkdNzStG7J+wVDdt7zK?=
 =?us-ascii?Q?LaOUnWQEFkdj4QrgBQhLK2d4zGuJXLKQr9TkaMtHQvYdKzImUamjWYBfsBnU?=
 =?us-ascii?Q?PBJZot9d4X1VsXy6hzoqE3DJtS2nJv6Wlm14TUKI8VdqBOmvO/MjndCijqzI?=
 =?us-ascii?Q?wnPzfIO1QAkTgzBehJTe4ea4h9cffWnQdtGLeWKY2S3G+pkMwFAcLmwA+Ac1?=
 =?us-ascii?Q?I4N+kCXzNMRIIF4DbuAOBNxRmKauWYvNUU8tTJhZW8Gjrii2aRY52FVvKfK/?=
 =?us-ascii?Q?UJgUc7sjJMKinf4mAs13zbuvpoelG0eQhbSv8DUW1fTFiDCY1174aww7x85n?=
 =?us-ascii?Q?ux78kig/2NzCmB8XZZ0Zx3L14PrWYP79Uu0g16P6bAfRZIGrzJQJiH2t8SYd?=
 =?us-ascii?Q?ALmzcd0ZlaFqxIRxaHXym9MPuKxvKPxGVVwiDZSrTWabQLTzJ3mPa3nIiIkx?=
 =?us-ascii?Q?l+EH0ky6zvFgmo53yRWD80lhNd5CYBMs6BDR9Pu0VUAZdqe8p1cqxOeq/SZs?=
 =?us-ascii?Q?cdbtsEcDl7UEISdi6gRgRS1zorq/aviwymslyfxmrEriuEGEHCRvtIT23q0H?=
 =?us-ascii?Q?fbFgFNNEQF+prqgh2FE4biwTbuNc64Cj+1KDfT7HrKcQvsrxhLCTbCfn8mmA?=
 =?us-ascii?Q?Q7FeTKF331uRUiB1I98/isnn0XTU8fZPd1yhjwfyofyL63Q29OrhX5dvnny0?=
 =?us-ascii?Q?GhPh+ig9B53MV8YbdmypNNMTfeVmjocwzLtrDoyl5Wb8uZqkgadk3XsvXRHS?=
 =?us-ascii?Q?RKGK1rgrRj9MTvKTdTS3KjvNIWlo6STauGz0ugIBSOmwV1nkhY3tCXhQR+EA?=
 =?us-ascii?Q?lDAbL8oSi6xrdpEHZlOHdAIt8r+aWTLIuSlJGoR8T/fv74ywwgH9BgGyEsaq?=
 =?us-ascii?Q?Au3ePLyyN4wxGoa1GfTNmLYZvPYe?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB03.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230031)(82310400017)(1800799015)(36860700004)(376005);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 May 2024 08:12:29.9036
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 77d4dac0-a24e-4b9c-5d18-08dc757fee53
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB03.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN2PEPF000044A9.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB6907

From: Alejandro Lucero <alucerop@amd.com>

By definition a type2 cxl device will use the host managed memory for
specific functionality, therefore it should not be available to other
uses.

Signed-off-by: Alejandro Lucero <alucerop@amd.com>
---
 drivers/cxl/core/region.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 014684ff4343..0716c2b8d456 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -3485,6 +3485,9 @@ static int cxl_region_probe(struct device *dev)
 	case CXL_DECODER_PMEM:
 		return devm_cxl_add_pmem_region(cxlr);
 	case CXL_DECODER_RAM:
+		if (cxlr->type != CXL_DECODER_HOSTONLYMEM)
+			return 0;
+
 		/*
 		 * The region can not be manged by CXL if any portion of
 		 * it is already online as 'System RAM'
-- 
2.17.1


