From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 74F83C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231774AbjBJJGQ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:16 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39100 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231779AbjBJJFv (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:05:51 -0500
Received: from mga18.intel.com (mga18.intel.com [134.134.136.126])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 31E845FF4;
        Fri, 10 Feb 2023 01:05:24 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019924; x=1707555924;
  h=subject:from:to:cc:date:message-id:mime-version:
   content-transfer-encoding;
  bh=aAOYbYjD+N5rIbj4yLf5cWdsbDyvwj1VTim/NDqe4VU=;
  b=N9M1/N0syUZ/ijR4s/xbctWiKVwo+n7kdFCbOnpUjIBF/4w56a8JTSWm
   DAEJStqukpqmNgtYP0sEavrb8qfNhN6KgvKdq+XbWoW24BaI3ZM7Fxuc8
   0JMjlcKjK3R7ip/jXub3mmbVHaRFXv9FZi3P36Eb83coLLAipn9RNupqp
   POHJ9ymBAUkdLpnXn7ZUa4qpLuAtDG8+ul1NdY4zAzRHlkomeqc7pS86T
   NplHb2P+8FAvVPL93lmuQMmPXHKbcixE+9ivk44kr2gT4jmOQCe1L5TzK
   qcGgPa355SH4ACyzngLr7WPVfJCpycDGXRIQjynqFtBdVZHcwkNVdREKN
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="314018672"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="314018672"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by orsmga106.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:22 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="736669673"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="736669673"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga004-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:22 -0800
Subject: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>,
        Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:21 -0800
Message-ID: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Changes since v1: [1]
- Add a fix for memdev removal racing port removal (found by unit tests)
- Add a fix to unwind region target list updates on error in
  cxl_region_attach() (Jonathan)
- Move the passthrough decoder fix for submission for v6.2-final (Greg)
- Fix wrong initcall for cxl_core (Gregory and Davidlohr)
- Add an endpoint decoder state (CXL_DECODER_STATE_AUTO) to replace
  the flag CXL_DECODER_F_AUTO (Jonathan)
- Reflow cmp_decode_pos() to reduce levels of indentation (Jonathan)
- Fix a leaked reference count in cxl_add_to_region() (Jonathan)
- Make cxl_add_to_region() return an error (Jonathan)
- Fix several spurious whitespace changes (Jonathan)
- Cleanup some spurious changes from the tools/testing/cxl update
  (Jonathan)
- Test for == CXL_CONFIG_COMMIT rather than >= CXL_CONFIG_COMMIT
  (Jonathan)
- Add comment to clarify device_attach() return code expectation in
  cxl_add_to_region() (Jonathan)
- Add a patch to split cxl_port_probe() into switch and endpoint port
  probe calls (Jonathan)
- Collect reviewed-by and tested-by tags

[1]: http://lore.kernel.org/r/167564534874.847146.5222419648551436750.stgit@dwillia2-xfh.jf.intel.com

---
Cover letter same as v1

Summary:
--------

CXL RAM support allows for the dynamic provisioning of new CXL RAM
regions, and more routinely, assembling a region from an existing
configuration established by platform-firmware. The latter is motivated
by CXL memory RAS (Reliability, Availability and Serviceability)
support, that requires associating device events with System Physical
Address ranges and vice versa.

The 'Soft Reserved' policy rework arranges for performance
differentiated memory like CXL attached DRAM, or high-bandwidth memory,
to be designated for 'System RAM' by default, rather than the device-dax
dedicated access mode. That current device-dax default is confusing and
surprising for the Pareto of users that do not expect memory to be
quarantined for dedicated access by default. Most users expect all
'System RAM'-capable memory to show up in FREE(1).


Details:
--------

Recall that the Linux 'Soft Reserved' designation for memory is a
reaction to platform-firmware, like EFI EDK2, delineating memory with
the EFI Specific Purpose Memory attribute (EFI_MEMORY_SP). An
alternative way to think of that attribute is that it specifies the
*not* general-purpose memory pool. It is memory that may be too precious
for general usage or not performant enough for some hot data structures.
However, in the absence of explicit policy it should just be 'System
RAM' by default.

Rather than require every distribution to ship a udev policy to assign
dax devices to dax_kmem (the device-memory hotplug driver) just make
that the kernel default. This is similar to the rationale in:

commit 8604d9e534a3 ("memory_hotplug: introduce CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE")

With this change the relatively niche use case of accessing this memory
via mapping a device-dax instance can be achieved by building with
CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=n, or specifying
memhp_default_state=offline at boot, and then use:

    daxctl reconfigure-device $device -m devdax --force

...to shift the corresponding address range to device-dax access.

The process of assembling a device-dax instance for a given CXL region
device configuration is similar to the process of assembling a
Device-Mapper or MDRAID storage-device array. Specifically, asynchronous
probing by the PCI and driver core enumerates all CXL endpoints and
their decoders. Then, once enough decoders have arrived to a describe a
given region, that region is passed to the device-dax subsystem where it
is subject to the above 'dax_kmem' policy. This assignment and policy
choice is only possible if memory is set aside by the 'Soft Reserved'
designation. Otherwise, CXL that is mapped as 'System RAM' becomes
immutable by CXL driver mechanisms, but is still enumerated for RAS
purposes.

This series is also available via:

https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=for-6.3/cxl-ram-region

...and has gone through some preview testing in various forms.

---

Dan Williams (20):
      cxl/memdev: Fix endpoint port removal
      cxl/Documentation: Update references to attributes added in v6.0
      cxl/region: Add a mode attribute for regions
      cxl/region: Support empty uuids for non-pmem regions
      cxl/region: Validate region mode vs decoder mode
      cxl/region: Add volatile region creation support
      cxl/region: Refactor attach_target() for autodiscovery
      cxl/region: Cleanup target list on attach error
      cxl/region: Move region-position validation to a helper
      kernel/range: Uplevel the cxl subsystem's range_contains() helper
      cxl/region: Enable CONFIG_CXL_REGION to be toggled
      cxl/port: Split endpoint and switch port probe
      cxl/region: Add region autodiscovery
      tools/testing/cxl: Define a fixed volatile configuration to parse
      dax/hmem: Move HMAT and Soft reservation probe initcall level
      dax/hmem: Drop unnecessary dax_hmem_remove()
      dax/hmem: Convey the dax range via memregion_info()
      dax/hmem: Move hmem device registration to dax_hmem.ko
      dax: Assign RAM regions to memory-hotplug by default
      cxl/dax: Create dax devices for CXL RAM regions


 Documentation/ABI/testing/sysfs-bus-cxl |   64 +-
 MAINTAINERS                             |    1 
 drivers/acpi/numa/hmat.c                |    4 
 drivers/cxl/Kconfig                     |   12 
 drivers/cxl/acpi.c                      |    3 
 drivers/cxl/core/core.h                 |    7 
 drivers/cxl/core/hdm.c                  |   25 +
 drivers/cxl/core/memdev.c               |    1 
 drivers/cxl/core/pci.c                  |    5 
 drivers/cxl/core/port.c                 |   92 ++-
 drivers/cxl/core/region.c               |  851 ++++++++++++++++++++++++++++---
 drivers/cxl/cxl.h                       |   57 ++
 drivers/cxl/cxlmem.h                    |    5 
 drivers/cxl/port.c                      |  113 +++-
 drivers/dax/Kconfig                     |   17 +
 drivers/dax/Makefile                    |    2 
 drivers/dax/bus.c                       |   53 +-
 drivers/dax/bus.h                       |   12 
 drivers/dax/cxl.c                       |   53 ++
 drivers/dax/device.c                    |    3 
 drivers/dax/hmem/Makefile               |    3 
 drivers/dax/hmem/device.c               |  102 ++--
 drivers/dax/hmem/hmem.c                 |  148 +++++
 drivers/dax/kmem.c                      |    1 
 include/linux/dax.h                     |    7 
 include/linux/memregion.h               |    2 
 include/linux/range.h                   |    5 
 lib/stackinit_kunit.c                   |    6 
 tools/testing/cxl/test/cxl.c            |  147 +++++
 29 files changed, 1484 insertions(+), 317 deletions(-)
 create mode 100644 drivers/dax/cxl.c

base-commit: 172738bbccdb4ef76bdd72fc72a315c741c39161

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2D345C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:27 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231883AbjBJJGZ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:25 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39168 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231219AbjBJJF6 (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:05:58 -0500
Received: from mga18.intel.com (mga18.intel.com [134.134.136.126])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 26F9163585;
        Fri, 10 Feb 2023 01:05:29 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019929; x=1707555929;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=0DbfECaRxiOQUgGeyWMl1ZfzEksrLbe++d0Gmjbv5io=;
  b=UWFGI2G9E/Z82lZhr7Rdg0UrxhlNk2JoBVMi1vRsNnewdRK/BOxv5zHW
   DuN1IqbcSl39gOrxmZpgHr4ByB8wKeYnMU3L9fM/oduvdUTpkV4CCE6pR
   HYo2r7+RFx9jER1h2ZE+TzFRBre9bAkPCVp9vtjby8t4z9pKIogAEECWm
   Qyyy1OB2CRYfLbppTO5/u19bojnddC6XuyNrioqpRly9p4ricwGhaUQu1
   zfS4B4/cFxVpJ4rC/d+F7M64NTQ5JHfBbfsQoMbcthXAUVx98RHewVcE+
   ql8SmJvE6LW8OKvgSxH7mEWBD54rIdkFgA77+/FQOPqccdbvU9nx5hOa9
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="314018692"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="314018692"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by orsmga106.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:28 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="736669726"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="736669726"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga004-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:28 -0800
Subject: [PATCH v2 01/20] cxl/memdev: Fix endpoint port removal
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: vishal.l.verma@intel.com, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:27 -0800
Message-ID: <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Testing of ram region support [1], stimulates a long standing bug in
cxl_detach_ep() where some cxl_ep_remove() cleanup is skipped due to
inability to walk ports after dports have been unregistered. That
results in a failure to re-register a memdev after the port is
re-enabled leading to a crash like the following:

    cxl_port_setup_targets: cxl region4: cxl_host_bridge.0:port4 iw: 1 ig: 256
    general protection fault, ...
    [..]
    RIP: 0010:cxl_region_setup_targets+0x897/0x9e0 [cxl_core]
    dev_name at include/linux/device.h:700
    (inlined by) cxl_port_setup_targets at drivers/cxl/core/region.c:1155
    (inlined by) cxl_region_setup_targets at drivers/cxl/core/region.c:1249
    [..]
    Call Trace:
     <TASK>
     attach_target+0x39a/0x760 [cxl_core]
     ? __mutex_unlock_slowpath+0x3a/0x290
     cxl_add_to_region+0xb8/0x340 [cxl_core]
     ? lockdep_hardirqs_on+0x7d/0x100
     discover_region+0x4b/0x80 [cxl_port]
     ? __pfx_discover_region+0x10/0x10 [cxl_port]
     device_for_each_child+0x58/0x90
     cxl_port_probe+0x10e/0x130 [cxl_port]
     cxl_bus_probe+0x17/0x50 [cxl_core]

Change the port ancestry walk to be by depth rather than by dport. This
ensures that even if a port has unregistered its dports a deferred
memdev cleanup will still be able to cleanup the memdev's interest in
that port.

The parent_port->dev.driver check is only needed for determining if the
bottom up removal beat the top-down removal, but cxl_ep_remove() can
always proceed.

Fixes: 2703c16c75ae ("cxl/core/port: Add switch port enumeration")
Link: http://lore.kernel.org/r/167564534874.847146.5222419648551436750.stgit@dwillia2-xfh.jf.intel.com [1]
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/memdev.c |    1 +
 drivers/cxl/core/port.c   |   58 +++++++++++++++++++++++++--------------------
 drivers/cxl/cxlmem.h      |    2 ++
 3 files changed, 35 insertions(+), 26 deletions(-)

diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
index a74a93310d26..3a8bc2b06047 100644
--- a/drivers/cxl/core/memdev.c
+++ b/drivers/cxl/core/memdev.c
@@ -246,6 +246,7 @@ static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
 	if (rc < 0)
 		goto err;
 	cxlmd->id = rc;
+	cxlmd->depth = -1;
 
 	dev = &cxlmd->dev;
 	device_initialize(dev);
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 410c036c09fa..317bcf4dbd9d 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -1207,6 +1207,7 @@ int cxl_endpoint_autoremove(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
 
 	get_device(&endpoint->dev);
 	dev_set_drvdata(dev, endpoint);
+	cxlmd->depth = endpoint->depth;
 	return devm_add_action_or_reset(dev, delete_endpoint, cxlmd);
 }
 EXPORT_SYMBOL_NS_GPL(cxl_endpoint_autoremove, CXL);
@@ -1241,50 +1242,55 @@ static void reap_dports(struct cxl_port *port)
 	}
 }
 
+struct detach_ctx {
+	struct cxl_memdev *cxlmd;
+	int depth;
+};
+
+static int port_has_memdev(struct device *dev, const void *data)
+{
+	const struct detach_ctx *ctx = data;
+	struct cxl_port *port;
+
+	if (!is_cxl_port(dev))
+		return 0;
+
+	port = to_cxl_port(dev);
+	if (port->depth != ctx->depth)
+		return 0;
+
+	return !!cxl_ep_load(port, ctx->cxlmd);
+}
+
 static void cxl_detach_ep(void *data)
 {
 	struct cxl_memdev *cxlmd = data;
-	struct device *iter;
 
-	for (iter = &cxlmd->dev; iter; iter = grandparent(iter)) {
-		struct device *dport_dev = grandparent(iter);
+	for (int i = cxlmd->depth - 1; i >= 1; i--) {
 		struct cxl_port *port, *parent_port;
+		struct detach_ctx ctx = {
+			.cxlmd = cxlmd,
+			.depth = i,
+		};
+		struct device *dev;
 		struct cxl_ep *ep;
 		bool died = false;
 
-		if (!dport_dev)
-			break;
-
-		port = find_cxl_port(dport_dev, NULL);
-		if (!port)
-			continue;
-
-		if (is_cxl_root(port)) {
-			put_device(&port->dev);
+		dev = bus_find_device(&cxl_bus_type, NULL, &ctx,
+				      port_has_memdev);
+		if (!dev)
 			continue;
-		}
+		port = to_cxl_port(dev);
 
 		parent_port = to_cxl_port(port->dev.parent);
 		device_lock(&parent_port->dev);
-		if (!parent_port->dev.driver) {
-			/*
-			 * The bottom-up race to delete the port lost to a
-			 * top-down port disable, give up here, because the
-			 * parent_port ->remove() will have cleaned up all
-			 * descendants.
-			 */
-			device_unlock(&parent_port->dev);
-			put_device(&port->dev);
-			continue;
-		}
-
 		device_lock(&port->dev);
 		ep = cxl_ep_load(port, cxlmd);
 		dev_dbg(&cxlmd->dev, "disconnect %s from %s\n",
 			ep ? dev_name(ep->ep) : "", dev_name(&port->dev));
 		cxl_ep_remove(port, ep);
 		if (ep && !port->dead && xa_empty(&port->endpoints) &&
-		    !is_cxl_root(parent_port)) {
+		    !is_cxl_root(parent_port) && parent_port->dev.driver) {
 			/*
 			 * This was the last ep attached to a dynamically
 			 * enumerated port. Block new cxl_add_ep() and garbage
diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
index ab138004f644..c9da3c699a21 100644
--- a/drivers/cxl/cxlmem.h
+++ b/drivers/cxl/cxlmem.h
@@ -38,6 +38,7 @@
  * @cxl_nvb: coordinate removal of @cxl_nvd if present
  * @cxl_nvd: optional bridge to an nvdimm if the device supports pmem
  * @id: id number of this memdev instance.
+ * @depth: endpoint port depth
  */
 struct cxl_memdev {
 	struct device dev;
@@ -47,6 +48,7 @@ struct cxl_memdev {
 	struct cxl_nvdimm_bridge *cxl_nvb;
 	struct cxl_nvdimm *cxl_nvd;
 	int id;
+	int depth;
 };
 
 static inline struct cxl_memdev *to_cxl_memdev(struct device *dev)


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 31425C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:36 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231877AbjBJJGf (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:35 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39236 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231880AbjBJJGD (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:03 -0500
Received: from mga09.intel.com (mga09.intel.com [134.134.136.24])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BBC391C5B2;
        Fri, 10 Feb 2023 01:05:34 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019934; x=1707555934;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=M9WD4tNW7gQKGRRkfXq/VM0O9cOu0NWS0bJh4WHOXA8=;
  b=S7k9NyP82e1i0I7etgt0z10qYR/eWKFk3yomQcJarzvPZXpnnBvGNzdK
   9myJi9aohZJgVgoB/5xpf2Us49pVSc+aBhLCUIr3cCqOaHFgwKqoKY7AZ
   OHLm3cFtxXP/UVRAr98U8PkY9PjUxHllGHUn/ntJHVwfIwUDPWSwDRij9
   +VnlBU78DDGeZMnADs4JEV3LRjZENkSwVGeLxlvFUWUP6XyUJZDU7/+jF
   11rJjZ1YRVoRIWkpjykDwVlexh38YgiZL7zs8Hay7tUqeQ0CYi4WH+v95
   Qr7vubIii675dYsQmWTjyWlVsm1ZP/ngg3NorHCHcamet3UBWx3yKWaml
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="331677022"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="331677022"
Received: from orsmga008.jf.intel.com ([10.7.209.65])
  by orsmga102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:34 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="698364539"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="698364539"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga008-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:33 -0800
Subject: [PATCH v2 02/20] cxl/Documentation: Update references to attributes
 added in v6.0
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Ira Weiny <ira.weiny@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:33 -0800
Message-ID: <167601993360.1924368.14122892663883462813.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Prior to Linus deciding that the kernel that following v5.19 would be
v6.0, the CXL ABI documentation already referenced v5.20. In preparation
for updating these entries update the kernel version to v6.0.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Reviewed-by: Davidlohr Bueso <dave@stgolabs.net>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564535494.847146.12120939572640882946.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 Documentation/ABI/testing/sysfs-bus-cxl |   30 +++++++++++++++---------------
 1 file changed, 15 insertions(+), 15 deletions(-)

diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
index 329a7e46c805..5be032313e29 100644
--- a/Documentation/ABI/testing/sysfs-bus-cxl
+++ b/Documentation/ABI/testing/sysfs-bus-cxl
@@ -198,7 +198,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/endpointX/CDAT
 Date:		July, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RO) If this sysfs entry is not present no DOE mailbox was
@@ -209,7 +209,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/mode
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) When a CXL decoder is of devtype "cxl_decoder_endpoint" it
@@ -229,7 +229,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/dpa_resource
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RO) When a CXL decoder is of devtype "cxl_decoder_endpoint",
@@ -240,7 +240,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/dpa_size
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) When a CXL decoder is of devtype "cxl_decoder_endpoint" it
@@ -260,7 +260,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/interleave_ways
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RO) The number of targets across which this decoder's host
@@ -275,7 +275,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/interleave_granularity
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RO) The number of consecutive bytes of host physical address
@@ -287,7 +287,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/create_pmem_region
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write a string in the form 'regionZ' to start the process
@@ -303,7 +303,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/decoderX.Y/delete_region
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(WO) Write a string in the form 'regionZ' to delete that region,
@@ -312,7 +312,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/uuid
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write a unique identifier for the region. This field must
@@ -322,7 +322,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/interleave_granularity
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Set the number of consecutive bytes each device in the
@@ -333,7 +333,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/interleave_ways
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Configures the number of devices participating in the
@@ -343,7 +343,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/size
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) System physical address space to be consumed by the region.
@@ -360,7 +360,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/resource
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RO) A region is a contiguous partition of a CXL root decoder
@@ -372,7 +372,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/target[0..N]
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write an endpoint decoder object name to 'targetX' where X
@@ -391,7 +391,7 @@ Description:
 
 What:		/sys/bus/cxl/devices/regionZ/commit
 Date:		May, 2022
-KernelVersion:	v5.20
+KernelVersion:	v6.0
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write a boolean 'true' string value to this attribute to


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3B21DC636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:42 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231715AbjBJJGl (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:41 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39268 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231708AbjBJJGI (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:08 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 308035A906;
        Fri, 10 Feb 2023 01:05:41 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019941; x=1707555941;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=3cQC8uwKOt3b1h6vNcSkmE8AzC7Sg9UhcvwbHDHzsBA=;
  b=dY/wlWSPmqvnTVPn7s/3qREwEx3YcYYzDVwHE6TNGzIE8v9Cm9WS5Epl
   F6E40ntp6WfjaQw+FWvh4vJX3tYQTjSUYCZ/Yy1i9+/5gqvFJaJD36j/K
   bjj85s5GQ3LHx3rtnqrYqx96jhlk+rXu0pCkdm/IOZ/RmMUEARlteshan
   ofcZbgNAQxp2UIx3ZK2U5rqrYoozTIXtHCoEKPHpvLBcN7hUaTv2aDm3Y
   VSxpsmEllWcNhnAXW2+IsHpBsJhrUpkO7i8vg/0vqL8fUSYerUVul1wY0
   VC7DiWs0l3l/pqryeqcwMMW0aPdu3hv7Lw65eiTQ7GLADX+DPjfHPGswP
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="416599982"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="416599982"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:40 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="669930135"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="669930135"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga007-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:39 -0800
Subject: [PATCH v2 03/20] cxl/region: Add a mode attribute for regions
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Ira Weiny <ira.weiny@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:39 -0800
Message-ID: <167601993930.1924368.4305018565539515665.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for a new region type, "ram" regions, add a mode
attribute to clarify the mode of the decoders that can be added to a
region. Share the internals of mode_show() (for decoders) with the
region case.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564536041.847146.11330354943211409793.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 Documentation/ABI/testing/sysfs-bus-cxl |   11 +++++++++++
 drivers/cxl/core/port.c                 |   12 +-----------
 drivers/cxl/core/region.c               |   10 ++++++++++
 drivers/cxl/cxl.h                       |   14 ++++++++++++++
 4 files changed, 36 insertions(+), 11 deletions(-)

diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
index 5be032313e29..058b0c45001f 100644
--- a/Documentation/ABI/testing/sysfs-bus-cxl
+++ b/Documentation/ABI/testing/sysfs-bus-cxl
@@ -358,6 +358,17 @@ Description:
 		results in the same address being allocated.
 
 
+What:		/sys/bus/cxl/devices/regionZ/mode
+Date:		January, 2023
+KernelVersion:	v6.3
+Contact:	linux-cxl@vger.kernel.org
+Description:
+		(RO) The mode of a region is established at region creation time
+		and dictates the mode of the endpoint decoder that comprise the
+		region. For more details on the possible modes see
+		/sys/bus/cxl/devices/decoderX.Y/mode
+
+
 What:		/sys/bus/cxl/devices/regionZ/resource
 Date:		May, 2022
 KernelVersion:	v6.0
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 317bcf4dbd9d..1e541956f605 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -180,17 +180,7 @@ static ssize_t mode_show(struct device *dev, struct device_attribute *attr,
 {
 	struct cxl_endpoint_decoder *cxled = to_cxl_endpoint_decoder(dev);
 
-	switch (cxled->mode) {
-	case CXL_DECODER_RAM:
-		return sysfs_emit(buf, "ram\n");
-	case CXL_DECODER_PMEM:
-		return sysfs_emit(buf, "pmem\n");
-	case CXL_DECODER_NONE:
-		return sysfs_emit(buf, "none\n");
-	case CXL_DECODER_MIXED:
-	default:
-		return sysfs_emit(buf, "mixed\n");
-	}
+	return sysfs_emit(buf, "%s\n", cxl_decoder_mode_name(cxled->mode));
 }
 
 static ssize_t mode_store(struct device *dev, struct device_attribute *attr,
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 60828d01972a..17d2d0c12725 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -458,6 +458,15 @@ static ssize_t resource_show(struct device *dev, struct device_attribute *attr,
 }
 static DEVICE_ATTR_RO(resource);
 
+static ssize_t mode_show(struct device *dev, struct device_attribute *attr,
+			 char *buf)
+{
+	struct cxl_region *cxlr = to_cxl_region(dev);
+
+	return sysfs_emit(buf, "%s\n", cxl_decoder_mode_name(cxlr->mode));
+}
+static DEVICE_ATTR_RO(mode);
+
 static int alloc_hpa(struct cxl_region *cxlr, resource_size_t size)
 {
 	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
@@ -585,6 +594,7 @@ static struct attribute *cxl_region_attrs[] = {
 	&dev_attr_interleave_granularity.attr,
 	&dev_attr_resource.attr,
 	&dev_attr_size.attr,
+	&dev_attr_mode.attr,
 	NULL,
 };
 
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index aa3af3bb73b2..ca76879af1de 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -320,6 +320,20 @@ enum cxl_decoder_mode {
 	CXL_DECODER_DEAD,
 };
 
+static inline const char *cxl_decoder_mode_name(enum cxl_decoder_mode mode)
+{
+	static const char * const names[] = {
+		[CXL_DECODER_NONE] = "none",
+		[CXL_DECODER_RAM] = "ram",
+		[CXL_DECODER_PMEM] = "pmem",
+		[CXL_DECODER_MIXED] = "mixed",
+	};
+
+	if (mode >= CXL_DECODER_NONE && mode <= CXL_DECODER_MIXED)
+		return names[mode];
+	return "mixed";
+}
+
 /**
  * struct cxl_endpoint_decoder - Endpoint  / SPA to DPA decoder
  * @cxld: base cxl_decoder_object


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 09D4FC05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231726AbjBJJGv (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:51 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39894 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231735AbjBJJGL (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:11 -0500
Received: from mga09.intel.com (mga09.intel.com [134.134.136.24])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 25D96635B6;
        Fri, 10 Feb 2023 01:05:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019947; x=1707555947;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=8rEeQZ+8vrd28/mihuN4IYSQYwRcfCWFNTCZHITf2LM=;
  b=i5B0I8eyEIDoGagokInkwn0BdPZtLE36BYpumMl6Kvrr0Cn+KN5I7mhL
   uWHWJriKPE17kWR3v8LdZWjhRVmldpErAlyljvwgraZfqTUMzXWkTz497
   U5ehOXzyrzN9KpGBjqoaxe2t62EcUBVjN0/1Z0HH1uSbN6S8gGxf4GOYK
   fvJ+HZ4Tgibt5pA8Rx3TKa12ukdJDCHybGRTdU6+W2x2fL3me1TOn+7Ug
   Du34dRfmdGTwYzwhkmu4cmy+9I4Qo+573vT5StJWr/YZE09n5c4Se1sfe
   MXormz8SAeyxFCuaYJcb/6/tN96qDQotkDg8lXPO/oDs1FQj4grZjtKQZ
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="331677059"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="331677059"
Received: from orsmga008.jf.intel.com ([10.7.209.65])
  by orsmga102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:46 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="698364566"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="698364566"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga008-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:45 -0800
Subject: [PATCH v2 04/20] cxl/region: Support empty uuids for non-pmem
 regions
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:45 -0800
Message-ID: <167601994558.1924368.12612811533724694444.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Shipping versions of the cxl-cli utility expect all regions to have a
'uuid' attribute. In preparation for 'ram' regions, update the 'uuid'
attribute to return an empty string which satisfies the current
expectations of 'cxl list -R'. Otherwise, 'cxl list -R' fails in the
presence of regions with the 'uuid' attribute missing. Force the
attribute to be read-only as there is no facility or expectation for a
'ram' region to recall its uuid from one boot to the next.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564536587.847146.12703125206459604597.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 Documentation/ABI/testing/sysfs-bus-cxl |    3 ++-
 drivers/cxl/core/region.c               |   11 +++++++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
index 058b0c45001f..4c4e1cbb1169 100644
--- a/Documentation/ABI/testing/sysfs-bus-cxl
+++ b/Documentation/ABI/testing/sysfs-bus-cxl
@@ -317,7 +317,8 @@ Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write a unique identifier for the region. This field must
 		be set for persistent regions and it must not conflict with the
-		UUID of another region.
+		UUID of another region. For volatile ram regions this
+		attribute is a read-only empty string.
 
 
 What:		/sys/bus/cxl/devices/regionZ/interleave_granularity
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 17d2d0c12725..0fc80478ff6b 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -45,7 +45,10 @@ static ssize_t uuid_show(struct device *dev, struct device_attribute *attr,
 	rc = down_read_interruptible(&cxl_region_rwsem);
 	if (rc)
 		return rc;
-	rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
+	if (cxlr->mode != CXL_DECODER_PMEM)
+		rc = sysfs_emit(buf, "\n");
+	else
+		rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
 	up_read(&cxl_region_rwsem);
 
 	return rc;
@@ -300,8 +303,12 @@ static umode_t cxl_region_visible(struct kobject *kobj, struct attribute *a,
 	struct device *dev = kobj_to_dev(kobj);
 	struct cxl_region *cxlr = to_cxl_region(dev);
 
+	/*
+	 * Support tooling that expects to find a 'uuid' attribute for all
+	 * regions regardless of mode.
+	 */
 	if (a == &dev_attr_uuid.attr && cxlr->mode != CXL_DECODER_PMEM)
-		return 0;
+		return 0444;
 	return a->mode;
 }
 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 88302C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:06:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231750AbjBJJGx (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:06:53 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39072 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231409AbjBJJGN (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:13 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 718A937713;
        Fri, 10 Feb 2023 01:05:53 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019953; x=1707555953;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=pOZoUMpBUKRLc8QIK289XEjoJsII4YkEt62Y5Arb8us=;
  b=ayHpBr5/S6SDefaGkDCl7ygH5IL2FZiTFvGE10pqlIFkSkwkhO1yTxIT
   Djues1HUKDGuS4yUcY2a/c2YKKMQo9FAdgqODujZkzm9Jkrx1UOzYsdsK
   Aw8yygItcbcW4rQx9Iv1ZfejyYcZTjmh3u3SIS2IbM3lhUsHtNW+2ZArA
   mXwT4qGfqiyFDBi75NgPWBSZ7FiP9f+tGw+/9/eNghQeKeyVlrHjJn5e3
   ZBvJwTfA6fwGiN7nNmdVmHfjFno7GaIc6vbhBbhdX9R6qvfGLbifUh99Y
   96veemMbkvk66OfAN+62RsVVUClh9JynZG4dj2WJ79kVG5SygvNvQV1Rs
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="416600012"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="416600012"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:53 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="669930208"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="669930208"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga007-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:51 -0800
Subject: [PATCH v2 05/20] cxl/region: Validate region mode vs decoder mode
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Ira Weiny <ira.weiny@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:51 -0800
Message-ID: <167601995111.1924368.7459128614177994602.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for a new region mode, do not, for example, allow
'ram' decoders to be assigned to 'pmem' regions and vice versa.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564537131.847146.9020072654741860107.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c |    6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 0fc80478ff6b..285835145e9b 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -1221,6 +1221,12 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 	struct cxl_dport *dport;
 	int i, rc = -ENXIO;
 
+	if (cxled->mode != cxlr->mode) {
+		dev_dbg(&cxlr->dev, "%s region mode: %d mismatch: %d\n",
+			dev_name(&cxled->cxld.dev), cxlr->mode, cxled->mode);
+		return -EINVAL;
+	}
+
 	if (cxled->mode == CXL_DECODER_DEAD) {
 		dev_dbg(&cxlr->dev, "%s dead\n", dev_name(&cxled->cxld.dev));
 		return -ENODEV;


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4E655C636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231834AbjBJJHW (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:22 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39706 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231567AbjBJJGd (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:33 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6DA3737735;
        Fri, 10 Feb 2023 01:06:12 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019972; x=1707555972;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=g9WOYiZgLx/JR1gosHNg5WOS/EaNuj1iypU5OOVGJsQ=;
  b=RFpgGd9JWcFKMfIILq03l6Y1R+rtcgNR5GJ5C2l5CKVe3TjGhwIhaxfs
   dlmseyPL7DcVP0WUU0BTnlTvkP/bgHhTWpttKG0Eih4i+GngKXpqJnmmq
   vIS/UMB+/zWHyBsQExIzMBsCVWylt6WrARpTyzSIQ6ptdb0EEuuMekIyS
   2HYPKuHhm6szX/H8cVWKki874swISFRGMsWF6ZHbsKxngzwRE7EV2k8ZV
   fa7AQbMVCEvxoRNY3AGxcCY0IB2S/wOcToJiXFLyYMoEv5XjlnNXlBL+w
   SWSiywUwYoYRkKP4/8FlkkmqFoSdyIv5oO9Z6HzzsJsltX0KMlvVWmpxP
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="416600025"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="416600025"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:58 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="669930220"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="669930220"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga007-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:05:58 -0800
Subject: [PATCH v2 06/20] cxl/region: Add volatile region creation support
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Ira Weiny <ira.weiny@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:05:57 -0800
Message-ID: <167601995775.1924368.352616146815830591.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Expand the region creation infrastructure to enable 'ram'
(volatile-memory) regions. The internals of create_pmem_region_store()
and create_pmem_region_show() are factored out into helpers
__create_region() and __create_region_show() for the 'ram' case to
reuse.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564537678.847146.4066579806086171091.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 Documentation/ABI/testing/sysfs-bus-cxl |   22 +++++-----
 drivers/cxl/core/core.h                 |    1 
 drivers/cxl/core/port.c                 |   14 ++++++
 drivers/cxl/core/region.c               |   71 +++++++++++++++++++++++++------
 4 files changed, 83 insertions(+), 25 deletions(-)

diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
index 4c4e1cbb1169..3acf2f17a73f 100644
--- a/Documentation/ABI/testing/sysfs-bus-cxl
+++ b/Documentation/ABI/testing/sysfs-bus-cxl
@@ -285,20 +285,20 @@ Description:
 		interleave_granularity).
 
 
-What:		/sys/bus/cxl/devices/decoderX.Y/create_pmem_region
-Date:		May, 2022
-KernelVersion:	v6.0
+What:		/sys/bus/cxl/devices/decoderX.Y/create_{pmem,ram}_region
+Date:		May, 2022, January, 2023
+KernelVersion:	v6.0 (pmem), v6.3 (ram)
 Contact:	linux-cxl@vger.kernel.org
 Description:
 		(RW) Write a string in the form 'regionZ' to start the process
-		of defining a new persistent memory region (interleave-set)
-		within the decode range bounded by root decoder 'decoderX.Y'.
-		The value written must match the current value returned from
-		reading this attribute. An atomic compare exchange operation is
-		done on write to assign the requested id to a region and
-		allocate the region-id for the next creation attempt. EBUSY is
-		returned if the region name written does not match the current
-		cached value.
+		of defining a new persistent, or volatile memory region
+		(interleave-set) within the decode range bounded by root decoder
+		'decoderX.Y'. The value written must match the current value
+		returned from reading this attribute. An atomic compare exchange
+		operation is done on write to assign the requested id to a
+		region and allocate the region-id for the next creation attempt.
+		EBUSY is returned if the region name written does not match the
+		current cached value.
 
 
 What:		/sys/bus/cxl/devices/decoderX.Y/delete_region
diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index 8c04672dca56..5eb873da5a30 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -11,6 +11,7 @@ extern struct attribute_group cxl_base_attribute_group;
 
 #ifdef CONFIG_CXL_REGION
 extern struct device_attribute dev_attr_create_pmem_region;
+extern struct device_attribute dev_attr_create_ram_region;
 extern struct device_attribute dev_attr_delete_region;
 extern struct device_attribute dev_attr_region;
 extern const struct device_type cxl_pmem_region_type;
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 1e541956f605..9e5df64ea6b5 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -294,6 +294,7 @@ static struct attribute *cxl_decoder_root_attrs[] = {
 	&dev_attr_cap_type3.attr,
 	&dev_attr_target_list.attr,
 	SET_CXL_REGION_ATTR(create_pmem_region)
+	SET_CXL_REGION_ATTR(create_ram_region)
 	SET_CXL_REGION_ATTR(delete_region)
 	NULL,
 };
@@ -305,6 +306,13 @@ static bool can_create_pmem(struct cxl_root_decoder *cxlrd)
 	return (cxlrd->cxlsd.cxld.flags & flags) == flags;
 }
 
+static bool can_create_ram(struct cxl_root_decoder *cxlrd)
+{
+	unsigned long flags = CXL_DECODER_F_TYPE3 | CXL_DECODER_F_RAM;
+
+	return (cxlrd->cxlsd.cxld.flags & flags) == flags;
+}
+
 static umode_t cxl_root_decoder_visible(struct kobject *kobj, struct attribute *a, int n)
 {
 	struct device *dev = kobj_to_dev(kobj);
@@ -313,7 +321,11 @@ static umode_t cxl_root_decoder_visible(struct kobject *kobj, struct attribute *
 	if (a == CXL_REGION_ATTR(create_pmem_region) && !can_create_pmem(cxlrd))
 		return 0;
 
-	if (a == CXL_REGION_ATTR(delete_region) && !can_create_pmem(cxlrd))
+	if (a == CXL_REGION_ATTR(create_ram_region) && !can_create_ram(cxlrd))
+		return 0;
+
+	if (a == CXL_REGION_ATTR(delete_region) &&
+	    !(can_create_pmem(cxlrd) || can_create_ram(cxlrd)))
 		return 0;
 
 	return a->mode;
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 285835145e9b..e440db8611a4 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -1689,6 +1689,15 @@ static struct cxl_region *devm_cxl_add_region(struct cxl_root_decoder *cxlrd,
 	struct device *dev;
 	int rc;
 
+	switch (mode) {
+	case CXL_DECODER_RAM:
+	case CXL_DECODER_PMEM:
+		break;
+	default:
+		dev_err(&cxlrd->cxlsd.cxld.dev, "unsupported mode %d\n", mode);
+		return ERR_PTR(-EINVAL);
+	}
+
 	cxlr = cxl_region_alloc(cxlrd, id);
 	if (IS_ERR(cxlr))
 		return cxlr;
@@ -1717,12 +1726,38 @@ static struct cxl_region *devm_cxl_add_region(struct cxl_root_decoder *cxlrd,
 	return ERR_PTR(rc);
 }
 
+static ssize_t __create_region_show(struct cxl_root_decoder *cxlrd, char *buf)
+{
+	return sysfs_emit(buf, "region%u\n", atomic_read(&cxlrd->region_id));
+}
+
 static ssize_t create_pmem_region_show(struct device *dev,
 				       struct device_attribute *attr, char *buf)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev);
+	return __create_region_show(to_cxl_root_decoder(dev), buf);
+}
 
-	return sysfs_emit(buf, "region%u\n", atomic_read(&cxlrd->region_id));
+static ssize_t create_ram_region_show(struct device *dev,
+				      struct device_attribute *attr, char *buf)
+{
+	return __create_region_show(to_cxl_root_decoder(dev), buf);
+}
+
+static struct cxl_region *__create_region(struct cxl_root_decoder *cxlrd,
+					  enum cxl_decoder_mode mode, int id)
+{
+	int rc;
+
+	rc = memregion_alloc(GFP_KERNEL);
+	if (rc < 0)
+		return ERR_PTR(rc);
+
+	if (atomic_cmpxchg(&cxlrd->region_id, id, rc) != id) {
+		memregion_free(rc);
+		return ERR_PTR(-EBUSY);
+	}
+
+	return devm_cxl_add_region(cxlrd, id, mode, CXL_DECODER_EXPANDER);
 }
 
 static ssize_t create_pmem_region_store(struct device *dev,
@@ -1731,29 +1766,39 @@ static ssize_t create_pmem_region_store(struct device *dev,
 {
 	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev);
 	struct cxl_region *cxlr;
-	int id, rc;
+	int rc, id;
 
 	rc = sscanf(buf, "region%d\n", &id);
 	if (rc != 1)
 		return -EINVAL;
 
-	rc = memregion_alloc(GFP_KERNEL);
-	if (rc < 0)
-		return rc;
+	cxlr = __create_region(cxlrd, CXL_DECODER_PMEM, id);
+	if (IS_ERR(cxlr))
+		return PTR_ERR(cxlr);
 
-	if (atomic_cmpxchg(&cxlrd->region_id, id, rc) != id) {
-		memregion_free(rc);
-		return -EBUSY;
-	}
+	return len;
+}
+DEVICE_ATTR_RW(create_pmem_region);
+
+static ssize_t create_ram_region_store(struct device *dev,
+				       struct device_attribute *attr,
+				       const char *buf, size_t len)
+{
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(dev);
+	struct cxl_region *cxlr;
+	int rc, id;
 
-	cxlr = devm_cxl_add_region(cxlrd, id, CXL_DECODER_PMEM,
-				   CXL_DECODER_EXPANDER);
+	rc = sscanf(buf, "region%d\n", &id);
+	if (rc != 1)
+		return -EINVAL;
+
+	cxlr = __create_region(cxlrd, CXL_DECODER_RAM, id);
 	if (IS_ERR(cxlr))
 		return PTR_ERR(cxlr);
 
 	return len;
 }
-DEVICE_ATTR_RW(create_pmem_region);
+DEVICE_ATTR_RW(create_ram_region);
 
 static ssize_t region_show(struct device *dev, struct device_attribute *attr,
 			   char *buf)


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 06FA0C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231843AbjBJJHX (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:23 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39230 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231500AbjBJJGe (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:34 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0091C2313F;
        Fri, 10 Feb 2023 01:06:13 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019974; x=1707555974;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=s+JhIpX+g9sjvv5ZiADOIwQseU67ppQ0dtunIobOaPU=;
  b=FoSVZzCpEuK93BjViEPsgOsWDT/V0KFsVcwyCVR6CBKAMDaTxb+C/h7a
   gZ0S78N3FUi59hasDyfFVACMrsfnkwDsh73jTTmKZRgmD9Dkjx4OHExop
   gSR57dlpmyHSy2BOcUz/NGxK7emo4RrAKaUNttBkIv+XJ2dxs78lWMmHG
   f05pycl7xkdf4l5ldFoxBq9TKIy5NZVffpioCmLywXS2U7C4J66+OCVUD
   7eW0paqHmG2DX76EckYUVhfICaB8+wDNcAY/Ac8AKmx5ND3U8MOxB10BS
   8v40f6XJ2NiL5f3PkuHxIkVHO6k521ZY4OG/GNbouBHuxWUVbhAnp4AIp
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="416600040"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="416600040"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:04 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="669930234"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="669930234"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga007-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:04 -0800
Subject: [PATCH v2 07/20] cxl/region: Refactor attach_target() for
 autodiscovery
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Ira Weiny <ira.weiny@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:04 -0800
Message-ID: <167601996393.1924368.2202255054618600069.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Region autodiscovery is the process of kernel creating 'struct
cxl_region' object to represent active CXL memory ranges it finds
already active in hardware when the driver loads. Typically this happens
when platform firmware establishes CXL memory regions and then publishes
them in the memory map. However, this can also happen in the case of
kexec-reboot after the kernel has created regions.

In the autodiscovery case the region creation process starts with a
known endpoint decoder. Refactor attach_target() into a helper that is
suitable to be called from either sysfs, for runtime region creation, or
from cxl_port_probe() after it has enumerated all endpoint decoders.

The cxl_port_probe() context is an async device-core probing context, so
it is not appropriate to allow SIGTERM to interrupt the assembly
process. Refactor attach_target() to take @cxled and @state as arguments
where @state indicates whether waiting from the region rwsem is
interruptible or not.

No behavior change is intended.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564538227.847146.16305045998592488364.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c |   47 +++++++++++++++++++++++++++------------------
 1 file changed, 28 insertions(+), 19 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index e440db8611a4..040bbd39c81d 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -1422,31 +1422,25 @@ void cxl_decoder_kill_region(struct cxl_endpoint_decoder *cxled)
 	up_write(&cxl_region_rwsem);
 }
 
-static int attach_target(struct cxl_region *cxlr, const char *decoder, int pos)
+static int attach_target(struct cxl_region *cxlr,
+			 struct cxl_endpoint_decoder *cxled, int pos,
+			 unsigned int state)
 {
-	struct device *dev;
-	int rc;
-
-	dev = bus_find_device_by_name(&cxl_bus_type, NULL, decoder);
-	if (!dev)
-		return -ENODEV;
-
-	if (!is_endpoint_decoder(dev)) {
-		put_device(dev);
-		return -EINVAL;
-	}
+	int rc = 0;
 
-	rc = down_write_killable(&cxl_region_rwsem);
+	if (state == TASK_INTERRUPTIBLE)
+		rc = down_write_killable(&cxl_region_rwsem);
+	else
+		down_write(&cxl_region_rwsem);
 	if (rc)
-		goto out;
+		return rc;
+
 	down_read(&cxl_dpa_rwsem);
-	rc = cxl_region_attach(cxlr, to_cxl_endpoint_decoder(dev), pos);
+	rc = cxl_region_attach(cxlr, cxled, pos);
 	if (rc == 0)
 		set_bit(CXL_REGION_F_INCOHERENT, &cxlr->flags);
 	up_read(&cxl_dpa_rwsem);
 	up_write(&cxl_region_rwsem);
-out:
-	put_device(dev);
 	return rc;
 }
 
@@ -1484,8 +1478,23 @@ static size_t store_targetN(struct cxl_region *cxlr, const char *buf, int pos,
 
 	if (sysfs_streq(buf, "\n"))
 		rc = detach_target(cxlr, pos);
-	else
-		rc = attach_target(cxlr, buf, pos);
+	else {
+		struct device *dev;
+
+		dev = bus_find_device_by_name(&cxl_bus_type, NULL, buf);
+		if (!dev)
+			return -ENODEV;
+
+		if (!is_endpoint_decoder(dev)) {
+			rc = -EINVAL;
+			goto out;
+		}
+
+		rc = attach_target(cxlr, to_cxl_endpoint_decoder(dev), pos,
+				   TASK_INTERRUPTIBLE);
+out:
+		put_device(dev);
+	}
 
 	if (rc < 0)
 		return rc;


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B63F2C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:33 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231701AbjBJJHc (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:32 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39820 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231476AbjBJJGj (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:39 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 26A5F2313C;
        Fri, 10 Feb 2023 01:06:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019977; x=1707555977;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=tyAA/0gIK0IYL4MQ6rj9f+aiydACvqCY4T+pqHWSbEY=;
  b=bKTN36axc+rzMWvS/i4F0FV/dF+4f2EdC0pT+uxCXFGpEXqbDFCSOKwI
   B6dZxVHaHIL/poGlDc0bif1Bw0vykKcIOU+3G4PvQ47KNVnMutsXqQZO0
   IZlVPzT5G+Ex2eg3+pSGF1JV2XHPPtJ4Lx5QCPcYQXediwK8JpBNX79rw
   Mcae5TGNS+7E53StpzOAkB1vGwtjwd1dOQ/lJGCwC7uDz1DoIjaUQXRdj
   zmsYog7725RSKassZHzRdIrhsll2CmdD4YGMAPEXeyx6A12iJbBFwS3N+
   1OC+vnHT1Fvk/47e8jSiBQH7n5xoy3NtQf1dD9lk37pnmAqeUXWg8ubDd
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329003041"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="329003041"
Received: from fmsmga006.fm.intel.com ([10.253.24.20])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:16 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="913463794"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="913463794"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga006-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:16 -0800
Subject: [PATCH v2 09/20] cxl/region: Move region-position validation to a
 helper
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:15 -0800
Message-ID: <167601997584.1924368.4615769326126138969.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for region autodiscovery, that needs all devices
discovered before their relative position in the region can be
determined, consolidate all position dependent validation in a helper.

Recall that in the on-demand region creation flow the end-user picks the
position of a given endpoint decoder in a region. In the autodiscovery
case the position of an endpoint decoder can only be determined after
all other endpoint decoders that claim to decode the region's address
range have been enumerated and attached. So, in the autodiscovery case
endpoint decoders may be attached before their relative position is
known. Once all decoders arrive, then positions can be determined and
validated with cxl_region_validate_position() the same as user initiated
on-demand creation.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564538779.847146.8356062886811511706.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c |  119 +++++++++++++++++++++++++++++----------------
 1 file changed, 76 insertions(+), 43 deletions(-)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index ae7d3adcd41a..691605f1e120 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -1211,35 +1211,13 @@ static int cxl_region_setup_targets(struct cxl_region *cxlr)
 	return 0;
 }
 
-static int cxl_region_attach(struct cxl_region *cxlr,
-			     struct cxl_endpoint_decoder *cxled, int pos)
+static int cxl_region_validate_position(struct cxl_region *cxlr,
+					struct cxl_endpoint_decoder *cxled,
+					int pos)
 {
-	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
-	struct cxl_port *ep_port, *root_port, *iter;
 	struct cxl_region_params *p = &cxlr->params;
-	struct cxl_dport *dport;
-	int i, rc = -ENXIO;
-
-	if (cxled->mode != cxlr->mode) {
-		dev_dbg(&cxlr->dev, "%s region mode: %d mismatch: %d\n",
-			dev_name(&cxled->cxld.dev), cxlr->mode, cxled->mode);
-		return -EINVAL;
-	}
-
-	if (cxled->mode == CXL_DECODER_DEAD) {
-		dev_dbg(&cxlr->dev, "%s dead\n", dev_name(&cxled->cxld.dev));
-		return -ENODEV;
-	}
-
-	/* all full of members, or interleave config not established? */
-	if (p->state > CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		dev_dbg(&cxlr->dev, "region already active\n");
-		return -EBUSY;
-	} else if (p->state < CXL_CONFIG_INTERLEAVE_ACTIVE) {
-		dev_dbg(&cxlr->dev, "interleave config missing\n");
-		return -ENXIO;
-	}
+	int i;
 
 	if (pos < 0 || pos >= p->interleave_ways) {
 		dev_dbg(&cxlr->dev, "position %d out of range %d\n", pos,
@@ -1278,6 +1256,71 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 		}
 	}
 
+	return 0;
+}
+
+static int cxl_region_attach_position(struct cxl_region *cxlr,
+				      struct cxl_root_decoder *cxlrd,
+				      struct cxl_endpoint_decoder *cxled,
+				      const struct cxl_dport *dport, int pos)
+{
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct cxl_port *iter;
+	int rc;
+
+	if (cxlrd->calc_hb(cxlrd, pos) != dport) {
+		dev_dbg(&cxlr->dev, "%s:%s invalid target position for %s\n",
+			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
+			dev_name(&cxlrd->cxlsd.cxld.dev));
+		return -ENXIO;
+	}
+
+	for (iter = cxled_to_port(cxled); !is_cxl_root(iter);
+	     iter = to_cxl_port(iter->dev.parent)) {
+		rc = cxl_port_attach_region(iter, cxlr, cxled, pos);
+		if (rc)
+			goto err;
+	}
+
+	return 0;
+
+err:
+	for (iter = cxled_to_port(cxled); !is_cxl_root(iter);
+	     iter = to_cxl_port(iter->dev.parent))
+		cxl_port_detach_region(iter, cxlr, cxled);
+	return rc;
+}
+
+static int cxl_region_attach(struct cxl_region *cxlr,
+			     struct cxl_endpoint_decoder *cxled, int pos)
+{
+	struct cxl_root_decoder *cxlrd = to_cxl_root_decoder(cxlr->dev.parent);
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct cxl_region_params *p = &cxlr->params;
+	struct cxl_port *ep_port, *root_port;
+	struct cxl_dport *dport;
+	int rc = -ENXIO;
+
+	if (cxled->mode != cxlr->mode) {
+		dev_dbg(&cxlr->dev, "%s region mode: %d mismatch: %d\n",
+			dev_name(&cxled->cxld.dev), cxlr->mode, cxled->mode);
+		return -EINVAL;
+	}
+
+	if (cxled->mode == CXL_DECODER_DEAD) {
+		dev_dbg(&cxlr->dev, "%s dead\n", dev_name(&cxled->cxld.dev));
+		return -ENODEV;
+	}
+
+	/* all full of members, or interleave config not established? */
+	if (p->state > CXL_CONFIG_INTERLEAVE_ACTIVE) {
+		dev_dbg(&cxlr->dev, "region already active\n");
+		return -EBUSY;
+	} else if (p->state < CXL_CONFIG_INTERLEAVE_ACTIVE) {
+		dev_dbg(&cxlr->dev, "interleave config missing\n");
+		return -ENXIO;
+	}
+
 	ep_port = cxled_to_port(cxled);
 	root_port = cxlrd_to_port(cxlrd);
 	dport = cxl_find_dport_by_dev(root_port, ep_port->host_bridge);
@@ -1288,13 +1331,6 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 		return -ENXIO;
 	}
 
-	if (cxlrd->calc_hb(cxlrd, pos) != dport) {
-		dev_dbg(&cxlr->dev, "%s:%s invalid target position for %s\n",
-			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
-			dev_name(&cxlrd->cxlsd.cxld.dev));
-		return -ENXIO;
-	}
-
 	if (cxled->cxld.target_type != cxlr->type) {
 		dev_dbg(&cxlr->dev, "%s:%s type mismatch: %d vs %d\n",
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
@@ -1318,12 +1354,13 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 		return -EINVAL;
 	}
 
-	for (iter = ep_port; !is_cxl_root(iter);
-	     iter = to_cxl_port(iter->dev.parent)) {
-		rc = cxl_port_attach_region(iter, cxlr, cxled, pos);
-		if (rc)
-			goto err;
-	}
+	rc = cxl_region_validate_position(cxlr, cxled, pos);
+	if (rc)
+		return rc;
+
+	rc = cxl_region_attach_position(cxlr, cxlrd, cxled, dport, pos);
+	if (rc)
+		return rc;
 
 	p->targets[pos] = cxled;
 	cxled->pos = pos;
@@ -1349,10 +1386,6 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 	p->nr_targets--;
 	cxled->pos = -1;
 	p->targets[pos] = NULL;
-err:
-	for (iter = ep_port; !is_cxl_root(iter);
-	     iter = to_cxl_port(iter->dev.parent))
-		cxl_port_detach_region(iter, cxlr, cxled);
 	return rc;
 }
 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D9C24C636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:32 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231911AbjBJJHc (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:32 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39246 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231879AbjBJJGf (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:35 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6BAD611EB9;
        Fri, 10 Feb 2023 01:06:15 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019975; x=1707555975;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=fhaP5oPHi1onz90GhrHdXiTbxa3g3s/6YpVTWY4pO0U=;
  b=JSHxYX701Clq6zXbr/KYF3yvV9vve2AyF2a6BgVEk7+OkN08K/bRgRhW
   XBfbQNhg/zp37M6Tn409rIWiPwpoI9dlVkIht5iTBbws5MdL5HZBDBrtX
   d+he9BFR+5kMxxFKVD1chUYv5VNESK+WN1ybfTm1p1sKZlBV4g8CXlyWg
   lmbhnIrVIR3cgGcM6597h9CDlpP2rhWoxgRoipt7Cs/29HPc+tmb/mo42
   QAVQswxM2bkVgYK9zvSOocOt39wCtZlHZYHMKZGMxUZ7LLxi0H4R0WS9O
   2z5GIKpR+rl1gYlpFyhB4w9eQDmPuU7iZ1yVvZmyihQhdFt5db66f+tcs
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="416600064"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="416600064"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:10 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="669930260"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="669930260"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga007-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:10 -0800
Subject: [PATCH v2 08/20] cxl/region: Cleanup target list on attach error
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        vishal.l.verma@intel.com, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:09 -0800
Message-ID: <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan noticed that the target list setup is not unwound completely
upon error. Undo all the setup in the 'err_decrement:' exit path.

Fixes: 27b3f8d13830 ("cxl/region: Program target lists")
Reported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Link: http://lore.kernel.org/r/20230208123031.00006990@Huawei.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/region.c |    2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 040bbd39c81d..ae7d3adcd41a 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -1347,6 +1347,8 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 
 err_decrement:
 	p->nr_targets--;
+	cxled->pos = -1;
+	p->targets[pos] = NULL;
 err:
 	for (iter = ep_port; !is_cxl_root(iter);
 	     iter = to_cxl_port(iter->dev.parent))


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id ADAFFC636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231488AbjBJJHj (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:39 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39278 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231329AbjBJJGm (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:42 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D9F9937736;
        Fri, 10 Feb 2023 01:06:22 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019982; x=1707555982;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=8q/1cNxswZmepEnA6xfwY56HjCTVePeFSsIba+FKR6Y=;
  b=ZRw+M68WmKFVF6bJwkp4m1Iz0TY4IiDKTg9mJihnQITd8NYxwCewiXPu
   RMW/vsvcqDs0/mfWROB+RyIlOxp8IjTuGNGXwfqjC+ZwUkL2N+ahz/2eR
   mnLDwb7atBSOI4wT5wm95zhlZ2EfMIcIMK9sU481djoVQhhFG4NWfsSUi
   ejrHxOZ2WsyrEDOk8kXWvZ24AwaJSX/fRZgvfKvvsVKlaHBNmQRgHgVAw
   V6hiYHSrxnSifW54/blm1CAk8dV7OQVa4qYsDCSsx91wLuBFKxRNNEKYB
   9hTmm0DzHhDfCkYeu5YHE84huZTfK1lchPm+c88L92NzBevV2cariRkck
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329003055"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="329003055"
Received: from fmsmga006.fm.intel.com ([10.253.24.20])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:22 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="913463813"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="913463813"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga006-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:22 -0800
Subject: [PATCH v2 10/20] kernel/range: Uplevel the cxl subsystem's
 range_contains() helper
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Kees Cook <keescook@chromium.org>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Ira Weiny <ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:21 -0800
Message-ID: <167601998163.1924368.6067392174077323935.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In support of the CXL subsystem's use of 'struct range' to track decode
address ranges, add a common range_contains() implementation with
identical semantics as resource_contains();

The existing 'range_contains()' in lib/stackinit_kunit.c is namespaced
with a 'stackinit_' prefix.

Cc: Kees Cook <keescook@chromium.org>
Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Ira Weiny <ira.weiny@intel.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564539327.847146.788601375229324484.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/pci.c |    5 -----
 include/linux/range.h  |    5 +++++
 lib/stackinit_kunit.c  |    6 +++---
 3 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 1d1492440287..9ed2120dbf8a 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -214,11 +214,6 @@ static int devm_cxl_enable_mem(struct device *host, struct cxl_dev_state *cxlds)
 	return devm_add_action_or_reset(host, clear_mem_enable, cxlds);
 }
 
-static bool range_contains(struct range *r1, struct range *r2)
-{
-	return r1->start <= r2->start && r1->end >= r2->end;
-}
-
 /* require dvsec ranges to be covered by a locked platform window */
 static int dvsec_range_allowed(struct device *dev, void *arg)
 {
diff --git a/include/linux/range.h b/include/linux/range.h
index 274681cc3154..7efb6a9b069b 100644
--- a/include/linux/range.h
+++ b/include/linux/range.h
@@ -13,6 +13,11 @@ static inline u64 range_len(const struct range *range)
 	return range->end - range->start + 1;
 }
 
+static inline bool range_contains(struct range *r1, struct range *r2)
+{
+	return r1->start <= r2->start && r1->end >= r2->end;
+}
+
 int add_range(struct range *range, int az, int nr_range,
 		u64 start, u64 end);
 
diff --git a/lib/stackinit_kunit.c b/lib/stackinit_kunit.c
index 4591d6cf5e01..05947a2feb93 100644
--- a/lib/stackinit_kunit.c
+++ b/lib/stackinit_kunit.c
@@ -31,8 +31,8 @@ static volatile u8 forced_mask = 0xff;
 static void *fill_start, *target_start;
 static size_t fill_size, target_size;
 
-static bool range_contains(char *haystack_start, size_t haystack_size,
-			   char *needle_start, size_t needle_size)
+static bool stackinit_range_contains(char *haystack_start, size_t haystack_size,
+				     char *needle_start, size_t needle_size)
 {
 	if (needle_start >= haystack_start &&
 	    needle_start + needle_size <= haystack_start + haystack_size)
@@ -175,7 +175,7 @@ static noinline void test_ ## name (struct kunit *test)		\
 								\
 	/* Validate that compiler lined up fill and target. */	\
 	KUNIT_ASSERT_TRUE_MSG(test,				\
-		range_contains(fill_start, fill_size,		\
+		stackinit_range_contains(fill_start, fill_size,	\
 			    target_start, target_size),		\
 		"stack fill missed target!? "			\
 		"(fill %zu wide, target offset by %d)\n",	\


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8540FC64EC4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:42 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231923AbjBJJHk (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:40 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39894 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231629AbjBJJGu (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:50 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id EBBF33EFC5;
        Fri, 10 Feb 2023 01:06:28 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019989; x=1707555989;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=QvyAdNBc9ZYsmtnrtNpMiAkkV624GUaybC07KzHXR5s=;
  b=ROTz6GR1lLgZ/UGNGI1F5F3KZIcEtNPAQipPFHlhx+l2ym3IZUOe/rka
   v21sG4kvO5KJ6PDn0qhC+au9KGGeqStppK03cg+DOkqlo7OTzC23Vd/4l
   e/58E5xg52nG0nCAQsivYn7qf4PEvVKpknIvheTQxL+zBJgNxcY4BzCNt
   KcaQLayHLJ2Ae0C6nFsesny21iqnTPUSD6urzLmSNvDFI1EZk72+GXZYC
   HhKB9Osht0Bnt5LepzMoIky4nYHZxlAd2S0LgM/ZQz9FsAhAn+iuPN6wh
   C/fZ+1BzpAFQVsG1ZllOdhtiKb+Vd8fsH4hyC4h7oJI0q85wGy3/BvJ6/
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329003076"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="329003076"
Received: from fmsmga006.fm.intel.com ([10.253.24.20])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:28 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="913463849"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="913463849"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga006-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:28 -0800
Subject: [PATCH v2 11/20] cxl/region: Enable CONFIG_CXL_REGION to be toggled
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Vishal Verma <vishal.l.verma@intel.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:27 -0800
Message-ID: <167601998765.1924368.258370414771847699.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Add help text and a label so the CXL_REGION config option can be
toggled. This is mainly to enable compile testing without region
support.

Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564539875.847146.16213498614174558767.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/Kconfig |   12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/cxl/Kconfig b/drivers/cxl/Kconfig
index 0ac53c422c31..163c094e67ae 100644
--- a/drivers/cxl/Kconfig
+++ b/drivers/cxl/Kconfig
@@ -104,12 +104,22 @@ config CXL_SUSPEND
 	depends on SUSPEND && CXL_MEM
 
 config CXL_REGION
-	bool
+	bool "CXL: Region Support"
 	default CXL_BUS
 	# For MAX_PHYSMEM_BITS
 	depends on SPARSEMEM
 	select MEMREGION
 	select GET_FREE_REGION
+	help
+	  Enable the CXL core to enumerate and provision CXL regions. A CXL
+	  region is defined by one or more CXL expanders that decode a given
+	  system-physical address range. For CXL regions established by
+	  platform-firmware this option enables memory error handling to
+	  identify the devices participating in a given interleaved memory
+	  range. Otherwise, platform-firmware managed CXL is enabled by being
+	  placed in the system address map and does not need a driver.
+
+	  If unsure say 'y'
 
 config CXL_REGION_INVALIDATION_TEST
 	bool "CXL: Region Cache Management Bypass (TEST)"


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E4B83C636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:43 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231728AbjBJJHm (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:42 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39048 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231741AbjBJJGv (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:06:51 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CF48F1C5B2;
        Fri, 10 Feb 2023 01:06:34 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676019994; x=1707555994;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=Gr+5ktwk+FAUTV+9ED5wsHL+1owhmcENlu36isQTlcE=;
  b=lo+nyjhMEvmuroe6vQf8V3U8cijZ3IA29aKKBwgWUNvPvX4R3GNBQkSO
   2o4fqOI9gAVzDdwEDUaQot6k1CTyv4DcuZO+z/2njhgkkQgi7SYKVo7eJ
   L75xzxZYmJQPy9W9LfvEU9bwtQu+LZxGQIiuvROzoI+Hpm4X+9nE12ylf
   TTVsM1glSLQFH0TsMYXuZuhsiEpMQlT6xSlqIWnSgAYbiuPLKXZIxHB7L
   WoNPaqNG/cEs4HC2fX7tWIu+MCYcGBj+MN4OyMHW4998+IMYhqaScgbvL
   2KbqEB5jkQXe/zRDLAZhwB8RanM+kmNjwoQA/fJOoxaDxtbTeOIgJkAuM
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329003096"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="329003096"
Received: from fmsmga006.fm.intel.com ([10.253.24.20])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:34 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="913463888"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="913463888"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga006-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:34 -0800
Subject: [PATCH v2 12/20] cxl/port: Split endpoint and switch port probe
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        vishal.l.verma@intel.com, dave.hansen@linux.intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:33 -0800
Message-ID: <167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan points out that the shared code between the switch and endpoint
case is small. Before adding another is_cxl_endpoint() conditional,
just split the two cases.

Rather than duplicate the "Couldn't enumerate decoders" error message
take the opportunity to improve the error messages in
devm_cxl_enumerate_decoders().

Reported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Link: http://lore.kernel.org/r/20230208170724.000067ec@Huawei.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/hdm.c |   11 ++++++--
 drivers/cxl/port.c     |   69 +++++++++++++++++++++++++++---------------------
 2 files changed, 47 insertions(+), 33 deletions(-)

diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index dcc16d7cb8f3..a0891c3464f1 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -826,7 +826,8 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
 			cxled = cxl_endpoint_decoder_alloc(port);
 			if (IS_ERR(cxled)) {
 				dev_warn(&port->dev,
-					 "Failed to allocate the decoder\n");
+					 "Failed to allocate decoder%d.%d\n",
+					 port->id, i);
 				return PTR_ERR(cxled);
 			}
 			cxld = &cxled->cxld;
@@ -836,7 +837,8 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
 			cxlsd = cxl_switch_decoder_alloc(port, target_count);
 			if (IS_ERR(cxlsd)) {
 				dev_warn(&port->dev,
-					 "Failed to allocate the decoder\n");
+					 "Failed to allocate decoder%d.%d\n",
+					 port->id, i);
 				return PTR_ERR(cxlsd);
 			}
 			cxld = &cxlsd->cxld;
@@ -844,13 +846,16 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
 
 		rc = init_hdm_decoder(port, cxld, target_map, hdm, i, &dpa_base);
 		if (rc) {
+			dev_warn(&port->dev,
+				 "Failed to initialize decoder%d.%d\n",
+				 port->id, i);
 			put_device(&cxld->dev);
 			return rc;
 		}
 		rc = add_hdm_decoder(port, cxld, target_map);
 		if (rc) {
 			dev_warn(&port->dev,
-				 "Failed to add decoder to port\n");
+				 "Failed to add decoder%d.%d\n", port->id, i);
 			return rc;
 		}
 	}
diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
index 5453771bf330..a8d46a67b45e 100644
--- a/drivers/cxl/port.c
+++ b/drivers/cxl/port.c
@@ -30,55 +30,64 @@ static void schedule_detach(void *cxlmd)
 	schedule_cxl_memdev_detach(cxlmd);
 }
 
-static int cxl_port_probe(struct device *dev)
+static int cxl_switch_port_probe(struct cxl_port *port)
 {
-	struct cxl_port *port = to_cxl_port(dev);
 	struct cxl_hdm *cxlhdm;
 	int rc;
 
+	rc = devm_cxl_port_enumerate_dports(port);
+	if (rc < 0)
+		return rc;
 
-	if (!is_cxl_endpoint(port)) {
-		rc = devm_cxl_port_enumerate_dports(port);
-		if (rc < 0)
-			return rc;
-		if (rc == 1)
-			return devm_cxl_add_passthrough_decoder(port);
-	}
+	if (rc == 1)
+		return devm_cxl_add_passthrough_decoder(port);
 
 	cxlhdm = devm_cxl_setup_hdm(port);
 	if (IS_ERR(cxlhdm))
 		return PTR_ERR(cxlhdm);
 
-	if (is_cxl_endpoint(port)) {
-		struct cxl_memdev *cxlmd = to_cxl_memdev(port->uport);
-		struct cxl_dev_state *cxlds = cxlmd->cxlds;
+	return devm_cxl_enumerate_decoders(cxlhdm);
+}
 
-		/* Cache the data early to ensure is_visible() works */
-		read_cdat_data(port);
+static int cxl_endpoint_port_probe(struct cxl_port *port)
+{
+	struct cxl_memdev *cxlmd = to_cxl_memdev(port->uport);
+	struct cxl_dev_state *cxlds = cxlmd->cxlds;
+	struct cxl_hdm *cxlhdm;
+	int rc;
+
+	cxlhdm = devm_cxl_setup_hdm(port);
+	if (IS_ERR(cxlhdm))
+		return PTR_ERR(cxlhdm);
 
-		get_device(&cxlmd->dev);
-		rc = devm_add_action_or_reset(dev, schedule_detach, cxlmd);
-		if (rc)
-			return rc;
+	/* Cache the data early to ensure is_visible() works */
+	read_cdat_data(port);
 
-		rc = cxl_hdm_decode_init(cxlds, cxlhdm);
-		if (rc)
-			return rc;
+	get_device(&cxlmd->dev);
+	rc = devm_add_action_or_reset(&port->dev, schedule_detach, cxlmd);
+	if (rc)
+		return rc;
 
-		rc = cxl_await_media_ready(cxlds);
-		if (rc) {
-			dev_err(dev, "Media not active (%d)\n", rc);
-			return rc;
-		}
-	}
+	rc = cxl_hdm_decode_init(cxlds, cxlhdm);
+	if (rc)
+		return rc;
 
-	rc = devm_cxl_enumerate_decoders(cxlhdm);
+	rc = cxl_await_media_ready(cxlds);
 	if (rc) {
-		dev_err(dev, "Couldn't enumerate decoders (%d)\n", rc);
+		dev_err(&port->dev, "Media not active (%d)\n", rc);
 		return rc;
 	}
 
-	return 0;
+	return devm_cxl_enumerate_decoders(cxlhdm);
+}
+
+static int cxl_port_probe(struct device *dev)
+{
+	struct cxl_port *port = to_cxl_port(dev);
+
+	if (is_cxl_endpoint(port))
+		return cxl_endpoint_port_probe(port);
+	return cxl_switch_port_probe(port);
 }
 
 static ssize_t CDAT_read(struct file *filp, struct kobject *kobj,


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3E8D6C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:07:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231720AbjBJJHq (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:07:46 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39970 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231737AbjBJJHA (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:07:00 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id ABF84BB9A;
        Fri, 10 Feb 2023 01:06:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020000; x=1707556000;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=xg87SwclHTz/KBBQ2o6kd8aRFgOzWf7Clc07w0ozOXQ=;
  b=W32/MnAvCX9l6dwMwhZWBSPTkKacNetL9nYsnQzBzBtQssAn2h2lZsxe
   kFbLzQNf8TZo0x4CTB27IhAxpn07IIPpRKyRVb63CphZNaXcvFMAGG9kl
   s9OlY90WrCH+T8XnTUVL4pQkXdsHlLILRdMNtaYZJ8F+CoZU5G9NyOr9A
   WZRSe5OjQ8GtbQHg0KU9pxkyXgKwAcITYbvDUbpV08rFlIShx0LVWb0Es
   3aLa6ygt3eMxS6vw/fPxKJIiUaZnkNJE8KgUqGztB2KSHnWXv7snQ3ePp
   pscz884uaJ1VFmU+Le89RuGd2ewvzlaCyUYXJgPRARCbpx1SoSRjhkaoD
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329003112"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="329003112"
Received: from fmsmga006.fm.intel.com ([10.253.24.20])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:40 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="913463913"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="913463913"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by fmsmga006-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:40 -0800
Subject: [PATCH v2 13/20] cxl/region: Add region autodiscovery
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:39 -0800
Message-ID: <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Region autodiscovery is an asynchronous state machine advanced by
cxl_port_probe(). After the decoders on an endpoint port are enumerated
they are scanned for actively enabled instances. Each active decoder is
flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
If a region does not already exist for the address range setting of the
decoder one is created. That creation process may race with other
decoders of the same region being discovered since cxl_port_probe() is
asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
introduced to mitigate that race.

Once all decoders have arrived, "p->nr_targets == p->interleave_ways",
they are sorted by their relative decode position. The sort algorithm
involves finding the point in the cxl_port topology where one leg of the
decode leads to deviceA and the other deviceB. At that point in the
topology the target order in the 'struct cxl_switch_decoder' indicates
the relative position of those endpoint decoders in the region.

>From that point the region goes through the same setup and validation
steps as user-created regions, but instead of programming the decoders
it validates that driver would have written the same values to the
decoders as were already present.

Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/hdm.c    |   11 +
 drivers/cxl/core/port.c   |    2 
 drivers/cxl/core/region.c |  497 ++++++++++++++++++++++++++++++++++++++++++++-
 drivers/cxl/cxl.h         |   29 +++
 drivers/cxl/port.c        |   48 ++++
 5 files changed, 576 insertions(+), 11 deletions(-)

diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index a0891c3464f1..8c29026a4b9d 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -676,6 +676,14 @@ static int cxl_decoder_reset(struct cxl_decoder *cxld)
 	port->commit_end--;
 	cxld->flags &= ~CXL_DECODER_F_ENABLE;
 
+	/* Userspace is now responsible for reconfiguring this decoder */
+	if (is_endpoint_decoder(&cxld->dev)) {
+		struct cxl_endpoint_decoder *cxled;
+
+		cxled = to_cxl_endpoint_decoder(&cxld->dev);
+		cxled->state = CXL_DECODER_STATE_MANUAL;
+	}
+
 	return 0;
 }
 
@@ -783,6 +791,9 @@ static int init_hdm_decoder(struct cxl_port *port, struct cxl_decoder *cxld,
 		return rc;
 	}
 	*dpa_base += dpa_size + skip;
+
+	cxled->state = CXL_DECODER_STATE_AUTO;
+
 	return 0;
 }
 
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 9e5df64ea6b5..59620528571a 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -446,6 +446,7 @@ bool is_endpoint_decoder(struct device *dev)
 {
 	return dev->type == &cxl_decoder_endpoint_type;
 }
+EXPORT_SYMBOL_NS_GPL(is_endpoint_decoder, CXL);
 
 bool is_root_decoder(struct device *dev)
 {
@@ -1628,6 +1629,7 @@ struct cxl_root_decoder *cxl_root_decoder_alloc(struct cxl_port *port,
 	}
 
 	cxlrd->calc_hb = calc_hb;
+	mutex_init(&cxlrd->range_lock);
 
 	cxld = &cxlsd->cxld;
 	cxld->dev.type = &cxl_decoder_root_type;
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 691605f1e120..3f6453da2c51 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -6,6 +6,7 @@
 #include <linux/module.h>
 #include <linux/slab.h>
 #include <linux/uuid.h>
+#include <linux/sort.h>
 #include <linux/idr.h>
 #include <cxlmem.h>
 #include <cxl.h>
@@ -524,7 +525,12 @@ static void cxl_region_iomem_release(struct cxl_region *cxlr)
 	if (device_is_registered(&cxlr->dev))
 		lockdep_assert_held_write(&cxl_region_rwsem);
 	if (p->res) {
-		remove_resource(p->res);
+		/*
+		 * Autodiscovered regions may not have been able to insert their
+		 * resource.
+		 */
+		if (p->res->parent)
+			remove_resource(p->res);
 		kfree(p->res);
 		p->res = NULL;
 	}
@@ -1105,12 +1111,35 @@ static int cxl_port_setup_targets(struct cxl_port *port,
 		return rc;
 	}
 
-	cxld->interleave_ways = iw;
-	cxld->interleave_granularity = ig;
-	cxld->hpa_range = (struct range) {
-		.start = p->res->start,
-		.end = p->res->end,
-	};
+	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
+		if (cxld->interleave_ways != iw ||
+		    cxld->interleave_granularity != ig ||
+		    cxld->hpa_range.start != p->res->start ||
+		    cxld->hpa_range.end != p->res->end ||
+		    ((cxld->flags & CXL_DECODER_F_ENABLE) == 0)) {
+			dev_err(&cxlr->dev,
+				"%s:%s %s expected iw: %d ig: %d %pr\n",
+				dev_name(port->uport), dev_name(&port->dev),
+				__func__, iw, ig, p->res);
+			dev_err(&cxlr->dev,
+				"%s:%s %s got iw: %d ig: %d state: %s %#llx:%#llx\n",
+				dev_name(port->uport), dev_name(&port->dev),
+				__func__, cxld->interleave_ways,
+				cxld->interleave_granularity,
+				(cxld->flags & CXL_DECODER_F_ENABLE) ?
+					"enabled" :
+					"disabled",
+				cxld->hpa_range.start, cxld->hpa_range.end);
+			return -ENXIO;
+		}
+	} else {
+		cxld->interleave_ways = iw;
+		cxld->interleave_granularity = ig;
+		cxld->hpa_range = (struct range) {
+			.start = p->res->start,
+			.end = p->res->end,
+		};
+	}
 	dev_dbg(&cxlr->dev, "%s:%s iw: %d ig: %d\n", dev_name(port->uport),
 		dev_name(&port->dev), iw, ig);
 add_target:
@@ -1121,7 +1150,17 @@ static int cxl_port_setup_targets(struct cxl_port *port,
 			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), pos);
 		return -ENXIO;
 	}
-	cxlsd->target[cxl_rr->nr_targets_set] = ep->dport;
+	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
+		if (cxlsd->target[cxl_rr->nr_targets_set] != ep->dport) {
+			dev_dbg(&cxlr->dev, "%s:%s: %s expected %s at %d\n",
+				dev_name(port->uport), dev_name(&port->dev),
+				dev_name(&cxlsd->cxld.dev),
+				dev_name(ep->dport->dport),
+				cxl_rr->nr_targets_set);
+			return -ENXIO;
+		}
+	} else
+		cxlsd->target[cxl_rr->nr_targets_set] = ep->dport;
 	inc = 1;
 out_target_set:
 	cxl_rr->nr_targets_set += inc;
@@ -1163,6 +1202,13 @@ static void cxl_region_teardown_targets(struct cxl_region *cxlr)
 	struct cxl_ep *ep;
 	int i;
 
+	/*
+	 * In the auto-discovery case skip automatic teardown since the
+	 * address space is already active
+	 */
+	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags))
+		return;
+
 	for (i = 0; i < p->nr_targets; i++) {
 		cxled = p->targets[i];
 		cxlmd = cxled_to_memdev(cxled);
@@ -1195,8 +1241,8 @@ static int cxl_region_setup_targets(struct cxl_region *cxlr)
 			iter = to_cxl_port(iter->dev.parent);
 
 		/*
-		 * Descend the topology tree programming targets while
-		 * looking for conflicts.
+		 * Descend the topology tree programming / validating
+		 * targets while looking for conflicts.
 		 */
 		for (ep = cxl_ep_load(iter, cxlmd); iter;
 		     iter = ep->next, ep = cxl_ep_load(iter, cxlmd)) {
@@ -1291,6 +1337,185 @@ static int cxl_region_attach_position(struct cxl_region *cxlr,
 	return rc;
 }
 
+static int cxl_region_attach_auto(struct cxl_region *cxlr,
+				  struct cxl_endpoint_decoder *cxled, int pos)
+{
+	struct cxl_region_params *p = &cxlr->params;
+
+	if (cxled->state != CXL_DECODER_STATE_AUTO) {
+		dev_err(&cxlr->dev,
+			"%s: unable to add decoder to autodetected region\n",
+			dev_name(&cxled->cxld.dev));
+		return -EINVAL;
+	}
+
+	if (pos >= 0) {
+		dev_dbg(&cxlr->dev, "%s: expected auto position, not %d\n",
+			dev_name(&cxled->cxld.dev), pos);
+		return -EINVAL;
+	}
+
+	if (p->nr_targets >= p->interleave_ways) {
+		dev_err(&cxlr->dev, "%s: no more target slots available\n",
+			dev_name(&cxled->cxld.dev));
+		return -ENXIO;
+	}
+
+	/*
+	 * Temporarily record the endpoint decoder into the target array. Yes,
+	 * this means that userspace can view devices in the wrong position
+	 * before the region activates, and must be careful to understand when
+	 * it might be racing region autodiscovery.
+	 */
+	pos = p->nr_targets;
+	p->targets[pos] = cxled;
+	cxled->pos = pos;
+	p->nr_targets++;
+
+	return 0;
+}
+
+static struct cxl_port *next_port(struct cxl_port *port)
+{
+	if (!port->parent_dport)
+		return NULL;
+	return port->parent_dport->port;
+}
+
+static int decoder_match_range(struct device *dev, void *data)
+{
+	struct cxl_endpoint_decoder *cxled = data;
+	struct cxl_switch_decoder *cxlsd;
+
+	if (!is_switch_decoder(dev))
+		return 0;
+
+	cxlsd = to_cxl_switch_decoder(dev);
+	return range_contains(&cxlsd->cxld.hpa_range, &cxled->cxld.hpa_range);
+}
+
+static void find_positions(const struct cxl_switch_decoder *cxlsd,
+			   const struct cxl_port *iter_a,
+			   const struct cxl_port *iter_b, int *a_pos,
+			   int *b_pos)
+{
+	int i;
+
+	for (i = 0, *a_pos = -1, *b_pos = -1; i < cxlsd->nr_targets; i++) {
+		if (cxlsd->target[i] == iter_a->parent_dport)
+			*a_pos = i;
+		else if (cxlsd->target[i] == iter_b->parent_dport)
+			*b_pos = i;
+		if (*a_pos >= 0 && *b_pos >= 0)
+			break;
+	}
+}
+
+static int cmp_decode_pos(const void *a, const void *b)
+{
+	struct cxl_endpoint_decoder *cxled_a = *(typeof(cxled_a) *)a;
+	struct cxl_endpoint_decoder *cxled_b = *(typeof(cxled_b) *)b;
+	struct cxl_memdev *cxlmd_a = cxled_to_memdev(cxled_a);
+	struct cxl_memdev *cxlmd_b = cxled_to_memdev(cxled_b);
+	struct cxl_port *port_a = cxled_to_port(cxled_a);
+	struct cxl_port *port_b = cxled_to_port(cxled_b);
+	struct cxl_port *iter_a, *iter_b, *port = NULL;
+	struct cxl_switch_decoder *cxlsd;
+	struct device *dev;
+	int a_pos, b_pos;
+	unsigned int seq;
+
+	/* Exit early if any prior sorting failed */
+	if (cxled_a->pos < 0 || cxled_b->pos < 0)
+		return 0;
+
+	/*
+	 * Walk up the hierarchy to find a shared port, find the decoder that
+	 * maps the range, compare the relative position of those dport
+	 * mappings.
+	 */
+	for (iter_a = port_a; iter_a; iter_a = next_port(iter_a)) {
+		struct cxl_port *next_a, *next_b;
+
+		next_a = next_port(iter_a);
+		if (!next_a)
+			break;
+
+		for (iter_b = port_b; iter_b; iter_b = next_port(iter_b)) {
+			next_b = next_port(iter_b);
+			if (next_a != next_b)
+				continue;
+			port = next_a;
+			break;
+		}
+
+		if (port)
+			break;
+	}
+
+	if (!port) {
+		dev_err(cxlmd_a->dev.parent,
+			"failed to find shared port with %s\n",
+			dev_name(cxlmd_b->dev.parent));
+		goto err;
+	}
+
+	dev = device_find_child(&port->dev, cxled_a, decoder_match_range);
+	if (!dev) {
+		struct range *range = &cxled_a->cxld.hpa_range;
+
+		dev_err(port->uport,
+			"failed to find decoder that maps %#llx-%#llx\n",
+			range->start, range->end);
+		goto err;
+	}
+
+	cxlsd = to_cxl_switch_decoder(dev);
+	do {
+		seq = read_seqbegin(&cxlsd->target_lock);
+		find_positions(cxlsd, iter_a, iter_b, &a_pos, &b_pos);
+	} while (read_seqretry(&cxlsd->target_lock, seq));
+
+	put_device(dev);
+
+	if (a_pos < 0 || b_pos < 0) {
+		dev_err(port->uport,
+			"failed to find shared decoder for %s and %s\n",
+			dev_name(cxlmd_a->dev.parent),
+			dev_name(cxlmd_b->dev.parent));
+		goto err;
+	}
+
+	dev_dbg(port->uport, "%s comes %s %s\n", dev_name(cxlmd_a->dev.parent),
+		a_pos - b_pos < 0 ? "before" : "after",
+		dev_name(cxlmd_b->dev.parent));
+
+	return a_pos - b_pos;
+err:
+	cxled_a->pos = -1;
+	return 0;
+}
+
+static int cxl_region_sort_targets(struct cxl_region *cxlr)
+{
+	struct cxl_region_params *p = &cxlr->params;
+	int i, rc = 0;
+
+	sort(p->targets, p->nr_targets, sizeof(p->targets[0]), cmp_decode_pos,
+	     NULL);
+
+	for (i = 0; i < p->nr_targets; i++) {
+		struct cxl_endpoint_decoder *cxled = p->targets[i];
+
+		if (cxled->pos < 0)
+			rc = -ENXIO;
+		cxled->pos = i;
+	}
+
+	dev_dbg(&cxlr->dev, "region sort %s\n", rc ? "failed" : "successful");
+	return rc;
+}
+
 static int cxl_region_attach(struct cxl_region *cxlr,
 			     struct cxl_endpoint_decoder *cxled, int pos)
 {
@@ -1354,6 +1579,50 @@ static int cxl_region_attach(struct cxl_region *cxlr,
 		return -EINVAL;
 	}
 
+	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
+		int i;
+
+		rc = cxl_region_attach_auto(cxlr, cxled, pos);
+		if (rc)
+			return rc;
+
+		/* await more targets to arrive... */
+		if (p->nr_targets < p->interleave_ways)
+			return 0;
+
+		/*
+		 * All targets are here, which implies all PCI enumeration that
+		 * affects this region has been completed. Walk the topology to
+		 * sort the devices into their relative region decode position.
+		 */
+		rc = cxl_region_sort_targets(cxlr);
+		if (rc)
+			return rc;
+
+		for (i = 0; i < p->nr_targets; i++) {
+			cxled = p->targets[i];
+			ep_port = cxled_to_port(cxled);
+			dport = cxl_find_dport_by_dev(root_port,
+						      ep_port->host_bridge);
+			rc = cxl_region_attach_position(cxlr, cxlrd, cxled,
+							dport, i);
+			if (rc)
+				return rc;
+		}
+
+		rc = cxl_region_setup_targets(cxlr);
+		if (rc)
+			return rc;
+
+		/*
+		 * If target setup succeeds in the autodiscovery case
+		 * then the region is already committed.
+		 */
+		p->state = CXL_CONFIG_COMMIT;
+
+		return 0;
+	}
+
 	rc = cxl_region_validate_position(cxlr, cxled, pos);
 	if (rc)
 		return rc;
@@ -2087,6 +2356,193 @@ static int devm_cxl_add_pmem_region(struct cxl_region *cxlr)
 	return rc;
 }
 
+static int match_decoder_by_range(struct device *dev, void *data)
+{
+	struct range *r1, *r2 = data;
+	struct cxl_root_decoder *cxlrd;
+
+	if (!is_root_decoder(dev))
+		return 0;
+
+	cxlrd = to_cxl_root_decoder(dev);
+	r1 = &cxlrd->cxlsd.cxld.hpa_range;
+	return range_contains(r1, r2);
+}
+
+static int match_region_by_range(struct device *dev, void *data)
+{
+	struct cxl_region_params *p;
+	struct cxl_region *cxlr;
+	struct range *r = data;
+	int rc = 0;
+
+	if (!is_cxl_region(dev))
+		return 0;
+
+	cxlr = to_cxl_region(dev);
+	p = &cxlr->params;
+
+	down_read(&cxl_region_rwsem);
+	if (p->res && p->res->start == r->start && p->res->end == r->end)
+		rc = 1;
+	up_read(&cxl_region_rwsem);
+
+	return rc;
+}
+
+/* Establish an empty region covering the given HPA range */
+static struct cxl_region *construct_region(struct cxl_root_decoder *cxlrd,
+					   struct cxl_endpoint_decoder *cxled)
+{
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct cxl_port *port = cxlrd_to_port(cxlrd);
+	struct range *hpa = &cxled->cxld.hpa_range;
+	struct cxl_region_params *p;
+	struct cxl_region *cxlr;
+	struct resource *res;
+	int rc;
+
+	do {
+		cxlr = __create_region(cxlrd, cxled->mode,
+				       atomic_read(&cxlrd->region_id));
+	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) == -EBUSY);
+
+	if (IS_ERR(cxlr)) {
+		dev_err(cxlmd->dev.parent,
+			"%s:%s: %s failed assign region: %ld\n",
+			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
+			__func__, PTR_ERR(cxlr));
+		return cxlr;
+	}
+
+	down_write(&cxl_region_rwsem);
+	p = &cxlr->params;
+	if (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE) {
+		dev_err(cxlmd->dev.parent,
+			"%s:%s: %s autodiscovery interrupted\n",
+			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
+			__func__);
+		rc = -EBUSY;
+		goto err;
+	}
+
+	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
+
+	res = kmalloc(sizeof(*res), GFP_KERNEL);
+	if (!res) {
+		rc = -ENOMEM;
+		goto err;
+	}
+
+	*res = DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
+				    dev_name(&cxlr->dev));
+	rc = insert_resource(cxlrd->res, res);
+	if (rc) {
+		/*
+		 * Platform-firmware may not have split resources like "System
+		 * RAM" on CXL window boundaries see cxl_region_iomem_release()
+		 */
+		dev_warn(cxlmd->dev.parent,
+			 "%s:%s: %s %s cannot insert resource\n",
+			 dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
+			 __func__, dev_name(&cxlr->dev));
+	}
+
+	p->res = res;
+	p->interleave_ways = cxled->cxld.interleave_ways;
+	p->interleave_granularity = cxled->cxld.interleave_granularity;
+	p->state = CXL_CONFIG_INTERLEAVE_ACTIVE;
+
+	rc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());
+	if (rc)
+		goto err;
+
+	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
+		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
+		dev_name(&cxlr->dev), p->res, p->interleave_ways,
+		p->interleave_granularity);
+
+	/* ...to match put_device() in cxl_add_to_region() */
+	get_device(&cxlr->dev);
+	up_write(&cxl_region_rwsem);
+
+	return cxlr;
+
+err:
+	up_write(&cxl_region_rwsem);
+	devm_release_action(port->uport, unregister_region, cxlr);
+	return ERR_PTR(rc);
+}
+
+int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
+{
+	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
+	struct range *hpa = &cxled->cxld.hpa_range;
+	struct cxl_decoder *cxld = &cxled->cxld;
+	struct cxl_root_decoder *cxlrd;
+	struct cxl_region_params *p;
+	struct cxl_region *cxlr;
+	bool attach = false;
+	struct device *dev;
+	int rc;
+
+	dev = device_find_child(&root->dev, &cxld->hpa_range,
+				match_decoder_by_range);
+	if (!dev) {
+		dev_err(cxlmd->dev.parent,
+			"%s:%s no CXL window for range %#llx:%#llx\n",
+			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
+			cxld->hpa_range.start, cxld->hpa_range.end);
+		return -ENXIO;
+	}
+
+	cxlrd = to_cxl_root_decoder(dev);
+
+	/*
+	 * Ensure that if multiple threads race to construct_region() for @hpa
+	 * one does the construction and the others add to that.
+	 */
+	mutex_lock(&cxlrd->range_lock);
+	dev = device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
+				match_region_by_range);
+	if (!dev)
+		cxlr = construct_region(cxlrd, cxled);
+	else
+		cxlr = to_cxl_region(dev);
+	mutex_unlock(&cxlrd->range_lock);
+
+	if (IS_ERR(cxlr)) {
+		rc = PTR_ERR(cxlr);
+		goto out;
+	}
+
+	attach_target(cxlr, cxled, -1, TASK_UNINTERRUPTIBLE);
+
+	down_read(&cxl_region_rwsem);
+	p = &cxlr->params;
+	attach = p->state == CXL_CONFIG_COMMIT;
+	up_read(&cxl_region_rwsem);
+
+	if (attach) {
+		int rc = device_attach(&cxlr->dev);
+
+		/*
+		 * If device_attach() fails the range may still be active via
+		 * the platform-firmware memory map, otherwise the driver for
+		 * regions is local to this file, so driver matching can't fail.
+		 */
+		if (rc < 0)
+			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
+				p->res);
+	}
+
+	put_device(&cxlr->dev);
+out:
+	put_device(&cxlrd->cxlsd.cxld.dev);
+	return rc;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);
+
 static int cxl_region_invalidate_memregion(struct cxl_region *cxlr)
 {
 	if (!test_bit(CXL_REGION_F_INCOHERENT, &cxlr->flags))
@@ -2111,6 +2567,15 @@ static int cxl_region_invalidate_memregion(struct cxl_region *cxlr)
 	return 0;
 }
 
+static int is_system_ram(struct resource *res, void *arg)
+{
+	struct cxl_region *cxlr = arg;
+	struct cxl_region_params *p = &cxlr->params;
+
+	dev_dbg(&cxlr->dev, "%pr has System RAM: %pr\n", p->res, res);
+	return 1;
+}
+
 static int cxl_region_probe(struct device *dev)
 {
 	struct cxl_region *cxlr = to_cxl_region(dev);
@@ -2144,6 +2609,18 @@ static int cxl_region_probe(struct device *dev)
 	switch (cxlr->mode) {
 	case CXL_DECODER_PMEM:
 		return devm_cxl_add_pmem_region(cxlr);
+	case CXL_DECODER_RAM:
+		/*
+		 * The region can not be manged by CXL if any portion of
+		 * it is already online as 'System RAM'
+		 */
+		if (walk_iomem_res_desc(IORES_DESC_NONE,
+					IORESOURCE_SYSTEM_RAM | IORESOURCE_BUSY,
+					p->res->start, p->res->end, cxlr,
+					is_system_ram) > 0)
+			return 0;
+		dev_dbg(dev, "TODO: hookup devdax\n");
+		return 0;
 	default:
 		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
 			cxlr->mode);
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index ca76879af1de..c8ee4bb8cce6 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -261,6 +261,8 @@ resource_size_t cxl_rcrb_to_component(struct device *dev,
  * cxl_decoder flags that define the type of memory / devices this
  * decoder supports as well as configuration lock status See "CXL 2.0
  * 8.2.5.12.7 CXL HDM Decoder 0 Control Register" for details.
+ * Additionally indicate whether decoder settings were autodetected,
+ * user customized.
  */
 #define CXL_DECODER_F_RAM   BIT(0)
 #define CXL_DECODER_F_PMEM  BIT(1)
@@ -334,12 +336,22 @@ static inline const char *cxl_decoder_mode_name(enum cxl_decoder_mode mode)
 	return "mixed";
 }
 
+/*
+ * Track whether this decoder is reserved for region autodiscovery, or
+ * free for userspace provisioning.
+ */
+enum cxl_decoder_state {
+	CXL_DECODER_STATE_MANUAL,
+	CXL_DECODER_STATE_AUTO,
+};
+
 /**
  * struct cxl_endpoint_decoder - Endpoint  / SPA to DPA decoder
  * @cxld: base cxl_decoder_object
  * @dpa_res: actively claimed DPA span of this decoder
  * @skip: offset into @dpa_res where @cxld.hpa_range maps
  * @mode: which memory type / access-mode-partition this decoder targets
+ * @state: autodiscovery state
  * @pos: interleave position in @cxld.region
  */
 struct cxl_endpoint_decoder {
@@ -347,6 +359,7 @@ struct cxl_endpoint_decoder {
 	struct resource *dpa_res;
 	resource_size_t skip;
 	enum cxl_decoder_mode mode;
+	enum cxl_decoder_state state;
 	int pos;
 };
 
@@ -380,6 +393,7 @@ typedef struct cxl_dport *(*cxl_calc_hb_fn)(struct cxl_root_decoder *cxlrd,
  * @region_id: region id for next region provisioning event
  * @calc_hb: which host bridge covers the n'th position by granularity
  * @platform_data: platform specific configuration data
+ * @range_lock: sync region autodiscovery by address range
  * @cxlsd: base cxl switch decoder
  */
 struct cxl_root_decoder {
@@ -387,6 +401,7 @@ struct cxl_root_decoder {
 	atomic_t region_id;
 	cxl_calc_hb_fn calc_hb;
 	void *platform_data;
+	struct mutex range_lock;
 	struct cxl_switch_decoder cxlsd;
 };
 
@@ -436,6 +451,13 @@ struct cxl_region_params {
  */
 #define CXL_REGION_F_INCOHERENT 0
 
+/*
+ * Indicate whether this region has been assembled by autodetection or
+ * userspace assembly. Prevent endpoint decoders outside of automatic
+ * detection from being added to the region.
+ */
+#define CXL_REGION_F_AUTO 1
+
 /**
  * struct cxl_region - CXL region
  * @dev: This region's device
@@ -699,6 +721,8 @@ struct cxl_nvdimm_bridge *cxl_find_nvdimm_bridge(struct device *dev);
 #ifdef CONFIG_CXL_REGION
 bool is_cxl_pmem_region(struct device *dev);
 struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev);
+int cxl_add_to_region(struct cxl_port *root,
+		      struct cxl_endpoint_decoder *cxled);
 #else
 static inline bool is_cxl_pmem_region(struct device *dev)
 {
@@ -708,6 +732,11 @@ static inline struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev)
 {
 	return NULL;
 }
+static inline int cxl_add_to_region(struct cxl_port *root,
+				    struct cxl_endpoint_decoder *cxled)
+{
+	return 0;
+}
 #endif
 
 /*
diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
index a8d46a67b45e..d88518836c2d 100644
--- a/drivers/cxl/port.c
+++ b/drivers/cxl/port.c
@@ -30,6 +30,34 @@ static void schedule_detach(void *cxlmd)
 	schedule_cxl_memdev_detach(cxlmd);
 }
 
+static int discover_region(struct device *dev, void *root)
+{
+	struct cxl_endpoint_decoder *cxled;
+	int rc;
+
+	if (!is_endpoint_decoder(dev))
+		return 0;
+
+	cxled = to_cxl_endpoint_decoder(dev);
+	if ((cxled->cxld.flags & CXL_DECODER_F_ENABLE) == 0)
+		return 0;
+
+	if (cxled->state != CXL_DECODER_STATE_AUTO)
+		return 0;
+
+	/*
+	 * Region enumeration is opportunistic, if this add-event fails,
+	 * continue to the next endpoint decoder.
+	 */
+	rc = cxl_add_to_region(root, cxled);
+	if (rc)
+		dev_dbg(dev, "failed to add to region: %#llx-%#llx\n",
+			cxled->cxld.hpa_range.start, cxled->cxld.hpa_range.end);
+
+	return 0;
+}
+
+
 static int cxl_switch_port_probe(struct cxl_port *port)
 {
 	struct cxl_hdm *cxlhdm;
@@ -54,6 +82,7 @@ static int cxl_endpoint_port_probe(struct cxl_port *port)
 	struct cxl_memdev *cxlmd = to_cxl_memdev(port->uport);
 	struct cxl_dev_state *cxlds = cxlmd->cxlds;
 	struct cxl_hdm *cxlhdm;
+	struct cxl_port *root;
 	int rc;
 
 	cxlhdm = devm_cxl_setup_hdm(port);
@@ -78,7 +107,24 @@ static int cxl_endpoint_port_probe(struct cxl_port *port)
 		return rc;
 	}
 
-	return devm_cxl_enumerate_decoders(cxlhdm);
+	rc = devm_cxl_enumerate_decoders(cxlhdm);
+	if (rc)
+		return rc;
+
+	/*
+	 * This can't fail in practice as CXL root exit unregisters all
+	 * descendant ports and that in turn synchronizes with cxl_port_probe()
+	 */
+	root = find_cxl_root(&cxlmd->dev);
+
+	/*
+	 * Now that all endpoint decoders are successfully enumerated, try to
+	 * assemble regions from committed decoders
+	 */
+	device_for_each_child(&port->dev, root, discover_region);
+	put_device(&root->dev);
+
+	return 0;
 }
 
 static int cxl_port_probe(struct device *dev)


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C7138C636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:04 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231788AbjBJJIE (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:04 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40042 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231807AbjBJJHF (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:07:05 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C24CC10D5;
        Fri, 10 Feb 2023 01:06:46 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020006; x=1707556006;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=rZ3O3B8mdY6zXcZ47a8wBl453HTwxqIFLhvZISKfgJs=;
  b=fm/xyL7oCJh5Xb/uBZ7561gSKxsCPNUZLdAzX5c8t+jWN19PqUPpruj6
   eOxHVFhtWSy4l5D34ABFF5bBGb5Q/bWrvBOJM8/jtFUW+MdIg9LyWE16N
   bmBAn9tXBF0SsEnrGEEzcMlVHbDzvhsJSbcr/iCE0WDQoBc7llzyvqVFh
   OXOrTyQ8TYB81O5COMLADcyicN+QFk2Opb9OAtUUXI/iILWPGxJMPX0In
   EJp3ARYnLJK/jS4jhYqpwthWUgeDI2PT24T5qTQGFeDgu269SOBo2/q6U
   pcE+3ZKnrgjYsMjsL0+0WKrTzCpo5XJ+E57CxU36P5ztU5WsBRVZYCFYQ
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="328062566"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="328062566"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:46 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="700392672"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="700392672"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:45 -0800
Subject: [PATCH v2 14/20] tools/testing/cxl: Define a fixed volatile
 configuration to parse
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:45 -0800
Message-ID: <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Take two endpoints attached to the first switch on the first host-bridge
in the cxl_test topology and define a pre-initialized region. This is a
x2 interleave underneath a x1 CXL Window.

$ modprobe cxl_test
$ # cxl list -Ru
{
  "region":"region3",
  "resource":"0xf010000000",
  "size":"512.00 MiB (536.87 MB)",
  "interleave_ways":2,
  "interleave_granularity":4096,
  "decode_state":"commit"
}

Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564541523.847146.12199636368812381475.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/cxl/core/core.h      |    3 -
 drivers/cxl/core/hdm.c       |    3 +
 drivers/cxl/core/port.c      |    2 +
 drivers/cxl/cxl.h            |    2 +
 drivers/cxl/cxlmem.h         |    3 +
 tools/testing/cxl/test/cxl.c |  147 +++++++++++++++++++++++++++++++++++++++---
 6 files changed, 146 insertions(+), 14 deletions(-)

diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index 5eb873da5a30..479f01da6d35 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -57,9 +57,6 @@ resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
 resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
 extern struct rw_semaphore cxl_dpa_rwsem;
 
-bool is_switch_decoder(struct device *dev);
-struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
-
 int cxl_memdev_init(void);
 void cxl_memdev_exit(void);
 void cxl_mbox_init(void);
diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
index 8c29026a4b9d..80eccae6ba9e 100644
--- a/drivers/cxl/core/hdm.c
+++ b/drivers/cxl/core/hdm.c
@@ -279,7 +279,7 @@ static int __cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
 	return 0;
 }
 
-static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
+int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
 				resource_size_t base, resource_size_t len,
 				resource_size_t skipped)
 {
@@ -295,6 +295,7 @@ static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
 
 	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
 }
+EXPORT_SYMBOL_NS_GPL(devm_cxl_dpa_reserve, CXL);
 
 resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled)
 {
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 59620528571a..b45d2796ef35 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -458,6 +458,7 @@ bool is_switch_decoder(struct device *dev)
 {
 	return is_root_decoder(dev) || dev->type == &cxl_decoder_switch_type;
 }
+EXPORT_SYMBOL_NS_GPL(is_switch_decoder, CXL);
 
 struct cxl_decoder *to_cxl_decoder(struct device *dev)
 {
@@ -485,6 +486,7 @@ struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev)
 		return NULL;
 	return container_of(dev, struct cxl_switch_decoder, cxld.dev);
 }
+EXPORT_SYMBOL_NS_GPL(to_cxl_switch_decoder, CXL);
 
 static void cxl_ep_release(struct cxl_ep *ep)
 {
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index c8ee4bb8cce6..2ac344235235 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -653,8 +653,10 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
 
 struct cxl_decoder *to_cxl_decoder(struct device *dev);
 struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
+struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
 struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
 bool is_root_decoder(struct device *dev);
+bool is_switch_decoder(struct device *dev);
 bool is_endpoint_decoder(struct device *dev);
 struct cxl_root_decoder *cxl_root_decoder_alloc(struct cxl_port *port,
 						unsigned int nr_targets,
diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
index c9da3c699a21..bf7d4c5c8612 100644
--- a/drivers/cxl/cxlmem.h
+++ b/drivers/cxl/cxlmem.h
@@ -81,6 +81,9 @@ static inline bool is_cxl_endpoint(struct cxl_port *port)
 }
 
 struct cxl_memdev *devm_cxl_add_memdev(struct cxl_dev_state *cxlds);
+int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
+			 resource_size_t base, resource_size_t len,
+			 resource_size_t skipped);
 
 static inline struct cxl_ep *cxl_ep_load(struct cxl_port *port,
 					 struct cxl_memdev *cxlmd)
diff --git a/tools/testing/cxl/test/cxl.c b/tools/testing/cxl/test/cxl.c
index 920bd969c554..5342f69d70d2 100644
--- a/tools/testing/cxl/test/cxl.c
+++ b/tools/testing/cxl/test/cxl.c
@@ -703,6 +703,142 @@ static int mock_decoder_reset(struct cxl_decoder *cxld)
 	return 0;
 }
 
+static void default_mock_decoder(struct cxl_decoder *cxld)
+{
+	cxld->hpa_range = (struct range){
+		.start = 0,
+		.end = -1,
+	};
+
+	cxld->interleave_ways = 1;
+	cxld->interleave_granularity = 256;
+	cxld->target_type = CXL_DECODER_EXPANDER;
+	cxld->commit = mock_decoder_commit;
+	cxld->reset = mock_decoder_reset;
+}
+
+static int first_decoder(struct device *dev, void *data)
+{
+	struct cxl_decoder *cxld;
+
+	if (!is_switch_decoder(dev))
+		return 0;
+	cxld = to_cxl_decoder(dev);
+	if (cxld->id == 0)
+		return 1;
+	return 0;
+}
+
+static void mock_init_hdm_decoder(struct cxl_decoder *cxld)
+{
+	struct acpi_cedt_cfmws *window = mock_cfmws[0];
+	struct platform_device *pdev = NULL;
+	struct cxl_endpoint_decoder *cxled;
+	struct cxl_switch_decoder *cxlsd;
+	struct cxl_port *port, *iter;
+	const int size = SZ_512M;
+	struct cxl_memdev *cxlmd;
+	struct cxl_dport *dport;
+	struct device *dev;
+	bool hb0 = false;
+	u64 base;
+	int i;
+
+	if (is_endpoint_decoder(&cxld->dev)) {
+		cxled = to_cxl_endpoint_decoder(&cxld->dev);
+		cxlmd = cxled_to_memdev(cxled);
+		WARN_ON(!dev_is_platform(cxlmd->dev.parent));
+		pdev = to_platform_device(cxlmd->dev.parent);
+
+		/* check is endpoint is attach to host-bridge0 */
+		port = cxled_to_port(cxled);
+		do {
+			if (port->uport == &cxl_host_bridge[0]->dev) {
+				hb0 = true;
+				break;
+			}
+			if (is_cxl_port(port->dev.parent))
+				port = to_cxl_port(port->dev.parent);
+			else
+				port = NULL;
+		} while (port);
+		port = cxled_to_port(cxled);
+	}
+
+	/*
+	 * The first decoder on the first 2 devices on the first switch
+	 * attached to host-bridge0 mock a fake / static RAM region. All
+	 * other decoders are default disabled. Given the round robin
+	 * assignment those devices are named cxl_mem.0, and cxl_mem.4.
+	 *
+	 * See 'cxl list -BMPu -m cxl_mem.0,cxl_mem.4'
+	 */
+	if (!hb0 || pdev->id % 4 || pdev->id > 4 || cxld->id > 0) {
+		default_mock_decoder(cxld);
+		return;
+	}
+
+	base = window->base_hpa;
+	cxld->hpa_range = (struct range) {
+		.start = base,
+		.end = base + size - 1,
+	};
+
+	cxld->interleave_ways = 2;
+	eig_to_granularity(window->granularity, &cxld->interleave_granularity);
+	cxld->target_type = CXL_DECODER_EXPANDER;
+	cxld->flags = CXL_DECODER_F_ENABLE;
+	cxled->state = CXL_DECODER_STATE_AUTO;
+	port->commit_end = cxld->id;
+	devm_cxl_dpa_reserve(cxled, 0, size / cxld->interleave_ways, 0);
+	cxld->commit = mock_decoder_commit;
+	cxld->reset = mock_decoder_reset;
+
+	/*
+	 * Now that endpoint decoder is set up, walk up the hierarchy
+	 * and setup the switch and root port decoders targeting @cxlmd.
+	 */
+	iter = port;
+	for (i = 0; i < 2; i++) {
+		dport = iter->parent_dport;
+		iter = dport->port;
+		dev = device_find_child(&iter->dev, NULL, first_decoder);
+		/*
+		 * Ancestor ports are guaranteed to be enumerated before
+		 * @port, and all ports have at least one decoder.
+		 */
+		if (WARN_ON(!dev))
+			continue;
+		cxlsd = to_cxl_switch_decoder(dev);
+		if (i == 0) {
+			/* put cxl_mem.4 second in the decode order */
+			if (pdev->id == 4)
+				cxlsd->target[1] = dport;
+			else
+				cxlsd->target[0] = dport;
+		} else
+			cxlsd->target[0] = dport;
+		cxld = &cxlsd->cxld;
+		cxld->target_type = CXL_DECODER_EXPANDER;
+		cxld->flags = CXL_DECODER_F_ENABLE;
+		iter->commit_end = 0;
+		/*
+		 * Switch targets 2 endpoints, while host bridge targets
+		 * one root port
+		 */
+		if (i == 0)
+			cxld->interleave_ways = 2;
+		else
+			cxld->interleave_ways = 1;
+		cxld->interleave_granularity = 256;
+		cxld->hpa_range = (struct range) {
+			.start = base,
+			.end = base + size - 1,
+		};
+		put_device(dev);
+	}
+}
+
 static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
 {
 	struct cxl_port *port = cxlhdm->port;
@@ -748,16 +884,7 @@ static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
 			cxld = &cxled->cxld;
 		}
 
-		cxld->hpa_range = (struct range) {
-			.start = 0,
-			.end = -1,
-		};
-
-		cxld->interleave_ways = min_not_zero(target_count, 1);
-		cxld->interleave_granularity = SZ_4K;
-		cxld->target_type = CXL_DECODER_EXPANDER;
-		cxld->commit = mock_decoder_commit;
-		cxld->reset = mock_decoder_reset;
+		mock_init_hdm_decoder(cxld);
 
 		if (target_count) {
 			rc = device_for_each_child(port->uport, &ctx,


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B16A4C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:13 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231628AbjBJJIM (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:12 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39248 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231863AbjBJJHc (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:07:32 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3152BDBDF;
        Fri, 10 Feb 2023 01:06:53 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020013; x=1707556013;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=Kiq8SiWxreJ/WplvYfP6rIo46j43k+e9EnBH+6Fzm+Q=;
  b=L2BSlSYB+kESKX/5othgWdaeXwqbvFYTDA3nSKCx425ekiJubiWR2IS/
   UZF/hzfKT54qhEIDUUFCERkJaHY6Itk9JfI9Qh4jn/Ao6Sp42jJJ8y8Ui
   FMYF75+WyVUJX1/wXug49r1z0+TNRUjACY9tRj6lzYODUiVm2F07l9Smv
   GfbenDy/5GVOnZuWTKSi06Mh4l30rPZhxC9XHQrK51qv4dZEs2FSZeAd8
   OEr3n/eBgixzS9ocRtJXOvBuNxo34iuNQcTpg7hhuYQKu4qteYSG8k0Es
   j5zfXWN727pNhPyv7HN1xuuZFFRE7aDUp2JJAtNU7nVWwrZU2lipMsy3g
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="328062586"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="328062586"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:52 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="700392732"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="700392732"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:51 -0800
Subject: [PATCH v2 15/20] dax/hmem: Move HMAT and Soft reservation probe
 initcall level
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:51 -0800
Message-ID: <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for moving more filtering of "hmem" ranges into the
dax_hmem.ko module, update the initcall levels. HMAT range registration
moves to subsys_initcall() to be done before Soft Reservation probing,
and Soft Reservation probing is moved to device_initcall() to be done
before dax_hmem.ko initialization if it is built-in.

Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564542109.847146.10113972881782419363.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/acpi/numa/hmat.c  |    2 +-
 drivers/dax/hmem/Makefile |    3 ++-
 drivers/dax/hmem/device.c |    2 +-
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/acpi/numa/hmat.c b/drivers/acpi/numa/hmat.c
index 605a0c7053be..ff24282301ab 100644
--- a/drivers/acpi/numa/hmat.c
+++ b/drivers/acpi/numa/hmat.c
@@ -869,4 +869,4 @@ static __init int hmat_init(void)
 	acpi_put_table(tbl);
 	return 0;
 }
-device_initcall(hmat_init);
+subsys_initcall(hmat_init);
diff --git a/drivers/dax/hmem/Makefile b/drivers/dax/hmem/Makefile
index 57377b4c3d47..d4c4cd6bccd7 100644
--- a/drivers/dax/hmem/Makefile
+++ b/drivers/dax/hmem/Makefile
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
-obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
+# device_hmem.o deliberately precedes dax_hmem.o for initcall ordering
 obj-$(CONFIG_DEV_DAX_HMEM_DEVICES) += device_hmem.o
+obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
 
 device_hmem-y := device.o
 dax_hmem-y := hmem.o
diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
index 903325aac991..20749c7fab81 100644
--- a/drivers/dax/hmem/device.c
+++ b/drivers/dax/hmem/device.c
@@ -104,4 +104,4 @@ static __init int hmem_init(void)
  * As this is a fallback for address ranges unclaimed by the ACPI HMAT
  * parsing it must be at an initcall level greater than hmat_init().
  */
-late_initcall(hmem_init);
+device_initcall(hmem_init);


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 25254C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:22 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231329AbjBJJIU (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:20 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39868 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231920AbjBJJHj (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:07:39 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 79A4123C4B;
        Fri, 10 Feb 2023 01:06:57 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020021; x=1707556021;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=M0vAv81xsakge/rDyjzGZncp54zlO+3hec2ycZsFjWQ=;
  b=n6zGVQFN0jAQQSUJ5RydnkU/ABHiehvVwNv7cT5dsVJJrvmlsgFruxm+
   1GLG6PSRIh/8ufbfm14djICUv/9Gy2DbaQmUIJzWHy/bJXo4KpsmaDpFD
   pvaUm/FhiUqjFjNZC4ztmOLUhBL2exHEeOLmfwYjIVwXPVrupNTPzqqMT
   WU5V3HVEniSIDuAwOFA85So+wPtb8C7Ugg5eFYDG09qUSPWc+CrvtPhzt
   PkGk2Y9voRWQvFU8S57h6rOdtW5G1gAz8Fa9MhqQddElj193iiVYU0DKC
   6QYrjpNLBa9fLNmB2U4DK5xuYDaIFYR5Fozl1fB9HVHxiftZVFZ+grrAi
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="328062605"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="328062605"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:57 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="700392810"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="700392810"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:06:56 -0800
Subject: [PATCH v2 16/20] dax/hmem: Drop unnecessary dax_hmem_remove()
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:06:56 -0800
Message-ID: <167602001664.1924368.9102029637928071240.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Empty driver remove callbacks can just be elided.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564542679.847146.17174404738816053065.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/dax/hmem/hmem.c |    7 -------
 1 file changed, 7 deletions(-)

diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
index 1bf040dbc834..c7351e0dc8ff 100644
--- a/drivers/dax/hmem/hmem.c
+++ b/drivers/dax/hmem/hmem.c
@@ -44,15 +44,8 @@ static int dax_hmem_probe(struct platform_device *pdev)
 	return 0;
 }
 
-static int dax_hmem_remove(struct platform_device *pdev)
-{
-	/* devm handles teardown */
-	return 0;
-}
-
 static struct platform_driver dax_hmem_driver = {
 	.probe = dax_hmem_probe,
-	.remove = dax_hmem_remove,
 	.driver = {
 		.name = "hmem",
 	},


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8BF4AC636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231849AbjBJJIa (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:30 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39926 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231894AbjBJJHk (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:07:40 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4205F40E9;
        Fri, 10 Feb 2023 01:07:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020023; x=1707556023;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=fsFyJVK/yMU8PeF2io/JqvsaT5S0XIoYNB1iom5H8o0=;
  b=JpzUwbbIq7mBgQ76cYlGttvVrllYFRZIMo2utqs504MfwtOzmIKGk11s
   9zvC9MDsNi3qJaHVmgZMRyLPlUnDrQhJ03Kv127dIlpjhFW65/EAeem3L
   9FLvsfClekL6jF6VFRsRJdaPjAmXbnuNjgQQX2NnNAjjDXkaXuwv5MQ1X
   nsp+nMGUelTNnT4+autqwJzpZRMsq7PHYjD8kQsCf7kX+77vvJJIMm5Rv
   CE2voMLjtpZny5aR37vgxgQWqMEJu5H4ejPdjBE2G6B41jWxKKS9s2cKI
   9dsrk7Z/dXQvQBLj+cMXJpBiAgojgurO9G2qYBVaA09CAPY757JJ7wXRi
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="328062621"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="328062621"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:02 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="700392901"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="700392901"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:02 -0800
Subject: [PATCH v2 17/20] dax/hmem: Convey the dax range via memregion_info()
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:07:02 -0800
Message-ID: <167602002217.1924368.7036275892522551624.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for hmem platform devices to be unregistered, stop using
platform_device_add_resources() to convey the address range. The
platform_device_add_resources() API causes an existing "Soft Reserved"
iomem resource to be re-parented under an inserted platform device
resource. When that platform device is deleted it removes the platform
device resource and all children.

Instead, it is sufficient to convey just the address range and let
request_mem_region() insert resources to indicate the devices active in
the range. This allows the "Soft Reserved" resource to be re-enumerated
upon the next probe event.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564543303.847146.11045895213318648441.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/dax/hmem/device.c |   37 ++++++++++++++-----------------------
 drivers/dax/hmem/hmem.c   |   14 +++-----------
 include/linux/memregion.h |    2 ++
 3 files changed, 19 insertions(+), 34 deletions(-)

diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
index 20749c7fab81..b1b339bccfe5 100644
--- a/drivers/dax/hmem/device.c
+++ b/drivers/dax/hmem/device.c
@@ -15,15 +15,8 @@ static struct resource hmem_active = {
 	.flags = IORESOURCE_MEM,
 };
 
-void hmem_register_device(int target_nid, struct resource *r)
+void hmem_register_device(int target_nid, struct resource *res)
 {
-	/* define a clean / non-busy resource for the platform device */
-	struct resource res = {
-		.start = r->start,
-		.end = r->end,
-		.flags = IORESOURCE_MEM,
-		.desc = IORES_DESC_SOFT_RESERVED,
-	};
 	struct platform_device *pdev;
 	struct memregion_info info;
 	int rc, id;
@@ -31,55 +24,53 @@ void hmem_register_device(int target_nid, struct resource *r)
 	if (nohmem)
 		return;
 
-	rc = region_intersects(res.start, resource_size(&res), IORESOURCE_MEM,
-			IORES_DESC_SOFT_RESERVED);
+	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
+			       IORES_DESC_SOFT_RESERVED);
 	if (rc != REGION_INTERSECTS)
 		return;
 
 	id = memregion_alloc(GFP_KERNEL);
 	if (id < 0) {
-		pr_err("memregion allocation failure for %pr\n", &res);
+		pr_err("memregion allocation failure for %pr\n", res);
 		return;
 	}
 
 	pdev = platform_device_alloc("hmem", id);
 	if (!pdev) {
-		pr_err("hmem device allocation failure for %pr\n", &res);
+		pr_err("hmem device allocation failure for %pr\n", res);
 		goto out_pdev;
 	}
 
-	if (!__request_region(&hmem_active, res.start, resource_size(&res),
+	if (!__request_region(&hmem_active, res->start, resource_size(res),
 			      dev_name(&pdev->dev), 0)) {
-		dev_dbg(&pdev->dev, "hmem range %pr already active\n", &res);
+		dev_dbg(&pdev->dev, "hmem range %pr already active\n", res);
 		goto out_active;
 	}
 
 	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
 	info = (struct memregion_info) {
 		.target_node = target_nid,
+		.range = {
+			.start = res->start,
+			.end = res->end,
+		},
 	};
 	rc = platform_device_add_data(pdev, &info, sizeof(info));
 	if (rc < 0) {
-		pr_err("hmem memregion_info allocation failure for %pr\n", &res);
-		goto out_resource;
-	}
-
-	rc = platform_device_add_resources(pdev, &res, 1);
-	if (rc < 0) {
-		pr_err("hmem resource allocation failure for %pr\n", &res);
+		pr_err("hmem memregion_info allocation failure for %pr\n", res);
 		goto out_resource;
 	}
 
 	rc = platform_device_add(pdev);
 	if (rc < 0) {
-		dev_err(&pdev->dev, "device add failed for %pr\n", &res);
+		dev_err(&pdev->dev, "device add failed for %pr\n", res);
 		goto out_resource;
 	}
 
 	return;
 
 out_resource:
-	__release_region(&hmem_active, res.start, resource_size(&res));
+	__release_region(&hmem_active, res->start, resource_size(res));
 out_active:
 	platform_device_put(pdev);
 out_pdev:
diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
index c7351e0dc8ff..5025a8c9850b 100644
--- a/drivers/dax/hmem/hmem.c
+++ b/drivers/dax/hmem/hmem.c
@@ -15,25 +15,17 @@ static int dax_hmem_probe(struct platform_device *pdev)
 	struct memregion_info *mri;
 	struct dev_dax_data data;
 	struct dev_dax *dev_dax;
-	struct resource *res;
-	struct range range;
-
-	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
-	if (!res)
-		return -ENOMEM;
 
 	mri = dev->platform_data;
-	range.start = res->start;
-	range.end = res->end;
-	dax_region = alloc_dax_region(dev, pdev->id, &range, mri->target_node,
-			PMD_SIZE, 0);
+	dax_region = alloc_dax_region(dev, pdev->id, &mri->range,
+				      mri->target_node, PMD_SIZE, 0);
 	if (!dax_region)
 		return -ENOMEM;
 
 	data = (struct dev_dax_data) {
 		.dax_region = dax_region,
 		.id = -1,
-		.size = region_idle ? 0 : resource_size(res),
+		.size = region_idle ? 0 : range_len(&mri->range),
 	};
 	dev_dax = devm_create_dev_dax(&data);
 	if (IS_ERR(dev_dax))
diff --git a/include/linux/memregion.h b/include/linux/memregion.h
index bf83363807ac..c01321467789 100644
--- a/include/linux/memregion.h
+++ b/include/linux/memregion.h
@@ -3,10 +3,12 @@
 #define _MEMREGION_H_
 #include <linux/types.h>
 #include <linux/errno.h>
+#include <linux/range.h>
 #include <linux/bug.h>
 
 struct memregion_info {
 	int target_node;
+	struct range range;
 };
 
 #ifdef CONFIG_MEMREGION


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 80E48C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:38 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231777AbjBJJIh (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:37 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40026 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231779AbjBJJIC (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:08:02 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8705730B1D;
        Fri, 10 Feb 2023 01:07:09 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020029; x=1707556029;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=yz6quCcaJ6esd5lp1w4m7/rotepEpujCREL7aGBC9MI=;
  b=GZOR9hvZFKZabo8OAq4ZJ8BIIGatBl0sesQrSTqJiQKOyy5or0CncQhc
   BAld/n12a3gRTUjV0FzqupHUCgdmkvxyF9FwBaCL3Eunw/7UUKtftcCk5
   888XHGMhkhx/zfDky+xpsmhLE1Qv9PimraHILoQf6/Q+3U7tKN8WvItUu
   TpjRm+wP/YGGkiwu4fdqj45DSMREfPBzkN1vRezZbJjJ/asPasipxwpTM
   18wBMemjLew+wM7NJJd9GsGJWDPDnMussUj1IdD75ww1Nhv65XUVxkIi8
   2z9p7JKNjV8U8cjtamQiatFdjNTXwFy5Q0hNJgRT60KwXZ/pZI7T+kCbj
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="328062647"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="328062647"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:08 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="700392965"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="700392965"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:08 -0800
Subject: [PATCH v2 18/20] dax/hmem: Move hmem device registration to
 dax_hmem.ko
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:07:07 -0800
Message-ID: <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

In preparation for the CXL region driver to take over the responsibility
of registering device-dax instances for CXL regions, move the
registration of "hmem" devices to dax_hmem.ko.

Previously the builtin component of this enabling
(drivers/dax/hmem/device.o) would register platform devices for each
address range and trigger the dax_hmem.ko module to load and attach
device-dax instances to those devices. Now, the ranges are collected
from the HMAT and EFI memory map walking, but the device creation is
deferred. A new "hmem_platform" device is created which triggers
dax_hmem.ko to load and register the platform devices.

Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564543923.847146.9030380223622044744.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/acpi/numa/hmat.c  |    2 -
 drivers/dax/Kconfig       |    2 -
 drivers/dax/hmem/device.c |   91 +++++++++++++++++++--------------------
 drivers/dax/hmem/hmem.c   |  105 +++++++++++++++++++++++++++++++++++++++++++++
 include/linux/dax.h       |    7 ++-
 5 files changed, 155 insertions(+), 52 deletions(-)

diff --git a/drivers/acpi/numa/hmat.c b/drivers/acpi/numa/hmat.c
index ff24282301ab..bba268ecd802 100644
--- a/drivers/acpi/numa/hmat.c
+++ b/drivers/acpi/numa/hmat.c
@@ -718,7 +718,7 @@ static void hmat_register_target_devices(struct memory_target *target)
 	for (res = target->memregions.child; res; res = res->sibling) {
 		int target_nid = pxm_to_node(target->memory_pxm);
 
-		hmem_register_device(target_nid, res);
+		hmem_register_resource(target_nid, res);
 	}
 }
 
diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
index 5fdf269a822e..d13c889c2a64 100644
--- a/drivers/dax/Kconfig
+++ b/drivers/dax/Kconfig
@@ -46,7 +46,7 @@ config DEV_DAX_HMEM
 	  Say M if unsure.
 
 config DEV_DAX_HMEM_DEVICES
-	depends on DEV_DAX_HMEM && DAX=y
+	depends on DEV_DAX_HMEM && DAX
 	def_bool y
 
 config DEV_DAX_KMEM
diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
index b1b339bccfe5..f9e1a76a04a9 100644
--- a/drivers/dax/hmem/device.c
+++ b/drivers/dax/hmem/device.c
@@ -8,6 +8,8 @@
 static bool nohmem;
 module_param_named(disable, nohmem, bool, 0444);
 
+static bool platform_initialized;
+static DEFINE_MUTEX(hmem_resource_lock);
 static struct resource hmem_active = {
 	.name = "HMEM devices",
 	.start = 0,
@@ -15,71 +17,66 @@ static struct resource hmem_active = {
 	.flags = IORESOURCE_MEM,
 };
 
-void hmem_register_device(int target_nid, struct resource *res)
+int walk_hmem_resources(struct device *host, walk_hmem_fn fn)
+{
+	struct resource *res;
+	int rc = 0;
+
+	mutex_lock(&hmem_resource_lock);
+	for (res = hmem_active.child; res; res = res->sibling) {
+		rc = fn(host, (int) res->desc, res);
+		if (rc)
+			break;
+	}
+	mutex_unlock(&hmem_resource_lock);
+	return rc;
+}
+EXPORT_SYMBOL_GPL(walk_hmem_resources);
+
+static void __hmem_register_resource(int target_nid, struct resource *res)
 {
 	struct platform_device *pdev;
-	struct memregion_info info;
-	int rc, id;
+	struct resource *new;
+	int rc;
 
-	if (nohmem)
+	new = __request_region(&hmem_active, res->start, resource_size(res), "",
+			       0);
+	if (!new) {
+		pr_debug("hmem range %pr already active\n", res);
 		return;
+	}
 
-	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
-			       IORES_DESC_SOFT_RESERVED);
-	if (rc != REGION_INTERSECTS)
-		return;
+	new->desc = target_nid;
 
-	id = memregion_alloc(GFP_KERNEL);
-	if (id < 0) {
-		pr_err("memregion allocation failure for %pr\n", res);
+	if (platform_initialized)
 		return;
-	}
 
-	pdev = platform_device_alloc("hmem", id);
+	pdev = platform_device_alloc("hmem_platform", 0);
 	if (!pdev) {
-		pr_err("hmem device allocation failure for %pr\n", res);
-		goto out_pdev;
-	}
-
-	if (!__request_region(&hmem_active, res->start, resource_size(res),
-			      dev_name(&pdev->dev), 0)) {
-		dev_dbg(&pdev->dev, "hmem range %pr already active\n", res);
-		goto out_active;
-	}
-
-	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
-	info = (struct memregion_info) {
-		.target_node = target_nid,
-		.range = {
-			.start = res->start,
-			.end = res->end,
-		},
-	};
-	rc = platform_device_add_data(pdev, &info, sizeof(info));
-	if (rc < 0) {
-		pr_err("hmem memregion_info allocation failure for %pr\n", res);
-		goto out_resource;
+		pr_err_once("failed to register device-dax hmem_platform device\n");
+		return;
 	}
 
 	rc = platform_device_add(pdev);
-	if (rc < 0) {
-		dev_err(&pdev->dev, "device add failed for %pr\n", res);
-		goto out_resource;
-	}
+	if (rc)
+		platform_device_put(pdev);
+	else
+		platform_initialized = true;
+}
 
-	return;
+void hmem_register_resource(int target_nid, struct resource *res)
+{
+	if (nohmem)
+		return;
 
-out_resource:
-	__release_region(&hmem_active, res->start, resource_size(res));
-out_active:
-	platform_device_put(pdev);
-out_pdev:
-	memregion_free(id);
+	mutex_lock(&hmem_resource_lock);
+	__hmem_register_resource(target_nid, res);
+	mutex_unlock(&hmem_resource_lock);
 }
 
 static __init int hmem_register_one(struct resource *res, void *data)
 {
-	hmem_register_device(phys_to_target_node(res->start), res);
+	hmem_register_resource(phys_to_target_node(res->start), res);
 
 	return 0;
 }
diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
index 5025a8c9850b..e7bdff3132fa 100644
--- a/drivers/dax/hmem/hmem.c
+++ b/drivers/dax/hmem/hmem.c
@@ -3,6 +3,7 @@
 #include <linux/memregion.h>
 #include <linux/module.h>
 #include <linux/pfn_t.h>
+#include <linux/dax.h>
 #include "../bus.h"
 
 static bool region_idle;
@@ -43,8 +44,110 @@ static struct platform_driver dax_hmem_driver = {
 	},
 };
 
-module_platform_driver(dax_hmem_driver);
+static void release_memregion(void *data)
+{
+	memregion_free((long) data);
+}
+
+static void release_hmem(void *pdev)
+{
+	platform_device_unregister(pdev);
+}
+
+static int hmem_register_device(struct device *host, int target_nid,
+				const struct resource *res)
+{
+	struct platform_device *pdev;
+	struct memregion_info info;
+	long id;
+	int rc;
+
+	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
+			       IORES_DESC_SOFT_RESERVED);
+	if (rc != REGION_INTERSECTS)
+		return 0;
+
+	id = memregion_alloc(GFP_KERNEL);
+	if (id < 0) {
+		dev_err(host, "memregion allocation failure for %pr\n", res);
+		return -ENOMEM;
+	}
+	rc = devm_add_action_or_reset(host, release_memregion, (void *) id);
+	if (rc)
+		return rc;
+
+	pdev = platform_device_alloc("hmem", id);
+	if (!pdev) {
+		dev_err(host, "device allocation failure for %pr\n", res);
+		return -ENOMEM;
+	}
+
+	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
+	info = (struct memregion_info) {
+		.target_node = target_nid,
+		.range = {
+			.start = res->start,
+			.end = res->end,
+		},
+	};
+	rc = platform_device_add_data(pdev, &info, sizeof(info));
+	if (rc < 0) {
+		dev_err(host, "memregion_info allocation failure for %pr\n",
+		       res);
+		goto out_put;
+	}
+
+	rc = platform_device_add(pdev);
+	if (rc < 0) {
+		dev_err(host, "%s add failed for %pr\n", dev_name(&pdev->dev),
+			res);
+		goto out_put;
+	}
+
+	return devm_add_action_or_reset(host, release_hmem, pdev);
+
+out_put:
+	platform_device_put(pdev);
+	return rc;
+}
+
+static int dax_hmem_platform_probe(struct platform_device *pdev)
+{
+	return walk_hmem_resources(&pdev->dev, hmem_register_device);
+}
+
+static struct platform_driver dax_hmem_platform_driver = {
+	.probe = dax_hmem_platform_probe,
+	.driver = {
+		.name = "hmem_platform",
+	},
+};
+
+static __init int dax_hmem_init(void)
+{
+	int rc;
+
+	rc = platform_driver_register(&dax_hmem_platform_driver);
+	if (rc)
+		return rc;
+
+	rc = platform_driver_register(&dax_hmem_driver);
+	if (rc)
+		platform_driver_unregister(&dax_hmem_platform_driver);
+
+	return rc;
+}
+
+static __exit void dax_hmem_exit(void)
+{
+	platform_driver_unregister(&dax_hmem_driver);
+	platform_driver_unregister(&dax_hmem_platform_driver);
+}
+
+module_init(dax_hmem_init);
+module_exit(dax_hmem_exit);
 
 MODULE_ALIAS("platform:hmem*");
+MODULE_ALIAS("platform:hmem_platform*");
 MODULE_LICENSE("GPL v2");
 MODULE_AUTHOR("Intel Corporation");
diff --git a/include/linux/dax.h b/include/linux/dax.h
index 2b5ecb591059..bf6258472e49 100644
--- a/include/linux/dax.h
+++ b/include/linux/dax.h
@@ -262,11 +262,14 @@ static inline bool dax_mapping(struct address_space *mapping)
 }
 
 #ifdef CONFIG_DEV_DAX_HMEM_DEVICES
-void hmem_register_device(int target_nid, struct resource *r);
+void hmem_register_resource(int target_nid, struct resource *r);
 #else
-static inline void hmem_register_device(int target_nid, struct resource *r)
+static inline void hmem_register_resource(int target_nid, struct resource *r)
 {
 }
 #endif
 
+typedef int (*walk_hmem_fn)(struct device *dev, int target_nid,
+			    const struct resource *res);
+int walk_hmem_resources(struct device *dev, walk_hmem_fn fn);
 #endif


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5B8D4C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:08:48 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231929AbjBJJIr (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:08:47 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39248 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231603AbjBJJIL (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:08:11 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3B0065774F;
        Fri, 10 Feb 2023 01:07:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020035; x=1707556035;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=9J3LVeqpx/pEaciMjT7PQYSzPAi14MY2qHE7XN4c/uM=;
  b=mX2PuKEBmdw7+WAlGkfagoHaT47fGxQZ/tH/v55l3OZEwk7RNtteRhNk
   otHm7xZKshKW5JDnoaDGggNGra2s+BJ6mymlJ0AMacRniOBSjmeB+TGuE
   MyefR34Z3kmAZvtXGcKhsIHbAZo1C7UfPfB9/n+edIDjOu1SYc8pwoqsR
   QkbjCVX5tBaPV2TNIMm2pn3J0im/yvnm3DQbrQRgpjkpUqTBsyKKvc8eZ
   V4yWsfGZDQVkwvGmi77SzkdLeBk9sStWq9XUoIpp3OCP2B6lLxOA63R5M
   04f39B1wmX9nzvM77/qQ6VXK1x8zBzIgqeWK8fPBWIgtcvJRiJ5qM27Hr
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="310738835"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="310738835"
Received: from orsmga007.jf.intel.com ([10.7.209.58])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:14 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="661341213"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="661341213"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga007-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:13 -0800
Subject: [PATCH v2 19/20] dax: Assign RAM regions to memory-hotplug by
 default
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Michal Hocko <mhocko@suse.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:07:13 -0800
Message-ID: <167602003336.1924368.6809503401422267885.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

The default mode for device-dax instances is backwards for RAM-regions
as evidenced by the fact that it tends to catch end users by surprise.
"Where is my memory?". Recall that platforms are increasingly shipping
with performance-differentiated memory pools beyond typical DRAM and
NUMA effects. This includes HBM (high-bandwidth-memory) and CXL (dynamic
interleave, varied media types, and future fabric attached
possibilities).

For this reason the EFI_MEMORY_SP (EFI Special Purpose Memory => Linux
'Soft Reserved') attribute is expected to be applied to all memory-pools
that are not the general purpose pool. This designation gives an
Operating System a chance to defer usage of a memory pool until later in
the boot process where its performance properties can be interrogated
and administrator policy can be applied.

'Soft Reserved' memory can be anything from too limited and precious to
be part of the general purpose pool (HBM), too slow to host hot kernel
data structures (some PMEM media), or anything in between. However, in
the absence of an explicit policy, the memory should at least be made
usable by default. The current device-dax default hides all
non-general-purpose memory behind a device interface.

The expectation is that the distribution of users that want the memory
online by default vs device-dedicated-access by default follows the
Pareto principle. A small number of enlightened users may want to do
userspace memory management through a device, but general users just
want the kernel to make the memory available with an option to get more
advanced later.

Arrange for all device-dax instances not backed by PMEM to default to
attaching to the dax_kmem driver. From there the baseline memory hotplug
policy (CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE / memhp_default_state=)
gates whether the memory comes online or stays offline. Where, if it
stays offline, it can be reliably converted back to device-mode where it
can be partitioned, or fronted by a userspace allocator.

So, if someone wants device-dax instances for their 'Soft Reserved'
memory:

1/ Build a kernel with CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=n or boot
   with memhp_default_state=offline, or roll the dice and hope that the
   kernel has not pinned a page in that memory before step 2.

2/ Write a udev rule to convert the target dax device(s) from
   'system-ram' mode to 'devdax' mode:

   daxctl reconfigure-device $dax -m devdax -f

Cc: Michal Hocko <mhocko@suse.com>
Cc: David Hildenbrand <david@redhat.com>
Cc: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Gregory Price <gregory.price@memverge.com>
Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564544513.847146.4645646177864365755.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 drivers/dax/Kconfig     |    2 +-
 drivers/dax/bus.c       |   53 ++++++++++++++++++++---------------------------
 drivers/dax/bus.h       |   12 +++++++++--
 drivers/dax/device.c    |    3 +--
 drivers/dax/hmem/hmem.c |   12 ++++++++++-
 drivers/dax/kmem.c      |    1 +
 6 files changed, 46 insertions(+), 37 deletions(-)

diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
index d13c889c2a64..1163eb62e5f6 100644
--- a/drivers/dax/Kconfig
+++ b/drivers/dax/Kconfig
@@ -50,7 +50,7 @@ config DEV_DAX_HMEM_DEVICES
 	def_bool y
 
 config DEV_DAX_KMEM
-	tristate "KMEM DAX: volatile-use of persistent memory"
+	tristate "KMEM DAX: map dax-devices as System-RAM"
 	default DEV_DAX
 	depends on DEV_DAX
 	depends on MEMORY_HOTPLUG # for add_memory() and friends
diff --git a/drivers/dax/bus.c b/drivers/dax/bus.c
index 1dad813ee4a6..012d576004e9 100644
--- a/drivers/dax/bus.c
+++ b/drivers/dax/bus.c
@@ -56,6 +56,25 @@ static int dax_match_id(struct dax_device_driver *dax_drv, struct device *dev)
 	return match;
 }
 
+static int dax_match_type(struct dax_device_driver *dax_drv, struct device *dev)
+{
+	enum dax_driver_type type = DAXDRV_DEVICE_TYPE;
+	struct dev_dax *dev_dax = to_dev_dax(dev);
+
+	if (dev_dax->region->res.flags & IORESOURCE_DAX_KMEM)
+		type = DAXDRV_KMEM_TYPE;
+
+	if (dax_drv->type == type)
+		return 1;
+
+	/* default to device mode if dax_kmem is disabled */
+	if (dax_drv->type == DAXDRV_DEVICE_TYPE &&
+	    !IS_ENABLED(CONFIG_DEV_DAX_KMEM))
+		return 1;
+
+	return 0;
+}
+
 enum id_action {
 	ID_REMOVE,
 	ID_ADD,
@@ -216,14 +235,9 @@ static int dax_bus_match(struct device *dev, struct device_driver *drv)
 {
 	struct dax_device_driver *dax_drv = to_dax_drv(drv);
 
-	/*
-	 * All but the 'device-dax' driver, which has 'match_always'
-	 * set, requires an exact id match.
-	 */
-	if (dax_drv->match_always)
+	if (dax_match_id(dax_drv, dev))
 		return 1;
-
-	return dax_match_id(dax_drv, dev);
+	return dax_match_type(dax_drv, dev);
 }
 
 /*
@@ -1413,13 +1427,10 @@ struct dev_dax *devm_create_dev_dax(struct dev_dax_data *data)
 }
 EXPORT_SYMBOL_GPL(devm_create_dev_dax);
 
-static int match_always_count;
-
 int __dax_driver_register(struct dax_device_driver *dax_drv,
 		struct module *module, const char *mod_name)
 {
 	struct device_driver *drv = &dax_drv->drv;
-	int rc = 0;
 
 	/*
 	 * dax_bus_probe() calls dax_drv->probe() unconditionally.
@@ -1434,26 +1445,7 @@ int __dax_driver_register(struct dax_device_driver *dax_drv,
 	drv->mod_name = mod_name;
 	drv->bus = &dax_bus_type;
 
-	/* there can only be one default driver */
-	mutex_lock(&dax_bus_lock);
-	match_always_count += dax_drv->match_always;
-	if (match_always_count > 1) {
-		match_always_count--;
-		WARN_ON(1);
-		rc = -EINVAL;
-	}
-	mutex_unlock(&dax_bus_lock);
-	if (rc)
-		return rc;
-
-	rc = driver_register(drv);
-	if (rc && dax_drv->match_always) {
-		mutex_lock(&dax_bus_lock);
-		match_always_count -= dax_drv->match_always;
-		mutex_unlock(&dax_bus_lock);
-	}
-
-	return rc;
+	return driver_register(drv);
 }
 EXPORT_SYMBOL_GPL(__dax_driver_register);
 
@@ -1463,7 +1455,6 @@ void dax_driver_unregister(struct dax_device_driver *dax_drv)
 	struct dax_id *dax_id, *_id;
 
 	mutex_lock(&dax_bus_lock);
-	match_always_count -= dax_drv->match_always;
 	list_for_each_entry_safe(dax_id, _id, &dax_drv->ids, list) {
 		list_del(&dax_id->list);
 		kfree(dax_id);
diff --git a/drivers/dax/bus.h b/drivers/dax/bus.h
index fbb940293d6d..8cd79ab34292 100644
--- a/drivers/dax/bus.h
+++ b/drivers/dax/bus.h
@@ -11,7 +11,10 @@ struct dax_device;
 struct dax_region;
 void dax_region_put(struct dax_region *dax_region);
 
-#define IORESOURCE_DAX_STATIC (1UL << 0)
+/* dax bus specific ioresource flags */
+#define IORESOURCE_DAX_STATIC BIT(0)
+#define IORESOURCE_DAX_KMEM BIT(1)
+
 struct dax_region *alloc_dax_region(struct device *parent, int region_id,
 		struct range *range, int target_node, unsigned int align,
 		unsigned long flags);
@@ -25,10 +28,15 @@ struct dev_dax_data {
 
 struct dev_dax *devm_create_dev_dax(struct dev_dax_data *data);
 
+enum dax_driver_type {
+	DAXDRV_KMEM_TYPE,
+	DAXDRV_DEVICE_TYPE,
+};
+
 struct dax_device_driver {
 	struct device_driver drv;
 	struct list_head ids;
-	int match_always;
+	enum dax_driver_type type;
 	int (*probe)(struct dev_dax *dev);
 	void (*remove)(struct dev_dax *dev);
 };
diff --git a/drivers/dax/device.c b/drivers/dax/device.c
index 5494d745ced5..ecdff79e31f2 100644
--- a/drivers/dax/device.c
+++ b/drivers/dax/device.c
@@ -475,8 +475,7 @@ EXPORT_SYMBOL_GPL(dev_dax_probe);
 
 static struct dax_device_driver device_dax_driver = {
 	.probe = dev_dax_probe,
-	/* all probe actions are unwound by devm, so .remove isn't necessary */
-	.match_always = 1,
+	.type = DAXDRV_DEVICE_TYPE,
 };
 
 static int __init dax_init(void)
diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
index e7bdff3132fa..5ec08f9f8a57 100644
--- a/drivers/dax/hmem/hmem.c
+++ b/drivers/dax/hmem/hmem.c
@@ -11,15 +11,25 @@ module_param_named(region_idle, region_idle, bool, 0644);
 
 static int dax_hmem_probe(struct platform_device *pdev)
 {
+	unsigned long flags = IORESOURCE_DAX_KMEM;
 	struct device *dev = &pdev->dev;
 	struct dax_region *dax_region;
 	struct memregion_info *mri;
 	struct dev_dax_data data;
 	struct dev_dax *dev_dax;
 
+	/*
+	 * @region_idle == true indicates that an administrative agent
+	 * wants to manipulate the range partitioning before the devices
+	 * are created, so do not send them to the dax_kmem driver by
+	 * default.
+	 */
+	if (region_idle)
+		flags = 0;
+
 	mri = dev->platform_data;
 	dax_region = alloc_dax_region(dev, pdev->id, &mri->range,
-				      mri->target_node, PMD_SIZE, 0);
+				      mri->target_node, PMD_SIZE, flags);
 	if (!dax_region)
 		return -ENOMEM;
 
diff --git a/drivers/dax/kmem.c b/drivers/dax/kmem.c
index 4852a2dbdb27..918d01d3fbaa 100644
--- a/drivers/dax/kmem.c
+++ b/drivers/dax/kmem.c
@@ -239,6 +239,7 @@ static void dev_dax_kmem_remove(struct dev_dax *dev_dax)
 static struct dax_device_driver device_dax_kmem_driver = {
 	.probe = dev_dax_kmem_probe,
 	.remove = dev_dax_kmem_remove,
+	.type = DAXDRV_KMEM_TYPE,
 };
 
 static int __init dax_kmem_init(void)


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4CF97C636D3
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 09:09:05 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231912AbjBJJJE (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 04:09:04 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39056 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231915AbjBJJIa (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 04:08:30 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 099942CFCB;
        Fri, 10 Feb 2023 01:07:19 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676020040; x=1707556040;
  h=subject:from:to:cc:date:message-id:in-reply-to:
   references:mime-version:content-transfer-encoding;
  bh=hrm0j+K5sMknqLeRHZPi95fuEMBi83jRYl1v32nRVsM=;
  b=ny88ZzDwCPmzUosWzwOxB6RUzxgzTnchWCZFI+XHuVtK51P3hvWz1+Yt
   Ph5KRBX+hdeKiukdjBBFQ5KQZa8JJr+tFdxQAi0HFi9D9twbcnsVeAB8r
   nZplY75rffCDqT30HL6+bByGmO6UvtIWh/GztcRGTQBZRaWyHVZhxOMAw
   e18MH4ZNMrmo8+8GGaeS96o4V1w0bVAX14KGFPMcxpf8JWgLjRXw9w6PS
   4j3UM9p9g07KZX2Oky5LPuMrF+6cjZAIh9so9GLsvxXe15t5UO5WZlIMo
   2I3keN7HptSKcBaNBdmp9sc8NemIw1PnZm/c/mw3yT1auf4OnOR/kbOGk
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="310738862"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="310738862"
Received: from orsmga007.jf.intel.com ([10.7.209.58])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:19 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="661341226"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="661341226"
Received: from hrchavan-mobl.amr.corp.intel.com (HELO dwillia2-xfh.jf.intel.com) ([10.209.46.42])
  by orsmga007-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 01:07:19 -0800
Subject: [PATCH v2 20/20] cxl/dax: Create dax devices for CXL RAM regions
From: Dan Williams <dan.j.williams@intel.com>
To: linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
Date: Fri, 10 Feb 2023 01:07:19 -0800
Message-ID: <167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
User-Agent: StGit/0.18-3-g996c
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

While platform firmware takes some responsibility for mapping the RAM
capacity of CXL devices present at boot, the OS is responsible for
mapping the remainder and hot-added devices. Platform firmware is also
responsible for identifying the platform general purpose memory pool,
typically DDR attached DRAM, and arranging for the remainder to be 'Soft
Reserved'. That reservation allows the CXL subsystem to route the memory
to core-mm via memory-hotplug (dax_kmem), or leave it for dedicated
access (device-dax).

The new 'struct cxl_dax_region' object allows for a CXL memory resource
(region) to be published, but also allow for udev and module policy to
act on that event. It also prevents cxl_core.ko from having a module
loading dependency on any drivers/dax/ modules.

Tested-by: Fan Ni <fan.ni@samsung.com>
Link: https://lore.kernel.org/r/167564545116.847146.4741351262959589920.stgit@dwillia2-xfh.jf.intel.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
---
 MAINTAINERS               |    1 
 drivers/cxl/acpi.c        |    3 +
 drivers/cxl/core/core.h   |    3 +
 drivers/cxl/core/port.c   |    4 +-
 drivers/cxl/core/region.c |  108 ++++++++++++++++++++++++++++++++++++++++++++-
 drivers/cxl/cxl.h         |   12 +++++
 drivers/dax/Kconfig       |   13 +++++
 drivers/dax/Makefile      |    2 +
 drivers/dax/cxl.c         |   53 ++++++++++++++++++++++
 drivers/dax/hmem/hmem.c   |   14 ++++++
 10 files changed, 209 insertions(+), 4 deletions(-)
 create mode 100644 drivers/dax/cxl.c

diff --git a/MAINTAINERS b/MAINTAINERS
index 7f86d02cb427..73a9f3401e0e 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
@@ -6035,6 +6035,7 @@ M:	Dan Williams <dan.j.williams@intel.com>
 M:	Vishal Verma <vishal.l.verma@intel.com>
 M:	Dave Jiang <dave.jiang@intel.com>
 L:	nvdimm@lists.linux.dev
+L:	linux-cxl@vger.kernel.org
 S:	Supported
 F:	drivers/dax/
 
diff --git a/drivers/cxl/acpi.c b/drivers/cxl/acpi.c
index ad0849af42d7..8ebb9a74790d 100644
--- a/drivers/cxl/acpi.c
+++ b/drivers/cxl/acpi.c
@@ -731,7 +731,8 @@ static void __exit cxl_acpi_exit(void)
 	cxl_bus_drain();
 }
 
-module_init(cxl_acpi_init);
+/* load before dax_hmem sees 'Soft Reserved' CXL ranges */
+subsys_initcall(cxl_acpi_init);
 module_exit(cxl_acpi_exit);
 MODULE_LICENSE("GPL v2");
 MODULE_IMPORT_NS(CXL);
diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index 479f01da6d35..cde475e13216 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -15,12 +15,14 @@ extern struct device_attribute dev_attr_create_ram_region;
 extern struct device_attribute dev_attr_delete_region;
 extern struct device_attribute dev_attr_region;
 extern const struct device_type cxl_pmem_region_type;
+extern const struct device_type cxl_dax_region_type;
 extern const struct device_type cxl_region_type;
 void cxl_decoder_kill_region(struct cxl_endpoint_decoder *cxled);
 #define CXL_REGION_ATTR(x) (&dev_attr_##x.attr)
 #define CXL_REGION_TYPE(x) (&cxl_region_type)
 #define SET_CXL_REGION_ATTR(x) (&dev_attr_##x.attr),
 #define CXL_PMEM_REGION_TYPE(x) (&cxl_pmem_region_type)
+#define CXL_DAX_REGION_TYPE(x) (&cxl_dax_region_type)
 int cxl_region_init(void);
 void cxl_region_exit(void);
 #else
@@ -38,6 +40,7 @@ static inline void cxl_region_exit(void)
 #define CXL_REGION_TYPE(x) NULL
 #define SET_CXL_REGION_ATTR(x)
 #define CXL_PMEM_REGION_TYPE(x) NULL
+#define CXL_DAX_REGION_TYPE(x) NULL
 #endif
 
 struct cxl_send_command;
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index b45d2796ef35..0bb7a5ff724b 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -46,6 +46,8 @@ static int cxl_device_id(struct device *dev)
 		return CXL_DEVICE_NVDIMM;
 	if (dev->type == CXL_PMEM_REGION_TYPE())
 		return CXL_DEVICE_PMEM_REGION;
+	if (dev->type == CXL_DAX_REGION_TYPE())
+		return CXL_DEVICE_DAX_REGION;
 	if (is_cxl_port(dev)) {
 		if (is_cxl_root(to_cxl_port(dev)))
 			return CXL_DEVICE_ROOT;
@@ -2015,6 +2017,6 @@ static void cxl_core_exit(void)
 	debugfs_remove_recursive(cxl_debugfs);
 }
 
-module_init(cxl_core_init);
+subsys_initcall(cxl_core_init);
 module_exit(cxl_core_exit);
 MODULE_LICENSE("GPL v2");
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 3f6453da2c51..91d334080cab 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -2272,6 +2272,75 @@ static struct cxl_pmem_region *cxl_pmem_region_alloc(struct cxl_region *cxlr)
 	return cxlr_pmem;
 }
 
+static void cxl_dax_region_release(struct device *dev)
+{
+	struct cxl_dax_region *cxlr_dax = to_cxl_dax_region(dev);
+
+	kfree(cxlr_dax);
+}
+
+static const struct attribute_group *cxl_dax_region_attribute_groups[] = {
+	&cxl_base_attribute_group,
+	NULL,
+};
+
+const struct device_type cxl_dax_region_type = {
+	.name = "cxl_dax_region",
+	.release = cxl_dax_region_release,
+	.groups = cxl_dax_region_attribute_groups,
+};
+
+static bool is_cxl_dax_region(struct device *dev)
+{
+	return dev->type == &cxl_dax_region_type;
+}
+
+struct cxl_dax_region *to_cxl_dax_region(struct device *dev)
+{
+	if (dev_WARN_ONCE(dev, !is_cxl_dax_region(dev),
+			  "not a cxl_dax_region device\n"))
+		return NULL;
+	return container_of(dev, struct cxl_dax_region, dev);
+}
+EXPORT_SYMBOL_NS_GPL(to_cxl_dax_region, CXL);
+
+static struct lock_class_key cxl_dax_region_key;
+
+static struct cxl_dax_region *cxl_dax_region_alloc(struct cxl_region *cxlr)
+{
+	struct cxl_region_params *p = &cxlr->params;
+	struct cxl_dax_region *cxlr_dax;
+	struct device *dev;
+
+	down_read(&cxl_region_rwsem);
+	if (p->state != CXL_CONFIG_COMMIT) {
+		cxlr_dax = ERR_PTR(-ENXIO);
+		goto out;
+	}
+
+	cxlr_dax = kzalloc(sizeof(*cxlr_dax), GFP_KERNEL);
+	if (!cxlr_dax) {
+		cxlr_dax = ERR_PTR(-ENOMEM);
+		goto out;
+	}
+
+	cxlr_dax->hpa_range.start = p->res->start;
+	cxlr_dax->hpa_range.end = p->res->end;
+
+	dev = &cxlr_dax->dev;
+	cxlr_dax->cxlr = cxlr;
+	device_initialize(dev);
+	lockdep_set_class(&dev->mutex, &cxl_dax_region_key);
+	device_set_pm_not_required(dev);
+	dev->parent = &cxlr->dev;
+	dev->bus = &cxl_bus_type;
+	dev->type = &cxl_dax_region_type;
+out:
+	up_read(&cxl_region_rwsem);
+
+	return cxlr_dax;
+}
+
 static void cxlr_pmem_unregister(void *_cxlr_pmem)
 {
 	struct cxl_pmem_region *cxlr_pmem = _cxlr_pmem;
@@ -2356,6 +2425,42 @@ static int devm_cxl_add_pmem_region(struct cxl_region *cxlr)
 	return rc;
 }
 
+static void cxlr_dax_unregister(void *_cxlr_dax)
+{
+	struct cxl_dax_region *cxlr_dax = _cxlr_dax;
+
+	device_unregister(&cxlr_dax->dev);
+}
+
+static int devm_cxl_add_dax_region(struct cxl_region *cxlr)
+{
+	struct cxl_dax_region *cxlr_dax;
+	struct device *dev;
+	int rc;
+
+	cxlr_dax = cxl_dax_region_alloc(cxlr);
+	if (IS_ERR(cxlr_dax))
+		return PTR_ERR(cxlr_dax);
+
+	dev = &cxlr_dax->dev;
+	rc = dev_set_name(dev, "dax_region%d", cxlr->id);
+	if (rc)
+		goto err;
+
+	rc = device_add(dev);
+	if (rc)
+		goto err;
+
+	dev_dbg(&cxlr->dev, "%s: register %s\n", dev_name(dev->parent),
+		dev_name(dev));
+
+	return devm_add_action_or_reset(&cxlr->dev, cxlr_dax_unregister,
+					cxlr_dax);
+err:
+	put_device(dev);
+	return rc;
+}
+
 static int match_decoder_by_range(struct device *dev, void *data)
 {
 	struct range *r1, *r2 = data;
@@ -2619,8 +2724,7 @@ static int cxl_region_probe(struct device *dev)
 					p->res->start, p->res->end, cxlr,
 					is_system_ram) > 0)
 			return 0;
-		dev_dbg(dev, "TODO: hookup devdax\n");
-		return 0;
+		return devm_cxl_add_dax_region(cxlr);
 	default:
 		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
 			cxlr->mode);
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index 2ac344235235..b1395c46baec 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -513,6 +513,12 @@ struct cxl_pmem_region {
 	struct cxl_pmem_region_mapping mapping[];
 };
 
+struct cxl_dax_region {
+	struct device dev;
+	struct cxl_region *cxlr;
+	struct range hpa_range;
+};
+
 /**
  * struct cxl_port - logical collection of upstream port devices and
  *		     downstream port devices to construct a CXL memory
@@ -707,6 +713,7 @@ void cxl_driver_unregister(struct cxl_driver *cxl_drv);
 #define CXL_DEVICE_MEMORY_EXPANDER	5
 #define CXL_DEVICE_REGION		6
 #define CXL_DEVICE_PMEM_REGION		7
+#define CXL_DEVICE_DAX_REGION		8
 
 #define MODULE_ALIAS_CXL(type) MODULE_ALIAS("cxl:t" __stringify(type) "*")
 #define CXL_MODALIAS_FMT "cxl:t%d"
@@ -725,6 +732,7 @@ bool is_cxl_pmem_region(struct device *dev);
 struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev);
 int cxl_add_to_region(struct cxl_port *root,
 		      struct cxl_endpoint_decoder *cxled);
+struct cxl_dax_region *to_cxl_dax_region(struct device *dev);
 #else
 static inline bool is_cxl_pmem_region(struct device *dev)
 {
@@ -739,6 +747,10 @@ static inline int cxl_add_to_region(struct cxl_port *root,
 {
 	return 0;
 }
+static inline struct cxl_dax_region *to_cxl_dax_region(struct device *dev)
+{
+	return NULL;
+}
 #endif
 
 /*
diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
index 1163eb62e5f6..bd06e16c7ac8 100644
--- a/drivers/dax/Kconfig
+++ b/drivers/dax/Kconfig
@@ -45,6 +45,19 @@ config DEV_DAX_HMEM
 
 	  Say M if unsure.
 
+config DEV_DAX_CXL
+	tristate "CXL DAX: direct access to CXL RAM regions"
+	depends on CXL_REGION && DEV_DAX
+	default CXL_REGION && DEV_DAX
+	help
+	  CXL RAM regions are either mapped by platform-firmware
+	  and published in the initial system-memory map as "System RAM", mapped
+	  by platform-firmware as "Soft Reserved", or dynamically provisioned
+	  after boot by the CXL driver. In the latter two cases a device-dax
+	  instance is created to access that unmapped-by-default address range.
+	  Per usual it can remain as dedicated access via a device interface, or
+	  converted to "System RAM" via the dax_kmem facility.
+
 config DEV_DAX_HMEM_DEVICES
 	depends on DEV_DAX_HMEM && DAX
 	def_bool y
diff --git a/drivers/dax/Makefile b/drivers/dax/Makefile
index 90a56ca3b345..5ed5c39857c8 100644
--- a/drivers/dax/Makefile
+++ b/drivers/dax/Makefile
@@ -3,10 +3,12 @@ obj-$(CONFIG_DAX) += dax.o
 obj-$(CONFIG_DEV_DAX) += device_dax.o
 obj-$(CONFIG_DEV_DAX_KMEM) += kmem.o
 obj-$(CONFIG_DEV_DAX_PMEM) += dax_pmem.o
+obj-$(CONFIG_DEV_DAX_CXL) += dax_cxl.o
 
 dax-y := super.o
 dax-y += bus.o
 device_dax-y := device.o
 dax_pmem-y := pmem.o
+dax_cxl-y := cxl.o
 
 obj-y += hmem/
diff --git a/drivers/dax/cxl.c b/drivers/dax/cxl.c
new file mode 100644
index 000000000000..ccdf8de85bd5
--- /dev/null
+++ b/drivers/dax/cxl.c
@@ -0,0 +1,53 @@
+// SPDX-License-Identifier: GPL-2.0-only
+/* Copyright(c) 2023 Intel Corporation. All rights reserved. */
+#include <linux/module.h>
+#include <linux/dax.h>
+
+#include "../cxl/cxl.h"
+#include "bus.h"
+
+static int cxl_dax_region_probe(struct device *dev)
+{
+	struct cxl_dax_region *cxlr_dax = to_cxl_dax_region(dev);
+	int nid = phys_to_target_node(cxlr_dax->hpa_range.start);
+	struct cxl_region *cxlr = cxlr_dax->cxlr;
+	struct dax_region *dax_region;
+	struct dev_dax_data data;
+	struct dev_dax *dev_dax;
+
+	if (nid == NUMA_NO_NODE)
+		nid = memory_add_physaddr_to_nid(cxlr_dax->hpa_range.start);
+
+	dax_region = alloc_dax_region(dev, cxlr->id, &cxlr_dax->hpa_range, nid,
+				      PMD_SIZE, IORESOURCE_DAX_KMEM);
+	if (!dax_region)
+		return -ENOMEM;
+
+	data = (struct dev_dax_data) {
+		.dax_region = dax_region,
+		.id = -1,
+		.size = range_len(&cxlr_dax->hpa_range),
+	};
+	dev_dax = devm_create_dev_dax(&data);
+	if (IS_ERR(dev_dax))
+		return PTR_ERR(dev_dax);
+
+	/* child dev_dax instances now own the lifetime of the dax_region */
+	dax_region_put(dax_region);
+	return 0;
+}
+
+static struct cxl_driver cxl_dax_region_driver = {
+	.name = "cxl_dax_region",
+	.probe = cxl_dax_region_probe,
+	.id = CXL_DEVICE_DAX_REGION,
+	.drv = {
+		.suppress_bind_attrs = true,
+	},
+};
+
+module_cxl_driver(cxl_dax_region_driver);
+MODULE_ALIAS_CXL(CXL_DEVICE_DAX_REGION);
+MODULE_LICENSE("GPL");
+MODULE_AUTHOR("Intel Corporation");
+MODULE_IMPORT_NS(CXL);
diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
index 5ec08f9f8a57..e5fe8b39fb94 100644
--- a/drivers/dax/hmem/hmem.c
+++ b/drivers/dax/hmem/hmem.c
@@ -72,6 +72,13 @@ static int hmem_register_device(struct device *host, int target_nid,
 	long id;
 	int rc;
 
+	if (IS_ENABLED(CONFIG_CXL_REGION) &&
+	    region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
+			      IORES_DESC_CXL) != REGION_DISJOINT) {
+		dev_dbg(host, "deferring range to CXL: %pr\n", res);
+		return 0;
+	}
+
 	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
 			       IORES_DESC_SOFT_RESERVED);
 	if (rc != REGION_INTERSECTS)
@@ -157,6 +164,13 @@ static __exit void dax_hmem_exit(void)
 module_init(dax_hmem_init);
 module_exit(dax_hmem_exit);
 
+/* Allow for CXL to define its own dax regions */
+#if IS_ENABLED(CONFIG_CXL_REGION)
+#if IS_MODULE(CONFIG_CXL_ACPI)
+MODULE_SOFTDEP("pre: cxl_acpi");
+#endif
+#endif
+
 MODULE_ALIAS("platform:hmem*");
 MODULE_ALIAS("platform:hmem_platform*");
 MODULE_LICENSE("GPL v2");


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4EEEFC636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:28:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232861AbjBJR25 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:28:57 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38992 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232800AbjBJR24 (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:28:56 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DB01C7358F;
        Fri, 10 Feb 2023 09:28:54 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD0w72WBwz67Qtq;
        Sat, 11 Feb 2023 01:24:23 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 17:28:51 +0000
Date: Fri, 10 Feb 2023 17:28:50 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, <vishal.l.verma@intel.com>,
        <dave.hansen@linux.intel.com>, <linux-mm@kvack.org>,
        <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 01/20] cxl/memdev: Fix endpoint port removal
Message-ID: <20230210172850.00001d5b@Huawei.com>
In-Reply-To: <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500001.china.huawei.com (7.191.163.213) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:05:27 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Testing of ram region support [1], stimulates a long standing bug in
> cxl_detach_ep() where some cxl_ep_remove() cleanup is skipped due to
> inability to walk ports after dports have been unregistered. That
> results in a failure to re-register a memdev after the port is
> re-enabled leading to a crash like the following:
> 
>     cxl_port_setup_targets: cxl region4: cxl_host_bridge.0:port4 iw: 1 ig: 256
>     general protection fault, ...
>     [..]
>     RIP: 0010:cxl_region_setup_targets+0x897/0x9e0 [cxl_core]
>     dev_name at include/linux/device.h:700
>     (inlined by) cxl_port_setup_targets at drivers/cxl/core/region.c:1155
>     (inlined by) cxl_region_setup_targets at drivers/cxl/core/region.c:1249
>     [..]
>     Call Trace:
>      <TASK>
>      attach_target+0x39a/0x760 [cxl_core]
>      ? __mutex_unlock_slowpath+0x3a/0x290
>      cxl_add_to_region+0xb8/0x340 [cxl_core]
>      ? lockdep_hardirqs_on+0x7d/0x100
>      discover_region+0x4b/0x80 [cxl_port]
>      ? __pfx_discover_region+0x10/0x10 [cxl_port]
>      device_for_each_child+0x58/0x90
>      cxl_port_probe+0x10e/0x130 [cxl_port]
>      cxl_bus_probe+0x17/0x50 [cxl_core]
> 
> Change the port ancestry walk to be by depth rather than by dport. This
> ensures that even if a port has unregistered its dports a deferred
> memdev cleanup will still be able to cleanup the memdev's interest in
> that port.
> 
> The parent_port->dev.driver check is only needed for determining if the
> bottom up removal beat the top-down removal, but cxl_ep_remove() can
> always proceed.

Why can cxl_ep_remove() always proceed?  What stops it racing?
Is it that we are holding a reference to the port at the time of the
call so the release callback can't be called until we drop that?
Anyhow, good to have a little more detail on the 'why' in the patch
description (particularly for those reading this when half asleep like me ;)

> 
> Fixes: 2703c16c75ae ("cxl/core/port: Add switch port enumeration")
> Link: http://lore.kernel.org/r/167564534874.847146.5222419648551436750.stgit@dwillia2-xfh.jf.intel.com [1]
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/memdev.c |    1 +
>  drivers/cxl/core/port.c   |   58 +++++++++++++++++++++++++--------------------
>  drivers/cxl/cxlmem.h      |    2 ++
>  3 files changed, 35 insertions(+), 26 deletions(-)
> 
> diff --git a/drivers/cxl/core/memdev.c b/drivers/cxl/core/memdev.c
> index a74a93310d26..3a8bc2b06047 100644
> --- a/drivers/cxl/core/memdev.c
> +++ b/drivers/cxl/core/memdev.c
> @@ -246,6 +246,7 @@ static struct cxl_memdev *cxl_memdev_alloc(struct cxl_dev_state *cxlds,
>  	if (rc < 0)
>  		goto err;
>  	cxlmd->id = rc;
> +	cxlmd->depth = -1;
>  
>  	dev = &cxlmd->dev;
>  	device_initialize(dev);
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 410c036c09fa..317bcf4dbd9d 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -1207,6 +1207,7 @@ int cxl_endpoint_autoremove(struct cxl_memdev *cxlmd, struct cxl_port *endpoint)
>  
>  	get_device(&endpoint->dev);
>  	dev_set_drvdata(dev, endpoint);
> +	cxlmd->depth = endpoint->depth;
>  	return devm_add_action_or_reset(dev, delete_endpoint, cxlmd);
>  }
>  EXPORT_SYMBOL_NS_GPL(cxl_endpoint_autoremove, CXL);
> @@ -1241,50 +1242,55 @@ static void reap_dports(struct cxl_port *port)
>  	}
>  }
>  
> +struct detach_ctx {
> +	struct cxl_memdev *cxlmd;
> +	int depth;
> +};

>  static void cxl_detach_ep(void *data)
>  {
>  	struct cxl_memdev *cxlmd = data;
> -	struct device *iter;
>  
> -	for (iter = &cxlmd->dev; iter; iter = grandparent(iter)) {
> -		struct device *dport_dev = grandparent(iter);
> +	for (int i = cxlmd->depth - 1; i >= 1; i--) {
>  		struct cxl_port *port, *parent_port;
> +		struct detach_ctx ctx = {
> +			.cxlmd = cxlmd,
> +			.depth = i,
> +		};
> +		struct device *dev;
>  		struct cxl_ep *ep;
>  		bool died = false;
>  
> -		if (!dport_dev)
> -			break;
> -
> -		port = find_cxl_port(dport_dev, NULL);
> -		if (!port)
> -			continue;
> -
> -		if (is_cxl_root(port)) {
> -			put_device(&port->dev);
> +		dev = bus_find_device(&cxl_bus_type, NULL, &ctx,
> +				      port_has_memdev);
> +		if (!dev)
>  			continue;
> -		}
> +		port = to_cxl_port(dev);
>  
>  		parent_port = to_cxl_port(port->dev.parent);
>  		device_lock(&parent_port->dev);
> -		if (!parent_port->dev.driver) {
> -			/*
> -			 * The bottom-up race to delete the port lost to a
> -			 * top-down port disable, give up here, because the
> -			 * parent_port ->remove() will have cleaned up all
> -			 * descendants.
> -			 */
> -			device_unlock(&parent_port->dev);
> -			put_device(&port->dev);
> -			continue;
> -		}
> -
>  		device_lock(&port->dev);
>  		ep = cxl_ep_load(port, cxlmd);
>  		dev_dbg(&cxlmd->dev, "disconnect %s from %s\n",
>  			ep ? dev_name(ep->ep) : "", dev_name(&port->dev));
>  		cxl_ep_remove(port, ep);
>  		if (ep && !port->dead && xa_empty(&port->endpoints) &&
> -		    !is_cxl_root(parent_port)) {
> +		    !is_cxl_root(parent_port) && parent_port->dev.driver) {
>  			/*
>  			 * This was the last ep attached to a dynamically
>  			 * enumerated port. Block new cxl_add_ep() and garbage



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D48B9C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:30:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232956AbjBJRaX (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:30:23 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40016 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232929AbjBJRaW (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:30:22 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AE3F8735B1;
        Fri, 10 Feb 2023 09:30:19 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD11D39ltz6J9nd;
        Sat, 11 Feb 2023 01:28:48 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 17:30:17 +0000
Date: Fri, 10 Feb 2023 17:30:16 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>,
        Vishal Verma <vishal.l.verma@intel.com>,
        "Fan Ni" <fan.ni@samsung.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 04/20] cxl/region: Support empty uuids for non-pmem
 regions
Message-ID: <20230210173016.000040d2@Huawei.com>
In-Reply-To: <167601994558.1924368.12612811533724694444.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601994558.1924368.12612811533724694444.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500001.china.huawei.com (7.191.163.213) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:05:45 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Shipping versions of the cxl-cli utility expect all regions to have a
> 'uuid' attribute. In preparation for 'ram' regions, update the 'uuid'
> attribute to return an empty string which satisfies the current
> expectations of 'cxl list -R'. Otherwise, 'cxl list -R' fails in the
> presence of regions with the 'uuid' attribute missing. Force the
> attribute to be read-only as there is no facility or expectation for a
> 'ram' region to recall its uuid from one boot to the next.
> 
> Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564536587.847146.12703125206459604597.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
After your explanations in v1 thread, I'm fine with this.
Just another bit of slightly inelegant ABI that we are stuck with.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> ---
>  Documentation/ABI/testing/sysfs-bus-cxl |    3 ++-
>  drivers/cxl/core/region.c               |   11 +++++++++--
>  2 files changed, 11 insertions(+), 3 deletions(-)
> 
> diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
> index 058b0c45001f..4c4e1cbb1169 100644
> --- a/Documentation/ABI/testing/sysfs-bus-cxl
> +++ b/Documentation/ABI/testing/sysfs-bus-cxl
> @@ -317,7 +317,8 @@ Contact:	linux-cxl@vger.kernel.org
>  Description:
>  		(RW) Write a unique identifier for the region. This field must
>  		be set for persistent regions and it must not conflict with the
> -		UUID of another region.
> +		UUID of another region. For volatile ram regions this
> +		attribute is a read-only empty string.
>  
>  
>  What:		/sys/bus/cxl/devices/regionZ/interleave_granularity
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 17d2d0c12725..0fc80478ff6b 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -45,7 +45,10 @@ static ssize_t uuid_show(struct device *dev, struct device_attribute *attr,
>  	rc = down_read_interruptible(&cxl_region_rwsem);
>  	if (rc)
>  		return rc;
> -	rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
> +	if (cxlr->mode != CXL_DECODER_PMEM)
> +		rc = sysfs_emit(buf, "\n");
> +	else
> +		rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
>  	up_read(&cxl_region_rwsem);
>  
>  	return rc;
> @@ -300,8 +303,12 @@ static umode_t cxl_region_visible(struct kobject *kobj, struct attribute *a,
>  	struct device *dev = kobj_to_dev(kobj);
>  	struct cxl_region *cxlr = to_cxl_region(dev);
>  
> +	/*
> +	 * Support tooling that expects to find a 'uuid' attribute for all
> +	 * regions regardless of mode.
> +	 */
>  	if (a == &dev_attr_uuid.attr && cxlr->mode != CXL_DECODER_PMEM)
> -		return 0;
> +		return 0444;
>  	return a->mode;
>  }
>  
> 
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E25C7C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:31:37 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232422AbjBJRbh (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:31:37 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40612 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232940AbjBJRbg (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:31:36 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0F65773958;
        Fri, 10 Feb 2023 09:31:36 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD12h5vcvz6J91l;
        Sat, 11 Feb 2023 01:30:04 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 17:31:33 +0000
Date: Fri, 10 Feb 2023 17:31:32 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, <vishal.l.verma@intel.com>,
        <dave.hansen@linux.intel.com>, <linux-mm@kvack.org>,
        <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 08/20] cxl/region: Cleanup target list on attach
 error
Message-ID: <20230210173132.00003647@Huawei.com>
In-Reply-To: <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500001.china.huawei.com (7.191.163.213) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:06:09 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Jonathan noticed that the target list setup is not unwound completely
> upon error. Undo all the setup in the 'err_decrement:' exit path.
> 
> Fixes: 27b3f8d13830 ("cxl/region: Program target lists")
> Reported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
> Link: http://lore.kernel.org/r/20230208123031.00006990@Huawei.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

> ---
>  drivers/cxl/core/region.c |    2 ++
>  1 file changed, 2 insertions(+)
> 
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 040bbd39c81d..ae7d3adcd41a 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -1347,6 +1347,8 @@ static int cxl_region_attach(struct cxl_region *cxlr,
>  
>  err_decrement:
>  	p->nr_targets--;
> +	cxled->pos = -1;
> +	p->targets[pos] = NULL;
>  err:
>  	for (iter = ep_port; !is_cxl_root(iter);
>  	     iter = to_cxl_port(iter->dev.parent))
> 
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 9C030C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:35:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232476AbjBJRfA (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:35:00 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:42988 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232516AbjBJRe5 (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:34:57 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 10D5875376;
        Fri, 10 Feb 2023 09:34:57 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.226])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD1361q8yz67Qtq;
        Sat, 11 Feb 2023 01:30:26 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 17:34:54 +0000
Date: Fri, 10 Feb 2023 17:34:53 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>,
        Vishal Verma <vishal.l.verma@intel.com>,
        "Fan Ni" <fan.ni@samsung.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 09/20] cxl/region: Move region-position validation to
 a helper
Message-ID: <20230210173453.00002fc5@Huawei.com>
In-Reply-To: <167601997584.1924368.4615769326126138969.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601997584.1924368.4615769326126138969.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:06:15 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> In preparation for region autodiscovery, that needs all devices
> discovered before their relative position in the region can be
> determined, consolidate all position dependent validation in a helper.
> 
> Recall that in the on-demand region creation flow the end-user picks the
> position of a given endpoint decoder in a region. In the autodiscovery
> case the position of an endpoint decoder can only be determined after
> all other endpoint decoders that claim to decode the region's address
> range have been enumerated and attached. So, in the autodiscovery case
> endpoint decoders may be attached before their relative position is
> known. Once all decoders arrive, then positions can be determined and
> validated with cxl_region_validate_position() the same as user initiated
> on-demand creation.
> 
> Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564538779.847146.8356062886811511706.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3816DC05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:41:29 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232750AbjBJRl2 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:41:28 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:48682 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233027AbjBJRlX (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:41:23 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0D96D7A7D0;
        Fri, 10 Feb 2023 09:41:17 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD1BP4Wt4z67Qtq;
        Sat, 11 Feb 2023 01:36:45 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 17:41:14 +0000
Date: Fri, 10 Feb 2023 17:41:13 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, <vishal.l.verma@intel.com>,
        <dave.hansen@linux.intel.com>, <linux-mm@kvack.org>,
        <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 12/20] cxl/port: Split endpoint and switch port probe
Message-ID: <20230210174113.000079d0@Huawei.com>
In-Reply-To: <167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:06:33 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Jonathan points out that the shared code between the switch and endpoint
> case is small. Before adding another is_cxl_endpoint() conditional,
> just split the two cases.
> 
> Rather than duplicate the "Couldn't enumerate decoders" error message
> take the opportunity to improve the error messages in
> devm_cxl_enumerate_decoders().
> 
> Reported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
> Link: http://lore.kernel.org/r/20230208170724.000067ec@Huawei.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
LGTM.
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

> ---
>  drivers/cxl/core/hdm.c |   11 ++++++--
>  drivers/cxl/port.c     |   69 +++++++++++++++++++++++++++---------------------
>  2 files changed, 47 insertions(+), 33 deletions(-)
> 
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index dcc16d7cb8f3..a0891c3464f1 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -826,7 +826,8 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>  			cxled = cxl_endpoint_decoder_alloc(port);
>  			if (IS_ERR(cxled)) {
>  				dev_warn(&port->dev,
> -					 "Failed to allocate the decoder\n");
> +					 "Failed to allocate decoder%d.%d\n",
> +					 port->id, i);
>  				return PTR_ERR(cxled);
>  			}
>  			cxld = &cxled->cxld;
> @@ -836,7 +837,8 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>  			cxlsd = cxl_switch_decoder_alloc(port, target_count);
>  			if (IS_ERR(cxlsd)) {
>  				dev_warn(&port->dev,
> -					 "Failed to allocate the decoder\n");
> +					 "Failed to allocate decoder%d.%d\n",
> +					 port->id, i);
>  				return PTR_ERR(cxlsd);
>  			}
>  			cxld = &cxlsd->cxld;
> @@ -844,13 +846,16 @@ int devm_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>  
>  		rc = init_hdm_decoder(port, cxld, target_map, hdm, i, &dpa_base);
>  		if (rc) {
> +			dev_warn(&port->dev,
> +				 "Failed to initialize decoder%d.%d\n",
> +				 port->id, i);
>  			put_device(&cxld->dev);
>  			return rc;
>  		}
>  		rc = add_hdm_decoder(port, cxld, target_map);
>  		if (rc) {
>  			dev_warn(&port->dev,
> -				 "Failed to add decoder to port\n");
> +				 "Failed to add decoder%d.%d\n", port->id, i);
>  			return rc;
>  		}
>  	}
> diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
> index 5453771bf330..a8d46a67b45e 100644
> --- a/drivers/cxl/port.c
> +++ b/drivers/cxl/port.c
> @@ -30,55 +30,64 @@ static void schedule_detach(void *cxlmd)
>  	schedule_cxl_memdev_detach(cxlmd);
>  }
>  
> -static int cxl_port_probe(struct device *dev)
> +static int cxl_switch_port_probe(struct cxl_port *port)
>  {
> -	struct cxl_port *port = to_cxl_port(dev);
>  	struct cxl_hdm *cxlhdm;
>  	int rc;
>  
> +	rc = devm_cxl_port_enumerate_dports(port);
> +	if (rc < 0)
> +		return rc;
>  
> -	if (!is_cxl_endpoint(port)) {
> -		rc = devm_cxl_port_enumerate_dports(port);
> -		if (rc < 0)
> -			return rc;
> -		if (rc == 1)
> -			return devm_cxl_add_passthrough_decoder(port);
> -	}
> +	if (rc == 1)
> +		return devm_cxl_add_passthrough_decoder(port);
>  
>  	cxlhdm = devm_cxl_setup_hdm(port);
>  	if (IS_ERR(cxlhdm))
>  		return PTR_ERR(cxlhdm);
>  
> -	if (is_cxl_endpoint(port)) {
> -		struct cxl_memdev *cxlmd = to_cxl_memdev(port->uport);
> -		struct cxl_dev_state *cxlds = cxlmd->cxlds;
> +	return devm_cxl_enumerate_decoders(cxlhdm);
> +}
>  
> -		/* Cache the data early to ensure is_visible() works */
> -		read_cdat_data(port);
> +static int cxl_endpoint_port_probe(struct cxl_port *port)
> +{
> +	struct cxl_memdev *cxlmd = to_cxl_memdev(port->uport);
> +	struct cxl_dev_state *cxlds = cxlmd->cxlds;
> +	struct cxl_hdm *cxlhdm;
> +	int rc;
> +
> +	cxlhdm = devm_cxl_setup_hdm(port);
> +	if (IS_ERR(cxlhdm))
> +		return PTR_ERR(cxlhdm);
>  
> -		get_device(&cxlmd->dev);
> -		rc = devm_add_action_or_reset(dev, schedule_detach, cxlmd);
> -		if (rc)
> -			return rc;
> +	/* Cache the data early to ensure is_visible() works */
> +	read_cdat_data(port);
>  
> -		rc = cxl_hdm_decode_init(cxlds, cxlhdm);
> -		if (rc)
> -			return rc;
> +	get_device(&cxlmd->dev);
> +	rc = devm_add_action_or_reset(&port->dev, schedule_detach, cxlmd);
> +	if (rc)
> +		return rc;
>  
> -		rc = cxl_await_media_ready(cxlds);
> -		if (rc) {
> -			dev_err(dev, "Media not active (%d)\n", rc);
> -			return rc;
> -		}
> -	}
> +	rc = cxl_hdm_decode_init(cxlds, cxlhdm);
> +	if (rc)
> +		return rc;
>  
> -	rc = devm_cxl_enumerate_decoders(cxlhdm);
> +	rc = cxl_await_media_ready(cxlds);
>  	if (rc) {
> -		dev_err(dev, "Couldn't enumerate decoders (%d)\n", rc);
> +		dev_err(&port->dev, "Media not active (%d)\n", rc);
>  		return rc;
>  	}
>  
> -	return 0;
> +	return devm_cxl_enumerate_decoders(cxlhdm);
> +}
> +
> +static int cxl_port_probe(struct device *dev)
> +{
> +	struct cxl_port *port = to_cxl_port(dev);
> +
> +	if (is_cxl_endpoint(port))
> +		return cxl_endpoint_port_probe(port);
> +	return cxl_switch_port_probe(port);
>  }
>  
>  static ssize_t CDAT_read(struct file *filp, struct kobject *kobj,
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6BF19C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 17:54:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232402AbjBJRyB (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:54:01 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:56186 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232714AbjBJRxx (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 12:53:53 -0500
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4343F7BFE0;
        Fri, 10 Feb 2023 09:53:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676051629; x=1707587629;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=oFl0+QGvRhLKYpr89Y6LGwAnRPGFf/nBPmxg2YZhifg=;
  b=DIhROjDbmTkViVyP3+XgDqIB442Qro5yU+kITonl81AolwqtnHJVKxbu
   zcFiC9rqGLUOuiWZ+NpTVRrV6AH5h9APSc7fkj2541PghqjLvmNi5SVee
   NdIbFD8RoaYoUYCzffiZ4CtyXzYNaUspZ53jqshlq0eUUApKaymMWJTp2
   BNamvktWABUrkkSlnSjcjhGjIJDScPdce8FVvxLqyrwqjqDstX4F26/jH
   aVV8T2rTpVg+d0p6VdAmUxymbtm3+rRx6N5BalgGwBQItEmgMmWyNZRhb
   y6hsVMcTckeWHBllLzpjnhj72i2p7aXDB8VZhoqQU176CZTwAUTlFkLX9
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="332622318"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="332622318"
Received: from orsmga002.jf.intel.com ([10.7.209.21])
  by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 09:53:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="668121817"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="668121817"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by orsmga002.jf.intel.com with ESMTP; 10 Feb 2023 09:53:48 -0800
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 09:53:47 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 09:53:47 -0800
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 09:53:47 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.168)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 09:53:46 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Sk+g35UL3zgBiT1YBwXqX5/QFx+/EfLluZO+KwFe26xa4BJlehJZhJX98ohFeWdCLvTafZtOgJX1QNkkg2OXQsBOeuPodqc/+vOPU0uHne5RwbMASjnWwUvmuHaDok6yBAqIM9ftSSqVfSKJNoqTwu1U3tJi0mZR5/3FR7pwXn7xnx+m3Fwz2NLi8KkjMbed1OQuYogcm38C4pdRZmB30MhiG1Nuq2hG0nsVSrSyBY3nOPEDpxbPpJzGkjWRlIgfnEsPtVuPigNAW8NvX9u+FVUrEivo9SS1VCZLwMzXe8/lJ5dqLN7TNZceisnGxMGEq6ZR0zDguzUBLXw+epXQJQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=F/7XIJZwso05h2YP82Wv6bkHoRHvK8xt2yj3VV8M+lk=;
 b=PvGlimYpUfM/qSvmfN6FkNvXcXkg7+YI8oNKSm0FmFOHgJw3y7jmOTWePuU4VPLKVlc8xxouav1We3pblxwIFPjbqUGpgAwr5erL96smoGufwU2XhkQOUBBFyx3LlEs07ybcS3F6qkihcIAwUhoeURb223SHjPa1AQMRusnLp/DB9jNNJbTN41mX1cUbw0fJsBiiGxEJ9ykGSyo9zUL8aYA41pICI6fpVFQjBSeMLLyq9WD+xAcsJHUI8sbz1Fi+uzYpghYC2jZiO09g57lUvQ71IBthsvll0ahWGKylVlhfJQaJcGeUwrjizKlOknckEp37NiVNfMWRvqFJNhpQEw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by CH3PR11MB7347.namprd11.prod.outlook.com (2603:10b6:610:14f::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 17:53:38 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.020; Fri, 10 Feb 2023
 17:53:38 +0000
Date: Fri, 10 Feb 2023 09:53:35 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Dan Williams <dan.j.williams@intel.com>,
        <linux-cxl@vger.kernel.org>
CC: Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        "Kees Cook" <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        "Dave Hansen" <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>,
        "Gregory Price" <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, <linux-mm@kvack.org>,
        <linux-acpi@vger.kernel.org>
Subject: RE: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
Message-ID: <63e6849f4c1a5_36c729462@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
X-ClientProxiedBy: BYAPR01CA0060.prod.exchangelabs.com (2603:10b6:a03:94::37)
 To PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|CH3PR11MB7347:EE_
X-MS-Office365-Filtering-Correlation-Id: 80ae3f04-d931-4562-3d8b-08db0b8fbd02
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: bzYHLjEPzeSBNoObRoK27DMmepPAemujIugd2MUu9RyV/fVn0sRyMxTnH54QVKEx+eHzsQlU8K6TmLnqmGbhcrKfRn6przU4bsirhL6scADObpwTR3EbI4oH60jwcqpY3JPQiQQl2CYFswVe4BKAZsTdlW9UCyj6xgj/YbpD8aXhQe3v+zsvP9gYcXBU9YTUXBRFtw5lJf6I03muDCuOJG3z/F12yiDNZi5HwGtLNPW9TDf3mCyroZ9zkFTv2jvOAUaoCFfEfHMH/uGGWPXkukL9DGqPJGFnGgtb72LphsPRIPF0Uy9fQwDmLVAqVEGdyUOHdEG19AU55ho80Z8TV5e2YXlnl+5AWSfnyw4Zu92sYuo/ROJPXfaU+55acvkg+cFuQRQY3GBlnzIatvz31jfCfUudd9Mxlps5LTMdYzGMbyVvnhcl7SEbIL5RoEsrMCG5O1YfxT3Ko1VUla/yVp//7efpHGHIZtjmHw4UEwzxcbkhT7aibWix6hbOwji5N8I7YrWRD7MJvzC8WWfo032yc9ZGAIbKNSpCADmwIF9eBnvjWxkBDucajBk/yrpUHGmOO5Mw4l7C9M5R4xNcHFAMGaySwehxzawLYOxnUOsyF1tkiig5AXBrBLE81ZDt8am/r8/TtnOjgSUckMMY1FRroRwbsnVzVjt9XFKevuwNWcykkthy0y6nPRnc+JaJWS52x4nZVrLQPiGQGJTnKg==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(366004)(39860400002)(376002)(346002)(136003)(396003)(451199018)(38100700002)(82960400001)(86362001)(7416002)(2906002)(8936002)(66556008)(66946007)(66476007)(4326008)(5660300002)(8676002)(41300700001)(83380400001)(316002)(54906003)(966005)(26005)(186003)(9686003)(6666004)(6506007)(6512007)(6486002)(478600001);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?e8/5vLSeJhFAuIcD305yH8UT3M7a/q3hRjHAt1QPYCNAQpEWlJAyplG8Kd03?=
 =?us-ascii?Q?Fm/COfImraJ0x2elT/ZCjDbBpM9I/LUAONrGg+zmtqk19L6Q9bHiiNX0i6fO?=
 =?us-ascii?Q?nE4PDoZ/P0chnLrz4TN46T0Io+MjTwUiNFva2YJptMrEDnMQwUPs8DRPLjYy?=
 =?us-ascii?Q?WHNWRk/WhcDyuajIC4o3Ujajhk850N1ML2e+5YQgCrzl7QljiGXmFEsM2PQZ?=
 =?us-ascii?Q?qrl/XezAsrxxqtam7M+MSi6AK+t6X7JDcP0I2N1nYJvITojK5S7PbTlx0SZG?=
 =?us-ascii?Q?BMqTS6qvAxfSWjDaniuaoHjLwEq9KYSQotkYpTnBP148hKUuMh9Jy7jyekQW?=
 =?us-ascii?Q?OWONvYGtkJPQ8oEFyvbjhWelr1nUILY+xNqeP0R4pF9FySb0Rvwx/Xx9BXdQ?=
 =?us-ascii?Q?X+K6L2UBMpkD1MSpS1jyGzA9KalooAcKKo9+lFALNs2wCT6vAWYKw7Tr15TW?=
 =?us-ascii?Q?ql16u++WPquNp5EhBItj3lTJf/LyyBcX/ry/ELez5HLcs3mjPg2wk6CvBPOV?=
 =?us-ascii?Q?4VRKuB08eEA6ibgxVwJ3j114Zieu7skzwRaq4jpyi5r7RjkHT8NtNg5aihD+?=
 =?us-ascii?Q?FSPG6PoBFCXeC2wXc8ZdHK70pRc5olm0c6acFfemtYupSZQ+QEjmbjUgbCQd?=
 =?us-ascii?Q?VYLx4AxHg7wSAG/n4BpmfDC1ofM4arHGXEmSs4hNpn4JFJQGYBNgu/JOr+Kn?=
 =?us-ascii?Q?i+hVqlMoP+Hj43Doz1m96WD3hawRyxBjFWOVCsI/T98dCGvci6NXI8qXfSrI?=
 =?us-ascii?Q?9ISM8wmV74ZtEGn6tcyCffB62vnmvdAiyTAPj0nvqTT8LOer4U0A8C0H5apF?=
 =?us-ascii?Q?6s7s7LYA8vu+eAOAxKCf12DRyVWBFO9NFZ32hPqdGD/uSaZjx7PvJg53v959?=
 =?us-ascii?Q?k4uKapJNYfIZKmOOhMjG2J4/3adca+515wXnmtLXytHtWcflFmpnBAoIcvCt?=
 =?us-ascii?Q?pU7ZAE4f60FLPPeuGK+bgTza34vOmp4w4Ze3C1oY5koZ54iC9ngx7ARu6txZ?=
 =?us-ascii?Q?U+XxBPEeNhZc7zK9nG0fhi1Cali5uaPLrCGopU9crxczvW0BwfjAP11d8PDQ?=
 =?us-ascii?Q?ZCurEDBxDShagJ/hoSmbkgrNqqhk+7WEajFigLtTc/JLxpOstcB74IcOzjvV?=
 =?us-ascii?Q?9EuaqezBIRSYEH6MOD/Mb4DBG2HkDqbXYd+J3aYHTw1vVyp6MmDRdsmLwHCi?=
 =?us-ascii?Q?Bg1+wql/EyNbGIgZ/VxrM/z1iaLhyiO0JMbZXN58YE+kPG1nysdfVMlsl2m+?=
 =?us-ascii?Q?k9nwzRdVd9sgPSQCYEonAIUw4sUtZ9WWfwSBgozGW/I0ZJtle5/fUuWUeOJr?=
 =?us-ascii?Q?jFKODgnbWSSH+GIusyENqhovBLCZvscQ3Aaqf0E7Go+zQSsBSFMsU59Z3eMy?=
 =?us-ascii?Q?w/MJVDtZbxIEi8FgN5Rb5bDQgqHgfzHaPCldcVAUlQ3izMB+gnBCbPDzcZRO?=
 =?us-ascii?Q?PK6s1hN8XhUi7d8sdzSPzB6nCLHaCJ5X7zudkuguP4M7ctGUGFhM7qcp85iT?=
 =?us-ascii?Q?XCuuhqAxDrZjZhHgC68LW7e+U786AIFPPR0LtUfUmfYwA1IwplNCRcia0azv?=
 =?us-ascii?Q?FruwbVZKBSgpbqk4sYIGqjUeZhbEVujvUJcWPvodXwnYTuFCTmnwr0HuxD6v?=
 =?us-ascii?Q?Ug=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 80ae3f04-d931-4562-3d8b-08db0b8fbd02
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 17:53:38.4526
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: SjGmSra6LVpzaLVsc4LThimjHWptbiXAjniJQryXl40Kg1OQZC1yoc/ZMZEKUEyjXz+1sOM5Wn1MVHXS4XCjw7IfjvPvVTqJrIZYYzvTpG8=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR11MB7347
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Dan Williams wrote:
> Changes since v1: [1]
> - Add a fix for memdev removal racing port removal (found by unit tests)
> - Add a fix to unwind region target list updates on error in
>   cxl_region_attach() (Jonathan)
> - Move the passthrough decoder fix for submission for v6.2-final (Greg)
> - Fix wrong initcall for cxl_core (Gregory and Davidlohr)
> - Add an endpoint decoder state (CXL_DECODER_STATE_AUTO) to replace
>   the flag CXL_DECODER_F_AUTO (Jonathan)
> - Reflow cmp_decode_pos() to reduce levels of indentation (Jonathan)
> - Fix a leaked reference count in cxl_add_to_region() (Jonathan)
> - Make cxl_add_to_region() return an error (Jonathan)
> - Fix several spurious whitespace changes (Jonathan)
> - Cleanup some spurious changes from the tools/testing/cxl update
>   (Jonathan)
> - Test for == CXL_CONFIG_COMMIT rather than >= CXL_CONFIG_COMMIT
>   (Jonathan)
> - Add comment to clarify device_attach() return code expectation in
>   cxl_add_to_region() (Jonathan)
> - Add a patch to split cxl_port_probe() into switch and endpoint port
>   probe calls (Jonathan)
> - Collect reviewed-by and tested-by tags
> 
> [1]: http://lore.kernel.org/r/167564534874.847146.5222419648551436750.stgit@dwillia2-xfh.jf.intel.com
> 
> ---
> Cover letter same as v1

Thanks for all the review so far! The outstanding backlog is still too
high to definitively say this will make v6.3:

http://lore.kernel.org/r/167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com
http://lore.kernel.org/r/167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com

...what I plan to do is provisionally include it in -next and then make
a judgement call next Friday.

I am encouraged by Fan's test results:

http://lore.kernel.org/r/20230208173720.GA709329@bgt-140510-bm03

...and am reminded that there are some non-trivial TODOs pent up behind
region enumeration:

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9ea4dcf49878

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5B973C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 18:10:07 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232760AbjBJSKG (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:10:06 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36646 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232742AbjBJSKF (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 13:10:05 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 04EA8677B3;
        Fri, 10 Feb 2023 10:10:03 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD1qy4DPdz67xhs;
        Sat, 11 Feb 2023 02:05:50 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 18:10:00 +0000
Date: Fri, 10 Feb 2023 18:09:58 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <20230210180958.00002e5a@Huawei.com>
In-Reply-To: <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml100004.china.huawei.com (7.191.162.219) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:06:39 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Region autodiscovery is an asynchronous state machine advanced by
> cxl_port_probe(). After the decoders on an endpoint port are enumerated
> they are scanned for actively enabled instances. Each active decoder is
> flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> If a region does not already exist for the address range setting of the
> decoder one is created. That creation process may race with other
> decoders of the same region being discovered since cxl_port_probe() is
> asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> introduced to mitigate that race.
> 
> Once all decoders have arrived, "p->nr_targets == p->interleave_ways",
> they are sorted by their relative decode position. The sort algorithm
> involves finding the point in the cxl_port topology where one leg of the
> decode leads to deviceA and the other deviceB. At that point in the
> topology the target order in the 'struct cxl_switch_decoder' indicates
> the relative position of those endpoint decoders in the region.
> 
> >From that point the region goes through the same setup and validation 
Why the >? 
> steps as user-created regions, but instead of programming the decoders
> it validates that driver would have written the same values to the
> decoders as were already present.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

A few trivial things inline and this being complex code I'm not
as confident about it as the rest of the series but with that in mind
and the fact I didn't find anything that looked broken...

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

...



> +
> +static int cxl_region_sort_targets(struct cxl_region *cxlr)
> +{
> +	struct cxl_region_params *p = &cxlr->params;
> +	int i, rc = 0;
> +
> +	sort(p->targets, p->nr_targets, sizeof(p->targets[0]), cmp_decode_pos,
> +	     NULL);
> +
> +	for (i = 0; i < p->nr_targets; i++) {
> +		struct cxl_endpoint_decoder *cxled = p->targets[i];
> +
> +		if (cxled->pos < 0)
> +			rc = -ENXIO;

If it makes sense to carry on after pos < 0 I'd like to see a comment here
on why.  If not, nicer to have a separate dev_dbg() for failed case nad
direct return here.

> +		cxled->pos = i;
> +	}
> +
> +	dev_dbg(&cxlr->dev, "region sort %s\n", rc ? "failed" : "successful");
> +	return rc;
> +}
> +

> +
> +int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
> +{
> +	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
> +	struct range *hpa = &cxled->cxld.hpa_range;
> +	struct cxl_decoder *cxld = &cxled->cxld;
> +	struct cxl_root_decoder *cxlrd;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	bool attach = false;
> +	struct device *dev;
> +	int rc;
> +
> +	dev = device_find_child(&root->dev, &cxld->hpa_range,
> +				match_decoder_by_range);
> +	if (!dev) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s no CXL window for range %#llx:%#llx\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
> +			cxld->hpa_range.start, cxld->hpa_range.end);
> +		return -ENXIO;
> +	}
> +
> +	cxlrd = to_cxl_root_decoder(dev);
> +
> +	/*
> +	 * Ensure that if multiple threads race to construct_region() for @hpa
> +	 * one does the construction and the others add to that.
> +	 */
> +	mutex_lock(&cxlrd->range_lock);
> +	dev = device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
> +				match_region_by_range);
> +	if (!dev)
> +		cxlr = construct_region(cxlrd, cxled);
> +	else
> +		cxlr = to_cxl_region(dev);
> +	mutex_unlock(&cxlrd->range_lock);
> +
> +	if (IS_ERR(cxlr)) {
> +		rc = PTR_ERR(cxlr);
> +		goto out;
> +	}
> +
> +	attach_target(cxlr, cxled, -1, TASK_UNINTERRUPTIBLE);
> +
> +	down_read(&cxl_region_rwsem);
> +	p = &cxlr->params;
> +	attach = p->state == CXL_CONFIG_COMMIT;
> +	up_read(&cxl_region_rwsem);
> +
> +	if (attach) {
> +		int rc = device_attach(&cxlr->dev);

Shadowing int rc isn't great for readability. Just call it rc2 or something :)
Or given you don't make use of the value...

		/*
		 * If device_attach() fails the range may still be active via
		 * the platform-firmware memory map, otherwise the driver for
		 * regions is local to this file, so driver matching can't fail
+                * and hence device_attach() cannot return 1.

//very much not obvious otherwise to anyone who isn't far too familiar with device_attach()

		 */
		if (device_attach(&cxlr->dev) < 0)
			dev_err()
> +
> +		/*
> +		 * If device_attach() fails the range may still be active via
> +		 * the platform-firmware memory map, otherwise the driver for
> +		 * regions is local to this file, so driver matching can't fail.
> +		 */
> +		if (rc < 0)
> +			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
> +				p->res);
> +	}
> +
> +	put_device(&cxlr->dev);
> +out:
> +	put_device(&cxlrd->cxlsd.cxld.dev);

Moderately horrible.  Maybe just keep an extra local variable around for the first
use of struct device *dev?  or maybe add a put_cxl_root_decoder() helper?

There are lots of other deep structure access like this I guess, so I don't mind
if you just leave this as yet another one.


> +	return rc;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);

...

> diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
> index a8d46a67b45e..d88518836c2d 100644
> --- a/drivers/cxl/port.c
> +++ b/drivers/cxl/port.c
> @@ -30,6 +30,34 @@ static void schedule_detach(void *cxlmd)
>  	schedule_cxl_memdev_detach(cxlmd);
>  }
>  
> +static int discover_region(struct device *dev, void *root)
> +{
> +	struct cxl_endpoint_decoder *cxled;
> +	int rc;
> +
> +	if (!is_endpoint_decoder(dev))
> +		return 0;
> +
> +	cxled = to_cxl_endpoint_decoder(dev);
> +	if ((cxled->cxld.flags & CXL_DECODER_F_ENABLE) == 0)
> +		return 0;
> +
> +	if (cxled->state != CXL_DECODER_STATE_AUTO)
> +		return 0;
> +
> +	/*
> +	 * Region enumeration is opportunistic, if this add-event fails,
> +	 * continue to the next endpoint decoder.
> +	 */
> +	rc = cxl_add_to_region(root, cxled);
> +	if (rc)
> +		dev_dbg(dev, "failed to add to region: %#llx-%#llx\n",
> +			cxled->cxld.hpa_range.start, cxled->cxld.hpa_range.end);
> +
> +	return 0;
> +}
> +
> +

Two blank lines?

>  static int cxl_switch_port_probe(struct cxl_port *port)
>  {

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8EAE8C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 18:12:21 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232520AbjBJSMU (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:12:20 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38638 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231970AbjBJSMT (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 13:12:19 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1EDA73A0AC;
        Fri, 10 Feb 2023 10:12:17 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD1xd50LFz6J91l;
        Sat, 11 Feb 2023 02:10:45 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 18:12:14 +0000
Date: Fri, 10 Feb 2023 18:12:13 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 14/20] tools/testing/cxl: Define a fixed volatile
 configuration to parse
Message-ID: <20230210181213.00001941@Huawei.com>
In-Reply-To: <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:06:45 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> Take two endpoints attached to the first switch on the first host-bridge
> in the cxl_test topology and define a pre-initialized region. This is a
> x2 interleave underneath a x1 CXL Window.
> 
> $ modprobe cxl_test
> $ # cxl list -Ru
> {
>   "region":"region3",
>   "resource":"0xf010000000",
>   "size":"512.00 MiB (536.87 MB)",
>   "interleave_ways":2,
>   "interleave_granularity":4096,
>   "decode_state":"commit"
> }
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564541523.847146.12199636368812381475.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
The few things I commented on v1 resolved so
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

> ---
>  drivers/cxl/core/core.h      |    3 -
>  drivers/cxl/core/hdm.c       |    3 +
>  drivers/cxl/core/port.c      |    2 +
>  drivers/cxl/cxl.h            |    2 +
>  drivers/cxl/cxlmem.h         |    3 +
>  tools/testing/cxl/test/cxl.c |  147 +++++++++++++++++++++++++++++++++++++++---
>  6 files changed, 146 insertions(+), 14 deletions(-)
> 
> diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
> index 5eb873da5a30..479f01da6d35 100644
> --- a/drivers/cxl/core/core.h
> +++ b/drivers/cxl/core/core.h
> @@ -57,9 +57,6 @@ resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
>  resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
>  extern struct rw_semaphore cxl_dpa_rwsem;
>  
> -bool is_switch_decoder(struct device *dev);
> -struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
> -
>  int cxl_memdev_init(void);
>  void cxl_memdev_exit(void);
>  void cxl_mbox_init(void);
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index 8c29026a4b9d..80eccae6ba9e 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -279,7 +279,7 @@ static int __cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>  	return 0;
>  }
>  
> -static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
> +int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>  				resource_size_t base, resource_size_t len,
>  				resource_size_t skipped)
>  {
> @@ -295,6 +295,7 @@ static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>  
>  	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
>  }
> +EXPORT_SYMBOL_NS_GPL(devm_cxl_dpa_reserve, CXL);
>  
>  resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled)
>  {
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 59620528571a..b45d2796ef35 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -458,6 +458,7 @@ bool is_switch_decoder(struct device *dev)
>  {
>  	return is_root_decoder(dev) || dev->type == &cxl_decoder_switch_type;
>  }
> +EXPORT_SYMBOL_NS_GPL(is_switch_decoder, CXL);
>  
>  struct cxl_decoder *to_cxl_decoder(struct device *dev)
>  {
> @@ -485,6 +486,7 @@ struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev)
>  		return NULL;
>  	return container_of(dev, struct cxl_switch_decoder, cxld.dev);
>  }
> +EXPORT_SYMBOL_NS_GPL(to_cxl_switch_decoder, CXL);
>  
>  static void cxl_ep_release(struct cxl_ep *ep)
>  {
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index c8ee4bb8cce6..2ac344235235 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -653,8 +653,10 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
>  
>  struct cxl_decoder *to_cxl_decoder(struct device *dev);
>  struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
> +struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>  struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
>  bool is_root_decoder(struct device *dev);
> +bool is_switch_decoder(struct device *dev);
>  bool is_endpoint_decoder(struct device *dev);
>  struct cxl_root_decoder *cxl_root_decoder_alloc(struct cxl_port *port,
>  						unsigned int nr_targets,
> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
> index c9da3c699a21..bf7d4c5c8612 100644
> --- a/drivers/cxl/cxlmem.h
> +++ b/drivers/cxl/cxlmem.h
> @@ -81,6 +81,9 @@ static inline bool is_cxl_endpoint(struct cxl_port *port)
>  }
>  
>  struct cxl_memdev *devm_cxl_add_memdev(struct cxl_dev_state *cxlds);
> +int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
> +			 resource_size_t base, resource_size_t len,
> +			 resource_size_t skipped);
>  
>  static inline struct cxl_ep *cxl_ep_load(struct cxl_port *port,
>  					 struct cxl_memdev *cxlmd)
> diff --git a/tools/testing/cxl/test/cxl.c b/tools/testing/cxl/test/cxl.c
> index 920bd969c554..5342f69d70d2 100644
> --- a/tools/testing/cxl/test/cxl.c
> +++ b/tools/testing/cxl/test/cxl.c
> @@ -703,6 +703,142 @@ static int mock_decoder_reset(struct cxl_decoder *cxld)
>  	return 0;
>  }
>  
> +static void default_mock_decoder(struct cxl_decoder *cxld)
> +{
> +	cxld->hpa_range = (struct range){
> +		.start = 0,
> +		.end = -1,
> +	};
> +
> +	cxld->interleave_ways = 1;
> +	cxld->interleave_granularity = 256;
> +	cxld->target_type = CXL_DECODER_EXPANDER;
> +	cxld->commit = mock_decoder_commit;
> +	cxld->reset = mock_decoder_reset;
> +}
> +
> +static int first_decoder(struct device *dev, void *data)
> +{
> +	struct cxl_decoder *cxld;
> +
> +	if (!is_switch_decoder(dev))
> +		return 0;
> +	cxld = to_cxl_decoder(dev);
> +	if (cxld->id == 0)
> +		return 1;
> +	return 0;
> +}
> +
> +static void mock_init_hdm_decoder(struct cxl_decoder *cxld)
> +{
> +	struct acpi_cedt_cfmws *window = mock_cfmws[0];
> +	struct platform_device *pdev = NULL;
> +	struct cxl_endpoint_decoder *cxled;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct cxl_port *port, *iter;
> +	const int size = SZ_512M;
> +	struct cxl_memdev *cxlmd;
> +	struct cxl_dport *dport;
> +	struct device *dev;
> +	bool hb0 = false;
> +	u64 base;
> +	int i;
> +
> +	if (is_endpoint_decoder(&cxld->dev)) {
> +		cxled = to_cxl_endpoint_decoder(&cxld->dev);
> +		cxlmd = cxled_to_memdev(cxled);
> +		WARN_ON(!dev_is_platform(cxlmd->dev.parent));
> +		pdev = to_platform_device(cxlmd->dev.parent);
> +
> +		/* check is endpoint is attach to host-bridge0 */
> +		port = cxled_to_port(cxled);
> +		do {
> +			if (port->uport == &cxl_host_bridge[0]->dev) {
> +				hb0 = true;
> +				break;
> +			}
> +			if (is_cxl_port(port->dev.parent))
> +				port = to_cxl_port(port->dev.parent);
> +			else
> +				port = NULL;
> +		} while (port);
> +		port = cxled_to_port(cxled);
> +	}
> +
> +	/*
> +	 * The first decoder on the first 2 devices on the first switch
> +	 * attached to host-bridge0 mock a fake / static RAM region. All
> +	 * other decoders are default disabled. Given the round robin
> +	 * assignment those devices are named cxl_mem.0, and cxl_mem.4.
> +	 *
> +	 * See 'cxl list -BMPu -m cxl_mem.0,cxl_mem.4'
> +	 */
> +	if (!hb0 || pdev->id % 4 || pdev->id > 4 || cxld->id > 0) {
> +		default_mock_decoder(cxld);
> +		return;
> +	}
> +
> +	base = window->base_hpa;
> +	cxld->hpa_range = (struct range) {
> +		.start = base,
> +		.end = base + size - 1,
> +	};
> +
> +	cxld->interleave_ways = 2;
> +	eig_to_granularity(window->granularity, &cxld->interleave_granularity);
> +	cxld->target_type = CXL_DECODER_EXPANDER;
> +	cxld->flags = CXL_DECODER_F_ENABLE;
> +	cxled->state = CXL_DECODER_STATE_AUTO;
> +	port->commit_end = cxld->id;
> +	devm_cxl_dpa_reserve(cxled, 0, size / cxld->interleave_ways, 0);
> +	cxld->commit = mock_decoder_commit;
> +	cxld->reset = mock_decoder_reset;
> +
> +	/*
> +	 * Now that endpoint decoder is set up, walk up the hierarchy
> +	 * and setup the switch and root port decoders targeting @cxlmd.
> +	 */
> +	iter = port;
> +	for (i = 0; i < 2; i++) {
> +		dport = iter->parent_dport;
> +		iter = dport->port;
> +		dev = device_find_child(&iter->dev, NULL, first_decoder);
> +		/*
> +		 * Ancestor ports are guaranteed to be enumerated before
> +		 * @port, and all ports have at least one decoder.
> +		 */
> +		if (WARN_ON(!dev))
> +			continue;
> +		cxlsd = to_cxl_switch_decoder(dev);
> +		if (i == 0) {
> +			/* put cxl_mem.4 second in the decode order */
> +			if (pdev->id == 4)
> +				cxlsd->target[1] = dport;
> +			else
> +				cxlsd->target[0] = dport;
> +		} else
> +			cxlsd->target[0] = dport;
> +		cxld = &cxlsd->cxld;
> +		cxld->target_type = CXL_DECODER_EXPANDER;
> +		cxld->flags = CXL_DECODER_F_ENABLE;
> +		iter->commit_end = 0;
> +		/*
> +		 * Switch targets 2 endpoints, while host bridge targets
> +		 * one root port
> +		 */
> +		if (i == 0)
> +			cxld->interleave_ways = 2;
> +		else
> +			cxld->interleave_ways = 1;
> +		cxld->interleave_granularity = 256;
> +		cxld->hpa_range = (struct range) {
> +			.start = base,
> +			.end = base + size - 1,
> +		};
> +		put_device(dev);
> +	}
> +}
> +
>  static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>  {
>  	struct cxl_port *port = cxlhdm->port;
> @@ -748,16 +884,7 @@ static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>  			cxld = &cxled->cxld;
>  		}
>  
> -		cxld->hpa_range = (struct range) {
> -			.start = 0,
> -			.end = -1,
> -		};
> -
> -		cxld->interleave_ways = min_not_zero(target_count, 1);
> -		cxld->interleave_granularity = SZ_4K;
> -		cxld->target_type = CXL_DECODER_EXPANDER;
> -		cxld->commit = mock_decoder_commit;
> -		cxld->reset = mock_decoder_reset;
> +		mock_init_hdm_decoder(cxld);
>  
>  		if (target_count) {
>  			rc = device_for_each_child(port->uport, &ctx,
> 
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 28BECC636CD
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 18:26:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233062AbjBJS04 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:26:56 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52706 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233067AbjBJS0y (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 13:26:54 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 370C77CC95;
        Fri, 10 Feb 2023 10:26:13 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD2BQ08fnz6J64s;
        Sat, 11 Feb 2023 02:21:50 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 18:25:59 +0000
Date: Fri, 10 Feb 2023 18:25:58 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 18/20] dax/hmem: Move hmem device registration to
 dax_hmem.ko
Message-ID: <20230210182558.00005853@Huawei.com>
In-Reply-To: <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml100004.china.huawei.com (7.191.162.219) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:07:07 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> In preparation for the CXL region driver to take over the responsibility
> of registering device-dax instances for CXL regions, move the
> registration of "hmem" devices to dax_hmem.ko.
> 
> Previously the builtin component of this enabling
> (drivers/dax/hmem/device.o) would register platform devices for each
> address range and trigger the dax_hmem.ko module to load and attach
> device-dax instances to those devices. Now, the ranges are collected
> from the HMAT and EFI memory map walking, but the device creation is
> deferred. A new "hmem_platform" device is created which triggers
> dax_hmem.ko to load and register the platform devices.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564543923.847146.9030380223622044744.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

I'm not particularly familiar with this code, but you changes indeed
reflect what you describe above an appear correct to me.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B7F0FC636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 18:36:09 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232520AbjBJSgJ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:36:09 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58270 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232604AbjBJSgH (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 13:36:07 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7CABA6D635;
        Fri, 10 Feb 2023 10:36:04 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676054164; x=1707590164;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=dOo4WPZmm/7JTrc9XPEwSRLAKLJIAbDMR6eC57vvadg=;
  b=d1vJpXFa+xivXaGUjEoko6XOK7TD0rtlasz5pnvRcYHLk+ffgP2Sre9g
   9ac9J5u8LCrXLHlCQJNFgmFu6Y4xh3AATWb2YAkCnK6PgeYh9eRCQuWbG
   Ahb9+0mtbIKLIax11qwyC9HO2FfSr/grQb3xqPaKBBSwtnc82uikZZ7Cg
   Y7/GVXcZTesYOFHrdOWn28u3VOrL1VPGKCakE2/AxsuaucK1CtY6cWlNK
   S8VEL2UEv9R56s6ThFcXcPN5G5zdAWnqLZf8CTveH2QIBSmvBzIKSL8IP
   NSN0yJqQBTUAppUw0nJOwJVDEOEyyd6Guv+b5uP6pwy0cwlwVXNeBxgaX
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="416718255"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="416718255"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 10:36:04 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="645714590"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="645714590"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga006-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 10:36:03 -0800
Message-ID: <3ea4d6ae-a9e8-3ad4-2b08-86a7b53b956a@intel.com>
Date: Fri, 10 Feb 2023 11:36:02 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 14/20] tools/testing/cxl: Define a fixed volatile
 configuration to parse
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:06 AM, Dan Williams wrote:
> Take two endpoints attached to the first switch on the first host-bridge
> in the cxl_test topology and define a pre-initialized region. This is a
> x2 interleave underneath a x1 CXL Window.
> 
> $ modprobe cxl_test
> $ # cxl list -Ru
> {
>    "region":"region3",
>    "resource":"0xf010000000",
>    "size":"512.00 MiB (536.87 MB)",
>    "interleave_ways":2,
>    "interleave_granularity":4096,
>    "decode_state":"commit"
> }
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564541523.847146.12199636368812381475.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   drivers/cxl/core/core.h      |    3 -
>   drivers/cxl/core/hdm.c       |    3 +
>   drivers/cxl/core/port.c      |    2 +
>   drivers/cxl/cxl.h            |    2 +
>   drivers/cxl/cxlmem.h         |    3 +
>   tools/testing/cxl/test/cxl.c |  147 +++++++++++++++++++++++++++++++++++++++---
>   6 files changed, 146 insertions(+), 14 deletions(-)
> 
> diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
> index 5eb873da5a30..479f01da6d35 100644
> --- a/drivers/cxl/core/core.h
> +++ b/drivers/cxl/core/core.h
> @@ -57,9 +57,6 @@ resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled);
>   resource_size_t cxl_dpa_resource_start(struct cxl_endpoint_decoder *cxled);
>   extern struct rw_semaphore cxl_dpa_rwsem;
>   
> -bool is_switch_decoder(struct device *dev);
> -struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
> -
>   int cxl_memdev_init(void);
>   void cxl_memdev_exit(void);
>   void cxl_mbox_init(void);
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index 8c29026a4b9d..80eccae6ba9e 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -279,7 +279,7 @@ static int __cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>   	return 0;
>   }
>   
> -static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
> +int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>   				resource_size_t base, resource_size_t len,
>   				resource_size_t skipped)
>   {
> @@ -295,6 +295,7 @@ static int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
>   
>   	return devm_add_action_or_reset(&port->dev, cxl_dpa_release, cxled);
>   }
> +EXPORT_SYMBOL_NS_GPL(devm_cxl_dpa_reserve, CXL);
>   
>   resource_size_t cxl_dpa_size(struct cxl_endpoint_decoder *cxled)
>   {
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 59620528571a..b45d2796ef35 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -458,6 +458,7 @@ bool is_switch_decoder(struct device *dev)
>   {
>   	return is_root_decoder(dev) || dev->type == &cxl_decoder_switch_type;
>   }
> +EXPORT_SYMBOL_NS_GPL(is_switch_decoder, CXL);
>   
>   struct cxl_decoder *to_cxl_decoder(struct device *dev)
>   {
> @@ -485,6 +486,7 @@ struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev)
>   		return NULL;
>   	return container_of(dev, struct cxl_switch_decoder, cxld.dev);
>   }
> +EXPORT_SYMBOL_NS_GPL(to_cxl_switch_decoder, CXL);
>   
>   static void cxl_ep_release(struct cxl_ep *ep)
>   {
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index c8ee4bb8cce6..2ac344235235 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -653,8 +653,10 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
>   
>   struct cxl_decoder *to_cxl_decoder(struct device *dev);
>   struct cxl_root_decoder *to_cxl_root_decoder(struct device *dev);
> +struct cxl_switch_decoder *to_cxl_switch_decoder(struct device *dev);
>   struct cxl_endpoint_decoder *to_cxl_endpoint_decoder(struct device *dev);
>   bool is_root_decoder(struct device *dev);
> +bool is_switch_decoder(struct device *dev);
>   bool is_endpoint_decoder(struct device *dev);
>   struct cxl_root_decoder *cxl_root_decoder_alloc(struct cxl_port *port,
>   						unsigned int nr_targets,
> diff --git a/drivers/cxl/cxlmem.h b/drivers/cxl/cxlmem.h
> index c9da3c699a21..bf7d4c5c8612 100644
> --- a/drivers/cxl/cxlmem.h
> +++ b/drivers/cxl/cxlmem.h
> @@ -81,6 +81,9 @@ static inline bool is_cxl_endpoint(struct cxl_port *port)
>   }
>   
>   struct cxl_memdev *devm_cxl_add_memdev(struct cxl_dev_state *cxlds);
> +int devm_cxl_dpa_reserve(struct cxl_endpoint_decoder *cxled,
> +			 resource_size_t base, resource_size_t len,
> +			 resource_size_t skipped);
>   
>   static inline struct cxl_ep *cxl_ep_load(struct cxl_port *port,
>   					 struct cxl_memdev *cxlmd)
> diff --git a/tools/testing/cxl/test/cxl.c b/tools/testing/cxl/test/cxl.c
> index 920bd969c554..5342f69d70d2 100644
> --- a/tools/testing/cxl/test/cxl.c
> +++ b/tools/testing/cxl/test/cxl.c
> @@ -703,6 +703,142 @@ static int mock_decoder_reset(struct cxl_decoder *cxld)
>   	return 0;
>   }
>   
> +static void default_mock_decoder(struct cxl_decoder *cxld)
> +{
> +	cxld->hpa_range = (struct range){
> +		.start = 0,
> +		.end = -1,
> +	};
> +
> +	cxld->interleave_ways = 1;
> +	cxld->interleave_granularity = 256;
> +	cxld->target_type = CXL_DECODER_EXPANDER;
> +	cxld->commit = mock_decoder_commit;
> +	cxld->reset = mock_decoder_reset;
> +}
> +
> +static int first_decoder(struct device *dev, void *data)
> +{
> +	struct cxl_decoder *cxld;
> +
> +	if (!is_switch_decoder(dev))
> +		return 0;
> +	cxld = to_cxl_decoder(dev);
> +	if (cxld->id == 0)
> +		return 1;
> +	return 0;
> +}
> +
> +static void mock_init_hdm_decoder(struct cxl_decoder *cxld)
> +{
> +	struct acpi_cedt_cfmws *window = mock_cfmws[0];
> +	struct platform_device *pdev = NULL;
> +	struct cxl_endpoint_decoder *cxled;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct cxl_port *port, *iter;
> +	const int size = SZ_512M;
> +	struct cxl_memdev *cxlmd;
> +	struct cxl_dport *dport;
> +	struct device *dev;
> +	bool hb0 = false;
> +	u64 base;
> +	int i;
> +
> +	if (is_endpoint_decoder(&cxld->dev)) {
> +		cxled = to_cxl_endpoint_decoder(&cxld->dev);
> +		cxlmd = cxled_to_memdev(cxled);
> +		WARN_ON(!dev_is_platform(cxlmd->dev.parent));
> +		pdev = to_platform_device(cxlmd->dev.parent);
> +
> +		/* check is endpoint is attach to host-bridge0 */
> +		port = cxled_to_port(cxled);
> +		do {
> +			if (port->uport == &cxl_host_bridge[0]->dev) {
> +				hb0 = true;
> +				break;
> +			}
> +			if (is_cxl_port(port->dev.parent))
> +				port = to_cxl_port(port->dev.parent);
> +			else
> +				port = NULL;
> +		} while (port);
> +		port = cxled_to_port(cxled);
> +	}
> +
> +	/*
> +	 * The first decoder on the first 2 devices on the first switch
> +	 * attached to host-bridge0 mock a fake / static RAM region. All
> +	 * other decoders are default disabled. Given the round robin
> +	 * assignment those devices are named cxl_mem.0, and cxl_mem.4.
> +	 *
> +	 * See 'cxl list -BMPu -m cxl_mem.0,cxl_mem.4'
> +	 */
> +	if (!hb0 || pdev->id % 4 || pdev->id > 4 || cxld->id > 0) {
> +		default_mock_decoder(cxld);
> +		return;
> +	}
> +
> +	base = window->base_hpa;
> +	cxld->hpa_range = (struct range) {
> +		.start = base,
> +		.end = base + size - 1,
> +	};
> +
> +	cxld->interleave_ways = 2;
> +	eig_to_granularity(window->granularity, &cxld->interleave_granularity);
> +	cxld->target_type = CXL_DECODER_EXPANDER;
> +	cxld->flags = CXL_DECODER_F_ENABLE;
> +	cxled->state = CXL_DECODER_STATE_AUTO;
> +	port->commit_end = cxld->id;
> +	devm_cxl_dpa_reserve(cxled, 0, size / cxld->interleave_ways, 0);
> +	cxld->commit = mock_decoder_commit;
> +	cxld->reset = mock_decoder_reset;
> +
> +	/*
> +	 * Now that endpoint decoder is set up, walk up the hierarchy
> +	 * and setup the switch and root port decoders targeting @cxlmd.
> +	 */
> +	iter = port;
> +	for (i = 0; i < 2; i++) {
> +		dport = iter->parent_dport;
> +		iter = dport->port;
> +		dev = device_find_child(&iter->dev, NULL, first_decoder);
> +		/*
> +		 * Ancestor ports are guaranteed to be enumerated before
> +		 * @port, and all ports have at least one decoder.
> +		 */
> +		if (WARN_ON(!dev))
> +			continue;
> +		cxlsd = to_cxl_switch_decoder(dev);
> +		if (i == 0) {
> +			/* put cxl_mem.4 second in the decode order */
> +			if (pdev->id == 4)
> +				cxlsd->target[1] = dport;
> +			else
> +				cxlsd->target[0] = dport;
> +		} else
> +			cxlsd->target[0] = dport;
> +		cxld = &cxlsd->cxld;
> +		cxld->target_type = CXL_DECODER_EXPANDER;
> +		cxld->flags = CXL_DECODER_F_ENABLE;
> +		iter->commit_end = 0;
> +		/*
> +		 * Switch targets 2 endpoints, while host bridge targets
> +		 * one root port
> +		 */
> +		if (i == 0)
> +			cxld->interleave_ways = 2;
> +		else
> +			cxld->interleave_ways = 1;
> +		cxld->interleave_granularity = 256;
> +		cxld->hpa_range = (struct range) {
> +			.start = base,
> +			.end = base + size - 1,
> +		};
> +		put_device(dev);
> +	}
> +}
> +
>   static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>   {
>   	struct cxl_port *port = cxlhdm->port;
> @@ -748,16 +884,7 @@ static int mock_cxl_enumerate_decoders(struct cxl_hdm *cxlhdm)
>   			cxld = &cxled->cxld;
>   		}
>   
> -		cxld->hpa_range = (struct range) {
> -			.start = 0,
> -			.end = -1,
> -		};
> -
> -		cxld->interleave_ways = min_not_zero(target_count, 1);
> -		cxld->interleave_granularity = SZ_4K;
> -		cxld->target_type = CXL_DECODER_EXPANDER;
> -		cxld->commit = mock_decoder_commit;
> -		cxld->reset = mock_decoder_reset;
> +		mock_init_hdm_decoder(cxld);
>   
>   		if (target_count) {
>   			rc = device_for_each_child(port->uport, &ctx,
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8E351C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 18:39:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232505AbjBJSjA (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:39:00 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33328 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232807AbjBJSjA (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 13:39:00 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id ED2942D16E;
        Fri, 10 Feb 2023 10:38:58 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PD2TL3Ctvz6J67f;
        Sat, 11 Feb 2023 02:34:46 +0800 (CST)
Received: from localhost (10.81.210.211) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 18:38:55 +0000
Date: Fri, 10 Feb 2023 18:38:54 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 20/20] cxl/dax: Create dax devices for CXL RAM
 regions
Message-ID: <20230210183854.000022ee@Huawei.com>
In-Reply-To: <167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.211]
X-ClientProxiedBy: lhrpeml100004.china.huawei.com (7.191.162.219) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, 10 Feb 2023 01:07:19 -0800
Dan Williams <dan.j.williams@intel.com> wrote:

> While platform firmware takes some responsibility for mapping the RAM
> capacity of CXL devices present at boot, the OS is responsible for
> mapping the remainder and hot-added devices. Platform firmware is also
> responsible for identifying the platform general purpose memory pool,
> typically DDR attached DRAM, and arranging for the remainder to be 'Soft
> Reserved'. That reservation allows the CXL subsystem to route the memory
> to core-mm via memory-hotplug (dax_kmem), or leave it for dedicated
> access (device-dax).
> 
> The new 'struct cxl_dax_region' object allows for a CXL memory resource
> (region) to be published, but also allow for udev and module policy to
> act on that event. It also prevents cxl_core.ko from having a module
> loading dependency on any drivers/dax/ modules.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564545116.847146.4741351262959589920.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

I've not yet gotten around to testing this version yet but from a read
through looks fine.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

I've skipped a patch or two where I felt I didn't have the expertise
to cover them adequately (and not enough time for now to get it...)
in particular the policy patch. Hopefully that will get
good review from others.

Jonathan



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 88162C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:14:11 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233552AbjBJVOK (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:14:10 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:35830 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232764AbjBJVOJ (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:14:09 -0500
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C692D635B2;
        Fri, 10 Feb 2023 13:14:08 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676063648; x=1707599648;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=BO34XjZLWGxBhKfn8yhJ9VDuVnjKXllAiqYv46Kdgc8=;
  b=dFzr3J6gUqOVhO7UzwK2G8k2cGN1t2jUmHmEhChVwSZIFr6DnQdaMRkV
   I+X3/JfKU7jn119wkN8UDyLyPrWmkvfAVLvhKevcV6EeNsDv/0VyTGorI
   PZqZrSETNt4qi4hgyZstG44pU/gAw9pMznq0JBHip4WOS/siwqSkctylw
   s0VPsVbKMFAzsjPL9Jrw4ziZQ6on5ID+dHItxzsPcnvKO+RYqBkviXQyN
   2LDlKYe2T4wy3QWn3diLyP6vFLmQXSnYkakWRi8Ms50EsByiFeWoVQ/SV
   2Pata/pJ5OsBx8V7i63SygDHHrrYL2Q/7+KP36dV1vui8au8OiwEeO26V
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="357927631"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="357927631"
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
  by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:14:08 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="756917700"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="756917700"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by FMSMGA003.fm.intel.com with ESMTP; 10 Feb 2023 13:14:08 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 13:14:07 -0800
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 13:14:07 -0800
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (104.47.70.100)
 by edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 13:14:07 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Rsk1ufPbGmVpk+E0X0gTT1/8a9C/tz/6Qm2kZXJkpLfF8In9GkPHZBGXax8vkfUa0WgoVaJeQ2ADggi8wnHoROPFTaNzBE6dy8cM4sO0BL/k0cjk+3RleIXEGraciXTCsjAoN5pir0Vbv7rz9zbzw2r7Tj3NXB8W1dVd1YYjyZmvRDgtPqh8aziY9BMY8YUMnlIs3568qznSzH9Vxnmqh8G8xWxixoKD/T45ziV+p/IDd8jKl9VjxyBQN1EZs91+aCySYaiw799xQR2NIitNLxznU+OIKGBiaHHIGoNwhMf43/WsLQN+qz0RhAi2pOcyGtr4KVZWgeAebmHhCG8dLw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=jFwxpGRszSuldtH2UxW4/JwCMP1MCiRsI7vh/KDBadA=;
 b=cRJvjL96eunugSnzuQ554ZKALWJ6nl1jGc+c/pDBIlt5YRvH+OhrbFdUFkZ8vGmfQS+jOntlc6w7OzosQCfvP1WCYMpwIu/QEi5uGx+ImM5S2RgNkB8T/kbjwKdZkJttPL/8CtYOGyUMyFmFHhMzQvoEuXkT/7BBZBmAwO7k9K5zhE4VkTVnDNo8RlA0B8MhaHGPN3rFbsSztGBoM8o1omZtvixddOeOF1nOPMfuhtP/vjZN8z3MwcgX+s9TAGYIRHYYHTKlvci8d1HdRJKvqEij/bhUbDOxwXGakOuHwtrT4AszKvxE/egeXi9K5Mhwi6BfXgYHSTusJLMXng6WYA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by MN2PR11MB4696.namprd11.prod.outlook.com (2603:10b6:208:26d::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 21:14:05 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.020; Fri, 10 Feb 2023
 21:14:05 +0000
Date: Fri, 10 Feb 2023 13:14:03 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, <vishal.l.verma@intel.com>,
        <dave.hansen@linux.intel.com>, <linux-mm@kvack.org>,
        <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 01/20] cxl/memdev: Fix endpoint port removal
Message-ID: <63e6b39b46bee_1db5d029497@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
 <20230210172850.00001d5b@Huawei.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230210172850.00001d5b@Huawei.com>
X-ClientProxiedBy: SJ0PR03CA0216.namprd03.prod.outlook.com
 (2603:10b6:a03:39f::11) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|MN2PR11MB4696:EE_
X-MS-Office365-Filtering-Correlation-Id: 5458929a-53b8-4a0e-447b-08db0babbdc8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: saOvIsvbO1DTv9E9n7P75ST7AJOF2nlbRfxqJZf7592iG0VrtSSSmxTQx5Gs+pYA/8HHYmBiLF8ewL8t3/RAo4rbQ2BtT33+0xr3xTMG1jaVXJlmMkK8dY3cjUD2/aQwxJwJZTyasfIYlOXQfZTv1kMiLW+zQsvs/ufJjKNTxgtce6lEjShcsmbxHq8V8oG+fvFzAoEomnyUQ9Hwa35W/jmEKKqErmODRONPGgycdrpXOxLGvmATGFz9jdUPBLbt6N6ipAvhDqc8ywv6lD1PlBhBDpwzMwwK9N2fwNjDCforxeEhFKv+H+hk5YG7lqDfgUkotn6YBCeCMYh7AKgElIjYEKmJCHuzV1z4nt2y+FuOCHMsPoaNkgkFcGzUq2exiii8xrdvq/cG/3DqqeFYgY+tbf+hpPDjnHvCh0axf/DnKNP2d1FYtyJkflMttnyjPKHHZOlfeicezG5Ucncy40y5z9IxICVFejfQD2idt5pND2QRxpDwn4fzyHj9VI7Sf4kIbv55zYQBWRRiwlnkwUFarQsn4fwelogi1lNVPJRsnM2df4EHGKQo9Gvc6gIHdLwW2IbDpTwBPP+EM2ZR6dRA5mhKRruc2TbHGb7K7WHwX2KoEWPanwRPi0sGGX225ixb6HGKpIq375sYz+Owaw==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(366004)(136003)(396003)(376002)(346002)(39860400002)(451199018)(86362001)(82960400001)(38100700002)(8936002)(66556008)(66476007)(41300700001)(66946007)(316002)(110136005)(8676002)(4326008)(5660300002)(2906002)(83380400001)(478600001)(186003)(6486002)(6512007)(9686003)(6506007)(26005);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?RkoixTQ9YdbquiyF07SWckLyjKi0Im2ta33rinwekP4Y9goZIryuDvkr32ku?=
 =?us-ascii?Q?BMXqrdNaWCLLWCr4Q2dU/6nJtnF1rR0hvSUrSuAvGThVEwTOXVRIF+TPDnIl?=
 =?us-ascii?Q?obXG/FL+xALmoBbjVixiL+28KG4rO4Qga96g4+TfmIv/RYsfHd4NsG3De5bR?=
 =?us-ascii?Q?SngexyTbDXRcUJ8E14e5g8BNIqjUQ6fW9lfwqS9FlWd/a103U5yv6tfsKYbG?=
 =?us-ascii?Q?rzN2nQbE4FNgfRqbyt/w2pMlvat2QDUBzFDSmM+kiaqnH3lAS1beSj+xlG8q?=
 =?us-ascii?Q?PNg26FDkDhhMHTOk8YYH7/xBKu+JNZNvzH4Mc5rB/GSPj4+BVqadNJ6dhxGk?=
 =?us-ascii?Q?H2A0w0fo8pPO0dGpqz2ea/5HJnG5o+dc5sEh/ms4KYjudcBJDxqxeyFUBabW?=
 =?us-ascii?Q?mijQxCziw134IDvkzA8mbj7n1q1UPPPxol+dT8n3lHgLd4bvvINUKNze0kj9?=
 =?us-ascii?Q?pj4bxsSMVPqvRITFglYpltBnXvVT4HJqPRSs9skWK1ihilcHjd0JKSoh/oWC?=
 =?us-ascii?Q?z4juYYdEmS4Vcr+iczmCOhO3JlAlinNFfq8IZSFuoMfgBQl6dU08LAGwJ4w/?=
 =?us-ascii?Q?DjSk8XihLoz3r8gk+ZWf17lgpJInZWcsn8Ez+RXqQU1MeOEnYexgry+pl2NL?=
 =?us-ascii?Q?QDLObezvQJO24enTqs2C2aQtr2DuiqBw02Y4AiGXqWrbvnK+U5XCs5dZlRja?=
 =?us-ascii?Q?XX93V9dF6jD8Rwn3dtG0j3N4BN74VtjvjbNLIoNTpw0SYe1IqzogGVAb5ldu?=
 =?us-ascii?Q?b2EleFzhIEjcUw9WoLqeZ0torEMbVCyzdGOF3XyTnwczk2t5f0cWpow0jdAu?=
 =?us-ascii?Q?s2R9STDd4tvSxEkBMfVjCN6SdOyLwRnMja/n5UnKEh3y9lr2Bzr06ubSWFwq?=
 =?us-ascii?Q?yX/PInznkp6XnscqFMVrqvY8/SXNSauIoVgS70VfwwL8dJwH8Cxw+t6selo7?=
 =?us-ascii?Q?QzDkghDXEHrb/yyA4bRxBpNjGsvhoJwM+qv5UX8pWvSyGo2hrl3RPvZLrRDD?=
 =?us-ascii?Q?eRs0izLfS2BtQA1XpJCHH6XcDNUUOn+G8Kh6K9b33aA0qsf8C+PbfvJWJxsB?=
 =?us-ascii?Q?06G+GahTZzYn+6BZ+H4n2HO52X7FJTp8To6hWcd8ZtO79hJnkdoLQWeBk4AO?=
 =?us-ascii?Q?U4kXBtCeni6AaV/G3rby4NEhg6MfMZeq8QEjaEUrd0oPxAnTE1VzMl7RWU1c?=
 =?us-ascii?Q?I9z7Vurq8763XWxCbtoORAo1ZuGeL51mY6OzpYySzAB/2qN1nYoYGka3kQ4u?=
 =?us-ascii?Q?m+Vp/DZCfbkzEIVx5WlqgsaeebkozXkjbnGh26t7CSHwPRYDGJxT3j1cIh6x?=
 =?us-ascii?Q?v8N/qpYb3YaMOEozE4i25PgCXvRXgA9GrWJqTPrH/heh6gB4LSJqwjIpb9HH?=
 =?us-ascii?Q?fbdDlZWl0Y8JtNR231UCdEioXvLYM4xCzURGWcU+XfBLFYY4VIXXRpewuTJi?=
 =?us-ascii?Q?BxuJRbjldwgMGHmjm0m7sIJ0UTbILe6A449Q/VWUIxKKYsDUsUdlJ0e+BLgB?=
 =?us-ascii?Q?/eSa2Ba8DLLROnOh5ftYuRCPyZrS4ScoNSym5AX38+WcxmY6Yg2vjQ3b3d5i?=
 =?us-ascii?Q?GsNQcPl2z7FI6ylM0UTdr8jw7vG1S392s+e3xxtkXX19oKWX9UQKqulgFzUL?=
 =?us-ascii?Q?Aw=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 5458929a-53b8-4a0e-447b-08db0babbdc8
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 21:14:05.5951
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: lyYwN0swIe2Pz9jSybfbw/eTtM+jJR3XGhou7VS5sh6+W3hoEVJajk5BG22QW+06fdjSOPjHfa8yT6BWLWHaqb22BjijYPuQcLFL7RI1XXI=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN2PR11MB4696
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan Cameron wrote:
> On Fri, 10 Feb 2023 01:05:27 -0800
> Dan Williams <dan.j.williams@intel.com> wrote:
> 
> > Testing of ram region support [1], stimulates a long standing bug in
> > cxl_detach_ep() where some cxl_ep_remove() cleanup is skipped due to
> > inability to walk ports after dports have been unregistered. That
> > results in a failure to re-register a memdev after the port is
> > re-enabled leading to a crash like the following:
> > 
> >     cxl_port_setup_targets: cxl region4: cxl_host_bridge.0:port4 iw: 1 ig: 256
> >     general protection fault, ...
> >     [..]
> >     RIP: 0010:cxl_region_setup_targets+0x897/0x9e0 [cxl_core]
> >     dev_name at include/linux/device.h:700
> >     (inlined by) cxl_port_setup_targets at drivers/cxl/core/region.c:1155
> >     (inlined by) cxl_region_setup_targets at drivers/cxl/core/region.c:1249
> >     [..]
> >     Call Trace:
> >      <TASK>
> >      attach_target+0x39a/0x760 [cxl_core]
> >      ? __mutex_unlock_slowpath+0x3a/0x290
> >      cxl_add_to_region+0xb8/0x340 [cxl_core]
> >      ? lockdep_hardirqs_on+0x7d/0x100
> >      discover_region+0x4b/0x80 [cxl_port]
> >      ? __pfx_discover_region+0x10/0x10 [cxl_port]
> >      device_for_each_child+0x58/0x90
> >      cxl_port_probe+0x10e/0x130 [cxl_port]
> >      cxl_bus_probe+0x17/0x50 [cxl_core]
> > 
> > Change the port ancestry walk to be by depth rather than by dport. This
> > ensures that even if a port has unregistered its dports a deferred
> > memdev cleanup will still be able to cleanup the memdev's interest in
> > that port.
> > 
> > The parent_port->dev.driver check is only needed for determining if the
> > bottom up removal beat the top-down removal, but cxl_ep_remove() can
> > always proceed.
> 
> Why can cxl_ep_remove() always proceed?  What stops it racing?
> Is it that we are holding a reference to the port at the time of the
> call so the release callback can't be called until we drop that?

Right, as long as a port reference is held then the cxl_ep_remove() at
cxl_port_release() can not race this one from memdev removal.
The result of cxl_ep_load() is guaranteed to stay stable until
the subsequent put_device().

> Anyhow, good to have a little more detail on the 'why' in the patch
> description (particularly for those reading this when half asleep like me ;)

Long day for you, I appreciate it!

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 33313C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:36:26 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233534AbjBJVgZ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:36:25 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:54064 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233284AbjBJVgY (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:36:24 -0500
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2A0CD32CDF;
        Fri, 10 Feb 2023 13:35:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676064949; x=1707600949;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=eHujy0CDGIHnqpC84TUVLj/84COPnbs2xTP2Pl847d0=;
  b=DUGuB/H31APf0790kjdJ7E4RJeRPD+Hj9OyitGbn9x2WQ+JInS226rH+
   dZBMhUYVBm+fzRpYzNPMiA9ng1VspEeBpNjWM04FD9QQWF+XLpPylKzNe
   NLIAa1aEEE9olEb2vm5+ukDDr9Rnl24jKU1oU0RRow63m22guzLl07blv
   em3lFjfbHm0BwyxE+8ovOQ8wWIEaE1mVlBLkt9lPj5KXtd3eDnQDrryj0
   fHhXwlGRmMmZm11fBfBXiwh2cIEGFUZKGeThDc1lMljep7elO3EFZ7dOd
   smDGWHiwEhfXX8Sj3c/jEbnxsx6Ow4WFaTqfeLP3RPpH3gdDZKqKo6tTt
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310162865"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="310162865"
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:35:23 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="756923951"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="756923951"
Received: from fmsmsx603.amr.corp.intel.com ([10.18.126.83])
  by FMSMGA003.fm.intel.com with ESMTP; 10 Feb 2023 13:35:23 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 13:35:22 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 13:35:22 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 13:35:22 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.169)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 13:35:22 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=e/HSBJOd4VpdxpAsSr/LmQKxIyFYQTNSi38JzTZXiQ++Os4K5FqzU1yj4epH/w6HB+DpbaIrlXqyKR8UCjLFnfsX4ghUXNaxbhNfMZS0NfsjTuCRdJRaW+qJqrUBNNsHPGPld6Z1vzlcoP8lLctiBKeoJ/d+LHXldwdBDD+WMVk0npwN0h7VlhxPo4JFRs/8nPBBHsV1UX/GoDBSrhc1WPCAKDbaq88eCvClT4xfshegglNm2/JywYbiy/uDgeWJkKWpDw0qWFqKC4UBDk76WIWnZ/NEqlzhrTfBkRvM569LPsMN+WbgEgviG0QUFLGV6Hv+looALjRT4wXCK+n0Dg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=zvMV6R2NEjcC2/OAfNdgjP44M5KXejWi6f7ILS5pfgo=;
 b=P0hRSINmue88Mjz5lER55XsCQP/L0Agj2TfaM3RJvpgEv/xPpXKP3PKnnQIEEJJzMJOpHEFJpGnuSE6yxzVe65Z3D1+N5k81VaC/igllx3A2beeCVaXEeHw7gwjMv0YuPdM4kUBJVKVbmzDWQx365O/14R/Z8Mqo/i+J6w/xrQCdAAj/5ETls89x97kdf0R3p8jbCEdg1dU84r8yS9/dPjd6oqnMiF3GaYd81EZQmLg5QdzDos+9q6YL/ybEQB5Z9Qg06hf4WkZI7OgMsk37lY0FVxeBY9oVREVUuX57/biDfnLHGSNROprdANHE519Oxm9r+QVK+ZqGPkmnnS/QqA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by SA0PR11MB4688.namprd11.prod.outlook.com (2603:10b6:806:72::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 21:35:20 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.020; Fri, 10 Feb 2023
 21:35:20 +0000
Date: Fri, 10 Feb 2023 13:35:17 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <63e6b89581c3c_1db5d029467@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
 <20230210180958.00002e5a@Huawei.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230210180958.00002e5a@Huawei.com>
X-ClientProxiedBy: BYAPR02CA0071.namprd02.prod.outlook.com
 (2603:10b6:a03:54::48) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|SA0PR11MB4688:EE_
X-MS-Office365-Filtering-Correlation-Id: 17ac955e-5909-4fa4-a1e0-08db0baeb54e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 1/C0KLOC9gzBPsJwoSgUx6tDjN/63BaCAPYahKTzKBVMliAmC40Gn4N5d+waI6xTinz/0m15hFYDiJ7RVxfCg4kb0U/Hji++uzTV36YoNuGb8mtt6v2ePSXnSii4AFy/NpVS4aPjiybIgYwAeWPfWqWAu6vwPESDjd6Mg6QZiBfpS1EGKsQW45gzWlQ8lFoIoWpFtiMkD3o/prctRE+UH9rOYfsrwUSIleujbRIQuacJ+GMnHUynGFTHeTlAMQ2SCR9Ui4tSLcUcvIpyLCv55NfCSsiBbfVidhVHWKpnjSXFHCZz2jFJZ4mA4g5O+e4FK2kf2hUD5ipGRS8uOLKmnEB+Kic6uhcTB56Z8iMAKNbrztKmYRS8rIPaGZw9lZPAkxu12Im1yJtXpu33Iihv2QnKHk33VGQqxLTN2jboj+nT78c01HOOWu8TR6cFbsco+JohK2OufSPIQUMjQn5zuNy/MzmDlDstbi8hLABPAwXUhk+vS/NGEKa91Grz9lWYfK5Je64m8dvxJdcYKpmho6pWiGesw2PZR4BfUn/iRA7uoW+xyBgNwp3VPivwFh6HVTXJbNDhfEFFNiAqE1yVUP3ZeujiK5CnxvPanUiAwZ+QNdYat6dqGBj95gRl4QV3UEQQC6XheP1WUtvVHfZxu5SBcyPsFHzVcHRiVJyyDcM=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(366004)(39860400002)(396003)(346002)(376002)(136003)(451199018)(2906002)(86362001)(82960400001)(38100700002)(6486002)(966005)(186003)(6506007)(9686003)(6512007)(26005)(66946007)(66476007)(83380400001)(66556008)(316002)(110136005)(6666004)(4326008)(41300700001)(478600001)(8676002)(5660300002)(8936002);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?+BYGcDTXdcJ1l6Rd1YLWf8ERnv9Mk8k+4C6XTVHI/izer2+MQiNWMTpLKT5X?=
 =?us-ascii?Q?LXVz3KS+Emhtee45YKCm/12Sgez9PY7Ivr1okEcPT61rNxD9ruze3Vsgtvr2?=
 =?us-ascii?Q?Ix5cjNuQ8i0tZyQJuRCTDM5s1enmefTTEXinu2S+hPR6T7blB9e6FIb6+XwR?=
 =?us-ascii?Q?RgriAArIAGGcFeeRTLXsczfBRNvzkT6BzwEt8fGxtIInfarDKpDlTigTbrp+?=
 =?us-ascii?Q?icMPaUswDA+eoGO8qIT8XATSprLisym8kWW60REHeoUnYxkrv2zk44lPptc0?=
 =?us-ascii?Q?OMxxEBk6e/xWwZOYL58UDpl4/3VsD34besIyUOzI+/qLBdGrq7EnthEoQ9ej?=
 =?us-ascii?Q?ZnROQ6P2IzPh9Ov8OYtTQL4PVdg8wauoR7MyDT3D7IOkvMxqrtI9rM1unMCA?=
 =?us-ascii?Q?YLkAvsTVx91uzoIfi3/gvwItcwIPwcp/H7N5Jmp3Sm2MmU4MClXp/2EwIZ/K?=
 =?us-ascii?Q?Bs6fVW9qEcPzoUdVHtiTJGGk305K0KMqmUwEE/xOQ1f6msE8ngvfLbgjCV3Z?=
 =?us-ascii?Q?uubQjUfFvkAddu102gM+PGE5VBC1ec9z6hRl8AKggiGfGj8u0gs1poU8xEXY?=
 =?us-ascii?Q?GZpGoUGesBS0X/iIzG1vvrx5c/CGeraWpm4icL9mhLig1ahR3rs4PZKsff1G?=
 =?us-ascii?Q?+khieKQuyJJm/GtlLVIw6rOVELl+Se+Cmxbf0uO/Hc3PMd2JxQjdC1wyY6Fn?=
 =?us-ascii?Q?mq/pD4kZVuo/p53hbGr4aJv37Z9Vf6wmyWhFzLK67k0aDPmJ5iQp1vUKIttW?=
 =?us-ascii?Q?wTXTe6JB35eXbqCMIfzaxcusOjyHt++7MKKaG0fah29fHqBlKC8QJXfzQA/Q?=
 =?us-ascii?Q?92n9avTXdeys8VJA0B9mTrwHcBQoX4xbUWK0BkKqBs0tkg1W4U3ygyfNaq4Z?=
 =?us-ascii?Q?ADJ+y1rM3zojnudsLphluiZadrZ039exsbJUD4ZhcKScOp3AGdEsaqZTbtaw?=
 =?us-ascii?Q?FuElgY8Hs2lfzHLTPhSPRwGzKtvgaOKiw2VxQ1udQ70PvB3gew9TlGeNuHKs?=
 =?us-ascii?Q?Fh+tpkxBSnBCL2bq9WIWWOUGT+AZdUp6h+cngLUfuIetbszE3sPJelOr81Z1?=
 =?us-ascii?Q?fR5FssO9I/unqB2AaWCB7V6Ddm7tqd6HvSTChWBd33CGoJ1UUjGiOiAXGShY?=
 =?us-ascii?Q?ud/whWk04A++bXEs0J9Li2Gl2LbVro02ic1BJFAeju2WL53YnvobtONrHLZh?=
 =?us-ascii?Q?cvDa4L1zFRAPjGT7ZXX0H1jfVOiN5azOQw8UKVlTJJLfbXEyK4Ag6EInsEps?=
 =?us-ascii?Q?RQsi7OWvkheV47j7ZmbOwyxp33d13dGp2yW9r4i21bDNixvZL+dSNDwXIoy7?=
 =?us-ascii?Q?Dbuzc8D1T6YLlJPl+3+v1jDr2Df0nl4PsvGctiv+h4Njl3HAAbOa9FfGABi6?=
 =?us-ascii?Q?oNoGUV+rWGrhWKmBpiR2ZMTbz7vPauo0i9cIvgtJtxryZTvhvOSlCd0Oa4TR?=
 =?us-ascii?Q?xyWBjvDShJfP6wMPZW7IVenDVaGQe5MknMoi6plMphppyKv88krePQmGqTnq?=
 =?us-ascii?Q?gbRcmrHmk+S5paVdrJiswkFxD64+wy9uTBcET6kpM2e2eztxWbFYDqllGFgR?=
 =?us-ascii?Q?6M/tsmDAlOx97mweX5Lk8iCqPKhU3/a+k2dX9dKIZxyl1IbUpXnQgS0dXevj?=
 =?us-ascii?Q?dQ=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 17ac955e-5909-4fa4-a1e0-08db0baeb54e
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 21:35:20.0070
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: qdiXCEjMtiEQyiCbksIb3rTtaYJGS3V1nvLbz3w23ekamg97/0GE3usubV2KdBgUTkke+761DrK/EqDfjHPCkORUVGuoKxCHrzSTGQCCzCg=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA0PR11MB4688
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan Cameron wrote:
> On Fri, 10 Feb 2023 01:06:39 -0800
> Dan Williams <dan.j.williams@intel.com> wrote:
> 
> > Region autodiscovery is an asynchronous state machine advanced by
> > cxl_port_probe(). After the decoders on an endpoint port are enumerated
> > they are scanned for actively enabled instances. Each active decoder is
> > flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> > If a region does not already exist for the address range setting of the
> > decoder one is created. That creation process may race with other
> > decoders of the same region being discovered since cxl_port_probe() is
> > asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> > introduced to mitigate that race.
> > 
> > Once all decoders have arrived, "p->nr_targets == p->interleave_ways",
> > they are sorted by their relative decode position. The sort algorithm
> > involves finding the point in the cxl_port topology where one leg of the
> > decode leads to deviceA and the other deviceB. At that point in the
> > topology the target order in the 'struct cxl_switch_decoder' indicates
> > the relative position of those endpoint decoders in the region.
> > 
> > >From that point the region goes through the same setup and validation 
> Why the >? 

I believe this is auto-added by git send-email or public-inbox to make
sure that a sentence that begins with "From" is not misinterpreted as a
"From:" header. You can see this throughout the kernel commit history.
In this case I pulled the patches back down from lore before editing
them to collect review tags.

> > steps as user-created regions, but instead of programming the decoders
> > it validates that driver would have written the same values to the
> > decoders as were already present.
> > 
> > Tested-by: Fan Ni <fan.ni@samsung.com>
> > Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.stgit@dwillia2-xfh.jf.intel.com
> > Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> 
> A few trivial things inline and this being complex code I'm not
> as confident about it as the rest of the series but with that in mind
> and the fact I didn't find anything that looked broken...
> 
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> 
> ...
> 
> 
> 
> > +
> > +static int cxl_region_sort_targets(struct cxl_region *cxlr)
> > +{
> > +	struct cxl_region_params *p = &cxlr->params;
> > +	int i, rc = 0;
> > +
> > +	sort(p->targets, p->nr_targets, sizeof(p->targets[0]), cmp_decode_pos,
> > +	     NULL);
> > +
> > +	for (i = 0; i < p->nr_targets; i++) {
> > +		struct cxl_endpoint_decoder *cxled = p->targets[i];
> > +
> > +		if (cxled->pos < 0)
> > +			rc = -ENXIO;
> 
> If it makes sense to carry on after pos < 0 I'd like to see a comment here
> on why.  If not, nicer to have a separate dev_dbg() for failed case nad
> direct return here.

Ok, I'll add:

/*
 * Record that sorting failed, but still continue to restore cxled->pos
 * with its ->targets[] position so that follow-on code paths can reliably
 * do p->targets[cxled->pos] to self-reference their entry.
 */

> 
> > +		cxled->pos = i;
> > +	}
> > +
> > +	dev_dbg(&cxlr->dev, "region sort %s\n", rc ? "failed" : "successful");
> > +	return rc;
> > +}
> > +
> 
> > +
> > +int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
> > +{
> > +	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
> > +	struct range *hpa = &cxled->cxld.hpa_range;
> > +	struct cxl_decoder *cxld = &cxled->cxld;
> > +	struct cxl_root_decoder *cxlrd;
> > +	struct cxl_region_params *p;
> > +	struct cxl_region *cxlr;
> > +	bool attach = false;
> > +	struct device *dev;
> > +	int rc;
> > +
> > +	dev = device_find_child(&root->dev, &cxld->hpa_range,
> > +				match_decoder_by_range);
> > +	if (!dev) {
> > +		dev_err(cxlmd->dev.parent,
> > +			"%s:%s no CXL window for range %#llx:%#llx\n",
> > +			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
> > +			cxld->hpa_range.start, cxld->hpa_range.end);
> > +		return -ENXIO;
> > +	}
> > +
> > +	cxlrd = to_cxl_root_decoder(dev);
> > +
> > +	/*
> > +	 * Ensure that if multiple threads race to construct_region() for @hpa
> > +	 * one does the construction and the others add to that.
> > +	 */
> > +	mutex_lock(&cxlrd->range_lock);
> > +	dev = device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
> > +				match_region_by_range);
> > +	if (!dev)
> > +		cxlr = construct_region(cxlrd, cxled);
> > +	else
> > +		cxlr = to_cxl_region(dev);
> > +	mutex_unlock(&cxlrd->range_lock);
> > +
> > +	if (IS_ERR(cxlr)) {
> > +		rc = PTR_ERR(cxlr);
> > +		goto out;
> > +	}
> > +
> > +	attach_target(cxlr, cxled, -1, TASK_UNINTERRUPTIBLE);
> > +
> > +	down_read(&cxl_region_rwsem);
> > +	p = &cxlr->params;
> > +	attach = p->state == CXL_CONFIG_COMMIT;
> > +	up_read(&cxl_region_rwsem);
> > +
> > +	if (attach) {
> > +		int rc = device_attach(&cxlr->dev);
> 
> Shadowing int rc isn't great for readability. Just call it rc2 or something :)
> Or given you don't make use of the value...

0day did not like this either...

> 
> 		/*
> 		 * If device_attach() fails the range may still be active via
> 		 * the platform-firmware memory map, otherwise the driver for
> 		 * regions is local to this file, so driver matching can't fail
> +                * and hence device_attach() cannot return 1.
> 
> //very much not obvious otherwise to anyone who isn't far too familiar with device_attach()

Hence the comment? Not sure what else can be said here about why
device_attach() < 0 is a sufficient check.

> 
> 		 */
> 		if (device_attach(&cxlr->dev) < 0)
> 			dev_err()
> > +
> > +		/*
> > +		 * If device_attach() fails the range may still be active via
> > +		 * the platform-firmware memory map, otherwise the driver for
> > +		 * regions is local to this file, so driver matching can't fail.
> > +		 */
> > +		if (rc < 0)
> > +			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
> > +				p->res);
> > +	}
> > +
> > +	put_device(&cxlr->dev);
> > +out:
> > +	put_device(&cxlrd->cxlsd.cxld.dev);
> 
> Moderately horrible.  Maybe just keep an extra local variable around for the first
> use of struct device *dev?  or maybe add a put_cxl_root_decoder() helper?
> 
> There are lots of other deep structure access like this I guess, so I don't mind
> if you just leave this as yet another one.

Yeah, it's difficult to have symmetry here, but I think I'll switch to
using an @cxlrd_dev variable so better match the get with the put.

> 
> 
> > +	return rc;
> > +}
> > +EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);
> 
> ...
> 
> > diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
> > index a8d46a67b45e..d88518836c2d 100644
> > --- a/drivers/cxl/port.c
> > +++ b/drivers/cxl/port.c
> > @@ -30,6 +30,34 @@ static void schedule_detach(void *cxlmd)
> >  	schedule_cxl_memdev_detach(cxlmd);
> >  }
> >  
> > +static int discover_region(struct device *dev, void *root)
> > +{
> > +	struct cxl_endpoint_decoder *cxled;
> > +	int rc;
> > +
> > +	if (!is_endpoint_decoder(dev))
> > +		return 0;
> > +
> > +	cxled = to_cxl_endpoint_decoder(dev);
> > +	if ((cxled->cxld.flags & CXL_DECODER_F_ENABLE) == 0)
> > +		return 0;
> > +
> > +	if (cxled->state != CXL_DECODER_STATE_AUTO)
> > +		return 0;
> > +
> > +	/*
> > +	 * Region enumeration is opportunistic, if this add-event fails,
> > +	 * continue to the next endpoint decoder.
> > +	 */
> > +	rc = cxl_add_to_region(root, cxled);
> > +	if (rc)
> > +		dev_dbg(dev, "failed to add to region: %#llx-%#llx\n",
> > +			cxled->cxld.hpa_range.start, cxled->cxld.hpa_range.end);
> > +
> > +	return 0;
> > +}
> > +
> > +
> 
> Two blank lines?

Just stashing this here so I can introduce a spurious whitespace removal
in the next patch. Will clean up.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E0807C636D4
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:49:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233889AbjBJVtR (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:49:17 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33230 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233764AbjBJVtQ (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:49:16 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E702E3D09C;
        Fri, 10 Feb 2023 13:49:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676065754; x=1707601754;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=dyn5hnxL/2Df8dOOBwX/hrPjoK9QSALxCR0HdlRDAKI=;
  b=R7Qus9h+CkzC3CD5bX/tdCSi/6NV36Hk/8YdPdfbtyV2EC1GViLyu6H+
   ZQWA1gytdJJJ3mZrgS41JHEiOPw/10A1XtIOC6Dml/D/iyzFKJl0Iaw6A
   deSTdsyz9uFxKydAUyTiq+CICmaySRKZyK1VL0IrMS7BOTZi6eqOY4wdH
   WmspUn6MHKUp7KhHl039XQIjG9Bw2uKdYfS/KYJwLCk7LujZ3g1BWbjfj
   U/tEGUqyXoofYHIv5HvkimF11jM2wo5DbG6HLRu/VvdMdiBsWOh5Xabwr
   sBOnCl2TTpfEZsAOdy9SV4MrcIJws6dRftGQJB1TBOPCxCCyXFzVwVSch
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="329165403"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="329165403"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:49:14 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="792112868"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="792112868"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orsmga004.jf.intel.com with ESMTP; 10 Feb 2023 13:49:13 -0800
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 13:49:13 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 13:49:13 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.169)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 13:49:13 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=mKe7DzKngUr7aGmpo8/sS4SqEo3w+hPZ51WAwlhPSGTzRLVhki6l/PHJI4f09AhmscTqz720SZBVMTt7nPoVKahP2F0msGZMRVgdYkE3nkE7skriUosETLYZ+/gKpEwMfOfaLjygsBTADCQoXGZWAUu0tCQ86IrDKrac/onrgV03IfKhyNJiuCMRiVFwj6XVP10WxpYde+ZOe433tlrxsYQ7m8ZAKz2glTd4VoH3eZMFOstRMcIlvIL79kZpOtBEiGzI/K3hUzgLUhNnWvyDOz9eHNZ1MkIgMsQjV4jzuNpwg8JRwlW3sr0c5b3fXNhmo1bnIxR08eXsq9z3o4xbLA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=8Esn9TcCGy3H/sMKfKPwQNp66GJrsPK+pyctETfAdeE=;
 b=RhK7iho/oUwZUVwuTMSAL2s6QKMchwlJwpRA5qQb46Zv6B5u+asok7jWMW81oyBCOzeelOAbOhXlpkTdMwNUu8r/1Y/y7+3RNwk8Y8ctlK3baxOKpGds1tB/J6VtLnrwgDP2tibmfXIkJbG0Ln0YjZkkIo+Teo8MrVJS6WimZs3roOoJafQHe9kwx1gGzF+Kxa9fi0ZE5ats2qNAALw7T7BJjCSKq2Kf/n8DNmd4dfFqnb5FqYN5tuJb/ujenp0RrX/NUaIlH+0Y9KOxOG6EIwoXeYMxKKRUie901Heoeyspv17ZVYzu73HYZ9Av4Imdz86TtYMQBGf1WOMyQg4F+g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by DM4PR11MB5246.namprd11.prod.outlook.com (2603:10b6:5:389::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.17; Fri, 10 Feb
 2023 21:49:11 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.020; Fri, 10 Feb 2023
 21:49:11 +0000
Date: Fri, 10 Feb 2023 13:49:08 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <63e6bbd4b5ec6_1db5d0294b6@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
 <20230210180958.00002e5a@Huawei.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230210180958.00002e5a@Huawei.com>
X-ClientProxiedBy: SJ0PR13CA0078.namprd13.prod.outlook.com
 (2603:10b6:a03:2c4::23) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|DM4PR11MB5246:EE_
X-MS-Office365-Filtering-Correlation-Id: 9e9b6502-d80e-42bf-253d-08db0bb0a4a8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: Ycm4vmUFREyN3+kU4yXLgtUJUoPqE2ij4HiQF0FH5j3NLtFOZRVp2suzcstOU6f11RwEHYiA7IT72pvo1DqBZDQ/695DkkicT8vofFwbrQQyrVBs53f4gF/OqNqhbOcRIZvY3nZ4qjrS6QLnYm+JAp5kxVvWIpzvoludLJqM4zDpWLirXlztInpJVG6hcVjmVx96wZlcDzq+cTvm+cwsErjFCKuTWGJHJW/gXytcekhYTv/mQYAThdM44qyHHI2UPqYa4HqlJzIXcvS75LPbF1NbGRgH3PFvLT2erk7RSYglTGyueEkdRWAhkT6mB/HxEOa1ne0jI3h3L3zp3bAiVoppSV0wqBQzGrYq9kdbYKRxj53AAIaLKM5XJPGr5AcJuMTdBeq+OYhQQy4DuStorRvATdNI2Dzfhkv46Gkp/MHL8L1NJ+u2DZCcKp9bDFBz8f0GHsBGD/aDAQTA7otfNgLuTVEiwInB03Q3QcMHBQwFjks0RBBmk6tEfBUB8KZxM9/7AsZ00wYO8XjNDXiuVTFIDp1M4ze17w2S/LspcwJ0WPm9TvxpmjM7WQBlDudxQJNcn6Nepf20ME8cw7pTmfXmUNLNYRlU6xRsGdu5O/+OEI0JBnAW3tnqXDM7em+IrEMw13LJjsgT4km+ZBcnlp+HEWp5YIKyII5mEhm9VEI=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(396003)(39860400002)(366004)(136003)(346002)(376002)(451199018)(5660300002)(2906002)(83380400001)(66476007)(6512007)(82960400001)(110136005)(4326008)(8676002)(38100700002)(66946007)(8936002)(6666004)(66556008)(186003)(9686003)(6506007)(41300700001)(6486002)(478600001)(966005)(86362001)(26005)(316002);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?qeM1VfVv3MKMHZbj/k2M7rPSh9rochlDZIY188YDfv8kjyseLRbHf869eX5B?=
 =?us-ascii?Q?7DhRO9NHCgn1BGbh2j2/Zg0wMMr9PP6L1WrjLqDfM1EBMSn4QNqVuQaE+VWe?=
 =?us-ascii?Q?ANFedpV4QFOLnJ9WwlyrA2EHFJNrkF4CgjZC2WoX0hIlTquINgE9qjlNyqTk?=
 =?us-ascii?Q?KrNQAowmZ18HaFot1LHwFl/W9gDf0Wy+5NR5qThm7/9SrSTyla3JxEFG2NUJ?=
 =?us-ascii?Q?MTw1F7U+4aN8kDi/KDin0SLaufhozn/1VC6z0AXGywxIBCKNRd4J0+uGKIIE?=
 =?us-ascii?Q?RBUmsZFa5afPWc1IFM48YoAOLNme+uGiuJdR89jUPRhPZS6cQDriLRJFM8mG?=
 =?us-ascii?Q?8xbr95dv/M19Z5B/PIhjSflAVeGnG8C07C5eWFykwa9eSOxxiyRqTu7UTm33?=
 =?us-ascii?Q?9A0E7MT7e3T9Yqig2waGxUgqEaIWcjnp12s3uTy9xZS40XLtmjDm/Grlwnw1?=
 =?us-ascii?Q?BABskFVeBLpp2FtCij+CFkZ7yoYEpSFztxbqQyOIOdDmFKhGtIf58vwL7zOi?=
 =?us-ascii?Q?v5HGsYiaCMlYLEJJpPSYBqNPRW2mgY4xHsb8rGF5k6IXGZMQSzEzsGCBd6GB?=
 =?us-ascii?Q?jFE4OTSt6CQz642gA6Dm9cD+aMxp/fKwk3aNe/H2Fj3Rdt9hZQjhS3+YbCVb?=
 =?us-ascii?Q?d197soHmo2AgVSLvD0+OujnVJiVMNN5nfyy/JxO8s7+hKIjEwtIZw0sp2RLw?=
 =?us-ascii?Q?Wl5AJVOJzzqBMeCx1S1I35qfECLuPfff3sDavGtHULrh9+rkOeuGqwqSOmkZ?=
 =?us-ascii?Q?LXRXuvr1W+2U6j7gnCi4cqW2lxn493G0BkcdvkJfj54Ihl/hLirxPaO0cAcl?=
 =?us-ascii?Q?kD7wSWYHjucSXhaszA/UdmPK/yXi+21Cue7QrkQ/3s+XIM9zMHURSWy17Uao?=
 =?us-ascii?Q?cUOLlee86nnEBfRy+6sSMSuGPGPWG2G1OAO1jEqg1Iue+tEf2zPZ059rsbya?=
 =?us-ascii?Q?JZ+tnPZtwvNG9/AgO+1xsyvP0KdF04AJcCGd7wPArW92px72ab808rJdJ0xi?=
 =?us-ascii?Q?upIP5EnwUX0+WahK1mpWREayDoyPYvoKNOzsNzkWjwdx3czCuKMv1KW7UNFA?=
 =?us-ascii?Q?kvVjeOHdV7F2moNMt5UmZS/SpA4q6M4/rwaybNOJWUdbzHhK4D3pKmbN/6+6?=
 =?us-ascii?Q?qomaJw10T65zxh+EflaCvQki41+QLSqW5UL3y8twQISJ/y3/csylDr/+htnJ?=
 =?us-ascii?Q?e7WHo/KlXrIkKkBJK6pIfjlMhdOwMzcciFtqUzWwgmX8kMmHdNF+MqU/Jyg/?=
 =?us-ascii?Q?Ixp1KXtAa79usCxwKW1e7PexuyMAUd0z5tMVH7UD4pOs1Di182xb+jFPlQ2s?=
 =?us-ascii?Q?co7cZO1vf8iDtx4/u2QfVwfHjIx09MFJfUrsw4ohXN+Tvx7IQg7QLnxN7Mex?=
 =?us-ascii?Q?hHQrm9fsci3YmNLMwr5I/nM7M1Uw/W0aaJAlQgI1/0C0lVuG7hfdb7UTjBjV?=
 =?us-ascii?Q?Sg54puSslCedreOKC6VM/XRhn5BLqVz33Ya8/cEtvm+GIq8mNCmO8+NskxHT?=
 =?us-ascii?Q?pyKQYG8h5LK5hzvHeYz5l5lhzO81qQW6/BCiGt61VB2feAZz138wS1PJiFWu?=
 =?us-ascii?Q?KIA5/H7kg5VaYfkzKXPtzoESNXEYx7YTMWXW72z6tlJtSciQ+eVhqt9sWnjD?=
 =?us-ascii?Q?Uw=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 9e9b6502-d80e-42bf-253d-08db0bb0a4a8
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 21:49:10.9408
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: mIgmLqnNB3+g07IQI+m5nNF9gdB+GsSD/ahai+x1x/FMsN3lm9Rsi4nDhzRupsSdLIEi3Qb44UjI7lKZb8OEVaFDzvJlWno49Ge9EtM5IBA=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR11MB5246
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan Cameron wrote:
> On Fri, 10 Feb 2023 01:06:39 -0800
> Dan Williams <dan.j.williams@intel.com> wrote:
> 
> > Region autodiscovery is an asynchronous state machine advanced by
> > cxl_port_probe(). After the decoders on an endpoint port are enumerated
> > they are scanned for actively enabled instances. Each active decoder is
> > flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> > If a region does not already exist for the address range setting of the
> > decoder one is created. That creation process may race with other
> > decoders of the same region being discovered since cxl_port_probe() is
> > asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> > introduced to mitigate that race.
> > 
> > Once all decoders have arrived, "p->nr_targets == p->interleave_ways",
> > they are sorted by their relative decode position. The sort algorithm
> > involves finding the point in the cxl_port topology where one leg of the
> > decode leads to deviceA and the other deviceB. At that point in the
> > topology the target order in the 'struct cxl_switch_decoder' indicates
> > the relative position of those endpoint decoders in the region.
> > 
> > >From that point the region goes through the same setup and validation 
> Why the >? 
> > steps as user-created regions, but instead of programming the decoders
> > it validates that driver would have written the same values to the
> > decoders as were already present.
> > 
> > Tested-by: Fan Ni <fan.ni@samsung.com>
> > Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.stgit@dwillia2-xfh.jf.intel.com
> > Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> 
> A few trivial things inline and this being complex code I'm not
> as confident about it as the rest of the series but with that in mind
> and the fact I didn't find anything that looked broken...
> 
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

Folded the following:

diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 3f6453da2c51..1580170d5bdb 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -2479,16 +2479,16 @@ int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
 	struct cxl_memdev *cxlmd = cxled_to_memdev(cxled);
 	struct range *hpa = &cxled->cxld.hpa_range;
 	struct cxl_decoder *cxld = &cxled->cxld;
+	struct device *cxlrd_dev, *region_dev;
 	struct cxl_root_decoder *cxlrd;
 	struct cxl_region_params *p;
 	struct cxl_region *cxlr;
 	bool attach = false;
-	struct device *dev;
 	int rc;
 
-	dev = device_find_child(&root->dev, &cxld->hpa_range,
-				match_decoder_by_range);
-	if (!dev) {
+	cxlrd_dev = device_find_child(&root->dev, &cxld->hpa_range,
+				      match_decoder_by_range);
+	if (!cxlrd_dev) {
 		dev_err(cxlmd->dev.parent,
 			"%s:%s no CXL window for range %#llx:%#llx\n",
 			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
@@ -2496,19 +2496,20 @@ int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
 		return -ENXIO;
 	}
 
-	cxlrd = to_cxl_root_decoder(dev);
+	cxlrd = to_cxl_root_decoder(cxlrd_dev);
 
 	/*
 	 * Ensure that if multiple threads race to construct_region() for @hpa
 	 * one does the construction and the others add to that.
 	 */
 	mutex_lock(&cxlrd->range_lock);
-	dev = device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
-				match_region_by_range);
-	if (!dev)
+	region_dev = device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
+				       match_region_by_range);
+	if (!region_dev) {
 		cxlr = construct_region(cxlrd, cxled);
-	else
-		cxlr = to_cxl_region(dev);
+		region_dev = &cxlr->dev;
+	} else
+		cxlr = to_cxl_region(region_dev);
 	mutex_unlock(&cxlrd->range_lock);
 
 	if (IS_ERR(cxlr)) {
@@ -2524,21 +2525,19 @@ int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder *cxled)
 	up_read(&cxl_region_rwsem);
 
 	if (attach) {
-		int rc = device_attach(&cxlr->dev);
-
 		/*
 		 * If device_attach() fails the range may still be active via
 		 * the platform-firmware memory map, otherwise the driver for
 		 * regions is local to this file, so driver matching can't fail.
 		 */
-		if (rc < 0)
+		if (device_attach(&cxlr->dev) < 0)
 			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
 				p->res);
 	}
 
-	put_device(&cxlr->dev);
+	put_device(region_dev);
 out:
-	put_device(&cxlrd->cxlsd.cxld.dev);
+	put_device(cxlrd_dev);
 	return rc;
 }
 EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);
diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
index d88518836c2d..d6c151dabaa7 100644
--- a/drivers/cxl/port.c
+++ b/drivers/cxl/port.c
@@ -57,7 +57,6 @@ static int discover_region(struct device *dev, void *root)
 	return 0;
 }
 
-
 static int cxl_switch_port_probe(struct cxl_port *port)
 {
 	struct cxl_hdm *cxlhdm;

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 46567C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:53:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232915AbjBJVxp (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:53:45 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38656 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232860AbjBJVxo (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:53:44 -0500
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DB4AA36699;
        Fri, 10 Feb 2023 13:53:43 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676066023; x=1707602023;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=vx5sAtd67oqSJ5HQNum0Qt2Ezi+uWPrpz/heDpnKEx0=;
  b=IGEZgCg1sV4E095GngvLPmkkfe6e78ZNdMMHsbTe8RQICzgbAqpSUPIC
   tr3mO2RskAhDXSXRieKnBtjWdCuoMMVH2K/IOlMFoy3z8QzL3YMnc/1im
   ZUsQjAp1vzsz6mfmyhG3LdJwI5SonvX0tQct+sLHZLTfVwqlabM461ktn
   JlaKp1FhxxQjvJYE5fjKPN8xwaPYIz6kOUA3PrJyA7wZmy8wWMYVKPSsy
   Pm1e+hy5ue2ityLkUWTJ7P1UbvRl9GOFS46YLQspiwv06p/9DFJ1aOKuo
   3Pia9ZPmwqDoJ6ZDGEsG7r2qLWVyLEIVFK4ATE+66UNFXU/Whq5Hpa95k
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="357937356"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="357937356"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
  by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:53:43 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="645765617"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="645765617"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga006-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:53:42 -0800
Message-ID: <448c17f6-cdfa-9422-c35e-cf95e1b99604@intel.com>
Date: Fri, 10 Feb 2023 14:53:42 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 15/20] dax/hmem: Move HMAT and Soft reservation probe
 initcall level
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:06 AM, Dan Williams wrote:
> In preparation for moving more filtering of "hmem" ranges into the
> dax_hmem.ko module, update the initcall levels. HMAT range registration
> moves to subsys_initcall() to be done before Soft Reservation probing,
> and Soft Reservation probing is moved to device_initcall() to be done
> before dax_hmem.ko initialization if it is built-in.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564542109.847146.10113972881782419363.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   drivers/acpi/numa/hmat.c  |    2 +-
>   drivers/dax/hmem/Makefile |    3 ++-
>   drivers/dax/hmem/device.c |    2 +-
>   3 files changed, 4 insertions(+), 3 deletions(-)
> 
> diff --git a/drivers/acpi/numa/hmat.c b/drivers/acpi/numa/hmat.c
> index 605a0c7053be..ff24282301ab 100644
> --- a/drivers/acpi/numa/hmat.c
> +++ b/drivers/acpi/numa/hmat.c
> @@ -869,4 +869,4 @@ static __init int hmat_init(void)
>   	acpi_put_table(tbl);
>   	return 0;
>   }
> -device_initcall(hmat_init);
> +subsys_initcall(hmat_init);
> diff --git a/drivers/dax/hmem/Makefile b/drivers/dax/hmem/Makefile
> index 57377b4c3d47..d4c4cd6bccd7 100644
> --- a/drivers/dax/hmem/Makefile
> +++ b/drivers/dax/hmem/Makefile
> @@ -1,6 +1,7 @@
>   # SPDX-License-Identifier: GPL-2.0
> -obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
> +# device_hmem.o deliberately precedes dax_hmem.o for initcall ordering
>   obj-$(CONFIG_DEV_DAX_HMEM_DEVICES) += device_hmem.o
> +obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
>   
>   device_hmem-y := device.o
>   dax_hmem-y := hmem.o
> diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
> index 903325aac991..20749c7fab81 100644
> --- a/drivers/dax/hmem/device.c
> +++ b/drivers/dax/hmem/device.c
> @@ -104,4 +104,4 @@ static __init int hmem_init(void)
>    * As this is a fallback for address ranges unclaimed by the ACPI HMAT
>    * parsing it must be at an initcall level greater than hmat_init().
>    */
> -late_initcall(hmem_init);
> +device_initcall(hmem_init);
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 25783C64ED6
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:57:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233600AbjBJV5z (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:57:55 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41994 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233625AbjBJV5x (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:57:53 -0500
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 83EA67DD22;
        Fri, 10 Feb 2023 13:57:51 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676066271; x=1707602271;
  h=message-id:date:mime-version:subject:from:to:cc:
   references:in-reply-to:content-transfer-encoding;
  bh=vPxF1JseRSs4g26NzPX6yAqIVHYMWM5zfMZbpc6cPmA=;
  b=ffdXpIX5PeC7qhusKogCYaQ1tyEcCXMSGoFzAUOW2LE/Gv2LBQAzygge
   R4ksVGTkZ3k9DC9Qb2elnBQyJMMAZfyD0UZNkCb0PV6DFriDZlKpHOqCQ
   TgZjYh9J9BIwUTTccvsNIJrndt63PWrK0AA7FVKrhctvz+UV/o6QiYUR4
   2vv8XUMYuZqlhwIV21O3MAn1eipX+pX5N20EKMfEf/fYvfCg2dJbeQo3C
   PW7Zj8UVdzP/6fVfGu2diRTHXVADo0Lt2IyDepKATqB1rsWLA5/uvxzqt
   obuKgNAfZeOVcswO9MKDxa7bSXE9ehdgXfNCDTbgm6yykJqV9I2SRROSE
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="330544827"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="330544827"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga103.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:57:43 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="700616193"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="700616193"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:57:42 -0800
Message-ID: <368f047a-b722-504f-41de-41b3f10cdeb8@intel.com>
Date: Fri, 10 Feb 2023 14:57:42 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 15/20] dax/hmem: Move HMAT and Soft reservation probe
 initcall level
Content-Language: en-US
From: Dave Jiang <dave.jiang@intel.com>
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
 <448c17f6-cdfa-9422-c35e-cf95e1b99604@intel.com>
In-Reply-To: <448c17f6-cdfa-9422-c35e-cf95e1b99604@intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:53 PM, Dave Jiang wrote:
> 
> 
> On 2/10/23 2:06 AM, Dan Williams wrote:
>> In preparation for moving more filtering of "hmem" ranges into the
>> dax_hmem.ko module, update the initcall levels. HMAT range registration
>> moves to subsys_initcall() to be done before Soft Reservation probing,
>> and Soft Reservation probing is moved to device_initcall() to be done
>> before dax_hmem.ko initialization if it is built-in.
>>
>> Tested-by: Fan Ni <fan.ni@samsung.com>
>> Link: 
>> https://lore.kernel.org/r/167564542109.847146.10113972881782419363.stgit@dwillia2-xfh.jf.intel.com
>> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> 
> Reviewed-by: Dave Jiang <dave.jiang@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> 
>> ---
>>  drivers/acpi/numa/hmat.c | 2 +-
>>  drivers/dax/hmem/Makefile | 3 ++-
>>  drivers/dax/hmem/device.c | 2 +-
>>  3 files changed, 4 insertions(+), 3 deletions(-)
>>
>> diff --git a/drivers/acpi/numa/hmat.c b/drivers/acpi/numa/hmat.c
>> index 605a0c7053be..ff24282301ab 100644
>> --- a/drivers/acpi/numa/hmat.c
>> +++ b/drivers/acpi/numa/hmat.c
>> @@ -869,4 +869,4 @@ static __init int hmat_init(void)
>>  acpi_put_table(tbl);
>>  return 0;
>>  }
>> -device_initcall(hmat_init);
>> +subsys_initcall(hmat_init);
>> diff --git a/drivers/dax/hmem/Makefile b/drivers/dax/hmem/Makefile
>> index 57377b4c3d47..d4c4cd6bccd7 100644
>> --- a/drivers/dax/hmem/Makefile
>> +++ b/drivers/dax/hmem/Makefile
>> @@ -1,6 +1,7 @@
>>  # SPDX-License-Identifier: GPL-2.0
>> -obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
>> +# device_hmem.o deliberately precedes dax_hmem.o for initcall ordering
>>  obj-$(CONFIG_DEV_DAX_HMEM_DEVICES) += device_hmem.o
>> +obj-$(CONFIG_DEV_DAX_HMEM) += dax_hmem.o
>>  device_hmem-y := device.o
>>  dax_hmem-y := hmem.o
>> diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
>> index 903325aac991..20749c7fab81 100644
>> --- a/drivers/dax/hmem/device.c
>> +++ b/drivers/dax/hmem/device.c
>> @@ -104,4 +104,4 @@ static __init int hmem_init(void)
>>  * As this is a fallback for address ranges unclaimed by the ACPI HMAT
>>  * parsing it must be at an initcall level greater than hmat_init().
>>  */
>> -late_initcall(hmem_init);
>> +device_initcall(hmem_init);
>>

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1E50AC636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 21:59:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233550AbjBJV7j (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 16:59:39 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43152 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232505AbjBJV7i (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 16:59:38 -0500
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2EFE97D8B3;
        Fri, 10 Feb 2023 13:59:38 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676066378; x=1707602378;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=IWeWBAcXU8gR83oqaSxz80kzyVRTcSG6AcaGmWbiYD8=;
  b=LUaeco8sb//FAPtCcxzVpDXfNxDbE+PUV+ZsKRXhRRyEp+7SI2qkzfZv
   1s4VvoC6cjNORKpwpwxZE1UbTqgbPI4UYtjb2g9fv94rcw4R8hldwLLJJ
   8EGxP0UGTPXjLrDvKnSrgx5JiNotAMMZs15xlzWr1jUV94AgoMFmY9Fg0
   emLjr97NlW6paJ/nxFI+nHcatP0ca3UQh0GO1XJavxBzJ3UkqPFMMcUg6
   KyZUTOhRAY80glV9lQGD3tSW3aoSEwQbEvlQVv8TJq0d2irotYPa3AbBv
   AuyHLOFxVQ8mMFvY+giBhG4fs8qhzHW5OyEpKvoQJh4c96LDyDrhdYkwA
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="330545038"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="330545038"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga103.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:59:37 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="700616322"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="700616322"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga001-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 13:59:37 -0800
Message-ID: <3bef679e-ddb6-45a1-2152-522fc217efa8@intel.com>
Date: Fri, 10 Feb 2023 14:59:36 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 16/20] dax/hmem: Drop unnecessary dax_hmem_remove()
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602001664.1924368.9102029637928071240.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602001664.1924368.9102029637928071240.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:06 AM, Dan Williams wrote:
> Empty driver remove callbacks can just be elided.
> 
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> Reviewed-by: Gregory Price <gregory.price@memverge.com>
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564542679.847146.17174404738816053065.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   drivers/dax/hmem/hmem.c |    7 -------
>   1 file changed, 7 deletions(-)
> 
> diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
> index 1bf040dbc834..c7351e0dc8ff 100644
> --- a/drivers/dax/hmem/hmem.c
> +++ b/drivers/dax/hmem/hmem.c
> @@ -44,15 +44,8 @@ static int dax_hmem_probe(struct platform_device *pdev)
>   	return 0;
>   }
>   
> -static int dax_hmem_remove(struct platform_device *pdev)
> -{
> -	/* devm handles teardown */
> -	return 0;
> -}
> -
>   static struct platform_driver dax_hmem_driver = {
>   	.probe = dax_hmem_probe,
> -	.remove = dax_hmem_remove,
>   	.driver = {
>   		.name = "hmem",
>   	},
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 27391C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 22:03:27 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233694AbjBJWD0 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 17:03:26 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:45272 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232505AbjBJWDZ (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 17:03:25 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3C0585ACF0;
        Fri, 10 Feb 2023 14:03:24 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676066604; x=1707602604;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=DJ4H1V+6TU5G803CMbKqoAlYJI/kGtz69jyguC5gnOM=;
  b=UMFahUlk5rBPjEU3isY+hb1WCiNot7v6ykx8y+SO0WY6blBY7UYGXAoU
   5JtzDsqokKx4CLfSWmb1H7gGPhkZbcGNc9hbrPYC/7gXo0KCxjf5tEjGN
   Kf5y4fx9AS7srF2JV1ELzAPbEgRavevBWl2S4fGvHxmFSlPofj4nSVLQe
   9yaS5F8h+lAxzOmWlzRS8Z8doPYtnwm9Q9J31RjX8+tTIsI+ZHWQNuhuD
   tpsHKM8+TswKTFyGmyilkXyZfjqzWw1FBePOYiqbEh50ippLD01jx+56K
   x4OJF/6PlFXyWzyG/VBcfndWPCkiTzseSewXCnfkYTgsL64w73QKBx0YY
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="329168193"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="329168193"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:03:23 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="792115392"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="792115392"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga004-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:03:22 -0800
Message-ID: <7f9303ac-1e3c-8b13-4b85-36a49baa37f1@intel.com>
Date: Fri, 10 Feb 2023 15:03:21 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 17/20] dax/hmem: Convey the dax range via
 memregion_info()
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602002217.1924368.7036275892522551624.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602002217.1924368.7036275892522551624.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:07 AM, Dan Williams wrote:
> In preparation for hmem platform devices to be unregistered, stop using
> platform_device_add_resources() to convey the address range. The
> platform_device_add_resources() API causes an existing "Soft Reserved"
> iomem resource to be re-parented under an inserted platform device
> resource. When that platform device is deleted it removes the platform
> device resource and all children.
> 
> Instead, it is sufficient to convey just the address range and let
> request_mem_region() insert resources to indicate the devices active in
> the range. This allows the "Soft Reserved" resource to be re-enumerated
> upon the next probe event.
> 
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564543303.847146.11045895213318648441.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   drivers/dax/hmem/device.c |   37 ++++++++++++++-----------------------
>   drivers/dax/hmem/hmem.c   |   14 +++-----------
>   include/linux/memregion.h |    2 ++
>   3 files changed, 19 insertions(+), 34 deletions(-)
> 
> diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
> index 20749c7fab81..b1b339bccfe5 100644
> --- a/drivers/dax/hmem/device.c
> +++ b/drivers/dax/hmem/device.c
> @@ -15,15 +15,8 @@ static struct resource hmem_active = {
>   	.flags = IORESOURCE_MEM,
>   };
>   
> -void hmem_register_device(int target_nid, struct resource *r)
> +void hmem_register_device(int target_nid, struct resource *res)
>   {
> -	/* define a clean / non-busy resource for the platform device */
> -	struct resource res = {
> -		.start = r->start,
> -		.end = r->end,
> -		.flags = IORESOURCE_MEM,
> -		.desc = IORES_DESC_SOFT_RESERVED,
> -	};
>   	struct platform_device *pdev;
>   	struct memregion_info info;
>   	int rc, id;
> @@ -31,55 +24,53 @@ void hmem_register_device(int target_nid, struct resource *r)
>   	if (nohmem)
>   		return;
>   
> -	rc = region_intersects(res.start, resource_size(&res), IORESOURCE_MEM,
> -			IORES_DESC_SOFT_RESERVED);
> +	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
> +			       IORES_DESC_SOFT_RESERVED);
>   	if (rc != REGION_INTERSECTS)
>   		return;
>   
>   	id = memregion_alloc(GFP_KERNEL);
>   	if (id < 0) {
> -		pr_err("memregion allocation failure for %pr\n", &res);
> +		pr_err("memregion allocation failure for %pr\n", res);
>   		return;
>   	}
>   
>   	pdev = platform_device_alloc("hmem", id);
>   	if (!pdev) {
> -		pr_err("hmem device allocation failure for %pr\n", &res);
> +		pr_err("hmem device allocation failure for %pr\n", res);
>   		goto out_pdev;
>   	}
>   
> -	if (!__request_region(&hmem_active, res.start, resource_size(&res),
> +	if (!__request_region(&hmem_active, res->start, resource_size(res),
>   			      dev_name(&pdev->dev), 0)) {
> -		dev_dbg(&pdev->dev, "hmem range %pr already active\n", &res);
> +		dev_dbg(&pdev->dev, "hmem range %pr already active\n", res);
>   		goto out_active;
>   	}
>   
>   	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
>   	info = (struct memregion_info) {
>   		.target_node = target_nid,
> +		.range = {
> +			.start = res->start,
> +			.end = res->end,
> +		},
>   	};
>   	rc = platform_device_add_data(pdev, &info, sizeof(info));
>   	if (rc < 0) {
> -		pr_err("hmem memregion_info allocation failure for %pr\n", &res);
> -		goto out_resource;
> -	}
> -
> -	rc = platform_device_add_resources(pdev, &res, 1);
> -	if (rc < 0) {
> -		pr_err("hmem resource allocation failure for %pr\n", &res);
> +		pr_err("hmem memregion_info allocation failure for %pr\n", res);
>   		goto out_resource;
>   	}
>   
>   	rc = platform_device_add(pdev);
>   	if (rc < 0) {
> -		dev_err(&pdev->dev, "device add failed for %pr\n", &res);
> +		dev_err(&pdev->dev, "device add failed for %pr\n", res);
>   		goto out_resource;
>   	}
>   
>   	return;
>   
>   out_resource:
> -	__release_region(&hmem_active, res.start, resource_size(&res));
> +	__release_region(&hmem_active, res->start, resource_size(res));
>   out_active:
>   	platform_device_put(pdev);
>   out_pdev:
> diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
> index c7351e0dc8ff..5025a8c9850b 100644
> --- a/drivers/dax/hmem/hmem.c
> +++ b/drivers/dax/hmem/hmem.c
> @@ -15,25 +15,17 @@ static int dax_hmem_probe(struct platform_device *pdev)
>   	struct memregion_info *mri;
>   	struct dev_dax_data data;
>   	struct dev_dax *dev_dax;
> -	struct resource *res;
> -	struct range range;
> -
> -	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
> -	if (!res)
> -		return -ENOMEM;
>   
>   	mri = dev->platform_data;
> -	range.start = res->start;
> -	range.end = res->end;
> -	dax_region = alloc_dax_region(dev, pdev->id, &range, mri->target_node,
> -			PMD_SIZE, 0);
> +	dax_region = alloc_dax_region(dev, pdev->id, &mri->range,
> +				      mri->target_node, PMD_SIZE, 0);
>   	if (!dax_region)
>   		return -ENOMEM;
>   
>   	data = (struct dev_dax_data) {
>   		.dax_region = dax_region,
>   		.id = -1,
> -		.size = region_idle ? 0 : resource_size(res),
> +		.size = region_idle ? 0 : range_len(&mri->range),
>   	};
>   	dev_dax = devm_create_dev_dax(&data);
>   	if (IS_ERR(dev_dax))
> diff --git a/include/linux/memregion.h b/include/linux/memregion.h
> index bf83363807ac..c01321467789 100644
> --- a/include/linux/memregion.h
> +++ b/include/linux/memregion.h
> @@ -3,10 +3,12 @@
>   #define _MEMREGION_H_
>   #include <linux/types.h>
>   #include <linux/errno.h>
> +#include <linux/range.h>
>   #include <linux/bug.h>
>   
>   struct memregion_info {
>   	int target_node;
> +	struct range range;
>   };
>   
>   #ifdef CONFIG_MEMREGION
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 67257C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 22:09:09 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233727AbjBJWJI (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 17:09:08 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:46824 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233799AbjBJWJG (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 17:09:06 -0500
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 06AA57E8FC;
        Fri, 10 Feb 2023 14:09:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676066942; x=1707602942;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=sY8OLIIt7+LZVX9JONJjX/aUMbbtvwjmsYGVh+lvMyE=;
  b=X899ru8JBM8nObkgLJzyirddpltaj05mQ1q15GLYRacOtV5iBfo7hjSt
   cfkprwMwtbsZZONlZFE9Ci0RBGmcMmMzNjKE6Z8PWxkkITfAZBEY3lpGu
   PT7josWx23wx0lgIpPL4aTLaVlBt/lv7w76M8D0ypwGr2+FpXlJ0k5VG6
   kzlid+TD7pyeOhz/XyEw91wld2LYWMa+8H+nJd9mZ8Sm24u8m6QjldAW9
   alwO6N0NokRrg7LtGqGmXnQoDiDXEodvW6fgXaqQL17O2cX9ndmVtwB4s
   4U/yAWfNekyXc3Ik+S6YN14bu3korfLyT0lRsyOswsGsDfTabHosESTO3
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="330547668"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="330547668"
Received: from orsmga005.jf.intel.com ([10.7.209.41])
  by fmsmga103.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:09:02 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="842156715"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="842156715"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:09:01 -0800
Message-ID: <87d18c67-1b6a-6331-fb17-152ce9b7bd88@intel.com>
Date: Fri, 10 Feb 2023 15:09:01 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 18/20] dax/hmem: Move hmem device registration to
 dax_hmem.ko
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:07 AM, Dan Williams wrote:
> In preparation for the CXL region driver to take over the responsibility
> of registering device-dax instances for CXL regions, move the
> registration of "hmem" devices to dax_hmem.ko.
> 
> Previously the builtin component of this enabling
> (drivers/dax/hmem/device.o) would register platform devices for each
> address range and trigger the dax_hmem.ko module to load and attach
> device-dax instances to those devices. Now, the ranges are collected
> from the HMAT and EFI memory map walking, but the device creation is
> deferred. A new "hmem_platform" device is created which triggers
> dax_hmem.ko to load and register the platform devices.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564543923.847146.9030380223622044744.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>
> ---
>   drivers/acpi/numa/hmat.c  |    2 -
>   drivers/dax/Kconfig       |    2 -
>   drivers/dax/hmem/device.c |   91 +++++++++++++++++++--------------------
>   drivers/dax/hmem/hmem.c   |  105 +++++++++++++++++++++++++++++++++++++++++++++
>   include/linux/dax.h       |    7 ++-
>   5 files changed, 155 insertions(+), 52 deletions(-)
> 
> diff --git a/drivers/acpi/numa/hmat.c b/drivers/acpi/numa/hmat.c
> index ff24282301ab..bba268ecd802 100644
> --- a/drivers/acpi/numa/hmat.c
> +++ b/drivers/acpi/numa/hmat.c
> @@ -718,7 +718,7 @@ static void hmat_register_target_devices(struct memory_target *target)
>   	for (res = target->memregions.child; res; res = res->sibling) {
>   		int target_nid = pxm_to_node(target->memory_pxm);
>   
> -		hmem_register_device(target_nid, res);
> +		hmem_register_resource(target_nid, res);
>   	}
>   }
>   
> diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
> index 5fdf269a822e..d13c889c2a64 100644
> --- a/drivers/dax/Kconfig
> +++ b/drivers/dax/Kconfig
> @@ -46,7 +46,7 @@ config DEV_DAX_HMEM
>   	  Say M if unsure.
>   
>   config DEV_DAX_HMEM_DEVICES
> -	depends on DEV_DAX_HMEM && DAX=y
> +	depends on DEV_DAX_HMEM && DAX
>   	def_bool y
>   
>   config DEV_DAX_KMEM
> diff --git a/drivers/dax/hmem/device.c b/drivers/dax/hmem/device.c
> index b1b339bccfe5..f9e1a76a04a9 100644
> --- a/drivers/dax/hmem/device.c
> +++ b/drivers/dax/hmem/device.c
> @@ -8,6 +8,8 @@
>   static bool nohmem;
>   module_param_named(disable, nohmem, bool, 0444);
>   
> +static bool platform_initialized;
> +static DEFINE_MUTEX(hmem_resource_lock);
>   static struct resource hmem_active = {
>   	.name = "HMEM devices",
>   	.start = 0,
> @@ -15,71 +17,66 @@ static struct resource hmem_active = {
>   	.flags = IORESOURCE_MEM,
>   };
>   
> -void hmem_register_device(int target_nid, struct resource *res)
> +int walk_hmem_resources(struct device *host, walk_hmem_fn fn)
> +{
> +	struct resource *res;
> +	int rc = 0;
> +
> +	mutex_lock(&hmem_resource_lock);
> +	for (res = hmem_active.child; res; res = res->sibling) {
> +		rc = fn(host, (int) res->desc, res);
> +		if (rc)
> +			break;
> +	}
> +	mutex_unlock(&hmem_resource_lock);
> +	return rc;
> +}
> +EXPORT_SYMBOL_GPL(walk_hmem_resources);
> +
> +static void __hmem_register_resource(int target_nid, struct resource *res)
>   {
>   	struct platform_device *pdev;
> -	struct memregion_info info;
> -	int rc, id;
> +	struct resource *new;
> +	int rc;
>   
> -	if (nohmem)
> +	new = __request_region(&hmem_active, res->start, resource_size(res), "",
> +			       0);
> +	if (!new) {
> +		pr_debug("hmem range %pr already active\n", res);
>   		return;
> +	}
>   
> -	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
> -			       IORES_DESC_SOFT_RESERVED);
> -	if (rc != REGION_INTERSECTS)
> -		return;
> +	new->desc = target_nid;
>   
> -	id = memregion_alloc(GFP_KERNEL);
> -	if (id < 0) {
> -		pr_err("memregion allocation failure for %pr\n", res);
> +	if (platform_initialized)
>   		return;
> -	}
>   
> -	pdev = platform_device_alloc("hmem", id);
> +	pdev = platform_device_alloc("hmem_platform", 0);
>   	if (!pdev) {
> -		pr_err("hmem device allocation failure for %pr\n", res);
> -		goto out_pdev;
> -	}
> -
> -	if (!__request_region(&hmem_active, res->start, resource_size(res),
> -			      dev_name(&pdev->dev), 0)) {
> -		dev_dbg(&pdev->dev, "hmem range %pr already active\n", res);
> -		goto out_active;
> -	}
> -
> -	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
> -	info = (struct memregion_info) {
> -		.target_node = target_nid,
> -		.range = {
> -			.start = res->start,
> -			.end = res->end,
> -		},
> -	};
> -	rc = platform_device_add_data(pdev, &info, sizeof(info));
> -	if (rc < 0) {
> -		pr_err("hmem memregion_info allocation failure for %pr\n", res);
> -		goto out_resource;
> +		pr_err_once("failed to register device-dax hmem_platform device\n");
> +		return;
>   	}
>   
>   	rc = platform_device_add(pdev);
> -	if (rc < 0) {
> -		dev_err(&pdev->dev, "device add failed for %pr\n", res);
> -		goto out_resource;
> -	}
> +	if (rc)
> +		platform_device_put(pdev);
> +	else
> +		platform_initialized = true;
> +}
>   
> -	return;
> +void hmem_register_resource(int target_nid, struct resource *res)
> +{
> +	if (nohmem)
> +		return;
>   
> -out_resource:
> -	__release_region(&hmem_active, res->start, resource_size(res));
> -out_active:
> -	platform_device_put(pdev);
> -out_pdev:
> -	memregion_free(id);
> +	mutex_lock(&hmem_resource_lock);
> +	__hmem_register_resource(target_nid, res);
> +	mutex_unlock(&hmem_resource_lock);
>   }
>   
>   static __init int hmem_register_one(struct resource *res, void *data)
>   {
> -	hmem_register_device(phys_to_target_node(res->start), res);
> +	hmem_register_resource(phys_to_target_node(res->start), res);
>   
>   	return 0;
>   }
> diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
> index 5025a8c9850b..e7bdff3132fa 100644
> --- a/drivers/dax/hmem/hmem.c
> +++ b/drivers/dax/hmem/hmem.c
> @@ -3,6 +3,7 @@
>   #include <linux/memregion.h>
>   #include <linux/module.h>
>   #include <linux/pfn_t.h>
> +#include <linux/dax.h>
>   #include "../bus.h"
>   
>   static bool region_idle;
> @@ -43,8 +44,110 @@ static struct platform_driver dax_hmem_driver = {
>   	},
>   };
>   
> -module_platform_driver(dax_hmem_driver);
> +static void release_memregion(void *data)
> +{
> +	memregion_free((long) data);
> +}
> +
> +static void release_hmem(void *pdev)
> +{
> +	platform_device_unregister(pdev);
> +}
> +
> +static int hmem_register_device(struct device *host, int target_nid,
> +				const struct resource *res)
> +{
> +	struct platform_device *pdev;
> +	struct memregion_info info;
> +	long id;
> +	int rc;
> +
> +	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
> +			       IORES_DESC_SOFT_RESERVED);
> +	if (rc != REGION_INTERSECTS)
> +		return 0;
> +
> +	id = memregion_alloc(GFP_KERNEL);
> +	if (id < 0) {
> +		dev_err(host, "memregion allocation failure for %pr\n", res);
> +		return -ENOMEM;
> +	}
> +	rc = devm_add_action_or_reset(host, release_memregion, (void *) id);
> +	if (rc)
> +		return rc;
> +
> +	pdev = platform_device_alloc("hmem", id);
> +	if (!pdev) {
> +		dev_err(host, "device allocation failure for %pr\n", res);
> +		return -ENOMEM;
> +	}
> +
> +	pdev->dev.numa_node = numa_map_to_online_node(target_nid);
> +	info = (struct memregion_info) {
> +		.target_node = target_nid,
> +		.range = {
> +			.start = res->start,
> +			.end = res->end,
> +		},
> +	};
> +	rc = platform_device_add_data(pdev, &info, sizeof(info));
> +	if (rc < 0) {
> +		dev_err(host, "memregion_info allocation failure for %pr\n",
> +		       res);
> +		goto out_put;
> +	}
> +
> +	rc = platform_device_add(pdev);
> +	if (rc < 0) {
> +		dev_err(host, "%s add failed for %pr\n", dev_name(&pdev->dev),
> +			res);
> +		goto out_put;
> +	}
> +
> +	return devm_add_action_or_reset(host, release_hmem, pdev);
> +
> +out_put:
> +	platform_device_put(pdev);
> +	return rc;
> +}
> +
> +static int dax_hmem_platform_probe(struct platform_device *pdev)
> +{
> +	return walk_hmem_resources(&pdev->dev, hmem_register_device);
> +}
> +
> +static struct platform_driver dax_hmem_platform_driver = {
> +	.probe = dax_hmem_platform_probe,
> +	.driver = {
> +		.name = "hmem_platform",
> +	},
> +};
> +
> +static __init int dax_hmem_init(void)
> +{
> +	int rc;
> +
> +	rc = platform_driver_register(&dax_hmem_platform_driver);
> +	if (rc)
> +		return rc;
> +
> +	rc = platform_driver_register(&dax_hmem_driver);
> +	if (rc)
> +		platform_driver_unregister(&dax_hmem_platform_driver);
> +
> +	return rc;
> +}
> +
> +static __exit void dax_hmem_exit(void)
> +{
> +	platform_driver_unregister(&dax_hmem_driver);
> +	platform_driver_unregister(&dax_hmem_platform_driver);
> +}
> +
> +module_init(dax_hmem_init);
> +module_exit(dax_hmem_exit);
>   
>   MODULE_ALIAS("platform:hmem*");
> +MODULE_ALIAS("platform:hmem_platform*");
>   MODULE_LICENSE("GPL v2");
>   MODULE_AUTHOR("Intel Corporation");
> diff --git a/include/linux/dax.h b/include/linux/dax.h
> index 2b5ecb591059..bf6258472e49 100644
> --- a/include/linux/dax.h
> +++ b/include/linux/dax.h
> @@ -262,11 +262,14 @@ static inline bool dax_mapping(struct address_space *mapping)
>   }
>   
>   #ifdef CONFIG_DEV_DAX_HMEM_DEVICES
> -void hmem_register_device(int target_nid, struct resource *r);
> +void hmem_register_resource(int target_nid, struct resource *r);
>   #else
> -static inline void hmem_register_device(int target_nid, struct resource *r)
> +static inline void hmem_register_resource(int target_nid, struct resource *r)
>   {
>   }
>   #endif
>   
> +typedef int (*walk_hmem_fn)(struct device *dev, int target_nid,
> +			    const struct resource *res);
> +int walk_hmem_resources(struct device *dev, walk_hmem_fn fn);
>   #endif
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 550B1C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 22:20:07 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233935AbjBJWUG (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 17:20:06 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52766 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233937AbjBJWTv (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 17:19:51 -0500
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C669DB6D5E;
        Fri, 10 Feb 2023 14:19:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676067556; x=1707603556;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=5QEIEhNAp3nmGGpMMbKD0XHNWNNpBBL7AkmI44tqVdc=;
  b=TOXVT2d8OPzwTzXUjGd6VOYyZyzpLlbO5TI4MqWYRDZxYZ+gKyXiapj1
   iZTl/LCZ7WxR168FdE7HsqOshq1das73i685oWwBcyXxYbYpS4A7z5Sov
   0ePcnDqLvWHAaIjfXsMBzNwS2pfk3pbwe2/1kwfNUMfer15js40sKaQiU
   4/chgxRbmVviUJySZ0eebn/0vYGTKE9RdyfYsZ757h2SiDGes9LnZzTRG
   L4gh9DfwmXs5UZUmYtVp3hUgEQrkFeyXd6pODJS/YU5Q+P1tnp9feTgAY
   cuo5uwrKnLT7EJvLcrcP+5GgTJE1KlG7vL6DIfvR3n3SjbcSdwJ3hUstR
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="318558876"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="318558876"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:19:16 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="736875933"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="736875933"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by fmsmga004-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:19:12 -0800
Message-ID: <065ecb4a-c71e-b293-cc01-599e5ded50da@intel.com>
Date: Fri, 10 Feb 2023 15:19:11 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 19/20] dax: Assign RAM regions to memory-hotplug by
 default
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Michal Hocko <mhocko@suse.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Gregory Price <gregory.price@memverge.com>,
        Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602003336.1924368.6809503401422267885.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602003336.1924368.6809503401422267885.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:07 AM, Dan Williams wrote:
> The default mode for device-dax instances is backwards for RAM-regions
> as evidenced by the fact that it tends to catch end users by surprise.
> "Where is my memory?". Recall that platforms are increasingly shipping
> with performance-differentiated memory pools beyond typical DRAM and
> NUMA effects. This includes HBM (high-bandwidth-memory) and CXL (dynamic
> interleave, varied media types, and future fabric attached
> possibilities).
> 
> For this reason the EFI_MEMORY_SP (EFI Special Purpose Memory => Linux
> 'Soft Reserved') attribute is expected to be applied to all memory-pools
> that are not the general purpose pool. This designation gives an
> Operating System a chance to defer usage of a memory pool until later in
> the boot process where its performance properties can be interrogated
> and administrator policy can be applied.
> 
> 'Soft Reserved' memory can be anything from too limited and precious to
> be part of the general purpose pool (HBM), too slow to host hot kernel
> data structures (some PMEM media), or anything in between. However, in
> the absence of an explicit policy, the memory should at least be made
> usable by default. The current device-dax default hides all
> non-general-purpose memory behind a device interface.
> 
> The expectation is that the distribution of users that want the memory
> online by default vs device-dedicated-access by default follows the
> Pareto principle. A small number of enlightened users may want to do
> userspace memory management through a device, but general users just
> want the kernel to make the memory available with an option to get more
> advanced later.
> 
> Arrange for all device-dax instances not backed by PMEM to default to
> attaching to the dax_kmem driver. From there the baseline memory hotplug
> policy (CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE / memhp_default_state=)
> gates whether the memory comes online or stays offline. Where, if it
> stays offline, it can be reliably converted back to device-mode where it
> can be partitioned, or fronted by a userspace allocator.
> 
> So, if someone wants device-dax instances for their 'Soft Reserved'
> memory:
> 
> 1/ Build a kernel with CONFIG_MEMORY_HOTPLUG_DEFAULT_ONLINE=n or boot
>     with memhp_default_state=offline, or roll the dice and hope that the
>     kernel has not pinned a page in that memory before step 2.
> 
> 2/ Write a udev rule to convert the target dax device(s) from
>     'system-ram' mode to 'devdax' mode:
> 
>     daxctl reconfigure-device $dax -m devdax -f
> 
> Cc: Michal Hocko <mhocko@suse.com>
> Cc: David Hildenbrand <david@redhat.com>
> Cc: Dave Hansen <dave.hansen@linux.intel.com>
> Reviewed-by: Gregory Price <gregory.price@memverge.com>
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564544513.847146.4645646177864365755.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   drivers/dax/Kconfig     |    2 +-
>   drivers/dax/bus.c       |   53 ++++++++++++++++++++---------------------------
>   drivers/dax/bus.h       |   12 +++++++++--
>   drivers/dax/device.c    |    3 +--
>   drivers/dax/hmem/hmem.c |   12 ++++++++++-
>   drivers/dax/kmem.c      |    1 +
>   6 files changed, 46 insertions(+), 37 deletions(-)
> 
> diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
> index d13c889c2a64..1163eb62e5f6 100644
> --- a/drivers/dax/Kconfig
> +++ b/drivers/dax/Kconfig
> @@ -50,7 +50,7 @@ config DEV_DAX_HMEM_DEVICES
>   	def_bool y
>   
>   config DEV_DAX_KMEM
> -	tristate "KMEM DAX: volatile-use of persistent memory"
> +	tristate "KMEM DAX: map dax-devices as System-RAM"
>   	default DEV_DAX
>   	depends on DEV_DAX
>   	depends on MEMORY_HOTPLUG # for add_memory() and friends
> diff --git a/drivers/dax/bus.c b/drivers/dax/bus.c
> index 1dad813ee4a6..012d576004e9 100644
> --- a/drivers/dax/bus.c
> +++ b/drivers/dax/bus.c
> @@ -56,6 +56,25 @@ static int dax_match_id(struct dax_device_driver *dax_drv, struct device *dev)
>   	return match;
>   }
>   
> +static int dax_match_type(struct dax_device_driver *dax_drv, struct device *dev)
> +{
> +	enum dax_driver_type type = DAXDRV_DEVICE_TYPE;
> +	struct dev_dax *dev_dax = to_dev_dax(dev);
> +
> +	if (dev_dax->region->res.flags & IORESOURCE_DAX_KMEM)
> +		type = DAXDRV_KMEM_TYPE;
> +
> +	if (dax_drv->type == type)
> +		return 1;
> +
> +	/* default to device mode if dax_kmem is disabled */
> +	if (dax_drv->type == DAXDRV_DEVICE_TYPE &&
> +	    !IS_ENABLED(CONFIG_DEV_DAX_KMEM))
> +		return 1;
> +
> +	return 0;
> +}
> +
>   enum id_action {
>   	ID_REMOVE,
>   	ID_ADD,
> @@ -216,14 +235,9 @@ static int dax_bus_match(struct device *dev, struct device_driver *drv)
>   {
>   	struct dax_device_driver *dax_drv = to_dax_drv(drv);
>   
> -	/*
> -	 * All but the 'device-dax' driver, which has 'match_always'
> -	 * set, requires an exact id match.
> -	 */
> -	if (dax_drv->match_always)
> +	if (dax_match_id(dax_drv, dev))
>   		return 1;
> -
> -	return dax_match_id(dax_drv, dev);
> +	return dax_match_type(dax_drv, dev);
>   }
>   
>   /*
> @@ -1413,13 +1427,10 @@ struct dev_dax *devm_create_dev_dax(struct dev_dax_data *data)
>   }
>   EXPORT_SYMBOL_GPL(devm_create_dev_dax);
>   
> -static int match_always_count;
> -
>   int __dax_driver_register(struct dax_device_driver *dax_drv,
>   		struct module *module, const char *mod_name)
>   {
>   	struct device_driver *drv = &dax_drv->drv;
> -	int rc = 0;
>   
>   	/*
>   	 * dax_bus_probe() calls dax_drv->probe() unconditionally.
> @@ -1434,26 +1445,7 @@ int __dax_driver_register(struct dax_device_driver *dax_drv,
>   	drv->mod_name = mod_name;
>   	drv->bus = &dax_bus_type;
>   
> -	/* there can only be one default driver */
> -	mutex_lock(&dax_bus_lock);
> -	match_always_count += dax_drv->match_always;
> -	if (match_always_count > 1) {
> -		match_always_count--;
> -		WARN_ON(1);
> -		rc = -EINVAL;
> -	}
> -	mutex_unlock(&dax_bus_lock);
> -	if (rc)
> -		return rc;
> -
> -	rc = driver_register(drv);
> -	if (rc && dax_drv->match_always) {
> -		mutex_lock(&dax_bus_lock);
> -		match_always_count -= dax_drv->match_always;
> -		mutex_unlock(&dax_bus_lock);
> -	}
> -
> -	return rc;
> +	return driver_register(drv);
>   }
>   EXPORT_SYMBOL_GPL(__dax_driver_register);
>   
> @@ -1463,7 +1455,6 @@ void dax_driver_unregister(struct dax_device_driver *dax_drv)
>   	struct dax_id *dax_id, *_id;
>   
>   	mutex_lock(&dax_bus_lock);
> -	match_always_count -= dax_drv->match_always;
>   	list_for_each_entry_safe(dax_id, _id, &dax_drv->ids, list) {
>   		list_del(&dax_id->list);
>   		kfree(dax_id);
> diff --git a/drivers/dax/bus.h b/drivers/dax/bus.h
> index fbb940293d6d..8cd79ab34292 100644
> --- a/drivers/dax/bus.h
> +++ b/drivers/dax/bus.h
> @@ -11,7 +11,10 @@ struct dax_device;
>   struct dax_region;
>   void dax_region_put(struct dax_region *dax_region);
>   
> -#define IORESOURCE_DAX_STATIC (1UL << 0)
> +/* dax bus specific ioresource flags */
> +#define IORESOURCE_DAX_STATIC BIT(0)
> +#define IORESOURCE_DAX_KMEM BIT(1)
> +
>   struct dax_region *alloc_dax_region(struct device *parent, int region_id,
>   		struct range *range, int target_node, unsigned int align,
>   		unsigned long flags);
> @@ -25,10 +28,15 @@ struct dev_dax_data {
>   
>   struct dev_dax *devm_create_dev_dax(struct dev_dax_data *data);
>   
> +enum dax_driver_type {
> +	DAXDRV_KMEM_TYPE,
> +	DAXDRV_DEVICE_TYPE,
> +};
> +
>   struct dax_device_driver {
>   	struct device_driver drv;
>   	struct list_head ids;
> -	int match_always;
> +	enum dax_driver_type type;
>   	int (*probe)(struct dev_dax *dev);
>   	void (*remove)(struct dev_dax *dev);
>   };
> diff --git a/drivers/dax/device.c b/drivers/dax/device.c
> index 5494d745ced5..ecdff79e31f2 100644
> --- a/drivers/dax/device.c
> +++ b/drivers/dax/device.c
> @@ -475,8 +475,7 @@ EXPORT_SYMBOL_GPL(dev_dax_probe);
>   
>   static struct dax_device_driver device_dax_driver = {
>   	.probe = dev_dax_probe,
> -	/* all probe actions are unwound by devm, so .remove isn't necessary */
> -	.match_always = 1,
> +	.type = DAXDRV_DEVICE_TYPE,
>   };
>   
>   static int __init dax_init(void)
> diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
> index e7bdff3132fa..5ec08f9f8a57 100644
> --- a/drivers/dax/hmem/hmem.c
> +++ b/drivers/dax/hmem/hmem.c
> @@ -11,15 +11,25 @@ module_param_named(region_idle, region_idle, bool, 0644);
>   
>   static int dax_hmem_probe(struct platform_device *pdev)
>   {
> +	unsigned long flags = IORESOURCE_DAX_KMEM;
>   	struct device *dev = &pdev->dev;
>   	struct dax_region *dax_region;
>   	struct memregion_info *mri;
>   	struct dev_dax_data data;
>   	struct dev_dax *dev_dax;
>   
> +	/*
> +	 * @region_idle == true indicates that an administrative agent
> +	 * wants to manipulate the range partitioning before the devices
> +	 * are created, so do not send them to the dax_kmem driver by
> +	 * default.
> +	 */
> +	if (region_idle)
> +		flags = 0;
> +
>   	mri = dev->platform_data;
>   	dax_region = alloc_dax_region(dev, pdev->id, &mri->range,
> -				      mri->target_node, PMD_SIZE, 0);
> +				      mri->target_node, PMD_SIZE, flags);
>   	if (!dax_region)
>   		return -ENOMEM;
>   
> diff --git a/drivers/dax/kmem.c b/drivers/dax/kmem.c
> index 4852a2dbdb27..918d01d3fbaa 100644
> --- a/drivers/dax/kmem.c
> +++ b/drivers/dax/kmem.c
> @@ -239,6 +239,7 @@ static void dev_dax_kmem_remove(struct dev_dax *dev_dax)
>   static struct dax_device_driver device_dax_kmem_driver = {
>   	.probe = dev_dax_kmem_probe,
>   	.remove = dev_dax_kmem_remove,
> +	.type = DAXDRV_KMEM_TYPE,
>   };
>   
>   static int __init dax_kmem_init(void)
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 840C0C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 22:42:36 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233981AbjBJWme (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 17:42:34 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36804 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233962AbjBJWmV (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 17:42:21 -0500
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 138CD7E8E6;
        Fri, 10 Feb 2023 14:42:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676068936; x=1707604936;
  h=message-id:date:mime-version:subject:to:cc:references:
   from:in-reply-to:content-transfer-encoding;
  bh=vgQ5HVzNJYQdtWgtqWW9OALwKtOYaSgNWQqlC5r/Gh0=;
  b=RLYb/JP8J4r8u5rJIcXTvh3H71HGde/uHN0lkaQqhZ1iSWXmqG6F0TAJ
   5L7eShtk4rdildvomA5Yp3nzdsR7Hi8oXkODrGzFpqRHBNDhHECC1ypEE
   9w2bYZRncg/d/gkyHZtZ2yeLaExMXyqJJUCor8siveK/AFzA09zVl7gnx
   +PdCz3zJTZlb18gLKDREFqrQwWLt2MWNZLXywht2KXLOn3pzo5AggPuJe
   Zwc48oJR3lmPfMJF3luIVY+3K2zdJQKHAMc3Q14KkosfzfOirmwMT/gqb
   C0w+5nTN6GMvxnr/2On20FQd8Yn+sTVLxOKoZTJ4s6arNb0XKpqq1l7gl
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310176526"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="310176526"
Received: from orsmga007.jf.intel.com ([10.7.209.58])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:42:15 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="661554721"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="661554721"
Received: from djiang5-mobl3.amr.corp.intel.com (HELO [10.213.190.133]) ([10.213.190.133])
  by orsmga007-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 14:42:14 -0800
Message-ID: <d106eda8-ed57-9105-0b28-6dcca21e55a7@intel.com>
Date: Fri, 10 Feb 2023 15:42:14 -0700
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Firefox/102.0 Thunderbird/102.6.0
Subject: Re: [PATCH v2 20/20] cxl/dax: Create dax devices for CXL RAM regions
Content-Language: en-US
To: Dan Williams <dan.j.williams@intel.com>, linux-cxl@vger.kernel.org
Cc: Fan Ni <fan.ni@samsung.com>, vishal.l.verma@intel.com,
        dave.hansen@linux.intel.com, linux-mm@kvack.org,
        linux-acpi@vger.kernel.org
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com>
From: Dave Jiang <dave.jiang@intel.com>
In-Reply-To: <167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org



On 2/10/23 2:07 AM, Dan Williams wrote:
> While platform firmware takes some responsibility for mapping the RAM
> capacity of CXL devices present at boot, the OS is responsible for
> mapping the remainder and hot-added devices. Platform firmware is also
> responsible for identifying the platform general purpose memory pool,
> typically DDR attached DRAM, and arranging for the remainder to be 'Soft
> Reserved'. That reservation allows the CXL subsystem to route the memory
> to core-mm via memory-hotplug (dax_kmem), or leave it for dedicated
> access (device-dax).
> 
> The new 'struct cxl_dax_region' object allows for a CXL memory resource
> (region) to be published, but also allow for udev and module policy to
> act on that event. It also prevents cxl_core.ko from having a module
> loading dependency on any drivers/dax/ modules.
> 
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564545116.847146.4741351262959589920.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>

> ---
>   MAINTAINERS               |    1
>   drivers/cxl/acpi.c        |    3 +
>   drivers/cxl/core/core.h   |    3 +
>   drivers/cxl/core/port.c   |    4 +-
>   drivers/cxl/core/region.c |  108 ++++++++++++++++++++++++++++++++++++++++++++-
>   drivers/cxl/cxl.h         |   12 +++++
>   drivers/dax/Kconfig       |   13 +++++
>   drivers/dax/Makefile      |    2 +
>   drivers/dax/cxl.c         |   53 ++++++++++++++++++++++
>   drivers/dax/hmem/hmem.c   |   14 ++++++
>   10 files changed, 209 insertions(+), 4 deletions(-)
>   create mode 100644 drivers/dax/cxl.c
> 
> diff --git a/MAINTAINERS b/MAINTAINERS
> index 7f86d02cb427..73a9f3401e0e 100644
> --- a/MAINTAINERS
> +++ b/MAINTAINERS
> @@ -6035,6 +6035,7 @@ M:	Dan Williams <dan.j.williams@intel.com>
>   M:	Vishal Verma <vishal.l.verma@intel.com>
>   M:	Dave Jiang <dave.jiang@intel.com>
>   L:	nvdimm@lists.linux.dev
> +L:	linux-cxl@vger.kernel.org
>   S:	Supported
>   F:	drivers/dax/
>   
> diff --git a/drivers/cxl/acpi.c b/drivers/cxl/acpi.c
> index ad0849af42d7..8ebb9a74790d 100644
> --- a/drivers/cxl/acpi.c
> +++ b/drivers/cxl/acpi.c
> @@ -731,7 +731,8 @@ static void __exit cxl_acpi_exit(void)
>   	cxl_bus_drain();
>   }
>   
> -module_init(cxl_acpi_init);
> +/* load before dax_hmem sees 'Soft Reserved' CXL ranges */
> +subsys_initcall(cxl_acpi_init);
>   module_exit(cxl_acpi_exit);
>   MODULE_LICENSE("GPL v2");
>   MODULE_IMPORT_NS(CXL);
> diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
> index 479f01da6d35..cde475e13216 100644
> --- a/drivers/cxl/core/core.h
> +++ b/drivers/cxl/core/core.h
> @@ -15,12 +15,14 @@ extern struct device_attribute dev_attr_create_ram_region;
>   extern struct device_attribute dev_attr_delete_region;
>   extern struct device_attribute dev_attr_region;
>   extern const struct device_type cxl_pmem_region_type;
> +extern const struct device_type cxl_dax_region_type;
>   extern const struct device_type cxl_region_type;
>   void cxl_decoder_kill_region(struct cxl_endpoint_decoder *cxled);
>   #define CXL_REGION_ATTR(x) (&dev_attr_##x.attr)
>   #define CXL_REGION_TYPE(x) (&cxl_region_type)
>   #define SET_CXL_REGION_ATTR(x) (&dev_attr_##x.attr),
>   #define CXL_PMEM_REGION_TYPE(x) (&cxl_pmem_region_type)
> +#define CXL_DAX_REGION_TYPE(x) (&cxl_dax_region_type)
>   int cxl_region_init(void);
>   void cxl_region_exit(void);
>   #else
> @@ -38,6 +40,7 @@ static inline void cxl_region_exit(void)
>   #define CXL_REGION_TYPE(x) NULL
>   #define SET_CXL_REGION_ATTR(x)
>   #define CXL_PMEM_REGION_TYPE(x) NULL
> +#define CXL_DAX_REGION_TYPE(x) NULL
>   #endif
>   
>   struct cxl_send_command;
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index b45d2796ef35..0bb7a5ff724b 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -46,6 +46,8 @@ static int cxl_device_id(struct device *dev)
>   		return CXL_DEVICE_NVDIMM;
>   	if (dev->type == CXL_PMEM_REGION_TYPE())
>   		return CXL_DEVICE_PMEM_REGION;
> +	if (dev->type == CXL_DAX_REGION_TYPE())
> +		return CXL_DEVICE_DAX_REGION;
>   	if (is_cxl_port(dev)) {
>   		if (is_cxl_root(to_cxl_port(dev)))
>   			return CXL_DEVICE_ROOT;
> @@ -2015,6 +2017,6 @@ static void cxl_core_exit(void)
>   	debugfs_remove_recursive(cxl_debugfs);
>   }
>   
> -module_init(cxl_core_init);
> +subsys_initcall(cxl_core_init);
>   module_exit(cxl_core_exit);
>   MODULE_LICENSE("GPL v2");
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 3f6453da2c51..91d334080cab 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -2272,6 +2272,75 @@ static struct cxl_pmem_region *cxl_pmem_region_alloc(struct cxl_region *cxlr)
>   	return cxlr_pmem;
>   }
>   
> +static void cxl_dax_region_release(struct device *dev)
> +{
> +	struct cxl_dax_region *cxlr_dax = to_cxl_dax_region(dev);
> +
> +	kfree(cxlr_dax);
> +}
> +
> +static const struct attribute_group *cxl_dax_region_attribute_groups[] = {
> +	&cxl_base_attribute_group,
> +	NULL,
> +};
> +
> +const struct device_type cxl_dax_region_type = {
> +	.name = "cxl_dax_region",
> +	.release = cxl_dax_region_release,
> +	.groups = cxl_dax_region_attribute_groups,
> +};
> +
> +static bool is_cxl_dax_region(struct device *dev)
> +{
> +	return dev->type == &cxl_dax_region_type;
> +}
> +
> +struct cxl_dax_region *to_cxl_dax_region(struct device *dev)
> +{
> +	if (dev_WARN_ONCE(dev, !is_cxl_dax_region(dev),
> +			  "not a cxl_dax_region device\n"))
> +		return NULL;
> +	return container_of(dev, struct cxl_dax_region, dev);
> +}
> +EXPORT_SYMBOL_NS_GPL(to_cxl_dax_region, CXL);
> +
> +static struct lock_class_key cxl_dax_region_key;
> +
> +static struct cxl_dax_region *cxl_dax_region_alloc(struct cxl_region *cxlr)
> +{
> +	struct cxl_region_params *p = &cxlr->params;
> +	struct cxl_dax_region *cxlr_dax;
> +	struct device *dev;
> +
> +	down_read(&cxl_region_rwsem);
> +	if (p->state != CXL_CONFIG_COMMIT) {
> +		cxlr_dax = ERR_PTR(-ENXIO);
> +		goto out;
> +	}
> +
> +	cxlr_dax = kzalloc(sizeof(*cxlr_dax), GFP_KERNEL);
> +	if (!cxlr_dax) {
> +		cxlr_dax = ERR_PTR(-ENOMEM);
> +		goto out;
> +	}
> +
> +	cxlr_dax->hpa_range.start = p->res->start;
> +	cxlr_dax->hpa_range.end = p->res->end;
> +
> +	dev = &cxlr_dax->dev;
> +	cxlr_dax->cxlr = cxlr;
> +	device_initialize(dev);
> +	lockdep_set_class(&dev->mutex, &cxl_dax_region_key);
> +	device_set_pm_not_required(dev);
> +	dev->parent = &cxlr->dev;
> +	dev->bus = &cxl_bus_type;
> +	dev->type = &cxl_dax_region_type;
> +out:
> +	up_read(&cxl_region_rwsem);
> +
> +	return cxlr_dax;
> +}
> +
>   static void cxlr_pmem_unregister(void *_cxlr_pmem)
>   {
>   	struct cxl_pmem_region *cxlr_pmem = _cxlr_pmem;
> @@ -2356,6 +2425,42 @@ static int devm_cxl_add_pmem_region(struct cxl_region *cxlr)
>   	return rc;
>   }
>   
> +static void cxlr_dax_unregister(void *_cxlr_dax)
> +{
> +	struct cxl_dax_region *cxlr_dax = _cxlr_dax;
> +
> +	device_unregister(&cxlr_dax->dev);
> +}
> +
> +static int devm_cxl_add_dax_region(struct cxl_region *cxlr)
> +{
> +	struct cxl_dax_region *cxlr_dax;
> +	struct device *dev;
> +	int rc;
> +
> +	cxlr_dax = cxl_dax_region_alloc(cxlr);
> +	if (IS_ERR(cxlr_dax))
> +		return PTR_ERR(cxlr_dax);
> +
> +	dev = &cxlr_dax->dev;
> +	rc = dev_set_name(dev, "dax_region%d", cxlr->id);
> +	if (rc)
> +		goto err;
> +
> +	rc = device_add(dev);
> +	if (rc)
> +		goto err;
> +
> +	dev_dbg(&cxlr->dev, "%s: register %s\n", dev_name(dev->parent),
> +		dev_name(dev));
> +
> +	return devm_add_action_or_reset(&cxlr->dev, cxlr_dax_unregister,
> +					cxlr_dax);
> +err:
> +	put_device(dev);
> +	return rc;
> +}
> +
>   static int match_decoder_by_range(struct device *dev, void *data)
>   {
>   	struct range *r1, *r2 = data;
> @@ -2619,8 +2724,7 @@ static int cxl_region_probe(struct device *dev)
>   					p->res->start, p->res->end, cxlr,
>   					is_system_ram) > 0)
>   			return 0;
> -		dev_dbg(dev, "TODO: hookup devdax\n");
> -		return 0;
> +		return devm_cxl_add_dax_region(cxlr);
>   	default:
>   		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
>   			cxlr->mode);
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index 2ac344235235..b1395c46baec 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -513,6 +513,12 @@ struct cxl_pmem_region {
>   	struct cxl_pmem_region_mapping mapping[];
>   };
>   
> +struct cxl_dax_region {
> +	struct device dev;
> +	struct cxl_region *cxlr;
> +	struct range hpa_range;
> +};
> +
>   /**
>    * struct cxl_port - logical collection of upstream port devices and
>    *		     downstream port devices to construct a CXL memory
> @@ -707,6 +713,7 @@ void cxl_driver_unregister(struct cxl_driver *cxl_drv);
>   #define CXL_DEVICE_MEMORY_EXPANDER	5
>   #define CXL_DEVICE_REGION		6
>   #define CXL_DEVICE_PMEM_REGION		7
> +#define CXL_DEVICE_DAX_REGION		8
>   
>   #define MODULE_ALIAS_CXL(type) MODULE_ALIAS("cxl:t" __stringify(type) "*")
>   #define CXL_MODALIAS_FMT "cxl:t%d"
> @@ -725,6 +732,7 @@ bool is_cxl_pmem_region(struct device *dev);
>   struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev);
>   int cxl_add_to_region(struct cxl_port *root,
>   		      struct cxl_endpoint_decoder *cxled);
> +struct cxl_dax_region *to_cxl_dax_region(struct device *dev);
>   #else
>   static inline bool is_cxl_pmem_region(struct device *dev)
>   {
> @@ -739,6 +747,10 @@ static inline int cxl_add_to_region(struct cxl_port *root,
>   {
>   	return 0;
>   }
> +static inline struct cxl_dax_region *to_cxl_dax_region(struct device *dev)
> +{
> +	return NULL;
> +}
>   #endif
>   
>   /*
> diff --git a/drivers/dax/Kconfig b/drivers/dax/Kconfig
> index 1163eb62e5f6..bd06e16c7ac8 100644
> --- a/drivers/dax/Kconfig
> +++ b/drivers/dax/Kconfig
> @@ -45,6 +45,19 @@ config DEV_DAX_HMEM
>   
>   	  Say M if unsure.
>   
> +config DEV_DAX_CXL
> +	tristate "CXL DAX: direct access to CXL RAM regions"
> +	depends on CXL_REGION && DEV_DAX
> +	default CXL_REGION && DEV_DAX
> +	help
> +	  CXL RAM regions are either mapped by platform-firmware
> +	  and published in the initial system-memory map as "System RAM", mapped
> +	  by platform-firmware as "Soft Reserved", or dynamically provisioned
> +	  after boot by the CXL driver. In the latter two cases a device-dax
> +	  instance is created to access that unmapped-by-default address range.
> +	  Per usual it can remain as dedicated access via a device interface, or
> +	  converted to "System RAM" via the dax_kmem facility.
> +
>   config DEV_DAX_HMEM_DEVICES
>   	depends on DEV_DAX_HMEM && DAX
>   	def_bool y
> diff --git a/drivers/dax/Makefile b/drivers/dax/Makefile
> index 90a56ca3b345..5ed5c39857c8 100644
> --- a/drivers/dax/Makefile
> +++ b/drivers/dax/Makefile
> @@ -3,10 +3,12 @@ obj-$(CONFIG_DAX) += dax.o
>   obj-$(CONFIG_DEV_DAX) += device_dax.o
>   obj-$(CONFIG_DEV_DAX_KMEM) += kmem.o
>   obj-$(CONFIG_DEV_DAX_PMEM) += dax_pmem.o
> +obj-$(CONFIG_DEV_DAX_CXL) += dax_cxl.o
>   
>   dax-y := super.o
>   dax-y += bus.o
>   device_dax-y := device.o
>   dax_pmem-y := pmem.o
> +dax_cxl-y := cxl.o
>   
>   obj-y += hmem/
> diff --git a/drivers/dax/cxl.c b/drivers/dax/cxl.c
> new file mode 100644
> index 000000000000..ccdf8de85bd5
> --- /dev/null
> +++ b/drivers/dax/cxl.c
> @@ -0,0 +1,53 @@
> +// SPDX-License-Identifier: GPL-2.0-only
> +/* Copyright(c) 2023 Intel Corporation. All rights reserved. */
> +#include <linux/module.h>
> +#include <linux/dax.h>
> +
> +#include "../cxl/cxl.h"
> +#include "bus.h"
> +
> +static int cxl_dax_region_probe(struct device *dev)
> +{
> +	struct cxl_dax_region *cxlr_dax = to_cxl_dax_region(dev);
> +	int nid = phys_to_target_node(cxlr_dax->hpa_range.start);
> +	struct cxl_region *cxlr = cxlr_dax->cxlr;
> +	struct dax_region *dax_region;
> +	struct dev_dax_data data;
> +	struct dev_dax *dev_dax;
> +
> +	if (nid == NUMA_NO_NODE)
> +		nid = memory_add_physaddr_to_nid(cxlr_dax->hpa_range.start);
> +
> +	dax_region = alloc_dax_region(dev, cxlr->id, &cxlr_dax->hpa_range, nid,
> +				      PMD_SIZE, IORESOURCE_DAX_KMEM);
> +	if (!dax_region)
> +		return -ENOMEM;
> +
> +	data = (struct dev_dax_data) {
> +		.dax_region = dax_region,
> +		.id = -1,
> +		.size = range_len(&cxlr_dax->hpa_range),
> +	};
> +	dev_dax = devm_create_dev_dax(&data);
> +	if (IS_ERR(dev_dax))
> +		return PTR_ERR(dev_dax);
> +
> +	/* child dev_dax instances now own the lifetime of the dax_region */
> +	dax_region_put(dax_region);
> +	return 0;
> +}
> +
> +static struct cxl_driver cxl_dax_region_driver = {
> +	.name = "cxl_dax_region",
> +	.probe = cxl_dax_region_probe,
> +	.id = CXL_DEVICE_DAX_REGION,
> +	.drv = {
> +		.suppress_bind_attrs = true,
> +	},
> +};
> +
> +module_cxl_driver(cxl_dax_region_driver);
> +MODULE_ALIAS_CXL(CXL_DEVICE_DAX_REGION);
> +MODULE_LICENSE("GPL");
> +MODULE_AUTHOR("Intel Corporation");
> +MODULE_IMPORT_NS(CXL);
> diff --git a/drivers/dax/hmem/hmem.c b/drivers/dax/hmem/hmem.c
> index 5ec08f9f8a57..e5fe8b39fb94 100644
> --- a/drivers/dax/hmem/hmem.c
> +++ b/drivers/dax/hmem/hmem.c
> @@ -72,6 +72,13 @@ static int hmem_register_device(struct device *host, int target_nid,
>   	long id;
>   	int rc;
>   
> +	if (IS_ENABLED(CONFIG_CXL_REGION) &&
> +	    region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
> +			      IORES_DESC_CXL) != REGION_DISJOINT) {
> +		dev_dbg(host, "deferring range to CXL: %pr\n", res);
> +		return 0;
> +	}
> +
>   	rc = region_intersects(res->start, resource_size(res), IORESOURCE_MEM,
>   			       IORES_DESC_SOFT_RESERVED);
>   	if (rc != REGION_INTERSECTS)
> @@ -157,6 +164,13 @@ static __exit void dax_hmem_exit(void)
>   module_init(dax_hmem_init);
>   module_exit(dax_hmem_exit);
>   
> +/* Allow for CXL to define its own dax regions */
> +#if IS_ENABLED(CONFIG_CXL_REGION)
> +#if IS_MODULE(CONFIG_CXL_ACPI)
> +MODULE_SOFTDEP("pre: cxl_acpi");
> +#endif
> +#endif
> +
>   MODULE_ALIAS("platform:hmem*");
>   MODULE_ALIAS("platform:hmem_platform*");
>   MODULE_LICENSE("GPL v2");
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 019D9C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 23:17:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229479AbjBJXRN (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 18:17:13 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60350 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229461AbjBJXRM (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 18:17:12 -0500
Received: from mga06.intel.com (mga06b.intel.com [134.134.136.31])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3CD9E17CEE;
        Fri, 10 Feb 2023 15:17:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676071031; x=1707607031;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=7f9aG3a1X9qu6eYbR2Q/lzokh603nQExz9rGfIrWCl8=;
  b=SiuYSK3YY37odVQdL6fuPsB8PP+igbYXK1JzM7ziwcwAHyE5Cs1gq9/P
   q5jFbaYaz4igeiOIwhe54nOI5yrHiydOr6/5RJSkxWAHCbCW8hjt3/6x3
   Wtg8/psAJjH9/ooxkG44hKDNukPkAkVTYUNEEATook6LDRfxXYJNPkuAY
   FQF92vZW22hIkCcc32M88o6XP0AOoYXk7M+85v/7EMoGxrnSrcGCADT8J
   vluYoyVTRjounhBZpFvR5EpPG99pQ1yBg8erAmGww4lf5InxV4o4+cg8L
   FTOrKUbotOO3qjpuW0x7S5BAr3Vat3G567fXAK/x6Qne2UiPhjtNMlq2v
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="392954687"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="392954687"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by orsmga104.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 15:17:04 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="736884605"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="736884605"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmsmga004.fm.intel.com with ESMTP; 10 Feb 2023 15:17:04 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:04 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:03 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 15:17:03 -0800
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (104.47.55.106)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:03 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=RpQqirxVmTW5W8+r+MCGpwQE1Kx/2sCpSB7eqnPQzY8n82Q48eWcKyTXZ91SOkiS9iBpzfPefJbfcEJtKANMgz/xMgXL1IrSOFSWmStlbhRv77zVW/1lTJL9k/weRtDCpjx/9ZqcKaD9BIh+vaf77z66JEap7UcQAHJ2Y9ifokQKwzqRoPcgI23EgS3z/vEnLwDyC6FtZWbW9oCl/gvz5n0lSZ6mF8jsurDNw9E2nv/xLuh2cpUfIu/6PMpoR0yQBExWvdqe332OZH+6ZjC8YGTcEqTIS82t+maNMkYg9RpGPQzSYKoH/WM7DSVTq8cJo0ewZqb5UVyb+/DOv9JHCQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=7f9aG3a1X9qu6eYbR2Q/lzokh603nQExz9rGfIrWCl8=;
 b=m/zTv/iztIDXyl9Gi5QlwMQ8rc+rkFrPEujklUxdCtkLjS1c51kCbbT1qNcv5U0vThvI7Do4v+ZN17176qDVI77Ff+E/ykoMbiJFNRorzyEPgImTVC9iCLgEBHzVsL65rs1cNoxkB6wOpIp1V0u6vTLzb8HDCrPchZ5pNLaI/G0uxg/EhNqvDFA+632VPJjz1KRuYMhhj0PB6Y6THHv+2o8pg6H7hZj4v10/T6jhljEy0uQFBU8BJTeK1YT/Y4E6Yv7bbfBvLHfkNt2T26haeDluA1d1kddF88QGOHpvf/bqJwEoxFOVb3eTh3HycxQJ3s9nskBic9VfKOt1ecjrhA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by MW4PR11MB6763.namprd11.prod.outlook.com (2603:10b6:303:20b::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 23:17:01 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Fri, 10 Feb 2023
 23:17:01 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 01/20] cxl/memdev: Fix endpoint port removal
Thread-Topic: [PATCH v2 01/20] cxl/memdev: Fix endpoint port removal
Thread-Index: AQHZPS7WY7b06dYEgUaGSi8v0QvOEa7I0S6A
Date: Fri, 10 Feb 2023 23:17:01 +0000
Message-ID: <205c20125f9ac540b600acee346714fae73de258.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|MW4PR11MB6763:EE_
x-ms-office365-filtering-correlation-id: 8a9f6ef0-c207-41db-5942-08db0bbcea34
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: 0aGAmvbGNROnC/wwuE0uuwghSwBdGsk47XLlAZPChZcmURy7261XF/eCIQfVSykoTMyzKWI4If7xMKzh9bILGeZAWbRvyB0Y36l+lfB6k7dRzxJyCMgX1b6k/w51jLBCbIQfyAN78kriYAZZ2egkTE/WSmECVENfneP5h1qjoCgPxV6fq62hbbnGy8SOD9fUVJrLypVAZBuJFES4DwXkUNSymBcYzzKOl0k+wJL70lJluUwPD841Q6EwTppYYFq1giVxGCV62AmlZgzTOsakGMm49XhHuBVLwgEZJMQcuhua7v24yXwrLOdc4BdX5ZU7EQr2Xy5HohmdezZFPegu5MoY7rDBFY16MovsLP/0mzAzFe7EngRwJk6C7NrdgW0DEUFR7pqo1csdddYoK8bKevsovATh/FDzNslnqVN9j0G1F+4GmsOo+KojTydW7o/HAicN/S+Nq0rEp8a/yW2XNUmFceqC7NGIw4yVmPlmA11fyMPaJ//sKUNVxkOJ/vL2X9+H+ebcYq9JN9beMoAbyZZ0+Fg6p4+3iYJpKvk7vTU8x6+KEoZn8rjsol33xiTY9+2Y4tN6cnSfO6qbXcnHkyf/XeygW4NPKO9S7tugerNK9lfwO5AjTmuRJMGax2LiauK1dPsKvcLO5KgEG+pYM7p+jl+D5pSUGcZPJhxO53JZ7xnbz9P+agr4fzaB61uU6A9KQ4xsCVs2X5ZCGdMnC6csH4KaoUkYAJPhV47XUN+U+QmEMg/vGtPGmJ0s9GOC
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(39860400002)(366004)(136003)(376002)(396003)(451199018)(110136005)(316002)(54906003)(91956017)(5660300002)(8676002)(76116006)(4326008)(66946007)(66556008)(66476007)(41300700001)(66446008)(64756008)(82960400001)(38070700005)(86362001)(36756003)(38100700002)(122000001)(6512007)(6506007)(26005)(71200400001)(6486002)(966005)(186003)(2616005)(2906002)(8936002)(478600001)(83380400001)(309714004);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?UCtBc01FdVR0YW5mcGsrYytIemhzY3ZlOFUram10SFN4N0xtdmZoVEwyOWVP?=
 =?utf-8?B?ZDhTZ1hiN283UE9scTFCaTk0bWlYNWQzTDRiWkdneGVjSmV3b2tlY2NhM3Bx?=
 =?utf-8?B?d2wzNGxPb0lvS0YvVUF3WElvNytpcVRDSTRVRVQ0OTc1ZitKTjhhU1V3Zmkv?=
 =?utf-8?B?Y2xkeGlrSG9mMmx5MFVRd1VFQ0k3aENjZVgrK3ZMZmh5TWtnTWhzTWNwVVAx?=
 =?utf-8?B?Y3Vhakp1cXdSekpkT1lOdEp3dlo4aFQvMnpUOXhYNko3NDNHTWcxLytCaXd4?=
 =?utf-8?B?TWdlVHFxZXllallOeXlmTmFNQVYrUVJQMmFNWGtVRGdYSlhBK013U2VFUlFL?=
 =?utf-8?B?T2NlM2pPVTV0NGlURTY5U2VhUXgwWDJsTlFGNnRyUTFidkdkcHYvc29LUTJT?=
 =?utf-8?B?K3pOd3UzK2VzbzU1TElnR0NHRDM1b2twMEpzTG51S096VjJJK2wzMVhIejJK?=
 =?utf-8?B?WVdPdUg1RFA0UVcyeEk4djcxSTV2dEpOWHh6OXBSZ1dYSjFHQjVKRlhpUWxI?=
 =?utf-8?B?NHdaaGR4K1RyMjVOajFJOEdkN01tY055T3NEVzIycUJWWWlRbmRCQk45alVs?=
 =?utf-8?B?VWFValBhTlhaT1ZGMk1NUXpSMGZmUUp1K3VaK3F1b2d5UUx1YjA2YmFnNGQ3?=
 =?utf-8?B?WUhSK1dScmU3K01VL2xsdHR0VnFFR0kwaE9maEdDdEgrbjJkSnlLRmE5RnZq?=
 =?utf-8?B?Rm1nSUFSanZEMkFxVEU3cmlNM01xZTZLeGpDdzg1c2FpYUZOdHU2YzJ4VlV1?=
 =?utf-8?B?ck1vQnNtSEQxOHNkTFJDRlZUVElVOVlxS2xmQWRyUFZycmhiMzR3cm1EWjF4?=
 =?utf-8?B?MG9lc2hGTzBXMk9FRUd5UVZVSXMxcEdWczNTQmxPbEhCTVNTRGpYRmswalJN?=
 =?utf-8?B?dGF3VXhpK2RQWkVFdTdqU1hLK0xBQUYyMTljaEQ4Y0JCZVNRUGRvMVNIYlB0?=
 =?utf-8?B?cUVvS1FtcllBdUk1cnpiSmVmYjFtM3poVU42Z1phbFR3ZDhVaHE1ZW5TcFBF?=
 =?utf-8?B?a0RGR0FYRzdVUlJHM0NwTjZwelhmalMwRmkwOUloS2dtUkZBZDBKUm5oekgy?=
 =?utf-8?B?Y05pTUUvYWNqNFd2T00xWGN4ekFzSWduYytJYmF2c0p4SEQvWFJCd3JPR3Zh?=
 =?utf-8?B?QmxwR3RVUEFlK1kzVU4rWHNycEJDSklNaHphTjNqaHJVY2h2OFFOMXRqaUtQ?=
 =?utf-8?B?UkZqL25ZU1ZMVnFUVi9hV0phK1VFVFdyT3hVcUV5dldwS3hHNVlaMVlKbENE?=
 =?utf-8?B?ekllV0g4K1l4NmxzekE5cGY1Y0J3aHlPdDBRWnM2NlUrZmlPaHpkK1RndGdp?=
 =?utf-8?B?cEMzbGxpMDhwTGVaSERzT2NOcHF6TzRkOUVucXVUOHRBbmkvM255ZjY2UmRH?=
 =?utf-8?B?YXl0UXd3RnlZOGNyRFYwZ2tpenFxS0xYbnh3N2FjTHdkZFRZQWtSUCtBWjEy?=
 =?utf-8?B?L3hDMWNWaXBvakdrcFNsUk9hamU1dForMEtQWmdrNUNBMXh0Mys4K2gwR3cz?=
 =?utf-8?B?SEFhcGc3cDBaRE9TdjNhdVhEUGp4Qk5QWUNabVAvK2NuaUtENUdCZWxLdzVz?=
 =?utf-8?B?NU1QYU5TMFRSL29oMGRrWkMwaFJ0aGJZdGhkNHJlZ252ZnBJYUtnc29SSkow?=
 =?utf-8?B?M2I2MkNURkxYTTg5V3dwa0lJK2xURzRxNGRIQWZ2OU93RGlGa2cwSkEzaER0?=
 =?utf-8?B?N1NBV1FrZUxYS1lvNk1Ccm95cWE5ajYyTjZQWU1NZmdFRXQxMkxIYjRuTFVZ?=
 =?utf-8?B?Rlc0OGFPUm01aFQxQit4RGlJdFZFbm9SSkhRS00xNGFXZ2dEK0ZBZ0syYlAy?=
 =?utf-8?B?WjJMYzdiSmMyV04rM0NjMDRGbGpsdGJtVjd3NlQrWEIyb2dsdVRkUVdMZ1dr?=
 =?utf-8?B?cytTN29WSUNtUlJRZ0NLbEhueVZ6Qnl6dDBaTWExdkEvWE1STlVtYzdEb3Mr?=
 =?utf-8?B?OGVCVWNDNEwvVnBhQ1FuT1hzMDhzeTVOU3FQclhNNjkvR1BNMjIxcVJhV2F2?=
 =?utf-8?B?UXVjWTJ4S2JUT296dTRXN3pxRlhLZFdSQllDWkpGc0RtQUIwYkNVWUpReDVz?=
 =?utf-8?B?MVcxMUhaaTBjbml3QzluNEpNL2ZWV01UTmU5QVNObS9qOUhVMGptc1h0ZnUz?=
 =?utf-8?B?UlF6UXcwdDZsK3BBODVWNWZCWkVoMlRURFdiK3lGZGJzSUdOWGJCZ2l1MUNa?=
 =?utf-8?B?UGc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <4A58DAB430FBED42BFDE5FE449DD3B55@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8a9f6ef0-c207-41db-5942-08db0bbcea34
X-MS-Exchange-CrossTenant-originalarrivaltime: 10 Feb 2023 23:17:01.3801
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: JM8DLm9Ei15rXwuJa4E+Ql6iMJlq/2NcNJtaQY+9a6WSR0cvRLf5Vj9BT+Z26Y+Nzu3L83eWB5gRV7d51g5cAeZqFk7LgikNoCgvCEANeMY=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR11MB6763
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA1IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
VGVzdGluZyBvZiByYW0gcmVnaW9uIHN1cHBvcnQgWzFdLCBzdGltdWxhdGVzIGEgbG9uZyBzdGFu
ZGluZyBidWcgaW4KPiBjeGxfZGV0YWNoX2VwKCkgd2hlcmUgc29tZSBjeGxfZXBfcmVtb3ZlKCkg
Y2xlYW51cCBpcyBza2lwcGVkIGR1ZSB0bwo+IGluYWJpbGl0eSB0byB3YWxrIHBvcnRzIGFmdGVy
IGRwb3J0cyBoYXZlIGJlZW4gdW5yZWdpc3RlcmVkLiBUaGF0Cj4gcmVzdWx0cyBpbiBhIGZhaWx1
cmUgdG8gcmUtcmVnaXN0ZXIgYSBtZW1kZXYgYWZ0ZXIgdGhlIHBvcnQgaXMKPiByZS1lbmFibGVk
IGxlYWRpbmcgdG8gYSBjcmFzaCBsaWtlIHRoZSBmb2xsb3dpbmc6Cj4gCj4gwqDCoMKgIGN4bF9w
b3J0X3NldHVwX3RhcmdldHM6IGN4bCByZWdpb240OiBjeGxfaG9zdF9icmlkZ2UuMDpwb3J0NCBp
dzogMSBpZzogMjU2Cj4gwqDCoMKgIGdlbmVyYWwgcHJvdGVjdGlvbiBmYXVsdCwgLi4uCj4gwqDC
oMKgIFsuLl0KPiDCoMKgwqAgUklQOiAwMDEwOmN4bF9yZWdpb25fc2V0dXBfdGFyZ2V0cysweDg5
Ny8weDllMCBbY3hsX2NvcmVdCj4gwqDCoMKgIGRldl9uYW1lIGF0IGluY2x1ZGUvbGludXgvZGV2
aWNlLmg6NzAwCj4gwqDCoMKgIChpbmxpbmVkIGJ5KSBjeGxfcG9ydF9zZXR1cF90YXJnZXRzIGF0
IGRyaXZlcnMvY3hsL2NvcmUvcmVnaW9uLmM6MTE1NQo+IMKgwqDCoCAoaW5saW5lZCBieSkgY3hs
X3JlZ2lvbl9zZXR1cF90YXJnZXRzIGF0IGRyaXZlcnMvY3hsL2NvcmUvcmVnaW9uLmM6MTI0OQo+
IMKgwqDCoCBbLi5dCj4gwqDCoMKgIENhbGwgVHJhY2U6Cj4gwqDCoMKgwqAgPFRBU0s+Cj4gwqDC
oMKgwqAgYXR0YWNoX3RhcmdldCsweDM5YS8weDc2MCBbY3hsX2NvcmVdCj4gwqDCoMKgwqAgPyBf
X211dGV4X3VubG9ja19zbG93cGF0aCsweDNhLzB4MjkwCj4gwqDCoMKgwqAgY3hsX2FkZF90b19y
ZWdpb24rMHhiOC8weDM0MCBbY3hsX2NvcmVdCj4gwqDCoMKgwqAgPyBsb2NrZGVwX2hhcmRpcnFz
X29uKzB4N2QvMHgxMDAKPiDCoMKgwqDCoCBkaXNjb3Zlcl9yZWdpb24rMHg0Yi8weDgwIFtjeGxf
cG9ydF0KPiDCoMKgwqDCoCA/IF9fcGZ4X2Rpc2NvdmVyX3JlZ2lvbisweDEwLzB4MTAgW2N4bF9w
b3J0XQo+IMKgwqDCoMKgIGRldmljZV9mb3JfZWFjaF9jaGlsZCsweDU4LzB4OTAKPiDCoMKgwqDC
oCBjeGxfcG9ydF9wcm9iZSsweDEwZS8weDEzMCBbY3hsX3BvcnRdCj4gwqDCoMKgwqAgY3hsX2J1
c19wcm9iZSsweDE3LzB4NTAgW2N4bF9jb3JlXQo+IAo+IENoYW5nZSB0aGUgcG9ydCBhbmNlc3Ry
eSB3YWxrIHRvIGJlIGJ5IGRlcHRoIHJhdGhlciB0aGFuIGJ5IGRwb3J0LiBUaGlzCj4gZW5zdXJl
cyB0aGF0IGV2ZW4gaWYgYSBwb3J0IGhhcyB1bnJlZ2lzdGVyZWQgaXRzIGRwb3J0cyBhIGRlZmVy
cmVkCj4gbWVtZGV2IGNsZWFudXAgd2lsbCBzdGlsbCBiZSBhYmxlIHRvIGNsZWFudXAgdGhlIG1l
bWRldidzIGludGVyZXN0IGluCj4gdGhhdCBwb3J0Lgo+IAo+IFRoZSBwYXJlbnRfcG9ydC0+ZGV2
LmRyaXZlciBjaGVjayBpcyBvbmx5IG5lZWRlZCBmb3IgZGV0ZXJtaW5pbmcgaWYgdGhlCj4gYm90
dG9tIHVwIHJlbW92YWwgYmVhdCB0aGUgdG9wLWRvd24gcmVtb3ZhbCwgYnV0IGN4bF9lcF9yZW1v
dmUoKSBjYW4KPiBhbHdheXMgcHJvY2VlZC4KPiAKPiBGaXhlczogMjcwM2MxNmM3NWFlICgiY3hs
L2NvcmUvcG9ydDogQWRkIHN3aXRjaCBwb3J0IGVudW1lcmF0aW9uIikKPiBMaW5rOiBodHRwOi8v
bG9yZS5rZXJuZWwub3JnL3IvMTY3NTY0NTM0ODc0Ljg0NzE0Ni41MjIyNDE5NjQ4NTUxNDM2NzUw
LnN0Z2l0QGR3aWxsaWEyLXhmaC5qZi5pbnRlbC5jb23CoFsxXQo+IFNpZ25lZC1vZmYtYnk6IERh
biBXaWxsaWFtcyA8ZGFuLmoud2lsbGlhbXNAaW50ZWwuY29tPgo+IC0tLQo+IMKgZHJpdmVycy9j
eGwvY29yZS9tZW1kZXYuYyB8wqDCoMKgIDEgKwo+IMKgZHJpdmVycy9jeGwvY29yZS9wb3J0LmPC
oMKgIHzCoMKgIDU4ICsrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0t
LQo+IMKgZHJpdmVycy9jeGwvY3hsbWVtLmjCoMKgwqDCoMKgIHzCoMKgwqAgMiArKwo+IMKgMyBm
aWxlcyBjaGFuZ2VkLCAzNSBpbnNlcnRpb25zKCspLCAyNiBkZWxldGlvbnMoLSkKCkxvb2tzIGdv
b2QsCgpSZXZpZXdlZC1ieTogVmlzaGFsIFZlcm1hIDx2aXNoYWwubC52ZXJtYUBpbnRlbC5jb20+
Cgo+IAo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2N4bC9jb3JlL21lbWRldi5jIGIvZHJpdmVycy9j
eGwvY29yZS9tZW1kZXYuYwo+IGluZGV4IGE3NGE5MzMxMGQyNi4uM2E4YmMyYjA2MDQ3IDEwMDY0
NAo+IC0tLSBhL2RyaXZlcnMvY3hsL2NvcmUvbWVtZGV2LmMKPiArKysgYi9kcml2ZXJzL2N4bC9j
b3JlL21lbWRldi5jCj4gQEAgLTI0Niw2ICsyNDYsNyBAQCBzdGF0aWMgc3RydWN0IGN4bF9tZW1k
ZXYgKmN4bF9tZW1kZXZfYWxsb2Moc3RydWN0IGN4bF9kZXZfc3RhdGUgKmN4bGRzLAo+IMKgwqDC
oMKgwqDCoMKgwqBpZiAocmMgPCAwKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
Z290byBlcnI7Cj4gwqDCoMKgwqDCoMKgwqDCoGN4bG1kLT5pZCA9IHJjOwo+ICvCoMKgwqDCoMKg
wqDCoGN4bG1kLT5kZXB0aCA9IC0xOwo+IMKgCj4gwqDCoMKgwqDCoMKgwqDCoGRldiA9ICZjeGxt
ZC0+ZGV2Owo+IMKgwqDCoMKgwqDCoMKgwqBkZXZpY2VfaW5pdGlhbGl6ZShkZXYpOwo+IGRpZmYg
LS1naXQgYS9kcml2ZXJzL2N4bC9jb3JlL3BvcnQuYyBiL2RyaXZlcnMvY3hsL2NvcmUvcG9ydC5j
Cj4gaW5kZXggNDEwYzAzNmMwOWZhLi4zMTdiY2Y0ZGJkOWQgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVy
cy9jeGwvY29yZS9wb3J0LmMKPiArKysgYi9kcml2ZXJzL2N4bC9jb3JlL3BvcnQuYwo+IEBAIC0x
MjA3LDYgKzEyMDcsNyBAQCBpbnQgY3hsX2VuZHBvaW50X2F1dG9yZW1vdmUoc3RydWN0IGN4bF9t
ZW1kZXYgKmN4bG1kLCBzdHJ1Y3QgY3hsX3BvcnQgKmVuZHBvaW50KQo+IMKgCj4gwqDCoMKgwqDC
oMKgwqDCoGdldF9kZXZpY2UoJmVuZHBvaW50LT5kZXYpOwo+IMKgwqDCoMKgwqDCoMKgwqBkZXZf
c2V0X2RydmRhdGEoZGV2LCBlbmRwb2ludCk7Cj4gK8KgwqDCoMKgwqDCoMKgY3hsbWQtPmRlcHRo
ID0gZW5kcG9pbnQtPmRlcHRoOwo+IMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gZGV2bV9hZGRfYWN0
aW9uX29yX3Jlc2V0KGRldiwgZGVsZXRlX2VuZHBvaW50LCBjeGxtZCk7Cj4gwqB9Cj4gwqBFWFBP
UlRfU1lNQk9MX05TX0dQTChjeGxfZW5kcG9pbnRfYXV0b3JlbW92ZSwgQ1hMKTsKPiBAQCAtMTI0
MSw1MCArMTI0Miw1NSBAQCBzdGF0aWMgdm9pZCByZWFwX2Rwb3J0cyhzdHJ1Y3QgY3hsX3BvcnQg
KnBvcnQpCj4gwqDCoMKgwqDCoMKgwqDCoH0KPiDCoH0KPiDCoAo+ICtzdHJ1Y3QgZGV0YWNoX2N0
eCB7Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9tZW1kZXYgKmN4bG1kOwo+ICvCoMKgwqDC
oMKgwqDCoGludCBkZXB0aDsKPiArfTsKPiArCj4gK3N0YXRpYyBpbnQgcG9ydF9oYXNfbWVtZGV2
KHN0cnVjdCBkZXZpY2UgKmRldiwgY29uc3Qgdm9pZCAqZGF0YSkKPiArewo+ICvCoMKgwqDCoMKg
wqDCoGNvbnN0IHN0cnVjdCBkZXRhY2hfY3R4ICpjdHggPSBkYXRhOwo+ICvCoMKgwqDCoMKgwqDC
oHN0cnVjdCBjeGxfcG9ydCAqcG9ydDsKPiArCj4gK8KgwqDCoMKgwqDCoMKgaWYgKCFpc19jeGxf
cG9ydChkZXYpKQo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gMDsKPiAr
Cj4gK8KgwqDCoMKgwqDCoMKgcG9ydCA9IHRvX2N4bF9wb3J0KGRldik7Cj4gK8KgwqDCoMKgwqDC
oMKgaWYgKHBvcnQtPmRlcHRoICE9IGN0eC0+ZGVwdGgpCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoHJldHVybiAwOwo+ICsKPiArwqDCoMKgwqDCoMKgwqByZXR1cm4gISFjeGxfZXBf
bG9hZChwb3J0LCBjdHgtPmN4bG1kKTsKPiArfQo+ICsKPiDCoHN0YXRpYyB2b2lkIGN4bF9kZXRh
Y2hfZXAodm9pZCAqZGF0YSkKPiDCoHsKPiDCoMKgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9tZW1k
ZXYgKmN4bG1kID0gZGF0YTsKPiAtwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgZGV2aWNlICppdGVyOwo+
IMKgCj4gLcKgwqDCoMKgwqDCoMKgZm9yIChpdGVyID0gJmN4bG1kLT5kZXY7IGl0ZXI7IGl0ZXIg
PSBncmFuZHBhcmVudChpdGVyKSkgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBz
dHJ1Y3QgZGV2aWNlICpkcG9ydF9kZXYgPSBncmFuZHBhcmVudChpdGVyKTsKPiArwqDCoMKgwqDC
oMKgwqBmb3IgKGludCBpID0gY3hsbWQtPmRlcHRoIC0gMTsgaSA+PSAxOyBpLS0pIHsKPiDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfcG9ydCAqcG9ydCwgKnBhcmVu
dF9wb3J0Owo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgZGV0YWNoX2N0
eCBjdHggPSB7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqAuY3hsbWQgPSBjeGxtZCwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoC5kZXB0aCA9IGksCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH07
Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBkZXZpY2UgKmRldjsKPiDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfZXAgKmVwOwo+IMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgYm9vbCBkaWVkID0gZmFsc2U7Cj4gwqAKPiAtwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaWYgKCFkcG9ydF9kZXYpCj4gLcKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBicmVhazsKPiAtCj4gLcKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoHBvcnQgPSBmaW5kX2N4bF9wb3J0KGRwb3J0X2RldiwgTlVM
TCk7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmICghcG9ydCkKPiAtwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGNvbnRpbnVlOwo+IC0KPiAt
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaWYgKGlzX2N4bF9yb290KHBvcnQpKSB7Cj4g
LcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwdXRfZGV2aWNl
KCZwb3J0LT5kZXYpOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXYgPSBidXNf
ZmluZF9kZXZpY2UoJmN4bF9idXNfdHlwZSwgTlVMTCwgJmN0eCwKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
IHBvcnRfaGFzX21lbWRldik7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmICgh
ZGV2KQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGNv
bnRpbnVlOwo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqB9Cj4gK8KgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoHBvcnQgPSB0b19jeGxfcG9ydChkZXYpOwo+IMKgCj4gwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwYXJlbnRfcG9ydCA9IHRvX2N4bF9wb3J0KHBvcnQt
PmRldi5wYXJlbnQpOwo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2aWNlX2xv
Y2soJnBhcmVudF9wb3J0LT5kZXYpOwo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBp
ZiAoIXBhcmVudF9wb3J0LT5kZXYuZHJpdmVyKSB7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAvKgo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgICogVGhlIGJvdHRvbS11cCByYWNlIHRvIGRlbGV0ZSB0aGUgcG9y
dCBsb3N0IHRvIGEKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoCAqIHRvcC1kb3duIHBvcnQgZGlzYWJsZSwgZ2l2ZSB1cCBoZXJlLCBiZWNhdXNlIHRoZQo+
IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICogcGFyZW50
X3BvcnQgLT5yZW1vdmUoKSB3aWxsIGhhdmUgY2xlYW5lZCB1cCBhbGwKPiAtwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCAqIGRlc2NlbmRhbnRzLgo+IC3CoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICovCj4gLcKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXZpY2VfdW5sb2NrKCZwYXJl
bnRfcG9ydC0+ZGV2KTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoHB1dF9kZXZpY2UoJnBvcnQtPmRldik7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjb250aW51ZTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgfQo+IC0KPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGRldmljZV9s
b2NrKCZwb3J0LT5kZXYpOwo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZXAgPSBj
eGxfZXBfbG9hZChwb3J0LCBjeGxtZCk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqBkZXZfZGJnKCZjeGxtZC0+ZGV2LCAiZGlzY29ubmVjdCAlcyBmcm9tICVzXG4iLAo+IMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGVwID8gZGV2X25hbWUo
ZXAtPmVwKSA6ICIiLCBkZXZfbmFtZSgmcG9ydC0+ZGV2KSk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqBjeGxfZXBfcmVtb3ZlKHBvcnQsIGVwKTsKPiDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoGlmIChlcCAmJiAhcG9ydC0+ZGVhZCAmJiB4YV9lbXB0eSgmcG9ydC0+
ZW5kcG9pbnRzKSAmJgo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAgIWlz
X2N4bF9yb290KHBhcmVudF9wb3J0KSkgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqAgIWlzX2N4bF9yb290KHBhcmVudF9wb3J0KSAmJiBwYXJlbnRfcG9ydC0+ZGV2LmRy
aXZlcikgewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oC8qCj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICog
VGhpcyB3YXMgdGhlIGxhc3QgZXAgYXR0YWNoZWQgdG8gYSBkeW5hbWljYWxseQo+IMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCAqIGVudW1lcmF0ZWQgcG9y
dC4gQmxvY2sgbmV3IGN4bF9hZGRfZXAoKSBhbmQgZ2FyYmFnZQo+IGRpZmYgLS1naXQgYS9kcml2
ZXJzL2N4bC9jeGxtZW0uaCBiL2RyaXZlcnMvY3hsL2N4bG1lbS5oCj4gaW5kZXggYWIxMzgwMDRm
NjQ0Li5jOWRhM2M2OTlhMjEgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9jeGwvY3hsbWVtLmgKPiAr
KysgYi9kcml2ZXJzL2N4bC9jeGxtZW0uaAo+IEBAIC0zOCw2ICszOCw3IEBACj4gwqAgKiBAY3hs
X252YjogY29vcmRpbmF0ZSByZW1vdmFsIG9mIEBjeGxfbnZkIGlmIHByZXNlbnQKPiDCoCAqIEBj
eGxfbnZkOiBvcHRpb25hbCBicmlkZ2UgdG8gYW4gbnZkaW1tIGlmIHRoZSBkZXZpY2Ugc3VwcG9y
dHMgcG1lbQo+IMKgICogQGlkOiBpZCBudW1iZXIgb2YgdGhpcyBtZW1kZXYgaW5zdGFuY2UuCj4g
KyAqIEBkZXB0aDogZW5kcG9pbnQgcG9ydCBkZXB0aAo+IMKgICovCj4gwqBzdHJ1Y3QgY3hsX21l
bWRldiB7Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBkZXZpY2UgZGV2Owo+IEBAIC00Nyw2ICs0
OCw3IEBAIHN0cnVjdCBjeGxfbWVtZGV2IHsKPiDCoMKgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9u
dmRpbW1fYnJpZGdlICpjeGxfbnZiOwo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgY3hsX252ZGlt
bSAqY3hsX252ZDsKPiDCoMKgwqDCoMKgwqDCoMKgaW50IGlkOwo+ICvCoMKgwqDCoMKgwqDCoGlu
dCBkZXB0aDsKPiDCoH07Cj4gwqAKPiDCoHN0YXRpYyBpbmxpbmUgc3RydWN0IGN4bF9tZW1kZXYg
KnRvX2N4bF9tZW1kZXYoc3RydWN0IGRldmljZSAqZGV2KQo+IAoK

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 650D3C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 23:17:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229645AbjBJXRu (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 18:17:50 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60462 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229461AbjBJXRt (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 18:17:49 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BC0A81814F;
        Fri, 10 Feb 2023 15:17:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676071068; x=1707607068;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=DSQFtfxsCOTuIwGQpMQSDKdzgocEbsz3hQJfAS0Wo7A=;
  b=JZV30tMZeBLFwLQj3wQKbRPoMR6gb38oJp6YIlaq11B+fKHaZCf4TGnB
   n4W2yy+9mykbOLFDbKklLvUsIjwkM6bEFYP7yGSc7C63CI1xDjg9EJWtN
   3knhMW+htVbtpVfKKQUb0smd91vjwJorfqN1QO1FkEFpwx1FU7faEuHUh
   XH2GtUwgIVldfM1bBUngwjbXfnPFke7NZ2ULAlPJCHILJRwvtTxvLfOD2
   xF9ghphrOvmz0NUruewhAa01tXctD6tCJiTXhdD6CWPR0aATt2IpudeRr
   6IwLfPYFsUpBy2N/1/xgAFZIV1JTsXFWnPYLb9KtJYWanX2Vc6yyTgidH
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310914297"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="310914297"
Received: from fmsmga001.fm.intel.com ([10.253.24.23])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 15:17:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="810986581"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="810986581"
Received: from orsmsx602.amr.corp.intel.com ([10.22.229.15])
  by fmsmga001.fm.intel.com with ESMTP; 10 Feb 2023 15:17:48 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX602.amr.corp.intel.com (10.22.229.15) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:47 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:47 -0800
Received: from ORSEDG602.ED.cps.intel.com (10.7.248.7) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 15:17:47 -0800
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (104.47.57.168)
 by edgegateway.intel.com (134.134.137.103) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 15:17:46 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=bAondeAVQBWF6KIzqAGXcxZhMb0MC7L36gSNqXlfhL1WD412BNEF94D8bqAuKftSj8akfjGxcXc3ydltWBIhyacYO34ejKZxMoHqNNiu7I1G+3wp9MeqtxucXXG1vLSdXANPF6Z6XqRBYdvQTWcIECg5JVGlTbnb98kwc5HQOfl3UXs2Pidw6jBHfjqkDyX2J4+C7TaHdy4OhK7kTJuAyUlDXCJAHKRHQYK4YXA098atj6QuYMCia3VmrQlNdyjJy5ZLGLukyprbWHTH96oCRD8hp72nwM9uVRxO9wd624PO2X3nUrA8YD2IEJM5E//nC9rt5y8XpwZiY7Zne5peXw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=DSQFtfxsCOTuIwGQpMQSDKdzgocEbsz3hQJfAS0Wo7A=;
 b=bXjQ49O2n0fD40VyoSh4o3TuCAno0rlUWOAJx+mvTJWpXO27qUF6i1MDUblmC3Clta8M89dNla4pRz9Rl+wgqt0XlpA0cbfbj7SJ4/dJJWLGfRZbIPboD7n50SyPlrjl++ErIcpSCVNx6U+r+S9Yi19+YqJw0SkcL0UN6V6HjzCStc+kdJsv/RsUw7uj8QCFXv7V72vGvlZ4yhOAxlYxtOr1iyuAokR17+ZrgPsU4tRJ/weP9P8I5FI1iTtTaCkn447jCGKQJcp9dP+EM/2An4imW1OoyWGX7MHf4/1zrd7fVnMWMyIBQyz7jU74gykfoIa1wYWuiC7AzBZQzLA8Qw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by MW4PR11MB6763.namprd11.prod.outlook.com (2603:10b6:303:20b::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 23:17:40 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Fri, 10 Feb 2023
 23:17:40 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "Jonathan.Cameron@Huawei.com" <Jonathan.Cameron@Huawei.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 08/20] cxl/region: Cleanup target list on attach error
Thread-Topic: [PATCH v2 08/20] cxl/region: Cleanup target list on attach error
Thread-Index: AQHZPS7zyVUQGfaNGU68kEv7nw0AM67I0V0A
Date: Fri, 10 Feb 2023 23:17:39 +0000
Message-ID: <7cce2c809fdb1c042b285de57f4cec0ace2127fd.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|MW4PR11MB6763:EE_
x-ms-office365-filtering-correlation-id: 63f8cfe8-cc3f-4bd3-145f-08db0bbd013c
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: 9/BY3iWBvK6DYNhb+ZYmqOl5PErsNEqh+AldntBQw3hJvMA1gmPYKCpEmbSmpjplzWvJxdgQWKoBo4vTlvRfN/btHx0K6NVL6ABSwRv68BT8dDiKclFABeLu7K5q4zLj+BKw56cnPIwBbZtbKoawbgWTiochr1Z5oHx2gGfVtLdIrV/W25s6AamdBscujM0zdEjFceeBGN3HpJ7Q86OkXmIVZLUZJUmqK5tzx1LMVysBIa5sSAjPWQkkXXp6IcGiar+K9smqtQuJbWTMinGbYyix7FQs1pIIdXJ0KQET2uBXQdCsK14il0K+kLLKPNAZH50GeZDm+4Pi9GvxBE0uSgnLL6jCHCPrTB91UGmXH4EMZvDvSZCvIBTkfqUr7D85joNmhT6ADFGm9o6Gl/5xlUynma3iZbMi68PZUIWbIWjTbnBJnoSt4PHXPX6My77J+MvwaDL122qS7U+pNzMSmPjWPB7k8TSyGlK2AxO35CNmdTOslbkljEiIgXq7y2jy56MQKH5Sg3bMriJIrZz/F5pf2yHe+4Q6Nky3YxVEt+6r3Vtvq2Mq9/Uxc/rq6jFRua/7GaL1pcWj7lNxSFprDAA718gR5E70RUCk7vYjdEyk84t8oQfDTv9kCS288fJn0Xo3eucqGM3iDl6EaTQhlpyPPTUPGI1eNLR3OixqHL01Do7ZMiYQen4sw1OPgL/Ea/uP9uVqvxcqO1qgsrjAzMVKwKBBx7nEvkRzP18MHio=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(39860400002)(366004)(136003)(376002)(396003)(451199018)(110136005)(316002)(54906003)(91956017)(5660300002)(8676002)(76116006)(4326008)(66946007)(66556008)(66476007)(41300700001)(66446008)(64756008)(82960400001)(38070700005)(86362001)(36756003)(38100700002)(122000001)(6512007)(6506007)(26005)(71200400001)(6486002)(966005)(186003)(2616005)(2906002)(4744005)(8936002)(478600001)(83380400001);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?M09IT2k4eHRnL243R2xLYnRJVkQ1Z0xxeW1YbzJNejgzV20zWVNuTnhxa25R?=
 =?utf-8?B?SGxCaUg1Y3JxVmdrM1JTZjZ2SUw5eEVCdkx2YnhVWHNheHJvNDd5M1NvRitJ?=
 =?utf-8?B?UlJMbys1amtPVUVKR0xCdjlCMVpBM0N4anR5Vm5ZNkxPeFUzMzc2YTNEZU9Z?=
 =?utf-8?B?QkFpNUpqYy9vRTEyTXZNL3NDMis5YjBjK3ArMjZXOGF3aDBENGJBNzBVeXho?=
 =?utf-8?B?RklxaHFnTmdpUlY0a2RrTEZBeVVhQzRoSC9NeVBsdFRvV3c0WkFjTHdCVGpa?=
 =?utf-8?B?Rkc0SUJVTmhPZ2dkeWNFQlFXMnA3TnBpQWU3Mnk5VlIzQjNTTDFoRVdiYzZK?=
 =?utf-8?B?MUVQRi9mMEtQeUFRYUcwN2lsQ0dUREdhTXY2b2RyMHZxU0txcEhNY1NLWEFG?=
 =?utf-8?B?SnZjbDZBeEFWbW5XaGRlN0wwa0t1ZEQyakFTendVQnV2VUMzT0FzZ0t3aCtm?=
 =?utf-8?B?TDRPMUtYdUZxQXNkSkZ6Rjc3RVoxZkFMYlJ2NUhRVzRHNVV2R2RqZEozUnpt?=
 =?utf-8?B?ek5Hd01aUXBOMFZUbFR3OGlSd3BPNUdseXlMZnlGSTU5cGZIenFrM3NWclVG?=
 =?utf-8?B?RVM5S2ltS2lwZi80a3E0dkZoMTY4RHpqN2NhMVJYYlFhQVB4NGM4Q2tYVmlL?=
 =?utf-8?B?ZlVQT29oRldDbDlEOGU1YVpWZ3R3eXRQM3Q0MFEyYXg4L0pLZU9lM0lPa0s4?=
 =?utf-8?B?QloxTXFjcHh4TVdzRTRzNXRVWStlUFQrQTZES1Iyb3hYM1FWbnBhSzZxOFJK?=
 =?utf-8?B?WHI1TmI2Q1N2Zk5GS2p1dFdnT1FFbzBTQzZsai9HcVBSWkRkNUpTL2JBRHZZ?=
 =?utf-8?B?MytjYjJtUE81Yk1tSE0wWGdYNGNaTnA3R0RoN1NsZ0htUVd2VkYrV3QrbmZQ?=
 =?utf-8?B?OUFnMEZEbnRxWkh3bGVvenNZOTVvSE5zR1pxVTN2dzNCbmJOMWF6NTRUVUVj?=
 =?utf-8?B?cXdhcGkwSlRSTWxlb0dsTjkyR3JlYnF0Zk1lUkpTcG5VWE4xeDBrUUhxNGky?=
 =?utf-8?B?UDFMdDZxWkNsMSswWWN0QnZDOWl4Qld6M2dHTTNMc3dhU2k2MUhyWnJBT1B2?=
 =?utf-8?B?aG1wRE5ud2lURGRjMUtZV2FOZ3NvSkZuSG0rajBjenliOEhsQkF4ZzdYV3pG?=
 =?utf-8?B?Z3dkNXhvaytIR0FxOSt5M1BJc3Y0K2lVMUFBRDlQMXFUWmhtdGw5NVhydUVj?=
 =?utf-8?B?VWRrdnFodEJVQ1lJdXJJQTBRaWt0OS85bWJNTk8zMTJhd3QvYm1sMGxkTXM2?=
 =?utf-8?B?Q3dUb0k5dU0xUytDTkhZSThkSjllUFR1bWpFRGJnbE8yUEkrWk1UdFhEZHRa?=
 =?utf-8?B?a0ZiN0c5OW9jclNpS0VHTWVEWENtYXQyaE9EN0o0VzdMekZqVnJPVEcvVWR6?=
 =?utf-8?B?dUNKTTVWOG9WaGpBcEhpaXhoaEtjQ2lmT2pUZXJNV1p4N1V4Wk5rTjJQaFJm?=
 =?utf-8?B?Z3N0V21XQmZialNRbCtxRm1SQjVlUkxKNGFycGZGQTdqV3haSk9tY3RjM0h2?=
 =?utf-8?B?azZFTzZuNjRjVmlMMGMyajdLT1Q0K2w2a213Qnk4NVYzbUF0MUo0cWFvaWNx?=
 =?utf-8?B?WmdNWDhOL1crWHh3eXNrNHRzK0ZEdVdtOGdkakNCN3RjTXFQajBLU1hTaWZt?=
 =?utf-8?B?NmppMjVHd2tMVS8rNVZMdGNLRGpsOUZydnA0alBIZmQrMnZlNWFmV2F0UWI3?=
 =?utf-8?B?ZmVmRkxkSFlpYjlwS1kvZW5QcWZJeFZlamhsK0lCSlRwRlNYY1RQdFRreWdD?=
 =?utf-8?B?NGxKSlphaUtlZUxDOTZPb1RUblRMREFvYVpKVTBEeGplak5Cc1dkdnFVOEJE?=
 =?utf-8?B?TFhDQmFmTjdLcld2UEpvaGJiWjBpU0E4cVVMSnpLOHo5ZncxTzQyS2ZlTG1p?=
 =?utf-8?B?bnBjQ3M2ZmtHc2wreVNKNjkzUllNK3BhVmtsUWd2OTFWMGgzRXEwVjRJMXBP?=
 =?utf-8?B?cStJekNSUXJJaGx2TVk5ejRqODdIQnVZV0tBQmFxSUV2TXRLNWp2UFRCaDMr?=
 =?utf-8?B?emFTWnVpcWlrR3hiQ1hZa2V3RS9iSWwrV01OblFZRUlIcWdWaUVXK2s0aHJU?=
 =?utf-8?B?a2M5SDJVckh6UllGNmlJcEtod1JnbkpHRmF1Y0gwYlhNVkgrR2grSkMxQmFD?=
 =?utf-8?B?bkVqazFuUXFaTlplblBZbUhaWXlQVTJ1b1NOcUx3OUxFaHJndkkrQTE4YmR2?=
 =?utf-8?B?VHc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <BFD8FA74114AA44281DAE41DE3B65044@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 63f8cfe8-cc3f-4bd3-145f-08db0bbd013c
X-MS-Exchange-CrossTenant-originalarrivaltime: 10 Feb 2023 23:17:39.9871
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: FTYZJdy84PJApSPbvwr9apjfOHIQhmhKSYOW+PeFy8yvrbUSl/+1UG9otWEmQalwoqkxEC9aNjdSvp1VGDZEMDHr0sr0seAajx0D4gVffAQ=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR11MB6763
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6DQo+
IEpvbmF0aGFuIG5vdGljZWQgdGhhdCB0aGUgdGFyZ2V0IGxpc3Qgc2V0dXAgaXMgbm90IHVud291
bmQgY29tcGxldGVseQ0KPiB1cG9uIGVycm9yLiBVbmRvIGFsbCB0aGUgc2V0dXAgaW4gdGhlICdl
cnJfZGVjcmVtZW50OicgZXhpdCBwYXRoLg0KPiANCj4gRml4ZXM6IDI3YjNmOGQxMzgzMCAoImN4
bC9yZWdpb246IFByb2dyYW0gdGFyZ2V0IGxpc3RzIikNCj4gUmVwb3J0ZWQtYnk6IEpvbmF0aGFu
IENhbWVyb24gPEpvbmF0aGFuLkNhbWVyb25ASHVhd2VpLmNvbT4NCj4gTGluazogaHR0cDovL2xv
cmUua2VybmVsLm9yZy9yLzIwMjMwMjA4MTIzMDMxLjAwMDA2OTkwQEh1YXdlaS5jb20NCj4gU2ln
bmVkLW9mZi1ieTogRGFuIFdpbGxpYW1zIDxkYW4uai53aWxsaWFtc0BpbnRlbC5jb20+DQo+IC0t
LQ0KPiDCoGRyaXZlcnMvY3hsL2NvcmUvcmVnaW9uLmMgfMKgwqDCoCAyICsrDQo+IMKgMSBmaWxl
IGNoYW5nZWQsIDIgaW5zZXJ0aW9ucygrKQ0KDQpMb29rcyBnb29kLA0KDQpSZXZpZXdlZC1ieTog
VmlzaGFsIFZlcm1hIDx2aXNoYWwubC52ZXJtYUBpbnRlbC5jb20+DQoNCj4gDQo+IGRpZmYgLS1n
aXQgYS9kcml2ZXJzL2N4bC9jb3JlL3JlZ2lvbi5jIGIvZHJpdmVycy9jeGwvY29yZS9yZWdpb24u
Yw0KPiBpbmRleCAwNDBiYmQzOWM4MWQuLmFlN2QzYWRjZDQxYSAxMDA2NDQNCj4gLS0tIGEvZHJp
dmVycy9jeGwvY29yZS9yZWdpb24uYw0KPiArKysgYi9kcml2ZXJzL2N4bC9jb3JlL3JlZ2lvbi5j
DQo+IEBAIC0xMzQ3LDYgKzEzNDcsOCBAQCBzdGF0aWMgaW50IGN4bF9yZWdpb25fYXR0YWNoKHN0
cnVjdCBjeGxfcmVnaW9uICpjeGxyLA0KPiDCoA0KPiDCoGVycl9kZWNyZW1lbnQ6DQo+IMKgwqDC
oMKgwqDCoMKgwqBwLT5ucl90YXJnZXRzLS07DQo+ICvCoMKgwqDCoMKgwqDCoGN4bGVkLT5wb3Mg
PSAtMTsNCj4gK8KgwqDCoMKgwqDCoMKgcC0+dGFyZ2V0c1twb3NdID0gTlVMTDsNCj4gwqBlcnI6
DQo+IMKgwqDCoMKgwqDCoMKgwqBmb3IgKGl0ZXIgPSBlcF9wb3J0OyAhaXNfY3hsX3Jvb3QoaXRl
cik7DQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCBpdGVyID0gdG9fY3hsX3BvcnQoaXRlci0+
ZGV2LnBhcmVudCkpDQo+IA0KDQo=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 87325C6379F
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 23:22:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229695AbjBJXWJ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 18:22:09 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33826 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229683AbjBJXWG (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 18:22:06 -0500
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7B9061E284;
        Fri, 10 Feb 2023 15:21:58 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676071318; x=1707607318;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=I8J3Hy6dmzk/nC1EcrmBEv7DGAWCvb70N5DUqH46w2s=;
  b=BgVzvmP9YEvxQrR8Vi/qhRZRtynOIDbk4+cYk285NX6MdFh6uwiFdd3k
   oSlPgTpNYg0bCZR5smdgEpOWe9PwWtPo26R+aR8cLa7lxZC0ZrD2rzJ7X
   6zr4FJw6Czw5jCBOCseDGsTS5YaPZcapdH/VkcKFaKormbbSN1NYlxmQQ
   Px24gB5R0UiA6ZKTW2khzpgCwDvpR1IBDUydpH0qCin4ja6BExNKsYWay
   8WU16EQUDSd4nALPryyvFrcAWNA8TAscItPUWz8CS3SnMhLSO5sHa7Vl8
   tOHKuuVTdtVbEFp1V7uoQ5vuV65Y5CmADJHhTPDVQhIEAG6o9gkkl5Ya4
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="328246490"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="328246490"
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 15:21:58 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="997103045"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="997103045"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by fmsmga005.fm.intel.com with ESMTP; 10 Feb 2023 15:21:57 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:21:57 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:21:57 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 15:21:57 -0800
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (104.47.55.106)
 by edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 15:21:56 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=MqjbFHDI7uonp02h5oAvBE2lONr9HAjeufc6qlNgAJ0YcPXLiMmzwM/r3C6Etavs8Y2FgQMdZULQQTl9kOv42VwI3hv7ZqJqaqH7IyPRbrY7ytQ5fn3xTCKI34+Y8QPdhToI7yY6tOwCv1M+GOrRvmHa9NcD0MgtGGcNPEK9t/MpA+dP08KOrR8pef1QWRA7bySUJdj/ma8peBB+FD7NYllEVdXWujLtGUT6lFnLoIGFNJ6F6j5uGsubUCA7sIggRaoTc1nsucwYoamolXF9VntRRyIvilXCUVicLpYhLe3RCtSIbgLWBSPc9ryd/eKpBFiEuo3MBm470mfpLiCR4g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=I8J3Hy6dmzk/nC1EcrmBEv7DGAWCvb70N5DUqH46w2s=;
 b=cZgv/HL66EITf4Q+zVNYPa9PuPfyHqilJYhKWN9fbYsEIB1QttcuMJgi8MV7ar0bwrDkbPmi4eshn8TNO0iA9TojNrRdow/y2Q0cZ8jlHV6wQiXk8sVXmbAxiQf0FsFydmqL0NNCf0yRh0GVYBeCYl6ilsomUPBIsfFunxtKQRIqfqrnV8WydXodQUmwUFjtYCtOdYRklhuJloMp5rb9KcU0fdCcpIhQrjucR49UOiWDS9ltGu5520DzKowodgu2sMnzWoT5QJPa7RcSh6cHZdjKF82UA7H1iLP3aUIHWPB+4bS4whKoI58HqLCdlzxWgsok7W2dKHpmyb9waDPC8Q==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by MW4PR11MB6763.namprd11.prod.outlook.com (2603:10b6:303:20b::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 23:21:55 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Fri, 10 Feb 2023
 23:21:55 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "Jonathan.Cameron@Huawei.com" <Jonathan.Cameron@Huawei.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 12/20] cxl/port: Split endpoint and switch port probe
Thread-Topic: [PATCH v2 12/20] cxl/port: Split endpoint and switch port probe
Thread-Index: AQHZPS79LGHLeBJf20iIzu6wiQkD+q7I0o2A
Date: Fri, 10 Feb 2023 23:21:54 +0000
Message-ID: <763804dd536fcfc8b5d49fb1412de23852fa7a88.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|MW4PR11MB6763:EE_
x-ms-office365-filtering-correlation-id: f098dd69-7f5f-4dcc-fecf-08db0bbd9939
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: LzTtN9KgP4zZvRNPFNUsAdR/UccP+gBODkBWSXU0sVbFA+y0Mq4m++jUwpU6aymPZcY5+zFvK5sgM9JEcQDHPUcmt8vFzPZp1pM66b91FghyRrd/QYiSyJoA9eWzB3/m+EZsE0TuOWqgzEHkmXKGQmL/HD5GViGt6ySk0Sho6ROGqMGWoaaJZYj6pCLW8Bt6fg1GikO73CaIv8klSIc332LmXNab+90CjJfm0XAc4RkEFMf35wb6t9hjriq7eUQB9YOIs+qsujFKJMAfjP9U5bXvGKpAvdrLbRqJnPV6o860u2CyvLbWqcwawtVybXO+neogqQd/Vc3zB4lnNnQakqM3a2Y3GoP61TVwS13Cw2t09j8JMf9EszZO3aKIhgbYU0ULBTUDWn07sNoIG579ThVl+TNXQUvT+HSutWmSyke20w1ZCBww/OZNFYH3asTe85uiJ78qUnnJoiRWrYRbxBGM4WJ6rsu2vBi/Urc9GeXLwkNw//svYC/7o5YqQvXf3N33XfvBaxuQLDMAREV4kF8waXhi9dsJC6vS1zj+XWffY0mGePGxuatRvPNmy3RvhcA/52WUr1k1xPg8CKzBcr0NDb3Tx5wBh8HIgXgp5Crrnc6p3htj9jpN2/bSdIOIRH+bBVcZOZAoqcf4zM6flxAKeYN2B0bquq/7oBPnhAs6VNL/s90+NSH+v7mNI04IKceSWZTJ9jB3wr03QF+uqQTMd9vVOIcGm/4bhmpIn4Y=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(39860400002)(366004)(136003)(376002)(396003)(451199018)(110136005)(316002)(54906003)(91956017)(5660300002)(8676002)(76116006)(4326008)(66946007)(66556008)(66476007)(41300700001)(66446008)(64756008)(82960400001)(38070700005)(86362001)(36756003)(38100700002)(122000001)(6512007)(6506007)(26005)(71200400001)(6486002)(966005)(186003)(2616005)(2906002)(8936002)(478600001)(83380400001);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?QmZZelo5b0pMMkRFMDczWm40WGtHQy9qeVVYNlpVR21vNmhuUXNYRXVHWGpa?=
 =?utf-8?B?M0RtSE11L3dUK1FNR3JFUG45UjF0ODZQVDhFQjdMdlpiUnhzZ0NwVHdreE53?=
 =?utf-8?B?V2JrQ0xJaFpycC9kRDhXQjVWU3RNZzFOQWJUdXQrb3RNeEppTk9na0M2dHFi?=
 =?utf-8?B?RVdEZk02a0VjczM5ZDBiMWg5WWlJSFFJY3hXc1hDTFZVQm4rVnVoYlRJbnM1?=
 =?utf-8?B?Yzlka1dRQUp3cGd5YjZPb3NjT00wQk5wV2oyV1BSbTN4dUpQNlFSTjM4cytD?=
 =?utf-8?B?UUUzcS84QTlGbG5qaUxIZDZlTS8zV0FwK3BzV2NHeHRSZWJTdjBsVWV5MEFx?=
 =?utf-8?B?NGMrTVBUMDJITjFRVnMycXBpbzllZ3dBMjYrSXVrWkNvZUR0UjhubnpWQjRy?=
 =?utf-8?B?MmxENkRsRUVmTVF4REUzcHV5eTJURFRTbS9keE1SZmVjQktGWGRHdU5haDdN?=
 =?utf-8?B?dkVXM1RtN0xUMnFLU2hkaUFvWUVxdCs5b1F4MnNvUmV5R3BJckJQS2ozZHE2?=
 =?utf-8?B?WkdCSzQ0VDNEdnIvcndGQUVPWkVZK2pRRGxsUW9QSyt4a3FER0p0S3lmeE9Z?=
 =?utf-8?B?QTlBNnNhZ3J3OUdpMXNuSFhaZTBsWDZ1Z2QxbGwwb2hIcnI0WE9kNFh2OWda?=
 =?utf-8?B?NUkvSXowS29kWnZxenlRN2YxQzlneHgzSmZUY3o3dDU0M2pZR2pQcTRxYVA0?=
 =?utf-8?B?V0NQbjlNMy8yN2RSdWdacHpIck5hclVOVnl5V1lYUEpSNHRGQ1FScm04UHV0?=
 =?utf-8?B?K2E0UGNPUVpWcFEzUVd1OUd6UlpxTVZNQWZ0MUx1SGRlcE5xWTRjbnlLcTl5?=
 =?utf-8?B?OHZ2a2MwNGZ0WVRqNHJPQ1dsTEtnZUxqeW9CWG1mRHY3QWY4NlVPaUdWUnhn?=
 =?utf-8?B?MW1lc1RzeGMxNjFGUTl3ZS9lVHN2U0pGV3BWdnU3Q2d1NS9scWZVZTk3M1VD?=
 =?utf-8?B?UFoxMUpGT291OUJyYStCUnQyZlQzRk5GWkZsR3dBdHcxQVE5RTRUT1RPMXFR?=
 =?utf-8?B?Qmd5UXROMVJlMDRaZStjNDdIMmpiYUoyd2RqWnh3NkQyaHk1c2thR0RWRitG?=
 =?utf-8?B?NFJicFlmUXFHV1JzSk1GRG1IcW9XU1diQUxSaHJYUHoySE1PM0lPYTF6VDFQ?=
 =?utf-8?B?L09zaEVYWXBnUjZxS1Y0RCsyVFlYM2NmM1ZMelJvMXdrUlhteUJTUUI1YXYz?=
 =?utf-8?B?WTZZZVllWVMxODQ0dVlzNjI1cUdjNnFaM2xja2x5UDU5VjU0eUtYOG42OC94?=
 =?utf-8?B?WkRNMUtqMVRqbEF1TFBHMFYyd2IwZXBsNmdLaFBDY0tXN1JiSkxpb2dVek9x?=
 =?utf-8?B?cFQ0T1l0T21yeGk1VHBWbzJMZXM5VEs3THRQeDYvaUd5dGNiTW5oOGM5NEFH?=
 =?utf-8?B?QjFKUjVLV05OQ3pjVXN4TmhIUUxRc2JiRllVaTRhaFV3VDZ2dGltM0cwMUtR?=
 =?utf-8?B?OUE4YWg4TnA3VnREQklnK2MvazYyc0JVQlRycTFDcnVEanlvYXVPejB6MHd4?=
 =?utf-8?B?VGcyZG5Gdys3bzRUaEpKcENZblFjdUVzWHVlUHpEUG5McytUYWd6RDBNSEdZ?=
 =?utf-8?B?c3ptWFRSQk9wYzZQSnozYzZQdjJ1UHZwdVJQMGNqR3J6cmNrVTBUK2ZISmRz?=
 =?utf-8?B?TEwranJpUHYxMXhBejRFZ3kxdVg0Tm9yVk1WSHhhNEdjSm5rUjZqV2lsbmdw?=
 =?utf-8?B?T0t3dW5ONDVXK2thcXk1YkhBWkw2NlhzWVNTRkZZZUgxa3JrTlMrUUxGdWZw?=
 =?utf-8?B?cjV3dDJaWlQ5M3VxcWI0dlk1QWR1dEN4VW1sdUxkTndLZjR1QXlTaGFsNnYz?=
 =?utf-8?B?dFNJeXpVeWdkb29GWEx2bEYwdEtucW5LWGsrdm1Ed3k5RUlubmNkUmM5bnJU?=
 =?utf-8?B?UW9jc2xEWEY0TWRpYTQ5VHNsTnNUT1JiajhuZzQvajBsUEprTmhBUXNHYkF0?=
 =?utf-8?B?WVJDYTRod2JwSzFTWXVEQU9BSU9reW5CeEVmM1ZiL2l6a0EyWWdiY1MrWWFF?=
 =?utf-8?B?d0g2NHljbkp0VHZhWFhDSjZ5U040d1hudjBKbE43eUxWUGpmVXgrWG1FSk1Z?=
 =?utf-8?B?aVdXRjB4UlV1MWdSWU1EcDRBSjJ2dmJQdHhIWnlEZCtlYVAyY0gvVG9iRFVo?=
 =?utf-8?B?NXkvQ1l3QlVGY2VGQjh0aUVDUUpkc1orZWxoZkkzQStHSkNuZTdzTWZkd0J2?=
 =?utf-8?B?N0E9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <03B54753298409439F9296B95729E008@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: f098dd69-7f5f-4dcc-fecf-08db0bbd9939
X-MS-Exchange-CrossTenant-originalarrivaltime: 10 Feb 2023 23:21:55.0027
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: egDhkChAmmsWvKPV49YiLB+VnfYIqNQ7VufDlCf0NcxgfNdX/Poi+ZeNWUREl3LsUyhXLBRtzKi2oCmr+Fkktgg2Lcj/XAfnvhnd1KM8FO0=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR11MB6763
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
Sm9uYXRoYW4gcG9pbnRzIG91dCB0aGF0IHRoZSBzaGFyZWQgY29kZSBiZXR3ZWVuIHRoZSBzd2l0
Y2ggYW5kIGVuZHBvaW50Cj4gY2FzZSBpcyBzbWFsbC4gQmVmb3JlIGFkZGluZyBhbm90aGVyIGlz
X2N4bF9lbmRwb2ludCgpIGNvbmRpdGlvbmFsLAo+IGp1c3Qgc3BsaXQgdGhlIHR3byBjYXNlcy4K
PiAKPiBSYXRoZXIgdGhhbiBkdXBsaWNhdGUgdGhlICJDb3VsZG4ndCBlbnVtZXJhdGUgZGVjb2Rl
cnMiIGVycm9yIG1lc3NhZ2UKPiB0YWtlIHRoZSBvcHBvcnR1bml0eSB0byBpbXByb3ZlIHRoZSBl
cnJvciBtZXNzYWdlcyBpbgo+IGRldm1fY3hsX2VudW1lcmF0ZV9kZWNvZGVycygpLgo+IAo+IFJl
cG9ydGVkLWJ5OiBKb25hdGhhbiBDYW1lcm9uIDxKb25hdGhhbi5DYW1lcm9uQEh1YXdlaS5jb20+
Cj4gTGluazogaHR0cDovL2xvcmUua2VybmVsLm9yZy9yLzIwMjMwMjA4MTcwNzI0LjAwMDA2N2Vj
QEh1YXdlaS5jb20KPiBTaWduZWQtb2ZmLWJ5OiBEYW4gV2lsbGlhbXMgPGRhbi5qLndpbGxpYW1z
QGludGVsLmNvbT4KPiAtLS0KPiDCoGRyaXZlcnMvY3hsL2NvcmUvaGRtLmMgfMKgwqAgMTEgKysr
KysrLS0KPiDCoGRyaXZlcnMvY3hsL3BvcnQuY8KgwqDCoMKgIHzCoMKgIDY5ICsrKysrKysrKysr
KysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLQo+IMKgMiBmaWxlcyBjaGFuZ2Vk
LCA0NyBpbnNlcnRpb25zKCspLCAzMyBkZWxldGlvbnMoLSkKCkxvb2tzIGdvb2QsCgpSZXZpZXdl
ZC1ieTogVmlzaGFsIFZlcm1hIDx2aXNoYWwubC52ZXJtYUBpbnRlbC5jb20+Cgo+IAo+IGRpZmYg
LS1naXQgYS9kcml2ZXJzL2N4bC9jb3JlL2hkbS5jIGIvZHJpdmVycy9jeGwvY29yZS9oZG0uYwo+
IGluZGV4IGRjYzE2ZDdjYjhmMy4uYTA4OTFjMzQ2NGYxIDEwMDY0NAo+IC0tLSBhL2RyaXZlcnMv
Y3hsL2NvcmUvaGRtLmMKPiArKysgYi9kcml2ZXJzL2N4bC9jb3JlL2hkbS5jCj4gQEAgLTgyNiw3
ICs4MjYsOCBAQCBpbnQgZGV2bV9jeGxfZW51bWVyYXRlX2RlY29kZXJzKHN0cnVjdCBjeGxfaGRt
ICpjeGxoZG0pCj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgY3hsZWQgPSBjeGxfZW5kcG9pbnRfZGVjb2Rlcl9hbGxvYyhwb3J0KTsKPiDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBpZiAoSVNfRVJSKGN4bGVkKSkg
ewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqBkZXZfd2FybigmcG9ydC0+ZGV2LAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAg
IkZhaWxlZCB0byBhbGxvY2F0ZSB0aGUgZGVjb2RlclxuIik7Cj4gK8KgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoCAiRmFpbGVkIHRvIGFsbG9jYXRlIGRlY29kZXIlZC4lZFxuIiwKPiArwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgIHBvcnQtPmlkLCBpKTsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIFBUUl9FUlIoY3hsZWQpOwo+
IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH0KPiDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxkID0gJmN4bGVk
LT5jeGxkOwo+IEBAIC04MzYsNyArODM3LDggQEAgaW50IGRldm1fY3hsX2VudW1lcmF0ZV9kZWNv
ZGVycyhzdHJ1Y3QgY3hsX2hkbSAqY3hsaGRtKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4bHNkID0gY3hsX3N3aXRjaF9kZWNvZGVyX2FsbG9jKHBv
cnQsIHRhcmdldF9jb3VudCk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgaWYgKElTX0VSUihjeGxzZCkpIHsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X3dhcm4oJnBvcnQt
PmRldiwKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICJGYWlsZWQgdG8gYWxsb2NhdGUgdGhlIGRl
Y29kZXJcbiIpOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAgIkZhaWxlZCB0byBhbGxvY2F0ZSBk
ZWNvZGVyJWQuJWRcbiIsCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCBwb3J0LT5pZCwgaSk7Cj4g
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoHJldHVybiBQVFJfRVJSKGN4bHNkKTsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqB9Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgY3hsZCA9ICZjeGxzZC0+Y3hsZDsKPiBAQCAtODQ0LDEzICs4NDYs
MTYgQEAgaW50IGRldm1fY3hsX2VudW1lcmF0ZV9kZWNvZGVycyhzdHJ1Y3QgY3hsX2hkbSAqY3hs
aGRtKQo+IMKgCj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByYyA9IGluaXRfaGRt
X2RlY29kZXIocG9ydCwgY3hsZCwgdGFyZ2V0X21hcCwgaGRtLCBpLCAmZHBhX2Jhc2UpOwo+IMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaWYgKHJjKSB7Cj4gK8KgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXZfd2FybigmcG9ydC0+ZGV2LAo+ICvC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoCAiRmFpbGVkIHRvIGluaXRpYWxpemUgZGVjb2RlciVkLiVkXG4iLAo+ICvCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCBwb3J0
LT5pZCwgaSk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgcHV0X2RldmljZSgmY3hsZC0+ZGV2KTsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqB9Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByYyA9IGFkZF9oZG1f
ZGVjb2Rlcihwb3J0LCBjeGxkLCB0YXJnZXRfbWFwKTsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoGlmIChyYykgewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoGRldl93YXJuKCZwb3J0LT5kZXYsCj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICJGYWlsZWQgdG8gYWRk
IGRlY29kZXIgdG8gcG9ydFxuIik7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICJGYWlsZWQgdG8gYWRkIGRlY29kZXIlZC4l
ZFxuIiwgcG9ydC0+aWQsIGkpOwo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoHJldHVybiByYzsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oH0KPiDCoMKgwqDCoMKgwqDCoMKgfQo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2N4bC9wb3J0LmMg
Yi9kcml2ZXJzL2N4bC9wb3J0LmMKPiBpbmRleCA1NDUzNzcxYmYzMzAuLmE4ZDQ2YTY3YjQ1ZSAx
MDA2NDQKPiAtLS0gYS9kcml2ZXJzL2N4bC9wb3J0LmMKPiArKysgYi9kcml2ZXJzL2N4bC9wb3J0
LmMKPiBAQCAtMzAsNTUgKzMwLDY0IEBAIHN0YXRpYyB2b2lkIHNjaGVkdWxlX2RldGFjaCh2b2lk
ICpjeGxtZCkKPiDCoMKgwqDCoMKgwqDCoMKgc2NoZWR1bGVfY3hsX21lbWRldl9kZXRhY2goY3hs
bWQpOwo+IMKgfQo+IMKgCj4gLXN0YXRpYyBpbnQgY3hsX3BvcnRfcHJvYmUoc3RydWN0IGRldmlj
ZSAqZGV2KQo+ICtzdGF0aWMgaW50IGN4bF9zd2l0Y2hfcG9ydF9wcm9iZShzdHJ1Y3QgY3hsX3Bv
cnQgKnBvcnQpCj4gwqB7Cj4gLcKgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9wb3J0ICpwb3J0ID0g
dG9fY3hsX3BvcnQoZGV2KTsKPiDCoMKgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9oZG0gKmN4bGhk
bTsKPiDCoMKgwqDCoMKgwqDCoMKgaW50IHJjOwo+IMKgCj4gK8KgwqDCoMKgwqDCoMKgcmMgPSBk
ZXZtX2N4bF9wb3J0X2VudW1lcmF0ZV9kcG9ydHMocG9ydCk7Cj4gK8KgwqDCoMKgwqDCoMKgaWYg
KHJjIDwgMCkKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIHJjOwo+IMKg
Cj4gLcKgwqDCoMKgwqDCoMKgaWYgKCFpc19jeGxfZW5kcG9pbnQocG9ydCkpIHsKPiAtwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmMgPSBkZXZtX2N4bF9wb3J0X2VudW1lcmF0ZV9kcG9y
dHMocG9ydCk7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChyYyA8IDApCj4g
LcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7
Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChyYyA9PSAxKQo+IC3CoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIGRldm1fY3hsX2Fk
ZF9wYXNzdGhyb3VnaF9kZWNvZGVyKHBvcnQpOwo+IC3CoMKgwqDCoMKgwqDCoH0KPiArwqDCoMKg
wqDCoMKgwqBpZiAocmMgPT0gMSkKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0
dXJuIGRldm1fY3hsX2FkZF9wYXNzdGhyb3VnaF9kZWNvZGVyKHBvcnQpOwo+IMKgCj4gwqDCoMKg
wqDCoMKgwqDCoGN4bGhkbSA9IGRldm1fY3hsX3NldHVwX2hkbShwb3J0KTsKPiDCoMKgwqDCoMKg
wqDCoMKgaWYgKElTX0VSUihjeGxoZG0pKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgcmV0dXJuIFBUUl9FUlIoY3hsaGRtKTsKPiDCoAo+IC3CoMKgwqDCoMKgwqDCoGlmIChpc19j
eGxfZW5kcG9pbnQocG9ydCkpIHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgc3Ry
dWN0IGN4bF9tZW1kZXYgKmN4bG1kID0gdG9fY3hsX21lbWRldihwb3J0LT51cG9ydCk7Cj4gLcKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfZGV2X3N0YXRlICpjeGxkcyA9
IGN4bG1kLT5jeGxkczsKPiArwqDCoMKgwqDCoMKgwqByZXR1cm4gZGV2bV9jeGxfZW51bWVyYXRl
X2RlY29kZXJzKGN4bGhkbSk7Cj4gK30KPiDCoAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqAvKiBDYWNoZSB0aGUgZGF0YSBlYXJseSB0byBlbnN1cmUgaXNfdmlzaWJsZSgpIHdvcmtz
ICovCj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJlYWRfY2RhdF9kYXRhKHBvcnQp
Owo+ICtzdGF0aWMgaW50IGN4bF9lbmRwb2ludF9wb3J0X3Byb2JlKHN0cnVjdCBjeGxfcG9ydCAq
cG9ydCkKPiArewo+ICvCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfbWVtZGV2ICpjeGxtZCA9IHRv
X2N4bF9tZW1kZXYocG9ydC0+dXBvcnQpOwo+ICvCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfZGV2
X3N0YXRlICpjeGxkcyA9IGN4bG1kLT5jeGxkczsKPiArwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgY3hs
X2hkbSAqY3hsaGRtOwo+ICvCoMKgwqDCoMKgwqDCoGludCByYzsKPiArCj4gK8KgwqDCoMKgwqDC
oMKgY3hsaGRtID0gZGV2bV9jeGxfc2V0dXBfaGRtKHBvcnQpOwo+ICvCoMKgwqDCoMKgwqDCoGlm
IChJU19FUlIoY3hsaGRtKSkKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJu
IFBUUl9FUlIoY3hsaGRtKTsKPiDCoAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBn
ZXRfZGV2aWNlKCZjeGxtZC0+ZGV2KTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
cmMgPSBkZXZtX2FkZF9hY3Rpb25fb3JfcmVzZXQoZGV2LCBzY2hlZHVsZV9kZXRhY2gsIGN4bG1k
KTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaWYgKHJjKQo+IC3CoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIHJjOwo+ICvCoMKgwqDC
oMKgwqDCoC8qIENhY2hlIHRoZSBkYXRhIGVhcmx5IHRvIGVuc3VyZSBpc192aXNpYmxlKCkgd29y
a3MgKi8KPiArwqDCoMKgwqDCoMKgwqByZWFkX2NkYXRfZGF0YShwb3J0KTsKPiDCoAo+IC3CoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByYyA9IGN4bF9oZG1fZGVjb2RlX2luaXQoY3hsZHMs
IGN4bGhkbSk7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChyYykKPiAtwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJldHVybiByYzsKPiAr
wqDCoMKgwqDCoMKgwqBnZXRfZGV2aWNlKCZjeGxtZC0+ZGV2KTsKPiArwqDCoMKgwqDCoMKgwqBy
YyA9IGRldm1fYWRkX2FjdGlvbl9vcl9yZXNldCgmcG9ydC0+ZGV2LCBzY2hlZHVsZV9kZXRhY2gs
IGN4bG1kKTsKPiArwqDCoMKgwqDCoMKgwqBpZiAocmMpCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoHJldHVybiByYzsKPiDCoAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqByYyA9IGN4bF9hd2FpdF9tZWRpYV9yZWFkeShjeGxkcyk7Cj4gLcKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoGlmIChyYykgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgZGV2X2VycihkZXYsICJNZWRpYSBub3QgYWN0aXZlICglZClcbiIsIHJj
KTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJldHVy
biByYzsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgfQo+IC3CoMKgwqDCoMKgwqDC
oH0KPiArwqDCoMKgwqDCoMKgwqByYyA9IGN4bF9oZG1fZGVjb2RlX2luaXQoY3hsZHMsIGN4bGhk
bSk7Cj4gK8KgwqDCoMKgwqDCoMKgaWYgKHJjKQo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqByZXR1cm4gcmM7Cj4gwqAKPiAtwqDCoMKgwqDCoMKgwqByYyA9IGRldm1fY3hsX2VudW1l
cmF0ZV9kZWNvZGVycyhjeGxoZG0pOwo+ICvCoMKgwqDCoMKgwqDCoHJjID0gY3hsX2F3YWl0X21l
ZGlhX3JlYWR5KGN4bGRzKTsKPiDCoMKgwqDCoMKgwqDCoMKgaWYgKHJjKSB7Cj4gLcKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoGRldl9lcnIoZGV2LCAiQ291bGRuJ3QgZW51bWVyYXRlIGRl
Y29kZXJzICglZClcbiIsIHJjKTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2
X2VycigmcG9ydC0+ZGV2LCAiTWVkaWEgbm90IGFjdGl2ZSAoJWQpXG4iLCByYyk7Cj4gwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7Cj4gwqDCoMKgwqDCoMKgwqDCoH0K
PiDCoAo+IC3CoMKgwqDCoMKgwqDCoHJldHVybiAwOwo+ICvCoMKgwqDCoMKgwqDCoHJldHVybiBk
ZXZtX2N4bF9lbnVtZXJhdGVfZGVjb2RlcnMoY3hsaGRtKTsKPiArfQo+ICsKPiArc3RhdGljIGlu
dCBjeGxfcG9ydF9wcm9iZShzdHJ1Y3QgZGV2aWNlICpkZXYpCj4gK3sKPiArwqDCoMKgwqDCoMKg
wqBzdHJ1Y3QgY3hsX3BvcnQgKnBvcnQgPSB0b19jeGxfcG9ydChkZXYpOwo+ICsKPiArwqDCoMKg
wqDCoMKgwqBpZiAoaXNfY3hsX2VuZHBvaW50KHBvcnQpKQo+ICvCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqByZXR1cm4gY3hsX2VuZHBvaW50X3BvcnRfcHJvYmUocG9ydCk7Cj4gK8KgwqDC
oMKgwqDCoMKgcmV0dXJuIGN4bF9zd2l0Y2hfcG9ydF9wcm9iZShwb3J0KTsKPiDCoH0KPiDCoAo+
IMKgc3RhdGljIHNzaXplX3QgQ0RBVF9yZWFkKHN0cnVjdCBmaWxlICpmaWxwLCBzdHJ1Y3Qga29i
amVjdCAqa29iaiwKPiAKCg==

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 841A5C636D7
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 23:37:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229653AbjBJXhJ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 18:37:09 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39680 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230004AbjBJXgt (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 18:36:49 -0500
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AEC85840CC;
        Fri, 10 Feb 2023 15:36:00 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676072160; x=1707608160;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=wnaszuPI4ENX6eV7n2PLFQK40JM+W5Noj8GOoSVQCjk=;
  b=dWdVHWoaL48ZNKmzzB4tKVw5nqe9lmhi8OcNLS2NS4V48zdUGpExMzSf
   T4pMbR+B7zLRHWEyab8U694a6zP37t8+aAydwuTHO5kQTuF6l49M166oY
   p/rDeU+qdTIapqic9zdnPji6yUGTTWWC1thxEosK7wn4k6ByINcEOUNEK
   xeIxQHLY8voU4tF9Vv+3dhSEd21XxqH8L07s6dYoORQLkY8/jtR4JBIwT
   DXYk+sGqUwBNHWr5T56hXukO8Gs5x3px3YnbG3YPvxM+CYVNSPwO9e7wd
   cW2mYlaBJWnZc1l45YXloqePDucm9Dq9SIKjDVGAyWDjwU4D4TncimYFe
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="395165333"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="395165333"
Received: from orsmga003.jf.intel.com ([10.7.209.27])
  by orsmga105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 15:34:50 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="618049765"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="618049765"
Received: from orsmsx602.amr.corp.intel.com ([10.22.229.15])
  by orsmga003.jf.intel.com with ESMTP; 10 Feb 2023 15:34:50 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX602.amr.corp.intel.com (10.22.229.15) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:34:49 -0800
Received: from orsmsx601.amr.corp.intel.com (10.22.229.14) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:34:49 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 15:34:49 -0800
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (104.47.57.44) by
 edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 15:34:38 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=MXAdpWxy509CD2P2fZbB+qDkGymuB0V2utCoSM4fr9kCAY6vbDy1fQJTE4wMW1omI6RpaiickMi91WqtZNJdyIECk37KzYP4EagU3Bu5RfQ336Eg6wVHqlwifcSVBQjEnX26iKEc/pdaAaNdwPjumTzRRcX4OQ10mUM66NybMGRtsWgLr9DzBC+n8pX1o9bcJoUY3LmAsNphdbFl+8ACsS0BmhfIzt2qUB6wMxnXNPJMtDxuw/fOsP8ND5yAfMYKHvEd75jRI6FvVNQEO0ojHAVycte3g9HN6VrumjN+42SDllWpKeRg+GZG+kMBm7jO4cq0hGvlF1t0u8H/Qm4NMA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=bEhCgic0uzvVqDmNp0g1Og9BKbkwBz4OjbLERh5mB/E=;
 b=VoQd8XevjNcepoDm9vBdGEtd9dOy45DctLR46/UPudEH2mGcCSPtSRwb7k40U42C/2TrqX0FtZXow9N7rzAeVM+QFbZeCT+TJuc0LEHI6JhRFdWcq3sXcHD9XaKOFpTZlBnmRk9Ul/pyXhN2x1GINREuIezVdAaBS0B7dHw6/Z1dXOmg5LbGrQkSgvU8eCNh2uhoH6xFleElLwgqta9o4jjWBIx7Pfd6Yq+bHzhcy6TSrEuGsT41CgK5Oq+GzeddEERRodB3p5rqvpSMA5AW/ivVYdw/uLoWGMAmcCtETg8kjT0ubxiaXv2nWy4nrBEMxVTecwvKijrUEzkibebyBQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by BL3PR11MB6434.namprd11.prod.outlook.com (2603:10b6:208:3ba::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Fri, 10 Feb
 2023 23:34:35 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6851:3db2:1166:dda6]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6851:3db2:1166:dda6%9]) with mapi id 15.20.6086.019; Fri, 10 Feb 2023
 23:34:35 +0000
Date: Fri, 10 Feb 2023 15:34:30 -0800
From: Ira Weiny <ira.weiny@intel.com>
To: Dan Williams <dan.j.williams@intel.com>,
        <linux-cxl@vger.kernel.org>
CC: Vishal Verma <vishal.l.verma@intel.com>,
        Fan Ni <fan.ni@samsung.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 04/20] cxl/region: Support empty uuids for non-pmem
 regions
Message-ID: <63e6d486dae75_1440152949e@iweiny-mobl.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601994558.1924368.12612811533724694444.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <167601994558.1924368.12612811533724694444.stgit@dwillia2-xfh.jf.intel.com>
X-ClientProxiedBy: BYAPR07CA0094.namprd07.prod.outlook.com
 (2603:10b6:a03:12b::35) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|BL3PR11MB6434:EE_
X-MS-Office365-Filtering-Correlation-Id: c717942b-da56-49c5-5f82-08db0bbf5e31
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: +iZjisD7z5iokWMPJ4XMyL7s0heNsTq8l830Schs8nzTDjNxTRjKgI3wp8yrtOXgwvSCawGGj+exTAY89ZYS7NS74MjSe4MjicKZ2g47Ybn75fkGUy17vwXyfI09ZpP07nf41hP7vsxAUU4hugAWG19RPXk512h9nOtJhSdRMtJdKea7NOKQM5swC5ZgicncboPwT8J8R09Iy6rbFPDOlrr3+UCgxpwPAcSDcueK43aR1/cwZ+BudqEfwxe67ryRWGfBo7WaXyjW8S1V4gz3n9iLZ7SlV2U/JMxXJ8+yj0GgjUsHo3T/5djJzHSXbZHrWzxXMANTeaYfGct2R+XWSEZKEpirTbeOPhnPll3wwDdbyh36ughZ1Nx4lKgSmTPQsyuXVrJlG8UrrGDMKq5g3oSerlvY/dQffiU74HfV+m4e44FCohyelSyu6QwcdvQUEhZwKj4kVaBZGkcdMJTdRvfWO+sKFFBN4A4Bz3Ts3+xH2q7JXBn2QooIO9tPAM4zokf88RAVSs61N8qa1q/NlQXgaXuGJBTu/S/eEkZ7UMNGCADJ9zH1N00/cZxcogblcfjzRkYr4VPq3EJ1+J4XCEZejGa9ocrjkpKjQiOnbPWny/Pzy/ZSDk77NTh453KxP7dTaJlB7bKL66MzBNQXeF0S04wTwkMOWGKj3kEqi40=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(366004)(396003)(39860400002)(136003)(376002)(346002)(451199018)(6486002)(966005)(86362001)(478600001)(6666004)(9686003)(4326008)(66946007)(6512007)(83380400001)(44832011)(186003)(6506007)(26005)(66556008)(54906003)(316002)(82960400001)(41300700001)(66476007)(8676002)(2906002)(5660300002)(38100700002)(8936002);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?7sHwpviR/XTufoT86EUY/qeCvo82VT8FnWGIV5Z+prPf034hI08hQetLJLhq?=
 =?us-ascii?Q?BMQyeLfLPhy1icnQVhkWSxPtM50tHGwvok8S+hiQCSVA9eQSSmmsOpk6UVY9?=
 =?us-ascii?Q?aIuhq9NXt1f00+hY6+jrecuJqEB3pB4q0EEp0zOarVf629WkEJuNpO9uBqWT?=
 =?us-ascii?Q?kXpcvESCBfM3opVIrJF0mce189xwkrU5yx1NsqUvHD5T6rHN3zJE/3Bhc9K7?=
 =?us-ascii?Q?MfV/kbZ3jDReCxDpShD8XNGgBXFCh0xIVGy3fU6hZC0gigFGdRr/k7ifVwc6?=
 =?us-ascii?Q?g5KRNHgfdL85O57Eyngr0H75q2piihysCTsc4i33rMf4L346e+dj9wx2fGmS?=
 =?us-ascii?Q?Vwd/NtIRIJuAlU177i1ujTsJ0zc55wmERknzwy3lNeIIQzxeDtyZ6aaYD/L4?=
 =?us-ascii?Q?zv8IxoHHF6KK73cMy68FqiX6CMsydRlo8yPJKHDjJiagJy3hrLz5vNNZpapa?=
 =?us-ascii?Q?BvTFhN2prdsUbhevqKq9SJ+d1zKT/wzvc7T2+HxXpmV1EHvHukmy6eRdhcy7?=
 =?us-ascii?Q?5OdPH7Rf5Vd75JXRifcpzH9niueZpAxB/sHK5VFww4KdPEv+0sokRuIZIO2e?=
 =?us-ascii?Q?AYORAgDGJkWQCx/SwFGdHLMyYN30pEPQBFqmRlTbbrcz5lELEkzO0nPfHHx7?=
 =?us-ascii?Q?KtoBTAO7OCbhsoojkLQDjs+H7PtK27JaVFm4YzhXlMz3aWS4AvfyXVmTlE5t?=
 =?us-ascii?Q?My8XXLCPu5AIQEl5WJXf3e/gEFQRhhhKU4Y5lN7HdhIYKaIFwEaTP7dQLiGf?=
 =?us-ascii?Q?2icY7WwtMjmYf1Ten9tJ4KfhciGoNcITb9mwTFR2jfCqvNFRkTNIjpYuGf61?=
 =?us-ascii?Q?z6Vk4S4k4w+DY32ScYJjoyWmKrVoxfMeOfPrlvsKUMtPc+/RITGm1ckEC5sU?=
 =?us-ascii?Q?eawgy6ak/f6XDwrMf3hzDsWJg8imc05Sy3MTMPPYvaKATg4iL82AHvFoSHo7?=
 =?us-ascii?Q?EhrJdZnOAf1xHBjvq/0ERgDJhaoLphen/7Atc5a6bD/x6jXSkik0nU6Z6VUT?=
 =?us-ascii?Q?16w69DaWaPcqJaW5yMwiVXG5oc/zKp9peoCxTpMKxSGGzv9FTCormc2jJGUu?=
 =?us-ascii?Q?uH1kOucoJ+4xVUQRjj0AXwjl0lRtjyZLK8xAp4AsltqLWy47WzjvPC3n3PiC?=
 =?us-ascii?Q?A1B4LHHixe0Um4uYRHas2NQuT/0T6hSjn7eBwchJ542P5FJhKM4/8eNKr/D4?=
 =?us-ascii?Q?c2BTkCnrqVzMrim3FObpnYydXaxihtLzZgdAw1xXTG7kh+ebUcVw7LFAy7Us?=
 =?us-ascii?Q?vE7jZDUghG8KL1Erp/XNdECZqVBuJ8YSOsNBx7+Vdq8j0UfxlXC6/g5xzR5R?=
 =?us-ascii?Q?Ed9SHhOglO8MNUBSA4iijV3cQLGhCBl1xAzEvR9ltG7wdfoJZZJDj6DICfod?=
 =?us-ascii?Q?PGzCd4tE+VQ4XCP1edxyt3eym5HjE/UcyDzS5VwXzJveOEQcK7+740bDre8a?=
 =?us-ascii?Q?Wvv2z1Z3gzXaPz3QsUbuZdLj9cHOqWBfGI815ROzXQurIeY2W4sJqUsqJ4dL?=
 =?us-ascii?Q?s9MqEJMNZQIjWxzx0o3Hv66riOn3lbSQoon3LfDECJwCCH4pY/imZye/coFY?=
 =?us-ascii?Q?wr8FOtMbEnDKzVFxGd1EpGh2gbincEzKBI8OhWKP?=
X-MS-Exchange-CrossTenant-Network-Message-Id: c717942b-da56-49c5-5f82-08db0bbf5e31
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 23:34:35.2197
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: kjDgsM2xWzrfmwXC3/eF7D2BlaR9acO1gKP1zP1W4dcRFlqCDoClKn91W0uwgmLCe9ZH2CvLtp+aUztmN0uD0g==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL3PR11MB6434
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Dan Williams wrote:
> Shipping versions of the cxl-cli utility expect all regions to have a
> 'uuid' attribute. In preparation for 'ram' regions, update the 'uuid'
> attribute to return an empty string which satisfies the current
> expectations of 'cxl list -R'. Otherwise, 'cxl list -R' fails in the
> presence of regions with the 'uuid' attribute missing. Force the
> attribute to be read-only as there is no facility or expectation for a
> 'ram' region to recall its uuid from one boot to the next.
> 
> Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>

Reviewed-by: Ira Weiny <ira.weiny@intel.com>

> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564536587.847146.12703125206459604597.stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  Documentation/ABI/testing/sysfs-bus-cxl |    3 ++-
>  drivers/cxl/core/region.c               |   11 +++++++++--
>  2 files changed, 11 insertions(+), 3 deletions(-)
> 
> diff --git a/Documentation/ABI/testing/sysfs-bus-cxl b/Documentation/ABI/testing/sysfs-bus-cxl
> index 058b0c45001f..4c4e1cbb1169 100644
> --- a/Documentation/ABI/testing/sysfs-bus-cxl
> +++ b/Documentation/ABI/testing/sysfs-bus-cxl
> @@ -317,7 +317,8 @@ Contact:	linux-cxl@vger.kernel.org
>  Description:
>  		(RW) Write a unique identifier for the region. This field must
>  		be set for persistent regions and it must not conflict with the
> -		UUID of another region.
> +		UUID of another region. For volatile ram regions this
> +		attribute is a read-only empty string.
>  
>  
>  What:		/sys/bus/cxl/devices/regionZ/interleave_granularity
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 17d2d0c12725..0fc80478ff6b 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -45,7 +45,10 @@ static ssize_t uuid_show(struct device *dev, struct device_attribute *attr,
>  	rc = down_read_interruptible(&cxl_region_rwsem);
>  	if (rc)
>  		return rc;
> -	rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
> +	if (cxlr->mode != CXL_DECODER_PMEM)
> +		rc = sysfs_emit(buf, "\n");
> +	else
> +		rc = sysfs_emit(buf, "%pUb\n", &p->uuid);
>  	up_read(&cxl_region_rwsem);
>  
>  	return rc;
> @@ -300,8 +303,12 @@ static umode_t cxl_region_visible(struct kobject *kobj, struct attribute *a,
>  	struct device *dev = kobj_to_dev(kobj);
>  	struct cxl_region *cxlr = to_cxl_region(dev);
>  
> +	/*
> +	 * Support tooling that expects to find a 'uuid' attribute for all
> +	 * regions regardless of mode.
> +	 */
>  	if (a == &dev_attr_uuid.attr && cxlr->mode != CXL_DECODER_PMEM)
> -		return 0;
> +		return 0444;
>  	return a->mode;
>  }
>  
> 
> 



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E46E5C05027
	for <linux-acpi@archiver.kernel.org>; Fri, 10 Feb 2023 23:46:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229921AbjBJXqk (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 18:46:40 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:56734 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229956AbjBJXqg (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 18:46:36 -0500
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7734C42DF1;
        Fri, 10 Feb 2023 15:46:30 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676072790; x=1707608790;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=GkT4UL+Ywni35EQihPKltiRWSEJJpeJnGnxDgGqEt3w=;
  b=N3fvt0x56uLUS380FnEE2XNdiADYa79NrfzZKKjXUG0yoqaSZTdsJpvl
   fplMAq8+qorKDY+rNd9V2rhWLO11U6FFE8ldvRDOPQ2fEL16eUPLbI+BZ
   bLVohy/EaJKHtEBoEH9VIlTds3yf9v6zLpbwiupnRa3v6xwWqHaIyaDVf
   Bj3xOURQWFaEP+d9SwAzqfYUvFPGguNpC0tf4ehyo75LZnzwUfZfUzegi
   itC5LKLPZfmb3niG50mF//jArxG++QqBdNqFSuKLEl9a441CkiNQY2RBS
   0fCLnQJhqoFdMFxuBYGIc6Shx7Ne1hgKn17PwUSFgfUML3smTzNeCsm/N
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310188219"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="310188219"
Received: from orsmga008.jf.intel.com ([10.7.209.65])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 15:46:29 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="698579739"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="698579739"
Received: from orsmsx601.amr.corp.intel.com ([10.22.229.14])
  by orsmga008.jf.intel.com with ESMTP; 10 Feb 2023 15:46:29 -0800
Received: from orsmsx611.amr.corp.intel.com (10.22.229.24) by
 ORSMSX601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:46:29 -0800
Received: from orsmsx611.amr.corp.intel.com (10.22.229.24) by
 ORSMSX611.amr.corp.intel.com (10.22.229.24) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 15:46:28 -0800
Received: from ORSEDG602.ED.cps.intel.com (10.7.248.7) by
 orsmsx611.amr.corp.intel.com (10.22.229.24) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 15:46:28 -0800
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (104.47.57.42) by
 edgegateway.intel.com (134.134.137.103) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 15:46:28 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=B1sGz3r8PTnNxRuB0tuQEXLFy15U3nlnEJVu90j2ecHukDxEWRWabKq8AAGVlJnEdxtflGINATtiSARbUtfWbNZScEtFwlUH3Sdawx89aoI9CMsGDfpTQRNwyb0ij2xIMtN8I+dcyzhmvcU5Z7bivNvmTRYTu1M/h7j7cE3K3x5goIVJ8V9OuKwDZnkFOXbiOXWUL5/92EBNCqM4cebVrWb7Kb8zOf8pDc5tgXuMNkhvpjTmhjot2t7Ggt8+i1KXToS79B0rJfZ31RfaUJtbDlr44hghsUt/yYNxU3lz+Lc6s3thOgtR4hgYJGrDYgZf5IA4uP12Tf0UNR781j0A4g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=J2ZubGgSCOAcYJbNHkJIdWbn7mj22W8EfZFXLTbgMoQ=;
 b=HDLym2hBrOzRpGmfMbboLvN8+kOs8adkUjmHKNFfIv0AKet3qmsbDaYeqUgy/l94m/RUIzbJVRRhYcUrZTo6CFHguxMHZV46sjbaWZlg7/F1uHXwRdZJEsAQIZQd4J1ngX23XPRTLpTWzbJZhmbLajfW4vY3GvmXc/O3WoCe7lgtRqC21UMNg+Qphx28U1p6WYu7Hz19o098dIoQ1MH/G9X5T2dHqNfQ0SVzKADsiAKge2sktUXNmf5CTrrBlAcef5lCZ0uVqj/XdqS5LXwHUC5fQX9erSMLCe9qJ7jYAnelE2f+jJoeI7s/SOh14jJwTNJj80Z0O0T74QLYS3o6CA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by BL3PR11MB6409.namprd11.prod.outlook.com (2603:10b6:208:3b8::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.22; Fri, 10 Feb
 2023 23:46:25 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6851:3db2:1166:dda6]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6851:3db2:1166:dda6%9]) with mapi id 15.20.6086.019; Fri, 10 Feb 2023
 23:46:19 +0000
Date: Fri, 10 Feb 2023 15:46:16 -0800
From: Ira Weiny <ira.weiny@intel.com>
To: Dan Williams <dan.j.williams@intel.com>,
        <linux-cxl@vger.kernel.org>
CC: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 08/20] cxl/region: Cleanup target list on attach error
Message-ID: <63e6d7481ed70_1440152941b@iweiny-mobl.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com>
X-ClientProxiedBy: BYAPR07CA0070.namprd07.prod.outlook.com
 (2603:10b6:a03:60::47) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|BL3PR11MB6409:EE_
X-MS-Office365-Filtering-Correlation-Id: 79cbad4c-050a-4700-46c2-08db0bc10207
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: MzJ9dnuelWsbSI1OlsitFrDECN+gKSx4FddAmDk3u5NPaAo/MGdZt0XrJMDVKssxIXSS46Vdj+eZyKeyfvqD6VZl41V1suWiKw8V3YxX74yBucqA+eIvD4q3xzUXYwd75mA80RIVE+CuJ2gX5Z1PdrtipWn9JzwGj+r4bZApKg3ryqDl82IifqtYtqTYTv5/ZhigDWDs+VOW1SfQ2K9t0vNYDPTlmuE9530B8AfManZkjJDX5XB30/z2Yyy/zJKhQqunZHmmrqjp7WkiQux+ifMUy8qtEtemtREer1Blxp+fCYFG0CmAmuRn8K+ylHqfPba/BcP/LJ0MTwmCPsn6sfjjpcdV2GX/Bygyw5HSabnUKcfgZGj38CS0NGFXXpuHAKDRAJqcKA28tp14Z5SXFMxmMGdiimepRP4JkKW+mx+yYAHLuFcHgnLCwfTJPcYW+ImkRqQClpWCktU88gHPJnwzprhfcGygazLyZFHSodn3iG/IG/vvpyiamL/HT0LcYVneluJJeMDL9Caq/+K7guq7AFOPdHa+TN9IsEl6FY1kar8YOT5AIiwzZVLkcx1mLQBo0RJZ03Mp2G515bTp4K7Lfnx3BYlZb4sKD76ezJqFr4uMJNQ4QW45ROLuOhPIJ9IYnbC+pIP55ctM3Ks5g/vC04dfMO87tWRrUuG5c+g=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(396003)(136003)(376002)(366004)(39860400002)(451199018)(86362001)(316002)(83380400001)(66946007)(66556008)(66476007)(6506007)(6666004)(9686003)(6512007)(186003)(26005)(478600001)(6486002)(966005)(82960400001)(38100700002)(8936002)(4744005)(5660300002)(8676002)(4326008)(41300700001)(2906002)(44832011);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?jzWKmDiUCtof7xe9IpEIvmiKOa+tI+JKOIWGqX+1x/PYHkPSer4H6eWrcJJb?=
 =?us-ascii?Q?8D+OLES8+Fyt9RYnXekcnwTFHsCxNFW0j6Fd8pTfi7OeAfOWWkL80a3NBED4?=
 =?us-ascii?Q?U76pLN5UYjO88a/aoKe8LEfkP24nP9HfB4tfmct5Jggud6QQOQaOCb4R51iB?=
 =?us-ascii?Q?a+X1ClZO4IWx63fO3BxfT24Jxj+8AoZMP5ZbNsEaSqDFUucLkAjElDXDE+I0?=
 =?us-ascii?Q?fuynBYOHe6OTshG3FiSu6QXXIMuay5ufYzgltoCpzPsrwzmpMXVirD/QSj6s?=
 =?us-ascii?Q?ZfXhx1YY9QTJUxQNHIb4qLm4vXQZV+QYxtl6n8mt22sja3zAWr2ycddowDoZ?=
 =?us-ascii?Q?++wId9RHJUDWKxF9YU185TXlbJl1s+d/wVZTfKjCUoyKQAbtoL0zqWIwuaXW?=
 =?us-ascii?Q?y5hwexjlZI+EY1yMyd7ZSrf2No12clucZUdotHXM5dnnB+nbsaoHftgsQQfQ?=
 =?us-ascii?Q?5D62adi02MVZh15/wRpD6ndvs2KijwqQKICZ3ZJH0PqQ624qOLFg8XCIQIaR?=
 =?us-ascii?Q?8c8SDRFRk3WlimFPa/F70TqXaU/gG018xQ+rFCjoCxu3jQuaisusz9iPAg/y?=
 =?us-ascii?Q?01rR6U58355cX3OdFlzmTxG9Rhn/X9ovX6kXdjYX5tMoMOCFeYXpONOUyPji?=
 =?us-ascii?Q?XbAAuhm+51haOJQoj1U4UlHE4GD+EJP3oB8R3555Fnkmp47ElVhCNooXDSc0?=
 =?us-ascii?Q?ZLZKqGUef2jqK2HTjlRO+7h6wBykDIgh0L2ivfJCVLJDXMBYVoFHaTlqbW5Q?=
 =?us-ascii?Q?Pcwy2jyOMtx1y03H+nq2jccmFwtAgJoGrisE5u49jRfHmTcdsvI0o08M2DSB?=
 =?us-ascii?Q?B7xS1G3NfhBw6zZ/6CQmVYOJrM4Slxd7CU14HQ0B3MpZUqUexAqPT2HjyP0M?=
 =?us-ascii?Q?Z1sS9xm482UAMSV6iCUPKP3B9CWscDeWJCY/KuGD4q2fLX45zMRvNS4Y9Nyg?=
 =?us-ascii?Q?Rm/EeVVOUIGy/Z5DvYCqL1aX8t14pyufVKL+UfwAo4mDjxmQzOmd5NhHdVpG?=
 =?us-ascii?Q?ZmC8vCwb7cPDYMCiPPDCNrsU3RLCeHGcFOGBV1sNJo6H4fjYmSU5Typcc4Wr?=
 =?us-ascii?Q?HkcnbOEO7H6mojLdHEPW6/X7fuIexdss94wgUSO4L0vdXM+Xx1rSyMR8ORFO?=
 =?us-ascii?Q?5hLU2eetnKJx6C9SU51BuS9wqHb6SNnfcQp93IM8RFi2ErqkHrpVfQnBKWSD?=
 =?us-ascii?Q?4FVEg7yHBwrjfl8FkA9mpqfSLz76Jq8zAMJWeIToJmHTMb+D7/rIpJmTShj/?=
 =?us-ascii?Q?VWs15hsuZaPWusJ1aSs37rOLpEzMsauIRObXrivBvl6umdzWPsfctLr6RSzp?=
 =?us-ascii?Q?9pnijrwXkmJtkhsxseXYxRAHf0waMxdA8eUinnuFnwaiNzMTjR8loT8pZiX5?=
 =?us-ascii?Q?QRnHQH3PgOLQM+HU2ryE8G9IXMmoJ+nx29SpJ4Ta+8jVOKPQaEZOnKDGPJcP?=
 =?us-ascii?Q?eItlUNhywU41wbomUfxICDfT6NppPuuDs4g0Yz/fp8hET4fAGMRi0PIvj95Q?=
 =?us-ascii?Q?PCMFgv6rP27tNzk4+5p+v1bSRIWzrejZK5sBkjub1+xxh0Wkr9oIMJSk6FWs?=
 =?us-ascii?Q?3GOqqWEt21HD59uFxxeIBQduImh4QCmaXToCAnx+?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 79cbad4c-050a-4700-46c2-08db0bc10207
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 23:46:19.5556
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: hq0z1A7G+kSfHnMG2bXjCGCznJJNMS1D2TCNBy5nRulvXk399sGO+WGAs99Qo9buFdof8ok6e8l5k+ENyTPYUA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL3PR11MB6409
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Dan Williams wrote:
> Jonathan noticed that the target list setup is not unwound completely
> upon error. Undo all the setup in the 'err_decrement:' exit path.
> 
> Fixes: 27b3f8d13830 ("cxl/region: Program target lists")
> Reported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>

Reviewed-by: Ira Weiny <ira.weiny@intel.com>

> Link: http://lore.kernel.org/r/20230208123031.00006990@Huawei.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/region.c |    2 ++
>  1 file changed, 2 insertions(+)
> 
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 040bbd39c81d..ae7d3adcd41a 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -1347,6 +1347,8 @@ static int cxl_region_attach(struct cxl_region *cxlr,
>  
>  err_decrement:
>  	p->nr_targets--;
> +	cxled->pos = -1;
> +	p->targets[pos] = NULL;
>  err:
>  	for (iter = ep_port; !is_cxl_root(iter);
>  	     iter = to_cxl_port(iter->dev.parent))
> 
> 



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1FBCBC636D7
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 00:29:18 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229457AbjBKA3R (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 19:29:17 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52448 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229473AbjBKA3Q (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 19:29:16 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5791DFB;
        Fri, 10 Feb 2023 16:29:15 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676075355; x=1707611355;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=9nl9UxG/Mdq5ZYQQmXxP7hxNx25QRIo97Z29rb950Uk=;
  b=EsMO73PkYucs5qcej0jhNDV7MaQ1+n04d9xPVTCnWmp3VwC1EqnEPJT+
   FsXqVUzM8FuXJEQpHePZpktrvCjtt/ZG0MZIpDiyznPholLPkPXidoTBM
   qLTFvGdCFIhvmG3rLKdrKdFEQNIO8OFkWWS4P5wKxQHXGRIZwD1c0zDvR
   krzBSpD/2r9JumkoF41WmBnuUbVI7VciHJGZggc+2WadENPMArQs6Wnau
   OUfbH9tQxKfJejXe7A71cH4hS/66xlhq1MfZ8DxcaO9XPasRc42y3ZwiH
   Kf/FhbisG22Ks2/8hpX4XM1vRRnPaiHRHMsx12Lp/gmAvH7GqOEwWXc20
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="416787204"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="416787204"
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 16:29:15 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="756960174"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="756960174"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by FMSMGA003.fm.intel.com with ESMTP; 10 Feb 2023 16:29:12 -0800
Received: from orsmsx601.amr.corp.intel.com (10.22.229.14) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 16:29:06 -0800
Received: from ORSEDG602.ED.cps.intel.com (10.7.248.7) by
 orsmsx601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 16:29:06 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.169)
 by edgegateway.intel.com (134.134.137.103) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 16:29:06 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=bWWcR39kBuJSptOYBwY70PosiA5CNDUK/NStdiE4a1iJPmA4Uhfo/LqTdfQ2pRDvK/BM7D9L8yYNvwkgxpmOZtl4ufveJeVEt6icogeii7e1hIk08KJgHxNENKlVMnOGt85NUsw3+v79cDp/9bh1YxSiC7pPm/Tkbju6M5JMm2pKPRb6bYoN83CVRs78lT3ZjKnTZa8kU7/N8F+etBQXAOS6/QHw85S8z0ocPuyV61e3EZZsedAyoHZDbx1j43+Ifur9/0/MUGNneZWsCdZ6HZ+w6zsGjha2U+ZYMqO3H1rMhCMHeqlsxFSf52xGfxLyhRby/dEtA3d6PvwGBxJBBA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=9nl9UxG/Mdq5ZYQQmXxP7hxNx25QRIo97Z29rb950Uk=;
 b=famfFDyG9hx1AdBVhfIbQm05MIPjhLjLY9VMmxmTwZm+G4hw1E41HLiZTV6jUck7zqDuELuChKnPEvcrlgNtJt4Rk0r3pLW7tzq/PyLdjw9z4SrjBil/8I5Z/laOHL9tiJPudMjGc7qK+b5/ALfR/Az6i2dolFLIE9nnaUMBN6aRWpTNfDCPlo3VC6da7pLN7PS+nCJZ8gifrrieoNtcqxQ3R/BPZ6/nBfrXa3x7K29CG1VCiFIaNbRT42AofI6RWCXlLfUYQsG8pveO2mcNsBkCTTKOd4C+N+tnw6XsjCdxJPdl7Xbxp5a8V21mA29mvcnTa8f44J315velammscg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by PH7PR11MB5943.namprd11.prod.outlook.com (2603:10b6:510:13f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Sat, 11 Feb
 2023 00:29:04 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 00:29:03 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Topic: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Index: AQHZPS8DDz5dkH6rTE2lebI/82cNa67I5U6A
Date: Sat, 11 Feb 2023 00:29:02 +0000
Message-ID: <4f10837c5dcc405eac2441aa78a5f2f388fb601a.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|PH7PR11MB5943:EE_
x-ms-office365-filtering-correlation-id: 40a5172f-4524-4516-d501-08db0bc6fa1c
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: IsNnLDQhfQQoTQDhk4El7ugqlL/D1IHQ3SC2EIlYVXQ0ENP3QS5CqUI/4j2dnWoT/lTVsvz+vPbF6q/yp2S4o1sQKruxeeIvhk91MKJdEjVYbv9YwCHHMkbmuXvLAwDcyODuSG2w27JcNpUR2L4LxRm8Wk888Yv8zZYabLBrGC90goAVXO1bSKT2coZ9E1nbjxmjcHI0/pf+n7elm7sMt6yGee2qtGWdT8mKpTo0oWWOssU/0tU0lN7UyDOQNjsvA3+RhAJ9i+y/tk6J0VmxpeI0PwIVQwpK8Yl9H+T3KEE7rbQJoc8BY798xXwQ9rEeG37zvK69FgWoRCoiMC/J+7oNp7eu8QhFP49JTKf+zm3dFsK6hUaiVQagk0Rs3HE5o3sGPY+uDF5R2C5z29jVsKxf/ErX9B/tCYlVKesuqv3pIbx1tVbwfAzyjHrpSRZegw71RIbO91Mfv7DMt9WpKHoddlr6WYR5j5UrsRgRn7VwgsLGkuwWp5Uc9UIjrMj1s0Q/9Bwt1wAd82dBWVFifrQlMiZ2CEsnU/vTbOh0RvGsjJPokUdEjFR2dueN6sN6JRruFjoV/vOcsylhmpHCxtzgjsqzuNb41ee86KvhrYwL4AlhnT2WOivorv4Bbam2SCKWiGkEDkG8rrW96rdYqOzeLMCvbUuX0rXk0wkWtPS8esNDqatDRXM1eL4n+iIB1kTHVqpWi+4/AwHDnkzSztfH0jLUC/h/z1A6aZzDs9I=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(39860400002)(366004)(396003)(346002)(376002)(136003)(451199018)(36756003)(83380400001)(122000001)(38100700002)(82960400001)(316002)(6506007)(26005)(186003)(110136005)(54906003)(478600001)(71200400001)(966005)(2906002)(6486002)(38070700005)(8936002)(5660300002)(41300700001)(66476007)(86362001)(2616005)(6512007)(66556008)(76116006)(91956017)(64756008)(8676002)(66946007)(4326008)(66446008);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?bTFFWThleXRSbnhEaW13MUtOMWF3RXFzU1ZqRkh2L1ZDRm1paGFnSkthYVVt?=
 =?utf-8?B?RkZhSmZpRXhKVHpEUTY0YzlSZ2JPSFlIc0tubUQ4MGtIVjVuNHFmU2hDOUdx?=
 =?utf-8?B?NnJZTSt5WWFCRElPY2pQemg0bkl5R3hpaWFjZnUydkVONUxPb3dvWTNTYy9l?=
 =?utf-8?B?amFHSDNoMjNzelhhcTQraC9nVFZLZTk4MlY3Yk9Ja2RkZ3BvaVIrZU5PNnZr?=
 =?utf-8?B?TGVHUm9UL20xRnVlem5obFRWS2JBMXUzNnN2Qm5qWmt0T2ZjSUlqTjA3b1lP?=
 =?utf-8?B?ZXRQOFB3RjlmNit1VVF0a0s4bjg5eS8yNmFVbXZWQ2RUWDE4YVNBQW5EdEUr?=
 =?utf-8?B?eXRLRU1RdU4xUnZma1pyaTk5Z0xIaEJFN1QwWDV5VlFFRisrZ3p5Rnd3TWZr?=
 =?utf-8?B?RG40ZWp4dExVYXArY3hzeHVIQ2JCdmJTQXEyUHhyVFUrYlNUclJ5bjdZNGJo?=
 =?utf-8?B?bStUVXdHSGNCSmdId25qWXRKdjh6L3VjR1hrMnpLeE1mTWp2Sy9MODhYRVAw?=
 =?utf-8?B?b1hpN3JLbjFKcGo4K1ExUVRpeVNOY1QrUWxnUTMwd1dBK2cralgyNWgzNklz?=
 =?utf-8?B?ek02YWZ3UFFQYzJpNjhmNE1qQkQzdnV4WXpESWo5Rko5dEoyaTdzSmxVbjFR?=
 =?utf-8?B?ZkJmZDgvR1diS083M2JoM2JEUzVoYmd6WURZVzA2Mi9PQTN5RUk2NzRaNERj?=
 =?utf-8?B?N1ArZzFRR3ZlR00wc0J2cU1zTkJRQk1lbWNMdWhxaW1haXc4ZmFPWkRwUjkz?=
 =?utf-8?B?bTEyQWxCNU5PK3NJSExvUlZJenVXc3BxRHF5dkhudlR4aU9RTUIzYWliZXla?=
 =?utf-8?B?NFR6azY5ZXVkaU9GL0RhRHBGd0lVaHNWU1pyMUpaSkhFcklMaW9Xekgzc1o1?=
 =?utf-8?B?WE9XV3NZOEJnaHNlR2Q5ejZYL3lkTFJtYU9vMndQM1E3R0xoZG5YWGtVQW43?=
 =?utf-8?B?bUF3cmF2a1FBNWNoVUJUYWxJVHYzckJpQ2l3UllvTVVRZ0ovMUlzU3hJK3hZ?=
 =?utf-8?B?OU85b3NlYndDaks5Y2syQ1h2TU83WVlKTnMrMy9kMitiWGplRFgvOFVHMWxN?=
 =?utf-8?B?dVlXeE10S0llTWwyb0U5akN4RlFJTFNxcThnZ3AzU2hkVUNzamZvS0ZmWTEy?=
 =?utf-8?B?cG8zVFN5Z3hhd2tlbG1Vc01BTThwbnRSeWFsS3FKcEFBbVFPT2FVOTNObGpE?=
 =?utf-8?B?MExuRkxGRHUrQ2hNelRkVk5lS1dCWHBkYnJPRHpXNG5lbWNndnlEZDJ1eTh2?=
 =?utf-8?B?ZkJWbG13OVZ6cUlSaUJUV0NhaHdlRTg3bXYzSk9CR3l0c1A0VFZBY2RJaEdW?=
 =?utf-8?B?UEhUM25jR1ZTMzdveUw0Vjk1V3UydTgvelFsdm1mRGVrb1JScHJrZ0hkOXlZ?=
 =?utf-8?B?L1V1TVRoQlc1UzhmZHByRUorck9XbFJoUEV1VE5wZHllTnM5N0FxSmlDQnFY?=
 =?utf-8?B?NytuR0tkd256cmptN2g0NHBCOEM3bUk3WVFENk1UUDg5bmZkT3NtUjFKWFBE?=
 =?utf-8?B?bTViVTlVZm00dUtPZGNXU3FEVjYzQXpoTjFuRXpKdk1QNEF4dDJJNVczZFJn?=
 =?utf-8?B?MU5TUnB4eXdvSXpZbGNXOElpeVAyMTRpQXp2b2dpazEyZXB6eXFsQlB3NTBI?=
 =?utf-8?B?RW8yK3VBNmpWZ2NwWlJpL2ZUcWRlcnFiUVpNRCthaHFjbGlJNElNNUcvYmtp?=
 =?utf-8?B?V3JjdzRNZjluWmluOVNReFFGbmp2TGlGcUw3emFpQ0hnUHZub2p4b0pGZCtP?=
 =?utf-8?B?SlRUaU93bWZqNVNvZkxZZnYxMFg3Z1pZVlFSSEw0OW5VWTN0YmVNZlZYeDdh?=
 =?utf-8?B?eUVJb1NCSk0wZktqMnV0Y3BQcTBWTlh3LzFrUFZkZUpKam1nV2hZQlFiS1RD?=
 =?utf-8?B?UmhVdCtsbWNKcmE3cURBeVdCVnhDSHNuaCtIRzg2MVB6WGRZODhjM1A5UTJY?=
 =?utf-8?B?MUwvVVJ4TXJuNkhRUkVxMXltL04yUDBmMWhiMHRpZzFsbTRXUStuTDZIOUIv?=
 =?utf-8?B?TDVXUVlabnhua1lobUl3VDBLcy9vZERkNkdERUZ1alZEMVdFU3dNWU1WK3FL?=
 =?utf-8?B?VTU3ckxyTVNvNW5kNUE1amdqaEd3RmVrR3JEa1d6QjlLNVZQUjcrK0pjS2Nu?=
 =?utf-8?B?VHhGT2xRaFpTa2VZRDRWUGZRRUpZVTY5R3NqY0V0bkx5dWJ1K0tPYTd6VEd3?=
 =?utf-8?B?OUE9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <AE3F278E8014B346842376061123CCBF@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 40a5172f-4524-4516-d501-08db0bc6fa1c
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 00:29:03.0055
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: 16hAgGrNkk+mZbUkJOlFsfUj/+7or+ZaEcapOzdeAB5u3bg0iRDDJs3CbiLTe0JR/fwsgTUkjLrgGjfC32d6GeTaG8tc5rcfp+NI/W5doPU=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB5943
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
UmVnaW9uIGF1dG9kaXNjb3ZlcnkgaXMgYW4gYXN5bmNocm9ub3VzIHN0YXRlIG1hY2hpbmUgYWR2
YW5jZWQgYnkKPiBjeGxfcG9ydF9wcm9iZSgpLiBBZnRlciB0aGUgZGVjb2RlcnMgb24gYW4gZW5k
cG9pbnQgcG9ydCBhcmUgZW51bWVyYXRlZAo+IHRoZXkgYXJlIHNjYW5uZWQgZm9yIGFjdGl2ZWx5
IGVuYWJsZWQgaW5zdGFuY2VzLiBFYWNoIGFjdGl2ZSBkZWNvZGVyIGlzCj4gZmxhZ2dlZCBmb3Ig
YXV0by1hc3NlbWJseSBDWExfREVDT0RFUl9GX0FVVE8gYW5kIGF0dGFjaGVkIHRvIGEgcmVnaW9u
Lgo+IElmIGEgcmVnaW9uIGRvZXMgbm90IGFscmVhZHkgZXhpc3QgZm9yIHRoZSBhZGRyZXNzIHJh
bmdlIHNldHRpbmcgb2YgdGhlCj4gZGVjb2RlciBvbmUgaXMgY3JlYXRlZC4gVGhhdCBjcmVhdGlv
biBwcm9jZXNzIG1heSByYWNlIHdpdGggb3RoZXIKPiBkZWNvZGVycyBvZiB0aGUgc2FtZSByZWdp
b24gYmVpbmcgZGlzY292ZXJlZCBzaW5jZSBjeGxfcG9ydF9wcm9iZSgpIGlzCj4gYXN5bmNocm9u
b3VzLiBBIG5ldyAnc3RydWN0IGN4bF9yb290X2RlY29kZXInIGxvY2ssIEByYW5nZV9sb2NrLCBp
cwo+IGludHJvZHVjZWQgdG8gbWl0aWdhdGUgdGhhdCByYWNlLgo+IAo+IE9uY2UgYWxsIGRlY29k
ZXJzIGhhdmUgYXJyaXZlZCwgInAtPm5yX3RhcmdldHMgPT0gcC0+aW50ZXJsZWF2ZV93YXlzIiwK
PiB0aGV5IGFyZSBzb3J0ZWQgYnkgdGhlaXIgcmVsYXRpdmUgZGVjb2RlIHBvc2l0aW9uLiBUaGUg
c29ydCBhbGdvcml0aG0KPiBpbnZvbHZlcyBmaW5kaW5nIHRoZSBwb2ludCBpbiB0aGUgY3hsX3Bv
cnQgdG9wb2xvZ3kgd2hlcmUgb25lIGxlZyBvZiB0aGUKPiBkZWNvZGUgbGVhZHMgdG8gZGV2aWNl
QSBhbmQgdGhlIG90aGVyIGRldmljZUIuIEF0IHRoYXQgcG9pbnQgaW4gdGhlCj4gdG9wb2xvZ3kg
dGhlIHRhcmdldCBvcmRlciBpbiB0aGUgJ3N0cnVjdCBjeGxfc3dpdGNoX2RlY29kZXInIGluZGlj
YXRlcwo+IHRoZSByZWxhdGl2ZSBwb3NpdGlvbiBvZiB0aG9zZSBlbmRwb2ludCBkZWNvZGVycyBp
biB0aGUgcmVnaW9uLgo+IAo+ID4gRnJvbSB0aGF0IHBvaW50IHRoZSByZWdpb24gZ29lcyB0aHJv
dWdoIHRoZSBzYW1lIHNldHVwIGFuZCB2YWxpZGF0aW9uCj4gc3RlcHMgYXMgdXNlci1jcmVhdGVk
IHJlZ2lvbnMsIGJ1dCBpbnN0ZWFkIG9mIHByb2dyYW1taW5nIHRoZSBkZWNvZGVycwo+IGl0IHZh
bGlkYXRlcyB0aGF0IGRyaXZlciB3b3VsZCBoYXZlIHdyaXR0ZW4gdGhlIHNhbWUgdmFsdWVzIHRv
IHRoZQo+IGRlY29kZXJzIGFzIHdlcmUgYWxyZWFkeSBwcmVzZW50Lgo+IAo+IFRlc3RlZC1ieTog
RmFuIE5pIDxmYW4ubmlAc2Ftc3VuZy5jb20+Cj4gTGluazogaHR0cHM6Ly9sb3JlLmtlcm5lbC5v
cmcvci8xNjc1NjQ1NDA5NzIuODQ3MTQ2LjE3MDk2MTc4NDMzMTc2MDk3ODMxLnN0Z2l0QGR3aWxs
aWEyLXhmaC5qZi5pbnRlbC5jb20KPiBTaWduZWQtb2ZmLWJ5OiBEYW4gV2lsbGlhbXMgPGRhbi5q
LndpbGxpYW1zQGludGVsLmNvbT4KPiAtLS0KPiDCoGRyaXZlcnMvY3hsL2NvcmUvaGRtLmPCoMKg
wqAgfMKgwqAgMTEgKwo+IMKgZHJpdmVycy9jeGwvY29yZS9wb3J0LmPCoMKgIHzCoMKgwqAgMiAK
PiDCoGRyaXZlcnMvY3hsL2NvcmUvcmVnaW9uLmMgfMKgIDQ5NyArKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKy0KPiDCoGRyaXZlcnMvY3hsL2N4bC5owqDCoMKgwqDC
oMKgwqDCoCB8wqDCoCAyOSArKysKPiDCoGRyaXZlcnMvY3hsL3BvcnQuY8KgwqDCoMKgwqDCoMKg
IHzCoMKgIDQ4ICsrKysKPiDCoDUgZmlsZXMgY2hhbmdlZCwgNTc2IGluc2VydGlvbnMoKyksIDEx
IGRlbGV0aW9ucygtKQo+IAo+IApPbmUgcXVlc3Rpb24gYmVsb3csIGJ1dCBvdGhlcndpc2UgbG9v
a3MgZ29vZCwKClJldmlld2VkLWJ5OiBWaXNoYWwgVmVybWEgPHZpc2hhbC5sLnZlcm1hQGludGVs
LmNvbT4KCjwuLj4KCj4gwqAKPiArc3RhdGljIGludCBjeGxfcmVnaW9uX2F0dGFjaF9hdXRvKHN0
cnVjdCBjeGxfcmVnaW9uICpjeGxyLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgIHN0cnVjdCBjeGxfZW5kcG9pbnRfZGVj
b2RlciAqY3hsZWQsIGludCBwb3MpCj4gK3sKPiArwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgY3hsX3Jl
Z2lvbl9wYXJhbXMgKnAgPSAmY3hsci0+cGFyYW1zOwo+ICsKPiArwqDCoMKgwqDCoMKgwqBpZiAo
Y3hsZWQtPnN0YXRlICE9IENYTF9ERUNPREVSX1NUQVRFX0FVVE8pIHsKPiArwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgZGV2X2VycigmY3hsci0+ZGV2LAo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgIiVzOiB1bmFibGUgdG8gYWRkIGRlY29kZXIg
dG8gYXV0b2RldGVjdGVkIHJlZ2lvblxuIiwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoGRldl9uYW1lKCZjeGxlZC0+Y3hsZC5kZXYpKTsKPiArwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIC1FSU5WQUw7Cj4gK8KgwqDCoMKgwqDCoMKg
fQo+ICsKPiArwqDCoMKgwqDCoMKgwqBpZiAocG9zID49IDApIHsKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgZGV2X2RiZygmY3hsci0+ZGV2LCAiJXM6IGV4cGVjdGVkIGF1dG8gcG9z
aXRpb24sIG5vdCAlZFxuIiwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoGRldl9uYW1lKCZjeGxlZC0+Y3hsZC5kZXYpLCBwb3MpOwo+ICvCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gLUVJTlZBTDsKPiArwqDCoMKgwqDCoMKgwqB9Cj4g
Kwo+ICvCoMKgwqDCoMKgwqDCoGlmIChwLT5ucl90YXJnZXRzID49IHAtPmludGVybGVhdmVfd2F5
cykgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXZfZXJyKCZjeGxyLT5kZXYs
ICIlczogbm8gbW9yZSB0YXJnZXQgc2xvdHMgYXZhaWxhYmxlXG4iLAo+ICvCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X25hbWUoJmN4bGVkLT5jeGxkLmRl
dikpOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gLUVOWElPOwo+ICvC
oMKgwqDCoMKgwqDCoH0KPiArCj4gK8KgwqDCoMKgwqDCoMKgLyoKPiArwqDCoMKgwqDCoMKgwqAg
KiBUZW1wb3JhcmlseSByZWNvcmQgdGhlIGVuZHBvaW50IGRlY29kZXIgaW50byB0aGUgdGFyZ2V0
IGFycmF5LiBZZXMsCj4gK8KgwqDCoMKgwqDCoMKgICogdGhpcyBtZWFucyB0aGF0IHVzZXJzcGFj
ZSBjYW4gdmlldyBkZXZpY2VzIGluIHRoZSB3cm9uZyBwb3NpdGlvbgo+ICvCoMKgwqDCoMKgwqDC
oCAqIGJlZm9yZSB0aGUgcmVnaW9uIGFjdGl2YXRlcywgYW5kIG11c3QgYmUgY2FyZWZ1bCB0byB1
bmRlcnN0YW5kIHdoZW4KPiArwqDCoMKgwqDCoMKgwqAgKiBpdCBtaWdodCBiZSByYWNpbmcgcmVn
aW9uIGF1dG9kaXNjb3ZlcnkuCj4gK8KgwqDCoMKgwqDCoMKgICovCgpXb3VsZCBpdCBiZSB3b3J0
aHdoaWxlIGFkZGluZyBhbiBhdHRyaWJ1dGUgYXJvdW5kIHRoaXMgLSBlaXRoZXIgdG8KZGlzdGlu
Z3Vpc2ggYW4gYXV0by1hc3NlbWJsZWQgcmVnaW9uIGZyb20gYSB1c2VyLWNyZWF0ZWQgb25lLCBv
cgpwZXJoYXBzIGJldHRlciAtIHNvbWV0aGluZyB0byBtYXJrIHRoZSBhc3NlbWJseSBjb21wbGV0
ZT8gY3hsLWxpc3QKZG9lc24ndCBoYXZlIHRvIGRpc3BsYXkgdGhpcyBhdHRyaWJ1dGUgYXMgaXMs
IGJ1dCBtYXliZSBpdCBjYW4gbWFrZSBhCmRlY2lzaW9uIHRvIG1hcmsgaXQgYXMgaWRsZSB3aGls
ZSBhc3NlbWJseSBpcyBwZW5kaW5nLCBvciBtYXliZSBldmVuCnJlZnVzZSB0byBhZGRfY3hsX3Jl
Z2lvbigpIGZvciBpdCBlbnRpcmVseT8KClRoaXMgY2FuIGJlIGEgZm9sbG93LW9uIHRvby4KCj4g
K8KgwqDCoMKgwqDCoMKgcG9zID0gcC0+bnJfdGFyZ2V0czsKPiArwqDCoMKgwqDCoMKgwqBwLT50
YXJnZXRzW3Bvc10gPSBjeGxlZDsKPiArwqDCoMKgwqDCoMKgwqBjeGxlZC0+cG9zID0gcG9zOwo+
ICvCoMKgwqDCoMKgwqDCoHAtPm5yX3RhcmdldHMrKzsKPiArCj4gK8KgwqDCoMKgwqDCoMKgcmV0
dXJuIDA7Cj4gK30KPiArCj4gCgo=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D89FDC636D7
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 00:39:38 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229658AbjBKAji (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 19:39:38 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59630 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229447AbjBKAjg (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 19:39:36 -0500
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D19F329163;
        Fri, 10 Feb 2023 16:39:34 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676075974; x=1707611974;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=wrtbG9HZCdyce99pqPvET2jiBS0lcOu3Mc8UFLHha7A=;
  b=PbC3reUUL+bwX0afvSGInNo5a6sraiNAcIEQS1nqcNVyn0wd+is6xEVg
   DkAeNcmZeMl+Gxuwhn7bN6G8bWPIFhz76uUgtzskVQr3IoyhnrfYV1rGp
   DxJBABQu+6UJxdKvEv1MJ5144ev4FlJc4M0bgidKG03pgFTOEaNf5Blq/
   XSoGZCFuJFAiDa13A+DgZRMylY90oKdfVVDFO3Dc/mQws+WCa4tgTTi5T
   d3THyZi5dDQVlnPHqAJiY8CRqIO6BEoqjlB7Yp/uEhWMcEwL4iMoZtQiV
   KRx2m8/iG578uASNLc8xe+S5y3dLlIy1kf6SW52Pa8DOql2wXAioVVbQF
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="395174316"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="395174316"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
  by orsmga105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 16:39:34 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="645804813"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="645804813"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orsmga006.jf.intel.com with ESMTP; 10 Feb 2023 16:39:34 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 16:39:33 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 16:39:33 -0800
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (104.47.66.47) by
 edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 16:39:32 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=DXBN1JIlmoRCArJVRoJcJDNHwEb3S1NH77xKg6pqyabqPgcqxTdZdHFhoBD3J+x1p+cYEJt5wDKQ23mLOdGSL0NGz6QpMfofoUBZisqiYjH8aZlkZdnMmXzSvs4spr5hL2AKWohqyGMY0QD9eqqYOX0tpn3fqdJ09S9B1YPW9R2Vr/YzRIXp5OQy8hdJ53Xl4pEIjOA6oOOhb1pvAAhm3aq/R9uGlPN6Zd5fMYF05TYjXPa5LO4rsPh9iJRMqXnjjZVxkrhh2XDy7N0E5w8qqrOIQwbGqvg11UOQrQJXnrVcY18EIn/k08ADlE7/g0wLCSBncMp5l3r/WspUwqyxPw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=wrtbG9HZCdyce99pqPvET2jiBS0lcOu3Mc8UFLHha7A=;
 b=nNRp9D+peDZex/r1/XJe5HgWKAu/w/nUO5mzL1mZ7nmCjkgYNMwnmCdA/BpBMcU5yeMXOu4NoGk8n1isea/slirUCYaRRg4Rbfljr3JavjcVRTGKBNBVWZ5zcP2DIviAWpXtrq9sX45RANItsKR9fK9w6T3nGdxLjSQtp31l0qH0xAyD98q69owksmG2QRmdUkiCQPJvs5Fpq8ddgl2eiujG0nPJ0RVL07JsvOX3+oM0vKSYuG5pIYSONOXtblUoCr8hHGO9FtrHoCmAXFPDcZv54ekNn3ZVRBU/idc18QYNvY6dzzKaUp3yv4IxHKlVAbdGlf9uK5MOyXFApMD86g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by PH7PR11MB6031.namprd11.prod.outlook.com (2603:10b6:510:1d2::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Sat, 11 Feb
 2023 00:39:30 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 00:39:30 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 14/20] tools/testing/cxl: Define a fixed volatile
 configuration to parse
Thread-Topic: [PATCH v2 14/20] tools/testing/cxl: Define a fixed volatile
 configuration to parse
Thread-Index: AQHZPS8Dz7i80fkESEOk3/or2F2Rqq7I6DuA
Date: Sat, 11 Feb 2023 00:39:30 +0000
Message-ID: <49833972552abe98a1316b78623266432ed20fc6.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|PH7PR11MB6031:EE_
x-ms-office365-filtering-correlation-id: 326aa5fc-7523-478a-bc51-08db0bc87046
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: +ClJiR2JyZhh7rihEnC/IIudzaXNFrku9tMqsjC3aUegrPhA3ORese1mvdmUBvtgpCG8Nv+hRldpeq2CbrwYQ57C4Trk+adfBIyKxvqNKCJ0zxR4IBeCN3/fDKtmLdSZhMaj0flLi8rup/j04tbUSzE6qmouZOJ680Kz916dkk/kr/b8LT5oQi5MReDAHXJkfvCtUHF97ltOrscjmCnKhXaaCQI+kv5+L1A7H1wYr0RUJj1uoC7mHLgsm/1u7VtX5dne39p+SS1E7fiFoKvSouGX/gKVuRDs7c9se2mFjSj2n7bPrcvPIEHcxR7q51FKFTCL25TL5HJdvOgm7hrItXjSesi06hjF+KjWhpmUqoSQWmSPU9J3/l8fJBXYfPO/TIFKD0+1jYeyt7zWl8titVUGIYC5R9+6geUflB7ILdypsyPHw2t1MI/OBIk15nTkyxZo0lmEImYeEcwr2nn4I/Ni9QacyZ6VMD+vF1BKM8BxEU+VaFapbmrRliz0dRg+u+Mg69tJa7k58+1BFnnzJ8vzSur7zYRWN55sqemWlNhQ4YGJA64cHIOlqXUDUXqpxCeXk6WA82ATLX2p44GdHtu6PaTeUefTl9TMWLWS304WuyY+bBUPjnVA+2zyU7COF+sNWAhG8YKRigblSXClB64Eoc7zMSU1D5m5mEAPA0z+XLkpYDHVL/0fXaV0wI9+0W+WcUK/pYFvnTNXOQ7LPx1elrEKQU19oA6/+pCz0U8=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(376002)(396003)(136003)(366004)(346002)(39860400002)(451199018)(38070700005)(36756003)(82960400001)(26005)(6506007)(86362001)(6512007)(186003)(478600001)(966005)(66476007)(2616005)(83380400001)(122000001)(41300700001)(5660300002)(8936002)(4326008)(2906002)(64756008)(54906003)(110136005)(8676002)(71200400001)(316002)(66556008)(91956017)(66446008)(38100700002)(76116006)(66946007)(6486002);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?d2xlWU9YOW5XZGcyZ2Q2RlFZQ01zV0hFNXFqd2V4Zkh4aU5GRkFGVW9sSzVF?=
 =?utf-8?B?L1BjajdsMDlmckdwTjQ2YzQyYjd5OXovYUZCME41S1J0U3VUR25wOC8rNUJo?=
 =?utf-8?B?UDA4ZEJHN3o0dHRQYks3L0Eybk8zMklkUE1JSEQyUVhvTnZTbmx5QXpJdWR6?=
 =?utf-8?B?ODQ0SzRzN2dTSVExSndlbSt2S3lKM2t6NGVLTTErdXovUmZScVFSQ1h1aGU5?=
 =?utf-8?B?QThpMUlkRXU1b0VnVnIycmJFU0x2K3U0alo5NzNrVGJSdDE0djR6MWVyNFVI?=
 =?utf-8?B?UkNNbmF6RWFXQ1VmdlNPSlhDTkJOQmpoWlBLLzRPVWlGZ1JMVllSdDRhZ0Ri?=
 =?utf-8?B?N3dJVU9SR0tydWYxUVlYVU4zVEpoNzY2Q0ZIRnNYMEVCTkZFYjdFZ0RtV3gr?=
 =?utf-8?B?clEvRUlaWXdVbmNoTk0xOTFGdkRicHljUFBRK2FRYkprTUt2OThmd21hb3V6?=
 =?utf-8?B?SXNDNG5CYUNmeEo0MHo2TTVVMzFDb0htSG8wRlJnazBxWXlxWVBidXBSNkRG?=
 =?utf-8?B?TXUxTzM2VE52L04vNW1NK00rRkE3U2F5cTQzRi90MDk4YVlBWlRCYlQrdmkw?=
 =?utf-8?B?Qi9aSmVBNDN1aUpTOEpmQlMxT2R5cFViQm8rV2RFaDVUTnEzc3gxc0h4Rlds?=
 =?utf-8?B?SHB4UnF1OHJhdWhiQWlwSTI3SHpLQjN2SEdDZ1QvTGNLZjNUOUNpeXJxemla?=
 =?utf-8?B?YjI1YjNSRFRvbFErQlFvc21kQzlDYndEamZ0VkJINTYwRjgrK1kvR2dqbE1W?=
 =?utf-8?B?YTk0Z3RwOXN1ZDgzRkdQcVFYWHlEc0l4VnZrNUtQOE5SZGozR01pN0UraDQz?=
 =?utf-8?B?d1FIQnltcWZiTGhhdEtJWk9od0ZSNUxtUHdkS1VSVmd3b1JJWEZ4OVU5dzFK?=
 =?utf-8?B?T253ZlRwVXA5djhNNFl1UUZBbHZUZUNMVnlrMTREOXpmbVlkZXFaQk1nQTFV?=
 =?utf-8?B?UUlsYnFpakNURkxqQmJicE1DK0dPTUJWTXBNME5QelJIVG52Q3YzSkpoNkJ1?=
 =?utf-8?B?YlRkUGlrQnZNeUdwTjROQ083NTh1ZFNCbldheHVPbHVQVDFYYTgrMlBNRzJH?=
 =?utf-8?B?NHZKRVdQNUJPTzJqSERNQVZaQU05WGhjdkYxRnBUL2J2dXk5MXpPNnpoUUZD?=
 =?utf-8?B?YXBBMDBmT28xVXovVWlKNXV5bGl0S0h0RVFXQmhZQnRaTm1GOUdWeHMyOWRW?=
 =?utf-8?B?U0pOcDQxcHFjM045bVVoMmZ0REp1R2NxeHJmUUV2TjBSNTlObjZUVTB1SDlY?=
 =?utf-8?B?a3A2UUZqamQrOWFGcDh5RXBxdWlwMU4rVlJCWDQwbUYzRlN2dmdGdlVTMU1L?=
 =?utf-8?B?QWo4eW5sby9IYldmN3dtbTB0V1habjZJTFhtV3RieW5kRW1jcTZEQ05Kc20x?=
 =?utf-8?B?aVBKM0ROVHBEUDN4Z2tGTWw5ckEyU1hIMlVRY0hwOTdOd0FzSWR3bVp0eG82?=
 =?utf-8?B?d0dKWFdKa0FxemROYlhpVi9zUlhFK2YrOTNSaWlNUC9kejNFUGVOUGhZYVYz?=
 =?utf-8?B?ZXBlVzRReW9GN1N0Q29LU0JzeStaeHdiRW1RRmhIcnhDWEcyV01TekI0MW9K?=
 =?utf-8?B?V0NVWTBOOEdVVmhYZUx0RHFlSEVxYUFEY0NhUTJHQXZ4RHVhN1dONS9VdTdz?=
 =?utf-8?B?aE5RUk5KZElrRTkraWtBS091M2hubUsrSW5pS3ZLbW1rOVdLTFF6UVNrbUYx?=
 =?utf-8?B?ZjJ3ZS9yNUNhNmJYOWhIekh6dWVTWGFrZVczUWJ6QVREQUVuVWo5T2p6VGpv?=
 =?utf-8?B?M0IvTkxxa3U3VlRpdnh2NFlHZnJyZndhT1ZUZ2Y5T280RHJKdmIvRU9ZeUpm?=
 =?utf-8?B?d3VXWUlxWTlBZlk2dVlOdFhlN2NzcnZZS3NxTG5qQzZJRm9lbGlhL3ZwVVds?=
 =?utf-8?B?ZUtETHFDWnBuSnR4VVNYQ2NXOEpaT2NDeWIrcEdjbzI1QmY0YW82MmtXOGZE?=
 =?utf-8?B?djVnNG15OVhuUlI4SExIcGJyTjVveHJGQ0VJUEtBUlltMmhsN2RTSHl3bThF?=
 =?utf-8?B?Wnd6ejZOR0ZBTGtSZ0htYWFQZVpzbXZkcmxvQ1ZkY2JvbEt3VWZvUnJPWDRY?=
 =?utf-8?B?VG9uMkhQUjcxanN6RlEyM05pazJqZUZpZG52d3RYMWNqU1JEWVlpZmhtR0hI?=
 =?utf-8?B?ZFRjajVaQ1FNdXZGVWhLYWNEUFlLTml6TDdTY3JSaXJENG9GM3VwaGJrZUVt?=
 =?utf-8?B?L0E9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <8534C7252C958346BCC884A1A41333BA@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 326aa5fc-7523-478a-bc51-08db0bc87046
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 00:39:30.7793
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: dTt7nh3pPY1E1FwPU2TVnG95kUzeamATCvZGjOol+RHLBnOOIG7eNzkiKcezup1VSYft8xgaWPf8sVsSnc6XqL6NZo9aggRFQIWjldPg3Zw=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB6031
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
VGFrZSB0d28gZW5kcG9pbnRzIGF0dGFjaGVkIHRvIHRoZSBmaXJzdCBzd2l0Y2ggb24gdGhlIGZp
cnN0IGhvc3QtYnJpZGdlCj4gaW4gdGhlIGN4bF90ZXN0IHRvcG9sb2d5IGFuZCBkZWZpbmUgYSBw
cmUtaW5pdGlhbGl6ZWQgcmVnaW9uLiBUaGlzIGlzIGEKPiB4MiBpbnRlcmxlYXZlIHVuZGVybmVh
dGggYSB4MSBDWEwgV2luZG93Lgo+IAo+ICQgbW9kcHJvYmUgY3hsX3Rlc3QKPiAkICMgY3hsIGxp
c3QgLVJ1Cj4gewo+IMKgICJyZWdpb24iOiJyZWdpb24zIiwKPiDCoCAicmVzb3VyY2UiOiIweGYw
MTAwMDAwMDAiLAo+IMKgICJzaXplIjoiNTEyLjAwIE1pQiAoNTM2Ljg3IE1CKSIsCj4gwqAgImlu
dGVybGVhdmVfd2F5cyI6MiwKPiDCoCAiaW50ZXJsZWF2ZV9ncmFudWxhcml0eSI6NDA5NiwKPiDC
oCAiZGVjb2RlX3N0YXRlIjoiY29tbWl0Igo+IH0KPiAKPiBUZXN0ZWQtYnk6IEZhbiBOaSA8ZmFu
Lm5pQHNhbXN1bmcuY29tPgo+IExpbms6IGh0dHBzOi8vbG9yZS5rZXJuZWwub3JnL3IvMTY3NTY0
NTQxNTIzLjg0NzE0Ni4xMjE5OTYzNjM2ODgxMjM4MTQ3NS5zdGdpdEBkd2lsbGlhMi14ZmguamYu
aW50ZWwuY29tCj4gU2lnbmVkLW9mZi1ieTogRGFuIFdpbGxpYW1zIDxkYW4uai53aWxsaWFtc0Bp
bnRlbC5jb20+Cj4gLS0tCj4gwqBkcml2ZXJzL2N4bC9jb3JlL2NvcmUuaMKgwqDCoMKgwqAgfMKg
wqDCoCAzIC0KPiDCoGRyaXZlcnMvY3hsL2NvcmUvaGRtLmPCoMKgwqDCoMKgwqAgfMKgwqDCoCAz
ICsKPiDCoGRyaXZlcnMvY3hsL2NvcmUvcG9ydC5jwqDCoMKgwqDCoCB8wqDCoMKgIDIgKwo+IMKg
ZHJpdmVycy9jeGwvY3hsLmjCoMKgwqDCoMKgwqDCoMKgwqDCoMKgIHzCoMKgwqAgMiArCj4gwqBk
cml2ZXJzL2N4bC9jeGxtZW0uaMKgwqDCoMKgwqDCoMKgwqAgfMKgwqDCoCAzICsKPiDCoHRvb2xz
L3Rlc3RpbmcvY3hsL3Rlc3QvY3hsLmMgfMKgIDE0NyArKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0KPiDCoDYgZmlsZXMgY2hhbmdlZCwgMTQ2IGluc2VydGlvbnMoKyks
IDE0IGRlbGV0aW9ucygtKQoKTG9va3MgZ29vZCwKClJldmlld2VkLWJ5OiBWaXNoYWwgVmVybWEg
PHZpc2hhbC5sLnZlcm1hQGludGVsLmNvbT4KCj4gCj4gZGlmZiAtLWdpdCBhL2RyaXZlcnMvY3hs
L2NvcmUvY29yZS5oIGIvZHJpdmVycy9jeGwvY29yZS9jb3JlLmgKPiBpbmRleCA1ZWI4NzNkYTVh
MzAuLjQ3OWYwMWRhNmQzNSAxMDA2NDQKPiAtLS0gYS9kcml2ZXJzL2N4bC9jb3JlL2NvcmUuaAo+
ICsrKyBiL2RyaXZlcnMvY3hsL2NvcmUvY29yZS5oCj4gQEAgLTU3LDkgKzU3LDYgQEAgcmVzb3Vy
Y2Vfc2l6ZV90IGN4bF9kcGFfc2l6ZShzdHJ1Y3QgY3hsX2VuZHBvaW50X2RlY29kZXIgKmN4bGVk
KTsKPiDCoHJlc291cmNlX3NpemVfdCBjeGxfZHBhX3Jlc291cmNlX3N0YXJ0KHN0cnVjdCBjeGxf
ZW5kcG9pbnRfZGVjb2RlciAqY3hsZWQpOwo+IMKgZXh0ZXJuIHN0cnVjdCByd19zZW1hcGhvcmUg
Y3hsX2RwYV9yd3NlbTsKPiDCoAo+IC1ib29sIGlzX3N3aXRjaF9kZWNvZGVyKHN0cnVjdCBkZXZp
Y2UgKmRldik7Cj4gLXN0cnVjdCBjeGxfc3dpdGNoX2RlY29kZXIgKnRvX2N4bF9zd2l0Y2hfZGVj
b2RlcihzdHJ1Y3QgZGV2aWNlICpkZXYpOwo+IC0KPiDCoGludCBjeGxfbWVtZGV2X2luaXQodm9p
ZCk7Cj4gwqB2b2lkIGN4bF9tZW1kZXZfZXhpdCh2b2lkKTsKPiDCoHZvaWQgY3hsX21ib3hfaW5p
dCh2b2lkKTsKPiBkaWZmIC0tZ2l0IGEvZHJpdmVycy9jeGwvY29yZS9oZG0uYyBiL2RyaXZlcnMv
Y3hsL2NvcmUvaGRtLmMKPiBpbmRleCA4YzI5MDI2YTRiOWQuLjgwZWNjYWU2YmE5ZSAxMDA2NDQK
PiAtLS0gYS9kcml2ZXJzL2N4bC9jb3JlL2hkbS5jCj4gKysrIGIvZHJpdmVycy9jeGwvY29yZS9o
ZG0uYwo+IEBAIC0yNzksNyArMjc5LDcgQEAgc3RhdGljIGludCBfX2N4bF9kcGFfcmVzZXJ2ZShz
dHJ1Y3QgY3hsX2VuZHBvaW50X2RlY29kZXIgKmN4bGVkLAo+IMKgwqDCoMKgwqDCoMKgwqByZXR1
cm4gMDsKPiDCoH0KPiDCoAo+IC1zdGF0aWMgaW50IGRldm1fY3hsX2RwYV9yZXNlcnZlKHN0cnVj
dCBjeGxfZW5kcG9pbnRfZGVjb2RlciAqY3hsZWQsCj4gK2ludCBkZXZtX2N4bF9kcGFfcmVzZXJ2
ZShzdHJ1Y3QgY3hsX2VuZHBvaW50X2RlY29kZXIgKmN4bGVkLAo+IMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXNvdXJjZV9z
aXplX3QgYmFzZSwgcmVzb3VyY2Vfc2l6ZV90IGxlbiwKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmVzb3VyY2Vfc2l6ZV90
IHNraXBwZWQpCj4gwqB7Cj4gQEAgLTI5NSw2ICsyOTUsNyBAQCBzdGF0aWMgaW50IGRldm1fY3hs
X2RwYV9yZXNlcnZlKHN0cnVjdCBjeGxfZW5kcG9pbnRfZGVjb2RlciAqY3hsZWQsCj4gwqAKPiDC
oMKgwqDCoMKgwqDCoMKgcmV0dXJuIGRldm1fYWRkX2FjdGlvbl9vcl9yZXNldCgmcG9ydC0+ZGV2
LCBjeGxfZHBhX3JlbGVhc2UsIGN4bGVkKTsKPiDCoH0KPiArRVhQT1JUX1NZTUJPTF9OU19HUEwo
ZGV2bV9jeGxfZHBhX3Jlc2VydmUsIENYTCk7Cj4gwqAKPiDCoHJlc291cmNlX3NpemVfdCBjeGxf
ZHBhX3NpemUoc3RydWN0IGN4bF9lbmRwb2ludF9kZWNvZGVyICpjeGxlZCkKPiDCoHsKPiBkaWZm
IC0tZ2l0IGEvZHJpdmVycy9jeGwvY29yZS9wb3J0LmMgYi9kcml2ZXJzL2N4bC9jb3JlL3BvcnQu
Ywo+IGluZGV4IDU5NjIwNTI4NTcxYS4uYjQ1ZDI3OTZlZjM1IDEwMDY0NAo+IC0tLSBhL2RyaXZl
cnMvY3hsL2NvcmUvcG9ydC5jCj4gKysrIGIvZHJpdmVycy9jeGwvY29yZS9wb3J0LmMKPiBAQCAt
NDU4LDYgKzQ1OCw3IEBAIGJvb2wgaXNfc3dpdGNoX2RlY29kZXIoc3RydWN0IGRldmljZSAqZGV2
KQo+IMKgewo+IMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gaXNfcm9vdF9kZWNvZGVyKGRldikgfHwg
ZGV2LT50eXBlID09ICZjeGxfZGVjb2Rlcl9zd2l0Y2hfdHlwZTsKPiDCoH0KPiArRVhQT1JUX1NZ
TUJPTF9OU19HUEwoaXNfc3dpdGNoX2RlY29kZXIsIENYTCk7Cj4gwqAKPiDCoHN0cnVjdCBjeGxf
ZGVjb2RlciAqdG9fY3hsX2RlY29kZXIoc3RydWN0IGRldmljZSAqZGV2KQo+IMKgewo+IEBAIC00
ODUsNiArNDg2LDcgQEAgc3RydWN0IGN4bF9zd2l0Y2hfZGVjb2RlciAqdG9fY3hsX3N3aXRjaF9k
ZWNvZGVyKHN0cnVjdCBkZXZpY2UgKmRldikKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoHJldHVybiBOVUxMOwo+IMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gY29udGFpbmVyX29mKGRl
diwgc3RydWN0IGN4bF9zd2l0Y2hfZGVjb2RlciwgY3hsZC5kZXYpOwo+IMKgfQo+ICtFWFBPUlRf
U1lNQk9MX05TX0dQTCh0b19jeGxfc3dpdGNoX2RlY29kZXIsIENYTCk7Cj4gwqAKPiDCoHN0YXRp
YyB2b2lkIGN4bF9lcF9yZWxlYXNlKHN0cnVjdCBjeGxfZXAgKmVwKQo+IMKgewo+IGRpZmYgLS1n
aXQgYS9kcml2ZXJzL2N4bC9jeGwuaCBiL2RyaXZlcnMvY3hsL2N4bC5oCj4gaW5kZXggYzhlZTRi
YjhjY2U2Li4yYWMzNDQyMzUyMzUgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9jeGwvY3hsLmgKPiAr
KysgYi9kcml2ZXJzL2N4bC9jeGwuaAo+IEBAIC02NTMsOCArNjUzLDEwIEBAIHN0cnVjdCBjeGxf
ZHBvcnQgKmRldm1fY3hsX2FkZF9yY2hfZHBvcnQoc3RydWN0IGN4bF9wb3J0ICpwb3J0LAo+IMKg
Cj4gwqBzdHJ1Y3QgY3hsX2RlY29kZXIgKnRvX2N4bF9kZWNvZGVyKHN0cnVjdCBkZXZpY2UgKmRl
dik7Cj4gwqBzdHJ1Y3QgY3hsX3Jvb3RfZGVjb2RlciAqdG9fY3hsX3Jvb3RfZGVjb2RlcihzdHJ1
Y3QgZGV2aWNlICpkZXYpOwo+ICtzdHJ1Y3QgY3hsX3N3aXRjaF9kZWNvZGVyICp0b19jeGxfc3dp
dGNoX2RlY29kZXIoc3RydWN0IGRldmljZSAqZGV2KTsKPiDCoHN0cnVjdCBjeGxfZW5kcG9pbnRf
ZGVjb2RlciAqdG9fY3hsX2VuZHBvaW50X2RlY29kZXIoc3RydWN0IGRldmljZSAqZGV2KTsKPiDC
oGJvb2wgaXNfcm9vdF9kZWNvZGVyKHN0cnVjdCBkZXZpY2UgKmRldik7Cj4gK2Jvb2wgaXNfc3dp
dGNoX2RlY29kZXIoc3RydWN0IGRldmljZSAqZGV2KTsKPiDCoGJvb2wgaXNfZW5kcG9pbnRfZGVj
b2RlcihzdHJ1Y3QgZGV2aWNlICpkZXYpOwo+IMKgc3RydWN0IGN4bF9yb290X2RlY29kZXIgKmN4
bF9yb290X2RlY29kZXJfYWxsb2Moc3RydWN0IGN4bF9wb3J0ICpwb3J0LAo+IMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHVuc2lnbmVkIGludCBucl90YXJnZXRzLAo+IGRp
ZmYgLS1naXQgYS9kcml2ZXJzL2N4bC9jeGxtZW0uaCBiL2RyaXZlcnMvY3hsL2N4bG1lbS5oCj4g
aW5kZXggYzlkYTNjNjk5YTIxLi5iZjdkNGM1Yzg2MTIgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9j
eGwvY3hsbWVtLmgKPiArKysgYi9kcml2ZXJzL2N4bC9jeGxtZW0uaAo+IEBAIC04MSw2ICs4MSw5
IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBpc19jeGxfZW5kcG9pbnQoc3RydWN0IGN4bF9wb3J0ICpw
b3J0KQo+IMKgfQo+IMKgCj4gwqBzdHJ1Y3QgY3hsX21lbWRldiAqZGV2bV9jeGxfYWRkX21lbWRl
dihzdHJ1Y3QgY3hsX2Rldl9zdGF0ZSAqY3hsZHMpOwo+ICtpbnQgZGV2bV9jeGxfZHBhX3Jlc2Vy
dmUoc3RydWN0IGN4bF9lbmRwb2ludF9kZWNvZGVyICpjeGxlZCwKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCByZXNvdXJjZV9zaXplX3QgYmFzZSwgcmVz
b3VyY2Vfc2l6ZV90IGxlbiwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoCByZXNvdXJjZV9zaXplX3Qgc2tpcHBlZCk7Cj4gwqAKPiDCoHN0YXRpYyBpbmxp
bmUgc3RydWN0IGN4bF9lcCAqY3hsX2VwX2xvYWQoc3RydWN0IGN4bF9wb3J0ICpwb3J0LAo+IMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgIHN0cnVjdCBjeGxfbWVtZGV2ICpjeGxtZCkKPiBkaWZmIC0t
Z2l0IGEvdG9vbHMvdGVzdGluZy9jeGwvdGVzdC9jeGwuYyBiL3Rvb2xzL3Rlc3RpbmcvY3hsL3Rl
c3QvY3hsLmMKPiBpbmRleCA5MjBiZDk2OWM1NTQuLjUzNDJmNjlkNzBkMiAxMDA2NDQKPiAtLS0g
YS90b29scy90ZXN0aW5nL2N4bC90ZXN0L2N4bC5jCj4gKysrIGIvdG9vbHMvdGVzdGluZy9jeGwv
dGVzdC9jeGwuYwo+IEBAIC03MDMsNiArNzAzLDE0MiBAQCBzdGF0aWMgaW50IG1vY2tfZGVjb2Rl
cl9yZXNldChzdHJ1Y3QgY3hsX2RlY29kZXIgKmN4bGQpCj4gwqDCoMKgwqDCoMKgwqDCoHJldHVy
biAwOwo+IMKgfQo+IMKgCj4gK3N0YXRpYyB2b2lkIGRlZmF1bHRfbW9ja19kZWNvZGVyKHN0cnVj
dCBjeGxfZGVjb2RlciAqY3hsZCkKPiArewo+ICvCoMKgwqDCoMKgwqDCoGN4bGQtPmhwYV9yYW5n
ZSA9IChzdHJ1Y3QgcmFuZ2Upewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAuc3Rh
cnQgPSAwLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAuZW5kID0gLTEsCj4gK8Kg
wqDCoMKgwqDCoMKgfTsKPiArCj4gK8KgwqDCoMKgwqDCoMKgY3hsZC0+aW50ZXJsZWF2ZV93YXlz
ID0gMTsKPiArwqDCoMKgwqDCoMKgwqBjeGxkLT5pbnRlcmxlYXZlX2dyYW51bGFyaXR5ID0gMjU2
Owo+ICvCoMKgwqDCoMKgwqDCoGN4bGQtPnRhcmdldF90eXBlID0gQ1hMX0RFQ09ERVJfRVhQQU5E
RVI7Cj4gK8KgwqDCoMKgwqDCoMKgY3hsZC0+Y29tbWl0ID0gbW9ja19kZWNvZGVyX2NvbW1pdDsK
PiArwqDCoMKgwqDCoMKgwqBjeGxkLT5yZXNldCA9IG1vY2tfZGVjb2Rlcl9yZXNldDsKPiArfQo+
ICsKPiArc3RhdGljIGludCBmaXJzdF9kZWNvZGVyKHN0cnVjdCBkZXZpY2UgKmRldiwgdm9pZCAq
ZGF0YSkKPiArewo+ICvCoMKgwqDCoMKgwqDCoHN0cnVjdCBjeGxfZGVjb2RlciAqY3hsZDsKPiAr
Cj4gK8KgwqDCoMKgwqDCoMKgaWYgKCFpc19zd2l0Y2hfZGVjb2RlcihkZXYpKQo+ICvCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gMDsKPiArwqDCoMKgwqDCoMKgwqBjeGxkID0g
dG9fY3hsX2RlY29kZXIoZGV2KTsKPiArwqDCoMKgwqDCoMKgwqBpZiAoY3hsZC0+aWQgPT0gMCkK
PiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIDE7Cj4gK8KgwqDCoMKgwqDC
oMKgcmV0dXJuIDA7Cj4gK30KPiArCj4gK3N0YXRpYyB2b2lkIG1vY2tfaW5pdF9oZG1fZGVjb2Rl
cihzdHJ1Y3QgY3hsX2RlY29kZXIgKmN4bGQpCj4gK3sKPiArwqDCoMKgwqDCoMKgwqBzdHJ1Y3Qg
YWNwaV9jZWR0X2NmbXdzICp3aW5kb3cgPSBtb2NrX2NmbXdzWzBdOwo+ICvCoMKgwqDCoMKgwqDC
oHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYgPSBOVUxMOwo+ICvCoMKgwqDCoMKgwqDCoHN0
cnVjdCBjeGxfZW5kcG9pbnRfZGVjb2RlciAqY3hsZWQ7Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0
IGN4bF9zd2l0Y2hfZGVjb2RlciAqY3hsc2Q7Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9w
b3J0ICpwb3J0LCAqaXRlcjsKPiArwqDCoMKgwqDCoMKgwqBjb25zdCBpbnQgc2l6ZSA9IFNaXzUx
Mk07Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9tZW1kZXYgKmN4bG1kOwo+ICvCoMKgwqDC
oMKgwqDCoHN0cnVjdCBjeGxfZHBvcnQgKmRwb3J0Owo+ICvCoMKgwqDCoMKgwqDCoHN0cnVjdCBk
ZXZpY2UgKmRldjsKPiArwqDCoMKgwqDCoMKgwqBib29sIGhiMCA9IGZhbHNlOwo+ICvCoMKgwqDC
oMKgwqDCoHU2NCBiYXNlOwo+ICvCoMKgwqDCoMKgwqDCoGludCBpOwo+ICsKPiArwqDCoMKgwqDC
oMKgwqBpZiAoaXNfZW5kcG9pbnRfZGVjb2RlcigmY3hsZC0+ZGV2KSkgewo+ICvCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxlZCA9IHRvX2N4bF9lbmRwb2ludF9kZWNvZGVyKCZjeGxk
LT5kZXYpOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxtZCA9IGN4bGVkX3Rv
X21lbWRldihjeGxlZCk7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoFdBUk5fT04o
IWRldl9pc19wbGF0Zm9ybShjeGxtZC0+ZGV2LnBhcmVudCkpOwo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqBwZGV2ID0gdG9fcGxhdGZvcm1fZGV2aWNlKGN4bG1kLT5kZXYucGFyZW50
KTsKPiArCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC8qIGNoZWNrIGlzIGVuZHBv
aW50IGlzIGF0dGFjaCB0byBob3N0LWJyaWRnZTAgKi8KPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgcG9ydCA9IGN4bGVkX3RvX3BvcnQoY3hsZWQpOwo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqBkbyB7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqBpZiAocG9ydC0+dXBvcnQgPT0gJmN4bF9ob3N0X2JyaWRnZVswXS0+ZGV2KSB7
Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgaGIwID0gdHJ1ZTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBicmVhazsKPiArwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH0KPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChpc19jeGxfcG9ydChwb3J0LT5kZXYucGFyZW50KSkK
PiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqBwb3J0ID0gdG9fY3hsX3BvcnQocG9ydC0+ZGV2LnBhcmVudCk7Cj4gK8KgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBlbHNlCj4gK8KgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcG9ydCA9
IE5VTEw7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH0gd2hpbGUgKHBvcnQpOwo+
ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwb3J0ID0gY3hsZWRfdG9fcG9ydChjeGxl
ZCk7Cj4gK8KgwqDCoMKgwqDCoMKgfQo+ICsKPiArwqDCoMKgwqDCoMKgwqAvKgo+ICvCoMKgwqDC
oMKgwqDCoCAqIFRoZSBmaXJzdCBkZWNvZGVyIG9uIHRoZSBmaXJzdCAyIGRldmljZXMgb24gdGhl
IGZpcnN0IHN3aXRjaAo+ICvCoMKgwqDCoMKgwqDCoCAqIGF0dGFjaGVkIHRvIGhvc3QtYnJpZGdl
MCBtb2NrIGEgZmFrZSAvIHN0YXRpYyBSQU0gcmVnaW9uLiBBbGwKPiArwqDCoMKgwqDCoMKgwqAg
KiBvdGhlciBkZWNvZGVycyBhcmUgZGVmYXVsdCBkaXNhYmxlZC4gR2l2ZW4gdGhlIHJvdW5kIHJv
YmluCj4gK8KgwqDCoMKgwqDCoMKgICogYXNzaWdubWVudCB0aG9zZSBkZXZpY2VzIGFyZSBuYW1l
ZCBjeGxfbWVtLjAsIGFuZCBjeGxfbWVtLjQuCj4gK8KgwqDCoMKgwqDCoMKgICoKPiArwqDCoMKg
wqDCoMKgwqAgKiBTZWUgJ2N4bCBsaXN0IC1CTVB1IC1tIGN4bF9tZW0uMCxjeGxfbWVtLjQnCj4g
K8KgwqDCoMKgwqDCoMKgICovCj4gK8KgwqDCoMKgwqDCoMKgaWYgKCFoYjAgfHwgcGRldi0+aWQg
JSA0IHx8IHBkZXYtPmlkID4gNCB8fCBjeGxkLT5pZCA+IDApIHsKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgZGVmYXVsdF9tb2NrX2RlY29kZXIoY3hsZCk7Cj4gK8KgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoHJldHVybjsKPiArwqDCoMKgwqDCoMKgwqB9Cj4gKwo+ICvCoMKg
wqDCoMKgwqDCoGJhc2UgPSB3aW5kb3ctPmJhc2VfaHBhOwo+ICvCoMKgwqDCoMKgwqDCoGN4bGQt
PmhwYV9yYW5nZSA9IChzdHJ1Y3QgcmFuZ2UpIHsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgLnN0YXJ0ID0gYmFzZSwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmVu
ZCA9IGJhc2UgKyBzaXplIC0gMSwKPiArwqDCoMKgwqDCoMKgwqB9Owo+ICsKPiArwqDCoMKgwqDC
oMKgwqBjeGxkLT5pbnRlcmxlYXZlX3dheXMgPSAyOwo+ICvCoMKgwqDCoMKgwqDCoGVpZ190b19n
cmFudWxhcml0eSh3aW5kb3ctPmdyYW51bGFyaXR5LCAmY3hsZC0+aW50ZXJsZWF2ZV9ncmFudWxh
cml0eSk7Cj4gK8KgwqDCoMKgwqDCoMKgY3hsZC0+dGFyZ2V0X3R5cGUgPSBDWExfREVDT0RFUl9F
WFBBTkRFUjsKPiArwqDCoMKgwqDCoMKgwqBjeGxkLT5mbGFncyA9IENYTF9ERUNPREVSX0ZfRU5B
QkxFOwo+ICvCoMKgwqDCoMKgwqDCoGN4bGVkLT5zdGF0ZSA9IENYTF9ERUNPREVSX1NUQVRFX0FV
VE87Cj4gK8KgwqDCoMKgwqDCoMKgcG9ydC0+Y29tbWl0X2VuZCA9IGN4bGQtPmlkOwo+ICvCoMKg
wqDCoMKgwqDCoGRldm1fY3hsX2RwYV9yZXNlcnZlKGN4bGVkLCAwLCBzaXplIC8gY3hsZC0+aW50
ZXJsZWF2ZV93YXlzLCAwKTsKPiArwqDCoMKgwqDCoMKgwqBjeGxkLT5jb21taXQgPSBtb2NrX2Rl
Y29kZXJfY29tbWl0Owo+ICvCoMKgwqDCoMKgwqDCoGN4bGQtPnJlc2V0ID0gbW9ja19kZWNvZGVy
X3Jlc2V0Owo+ICsKPiArwqDCoMKgwqDCoMKgwqAvKgo+ICvCoMKgwqDCoMKgwqDCoCAqIE5vdyB0
aGF0IGVuZHBvaW50IGRlY29kZXIgaXMgc2V0IHVwLCB3YWxrIHVwIHRoZSBoaWVyYXJjaHkKPiAr
wqDCoMKgwqDCoMKgwqAgKiBhbmQgc2V0dXAgdGhlIHN3aXRjaCBhbmQgcm9vdCBwb3J0IGRlY29k
ZXJzIHRhcmdldGluZyBAY3hsbWQuCj4gK8KgwqDCoMKgwqDCoMKgICovCj4gK8KgwqDCoMKgwqDC
oMKgaXRlciA9IHBvcnQ7Cj4gK8KgwqDCoMKgwqDCoMKgZm9yIChpID0gMDsgaSA8IDI7IGkrKykg
ewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkcG9ydCA9IGl0ZXItPnBhcmVudF9k
cG9ydDsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaXRlciA9IGRwb3J0LT5wb3J0
Owo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXYgPSBkZXZpY2VfZmluZF9jaGls
ZCgmaXRlci0+ZGV2LCBOVUxMLCBmaXJzdF9kZWNvZGVyKTsKPiArwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgLyoKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICogQW5jZXN0
b3IgcG9ydHMgYXJlIGd1YXJhbnRlZWQgdG8gYmUgZW51bWVyYXRlZCBiZWZvcmUKPiArwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICogQHBvcnQsIGFuZCBhbGwgcG9ydHMgaGF2ZSBhdCBs
ZWFzdCBvbmUgZGVjb2Rlci4KPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICovCj4g
K8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChXQVJOX09OKCFkZXYpKQo+ICvCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY29udGludWU7Cj4gK8Kg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4bHNkID0gdG9fY3hsX3N3aXRjaF9kZWNvZGVy
KGRldik7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChpID09IDApIHsKPiAr
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC8qIHB1dCBjeGxf
bWVtLjQgc2Vjb25kIGluIHRoZSBkZWNvZGUgb3JkZXIgKi8KPiArwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGlmIChwZGV2LT5pZCA9PSA0KQo+ICvCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4
bHNkLT50YXJnZXRbMV0gPSBkcG9ydDsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoGVsc2UKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxzZC0+dGFyZ2V0WzBdID0gZHBvcnQ7Cj4g
K8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH0gZWxzZQo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY3hsc2QtPnRhcmdldFswXSA9IGRwb3J0Owo+
ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxkID0gJmN4bHNkLT5jeGxkOwo+ICvC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxkLT50YXJnZXRfdHlwZSA9IENYTF9ERUNP
REVSX0VYUEFOREVSOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxkLT5mbGFn
cyA9IENYTF9ERUNPREVSX0ZfRU5BQkxFOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqBpdGVyLT5jb21taXRfZW5kID0gMDsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
LyoKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgICogU3dpdGNoIHRhcmdldHMgMiBl
bmRwb2ludHMsIHdoaWxlIGhvc3QgYnJpZGdlIHRhcmdldHMKPiArwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgICogb25lIHJvb3QgcG9ydAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqAgKi8KPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgaWYgKGkgPT0gMCkKPiAr
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4bGQtPmludGVy
bGVhdmVfd2F5cyA9IDI7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGVsc2UKPiAr
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4bGQtPmludGVy
bGVhdmVfd2F5cyA9IDE7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4bGQtPmlu
dGVybGVhdmVfZ3JhbnVsYXJpdHkgPSAyNTY7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoGN4bGQtPmhwYV9yYW5nZSA9IChzdHJ1Y3QgcmFuZ2UpIHsKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC5zdGFydCA9IGJhc2UsCj4gK8KgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAuZW5kID0gYmFzZSArIHNpemUg
LSAxLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqB9Owo+ICvCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqBwdXRfZGV2aWNlKGRldik7Cj4gK8KgwqDCoMKgwqDCoMKgfQo+ICt9
Cj4gKwo+IMKgc3RhdGljIGludCBtb2NrX2N4bF9lbnVtZXJhdGVfZGVjb2RlcnMoc3RydWN0IGN4
bF9oZG0gKmN4bGhkbSkKPiDCoHsKPiDCoMKgwqDCoMKgwqDCoMKgc3RydWN0IGN4bF9wb3J0ICpw
b3J0ID0gY3hsaGRtLT5wb3J0Owo+IEBAIC03NDgsMTYgKzg4NCw3IEBAIHN0YXRpYyBpbnQgbW9j
a19jeGxfZW51bWVyYXRlX2RlY29kZXJzKHN0cnVjdCBjeGxfaGRtICpjeGxoZG0pCj4gwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY3hsZCA9ICZjeGxlZC0+
Y3hsZDsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoH0KPiDCoAo+IC3CoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjeGxkLT5ocGFfcmFuZ2UgPSAoc3RydWN0IHJhbmdlKSB7
Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAuc3RhcnQg
PSAwLAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmVu
ZCA9IC0xLAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqB9Owo+IC0KPiAtwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY3hsZC0+aW50ZXJsZWF2ZV93YXlzID0gbWluX25vdF96
ZXJvKHRhcmdldF9jb3VudCwgMSk7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGN4
bGQtPmludGVybGVhdmVfZ3JhbnVsYXJpdHkgPSBTWl80SzsKPiAtwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgY3hsZC0+dGFyZ2V0X3R5cGUgPSBDWExfREVDT0RFUl9FWFBBTkRFUjsKPiAt
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY3hsZC0+Y29tbWl0ID0gbW9ja19kZWNvZGVy
X2NvbW1pdDsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgY3hsZC0+cmVzZXQgPSBt
b2NrX2RlY29kZXJfcmVzZXQ7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoG1vY2tf
aW5pdF9oZG1fZGVjb2RlcihjeGxkKTsKPiDCoAo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgaWYgKHRhcmdldF9jb3VudCkgewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoHJjID0gZGV2aWNlX2Zvcl9lYWNoX2NoaWxkKHBvcnQtPnVwb3J0
LCAmY3R4LAo+IAoK

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 49A49C6379F
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 00:40:55 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229707AbjBKAky (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 19:40:54 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60146 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229576AbjBKAkx (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 19:40:53 -0500
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BE46C6C7DC;
        Fri, 10 Feb 2023 16:40:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676076047; x=1707612047;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=8fBNjJscA6O2iRhqTW8OJZQ3bvZbo9q/Nxd3482rRsM=;
  b=a98hpXZsP1XLs5YXGdaSl4lM2IGX2MXiisGqt38RjOKyG2x8fRdUDU/c
   jtz7Lf9N/PZghHCzNTf6aiUiBHd4LpGnoy7cepjXNNfE1/PLi21ghQaG/
   9KNpiuTbR4BoQcVWAWkT9LGka917lWDhZ8o2ufpmVZe6liqk20ZE+v+ZO
   B82q0YqztJ1JaeQ60X9INS1c0r4jkNcbNwZ3FVEvvONPSW+77ZSkBxInN
   qG/mWiCJtLOArAzQxisJ1znoEE6LKqy4YeOH8lqNAn+PGo6KNG4CUEniQ
   CdtJMOlVDOpJ3W04PRhX5qsgxggcOlpA0EFIvt41z1VWqcjkYT1/914lv
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="395174502"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="395174502"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
  by orsmga105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 16:40:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="645805218"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="645805218"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orsmga006.jf.intel.com with ESMTP; 10 Feb 2023 16:40:47 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 16:40:46 -0800
Received: from orsmsx611.amr.corp.intel.com (10.22.229.24) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 16:40:45 -0800
Received: from ORSEDG601.ED.cps.intel.com (10.7.248.6) by
 orsmsx611.amr.corp.intel.com (10.22.229.24) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 16:40:45 -0800
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (104.47.66.45) by
 edgegateway.intel.com (134.134.137.102) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 16:40:45 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=oEHzb1YexSIgy/ippbZ+xRRO0P0PG7Ey2uV5tg3VTM4GU531bHeKx4WVdrxbSawerAt/Vk5/kE3mHnmFopIWx0/xd7785aKbfn3XibmFP320ee3ihkfRC7qtZT+4EaUssNCekG6DuHgiTUGKKVaFg2XBAbDOXZt7Gfrt2YbrP6/Fh5Q0A/T7PshlzMKBvIUIWjyOzta+1ndByIXrSMOget+En2EHZHkkrDwtMRUd/Z7eQGMlFGMKI4ELZ/xhZTcqAd/qvi+3Rfr0F8eZ6FBRYN7+eFxaZJO0H61uIqkb364zH/eOEzMQwmIW+vIsY9CclL9k8TlvtE9YTJrY7REPBA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=8fBNjJscA6O2iRhqTW8OJZQ3bvZbo9q/Nxd3482rRsM=;
 b=LSi01BULd86tqKhaLu/B9Kk7BeDjRe8A5JXYuXrXXm+ZJi6IxBBQdiCEH/lRzapAtw5XiCsesxSoo8Ql1k8SrfgmFoxAp5nKiXy//Lp9N68Lm6AoxS23S2uUwMGa7pjIKqlND9j8aYJKxRZqho5Gzh3omaME7JoK+efd4g6ZS5n4ZhLf+k2yAUvIBpTOH10P1X3mJEgcaq/NIHfNZqM+kxhn8oXG5BqIRBWy6BSzsXCZaKzH8SpfVMffN+rWXyEvfYVeTIeEo07HVqIJape4EOdQFD9+3zK8UPffWAzMMuCDVsH7jfPvPPjaMH6xRFgh1dWm/yUI2evGUcAj8FxFAw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by PH7PR11MB6031.namprd11.prod.outlook.com (2603:10b6:510:1d2::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Sat, 11 Feb
 2023 00:40:39 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 00:40:39 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 15/20] dax/hmem: Move HMAT and Soft reservation probe
 initcall level
Thread-Topic: [PATCH v2 15/20] dax/hmem: Move HMAT and Soft reservation probe
 initcall level
Thread-Index: AQHZPS8Gd6h73Sipp0ux0Xrw8fbC1a7I6IyA
Date: Sat, 11 Feb 2023 00:40:39 +0000
Message-ID: <56afc05eec2ac63af7984fffdfb8a5ab2e1678ec.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|PH7PR11MB6031:EE_
x-ms-office365-filtering-correlation-id: 8af63257-61c5-4892-0fbb-08db0bc8990c
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: f+7eCNu/Kv0U8lprsbIGsMV8yXkEDC+V14zJ9SS9kpVkgByryS/CU2vnoGZVQanrcoESMe4NwXFM2e8XCmymu3nZKtp0pvjMJ7FQXPogfiK4HjHDBDZA4DyxxHhd3Tkf3e+BBCaUe/6eVifqevb3v0vVwUcrbeRRLl4drxS4C5WcAmjNOqSoXVtsLc6j4YhDO7NwPZDlcOVXJ8rGNxsMyMDz2kqg/IxDa75k7MNu+1GZ2s5WdGyfSHsx3W370CZYJqDZStobYGi7LpUvd/S/2YDZdjZSfgYAuPMYk/dsc718cY/xqTCVK3UNZ8uM7aYaQTRJE7wHGQexJVUY930yuyEgdBT2MSczJlVKXfSw1cyx9wH7yJHKYPQuE9KnH4XbOd68g4tbQdBFaM0qOWF88u36fLsdzASaLPt+tbfWyTPgASMZgSNEmK5BwSw0dnrkTXYIJFFIPUutP6BS7YDPWmrQUweCRwnjrH+eubUhIoSYQXGLrGHERTv0HldmaoHpHjqBwXtBYF+I11JpP93YdNUTKcMXPUkQrvP4/w5tJrl4m5rjqkQyNbqne4Wd8SKvcCGwsWl9YRDIkl6Ks4RfNgqckp3kcOU76SD/arj2eR5bo07abQ+w6HL7vuN8uav26tE7ALX7Uy6RqWxoUNIhsVFdGGb6VVWS6t8955+bzS/ysWA4N1Tazd5kTAJU/KbOKWQAhrm6NMK/Bf6P+2ppmV1mMxIuI43tX8jwqlurHmM=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(376002)(396003)(136003)(366004)(346002)(39860400002)(451199018)(38070700005)(36756003)(82960400001)(26005)(6506007)(86362001)(6512007)(186003)(478600001)(966005)(66476007)(2616005)(83380400001)(122000001)(41300700001)(5660300002)(8936002)(4326008)(2906002)(64756008)(54906003)(110136005)(8676002)(71200400001)(316002)(66556008)(91956017)(66446008)(38100700002)(76116006)(66946007)(6486002);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?end0YmdKcVh4RjZIdTJsemFLTTM2clFzUysyQWg4QmZNRDBuRnh0cmZyU0hS?=
 =?utf-8?B?QTVPcFdsWHBtTFdRaXQyeTJ4WWFLUlJONkE3a3FDdmNnUk9oR21URm5ORFdl?=
 =?utf-8?B?TElodDZsbFFFVFlwTjRMUE41TFM4M0FQdUNoQUtHWFZlMFRlK2VpdEtiY2Jz?=
 =?utf-8?B?M2xmS2FIV01CemJnNUIrcnZhYkFjQjVEUXNrZzlvMnVUT1dRNEkrSWlCMzZT?=
 =?utf-8?B?R28wbmJCRnNMa2FmcnlsSFczSlcxU3hmbEMvM0tQK25aUytDajQ2MHFTMTkw?=
 =?utf-8?B?enJvemNRcmI1cWRQUVp3dk9hbi96dlZ3TG12eWJYdExUWnNUQ0J5b3Nvb25j?=
 =?utf-8?B?UTZBek8yd2l2WTR6M3IySzAyckJzZ0pyU0lrcDJ0VDgrZk1WekJGeWg2Rmk1?=
 =?utf-8?B?Z2RvdE9QMmVsV1FXUzlJbmNzNDYvamdmT09RZ1pXT2ZETUhsb0RUWmM3Uy9v?=
 =?utf-8?B?OHNlaVJnYW56SDZBcEprUmhVd2x1VE8rRkRNU1RIZ1REZVQxQVZLeXN0Nm9a?=
 =?utf-8?B?ZUtSV25aZGZHUGhWb3ZsZDJuSDlHRFV2OWJWUlZUZXlPYmJoVnU5NE1EOXd3?=
 =?utf-8?B?OXZlakx6enFNcmx2bDRwVWwvbngrREg0K0ZWMytwbVNxUmppUkM5NGRaNld5?=
 =?utf-8?B?NUk2NElXWU1pN3pkd3VIR0RBWHdaWkdXSlN0V0dhTFp6emtKOHNVMng2bGVs?=
 =?utf-8?B?ZURQdGREdUFYb0crdHJ2cHpQcFAxTFRWUVV6NHZjenUxa3IrU3R0K3gzWVlD?=
 =?utf-8?B?VDVVZTJjTTlBS3RUcmRJUzlXUTZJVHJ1dzRWY2xhWll5aWxoakYxajQzWmZm?=
 =?utf-8?B?dGw4NW8zaU5vYUkyUWxSOGdRUE83eHVuc0V5QjY3YlFWZkxCTTZDNTVoVjBU?=
 =?utf-8?B?Y212N2xSWHFoMVlFNWNhQlB2ZmpzY0ZzYTdEYTRDOTFjdTczc3ZTWmU4dG9E?=
 =?utf-8?B?VGg2TXJDOTZsRkdSWU5CTnIwSFZkNndaMXRrMVJjNjkwamJuK0l1SzJOaVA3?=
 =?utf-8?B?aHdINDh6RHJ6dE51Z3pxZG9QZ09YcEZxNlZ4QzFyaE12ZE45bWp4blVmb2pm?=
 =?utf-8?B?QjZwa0NaeVlEdHAyaXc1UTB1S0ZicWtNNVZxL2ZWZUxDM2tDbHgyN0swU3Zj?=
 =?utf-8?B?RFlYb3J5T2RtSkplejdZTGZyNlFnN2tjbUM0NTNCZHkrcStuaTU3YXJ5VkxX?=
 =?utf-8?B?Nk9qUlduYnd2MUtqYXBZZmdCc1U2MzRCeEg1WFNBeUVRMDROM3lXaUdpVFNj?=
 =?utf-8?B?b2dYcUI4eUtlQjlGa0pBMVdOdHY0NVZ1R2t6ZStZMFhmS28vVFFTMHhwNVF6?=
 =?utf-8?B?dXN4RFNhdzNqNC9DNmJKeHJOS1NuSGFqQWw0MTRJcDZqVHRHZU1DSUJWOWMw?=
 =?utf-8?B?TWprZVk2OEZKb3ZiUGNVeE9hYUQyMTdEcWR4SW8ydWFJZG9ESzFjMm9IaHBo?=
 =?utf-8?B?REFLN0NBajRDQ0N4dWx4Z1FNUWRZN1R5blVOZks4WTJISTYxVGtPZnRyY3VF?=
 =?utf-8?B?MXp5ZGdNSVNzVkFyQlNSdWVTRUJoUG5xTUdHNit1RWFydDlLdC81dTEyWGJw?=
 =?utf-8?B?TDB1aldQcXBpaXJvUkFZU2pubHppeXM0ZDhtcVZTZ3NHa2IwVkd4cnJEeGdZ?=
 =?utf-8?B?c0YwdWlTTHR6Y29CejdPUER6Qjc1bTZlQyswWGdySzJVQW51NFVZS1V3MHpj?=
 =?utf-8?B?Y0dIZEZSNUFuKzMvSmRsTTgvMWxpZWxaSkNsS2pzNGx4Y25zejNqT3U4cE5T?=
 =?utf-8?B?UDhpTk5WN3Uxd0oxbS9ZU0luVzlHYW5aUGFTVzhrZDVxeDNLOFY0SXpYckJw?=
 =?utf-8?B?S01mcUEwSUsvbUJiODUwNHdhQ05DR0c1bVpMTUQ3c3pSUW5hYldVYVozQktm?=
 =?utf-8?B?OHlxN25OcDZ2c2lCT3I0bGpPdU9xR3NvSTk1djNFc3NLbUd2a3RjN0JGRFZh?=
 =?utf-8?B?Q0ZicDZhKy9Najl1cjJXczgzVzNBZ1JRdDNLaThncHQ2QXJQQVp2ejJxb1Bl?=
 =?utf-8?B?ZnlqK0QyLzR0S3FaVnRRclhyaGRXNDBPVzJ5R2VSODI4UkxrQng3UlRGSC9F?=
 =?utf-8?B?L0I2ZUM0MS9FZU5xTEhPQnNzQkFOYzlrakVtRmtFWXcxVWRGeitGK3Vja3hn?=
 =?utf-8?B?NFFFbWJUZ1VoeGhmSHBwSTZSaGdMdTlVL0ZkUTBUTTNpU0NVZk9UQ05WKzZV?=
 =?utf-8?B?bUE9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <F538C89C435DCB4AA368EE006004BC26@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8af63257-61c5-4892-0fbb-08db0bc8990c
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 00:40:39.1501
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: RnBLw5Lpw/bCYpsTFz+5psBR/xrVw7QdUdcC11T2weNSEAsrW1XaRwOARMds+BuY75mCX3MF+577hOABA/9Q4J+hw5VLJtYB0SZLNHGH77I=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB6031
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6DQo+
IEluIHByZXBhcmF0aW9uIGZvciBtb3ZpbmcgbW9yZSBmaWx0ZXJpbmcgb2YgImhtZW0iIHJhbmdl
cyBpbnRvIHRoZQ0KPiBkYXhfaG1lbS5rbyBtb2R1bGUsIHVwZGF0ZSB0aGUgaW5pdGNhbGwgbGV2
ZWxzLiBITUFUIHJhbmdlIHJlZ2lzdHJhdGlvbg0KPiBtb3ZlcyB0byBzdWJzeXNfaW5pdGNhbGwo
KSB0byBiZSBkb25lIGJlZm9yZSBTb2Z0IFJlc2VydmF0aW9uIHByb2JpbmcsDQo+IGFuZCBTb2Z0
IFJlc2VydmF0aW9uIHByb2JpbmcgaXMgbW92ZWQgdG8gZGV2aWNlX2luaXRjYWxsKCkgdG8gYmUg
ZG9uZQ0KPiBiZWZvcmUgZGF4X2htZW0ua28gaW5pdGlhbGl6YXRpb24gaWYgaXQgaXMgYnVpbHQt
aW4uDQo+IA0KPiBUZXN0ZWQtYnk6IEZhbiBOaSA8ZmFuLm5pQHNhbXN1bmcuY29tPg0KPiBMaW5r
OiBodHRwczovL2xvcmUua2VybmVsLm9yZy9yLzE2NzU2NDU0MjEwOS44NDcxNDYuMTAxMTM5NzI4
ODE3ODI0MTkzNjMuc3RnaXRAZHdpbGxpYTIteGZoLmpmLmludGVsLmNvbQ0KPiBTaWduZWQtb2Zm
LWJ5OiBEYW4gV2lsbGlhbXMgPGRhbi5qLndpbGxpYW1zQGludGVsLmNvbT4NCj4gLS0tDQo+IMKg
ZHJpdmVycy9hY3BpL251bWEvaG1hdC5jwqAgfMKgwqDCoCAyICstDQo+IMKgZHJpdmVycy9kYXgv
aG1lbS9NYWtlZmlsZSB8wqDCoMKgIDMgKystDQo+IMKgZHJpdmVycy9kYXgvaG1lbS9kZXZpY2Uu
YyB8wqDCoMKgIDIgKy0NCj4gwqAzIGZpbGVzIGNoYW5nZWQsIDQgaW5zZXJ0aW9ucygrKSwgMyBk
ZWxldGlvbnMoLSkNCg0KTG9va3MgZ29vZCwNCg0KUmV2aWV3ZWQtYnk6IFZpc2hhbCBWZXJtYSA8
dmlzaGFsLmwudmVybWFAaW50ZWwuY29tPg0KDQo+IA0KPiBkaWZmIC0tZ2l0IGEvZHJpdmVycy9h
Y3BpL251bWEvaG1hdC5jIGIvZHJpdmVycy9hY3BpL251bWEvaG1hdC5jDQo+IGluZGV4IDYwNWEw
YzcwNTNiZS4uZmYyNDI4MjMwMWFiIDEwMDY0NA0KPiAtLS0gYS9kcml2ZXJzL2FjcGkvbnVtYS9o
bWF0LmMNCj4gKysrIGIvZHJpdmVycy9hY3BpL251bWEvaG1hdC5jDQo+IEBAIC04NjksNCArODY5
LDQgQEAgc3RhdGljIF9faW5pdCBpbnQgaG1hdF9pbml0KHZvaWQpDQo+IMKgwqDCoMKgwqDCoMKg
wqBhY3BpX3B1dF90YWJsZSh0YmwpOw0KPiDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIDA7DQo+IMKg
fQ0KPiAtZGV2aWNlX2luaXRjYWxsKGhtYXRfaW5pdCk7DQo+ICtzdWJzeXNfaW5pdGNhbGwoaG1h
dF9pbml0KTsNCj4gZGlmZiAtLWdpdCBhL2RyaXZlcnMvZGF4L2htZW0vTWFrZWZpbGUgYi9kcml2
ZXJzL2RheC9obWVtL01ha2VmaWxlDQo+IGluZGV4IDU3Mzc3YjRjM2Q0Ny4uZDRjNGNkNmJjY2Q3
IDEwMDY0NA0KPiAtLS0gYS9kcml2ZXJzL2RheC9obWVtL01ha2VmaWxlDQo+ICsrKyBiL2RyaXZl
cnMvZGF4L2htZW0vTWFrZWZpbGUNCj4gQEAgLTEsNiArMSw3IEBADQo+IMKgIyBTUERYLUxpY2Vu
c2UtSWRlbnRpZmllcjogR1BMLTIuMA0KPiAtb2JqLSQoQ09ORklHX0RFVl9EQVhfSE1FTSkgKz0g
ZGF4X2htZW0ubw0KPiArIyBkZXZpY2VfaG1lbS5vIGRlbGliZXJhdGVseSBwcmVjZWRlcyBkYXhf
aG1lbS5vIGZvciBpbml0Y2FsbCBvcmRlcmluZw0KPiDCoG9iai0kKENPTkZJR19ERVZfREFYX0hN
RU1fREVWSUNFUykgKz0gZGV2aWNlX2htZW0ubw0KPiArb2JqLSQoQ09ORklHX0RFVl9EQVhfSE1F
TSkgKz0gZGF4X2htZW0ubw0KPiDCoA0KPiDCoGRldmljZV9obWVtLXkgOj0gZGV2aWNlLm8NCj4g
wqBkYXhfaG1lbS15IDo9IGhtZW0ubw0KPiBkaWZmIC0tZ2l0IGEvZHJpdmVycy9kYXgvaG1lbS9k
ZXZpY2UuYyBiL2RyaXZlcnMvZGF4L2htZW0vZGV2aWNlLmMNCj4gaW5kZXggOTAzMzI1YWFjOTkx
Li4yMDc0OWM3ZmFiODEgMTAwNjQ0DQo+IC0tLSBhL2RyaXZlcnMvZGF4L2htZW0vZGV2aWNlLmMN
Cj4gKysrIGIvZHJpdmVycy9kYXgvaG1lbS9kZXZpY2UuYw0KPiBAQCAtMTA0LDQgKzEwNCw0IEBA
IHN0YXRpYyBfX2luaXQgaW50IGhtZW1faW5pdCh2b2lkKQ0KPiDCoCAqIEFzIHRoaXMgaXMgYSBm
YWxsYmFjayBmb3IgYWRkcmVzcyByYW5nZXMgdW5jbGFpbWVkIGJ5IHRoZSBBQ1BJIEhNQVQNCj4g
wqAgKiBwYXJzaW5nIGl0IG11c3QgYmUgYXQgYW4gaW5pdGNhbGwgbGV2ZWwgZ3JlYXRlciB0aGFu
IGhtYXRfaW5pdCgpLg0KPiDCoCAqLw0KPiAtbGF0ZV9pbml0Y2FsbChobWVtX2luaXQpOw0KPiAr
ZGV2aWNlX2luaXRjYWxsKGhtZW1faW5pdCk7DQo+IA0KDQo=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 33415C636D7
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 00:41:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229645AbjBKAlJ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 19:41:09 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60326 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229676AbjBKAlI (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 19:41:08 -0500
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 46F5823D86;
        Fri, 10 Feb 2023 16:41:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676076067; x=1707612067;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=DZxFaKnIa/AhBJ6AH4QsS5P0XThbO3JB9Rk7KtXMuE4=;
  b=e54yJAHhXDjIrnKLl/QflK1M59ee+zZJ5W8azyJxqR1UPNmdeS0eJSQx
   09hRLRPP1gRqtiS362p9yZV/5F+q7BFMGl7lITC325yEbRA6IdevA5LU9
   sSxoiTY1p9WS9ul6Wk1X1e/Tm9y1vIsrShC4P3AjKJ3X1WF0jDw5v+7Fz
   HyJe7bRp5hGorB600+SBCI9+6rSQIRb+UKtq7xJqxBnbySXhnlTvzmikl
   mzuGDEsUxjiJe2nqBTGY0otYCI/bhw27RVDW26T/tF1oHMgQ8K86lQeOR
   DXyK1rWfGT/Gu+q4oarBgIWwSEpPk5by0TOBMiup502MUaXIo+axRFh0r
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="318584047"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="318584047"
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
  by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 16:41:06 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="756962342"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="756962342"
Received: from orsmsx601.amr.corp.intel.com ([10.22.229.14])
  by FMSMGA003.fm.intel.com with ESMTP; 10 Feb 2023 16:41:06 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 16:41:06 -0800
Received: from ORSEDG601.ED.cps.intel.com (10.7.248.6) by
 orsmsx612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 16:41:06 -0800
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (104.47.66.47) by
 edgegateway.intel.com (134.134.137.102) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 16:41:05 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=g34QxZ/eZR/uhJc3cZsKVmN2mZ2sv4aabWwV3baipnaqYC9DMQFfWDYSxaVK2VefXzKSq95dewt/Tjr6RSm/dM37OQ54VHt3jwcVE3cwngf2EtPstPCQLY5hOAOWJ0IE7+gQTpbeKdMV70+UWff2xoi3CCMyMtlohtILFs6H3Tpho/dHhefoinW9iLqUPBZZ66q/Ci5FRytfWRxCAondKAq9Mk27ys+4oRAoXr6gbc3CeTETx4cCz7QMIZP94VOyLZSqeNvi8cxqYPASI+VBkoa4YeifKRaVJRfIKUjeZeUvcpALRLhZE6rgFq3VkfXiPWdREPU9uVpsax2O21Vgsg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=DZxFaKnIa/AhBJ6AH4QsS5P0XThbO3JB9Rk7KtXMuE4=;
 b=ie7xtoDNyz8kM0mdnK9jOqGYvwWBNU0ls3DftnS/Xq6g/BR8H00rsdtE6kIiaBoxQbreAayxChSDuG+xcsDiY3k4TDhrTeINM3iWRgBfjf0IR4abyMUTVIG92NHFFkHvaPkEfXX5ztRNcPTCt09zfI9hM11v1hEH31uqyZhyyM0fh6e1RYCh78iFZrX6se/yCbR3E++zUzSgICkEjiWU8rRQGWLZHQemtEXbhq2u7l1pIgt3bHbfPYoFmIJvqOufeRkbFJMRyH90tNZXiCztHC8qTL9S2AIZ82kP+DlLeToUYVljHj4RezAlk5qfdcaUAf4L16VDSGB5X7Xu9PRm4w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by PH7PR11MB6031.namprd11.prod.outlook.com (2603:10b6:510:1d2::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Sat, 11 Feb
 2023 00:41:04 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 00:41:04 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "Jonathan.Cameron@huawei.com" <Jonathan.Cameron@huawei.com>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 16/20] dax/hmem: Drop unnecessary dax_hmem_remove()
Thread-Topic: [PATCH v2 16/20] dax/hmem: Drop unnecessary dax_hmem_remove()
Thread-Index: AQHZPS8NdIprPVmPwEqewAzVqWJRmK7I6KoA
Date: Sat, 11 Feb 2023 00:41:04 +0000
Message-ID: <c40377d8312ead62f17ae6f9734f366e251510a3.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602001664.1924368.9102029637928071240.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602001664.1924368.9102029637928071240.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|PH7PR11MB6031:EE_
x-ms-office365-filtering-correlation-id: a87ae7be-d793-4a6d-4afb-08db0bc8a7f7
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: getLHLIHS6YJa3JUcFUX+W9Im5imQ9bsN3SBlnK2DfKBjKqGTB1RvPmpo7mHfCLX0Non66el+rmN0swGV4pvCjT2sFKOT7uCBC248brVj/juZPM6EOzR4LW26Zfvr9YoZea2tS50+iJkBQZ/YFEv7niTvEXxqvIP9iO9Uo4PWVzss3HrjFM4VoKroC5odq4UCg6AXchk+/iDgMtbLFOEiucSxKGO90BMHCVN757xtcZbwFnmTUjT21zsagvSUn3Rhwf3kZJjPOvZzXofn7wpSEw9/6SUB8cw0aGh1UKLbQODOC15mwVYZIVQon5IQ48l43a7fy7KNU93J9GC4ArJQetjJiimMuEmDi4FjujGio7G6C1YVV2uk9lq9xTFwxNbgIyi8eAHz5um0m1TteDI6HlZUjJPXJXdNKgHSii7PRXlf76pM5cB9Rm/mHghJvDFBDIILAuKYkN7k3MQLMB03psJ0OZaSf77LLw3bcuWIM/0FWqnQrh13X2aN7rNPZnlHlXMhyU5+2e4yidmPP/zT6Fo0R4AXzs24ccIbczooTdHuA696OlgkMbeDZh4AKyn0oTvPNRa1fyNUUubzgqZZVWmJvmJOccNZYM6OyUyPwVARTlvWWIJeiqBqZ2b2jR8dNxZ8DAaR9qBLSTEcsCbovcEaPVMmK2GBiVRwsbcWBALnkVkIPP5kohM899IdRSsDqBm9h5b1uETl8gLp7knY+xD0Kn1zUoQcOobbTOc/pY=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(376002)(396003)(136003)(366004)(346002)(39860400002)(451199018)(38070700005)(36756003)(82960400001)(26005)(6506007)(86362001)(6512007)(186003)(478600001)(966005)(66476007)(2616005)(83380400001)(122000001)(41300700001)(5660300002)(8936002)(4326008)(2906002)(4744005)(64756008)(54906003)(110136005)(8676002)(71200400001)(316002)(66556008)(91956017)(66446008)(38100700002)(76116006)(66946007)(6486002);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?MTVYd0tNT3hIZGIzcDRNdHc5SlYwZXJ4YWpIeEs4bHVLUmt0NncxMTJTajlH?=
 =?utf-8?B?SURPV1Z4eUtKS0RIbUw4TG16WWt6UDBwNGhDMUNLc2c1TlRRU1czbGVrbHZv?=
 =?utf-8?B?anQvMEV2bjk1OS9YRnRLcDV3OWNheE0yM3pDeGhUQkhGOUFRVk1BbmZVYkFw?=
 =?utf-8?B?S1dIQW5WZS81TkhLdFNXTnYyeGMxZkN4SmxWNkRldkpOVnRZQzlDSittalZw?=
 =?utf-8?B?eXErVCthc2hZcXRrZG93WithZnZ3eDUxVUs2R2RpYXpBK0VOanhHdWNhUU1x?=
 =?utf-8?B?TnBOVzQ0M0QwVFVuWmU2Q2hXZzFHdDRvdVg1blQ3bi9wakZZNm0xdE82ekRQ?=
 =?utf-8?B?Mm5vU2QxWmxHNi93VUd0RXZ6eC9MVkwrNWtPK3ExOWdNejczNzZ0YVF5WjFE?=
 =?utf-8?B?WFFIaFRjWW13cXdGeCtwUzEyRWhIZWJaNEJMeGZUTGZtUDczZUNONTArTElL?=
 =?utf-8?B?c3R3Qm1zcTVIZUpDamRjTmFQOEd6SXJIOExTdWVpNHI5bCtiR3NHcjhuZ0pj?=
 =?utf-8?B?Um8yYWRXam54VHR1NXFlQ0dESnlYNmVBdlVHeGljcVcyYzZPV0twSzdVbTY3?=
 =?utf-8?B?cEp2Sko5K2xkYVpyQjZRUVlTVTBsSUswM1VENmMra0RDQ09yTXJ5SXIvUENG?=
 =?utf-8?B?Y1VjZWZNZzk5N2F4V0hnNXBzaDNSamt1Rnh3MUhCd3ZLWUFROUJESjl2ay9p?=
 =?utf-8?B?WmlGVlBwcE9pTTVRM1g0TnBzMmFZeDZyL2RrS2g4M0VycDNHcVY5bUZ2S3VW?=
 =?utf-8?B?Vjg3d1RtMUNsWldCM2E2RzlkcWlwOG5XYnFjQzlsUDdORkxpdG9ua203NklB?=
 =?utf-8?B?YzBxeWNqM09kdlM2SHJndVJKNjFycVRhaDRqWE84dWJTL1JHZVhFS0hiVm0z?=
 =?utf-8?B?RUFRcFVNWS9Yc25SMk5LZE16bGlEemRkRWRQMHBuWEVIbHh1MVA1ZUFJY0Mr?=
 =?utf-8?B?TFlEaENiU2ZtS2o5WU1Ed01BL3huakw0VlFYU1I2eURjalpVdGkxaktLMXJw?=
 =?utf-8?B?RDY4RWZ4UWV5djJGNll3a2swYXNTQWllYlh0WngrYWk2dzI5RzJZRkpSTlB2?=
 =?utf-8?B?THNlbTE3cUJDSHo1aU9ha3U1d2JLV3hBS0pYT0dWVUNRdkN2MEF3QlUzQmhk?=
 =?utf-8?B?N216WURHcVpkeFNZWmIvY2hnMWd3dXVOZUtDdU5uZXNITlNWMmlFZnFYNUpR?=
 =?utf-8?B?N2d3eXV3UDk4eWNFZDNzYXhHR3hDK3V1TEw3TlptQVhHMDZYWXFSUW9tYnF3?=
 =?utf-8?B?ZVZMMkt4eDVUeG9QT09xVmcxREg4QnlqNGtqV1FXRGZ2bFRDSEFtbTZLaFRl?=
 =?utf-8?B?U1lCMWRvQksrQnpIYXlRdmFxOGd1OVhNV3RPNU1mckU2WVZUY0xXV1JNbEJT?=
 =?utf-8?B?S2ZKNHQvaGRQWmdPNUtLaGFRQzdmMTRYcWlWOGwvSVh1QndyazZJYlNLV3ZW?=
 =?utf-8?B?cmpEL2tLNmkzTGVUSmZlSC9QdnBkaGVCRG96QlJXbm9zSnAxTnYxK3IyYnZV?=
 =?utf-8?B?UUFiSnpWelhWd1JsMnZaeXZkQkZ5K1g1V0h2S3ZwR0N4VlZpYTdJckM0L3p3?=
 =?utf-8?B?WE9CbmQzalRtZWlJNDNMUGZmWVFGUnJBM1FuOVBFSEozdHRhSnJZQ3AyZ3JW?=
 =?utf-8?B?ZTZ2NU0vN2ExbXZ1VFd5SjU0WGRuVm5aWDBNZkp1NTVTd1lLeVFNY28zaVBL?=
 =?utf-8?B?UEZjaHFmam1CU2UyK01XbzhxL1hzcFNQWTY4UkxCMUF6T0ozSEtLNkhnY0VX?=
 =?utf-8?B?bStCbWdSOE5hNzRzWkpscmJNTlpaS3J0Nm5NMTcrZEprVDZsa1V1Mld6aE1B?=
 =?utf-8?B?dzd3UHdQUkNKNkMvaHF0N2d2NlFYclhMMGg4K1U1eDNjeDlqWGI5M1c0UUpB?=
 =?utf-8?B?QjVyWXNQV2hIaGJxZDA5VUplK3F1ZzlxWWZhTks2dVBFTEw1VGtUSlJ5NlI4?=
 =?utf-8?B?VnVYakhaSUdPYXdWa3l5TVBJR2RQNHo0S0lTaE9oVnhKMU1IYUU1VlVSQnhs?=
 =?utf-8?B?Zm43SXN6NlJzRnFhYU5hcmZJckZqQUpqbG13Q0crckJEMkQ4QXVjTjFBL0cv?=
 =?utf-8?B?MzFJN3lzcVRyQW03Z3g2Um1YSlppOUsvVTc1YThwQ1ZKY0dZM0xiKzIrRFVP?=
 =?utf-8?B?VmNJd2p6NzJxbzFpa290SWFwNjRrUlkxSGtYb1lpZUpEeS9SemxIOUhsQjdh?=
 =?utf-8?B?Mmc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <6A795E3A7406DC4A8EC1FADFAFF9457F@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: a87ae7be-d793-4a6d-4afb-08db0bc8a7f7
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 00:41:04.2267
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: rNwlxV4wbRQ14f/Y63GBrAmQUlYldu9/waWj1nrIWMtnBaUF5vO+7vBOBwt9s2vhbDv3Lp/KLb37HhxncADu4PlQJfSdYS8D2BiWO0Y5BbA=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB6031
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA2IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6DQo+
IEVtcHR5IGRyaXZlciByZW1vdmUgY2FsbGJhY2tzIGNhbiBqdXN0IGJlIGVsaWRlZC4NCj4gDQo+
IFJldmlld2VkLWJ5OiBKb25hdGhhbiBDYW1lcm9uIDxKb25hdGhhbi5DYW1lcm9uQGh1YXdlaS5j
b20+DQo+IFJldmlld2VkLWJ5OiBHcmVnb3J5IFByaWNlIDxncmVnb3J5LnByaWNlQG1lbXZlcmdl
LmNvbT4NCj4gVGVzdGVkLWJ5OiBGYW4gTmkgPGZhbi5uaUBzYW1zdW5nLmNvbT4NCj4gTGluazog
aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvci8xNjc1NjQ1NDI2NzkuODQ3MTQ2LjE3MTc0NDA0NzM4
ODE2MDUzMDY1LnN0Z2l0QGR3aWxsaWEyLXhmaC5qZi5pbnRlbC5jb20NCj4gU2lnbmVkLW9mZi1i
eTogRGFuIFdpbGxpYW1zIDxkYW4uai53aWxsaWFtc0BpbnRlbC5jb20+DQo+IC0tLQ0KPiDCoGRy
aXZlcnMvZGF4L2htZW0vaG1lbS5jIHzCoMKgwqAgNyAtLS0tLS0tDQo+IMKgMSBmaWxlIGNoYW5n
ZWQsIDcgZGVsZXRpb25zKC0pDQoNCkxvb2tzIGdvb2QsDQoNClJldmlld2VkLWJ5OiBWaXNoYWwg
VmVybWEgPHZpc2hhbC5sLnZlcm1hQGludGVsLmNvbT4NCg0KPiANCj4gZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZGF4L2htZW0vaG1lbS5jIGIvZHJpdmVycy9kYXgvaG1lbS9obWVtLmMNCj4gaW5kZXgg
MWJmMDQwZGJjODM0Li5jNzM1MWUwZGM4ZmYgMTAwNjQ0DQo+IC0tLSBhL2RyaXZlcnMvZGF4L2ht
ZW0vaG1lbS5jDQo+ICsrKyBiL2RyaXZlcnMvZGF4L2htZW0vaG1lbS5jDQo+IEBAIC00NCwxNSAr
NDQsOCBAQCBzdGF0aWMgaW50IGRheF9obWVtX3Byb2JlKHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2Ug
KnBkZXYpDQo+IMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gMDsNCj4gwqB9DQo+IMKgDQo+IC1zdGF0
aWMgaW50IGRheF9obWVtX3JlbW92ZShzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpwZGV2KQ0KPiAt
ew0KPiAtwqDCoMKgwqDCoMKgwqAvKiBkZXZtIGhhbmRsZXMgdGVhcmRvd24gKi8NCj4gLcKgwqDC
oMKgwqDCoMKgcmV0dXJuIDA7DQo+IC19DQo+IC0NCj4gwqBzdGF0aWMgc3RydWN0IHBsYXRmb3Jt
X2RyaXZlciBkYXhfaG1lbV9kcml2ZXIgPSB7DQo+IMKgwqDCoMKgwqDCoMKgwqAucHJvYmUgPSBk
YXhfaG1lbV9wcm9iZSwNCj4gLcKgwqDCoMKgwqDCoMKgLnJlbW92ZSA9IGRheF9obWVtX3JlbW92
ZSwNCj4gwqDCoMKgwqDCoMKgwqDCoC5kcml2ZXIgPSB7DQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgLm5hbWUgPSAiaG1lbSIsDQo+IMKgwqDCoMKgwqDCoMKgwqB9LA0KPiANCg0K

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6C332C636D7
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 01:03:22 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229576AbjBKBDV (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 20:03:21 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41282 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229455AbjBKBDU (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 20:03:20 -0500
Received: from mga06.intel.com (mga06b.intel.com [134.134.136.31])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D02BB75F52;
        Fri, 10 Feb 2023 17:03:19 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676077399; x=1707613399;
  h=date:from:to:cc:subject:message-id:references:
   content-transfer-encoding:in-reply-to:mime-version;
  bh=6gpOsIZ8MUGeiVRXXTaxmNPVnTOdpGuUiTCM0F6X5Jg=;
  b=D7xayXhRQl49W13F65aXUyQpuqS3QU4t63Nnk/2du8O/zli9mvJ4RI7M
   x4JvtF829hFNlZPK65ra0TxCLUyzpUgnLiVL17FMt5Q47rpPV3hM17CU6
   /toSvrCNMiLppYzh0tDVUs27sN9zPSFMy/kKImWyi7WDXlLTSCfI4oUpF
   4kxUMr+edGkCE3qj4kHdthBEqVT6fBib7P9zKFVg1TtMEhC5TnAuycDeJ
   4toaC/42qo/mUcXINPCcWOaPeyolJwiyrzCSOquCrkaov/64ppZp6i0ay
   fILvydcw6yR/9vZ17IDiqAlf2366Ys1PRczqD5awLDXaZ2w+OD3Qg92w2
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="392969688"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="392969688"
Received: from orsmga002.jf.intel.com ([10.7.209.21])
  by orsmga104.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 17:03:19 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="668238205"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="668238205"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orsmga002.jf.intel.com with ESMTP; 10 Feb 2023 17:03:18 -0800
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 17:03:18 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 17:03:17 -0800
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 17:03:17 -0800
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (104.47.59.168)
 by edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 17:03:17 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=cOaoknl7fXNUqOmBwyRCHeVJDQr6gfjk4CNP+6dSH9QFhjDkvmH2sWH68WT08bkdOoYWOE6odPP+JQYF/t5X5LbeqthugYXoNI+KYdEWAtLsAJ9PW6sN7c5Rgd4JNdQ23OPHqHg40GSKr6er6Bi2prhdho37ZDahZ6tzgtIs6FX3o5U8UMf1rQbwBVddFsC24dJ5iRLAEqCoH64y/zl4j2MehCWvrYRcUiCKR/YuFXroVv5NULq6cQWc3DzEOiqBgqexjz9cZYykQHUFGEDGSTBSTX5JEK/iFNdvWlhNZyeOjb6RsFjsEzMUoBFco8HmK9F9G1+moyRYXWRLZ52myg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=pMA8MgXNlYnt3xS2yLciMOFcMPl95aJSsscFChYNgGI=;
 b=JH54qeUZGKYcl7ZhH/3BwFh0HWGQxmD4VNfJSjk1CrWauYzUUxjR0Qkc8tpSrD5GVTC/nDHkOYtK+P6zzjAt0yvargT+t7jbqC+ykxuvDgBpXfTyzwAISMf0tyLDD9W33ZEay86fc950SayeFVsbD6C9oDTN0DNb2LlQ/e3+Mn4IATv/V79qi7HDOpHZSq01tOq+hciE5KCH35ftKBrXc8uubuWTAcuOPglY47og0VvYzYcBwC7/Z4zgWPH1kfR5Ni7j3A8HVzt5x9srKBd2XlhGbkYCgNXhegdWdvuRiK4A+BeI985w9tkujYkc11kveRGeXljnKiKt6ZQ81rFQDQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by CH3PR11MB8155.namprd11.prod.outlook.com (2603:10b6:610:164::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Sat, 11 Feb
 2023 01:03:15 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.020; Sat, 11 Feb 2023
 01:03:15 +0000
Date: Fri, 10 Feb 2023 17:03:13 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: "Verma, Vishal L" <vishal.l.verma@intel.com>,
        "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <63e6e95152384_1e534829443@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
 <4f10837c5dcc405eac2441aa78a5f2f388fb601a.camel@intel.com>
Content-Type: text/plain; charset="iso-8859-1"
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <4f10837c5dcc405eac2441aa78a5f2f388fb601a.camel@intel.com>
X-ClientProxiedBy: SJ0PR05CA0144.namprd05.prod.outlook.com
 (2603:10b6:a03:33d::29) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|CH3PR11MB8155:EE_
X-MS-Office365-Filtering-Correlation-Id: 18034563-d142-471a-bd68-08db0bcbc163
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: K/dhufrU5Awd3ICfgbFfPZ0LFxkIG87LjHHnBVYPgaQAh8CA8ozDYLxBV2qytmOWcosgQCBWWFOctu78Q6OXfn1OFYDVL5UoBj71WC53NkyCjG0tIb3SMclQqpG9jfZ1+4Y9chUYw/3QXe31yhc3hPwlz8cSTYfXiN/6kv75yP9GqvjcTHMqcGv/KQKtXUIQK5mfpcVLOppH+Q609jggzvwbrGbhuuEAxmsFtZSO2bfgt5aEHJdlOYm56TUbJ7jPHUPv226F62qrI8nCLXYNdCV5rSYh5pvM+db9Of9UTqSCQQbENaiLv0HMsmK/6eGdchBAvAZL1lZQ+pg7JEgzKbNn6XDOb632OzJdlCUlr9Uab48hDnXHan/IZ5bg9ZKt1ehT6B3WAP1YJNH9GFok7M+UcvpKy/cyPKKRARmnrYXxyN/SHKfTX4qDE98f07UqgTNGvgA+rlMv+c4686WmZbfAnu8E7aBG694MLVal9PzAviCS7xbt027V9k3gkXspG0QAXNPv0xc4o3hCKZBEwu3tv7dKj/1xloraMn2XmBxv0A0hjjHACsLHEzG33jA9teUL+UTV+v8aHYYxNqQqFsh61nGr/PXIjs4R7mjlkIx9rFqpX0IcQOKy1ldABrILktf5gIGkYv0TwIGUbqP9g2ImuGIk0xtTub+M53mVDG0=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(396003)(346002)(39860400002)(376002)(366004)(136003)(451199018)(86362001)(66556008)(4326008)(66476007)(66946007)(8676002)(41300700001)(5660300002)(8936002)(2906002)(82960400001)(38100700002)(6506007)(6512007)(316002)(186003)(26005)(110136005)(966005)(54906003)(478600001)(6486002)(9686003)(83380400001);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?iso-8859-1?Q?+OASBuUrkb0eLHCgEBO3jmpVmyZOM+6ipgyS7nP0vPyewr5nAEN6Jm6Kxp?=
 =?iso-8859-1?Q?ASuNhhRKLyMWQ49kPt1pJfFsn1wgBHEy5iiZlfHpJvGonYVlW9htZL7i0w?=
 =?iso-8859-1?Q?sR8VoVkc+yZLgjyEVh8Wl59SZkzdcTC9wso5e8RGPPEW66HrhB7a3Ofknn?=
 =?iso-8859-1?Q?a+1el8NdChQT3y4Y4JZy/Vy/qiQttP4Sslzlmv6stvjPOaFJ1HPc1ygOp9?=
 =?iso-8859-1?Q?dZqnjymuhir1jQFE4jiIecHKt1Gq4B0eeeZDWKm3bDe2m7pt7eUeKKSK6B?=
 =?iso-8859-1?Q?xk3PcHigMOxmPBpEWuldtVu7J4s0Cs3FYW8Y8LklnZapOnOLVEPdgSsz30?=
 =?iso-8859-1?Q?Rrctgk0bs3sLBq8kptXwSsqOfWDX0D6J0wfo01fkoolHjw9qSOx/avdrQz?=
 =?iso-8859-1?Q?Qgu3eHbH6QIck6/Z/CEs0D09aOnT2x2sDzuOEqAIDoceACpRteeipLTEwF?=
 =?iso-8859-1?Q?bKfAHa1jEfhVfNh9VKrjL5jX2Kk7QF0x/GXpxhxVWmdhowEPlxOzClvapM?=
 =?iso-8859-1?Q?5E0O+LAPknlDZZt1RO5uCjkAQOFVozWvHHBaePbxy8VTfrVu3x8y9RWRvz?=
 =?iso-8859-1?Q?qJ5t1J7QWZfF+RR2k4FA40i69smH3ynToO13aU42Tj/7ZvRH4Gb8NQEdiq?=
 =?iso-8859-1?Q?ToB02dT1I+NqTA2mN8G1NviGmzTTk54l993cnb8X4APZ3FYjMPQIsHPtoV?=
 =?iso-8859-1?Q?jagCp4+s32qjYU/g/ei5Ev8s6Dmy65RmuQXGEQeZk7TNz9ZSxbiVDojq1r?=
 =?iso-8859-1?Q?2m5hqYlTqeGBLyDiSZqzP3IN3rYw+5lISegg65K+5R/s+BS5pwwAafur0M?=
 =?iso-8859-1?Q?0Y/0ShBVj3NrXWkNH9v1qFg/pE+V3QK2i7zn6ltWumpIafT2ccp+h+Klje?=
 =?iso-8859-1?Q?d4OeByR7YOScMfdOzC0MmVOOZKmugPs61kdpCISGy1LKRQh3q1Sq2twFsC?=
 =?iso-8859-1?Q?DDR9OzTzSSBLFBjla5GNpckhHYEk9PqPNqPL+KL/8MVp5p3RUCQFpHY21w?=
 =?iso-8859-1?Q?Pt+faC9oWeSqlB6IW4Es2vy1+ll87m7T7LH6uOzZVC1aCyMuHOWC1+kq6a?=
 =?iso-8859-1?Q?Mh4n1ibnyuac/u3rI1/VL6kxJSmjzLwPCGC7fysJxHmAw+rMqhGnvuyMO1?=
 =?iso-8859-1?Q?2HwJklczpxatzusoGNh1B0fKRiZvKIcr37qsxLp2ol0QfoCqU5UPWiVRap?=
 =?iso-8859-1?Q?9md6Wly+qgLeZ6t/cMlb98iCl09GUVa/zOspQhQANrAOMSxV203r/guGeH?=
 =?iso-8859-1?Q?gplJNZ0FDvWKncV/1o5hVRUACtTuz8yM8SMQmbCQV3EOnZvN1PW7rtlYCr?=
 =?iso-8859-1?Q?m1lMgHxV2w456BYB6mMlST5RTKfKeOT18mbhfXlAHTCWitBb/IThDAMrIH?=
 =?iso-8859-1?Q?YJgmPKPOEuV03+P6oOIrP31pjGPfGnS+nfsoPfvyqEBbCcEwoij4NC2Yxy?=
 =?iso-8859-1?Q?XG7r52h7+pKojZebycssXSQjHnOT52KdBvpmHGEDGxwH0sUnXJSwTlTC7h?=
 =?iso-8859-1?Q?CQEaskybRAEWeijCwvxaV1evlUkKnWAtyIW71lvHRGCD5B/3M81AVcklSQ?=
 =?iso-8859-1?Q?KsaYEkbK8WqY9/AuDmGDg/o47zr++SDav16GkpJDFhavxHXcY9xPO+kFXU?=
 =?iso-8859-1?Q?m5VFeyAKhU1tbo2pVEE3m/WGjJO9pELCkrjmNmSG2C5cLOWCEagxopXw?=
 =?iso-8859-1?Q?=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 18034563-d142-471a-bd68-08db0bcbc163
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 11 Feb 2023 01:03:15.5425
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 2U1H8ALrgsO4z2l1c2gSYx27RzfxlXvaXm/8S/B3eECfxxe6TfctT+zwEs2u1BzU0vt3MamRWnu5yUQ+6AVh0uceXzUTPHtXgzABLMe7Rao=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR11MB8155
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Verma, Vishal L wrote:
> On Fri, 2023-02-10 at 01:06 -0800, Dan Williams wrote:
> > Region autodiscovery is an asynchronous state machine advanced by
> > cxl_port_probe(). After the decoders on an endpoint port are enumerated
> > they are scanned for actively enabled instances. Each active decoder is
> > flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> > If a region does not already exist for the address range setting of the
> > decoder one is created. That creation process may race with other
> > decoders of the same region being discovered since cxl_port_probe() is
> > asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> > introduced to mitigate that race.
> > 
> > Once all decoders have arrived, "p->nr_targets == p->interleave_ways",
> > they are sorted by their relative decode position. The sort algorithm
> > involves finding the point in the cxl_port topology where one leg of the
> > decode leads to deviceA and the other deviceB. At that point in the
> > topology the target order in the 'struct cxl_switch_decoder' indicates
> > the relative position of those endpoint decoders in the region.
> > 
> > > From that point the region goes through the same setup and validation
> > steps as user-created regions, but instead of programming the decoders
> > it validates that driver would have written the same values to the
> > decoders as were already present.
> > 
> > Tested-by: Fan Ni <fan.ni@samsung.com>
> > Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.stgit@dwillia2-xfh.jf.intel.com
> > Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> > ---
> > drivers/cxl/core/hdm.c | 11 +
> > drivers/cxl/core/port.c | 2 
> > drivers/cxl/core/region.c | 497 ++++++++++++++++++++++++++++++++++++++++++++-
> > drivers/cxl/cxl.h | 29 +++
> > drivers/cxl/port.c | 48 ++++
> > 5 files changed, 576 insertions(+), 11 deletions(-)
> > 
> > 
> One question below, but otherwise looks good,
> 
> Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
> 
> <..>
> 
> > 
> > +static int cxl_region_attach_auto(struct cxl_region *cxlr,
> > + struct cxl_endpoint_decoder *cxled, int pos)
> > +{
> > +struct cxl_region_params *p = &cxlr->params;
> > +
> > +if (cxled->state != CXL_DECODER_STATE_AUTO) {
> > +dev_err(&cxlr->dev,
> > +"%s: unable to add decoder to autodetected region\n",
> > +dev_name(&cxled->cxld.dev));
> > +return -EINVAL;
> > +}
> > +
> > +if (pos >= 0) {
> > +dev_dbg(&cxlr->dev, "%s: expected auto position, not %d\n",
> > +dev_name(&cxled->cxld.dev), pos);
> > +return -EINVAL;
> > +}
> > +
> > +if (p->nr_targets >= p->interleave_ways) {
> > +dev_err(&cxlr->dev, "%s: no more target slots available\n",
> > +dev_name(&cxled->cxld.dev));
> > +return -ENXIO;
> > +}
> > +
> > +/*
> > + * Temporarily record the endpoint decoder into the target array. Yes,
> > + * this means that userspace can view devices in the wrong position
> > + * before the region activates, and must be careful to understand when
> > + * it might be racing region autodiscovery.
> > + */
> 
> Would it be worthwhile adding an attribute around this - either to
> distinguish an auto-assembled region from a user-created one, or
> perhaps better - something to mark the assembly complete? cxl-list
> doesn't have to display this attribute as is, but maybe it can make a
> decision to mark it as idle while assembly is pending, or maybe even
> refuse to add_cxl_region() for it entirely?
> 
> This can be a follow-on too.

"Assembly complete" is determined by "commit" going active. What about
all of the "targetX" attributes printing the decoder-name out with a prefix
like:

    "auto:decoderX.Y"

...that way userspace can both see what candidate decoders the kernel is
considering, and the fact that assembly is still in progress (or
stalled).

The concern thought is breaking legacy that only ever expects to read
decoder names there... guess it depends on how bad the failure mode is.

Instead, maybe a new attribute like "origin" that returns "manual" vs
"auto"?

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D2ED5C61DA4
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 04:25:30 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229604AbjBKEZ3 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 23:25:29 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36928 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229447AbjBKEZ2 (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 23:25:28 -0500
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 90DD6821B6;
        Fri, 10 Feb 2023 20:25:26 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676089526; x=1707625526;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=AnKN2daaHaaWFuMwoe1D9+KaG/c5U7QazlY+lYf2rrc=;
  b=fifvr8JTz65ulQDfQv7j8IVgQij4AaNL53Zlvow75ojIHqBYN15oCUHB
   N3mzqLVx5wAgTXcd6MnSeO7NkjuZ/pB/JGjVk3yubAY+Idcxg3C5PZFmB
   HSHjP8RBa+YM5yQNhJGbDVoCvtn+jjBOTYvsPY20eZ35+Z9sbAub5z2+G
   kC+6orBCge/xhM6a5X2DvpImNkmSzzCk83q5fPBB7Ba1WCeNi4KC+5j3t
   cGiT17wL+N9SwOSeBaS6QNgwvpmL3FfBbpdRSTay/ODRrA5/J/GBScQa5
   bQDO9Njhi5oI93vGnJZP8DzAec+9SZyOuJrZSVNlK/bs5UIfOUyx660i6
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310214092"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="310214092"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 20:25:26 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="700681760"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="700681760"
Received: from fmsmsx603.amr.corp.intel.com ([10.18.126.83])
  by orsmga001.jf.intel.com with ESMTP; 10 Feb 2023 20:25:25 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 20:25:25 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 20:25:24 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 20:25:24 -0800
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (104.47.70.105)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 20:25:22 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=KLyv43HdS2ouG1zwDECImAgio54Kj9HoiXN92YYkCh/ImglVjwsT0HtwYv8mqYHVPMKaKScHy3mmx9DGGV37uz2dkxiYQzTymePKcx5tUBFkZqUO0SWrzzghlXVtyoru6rK9ulRk/B+TW3RPkYyxWbgFfr3z/fA+KIyowjljSCsOxg8oG/caTm/IYquDWCHpRwJU2x7vQAjt+b1tvvUEpMBSTg2n4P76bmB9p0Gqw8uHO9l7yUxOpZg/3Hxv8xXcKhr1l1DCyJMLq3QDnA05TkRyATIjazCUwO7i+WUNOQhj8gLBI8A571+MkLpr24m1yb5opK32ly8V5+08Xr3Epw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=AnKN2daaHaaWFuMwoe1D9+KaG/c5U7QazlY+lYf2rrc=;
 b=WUjKGL+AQO+K2rRwzlglCf+fgI486nGT5jZpGmMwWzRre+aZC9ByGQAZ6/2mPlvmoUO2ul1Wyy1qVgCNT7KX94QtjHqL8qQ63WTtiTURe59SqdY2k/DUaxcH5lcxMsCbKkkNR40W5Hwr/9ohRiOdC4xaX0PuYerTQD8tnuWWGivuTABNu5+EHhihJgPUGi1uX31eGH/J23c7MCa22FasQ819NsWy6Hqr40InR0ClbX0RpJHIiKY7zITB4U+Rj7cntpyUDpVnZyF5RNJFUak9QjVLhuG35ii0+DwbydoAIywf+6uTDQh+IICJ1Byru3EiNDcgns+SuEKX6JdMb1z5jg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by SA1PR11MB6896.namprd11.prod.outlook.com (2603:10b6:806:2bd::8) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Sat, 11 Feb
 2023 04:25:20 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 04:25:20 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "Jonathan.Cameron@huawei.com" <Jonathan.Cameron@huawei.com>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 17/20] dax/hmem: Convey the dax range via
 memregion_info()
Thread-Topic: [PATCH v2 17/20] dax/hmem: Convey the dax range via
 memregion_info()
Thread-Index: AQHZPS8RPrzdNxCjpUGnkRmKWIqfba7JJ1GA
Date: Sat, 11 Feb 2023 04:25:19 +0000
Message-ID: <59b99a2c6594581e32da528da32483caed1b1da5.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602002217.1924368.7036275892522551624.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602002217.1924368.7036275892522551624.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|SA1PR11MB6896:EE_
x-ms-office365-filtering-correlation-id: 8167b9de-4fcb-4948-53ce-08db0be7fbd9
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: +0fhFgxXu18oTgGYmpHSMtNotSDKmToiKqvBVlNzQpOoIOuRoVdA2qLNcypi9J93snHMpPMXXOZGD91OfH0PywLfvxin3dHZEIOF3VlfEvZLyd4RvWniNtYtJLXjufm8GRvIhIhuipIzRLnlII7p8sdp/kcIbxf9wmtbMU+4B4g7oi5oFmGSA0mc2RkRE8a29fDi54nxPeGWINWmkVq2yUN8G+pihlH/OFWzRk/zoY6dBzvpZgfv1CTJmFVGHDCLQg2gU+gxqRCkIIuSV1CNzIM8etZKH0x5njM6i0X0RUhTVrjExznEP/vlNFp72SBPskfgAC+nFTeNkt5orX9KH6henBaYyscYo/ZRKkjjPlWDGSJwIYdPdNIx7NtjfWrIN7oxfhoq9jArnuTlSQBEAIUwBGi+emuIeombgUh2TMnVnI3NUrYoF5OlPA2zVzEHi8oIcDVzhfQm/w3BDrlebMwBU4Wh+zAt8rF4ghoHoMCOudeSk9kzmSkNHgoLiOT4dJpLfGM5ANp729FtBrJdHp1BVhER8mG0QnUMXBNi50k/v/WQ29TcV2hslIuNCN7i8XpiohKD8CalyWYJmv3b5woO1erW7QENOBLaAfYioUpizRFc9yZ/PRTXTFF6GAuKJM92xTPKJiWpkOIDQmEKMMW/pYGkUBeVSzEYe6ShZk4Hwq6fvkmDDwkl2e+yAW6A6zqXYiz3680ukzC8SwMqagoHx8e5xAk6uZktd4yNRBs=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(396003)(346002)(376002)(366004)(39860400002)(136003)(451199018)(86362001)(38070700005)(66556008)(8676002)(64756008)(66446008)(4326008)(66476007)(66946007)(76116006)(41300700001)(91956017)(5660300002)(8936002)(2906002)(36756003)(82960400001)(122000001)(38100700002)(6506007)(6512007)(316002)(186003)(71200400001)(26005)(966005)(54906003)(110136005)(478600001)(6486002)(2616005)(83380400001);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?eXl1SEJKM0JyM2IvWGl1eEtZM0xNelFDemFLRjlldHlacXB5dU1nVUd2N0t0?=
 =?utf-8?B?NTFxdkdHajVRclJDRXM3OU96dU9STFBXMVRWUUVlb2hSay9SRDVlaXJRemk3?=
 =?utf-8?B?VlRkR3V4dWR3YjJOdnA5V3JPNGVEVUdINklKY2VYYzdRM3M0ajdIbkJHSlMw?=
 =?utf-8?B?ZzFNMlpqUHpSY3ZSV0VwdUU3SXNjbGE1eGdyTUd2NlJLQi9rTGZLeXl1R2wy?=
 =?utf-8?B?dXdOZ28wZkt2S0hUbVMwZTdHMWdSK1ZCT1NZTTZCazVhNW9BOFpuM0t6aWVz?=
 =?utf-8?B?VXUvOFVnK2cyelpsUzVhemcxSXdkVHJlRFNrcTE5c1oxQzdOcUYvQ3F4RTVB?=
 =?utf-8?B?SGN5UU1pTk5iV2lmZTB3OGdSdDNKYklKTFVpZWFGOGwremthSk1YOEZoM3Nl?=
 =?utf-8?B?SjdUVVFJcm1hYWxab3VOZWt5RUxHYkxSRWZTZWlHRHg2MWYvYjNVOGdZMEJt?=
 =?utf-8?B?dnlZOExlMmNVZFJ3ZlNEUUw3L2dPbnRyYU1aTnBoNVFyWTV0TkNpZ29VeDF1?=
 =?utf-8?B?TmR3MnlidjFCRHR0WDR0WTFyUkI0WVh5SXRQb05oN3JKWjdzZkpESGVLKzAy?=
 =?utf-8?B?dDJYVmxXZ3Y1em5aY1ZpQm14RkVuMGRsSm90bkFiVXBpSFVFUHBwQWhBd2pV?=
 =?utf-8?B?OW1IV3J3Z3NVT2pFbklzSXRIc0lhOG1kL0o3WlRpMSszZTBZOXc2N2piMEJO?=
 =?utf-8?B?OFU1ei9YTURkZElvbmhYSjN5TnVHbFNZU0NTbm1YaG5sWlBSbTFYYnpFd0Jm?=
 =?utf-8?B?QjgxWWtaS3prN1hmWHhJY1VFMEhEazdENzdFeDBzamlZK3VvQk83aHh0aWJ2?=
 =?utf-8?B?Wll5S2RtQzFmZlV1NDVrYUR3bFhzVkxNOTRhQXdjeUFpdkkxRGdVSUkzZFly?=
 =?utf-8?B?TUNKeEpPcE5YdmdrRUl5dHBhVk8wejJGUFF1UzFpNmcrbzd3RTVSZWlKOTIv?=
 =?utf-8?B?d1QzZHlZZzB5U28xQzBOYmZkZjZhOTRtNkU3QTZtcEFXcllJU25BR1MxY3FU?=
 =?utf-8?B?eUl1V1Q5T0JVWFhtWlJUYngrd1lYK25LZ1lpNlpZSjJLN2g5M2c1Vnc1RWw0?=
 =?utf-8?B?QkNVUFA0anZ4NTlvWHp0SzRWZlFBWGowN0xSenEveTlKekk3Y0dxSmVLOTJo?=
 =?utf-8?B?WWg0NUgwdm9oNmpwODhYaTRrWUxQK0pzd0tLZHFZOUFENmNHTTNtYi9qYTcv?=
 =?utf-8?B?Z2c2VVcwNm42ZGNJb0dNWFJnSldIK1oydUQvV09NdzRtMHZocGxUSlBDdW9M?=
 =?utf-8?B?NnBKY1BneXQxSUh3UURkcUdqbGxVYW5OVDZIM005WWsvV0swS1p5dUZySG5R?=
 =?utf-8?B?dkFlM01HY2Fxa2RXSmlZYUxIU05PTzZWTXVlKy9CaUZWYllSaFpCeFo1UUE3?=
 =?utf-8?B?Y2htSWVXTEFHU2R2M1EySWQ4MEVxeXlVK1dIdjZXejJwNkZUelR3SStYRHFI?=
 =?utf-8?B?RXdJc0FGUlpDYVdscjVTNG12dWJzWm11UFdqWVNtKzNlYjNreUVqZ2oyQmF5?=
 =?utf-8?B?UVE1TXp5dWNaMGVmVFlKUEVab011aC9MSVB3S0ljOWlseXRHK2RyYTFOSDd6?=
 =?utf-8?B?RStuWXRxK2RLQTNPWjRoa2M5ZGYza05wZ1NySElyb0xTNm93ZlFsUHFPN2lU?=
 =?utf-8?B?dStNVEtzYXd0bFF2NFRtdU5MazgxcWFyVUxzallHY2ZQdzdMZHlCVTZmSTZB?=
 =?utf-8?B?OWtaTkFoQXkrNVEvUm9ESjBtdUtmdmFJdDZWK0p6cjZ5V1VCbzBqVHRrSzcv?=
 =?utf-8?B?VG5lazY0UDBvcFpwZlhyQ25GTHptTDBZTmtlSWZLc1hQM1BvM1dVMEYvR0tU?=
 =?utf-8?B?dTZjUkxQOW9GLzkyaUV3eXc2TDNjNlJ3VXNoc0J1ZHVHREgveHFscGJMeFg3?=
 =?utf-8?B?T3RldG5nc05NVlpsZ1h0RlVxRDYxZkNXYzc5U3lHNG1welNZeW1icnpTWGQ0?=
 =?utf-8?B?a2dhVVhhb24wbUxKN1BxVG5zZExYYVZRLy84MTBzV3htZEczbEs2Tnk1OXBa?=
 =?utf-8?B?Y0lJeGowTERxTTl1ZFVzVUZ3dExuMGJsd2FQaGUrMFpmaEExVkRtcVBQcitP?=
 =?utf-8?B?dFI2RVdFNHVFMFMyNEUyOElUS0ZGT3lwVmVjOS8vWjBOQTJIdlRuTEhlMWJr?=
 =?utf-8?B?SUQzTjZLTzBoQXduOE50OXdZR2cwSmNzOVp2dkZKcVNrSmNaUm11cFJ0WEFV?=
 =?utf-8?B?VGc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <712C24B4755C5948999A5C668631CD5D@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8167b9de-4fcb-4948-53ce-08db0be7fbd9
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 04:25:19.3263
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: 03zscMGMVvEKt79yeeAs3b8mJz4MN1QoTzTCaTzGw+rhq9XjlCxZ2W2jIcH7h3GTklEa5sPS4JQ9dyApL+BazUAzlN8sq2MojETSQLRcMDw=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR11MB6896
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA3IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
SW4gcHJlcGFyYXRpb24gZm9yIGhtZW0gcGxhdGZvcm0gZGV2aWNlcyB0byBiZSB1bnJlZ2lzdGVy
ZWQsIHN0b3AgdXNpbmcKPiBwbGF0Zm9ybV9kZXZpY2VfYWRkX3Jlc291cmNlcygpIHRvIGNvbnZl
eSB0aGUgYWRkcmVzcyByYW5nZS4gVGhlCj4gcGxhdGZvcm1fZGV2aWNlX2FkZF9yZXNvdXJjZXMo
KSBBUEkgY2F1c2VzIGFuIGV4aXN0aW5nICJTb2Z0IFJlc2VydmVkIgo+IGlvbWVtIHJlc291cmNl
IHRvIGJlIHJlLXBhcmVudGVkIHVuZGVyIGFuIGluc2VydGVkIHBsYXRmb3JtIGRldmljZQo+IHJl
c291cmNlLiBXaGVuIHRoYXQgcGxhdGZvcm0gZGV2aWNlIGlzIGRlbGV0ZWQgaXQgcmVtb3ZlcyB0
aGUgcGxhdGZvcm0KPiBkZXZpY2UgcmVzb3VyY2UgYW5kIGFsbCBjaGlsZHJlbi4KPiAKPiBJbnN0
ZWFkLCBpdCBpcyBzdWZmaWNpZW50IHRvIGNvbnZleSBqdXN0IHRoZSBhZGRyZXNzIHJhbmdlIGFu
ZCBsZXQKPiByZXF1ZXN0X21lbV9yZWdpb24oKSBpbnNlcnQgcmVzb3VyY2VzIHRvIGluZGljYXRl
IHRoZSBkZXZpY2VzIGFjdGl2ZSBpbgo+IHRoZSByYW5nZS4gVGhpcyBhbGxvd3MgdGhlICJTb2Z0
IFJlc2VydmVkIiByZXNvdXJjZSB0byBiZSByZS1lbnVtZXJhdGVkCj4gdXBvbiB0aGUgbmV4dCBw
cm9iZSBldmVudC4KPiAKPiBSZXZpZXdlZC1ieTogSm9uYXRoYW4gQ2FtZXJvbiA8Sm9uYXRoYW4u
Q2FtZXJvbkBodWF3ZWkuY29tPgo+IFRlc3RlZC1ieTogRmFuIE5pIDxmYW4ubmlAc2Ftc3VuZy5j
b20+Cj4gTGluazogaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvci8xNjc1NjQ1NDMzMDMuODQ3MTQ2
LjExMDQ1ODk1MjEzMzE4NjQ4NDQxLnN0Z2l0QGR3aWxsaWEyLXhmaC5qZi5pbnRlbC5jb20KPiBT
aWduZWQtb2ZmLWJ5OiBEYW4gV2lsbGlhbXMgPGRhbi5qLndpbGxpYW1zQGludGVsLmNvbT4KPiAt
LS0KPiDCoGRyaXZlcnMvZGF4L2htZW0vZGV2aWNlLmMgfMKgwqAgMzcgKysrKysrKysrKysrKyst
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLQo+IMKgZHJpdmVycy9kYXgvaG1lbS9obWVtLmPCoMKgIHzC
oMKgIDE0ICsrKy0tLS0tLS0tLS0tCj4gwqBpbmNsdWRlL2xpbnV4L21lbXJlZ2lvbi5oIHzCoMKg
wqAgMiArKwo+IMKgMyBmaWxlcyBjaGFuZ2VkLCAxOSBpbnNlcnRpb25zKCspLCAzNCBkZWxldGlv
bnMoLSkKCkxvb2tzIGdvb2QsCgpSZXZpZXdlZC1ieTogVmlzaGFsIFZlcm1hIDx2aXNoYWwubC52
ZXJtYUBpbnRlbC5jb20+Cgo+IAo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2RheC9obWVtL2Rldmlj
ZS5jIGIvZHJpdmVycy9kYXgvaG1lbS9kZXZpY2UuYwo+IGluZGV4IDIwNzQ5YzdmYWI4MS4uYjFi
MzM5YmNjZmU1IDEwMDY0NAo+IC0tLSBhL2RyaXZlcnMvZGF4L2htZW0vZGV2aWNlLmMKPiArKysg
Yi9kcml2ZXJzL2RheC9obWVtL2RldmljZS5jCj4gQEAgLTE1LDE1ICsxNSw4IEBAIHN0YXRpYyBz
dHJ1Y3QgcmVzb3VyY2UgaG1lbV9hY3RpdmUgPSB7Cj4gwqDCoMKgwqDCoMKgwqDCoC5mbGFncyA9
IElPUkVTT1VSQ0VfTUVNLAo+IMKgfTsKPiDCoAo+IC12b2lkIGhtZW1fcmVnaXN0ZXJfZGV2aWNl
KGludCB0YXJnZXRfbmlkLCBzdHJ1Y3QgcmVzb3VyY2UgKnIpCj4gK3ZvaWQgaG1lbV9yZWdpc3Rl
cl9kZXZpY2UoaW50IHRhcmdldF9uaWQsIHN0cnVjdCByZXNvdXJjZSAqcmVzKQo+IMKgewo+IC3C
oMKgwqDCoMKgwqDCoC8qIGRlZmluZSBhIGNsZWFuIC8gbm9uLWJ1c3kgcmVzb3VyY2UgZm9yIHRo
ZSBwbGF0Zm9ybSBkZXZpY2UgKi8KPiAtwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgcmVzb3VyY2UgcmVz
ID0gewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAuc3RhcnQgPSByLT5zdGFydCwK
PiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmVuZCA9IHItPmVuZCwKPiAtwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmZsYWdzID0gSU9SRVNPVVJDRV9NRU0sCj4gLcKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC5kZXNjID0gSU9SRVNfREVTQ19TT0ZUX1JFU0VSVkVE
LAo+IC3CoMKgwqDCoMKgwqDCoH07Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBwbGF0Zm9ybV9k
ZXZpY2UgKnBkZXY7Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBtZW1yZWdpb25faW5mbyBpbmZv
Owo+IMKgwqDCoMKgwqDCoMKgwqBpbnQgcmMsIGlkOwo+IEBAIC0zMSw1NSArMjQsNTMgQEAgdm9p
ZCBobWVtX3JlZ2lzdGVyX2RldmljZShpbnQgdGFyZ2V0X25pZCwgc3RydWN0IHJlc291cmNlICpy
KQo+IMKgwqDCoMKgwqDCoMKgwqBpZiAobm9obWVtKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgcmV0dXJuOwo+IMKgCj4gLcKgwqDCoMKgwqDCoMKgcmMgPSByZWdpb25faW50ZXJz
ZWN0cyhyZXMuc3RhcnQsIHJlc291cmNlX3NpemUoJnJlcyksIElPUkVTT1VSQ0VfTUVNLAo+IC3C
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgSU9SRVNfREVTQ19T
T0ZUX1JFU0VSVkVEKTsKPiArwqDCoMKgwqDCoMKgwqByYyA9IHJlZ2lvbl9pbnRlcnNlY3RzKHJl
cy0+c3RhcnQsIHJlc291cmNlX3NpemUocmVzKSwgSU9SRVNPVVJDRV9NRU0sCj4gK8KgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAgSU9SRVNf
REVTQ19TT0ZUX1JFU0VSVkVEKTsKPiDCoMKgwqDCoMKgwqDCoMKgaWYgKHJjICE9IFJFR0lPTl9J
TlRFUlNFQ1RTKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuOwo+IMKg
Cj4gwqDCoMKgwqDCoMKgwqDCoGlkID0gbWVtcmVnaW9uX2FsbG9jKEdGUF9LRVJORUwpOwo+IMKg
wqDCoMKgwqDCoMKgwqBpZiAoaWQgPCAwKSB7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoHByX2VycigibWVtcmVnaW9uIGFsbG9jYXRpb24gZmFpbHVyZSBmb3IgJXByXG4iLCAmcmVz
KTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcHJfZXJyKCJtZW1yZWdpb24gYWxs
b2NhdGlvbiBmYWlsdXJlIGZvciAlcHJcbiIsIHJlcyk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqByZXR1cm47Cj4gwqDCoMKgwqDCoMKgwqDCoH0KPiDCoAo+IMKgwqDCoMKgwqDC
oMKgwqBwZGV2ID0gcGxhdGZvcm1fZGV2aWNlX2FsbG9jKCJobWVtIiwgaWQpOwo+IMKgwqDCoMKg
wqDCoMKgwqBpZiAoIXBkZXYpIHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcHJf
ZXJyKCJobWVtIGRldmljZSBhbGxvY2F0aW9uIGZhaWx1cmUgZm9yICVwclxuIiwgJnJlcyk7Cj4g
K8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHByX2VycigiaG1lbSBkZXZpY2UgYWxsb2Nh
dGlvbiBmYWlsdXJlIGZvciAlcHJcbiIsIHJlcyk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqBnb3RvIG91dF9wZGV2Owo+IMKgwqDCoMKgwqDCoMKgwqB9Cj4gwqAKPiAtwqDCoMKg
wqDCoMKgwqBpZiAoIV9fcmVxdWVzdF9yZWdpb24oJmhtZW1fYWN0aXZlLCByZXMuc3RhcnQsIHJl
c291cmNlX3NpemUoJnJlcyksCj4gK8KgwqDCoMKgwqDCoMKgaWYgKCFfX3JlcXVlc3RfcmVnaW9u
KCZobWVtX2FjdGl2ZSwgcmVzLT5zdGFydCwgcmVzb3VyY2Vfc2l6ZShyZXMpLAo+IMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAgZGV2X25h
bWUoJnBkZXYtPmRldiksIDApKSB7Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGRl
dl9kYmcoJnBkZXYtPmRldiwgImhtZW0gcmFuZ2UgJXByIGFscmVhZHkgYWN0aXZlXG4iLCAmcmVz
KTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X2RiZygmcGRldi0+ZGV2LCAi
aG1lbSByYW5nZSAlcHIgYWxyZWFkeSBhY3RpdmVcbiIsIHJlcyk7Cj4gwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqBnb3RvIG91dF9hY3RpdmU7Cj4gwqDCoMKgwqDCoMKgwqDCoH0KPiDC
oAo+IMKgwqDCoMKgwqDCoMKgwqBwZGV2LT5kZXYubnVtYV9ub2RlID0gbnVtYV9tYXBfdG9fb25s
aW5lX25vZGUodGFyZ2V0X25pZCk7Cj4gwqDCoMKgwqDCoMKgwqDCoGluZm8gPSAoc3RydWN0IG1l
bXJlZ2lvbl9pbmZvKSB7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAudGFyZ2V0
X25vZGUgPSB0YXJnZXRfbmlkLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAucmFu
Z2UgPSB7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAu
c3RhcnQgPSByZXMtPnN0YXJ0LAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgLmVuZCA9IHJlcy0+ZW5kLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqB9LAo+IMKgwqDCoMKgwqDCoMKgwqB9Owo+IMKgwqDCoMKgwqDCoMKgwqByYyA9IHBsYXRm
b3JtX2RldmljZV9hZGRfZGF0YShwZGV2LCAmaW5mbywgc2l6ZW9mKGluZm8pKTsKPiDCoMKgwqDC
oMKgwqDCoMKgaWYgKHJjIDwgMCkgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBw
cl9lcnIoImhtZW0gbWVtcmVnaW9uX2luZm8gYWxsb2NhdGlvbiBmYWlsdXJlIGZvciAlcHJcbiIs
ICZyZXMpOwo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBnb3RvIG91dF9yZXNvdXJj
ZTsKPiAtwqDCoMKgwqDCoMKgwqB9Cj4gLQo+IC3CoMKgwqDCoMKgwqDCoHJjID0gcGxhdGZvcm1f
ZGV2aWNlX2FkZF9yZXNvdXJjZXMocGRldiwgJnJlcywgMSk7Cj4gLcKgwqDCoMKgwqDCoMKgaWYg
KHJjIDwgMCkgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwcl9lcnIoImhtZW0g
cmVzb3VyY2UgYWxsb2NhdGlvbiBmYWlsdXJlIGZvciAlcHJcbiIsICZyZXMpOwo+ICvCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwcl9lcnIoImhtZW0gbWVtcmVnaW9uX2luZm8gYWxsb2Nh
dGlvbiBmYWlsdXJlIGZvciAlcHJcbiIsIHJlcyk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqBnb3RvIG91dF9yZXNvdXJjZTsKPiDCoMKgwqDCoMKgwqDCoMKgfQo+IMKgCj4gwqDC
oMKgwqDCoMKgwqDCoHJjID0gcGxhdGZvcm1fZGV2aWNlX2FkZChwZGV2KTsKPiDCoMKgwqDCoMKg
wqDCoMKgaWYgKHJjIDwgMCkgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBkZXZf
ZXJyKCZwZGV2LT5kZXYsICJkZXZpY2UgYWRkIGZhaWxlZCBmb3IgJXByXG4iLCAmcmVzKTsKPiAr
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X2VycigmcGRldi0+ZGV2LCAiZGV2aWNl
IGFkZCBmYWlsZWQgZm9yICVwclxuIiwgcmVzKTsKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoGdvdG8gb3V0X3Jlc291cmNlOwo+IMKgwqDCoMKgwqDCoMKgwqB9Cj4gwqAKPiDCoMKg
wqDCoMKgwqDCoMKgcmV0dXJuOwo+IMKgCj4gwqBvdXRfcmVzb3VyY2U6Cj4gLcKgwqDCoMKgwqDC
oMKgX19yZWxlYXNlX3JlZ2lvbigmaG1lbV9hY3RpdmUsIHJlcy5zdGFydCwgcmVzb3VyY2Vfc2l6
ZSgmcmVzKSk7Cj4gK8KgwqDCoMKgwqDCoMKgX19yZWxlYXNlX3JlZ2lvbigmaG1lbV9hY3RpdmUs
IHJlcy0+c3RhcnQsIHJlc291cmNlX3NpemUocmVzKSk7Cj4gwqBvdXRfYWN0aXZlOgo+IMKgwqDC
oMKgwqDCoMKgwqBwbGF0Zm9ybV9kZXZpY2VfcHV0KHBkZXYpOwo+IMKgb3V0X3BkZXY6Cj4gZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZGF4L2htZW0vaG1lbS5jIGIvZHJpdmVycy9kYXgvaG1lbS9obWVt
LmMKPiBpbmRleCBjNzM1MWUwZGM4ZmYuLjUwMjVhOGM5ODUwYiAxMDA2NDQKPiAtLS0gYS9kcml2
ZXJzL2RheC9obWVtL2htZW0uYwo+ICsrKyBiL2RyaXZlcnMvZGF4L2htZW0vaG1lbS5jCj4gQEAg
LTE1LDI1ICsxNSwxNyBAQCBzdGF0aWMgaW50IGRheF9obWVtX3Byb2JlKHN0cnVjdCBwbGF0Zm9y
bV9kZXZpY2UgKnBkZXYpCj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBtZW1yZWdpb25faW5mbyAq
bXJpOwo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgZGV2X2RheF9kYXRhIGRhdGE7Cj4gwqDCoMKg
wqDCoMKgwqDCoHN0cnVjdCBkZXZfZGF4ICpkZXZfZGF4Owo+IC3CoMKgwqDCoMKgwqDCoHN0cnVj
dCByZXNvdXJjZSAqcmVzOwo+IC3CoMKgwqDCoMKgwqDCoHN0cnVjdCByYW5nZSByYW5nZTsKPiAt
Cj4gLcKgwqDCoMKgwqDCoMKgcmVzID0gcGxhdGZvcm1fZ2V0X3Jlc291cmNlKHBkZXYsIElPUkVT
T1VSQ0VfTUVNLCAwKTsKPiAtwqDCoMKgwqDCoMKgwqBpZiAoIXJlcykKPiAtwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIC1FTk9NRU07Cj4gwqAKPiDCoMKgwqDCoMKgwqDCoMKg
bXJpID0gZGV2LT5wbGF0Zm9ybV9kYXRhOwo+IC3CoMKgwqDCoMKgwqDCoHJhbmdlLnN0YXJ0ID0g
cmVzLT5zdGFydDsKPiAtwqDCoMKgwqDCoMKgwqByYW5nZS5lbmQgPSByZXMtPmVuZDsKPiAtwqDC
oMKgwqDCoMKgwqBkYXhfcmVnaW9uID0gYWxsb2NfZGF4X3JlZ2lvbihkZXYsIHBkZXYtPmlkLCAm
cmFuZ2UsIG1yaS0+dGFyZ2V0X25vZGUsCj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqBQTURfU0laRSwgMCk7Cj4gK8KgwqDCoMKgwqDCoMKgZGF4X3JlZ2lv
biA9IGFsbG9jX2RheF9yZWdpb24oZGV2LCBwZGV2LT5pZCwgJm1yaS0+cmFuZ2UsCj4gK8KgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoCBtcmktPnRhcmdldF9ub2RlLCBQTURfU0laRSwgMCk7Cj4gwqDCoMKgwqDCoMKg
wqDCoGlmICghZGF4X3JlZ2lvbikKPiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJl
dHVybiAtRU5PTUVNOwo+IMKgCj4gwqDCoMKgwqDCoMKgwqDCoGRhdGEgPSAoc3RydWN0IGRldl9k
YXhfZGF0YSkgewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmRheF9yZWdpb24g
PSBkYXhfcmVnaW9uLAo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLmlkID0gLTEs
Cj4gLcKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC5zaXplID0gcmVnaW9uX2lkbGUgPyAw
IDogcmVzb3VyY2Vfc2l6ZShyZXMpLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAu
c2l6ZSA9IHJlZ2lvbl9pZGxlID8gMCA6IHJhbmdlX2xlbigmbXJpLT5yYW5nZSksCj4gwqDCoMKg
wqDCoMKgwqDCoH07Cj4gwqDCoMKgwqDCoMKgwqDCoGRldl9kYXggPSBkZXZtX2NyZWF0ZV9kZXZf
ZGF4KCZkYXRhKTsKPiDCoMKgwqDCoMKgwqDCoMKgaWYgKElTX0VSUihkZXZfZGF4KSkKPiBkaWZm
IC0tZ2l0IGEvaW5jbHVkZS9saW51eC9tZW1yZWdpb24uaCBiL2luY2x1ZGUvbGludXgvbWVtcmVn
aW9uLmgKPiBpbmRleCBiZjgzMzYzODA3YWMuLmMwMTMyMTQ2Nzc4OSAxMDA2NDQKPiAtLS0gYS9p
bmNsdWRlL2xpbnV4L21lbXJlZ2lvbi5oCj4gKysrIGIvaW5jbHVkZS9saW51eC9tZW1yZWdpb24u
aAo+IEBAIC0zLDEwICszLDEyIEBACj4gwqAjZGVmaW5lIF9NRU1SRUdJT05fSF8KPiDCoCNpbmNs
dWRlIDxsaW51eC90eXBlcy5oPgo+IMKgI2luY2x1ZGUgPGxpbnV4L2Vycm5vLmg+Cj4gKyNpbmNs
dWRlIDxsaW51eC9yYW5nZS5oPgo+IMKgI2luY2x1ZGUgPGxpbnV4L2J1Zy5oPgo+IMKgCj4gwqBz
dHJ1Y3QgbWVtcmVnaW9uX2luZm8gewo+IMKgwqDCoMKgwqDCoMKgwqBpbnQgdGFyZ2V0X25vZGU7
Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IHJhbmdlIHJhbmdlOwo+IMKgfTsKPiDCoAo+IMKgI2lm
ZGVmIENPTkZJR19NRU1SRUdJT04KPiAKCg==

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A2FD9C636D4
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 04:41:18 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229585AbjBKElQ (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Fri, 10 Feb 2023 23:41:16 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39346 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229447AbjBKElP (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Fri, 10 Feb 2023 23:41:15 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 573DD7BFF4;
        Fri, 10 Feb 2023 20:41:13 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676090473; x=1707626473;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=E2HwXPfp7Cj5yw8DU0nQ6aWYOc/FTraUGJni3vkUyKU=;
  b=nGhPlb4VCTDafitwgA3upnIErPIJsxOimgCGUPYRG5R+Fp0mg+2EliSF
   ImkO+/T3yHgcI1LwidvtuZhcEx+Cx5bVb317wPAdzBVII3d4r0SAMEcLl
   wkInDs+0m2fNOhLSLOJzHgGWXiHWGnClGm5MxVL2HW/aN8Ns5RifTxDOb
   uIwrKh8dR3UE1Z8TcLqy0dlO7USDW7SwGX2vu+FvIqRd94g+sp+9j9/Mi
   /3gpezsAjG7TxnIPHc56o37laYBjl2Ja51D/RUPLeA/efRrTI2VyvMP5r
   tofXZZ0N8rFQm2Ms+2VJDho8iuUzO4HvBVJn4ZCZEh/kEQRXHZERnDnJQ
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="310946468"
X-IronPort-AV: E=Sophos;i="5.97,289,1669104000"; 
   d="scan'208";a="310946468"
Received: from orsmga007.jf.intel.com ([10.7.209.58])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 20:41:12 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="661617187"
X-IronPort-AV: E=Sophos;i="5.97,289,1669104000"; 
   d="scan'208";a="661617187"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orsmga007.jf.intel.com with ESMTP; 10 Feb 2023 20:41:11 -0800
Received: from fmsmsx602.amr.corp.intel.com (10.18.126.82) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 20:41:11 -0800
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 20:41:11 -0800
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (104.47.70.106)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 20:41:10 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=FNSZl8Lv8YYScIpqdSUNqJdS6vhWiaDsXllCuDZzIIyv4kHkpCkNWHheX+YNE3dQY2eQ4Vg5175niwXcz/06E/c30dkqXMvfOLzk+xhC2++4tIgyIYcaK4zVoBOgZO7MWx0h2vw6exEih4IvUyzRRkGK7EwHNXFOfVoboxjafHpgDHcexv4YfiSC4mZN6YF2yuWej4OTiUHh6gOcAosO4Vxaq3Giv/kqKT8kuy810+dGU7L5nSfo/1Q6VRH2AP/Nb2p0nBwelV8PovyikIfYFUBnqKy7ynRELgkWDJWv5Ny540iozkJyHENRpRyxd2zIWqNa/evAzA9ToU0B3gcODw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=E2HwXPfp7Cj5yw8DU0nQ6aWYOc/FTraUGJni3vkUyKU=;
 b=GY7fF+M2qG9mkGv0lUPdzxRIp+HtK9fMFsjDZo2bIsBhNQmEuBc5F8ZupKAwTHnU3J3JDN0IyBlP4+o9NOiXc5jos/PJSsmBcaq84TL6bkxYGsfM0lIjtLgV5eNlX/NPABr7+9qSwyWkEloSfafR1wih9/AcgNvj+xrrH3alMVFZ0Cptmlvn6LENMwpxYwWkNZIWrW0lo4awX6YnRCtgW+/ZdatJqj04WiPGLgkez374c4gQ5US0vL2VzOibn8hQ1foriJgAXFXMJb2GCuvOORv+CVUpnEbxmp8kvdqY86r4tqG9dXtQ79MWouFaEbdClllizpeDycsGq/fhaWy7Fg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from MN2PR11MB3999.namprd11.prod.outlook.com (2603:10b6:208:154::32)
 by PH7PR11MB7099.namprd11.prod.outlook.com (2603:10b6:510:20e::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.22; Sat, 11 Feb
 2023 04:41:06 +0000
Received: from MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627]) by MN2PR11MB3999.namprd11.prod.outlook.com
 ([fe80::35af:d7a8:8484:627%5]) with mapi id 15.20.6086.017; Sat, 11 Feb 2023
 04:41:06 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 18/20] dax/hmem: Move hmem device registration to
 dax_hmem.ko
Thread-Topic: [PATCH v2 18/20] dax/hmem: Move hmem device registration to
 dax_hmem.ko
Thread-Index: AQHZPS8Ts7wnB/d8GEmhYyXN8FaA9K7JK7mA
Date: Sat, 11 Feb 2023 04:41:05 +0000
Message-ID: <0f73a0a27ff018219dadd355283f5c7120dbe65e.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: MN2PR11MB3999:EE_|PH7PR11MB7099:EE_
x-ms-office365-filtering-correlation-id: 2cb94d8e-c0c0-4819-fcc6-08db0bea2fd9
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: Kv0efBWiFfKc64Mdcf5l0WOIbojCGsmWy2dB1pHyrJKNZtaH1axBZw72Q7cy/nmWaPWK8MqCmweWrvb5RQDEhfD99HkxFYPrMLj7vIYT8t2RVanCZQO170PSjRpvjHm2bJGaNcuq8Na05nhFDJreCOs91S7ozGWJjyzmUysmi1PshbzvlANf7nxnpfE0TqyPoZgO+LbOWP3e5jXYLcFLL1pfnKj5pKGE6W5hDCooJnncS+HhTOv2zuh3aExRlXQRhJe7CguZL0ZWRsTXva1nhvAFvPcnYU77MZc+clfYYOTA6lGyvFK4WJD+Ul6+NMxcrSQkevyyW0GlliH0lChMqih8C6P/69tX6Tuo+AiEuy3Pz/0DMgkE+DVWH5VwwnAHTk+wIWH+8iLytv2SD78qRdbPsxFnKeh+KUhCyxObikE+2ANH+njSe2oVyQ4sT6YZnPE5eftTk1OZoq2BLrKXrD1NLts0bivPlfH9kzWvt1+uBadUfGJlvcWnVdF9+TkIdecQK9SqTC0vmwN7x2mCtAEyki/aUzOrLzuE8pGM6GmgX4uEUCIAEC5H3fdV7FkpIoHHVAyn3q3HevKDal1TfiUYBhbt0pOYaf8z21zXTdByvMluyJXMfm6RUQUgXNoL+48sODw3KM1RmfCqHJSAyHPkG6DzhK+pxetqy7B7dsd8FRQM0KWRakVoOV2s8ikTIjZWbLXNyK88AbrwseWb2X4DxIOZysZET2kdRQA3MQ8=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN2PR11MB3999.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(396003)(136003)(366004)(39860400002)(376002)(346002)(451199018)(82960400001)(122000001)(38100700002)(6486002)(966005)(478600001)(83380400001)(36756003)(6512007)(26005)(6506007)(186003)(2616005)(71200400001)(66946007)(66446008)(64756008)(66556008)(66476007)(86362001)(5660300002)(8936002)(41300700001)(316002)(110136005)(54906003)(38070700005)(76116006)(91956017)(4326008)(2906002)(8676002);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?THVWSTRnd015R3k2TGo4S01wWjdERGl3RE5MOUU3YU1TOU94bEd6S0N6K0dw?=
 =?utf-8?B?VElCbHVSYlpFeEJLT1gvWHVmVlJqQXpxRFJKVHVwbUZsODc1NHRNMEJUL3dW?=
 =?utf-8?B?cmZLRDJhVUk5SHd0Z2ZqL1dJajZXQnJ2bDBhcTRKUXpvaFpNSEp1MXRlVjFS?=
 =?utf-8?B?bWxwakpWLzZIMzRHSFBncUxtMVd2Zm5KenFDZkNEaVpPNGZ5N0RNMnp5OGJx?=
 =?utf-8?B?VDU2ZUFpRkJYSWFBN0EvYnM0SkxzdVRzbC9qZTRWUG1UWEFiejExMktibGpE?=
 =?utf-8?B?ZzJCUm1FUXZwMTBOSHYvc0puWU1PdkZCODByaUZxUUg4Um4vcTNGbTErS3Jt?=
 =?utf-8?B?NnNKZFFYYmptMzBlTVF6RThaMTA1dHlDakR0c3ZSRVRYOHkva0VKd2UyakNQ?=
 =?utf-8?B?dVVsNDg0bE5uU0pKRnUxaU53N1FJWEF6MzhMU0JsOWJrNGFwTUhZZkV4VjdZ?=
 =?utf-8?B?d3dyMjBwM0lHNGtWZDJDNnZiZDNUSFFpNTdrWmNFMVZOSGc5bGdiN0ZUT3Ex?=
 =?utf-8?B?VnNQTEVZZ2N0MHdqZW9TVnVQd0FPVno1NFBhY2NGaEdyMjJjV3Mwbk9sZitV?=
 =?utf-8?B?Vm4zVXUwQW5kL2hrZ3FpcGswYnFQMzRLL291YnZTVGI1VWcvNldIR24zOGJi?=
 =?utf-8?B?Z3NoZXVhZE9DNHNsajNXdlRMcWpZVnBHMXBlcW9Gc3AzT2Y0YldTOTZ4eTNy?=
 =?utf-8?B?clZCNDNBczBKNWNTcWtZV2E5UDQ5dFFpYlprdTlrcTgwTVJ5dmxXbEdTUGhB?=
 =?utf-8?B?ZFlSa0RSVmRDNHc2eXBsbURGSXdrTzhoUkM2ZStpSSs1UTQyMU93ZVl4WnBJ?=
 =?utf-8?B?WCtLbEpLQlRTZDVMM0RYbnZhOCtvVVI4anlZSjZHRlMzeC9RZHplY0ZhN1NV?=
 =?utf-8?B?NVU2b1ZyQVVJL2UzV2RSQjlmQUhFaE9uTDU4OXQwckRuZDloTzVjOVlzZTdl?=
 =?utf-8?B?YmJ4bXFxVXpCaEE3WUZVZHdSVUZVL0VFRm02L2VhOWlWcDlqNXZHTFdGM0N1?=
 =?utf-8?B?MG96YnNQbTBqZEI1QWJEUGlXaGwrSVNDYjhvMkNYNGt5MmVBY1MzNWxUMWNS?=
 =?utf-8?B?S1dldGtQNUVMTkxyUHE2emp4K0JnbUlBbzVkYjZQNkVsNzk0YTJ3QTdJS1JF?=
 =?utf-8?B?My9NUERXRWNXMFRDWnlWZHd0OTZzOGp6YjdZaFhOTWpGc2xDWXIxck1KVy9x?=
 =?utf-8?B?cHpXbFJNbE1iSUxUZmlUdVhVUDd1WEpyOG5pZnBPNDVrNGJPNXN3c1ZwOEw0?=
 =?utf-8?B?R2FqKzB0NlhCRXRiVGtxUjU5UUtHcW1GZ0RCaU1lL3h2ZW9sWk83ald6eE9R?=
 =?utf-8?B?V3c3T3JHeHU0NkJvejFnb2xnODhWQkRJZGE4NTNJU1pseFRBWlQzL2E1MGcw?=
 =?utf-8?B?Y0R6RWNqSUNLdmduOGFTY2pVZlNLREs1eWkwOGdaT3VHQ2tWUmQxNkF5R1ha?=
 =?utf-8?B?MENja2ZxNUkrU2ptRXRVVGl1djBlUlg2amVndWJYa2NRVFdscEFDQXVHVGpF?=
 =?utf-8?B?NFdPbmlGaGRFMkR0M2E4dy9SQWNianBYNkdFMWpsbDZsclhoZEpNLzdBTUp3?=
 =?utf-8?B?TTlINDBrMGpLdEREUERXUmNIY09yRmV2VVlPdnA4bFNtL3pkdGNXbHFKY21h?=
 =?utf-8?B?aWV1Yk0yakJYdXUwUm9oN21QNzFURk0rK3JDUGhFdVpsZGNFMFkrM0ZHNXhV?=
 =?utf-8?B?M2ZENFR6UWY5Y3Rtb3BPeklqRFZqV2JnbEtwUDlZem9VbFViS3B0aWc5S0U3?=
 =?utf-8?B?d0RVZmYwLzlYc09rTGFRSjhKSTVrZzFoSmxJbzNaa0hYWjNrTi96V3RDYncy?=
 =?utf-8?B?YVU0aVZGNUhuVE84Sk5CV2JQR0tVV3g1VkpJYS9vZHgzZE9KTEk4a3RyMVV2?=
 =?utf-8?B?QXhpR21iYUp3K3M0Z2ZTdHVXVUNnM3AvcUJiOUZHbDR2MjJ5bjc5Z2plNUdC?=
 =?utf-8?B?TVI2T1NLbEZxK20wUXZ5blpTcHJXRmg0cU9TU1pjK0IwMWQzTlJwU1ZCYnNJ?=
 =?utf-8?B?TGl3WVBGbCtmNU9NSTc5OUJtYkZSTGxwMnBxUXpqdTJZUmZ1VFdST3pjNVRm?=
 =?utf-8?B?bjRodk14NGc0b3pJbGNuZ2ZUUDZxRFFHUU13OWZESDhyZmI2RVdWR1NLTGR5?=
 =?utf-8?B?R0o3QVlMUGQxZTFmQmFRY3kyL0ZZaHdHUkxubG9ib1h3a1hwVTNEWWlkalls?=
 =?utf-8?B?Rmc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <98A3A8D7AD79A54091B3587148DA95EC@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: MN2PR11MB3999.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 2cb94d8e-c0c0-4819-fcc6-08db0bea2fd9
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 04:41:05.5812
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: ofiQNNwQ4bWYqzFIfNGrGN6dJb9fP2ervD3RhccUwOqoecap2A2iJCNiY4ciSoyDLXH1jjHwLVH92JxabvrrYBf+/dgMQNRq55V1xK2K9D0=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB7099
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA3IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
SW4gcHJlcGFyYXRpb24gZm9yIHRoZSBDWEwgcmVnaW9uIGRyaXZlciB0byB0YWtlIG92ZXIgdGhl
IHJlc3BvbnNpYmlsaXR5Cj4gb2YgcmVnaXN0ZXJpbmcgZGV2aWNlLWRheCBpbnN0YW5jZXMgZm9y
IENYTCByZWdpb25zLCBtb3ZlIHRoZQo+IHJlZ2lzdHJhdGlvbiBvZiAiaG1lbSIgZGV2aWNlcyB0
byBkYXhfaG1lbS5rby4KPiAKPiBQcmV2aW91c2x5IHRoZSBidWlsdGluIGNvbXBvbmVudCBvZiB0
aGlzIGVuYWJsaW5nCj4gKGRyaXZlcnMvZGF4L2htZW0vZGV2aWNlLm8pIHdvdWxkIHJlZ2lzdGVy
IHBsYXRmb3JtIGRldmljZXMgZm9yIGVhY2gKPiBhZGRyZXNzIHJhbmdlIGFuZCB0cmlnZ2VyIHRo
ZSBkYXhfaG1lbS5rbyBtb2R1bGUgdG8gbG9hZCBhbmQgYXR0YWNoCj4gZGV2aWNlLWRheCBpbnN0
YW5jZXMgdG8gdGhvc2UgZGV2aWNlcy4gTm93LCB0aGUgcmFuZ2VzIGFyZSBjb2xsZWN0ZWQKPiBm
cm9tIHRoZSBITUFUIGFuZCBFRkkgbWVtb3J5IG1hcCB3YWxraW5nLCBidXQgdGhlIGRldmljZSBj
cmVhdGlvbiBpcwo+IGRlZmVycmVkLiBBIG5ldyAiaG1lbV9wbGF0Zm9ybSIgZGV2aWNlIGlzIGNy
ZWF0ZWQgd2hpY2ggdHJpZ2dlcnMKPiBkYXhfaG1lbS5rbyB0byBsb2FkIGFuZCByZWdpc3RlciB0
aGUgcGxhdGZvcm0gZGV2aWNlcy4KPiAKPiBUZXN0ZWQtYnk6IEZhbiBOaSA8ZmFuLm5pQHNhbXN1
bmcuY29tPgo+IExpbms6IGh0dHBzOi8vbG9yZS5rZXJuZWwub3JnL3IvMTY3NTY0NTQzOTIzLjg0
NzE0Ni45MDMwMzgwMjIzNjIyMDQ0NzQ0LnN0Z2l0QGR3aWxsaWEyLXhmaC5qZi5pbnRlbC5jb20K
PiBTaWduZWQtb2ZmLWJ5OiBEYW4gV2lsbGlhbXMgPGRhbi5qLndpbGxpYW1zQGludGVsLmNvbT4K
PiAtLS0KPiDCoGRyaXZlcnMvYWNwaS9udW1hL2htYXQuY8KgIHzCoMKgwqAgMiAtCj4gwqBkcml2
ZXJzL2RheC9LY29uZmlnwqDCoMKgwqDCoMKgIHzCoMKgwqAgMiAtCj4gwqBkcml2ZXJzL2RheC9o
bWVtL2RldmljZS5jIHzCoMKgIDkxICsrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0t
LS0tLQo+IMKgZHJpdmVycy9kYXgvaG1lbS9obWVtLmPCoMKgIHzCoCAxMDUgKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCj4gwqBpbmNsdWRlL2xpbnV4L2RheC5o
wqDCoMKgwqDCoMKgIHzCoMKgwqAgNyArKy0KPiDCoDUgZmlsZXMgY2hhbmdlZCwgMTU1IGluc2Vy
dGlvbnMoKyksIDUyIGRlbGV0aW9ucygtKQoKTG9va3MgZ29vZCwKClJldmlld2VkLWJ5OiBWaXNo
YWwgVmVybWEgPHZpc2hhbC5sLnZlcm1hQGludGVsLmNvbT4KCj4gCj4gZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvYWNwaS9udW1hL2htYXQuYyBiL2RyaXZlcnMvYWNwaS9udW1hL2htYXQuYwo+IGluZGV4
IGZmMjQyODIzMDFhYi4uYmJhMjY4ZWNkODAyIDEwMDY0NAo+IC0tLSBhL2RyaXZlcnMvYWNwaS9u
dW1hL2htYXQuYwo+ICsrKyBiL2RyaXZlcnMvYWNwaS9udW1hL2htYXQuYwo+IEBAIC03MTgsNyAr
NzE4LDcgQEAgc3RhdGljIHZvaWQgaG1hdF9yZWdpc3Rlcl90YXJnZXRfZGV2aWNlcyhzdHJ1Y3Qg
bWVtb3J5X3RhcmdldCAqdGFyZ2V0KQo+IMKgwqDCoMKgwqDCoMKgwqBmb3IgKHJlcyA9IHRhcmdl
dC0+bWVtcmVnaW9ucy5jaGlsZDsgcmVzOyByZXMgPSByZXMtPnNpYmxpbmcpIHsKPiDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGludCB0YXJnZXRfbmlkID0gcHhtX3RvX25vZGUodGFy
Z2V0LT5tZW1vcnlfcHhtKTsKPiDCoAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBo
bWVtX3JlZ2lzdGVyX2RldmljZSh0YXJnZXRfbmlkLCByZXMpOwo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqBobWVtX3JlZ2lzdGVyX3Jlc291cmNlKHRhcmdldF9uaWQsIHJlcyk7Cj4g
wqDCoMKgwqDCoMKgwqDCoH0KPiDCoH0KPiDCoAo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2RheC9L
Y29uZmlnIGIvZHJpdmVycy9kYXgvS2NvbmZpZwo+IGluZGV4IDVmZGYyNjlhODIyZS4uZDEzYzg4
OWMyYTY0IDEwMDY0NAo+IC0tLSBhL2RyaXZlcnMvZGF4L0tjb25maWcKPiArKysgYi9kcml2ZXJz
L2RheC9LY29uZmlnCj4gQEAgLTQ2LDcgKzQ2LDcgQEAgY29uZmlnIERFVl9EQVhfSE1FTQo+IMKg
wqDCoMKgwqDCoMKgwqDCoCBTYXkgTSBpZiB1bnN1cmUuCj4gwqAKPiDCoGNvbmZpZyBERVZfREFY
X0hNRU1fREVWSUNFUwo+IC3CoMKgwqDCoMKgwqDCoGRlcGVuZHMgb24gREVWX0RBWF9ITUVNICYm
IERBWD15Cj4gK8KgwqDCoMKgwqDCoMKgZGVwZW5kcyBvbiBERVZfREFYX0hNRU0gJiYgREFYCj4g
wqDCoMKgwqDCoMKgwqDCoGRlZl9ib29sIHkKPiDCoAo+IMKgY29uZmlnIERFVl9EQVhfS01FTQo+
IGRpZmYgLS1naXQgYS9kcml2ZXJzL2RheC9obWVtL2RldmljZS5jIGIvZHJpdmVycy9kYXgvaG1l
bS9kZXZpY2UuYwo+IGluZGV4IGIxYjMzOWJjY2ZlNS4uZjllMWE3NmEwNGE5IDEwMDY0NAo+IC0t
LSBhL2RyaXZlcnMvZGF4L2htZW0vZGV2aWNlLmMKPiArKysgYi9kcml2ZXJzL2RheC9obWVtL2Rl
dmljZS5jCj4gQEAgLTgsNiArOCw4IEBACj4gwqBzdGF0aWMgYm9vbCBub2htZW07Cj4gwqBtb2R1
bGVfcGFyYW1fbmFtZWQoZGlzYWJsZSwgbm9obWVtLCBib29sLCAwNDQ0KTsKPiDCoAo+ICtzdGF0
aWMgYm9vbCBwbGF0Zm9ybV9pbml0aWFsaXplZDsKPiArc3RhdGljIERFRklORV9NVVRFWChobWVt
X3Jlc291cmNlX2xvY2spOwo+IMKgc3RhdGljIHN0cnVjdCByZXNvdXJjZSBobWVtX2FjdGl2ZSA9
IHsKPiDCoMKgwqDCoMKgwqDCoMKgLm5hbWUgPSAiSE1FTSBkZXZpY2VzIiwKPiDCoMKgwqDCoMKg
wqDCoMKgLnN0YXJ0ID0gMCwKPiBAQCAtMTUsNzEgKzE3LDY2IEBAIHN0YXRpYyBzdHJ1Y3QgcmVz
b3VyY2UgaG1lbV9hY3RpdmUgPSB7Cj4gwqDCoMKgwqDCoMKgwqDCoC5mbGFncyA9IElPUkVTT1VS
Q0VfTUVNLAo+IMKgfTsKPiDCoAo+IC12b2lkIGhtZW1fcmVnaXN0ZXJfZGV2aWNlKGludCB0YXJn
ZXRfbmlkLCBzdHJ1Y3QgcmVzb3VyY2UgKnJlcykKPiAraW50IHdhbGtfaG1lbV9yZXNvdXJjZXMo
c3RydWN0IGRldmljZSAqaG9zdCwgd2Fsa19obWVtX2ZuIGZuKQo+ICt7Cj4gK8KgwqDCoMKgwqDC
oMKgc3RydWN0IHJlc291cmNlICpyZXM7Cj4gK8KgwqDCoMKgwqDCoMKgaW50IHJjID0gMDsKPiAr
Cj4gK8KgwqDCoMKgwqDCoMKgbXV0ZXhfbG9jaygmaG1lbV9yZXNvdXJjZV9sb2NrKTsKPiArwqDC
oMKgwqDCoMKgwqBmb3IgKHJlcyA9IGhtZW1fYWN0aXZlLmNoaWxkOyByZXM7IHJlcyA9IHJlcy0+
c2libGluZykgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByYyA9IGZuKGhvc3Qs
IChpbnQpIHJlcy0+ZGVzYywgcmVzKTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
aWYgKHJjKQo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
YnJlYWs7Cj4gK8KgwqDCoMKgwqDCoMKgfQo+ICvCoMKgwqDCoMKgwqDCoG11dGV4X3VubG9jaygm
aG1lbV9yZXNvdXJjZV9sb2NrKTsKPiArwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7Cj4gK30KPiAr
RVhQT1JUX1NZTUJPTF9HUEwod2Fsa19obWVtX3Jlc291cmNlcyk7Cj4gKwo+ICtzdGF0aWMgdm9p
ZCBfX2htZW1fcmVnaXN0ZXJfcmVzb3VyY2UoaW50IHRhcmdldF9uaWQsIHN0cnVjdCByZXNvdXJj
ZSAqcmVzKQo+IMKgewo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpw
ZGV2Owo+IC3CoMKgwqDCoMKgwqDCoHN0cnVjdCBtZW1yZWdpb25faW5mbyBpbmZvOwo+IC3CoMKg
wqDCoMKgwqDCoGludCByYywgaWQ7Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IHJlc291cmNlICpu
ZXc7Cj4gK8KgwqDCoMKgwqDCoMKgaW50IHJjOwo+IMKgCj4gLcKgwqDCoMKgwqDCoMKgaWYgKG5v
aG1lbSkKPiArwqDCoMKgwqDCoMKgwqBuZXcgPSBfX3JlcXVlc3RfcmVnaW9uKCZobWVtX2FjdGl2
ZSwgcmVzLT5zdGFydCwgcmVzb3VyY2Vfc2l6ZShyZXMpLCAiIiwKPiArwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCAwKTsKPiArwqDCoMKg
wqDCoMKgwqBpZiAoIW5ldykgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwcl9k
ZWJ1ZygiaG1lbSByYW5nZSAlcHIgYWxyZWFkeSBhY3RpdmVcbiIsIHJlcyk7Cj4gwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm47Cj4gK8KgwqDCoMKgwqDCoMKgfQo+IMKgCj4g
LcKgwqDCoMKgwqDCoMKgcmMgPSByZWdpb25faW50ZXJzZWN0cyhyZXMtPnN0YXJ0LCByZXNvdXJj
ZV9zaXplKHJlcyksIElPUkVTT1VSQ0VfTUVNLAo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgIElPUkVTX0RFU0NfU09GVF9SRVNFUlZF
RCk7Cj4gLcKgwqDCoMKgwqDCoMKgaWYgKHJjICE9IFJFR0lPTl9JTlRFUlNFQ1RTKQo+IC3CoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm47Cj4gK8KgwqDCoMKgwqDCoMKgbmV3LT5k
ZXNjID0gdGFyZ2V0X25pZDsKPiDCoAo+IC3CoMKgwqDCoMKgwqDCoGlkID0gbWVtcmVnaW9uX2Fs
bG9jKEdGUF9LRVJORUwpOwo+IC3CoMKgwqDCoMKgwqDCoGlmIChpZCA8IDApIHsKPiAtwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcHJfZXJyKCJtZW1yZWdpb24gYWxsb2NhdGlvbiBmYWls
dXJlIGZvciAlcHJcbiIsIHJlcyk7Cj4gK8KgwqDCoMKgwqDCoMKgaWYgKHBsYXRmb3JtX2luaXRp
YWxpemVkKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuOwo+IC3CoMKg
wqDCoMKgwqDCoH0KPiDCoAo+IC3CoMKgwqDCoMKgwqDCoHBkZXYgPSBwbGF0Zm9ybV9kZXZpY2Vf
YWxsb2MoImhtZW0iLCBpZCk7Cj4gK8KgwqDCoMKgwqDCoMKgcGRldiA9IHBsYXRmb3JtX2Rldmlj
ZV9hbGxvYygiaG1lbV9wbGF0Zm9ybSIsIDApOwo+IMKgwqDCoMKgwqDCoMKgwqBpZiAoIXBkZXYp
IHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcHJfZXJyKCJobWVtIGRldmljZSBh
bGxvY2F0aW9uIGZhaWx1cmUgZm9yICVwclxuIiwgcmVzKTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgZ290byBvdXRfcGRldjsKPiAtwqDCoMKgwqDCoMKgwqB9Cj4gLQo+IC3CoMKg
wqDCoMKgwqDCoGlmICghX19yZXF1ZXN0X3JlZ2lvbigmaG1lbV9hY3RpdmUsIHJlcy0+c3RhcnQs
IHJlc291cmNlX3NpemUocmVzKSwKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAgZGV2X25hbWUoJnBkZXYtPmRldiksIDApKSB7Cj4gLcKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGRldl9kYmcoJnBkZXYtPmRldiwgImhtZW0gcmFu
Z2UgJXByIGFscmVhZHkgYWN0aXZlXG4iLCByZXMpOwo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqBnb3RvIG91dF9hY3RpdmU7Cj4gLcKgwqDCoMKgwqDCoMKgfQo+IC0KPiAtwqDCoMKg
wqDCoMKgwqBwZGV2LT5kZXYubnVtYV9ub2RlID0gbnVtYV9tYXBfdG9fb25saW5lX25vZGUodGFy
Z2V0X25pZCk7Cj4gLcKgwqDCoMKgwqDCoMKgaW5mbyA9IChzdHJ1Y3QgbWVtcmVnaW9uX2luZm8p
IHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLnRhcmdldF9ub2RlID0gdGFyZ2V0
X25pZCwKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLnJhbmdlID0gewo+IC3CoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgLnN0YXJ0ID0gcmVzLT5z
dGFydCwKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoC5l
bmQgPSByZXMtPmVuZCwKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgfSwKPiAtwqDC
oMKgwqDCoMKgwqB9Owo+IC3CoMKgwqDCoMKgwqDCoHJjID0gcGxhdGZvcm1fZGV2aWNlX2FkZF9k
YXRhKHBkZXYsICZpbmZvLCBzaXplb2YoaW5mbykpOwo+IC3CoMKgwqDCoMKgwqDCoGlmIChyYyA8
IDApIHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcHJfZXJyKCJobWVtIG1lbXJl
Z2lvbl9pbmZvIGFsbG9jYXRpb24gZmFpbHVyZSBmb3IgJXByXG4iLCByZXMpOwo+IC3CoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBnb3RvIG91dF9yZXNvdXJjZTsKPiArwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgcHJfZXJyX29uY2UoImZhaWxlZCB0byByZWdpc3RlciBkZXZpY2Ut
ZGF4IGhtZW1fcGxhdGZvcm0gZGV2aWNlXG4iKTsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgcmV0dXJuOwo+IMKgwqDCoMKgwqDCoMKgwqB9Cj4gwqAKPiDCoMKgwqDCoMKgwqDCoMKg
cmMgPSBwbGF0Zm9ybV9kZXZpY2VfYWRkKHBkZXYpOwo+IC3CoMKgwqDCoMKgwqDCoGlmIChyYyA8
IDApIHsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X2VycigmcGRldi0+ZGV2
LCAiZGV2aWNlIGFkZCBmYWlsZWQgZm9yICVwclxuIiwgcmVzKTsKPiAtwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgZ290byBvdXRfcmVzb3VyY2U7Cj4gLcKgwqDCoMKgwqDCoMKgfQo+ICvC
oMKgwqDCoMKgwqDCoGlmIChyYykKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcGxh
dGZvcm1fZGV2aWNlX3B1dChwZGV2KTsKPiArwqDCoMKgwqDCoMKgwqBlbHNlCj4gK8KgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoHBsYXRmb3JtX2luaXRpYWxpemVkID0gdHJ1ZTsKPiArfQo+
IMKgCj4gLcKgwqDCoMKgwqDCoMKgcmV0dXJuOwo+ICt2b2lkIGhtZW1fcmVnaXN0ZXJfcmVzb3Vy
Y2UoaW50IHRhcmdldF9uaWQsIHN0cnVjdCByZXNvdXJjZSAqcmVzKQo+ICt7Cj4gK8KgwqDCoMKg
wqDCoMKgaWYgKG5vaG1lbSkKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJu
Owo+IMKgCj4gLW91dF9yZXNvdXJjZToKPiAtwqDCoMKgwqDCoMKgwqBfX3JlbGVhc2VfcmVnaW9u
KCZobWVtX2FjdGl2ZSwgcmVzLT5zdGFydCwgcmVzb3VyY2Vfc2l6ZShyZXMpKTsKPiAtb3V0X2Fj
dGl2ZToKPiAtwqDCoMKgwqDCoMKgwqBwbGF0Zm9ybV9kZXZpY2VfcHV0KHBkZXYpOwo+IC1vdXRf
cGRldjoKPiAtwqDCoMKgwqDCoMKgwqBtZW1yZWdpb25fZnJlZShpZCk7Cj4gK8KgwqDCoMKgwqDC
oMKgbXV0ZXhfbG9jaygmaG1lbV9yZXNvdXJjZV9sb2NrKTsKPiArwqDCoMKgwqDCoMKgwqBfX2ht
ZW1fcmVnaXN0ZXJfcmVzb3VyY2UodGFyZ2V0X25pZCwgcmVzKTsKPiArwqDCoMKgwqDCoMKgwqBt
dXRleF91bmxvY2soJmhtZW1fcmVzb3VyY2VfbG9jayk7Cj4gwqB9Cj4gwqAKPiDCoHN0YXRpYyBf
X2luaXQgaW50IGhtZW1fcmVnaXN0ZXJfb25lKHN0cnVjdCByZXNvdXJjZSAqcmVzLCB2b2lkICpk
YXRhKQo+IMKgewo+IC3CoMKgwqDCoMKgwqDCoGhtZW1fcmVnaXN0ZXJfZGV2aWNlKHBoeXNfdG9f
dGFyZ2V0X25vZGUocmVzLT5zdGFydCksIHJlcyk7Cj4gK8KgwqDCoMKgwqDCoMKgaG1lbV9yZWdp
c3Rlcl9yZXNvdXJjZShwaHlzX3RvX3RhcmdldF9ub2RlKHJlcy0+c3RhcnQpLCByZXMpOwo+IMKg
Cj4gwqDCoMKgwqDCoMKgwqDCoHJldHVybiAwOwo+IMKgfQo+IGRpZmYgLS1naXQgYS9kcml2ZXJz
L2RheC9obWVtL2htZW0uYyBiL2RyaXZlcnMvZGF4L2htZW0vaG1lbS5jCj4gaW5kZXggNTAyNWE4
Yzk4NTBiLi5lN2JkZmYzMTMyZmEgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9kYXgvaG1lbS9obWVt
LmMKPiArKysgYi9kcml2ZXJzL2RheC9obWVtL2htZW0uYwo+IEBAIC0zLDYgKzMsNyBAQAo+IMKg
I2luY2x1ZGUgPGxpbnV4L21lbXJlZ2lvbi5oPgo+IMKgI2luY2x1ZGUgPGxpbnV4L21vZHVsZS5o
Pgo+IMKgI2luY2x1ZGUgPGxpbnV4L3Bmbl90Lmg+Cj4gKyNpbmNsdWRlIDxsaW51eC9kYXguaD4K
PiDCoCNpbmNsdWRlICIuLi9idXMuaCIKPiDCoAo+IMKgc3RhdGljIGJvb2wgcmVnaW9uX2lkbGU7
Cj4gQEAgLTQzLDggKzQ0LDExMCBAQCBzdGF0aWMgc3RydWN0IHBsYXRmb3JtX2RyaXZlciBkYXhf
aG1lbV9kcml2ZXIgPSB7Cj4gwqDCoMKgwqDCoMKgwqDCoH0sCj4gwqB9Owo+IMKgCj4gLW1vZHVs
ZV9wbGF0Zm9ybV9kcml2ZXIoZGF4X2htZW1fZHJpdmVyKTsKPiArc3RhdGljIHZvaWQgcmVsZWFz
ZV9tZW1yZWdpb24odm9pZCAqZGF0YSkKPiArewo+ICvCoMKgwqDCoMKgwqDCoG1lbXJlZ2lvbl9m
cmVlKChsb25nKSBkYXRhKTsKPiArfQo+ICsKPiArc3RhdGljIHZvaWQgcmVsZWFzZV9obWVtKHZv
aWQgKnBkZXYpCj4gK3sKPiArwqDCoMKgwqDCoMKgwqBwbGF0Zm9ybV9kZXZpY2VfdW5yZWdpc3Rl
cihwZGV2KTsKPiArfQo+ICsKPiArc3RhdGljIGludCBobWVtX3JlZ2lzdGVyX2RldmljZShzdHJ1
Y3QgZGV2aWNlICpob3N0LCBpbnQgdGFyZ2V0X25pZCwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBjb25zdCBzdHJ1Y3QgcmVz
b3VyY2UgKnJlcykKPiArewo+ICvCoMKgwqDCoMKgwqDCoHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2Ug
KnBkZXY7Cj4gK8KgwqDCoMKgwqDCoMKgc3RydWN0IG1lbXJlZ2lvbl9pbmZvIGluZm87Cj4gK8Kg
wqDCoMKgwqDCoMKgbG9uZyBpZDsKPiArwqDCoMKgwqDCoMKgwqBpbnQgcmM7Cj4gKwo+ICvCoMKg
wqDCoMKgwqDCoHJjID0gcmVnaW9uX2ludGVyc2VjdHMocmVzLT5zdGFydCwgcmVzb3VyY2Vfc2l6
ZShyZXMpLCBJT1JFU09VUkNFX01FTSwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoCBJT1JFU19ERVNDX1NPRlRfUkVTRVJWRUQpOwo+
ICvCoMKgwqDCoMKgwqDCoGlmIChyYyAhPSBSRUdJT05fSU5URVJTRUNUUykKPiArwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIDA7Cj4gKwo+ICvCoMKgwqDCoMKgwqDCoGlkID0g
bWVtcmVnaW9uX2FsbG9jKEdGUF9LRVJORUwpOwo+ICvCoMKgwqDCoMKgwqDCoGlmIChpZCA8IDAp
IHsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X2Vycihob3N0LCAibWVtcmVn
aW9uIGFsbG9jYXRpb24gZmFpbHVyZSBmb3IgJXByXG4iLCByZXMpOwo+ICvCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gLUVOT01FTTsKPiArwqDCoMKgwqDCoMKgwqB9Cj4gK8Kg
wqDCoMKgwqDCoMKgcmMgPSBkZXZtX2FkZF9hY3Rpb25fb3JfcmVzZXQoaG9zdCwgcmVsZWFzZV9t
ZW1yZWdpb24sICh2b2lkICopIGlkKTsKPiArwqDCoMKgwqDCoMKgwqBpZiAocmMpCj4gK8KgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJldHVybiByYzsKPiArCj4gK8KgwqDCoMKgwqDCoMKg
cGRldiA9IHBsYXRmb3JtX2RldmljZV9hbGxvYygiaG1lbSIsIGlkKTsKPiArwqDCoMKgwqDCoMKg
wqBpZiAoIXBkZXYpIHsKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgZGV2X2Vyciho
b3N0LCAiZGV2aWNlIGFsbG9jYXRpb24gZmFpbHVyZSBmb3IgJXByXG4iLCByZXMpOwo+ICvCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gLUVOT01FTTsKPiArwqDCoMKgwqDCoMKg
wqB9Cj4gKwo+ICvCoMKgwqDCoMKgwqDCoHBkZXYtPmRldi5udW1hX25vZGUgPSBudW1hX21hcF90
b19vbmxpbmVfbm9kZSh0YXJnZXRfbmlkKTsKPiArwqDCoMKgwqDCoMKgwqBpbmZvID0gKHN0cnVj
dCBtZW1yZWdpb25faW5mbykgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAudGFy
Z2V0X25vZGUgPSB0YXJnZXRfbmlkLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAu
cmFuZ2UgPSB7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqAuc3RhcnQgPSByZXMtPnN0YXJ0LAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgLmVuZCA9IHJlcy0+ZW5kLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqB9LAo+ICvCoMKgwqDCoMKgwqDCoH07Cj4gK8KgwqDCoMKgwqDCoMKgcmMgPSBwbGF0
Zm9ybV9kZXZpY2VfYWRkX2RhdGEocGRldiwgJmluZm8sIHNpemVvZihpbmZvKSk7Cj4gK8KgwqDC
oMKgwqDCoMKgaWYgKHJjIDwgMCkgewo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBk
ZXZfZXJyKGhvc3QsICJtZW1yZWdpb25faW5mbyBhbGxvY2F0aW9uIGZhaWx1cmUgZm9yICVwclxu
IiwKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgIHJlcyk7Cj4g
K8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoGdvdG8gb3V0X3B1dDsKPiArwqDCoMKgwqDC
oMKgwqB9Cj4gKwo+ICvCoMKgwqDCoMKgwqDCoHJjID0gcGxhdGZvcm1fZGV2aWNlX2FkZChwZGV2
KTsKPiArwqDCoMKgwqDCoMKgwqBpZiAocmMgPCAwKSB7Cj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoGRldl9lcnIoaG9zdCwgIiVzIGFkZCBmYWlsZWQgZm9yICVwclxuIiwgZGV2X25h
bWUoJnBkZXYtPmRldiksCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqByZXMpOwo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBnb3RvIG91dF9w
dXQ7Cj4gK8KgwqDCoMKgwqDCoMKgfQo+ICsKPiArwqDCoMKgwqDCoMKgwqByZXR1cm4gZGV2bV9h
ZGRfYWN0aW9uX29yX3Jlc2V0KGhvc3QsIHJlbGVhc2VfaG1lbSwgcGRldik7Cj4gKwo+ICtvdXRf
cHV0Ogo+ICvCoMKgwqDCoMKgwqDCoHBsYXRmb3JtX2RldmljZV9wdXQocGRldik7Cj4gK8KgwqDC
oMKgwqDCoMKgcmV0dXJuIHJjOwo+ICt9Cj4gKwo+ICtzdGF0aWMgaW50IGRheF9obWVtX3BsYXRm
b3JtX3Byb2JlKHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCj4gK3sKPiArwqDCoMKgwqDC
oMKgwqByZXR1cm4gd2Fsa19obWVtX3Jlc291cmNlcygmcGRldi0+ZGV2LCBobWVtX3JlZ2lzdGVy
X2RldmljZSk7Cj4gK30KPiArCj4gK3N0YXRpYyBzdHJ1Y3QgcGxhdGZvcm1fZHJpdmVyIGRheF9o
bWVtX3BsYXRmb3JtX2RyaXZlciA9IHsKPiArwqDCoMKgwqDCoMKgwqAucHJvYmUgPSBkYXhfaG1l
bV9wbGF0Zm9ybV9wcm9iZSwKPiArwqDCoMKgwqDCoMKgwqAuZHJpdmVyID0gewo+ICvCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAubmFtZSA9ICJobWVtX3BsYXRmb3JtIiwKPiArwqDCoMKg
wqDCoMKgwqB9LAo+ICt9Owo+ICsKPiArc3RhdGljIF9faW5pdCBpbnQgZGF4X2htZW1faW5pdCh2
b2lkKQo+ICt7Cj4gK8KgwqDCoMKgwqDCoMKgaW50IHJjOwo+ICsKPiArwqDCoMKgwqDCoMKgwqBy
YyA9IHBsYXRmb3JtX2RyaXZlcl9yZWdpc3RlcigmZGF4X2htZW1fcGxhdGZvcm1fZHJpdmVyKTsK
PiArwqDCoMKgwqDCoMKgwqBpZiAocmMpCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oHJldHVybiByYzsKPiArCj4gK8KgwqDCoMKgwqDCoMKgcmMgPSBwbGF0Zm9ybV9kcml2ZXJfcmVn
aXN0ZXIoJmRheF9obWVtX2RyaXZlcik7Cj4gK8KgwqDCoMKgwqDCoMKgaWYgKHJjKQo+ICvCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBwbGF0Zm9ybV9kcml2ZXJfdW5yZWdpc3RlcigmZGF4
X2htZW1fcGxhdGZvcm1fZHJpdmVyKTsKPiArCj4gK8KgwqDCoMKgwqDCoMKgcmV0dXJuIHJjOwo+
ICt9Cj4gKwo+ICtzdGF0aWMgX19leGl0IHZvaWQgZGF4X2htZW1fZXhpdCh2b2lkKQo+ICt7Cj4g
K8KgwqDCoMKgwqDCoMKgcGxhdGZvcm1fZHJpdmVyX3VucmVnaXN0ZXIoJmRheF9obWVtX2RyaXZl
cik7Cj4gK8KgwqDCoMKgwqDCoMKgcGxhdGZvcm1fZHJpdmVyX3VucmVnaXN0ZXIoJmRheF9obWVt
X3BsYXRmb3JtX2RyaXZlcik7Cj4gK30KPiArCj4gK21vZHVsZV9pbml0KGRheF9obWVtX2luaXQp
Owo+ICttb2R1bGVfZXhpdChkYXhfaG1lbV9leGl0KTsKPiDCoAo+IMKgTU9EVUxFX0FMSUFTKCJw
bGF0Zm9ybTpobWVtKiIpOwo+ICtNT0RVTEVfQUxJQVMoInBsYXRmb3JtOmhtZW1fcGxhdGZvcm0q
Iik7Cj4gwqBNT0RVTEVfTElDRU5TRSgiR1BMIHYyIik7Cj4gwqBNT0RVTEVfQVVUSE9SKCJJbnRl
bCBDb3Jwb3JhdGlvbiIpOwo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2RheC5oIGIvaW5j
bHVkZS9saW51eC9kYXguaAo+IGluZGV4IDJiNWVjYjU5MTA1OS4uYmY2MjU4NDcyZTQ5IDEwMDY0
NAo+IC0tLSBhL2luY2x1ZGUvbGludXgvZGF4LmgKPiArKysgYi9pbmNsdWRlL2xpbnV4L2RheC5o
Cj4gQEAgLTI2MiwxMSArMjYyLDE0IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBkYXhfbWFwcGluZyhz
dHJ1Y3QgYWRkcmVzc19zcGFjZSAqbWFwcGluZykKPiDCoH0KPiDCoAo+IMKgI2lmZGVmIENPTkZJ
R19ERVZfREFYX0hNRU1fREVWSUNFUwo+IC12b2lkIGhtZW1fcmVnaXN0ZXJfZGV2aWNlKGludCB0
YXJnZXRfbmlkLCBzdHJ1Y3QgcmVzb3VyY2UgKnIpOwo+ICt2b2lkIGhtZW1fcmVnaXN0ZXJfcmVz
b3VyY2UoaW50IHRhcmdldF9uaWQsIHN0cnVjdCByZXNvdXJjZSAqcik7Cj4gwqAjZWxzZQo+IC1z
dGF0aWMgaW5saW5lIHZvaWQgaG1lbV9yZWdpc3Rlcl9kZXZpY2UoaW50IHRhcmdldF9uaWQsIHN0
cnVjdCByZXNvdXJjZSAqcikKPiArc3RhdGljIGlubGluZSB2b2lkIGhtZW1fcmVnaXN0ZXJfcmVz
b3VyY2UoaW50IHRhcmdldF9uaWQsIHN0cnVjdCByZXNvdXJjZSAqcikKPiDCoHsKPiDCoH0KPiDC
oCNlbmRpZgo+IMKgCj4gK3R5cGVkZWYgaW50ICgqd2Fsa19obWVtX2ZuKShzdHJ1Y3QgZGV2aWNl
ICpkZXYsIGludCB0YXJnZXRfbmlkLAo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgIGNvbnN0IHN0cnVjdCByZXNvdXJjZSAqcmVzKTsKPiAraW50
IHdhbGtfaG1lbV9yZXNvdXJjZXMoc3RydWN0IGRldmljZSAqZGV2LCB3YWxrX2htZW1fZm4gZm4p
Owo+IMKgI2VuZGlmCj4gCgo=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B7D85C61DA4
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 05:57:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229476AbjBKF5v (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Sat, 11 Feb 2023 00:57:51 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:55838 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229447AbjBKF5u (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Sat, 11 Feb 2023 00:57:50 -0500
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0F56534C1F;
        Fri, 10 Feb 2023 21:57:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676095069; x=1707631069;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=NXon1QKtR4ZOSSK7XCbhQJIjXT2jtMmXZf/P+XmaN50=;
  b=igek8xn0xIazy76PT+oBf02KmDQ7wzskw4ZDtStX/q6j43qOa+K9M0ZR
   F6D7D0ZsGdrtby+iB5hRlEI8BASHb6NYm8yXziQCg6DgjK/irr2KA6fqL
   45wUFa+7BHzeme+pLPEprB/gNAhbb3I+tJR8kIMv0ecBjPpSRujTwsKX3
   S1VEie090PXSg8UfzoNwm/ZF6wCYpDL44Ne6b6HPH7UGyUcMsTYNOJK7o
   rcYIukDrgPFqD0yOlEuk8p/8Y5HhkZ2KqFTUkEieWbYO1R5O5mSrSWUzR
   SuNEulKtFzTtF8jLam+zJo+OLeeYeu2LXHknoAnt5/2Gj0Pdg3UvcH6II
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="332730039"
X-IronPort-AV: E=Sophos;i="5.97,289,1669104000"; 
   d="scan'208";a="332730039"
Received: from orsmga005.jf.intel.com ([10.7.209.41])
  by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 21:57:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="842242683"
X-IronPort-AV: E=Sophos;i="5.97,289,1669104000"; 
   d="scan'208";a="842242683"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orsmga005.jf.intel.com with ESMTP; 10 Feb 2023 21:57:44 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Fri, 10 Feb 2023 21:57:43 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Fri, 10 Feb 2023 21:57:43 -0800
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (104.47.59.171)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Fri, 10 Feb 2023 21:57:43 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=CpZxtuAzlsHAKP59HSeSoPB9sDirQ9tOipZfXfS6xc0poqqCODIw+XxWp32vZQyWZv/SPdsg1qMPmbCa6tmEIO0pB5Rpk2jQSe7gu1nUDCNB/gXFlYnj3S1Gf4g2cZRhcxt0mF6QuOlDnteUgxZUiYjc/FMFqoAVBq1hSArXWPc/dImF8T3wuOgyvPGndNo0CTXxiUud3blHWdtw2ZXWtxTiUTONy8B1cSzkyvsnXFmn1AXVSfQY41dNWgOKF3DhByFFhnaHAlbhYm0EbyzyC2aVATgKS83hlbH6MVz7Yj4YmUuROuzVS4X3vBhd26huczDDafbTosUCQS9BdEx72w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=NXon1QKtR4ZOSSK7XCbhQJIjXT2jtMmXZf/P+XmaN50=;
 b=bOqvNaQaomO77XXOfXD7ElPzbZVxRkYyP93aQBIkgi/UYPmo8NmSHBnYJ9iAaVBrjM78PZgLx3fQI4D4lcOoCPGgkEUMXI2cDegXuNsAWS1C6+tDreQXHAS4kWhM0bOIjoU9APHx5ep0I18/zylfpeUgt5V1Rd1RrwmNebzry2H5umtKVkM1RVqGaLdp/etdu2tdwYJg0f/+WwP/wNTmpkiz7fffz4VSJE64z908ewTn61ConnmQjQPbdNAPMoxlRHmrhGJYyx5PUDh/n9y78KvQlPYWptpovFmFi6KP+6//C8z+lWAUBW5GKN+F3sz44WoECgzWKJ3ROtRwgBB8jA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from BN6PR11MB3988.namprd11.prod.outlook.com (2603:10b6:405:7c::23)
 by BL1PR11MB5414.namprd11.prod.outlook.com (2603:10b6:208:31e::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Sat, 11 Feb
 2023 05:57:34 +0000
Received: from BN6PR11MB3988.namprd11.prod.outlook.com
 ([fe80::16cf:5ab1:7f74:d1e5]) by BN6PR11MB3988.namprd11.prod.outlook.com
 ([fe80::16cf:5ab1:7f74:d1e5%7]) with mapi id 15.20.6086.019; Sat, 11 Feb 2023
 05:57:34 +0000
From: "Verma, Vishal L" <vishal.l.verma@intel.com>
To: "Williams, Dan J" <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
CC: "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "Hocko, Michal" <mhocko@suse.com>,
        "fan.ni@samsung.com" <fan.ni@samsung.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "david@redhat.com" <david@redhat.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 19/20] dax: Assign RAM regions to memory-hotplug by
 default
Thread-Topic: [PATCH v2 19/20] dax: Assign RAM regions to memory-hotplug by
 default
Thread-Index: AQHZPS8Xi4/K8RB93UaQXUo4w6y3SK7JQRcA
Date: Sat, 11 Feb 2023 05:57:33 +0000
Message-ID: <25626477e9500b1e17c15d5fbab1fd067dd57ef7.camel@intel.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
         <167602003336.1924368.6809503401422267885.stgit@dwillia2-xfh.jf.intel.com>
In-Reply-To: <167602003336.1924368.6809503401422267885.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.46.3 (3.46.3-1.fc37) 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: BN6PR11MB3988:EE_|BL1PR11MB5414:EE_
x-ms-office365-filtering-correlation-id: 3959da7e-0313-4a7a-3010-08db0bf4dec1
x-ld-processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: TdzIsfqA+ZkS0ORs+JkAj7I52MNBZXafHuuiNfSnNzD+Y9qG/tFNvfzpoJuw5sVT8EmFVMm65yKmhrMDV70LPJmMQSIfie855EYARt+DzRyWyEDrLIc+eHT859qXo5j0Fbd5x/DYizeFpIEDbrd2uw2jOGGEaOi340Rbyd2LZYH5hjToSEudnhfu2C1E8YlCi2Wz/u/8Kn3hhquNjyRvIYwIIKAfUquEd9fMUTWr9jmw74C91WXK0pEyGIH1AN7XfoREMZovwz6rIkFoz0w3D16mGGAoMOLOn/wJx//dcTMeaSfx5OWfxiX3kQ6qSn8BPZRdjBK6AaEBaB1uYHwdDOziAGq+F0m75DSh2hKb1VkH6AxX6H4YeecmcLuiw5awaTsFHNV1Gb28tZH14DKpt0gUSDF81FXEGymbwKYUydEYcTlcIRn2dxklXWuasYzA06MCHIXNs51B1KMgMQoqyzP9gcuZgA3jJoMriC6AqmVclo/39Q4z5OrHZQRmmox7dFIEZ8p8FV5e0OQmbkTdKS55M37PgW8p8hwACfdF1cybWmPTPX0iEvGejsGdQLDrIdl7Pxucb+68Xgd6hMvO0y1oURupxEHWaZ5F7TmWo9asLI2EOK2Z0v/CNJW5tKHeopA+db8Px/3KgWXC2apPf62jI1UFSJR3d50COAZzQTKOwJGKZD1scLq9nBO6KYDdQ0iQQl9QgopkpzuXtsrrrm6cGNL9ffmj2Jdk1ATca7Q=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR11MB3988.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(396003)(39860400002)(366004)(376002)(136003)(346002)(451199018)(2906002)(86362001)(82960400001)(38100700002)(122000001)(6486002)(71200400001)(2616005)(966005)(6506007)(6512007)(36756003)(38070700005)(26005)(186003)(91956017)(83380400001)(54906003)(316002)(66946007)(110136005)(41300700001)(4326008)(478600001)(66556008)(8676002)(66446008)(76116006)(64756008)(8936002)(66476007)(5660300002);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?WlN4RVRHeFFla0FJcHQxZ0Nmd0dETGp1SDhFd3ZlOFljTnBLRTgySDAxeGti?=
 =?utf-8?B?a05DUEFkZEc2TzUyTThJa2Z4WndBb2tjaEFhcVYwb242eVFaeW0zLzcrUlZY?=
 =?utf-8?B?bVZBb2hVeDNtTUc2UEpua2drVi9wcW1CVDNqZXlUeEhMK2U2MC9xemFBQWJy?=
 =?utf-8?B?d2FSNS95NElCSzFUK1RNNDhydTk1K0luSG5aZTg5U1VWeWRHeVZmQzhQeURr?=
 =?utf-8?B?Q25xQXRHNjgzVmNsZTVuUld6b3dGL05pTDRxbC96cTBOdXRTUjJqUTNOMm9U?=
 =?utf-8?B?N2pTNlpwRy9JcGN1MmUvcmRsZlRvaDJOUlJUV3REcFNHZ3lZVk5vMUtRcjBy?=
 =?utf-8?B?TnhMSzYrVXpFeDk5QnlHR1AxNExIOUZqTW9TRmxSWmdPRnYwSjNuYXV4T3Z2?=
 =?utf-8?B?dWpXRTViVFV0MUJINVdNMS9xNGI3OXZCWFdIVHdhRTNRR3NVTlBzRGVlVm9j?=
 =?utf-8?B?WVNxbUl0Z3IxV0xjT3AzcDJjQTdhc0R5cy94SzBGeENXYTlRUnpCZnVtYnl5?=
 =?utf-8?B?bmJLMnd3OHU1RWY1WjNuUkgwdXhPT3h5TXJyYUxMQStIcG4zNFJlbFNpaGRv?=
 =?utf-8?B?THdBM0t4NE5RUTNCMmtQSXF1WmIyN0d0eUVzckZldmgwQ1ZjcFowM2MwRDUv?=
 =?utf-8?B?Z0laRXhTSXhlME0rbkFySUpualRyRU5EZnpuRHQ0VllpV1dROUsxb1I2RnEw?=
 =?utf-8?B?K0M3RUpJU1JzNWQvUTN5M3lZQXZMa3dFSUtOdmxSQU4vN0t6blJlL3NUbW5R?=
 =?utf-8?B?MlJKMFBudjlBY2VwQVRpN0tJUG5FQ0k1b1pCbnFrOVhpbHB5WE9xMGJmMWFl?=
 =?utf-8?B?anUwaG5yU3FmRWZmQTVVa3FLcXlySHpGemU2VHlwOVk0cW9scFU2RjROYkxH?=
 =?utf-8?B?a3hzK3BPdXhDL1dzKzNENGxWelMrbG5aZlNwWERXVkFtak4wZ2FnZHNDbVpk?=
 =?utf-8?B?OUNiaFd4MG82YjIxMDVieHA5Z1R6eXNrSnF1ejNCdHowd2JFcS9nWmJvVUR1?=
 =?utf-8?B?VWNUNlF1bTEweExzNldzai91VXJMc0loajlIYkt6eFhvWWxkMkF4UC9lL3Iv?=
 =?utf-8?B?K1BNNkRSc29RQXdTZUd1akx1cUdBNXNac3UvV2xoSmRtT2JNc2FiQ1cxVHFR?=
 =?utf-8?B?WjNiTzdGN0ZqSEtWKzRWbUttdHlsd0dESE1nR1NKOU04QWU0OGpaaXlLTmtP?=
 =?utf-8?B?Tk1CNmozdEtmd3JTRlllZXIrbVdkZnFlVkFKdDhSTlZmaTIweUlVcU16VExm?=
 =?utf-8?B?UnQrSURIdEVCUkd4UWxmRllVUGNod2JRbUZNWnNFYVZERkl4cHdtalpDMUoy?=
 =?utf-8?B?d2ZEeGhLTTd3dmF5dFE2b0cxKzBtbEUzRXFVSUU0TEZoVHF6NlFmamN0UlZD?=
 =?utf-8?B?K0VySjBPNmpwZWgvOFd6KzFHN0N6b0kwMitXY0oxQ25WeXk4UUpLN09abTdz?=
 =?utf-8?B?QTJtMklDY2RsZDFLU1R0NjQ1RHZHSkEzZEMzQkZjWjIvd25sZHAxS1ZQSjRh?=
 =?utf-8?B?L3UyRVZnM0w3R3hGMjNnTjJVSUh0YVFaMEV0anFEN2hBWmNqQUVRT3VWUVhK?=
 =?utf-8?B?d05CaDk0R0lUQ2lVa1JjRGhyMUFnTkVMT3hIeDkxdjNmM1ppS1hxclVvVTdz?=
 =?utf-8?B?K1pJVkNaWnY1cTVRV0lkN1A4NDR5TXBoNUVaa0pOS3dGS1hMRGMwR1ZERnBw?=
 =?utf-8?B?dFVHMWdTb2k2MmJ2NTYrQTRSS0hHV2RtUUxvaHpoYTZLS283aC9GSGdBeUR1?=
 =?utf-8?B?dmdIbHlIa2Y4VFZsT1JhQmYzVS9TcjlHMS9zZndabTU2SUZYMGpVSWw1SXdT?=
 =?utf-8?B?V3BDUVJrMnFITHdDL0lEMzdBUW0rNlBUWTViamRIRXptRXhIcEFxNnNWTDdZ?=
 =?utf-8?B?V1hYdzA0Q3hsVTdnSVd4Vlo3MHMzeTVBdnFrWjl3Y0dmV080WnJWRXEyS2kw?=
 =?utf-8?B?RXYvTzgvbmsyNklKVW1OMGRHZ25YN243T0IzNVhuZXIzTUdRWVlwTWJjeG1Z?=
 =?utf-8?B?VDJBNnh2bUFDdnN1YnhNQkFEY3Boc0didmVNR0MyR0phZU10QzVneE5Daktx?=
 =?utf-8?B?Z1Q3SkV2Q1NUdUNhL2JtVEZ2NklyMzVoeEM3Zk85cFh4WkppYWpiQlRHc2Vi?=
 =?utf-8?B?blE5c3dlaktXbUhoT054UDRRVEE4UzRDU0Y5aWUwTFhaVjljRlhUcWJYZFp0?=
 =?utf-8?B?TEE9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <78CB314B4F5F97469EE0A8C1F2B5A87C@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: BN6PR11MB3988.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 3959da7e-0313-4a7a-3010-08db0bf4dec1
X-MS-Exchange-CrossTenant-originalarrivaltime: 11 Feb 2023 05:57:34.0029
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: genZjLe1pZnZ/rH25tX6+LfU6AUWS+oOUHYAj7qjkOaaw4x9oF1pMiUWjHG+vwsRSVLstrJuJ3cixhbzracmoSnxYs1sZMUWiMAGd92COnY=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR11MB5414
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

T24gRnJpLCAyMDIzLTAyLTEwIGF0IDAxOjA3IC0wODAwLCBEYW4gV2lsbGlhbXMgd3JvdGU6Cj4g
VGhlIGRlZmF1bHQgbW9kZSBmb3IgZGV2aWNlLWRheCBpbnN0YW5jZXMgaXMgYmFja3dhcmRzIGZv
ciBSQU0tcmVnaW9ucwo+IGFzIGV2aWRlbmNlZCBieSB0aGUgZmFjdCB0aGF0IGl0IHRlbmRzIHRv
IGNhdGNoIGVuZCB1c2VycyBieSBzdXJwcmlzZS4KPiAiV2hlcmUgaXMgbXkgbWVtb3J5PyIuIFJl
Y2FsbCB0aGF0IHBsYXRmb3JtcyBhcmUgaW5jcmVhc2luZ2x5IHNoaXBwaW5nCj4gd2l0aCBwZXJm
b3JtYW5jZS1kaWZmZXJlbnRpYXRlZCBtZW1vcnkgcG9vbHMgYmV5b25kIHR5cGljYWwgRFJBTSBh
bmQKPiBOVU1BIGVmZmVjdHMuIFRoaXMgaW5jbHVkZXMgSEJNIChoaWdoLWJhbmR3aWR0aC1tZW1v
cnkpIGFuZCBDWEwgKGR5bmFtaWMKPiBpbnRlcmxlYXZlLCB2YXJpZWQgbWVkaWEgdHlwZXMsIGFu
ZCBmdXR1cmUgZmFicmljIGF0dGFjaGVkCj4gcG9zc2liaWxpdGllcykuCj4gCj4gRm9yIHRoaXMg
cmVhc29uIHRoZSBFRklfTUVNT1JZX1NQIChFRkkgU3BlY2lhbCBQdXJwb3NlIE1lbW9yeSA9PiBM
aW51eAo+ICdTb2Z0IFJlc2VydmVkJykgYXR0cmlidXRlIGlzIGV4cGVjdGVkIHRvIGJlIGFwcGxp
ZWQgdG8gYWxsIG1lbW9yeS1wb29scwo+IHRoYXQgYXJlIG5vdCB0aGUgZ2VuZXJhbCBwdXJwb3Nl
IHBvb2wuIFRoaXMgZGVzaWduYXRpb24gZ2l2ZXMgYW4KPiBPcGVyYXRpbmcgU3lzdGVtIGEgY2hh
bmNlIHRvIGRlZmVyIHVzYWdlIG9mIGEgbWVtb3J5IHBvb2wgdW50aWwgbGF0ZXIgaW4KPiB0aGUg
Ym9vdCBwcm9jZXNzIHdoZXJlIGl0cyBwZXJmb3JtYW5jZSBwcm9wZXJ0aWVzIGNhbiBiZSBpbnRl
cnJvZ2F0ZWQKPiBhbmQgYWRtaW5pc3RyYXRvciBwb2xpY3kgY2FuIGJlIGFwcGxpZWQuCj4gCj4g
J1NvZnQgUmVzZXJ2ZWQnIG1lbW9yeSBjYW4gYmUgYW55dGhpbmcgZnJvbSB0b28gbGltaXRlZCBh
bmQgcHJlY2lvdXMgdG8KPiBiZSBwYXJ0IG9mIHRoZSBnZW5lcmFsIHB1cnBvc2UgcG9vbCAoSEJN
KSwgdG9vIHNsb3cgdG8gaG9zdCBob3Qga2VybmVsCj4gZGF0YSBzdHJ1Y3R1cmVzIChzb21lIFBN
RU0gbWVkaWEpLCBvciBhbnl0aGluZyBpbiBiZXR3ZWVuLiBIb3dldmVyLCBpbgo+IHRoZSBhYnNl
bmNlIG9mIGFuIGV4cGxpY2l0IHBvbGljeSwgdGhlIG1lbW9yeSBzaG91bGQgYXQgbGVhc3QgYmUg
bWFkZQo+IHVzYWJsZSBieSBkZWZhdWx0LiBUaGUgY3VycmVudCBkZXZpY2UtZGF4IGRlZmF1bHQg
aGlkZXMgYWxsCj4gbm9uLWdlbmVyYWwtcHVycG9zZSBtZW1vcnkgYmVoaW5kIGEgZGV2aWNlIGlu
dGVyZmFjZS4KPiAKPiBUaGUgZXhwZWN0YXRpb24gaXMgdGhhdCB0aGUgZGlzdHJpYnV0aW9uIG9m
IHVzZXJzIHRoYXQgd2FudCB0aGUgbWVtb3J5Cj4gb25saW5lIGJ5IGRlZmF1bHQgdnMgZGV2aWNl
LWRlZGljYXRlZC1hY2Nlc3MgYnkgZGVmYXVsdCBmb2xsb3dzIHRoZQo+IFBhcmV0byBwcmluY2lw
bGUuIEEgc21hbGwgbnVtYmVyIG9mIGVubGlnaHRlbmVkIHVzZXJzIG1heSB3YW50IHRvIGRvCj4g
dXNlcnNwYWNlIG1lbW9yeSBtYW5hZ2VtZW50IHRocm91Z2ggYSBkZXZpY2UsIGJ1dCBnZW5lcmFs
IHVzZXJzIGp1c3QKPiB3YW50IHRoZSBrZXJuZWwgdG8gbWFrZSB0aGUgbWVtb3J5IGF2YWlsYWJs
ZSB3aXRoIGFuIG9wdGlvbiB0byBnZXQgbW9yZQo+IGFkdmFuY2VkIGxhdGVyLgo+IAo+IEFycmFu
Z2UgZm9yIGFsbCBkZXZpY2UtZGF4IGluc3RhbmNlcyBub3QgYmFja2VkIGJ5IFBNRU0gdG8gZGVm
YXVsdCB0bwo+IGF0dGFjaGluZyB0byB0aGUgZGF4X2ttZW0gZHJpdmVyLiBGcm9tIHRoZXJlIHRo
ZSBiYXNlbGluZSBtZW1vcnkgaG90cGx1Zwo+IHBvbGljeSAoQ09ORklHX01FTU9SWV9IT1RQTFVH
X0RFRkFVTFRfT05MSU5FIC8gbWVtaHBfZGVmYXVsdF9zdGF0ZT0pCj4gZ2F0ZXMgd2hldGhlciB0
aGUgbWVtb3J5IGNvbWVzIG9ubGluZSBvciBzdGF5cyBvZmZsaW5lLiBXaGVyZSwgaWYgaXQKPiBz
dGF5cyBvZmZsaW5lLCBpdCBjYW4gYmUgcmVsaWFibHkgY29udmVydGVkIGJhY2sgdG8gZGV2aWNl
LW1vZGUgd2hlcmUgaXQKPiBjYW4gYmUgcGFydGl0aW9uZWQsIG9yIGZyb250ZWQgYnkgYSB1c2Vy
c3BhY2UgYWxsb2NhdG9yLgo+IAo+IFNvLCBpZiBzb21lb25lIHdhbnRzIGRldmljZS1kYXggaW5z
dGFuY2VzIGZvciB0aGVpciAnU29mdCBSZXNlcnZlZCcKPiBtZW1vcnk6Cj4gCj4gMS8gQnVpbGQg
YSBrZXJuZWwgd2l0aCBDT05GSUdfTUVNT1JZX0hPVFBMVUdfREVGQVVMVF9PTkxJTkU9biBvciBi
b290Cj4gwqDCoCB3aXRoIG1lbWhwX2RlZmF1bHRfc3RhdGU9b2ZmbGluZSwgb3Igcm9sbCB0aGUg
ZGljZSBhbmQgaG9wZSB0aGF0IHRoZQo+IMKgwqAga2VybmVsIGhhcyBub3QgcGlubmVkIGEgcGFn
ZSBpbiB0aGF0IG1lbW9yeSBiZWZvcmUgc3RlcCAyLgo+IAo+IDIvIFdyaXRlIGEgdWRldiBydWxl
IHRvIGNvbnZlcnQgdGhlIHRhcmdldCBkYXggZGV2aWNlKHMpIGZyb20KPiDCoMKgICdzeXN0ZW0t
cmFtJyBtb2RlIHRvICdkZXZkYXgnIG1vZGU6Cj4gCj4gwqDCoCBkYXhjdGwgcmVjb25maWd1cmUt
ZGV2aWNlICRkYXggLW0gZGV2ZGF4IC1mCj4gCj4gQ2M6IE1pY2hhbCBIb2NrbyA8bWhvY2tvQHN1
c2UuY29tPgo+IENjOiBEYXZpZCBIaWxkZW5icmFuZCA8ZGF2aWRAcmVkaGF0LmNvbT4KPiBDYzog
RGF2ZSBIYW5zZW4gPGRhdmUuaGFuc2VuQGxpbnV4LmludGVsLmNvbT4KPiBSZXZpZXdlZC1ieTog
R3JlZ29yeSBQcmljZSA8Z3JlZ29yeS5wcmljZUBtZW12ZXJnZS5jb20+Cj4gVGVzdGVkLWJ5OiBG
YW4gTmkgPGZhbi5uaUBzYW1zdW5nLmNvbT4KPiBMaW5rOiBodHRwczovL2xvcmUua2VybmVsLm9y
Zy9yLzE2NzU2NDU0NDUxMy44NDcxNDYuNDY0NTY0NjE3Nzg2NDM2NTc1NS5zdGdpdEBkd2lsbGlh
Mi14ZmguamYuaW50ZWwuY29tCj4gU2lnbmVkLW9mZi1ieTogRGFuIFdpbGxpYW1zIDxkYW4uai53
aWxsaWFtc0BpbnRlbC5jb20+Cj4gLS0tCj4gwqBkcml2ZXJzL2RheC9LY29uZmlnwqDCoMKgwqAg
fMKgwqDCoCAyICstCj4gwqBkcml2ZXJzL2RheC9idXMuY8KgwqDCoMKgwqDCoCB8wqDCoCA1MyAr
KysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQo+IMKgZHJpdmVy
cy9kYXgvYnVzLmjCoMKgwqDCoMKgwqAgfMKgwqAgMTIgKysrKysrKysrLS0KPiDCoGRyaXZlcnMv
ZGF4L2RldmljZS5jwqDCoMKgIHzCoMKgwqAgMyArLS0KPiDCoGRyaXZlcnMvZGF4L2htZW0vaG1l
bS5jIHzCoMKgIDEyICsrKysrKysrKystCj4gwqBkcml2ZXJzL2RheC9rbWVtLmPCoMKgwqDCoMKg
IHzCoMKgwqAgMSArCj4gwqA2IGZpbGVzIGNoYW5nZWQsIDQ2IGluc2VydGlvbnMoKyksIDM3IGRl
bGV0aW9ucygtKQoKTG9va3MgZ29vZCwKClJldmlld2VkLWJ5OiBWaXNoYWwgVmVybWEgPHZpc2hh
bC5sLnZlcm1hQGludGVsLmNvbT4KCj4gCj4gZGlmZiAtLWdpdCBhL2RyaXZlcnMvZGF4L0tjb25m
aWcgYi9kcml2ZXJzL2RheC9LY29uZmlnCj4gaW5kZXggZDEzYzg4OWMyYTY0Li4xMTYzZWI2MmU1
ZjYgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9kYXgvS2NvbmZpZwo+ICsrKyBiL2RyaXZlcnMvZGF4
L0tjb25maWcKPiBAQCAtNTAsNyArNTAsNyBAQCBjb25maWcgREVWX0RBWF9ITUVNX0RFVklDRVMK
PiDCoMKgwqDCoMKgwqDCoMKgZGVmX2Jvb2wgeQo+IMKgCj4gwqBjb25maWcgREVWX0RBWF9LTUVN
Cj4gLcKgwqDCoMKgwqDCoMKgdHJpc3RhdGUgIktNRU0gREFYOiB2b2xhdGlsZS11c2Ugb2YgcGVy
c2lzdGVudCBtZW1vcnkiCj4gK8KgwqDCoMKgwqDCoMKgdHJpc3RhdGUgIktNRU0gREFYOiBtYXAg
ZGF4LWRldmljZXMgYXMgU3lzdGVtLVJBTSIKPiDCoMKgwqDCoMKgwqDCoMKgZGVmYXVsdCBERVZf
REFYCj4gwqDCoMKgwqDCoMKgwqDCoGRlcGVuZHMgb24gREVWX0RBWAo+IMKgwqDCoMKgwqDCoMKg
wqBkZXBlbmRzIG9uIE1FTU9SWV9IT1RQTFVHICMgZm9yIGFkZF9tZW1vcnkoKSBhbmQgZnJpZW5k
cwo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2RheC9idXMuYyBiL2RyaXZlcnMvZGF4L2J1cy5jCj4g
aW5kZXggMWRhZDgxM2VlNGE2Li4wMTJkNTc2MDA0ZTkgMTAwNjQ0Cj4gLS0tIGEvZHJpdmVycy9k
YXgvYnVzLmMKPiArKysgYi9kcml2ZXJzL2RheC9idXMuYwo+IEBAIC01Niw2ICs1NiwyNSBAQCBz
dGF0aWMgaW50IGRheF9tYXRjaF9pZChzdHJ1Y3QgZGF4X2RldmljZV9kcml2ZXIgKmRheF9kcnYs
IHN0cnVjdCBkZXZpY2UgKmRldikKPiDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIG1hdGNoOwo+IMKg
fQo+IMKgCj4gK3N0YXRpYyBpbnQgZGF4X21hdGNoX3R5cGUoc3RydWN0IGRheF9kZXZpY2VfZHJp
dmVyICpkYXhfZHJ2LCBzdHJ1Y3QgZGV2aWNlICpkZXYpCj4gK3sKPiArwqDCoMKgwqDCoMKgwqBl
bnVtIGRheF9kcml2ZXJfdHlwZSB0eXBlID0gREFYRFJWX0RFVklDRV9UWVBFOwo+ICvCoMKgwqDC
oMKgwqDCoHN0cnVjdCBkZXZfZGF4ICpkZXZfZGF4ID0gdG9fZGV2X2RheChkZXYpOwo+ICsKPiAr
wqDCoMKgwqDCoMKgwqBpZiAoZGV2X2RheC0+cmVnaW9uLT5yZXMuZmxhZ3MgJiBJT1JFU09VUkNF
X0RBWF9LTUVNKQo+ICvCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqB0eXBlID0gREFYRFJW
X0tNRU1fVFlQRTsKPiArCj4gK8KgwqDCoMKgwqDCoMKgaWYgKGRheF9kcnYtPnR5cGUgPT0gdHlw
ZSkKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIDE7Cj4gKwo+ICvCoMKg
wqDCoMKgwqDCoC8qIGRlZmF1bHQgdG8gZGV2aWNlIG1vZGUgaWYgZGF4X2ttZW0gaXMgZGlzYWJs
ZWQgKi8KPiArwqDCoMKgwqDCoMKgwqBpZiAoZGF4X2Rydi0+dHlwZSA9PSBEQVhEUlZfREVWSUNF
X1RZUEUgJiYKPiArwqDCoMKgwqDCoMKgwqDCoMKgwqAgIUlTX0VOQUJMRUQoQ09ORklHX0RFVl9E
QVhfS01FTSkpCj4gK8KgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHJldHVybiAxOwo+ICsK
PiArwqDCoMKgwqDCoMKgwqByZXR1cm4gMDsKPiArfQo+ICsKPiDCoGVudW0gaWRfYWN0aW9uIHsK
PiDCoMKgwqDCoMKgwqDCoMKgSURfUkVNT1ZFLAo+IMKgwqDCoMKgwqDCoMKgwqBJRF9BREQsCj4g
QEAgLTIxNiwxNCArMjM1LDkgQEAgc3RhdGljIGludCBkYXhfYnVzX21hdGNoKHN0cnVjdCBkZXZp
Y2UgKmRldiwgc3RydWN0IGRldmljZV9kcml2ZXIgKmRydikKPiDCoHsKPiDCoMKgwqDCoMKgwqDC
oMKgc3RydWN0IGRheF9kZXZpY2VfZHJpdmVyICpkYXhfZHJ2ID0gdG9fZGF4X2RydihkcnYpOwo+
IMKgCj4gLcKgwqDCoMKgwqDCoMKgLyoKPiAtwqDCoMKgwqDCoMKgwqAgKiBBbGwgYnV0IHRoZSAn
ZGV2aWNlLWRheCcgZHJpdmVyLCB3aGljaCBoYXMgJ21hdGNoX2Fsd2F5cycKPiAtwqDCoMKgwqDC
oMKgwqAgKiBzZXQsIHJlcXVpcmVzIGFuIGV4YWN0IGlkIG1hdGNoLgo+IC3CoMKgwqDCoMKgwqDC
oCAqLwo+IC3CoMKgwqDCoMKgwqDCoGlmIChkYXhfZHJ2LT5tYXRjaF9hbHdheXMpCj4gK8KgwqDC
oMKgwqDCoMKgaWYgKGRheF9tYXRjaF9pZChkYXhfZHJ2LCBkZXYpKQo+IMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIDE7Cj4gLQo+IC3CoMKgwqDCoMKgwqDCoHJldHVybiBk
YXhfbWF0Y2hfaWQoZGF4X2RydiwgZGV2KTsKPiArwqDCoMKgwqDCoMKgwqByZXR1cm4gZGF4X21h
dGNoX3R5cGUoZGF4X2RydiwgZGV2KTsKPiDCoH0KPiDCoAo+IMKgLyoKPiBAQCAtMTQxMywxMyAr
MTQyNywxMCBAQCBzdHJ1Y3QgZGV2X2RheCAqZGV2bV9jcmVhdGVfZGV2X2RheChzdHJ1Y3QgZGV2
X2RheF9kYXRhICpkYXRhKQo+IMKgfQo+IMKgRVhQT1JUX1NZTUJPTF9HUEwoZGV2bV9jcmVhdGVf
ZGV2X2RheCk7Cj4gwqAKPiAtc3RhdGljIGludCBtYXRjaF9hbHdheXNfY291bnQ7Cj4gLQo+IMKg
aW50IF9fZGF4X2RyaXZlcl9yZWdpc3RlcihzdHJ1Y3QgZGF4X2RldmljZV9kcml2ZXIgKmRheF9k
cnYsCj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgbW9kdWxlICptb2R1
bGUsIGNvbnN0IGNoYXIgKm1vZF9uYW1lKQo+IMKgewo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3Qg
ZGV2aWNlX2RyaXZlciAqZHJ2ID0gJmRheF9kcnYtPmRydjsKPiAtwqDCoMKgwqDCoMKgwqBpbnQg
cmMgPSAwOwo+IMKgCj4gwqDCoMKgwqDCoMKgwqDCoC8qCj4gwqDCoMKgwqDCoMKgwqDCoCAqIGRh
eF9idXNfcHJvYmUoKSBjYWxscyBkYXhfZHJ2LT5wcm9iZSgpIHVuY29uZGl0aW9uYWxseS4KPiBA
QCAtMTQzNCwyNiArMTQ0NSw3IEBAIGludCBfX2RheF9kcml2ZXJfcmVnaXN0ZXIoc3RydWN0IGRh
eF9kZXZpY2VfZHJpdmVyICpkYXhfZHJ2LAo+IMKgwqDCoMKgwqDCoMKgwqBkcnYtPm1vZF9uYW1l
ID0gbW9kX25hbWU7Cj4gwqDCoMKgwqDCoMKgwqDCoGRydi0+YnVzID0gJmRheF9idXNfdHlwZTsK
PiDCoAo+IC3CoMKgwqDCoMKgwqDCoC8qIHRoZXJlIGNhbiBvbmx5IGJlIG9uZSBkZWZhdWx0IGRy
aXZlciAqLwo+IC3CoMKgwqDCoMKgwqDCoG11dGV4X2xvY2soJmRheF9idXNfbG9jayk7Cj4gLcKg
wqDCoMKgwqDCoMKgbWF0Y2hfYWx3YXlzX2NvdW50ICs9IGRheF9kcnYtPm1hdGNoX2Fsd2F5czsK
PiAtwqDCoMKgwqDCoMKgwqBpZiAobWF0Y2hfYWx3YXlzX2NvdW50ID4gMSkgewo+IC3CoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBtYXRjaF9hbHdheXNfY291bnQtLTsKPiAtwqDCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgV0FSTl9PTigxKTsKPiAtwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqDCoMKgcmMgPSAtRUlOVkFMOwo+IC3CoMKgwqDCoMKgwqDCoH0KPiAtwqDCoMKgwqDCoMKg
wqBtdXRleF91bmxvY2soJmRheF9idXNfbG9jayk7Cj4gLcKgwqDCoMKgwqDCoMKgaWYgKHJjKQo+
IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7Cj4gLQo+IC3CoMKgwqDC
oMKgwqDCoHJjID0gZHJpdmVyX3JlZ2lzdGVyKGRydik7Cj4gLcKgwqDCoMKgwqDCoMKgaWYgKHJj
ICYmIGRheF9kcnYtPm1hdGNoX2Fsd2F5cykgewo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqBtdXRleF9sb2NrKCZkYXhfYnVzX2xvY2spOwo+IC3CoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqBtYXRjaF9hbHdheXNfY291bnQgLT0gZGF4X2Rydi0+bWF0Y2hfYWx3YXlzOwo+IC3C
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBtdXRleF91bmxvY2soJmRheF9idXNfbG9jayk7
Cj4gLcKgwqDCoMKgwqDCoMKgfQo+IC0KPiAtwqDCoMKgwqDCoMKgwqByZXR1cm4gcmM7Cj4gK8Kg
wqDCoMKgwqDCoMKgcmV0dXJuIGRyaXZlcl9yZWdpc3RlcihkcnYpOwo+IMKgfQo+IMKgRVhQT1JU
X1NZTUJPTF9HUEwoX19kYXhfZHJpdmVyX3JlZ2lzdGVyKTsKPiDCoAo+IEBAIC0xNDYzLDcgKzE0
NTUsNiBAQCB2b2lkIGRheF9kcml2ZXJfdW5yZWdpc3RlcihzdHJ1Y3QgZGF4X2RldmljZV9kcml2
ZXIgKmRheF9kcnYpCj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBkYXhfaWQgKmRheF9pZCwgKl9p
ZDsKPiDCoAo+IMKgwqDCoMKgwqDCoMKgwqBtdXRleF9sb2NrKCZkYXhfYnVzX2xvY2spOwo+IC3C
oMKgwqDCoMKgwqDCoG1hdGNoX2Fsd2F5c19jb3VudCAtPSBkYXhfZHJ2LT5tYXRjaF9hbHdheXM7
Cj4gwqDCoMKgwqDCoMKgwqDCoGxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShkYXhfaWQsIF9pZCwg
JmRheF9kcnYtPmlkcywgbGlzdCkgewo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
bGlzdF9kZWwoJmRheF9pZC0+bGlzdCk7Cj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKg
wqBrZnJlZShkYXhfaWQpOwo+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2RheC9idXMuaCBiL2RyaXZl
cnMvZGF4L2J1cy5oCj4gaW5kZXggZmJiOTQwMjkzZDZkLi44Y2Q3OWFiMzQyOTIgMTAwNjQ0Cj4g
LS0tIGEvZHJpdmVycy9kYXgvYnVzLmgKPiArKysgYi9kcml2ZXJzL2RheC9idXMuaAo+IEBAIC0x
MSw3ICsxMSwxMCBAQCBzdHJ1Y3QgZGF4X2RldmljZTsKPiDCoHN0cnVjdCBkYXhfcmVnaW9uOwo+
IMKgdm9pZCBkYXhfcmVnaW9uX3B1dChzdHJ1Y3QgZGF4X3JlZ2lvbiAqZGF4X3JlZ2lvbik7Cj4g
wqAKPiAtI2RlZmluZSBJT1JFU09VUkNFX0RBWF9TVEFUSUMgKDFVTCA8PCAwKQo+ICsvKiBkYXgg
YnVzIHNwZWNpZmljIGlvcmVzb3VyY2UgZmxhZ3MgKi8KPiArI2RlZmluZSBJT1JFU09VUkNFX0RB
WF9TVEFUSUMgQklUKDApCj4gKyNkZWZpbmUgSU9SRVNPVVJDRV9EQVhfS01FTSBCSVQoMSkKPiAr
Cj4gwqBzdHJ1Y3QgZGF4X3JlZ2lvbiAqYWxsb2NfZGF4X3JlZ2lvbihzdHJ1Y3QgZGV2aWNlICpw
YXJlbnQsIGludCByZWdpb25faWQsCj4gwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBz
dHJ1Y3QgcmFuZ2UgKnJhbmdlLCBpbnQgdGFyZ2V0X25vZGUsIHVuc2lnbmVkIGludCBhbGlnbiwK
PiDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoHVuc2lnbmVkIGxvbmcgZmxhZ3MpOwo+
IEBAIC0yNSwxMCArMjgsMTUgQEAgc3RydWN0IGRldl9kYXhfZGF0YSB7Cj4gwqAKPiDCoHN0cnVj
dCBkZXZfZGF4ICpkZXZtX2NyZWF0ZV9kZXZfZGF4KHN0cnVjdCBkZXZfZGF4X2RhdGEgKmRhdGEp
Owo+IMKgCj4gK2VudW0gZGF4X2RyaXZlcl90eXBlIHsKPiArwqDCoMKgwqDCoMKgwqBEQVhEUlZf
S01FTV9UWVBFLAo+ICvCoMKgwqDCoMKgwqDCoERBWERSVl9ERVZJQ0VfVFlQRSwKPiArfTsKPiAr
Cj4gwqBzdHJ1Y3QgZGF4X2RldmljZV9kcml2ZXIgewo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3Qg
ZGV2aWNlX2RyaXZlciBkcnY7Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBsaXN0X2hlYWQgaWRz
Owo+IC3CoMKgwqDCoMKgwqDCoGludCBtYXRjaF9hbHdheXM7Cj4gK8KgwqDCoMKgwqDCoMKgZW51
bSBkYXhfZHJpdmVyX3R5cGUgdHlwZTsKPiDCoMKgwqDCoMKgwqDCoMKgaW50ICgqcHJvYmUpKHN0
cnVjdCBkZXZfZGF4ICpkZXYpOwo+IMKgwqDCoMKgwqDCoMKgwqB2b2lkICgqcmVtb3ZlKShzdHJ1
Y3QgZGV2X2RheCAqZGV2KTsKPiDCoH07Cj4gZGlmZiAtLWdpdCBhL2RyaXZlcnMvZGF4L2Rldmlj
ZS5jIGIvZHJpdmVycy9kYXgvZGV2aWNlLmMKPiBpbmRleCA1NDk0ZDc0NWNlZDUuLmVjZGZmNzll
MzFmMiAxMDA2NDQKPiAtLS0gYS9kcml2ZXJzL2RheC9kZXZpY2UuYwo+ICsrKyBiL2RyaXZlcnMv
ZGF4L2RldmljZS5jCj4gQEAgLTQ3NSw4ICs0NzUsNyBAQCBFWFBPUlRfU1lNQk9MX0dQTChkZXZf
ZGF4X3Byb2JlKTsKPiDCoAo+IMKgc3RhdGljIHN0cnVjdCBkYXhfZGV2aWNlX2RyaXZlciBkZXZp
Y2VfZGF4X2RyaXZlciA9IHsKPiDCoMKgwqDCoMKgwqDCoMKgLnByb2JlID0gZGV2X2RheF9wcm9i
ZSwKPiAtwqDCoMKgwqDCoMKgwqAvKiBhbGwgcHJvYmUgYWN0aW9ucyBhcmUgdW53b3VuZCBieSBk
ZXZtLCBzbyAucmVtb3ZlIGlzbid0IG5lY2Vzc2FyeSAqLwo+IC3CoMKgwqDCoMKgwqDCoC5tYXRj
aF9hbHdheXMgPSAxLAo+ICvCoMKgwqDCoMKgwqDCoC50eXBlID0gREFYRFJWX0RFVklDRV9UWVBF
LAo+IMKgfTsKPiDCoAo+IMKgc3RhdGljIGludCBfX2luaXQgZGF4X2luaXQodm9pZCkKPiBkaWZm
IC0tZ2l0IGEvZHJpdmVycy9kYXgvaG1lbS9obWVtLmMgYi9kcml2ZXJzL2RheC9obWVtL2htZW0u
Ywo+IGluZGV4IGU3YmRmZjMxMzJmYS4uNWVjMDhmOWY4YTU3IDEwMDY0NAo+IC0tLSBhL2RyaXZl
cnMvZGF4L2htZW0vaG1lbS5jCj4gKysrIGIvZHJpdmVycy9kYXgvaG1lbS9obWVtLmMKPiBAQCAt
MTEsMTUgKzExLDI1IEBAIG1vZHVsZV9wYXJhbV9uYW1lZChyZWdpb25faWRsZSwgcmVnaW9uX2lk
bGUsIGJvb2wsIDA2NDQpOwo+IMKgCj4gwqBzdGF0aWMgaW50IGRheF9obWVtX3Byb2JlKHN0cnVj
dCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCj4gwqB7Cj4gK8KgwqDCoMKgwqDCoMKgdW5zaWduZWQg
bG9uZyBmbGFncyA9IElPUkVTT1VSQ0VfREFYX0tNRU07Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVj
dCBkZXZpY2UgKmRldiA9ICZwZGV2LT5kZXY7Cj4gwqDCoMKgwqDCoMKgwqDCoHN0cnVjdCBkYXhf
cmVnaW9uICpkYXhfcmVnaW9uOwo+IMKgwqDCoMKgwqDCoMKgwqBzdHJ1Y3QgbWVtcmVnaW9uX2lu
Zm8gKm1yaTsKPiDCoMKgwqDCoMKgwqDCoMKgc3RydWN0IGRldl9kYXhfZGF0YSBkYXRhOwo+IMKg
wqDCoMKgwqDCoMKgwqBzdHJ1Y3QgZGV2X2RheCAqZGV2X2RheDsKPiDCoAo+ICvCoMKgwqDCoMKg
wqDCoC8qCj4gK8KgwqDCoMKgwqDCoMKgICogQHJlZ2lvbl9pZGxlID09IHRydWUgaW5kaWNhdGVz
IHRoYXQgYW4gYWRtaW5pc3RyYXRpdmUgYWdlbnQKPiArwqDCoMKgwqDCoMKgwqAgKiB3YW50cyB0
byBtYW5pcHVsYXRlIHRoZSByYW5nZSBwYXJ0aXRpb25pbmcgYmVmb3JlIHRoZSBkZXZpY2VzCj4g
K8KgwqDCoMKgwqDCoMKgICogYXJlIGNyZWF0ZWQsIHNvIGRvIG5vdCBzZW5kIHRoZW0gdG8gdGhl
IGRheF9rbWVtIGRyaXZlciBieQo+ICvCoMKgwqDCoMKgwqDCoCAqIGRlZmF1bHQuCj4gK8KgwqDC
oMKgwqDCoMKgICovCj4gK8KgwqDCoMKgwqDCoMKgaWYgKHJlZ2lvbl9pZGxlKQo+ICvCoMKgwqDC
oMKgwqDCoMKgwqDCoMKgwqDCoMKgwqBmbGFncyA9IDA7Cj4gKwo+IMKgwqDCoMKgwqDCoMKgwqBt
cmkgPSBkZXYtPnBsYXRmb3JtX2RhdGE7Cj4gwqDCoMKgwqDCoMKgwqDCoGRheF9yZWdpb24gPSBh
bGxvY19kYXhfcmVnaW9uKGRldiwgcGRldi0+aWQsICZtcmktPnJhbmdlLAo+IC3CoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDC
oMKgwqAgbXJpLT50YXJnZXRfbm9kZSwgUE1EX1NJWkUsIDApOwo+ICvCoMKgwqDCoMKgwqDCoMKg
wqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqAg
bXJpLT50YXJnZXRfbm9kZSwgUE1EX1NJWkUsIGZsYWdzKTsKPiDCoMKgwqDCoMKgwqDCoMKgaWYg
KCFkYXhfcmVnaW9uKQo+IMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgcmV0dXJuIC1F
Tk9NRU07Cj4gwqAKPiBkaWZmIC0tZ2l0IGEvZHJpdmVycy9kYXgva21lbS5jIGIvZHJpdmVycy9k
YXgva21lbS5jCj4gaW5kZXggNDg1MmEyZGJkYjI3Li45MThkMDFkM2ZiYWEgMTAwNjQ0Cj4gLS0t
IGEvZHJpdmVycy9kYXgva21lbS5jCj4gKysrIGIvZHJpdmVycy9kYXgva21lbS5jCj4gQEAgLTIz
OSw2ICsyMzksNyBAQCBzdGF0aWMgdm9pZCBkZXZfZGF4X2ttZW1fcmVtb3ZlKHN0cnVjdCBkZXZf
ZGF4ICpkZXZfZGF4KQo+IMKgc3RhdGljIHN0cnVjdCBkYXhfZGV2aWNlX2RyaXZlciBkZXZpY2Vf
ZGF4X2ttZW1fZHJpdmVyID0gewo+IMKgwqDCoMKgwqDCoMKgwqAucHJvYmUgPSBkZXZfZGF4X2tt
ZW1fcHJvYmUsCj4gwqDCoMKgwqDCoMKgwqDCoC5yZW1vdmUgPSBkZXZfZGF4X2ttZW1fcmVtb3Zl
LAo+ICvCoMKgwqDCoMKgwqDCoC50eXBlID0gREFYRFJWX0tNRU1fVFlQRSwKPiDCoH07Cj4gwqAK
PiDCoHN0YXRpYyBpbnQgX19pbml0IGRheF9rbWVtX2luaXQodm9pZCkKPiAKCg==

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 30613C636D7
	for <linux-acpi@archiver.kernel.org>; Sat, 11 Feb 2023 14:05:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229692AbjBKOFN (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Sat, 11 Feb 2023 09:05:13 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58596 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229475AbjBKOFM (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Sat, 11 Feb 2023 09:05:12 -0500
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2044.outbound.protection.outlook.com [40.107.244.44])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4314525B9A;
        Sat, 11 Feb 2023 06:05:07 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=WCQS1KjracpvaP662wlIq6t+Sokd98E/fzh395sjRLxzGCJqk1Q/490itDq+XvOA/mr1/pLpFJ9DkqqxvCdyBdybgCuoyl3rRPYaSTRfWOFntnCFWRCDuqOJESo/R0YHlIUJdba/QJO2L8/JB9uFg4860VwjCVUsCLFAP0MGIUUsGqLbv5DTT+dgIthG6GG/NNhRCfhcPw6amiF4dWtKLgiJ8xHimIKrAjt4nmP6XbFhzXJ4iknWULPhKAGwWqF+B4leZPG+u+BWEIZaDTSzgovcsFDM/RAcLBxkzJVoa4PlWfreupYkQIP1z6M81tB8BhzLkjcpxbm/TEv6n7sVpg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=OBnLN7WJV8lgx3QXZ9qsCn2X+CaPJyeJf8lsAtsNspU=;
 b=CADc2+XcqVB+TuQ2Vy9Qalpl4eeGodNqu2r1TF46ZzafgAvxuMhuXut+0Q9PHTrWLt8/3spAewIj8tkLqXj9xIR+OvTxXvPU76nGxRTyXqp/X8bJv0frh6qWAcm4FI6oW7majFSbaWjHGnrIrKMixKb5LxIjHc44tUi0kjkwXCZwMvWoTfDl/nygisYKgNKbmP0q0nDYsuF6Xx+qzrSPcZaag/gsnairl6NA8qT552SP1XGekwpj5goL3AznFef+xBgjGq+cqDI5ZwKnOtyF8mPoF7Vwmu056IGeuZV3PH5Cn7FFEo7WDWR+UcRThYSvGL2YXUSRrptR8Lpq7GnTfw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=OBnLN7WJV8lgx3QXZ9qsCn2X+CaPJyeJf8lsAtsNspU=;
 b=GIyQ7z1eCDcJF2gI4GjWT1I10hHO4lf5Yn6y20XRcDrlBuPnhp8RGVLwfDgm8bhwNjPbhl3bgBx1CWsgdoWJvMADhQMCpCenMRN7eAPliH+1mksbFsdVzVVaYEZFrBl3Irh9DU5o9WXlh/w8/klD/AEPO1fekT9ugAgbrw75mYA=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by MW4PR17MB4859.namprd17.prod.outlook.com (2603:10b6:303:10c::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.22; Sat, 11 Feb
 2023 14:05:02 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%3]) with mapi id 15.20.6086.022; Sat, 11 Feb 2023
 14:05:02 +0000
Date: Sat, 11 Feb 2023 09:04:57 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Dan Williams <dan.j.williams@intel.com>
Cc: linux-cxl@vger.kernel.org, Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>, Fan Ni <fan.ni@samsung.com>,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
Message-ID: <Y+egiS92/AGC+05g@memverge.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <63e6849f4c1a5_36c729462@dwillia2-xfh.jf.intel.com.notmuch>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <63e6849f4c1a5_36c729462@dwillia2-xfh.jf.intel.com.notmuch>
X-ClientProxiedBy: MN2PR06CA0014.namprd06.prod.outlook.com
 (2603:10b6:208:23d::19) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|MW4PR17MB4859:EE_
X-MS-Office365-Filtering-Correlation-Id: 997b4d74-2019-4568-8d06-08db0c38f80e
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: RwPCu/o0mcYxaL/kviAI84cVaj5RTtRaYZ5vqwXWSeFNXuouE7xqm5HXV7lSB1qbMFm9YbjeY3LegvPOxYKeRhNrQUqyeK8K+ib9jeUh7ZivdRhPzLPERCFfhZwsNx0xicStK7Y0zs4EnaPb20Rg3F+8+pc+p2kE2o9bxBPRkwfe8VO/pI+sP5jj6vFFN8Qn0I4pa0zqX+LLw+O3sH0XNIN0c5Q0PiORMjG5qNd8td9P1Lsr5LQEUYBSifc3f4nYcdjmvxRuspcHdiYKOjiAEMkMozGDJ75CwTa4BohzWsDtnAJAQ728eNaiWqHALlNYpERhvDMnc3moAB1aKRDQLUxco12uw+iG1v9u5vWFYiUl/+dFv/aoQtTnswYMtWWPQ+Mu/opiAtz2i+j2XUB0EaXR4yIBn1sLDdv0P7zJ64qddMrjry94sujv9uMmSJ5r1NRt5BUAQm6sb5WmwZbHlLqJ2Dxfny7VQ3OZcD7ME0LLxIc5Bxec2nrQJgbTXahyhvGfTUnfKyIx6SaeqhgeXaW/EImPBHfwu5bYCOF3jXZAY5VNu63zx92hE+3f4voOHiQM6iz+nuoGpQuBnE0RPPkq9C9gg9s3j/Qs6lIvdXW9pcwQ8WZFoyVW56XACrOfv1oBVGAGSxG5T1Lr6THbdI3jV4Kiyt2VTSdV7WHO6jZ5XjuPS/QeLtB7TCz91Avkkng0SSPyR1oBdf+snPjfJQ==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(396003)(39840400004)(136003)(366004)(376002)(451199018)(66574015)(83380400001)(38100700002)(86362001)(2906002)(316002)(54906003)(7416002)(8936002)(66476007)(5660300002)(66946007)(66556008)(44832011)(4326008)(6916009)(8676002)(41300700001)(2616005)(6506007)(6512007)(26005)(186003)(478600001)(966005)(6486002)(36756003)(6666004);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?2wUC3RN/y7j7lc2oQSou6CLYAeF3HbR3xvqrWq6B34BwYL+hfX2aZpN4OupU?=
 =?us-ascii?Q?/XSi9dDLF4PoWS0k0AFu/9/g4koFDw64w4XOez6qvWPMMpkjqn7gQBABZhIS?=
 =?us-ascii?Q?wRn8IvoquO50wZqssDpYyhvFVyH9pZQgbtyZkgYDCWV/rudVCXj+ButpI/ov?=
 =?us-ascii?Q?yszh5wTMCxRJBwK8DXE9hmLs/sTz0nlnQWWCdniDUOP82UtkF3l0Bbily/ck?=
 =?us-ascii?Q?DOO+lIWbpB5YQgAxn5ZE7Ypw5Y6p/KYxV9b7/7WHMgogL+yZEMUcp5CsbaVt?=
 =?us-ascii?Q?qv+TJZ9cpWtnHCGn9L72m2e+bxxql6DNuUIr3xiuhDrPEZqYowQm4P3luZyO?=
 =?us-ascii?Q?sGa6qWPoibWQ2ih7S+yacAiX7DAKgtHWSciY2+5msIe9RMVpInXU8Rvsj+iH?=
 =?us-ascii?Q?u6LCUourT8UK0T2M/zj+iSx7VuOOd52dVgQbYeBsEuyvVr5Id6+Ra2+leKAq?=
 =?us-ascii?Q?XptMOBJ0SZztvloz4rL6q8vkwDCO+bAsif/yrzNQSjfDt2yzwMJfqRP0TD1M?=
 =?us-ascii?Q?kmUoBjToQ/0MoqgkflUdHdWyW/r8ACFQJrXbYUE1gVBwSeK9BrfLIPGLCtlQ?=
 =?us-ascii?Q?wXDuV0YMjkTMExq6Q55bKbOCNM+xNZGRsHH4uDycqVel9HShbTGwuLRy3BeC?=
 =?us-ascii?Q?VUNYhgRG4R8AxtVThto0zs4ARflRpjH7YlrADdOAAsS5ZyPXc1DpsvM0oXZ3?=
 =?us-ascii?Q?Gi6KVnavdZ31Kq9JRBOh2V+veVyC4YhGgDx4veuWUN4GBP9FTUBMZTQCmb24?=
 =?us-ascii?Q?gJsWdJ3B0M3lh8MhsNnxKYP9sMw5KovMs8CWU+hcZ//jUYqYGhP/Vt3djcJI?=
 =?us-ascii?Q?J20+9jv08X1P7LyvFotQBoamVwFUMw80XCSlD7A2gzYXowVVRHQqDXr0EKrs?=
 =?us-ascii?Q?nzAcifxPtkRxJSsRMwqlqJ9nUJWCJ34RbfQJ8fuzBv4bIwUXEGObCujStWr+?=
 =?us-ascii?Q?IS7gvt2DSXTtf+hILDJ8UmpoflyCgmeo340bDYSozSdcy2HwytZB2JXo38Nm?=
 =?us-ascii?Q?3oGR0uFyx7w5AlHKJTnbJTiUFvcPzI4BwGuB/kMITYplUVPwZP2NB6/e63sM?=
 =?us-ascii?Q?VUFUzyHZXO3rArJ+mmd+41CnQXlKJNxDs+R1y/qOgUnNItEZmJBhfeqTLQqF?=
 =?us-ascii?Q?RARHxrIEhSILUF8rSKXdg9rP6SCp984qJU+z8icISAiKT/83S4b6mmIhUw5h?=
 =?us-ascii?Q?L1LOfOxpi+3A5hK8OGOzoHZulxj05VQZ/5SV/yi8oq0V2VdLA0PfY5kvX3Rj?=
 =?us-ascii?Q?GV5eNVCcyIrcA6zFxYkt9aTUVWANPWSHaXCm5pGubAvVPB7vBjUB8zgdg8ek?=
 =?us-ascii?Q?qmXYmR9JJwJ+9gxaNFUcvCxV5kFRx1mf1rxUBz4yPkWvTz5iOpE42uMiILmK?=
 =?us-ascii?Q?5SideBZMmZ0tuiDWBhhorBsRx+Ep18u1e11iw2saJQu5azZixTD3NrxeDGu0?=
 =?us-ascii?Q?CCSBxoxnNSb3k5RnKfpEAvLi98IKAj9FApe3SMyJtStoyIJYatj39TzVN6YC?=
 =?us-ascii?Q?8tGcFbC/jLUHRzuvuiTerq85juO8TFpe0EJTqQc90BvTJrvh+dW1Lv9U6Ax8?=
 =?us-ascii?Q?3r2E8zDEe4T7ht9G7ipz3L4IZ5eNZ93KUSlw0KXLL8E2Veukuehlz1x+g2td?=
 =?us-ascii?Q?Jw=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 997b4d74-2019-4568-8d06-08db0c38f80e
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 11 Feb 2023 14:05:02.5274
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: NUL1kr+6+cg6RMz0KInHwhal6f7XqbZadeP86tNr8dqWPIKJ8HDk//8HvLkT9uqpdav3EfuaKCZ/q0vQB3MFeP4RfjkkYyZUgmBZIfyLA4w=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR17MB4859
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, Feb 10, 2023 at 09:53:35AM -0800, Dan Williams wrote:
> Dan Williams wrote:
> > Changes since v1: [1]
> > - Add a fix for memdev removal racing port removal (found by unit tests)
> > - Add a fix to unwind region target list updates on error in
> >   cxl_region_attach() (Jonathan)
> > - Move the passthrough decoder fix for submission for v6.2-final (Greg)
> > - Fix wrong initcall for cxl_core (Gregory and Davidlohr)
> > - Add an endpoint decoder state (CXL_DECODER_STATE_AUTO) to replace
> >   the flag CXL_DECODER_F_AUTO (Jonathan)
> > - Reflow cmp_decode_pos() to reduce levels of indentation (Jonathan)
> > - Fix a leaked reference count in cxl_add_to_region() (Jonathan)
> > - Make cxl_add_to_region() return an error (Jonathan)
> > - Fix several spurious whitespace changes (Jonathan)
> > - Cleanup some spurious changes from the tools/testing/cxl update
> >   (Jonathan)
> > - Test for == CXL_CONFIG_COMMIT rather than >= CXL_CONFIG_COMMIT
> >   (Jonathan)
> > - Add comment to clarify device_attach() return code expectation in
> >   cxl_add_to_region() (Jonathan)
> > - Add a patch to split cxl_port_probe() into switch and endpoint port
> >   probe calls (Jonathan)
> > - Collect reviewed-by and tested-by tags
> > 
> > [1]: http://lore.kernel.org/r/167564534874.847146.5222419648551436750.stgit@dwillia2-xfh.jf.intel.com
> > 
> > ---
> > Cover letter same as v1
> 
> Thanks for all the review so far! The outstanding backlog is still too
> high to definitively say this will make v6.3:
> 
> http://lore.kernel.org/r/167601992789.1924368.8083994227892600608.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167601996980.1924368.390423634911157277.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167601999378.1924368.15071142145866277623.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167602000547.1924368.11613151863880268868.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167602001107.1924368.11562316181038595611.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167602002771.1924368.5653558226424530127.stgit@dwillia2-xfh.jf.intel.com
> http://lore.kernel.org/r/167602003896.1924368.10335442077318970468.stgit@dwillia2-xfh.jf.intel.com
> 
> ...what I plan to do is provisionally include it in -next and then make
> a judgement call next Friday.
> 
> I am encouraged by Fan's test results:
> 
> http://lore.kernel.org/r/20230208173720.GA709329@bgt-140510-bm03
> 
> ...and am reminded that there are some non-trivial TODOs pent up behind
> region enumeration:
> 
> https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9ea4dcf49878

I have also been testing with generally positive results, I've just been
traveling so internet has been spotty.

I'll post a full breakdown of what i've been doing on monday, including
poking the new kernel boot parameter and such.

~Gregory

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B2FCDC6379F
	for <linux-acpi@archiver.kernel.org>; Mon, 13 Feb 2023 18:23:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229716AbjBMSXB (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Mon, 13 Feb 2023 13:23:01 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43082 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229622AbjBMSWw (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Mon, 13 Feb 2023 13:22:52 -0500
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2048.outbound.protection.outlook.com [40.107.223.48])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8A3C31A96E;
        Mon, 13 Feb 2023 10:22:31 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=itmM3/dR0f93HevGb3FlhC2mtBaNJb8xbSsnteAUPovT0Mv8WCSpbtUbIJ0oFm4Wc+f354cWd0zjFQ6E6Sd15WRXlNuQf2VCD2VqE3V/Vr/z/9uP4su1LOQZJumHmTLFLTs01/gx1hKuxOss0IXbbAAJXsRT003kwJl04fqwL7Lt+VidU8XG+NLwjJqyXM2HHi7dgIbY+vgW6FWnqMPTIxhybwry77LHZjHMfilWTwAro0PX+NloGEg/jztutFXUJfl9XHM6R6wp/yN+6PVfw8N++gAnlAFn5IfOo6Zf8cmQhbzKWSCaUBwF7P38HXnY9KzORvK4uVqcrxy+HNxmxQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=YZ8gFfR9Yph6H0hyfjJASRSXHdy74xMPSppr95Tpchs=;
 b=JyOCiYRGK1RQ1Q/Jw4Gx8TwZrkV+YxhXMtRDpFlVBNE0EC4CH3d+5EF73YBe4ABZ1s5SbpwYqGQF5VdNE6z4L+jo65pS2jH7RtQhMcST4WftE9XsdK6kr7V5KV3jBrPcHE3MScIvrCazHxaK1WCJwjCm6zi61NM9qaWh3J7tNrRB8A6Ex1pE+t0pBKtQHGo2ORGZpc3IFNgiwj6AnDlkjM+1y1hy0bUpN+O8YUOKfZdLpNGzBTtdaymVajlZoAoi4lSeCS9lKwaxSoZeMuXSgHXiGJ/XEi9YfPV5pqoNBM+DhTQcWgtUeKEtGfSwGmW+oPIHaIWBkaUGwTUftu+swg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=YZ8gFfR9Yph6H0hyfjJASRSXHdy74xMPSppr95Tpchs=;
 b=y96aajLB4tOLH+yHzXVG1LjnFeWSHfGdZXiNc49vM1Q35Yq4GaOcEap5ujqjCH2+06z2K7WDvAipzqYdloegHCGYDWt45DliCTLboLKfs/RlRm9GAcRARXl7fF6SbCvbTQU3/7fwdUSIFZtWBQmzHDmImHo9tEEV1HvAQzcoHFs=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by DM8PR17MB5031.namprd17.prod.outlook.com (2603:10b6:8:29::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.24; Mon, 13 Feb
 2023 18:22:28 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%3]) with mapi id 15.20.6086.024; Mon, 13 Feb 2023
 18:22:28 +0000
Date: Mon, 13 Feb 2023 13:22:17 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Dan Williams <dan.j.williams@intel.com>
Cc: linux-cxl@vger.kernel.org, Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>, Fan Ni <fan.ni@samsung.com>,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
Message-ID: <Y+p/2S4rnrOOyZ8w@memverge.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
X-ClientProxiedBy: BYAPR06CA0024.namprd06.prod.outlook.com
 (2603:10b6:a03:d4::37) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|DM8PR17MB5031:EE_
X-MS-Office365-Filtering-Correlation-Id: df99428a-4317-4170-aa0f-08db0def4320
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: r8WT7igO3ayhAr9+dErjh+MXRMgcNdSAE00NahcxIra+LW9PTwQEibmFhMpaX7sLtO1jqklbCP8x/AuWEhIFrA0UAZIp6Lweh19ijbgwUBVN9zXm7Rcp3W2Texih3s59LYmbkEE43V1cRZ2RdaB4LNHxQrLfXm9/12+729c8jJbqifBQxbw3yARG+b2/uxXrgOH7YwfslrtpqgKXAmYs8lt+PeDqJUgJusGC9nbokqAmYIP2NxdNh8+iJ2dtjQnI7YTGqhC8Tl70SfvfzCmDo4tyrhLxUREXxu+QpmbZScbEdP/bwVkD4Q8ub8wINFoPQ+qVIHk6VZoiRlSNgKugxHRnykTSUjpERWBTo5OONOKsIfkaAAD5UgXEEUD9gb+JIhIS5QgZ068JhLa06ALbOwfKp4jlH1I5hJxu5WdPml3upOnzdn7ogFn1CgJxkBu/5HeAWKnLkmI0wLge68gSqc9LZBoTelvax7JeFWDIMzzlPW/NaUuULpTm8jYWzmWbkEQxf8sENH9heIH7iQ2ZXoDy6hoji9KXBxQuMjNGDgse7rOPA+qiTs1E5yLUoxQgry3ZBx42f8mqTXOnrJOv2hB3hSyiu0Hr4xvaegwCSAcnM7RfGNrdYKfy18re6eG21VIcDFMlLvfUc0lfpTH46A==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(396003)(376002)(39830400003)(136003)(366004)(451199018)(36756003)(2906002)(8936002)(316002)(30864003)(44832011)(7416002)(5660300002)(41300700001)(6916009)(66476007)(4326008)(66556008)(8676002)(86362001)(66946007)(38100700002)(54906003)(83380400001)(2616005)(6486002)(6666004)(478600001)(6506007)(6512007)(26005)(186003);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?6FfT22r/eIIlx8XdiJ6FEoLYdN6Nq2fhHAesBxyoT2FOaQZ1hp6/mx7n2rQU?=
 =?us-ascii?Q?JqR14RrOs1A4nsAGQzOoEC7h545fgxcEkYEWwVkfFSFNV7mxJzL6PftFvD6B?=
 =?us-ascii?Q?er/VTQQG/DI19aEPUNP+KI3fvMbb5CRbvSHjiGoBYL47qcuaR/xiCkweKRZ5?=
 =?us-ascii?Q?s/Aby+P1Aghx9UAKBrU1TmxP53NOy2PcECYEs+/yBV0DLy9FeUqmM8DdpYNG?=
 =?us-ascii?Q?uZ97AVxciYZZFGY9vUeyz/lCnwJYf6b2SFvOGfnfML9w3FJ9d8q4UUm6rktW?=
 =?us-ascii?Q?VPUBhDznAdRVydqFQjcqfpVguNLkv+6erogx2BsEWOHVnznzV3Nc85wr7QpY?=
 =?us-ascii?Q?kfkmLhozlpkt11OJWiF98xH4VviOsY6g3Ylz6fG+HfJ9Jp+ep/TAJNnaHjO0?=
 =?us-ascii?Q?Hqq4Y59JFjOyI7dJn28YnlYK2szChgwbaGMmzQTzrNAbifmXET/gtaf2pmHY?=
 =?us-ascii?Q?ZEw4eNKEUKf3BRm9XTom1WaKfa0OSex1hP1MXhcFEs0Rq4Rlz1nx4CTHlHKQ?=
 =?us-ascii?Q?HmFscdCCUcnPHNYJ+r/9FznxDg/6cJ7/lLJQEvA52Ryma2ohT7jVq6gtYyZT?=
 =?us-ascii?Q?zsCbEjb/J5zf4CjJ3P60MRSI9m0oMbygabFV5bc1A8rHzM/5fx5gHmuGljqT?=
 =?us-ascii?Q?LUIVsVFpE8nxyjR2nnTN3BAwuciWNH4dydbEvBcXE5wGIWzt4qdDoIaSszo7?=
 =?us-ascii?Q?GdVdKL/nFPQ12cGpmk8C1G7CtH0VgNdO4hdt5vS8Im8Ycy2yZ1z9Xz/sUgfD?=
 =?us-ascii?Q?pzDJ7q+Ob3Gw4olxDit0AGgo23Xaz0KGvUeiQA6+rz3AMYFl9+jMCpIEbWxN?=
 =?us-ascii?Q?fl16Y0YxOldBfyGkXfx2UsSqRbwUVoL/PRf7m+lC/RL4B5ooyVTRM6nA5wWb?=
 =?us-ascii?Q?S8Y2+zGX2127fkd0vbE/h5PPUA5q3wjdT9aSc3DToElAq4SnpFcvzs+q6gSp?=
 =?us-ascii?Q?LzDIBSEE2t/xEQ+VJEOPo/AUk3ZUPq/9Pl8HVTflSwPBnyGdGCgYbojuRHDN?=
 =?us-ascii?Q?C75FGzIzKRGqbewlHFv9QYL1mvTY/uTuS5kWdWUaVL5hXH1T9fRDZIwupvfY?=
 =?us-ascii?Q?DDCOZqvk8b6bQMTDV4kbK0bKv5+DF+zC+Z3QrErSBbs6cs+VeQyDLqpCLvCL?=
 =?us-ascii?Q?kjHbzygUW3Ndp4Ztx2mL/8tfINrzFACiWSQAk139iLwCPp3AcL9/6yyFynTw?=
 =?us-ascii?Q?UcqBKRXVeoYNESi3MuPsywa2IKD9TDv0RqFQKl5HDsz21FyGwRoh75IXyqVI?=
 =?us-ascii?Q?23v3iPjNKmpHI/5vdHUDmm1Opefn07kOUEazPCLum7/XXTkpNz3ECTZxvl6f?=
 =?us-ascii?Q?K6je/omDv0duHN27mgVILQ0raOJejUu4vcXIcBAw8Jf+Nv3Lt80cibZ+F+75?=
 =?us-ascii?Q?i//smYF+jJP7+P8yQ3Z3mEO9M8IH3wAYZnoGjGgB+YShWzxtQ9XhDQC1utp1?=
 =?us-ascii?Q?2otVWOQU4Ha7HC8GOnHg1Qs42WZTbEDLcZnTkBPx+sY8n+LAOTpLcNpPHthI?=
 =?us-ascii?Q?c2XU0YeIaCoNyLoBk7HpBKwxMshxJx7YmnyyEZrsqsfa2A8plXIOy6pBan+A?=
 =?us-ascii?Q?aPUFquZkCVDOIE2JefCV6AFwsWBZGj/dcTVnHNJe383cITBS1dspzQ4LBPq2?=
 =?us-ascii?Q?9A=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: df99428a-4317-4170-aa0f-08db0def4320
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Feb 2023 18:22:28.0428
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: O7sfS+vyDWUcK+CFeW3VcmP9c+Bs1p9JtsA7isJzHzVJMRsmGbna7ZOIobyUF0RlnIIuPcUZPeYMTtX21cbjKP49+r4YNE5PPXvwa0y46yI=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM8PR17MB5031
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, Feb 10, 2023 at 01:05:21AM -0800, Dan Williams wrote:
> Changes since v1: [1]
> [... snip ...]

For a single attached device - I have been finding general success.

For multiple attached devices, I'm seeing some strange behaviors.

With multiple root ports, I got some stack traces before deciding
I needed multiple CMFW to do this "correctly", and just attached
multiple pxb-cxl to the root bus.

Obviously this configuration is "not great", and some form of
"impossible in the real world", but it's worth examining i think.

/opt/qemu-cxl/bin/qemu-system-x86_64 \
-drive file=/data/qemu/images/pool/pool1.qcow2,format=qcow2,index=0,media=disk,id=hd \
-m 4G,slots=4,maxmem=16G \
-smp 4 \
-machine type=q35,accel=kvm,cxl=on \
-enable-kvm \
-nographic \
-netdev bridge,id=hn0,br=virbr0 \
-device virtio-net-pci,netdev=hn0,id=nic1,mac=52:54:00:12:34:56 \
-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 \
-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=191 \
-device pxb-cxl,id=cxl.2,bus=pcie.0,bus_nr=230 \
-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,port=0,slot=0 \
-device cxl-rp,id=rp1,bus=cxl.1,chassis=0,port=1,slot=1 \
-device cxl-rp,id=rp2,bus=cxl.2,chassis=0,port=2,slot=2 \
-object memory-backend-ram,id=mem0,size=4G \
-object memory-backend-ram,id=mem1,size=4G \
-object memory-backend-ram,id=mem2,size=4G \
-device cxl-type3,bus=rp0,volatile-memdev=mem0,id=cxl-mem0 \
-device cxl-type3,bus=rp1,volatile-memdev=mem1,id=cxl-mem1 \
-device cxl-type3,bus=rp2,volatile-memdev=mem2,id=cxl-mem2 \
-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G,cxl-fmw.1.targets.0=cxl.1,cxl-fmw.1.size=4G,cxl-fmw.2.targets.0=cxl.2,cxl-fmw.2.size=4G

The goal here should be to have 3 different memory expanders have their
regions created and mapped to 3 different numa nodes.

One piece i'm not confident about is my CFMW's
(listed more readably:)

-M cxl-fmw.0.targets.0=cxl.0,
   cxl-fmw.0.size=4G,
   cxl-fmw.1.targets.0=cxl.1,
   cxl-fmw.1.size=4G,
   cxl-fmw.2.targets.0=cxl.2,
   cxl-fmw.2.size=4G

should targets in this case be targets.0/1/2, or all of them targets.0?

Either way, i would expect 3 root decoders, and 3 memory devices

[root@fedora ~]# ls /sys/bus/cxl/devices/
decoder0.0  decoder1.0  decoder4.0  endpoint4  mem0  nvdimm-bridge0  port3
decoder0.1  decoder2.0  decoder5.0  endpoint5  mem1  port1           root0
decoder0.2  decoder3.0  decoder6.0  endpoint6  mem2  port2

I see the devices I expect, but i would expect the following:
(cxl list output at the bottom)

decoder0.0 -> mem0
decoder0.1 -> mem1
decoder0.2 -> mem2

root0 -> [decoder0.0, 0.1, 0.2]
root0 -> [port1, 2, 3]
port1 -> mem0
port2 -> mem1
port3 -> mem2

Really i see these decoders and device mappings setup:
port1 -> mem2
port2 -> mem1
port3 -> mem0

Therefore I should expect
decoder0.0 -> mem2
decoder0.1 -> mem1
decoder0.2 -> mem0

This bears out: attempting to use any other combination produces ndctl errors.

So the numbers are backwards, maybe that's relevant, maybe it's not.
The devices are otherwise completely the same, so for the most part
everything might "just work".  Lets keep testing.


[root@fedora ~]# cat create_region.sh
./ndctl/build/cxl/cxl \
  create-region \
  -m \
  -t ram \
  -d decoder0.$1 \
  -w 1 \
  -g 4096 \
  mem$2

[root@fedora ~]# ./create_region.sh 2 0
[   34.424931] cxl_region region2: Bypassing cpu_cache_invalidate_memregion() for testing!
{
  "region":"region2",
  "resource":"0x790000000",
  "size":"4.00 GiB (4.29 GB)",
  "type":"ram",
  "interleave_ways":1,
  "interleave_granularity":4096,
  "decode_state":"commit",
  "mappings":[
    {
      "position":0,
      "memdev":"mem0",
      "decoder":"decoder4.0"
    }
  ]
}
cxl region: cmd_create_region: created 1 region

[   34.486668] Fallback order for Node 3: 3 0
[   34.487568] Built 1 zonelists, mobility grouping on.  Total pages: 979669
[   34.488206] Policy zone: Normal
[   34.501938] Fallback order for Node 0: 0 3
[   34.502405] Fallback order for Node 1: 1 3 0
[   34.502832] Fallback order for Node 2: 2 3 0
[   34.503251] Fallback order for Node 3: 3 0
[   34.503649] Built 2 zonelists, mobility grouping on.  Total pages: 1012437
[   34.504296] Policy zone: Normal



Cool, looks good.  Lets try mem1



[root@fedora ~]# ./create_region.sh 1 1

[   98.787029] Fallback order for Node 2: 2 3 0
[   98.787630] Built 2 zonelists, mobility grouping on.  Total pages: 2019798
[   98.788483] Policy zone: Normal
[  128.301580] Fallback order for Node 0: 0 2 3
[  128.302084] Fallback order for Node 1: 1 3 2 0
[  128.302547] Fallback order for Node 2: 2 3 0
[  128.303009] Fallback order for Node 3: 3 2 0
[  128.303436] Built 3 zonelists, mobility grouping on.  Total pages: 2052566
[  128.304071] Policy zone: Normal
[ .... wait 20-30 more seconds .... ]
{
  "region":"region1",
  "resource":"0x690000000",
  "size":"4.00 GiB (4.29 GB)",
  "type":"ram",
  "interleave_ways":1,
  "interleave_granularity":4096,
  "decode_state":"commit",
  "mappings":[
    {
      "position":0,
      "memdev":"mem1",
      "decoder":"decoder5.0"
    }
  ]
}
cxl region: cmd_create_region: created 1 region


This takes a LONG time to complete. Maybe that's expected, I don't know.


Lets online mem2.


[root@fedora ~]# ./create_region.sh 0 2
extra data[7]: 0x0000000000000000
emulation failure
RAX=0000000000000000 RBX=ffff8a6f90006800 RCX=0000000000100001 RDX=0000000080100010
RSI=ffffca291a400000 RDI=0000000040000000 RBP=ffff9684c0017a60 RSP=ffff9684c0017a30
R8 =ffff8a6f90006800 R9 =0000000000100001 R10=0000000000000000 R11=0000000000000001
R12=ffffca291a400000 R13=0000000000100001 R14=0000000000000000 R15=0000000080100010
RIP=ffffffffb71c5831 RFL=00010006 [-----P-] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0000 0000000000000000 ffffffff 00c00000
CS =0010 0000000000000000 ffffffff 00a09b00 DPL=0 CS64 [-RA]
SS =0018 0000000000000000 ffffffff 00c09300 DPL=0 DS   [-WA]
DS =0000 0000000000000000 ffffffff 00c00000
FS =0000 00007fd03025db40 ffffffff 00c00000
GS =0000 ffff8a6a7bd00000 ffffffff 00c00000
LDT=0000 0000000000000000 ffffffff 00c00000
TR =0040 fffffe46e6e25000 00004087 00008b00 DPL=0 TSS64-busy
GDT=     fffffe46e6e23000 0000007f
IDT=     fffffe0000000000 00000fff
CR0=80050033 CR2=00005604371ab0c8 CR3=0000000102ece000 CR4=000006e0
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000
DR6=00000000fffe0ff0 DR7=0000000000000400
EFER=0000000000000d01
Code=83 ec 08 81 e7 00 00 00 40 74 2c 48 89 d0 48 89 ca 4c 89 c9 <f0> 48 0f c7 4e 20 0f 84 85 00 00 00 f3 90 48 83 c4 08 31 c0 5b 41 5c 41 5d 41 5e 41 5f 5d


Well that seems bad lol.  I'm not sure what to make of this since my
scrollback cuts off and the machine completely locks up.  I have never
seen "emulation failure" before.


Reboot and attempt to online that region by itself:

[root@fedora ~]# ./create_region.sh 0 2
[   21.292598] cxl_region region0: Bypassing cpu_cache_invalidate_memregion() for testing!
[   21.341753] Fallback order for Node 1: 1 0
[   21.342462] Built 1 zonelists, mobility grouping on.  Total pages: 979670
[   21.343085] Policy zone: Normal
[   21.355166] Fallback order for Node 0: 0 1
[   21.355613] Fallback order for Node 1: 1 0
[   21.356009] Fallback order for Node 2: 2 1 0
[   21.356441] Fallback order for Node 3: 3 1 0
[   21.356874] Built 2 zonelists, mobility grouping on.  Total pages: 1012438
[   21.357501] Policy zone: Normal
{
  "region":"region0",
  "resource":"0x590000000",
  "size":"4.00 GiB (4.29 GB)",
  "type":"ram",
  "interleave_ways":1,
  "interleave_granularity":4096,
  "decode_state":"commit",
  "mappings":[
    {
      "position":0,
      "memdev":"mem2",
      "decoder":"decoder6.0"
    }
  ]
}
cxl region: cmd_create_region: created 1 region


That works fine, and works just like onlining the first region (2,0).

This suggests the issue is actually creating multiple regions in this
topology.



Bonus round: booting with memhp_default_state=offline

All regions successfully get created without error.



I have a few guesses, but haven't dived in yet:

1) There's a QEMU error in the way this configuration routes to various
   components of the CXL structure, and/or multiple pxb-cxl's do bad
   things and I should feel bad for doing this configuration.

2) There's something going on when creating the topology, leading to the
   inverted [decoder0.2, mem0], [decoder0.1, mem1], [decoder0.0, mem2]
   mappings, leading to inconsistent device control.  Or I'm making a
   bad assumption and this is expected behavior.

3) The memory block creation / online code is getting hung up somewhere.
   Why does the second region take forever to online?

4) Something else completely.


My gut at the moment tells me my configuration is bad, but i have no
idea why.  Anyone with an idea on what I should look for, let me know.


cxl list output for completeness:

[root@fedora ~]# ./ndctl/build/cxl/cxl list -vvvv
[
  {
    "bus":"root0",
    "provider":"ACPI.CXL",
    "nr_dports":3,
    "dports":[
      {
        "dport":"pci0000:e6",
        "alias":"ACPI0016:00",
        "id":230
      },
      {
        "dport":"pci0000:bf",
        "alias":"ACPI0016:01",
        "id":191
      },
      {
        "dport":"pci0000:34",
        "alias":"ACPI0016:02",
        "id":52
      }
    ],
    "ports:root0":[
      {
        "port":"port1",
        "host":"pci0000:e6",
        "depth":1,
        "nr_dports":1,
        "dports":[
          {
            "dport":"0000:e6:00.0",
            "id":2
          }
        ],
        "endpoints:port1":[
          {
            "endpoint":"endpoint5",
            "host":"mem1",
            "depth":2,
            "memdev":{
              "memdev":"mem1",
              "ram_size":4294967296,
              "serial":0,
              "host":"0000:e7:00.0",
              "partition_info":{
                "total_size":4294967296,
                "volatile_only_size":4294967296,
                "persistent_only_size":0,
                "partition_alignment_size":0
              }
            },
            "decoders:endpoint5":[
              {
                "decoder":"decoder5.0",
                "interleave_ways":1,
                "state":"disabled"
              }
            ]
          }
        ],
        "decoders:port1":[
          {
            "decoder":"decoder1.0",
            "interleave_ways":1,
            "state":"disabled",
            "nr_targets":1,
            "targets":[
              {
                "target":"0000:e6:00.0",
                "position":0,
                "id":2
              }
            ]
          }
        ]
      },
      {
        "port":"port3",
        "host":"pci0000:34",
        "depth":1,
        "nr_dports":1,
        "dports":[
          {
            "dport":"0000:34:00.0",
            "id":0
          }
        ],
        "endpoints:port3":[
          {
            "endpoint":"endpoint4",
            "host":"mem0",
            "depth":2,
            "memdev":{
              "memdev":"mem0",
              "ram_size":4294967296,
              "serial":0,
              "host":"0000:35:00.0",
              "partition_info":{
                "total_size":4294967296,
                "volatile_only_size":4294967296,
                "persistent_only_size":0,
                "partition_alignment_size":0
              }
            },
            "decoders:endpoint4":[
              {
                "decoder":"decoder4.0",
                "interleave_ways":1,
                "state":"disabled"
              }
            ]
          }
        ],
        "decoders:port3":[
          {
            "decoder":"decoder3.0",
            "interleave_ways":1,
            "state":"disabled",
            "nr_targets":1,
            "targets":[
              {
                "target":"0000:34:00.0",
                "position":0,
                "id":0
              }
            ]
          }
        ]
      },
      {
        "port":"port2",
        "host":"pci0000:bf",
        "depth":1,
        "nr_dports":1,
        "dports":[
          {
            "dport":"0000:bf:00.0",
            "id":1
          }
        ],
        "endpoints:port2":[
          {
            "endpoint":"endpoint6",
            "host":"mem2",
            "depth":2,
            "memdev":{
              "memdev":"mem2",
              "ram_size":4294967296,
              "serial":0,
              "host":"0000:c0:00.0",
              "partition_info":{
                "total_size":4294967296,
                "volatile_only_size":4294967296,
                "persistent_only_size":0,
                "partition_alignment_size":0
              }
            },
            "decoders:endpoint6":[
              {
                "decoder":"decoder6.0",
                "interleave_ways":1,
                "state":"disabled"
              }
            ]
          }
        ],
        "decoders:port2":[
          {
            "decoder":"decoder2.0",
            "interleave_ways":1,
            "state":"disabled",
            "nr_targets":1,
            "targets":[
              {
                "target":"0000:bf:00.0",
                "position":0,
                "id":1
              }
            ]
          }
        ]
      }
    ],
    "decoders:root0":[
      {
        "decoder":"decoder0.0",
        "resource":23890755584,
        "size":4294967296,
        "interleave_ways":1,
        "max_available_extent":4294967296,
        "pmem_capable":true,
        "volatile_capable":true,
        "accelmem_capable":true,
        "nr_targets":1,
        "targets":[
          {
            "target":"pci0000:34",
            "alias":"ACPI0016:02",
            "position":0,
            "id":52
          }
        ]
      },
      {
        "decoder":"decoder0.1",
        "resource":28185722880,
        "size":4294967296,
        "interleave_ways":1,
        "max_available_extent":4294967296,
        "pmem_capable":true,
        "volatile_capable":true,
        "accelmem_capable":true,
        "nr_targets":1,
        "targets":[
          {
            "target":"pci0000:bf",
            "alias":"ACPI0016:01",
            "position":0,
            "id":191
          }
        ]
      },
      {
        "decoder":"decoder0.2",
        "resource":32480690176,
        "size":4294967296,
        "interleave_ways":1,
        "max_available_extent":4294967296,
        "pmem_capable":true,
        "volatile_capable":true,
        "accelmem_capable":true,
        "nr_targets":1,
        "targets":[
          {
            "target":"pci0000:e6",
            "alias":"ACPI0016:00",
            "position":0,
            "id":230
          }
        ]
      }
    ]
  }
]

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 46070C6379F
	for <linux-acpi@archiver.kernel.org>; Mon, 13 Feb 2023 18:31:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229711AbjBMSba (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Mon, 13 Feb 2023 13:31:30 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53924 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229647AbjBMSb3 (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Mon, 13 Feb 2023 13:31:29 -0500
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2076.outbound.protection.outlook.com [40.107.92.76])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AC914EC;
        Mon, 13 Feb 2023 10:31:28 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Q3dviqzBQT3GisVmzpbo99fL/7PWACW/M2G662ZsJocQM1S2qJGFNQ7sRGScGp/tx9TJClrenSgzl7ZrZKMRg4t/feJaMtd+qZmor5MxMErGhOQweLkb3UDzcsjhgIYIDRBmneu+kqXf1aAOTep1ScpjL+Qii4B2HwAoGPCzwWbk3UHtOo8JaRwQE8T6pBxqYBkK7JDPlBG7935XXPi8f4H4zT4IzGV2DXa5mmaFkBST7z3MYvF7h6uWUCGjrBar8EHt8YkybY3OD+CHWwwCW9kRCwIMM+kHR+RmOQxC9pwBwoYok/4sF7BUTicIbIh8PLCBhHdmCflWOGJepuILPQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=jQMQb8bFcXsRczBM6tN89XkK5QXq2Ci0dG49sRceyTM=;
 b=XnDJ/7Ltp82l4cZYk73JlUaLxv3rLUqXlE6TNYP+W5KS3B/5br0xp+6Q2pqs1QdFHUnRkAoqvkYSEF7RHG2MavaGG+gJpOPEBGSybqB3Q/TX93BupjEY5rPQrk7I+qwqVvZoMNswWDcm0TUVIOFHKs/IHCXYxvXClCqNBdzgtpmGVAzF7otO8j8Fwvfp6JGP+0rMPqV72A6KdVmfKuTbiSLkb9ZezhJ4LBsCo7KPjbvLsSX3zMsSlRnnNivwiw93yx4T1H3cAhMC+sH3jfu4dkL8dv5yAcjOQPU0Kk45a+8VMYmwJG0e1A5judIQS3OfNnw8FlwFSpzvFsDSHf0Y4w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jQMQb8bFcXsRczBM6tN89XkK5QXq2Ci0dG49sRceyTM=;
 b=dkKmK/pQ+LYTWqMrrCE6gHw4eTHzCs8YBNJU+rPD6R+MddkIF7xulRmFi9n8aV2s1UzhuPSTC9AeIjD8GYzzksZGfGTJz/hEUpgtqq7PqqUkjbVOSX1SeDccriymPY8jC5WMdmQqV+DlS4umI3SFhC5d7PX8cPBU5nDvLjspJKI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by MW4PR17MB5531.namprd17.prod.outlook.com (2603:10b6:303:126::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.23; Mon, 13 Feb
 2023 18:31:23 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%3]) with mapi id 15.20.6086.024; Mon, 13 Feb 2023
 18:31:23 +0000
Date: Mon, 13 Feb 2023 13:31:17 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Dan Williams <dan.j.williams@intel.com>
Cc: linux-cxl@vger.kernel.org, Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>, Fan Ni <fan.ni@samsung.com>,
        linux-mm@kvack.org, linux-acpi@vger.kernel.org
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
Message-ID: <Y+qB9T/PCZ6TpYlK@memverge.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <Y+p/2S4rnrOOyZ8w@memverge.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Y+p/2S4rnrOOyZ8w@memverge.com>
X-ClientProxiedBy: BY3PR10CA0024.namprd10.prod.outlook.com
 (2603:10b6:a03:255::29) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|MW4PR17MB5531:EE_
X-MS-Office365-Filtering-Correlation-Id: 67ff5507-851e-45e4-ebdc-08db0df08265
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: eD/S+QLbRCQucKAB1yjyS8hK+TTTz4A/+A8k+bNGkPW8CC/oiYfk4XcJSKRfRrfiEMtnwZT345/9Bz0OxiPzrwlBMvWqgq3XJpiDh2dO4BQ+Rkh0WucvqAIsEfQiv8K1jfgp/z99hgzPz3Kwm+fnKtXUz512Bse3AXh+/ckzSMUIjx8o12QthOebXp8XJfl4xZdnskKx2kkzshwTsjF0xLM4aWqfz652M/gTGk4lgYALXx7U12YXbQc4Lndk6UQNC993vmXALgmaLuVl8TqsS/CXec9UdsYboMMNdfLfqY67HZ5V9tdeC5Vr2/jxL+s8YIzytuA9g6t0pjbG6MVDCBOyZlivrcbF/sQdgGb1KNfuZ/hin3bSovvzlTE/j0Z+NJNBzFkaJMvI3D9GLl4qONpwPs0VZnW5r6NtS/elR5ImCf/o/Q5tGCHt3rzC2OzlIxxQpYECnEO8WKndQRJybLnrmvvQNO/5hAkASU8XOW5I7C1CKpNRt/26wM7tF/RGUA/shK8tC9huRDclWy4ll58effAoNcPXBUsJs2IM8d/cvgGVdfqQRwrGXmaKBzUe7QCF+g40vym90hxa8FRongsrX3k/eINr/YcBnUOMnl7nYuT5Oj3/blkULHB0ZuGiMUNgiNLjiPrRSz1ci8W6xg==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(39840400004)(346002)(136003)(396003)(376002)(366004)(451199018)(6666004)(8936002)(8676002)(66476007)(4326008)(6916009)(66946007)(54906003)(36756003)(66556008)(316002)(41300700001)(6486002)(478600001)(26005)(186003)(2906002)(6512007)(38100700002)(44832011)(86362001)(4744005)(6506007)(2616005)(5660300002)(7416002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?T4snBUbc+mX6W3Z12yTjvIlKGkOwZ3M+lrlTcQjyTj8noSPexKCEDmj8DcI/?=
 =?us-ascii?Q?+ZnigNMgXNHct2ZcDknp8gb71pksQYKWe/m+ERzSDVThNM43r+D9V5voje3C?=
 =?us-ascii?Q?aqLjZsq3jObL2Zxe57mGF1qvqMfhQQn6ge4LJLbo4IYf7dKn23QDGGp4DwzL?=
 =?us-ascii?Q?3eytdDL+Q+6WtGC4cpJwDMRSlXVJG6p575tjrxfIdbFw9C9C7vXU6yHnIqw7?=
 =?us-ascii?Q?oGCW7lyxVYCQ+GcLzE524o3q6wWW/ZtV6XilGIbOPKaRxUQJHNXYfjpOAV17?=
 =?us-ascii?Q?NqtTrNObuddKY5AdOyDLzOCOkFfBDtuOi5XMlgZ4tYz7doYuM5G0nMHS7c9+?=
 =?us-ascii?Q?bXpJVhYqvTZjah3h5tZxO16At4w2hBHA5ty5nNId143hLA5S1BAmsczYS2y6?=
 =?us-ascii?Q?0VBI4XSSzaK7hS3sL4J+KhaH5vmW3I2R/V8g9z6fUPZMqOvHJhHpCJHn0lDl?=
 =?us-ascii?Q?26MzcsXR76TzEZ1nUQIv+BnxO868EE6E1bfXrMSr0VixSMUdtHtOnRFlpT6N?=
 =?us-ascii?Q?HwOHDLgk6ugSBtZ42wNs6WmHn3gf1sTmNEGYqZSIn0w8dhx1ydtT8LTW+5lj?=
 =?us-ascii?Q?Sz8IGihZfGMEngkocy5SYD4MkpLuZVs36SGkd2YTn5wZnW0JTf2fNk4XN5y7?=
 =?us-ascii?Q?feIWh9HU0fwEwKcsAVJcTYMF6bAAvkzf+pVucpHeSM5O1DNBLe5XwBUU7oEW?=
 =?us-ascii?Q?seBsT57K/9eXL0ilq56U6HBzc7Z8PkuLjgiraJtWdnvHEDI30d1zijuNEfgU?=
 =?us-ascii?Q?lgeGTvwgg6N2WwmTSm9fgvYdwl4M0h9+1Fdu91vZGSiy3fmLKul29sSIGMFp?=
 =?us-ascii?Q?YpFa+maFgsUz+bc67vWMSWtpTmJV6Qec4lmfR+omzsV/U+vQxZk+OE9Q8HOh?=
 =?us-ascii?Q?fxLnUQQib89gmlUIZR1Ua/4AtCBI6NKQ9tsSgqODwZcH4WjXij+cwm+abs91?=
 =?us-ascii?Q?KkjamBZx47rWVjqWhH17BOWmVZ8ZEqbESlinf1ZbHU6+nnSkOJDizfBuzAAR?=
 =?us-ascii?Q?8J0PxSTfxGFOW7U6Ri7CoOKvNY29E5pA1dciSHhSds3fuLW4FR4MD7uREy5S?=
 =?us-ascii?Q?yKpsi7FGkgxA/FLv9zHOk1t/VMBidWjbCqOYi95ov6D+VhtBXBHCeOuqXmYS?=
 =?us-ascii?Q?4FftDRc728SJRjxOTGYP28G2JqAqnhXyGVQHxSxzLNH3+HZlPH4a/cD/ghln?=
 =?us-ascii?Q?Ytv6x4uaz+VR3chNpOMz0PugKaR/NXW5nOddkFxg3lBKEOPRfVaguV3nNl9I?=
 =?us-ascii?Q?hjnLd61jFnwoEc3pwFXhI5pomU8RgixHGh2W7Cqs9nHue7+/MosnkvC2bnxq?=
 =?us-ascii?Q?EWkcUayNU6vS/CB5GHGbyZqG/MBf/SUYNAz/AU8j7P6Rn3nzMEK6hDbUhBvm?=
 =?us-ascii?Q?Z/TcBKZvux+d35qJaieGHartfqPVYj7LvmJx8GFrOYy6bS+AABuS4pg/DSFs?=
 =?us-ascii?Q?uV3cWIhqLXxBbuW7k8FueR8GzjXQGvJ4VLF3T3CNI/OYYYiVHTDHSwyEu+pP?=
 =?us-ascii?Q?j+4OJKss0QTtMAh6rs0D+7LgHDC+4fBNJ0+1CtSUGWPRvDGw0A3SUefnkjo4?=
 =?us-ascii?Q?S4TjSsIsF8eEk7BgmMOpLGvr3h7ae0F7N98r/ssM4Flz8icOnKSHBy2BpFn+?=
 =?us-ascii?Q?mw=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 67ff5507-851e-45e4-ebdc-08db0df08265
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Feb 2023 18:31:23.6586
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: Oq9IKhYIX/ZEqA9XzEyMlG0lFycBjyYLL2D39SJ1sAGFOUcPlrfvQ+fd+3HFLw6/uAwoI0VF/LpzGZZmJYNALXrvsWIJSsrlZGaoH1hPl/k=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR17MB5531
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Mon, Feb 13, 2023 at 01:22:17PM -0500, Gregory Price wrote:
> On Fri, Feb 10, 2023 at 01:05:21AM -0800, Dan Williams wrote:
> > Changes since v1: [1]
> > [... snip ...]
> [... snip ...]
> Really i see these decoders and device mappings setup:
> port1 -> mem2
> port2 -> mem1
> port3 -> mem0

small correction:
port1 -> mem1
port3 -> mem0
port2 -> mem2

> 
> Therefore I should expect
> decoder0.0 -> mem2
> decoder0.1 -> mem1
> decoder0.2 -> mem0
> 

this end up mapping this way, which is still further jumbled.

Something feels like there's an off-by-one

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A9FADC636CC
	for <linux-acpi@archiver.kernel.org>; Mon, 13 Feb 2023 19:28:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231156AbjBMT2N (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Mon, 13 Feb 2023 14:28:13 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59996 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230142AbjBMT2M (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Mon, 13 Feb 2023 14:28:12 -0500
Received: from mailout2.w2.samsung.com (mailout2.w2.samsung.com [211.189.100.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 69C139024;
        Mon, 13 Feb 2023 11:27:55 -0800 (PST)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout2.w2.samsung.com (KnoxPortal) with ESMTP id 20230213192752usoutp025e4b2d2431e9f704baeb8c894179f58c~DePNMxY7F1527615276usoutp02U;
        Mon, 13 Feb 2023 19:27:52 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w2.samsung.com 20230213192752usoutp025e4b2d2431e9f704baeb8c894179f58c~DePNMxY7F1527615276usoutp02U
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1676316472;
        bh=NrItREScFuXNw3/cq5mvaAeNjjO2MiGw/sZ2JgF8Rwk=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=IfmwcNrcSQqDiBVUFFrEXT8l+WQ/lf3EQWrZt24xGuwOyulhozfgWIResteCgFWeH
         SqmZUnoD+UTFdka/C2AmRp5ICBTpBJfStUDj1bpHytMAmL5+g3Ff1q2eTlETzPWYIs
         IXynMvsWD/4cS4bFp+WjLibt+lckW7ACkezQZufs=
Received: from ussmges2new.samsung.com (u111.gpu85.samsung.co.kr
        [203.254.195.111]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230213192752uscas1p17900ccee8da551a4806d1d2b1c090887~DePNDBUJf0922609226uscas1p1C;
        Mon, 13 Feb 2023 19:27:52 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges2new.samsung.com (USCPEMTA) with SMTP id 7C.9E.49129.83F8AE36; Mon,
        13 Feb 2023 14:27:52 -0500 (EST)
Received: from ussmgxs1new.samsung.com (u89.gpu85.samsung.co.kr
        [203.254.195.89]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230213192752uscas1p1c49508da4b100c9ba6a1a3aa92ca03e5~DePMvwylr0069200692uscas1p1e;
        Mon, 13 Feb 2023 19:27:52 +0000 (GMT)
X-AuditID: cbfec36f-167fe7000001bfe9-41-63ea8f38f15d
Received: from SSI-EX2.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs1new.samsung.com (USCPEXMTA) with SMTP id 8B.89.11378.73F8AE36; Mon,
        13 Feb 2023 14:27:52 -0500 (EST)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX2.ssi.samsung.com (105.128.2.227) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Mon, 13 Feb 2023 11:27:51 -0800
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Mon,
        13 Feb 2023 11:27:51 -0800
From: Fan Ni <fan.ni@samsung.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "vishal.l.verma@intel.com" <vishal.l.verma@intel.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>,
        "arnd@kernel.org" <arnd@kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Topic: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Index: AQHZPS8BwEUv6lxvFESNil6PPdG9Oq7Nzj+A
Date: Mon, 13 Feb 2023 19:27:51 +0000
Message-ID: <20230213192631.GA984720@bgt-140510-bm03>
In-Reply-To: <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="us-ascii"
Content-ID: <037F73170130C541B884F04C1E9FD389@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA02SeUiTcRjH+b3H9rpavM1qT+sAp52m1ShYh6LZsUKipKgt0tZ6UUs325x2
        QQWKZQ1NNHONnAd5sLSWR+o6tLLUwC4tJJIOp6Zpmp2uVvNV2H+f7/f5PjxffvwoXFBKiqho
        dTyjVStjxBweUdX4rdVPmvZJtaynUCitqrCS0uysp0jacz0FSYvupCFpq7GZkL61OElpR3oj
        FsSVFdh6MZm19CxHZh3O4MquNG2XfbXO3UYqeGsPMDHRCYx2aeA+XtRg8XMU974NHXk6mo1O
        oaQSlIooCugV0HrhYCriUQK6BEG2I59kRTIGtns27kRo5MZO1r+G4EllI8GKYQQttSYuK64i
        +PW+HEtFHhSH9oI7qdUcF0+jfeGCqR53hXC6AYPHJXW4a+BJr4O0+ns4GwqBmi8PSJYlYHdY
        x/oR9Dxorzrhsvn0SigbfMl1sQe9CyoNtYSLET0DfjRbxu7itBA6PuaOMdBTIf+yDWd5Bvyt
        fcdh2Qs6f/Ry2fwSMNcNc1gOhKrcu+PsC1fz+nD27lRoyvlIsLszob749Ti/pqDcEMzyesj9
        NkCyPAvaXmXh7MupoHSIx9oxkFtYMb66BvIc5Vg68jG6tTa6NTK6NTK6NTK6NTIjshQJ9Tpd
        bCSjk6iZRH+dMlanV0f6qzSxVvT/O7X8va+5hV51DPk3IIxCDQgoXDyN79nVoxLwDyiPHmO0
        mgitPobRNaBZFCEW8pcHNKkEdKQynjnEMHGMdmKKUR6iU5iFOCnLNqnkJYkt5knnt4d9GLLP
        nk8ueLijeMOikO/OBMuL7ttReHhntyGw/8XejvlBFbeKXgq9FfLqgD8XAzbHry/QKP7YnRvU
        TbyD6tUp++yjZQOP0uVYs97U6bWVOL1lxLqkvTLTFkrq7eLA3VpaXqmVDe72OK7ox7p2GSn5
        gCZjj5PvO9LmvUpUmLNwf82ZvrK6jK9hQfmOcIU18+aN0DkrJd3CiHPPjvpt9JSpMw+HyZvF
        l34ajOb+Kcmik9GEOKndYKrxqeie/PBN4oKNa353/VzkaSoypSRtyficIHH2Bod+Hm0s2POm
        b7rIohc4JGnEpi97j/dWx/mZaTGhi1IuX4xrdcp/iPCelL0DAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrNIsWRmVeSWpSXmKPExsWS2cA0Sdei/1WywYolLBbbtmxitZg+9QKj
        xYsN7YwWy/f1M1qcn3WKxeLemv+sFrcmHGNyYPdYvOclk8emVZ1sHps+TWL3mHcy0OPzJrkA
        1igum5TUnMyy1CJ9uwSujPcrLjEWPLrKWHHh93TGBsaWlYxdjBwcEgImEl82hnYxcnEICaxm
        lJi07xoThPOJUeLh9YvMEM4yRomWrqtADicHm4CixL6u7WwgtoiAtsTEOQfBipgFDjFJnFi5
        G6xIWMBJov/gAWaIImeJnR+OsELYRhLP/mwCW80ioCpxbVsNSJhXwFRi3fsr7BDLljBKLL36
        jB0kwSkQLrG1dxcLiM0oICbx/dQaJhCbWUBc4taT+WC2hICAxJI955khbFGJl4//sULYihL3
        v79kh6jXkViw+xMbhG0nsW3+fihbW2LZwtfMEEcISpyc+YQFoldS4uCKGywTGCVmIVk3C8mo
        WUhGzUIyahaSUQsYWVcxipcWF+emVxQb5qWW6xUn5haX5qXrJefnbmIExvfpf4cjdzAevfVR
        7xAjEwfjIUYJDmYlEV7hpy+ShXhTEiurUovy44tKc1KLDzFKc7AoifMKuU6MFxJITyxJzU5N
        LUgtgskycXBKNTAFlfm90LJj/rdwzlozA8dA/p47C06uN3hooJr3jnfn5BB5nlM1MRkq+10t
        5l2MEV+zdcbypgfxaiUR2ZGyn2UXuibHXLknrDU76PIW75W33C7Oqa04ZdBoF7FmSdCPB1f4
        1RwSNPfPCVP65KWTZPh4/dJ1WgHRrpslqqWFX/bM648NvrzgcL90/oPemfsa49Nkwjl3HTvF
        VLa1Yq9n6ZsCQcYjyQFMXHKN9YIBb2qNHA7WtD0z33vc+/+NeWy9Dd2Lp0tId0e/UVA4MO2d
        oHTMRb7bkc6yn7dUu0XLP2rdPZ2Jj49/uv2V0FRtqdzQdxye/JyfIqr2Lzph1L20KWmr85O+
        r7KOWopsZut7lViKMxINtZiLihMB2mmJVV4DAAA=
X-CMS-MailID: 20230213192752uscas1p1c49508da4b100c9ba6a1a3aa92ca03e5
CMS-TYPE: 301P
X-CMS-RootMailID: 20230213192752uscas1p1c49508da4b100c9ba6a1a3aa92ca03e5
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
        <CGME20230213192752uscas1p1c49508da4b100c9ba6a1a3aa92ca03e5@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, Feb 10, 2023 at 01:06:39AM -0800, Dan Williams wrote:
> Region autodiscovery is an asynchronous state machine advanced by
> cxl_port_probe(). After the decoders on an endpoint port are enumerated
> they are scanned for actively enabled instances. Each active decoder is
> flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> If a region does not already exist for the address range setting of the
> decoder one is created. That creation process may race with other
> decoders of the same region being discovered since cxl_port_probe() is
> asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> introduced to mitigate that race.
>=20
> Once all decoders have arrived, "p->nr_targets =3D=3D p->interleave_ways"=
,
> they are sorted by their relative decode position. The sort algorithm
> involves finding the point in the cxl_port topology where one leg of the
> decode leads to deviceA and the other deviceB. At that point in the
> topology the target order in the 'struct cxl_switch_decoder' indicates
> the relative position of those endpoint decoders in the region.
>=20
> >From that point the region goes through the same setup and validation
> steps as user-created regions, but instead of programming the decoders
> it validates that driver would have written the same values to the
> decoders as were already present.
>=20
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.=
stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/hdm.c    |   11 +
>  drivers/cxl/core/port.c   |    2=20
>  drivers/cxl/core/region.c |  497 +++++++++++++++++++++++++++++++++++++++=
+++++-
>  drivers/cxl/cxl.h         |   29 +++
>  drivers/cxl/port.c        |   48 ++++
>  5 files changed, 576 insertions(+), 11 deletions(-)
>=20
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index a0891c3464f1..8c29026a4b9d 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -676,6 +676,14 @@ static int cxl_decoder_reset(struct cxl_decoder *cxl=
d)
>  	port->commit_end--;
>  	cxld->flags &=3D ~CXL_DECODER_F_ENABLE;
> =20
> +	/* Userspace is now responsible for reconfiguring this decoder */
> +	if (is_endpoint_decoder(&cxld->dev)) {
> +		struct cxl_endpoint_decoder *cxled;
> +
> +		cxled =3D to_cxl_endpoint_decoder(&cxld->dev);
> +		cxled->state =3D CXL_DECODER_STATE_MANUAL;
> +	}
> +
>  	return 0;
>  }
> =20
> @@ -783,6 +791,9 @@ static int init_hdm_decoder(struct cxl_port *port, st=
ruct cxl_decoder *cxld,
>  		return rc;
>  	}
>  	*dpa_base +=3D dpa_size + skip;
> +
> +	cxled->state =3D CXL_DECODER_STATE_AUTO;
> +
>  	return 0;
>  }
> =20
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 9e5df64ea6b5..59620528571a 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -446,6 +446,7 @@ bool is_endpoint_decoder(struct device *dev)
>  {
>  	return dev->type =3D=3D &cxl_decoder_endpoint_type;
>  }
> +EXPORT_SYMBOL_NS_GPL(is_endpoint_decoder, CXL);
> =20
>  bool is_root_decoder(struct device *dev)
>  {
> @@ -1628,6 +1629,7 @@ struct cxl_root_decoder *cxl_root_decoder_alloc(str=
uct cxl_port *port,
>  	}
> =20
>  	cxlrd->calc_hb =3D calc_hb;
> +	mutex_init(&cxlrd->range_lock);
> =20
>  	cxld =3D &cxlsd->cxld;
>  	cxld->dev.type =3D &cxl_decoder_root_type;
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 691605f1e120..3f6453da2c51 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -6,6 +6,7 @@
>  #include <linux/module.h>
>  #include <linux/slab.h>
>  #include <linux/uuid.h>
> +#include <linux/sort.h>
>  #include <linux/idr.h>
>  #include <cxlmem.h>
>  #include <cxl.h>
> @@ -524,7 +525,12 @@ static void cxl_region_iomem_release(struct cxl_regi=
on *cxlr)
>  	if (device_is_registered(&cxlr->dev))
>  		lockdep_assert_held_write(&cxl_region_rwsem);
>  	if (p->res) {
> -		remove_resource(p->res);
> +		/*
> +		 * Autodiscovered regions may not have been able to insert their
> +		 * resource.
> +		 */
> +		if (p->res->parent)
> +			remove_resource(p->res);
>  		kfree(p->res);
>  		p->res =3D NULL;
>  	}
> @@ -1105,12 +1111,35 @@ static int cxl_port_setup_targets(struct cxl_port=
 *port,
>  		return rc;
>  	}
> =20
> -	cxld->interleave_ways =3D iw;
> -	cxld->interleave_granularity =3D ig;
> -	cxld->hpa_range =3D (struct range) {
> -		.start =3D p->res->start,
> -		.end =3D p->res->end,
> -	};
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		if (cxld->interleave_ways !=3D iw ||
> +		    cxld->interleave_granularity !=3D ig ||
> +		    cxld->hpa_range.start !=3D p->res->start ||
> +		    cxld->hpa_range.end !=3D p->res->end ||
> +		    ((cxld->flags & CXL_DECODER_F_ENABLE) =3D=3D 0)) {
> +			dev_err(&cxlr->dev,
> +				"%s:%s %s expected iw: %d ig: %d %pr\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				__func__, iw, ig, p->res);
> +			dev_err(&cxlr->dev,
> +				"%s:%s %s got iw: %d ig: %d state: %s %#llx:%#llx\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				__func__, cxld->interleave_ways,
> +				cxld->interleave_granularity,
> +				(cxld->flags & CXL_DECODER_F_ENABLE) ?
> +					"enabled" :
> +					"disabled",
> +				cxld->hpa_range.start, cxld->hpa_range.end);
> +			return -ENXIO;
> +		}
> +	} else {
> +		cxld->interleave_ways =3D iw;
> +		cxld->interleave_granularity =3D ig;
> +		cxld->hpa_range =3D (struct range) {
> +			.start =3D p->res->start,
> +			.end =3D p->res->end,
> +		};
> +	}
>  	dev_dbg(&cxlr->dev, "%s:%s iw: %d ig: %d\n", dev_name(port->uport),
>  		dev_name(&port->dev), iw, ig);
>  add_target:
> @@ -1121,7 +1150,17 @@ static int cxl_port_setup_targets(struct cxl_port =
*port,
>  			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), pos);
>  		return -ENXIO;
>  	}
> -	cxlsd->target[cxl_rr->nr_targets_set] =3D ep->dport;
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		if (cxlsd->target[cxl_rr->nr_targets_set] !=3D ep->dport) {
> +			dev_dbg(&cxlr->dev, "%s:%s: %s expected %s at %d\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				dev_name(&cxlsd->cxld.dev),
> +				dev_name(ep->dport->dport),
> +				cxl_rr->nr_targets_set);
> +			return -ENXIO;
> +		}
> +	} else
> +		cxlsd->target[cxl_rr->nr_targets_set] =3D ep->dport;
>  	inc =3D 1;
>  out_target_set:
>  	cxl_rr->nr_targets_set +=3D inc;
> @@ -1163,6 +1202,13 @@ static void cxl_region_teardown_targets(struct cxl=
_region *cxlr)
>  	struct cxl_ep *ep;
>  	int i;
> =20
> +	/*
> +	 * In the auto-discovery case skip automatic teardown since the
> +	 * address space is already active
> +	 */
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags))
> +		return;
> +
>  	for (i =3D 0; i < p->nr_targets; i++) {
>  		cxled =3D p->targets[i];
>  		cxlmd =3D cxled_to_memdev(cxled);
> @@ -1195,8 +1241,8 @@ static int cxl_region_setup_targets(struct cxl_regi=
on *cxlr)
>  			iter =3D to_cxl_port(iter->dev.parent);
> =20
>  		/*
> -		 * Descend the topology tree programming targets while
> -		 * looking for conflicts.
> +		 * Descend the topology tree programming / validating
> +		 * targets while looking for conflicts.
>  		 */
>  		for (ep =3D cxl_ep_load(iter, cxlmd); iter;
>  		     iter =3D ep->next, ep =3D cxl_ep_load(iter, cxlmd)) {
> @@ -1291,6 +1337,185 @@ static int cxl_region_attach_position(struct cxl_=
region *cxlr,
>  	return rc;
>  }
> =20
> +static int cxl_region_attach_auto(struct cxl_region *cxlr,
> +				  struct cxl_endpoint_decoder *cxled, int pos)
> +{
> +	struct cxl_region_params *p =3D &cxlr->params;
> +
> +	if (cxled->state !=3D CXL_DECODER_STATE_AUTO) {
> +		dev_err(&cxlr->dev,
> +			"%s: unable to add decoder to autodetected region\n",
> +			dev_name(&cxled->cxld.dev));
> +		return -EINVAL;
> +	}
> +
> +	if (pos >=3D 0) {
> +		dev_dbg(&cxlr->dev, "%s: expected auto position, not %d\n",
> +			dev_name(&cxled->cxld.dev), pos);
> +		return -EINVAL;
> +	}
> +
> +	if (p->nr_targets >=3D p->interleave_ways) {
> +		dev_err(&cxlr->dev, "%s: no more target slots available\n",
> +			dev_name(&cxled->cxld.dev));
> +		return -ENXIO;
> +	}
> +
> +	/*
> +	 * Temporarily record the endpoint decoder into the target array. Yes,
> +	 * this means that userspace can view devices in the wrong position
> +	 * before the region activates, and must be careful to understand when
> +	 * it might be racing region autodiscovery.
> +	 */
> +	pos =3D p->nr_targets;
> +	p->targets[pos] =3D cxled;
> +	cxled->pos =3D pos;
> +	p->nr_targets++;
> +
> +	return 0;
> +}
> +
> +static struct cxl_port *next_port(struct cxl_port *port)
> +{
> +	if (!port->parent_dport)
> +		return NULL;
> +	return port->parent_dport->port;
> +}
> +
> +static int decoder_match_range(struct device *dev, void *data)
> +{
> +	struct cxl_endpoint_decoder *cxled =3D data;
> +	struct cxl_switch_decoder *cxlsd;
> +
> +	if (!is_switch_decoder(dev))
> +		return 0;
> +
> +	cxlsd =3D to_cxl_switch_decoder(dev);
> +	return range_contains(&cxlsd->cxld.hpa_range, &cxled->cxld.hpa_range);
> +}
> +
> +static void find_positions(const struct cxl_switch_decoder *cxlsd,
> +			   const struct cxl_port *iter_a,
> +			   const struct cxl_port *iter_b, int *a_pos,
> +			   int *b_pos)
> +{
> +	int i;
> +
> +	for (i =3D 0, *a_pos =3D -1, *b_pos =3D -1; i < cxlsd->nr_targets; i++)=
 {
> +		if (cxlsd->target[i] =3D=3D iter_a->parent_dport)
> +			*a_pos =3D i;
> +		else if (cxlsd->target[i] =3D=3D iter_b->parent_dport)
> +			*b_pos =3D i;
> +		if (*a_pos >=3D 0 && *b_pos >=3D 0)
> +			break;
> +	}
> +}
> +
> +static int cmp_decode_pos(const void *a, const void *b)
> +{
> +	struct cxl_endpoint_decoder *cxled_a =3D *(typeof(cxled_a) *)a;
> +	struct cxl_endpoint_decoder *cxled_b =3D *(typeof(cxled_b) *)b;
> +	struct cxl_memdev *cxlmd_a =3D cxled_to_memdev(cxled_a);
> +	struct cxl_memdev *cxlmd_b =3D cxled_to_memdev(cxled_b);
> +	struct cxl_port *port_a =3D cxled_to_port(cxled_a);
> +	struct cxl_port *port_b =3D cxled_to_port(cxled_b);
> +	struct cxl_port *iter_a, *iter_b, *port =3D NULL;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct device *dev;
> +	int a_pos, b_pos;
> +	unsigned int seq;
> +
> +	/* Exit early if any prior sorting failed */
> +	if (cxled_a->pos < 0 || cxled_b->pos < 0)
> +		return 0;
> +
> +	/*
> +	 * Walk up the hierarchy to find a shared port, find the decoder that
> +	 * maps the range, compare the relative position of those dport
> +	 * mappings.
> +	 */
> +	for (iter_a =3D port_a; iter_a; iter_a =3D next_port(iter_a)) {
> +		struct cxl_port *next_a, *next_b;
> +
> +		next_a =3D next_port(iter_a);
> +		if (!next_a)
> +			break;
> +
> +		for (iter_b =3D port_b; iter_b; iter_b =3D next_port(iter_b)) {
> +			next_b =3D next_port(iter_b);
> +			if (next_a !=3D next_b)
> +				continue;
> +			port =3D next_a;
> +			break;
> +		}
> +
> +		if (port)
> +			break;
> +	}
> +
> +	if (!port) {
> +		dev_err(cxlmd_a->dev.parent,
> +			"failed to find shared port with %s\n",
> +			dev_name(cxlmd_b->dev.parent));
> +		goto err;
> +	}
> +
> +	dev =3D device_find_child(&port->dev, cxled_a, decoder_match_range);
> +	if (!dev) {
> +		struct range *range =3D &cxled_a->cxld.hpa_range;
> +
> +		dev_err(port->uport,
> +			"failed to find decoder that maps %#llx-%#llx\n",
> +			range->start, range->end);
> +		goto err;
> +	}
> +
> +	cxlsd =3D to_cxl_switch_decoder(dev);
> +	do {
> +		seq =3D read_seqbegin(&cxlsd->target_lock);
> +		find_positions(cxlsd, iter_a, iter_b, &a_pos, &b_pos);
> +	} while (read_seqretry(&cxlsd->target_lock, seq));
> +
> +	put_device(dev);
> +
> +	if (a_pos < 0 || b_pos < 0) {
> +		dev_err(port->uport,
> +			"failed to find shared decoder for %s and %s\n",
> +			dev_name(cxlmd_a->dev.parent),
> +			dev_name(cxlmd_b->dev.parent));
> +		goto err;
> +	}
> +
> +	dev_dbg(port->uport, "%s comes %s %s\n", dev_name(cxlmd_a->dev.parent),
> +		a_pos - b_pos < 0 ? "before" : "after",
> +		dev_name(cxlmd_b->dev.parent));
> +
> +	return a_pos - b_pos;
> +err:
> +	cxled_a->pos =3D -1;
> +	return 0;
> +}
> +
> +static int cxl_region_sort_targets(struct cxl_region *cxlr)
> +{
> +	struct cxl_region_params *p =3D &cxlr->params;
> +	int i, rc =3D 0;
> +
> +	sort(p->targets, p->nr_targets, sizeof(p->targets[0]), cmp_decode_pos,
> +	     NULL);
> +
> +	for (i =3D 0; i < p->nr_targets; i++) {
> +		struct cxl_endpoint_decoder *cxled =3D p->targets[i];
> +
> +		if (cxled->pos < 0)
> +			rc =3D -ENXIO;
> +		cxled->pos =3D i;
> +	}
> +
> +	dev_dbg(&cxlr->dev, "region sort %s\n", rc ? "failed" : "successful");
> +	return rc;
> +}
> +
>  static int cxl_region_attach(struct cxl_region *cxlr,
>  			     struct cxl_endpoint_decoder *cxled, int pos)
>  {
> @@ -1354,6 +1579,50 @@ static int cxl_region_attach(struct cxl_region *cx=
lr,
>  		return -EINVAL;
>  	}
> =20
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		int i;
> +
> +		rc =3D cxl_region_attach_auto(cxlr, cxled, pos);
> +		if (rc)
> +			return rc;
> +
> +		/* await more targets to arrive... */
> +		if (p->nr_targets < p->interleave_ways)
> +			return 0;
> +
> +		/*
> +		 * All targets are here, which implies all PCI enumeration that
> +		 * affects this region has been completed. Walk the topology to
> +		 * sort the devices into their relative region decode position.
> +		 */
> +		rc =3D cxl_region_sort_targets(cxlr);
> +		if (rc)
> +			return rc;
> +
> +		for (i =3D 0; i < p->nr_targets; i++) {
> +			cxled =3D p->targets[i];
> +			ep_port =3D cxled_to_port(cxled);
> +			dport =3D cxl_find_dport_by_dev(root_port,
> +						      ep_port->host_bridge);
> +			rc =3D cxl_region_attach_position(cxlr, cxlrd, cxled,
> +							dport, i);
> +			if (rc)
> +				return rc;
> +		}
> +
> +		rc =3D cxl_region_setup_targets(cxlr);
> +		if (rc)
> +			return rc;
> +
> +		/*
> +		 * If target setup succeeds in the autodiscovery case
> +		 * then the region is already committed.
> +		 */
> +		p->state =3D CXL_CONFIG_COMMIT;
> +
> +		return 0;
> +	}
> +
>  	rc =3D cxl_region_validate_position(cxlr, cxled, pos);
>  	if (rc)
>  		return rc;
> @@ -2087,6 +2356,193 @@ static int devm_cxl_add_pmem_region(struct cxl_re=
gion *cxlr)
>  	return rc;
>  }
> =20
> +static int match_decoder_by_range(struct device *dev, void *data)
> +{
> +	struct range *r1, *r2 =3D data;
> +	struct cxl_root_decoder *cxlrd;
> +
> +	if (!is_root_decoder(dev))
> +		return 0;
> +
> +	cxlrd =3D to_cxl_root_decoder(dev);
> +	r1 =3D &cxlrd->cxlsd.cxld.hpa_range;
> +	return range_contains(r1, r2);
> +}
> +
> +static int match_region_by_range(struct device *dev, void *data)
> +{
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	struct range *r =3D data;
> +	int rc =3D 0;
> +
> +	if (!is_cxl_region(dev))
> +		return 0;
> +
> +	cxlr =3D to_cxl_region(dev);
> +	p =3D &cxlr->params;
> +
> +	down_read(&cxl_region_rwsem);
> +	if (p->res && p->res->start =3D=3D r->start && p->res->end =3D=3D r->en=
d)
> +		rc =3D 1;
> +	up_read(&cxl_region_rwsem);
> +
> +	return rc;
> +}
> +
> +/* Establish an empty region covering the given HPA range */
> +static struct cxl_region *construct_region(struct cxl_root_decoder *cxlr=
d,
> +					   struct cxl_endpoint_decoder *cxled)
> +{
> +	struct cxl_memdev *cxlmd =3D cxled_to_memdev(cxled);
> +	struct cxl_port *port =3D cxlrd_to_port(cxlrd);
> +	struct range *hpa =3D &cxled->cxld.hpa_range;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	struct resource *res;
> +	int rc;
> +
> +	do {
> +		cxlr =3D __create_region(cxlrd, cxled->mode,
> +				       atomic_read(&cxlrd->region_id));
> +	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) =3D=3D -EBUSY);
> +
> +	if (IS_ERR(cxlr)) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s: %s failed assign region: %ld\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			__func__, PTR_ERR(cxlr));
> +		return cxlr;
> +	}
> +
> +	down_write(&cxl_region_rwsem);
> +	p =3D &cxlr->params;
> +	if (p->state >=3D CXL_CONFIG_INTERLEAVE_ACTIVE) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s: %s autodiscovery interrupted\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			__func__);
> +		rc =3D -EBUSY;
> +		goto err;
> +	}
> +
> +	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
> +
> +	res =3D kmalloc(sizeof(*res), GFP_KERNEL);
> +	if (!res) {
> +		rc =3D -ENOMEM;
> +		goto err;
> +	}
> +
> +	*res =3D DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
> +				    dev_name(&cxlr->dev));
> +	rc =3D insert_resource(cxlrd->res, res);
> +	if (rc) {
> +		/*
> +		 * Platform-firmware may not have split resources like "System
> +		 * RAM" on CXL window boundaries see cxl_region_iomem_release()
> +		 */
> +		dev_warn(cxlmd->dev.parent,
> +			 "%s:%s: %s %s cannot insert resource\n",
> +			 dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			 __func__, dev_name(&cxlr->dev));
> +	}
> +
> +	p->res =3D res;
> +	p->interleave_ways =3D cxled->cxld.interleave_ways;
> +	p->interleave_granularity =3D cxled->cxld.interleave_granularity;
> +	p->state =3D CXL_CONFIG_INTERLEAVE_ACTIVE;
> +
> +	rc =3D sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group(=
));
> +	if (rc)
> +		goto err;
> +
> +	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
> +		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
> +		dev_name(&cxlr->dev), p->res, p->interleave_ways,
> +		p->interleave_granularity);
> +
> +	/* ...to match put_device() in cxl_add_to_region() */
> +	get_device(&cxlr->dev);
> +	up_write(&cxl_region_rwsem);
> +
> +	return cxlr;
> +
> +err:
> +	up_write(&cxl_region_rwsem);
> +	devm_release_action(port->uport, unregister_region, cxlr);
> +	return ERR_PTR(rc);
> +}
> +
> +int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder=
 *cxled)
> +{
> +	struct cxl_memdev *cxlmd =3D cxled_to_memdev(cxled);
> +	struct range *hpa =3D &cxled->cxld.hpa_range;
> +	struct cxl_decoder *cxld =3D &cxled->cxld;
> +	struct cxl_root_decoder *cxlrd;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	bool attach =3D false;
> +	struct device *dev;
> +	int rc;
> +
> +	dev =3D device_find_child(&root->dev, &cxld->hpa_range,
> +				match_decoder_by_range);
> +	if (!dev) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s no CXL window for range %#llx:%#llx\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
> +			cxld->hpa_range.start, cxld->hpa_range.end);
> +		return -ENXIO;
> +	}
> +
> +	cxlrd =3D to_cxl_root_decoder(dev);
> +
> +	/*
> +	 * Ensure that if multiple threads race to construct_region() for @hpa
> +	 * one does the construction and the others add to that.
> +	 */
> +	mutex_lock(&cxlrd->range_lock);
> +	dev =3D device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
> +				match_region_by_range);
> +	if (!dev)
> +		cxlr =3D construct_region(cxlrd, cxled);
> +	else
> +		cxlr =3D to_cxl_region(dev);
> +	mutex_unlock(&cxlrd->range_lock);
> +
> +	if (IS_ERR(cxlr)) {
> +		rc =3D PTR_ERR(cxlr);
> +		goto out;
> +	}
> +
> +	attach_target(cxlr, cxled, -1, TASK_UNINTERRUPTIBLE);
> +
> +	down_read(&cxl_region_rwsem);
> +	p =3D &cxlr->params;
> +	attach =3D p->state =3D=3D CXL_CONFIG_COMMIT;
> +	up_read(&cxl_region_rwsem);
> +
> +	if (attach) {
> +		int rc =3D device_attach(&cxlr->dev);
> +
> +		/*
> +		 * If device_attach() fails the range may still be active via
> +		 * the platform-firmware memory map, otherwise the driver for
> +		 * regions is local to this file, so driver matching can't fail.
> +		 */
> +		if (rc < 0)
> +			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
> +				p->res);
> +	}
> +
> +	put_device(&cxlr->dev);
> +out:
> +	put_device(&cxlrd->cxlsd.cxld.dev);
> +	return rc;

rc can be returned without initialized as mentioned by Arnd Bergmann in
https://lore.kernel.org/linux-cxl/20230213101220.3821689-1-arnd@kernel.org/=
T/#u

> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);
> +
>  static int cxl_region_invalidate_memregion(struct cxl_region *cxlr)
>  {
>  	if (!test_bit(CXL_REGION_F_INCOHERENT, &cxlr->flags))
> @@ -2111,6 +2567,15 @@ static int cxl_region_invalidate_memregion(struct =
cxl_region *cxlr)
>  	return 0;
>  }
> =20
> +static int is_system_ram(struct resource *res, void *arg)
> +{
> +	struct cxl_region *cxlr =3D arg;
> +	struct cxl_region_params *p =3D &cxlr->params;
> +
> +	dev_dbg(&cxlr->dev, "%pr has System RAM: %pr\n", p->res, res);
> +	return 1;
> +}
> +
>  static int cxl_region_probe(struct device *dev)
>  {
>  	struct cxl_region *cxlr =3D to_cxl_region(dev);
> @@ -2144,6 +2609,18 @@ static int cxl_region_probe(struct device *dev)
>  	switch (cxlr->mode) {
>  	case CXL_DECODER_PMEM:
>  		return devm_cxl_add_pmem_region(cxlr);
> +	case CXL_DECODER_RAM:
> +		/*
> +		 * The region can not be manged by CXL if any portion of
> +		 * it is already online as 'System RAM'
> +		 */
> +		if (walk_iomem_res_desc(IORES_DESC_NONE,
> +					IORESOURCE_SYSTEM_RAM | IORESOURCE_BUSY,
> +					p->res->start, p->res->end, cxlr,
> +					is_system_ram) > 0)
> +			return 0;
> +		dev_dbg(dev, "TODO: hookup devdax\n");
> +		return 0;
>  	default:
>  		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
>  			cxlr->mode);
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index ca76879af1de..c8ee4bb8cce6 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -261,6 +261,8 @@ resource_size_t cxl_rcrb_to_component(struct device *=
dev,
>   * cxl_decoder flags that define the type of memory / devices this
>   * decoder supports as well as configuration lock status See "CXL 2.0
>   * 8.2.5.12.7 CXL HDM Decoder 0 Control Register" for details.
> + * Additionally indicate whether decoder settings were autodetected,
> + * user customized.
>   */
>  #define CXL_DECODER_F_RAM   BIT(0)
>  #define CXL_DECODER_F_PMEM  BIT(1)
> @@ -334,12 +336,22 @@ static inline const char *cxl_decoder_mode_name(enu=
m cxl_decoder_mode mode)
>  	return "mixed";
>  }
> =20
> +/*
> + * Track whether this decoder is reserved for region autodiscovery, or
> + * free for userspace provisioning.
> + */
> +enum cxl_decoder_state {
> +	CXL_DECODER_STATE_MANUAL,
> +	CXL_DECODER_STATE_AUTO,
> +};
> +
>  /**
>   * struct cxl_endpoint_decoder - Endpoint  / SPA to DPA decoder
>   * @cxld: base cxl_decoder_object
>   * @dpa_res: actively claimed DPA span of this decoder
>   * @skip: offset into @dpa_res where @cxld.hpa_range maps
>   * @mode: which memory type / access-mode-partition this decoder targets
> + * @state: autodiscovery state
>   * @pos: interleave position in @cxld.region
>   */
>  struct cxl_endpoint_decoder {
> @@ -347,6 +359,7 @@ struct cxl_endpoint_decoder {
>  	struct resource *dpa_res;
>  	resource_size_t skip;
>  	enum cxl_decoder_mode mode;
> +	enum cxl_decoder_state state;
>  	int pos;
>  };
> =20
> @@ -380,6 +393,7 @@ typedef struct cxl_dport *(*cxl_calc_hb_fn)(struct cx=
l_root_decoder *cxlrd,
>   * @region_id: region id for next region provisioning event
>   * @calc_hb: which host bridge covers the n'th position by granularity
>   * @platform_data: platform specific configuration data
> + * @range_lock: sync region autodiscovery by address range
>   * @cxlsd: base cxl switch decoder
>   */
>  struct cxl_root_decoder {
> @@ -387,6 +401,7 @@ struct cxl_root_decoder {
>  	atomic_t region_id;
>  	cxl_calc_hb_fn calc_hb;
>  	void *platform_data;
> +	struct mutex range_lock;
>  	struct cxl_switch_decoder cxlsd;
>  };
> =20
> @@ -436,6 +451,13 @@ struct cxl_region_params {
>   */
>  #define CXL_REGION_F_INCOHERENT 0
> =20
> +/*
> + * Indicate whether this region has been assembled by autodetection or
> + * userspace assembly. Prevent endpoint decoders outside of automatic
> + * detection from being added to the region.
> + */
> +#define CXL_REGION_F_AUTO 1
> +
>  /**
>   * struct cxl_region - CXL region
>   * @dev: This region's device
> @@ -699,6 +721,8 @@ struct cxl_nvdimm_bridge *cxl_find_nvdimm_bridge(stru=
ct device *dev);
>  #ifdef CONFIG_CXL_REGION
>  bool is_cxl_pmem_region(struct device *dev);
>  struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev);
> +int cxl_add_to_region(struct cxl_port *root,
> +		      struct cxl_endpoint_decoder *cxled);
>  #else
>  static inline bool is_cxl_pmem_region(struct device *dev)
>  {
> @@ -708,6 +732,11 @@ static inline struct cxl_pmem_region *to_cxl_pmem_re=
gion(struct device *dev)
>  {
>  	return NULL;
>  }
> +static inline int cxl_add_to_region(struct cxl_port *root,
> +				    struct cxl_endpoint_decoder *cxled)
> +{
> +	return 0;
> +}
>  #endif
> =20
>  /*
> diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
> index a8d46a67b45e..d88518836c2d 100644
> --- a/drivers/cxl/port.c
> +++ b/drivers/cxl/port.c
> @@ -30,6 +30,34 @@ static void schedule_detach(void *cxlmd)
>  	schedule_cxl_memdev_detach(cxlmd);
>  }
> =20
> +static int discover_region(struct device *dev, void *root)
> +{
> +	struct cxl_endpoint_decoder *cxled;
> +	int rc;
> +
> +	if (!is_endpoint_decoder(dev))
> +		return 0;
> +
> +	cxled =3D to_cxl_endpoint_decoder(dev);
> +	if ((cxled->cxld.flags & CXL_DECODER_F_ENABLE) =3D=3D 0)
> +		return 0;
> +
> +	if (cxled->state !=3D CXL_DECODER_STATE_AUTO)
> +		return 0;
> +
> +	/*
> +	 * Region enumeration is opportunistic, if this add-event fails,
> +	 * continue to the next endpoint decoder.
> +	 */
> +	rc =3D cxl_add_to_region(root, cxled);
> +	if (rc)
> +		dev_dbg(dev, "failed to add to region: %#llx-%#llx\n",
> +			cxled->cxld.hpa_range.start, cxled->cxld.hpa_range.end);
> +
> +	return 0;
> +}
> +
> +
>  static int cxl_switch_port_probe(struct cxl_port *port)
>  {
>  	struct cxl_hdm *cxlhdm;
> @@ -54,6 +82,7 @@ static int cxl_endpoint_port_probe(struct cxl_port *por=
t)
>  	struct cxl_memdev *cxlmd =3D to_cxl_memdev(port->uport);
>  	struct cxl_dev_state *cxlds =3D cxlmd->cxlds;
>  	struct cxl_hdm *cxlhdm;
> +	struct cxl_port *root;
>  	int rc;
> =20
>  	cxlhdm =3D devm_cxl_setup_hdm(port);
> @@ -78,7 +107,24 @@ static int cxl_endpoint_port_probe(struct cxl_port *p=
ort)
>  		return rc;
>  	}
> =20
> -	return devm_cxl_enumerate_decoders(cxlhdm);
> +	rc =3D devm_cxl_enumerate_decoders(cxlhdm);
> +	if (rc)
> +		return rc;
> +
> +	/*
> +	 * This can't fail in practice as CXL root exit unregisters all
> +	 * descendant ports and that in turn synchronizes with cxl_port_probe()
> +	 */
> +	root =3D find_cxl_root(&cxlmd->dev);
> +
> +	/*
> +	 * Now that all endpoint decoders are successfully enumerated, try to
> +	 * assemble regions from committed decoders
> +	 */
> +	device_for_each_child(&port->dev, root, discover_region);
> +	put_device(&root->dev);
> +
> +	return 0;
>  }
> =20
>  static int cxl_port_probe(struct device *dev)
>=20
> =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 245E1C64EC7
	for <linux-acpi@archiver.kernel.org>; Tue, 14 Feb 2023 13:23:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232691AbjBNNXl (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Tue, 14 Feb 2023 08:23:41 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34584 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232651AbjBNNXk (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Tue, 14 Feb 2023 08:23:40 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7266C5FEB;
        Tue, 14 Feb 2023 05:23:39 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PGMHC09Mbz6J7f8;
        Tue, 14 Feb 2023 21:19:03 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Tue, 14 Feb
 2023 13:23:37 +0000
Date: Tue, 14 Feb 2023 13:23:36 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <20230214132336.00005915@Huawei.com>
In-Reply-To: <63e6b89581c3c_1db5d029467@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
        <20230210180958.00002e5a@Huawei.com>
        <63e6b89581c3c_1db5d029467@dwillia2-xfh.jf.intel.com.notmuch>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100005.china.huawei.com (7.191.160.25) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org


> > 
> > 		/*
> > 		 * If device_attach() fails the range may still be active via
> > 		 * the platform-firmware memory map, otherwise the driver for
> > 		 * regions is local to this file, so driver matching can't fail
> > +                * and hence device_attach() cannot return 1.
> > 
> > //very much not obvious otherwise to anyone who isn't far too familiar with device_attach()  
> 
> Hence the comment? Not sure what else can be said here about why
> device_attach() < 0 is a sufficient check.

I'd just add the bit I added above that calls out the condition you are
describing is indicated by a return of 1.




From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 94B8BC05027
	for <linux-acpi@archiver.kernel.org>; Tue, 14 Feb 2023 13:35:38 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231899AbjBNNfh (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Tue, 14 Feb 2023 08:35:37 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41042 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231580AbjBNNfg (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Tue, 14 Feb 2023 08:35:36 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7D8A025958;
        Tue, 14 Feb 2023 05:35:34 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PGMcJ1Qq7z67HtH;
        Tue, 14 Feb 2023 21:33:52 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Tue, 14 Feb
 2023 13:35:31 +0000
Date: Tue, 14 Feb 2023 13:35:31 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Dan Williams <dan.j.williams@intel.com>,
        <linux-cxl@vger.kernel.org>, Ira Weiny <ira.weiny@intel.com>,
        David Hildenbrand <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>, Fan Ni <fan.ni@samsung.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System
 RAM' default
Message-ID: <20230214133531.00000cf7@Huawei.com>
In-Reply-To: <Y+p/2S4rnrOOyZ8w@memverge.com>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <Y+p/2S4rnrOOyZ8w@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100002.china.huawei.com (7.191.160.241) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Mon, 13 Feb 2023 13:22:17 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> On Fri, Feb 10, 2023 at 01:05:21AM -0800, Dan Williams wrote:
> > Changes since v1: [1]
> > [... snip ...]  
> 
> For a single attached device - I have been finding general success.
> 
> For multiple attached devices, I'm seeing some strange behaviors.
> 
> With multiple root ports, I got some stack traces before deciding
> I needed multiple CMFW to do this "correctly", and just attached
> multiple pxb-cxl to the root bus.

Hmm. I should get on with doing multiple HDM decoders in the host
bridge at least. (also useful to support in switch and EP obviously)

> 
> Obviously this configuration is "not great", and some form of
> "impossible in the real world", but it's worth examining i think.

Seems reasonable simplification of what you might see on a 3 socket
system.  Host bridge and CFMWS per socket.

> 
> /opt/qemu-cxl/bin/qemu-system-x86_64 \
> -drive file=/data/qemu/images/pool/pool1.qcow2,format=qcow2,index=0,media=disk,id=hd \
> -m 4G,slots=4,maxmem=16G \
> -smp 4 \
> -machine type=q35,accel=kvm,cxl=on \
> -enable-kvm \
> -nographic \
> -netdev bridge,id=hn0,br=virbr0 \
> -device virtio-net-pci,netdev=hn0,id=nic1,mac=52:54:00:12:34:56 \
> -device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 \
> -device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=191 \
> -device pxb-cxl,id=cxl.2,bus=pcie.0,bus_nr=230 \
> -device cxl-rp,id=rp0,bus=cxl.0,chassis=0,port=0,slot=0 \
> -device cxl-rp,id=rp1,bus=cxl.1,chassis=0,port=1,slot=1 \
> -device cxl-rp,id=rp2,bus=cxl.2,chassis=0,port=2,slot=2 \
> -object memory-backend-ram,id=mem0,size=4G \
> -object memory-backend-ram,id=mem1,size=4G \
> -object memory-backend-ram,id=mem2,size=4G \
> -device cxl-type3,bus=rp0,volatile-memdev=mem0,id=cxl-mem0 \
> -device cxl-type3,bus=rp1,volatile-memdev=mem1,id=cxl-mem1 \
> -device cxl-type3,bus=rp2,volatile-memdev=mem2,id=cxl-mem2 \
> -M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G,cxl-fmw.1.targets.0=cxl.1,cxl-fmw.1.size=4G,cxl-fmw.2.targets.0=cxl.2,cxl-fmw.2.size=4G
> 
> The goal here should be to have 3 different memory expanders have their
> regions created and mapped to 3 different numa nodes.
> 
> One piece i'm not confident about is my CFMW's
> (listed more readably:)
> 
> -M cxl-fmw.0.targets.0=cxl.0,
>    cxl-fmw.0.size=4G,
>    cxl-fmw.1.targets.0=cxl.1,
>    cxl-fmw.1.size=4G,
>    cxl-fmw.2.targets.0=cxl.2,
>    cxl-fmw.2.size=4G
> 
> should targets in this case be targets.0/1/2, or all of them targets.0?

targets.0 for all of them.  Fairly sure it will moan at you if you don't
do that as some of the targets array for each cfmws will be un specified.

> 
> Either way, i would expect 3 root decoders, and 3 memory devices
> 
> [root@fedora ~]# ls /sys/bus/cxl/devices/
> decoder0.0  decoder1.0  decoder4.0  endpoint4  mem0  nvdimm-bridge0  port3
> decoder0.1  decoder2.0  decoder5.0  endpoint5  mem1  port1           root0
> decoder0.2  decoder3.0  decoder6.0  endpoint6  mem2  port2
> 
> I see the devices I expect, but i would expect the following:
> (cxl list output at the bottom)
> 
> decoder0.0 -> mem0
> decoder0.1 -> mem1
> decoder0.2 -> mem2

I don't think there is any enforcement of ordering across various elements.
It just depends on exact ordering of probe calls that are racing.


> 
> root0 -> [decoder0.0, 0.1, 0.2]
> root0 -> [port1, 2, 3]
> port1 -> mem0
> port2 -> mem1
> port3 -> mem2
> 
> Really i see these decoders and device mappings setup:
> port1 -> mem2
> port2 -> mem1
> port3 -> mem0
> 
> Therefore I should expect
> decoder0.0 -> mem2
> decoder0.1 -> mem1
> decoder0.2 -> mem0
> 
> This bears out: attempting to use any other combination produces ndctl errors.
> 
> So the numbers are backwards, maybe that's relevant, maybe it's not.
> The devices are otherwise completely the same, so for the most part
> everything might "just work".  Lets keep testing.
> 
> 
> [root@fedora ~]# cat create_region.sh
> ./ndctl/build/cxl/cxl \
>   create-region \
>   -m \
>   -t ram \
>   -d decoder0.$1 \
>   -w 1 \
>   -g 4096 \
>   mem$2
> 
> [root@fedora ~]# ./create_region.sh 2 0
> [   34.424931] cxl_region region2: Bypassing cpu_cache_invalidate_memregion() for testing!
> {
>   "region":"region2",
>   "resource":"0x790000000",
>   "size":"4.00 GiB (4.29 GB)",
>   "type":"ram",
>   "interleave_ways":1,
>   "interleave_granularity":4096,
>   "decode_state":"commit",
>   "mappings":[
>     {
>       "position":0,
>       "memdev":"mem0",
>       "decoder":"decoder4.0"
>     }
>   ]
> }
> cxl region: cmd_create_region: created 1 region
> 
> [   34.486668] Fallback order for Node 3: 3 0
> [   34.487568] Built 1 zonelists, mobility grouping on.  Total pages: 979669
> [   34.488206] Policy zone: Normal
> [   34.501938] Fallback order for Node 0: 0 3
> [   34.502405] Fallback order for Node 1: 1 3 0
> [   34.502832] Fallback order for Node 2: 2 3 0
> [   34.503251] Fallback order for Node 3: 3 0
> [   34.503649] Built 2 zonelists, mobility grouping on.  Total pages: 1012437
> [   34.504296] Policy zone: Normal
> 
> 
> 
> Cool, looks good.  Lets try mem1
> 
> 
> 
> [root@fedora ~]# ./create_region.sh 1 1
> 
> [   98.787029] Fallback order for Node 2: 2 3 0
> [   98.787630] Built 2 zonelists, mobility grouping on.  Total pages: 2019798
> [   98.788483] Policy zone: Normal
> [  128.301580] Fallback order for Node 0: 0 2 3
> [  128.302084] Fallback order for Node 1: 1 3 2 0
> [  128.302547] Fallback order for Node 2: 2 3 0
> [  128.303009] Fallback order for Node 3: 3 2 0
> [  128.303436] Built 3 zonelists, mobility grouping on.  Total pages: 2052566
> [  128.304071] Policy zone: Normal
> [ .... wait 20-30 more seconds .... ]
> {
>   "region":"region1",
>   "resource":"0x690000000",
>   "size":"4.00 GiB (4.29 GB)",
>   "type":"ram",
>   "interleave_ways":1,
>   "interleave_granularity":4096,
>   "decode_state":"commit",
>   "mappings":[
>     {
>       "position":0,
>       "memdev":"mem1",
>       "decoder":"decoder5.0"
>     }
>   ]
> }
> cxl region: cmd_create_region: created 1 region
> 
> 
> This takes a LONG time to complete. Maybe that's expected, I don't know.
> 
> 
> Lets online mem2.
> 
> 
> [root@fedora ~]# ./create_region.sh 0 2
> extra data[7]: 0x0000000000000000
> emulation failure
> RAX=0000000000000000 RBX=ffff8a6f90006800 RCX=0000000000100001 RDX=0000000080100010
> RSI=ffffca291a400000 RDI=0000000040000000 RBP=ffff9684c0017a60 RSP=ffff9684c0017a30
> R8 =ffff8a6f90006800 R9 =0000000000100001 R10=0000000000000000 R11=0000000000000001
> R12=ffffca291a400000 R13=0000000000100001 R14=0000000000000000 R15=0000000080100010
> RIP=ffffffffb71c5831 RFL=00010006 [-----P-] CPL=0 II=0 A20=1 SMM=0 HLT=0
> ES =0000 0000000000000000 ffffffff 00c00000
> CS =0010 0000000000000000 ffffffff 00a09b00 DPL=0 CS64 [-RA]
> SS =0018 0000000000000000 ffffffff 00c09300 DPL=0 DS   [-WA]
> DS =0000 0000000000000000 ffffffff 00c00000
> FS =0000 00007fd03025db40 ffffffff 00c00000
> GS =0000 ffff8a6a7bd00000 ffffffff 00c00000
> LDT=0000 0000000000000000 ffffffff 00c00000
> TR =0040 fffffe46e6e25000 00004087 00008b00 DPL=0 TSS64-busy
> GDT=     fffffe46e6e23000 0000007f
> IDT=     fffffe0000000000 00000fff
> CR0=80050033 CR2=00005604371ab0c8 CR3=0000000102ece000 CR4=000006e0
> DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000
> DR6=00000000fffe0ff0 DR7=0000000000000400
> EFER=0000000000000d01
> Code=83 ec 08 81 e7 00 00 00 40 74 2c 48 89 d0 48 89 ca 4c 89 c9 <f0> 48 0f c7 4e 20 0f 84 85 00 00 00 f3 90 48 83 c4 08 31 c0 5b 41 5c 41 5d 41 5e 41 5f 5d
> 
> 
> Well that seems bad lol.  I'm not sure what to make of this since my
> scrollback cuts off and the machine completely locks up.  I have never
> seen "emulation failure" before.
> 
> 
> Reboot and attempt to online that region by itself:
> 
> [root@fedora ~]# ./create_region.sh 0 2
> [   21.292598] cxl_region region0: Bypassing cpu_cache_invalidate_memregion() for testing!
> [   21.341753] Fallback order for Node 1: 1 0
> [   21.342462] Built 1 zonelists, mobility grouping on.  Total pages: 979670
> [   21.343085] Policy zone: Normal
> [   21.355166] Fallback order for Node 0: 0 1
> [   21.355613] Fallback order for Node 1: 1 0
> [   21.356009] Fallback order for Node 2: 2 1 0
> [   21.356441] Fallback order for Node 3: 3 1 0
> [   21.356874] Built 2 zonelists, mobility grouping on.  Total pages: 1012438
> [   21.357501] Policy zone: Normal
> {
>   "region":"region0",
>   "resource":"0x590000000",
>   "size":"4.00 GiB (4.29 GB)",
>   "type":"ram",
>   "interleave_ways":1,
>   "interleave_granularity":4096,
>   "decode_state":"commit",
>   "mappings":[
>     {
>       "position":0,
>       "memdev":"mem2",
>       "decoder":"decoder6.0"
>     }
>   ]
> }
> cxl region: cmd_create_region: created 1 region
> 
> 
> That works fine, and works just like onlining the first region (2,0).
> 
> This suggests the issue is actually creating multiple regions in this
> topology.
> 
> 
> 
> Bonus round: booting with memhp_default_state=offline
> 
> All regions successfully get created without error.
> 
> 
> 
> I have a few guesses, but haven't dived in yet:
> 
> 1) There's a QEMU error in the way this configuration routes to various
>    components of the CXL structure, and/or multiple pxb-cxl's do bad
>    things and I should feel bad for doing this configuration.

Nothing looks like it should be broken in your command line etc.
There may well be a bug in qemu though.
> 
> 2) There's something going on when creating the topology, leading to the
>    inverted [decoder0.2, mem0], [decoder0.1, mem1], [decoder0.0, mem2]
>    mappings, leading to inconsistent device control.  Or I'm making a
>    bad assumption and this is expected behavior.

Expected I think.

> 
> 3) The memory block creation / online code is getting hung up somewhere.
>    Why does the second region take forever to online?

Maybe try some smaller devices, just in case it's running out of memory somewhere.

> 
> 4) Something else completely.
> 
> 
> My gut at the moment tells me my configuration is bad, but i have no
> idea why.  Anyone with an idea on what I should look for, let me know.
> 
> 
> cxl list output for completeness:
> 
> [root@fedora ~]# ./ndctl/build/cxl/cxl list -vvvv
> [
>   {
>     "bus":"root0",
>     "provider":"ACPI.CXL",
>     "nr_dports":3,
>     "dports":[
>       {
>         "dport":"pci0000:e6",
>         "alias":"ACPI0016:00",
>         "id":230
>       },
>       {
>         "dport":"pci0000:bf",
>         "alias":"ACPI0016:01",
>         "id":191
>       },
>       {
>         "dport":"pci0000:34",
>         "alias":"ACPI0016:02",
>         "id":52
>       }
>     ],
>     "ports:root0":[
>       {
>         "port":"port1",
>         "host":"pci0000:e6",
>         "depth":1,
>         "nr_dports":1,
>         "dports":[
>           {
>             "dport":"0000:e6:00.0",
>             "id":2
>           }
>         ],
>         "endpoints:port1":[
>           {
>             "endpoint":"endpoint5",
>             "host":"mem1",
>             "depth":2,
>             "memdev":{
>               "memdev":"mem1",
>               "ram_size":4294967296,
>               "serial":0,
>               "host":"0000:e7:00.0",
>               "partition_info":{
>                 "total_size":4294967296,
>                 "volatile_only_size":4294967296,
>                 "persistent_only_size":0,
>                 "partition_alignment_size":0
>               }
>             },
>             "decoders:endpoint5":[
>               {
>                 "decoder":"decoder5.0",
>                 "interleave_ways":1,
>                 "state":"disabled"
>               }
>             ]
>           }
>         ],
>         "decoders:port1":[
>           {
>             "decoder":"decoder1.0",
>             "interleave_ways":1,
>             "state":"disabled",
>             "nr_targets":1,
>             "targets":[
>               {
>                 "target":"0000:e6:00.0",
>                 "position":0,
>                 "id":2
>               }
>             ]
>           }
>         ]
>       },
>       {
>         "port":"port3",
>         "host":"pci0000:34",
>         "depth":1,
>         "nr_dports":1,
>         "dports":[
>           {
>             "dport":"0000:34:00.0",
>             "id":0
>           }
>         ],
>         "endpoints:port3":[
>           {
>             "endpoint":"endpoint4",
>             "host":"mem0",
>             "depth":2,
>             "memdev":{
>               "memdev":"mem0",
>               "ram_size":4294967296,
>               "serial":0,
>               "host":"0000:35:00.0",
>               "partition_info":{
>                 "total_size":4294967296,
>                 "volatile_only_size":4294967296,
>                 "persistent_only_size":0,
>                 "partition_alignment_size":0
>               }
>             },
>             "decoders:endpoint4":[
>               {
>                 "decoder":"decoder4.0",
>                 "interleave_ways":1,
>                 "state":"disabled"
>               }
>             ]
>           }
>         ],
>         "decoders:port3":[
>           {
>             "decoder":"decoder3.0",
>             "interleave_ways":1,
>             "state":"disabled",
>             "nr_targets":1,
>             "targets":[
>               {
>                 "target":"0000:34:00.0",
>                 "position":0,
>                 "id":0
>               }
>             ]
>           }
>         ]
>       },
>       {
>         "port":"port2",
>         "host":"pci0000:bf",
>         "depth":1,
>         "nr_dports":1,
>         "dports":[
>           {
>             "dport":"0000:bf:00.0",
>             "id":1
>           }
>         ],
>         "endpoints:port2":[
>           {
>             "endpoint":"endpoint6",
>             "host":"mem2",
>             "depth":2,
>             "memdev":{
>               "memdev":"mem2",
>               "ram_size":4294967296,
>               "serial":0,
>               "host":"0000:c0:00.0",
>               "partition_info":{
>                 "total_size":4294967296,
>                 "volatile_only_size":4294967296,
>                 "persistent_only_size":0,
>                 "partition_alignment_size":0
>               }
>             },
>             "decoders:endpoint6":[
>               {
>                 "decoder":"decoder6.0",
>                 "interleave_ways":1,
>                 "state":"disabled"
>               }
>             ]
>           }
>         ],
>         "decoders:port2":[
>           {
>             "decoder":"decoder2.0",
>             "interleave_ways":1,
>             "state":"disabled",
>             "nr_targets":1,
>             "targets":[
>               {
>                 "target":"0000:bf:00.0",
>                 "position":0,
>                 "id":1
>               }
>             ]
>           }
>         ]
>       }
>     ],
>     "decoders:root0":[
>       {
>         "decoder":"decoder0.0",
>         "resource":23890755584,
>         "size":4294967296,
>         "interleave_ways":1,
>         "max_available_extent":4294967296,
>         "pmem_capable":true,
>         "volatile_capable":true,
>         "accelmem_capable":true,
>         "nr_targets":1,
>         "targets":[
>           {
>             "target":"pci0000:34",
>             "alias":"ACPI0016:02",
>             "position":0,
>             "id":52
>           }
>         ]
>       },
>       {
>         "decoder":"decoder0.1",
>         "resource":28185722880,
>         "size":4294967296,
>         "interleave_ways":1,
>         "max_available_extent":4294967296,
>         "pmem_capable":true,
>         "volatile_capable":true,
>         "accelmem_capable":true,
>         "nr_targets":1,
>         "targets":[
>           {
>             "target":"pci0000:bf",
>             "alias":"ACPI0016:01",
>             "position":0,
>             "id":191
>           }
>         ]
>       },
>       {
>         "decoder":"decoder0.2",
>         "resource":32480690176,
>         "size":4294967296,
>         "interleave_ways":1,
>         "max_available_extent":4294967296,
>         "pmem_capable":true,
>         "volatile_capable":true,
>         "accelmem_capable":true,
>         "nr_targets":1,
>         "targets":[
>           {
>             "target":"pci0000:e6",
>             "alias":"ACPI0016:00",
>             "position":0,
>             "id":230
>           }
>         ]
>       }
>     ]
>   }
> ]


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 93D18C61DA4
	for <linux-acpi@archiver.kernel.org>; Tue, 14 Feb 2023 16:45:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232515AbjBNQpA (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Tue, 14 Feb 2023 11:45:00 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36184 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231355AbjBNQom (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Tue, 14 Feb 2023 11:44:42 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 761C92CFD3;
        Tue, 14 Feb 2023 08:44:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676393043; x=1707929043;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=3tvw/QI2D6ZTdCszmgUUILhpm8UFQ9Woe8Lafhd7yBQ=;
  b=MvCzmgE2/uX/DVBds5boDUTOlWJDbBpzG/fdW/ZUDFHhQCSJbHJdgRhH
   sQV6HSTZwBmZjCMJkW/xKPK9pgKqSsFqMEVb7pnmNNEIEGQxGAGRgvEGp
   ntp63TNV2aMcwWnK1M+jMuZkwygCUBk2SJWZ015a7UsjAbWAt+oP47yzA
   qnZ4KaR0i0dG0aDSz2vMlTzdXIYVWr4FEX1JJOf7eYvhRbulV2JXMo8wD
   ShYrbDF+G+PUNu6a8wT9Qnr+1dYaPgmJR9kA6dI9Vqca680TQVYd36Uxt
   +JN18Tjr6AAXsumYU2M2juep30mNpHEIB1UFiani468c4V9L9uwqmIoQx
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10621"; a="417422827"
X-IronPort-AV: E=Sophos;i="5.97,297,1669104000"; 
   d="scan'208";a="417422827"
Received: from fmsmga002.fm.intel.com ([10.253.24.26])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 14 Feb 2023 08:43:44 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10621"; a="778408876"
X-IronPort-AV: E=Sophos;i="5.97,297,1669104000"; 
   d="scan'208";a="778408876"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmsmga002.fm.intel.com with ESMTP; 14 Feb 2023 08:43:44 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Tue, 14 Feb 2023 08:43:43 -0800
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Tue, 14 Feb 2023 08:43:43 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.168)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Tue, 14 Feb 2023 08:43:43 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=fur7xvapgA4W16qGJxEWCt6xzyePX5KOnseLFYnDewNCsu8vJx8Hc3x28cT78oG6ZPsggYkfe4izPQ7qcYWwwRJj4CkwkOEMzF2tRLKsJsCjqX9YrXtjsE3IcX1xIgztIaVowh2W8+U5YLiXRIIpWiuWBP9iKdk3lsj+Itr4wK/uMYVsvIWQodTdp3UWQG1WZ4CWNHLp/2Qerd+56gYVMVMWEsUOZzLeT5gCn7bLM/4TJKOQJxZG+bvTMxiiFN4kS7IvjSkx28URCuvw+SYVwu/jcJUwuMFjh5DJ9qMk4Xs9Fs+BkoBP5sSWbmS4M6GO+E7nA5EpMAQjslBIof8sEA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Bf19+GqZdyBUa2M+KLC4NWRWvx6V4y69gY0Htj+LPHc=;
 b=P52SvY054qIJ5mBKAzv/Iy1MRSQ/Sb4hZ+414oOX9pJKPHnkwoTk1xMu13q83QSIxGYczzd/XWAWuGfJK5PkMFD/7CgMw4p+SCap5xyIKOnTRbOPl/reaOfxY/pyN2ZXi9af0kOE1sCHCZA4mIBPq8nsm0HhjXyPHbmWR32u5z6Yws3UH+6lH4csG9/jssAL6Hrf/lTnPRN+YgbvoK8J+bJHc5J7eajlErmtgnyt3W2V+S1cACiLe4g0c4+vtjNHW8eK+cZqO60wdP+CHC/AEFMAAwzLqddXrDlyvfkXQ/b1MirSufvl039TNl6ByeRyUaVIECBvQfjKEhI7pJKa7A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by PH0PR11MB5144.namprd11.prod.outlook.com (2603:10b6:510:3e::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.26; Tue, 14 Feb
 2023 16:43:42 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%5]) with mapi id 15.20.6086.024; Tue, 14 Feb 2023
 16:43:42 +0000
Date: Tue, 14 Feb 2023 08:43:39 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Dan Williams <dan.j.williams@intel.com>
CC: <linux-cxl@vger.kernel.org>, Fan Ni <fan.ni@samsung.com>,
        <vishal.l.verma@intel.com>, <dave.hansen@linux.intel.com>,
        <linux-mm@kvack.org>, <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Message-ID: <63ebba3b6fe55_32d6129475@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
 <20230210180958.00002e5a@Huawei.com>
 <63e6b89581c3c_1db5d029467@dwillia2-xfh.jf.intel.com.notmuch>
 <20230214132336.00005915@Huawei.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230214132336.00005915@Huawei.com>
X-ClientProxiedBy: SJ0PR03CA0334.namprd03.prod.outlook.com
 (2603:10b6:a03:39c::9) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|PH0PR11MB5144:EE_
X-MS-Office365-Filtering-Correlation-Id: 03d762e7-b391-4296-a7e0-08db0eaaa173
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: S8SMG+RnG8uqudp0yYcCoyJfagdxuRbmQiY1sIJ2ZDU8TATT6L4p8S0nzuJw3J+dSgWdI9XbWUeHCMldkTAXhVjHBPEHTVsUWCSvF/ePdkVwABUudB/uI5JQxEca5Z4mrFbwL2+9qqUueBOup7gvVedDvilWQLCVdBb3AP+Ao6UFiCLilNclU2TCchU6LX+Zi6ZgggNecbeXGfKk0gwzh25ZUXaqnizJUAXmoRZWHPUZJdyvIs4aWP169t4XNFTUyPnqo6YvLs+ATyGJOMyuT7eGwDxHftXumGS/tl1QepRKo3+MzRA0HWbpx+R2R1DgHO234bBA5CYul+VOUzDbD93++hcdpoefzAh2oRyEhXqmbO44Q+DxbhuQbEbpjqsLImXuUbvytu23WZ8y2tlAN1DtZrgUkvlkILlEZxx0UoOe68s7f3MidopgljzQmlJUfWTggHvRGckotHVrtS/3w2PzgbUVPtCud6ozpGBfXM1wuNmiJqkILHNtQm5/cacNxGKcO07cKoIx1Ls8Uepa8p07yUj1sIw1mvKtuMCiOZHmImPcw3C64fuLTWeQ546wr1WMDfHwFCXJNwGegIxM7oCOgTP5qBbJpcuwHNTkp0YESo24yY+VriTw5dDM2q3eKUdAgdv2M6Fpl9K0YHjsuroaujYPJR8nFCi4bBf2lEywQVcaXOFK0RZL7u5AXbkJ
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(376002)(39860400002)(396003)(136003)(366004)(451199018)(4326008)(8676002)(66946007)(66556008)(66476007)(6666004)(6486002)(478600001)(5660300002)(26005)(186003)(6512007)(9686003)(8936002)(2906002)(316002)(6506007)(41300700001)(4744005)(86362001)(82960400001)(110136005)(38100700002);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?Ucz4E+xqg1qrgXRaOwjHIed6n9QHuOftTkcXpidGbkC68sBTN4eppasOXQQk?=
 =?us-ascii?Q?zqe1PTFP7FhPtUkQ3QDwcFcKT3aFtlaBkCpESixCHGrDK8/jVLqQU+YQAFj+?=
 =?us-ascii?Q?CguZQKxyCZUXBnqcQ2OgIHBEU7UFtZFo1mx+IUV47e8S5Afnpizgk40Q23Og?=
 =?us-ascii?Q?5IrJw6c8CszFvwD8dF/YSes1cpQyxDN5aBJDe2yQ7XzSKmi+zOSpEfq+rDCE?=
 =?us-ascii?Q?BumRjtX5Dg/V4pjQAft/2+YGEKTFonGRwK9gJv2E8tqW6yvbOVlWbPTVOhjz?=
 =?us-ascii?Q?aq0UJuhkq7vcOg71KTRU3tfsj4jQmaMwP4eSx4wSfVY5/fWUb3W2S3XuDVb4?=
 =?us-ascii?Q?6PIVrIKhkw4aG2qqII3STSz4IoebB3Q9ZRhgIIi/QRoKUyJEuwuwCthCri6e?=
 =?us-ascii?Q?dgyQNeLXaHXI71kOAyJyl5QcYZrDo5FMJqL56bUBhVEbYUOgvGKxKMi5gxaW?=
 =?us-ascii?Q?GkRtewi8wmCmFdOGRhY6honRSfrgjYIBsuJzdmIEwflhKEfhKH5uqeMRhcsH?=
 =?us-ascii?Q?nASJhcK//B7m0Hwy09xlqwk0iN9C7wFcaBSkFtQeM32xteUpaUvscH35qLJR?=
 =?us-ascii?Q?cPaE+MjhluytGvDCG4Thzwu3/Esnu3qSHZuEKskjnSzoQuuHcmOlujfgxjy1?=
 =?us-ascii?Q?AT8Cxf6Jkmq56q+9TOuFTW+ciJDGpeKIcUKHmS1epZo8Bw8FNLpMwSgCE57F?=
 =?us-ascii?Q?CYs3xv5WeHHOYus28OJRFv/tO3iI9n1Khv7nIqMZpPkwNyEHJJ0iVq9MQ2aw?=
 =?us-ascii?Q?5OHGVFM059bRpLF1pDimdnHCRpr/eM2FnpTyvndlpWbBOH/279/zmkRjG2MH?=
 =?us-ascii?Q?VrQM3i+up+pR66i5KS2aXU02W+nMfjXxSdt14g5neZET6b8KK9jnUNshIOJo?=
 =?us-ascii?Q?ltIIp0SAKWsBwHtXVxhSlPYXIlk9rikvWjK8tJZIpPrFUrfWUCOTENhtSFGF?=
 =?us-ascii?Q?lYngQvpeuCG9yU9dkCS5QO6uhgT0af/E9yqxXnnP7YaqLj11bJ+XCOd39hef?=
 =?us-ascii?Q?94ck5KnxTo1uNxwmpVP4Xy+Z9uJCQPGamGNLuP1P3l8M73s/Q16g7zUilIf7?=
 =?us-ascii?Q?n/A6DhvoowHTJfX9UmGTRjv0yHzpx3mfw1h9PNFAzOcrj0VIkJkf5GRP5dmv?=
 =?us-ascii?Q?+fXp6HMn1hQpI64oWNHJl//FMliJuN2X0+rxJphEzLVpIgRw21PYSm6U7/Fn?=
 =?us-ascii?Q?DpxkthKDVSwkuYsZSiNVLQCmJ4S4bFpcWgdvAe3eUdmwlEy5t96RqyntRlD4?=
 =?us-ascii?Q?Bb/mqdy2E1OYKuTj/awxk8d0sDjRw78/PSt1ABCDGqq6+DTbednGDhIiI071?=
 =?us-ascii?Q?FcsW5rZS3OuXrczfrcZ6DbWZTlBv9pfW5kFtNXLSNgOsewBeF8efcFPWLtMX?=
 =?us-ascii?Q?+tiintyJyLQLnIWV+WBGA+DK7cf3oJMvICPqMzS3aSQxSemhd3gpZk2or/9C?=
 =?us-ascii?Q?9uV3iE5mfAEJ+xscNuLKIxMPY3mitMJJWPATpA3VaLLcuwuAt9G9cVAgiJWY?=
 =?us-ascii?Q?J239+STmzFlUcPceNrCK6LED9HMg10gbkYYo+v90nm8Of7gPmjh3DRBOonGr?=
 =?us-ascii?Q?lrrIaviXDiIIYBLdtMYiMQ/+7DsrlRyQBHsufU59+UKOJGeK9sAG+rRaUMr6?=
 =?us-ascii?Q?+w=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 03d762e7-b391-4296-a7e0-08db0eaaa173
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Feb 2023 16:43:42.0404
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: TowZSjUtMxzXdRV4qkGQgrZw5T7UZWGyIzLVURYDoR7VARFPV4aPxVZVcfTRqmz7WVrs0QEdnImb8ONDyiHaCvmqrucDP1nLTCapp3GX8Ek=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH0PR11MB5144
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Jonathan Cameron wrote:
> 
> > > 
> > > 		/*
> > > 		 * If device_attach() fails the range may still be active via
> > > 		 * the platform-firmware memory map, otherwise the driver for
> > > 		 * regions is local to this file, so driver matching can't fail
> > > +                * and hence device_attach() cannot return 1.
> > > 
> > > //very much not obvious otherwise to anyone who isn't far too familiar with device_attach()  
> > 
> > Hence the comment? Not sure what else can be said here about why
> > device_attach() < 0 is a sufficient check.
> 
> I'd just add the bit I added above that calls out the condition you are
> describing is indicated by a return of 1.

Got it.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 933BCC61DA4
	for <linux-acpi@archiver.kernel.org>; Wed, 22 Feb 2023 21:41:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232831AbjBVVl4 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Wed, 22 Feb 2023 16:41:56 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41222 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232554AbjBVVlz (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Wed, 22 Feb 2023 16:41:55 -0500
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2D67231E2C;
        Wed, 22 Feb 2023 13:41:53 -0800 (PST)
Received: from uscas1p2.samsung.com (unknown [182.198.245.207])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230222214151usoutp011a7909c04a265d354640d5cce4f4babf~GQ3wjpTnM1696916969usoutp01b;
        Wed, 22 Feb 2023 21:41:51 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230222214151usoutp011a7909c04a265d354640d5cce4f4babf~GQ3wjpTnM1696916969usoutp01b
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1677102111;
        bh=LPOYnY1Abu2MYRNN0Up70ibVPDy5s5C6eVW/VlCfsSA=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=IQtx/RO+Dzp6xVa72OVw3DYV9UyxHL+a/URbEjUeBS08l9fpLcqoJ6GjbUP8ejYgH
         jhES8Ftm/UvnCYAUEdGZ+9oxOFY+tbw72CEymQ6Q8N8a+OZzDxNzRqhrRxjSziDDTe
         OalRFJycwqlTVbrU0o9xftp31LjWJ4t5RY6aR0G8=
Received: from ussmges3new.samsung.com (u112.gpu85.samsung.co.kr
        [203.254.195.112]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230222214151uscas1p1f939224fd14ace1b04548b5593a2bf56~GQ3wUtHE42613626136uscas1p1C;
        Wed, 22 Feb 2023 21:41:51 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges3new.samsung.com (USCPEMTA) with SMTP id C5.62.12196.F1C86F36; Wed,
        22 Feb 2023 16:41:51 -0500 (EST)
Received: from ussmgxs2new.samsung.com (u91.gpu85.samsung.co.kr
        [203.254.195.91]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230222214151uscas1p26d53b2e198f63a1f382fe575c6c25070~GQ3wAyhDD0572405724uscas1p2e;
        Wed, 22 Feb 2023 21:41:51 +0000 (GMT)
X-AuditID: cbfec370-83dfe70000012fa4-21-63f68c1fa75e
Received: from SSI-EX3.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs2new.samsung.com (USCPEXMTA) with SMTP id 22.E0.17110.E1C86F36; Wed,
        22 Feb 2023 16:41:50 -0500 (EST)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX3.ssi.samsung.com (105.128.2.228) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Wed, 22 Feb 2023 13:41:50 -0800
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Wed,
        22 Feb 2023 13:41:50 -0800
From: Fan Ni <fan.ni@samsung.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Dan Williams <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        Ira Weiny <ira.weiny@intel.com>,
        "David Hildenbrand" <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        "Davidlohr Bueso" <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        "Jonathan Cameron" <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        "Michal Hocko" <mhocko@suse.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>,
        Adam Manzanares <a.manzanares@samsung.com>
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System
 RAM' default
Thread-Topic: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System
        RAM' default
Thread-Index: AQHZPS7TjaXMIoSW1Eqtx3n221KG+a7Nu/OAgAACg4CADloxgA==
Date: Wed, 22 Feb 2023 21:41:49 +0000
Message-ID: <20230222214140.GA1276133@bgt-140510-bm03>
In-Reply-To: <Y+qB9T/PCZ6TpYlK@memverge.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="us-ascii"
Content-ID: <8B5676B7EC3BAA41B8A1E05B7711F9CD@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrIKsWRmVeSWpSXmKPExsWy7djX87ryPd+SDV7PF7eYPvUCo8WLDe2M
        FiduNrJZrL65htHi6/pfzBYNTY9YLPY/fc5isWrhNTaLM925Fsv39TNanJ91isXi3pr/rBb3
        +xwsbk04xuTA5zG74SKLR8uRt6wei/e8ZPLY9GkSu8e8k4EeGz/+Z/d4v+8qm8fU2fUe67dc
        ZfH4vEkugCuKyyYlNSezLLVI3y6BK+POsZesBX/VKra8387awLhVuouRk0NCwERiemsnaxcj
        F4eQwEpGiR+vX7NBOK1MEj2bHzDCVG0/dIEFIrGWUeL2jm/sEM4nRonju3rYQKqEBJYxSix4
        nwNiswkoSuzr2g4U5+AQEdCT+PjfE6SeWeAJi8Thtmdg9cIC4RJ/u/qZQWwRgQiJadNusEDU
        O0n8fOEMYrIIqEq8OqEAUsErYCaxs286C4jNKaAj8avvAJjNKCAm8f3UGiYQm1lAXOLWk/lM
        EDcLSiyavYcZwhaT+LfrIRuErShx//tLdoh6HYkFuz+xQdh2Eo3vP7BA2NoSyxa+ZobYKyhx
        cuYTFoheSYmDK26Aw0FCYDWnxJwzp6CGukhsXnOPHcKWlvh7dxkTyP0SAskSqz5yQYRzJOYv
        2QI1x1pi4Z/1TBMYVWYhOXsWkpNmITlpFpKTZiE5aQEj6ypG8dLi4tz01GLjvNRyveLE3OLS
        vHS95PzcTYzAVHj63+GCHYy3bn3UO8TIxMF4iFGCg1lJhPc/7+dkId6UxMqq1KL8+KLSnNTi
        Q4zSHCxK4ryGtieThQTSE0tSs1NTC1KLYLJMHJxSDUw1Blc/yDvaJPYstzO/ccFLPGTeE2m/
        c38NLU9mHSo5N7Ge70ZvY75h8wENhbqHET3mausUDu+eu/iG5aaaYweD088Vpt8osWR/sXnd
        lTh2Tk3dmCcfO85aye64z10hvLa1y8D4ieUrlgiV/T35AjU8/U6lOQfXbe6Ju/K9Ue+wVk6A
        SyHzf+N9677xuaZ6PL0yVWzD57/sz2Ukc/pC3x243/VA7gBXQoAm58/V9b8qpdY3Bzf4fTtb
        KKQ4tVztqWnmNHFN9e5zqq7sRfuanN9dX7HJ4AHXm1gvvR+2ppaRS8zPu167/3/qfJMLqqfM
        9xtuOKHdft+ooean05mV83c53+C0L/09j3XHm1+X25RYijMSDbWYi4oTAfYL1Tj0AwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFmpkleLIzCtJLcpLzFFi42LJbGCaqCvX8y3Z4P1rG4vpUy8wWrzY0M5o
        ceJmI5vF6ptrGC2+rv/FbNHQ9IjFYv/T5ywWqxZeY7M4051rsXxfP6PF+VmnWCzurfnPanG/
        z8Hi1oRjTA58HrMbLrJ4tBx5y+qxeM9LJo9Nnyaxe8w7Geix8eN/do/3+66yeUydXe+xfstV
        Fo/Pm+QCuKK4bFJSczLLUov07RK4Mu4ce8la8FetYsv77awNjFuluxg5OSQETCS2H7rA0sXI
        xSEksJpRov9NEzuE84lR4va5e2wQzjJGic/7W5lBWtgEFCX2dW0HSnBwiAjoSXz87wlSwyzw
        hEXicNszNpAaYYFwifdLjoPViwhESDy92MkOUe8k8fOFM4jJIqAq8eqEAkgFr4CZxM6+6VBH
        zGSU6Ph2iwkkwSmgI/Gr7wALiM0oICbx/dQasDizgLjErSfzmSA+EJBYsuc8M4QtKvHy8T9W
        CFtR4v73l+wQ9ToSC3Z/YoOw7SQa339ggbC1JZYtfM0McYSgxMmZT1ggeiUlDq64wTKBUWIW
        knWzkIyahWTULCSjZiEZtYCRdRWjeGlxcW56RbFRXmq5XnFibnFpXrpecn7uJkZgKjn973D0
        Dsbbtz7qHWJk4mA8xCjBwawkwvuf93OyEG9KYmVValF+fFFpTmrxIUZpDhYlcd6XURPjhQTS
        E0tSs1NTC1KLYLJMHJxSDUyqDvxT1gSydISmRH6Q+aH+p/d7X+eCBp6y92s/zj/javPys6fh
        2cmGJ+Wsjt8/Y62u+6r+wpy7ZQmPvl+6e2TheoOHTB6Fn63ipp4vM2Dc47XkrNz5SsaJnQyb
        QgPm57BqnLbibjzBxaW7+FFe6rq2bRLqe1K/fplcZdTCsVHEaP209R1sTtvT7XkfiF+f1rd8
        Rnu5Qx9PVmW3bXq63fW6X9v/b+TIry7K63r+9lGgIf+BhlUbj+Szyd7hMWH83Hvp7HyTqV9M
        ah7Gd5hp8E+a6VPAq82wssQrf6LctGuZijMuWdxTEZnVMNO2n9NzT8iUT+vT5ObmN812f6pV
        l7OwWFn/4E/zRkuxVXsjM5VYijMSDbWYi4oTAWayOpaUAwAA
X-CMS-MailID: 20230222214151uscas1p26d53b2e198f63a1f382fe575c6c25070
CMS-TYPE: 301P
X-CMS-RootMailID: 20230222214151uscas1p26d53b2e198f63a1f382fe575c6c25070
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <Y+p/2S4rnrOOyZ8w@memverge.com> <Y+qB9T/PCZ6TpYlK@memverge.com>
        <CGME20230222214151uscas1p26d53b2e198f63a1f382fe575c6c25070@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Mon, Feb 13, 2023 at 01:31:17PM -0500, Gregory Price wrote:

> On Mon, Feb 13, 2023 at 01:22:17PM -0500, Gregory Price wrote:
> > On Fri, Feb 10, 2023 at 01:05:21AM -0800, Dan Williams wrote:
> > > Changes since v1: [1]
> > > [... snip ...]
> > [... snip ...]
> > Really i see these decoders and device mappings setup:
> > port1 -> mem2
> > port2 -> mem1
> > port3 -> mem0
>=20
> small correction:
> port1 -> mem1
> port3 -> mem0
> port2 -> mem2
>=20
> >=20
> > Therefore I should expect
> > decoder0.0 -> mem2
> > decoder0.1 -> mem1
> > decoder0.2 -> mem0
> >=20
>=20
> this end up mapping this way, which is still further jumbled.
>=20
> Something feels like there's an off-by-one
>=20

Currently, the naming of memdevs can be out-of-order due to the
following two reasons,
1. At kernel side, cxl port driver does async device probe, which can
change the memdev naming even within a single OS boot and among multiple
time of device enumeration. The pattern can be observed with following
steps in the guest,
	loop(){
	a) modprobe cxl_xxx
	b)cxl list  --> you will see the memdev name changes (like mem0->mem1).
	c) rmmod cxl_xxx
	}
This behaviour can be avoided by using sync device probe by making the
following change
--------------------------------------------
diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index 258004f34281..f3f90fad62b5 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -663,7 +663,7 @@ static struct pci_driver cxl_pci_driver =3D {
 	.probe			=3D cxl_pci_probe,
 	.err_handler		=3D &cxl_error_handlers,
 	.driver	=3D {
-		.probe_type	=3D PROBE_PREFER_ASYNCHRONOUS,
+		.probe_type =3D PROBE_FORCE_SYNCHRONOUS,
 	},
 };
-------------------------------------------

The above patch, you will see consistent memdev naming within one
OS boot, however, the order can be still different from what we expect with
the qemu config options we use. We need to make some change at QEMU side
also as shown below.

2. Currently in Qemu, multiple components at the same topology level are
stored in a data structure called QLIST as defined in
include/qemu/queue.h. When enqueuing a component, current qemu code uses
QLIST_INSERT_HEAD to insert the item at the head, but when iterating, it
uses QLIST_FOREACH/QLIST_FOREACH_SAFE which is also from the head of the
list. That is to say, if we enqueue items P1,P2,P3 in order, when iterating=
,
we get P3,P2,P1. I have a simple test with the below code change(always
insert to the list tail), the order issue is fixed.

---------------------------------------------------------------------------=
-
diff --git a/include/qemu/queue.h b/include/qemu/queue.h
index e029e7bf66..15491960e1 100644
--- a/include/qemu/queue.h
+++ b/include/qemu/queue.h
@@ -130,7 +130,7 @@ struct {                                               =
                 \
         (listelm)->field.le_prev =3D &(elm)->field.le_next;               =
\
 } while (/*CONSTCOND*/0)
=20
-#define QLIST_INSERT_HEAD(head, elm, field) do {                        \
+#define QLIST_INSERT_HEAD_OLD(head, elm, field) do {                    \
         if (((elm)->field.le_next =3D (head)->lh_first) !=3D NULL)        =
  \
                 (head)->lh_first->field.le_prev =3D &(elm)->field.le_next;=
\
         (head)->lh_first =3D (elm);                                       =
\
@@ -146,6 +146,20 @@ struct {                                              =
                  \
         (elm)->field.le_prev =3D NULL;                                    =
\
 } while (/*CONSTCOND*/0)
=20
+#define QLIST_INSERT_TAIL(head, elm, field) do {                        \
+        typeof(elm) last_p =3D (head)->lh_first;                          =
\
+        while (last_p && last_p->field.le_next)                         \
+            last_p =3D last_p->field.le_next;                             =
\
+        if (last_p)                                                     \
+            QLIST_INSERT_AFTER(last_p, elm, field);                     \
+        else                                                            \
+            QLIST_INSERT_HEAD_OLD(head, elm, field);                    \
+} while (/*CONSTCOND*/0)
+
+#define QLIST_INSERT_HEAD(head, elm, field) do {                        \
+        QLIST_INSERT_TAIL(head, elm, field);                            \
+} while (/*CONSTCOND*/0)
+
 /*
  * Like QLIST_REMOVE() but safe to call when elm is not in a list
  */
---------------------------------------------------------------------------=
--

The memdev naming order can also cause confusion when creating regions
for multiple memdevs under different HBs as in the kernel code, we enforce
HB check to ensure the target position matches the CFMW configuration.
To avoid the confusion, we can use "cxl list -TD" to find out the target
position for a memdev, but it is kind of annoying to do it before
creating region.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D7F31C6379F
	for <linux-acpi@archiver.kernel.org>; Wed, 22 Feb 2023 22:18:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232898AbjBVWS6 (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Wed, 22 Feb 2023 17:18:58 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:44998 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232630AbjBVWSt (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Wed, 22 Feb 2023 17:18:49 -0500
Received: from mga18.intel.com (mga18.intel.com [134.134.136.126])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DE14E469A;
        Wed, 22 Feb 2023 14:18:26 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1677104306; x=1708640306;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=Dy5EnaRDOp3Ku3VThQS0qowUYay7A32JoU6kRDQ10gQ=;
  b=jR90Gty9xd3qAgFXen9HPkRdfywAUxbVW2ls1sWtLd9+y2BsFN4Ln0mF
   2jdgEwpB2FsUpzOzYHrvbBZ5U9rfKm0YoAggv5B/Y1U5QV77s3+xOCZzp
   hmM8f4PwiNi2d99muLEircY4mk3h2BSaWCZS/TowjrAV2p06j4/ZQ34ZY
   kfikGccLA9SGt0yuoNOiB0bdOQAQ7UO+PlAhxTWsQ4j+QyGyqChJSDmzG
   ul/mKAPpyoN6rzoyDjqxaruGZpZOY/nRREdJFKaXUrMKjriCAVNWx6eya
   if5RrB0wKR0133zljJR2Kt/6MDdoN98eXhWcyc83OaDEmjcauwqSAthbi
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10629"; a="316780407"
X-IronPort-AV: E=Sophos;i="5.97,319,1669104000"; 
   d="scan'208";a="316780407"
Received: from orsmga001.jf.intel.com ([10.7.209.18])
  by orsmga106.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 22 Feb 2023 14:18:15 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10629"; a="704614112"
X-IronPort-AV: E=Sophos;i="5.97,319,1669104000"; 
   d="scan'208";a="704614112"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orsmga001.jf.intel.com with ESMTP; 22 Feb 2023 14:18:15 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Wed, 22 Feb 2023 14:18:14 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Wed, 22 Feb 2023 14:18:14 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Wed, 22 Feb 2023 14:18:14 -0800
Received: from NAM04-MW2-obe.outbound.protection.outlook.com (104.47.73.170)
 by edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Wed, 22 Feb 2023 14:18:12 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=KUAu9LH91o+vYG5ppbeLrSDmjqIygSmu8UBhsMzu0JSAeMfCeZZL4o2n82sIvtm2sB0MNryl8I/QboLiPrunFhS6xgONecD00AIMy3iEAsEY0k2awehkDZpx01fUh7Ieoxneae9DsCmXcEW3u2OWJsSP6sgqXHheBhKvwWZTE9MxYp2JfhYPWkq4Lsx54Lgjui8Rp37WyxUoVyI3U9yq/u8urkGjzU289aQT6f8us2UISx61USKfXc7t1GLpzlHYxT1/vbQ5mbT/w8Lxu7ctkhtYN1T3eQHmOWCnTtkmCHI7kDh94pxT9an6XGXt+owPM8YNZA4T8qbnwqPDxFo54Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3pIZOtCs3GbvReSnpMhVHuc7G3rHBPdEqivzWP62Yyw=;
 b=Z2rlv2KN9pNmYv0PFQwksmSviSRpHkzO9U9j/8yAgzK4KCq8UGj/KOvKA96QcsHNtp5dM3heGObNHeqcSU6fC2wd2WwkhGBdUo6EHeyZGdDs+lrP/+/poWzA8yekO3SlyqMyrFBX4bLnnioCuA7Jf8lOfusaAO8+4jOrzpa/VoHIa1/qINbHi4z7RmbwKPWS+pfzvyktfTlB+1B8cX0j6M1ko5kN6APsHdukXhXDvqWqfPmUisqxGTmMEyKkbQgV0+rauUpZoX75g7omVo3iazBeL/E8cXmQl8HMgigji/jfaPtmjFxXs06slYUgPf38DFxiaHZ5BRNGi7oy+FmcNg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from PH8PR11MB8107.namprd11.prod.outlook.com (2603:10b6:510:256::6)
 by IA0PR11MB7884.namprd11.prod.outlook.com (2603:10b6:208:3dc::5) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6111.21; Wed, 22 Feb
 2023 22:18:08 +0000
Received: from PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc]) by PH8PR11MB8107.namprd11.prod.outlook.com
 ([fe80::421b:865b:f356:7dfc%6]) with mapi id 15.20.6134.019; Wed, 22 Feb 2023
 22:18:08 +0000
Date: Wed, 22 Feb 2023 14:18:05 -0800
From: Dan Williams <dan.j.williams@intel.com>
To: Fan Ni <fan.ni@samsung.com>,
        Gregory Price <gregory.price@memverge.com>
CC: Dan Williams <dan.j.williams@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        Ira Weiny <ira.weiny@intel.com>,
        "David Hildenbrand" <david@redhat.com>,
        Dave Jiang <dave.jiang@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        Kees Cook <keescook@chromium.org>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        Vishal Verma <vishal.l.verma@intel.com>,
        Dave Hansen <dave.hansen@linux.intel.com>,
        Michal Hocko <mhocko@suse.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>,
        Adam Manzanares <a.manzanares@samsung.com>
Subject: Re: [PATCH v2 00/20] CXL RAM and the 'Soft Reserved' => 'System RAM'
 default
Message-ID: <63f6949d71917_19f329463@dwillia2-xfh.jf.intel.com.notmuch>
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
 <Y+p/2S4rnrOOyZ8w@memverge.com>
 <Y+qB9T/PCZ6TpYlK@memverge.com>
 <CGME20230222214151uscas1p26d53b2e198f63a1f382fe575c6c25070@uscas1p2.samsung.com>
 <20230222214140.GA1276133@bgt-140510-bm03>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230222214140.GA1276133@bgt-140510-bm03>
X-ClientProxiedBy: SJ0PR05CA0063.namprd05.prod.outlook.com
 (2603:10b6:a03:332::8) To PH8PR11MB8107.namprd11.prod.outlook.com
 (2603:10b6:510:256::6)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: PH8PR11MB8107:EE_|IA0PR11MB7884:EE_
X-MS-Office365-Filtering-Correlation-Id: d37f597a-4c1f-4b26-c7f6-08db1522ad26
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: n7LlIwe613E3sd88gMG2+aVSzNT1yqJpXzmUvZNcfwxhzffitc7Mf0X+Eeu280+8IxSiyObhQq2ExHz1hhSpPUWYb2s9/3F4tivNvKsrD8kO/jcs3bSXgKY7OTVnoRFbG0U+9g9gC5JBw6XCegbYsg5FxF/Ps2t4dIGvlsVzbSsc6fPUHfVjAS7R6rp4VWmIm3c7Lx5aQ4TULYogg8cj+EeEcaeb2NmC5SVpCtFDm/o8CeNnnsARdQTRSVkDQJ/7YCWI1QycrsEQTdC5Oom/dUU9ju2FDVyJ9GsS7jD5+jOZC0o2YVhNLLokMjmsPEzIWGYdM1XjRgOwA6iP8K2tW4EiHgiUeB1WhD2dWG6vzPjlCzqVxs8BemMbPETuiEvquigoPUP1sxSXxix4intscFdHwy8uUncFT3hK1yECnu/UVWqQkhI9YBSSeEiRZ6JzC5ouHxs29WzPwPYJBKSNKUHSkzmer+5UePm5wHi13KdqXlEdz3UDOSOHs+QbXEPlFn963KH9yGkAicnc0W8uGEQh2FkLVmcxUEUORtOJVg3GBms5I0oc8Vv9bDhbv26zuvAGVVQYbJbzQIkkTEFRPV9TWErnH3V4Ufpr5d+HZJMUmjy9WmABwWgBAIsyKattm2tOA3tC7qEoPwqZX7y0RclA6bZVjBP1pFj2uOLfOQ5t0qYrjrXnq+px+WTciuwB
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:PH8PR11MB8107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(39860400002)(366004)(376002)(396003)(136003)(451199018)(38100700002)(66556008)(66946007)(66476007)(8676002)(83380400001)(6506007)(26005)(6512007)(186003)(86362001)(9686003)(6666004)(82960400001)(110136005)(54906003)(316002)(478600001)(6486002)(4326008)(5660300002)(2906002)(8936002)(7416002)(41300700001)(21314003);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?i/XnhGlWofZ3vRSK6uOH+i3gAMXBDRAhiYuYSRgtDdEzIyUiwvde+U7S6YL9?=
 =?us-ascii?Q?Z1tTgOH303DSvafFnaOkEcmM8DqX21rnuY47oEq1b0ltMmu1eaID0qHT214V?=
 =?us-ascii?Q?HUa0CvtD+Dm3hdnziNYLTgJp6PetJyyg7weyyPhIoIcTU00lr7mjq/57MQWA?=
 =?us-ascii?Q?njQ98ZfA+UF1pD+I0ZzbYbjSgQaq+/R+5HbHZ99mcvB1p6G7VxTBQbSdmZaB?=
 =?us-ascii?Q?wzlg35R3dHE5S75pqvQHKt6juJDhPV6PEPH1lZt+1UedANy6BBwVAvGZF8vM?=
 =?us-ascii?Q?JLirvv9JvCzBZni/wt+t5LFb5YLODDpf+dE6Q+KXDdERK9i5HgcCWgassmF5?=
 =?us-ascii?Q?P+4YMDGB51i4BPVenSQBytheschvIP3OLDmUlqM2YzEI1BZZULddd45K3mQJ?=
 =?us-ascii?Q?keBNmTXtuF4ZMrYYRnIdC38adA0CcSpHiNy3xUuu5HOhBzeREbBVNRbs1vbu?=
 =?us-ascii?Q?OJFXjiu5yTmZnDnwUxv35RT/ZgWtzb0ySvt4OU6Q0gCIkiHtknKnMnXB8ezQ?=
 =?us-ascii?Q?LV48ub5gidzK+Sjfrxl3gz1sJwd2MPPOP8yGY+Vjw2bsZGowe8e0Gm7fLaDj?=
 =?us-ascii?Q?KZ2P1FRlK5b5Bx3mGNLMXMa5dZ0Okch90v0lRqBljA9qCsfjWqG8EBLNEFu/?=
 =?us-ascii?Q?fHCFtDqMcsR5x7A8DFyZntrnU3z1KBdRR8p8bMZOZUCBD1KTi7X5ZqhVtIV+?=
 =?us-ascii?Q?HH6iDR12QvVhdHFINGPoN7jaOQJIvBEbMbgu5tfXwuRKkK8v6hACAYq9JNkL?=
 =?us-ascii?Q?THaBBv/tbV2nfsG37qZQ2RjBmvBjmin2+akLxXQlbbDmFhCmbDuVwO/ekW9l?=
 =?us-ascii?Q?SHJQv+yesLgdZsLEDrG9x8ykLQ8rxKX1GiuDuZXiNV0KI8wV0V8aGXaVgVX1?=
 =?us-ascii?Q?tqzr5DDfoPJ2OyJMxvn3js3bRFuJlGeQBURboGLAIZCiNE6UuG40JDwMSTCE?=
 =?us-ascii?Q?xxNgvFWsv/PGNwjo4OkfzijpbYAjVW4tF2oYtuT2b8Mg1L5gMNy8VDgfOOs+?=
 =?us-ascii?Q?fHOiEt3DINhIBEHG5x7CGcsSMe3nz3opqqAWUo51ruC58ZXNsxpG83pvqfjw?=
 =?us-ascii?Q?Ux2VzPpcF+0PN3jwKOHtAlrth82andJ/pTENgH9cWkjUF8EkV385yGdZb6d2?=
 =?us-ascii?Q?/cgJjoVM9fl5LPZA6bBynR+TCtj9K9wPONCDv2Ys6eyYJNZc43WrNPb9rey0?=
 =?us-ascii?Q?5uyvyI8VzTOyZY74lEHcXIOjE/G0syKIgwXwWynI9Un24c1A+8Wyla3WvGzg?=
 =?us-ascii?Q?cye0nHQ8FG4EBB7yW1fiHjy91UXlPJhX6lv6DoySMEvC4dfYTV3YARFpjNf2?=
 =?us-ascii?Q?NdrbqGAmzlNokFX2mKdR4YtiRslHDfKpiYNkSdJi0swkzkCPoeApQHxOVhMb?=
 =?us-ascii?Q?mdUCfYtStEvdQmKD8PtIaGdLRI2f03ztXjay2IEtboI3B6aTKVFCZRBnfCXL?=
 =?us-ascii?Q?zhND3QfSK6i5mJu6+vSxCJlx57eRBgX7OelTNcFA6rcRk27RQZS1ecKJBid4?=
 =?us-ascii?Q?T4l6lnh519fAfDI6ZeIN9muoRg74DtN+EJSG0wJnkK3LPaQPHll+cfXDa1I8?=
 =?us-ascii?Q?QBm0VhLboWIeNcTqzsagGobIhUVf7yPuAd8NWA4nfjHZoqimCTkOSIZMJ0vx?=
 =?us-ascii?Q?ZA=3D=3D?=
X-MS-Exchange-CrossTenant-Network-Message-Id: d37f597a-4c1f-4b26-c7f6-08db1522ad26
X-MS-Exchange-CrossTenant-AuthSource: PH8PR11MB8107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 22 Feb 2023 22:18:08.3003
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: pxcFgXNA/UQG5i/1iR8Fpg7K1nwYhiHKBleLT3vIt1hyBDSPk+fKZyJERlThuXbiKe2rXSSOy13zalL20gJOErHH1mZ3sUuF3X36Eu8jSW0=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR11MB7884
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

Fan Ni wrote:
> On Mon, Feb 13, 2023 at 01:31:17PM -0500, Gregory Price wrote:
> 
> > On Mon, Feb 13, 2023 at 01:22:17PM -0500, Gregory Price wrote:
> > > On Fri, Feb 10, 2023 at 01:05:21AM -0800, Dan Williams wrote:
> > > > Changes since v1: [1]
> > > > [... snip ...]
> > > [... snip ...]
> > > Really i see these decoders and device mappings setup:
> > > port1 -> mem2
> > > port2 -> mem1
> > > port3 -> mem0
> > 
> > small correction:
> > port1 -> mem1
> > port3 -> mem0
> > port2 -> mem2
> > 
> > > 
> > > Therefore I should expect
> > > decoder0.0 -> mem2
> > > decoder0.1 -> mem1
> > > decoder0.2 -> mem0
> > > 
> > 
> > this end up mapping this way, which is still further jumbled.
> > 
> > Something feels like there's an off-by-one
> > 
> 
> Currently, the naming of memdevs can be out-of-order due to the
> following two reasons,
> 1. At kernel side, cxl port driver does async device probe, which can
> change the memdev naming even within a single OS boot and among multiple
> time of device enumeration. The pattern can be observed with following
> steps in the guest,
> 	loop(){
> 	a) modprobe cxl_xxx
> 	b)cxl list  --> you will see the memdev name changes (like mem0->mem1).
> 	c) rmmod cxl_xxx
> 	}
> This behaviour can be avoided by using sync device probe by making the
> following change
> --------------------------------------------
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index 258004f34281..f3f90fad62b5 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -663,7 +663,7 @@ static struct pci_driver cxl_pci_driver = {
>  	.probe			= cxl_pci_probe,
>  	.err_handler		= &cxl_error_handlers,
>  	.driver	= {
> -		.probe_type	= PROBE_PREFER_ASYNCHRONOUS,
> +		.probe_type = PROBE_FORCE_SYNCHRONOUS,
>  	},
>  };
> -------------------------------------------
> 
> The above patch, you will see consistent memdev naming within one
> OS boot, however, the order can be still different from what we expect with
> the qemu config options we use. We need to make some change at QEMU side
> also as shown below.

This is by design. Kernel device name order is not guaranteed even with
synchronous probing and the async probing acts to make sure these names
are always random for memdevs. For a memdev the recommendation is to
identify them by 'host'/'path' or by 'serial':

# cxl list -u -m 0000:35:00.0
{
  "memdev":"mem0",
  "pmem_size":"512.00 MiB (536.87 MB)",
  "serial":"0",
  "host":"0000:35:00.0"
}


# cxl list -u -s 0
{
  "memdev":"mem0",
  "pmem_size":"512.00 MiB (536.87 MB)",
  "serial":"0",
  "host":"0000:35:00.0"
}

Although, in real life a CXL device will have a non-zero unique serial
number.

> 2. Currently in Qemu, multiple components at the same topology level are
> stored in a data structure called QLIST as defined in
> include/qemu/queue.h. When enqueuing a component, current qemu code uses
> QLIST_INSERT_HEAD to insert the item at the head, but when iterating, it
> uses QLIST_FOREACH/QLIST_FOREACH_SAFE which is also from the head of the
> list. That is to say, if we enqueue items P1,P2,P3 in order, when iterating,
> we get P3,P2,P1. I have a simple test with the below code change(always
> insert to the list tail), the order issue is fixed.

Again, kernel does not and should not be expected to guarantee kernel
device name ordering. Perhaps this merits /dev/cxl/by-path and
/dev/cxl/by-id similar to /dev/disk/by-path and /dev/disk/by-id for
semi-persistent / persistent naming.

That's a conversation to have with the systemd-udev folks.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-acpi-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2FF0FC7EE30
	for <linux-acpi@archiver.kernel.org>; Tue, 28 Feb 2023 18:53:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229758AbjB1Sxz (ORCPT <rfc822;linux-acpi@archiver.kernel.org>);
        Tue, 28 Feb 2023 13:53:55 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:54474 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229546AbjB1Sxy (ORCPT
        <rfc822;linux-acpi@vger.kernel.org>); Tue, 28 Feb 2023 13:53:54 -0500
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AD67B23DAF;
        Tue, 28 Feb 2023 10:53:50 -0800 (PST)
Received: from uscas1p2.samsung.com (unknown [182.198.245.207])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230228185349usoutp018333c8fa1981db80ce1ec2e98155d649~IEcwGrkH80728707287usoutp01Y;
        Tue, 28 Feb 2023 18:53:49 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230228185349usoutp018333c8fa1981db80ce1ec2e98155d649~IEcwGrkH80728707287usoutp01Y
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1677610429;
        bh=KMjFAvg33d71tzzA1MJXReWWFh/0FnBoyl7FggkKTTc=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=aAlYXRcZNnLftZL/7fmTSlsk2QdsKuVG5HI9E0MAn3WembeC1CR+BbSnnLq42yCSO
         bNJmqoa9VWDFkacHecfKBg/89jN1HngMkxpM4USRNzK5SP05lEP/b9eOUUMP4pqno9
         nY1bln5sRiahb9A+KBcy/4TGgDvQ4KhP5EK3D8jE=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230228185349uscas1p1fd5c69c94f11cde6911f1cf0b323a5c6~IEcv-49Wc2370323703uscas1p1M;
        Tue, 28 Feb 2023 18:53:49 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id E8.3F.06976.CBD4EF36; Tue,
        28 Feb 2023 13:53:48 -0500 (EST)
Received: from ussmgxs3new.samsung.com (u92.gpu85.samsung.co.kr
        [203.254.195.92]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230228185348uscas1p1a5314a077383ee81ac228c1b9f1da2f8~IEcvsQQJn2376523765uscas1p1Q;
        Tue, 28 Feb 2023 18:53:48 +0000 (GMT)
X-AuditID: cbfec36d-afdff70000011b40-4c-63fe4dbcb0b5
Received: from SSI-EX2.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs3new.samsung.com (USCPEXMTA) with SMTP id C0.B5.11346.CBD4EF36; Tue,
        28 Feb 2023 13:53:48 -0500 (EST)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX2.ssi.samsung.com (105.128.2.227) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Tue, 28 Feb 2023 10:53:47 -0800
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Tue,
        28 Feb 2023 10:53:47 -0800
From: Fan Ni <fan.ni@samsung.com>
To: Dan Williams <dan.j.williams@intel.com>
CC: "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "vishal.l.verma@intel.com" <vishal.l.verma@intel.com>,
        "dave.hansen@linux.intel.com" <dave.hansen@linux.intel.com>,
        "linux-mm@kvack.org" <linux-mm@kvack.org>,
        "linux-acpi@vger.kernel.org" <linux-acpi@vger.kernel.org>
Subject: Re: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Topic: [PATCH v2 13/20] cxl/region: Add region autodiscovery
Thread-Index: AQHZPS8BwEUv6lxvFESNil6PPdG9Oq7lV7OA
Date: Tue, 28 Feb 2023 18:53:47 +0000
Message-ID: <20230228185226.GA1361414@bgt-140510-bm03>
In-Reply-To: <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="us-ascii"
Content-ID: <3705B10E73711B4AAB5C05B6B62DC8C4@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrAKsWRmVeSWpSXmKPExsWy7djX87p7fP8lGzy+aGMxfeoFRosXG9oZ
        LZbv62e0OD/rFIvFvTX/WS1uTTjG5MDmsXjPSyaPTZ8msXvMOxno8XmTXABLFJdNSmpOZllq
        kb5dAlfGyhXqBXeuMFY86DnB3MDYu4Kxi5GTQ0LAROLs3L8sXYxcHEICKxklNrRfZoVwWpkk
        Gro2M3cxcoBVrb2uARFfyygx5cc5qI5PjBIrFh5lhHCWMUpManvABDKXTUBRYl/XdjYQW0RA
        W2LinIPMIEXMAnOZJJ7v6GAFSQgLOEn0HzzADFHkLLHzwxFWCNtI4u7BLhYQm0VAVWLtzy9M
        IGfwCphJTDsbBhLmFAiX2Nq7C6yEUUBM4vupNWB7mQXEJW49mc8E8ZugxKLZe5ghbDGJf7se
        skHYihL3v79kh6jXkViw+xMbhG0n0XFiLguErS2xbOFrsF5eoDknZz5hgeiVlDi44gaUfYFD
        4tg1ewjbRWLJ0TVQu6Qlpq+5zAIJuWSJVR+5IMI5EvOXbIFqtZZY+Gc90wRGlVlIrp6F5KJZ
        SC6aheSiWUguWsDIuopRvLS4ODc9tdgwL7Vcrzgxt7g0L10vOT93EyMwEZ3+dzh3B+OOWx/1
        DjEycTAeYpTgYFYS4V14+0+yEG9KYmVValF+fFFpTmrxIUZpDhYlcV5D25PJQgLpiSWp2amp
        BalFMFkmDk6pBibOxzlNPSuiliXOPv9jIX/1qzvP1Hm7utIm3Hu53EQ//5roS3bbnukliQ+v
        Wvx9uzZkZe7au7bhzmJz9Gd+4op5Otlvzb7ndpszfOcm3F67vpLjxqYnuqwVsW48m9gkch9n
        h4RmunxZEfgwYvbzVfce2IhGnFbqUWB/qzl3kZ3vuQi7V+YGGR0XTOaYrpANlTJX3tdZfv7c
        jMjemIVmVb2tSs0uHf8Zppz41B/36oTZaq9/FXdehEqpSJq/T7lkWRV9wLy+Kbp4WpH2ppVL
        epYuM1SbvTe++2w4f1tVTX7X5YtLvdfkWIdyVlyK1LmjvnL27f1ixyeZuYvLsDJvXMYp2bZ3
        z5SDMywzu57VSCuxFGckGmoxFxUnAgAuFg3gswMAAA==
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrAIsWRmVeSWpSXmKPExsWS2cA0SXeP779kg41dahbTp15gtHixoZ3R
        Yvm+fkaL87NOsVjcW/Of1eLWhGNMDmwei/e8ZPLY9GkSu8e8k4EenzfJBbBEcdmkpOZklqUW
        6dslcGWsXKFecOcKY8WDnhPMDYy9Kxi7GDk4JARMJNZe1+hi5OIQEljNKHH06l82COcTo0RP
        z2NmCGcZo8Sb3kb2LkZODjYBRYl9XdvZQGwRAW2JiXMOghUxC8xlkni+o4MVJCEs4CTRf/AA
        M0SRs8TOD0dYIWwjibsHu1hAbBYBVYm1P78wgZzBK2AmMe1sGMSyJYwSS68+A1vGKRAusbV3
        F1g9o4CYxPdTa5hAbGYBcYlbT+aD2RICAhJL9pxnhrBFJV4+/scKYStK3P/+kh2iXkdiwe5P
        bBC2nUTHibksELa2xLKFr8F6eQUEJU7OfMIC0SspcXDFDZYJjBKzkKybhWTULCSjZiEZNQvJ
        qAWMrKsYxUuLi3PTK4qN81LL9YoTc4tL89L1kvNzNzECI/n0v8MxOxjv3fqod4iRiYPxEKME
        B7OSCO/C23+ShXhTEiurUovy44tKc1KLDzFKc7AoifN6xE6MFxJITyxJzU5NLUgtgskycXBK
        NTAZaf0/8OLCpNC2SY+iV73a/VxDVr6tvPaXocCE0IsXb01bZGZuEH57L5uqsnyMYa1qBKPF
        kyOajVJmewsN9l1teuv75/fFhY4hob3mQkzLXxybICJVssNiyb3gJ3Fn+ZMmBP3Yu/jI0/u6
        RS+FhHde+RIweX3jGe7r/pGMRWfPZZY4ruvnLb6RctqL99LbOYZby3zqLedeEG8y8ljf5He0
        O7LTZ+d998dOM5uYPCR3BRucz2SaVMfn2nLLQEs5fXdh2OR9Oa8PPUyNff2XtXnpz4BnX965
        Fh+82ib36PA1w4MlNesmnfynZGty5sjG98nnyw13HOBe+um/FH/BWX6WV/feHROLj0/dHpBx
        /c5SJZbijERDLeai4kQARjRKo1MDAAA=
X-CMS-MailID: 20230228185348uscas1p1a5314a077383ee81ac228c1b9f1da2f8
CMS-TYPE: 301P
X-CMS-RootMailID: 20230228185348uscas1p1a5314a077383ee81ac228c1b9f1da2f8
References: <167601992097.1924368.18291887895351917895.stgit@dwillia2-xfh.jf.intel.com>
        <167601999958.1924368.9366954455835735048.stgit@dwillia2-xfh.jf.intel.com>
        <CGME20230228185348uscas1p1a5314a077383ee81ac228c1b9f1da2f8@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-acpi.vger.kernel.org>
X-Mailing-List: linux-acpi@vger.kernel.org

On Fri, Feb 10, 2023 at 01:06:39AM -0800, Dan Williams wrote:
> Region autodiscovery is an asynchronous state machine advanced by
> cxl_port_probe(). After the decoders on an endpoint port are enumerated
> they are scanned for actively enabled instances. Each active decoder is
> flagged for auto-assembly CXL_DECODER_F_AUTO and attached to a region.
> If a region does not already exist for the address range setting of the
> decoder one is created. That creation process may race with other
> decoders of the same region being discovered since cxl_port_probe() is
> asynchronous. A new 'struct cxl_root_decoder' lock, @range_lock, is
> introduced to mitigate that race.
>=20
> Once all decoders have arrived, "p->nr_targets =3D=3D p->interleave_ways"=
,
> they are sorted by their relative decode position. The sort algorithm
> involves finding the point in the cxl_port topology where one leg of the
> decode leads to deviceA and the other deviceB. At that point in the
> topology the target order in the 'struct cxl_switch_decoder' indicates
> the relative position of those endpoint decoders in the region.
>=20
> >From that point the region goes through the same setup and validation
> steps as user-created regions, but instead of programming the decoders
> it validates that driver would have written the same values to the
> decoders as were already present.
>=20
> Tested-by: Fan Ni <fan.ni@samsung.com>
> Link: https://lore.kernel.org/r/167564540972.847146.17096178433176097831.=
stgit@dwillia2-xfh.jf.intel.com
> Signed-off-by: Dan Williams <dan.j.williams@intel.com>
> ---
>  drivers/cxl/core/hdm.c    |   11 +
>  drivers/cxl/core/port.c   |    2=20
>  drivers/cxl/core/region.c |  497 +++++++++++++++++++++++++++++++++++++++=
+++++-
>  drivers/cxl/cxl.h         |   29 +++
>  drivers/cxl/port.c        |   48 ++++
>  5 files changed, 576 insertions(+), 11 deletions(-)
>=20
> diff --git a/drivers/cxl/core/hdm.c b/drivers/cxl/core/hdm.c
> index a0891c3464f1..8c29026a4b9d 100644
> --- a/drivers/cxl/core/hdm.c
> +++ b/drivers/cxl/core/hdm.c
> @@ -676,6 +676,14 @@ static int cxl_decoder_reset(struct cxl_decoder *cxl=
d)
>  	port->commit_end--;
>  	cxld->flags &=3D ~CXL_DECODER_F_ENABLE;
> =20
> +	/* Userspace is now responsible for reconfiguring this decoder */
> +	if (is_endpoint_decoder(&cxld->dev)) {
> +		struct cxl_endpoint_decoder *cxled;
> +
> +		cxled =3D to_cxl_endpoint_decoder(&cxld->dev);
> +		cxled->state =3D CXL_DECODER_STATE_MANUAL;
> +	}
> +
>  	return 0;
>  }
> =20
> @@ -783,6 +791,9 @@ static int init_hdm_decoder(struct cxl_port *port, st=
ruct cxl_decoder *cxld,
>  		return rc;
>  	}
>  	*dpa_base +=3D dpa_size + skip;
> +
> +	cxled->state =3D CXL_DECODER_STATE_AUTO;
> +
>  	return 0;
>  }
> =20
> diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
> index 9e5df64ea6b5..59620528571a 100644
> --- a/drivers/cxl/core/port.c
> +++ b/drivers/cxl/core/port.c
> @@ -446,6 +446,7 @@ bool is_endpoint_decoder(struct device *dev)
>  {
>  	return dev->type =3D=3D &cxl_decoder_endpoint_type;
>  }
> +EXPORT_SYMBOL_NS_GPL(is_endpoint_decoder, CXL);
> =20
>  bool is_root_decoder(struct device *dev)
>  {
> @@ -1628,6 +1629,7 @@ struct cxl_root_decoder *cxl_root_decoder_alloc(str=
uct cxl_port *port,
>  	}
> =20
>  	cxlrd->calc_hb =3D calc_hb;
> +	mutex_init(&cxlrd->range_lock);
> =20
>  	cxld =3D &cxlsd->cxld;
>  	cxld->dev.type =3D &cxl_decoder_root_type;
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 691605f1e120..3f6453da2c51 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -6,6 +6,7 @@
>  #include <linux/module.h>
>  #include <linux/slab.h>
>  #include <linux/uuid.h>
> +#include <linux/sort.h>
>  #include <linux/idr.h>
>  #include <cxlmem.h>
>  #include <cxl.h>
> @@ -524,7 +525,12 @@ static void cxl_region_iomem_release(struct cxl_regi=
on *cxlr)
>  	if (device_is_registered(&cxlr->dev))
>  		lockdep_assert_held_write(&cxl_region_rwsem);
>  	if (p->res) {
> -		remove_resource(p->res);
> +		/*
> +		 * Autodiscovered regions may not have been able to insert their
> +		 * resource.
> +		 */
> +		if (p->res->parent)
> +			remove_resource(p->res);
>  		kfree(p->res);
>  		p->res =3D NULL;
>  	}
> @@ -1105,12 +1111,35 @@ static int cxl_port_setup_targets(struct cxl_port=
 *port,
>  		return rc;
>  	}
> =20
> -	cxld->interleave_ways =3D iw;
> -	cxld->interleave_granularity =3D ig;
> -	cxld->hpa_range =3D (struct range) {
> -		.start =3D p->res->start,
> -		.end =3D p->res->end,
> -	};
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		if (cxld->interleave_ways !=3D iw ||
> +		    cxld->interleave_granularity !=3D ig ||
> +		    cxld->hpa_range.start !=3D p->res->start ||
> +		    cxld->hpa_range.end !=3D p->res->end ||
> +		    ((cxld->flags & CXL_DECODER_F_ENABLE) =3D=3D 0)) {
> +			dev_err(&cxlr->dev,
> +				"%s:%s %s expected iw: %d ig: %d %pr\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				__func__, iw, ig, p->res);
> +			dev_err(&cxlr->dev,
> +				"%s:%s %s got iw: %d ig: %d state: %s %#llx:%#llx\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				__func__, cxld->interleave_ways,
> +				cxld->interleave_granularity,
> +				(cxld->flags & CXL_DECODER_F_ENABLE) ?
> +					"enabled" :
> +					"disabled",
> +				cxld->hpa_range.start, cxld->hpa_range.end);
> +			return -ENXIO;
> +		}
> +	} else {
> +		cxld->interleave_ways =3D iw;
> +		cxld->interleave_granularity =3D ig;
> +		cxld->hpa_range =3D (struct range) {
> +			.start =3D p->res->start,
> +			.end =3D p->res->end,
> +		};
> +	}
>  	dev_dbg(&cxlr->dev, "%s:%s iw: %d ig: %d\n", dev_name(port->uport),
>  		dev_name(&port->dev), iw, ig);
>  add_target:
> @@ -1121,7 +1150,17 @@ static int cxl_port_setup_targets(struct cxl_port =
*port,
>  			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), pos);
>  		return -ENXIO;
>  	}
> -	cxlsd->target[cxl_rr->nr_targets_set] =3D ep->dport;
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		if (cxlsd->target[cxl_rr->nr_targets_set] !=3D ep->dport) {
> +			dev_dbg(&cxlr->dev, "%s:%s: %s expected %s at %d\n",
> +				dev_name(port->uport), dev_name(&port->dev),
> +				dev_name(&cxlsd->cxld.dev),
> +				dev_name(ep->dport->dport),
> +				cxl_rr->nr_targets_set);
> +			return -ENXIO;
> +		}
> +	} else
> +		cxlsd->target[cxl_rr->nr_targets_set] =3D ep->dport;
>  	inc =3D 1;
>  out_target_set:
>  	cxl_rr->nr_targets_set +=3D inc;
> @@ -1163,6 +1202,13 @@ static void cxl_region_teardown_targets(struct cxl=
_region *cxlr)
>  	struct cxl_ep *ep;
>  	int i;
> =20
> +	/*
> +	 * In the auto-discovery case skip automatic teardown since the
> +	 * address space is already active
> +	 */
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags))
> +		return;
> +
>  	for (i =3D 0; i < p->nr_targets; i++) {
>  		cxled =3D p->targets[i];
>  		cxlmd =3D cxled_to_memdev(cxled);
> @@ -1195,8 +1241,8 @@ static int cxl_region_setup_targets(struct cxl_regi=
on *cxlr)
>  			iter =3D to_cxl_port(iter->dev.parent);
> =20
>  		/*
> -		 * Descend the topology tree programming targets while
> -		 * looking for conflicts.
> +		 * Descend the topology tree programming / validating
> +		 * targets while looking for conflicts.
>  		 */
>  		for (ep =3D cxl_ep_load(iter, cxlmd); iter;
>  		     iter =3D ep->next, ep =3D cxl_ep_load(iter, cxlmd)) {
> @@ -1291,6 +1337,185 @@ static int cxl_region_attach_position(struct cxl_=
region *cxlr,
>  	return rc;
>  }
> =20
> +static int cxl_region_attach_auto(struct cxl_region *cxlr,
> +				  struct cxl_endpoint_decoder *cxled, int pos)
> +{
> +	struct cxl_region_params *p =3D &cxlr->params;
> +
> +	if (cxled->state !=3D CXL_DECODER_STATE_AUTO) {
> +		dev_err(&cxlr->dev,
> +			"%s: unable to add decoder to autodetected region\n",
> +			dev_name(&cxled->cxld.dev));
> +		return -EINVAL;
> +	}
> +
> +	if (pos >=3D 0) {
> +		dev_dbg(&cxlr->dev, "%s: expected auto position, not %d\n",
> +			dev_name(&cxled->cxld.dev), pos);
> +		return -EINVAL;
> +	}
> +
> +	if (p->nr_targets >=3D p->interleave_ways) {
> +		dev_err(&cxlr->dev, "%s: no more target slots available\n",
> +			dev_name(&cxled->cxld.dev));
> +		return -ENXIO;
> +	}
> +
> +	/*
> +	 * Temporarily record the endpoint decoder into the target array. Yes,
> +	 * this means that userspace can view devices in the wrong position
> +	 * before the region activates, and must be careful to understand when
> +	 * it might be racing region autodiscovery.
> +	 */
> +	pos =3D p->nr_targets;
> +	p->targets[pos] =3D cxled;
> +	cxled->pos =3D pos;
> +	p->nr_targets++;
> +
> +	return 0;
> +}
> +
> +static struct cxl_port *next_port(struct cxl_port *port)
> +{
> +	if (!port->parent_dport)
> +		return NULL;
> +	return port->parent_dport->port;
> +}
> +
> +static int decoder_match_range(struct device *dev, void *data)
> +{
> +	struct cxl_endpoint_decoder *cxled =3D data;
> +	struct cxl_switch_decoder *cxlsd;
> +
> +	if (!is_switch_decoder(dev))
> +		return 0;
> +
> +	cxlsd =3D to_cxl_switch_decoder(dev);
> +	return range_contains(&cxlsd->cxld.hpa_range, &cxled->cxld.hpa_range);
> +}
> +
> +static void find_positions(const struct cxl_switch_decoder *cxlsd,
> +			   const struct cxl_port *iter_a,
> +			   const struct cxl_port *iter_b, int *a_pos,
> +			   int *b_pos)
> +{
> +	int i;
> +
> +	for (i =3D 0, *a_pos =3D -1, *b_pos =3D -1; i < cxlsd->nr_targets; i++)=
 {
> +		if (cxlsd->target[i] =3D=3D iter_a->parent_dport)
> +			*a_pos =3D i;
> +		else if (cxlsd->target[i] =3D=3D iter_b->parent_dport)
> +			*b_pos =3D i;
> +		if (*a_pos >=3D 0 && *b_pos >=3D 0)
> +			break;
> +	}
> +}
> +
> +static int cmp_decode_pos(const void *a, const void *b)
> +{
> +	struct cxl_endpoint_decoder *cxled_a =3D *(typeof(cxled_a) *)a;
> +	struct cxl_endpoint_decoder *cxled_b =3D *(typeof(cxled_b) *)b;
> +	struct cxl_memdev *cxlmd_a =3D cxled_to_memdev(cxled_a);
> +	struct cxl_memdev *cxlmd_b =3D cxled_to_memdev(cxled_b);
> +	struct cxl_port *port_a =3D cxled_to_port(cxled_a);
> +	struct cxl_port *port_b =3D cxled_to_port(cxled_b);
> +	struct cxl_port *iter_a, *iter_b, *port =3D NULL;
> +	struct cxl_switch_decoder *cxlsd;
> +	struct device *dev;
> +	int a_pos, b_pos;
> +	unsigned int seq;
> +
> +	/* Exit early if any prior sorting failed */
> +	if (cxled_a->pos < 0 || cxled_b->pos < 0)
> +		return 0;
> +
> +	/*
> +	 * Walk up the hierarchy to find a shared port, find the decoder that
> +	 * maps the range, compare the relative position of those dport
> +	 * mappings.
> +	 */
> +	for (iter_a =3D port_a; iter_a; iter_a =3D next_port(iter_a)) {
> +		struct cxl_port *next_a, *next_b;
> +
> +		next_a =3D next_port(iter_a);
> +		if (!next_a)
> +			break;
> +
> +		for (iter_b =3D port_b; iter_b; iter_b =3D next_port(iter_b)) {
> +			next_b =3D next_port(iter_b);
> +			if (next_a !=3D next_b)
> +				continue;
> +			port =3D next_a;
> +			break;
> +		}
> +
> +		if (port)
> +			break;
> +	}
> +
> +	if (!port) {
> +		dev_err(cxlmd_a->dev.parent,
> +			"failed to find shared port with %s\n",
> +			dev_name(cxlmd_b->dev.parent));
> +		goto err;
> +	}
> +
> +	dev =3D device_find_child(&port->dev, cxled_a, decoder_match_range);
> +	if (!dev) {
> +		struct range *range =3D &cxled_a->cxld.hpa_range;
> +
> +		dev_err(port->uport,
> +			"failed to find decoder that maps %#llx-%#llx\n",
> +			range->start, range->end);
> +		goto err;
> +	}
> +
> +	cxlsd =3D to_cxl_switch_decoder(dev);
> +	do {
> +		seq =3D read_seqbegin(&cxlsd->target_lock);
> +		find_positions(cxlsd, iter_a, iter_b, &a_pos, &b_pos);
> +	} while (read_seqretry(&cxlsd->target_lock, seq));
> +
> +	put_device(dev);
> +
> +	if (a_pos < 0 || b_pos < 0) {
> +		dev_err(port->uport,
> +			"failed to find shared decoder for %s and %s\n",
> +			dev_name(cxlmd_a->dev.parent),
> +			dev_name(cxlmd_b->dev.parent));
> +		goto err;
> +	}
> +
> +	dev_dbg(port->uport, "%s comes %s %s\n", dev_name(cxlmd_a->dev.parent),
> +		a_pos - b_pos < 0 ? "before" : "after",
> +		dev_name(cxlmd_b->dev.parent));
> +
> +	return a_pos - b_pos;
> +err:
> +	cxled_a->pos =3D -1;
> +	return 0;
> +}
> +
> +static int cxl_region_sort_targets(struct cxl_region *cxlr)
> +{
> +	struct cxl_region_params *p =3D &cxlr->params;
> +	int i, rc =3D 0;
> +
> +	sort(p->targets, p->nr_targets, sizeof(p->targets[0]), cmp_decode_pos,
> +	     NULL);
> +
> +	for (i =3D 0; i < p->nr_targets; i++) {
> +		struct cxl_endpoint_decoder *cxled =3D p->targets[i];
> +
> +		if (cxled->pos < 0)
> +			rc =3D -ENXIO;
> +		cxled->pos =3D i;
> +	}
> +
> +	dev_dbg(&cxlr->dev, "region sort %s\n", rc ? "failed" : "successful");
> +	return rc;
> +}
> +
>  static int cxl_region_attach(struct cxl_region *cxlr,
>  			     struct cxl_endpoint_decoder *cxled, int pos)
>  {
> @@ -1354,6 +1579,50 @@ static int cxl_region_attach(struct cxl_region *cx=
lr,
>  		return -EINVAL;
>  	}
> =20
> +	if (test_bit(CXL_REGION_F_AUTO, &cxlr->flags)) {
> +		int i;
> +
> +		rc =3D cxl_region_attach_auto(cxlr, cxled, pos);
> +		if (rc)
> +			return rc;
> +
> +		/* await more targets to arrive... */
> +		if (p->nr_targets < p->interleave_ways)
> +			return 0;
> +
> +		/*
> +		 * All targets are here, which implies all PCI enumeration that
> +		 * affects this region has been completed. Walk the topology to
> +		 * sort the devices into their relative region decode position.
> +		 */
> +		rc =3D cxl_region_sort_targets(cxlr);
> +		if (rc)
> +			return rc;
> +
> +		for (i =3D 0; i < p->nr_targets; i++) {
> +			cxled =3D p->targets[i];
> +			ep_port =3D cxled_to_port(cxled);
> +			dport =3D cxl_find_dport_by_dev(root_port,
> +						      ep_port->host_bridge);
> +			rc =3D cxl_region_attach_position(cxlr, cxlrd, cxled,
> +							dport, i);
> +			if (rc)
> +				return rc;
> +		}
> +
> +		rc =3D cxl_region_setup_targets(cxlr);
> +		if (rc)
> +			return rc;
> +
> +		/*
> +		 * If target setup succeeds in the autodiscovery case
> +		 * then the region is already committed.
> +		 */
> +		p->state =3D CXL_CONFIG_COMMIT;
> +
> +		return 0;
> +	}
> +
>  	rc =3D cxl_region_validate_position(cxlr, cxled, pos);
>  	if (rc)
>  		return rc;
> @@ -2087,6 +2356,193 @@ static int devm_cxl_add_pmem_region(struct cxl_re=
gion *cxlr)
>  	return rc;
>  }
> =20
> +static int match_decoder_by_range(struct device *dev, void *data)
> +{
> +	struct range *r1, *r2 =3D data;
> +	struct cxl_root_decoder *cxlrd;
> +
> +	if (!is_root_decoder(dev))
> +		return 0;
> +
> +	cxlrd =3D to_cxl_root_decoder(dev);
> +	r1 =3D &cxlrd->cxlsd.cxld.hpa_range;
> +	return range_contains(r1, r2);
> +}
> +
> +static int match_region_by_range(struct device *dev, void *data)
> +{
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	struct range *r =3D data;
> +	int rc =3D 0;
> +
> +	if (!is_cxl_region(dev))
> +		return 0;
> +
> +	cxlr =3D to_cxl_region(dev);
> +	p =3D &cxlr->params;
> +
> +	down_read(&cxl_region_rwsem);
> +	if (p->res && p->res->start =3D=3D r->start && p->res->end =3D=3D r->en=
d)
> +		rc =3D 1;
> +	up_read(&cxl_region_rwsem);
> +
> +	return rc;
> +}
> +
> +/* Establish an empty region covering the given HPA range */
> +static struct cxl_region *construct_region(struct cxl_root_decoder *cxlr=
d,
> +					   struct cxl_endpoint_decoder *cxled)
> +{
> +	struct cxl_memdev *cxlmd =3D cxled_to_memdev(cxled);
> +	struct cxl_port *port =3D cxlrd_to_port(cxlrd);
> +	struct range *hpa =3D &cxled->cxld.hpa_range;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	struct resource *res;
> +	int rc;
> +
> +	do {
> +		cxlr =3D __create_region(cxlrd, cxled->mode,
> +				       atomic_read(&cxlrd->region_id));
> +	} while (IS_ERR(cxlr) && PTR_ERR(cxlr) =3D=3D -EBUSY);
> +
> +	if (IS_ERR(cxlr)) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s: %s failed assign region: %ld\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			__func__, PTR_ERR(cxlr));
> +		return cxlr;
> +	}
> +
> +	down_write(&cxl_region_rwsem);
> +	p =3D &cxlr->params;
> +	if (p->state >=3D CXL_CONFIG_INTERLEAVE_ACTIVE) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s: %s autodiscovery interrupted\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			__func__);
> +		rc =3D -EBUSY;
> +		goto err;
> +	}
> +
> +	set_bit(CXL_REGION_F_AUTO, &cxlr->flags);
> +
> +	res =3D kmalloc(sizeof(*res), GFP_KERNEL);
> +	if (!res) {
> +		rc =3D -ENOMEM;
> +		goto err;
> +	}
> +
> +	*res =3D DEFINE_RES_MEM_NAMED(hpa->start, range_len(hpa),
> +				    dev_name(&cxlr->dev));
> +	rc =3D insert_resource(cxlrd->res, res);
> +	if (rc) {
> +		/*
> +		 * Platform-firmware may not have split resources like "System
> +		 * RAM" on CXL window boundaries see cxl_region_iomem_release()
> +		 */
> +		dev_warn(cxlmd->dev.parent,
> +			 "%s:%s: %s %s cannot insert resource\n",
> +			 dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev),
> +			 __func__, dev_name(&cxlr->dev));
> +	}
> +
> +	p->res =3D res;
> +	p->interleave_ways =3D cxled->cxld.interleave_ways;
> +	p->interleave_granularity =3D cxled->cxld.interleave_granularity;
> +	p->state =3D CXL_CONFIG_INTERLEAVE_ACTIVE;
> +
> +	rc =3D sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group(=
));
> +	if (rc)
> +		goto err;
> +
> +	dev_dbg(cxlmd->dev.parent, "%s:%s: %s %s res: %pr iw: %d ig: %d\n",
> +		dev_name(&cxlmd->dev), dev_name(&cxled->cxld.dev), __func__,
> +		dev_name(&cxlr->dev), p->res, p->interleave_ways,
> +		p->interleave_granularity);
> +
> +	/* ...to match put_device() in cxl_add_to_region() */
> +	get_device(&cxlr->dev);
> +	up_write(&cxl_region_rwsem);
> +
> +	return cxlr;
> +
> +err:
> +	up_write(&cxl_region_rwsem);
> +	devm_release_action(port->uport, unregister_region, cxlr);
> +	return ERR_PTR(rc);
> +}
> +
> +int cxl_add_to_region(struct cxl_port *root, struct cxl_endpoint_decoder=
 *cxled)
> +{
> +	struct cxl_memdev *cxlmd =3D cxled_to_memdev(cxled);
> +	struct range *hpa =3D &cxled->cxld.hpa_range;
> +	struct cxl_decoder *cxld =3D &cxled->cxld;
> +	struct cxl_root_decoder *cxlrd;
> +	struct cxl_region_params *p;
> +	struct cxl_region *cxlr;
> +	bool attach =3D false;
> +	struct device *dev;
> +	int rc;
> +
> +	dev =3D device_find_child(&root->dev, &cxld->hpa_range,
> +				match_decoder_by_range);
> +	if (!dev) {
> +		dev_err(cxlmd->dev.parent,
> +			"%s:%s no CXL window for range %#llx:%#llx\n",
> +			dev_name(&cxlmd->dev), dev_name(&cxld->dev),
> +			cxld->hpa_range.start, cxld->hpa_range.end);
> +		return -ENXIO;
> +	}
> +
> +	cxlrd =3D to_cxl_root_decoder(dev);
> +
> +	/*
> +	 * Ensure that if multiple threads race to construct_region() for @hpa
> +	 * one does the construction and the others add to that.
> +	 */
> +	mutex_lock(&cxlrd->range_lock);
> +	dev =3D device_find_child(&cxlrd->cxlsd.cxld.dev, hpa,
> +				match_region_by_range);
> +	if (!dev)
> +		cxlr =3D construct_region(cxlrd, cxled);
> +	else
> +		cxlr =3D to_cxl_region(dev);
> +	mutex_unlock(&cxlrd->range_lock);
> +
> +	if (IS_ERR(cxlr)) {
> +		rc =3D PTR_ERR(cxlr);
> +		goto out;
> +	}
> +
> +	attach_target(cxlr, cxled, -1, TASK_UNINTERRUPTIBLE);
> +
> +	down_read(&cxl_region_rwsem);
> +	p =3D &cxlr->params;
> +	attach =3D p->state =3D=3D CXL_CONFIG_COMMIT;
> +	up_read(&cxl_region_rwsem);
> +
> +	if (attach) {
> +		int rc =3D device_attach(&cxlr->dev);
> +
> +		/*
> +		 * If device_attach() fails the range may still be active via
> +		 * the platform-firmware memory map, otherwise the driver for
> +		 * regions is local to this file, so driver matching can't fail.
> +		 */
> +		if (rc < 0)
> +			dev_err(&cxlr->dev, "failed to enable, range: %pr\n",
> +				p->res);
> +	}
> +
> +	put_device(&cxlr->dev);
> +out:
> +	put_device(&cxlrd->cxlsd.cxld.dev);
> +	return rc;
> +}
> +EXPORT_SYMBOL_NS_GPL(cxl_add_to_region, CXL);
> +
>  static int cxl_region_invalidate_memregion(struct cxl_region *cxlr)
>  {
>  	if (!test_bit(CXL_REGION_F_INCOHERENT, &cxlr->flags))
> @@ -2111,6 +2567,15 @@ static int cxl_region_invalidate_memregion(struct =
cxl_region *cxlr)
>  	return 0;
>  }
> =20
> +static int is_system_ram(struct resource *res, void *arg)
> +{
> +	struct cxl_region *cxlr =3D arg;
> +	struct cxl_region_params *p =3D &cxlr->params;
> +
> +	dev_dbg(&cxlr->dev, "%pr has System RAM: %pr\n", p->res, res);
> +	return 1;
> +}
> +
>  static int cxl_region_probe(struct device *dev)
>  {
>  	struct cxl_region *cxlr =3D to_cxl_region(dev);
> @@ -2144,6 +2609,18 @@ static int cxl_region_probe(struct device *dev)
>  	switch (cxlr->mode) {
>  	case CXL_DECODER_PMEM:
>  		return devm_cxl_add_pmem_region(cxlr);
> +	case CXL_DECODER_RAM:
> +		/*
> +		 * The region can not be manged by CXL if any portion of
> +		 * it is already online as 'System RAM'
> +		 */
> +		if (walk_iomem_res_desc(IORES_DESC_NONE,
> +					IORESOURCE_SYSTEM_RAM | IORESOURCE_BUSY,
> +					p->res->start, p->res->end, cxlr,
> +					is_system_ram) > 0)
> +			return 0;
> +		dev_dbg(dev, "TODO: hookup devdax\n");
> +		return 0;
>  	default:
>  		dev_dbg(&cxlr->dev, "unsupported region mode: %d\n",
>  			cxlr->mode);
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index ca76879af1de..c8ee4bb8cce6 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -261,6 +261,8 @@ resource_size_t cxl_rcrb_to_component(struct device *=
dev,
>   * cxl_decoder flags that define the type of memory / devices this
>   * decoder supports as well as configuration lock status See "CXL 2.0
>   * 8.2.5.12.7 CXL HDM Decoder 0 Control Register" for details.
> + * Additionally indicate whether decoder settings were autodetected,
> + * user customized.
>   */
>  #define CXL_DECODER_F_RAM   BIT(0)
>  #define CXL_DECODER_F_PMEM  BIT(1)
> @@ -334,12 +336,22 @@ static inline const char *cxl_decoder_mode_name(enu=
m cxl_decoder_mode mode)
>  	return "mixed";
>  }
> =20
> +/*
> + * Track whether this decoder is reserved for region autodiscovery, or
> + * free for userspace provisioning.
> + */
> +enum cxl_decoder_state {
> +	CXL_DECODER_STATE_MANUAL,
> +	CXL_DECODER_STATE_AUTO,
> +};
> +
>  /**
>   * struct cxl_endpoint_decoder - Endpoint  / SPA to DPA decoder
>   * @cxld: base cxl_decoder_object
>   * @dpa_res: actively claimed DPA span of this decoder
>   * @skip: offset into @dpa_res where @cxld.hpa_range maps
>   * @mode: which memory type / access-mode-partition this decoder targets
> + * @state: autodiscovery state
>   * @pos: interleave position in @cxld.region
>   */
>  struct cxl_endpoint_decoder {
> @@ -347,6 +359,7 @@ struct cxl_endpoint_decoder {
>  	struct resource *dpa_res;
>  	resource_size_t skip;
>  	enum cxl_decoder_mode mode;
> +	enum cxl_decoder_state state;
>  	int pos;
>  };
> =20
> @@ -380,6 +393,7 @@ typedef struct cxl_dport *(*cxl_calc_hb_fn)(struct cx=
l_root_decoder *cxlrd,
>   * @region_id: region id for next region provisioning event
>   * @calc_hb: which host bridge covers the n'th position by granularity
>   * @platform_data: platform specific configuration data
> + * @range_lock: sync region autodiscovery by address range
>   * @cxlsd: base cxl switch decoder
>   */
>  struct cxl_root_decoder {
> @@ -387,6 +401,7 @@ struct cxl_root_decoder {
>  	atomic_t region_id;
>  	cxl_calc_hb_fn calc_hb;
>  	void *platform_data;
> +	struct mutex range_lock;
>  	struct cxl_switch_decoder cxlsd;
>  };
> =20
> @@ -436,6 +451,13 @@ struct cxl_region_params {
>   */
>  #define CXL_REGION_F_INCOHERENT 0
> =20
> +/*
> + * Indicate whether this region has been assembled by autodetection or
> + * userspace assembly. Prevent endpoint decoders outside of automatic
> + * detection from being added to the region.
> + */
> +#define CXL_REGION_F_AUTO 1
> +
>  /**
>   * struct cxl_region - CXL region
>   * @dev: This region's device
> @@ -699,6 +721,8 @@ struct cxl_nvdimm_bridge *cxl_find_nvdimm_bridge(stru=
ct device *dev);
>  #ifdef CONFIG_CXL_REGION
>  bool is_cxl_pmem_region(struct device *dev);
>  struct cxl_pmem_region *to_cxl_pmem_region(struct device *dev);
> +int cxl_add_to_region(struct cxl_port *root,
> +		      struct cxl_endpoint_decoder *cxled);
>  #else
>  static inline bool is_cxl_pmem_region(struct device *dev)
>  {
> @@ -708,6 +732,11 @@ static inline struct cxl_pmem_region *to_cxl_pmem_re=
gion(struct device *dev)
>  {
>  	return NULL;
>  }
> +static inline int cxl_add_to_region(struct cxl_port *root,
> +				    struct cxl_endpoint_decoder *cxled)
> +{
> +	return 0;
> +}
>  #endif
> =20
>  /*
> diff --git a/drivers/cxl/port.c b/drivers/cxl/port.c
> index a8d46a67b45e..d88518836c2d 100644
> --- a/drivers/cxl/port.c
> +++ b/drivers/cxl/port.c
> @@ -30,6 +30,34 @@ static void schedule_detach(void *cxlmd)
>  	schedule_cxl_memdev_detach(cxlmd);
>  }
> =20
> +static int discover_region(struct device *dev, void *root)
> +{
> +	struct cxl_endpoint_decoder *cxled;
> +	int rc;
> +
> +	if (!is_endpoint_decoder(dev))
> +		return 0;
> +
> +	cxled =3D to_cxl_endpoint_decoder(dev);
> +	if ((cxled->cxld.flags & CXL_DECODER_F_ENABLE) =3D=3D 0)
> +		return 0;
> +
> +	if (cxled->state !=3D CXL_DECODER_STATE_AUTO)
> +		return 0;
> +
> +	/*
> +	 * Region enumeration is opportunistic, if this add-event fails,
> +	 * continue to the next endpoint decoder.
> +	 */
> +	rc =3D cxl_add_to_region(root, cxled);
> +	if (rc)
> +		dev_dbg(dev, "failed to add to region: %#llx-%#llx\n",
> +			cxled->cxld.hpa_range.start, cxled->cxld.hpa_range.end);
> +
> +	return 0;
should we return rc here?
> +}
> +
> +
>  static int cxl_switch_port_probe(struct cxl_port *port)
>  {
>  	struct cxl_hdm *cxlhdm;
> @@ -54,6 +82,7 @@ static int cxl_endpoint_port_probe(struct cxl_port *por=
t)
>  	struct cxl_memdev *cxlmd =3D to_cxl_memdev(port->uport);
>  	struct cxl_dev_state *cxlds =3D cxlmd->cxlds;
>  	struct cxl_hdm *cxlhdm;
> +	struct cxl_port *root;
>  	int rc;
> =20
>  	cxlhdm =3D devm_cxl_setup_hdm(port);
> @@ -78,7 +107,24 @@ static int cxl_endpoint_port_probe(struct cxl_port *p=
ort)
>  		return rc;
>  	}
> =20
> -	return devm_cxl_enumerate_decoders(cxlhdm);
> +	rc =3D devm_cxl_enumerate_decoders(cxlhdm);
> +	if (rc)
> +		return rc;
> +
> +	/*
> +	 * This can't fail in practice as CXL root exit unregisters all
> +	 * descendant ports and that in turn synchronizes with cxl_port_probe()
> +	 */
> +	root =3D find_cxl_root(&cxlmd->dev);
> +
> +	/*
> +	 * Now that all endpoint decoders are successfully enumerated, try to
> +	 * assemble regions from committed decoders
> +	 */
> +	device_for_each_child(&port->dev, root, discover_region);
> +	put_device(&root->dev);
> +
> +	return 0;
>  }
> =20
>  static int cxl_port_probe(struct device *dev)
>=20
> =

