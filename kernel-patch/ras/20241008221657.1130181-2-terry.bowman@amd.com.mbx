From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-BN1-obe.outbound.protection.outlook.com (mail-bn1nam02on2042.outbound.protection.outlook.com [40.107.212.42])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 291092C859;
	Tue,  8 Oct 2024 22:17:19 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.212.42
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425841; cv=fail; b=NlkL2WH0vnfYFPt68fq/NzJrhocV11wES2oh0GZtAQZ6tlcmmbsCo1OvuCgvKr38lV+0DWC9DhlTv/5zu0SNbfLjXPTC3MUNyRiESgCBNBihSdwHl01m8nWHcozLZcS7bC1XDhv9Xoa2BBOEd2dmeW+aYbVMdteD4ozUpi4w+HI=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425841; c=relaxed/simple;
	bh=3ajCeJWwKGnIuIRxtZoHxudNg8Sh/rhnFW2YiHLoLsg=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=tWZW/5WYhlAXJPA52RZEM2iq1RKecstQkxdoxd/OB1Ij5xPRgsg7jfvq58zkGQzxFnpf5TZuFoiV+2D8LL6Ua0slMu+JL6S4zhPai07yL/7FRuEC3l5POW8JBVkO6/Yg6wcH1cNY1+Kb5RmvLFI10Y3PeJewlZUgu8TY7Z/raCc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=HliNjP42; arc=fail smtp.client-ip=40.107.212.42
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="HliNjP42"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=dnqhJNaFlNbg06zpbnWd9AUwqAXSmusK8V7zmrcLEOVxc8iV1bdfgNCANMyVFJL/lAlKs/tA5OUAtZCKZz4+1bosyA/NYOphjffFThvonB978HmM9QzOgGYGFqPYqEV5pNQB8ykvKv7wjZaKTN/ojXJHAofyvrLhwUaUMXedlqHqdAGOcidjaQpMr5QaMfLzMf6edcvOyrzy10XtB+QyVTJER8EOdeC4tmBFEd1k3EPI7K3PyeA/5RimEQ/ZF8hwCiHdQq+L9fN3VpG++lcLwZAEXji/gEmAVqoDXPtgA2gfLVwACgah520yhIOfgYzUlWtfxZ1cVPSds62AEHYIPw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=WzeuONoSBQVkfMYVqHFiOWzK8/y4jh1+ot/IDWAMvdU=;
 b=nUIH3MnNz/D8ak4izxi70EfPzr3tUNCRu0JGxypAZo2Juz6Xla4b+vb//gYYLehUuu0pdsGyIdYr2Dfaygf82JXUndOBa9dAZG696ojs2ytSb+zCOzuRQaXMl/s2/2MAZ3GievEG89FPA7s6geUDPcnsP5SQmMq+ggNZRzSW+4fpPInD9OrWXj9sTljwiv9qK5+FAd7iHIpv1KbJ3il2QoZmDrYAHnKQnTmHszDBAN7XYpW0oJ+fs4mEAdL4QIerlwJp8N9642sYZvefQCI9i2klVrbO13odOnuhSggx9gKuYgIOANUQviQGp3ml3U/EXw1tWi/g/GKnxxIWY0SbRg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=WzeuONoSBQVkfMYVqHFiOWzK8/y4jh1+ot/IDWAMvdU=;
 b=HliNjP42pghASFZmoEaIDdBjAZWhnYBgXhHoeizbXFw323vYFZNZ3iBfhTRO79RPOxIG2DsZC9mHp+XOugc07/Kr6gC4kCI0Y4u0CCyauvYe1TV7nWC8wCf8s06MEPrIJzkrt83BqIZN1WaSEzPsINaKO/h3rY6vbaXu5XTu2wI=
Received: from BLAPR03CA0090.namprd03.prod.outlook.com (2603:10b6:208:329::35)
 by SJ2PR12MB8159.namprd12.prod.outlook.com (2603:10b6:a03:4f9::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:17:16 +0000
Received: from BN3PEPF0000B078.namprd04.prod.outlook.com
 (2603:10b6:208:329:cafe::2b) by BLAPR03CA0090.outlook.office365.com
 (2603:10b6:208:329::35) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:15 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B078.mail.protection.outlook.com (10.167.243.123) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:15 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:14 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 01/15] cxl/aer/pci: Add CXL PCIe port error handler callbacks in AER service driver
Date: Tue, 8 Oct 2024 17:16:43 -0500
Message-ID: <20241008221657.1130181-2-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B078:EE_|SJ2PR12MB8159:EE_
X-MS-Office365-Filtering-Correlation-Id: dbbf03eb-a5d0-41d5-0394-08dce7e6f6fe
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|82310400026|1800799024|36860700013|7416014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?68BUTrfqrAkzFAo0Da87kN0FeUuI1sjuDq1G/qKHk/O+q//MFWxJ1ZQjpKvJ?=
 =?us-ascii?Q?TS9wzo/hvtaBZji1GaOBOnWY7iThQTSDYPiQ0O+yQAsaKBzc7qGXnXi0DCgj?=
 =?us-ascii?Q?oyXBNOyrT2/i+Ni4zG5pHrxUdhHRzU+YT3HALW648olO/YAIfUjw7OsbFGfQ?=
 =?us-ascii?Q?9TSfdBCKq8nqSXLvcyZ7iQiuuISVMCxCDzmKUH77dQeUjtvM661+GlJEXXQy?=
 =?us-ascii?Q?F5cCDw8czcNs9iF1wHBplb60iqq4kiCpaMiDV1Z0ck14RCC7Z4Y2JzfJqR8r?=
 =?us-ascii?Q?XWimlAZnGLPhVN7/o9SFMEHRLX5w7/1EH8Vuv+O3ai/71nm4XXjOhnY91yc3?=
 =?us-ascii?Q?ToRXAMz6qykHb17yJMq9GLFYkerwatMjEf/2b79Oog0Y3z4dtk1PytuSh6lu?=
 =?us-ascii?Q?KAQqU65zZVT6DGM66yJqt3OsRc71Jg2y5R1zoqwLaWl5yu+ugwsSmEdl3AN3?=
 =?us-ascii?Q?bV3KinTM7/2VdKb0sVsMTChTbCAoOgyt5v7fcPUZWprXCqQRfiX7iskX/HTZ?=
 =?us-ascii?Q?nfp9SFbiBBtionmHoIfJmgX2N/3bMjQ18MjRocY3cfsHORXZMyoFtqLTOQXz?=
 =?us-ascii?Q?oExbSaqk4bMngYYHyZpayFzxowjL6pBDYWuM0S1Y+NZ0hw5lO73Tpa1Q1/RV?=
 =?us-ascii?Q?7Plvyu+LK1Y+IbyubswlqSufAIUOinM1Ppj9C9zqBz1/JNsZ77a2YRqhayZN?=
 =?us-ascii?Q?TLl5Nwcd33L/yAjyL5sZRDTukYmmg/nxRI/MzM5fw9SJeU92DCYpM+byBkf2?=
 =?us-ascii?Q?qr6JtY+kR1Ll+Gr+/1Rju1FpbBAy0uC6IK8lc/ZTDPJwr6EXnuIEPMBU3PtL?=
 =?us-ascii?Q?/57CGaTg96IiuJ2H73NwdWcmbkJhUlJTjA3JfXUEJVrZOvv9eV1kcGraVKfq?=
 =?us-ascii?Q?Zek4FKe6Y+CnYfQS1Feah10WT+zKokI1XVvtFJrPFam/SXCYZRYjex5n8C23?=
 =?us-ascii?Q?Afpc5hbvD2pSLnODGLoNiiZogkaXz1VTwNAt+Pqk97GYhkCOgF/HorcYDnyA?=
 =?us-ascii?Q?jkc0kG2XfSW3RHZgJvyFlOOX8M6D/sW7aC9QvnYfxlOadN/V/bX/geINB1WA?=
 =?us-ascii?Q?BZO5V8psZPrNI4qy/QCgyn6Gm26r0+H0BkXSVo4JmVLhjQwBWmY8KnUzNHL8?=
 =?us-ascii?Q?8wWRHNwMxz2w8b+U7lFY7zBShIMjzs8/NV4qQlQXz7mmv0lnRwhxfdubWiCW?=
 =?us-ascii?Q?eKm59ccE/jWI4kruKjjiM8ZhrUk9P9v81lBSCKONSWXjX7verDB7oWvOkEQu?=
 =?us-ascii?Q?RYMKhzsnXpf46hXpEBsOQ8PUCXgNstOFUEvW8Lml1eUYR7pIM02IaBUu+GOo?=
 =?us-ascii?Q?A1O2grd+CUlyVmwSnGXWoT8L89UgSgt75yHCg5skIGp4Zzw+hZ18z4bxAQ1r?=
 =?us-ascii?Q?+JkgOzTRwJGMf+vgipnypjqQ6TJW?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(82310400026)(1800799024)(36860700013)(7416014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:15.1323
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: dbbf03eb-a5d0-41d5-0394-08dce7e6f6fe
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B078.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ2PR12MB8159
Status: RO
Content-Length: 3115
Lines: 94

CXL protocol errors are reported to the OS through PCIe correctable and
uncorrectable internal errors. However, since CXL PCIe port devices
are currently bound to the portdrv driver, there is no mechanism to
notify the CXL driver, which is necessary for proper logging and
handling.

To address this, introduce CXL PCIe port error callbacks along with
register/unregister and accessor functions. The callbacks will be
invoked by the AER driver in the case protocol errors are reported by
a CXL port device.

The AER driver callbacks will be used in future patches implementing
CXL PCIe port error handling.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 22 ++++++++++++++++++++++
 include/linux/aer.h    | 14 ++++++++++++++
 2 files changed, 36 insertions(+)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index 13b8586924ea..a9792b9576b4 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -50,6 +50,8 @@ struct aer_rpc {
 	DECLARE_KFIFO(aer_fifo, struct aer_err_source, AER_ERROR_SOURCES_MAX);
 };
 
+static struct cxl_port_err_hndlrs cxl_port_hndlrs;
+
 /* AER stats for the device */
 struct aer_stats {
 
@@ -1078,6 +1080,26 @@ static inline void cxl_rch_handle_error(struct pci_dev *dev,
 					struct aer_err_info *info) { }
 #endif
 
+void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs)
+{
+	cxl_port_hndlrs.error_detected = _cxl_port_hndlrs->error_detected;
+	cxl_port_hndlrs.cor_error_detected = _cxl_port_hndlrs->cor_error_detected;
+}
+EXPORT_SYMBOL_NS_GPL(register_cxl_port_hndlrs, CXL);
+
+void unregister_cxl_port_hndlrs(void)
+{
+	cxl_port_hndlrs.error_detected = NULL;
+	cxl_port_hndlrs.cor_error_detected = NULL;
+}
+EXPORT_SYMBOL_NS_GPL(unregister_cxl_port_hndlrs, CXL);
+
+struct cxl_port_err_hndlrs *find_cxl_port_hndlrs(void)
+{
+	return &cxl_port_hndlrs;
+}
+EXPORT_SYMBOL_NS_GPL(find_cxl_port_hndlrs, CXL);
+
 /**
  * pci_aer_handle_error - handle logging error into an event log
  * @dev: pointer to pci_dev data structure of error source device
diff --git a/include/linux/aer.h b/include/linux/aer.h
index 4b97f38f3fcf..67fd04c5ae2b 100644
--- a/include/linux/aer.h
+++ b/include/linux/aer.h
@@ -10,6 +10,7 @@
 
 #include <linux/errno.h>
 #include <linux/types.h>
+#include <linux/pci.h>
 
 #define AER_NONFATAL			0
 #define AER_FATAL			1
@@ -55,5 +56,18 @@ void pci_print_aer(struct pci_dev *dev, int aer_severity,
 int cper_severity_to_aer(int cper_severity);
 void aer_recover_queue(int domain, unsigned int bus, unsigned int devfn,
 		       int severity, struct aer_capability_regs *aer_regs);
+
+struct cxl_port_err_hndlrs {
+
+	/* CXL uncorrectable error detected on this device */
+	pci_ers_result_t (*error_detected)(struct pci_dev *dev,
+					   pci_channel_state_t error);
+
+	/* CXL corrected error detected on this device */
+	void (*cor_error_detected)(struct pci_dev *dev);
+};
+void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs);
+void unregister_cxl_port_hndlrs(void);
+struct cxl_port_err_hndlrs *find_cxl_port_hndlrs(void);
 #endif //_AER_H_
 
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2083.outbound.protection.outlook.com [40.107.223.83])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EE0B414A82;
	Tue,  8 Oct 2024 22:17:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.83
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425851; cv=fail; b=vB5F60b9Ev08qhhAXw6UXIwJIl65AblMsr9NXRochC2HRR9N+PwUaOmc8QgHsAcTIjoi/khR9j3ABYFIqjs6GgW52peyrK9R9RLuzHzpo/WjG0hrB5IGQwm1uAax+VEj6sxB6h+NpJzxpMJ4I/UYdg72ZFI8APBBCGk93m+6pXE=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425851; c=relaxed/simple;
	bh=SSMpZoRLutuTarErOJMvSEXKfHRL9sFXLu5OJJxOQjQ=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=f3FRF+RHirYKA2ALm9FqaPGPl+kNHD4VLedNXplMcFpmLD7vHrzZBmsL1cP+oW62/xtyyYySDEvYJ51zpW/ibuMvmt2ZjF8dTUQNVCTBwFhAIdefz5hW1a/H9XiBn9PZkQ+I4Q+d/Zzy7Ip6O4jxpB5bFgqIpF8WAeuMYG7UdbE=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=vi3K9S2S; arc=fail smtp.client-ip=40.107.223.83
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="vi3K9S2S"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=XqhX20KxOSHLWKbRRir+TCeLZkFtuZt+Vo2eqH+VIgLPiRbSSabRqp/05ar8tfumkh2jPZwudOTyCMJQ2gGdN7/8w4NHtdaHshYjtKdQ3V/9wxYXjgtV+F4swSvZSe+eYqAfzOG3lN+iFSOcEzjQp+F+i9TVmOPDYAildSi7bFeErl0Ghmra71i43E+tojZ5WAF/4AVeh8Rl7F7fFibDZZPfDhjtIEZdgKaBqIIlPXzF0cRtjEUxLCQkOLhZt9FkTa+GuQ0YY8PamII9pznUOK38dKNDEPxiiSPtcIYNTSSxOuo0efSA/QWyMYRMwnf1CwjYxVwRn5X2wy7AFx+zvA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=4sk7/Vpa10zq+0W20CuOYCvwvBeBBvNOMtj1SLJC5/I=;
 b=admtcMLbTIeSf+XIcg1mlBw7GjTkVxjwyArqoxWpoEriShMIKGmVQVDQHQSeqM5maRsVGhCusCpjHS21B3pV93h51m7IbyO2SpizxvEbiBI2ZngIsFI1ulEnk9FkBSKJliv4MmupX3Y51pMY0vwaxvKoBToyZORoYm0hyLkouL8311CYOlURH/8Ndbdu051x8gEwWVVpm0TBdmCpAcnoQjp2WbJPlpq1ulQ7rCqe/KzSihMNgvmbCAydLRb+an5O2yVnkcZd8tlNLQJ/YQNyFwXBw6PvwutHHRT9dyaLo6TFxWBUGPONJSj7xXaKxj5vw5q/LgHtrggrAnRY6VX4jw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=4sk7/Vpa10zq+0W20CuOYCvwvBeBBvNOMtj1SLJC5/I=;
 b=vi3K9S2Seh4PtyCXII7kgpPcTjDIVW3b0Ngn4RKoe3cB3tgAczQH1jHOvv+IRKwnoHWU0mww7510RqLU+hcL1+QDSSs5vBc73eq7qyO3iWnuV4aYnJ7fUcAeejcjzv3OHr8Cppm0UAyLK++AEH8dZWLi2O9vSWqFaHUrR6n0XA8=
Received: from BLAP220CA0027.NAMP220.PROD.OUTLOOK.COM (2603:10b6:208:32c::32)
 by SN7PR12MB8770.namprd12.prod.outlook.com (2603:10b6:806:34b::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:17:26 +0000
Received: from BN3PEPF0000B073.namprd04.prod.outlook.com
 (2603:10b6:208:32c:cafe::e9) by BLAP220CA0027.outlook.office365.com
 (2603:10b6:208:32c::32) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.17 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:26 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B073.mail.protection.outlook.com (10.167.243.118) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:26 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:25 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 02/15] cxl/aer/pci: Update is_internal_error() to be callable w/o CONFIG_PCIEAER_CXL
Date: Tue, 8 Oct 2024 17:16:44 -0500
Message-ID: <20241008221657.1130181-3-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B073:EE_|SN7PR12MB8770:EE_
X-MS-Office365-Filtering-Correlation-Id: bd1dc2c2-3d7c-435b-58b2-08dce7e6fd92
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|36860700013|7416014|376014|1800799024|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?eSmBi+i8hv2iDhumEYjMH88Gaui4STGoBBnBA0cHCQ89fIG3uRNxpxAyo8gB?=
 =?us-ascii?Q?z2LD15qP0X34uyAw3sxnO8EFeZnBI/ql70c7MXeMW35ri1yvH0u2dVNH9lAU?=
 =?us-ascii?Q?Fn+72r3TXwClWaB0Mtdy45f7QjYRTLLluNeJJmgp509VtVXpmwlJqapH+P54?=
 =?us-ascii?Q?PBe8btdsBaCVs3zuAjFYn9hOvuTdcOIVux5ahMqK50WTYm+MxQUEDUQrxUkC?=
 =?us-ascii?Q?UNKEjz5SzhsB83BA97pF8TALGtVRdvT6ovQZu099ZY6RR3XuXDF/nQ6vTDJZ?=
 =?us-ascii?Q?ZnCZwUvFtsmqpD1YPJyRdhIn7d1EArp8Rsyo0BedD/V80dcKLlMK/5d0JAnF?=
 =?us-ascii?Q?qZQidFrZp4lnJKpslbD09omKHITncvmocgQRY3l2ccCfobtMC5ND+NDcMcWz?=
 =?us-ascii?Q?2nLn5n4Vvkhamcb90Y9PzRu4P1UAm8pjI/lyfFIJ+O7dxNTTNwUq4L50cZEJ?=
 =?us-ascii?Q?+C2HYPmMVNwxI5aVTcfzl/AReyIymGKN8beGvQwDlBpcAN8TfRHPAnSxAbpU?=
 =?us-ascii?Q?8o2la3v4PhcbpqVaoW+0KSjWvI78J187SuAzpZCbVbjgHicd/RT6v0xy9vPq?=
 =?us-ascii?Q?lxhTBcDJl0I5XB18lsRpCIdG/fUhtBiS4KUV5pLwh5/F6JOR7Iryo3ogeZsR?=
 =?us-ascii?Q?e6xuHAUJokJO8n5Oa3Z4JrRZFnJ171+XFa295sARzgmnMGlvbKGt1D3PooMM?=
 =?us-ascii?Q?85QnzuvOYAsXq7OuNz5tb25mIgXIoCqu0RzYRwOC+80G90UMv6HmyFiy+R9M?=
 =?us-ascii?Q?i7ZI2Ortlk7aSOdtq856f9oVNZRZs0+eA8iv475uDSrnpljfyr5ImPlKzEGY?=
 =?us-ascii?Q?toEVWY4ubjdnURGzJK+gREbZc5i2cCMzG2Ow0U/siyYP5J2k42aKvg8dqMX0?=
 =?us-ascii?Q?2QjNdVtqYVDLRkKYcltuUfCUeS+OUlptHHmxoPJREbtpdQQdjgqr4io2APop?=
 =?us-ascii?Q?y+TscQlBPqYa9hj+hKMg5IV/RrdYDoGCn4roweB+ow98yYcl5JYoWV1giRhk?=
 =?us-ascii?Q?HRV6DgwG1fcTOaNFGbs2lmg0pSZU2JmgWFyvkqhAovYeg4YugKcIXzXZNdXC?=
 =?us-ascii?Q?sQqDzl7o103xkrDgMwNhJcU7HgRO7UtJ90AKTzSLW3RzghJZwLHUDQYIVACk?=
 =?us-ascii?Q?CroqNTnF8+ElU+bD8nieDE+pCBD/OjhqQHB6Non97FhAai4SKXlsjPx3uepl?=
 =?us-ascii?Q?RSorkmUM9iRTu8iESROqu0940Kmo3cZLNxTMQDwYWCicZoqFNiQHPTJrORGn?=
 =?us-ascii?Q?2WXs3rR231rtNtnVNrtU+H1yvy69Nd6GZYsZtAQj+T2HtyndBhOEpBHCYq4t?=
 =?us-ascii?Q?PTyE6B6Ih7MKFX1S0Y+QRldPcLyEYQw2KmiHAlG5UYkgzuWGYsyNRvyYbUDm?=
 =?us-ascii?Q?tg3Rg+CKHobJlB8y8a11UDGHvESq?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(36860700013)(7416014)(376014)(1800799024)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:26.1863
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: bd1dc2c2-3d7c-435b-58b2-08dce7e6fd92
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B073.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR12MB8770
Status: RO
Content-Length: 1692
Lines: 56

CXL port error handling will be updated in future and will use
logic to determine if an error requires CXL or PCIe processing.
Internal errors are one indicator to identify an error is a CXL
protocol error.

is_internal_error() is currently limited by CONFIG_PCIEAER_CXL
kernel config.

Update the is_internal_error() function's declaration such that it is
always available regardless if CONFIG_PCIEAER_CXL kernel config
is enabled or disabled.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 17 ++++++++---------
 1 file changed, 8 insertions(+), 9 deletions(-)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index a9792b9576b4..1e72829a249f 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -941,8 +941,15 @@ static bool find_source_device(struct pci_dev *parent,
 	return true;
 }
 
-#ifdef CONFIG_PCIEAER_CXL
+static bool is_internal_error(struct aer_err_info *info)
+{
+	if (info->severity == AER_CORRECTABLE)
+		return info->status & PCI_ERR_COR_INTERNAL;
 
+	return info->status & PCI_ERR_UNC_INTN;
+}
+
+#ifdef CONFIG_PCIEAER_CXL
 /**
  * pci_aer_unmask_internal_errors - unmask internal errors
  * @dev: pointer to the pcie_dev data structure
@@ -994,14 +1001,6 @@ static bool cxl_error_is_native(struct pci_dev *dev)
 	return (pcie_ports_native || host->native_aer);
 }
 
-static bool is_internal_error(struct aer_err_info *info)
-{
-	if (info->severity == AER_CORRECTABLE)
-		return info->status & PCI_ERR_COR_INTERNAL;
-
-	return info->status & PCI_ERR_UNC_INTN;
-}
-
 static int cxl_rch_handle_error_iter(struct pci_dev *dev, void *data)
 {
 	struct aer_err_info *info = (struct aer_err_info *)data;
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2061.outbound.protection.outlook.com [40.107.236.61])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 288E614A82;
	Tue,  8 Oct 2024 22:17:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.61
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425862; cv=fail; b=hT2AG6YkaMgbLHgiArSSalGkRYJjU6i5f0nkReNxPc63xL4psT7bmUWydlJNTnBSxIovz7PLEBVqiRwJ5YJfAtCHd66xDFU/ECOlbQCiVm0ZMvZIjcrEeFsunLTvkzmptRrz5xqBJgUOGKAvyksWlf4Ug/OWwnuV0tre8EKAHxc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425862; c=relaxed/simple;
	bh=Khez0xSxToTOHyrUaMypy7f4f6wN+rGwB6rWgLhZF6g=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=W4OCc1AbKgXsm0+IElkc85gYbmjKjkJpq4heInwhl3biu+Q5GtFD4k+W01t2byXCWbiZZnUrBge/yuPSD1ckxfWKnSf5Xvs6tB4Dwy+OXyo2gQDgtOx0xcZh1osVr0043cvNli9fo0xRZ4WdJz/dG1qGP+Ojysjd6Y1u6IoJmio=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=LQNYyFOt; arc=fail smtp.client-ip=40.107.236.61
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="LQNYyFOt"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=As5RFjVD5M++K1fPAtq2MVuqkkn+LbYLHsMg4j9yatopdXqp73gjzBqhpxxCQfghF7QihRlCZQxSBrFLpmaTMya0c3u0OB39R+x5fN4ZGshllXnKqeoM+KVhmOyiLOeirMGlzvmxiPHxgaEjh7n39o1fn3lnpfhovu97Lf6th6JJTZPqUTSCtQjV5YYth8Vm/bh+TdLqE+gyKulaRNX+NxQgD27M1hvhdcfSa7vX2Wjg5VVpCSdjYdmgYmRrg5hmuIxufKKWpDi92A9slFMVfsDx9EULavu5v4auEtdAGb52STOUUR3N1KZHKzmdMdqFq3YCUEc2ayrBtpCiFNQA/Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=oUox8n1qf0eOfn8XyU10gGsVoUogdkhUmvwdICPzxJ4=;
 b=bpkUWUYHEqIpY6Mg/xRSriPt+5CvY2iUzqH3tf0rhuu//WFRsZ2eSzrMWIvG9BeWSRo8+omIAl2MD6oCEZD2wukMAqQlz7o/PJtynkLIyWVKmNYZSgNnsmG5cd/Nvt80HzHLTIL/2cpOhiwSQtFbq/hmGH+fyQg3sQX1lP8xjwAgGGXo1UAh9XjPwTirhvSb8OaTlN0cS3Wa8QcVgVEVfM5DyIG9eXU/SYAzll5g8FMtdTx6gB51gBht5V3WgEl2F2J/tFvQfz1afIpzHRgcptSsiXMqrQrDqVpxzcPYpReT8bbEyIoViW3HpmGnRUnpXthP3CcGKD7d+rHteGTQNA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=oUox8n1qf0eOfn8XyU10gGsVoUogdkhUmvwdICPzxJ4=;
 b=LQNYyFOtFCk3uetBIu64p7vQFBsyj16mXJmwpqXIT1cONdKuZDOqDqe4GaAAw0Yn43BR2nm+FJbHiroye746JxPiVOeW12leYH1t4HoW0+xRwHnTymwLy1ldIS0QnDf3UqtIKix/AuVo3axSSykpuu/1jYzUj0O/T3T1FipTtDU=
Received: from BL1PR13CA0209.namprd13.prod.outlook.com (2603:10b6:208:2be::34)
 by DS0PR12MB7631.namprd12.prod.outlook.com (2603:10b6:8:11e::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.16; Tue, 8 Oct
 2024 22:17:37 +0000
Received: from BN3PEPF0000B072.namprd04.prod.outlook.com
 (2603:10b6:208:2be:cafe::79) by BL1PR13CA0209.outlook.office365.com
 (2603:10b6:208:2be::34) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.17 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:37 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B072.mail.protection.outlook.com (10.167.243.117) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:37 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:36 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 03/15] cxl/aer/pci: Refactor AER driver's existing interfaces to support CXL PCIe ports
Date: Tue, 8 Oct 2024 17:16:45 -0500
Message-ID: <20241008221657.1130181-4-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B072:EE_|DS0PR12MB7631:EE_
X-MS-Office365-Filtering-Correlation-Id: 4b04c59c-d6fa-4eb6-dab5-08dce7e7042d
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|82310400026|7416014|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?92+ywI60a9IBg63an+fu9jwmtD+AaXrnzl9YXN6B+Pd1u8Dz97wi1oBn3Bxr?=
 =?us-ascii?Q?mEWVK6oI9d6eJwefa9yBzqzVUCUoVskGmAWqZ1CbY4na2gux8B6faFZOWg51?=
 =?us-ascii?Q?q8r3qIa9lo+8HV3SzJly2dCXpkRvE++CSxoweg0cKpQ9TD6gwonHi7Z/kN8i?=
 =?us-ascii?Q?NnVHhq0wv3E6JcRe4jbYTTYDqsQ8E5ZGcPd8i5eti9uZGsprpJWyGPm3g2wh?=
 =?us-ascii?Q?LGzXpkD+ojjLuHjy/A+UbfgSDdCluRQilyjsFGE21bYnSa3PqOvq2KHq2gJy?=
 =?us-ascii?Q?SmyndaxH5L+v8P/tutBrjc8vzwJV7U1MJgIBbK9vKTlmbO+vRIuHSrZUFdEY?=
 =?us-ascii?Q?QNjhJqMT5ijue3LogpC2hBPJLyQ81CJ900JdY15eYJ0NV0trx2q28YfM9U14?=
 =?us-ascii?Q?3IZs3oLLqmvmKA4EZ1kvvfAgpBbNrXuy8E0wWlOkJgeiUherGvXuVGDgl7qf?=
 =?us-ascii?Q?82KA1LH2T61+u87E6GIQX2TRFAWRqpFFTz4AmrIC0WZpAfYNDVXQ8bp4QaKj?=
 =?us-ascii?Q?YtyXhdFi+ZGI/NpsDifD5BbGM8eKY6Uc+G88JNlssWYtLXvNBNjkkm2kd9KO?=
 =?us-ascii?Q?bv7kMyQdZGaRhZs79gcUDu5GNSuaN7qG2WzI+m7kQair4364x3nYFuYBJ6xz?=
 =?us-ascii?Q?CZ76juDsBCfEykBU3nAxredDratlTP+oV54r8Pvl6HXz3QoaKu+j6D5PNnKd?=
 =?us-ascii?Q?aCnvYxzHr46HO+K8IOUUniHcpXZH6yteVu7TA9B84Dedg1BNZqwe6bWzcSdi?=
 =?us-ascii?Q?pCE5DvppBe2/ALkr3ldpijNLdFephlNxy5je9Kn2xOxLMOHnck6MWGspkSvb?=
 =?us-ascii?Q?T4EvYOiI9akJlbVSQmbnL09ztq3s+OyVtUCqfuC2DXUVxFfXZy9z5Q6zrJeI?=
 =?us-ascii?Q?qxgZ3ZrsJatYlNdZtot2W6Gi2wugdZzkQvFJKWoaJ3kY4+9yZU36Pa6szaQp?=
 =?us-ascii?Q?TiQYQ6tf9ouhs2nSDG8b2XdTYYuzYwpDv7HZXbjhXHE78VYSCXNIju+HXLwp?=
 =?us-ascii?Q?8Qgolu+E8RvYob9O5gRozX1yHe6u5/SWK/rC6oW4s8gdiaREwBV32NgTpbr1?=
 =?us-ascii?Q?DR7jqgc7MKEixj7WVCXXtOVLm9QfTHs0VN85ROYXcv5k78u1MAEbWkKuKiR3?=
 =?us-ascii?Q?C0YDm4/s06XIYRL0OLQO4P+SDbZshQ3BESveWb29VHb/uvhz5TVAENyICT/Y?=
 =?us-ascii?Q?C0QZysZAszn+m6oZxzzqclfSYnMubY99KE+kObUb/z0EX+DozbheN36X+DGH?=
 =?us-ascii?Q?4IKt8CyhhBL9gNDMHClHi831KMARd3GGA12AIF6/gvtYpps44i4cSOGeRI2x?=
 =?us-ascii?Q?j7mbuyzVkqtCc9mnI0+vvMRXIx28o1pm6aNNpoihTVup0GJPgULRi/zWcJHF?=
 =?us-ascii?Q?IeE6//RyYB7eVOze/bUN5vWr1cLB?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(82310400026)(7416014)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:37.2562
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 4b04c59c-d6fa-4eb6-dab5-08dce7e7042d
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B072.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR12MB7631
Status: RO
Content-Length: 3128
Lines: 92

The AER service driver already includes support for CXL restricted host
(RCH) downstream port error handling. The current implementation is based
CXl1.1 using a root complex event collector.

Update the function interfaces and parameters where necessary to add
virtual hierarchy (VH) mode CXL PCIe port error handling alongside the RCH
handling. The CXL PCIe port error handling will be added in a future patch.

Limit changes to refactoring variable and function names. No
functional changes are added.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 28 ++++++++++++++--------------
 1 file changed, 14 insertions(+), 14 deletions(-)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index 1e72829a249f..dc8b17999001 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -1030,7 +1030,7 @@ static int cxl_rch_handle_error_iter(struct pci_dev *dev, void *data)
 	return 0;
 }
 
-static void cxl_rch_handle_error(struct pci_dev *dev, struct aer_err_info *info)
+static void cxl_handle_error(struct pci_dev *dev, struct aer_err_info *info)
 {
 	/*
 	 * Internal errors of an RCEC indicate an AER error in an
@@ -1053,30 +1053,30 @@ static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
 	return *handles_cxl;
 }
 
-static bool handles_cxl_errors(struct pci_dev *rcec)
+static bool handles_cxl_errors(struct pci_dev *dev)
 {
 	bool handles_cxl = false;
 
-	if (pci_pcie_type(rcec) == PCI_EXP_TYPE_RC_EC &&
-	    pcie_aer_is_native(rcec))
-		pcie_walk_rcec(rcec, handles_cxl_error_iter, &handles_cxl);
+	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC &&
+	    pcie_aer_is_native(dev))
+		pcie_walk_rcec(dev, handles_cxl_error_iter, &handles_cxl);
 
 	return handles_cxl;
 }
 
-static void cxl_rch_enable_rcec(struct pci_dev *rcec)
+static void cxl_enable_internal_errors(struct pci_dev *dev)
 {
-	if (!handles_cxl_errors(rcec))
+	if (!handles_cxl_errors(dev))
 		return;
 
-	pci_aer_unmask_internal_errors(rcec);
-	pci_info(rcec, "CXL: Internal errors unmasked");
+	pci_aer_unmask_internal_errors(dev);
+	pci_info(dev, "CXL: Internal errors unmasked");
 }
 
 #else
-static inline void cxl_rch_enable_rcec(struct pci_dev *dev) { }
-static inline void cxl_rch_handle_error(struct pci_dev *dev,
-					struct aer_err_info *info) { }
+static inline void cxl_enable_internal_errors(struct pci_dev *dev) { }
+static inline void cxl_handle_error(struct pci_dev *dev,
+				    struct aer_err_info *info) { }
 #endif
 
 void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs)
@@ -1134,7 +1134,7 @@ static void pci_aer_handle_error(struct pci_dev *dev, struct aer_err_info *info)
 
 static void handle_error_source(struct pci_dev *dev, struct aer_err_info *info)
 {
-	cxl_rch_handle_error(dev, info);
+	cxl_handle_error(dev, info);
 	pci_aer_handle_error(dev, info);
 	pci_dev_put(dev);
 }
@@ -1512,7 +1512,7 @@ static int aer_probe(struct pcie_device *dev)
 		return status;
 	}
 
-	cxl_rch_enable_rcec(port);
+	cxl_enable_internal_errors(port);
 	aer_enable_rootport(rpc);
 	pci_info(port, "enabled with IRQ %d\n", dev->irq);
 	return 0;
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2088.outbound.protection.outlook.com [40.107.243.88])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 549FA14A82;
	Tue,  8 Oct 2024 22:17:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.88
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425874; cv=fail; b=Qa5ZwTL3TDQby7tnyTi5Civ/ImzCISDLVir7LLsoXgUV/yLorTBARYfgvaHUabKyXWM5ljPlOkW/dwyIxCjKJPaLF0v3xBjlukcPt+qanW/woAqIK6maEJ2J2lovSxIcAkyrNjlQ1ogGSYKyQWOhz29Df53dhtkcJlruzzD7E0E=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425874; c=relaxed/simple;
	bh=QbiLpf1nxlmgh3430zRD8OWfiRaabwpPK/jw9ikl7y4=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=FE31vkiM+wAnaomry6N5yysHqLwLd7P3abmu0GwVyDP0wEUQo9OlNSX6Z+Snpr5XrpWQhPL0I0UbLusnCtmK0eAzjU6ymklcWJlV1x2u+CikmfEXcut36IH/a4oWhYFJIxAZKE78YAaeBc0aI+HvVumFoCLPm72qxRYGGeVtDVk=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=qe/rSks0; arc=fail smtp.client-ip=40.107.243.88
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="qe/rSks0"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=hDuacETvcGN2s2MxQDKMz0wjdmJ6oNrvvJOjStuhqgtGhu7mcNwcLD/2kVoUasYXXJ/Hl6v5LrCckSm1DanvlPQUOAcbUFlKlE+N876eTkIaSJCqRpPuR7g34/sawmFoB/Hlqsxigmme4cCCkPW0iQL2JjvIsG6aYYw7OGY1y1RhBT5JdC/+VWIjs+SwebM3WVG+WVRkMu2CHH6kPoDVtzkCy3ZmRjHzhP6VyLON4KL4WYrY9Bk7tsbMggH8VYYB8DCegpXzBW1UupU2C4zEznsRgLkHk4+ZoWJwHQ4UnuZDBrZ5u42ZKdWRdbThys7u9Askc8V8QX2K+XpH0fBnxQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=U4NymEgzEbnfYrhvaxAPu5Q4T9jwhLX9jJl+5ih2zss=;
 b=QIjGN/C4YACZb/DD7bg7VjWUO6Je04rb7BCSbK+wRUEwWKtloq4vwWE1PZ7K0iT3eFoSgEdl2wk72XU4RL9qu6NH/szSDw03PHOuIfWLs7HT74+xn9iGd3+PBAXjsRmNJHCTtl8PuieJWjm2wtuSP0tMGG2t2G1C6484SVBNb5ZRcy50TP0sEkTtqvX51YqUH7YWBT3HbEu48mSP1s769T+SXfi9HDBXwsRdYjfCyv8yJpELMtnB4GR4+MgsuMzl/Ef2C8f1rSPejlwjCAhwG64H47BgO/9babHtX+f+L/W9UgvALcmtayq5brO9MvhfMhTzjBHQFBoaYjSYwJ8QMg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=U4NymEgzEbnfYrhvaxAPu5Q4T9jwhLX9jJl+5ih2zss=;
 b=qe/rSks07o4ZF0hYFVyWrdcFWsIzUuLBaNOOD8zWu/GVbBwMLaYR6qbiEHR3VBqwA2IE6gsCJnUQuy4R+zIlX/A8n4cFcERLrUnkwFazx7WVnXzbgJxlEtPMCcy3bt35CKC9iAz5YgO+qRR0G7x6g5nmDkQL3JavZUNrzS+EPts=
Received: from BN8PR04CA0040.namprd04.prod.outlook.com (2603:10b6:408:d4::14)
 by IA0PR12MB7577.namprd12.prod.outlook.com (2603:10b6:208:43e::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.22; Tue, 8 Oct
 2024 22:17:49 +0000
Received: from BN3PEPF0000B074.namprd04.prod.outlook.com
 (2603:10b6:408:d4:cafe::44) by BN8PR04CA0040.outlook.office365.com
 (2603:10b6:408:d4::14) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.17 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:48 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B074.mail.protection.outlook.com (10.167.243.119) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:48 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:47 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 04/15] cxl/aer/pci: Add CXL PCIe port correctable error support in AER service driver
Date: Tue, 8 Oct 2024 17:16:46 -0500
Message-ID: <20241008221657.1130181-5-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B074:EE_|IA0PR12MB7577:EE_
X-MS-Office365-Filtering-Correlation-Id: 9cc0c316-2105-4fe0-9291-08dce7e70ace
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|36860700013|82310400026|1800799024|7416014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?ptiPZ+PGN7KbxApiYVHw6Zy26jB34QOIO6ZO/v13fZdN6ZUz2U0xiv49JO7y?=
 =?us-ascii?Q?06KNqWrr5osipkeujnG8sONl+gZqs/EdMtDv4vTz0R6dPZpR38ikJTElWZPq?=
 =?us-ascii?Q?qxE8Tknik8+/MdNocr45dYGg9dLJFT0PmkEL6S8Wym+yNm7vwpTZ4QSj5c4r?=
 =?us-ascii?Q?pSMy0sdFkNeo7EtNFoE2xNgwbJRwEg+2N32WEe8C06zVC9euHhsP0Y3TzxHW?=
 =?us-ascii?Q?qidjwRFuUomBUK/2bcV/9nOKmJoo2ACEXDmnlbrJWup5RMHf5rj+RvwkJ6SV?=
 =?us-ascii?Q?bfNrjMc+EXUJIr08e5O91gNT2FEUkqHCbFd673cZLVQ7f5En+utnEPcwEB33?=
 =?us-ascii?Q?/X/zLhDqiK+7y3g7No49oZxNnztXazW6iFM4zY7BOl6q+rrqW48gMpryWd+m?=
 =?us-ascii?Q?zpCJFTno9I+Z0dnVd2p0V+awrdPA/D2DnitEjZgvdxhYog6+jPrOc4X9kRdh?=
 =?us-ascii?Q?+3UunEyQSfhM1+m/1eii4hiGaS8Ey/toMiOPAe0g84TPbJiWI7/D89OIUgTn?=
 =?us-ascii?Q?FrMPhRtT153zFe2zQakS/g1Cr3uV5bo+XBMTo5/i3v1WiSE0maxBdHQP2zUO?=
 =?us-ascii?Q?KP2cDqIarenoehXo/m/0aBQHRe9NdnQ30JUilCtUB2sSjDqyvCNssmw9kJss?=
 =?us-ascii?Q?NRQhwAz5RLuUnGQXbOp0A9JQOjcV8b4+PWQQZk0pitpsQ1mro5/It0NZmQg3?=
 =?us-ascii?Q?l4GIAN5V1VRU/jpJCirERFC+shvJRm10PQ532deXmF7JqKYOtOeSlXEwHGrr?=
 =?us-ascii?Q?uZ05KdRfIlhzts3RYCWM+yeFHowhn0YEttUlJk0q7fV5ipW3BHxZpO81X2LU?=
 =?us-ascii?Q?dw1dbZAD9f1YYJTx9hEJshjsTWHkktXqW1br3n97Rwne0zK54L0Z4UOo+MM1?=
 =?us-ascii?Q?1xIfOtDuYSCNoCmOMXRV/KAuJEoJrOgnsf9FT5aA8Z3TurWMqstYK4+7SmCA?=
 =?us-ascii?Q?4vEw0kotHPLRjZhPY9AZ4qYZKV6swD8BNKnqpxE//2VspTCaLg+C3eRnfZTm?=
 =?us-ascii?Q?gL7YoNAPOfLsWun/NY6BjCkP/BaMH67aUuj9YhZ14fO/bYQdaXHPS79OAfol?=
 =?us-ascii?Q?Sh5KRByPi5cL7pPkBep2splmPPH71TY692z4UkD+Je8ZTw44Qj1x1fGuhoJw?=
 =?us-ascii?Q?7sKNQRt4eSqPfNwxF9qhxB17HSowOazRtAYlg2ooqXXNy8jRZIvMdAGbYpKO?=
 =?us-ascii?Q?grEbwbXdBOiA65ORXzcCz97c/viC5vZpBM5CmqPaZZ77PrttGzoc0HkaQvty?=
 =?us-ascii?Q?B2Y/S0S5PrRIvUNbVNGJFVzc6GDHqeTl9KO+YPRlAeZorBxiWeL3CJyeC+eg?=
 =?us-ascii?Q?d4KIovOqTOIdlBTFlkH+ZLNPbYl0BuLtsU5Z2qmHPxr+RJXo7SVTzSNj78U8?=
 =?us-ascii?Q?tAzIS6Hnb0uSasv/UY+AE9NboC0D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(36860700013)(82310400026)(1800799024)(7416014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:48.3758
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9cc0c316-2105-4fe0-9291-08dce7e70ace
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B074.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB7577
Status: RO
Content-Length: 4373
Lines: 131

The AER service driver currently does not manage CXL PCIe port
protocol errors reported by CXL root ports, CXL upstream switch ports,
and CXL downstream switch ports. Consequently, RAS protocol errors
from CXL PCIe port devices are not properly logged or handled.

These errors are reported to the OS via the root port's AER correctable
and uncorrectable internal error fields. While the AER driver supports
handling downstream port protocol errors in restricted CXL host (RCH)
mode also known as CXL1.1, it lacks the same functionality for CXL
PCIe ports operating in virtual hierarchy (VH) mode, introduced in
CXL2.0.

To address this gap, update the AER driver to handle CXL PCIe port
device protocol correctable errors (CE).

The uncorrectable error handling (UCE) will be added in a future
patch.

Make this update alongside the existing downstream port RCH error
handling logic, extending support to CXL PCIe ports in VH.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 54 +++++++++++++++++++++++++++++++++---------
 1 file changed, 43 insertions(+), 11 deletions(-)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index dc8b17999001..1c996287d4ce 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -40,6 +40,8 @@
 #define AER_MAX_TYPEOF_COR_ERRS		16	/* as per PCI_ERR_COR_STATUS */
 #define AER_MAX_TYPEOF_UNCOR_ERRS	27	/* as per PCI_ERR_UNCOR_STATUS*/
 
+#define CXL_DVSEC_PORT_EXTENSIONS	3
+
 struct aer_err_source {
 	u32 status;			/* PCI_ERR_ROOT_STATUS */
 	u32 id;				/* PCI_ERR_ROOT_ERR_SRC */
@@ -941,6 +943,17 @@ static bool find_source_device(struct pci_dev *parent,
 	return true;
 }
 
+static bool is_pcie_cxl_port(struct pci_dev *dev)
+{
+	if ((pci_pcie_type(dev) != PCI_EXP_TYPE_ROOT_PORT) &&
+	    (pci_pcie_type(dev) != PCI_EXP_TYPE_UPSTREAM) &&
+	    (pci_pcie_type(dev) != PCI_EXP_TYPE_DOWNSTREAM))
+		return false;
+
+	return (!!pci_find_dvsec_capability(dev, PCI_VENDOR_ID_CXL,
+					    CXL_DVSEC_PORT_EXTENSIONS));
+}
+
 static bool is_internal_error(struct aer_err_info *info)
 {
 	if (info->severity == AER_CORRECTABLE)
@@ -1032,14 +1045,22 @@ static int cxl_rch_handle_error_iter(struct pci_dev *dev, void *data)
 
 static void cxl_handle_error(struct pci_dev *dev, struct aer_err_info *info)
 {
-	/*
-	 * Internal errors of an RCEC indicate an AER error in an
-	 * RCH's downstream port. Check and handle them in the CXL.mem
-	 * device driver.
-	 */
-	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC &&
-	    is_internal_error(info))
+	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC)
 		pcie_walk_rcec(dev, cxl_rch_handle_error_iter, info);
+
+	if (info->severity == AER_CORRECTABLE) {
+		struct cxl_port_err_hndlrs *cxl_port_hndlrs =
+			find_cxl_port_hndlrs();
+		int aer = dev->aer_cap;
+
+		if (aer)
+			pci_write_config_dword(dev, aer + PCI_ERR_COR_STATUS,
+					       info->status);
+
+		if (cxl_port_hndlrs && cxl_port_hndlrs->cor_error_detected)
+			cxl_port_hndlrs->cor_error_detected(dev);
+		pcie_clear_device_status(dev);
+	}
 }
 
 static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
@@ -1057,9 +1078,13 @@ static bool handles_cxl_errors(struct pci_dev *dev)
 {
 	bool handles_cxl = false;
 
-	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC &&
-	    pcie_aer_is_native(dev))
+	if (!pcie_aer_is_native(dev))
+		return false;
+
+	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC)
 		pcie_walk_rcec(dev, handles_cxl_error_iter, &handles_cxl);
+	else
+		handles_cxl = is_pcie_cxl_port(dev);
 
 	return handles_cxl;
 }
@@ -1077,6 +1102,10 @@ static void cxl_enable_internal_errors(struct pci_dev *dev)
 static inline void cxl_enable_internal_errors(struct pci_dev *dev) { }
 static inline void cxl_handle_error(struct pci_dev *dev,
 				    struct aer_err_info *info) { }
+static bool handles_cxl_errors(struct pci_dev *dev)
+{
+	return false;
+}
 #endif
 
 void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs)
@@ -1134,8 +1163,11 @@ static void pci_aer_handle_error(struct pci_dev *dev, struct aer_err_info *info)
 
 static void handle_error_source(struct pci_dev *dev, struct aer_err_info *info)
 {
-	cxl_handle_error(dev, info);
-	pci_aer_handle_error(dev, info);
+	if (is_internal_error(info) && handles_cxl_errors(dev))
+		cxl_handle_error(dev, info);
+	else
+		pci_aer_handle_error(dev, info);
+
 	pci_dev_put(dev);
 }
 
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2082.outbound.protection.outlook.com [40.107.243.82])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0AD4221503B;
	Tue,  8 Oct 2024 22:18:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.82
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425884; cv=fail; b=ZOpgxBufhq8Ky/Ina/CaXC1XY2Pqa8VUXk/S5EBs5nTahu1sPVJdnsIw+JDl1pDDfmYrd3to8RMRzYdTKRNvvg0qv2+ZZ5mzro6I7wiapOofTrDCzDw11xUDP6I5V+FUa8M5h+bICmKXM7jbykDswVdSvB0RYXzfNLpQemKvKkc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425884; c=relaxed/simple;
	bh=OJYtZWQw6f669aGAjML3ycJHL7HsB6Al3dA3n8GFPFA=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=HBLiVzm6kjikWcGIrgUpO8oI6cjutuBc0d8fmn0fiwgKpo8Wdian+Fwk+pU2teiIXT808aCZ2wQuW6RpgnoTAeIfRbVRRhs7cBYQE4GgkUZe+XMFsjxS2GNBPN1vuIvr7UxncBFCPbt6LqweiNePUouW6E9i+WEBb8udG7dAa/o=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=XXtZrCRV; arc=fail smtp.client-ip=40.107.243.82
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="XXtZrCRV"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=SqRftEEs0ls9d4I0lwfAiBFesQ9KgV8tJd1WENIN48pEsIkRbZ4WQ8sJ+E2ROxTZ3gRByMoSBPrNMBFjTXQKX1TdUD8o8x8Ffoix2pgYM/AOnEa95cudz+VjKXf7XsErDZ4vG4QujYZmW+uKTbNNbZn8/jEcN13F078JxgNRWKg3uWxX70p5uoCPb24r8PHHpxmi1Ok0LBVh9vcQNFapyg+jb2CFpkudzQ4ggQg7E893IVHJvj3Aa33XYQKEED06rsH+XIx1oLqu16M9Kb+PXx6A59RtthxFEXd9hFBiG/R9CZbXmh/QRMRp5vEFSLbTLbYfAUT0hHM15BfuKZ759w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=wCdctbVVHEMmR1KiD1vViPKiykyG3dlIPIy2SfUwEEc=;
 b=fDgBwRUl0hxpy0kNT5HmJJsdjHF6bhRZmQtO9J1QLDrg4uw9i+6IFZBDNQOwPhGwiztDwBRiNu+AofbGMATSCCeAjywaA7kDAnY2rIHpM+gS0AJXwQCcHchlk0imeP39Cw0+RSCuIxnpDxBB4C8DWNdXzU2S7gdqk2QMey8MGbSPfIRDMONd7kCi6OZfMuVu3wAZ6KZz4rPEA6kii/Qsg5GU9JzcRB8mZl16ITV91H6i929WwYO/zSCyLWsuJ/HWAxrqgc5MgOv0HKuFsVHTBFaWiS9EMuGA0pfzmquIsFLtyxrjgXiLPjwMExUa80kxcAmbIDWl8gLlLzh8KY8qEA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=wCdctbVVHEMmR1KiD1vViPKiykyG3dlIPIy2SfUwEEc=;
 b=XXtZrCRVrIjvuxQnc4nXUQWAye+cWbwpWEkpR8sBlwDeBvcSTWbW/607XhuwSHcWpBmhzswpUODoj8O6glEYBWfk1TKoTd3RF0PYdEBND66YKT55pFwgQE0TmV1aUDalL3V0f4cLafa49V0BwljTc7CwmOr2kAxf3W/KTHVFn2g=
Received: from MN2PR15CA0051.namprd15.prod.outlook.com (2603:10b6:208:237::20)
 by SA1PR12MB8844.namprd12.prod.outlook.com (2603:10b6:806:378::6) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:17:59 +0000
Received: from BN3PEPF0000B075.namprd04.prod.outlook.com
 (2603:10b6:208:237:cafe::b1) by MN2PR15CA0051.outlook.office365.com
 (2603:10b6:208:237::20) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:59 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B075.mail.protection.outlook.com (10.167.243.120) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:59 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:58 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 05/15] cxl/aer/pci: Update AER driver to read UCE fatal status for all CXL PCIe port devices
Date: Tue, 8 Oct 2024 17:16:47 -0500
Message-ID: <20241008221657.1130181-6-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B075:EE_|SA1PR12MB8844:EE_
X-MS-Office365-Filtering-Correlation-Id: de3be1b9-fcf7-41bf-2728-08dce7e7115f
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|1800799024|376014|7416014|36860700013|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?WTiO3jqrs4ZounpFYTxDDgg3VyPdDme86DBPliozFj2CUuMeVcuU89QLvRJ/?=
 =?us-ascii?Q?NL/mKocD012Xeoy/y8x/4MUjjZ7ewLsVuAlm1s3bfxu7pP/qqnIxf2hruENQ?=
 =?us-ascii?Q?KZm3qRt6e9RTuw2mm8qpPKDnyLt64SII0s+cAA4r1IKIfzHZ84n0WfbHn21T?=
 =?us-ascii?Q?1RPqwQop2GFTpsOKyaXe3oWmjEIx/RzQFRMyq3w8XWzgD7NX41sIci+AXxm0?=
 =?us-ascii?Q?0ij+xGWK3SlG23HH8u7HZdDzpZo1BIItzf5IGt+i4yRcsJujhUDa4LrEESsb?=
 =?us-ascii?Q?3lPFgmIJDdWgxYljvKprST2UK/MKoxB+jTRdV2zgtCyDDMrboOuyiGPhs1QT?=
 =?us-ascii?Q?tdKwAiyZOHYGECd0lifBVf8KppJR8TuPZDiFVeGtKQ75OqihncRZausff5uL?=
 =?us-ascii?Q?CCYaqw7sxVVgvGFPUgWDgjYjw9v/9gXNjjvYwEbhQzXtbCrp+C6er+POfWpe?=
 =?us-ascii?Q?22S+Shp0bxew7ik83xScGltHY1LYApCENWFUkEXiASG87bBWN20x5LXVCb7/?=
 =?us-ascii?Q?Ru07Sndqcgh62nIFNJulBOlMOKFu1KAe4Yj0btvyF+Sqgy/tnV/GbI4zB0kC?=
 =?us-ascii?Q?kZHlu38J0Y3FchGajD2GmcN3l/Zw/9ORq/TJcgX2nZ4nmbre9ncnEnYGdpat?=
 =?us-ascii?Q?wkmIFFRBXJ3u05FSCBj2fvRh5jt//S0p96kAyc9UJipKBgpdVSGNZDQFftVr?=
 =?us-ascii?Q?9hLGIo4KbIaBKELmaMfy2QNLGE0fP8305eyhFesecR/bQOEYhB0XeW6k5Gkl?=
 =?us-ascii?Q?o94E2a+nA1/cUCs/uJ3f5GIiwaeleXM304WC9ztB74gTgwVnDp9GFGdMTJGD?=
 =?us-ascii?Q?Q62TldvmrqlgWNlyMMIBiMdCYT22BuqijjY5h0naFpjTCXN8SeSDexbpMBVf?=
 =?us-ascii?Q?t5AYjuOrsgiJJLDN0GkbBictXlZignpR8h+54J0yTKFJJnUxNlX2GS8UWThA?=
 =?us-ascii?Q?VQS33vu7I4SW8HXogjSbP5bgoq7aIMMkLXXiM48BygwgoU4QVAttgfPgjwI/?=
 =?us-ascii?Q?ZzGg6BM4wuq3eGdL7EIbH5KZfMlBQ5tXhoCpFR5RVucIr0Yb97PSxH/HoXmK?=
 =?us-ascii?Q?pFp/xd//kBOiEF2nABGCaL5UE9HZb5loUryUh25FYXnkwH2lFYD30nEVJTEJ?=
 =?us-ascii?Q?ZF5KRQsU/G82rw26AecA7E1eRg4BzaIb5Aay6YT8nGIikSEqoD3FBFjvWqnW?=
 =?us-ascii?Q?lDEoVekc3hmRLfWDadXEouN/+dfX9RdPDED4PXRLIaQLPntX/Q346K6Otums?=
 =?us-ascii?Q?ram13SF+IbE2BwG6V37LTxIdc/Y0VE2vNRPHr4FwIW5j+Zq2+tZqiAETrlnW?=
 =?us-ascii?Q?MJXLQwgWGHfzY7sbAL4vHxAGVy6yroJu+MmkNBvCmZuzNxXK2GZhHM3NymOh?=
 =?us-ascii?Q?yfWbi8MwJhtyz28QuLh44752l9TL?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(1800799024)(376014)(7416014)(36860700013)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:59.3896
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: de3be1b9-fcf7-41bf-2728-08dce7e7115f
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B075.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB8844
Status: RO
Content-Length: 1107
Lines: 31

The AER service driver's aer_get_device_err_info() function does not
read uncorrectable (UCE) fatal error status from PCIe upstream port
devices. As a result, fatal errors are not logged or handled as needed
for CXL PCIe upstream switch port devices.

Update the aer_get_device_err_info() function to read the UCE fatal
status for all CXL PCIe port devices.

The fatal error status will be used in future patches implementing
CXL PCIe port error handling and logging.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index 1c996287d4ce..9b2872c8e20d 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -1282,6 +1282,7 @@ int aer_get_device_error_info(struct pci_dev *dev, struct aer_err_info *info)
 	} else if (type == PCI_EXP_TYPE_ROOT_PORT ||
 		   type == PCI_EXP_TYPE_RC_EC ||
 		   type == PCI_EXP_TYPE_DOWNSTREAM ||
+		   type == PCI_EXP_TYPE_UPSTREAM ||
 		   info->severity == AER_NONFATAL) {
 
 		/* Link is still healthy for IO reads */
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2084.outbound.protection.outlook.com [40.107.92.84])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id D97A22C859;
	Tue,  8 Oct 2024 22:18:14 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.84
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425896; cv=fail; b=e2em9O/gtMA29ao90h5LGnF6W0rdkmvyfwCnej0Q2G2SqnN4DH7ABdzlmaqwes8oL1PiY6Pm+JfnZgyh4JLEw9LRLVoBTgsijZn21vMs5xTN5nyPVhclBJLNphpRXsH3rvTWITUu1QWMfp8xq22T5oPYdTD56B1pM2HIoWJJ+KA=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425896; c=relaxed/simple;
	bh=oSF/mO9ozQg+8p1WxFakCsc6TjWo/KZyLNz/4smXDDk=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=ViLl4gO+m+MI2oL28gGqfgduFfZp8JgKPAfkf6at6e1xJuQi0kBQp/W7UaRK5V1NKG3c1BGSHHeaxRl95ajgGCpN1pH+TzUFu+HpPQ+jx3DHTpAv+JfeHDuNIjQin5oIXiauxSMhXeJJ7HYieGOtJc/728KAHIKGPheWNNSKxSQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=3iHEssXJ; arc=fail smtp.client-ip=40.107.92.84
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="3iHEssXJ"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=pkfBy+E2wAav+3jK52t5EJw1EGrPoyy57TALPyvLnGJmmgaZu0wqkirh5StSdDIxUAVfs3gUA4xXP/aYseERkGlToyZOntV3TBA287L3oDDD9eXazekXDx/I2l/BmH41RB5zt5Q1re/yG16eoqFebhPprAWidpcllejimqsj6G6kMUb9/yHmIPrVIC2GMRkTw6kiFPnmh3UzWKj0eAmJ5rUGOZJRdmZufTYaNhtAZQvQbM0L1ljoWcXPhxBK2C026txpxQzpYDSiImSITritCuG3J8ZjzAtIwdHhE1RJ5h43Drbti0V/KIEXwwuJu6Z1Boild64KiSeLTNu+UJCfxA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Fh3w6rWrpDOlzXz+HhUx6VpM4tEKXEvGv4KWMNEaqQA=;
 b=HYOix/uMT5sKIyBdZiKRifN+jHtQrMyNKQAG5uFo8GoDGj7T8KCXwWgpe4NuJQJ23ONcftpyS3K3jTKVpKYKnxikq9MMDfl6/MnfpGzE4mlEJLnpcJ3v21Ea6Msuo4YKbwB8HXMevCay8IlhHbeDYP8fwzGR3zd6rxQsJYX/M4XBJrpfPnPWY97aIqvthyD5lncwtxvUdUyPJc+HEN1p7t9nH51j0Gdr10M4Bcnq1XkUE37OL5JZuFSqoF1JHf9NdOYshxbAqapS7Xr/SxcizdEG6cBj9A/WO+9XPjYJwNdWfqvAmy84O6tHwPhZbSor46k2IuwAVHoQXsZsioSFXQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Fh3w6rWrpDOlzXz+HhUx6VpM4tEKXEvGv4KWMNEaqQA=;
 b=3iHEssXJwwgYEW338qx4GNlk9v7TkTwwJRuYE1A3UxPeP5TqyXsQIFXx1fdqCUbJ0iyCDF67wXgcKNsL20S6wjR0x/RGxYORiaN5lE64iwDacG98sbYSTMe2+CGokOqbgaZUlNiUbpAkR6bIvPJx1pR4fCXZrKdcXZHybljY6cI=
Received: from BN9PR03CA0604.namprd03.prod.outlook.com (2603:10b6:408:106::9)
 by DM4PR12MB5986.namprd12.prod.outlook.com (2603:10b6:8:69::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:18:11 +0000
Received: from BN3PEPF0000B076.namprd04.prod.outlook.com
 (2603:10b6:408:106:cafe::9f) by BN9PR03CA0604.outlook.office365.com
 (2603:10b6:408:106::9) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:18:10 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B076.mail.protection.outlook.com (10.167.243.121) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:18:10 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:18:09 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 06/15] cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to pci_ers_result type
Date: Tue, 8 Oct 2024 17:16:48 -0500
Message-ID: <20241008221657.1130181-7-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B076:EE_|DM4PR12MB5986:EE_
X-MS-Office365-Filtering-Correlation-Id: 2e317adf-bcf2-40e7-be25-08dce7e717e8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|36860700013|1800799024|376014|7416014|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?yim4jDO0NDqNypTDyB4mW4ZJa+6icWidsJd3+Lw2eDO4szcqSsmOvEqWKfOf?=
 =?us-ascii?Q?A+sEi+MSGjkGGe3fHu0gweca10qmAShDUBulBq1tP0kT5aPXSCKTB7EKS2KV?=
 =?us-ascii?Q?eDyAMFsFZBbxFVWB3dEjGLoJbcujTvo87mrkstN6PUKmVNWdLHBxEObFUvMe?=
 =?us-ascii?Q?hlZInOLMCYXOcR4CMrZd5jaPsrkkcYiVJfoReWAl02hnLpwlxRdXrrsXFnEO?=
 =?us-ascii?Q?Q+283+cbF1FQcHw3o5xsLQDNpunhWiwMyM37YJU2uh0RATn7MBV+UXbhfvsf?=
 =?us-ascii?Q?bqjOuXd0N7xdvN24+o0Do3YQcBXJRE1EDH90qhflO1l5Pu8kmFvzvM7F1ufP?=
 =?us-ascii?Q?9xIqhNX1wq9N0dsxiIJUXqOTljg8g7q14mrKHoYxNWifSu3lXstbgIjgnDJo?=
 =?us-ascii?Q?HUOeHVUnFiSJ2kWrhuAP8kjvHZxTfuYveHqLN48ac2wFyaynYHv34Qu7L2Q6?=
 =?us-ascii?Q?iAqB9M3k1AhS1TT0Vx0VaG8+DUbK9u8l/SZzYFY+Owh0RATSQBPcRPd/WJwV?=
 =?us-ascii?Q?bdd5UdACANJDax8xpSCP3T9uYAaM9b1SmkRvCklNsbHMxkS5ZRqQWWmqfLKE?=
 =?us-ascii?Q?aX46lw0iM269jbtz3ptrMOlXHfwPZDLeVcrj+KrvNDGf61yonGnC2Avcao06?=
 =?us-ascii?Q?qvlxG921l4yUAAqR4h2EOo8hw0nOns1QoWx9QesbtyzjQBNKDoaJp9o0TTjS?=
 =?us-ascii?Q?PsJBAfhGR7+E4VhA9kn9pM27eZa1AQW+LupBS5Tjt1YdrpR6dymNM+obiBzY?=
 =?us-ascii?Q?HJvB0B1n2kxqCEFM0g0msR9bnGeg+Pv+rOZeokXS2U9ZEJDA9VjJNOBxjVRH?=
 =?us-ascii?Q?OynYLYmxMF4N4fzuSq61lLsSQGoFcPEBlt66D1c6RKX+06NPX9vK86pSb/5x?=
 =?us-ascii?Q?nlWkPo4Es7KVThDpZ3w1I7dr8eiy1cqyv/GbkxitDYycRfboM/n2dx8IonjW?=
 =?us-ascii?Q?SMXZPjRvnNsYs+z+bKQVVA41OJi+Z4gydfLH7RM3AI53DUdqkWLESTbB4qcZ?=
 =?us-ascii?Q?Ds9a0jYvf3v+E7q1avM9nsdfBbdeAR5M9wEHbks+C2VdqJh8YR+++pYCMRSc?=
 =?us-ascii?Q?1/FiJfXxdeL7vRzbp8FP+EwbW8u79+NtX5quHMtmGOeqo4XMQyoiJXwt2awr?=
 =?us-ascii?Q?l+CQ8RAGsjsNkIALvSgtqGDYW6OFI+8DouwiLg/EW9cahTw15H06u2BXO6/W?=
 =?us-ascii?Q?+TrbxA4sw69XMejE2FuZzm3Ztk5nh1X+NjbrVtJRElJA1HPbQEUqfiRE9iqJ?=
 =?us-ascii?Q?1eXJOqpm1StYs/k4rtL+NNi+nETzmXBK8OwmOeWZnOLzVD5SMCuAPlANi15Q?=
 =?us-ascii?Q?K9Qr2lWxrM5NtAgpxK7nhumy8UkkKdC9yJmEYZzLrLrlIf6Wk4OCU+VlUloU?=
 =?us-ascii?Q?8NKqMJllZ712pz/rkj3jZ/qNRnpT?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(36860700013)(1800799024)(376014)(7416014)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:18:10.3733
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 2e317adf-bcf2-40e7-be25-08dce7e717e8
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B076.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR12MB5986
Status: RO
Content-Length: 799
Lines: 28

The CXL AER service will be updated to support CXL PCIe port error
handling in the future. These devices will use a system panic during
recovery handling.

Add PCI_ERS_RESULT_PANIC enumeration to pci_ers_result type.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 include/linux/pci.h | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/include/linux/pci.h b/include/linux/pci.h
index 4cf89a4b4cbc..6f7e7371161d 100644
--- a/include/linux/pci.h
+++ b/include/linux/pci.h
@@ -857,6 +857,9 @@ enum pci_ers_result {
 
 	/* No AER capabilities registered for the driver */
 	PCI_ERS_RESULT_NO_AER_DRIVER = (__force pci_ers_result_t) 6,
+
+	/* Device state requires system panic */
+	PCI_ERS_RESULT_PANIC = (__force pci_ers_result_t) 7,
 };
 
 /* PCI bus error event callbacks */
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2047.outbound.protection.outlook.com [40.107.94.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B2A31215029;
	Tue,  8 Oct 2024 22:18:26 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.47
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425908; cv=fail; b=gMs0RWgIKZLgDaG1sxQfmxqNZbZp0kla4iRgMtaNLX1PVBTQflahrPHd6xNYDvwfjkf44MKWYaA7S/GgFuGWkqNqmCKegaYQDKF6V78xzF3rlXQt14sdcVOB4IVYdaZrPTDfHmKOy052bh5hCcK2gAhi5BlMAgpcX2TP7WGShRs=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425908; c=relaxed/simple;
	bh=Kkn8mC2FDHoj+bh80mhCXIfMEzekjwKBPe42FzZ3mzQ=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=uGtEGcXt8LELdqT/NbHIktdSGgwIj/Kfob7QEqF0QkUd76YNyWFk9iud9A8LMzDShh4ozwfxZcbKK8CA53R2+epdTT6J44KLawRDDCBMIC4VOBMx8ij7ReOcxeDzPtEWe1o4f7+GK8yZ4JdsGoukX55zxFMiEwt5RddI0+wN0Ek=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=ZtVHY6yW; arc=fail smtp.client-ip=40.107.94.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="ZtVHY6yW"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=Xblk+eptCqKPPIkknDX/4BPMyXttFssdQAlMFdiIUWhVIqnZYrDZYFsDQJ2NIQFCYxUKthIb7oqgd27LxKcvy6y69Pm/fI+nJWdZ6STX2BPo4A73bmHxGS14gHyE5FHiEUQ55MyUVf/98gFASIkSQEqWqDnp92uPUq9+blT0SrVtn19xduikxV2k2zqvhhmteTbCX5nD9ndkXmKa9fzdvjEcPpGlp6bIXAOso+JQjpZfxTp3gYVxQZurncMEQyh2rUWmyt+fdNlxxac/fUpboTPCftoVa2qSY4FGw5HWU+oMiCy4tCWy9YuZMjxfM6NIcFn0f/0K4XQPDA9W6gC2yQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=AZfNXx/wbIYcbDTbyhbPWoMTc4wLgREmLHj6HiSJI50=;
 b=QuVY0o4I0grWXgHMhmv92DaM8/NauU8r6PkSHVRHKMY4st5vzd6jto4WCysJ4el/hro7FOBMC7UOjsxpxglSB+Qec8FAyFtbs7M6Ku57p6/pAAl8xs2mK0C2IvJ9MeqEbaNaS+fFfjqF0gpoDuHiSwlbeBse2RIb5AkFChF1438XXkHek94e2WP+4HWqLT2+zC3TcMRdjqxCEjkFwrxSISp+zgl1ARz1eaj56njJZ0xzHNYE35vo1iUrK7YDa5G9jbYbL5y3oSY+1xlSNfdrz3/NNBeNFuy8iXToyfrFm8sB+Kdvd4HKVvn/t+IaGidcp/qBI/lFf1ejsRtf9F/NyA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=AZfNXx/wbIYcbDTbyhbPWoMTc4wLgREmLHj6HiSJI50=;
 b=ZtVHY6yWaD3rMeiLsIr5j1I7vaW6Ugdu8N8GLkafIhyjj25WK06TefzSt1V75dOeGLDpWE6dTtD+IW/hJh3dNEZ8o4+ZB+rBLxIux7YR5Z4AiFILYhBvDZVRosB99tnYbqm6ejHg8CcexjofnOqvCOHfg6eKIO9sb8XE6OeRE8E=
Received: from BLAPR03CA0081.namprd03.prod.outlook.com (2603:10b6:208:329::26)
 by SA1PR12MB7269.namprd12.prod.outlook.com (2603:10b6:806:2be::5) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.18; Tue, 8 Oct
 2024 22:18:21 +0000
Received: from BN3PEPF0000B078.namprd04.prod.outlook.com
 (2603:10b6:208:329:cafe::32) by BLAPR03CA0081.outlook.office365.com
 (2603:10b6:208:329::26) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:18:21 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B078.mail.protection.outlook.com (10.167.243.123) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:18:21 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:18:20 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable error recovery in AER service driver
Date: Tue, 8 Oct 2024 17:16:49 -0500
Message-ID: <20241008221657.1130181-8-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B078:EE_|SA1PR12MB7269:EE_
X-MS-Office365-Filtering-Correlation-Id: e71c4f5c-825e-4a2c-f40c-08dce7e71e86
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|7416014|82310400026|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?YpElI/AzMKmrd5q60FXs6QWsCnrjNQ4UagVjpVuNkPYj9p1MHOp3V15wAQQN?=
 =?us-ascii?Q?ew+HJHNlZqyRzHoNNrvK+WJqXP3YlJjrM1GTPlVC1igoQGg7N1DApNvUAoin?=
 =?us-ascii?Q?nv8fUCDN6wiak88klOiEXOjG7A7doCk4eFgqTy/Olyx1dRvFddt+Qrydl7qK?=
 =?us-ascii?Q?s1OkuO1PI8TQfXM295zqS4FNKbRvKHEQ2kzaYVlilrl0/+AxaSyA5dhWvE0V?=
 =?us-ascii?Q?CM00e4sCQRPvHQg2jJjcyEcU9ahnqgp8/Dx2bWxwnNbDvcYco2Yf7WKXFDxj?=
 =?us-ascii?Q?VBPzouHx1pLb5EGHzi4HpxlCDemjAwq1rqATiJQ9QHXxIFd/XyTFB2/gunen?=
 =?us-ascii?Q?Mj5dx/IXYhiQT1CXEB0TzJdo4TjaIn83+ZgI3n7mB4imupW30HraPwos5sdK?=
 =?us-ascii?Q?ZT/EugddHZiAFIeoVNCwwfHSPNqTB7aISz7JaN9IARP4Ja/qIrN1FnF1UfQJ?=
 =?us-ascii?Q?KTzOUjL7qKJHo2czOSoDIfU/QqLS5WpC6ybiiG3jROUmzEEDHfNQV4/LqM2n?=
 =?us-ascii?Q?FhD/wu4GTicZvV396YL0vcubt8lfN6oJiXfRC8RvM67D84fmZW41c+tur3XV?=
 =?us-ascii?Q?rke3in2mFcx+HAtHLuwl3GLrdbSLrcwfTT+7NE8B8tN3dKcBsWPkR4pc+iS7?=
 =?us-ascii?Q?x/zscLoYsCGFI1ot62KNhs1ygzCT8MYySpIV824ZnHCYRjwzLYTMUcRp0+kP?=
 =?us-ascii?Q?320U3VK8l7DyLV/xpbtBeJOpSd+/a9bl33GhGSu2LQo++12SRQxjUwkdXuTC?=
 =?us-ascii?Q?zNjp8FvGTEJTxFiJ7IJXAyIzlAsVALEVDVIQdtPqnbQOCUPbJOLMt5aaFTkX?=
 =?us-ascii?Q?Xo2YDEWNJZxuNSYsHf0Us7/PP/L3pRSgLhAECp4wDnOoy5oJVYSPU56Rg/AC?=
 =?us-ascii?Q?ClvGEgF7b5qDCk2LPa39UdnvaeqPvBPkAyVQqAgL/J+LuUG3v9NZJhvKga4k?=
 =?us-ascii?Q?0sTac0tgMrxgTNj92f2Bmo+7GM12kR3s68lfrT3PtrODxlQmf4DcwYFNLcBJ?=
 =?us-ascii?Q?yyJKD89LGcSkAzRuqdGednrSgkpdXc1uMnLW4PwIFgRBZJcu/M9pwmwRBptP?=
 =?us-ascii?Q?QOHhn2DXZNIZRPk0c6FCaVkyGct2uAjeikU9RId769lZ8D5dfAAUhh/wdm4u?=
 =?us-ascii?Q?d2UI2i6cPGTzjyN/2n4IufAcTomfJyzS54wetIEIJ1x/YfTQjW7X4bemAkMf?=
 =?us-ascii?Q?jOoc0DRgWd7JNsDONQ06Y+OdFvkgHVQ9j/djMhcWN1ge0Wzsh/FHbD4z4M3x?=
 =?us-ascii?Q?I6kbh+r1R7yBAlSJsCnjxapfti+V+zPIapYaQZUIKZuVjY5J0vWfrzD3Sh3a?=
 =?us-ascii?Q?2uD1rgV6yDZOmKKlKsLZWqB9G52iQf/eBxfL+X+gTyVCCysp+8P326CtxHSS?=
 =?us-ascii?Q?UGTdxvDpDfQUrJaNbT1Q17/XkVsA?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(7416014)(82310400026)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:18:21.4608
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: e71c4f5c-825e-4a2c-f40c-08dce7e71e86
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B078.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB7269
Status: RO
Content-Length: 7892
Lines: 232

The current pcie_do_recovery() handles device recovery as result of
uncorrectable errors (UCE). But, CXL port devices require unique
recovery handling.

Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
specific handling to the new recovery function.

The CXL port UCE recovery must invoke the AER service driver's CXL port
UCE callback. This is different than the standard pcie_do_recovery()
recovery that calls the pci_driver::err_handler UCE handler instead.

Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
"recover" the error. A panic is called instead of attempting recovery
to avoid potential system corruption.

The uncorrectable support added here will be used to complete CXL PCIe
port error handling in the future.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pci.h      |   5 ++
 drivers/pci/pcie/aer.c |   5 +-
 drivers/pci/pcie/err.c | 150 +++++++++++++++++++++++++++++++++++++++++
 3 files changed, 159 insertions(+), 1 deletion(-)

diff --git a/drivers/pci/pci.h b/drivers/pci/pci.h
index 79c8398f3938..d1f5b42fa48d 100644
--- a/drivers/pci/pci.h
+++ b/drivers/pci/pci.h
@@ -632,6 +632,11 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
 		pci_channel_state_t state,
 		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev));
 
+/* CXL error reporting and recovery */
+pci_ers_result_t cxl_do_recovery(struct pci_dev *dev,
+		pci_channel_state_t state,
+		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev));
+
 bool pcie_wait_for_link(struct pci_dev *pdev, bool active);
 int pcie_retrain_link(struct pci_dev *pdev, bool use_lt);
 
diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index 9b2872c8e20d..81a19028c4e7 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -1060,7 +1060,10 @@ static void cxl_handle_error(struct pci_dev *dev, struct aer_err_info *info)
 		if (cxl_port_hndlrs && cxl_port_hndlrs->cor_error_detected)
 			cxl_port_hndlrs->cor_error_detected(dev);
 		pcie_clear_device_status(dev);
-	}
+	} else if (info->severity == AER_NONFATAL)
+		cxl_do_recovery(dev, pci_channel_io_normal, aer_root_reset);
+	else if (info->severity == AER_FATAL)
+		cxl_do_recovery(dev, pci_channel_io_frozen, aer_root_reset);
 }
 
 static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
index 31090770fffc..de12f2eb19ef 100644
--- a/drivers/pci/pcie/err.c
+++ b/drivers/pci/pcie/err.c
@@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
 	return 0;
 }
 
+static int cxl_report_error_detected(struct pci_dev *dev,
+				     pci_channel_state_t state,
+				     enum pci_ers_result *result)
+{
+	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
+	struct pci_driver *pdrv;
+	pci_ers_result_t vote;
+
+	device_lock(&dev->dev);
+	cxl_port_hndlrs = find_cxl_port_hndlrs();
+	pdrv = dev->driver;
+	if (pci_dev_is_disconnected(dev)) {
+		vote = PCI_ERS_RESULT_DISCONNECT;
+	} else if (!pci_dev_set_io_state(dev, state)) {
+		pci_info(dev, "can't recover (state transition %u -> %u invalid)\n",
+			dev->error_state, state);
+		vote = PCI_ERS_RESULT_NONE;
+	} else if (!cxl_port_hndlrs || !cxl_port_hndlrs->error_detected) {
+		if (dev->hdr_type != PCI_HEADER_TYPE_BRIDGE) {
+			vote = PCI_ERS_RESULT_NO_AER_DRIVER;
+			pci_info(dev, "can't recover (no error_detected callback)\n");
+		} else {
+			vote = PCI_ERS_RESULT_NONE;
+		}
+	} else {
+		vote = cxl_port_hndlrs->error_detected(dev, state);
+	}
+	pci_uevent_ers(dev, vote);
+	*result = merge_result(*result, vote);
+	device_unlock(&dev->dev);
+	return 0;
+}
+
+static int cxl_report_frozen_detected(struct pci_dev *dev, void *data)
+{
+	/*
+	 * CXL endpoints report using pci_dev::err_handlers.
+	 * CXL PCIe ports report using aer_rpc::cxl_port_err_handlers.
+	 */
+	if (pci_pcie_type(dev) == PCI_EXP_TYPE_ENDPOINT)
+		return report_error_detected(dev, pci_channel_io_frozen, data);
+	else
+		return cxl_report_error_detected(dev, pci_channel_io_frozen, data);
+}
+
+static int cxl_report_normal_detected(struct pci_dev *dev, void *data)
+{
+	/*
+	 * CXL endpoints report using pci_dev::err_handlers.
+	 * CXL PCIe ports report using aer_rpc::cxl_port_err_handlers.
+	 */
+	if (pci_pcie_type(dev) == PCI_EXP_TYPE_ENDPOINT)
+		return report_error_detected(dev, pci_channel_io_normal, data);
+	else
+		return cxl_report_error_detected(dev, pci_channel_io_normal, data);
+}
+
 static int pci_pm_runtime_get_sync(struct pci_dev *pdev, void *data)
 {
 	pm_runtime_get_sync(&pdev->dev);
@@ -188,6 +245,28 @@ static void pci_walk_bridge(struct pci_dev *bridge,
 		cb(bridge, userdata);
 }
 
+/**
+ * cxl_walk_bridge - walk bridges potentially AER affected
+ * @bridge:	bridge which may be a Port, an RCEC, or an RCiEP
+ * @cb:		callback to be called for each device found
+ * @userdata:	arbitrary pointer to be passed to callback
+ *
+ * If the device provided is a bridge, walk the subordinate bus, including
+ * the device itself and any bridged devices on buses under this bus.  Call
+ * the provided callback on each device found.
+ *
+ * If the device provided has no subordinate bus, e.g., an RCEC or RCiEP,
+ * call the callback on the device itself.
+ */
+static void cxl_walk_bridge(struct pci_dev *bridge,
+			    int (*cb)(struct pci_dev *, void *),
+			    void *userdata)
+{
+	cb(bridge, userdata);
+	if (bridge->subordinate)
+		pci_walk_bus(bridge->subordinate, cb, userdata);
+}
+
 pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
 		pci_channel_state_t state,
 		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
@@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
 
 	return status;
 }
+
+pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
+				 pci_channel_state_t state,
+				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
+{
+	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
+	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
+	int type = pci_pcie_type(bridge);
+
+	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
+	    (type != PCI_EXP_TYPE_RC_EC) &&
+	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
+	    (type != PCI_EXP_TYPE_UPSTREAM)) {
+		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
+		return status;
+	}
+
+	cxl_walk_bridge(bridge, pci_pm_runtime_get_sync, NULL);
+
+	pci_dbg(bridge, "broadcast error_detected message\n");
+	if (state == pci_channel_io_frozen) {
+		cxl_walk_bridge(bridge, cxl_report_frozen_detected, &status);
+		if (reset_subordinates(bridge) != PCI_ERS_RESULT_RECOVERED) {
+			pci_warn(bridge, "subordinate device reset failed\n");
+			goto failed;
+		}
+	} else {
+		cxl_walk_bridge(bridge, cxl_report_normal_detected, &status);
+	}
+
+	if (status == PCI_ERS_RESULT_PANIC)
+		panic("CXL cachemem error. Invoking panic");
+
+	if (status == PCI_ERS_RESULT_CAN_RECOVER) {
+		status = PCI_ERS_RESULT_RECOVERED;
+		pci_dbg(bridge, "broadcast mmio_enabled message\n");
+		cxl_walk_bridge(bridge, report_mmio_enabled, &status);
+	}
+
+	if (status == PCI_ERS_RESULT_NEED_RESET) {
+		status = PCI_ERS_RESULT_RECOVERED;
+		pci_dbg(bridge, "broadcast slot_reset message\n");
+		report_slot_reset(bridge, &status);
+		pci_walk_bridge(bridge, report_slot_reset, &status);
+	}
+
+	if (status != PCI_ERS_RESULT_RECOVERED)
+		goto failed;
+
+	pci_dbg(bridge, "broadcast resume message\n");
+	cxl_walk_bridge(bridge, report_resume, &status);
+
+	if (host->native_aer || pcie_ports_native) {
+		pcie_clear_device_status(bridge);
+		pci_aer_clear_nonfatal_status(bridge);
+	}
+
+	cxl_walk_bridge(bridge, pci_pm_runtime_put, NULL);
+
+	pci_info(bridge, "device recovery successful\n");
+	return status;
+
+failed:
+	cxl_walk_bridge(bridge, pci_pm_runtime_put, NULL);
+
+	pci_uevent_ers(bridge, PCI_ERS_RESULT_DISCONNECT);
+
+	pci_info(bridge, "device recovery failed\n");
+
+	return status;
+}
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2077.outbound.protection.outlook.com [40.107.92.77])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C3A69216434;
	Tue,  8 Oct 2024 22:18:36 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.77
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425919; cv=fail; b=uK+rbaBW2XoZNQTRgHvgtVNFsDzRzI2Gg0hWwhW5PS7wK/tDB7iD6XWUmUDtuc2amtF/BRWUOhRtlu/6Zb31tTbFUcBTaFLdONtYyrTwJG2s5hDUTDdKFR1Ld+6c9lwoANJ/OlR/T1fepirstdpj5+8wXGade0wDfDg1ir7LTQo=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425919; c=relaxed/simple;
	bh=tWXbjlwIM9qNFbbcPhA4yhkUdCvK7+WU0BYTLWYNYWE=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=HVcDK9PMtTyXJo0RfdT2dviyz1DajBXtUudpx9Bf5fm5mEF4qpDK/y/Cf2SADdRlLKokAQQjuVUOGYEFaBL73U0smoSYptObcxmDcnavVXF77nUSVqiQozu427lh/nmzUlipK8Mf/uLVRUR5vbEwpFrbmegU8PjRLhQ16bgb7lY=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=qHkAVQNJ; arc=fail smtp.client-ip=40.107.92.77
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="qHkAVQNJ"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=qnOgsgtHwIMdgFt9UAHe9r9yq2BvoS6I3K/Iodj8cfKjFoHA9ByEgHtijADvetmhIBz2UibkeKi0AqlT9HdrTYfA59DbiDkNBOvB8coBb6seUqYnhACwwwedJ8z85L05PXblK0Wi2KgundwrBm/0XP7CPa5IXCL+utQ5HiGHAjjiTlKl8sozP3sQZPN4JbRKCPoqKQwt3bS5TBRplq4+d40gX9tdpPRxqKJgyMwOG8/TqgV/8qFlEJoEX3SMi8TAuLvZESzcsVYSRj8BBzujiqbUHINY0ZykVGwtLuJErgO6gdcqaIP3w8xuo/ta+qi1tgp/IZrMjubd4WF15hjDQA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=7C0kM8b0VZECq7tQOLeCsFwAlc0hBQXp/54ZKhCpVQ8=;
 b=D3Fa/0Ejr75IagB3ZfzNnN591tKrXdpTjpPoG2ASP8pwMOYPA/WLP9MBQWD4/WI271fCKJesbHXFfQWNlbgY8qhdDgjntO8KucX7yJt3ihAGbM222WQWkVA1wk/prAJAnfAVwTvBNqcN9fZY7XXBUaTBlWnZ3p6CNfzaBo3bd/8GQTcu32a2/Aqqngd0i6aBVbdBfmLLHJ1Equ2kAh3gBXXxQRnlovpZMtvOT1CGLE24StZE/JiGKJol+SHLQewcb8oQT5Y6ZzZT5bHUBJY6+KG2Q1TvoAFc48lHF+HHIdzW+XWLOaTWtqNPJyHJMLXpf/WkvqjzGJV7gZKJ7HGaLA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=7C0kM8b0VZECq7tQOLeCsFwAlc0hBQXp/54ZKhCpVQ8=;
 b=qHkAVQNJRzSEjIfOUUgiyzuif4BjrBvKWCtDrLrSPofYonqg1z+jDS1exdjI5tAMdWht5YSYg3/BNQU5mXSXRwWkHrtGrgXynL28PrAAkWbiDUNoUqdzgVTGj6xcjxFN9Db34uENUoNywetdQ26ccMQVbGqcl5vmSPU1gHdIm3Y=
Received: from BN8PR04CA0058.namprd04.prod.outlook.com (2603:10b6:408:d4::32)
 by SJ0PR12MB8138.namprd12.prod.outlook.com (2603:10b6:a03:4e0::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.16; Tue, 8 Oct
 2024 22:18:33 +0000
Received: from BN3PEPF0000B074.namprd04.prod.outlook.com
 (2603:10b6:408:d4:cafe::ce) by BN8PR04CA0058.outlook.office365.com
 (2603:10b6:408:d4::32) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:18:32 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B074.mail.protection.outlook.com (10.167.243.119) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:18:32 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:18:31 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 08/15] cxl/pci: Change find_cxl_ports() to be non-static
Date: Tue, 8 Oct 2024 17:16:50 -0500
Message-ID: <20241008221657.1130181-9-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B074:EE_|SJ0PR12MB8138:EE_
X-MS-Office365-Filtering-Correlation-Id: 4e84dd3a-8117-492c-7f87-08dce7e72527
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|7416014|82310400026|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?AcFAKhBEICG4bYHq8PgXcHnsEYDkzstZkAokTIUYQPGxdOm8SK2UBKcGAfmT?=
 =?us-ascii?Q?d+FbNrQouKORs1XaBi4gmpPLvg/ZD1FPmMLx/Uo9U6RlomNCbgs6gZGD8hFt?=
 =?us-ascii?Q?RE1mtFTUNvSFl3eCcX2xM07ayOCX+snmY3VCsD8lv66mOFeZdYueQRZVsq4o?=
 =?us-ascii?Q?mjPwKU55CrbWDVZZUENPEFfEI2SvcmEf7VpMraWLYkbM5I2Q30lFPy4w5lfu?=
 =?us-ascii?Q?O7/tH8RhMK6tsNXX1GnnrW35MW5Kq5me8eISEbLBZBJbtFemNO7v0I8r3uVq?=
 =?us-ascii?Q?TMPgL8fvilR71XTQ+H+6Z5jgpyU3auDw6qPUe744gtEupq8NgiaufnDARgAd?=
 =?us-ascii?Q?qZ6u5/LdReyxMgOYB0eRT8Ob3NPaiO7Eu2eSqwFKYf0ToM2i4/bW+W3F+qlQ?=
 =?us-ascii?Q?Uxaq09YCWgmAz0cy7BM5AVTuX8iirHZ70waBsQAgafq9yB0TCssA7MqVZVUp?=
 =?us-ascii?Q?iPzaE7gnXDIilCrrsh3bjRuHWfF23G2iItmqnPf/Ug5MzXRrxVfBTng3AcYa?=
 =?us-ascii?Q?sX9SyFlLIaTVZWgjWwaC6Gn1+X5ABZRpW9CzDi8Bj/DB6JIEbhvXXwRo4Vjc?=
 =?us-ascii?Q?9svS42NFRv1hv06ZG/83FMywMtiTkh1w2WCiCmJU5ywtke/VnDEZHxIGTZX0?=
 =?us-ascii?Q?LTpdOSkVDTh3d06L3vxWPytffSYxVft6zi3EInppgZN8KPR6oJx5Xk2WUazh?=
 =?us-ascii?Q?+f3SiXT1mEXxdDGuQWG2Y4GlV0+CUDSOyffbTOBdjHOmVInHMMkuGn0hrO1Q?=
 =?us-ascii?Q?5Fo3h2BW893vXxxybB8NytfGLuJd/f2VEkoEs6OKF35G4+M4viEHkb1e1BN0?=
 =?us-ascii?Q?VdKCqmznTu+6V/703AsMamFdnerN5lzDLPTXMBGn9n+ExXjYh1BcB/4leQAm?=
 =?us-ascii?Q?fC1tmBwTX02CpKuLmQ8ClFu9g5AGhRpCetYxlGMhpif0f/gCpdxFcpWBRwQN?=
 =?us-ascii?Q?lO7vlpwzr8YvGfG0gFRYuJXpcNeVqaemkirfFFpRGH+CcwYPkMhIjQT1XcHq?=
 =?us-ascii?Q?hS++VutA3sgu/TbpqXBvD26/fvWCi73BJOvrlA2VXfTLgEC+HiXZzhDqukZ9?=
 =?us-ascii?Q?r4DifqvPzQwHm3idaOwZeZoWLJfSsxooQ7neH6m5mDf04Zaj96TY1k7SMOEZ?=
 =?us-ascii?Q?qOC8/jNNXMk/bAAWcchHSGAB04Zqu5JuL1cn7WlJboYIPMw+ieZBtQl2OkNs?=
 =?us-ascii?Q?PR0K85iIlnazQMiWfmXoXYTgS7YMU+FS24jgr8rQx7tD/qHj3ijPdAEzsRrE?=
 =?us-ascii?Q?SyemcDdNVhhe8Gk9L79AZjhw5NL1XKVRnr01a9F8rJJMpN5+ShMFw9QBvddY?=
 =?us-ascii?Q?ivDn61t7WNgSmsTc8Li0slrJASqnzTWBL8DW57mitSy+kWI6jraVxG32Jg7t?=
 =?us-ascii?Q?eNmYf4T2DxZ01pU+TuCSgaQbkrMz?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(7416014)(82310400026)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:18:32.5949
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 4e84dd3a-8117-492c-7f87-08dce7e72527
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B074.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR12MB8138
Status: RO
Content-Length: 1534
Lines: 43

CXL PCIe port protocol error support will be added in the future. This
requires searching for a CXL PCIe port device in the CXL topology as
provided by find_cxl_port(). But, find_cxl_port() is defined static
and as a result is not callable outside of this source file.

Update the find_cxl_port() declaration to be non-static.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/core.h | 3 +++
 drivers/cxl/core/port.c | 4 ++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/cxl/core/core.h b/drivers/cxl/core/core.h
index 72a506c9dbd0..14a8b4d14af6 100644
--- a/drivers/cxl/core/core.h
+++ b/drivers/cxl/core/core.h
@@ -108,4 +108,7 @@ int cxl_update_hmat_access_coordinates(int nid, struct cxl_region *cxlr,
 				       enum access_coordinate_class access);
 bool cxl_need_node_perf_attrs_update(int nid);
 
+struct cxl_port *find_cxl_port(struct device *dport_dev,
+			       struct cxl_dport **dport);
+
 #endif /* __CXL_CORE_H__ */
diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.c
index 1d5007e3795a..089a1f4535c1 100644
--- a/drivers/cxl/core/port.c
+++ b/drivers/cxl/core/port.c
@@ -1336,8 +1336,8 @@ static struct cxl_port *__find_cxl_port(struct cxl_find_port_ctx *ctx)
 	return NULL;
 }
 
-static struct cxl_port *find_cxl_port(struct device *dport_dev,
-				      struct cxl_dport **dport)
+struct cxl_port *find_cxl_port(struct device *dport_dev,
+			       struct cxl_dport **dport)
 {
 	struct cxl_find_port_ctx ctx = {
 		.dport_dev = dport_dev,
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (mail-sn1nam02on2086.outbound.protection.outlook.com [40.107.96.86])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A8D53215039;
	Tue,  8 Oct 2024 22:18:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.96.86
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425929; cv=fail; b=tbmhJ/8U2Pc66r4Ac1NqSl0ialPEjtv+h8FiExqNykA/cGm9HVcr57IRLhtw1XSbX8QJ7Veu4iSwZg+Yb90wS71XlYPcmRPEtEbposjq27OlnpR+hLdkWf/wB3ONunu9YjnEemIu69jbZgebA/GN+WYQkv4ZQlymdxOIO7DhO48=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425929; c=relaxed/simple;
	bh=FO3SwhHWq8DD2fjZrIXlGQzQqK+orFXfoHefumruETw=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=BCzY6BsqglUF7FjILesrNcARNQhUCXYQE1v408xbnP8dFgvjMPPNkiZiHVTrBeid+x2tzzA2kQ8R2zXRleboQfQpigKTDebqLBRlEyHK+JvGvCMv67M4d7LWmxB3A62V+uavDo5pKSMVeocYvhwS5y6uy3rvGDayneUP+hyIlh0=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=jUw5JxKF; arc=fail smtp.client-ip=40.107.96.86
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="jUw5JxKF"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=aFXmRxHenhQ4XJeSkW4Z71ElZFYX16k5L+NYkYpvPlGsONQ0xEXfu0blqXQoiTz+U9ZDWluWGKBg7gMOjpxHgCLgLws8zAxMRfEYcoy3No5Ddw7+3uuS+cUIEzhQXwex4FFjRJivcXKmud1iI6uGQLGHRojuKTj0lVPrfuZFp+MGqVxJ3e7kJGFIQz0VOt+XCs3ymQ1IzfpyTlu0J/TEhL7sNe+jVGbsxiwFT0SakljBhP+YE3svkbARgyQoRTTeCXBX3GpF6HWgMPOiF+D3X4OS3F8roK90WLoeylVxwFn3LZTsRunqsAHws7Nle8BbZ/HZVxW76oyu6xC0yTivSA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=/wfs9/9pGlrUYcE94dso+MM24VISuqUkE3p3AVyJ/aA=;
 b=OIzF/6xoHcR5yu+HYWsoYpNumysj3ziYlOMC2NC7RuksOhKUtGmx11zG5eltLsZYucQmFBZ6UiLKWiST+wBc/0UEBtldg9178RrTW+26uC98PEqKwLMir/I0tBMWnOcQjkU4v9LHpwnFIiyV4gBU56oN1WQZABiOLj1K7LUg2SPCQKx4cTTOKOHNGumrjoZ3y6wUdFCzd+IJ83LHm+3xRsWqdW23t/5cWUmCPnyyQHvCul2+zBsqUrWRlMImcgdu0HQXGw4wTprOaQf0D6xyblIl9B5iZbEE1Qngx4CUMnkd3rrGrrfbMRcHCizLlskL730V8vvG7chOLR5V08sG6w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=/wfs9/9pGlrUYcE94dso+MM24VISuqUkE3p3AVyJ/aA=;
 b=jUw5JxKFJLHbDL/HgwmmeG5ruZS5yjzvt8+ZlQJYY26wP5ezZKwaWqzP4/9/lJjzKzw7t72CvzjilJ4gFHzD98ta202U8sEnSDMMWyZhDjZVJtZB5oO3euszHcgA6jR9TcNz9IPWj2NBd9yJ6fmURfZrq+DIQ4v1zPVcLRtRSy8=
Received: from BL0PR0102CA0066.prod.exchangelabs.com (2603:10b6:208:25::43) by
 PH7PR12MB6860.namprd12.prod.outlook.com (2603:10b6:510:1b6::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.24; Tue, 8 Oct
 2024 22:18:44 +0000
Received: from BN3PEPF0000B071.namprd04.prod.outlook.com
 (2603:10b6:208:25:cafe::d4) by BL0PR0102CA0066.outlook.office365.com
 (2603:10b6:208:25::43) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.7982.34 via Frontend
 Transport; Tue, 8 Oct 2024 22:18:44 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B071.mail.protection.outlook.com (10.167.243.116) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:18:43 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:18:42 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 09/15] cxl/pci: Map CXL PCIe downstream port RAS registers
Date: Tue, 8 Oct 2024 17:16:51 -0500
Message-ID: <20241008221657.1130181-10-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B071:EE_|PH7PR12MB6860:EE_
X-MS-Office365-Filtering-Correlation-Id: 004e4685-5204-4c26-6379-08dce7e72bd9
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|36860700013|1800799024|376014|82310400026|7416014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?Fb33BIcssvSNssrpz7cXCP8qlAtXKXaJobKFdezBNMY5UAeQvWqZY90zysCe?=
 =?us-ascii?Q?mctO1Zh0NenKbF6/tYz/2W5tOl9dzgrRWXv1BO5g77v7IPcEYFdULsLXZtP+?=
 =?us-ascii?Q?F6JOeZkIR8ghs1cNhQ22fDixOWF+NOdvfS4LZ27QeQswKgC5eZeZ8DhKDhay?=
 =?us-ascii?Q?Q6JBO4FKqaEAHtjcljUAW4zoaELVTsnFuKJHJbfXjnsyxix/jevpmaTU9FMf?=
 =?us-ascii?Q?cpCYM4DmkfUB+ewhopIssOmIHd5MB0iZVurfmH8weqMQsUAspNBxchjmyNXy?=
 =?us-ascii?Q?v//6GQSQACR5oQ9eLmkG6/82enBgNE7HV8M3jqe+22e183jbWAw4ijaLvxg+?=
 =?us-ascii?Q?us0dpnExbHnfco/qbmV1vkwM1hsGD5hbvhzIGtNLSUsUNGqwso33eMgpMSoO?=
 =?us-ascii?Q?KtV1KMguhZpX5sMGkdRRZ3/6e4n896BJmFOFGtbtI5sCqPv3qMdQ3mBmgHt7?=
 =?us-ascii?Q?EsMJz6BJFtNd/Tdq9mhljSB5y1GkNqMjHFqxoAQn/QsSbXt7PlXMXhCrMaOo?=
 =?us-ascii?Q?N3GDJyl2bDd2ObUpaU91rKGe3TAqpUae+24JjvuLEA1S5L2x81zthGSMv6fX?=
 =?us-ascii?Q?Od3rYugRZVgQztY3GMKbXiHsyvo4oPmdVp1UKdd6s/BM9fYdqU2ZSs3qzA/3?=
 =?us-ascii?Q?koQO4F5Xr1yhykdOVetOjPDk/vnE8VByiNVnBvgZkrd9NxPoBoGauJ0eQApa?=
 =?us-ascii?Q?0ZqgUp1Go6N7zXMKIlGVvMPq+XN5uKWZ+i1a2r6WBmxJAF+d1egiV/xsKzAH?=
 =?us-ascii?Q?bUX4MtqanmvNibP3hYc0Oxy85MzLg5aWYz+23aazbMQVB5ob5cyD0VXIwI3y?=
 =?us-ascii?Q?GC6tdoEVsSTIJ3AvxOwUAjrCK9wR1gSsd2jYTZKyZr3tivKQ6eBmhqLGj4g/?=
 =?us-ascii?Q?MBRyjoS/AmmY4oFJpN8uJp+j1A7Fk9TxDnm9iwuRRLshZxPlNE11EWqlTVo6?=
 =?us-ascii?Q?w4DdDgd2VdaU6cX82ULayY2QvM8hl4oqhLX4zgwEgrCIUjt9q2jI8PpLD1y1?=
 =?us-ascii?Q?27qjEpAyVXK0jrpMdzP3hD7ikAdeW+xMlUHX+p5y72LVHMp+xWmk4FhqC+5b?=
 =?us-ascii?Q?uBQtfutRz5fOF3qYcti1/cjpmpjjuIkwC5zVhQB6nD+UZeAZ1nlGz1mIozZF?=
 =?us-ascii?Q?12qrEP25Nsoa6agXJ72vU+RJqlb8jq8DAqSLJ0dTnFyD1ihiP35Io7X32WZl?=
 =?us-ascii?Q?3uXd4ysF8Iju9dmNK9gRAsyg9ATmGQFMlS3BA5LdgaYBE+KJTgH2y7YHuT/Y?=
 =?us-ascii?Q?XCleH/w9Wevj2HjngN1/6ufOYorSC26bJzglj4MS8ExyGOWLOHJlpvKp4YHp?=
 =?us-ascii?Q?lVbusuU0M55dE2tFfqVMvREg2UilMrNFNWTbPeMkrWIQrlJw6VlMHNVtf2VG?=
 =?us-ascii?Q?iTrq4p6JgEdmBGJyG0kdHBuLnR2e?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(36860700013)(1800799024)(376014)(82310400026)(7416014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:18:43.8271
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 004e4685-5204-4c26-6379-08dce7e72bd9
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B071.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR12MB6860
Status: RO
Content-Length: 5961
Lines: 177

RAS registers are not mapped for CXL root ports, CXL downstream switch
ports, or CXL upstream switch ports. To prepare for future RAS logging
and handling, the driver needs updating to map PCIe port RAS registers.

Refactor and rename cxl_setup_parent_dport() to be cxl_init_ep_ports_aer().
Update the function such that it will iterate an endpoint's dports to map
the RAS registers.

Rename cxl_dport_map_regs() to be cxl_dport_init_aer(). The new
function name is a more accurate description of the function's work.

This update should also include checking for previously mapped registers
within the topology, particularly with CXL switches. Endpoints under a
CXL switch may share a common downstream and upstream port, ensure that
the registers are only mapped once.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c | 37 ++++++++++++++++---------------------
 drivers/cxl/cxl.h      |  7 ++++---
 drivers/cxl/mem.c      | 27 +++++++++++++++++++++++++--
 3 files changed, 45 insertions(+), 26 deletions(-)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 51132a575b27..6f7bcdb389bf 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -787,21 +787,6 @@ static void cxl_dport_map_rch_aer(struct cxl_dport *dport)
 	dport->regs.dport_aer = dport_aer;
 }
 
-static void cxl_dport_map_regs(struct cxl_dport *dport)
-{
-	struct cxl_register_map *map = &dport->reg_map;
-	struct device *dev = dport->dport_dev;
-
-	if (!map->component_map.ras.valid)
-		dev_dbg(dev, "RAS registers not found\n");
-	else if (cxl_map_component_regs(map, &dport->regs.component,
-					BIT(CXL_CM_CAP_CAP_ID_RAS)))
-		dev_dbg(dev, "Failed to map RAS capability.\n");
-
-	if (dport->rch)
-		cxl_dport_map_rch_aer(dport);
-}
-
 static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
 {
 	void __iomem *aer_base = dport->regs.dport_aer;
@@ -831,7 +816,7 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
 	}
 }
 
-void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport)
+void cxl_dport_init_aer(struct cxl_dport *dport)
 {
 	struct device *dport_dev = dport->dport_dev;
 
@@ -840,15 +825,25 @@ void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport)
 
 		if (host_bridge->native_aer)
 			dport->rcrb.aer_cap = cxl_rcrb_to_aer(dport_dev, dport->rcrb.base);
+
+		cxl_dport_map_rch_aer(dport);
+		cxl_disable_rch_root_ints(dport);
 	}
 
-	dport->reg_map.host = host;
-	cxl_dport_map_regs(dport);
+	/* dport may have more than 1 downstream EP. Check if already mapped. */
+	if (dport->regs.ras) {
+		dev_warn(dport_dev, "RAS is already mapped\n");
+		return;
+	}
 
-	if (dport->rch)
-		cxl_disable_rch_root_ints(dport);
+	dport->reg_map.host = dport_dev;
+	if (cxl_map_component_regs(&dport->reg_map, &dport->regs.component,
+				   BIT(CXL_CM_CAP_CAP_ID_RAS))) {
+		dev_err(dport_dev, "Failed to map RAS capability.\n");
+		return;
+	}
 }
-EXPORT_SYMBOL_NS_GPL(cxl_setup_parent_dport, CXL);
+EXPORT_SYMBOL_NS_GPL(cxl_dport_init_aer, CXL);
 
 static void cxl_handle_rdport_cor_ras(struct cxl_dev_state *cxlds,
 					  struct cxl_dport *dport)
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index 9afb407d438f..cb9e05e2912b 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -592,6 +592,7 @@ struct cxl_dax_region {
  * @parent_dport: dport that points to this port in the parent
  * @decoder_ida: allocator for decoder ids
  * @reg_map: component and ras register mapping parameters
+ * @uport_regs: mapped component registers
  * @nr_dports: number of entries in @dports
  * @hdm_end: track last allocated HDM decoder instance for allocation ordering
  * @commit_end: cursor to track highest committed decoder for commit ordering
@@ -612,6 +613,7 @@ struct cxl_port {
 	struct cxl_dport *parent_dport;
 	struct ida decoder_ida;
 	struct cxl_register_map reg_map;
+	struct cxl_component_regs uport_regs;
 	int nr_dports;
 	int hdm_end;
 	int commit_end;
@@ -761,10 +763,9 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
 					 resource_size_t rcrb);
 
 #ifdef CONFIG_PCIEAER_CXL
-void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport);
+void cxl_dport_init_aer(struct cxl_dport *dport);
 #else
-static inline void cxl_setup_parent_dport(struct device *host,
-					  struct cxl_dport *dport) { }
+static inline void cxl_dport_init_aer(struct cxl_dport *dport) { }
 #endif
 
 struct cxl_decoder *to_cxl_decoder(struct device *dev);
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index 7de232eaeb17..b7204f010785 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -45,6 +45,30 @@ static int cxl_mem_dpa_show(struct seq_file *file, void *data)
 	return 0;
 }
 
+static bool dev_is_cxl_pci(struct device *dev, u32 pcie_type)
+{
+	struct pci_dev *pdev;
+
+	if (!dev_is_pci(dev))
+		return false;
+
+	pdev = to_pci_dev(dev);
+	if (pci_pcie_type(pdev) != pcie_type)
+		return false;
+
+	return pci_find_dvsec_capability(pdev, PCI_VENDOR_ID_CXL,
+					 CXL_DVSEC_REG_LOCATOR);
+}
+
+static void cxl_init_ep_ports_aer(struct cxl_ep *ep)
+{
+	struct cxl_dport *dport = ep->dport;
+
+	if (dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_DOWNSTREAM) ||
+	    dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_ROOT_PORT))
+		cxl_dport_init_aer(dport);
+}
+
 static int devm_cxl_add_endpoint(struct device *host, struct cxl_memdev *cxlmd,
 				 struct cxl_dport *parent_dport)
 {
@@ -62,6 +86,7 @@ static int devm_cxl_add_endpoint(struct device *host, struct cxl_memdev *cxlmd,
 
 		ep = cxl_ep_load(iter, cxlmd);
 		ep->next = down;
+		cxl_init_ep_ports_aer(ep);
 	}
 
 	/* Note: endpoint port component registers are derived from @cxlds */
@@ -166,8 +191,6 @@ static int cxl_mem_probe(struct device *dev)
 	else
 		endpoint_parent = &parent_port->dev;
 
-	cxl_setup_parent_dport(dev, dport);
-
 	device_lock(endpoint_parent);
 	if (!endpoint_parent->driver) {
 		dev_err(dev, "CXL port topology %s not enabled\n",
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2085.outbound.protection.outlook.com [40.107.244.85])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8E6E0216444;
	Tue,  8 Oct 2024 22:18:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.85
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425940; cv=fail; b=BJA/EG5msZUWw7QdRV7FKtk1Bn2xAlYTnTfnrExYxZSe8eqj927kUqDw6+ZT8w0zB5Z9pT9ctMxn1XmCuDGFRzBoOaRpb5RuTUCxF3GMRVRMBD2EqfN7OyuybftN0FXatkWbycYnQrwSfWzdmr0CFX5VsngOrJ+UGa7/Zk7qKOA=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425940; c=relaxed/simple;
	bh=n5mqW6CK7reIo+symxOB7Nj8fQWA3uZeEg0DoAwiUd0=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=JlMaj1LxSxXU4xuDqFUnIpsXjNeGrMS9Becbmg3n0MROdRRqa/jYThQXA/A219q9heMSclJQhabdNJL7+Sq5NNJ/e+hK7yLhhknW0cDeexI4OZVLa72fFlTbePoGxhfkf/k/Q/cIDJI3/BMInpAixrpc2bvjDvNPBHH5e/JXhBE=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=QoDa0OzB; arc=fail smtp.client-ip=40.107.244.85
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="QoDa0OzB"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=FO7Z5XxBDkz1SziWX0b+bQe3v2HUHaBiM6EzXcDNT3d1Y175spPgRPwiEZpg7e6glVm1NncN44Kiq051U1HqB4n5bi0f1xXcm/kbpg3vIxEI8q/+XWdkywtxpKxp6nAH976rZvb06RFuWDvg5fMCTC2YYb4kK99zTztZEgXfvFgYUuefsxCRUKQavFylTXU+7BpuVZoZyehbHFqvFq3erzPnPw+P6lvRJiHxLB5j6dzi+SGZzbPNQTRm+4J/Hw4F+1rSNmDIHZYzOXkA29Gku2/RXkqVjhJdDzsyXd4+Tv8FJx/1eOXqHyuaxraxwy2T58+OkXwf50tIm7FpUTbuTQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=8Sbn5U87PdCbAESrXUHWXyxwIM6nvnNs9Q/IwaG2h14=;
 b=FXg7SS7MrB56mzZkIBn8JGvNRw33emN3HPu2vONVspkEgj/FYoSGDGfB+H+27KXBGsGWqKVyn4hEn0jmmXwZIVKuz8M/+vFS9tPqzor8VGU1HPrfPCRHzgNMiShICAvxXja1SIK5gy/VqfLnZ6YWo+3r6AtusfepJR7yKFdvhV7OUf7cn/6Aew+8CB5owsA9FA6gWCbGlFiTOA+OinhGEQ5hW2CCCwwAws0iF6dLKTOdQuIAjMeUbH/ORxCbcr5BrGYPthaz1NLSXikJnuuIpmkaz4VO29A1B8OrBBCnmGdWkSMEbFKAmFPO1B28ZTxDIYXjmoYBiCiKuYT0sarnig==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=8Sbn5U87PdCbAESrXUHWXyxwIM6nvnNs9Q/IwaG2h14=;
 b=QoDa0OzB2PYQntwEaIs6WD/zZKGaUih99Sho8AjEIDz2tsFPL2CqMwMckV7I+n2SMwgiomOf2LnLLNfs/J8SwUp+ZsSSOHKAn+kyD/yifPAt2/JVuA/PE1QUV/ydTGAFh4fy7JjpbPefWPyHsrAdQWmieO1aYmAcH+3RbYxrrJI=
Received: from BLAP220CA0028.NAMP220.PROD.OUTLOOK.COM (2603:10b6:208:32c::33)
 by PH8PR12MB7277.namprd12.prod.outlook.com (2603:10b6:510:223::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.20; Tue, 8 Oct
 2024 22:18:55 +0000
Received: from BN3PEPF0000B073.namprd04.prod.outlook.com
 (2603:10b6:208:32c:cafe::ea) by BLAP220CA0028.outlook.office365.com
 (2603:10b6:208:32c::33) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:18:55 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B073.mail.protection.outlook.com (10.167.243.118) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:18:55 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:18:54 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 10/15] cxl/pci: Map CXL PCIe upstream port RAS registers
Date: Tue, 8 Oct 2024 17:16:52 -0500
Message-ID: <20241008221657.1130181-11-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B073:EE_|PH8PR12MB7277:EE_
X-MS-Office365-Filtering-Correlation-Id: a757d139-0184-4cdc-8283-08dce7e7328b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|36860700013|7416014|376014|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?NRsdfgPeU/+uDInpyGa+Wn/K/9wPfSjxmzuG3xLnHMERqTeTZNx30uzys4FC?=
 =?us-ascii?Q?cBCt/A4HYKiroACafEgdF3fSbs/rNpqyJiYuXyvIoPmsYETPbSbQNHHwYqBr?=
 =?us-ascii?Q?i8cjnMx1UmmHc09CPChRhl1YO890oJ6xFre9VAKo7PBRS4eu/tpRaccRl8x6?=
 =?us-ascii?Q?AEtwVEjzg8dcMvdBlwY9aSCdMuRrWdS92gN4Kl0MuhFvDfKH62GqvEfUhEz/?=
 =?us-ascii?Q?wJew5scpoEWLIO2JlxOujOk05sDtllbJ2zpMepmVqh9+koGpuxBe9hW5YAxf?=
 =?us-ascii?Q?ec8mb5ECI4iZAMGwSjGR98QwPWgHDLYDD4Sry1HB3CV6b9jliJqB2lLJeTbL?=
 =?us-ascii?Q?WyQyGj0HDojA4EFTca6eSG9RTeO6bpmwB35aS0Gu6U8fyADzGXHjCUX0TKFe?=
 =?us-ascii?Q?LYBa48COLtnjJ2nw107jSXpImi/TaL0BBbXCDeHySEg6uvXazNebiilNWUlN?=
 =?us-ascii?Q?l+6Q2r2WhYz74UKr5XTbt3wlsdzQOvbh5Bahe6A6SyC4zAwXyrBvhZQLMr02?=
 =?us-ascii?Q?xmKvZ5C/K3JHemKEN7nLDmoXHC4nw5hy1e1NHjgfnl3rCZBAQ+nKXzvS1Q4C?=
 =?us-ascii?Q?0KUldZmdEcGzych04NMbDW7kthLKvegOg+9hgC+YrjIJd24kj17EzaQdmZKR?=
 =?us-ascii?Q?aMkdU/voLmcDZ8ZI98dPCjV2xs5YlZ3M5A0H/Q10AWRH59hH6MiBjLOP3k/F?=
 =?us-ascii?Q?pURdrkde9/+L3761qx20k/LXLGGs8xgnN20WgeXLOTtNvh6YnnaUWS8YoD/J?=
 =?us-ascii?Q?svFXtqHmC+oyBhC7NO7UqQxl+NqSvicT2G4FShSvl2RQdkFnsyEviH1f9K4q?=
 =?us-ascii?Q?uk+bj8FNJtUyztsgw2Rmr4EhXrsePj83u2ZRyZMU7pTAdgL+HjO2QC6msB8T?=
 =?us-ascii?Q?QBFXlP/FFDzZwbLTV6ps6UU31xOSILAsscHKaZQ9O45GBX/kLwh5Bc0s/8E1?=
 =?us-ascii?Q?5Ce6j0npnJuh1y5qRR9Fay2sMcGYPY0lJdORNUnC0X7svqhAqHK6IhQx494S?=
 =?us-ascii?Q?Lh3DzfQLEG1BpIR9xF0DFEYlnXIM0kr0mJlhUanN0akRcqR8Es/DKNfoEUBf?=
 =?us-ascii?Q?rgRvm1WbOLZhq4InGBROrvp1SRI1MOXbsE4RX3VgFLn69qqZaCPfEmw614bW?=
 =?us-ascii?Q?gv0P7i2StjkVV7ereJVm7WMjS2rFrjImrfZutmnlxobmYC26Xuk9H7Rr7yf1?=
 =?us-ascii?Q?C3GoUr80tXEcF8FOx/0vp7hPo/Rnz75bP0is0Y9gAclH/xfCeRIZQ0U4b0oj?=
 =?us-ascii?Q?yoijMc0w1jhK4Tp6411eMtwqRvMILE1gXSNgqhZmf9QP5zR7/C8lnQ5F2Rhu?=
 =?us-ascii?Q?nkiois7M3yvwLxj42V7XiAMOmokyWf5ELYEn0CtXf7xmcLGgoIhlM9kReCH7?=
 =?us-ascii?Q?eYd3NEUkR1NVSJbGMO1lTZyKvfL0?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(36860700013)(7416014)(376014)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:18:55.0608
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: a757d139-0184-4cdc-8283-08dce7e7328b
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B073.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB7277
Status: O
Content-Length: 2705
Lines: 79

RAS registers are mapped for CXL root ports and CXL downstream but
not for CXL upstream switch ports. CXL upstream switch ports' mapped
RAS registers are required for handling and logging protocol errors.

Introduce 'struct cxl_regs' member into 'struct cxl_port' to store a
pointer to the upstream port's mapped RAS registers.

Map the the CXL upstream switch port's RAS register block.

The upstream port may be have multiple downstream endpoints. Before
mapping AER registers check if the registers are already mapped.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c | 17 +++++++++++++++++
 drivers/cxl/cxl.h      |  2 ++
 drivers/cxl/mem.c      |  3 +++
 3 files changed, 22 insertions(+)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 6f7bcdb389bf..be181358a775 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -816,6 +816,23 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
 	}
 }
 
+void cxl_uport_init_aer(struct cxl_port *port)
+{
+	/* uport may have more than 1 downstream EP. Check if already mapped. */
+	if (port->uport_regs.ras) {
+		dev_warn(&port->dev, "RAS is already mapped\n");
+		return;
+	}
+
+	port->reg_map.host = &port->dev;
+	if (cxl_map_component_regs(&port->reg_map, &port->uport_regs,
+				   BIT(CXL_CM_CAP_CAP_ID_RAS))) {
+		dev_err(&port->dev, "Failed to map RAS capability.\n");
+		return;
+	}
+}
+EXPORT_SYMBOL_NS_GPL(cxl_uport_init_aer, CXL);
+
 void cxl_dport_init_aer(struct cxl_dport *dport)
 {
 	struct device *dport_dev = dport->dport_dev;
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index cb9e05e2912b..7a5f2c33223e 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -764,8 +764,10 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
 
 #ifdef CONFIG_PCIEAER_CXL
 void cxl_dport_init_aer(struct cxl_dport *dport);
+void cxl_uport_init_aer(struct cxl_port *port);
 #else
 static inline void cxl_dport_init_aer(struct cxl_dport *dport) { }
+static inline void cxl_uport_init_aer(struct cxl_port *port) { }
 #endif
 
 struct cxl_decoder *to_cxl_decoder(struct device *dev);
diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
index b7204f010785..82b1383fb6f3 100644
--- a/drivers/cxl/mem.c
+++ b/drivers/cxl/mem.c
@@ -67,6 +67,9 @@ static void cxl_init_ep_ports_aer(struct cxl_ep *ep)
 	if (dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_DOWNSTREAM) ||
 	    dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_ROOT_PORT))
 		cxl_dport_init_aer(dport);
+
+	if (dev_is_cxl_pci(dport->port->uport_dev, PCI_EXP_TYPE_UPSTREAM))
+		cxl_uport_init_aer(dport->port);
 }
 
 static int devm_cxl_add_endpoint(struct device *host, struct cxl_memdev *cxlmd,
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2087.outbound.protection.outlook.com [40.107.237.87])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EFE3218C34D;
	Tue,  8 Oct 2024 22:19:10 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.87
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425952; cv=fail; b=flm8D5hfFJ8Mkoho//5+h7Iu30WxYUWZMVs+/hajglbCbsJ1JoRTBPFYhNkceDizT1boJyCqYln0s2qqLEihOABeIwltZL79jhMeaG2XpPsBeESuczHG3bl5RhRcK0EkOySRVhTOFtWIm0LTWqzfhvtS4LoJYQvekUK/fcJHNdg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425952; c=relaxed/simple;
	bh=x+j0Tkc+Y9G58y00iX85dCYxisy/ach7mi79EWt181w=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=RUvLwBxECzYHh8vhU2CBU68hi1XerOzvqqB0gX0Vsg8sW3xHsR4K/huaciFTC6+Bi0jIybq78nHmE1Rterr4sD2kZvAPKM2C7UVC48qQhJyGeNyxwrIz5yBpUq5a2eOIejghQ+17yuYzjUbkdKc26w9GALPR2/j8zVZ7ksRNHZ4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=l4SH0v4M; arc=fail smtp.client-ip=40.107.237.87
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="l4SH0v4M"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=qY4Yo9rzAFc4cAq2o4VKMs4sOQ/hZiyEVY0qSbChirYQQUAz8zWreAYisacagcJKse3hnNJp1/zeN0BUOiU1dlIc1Hzc5Ufgcsh/p3XQPrD2bMgqMcEYSrb8mSwUA0jvBHLzLq1WEWbUto/pjkKArwy9pVoHKH8sgXuvaT8LzNkdu0OAOkQQLe45ZjVvVlN66oQSCGIBZFcZA7QpnDx+BSxQAJN+3P8Hr8G9rFOlv2QhtnzfUOUqGUgnFiDmAjZNX9JVDb5SLd4ylrOfMzyjpURVkuMO4c+7cNIYzIjvE8vEoqq+XSfiFKondDBn/R31qgDV+ye0SqwPZpjJ6RtcWg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=gGAOPC69NGgnNbFIIELRp/hMlB8yj3IgPCUzsuTIMnE=;
 b=XxOjj5TFnNbnjxgkKisAa/BSG5b/Y1qdJMzjevIkUvgkKJT4vh5bDu0rQ3+MVpX4Kyp/0lz19RSFzzRVvBZUqDGDYeTxi8Snzi+7Lxh7njso558y/URdLRIScsut6tGa/qU2zJgVldFs43/Iz+XlSo3aBH7ZvU+B6LW+cab81UMeH0gHBhA92lDCz5tKQ6+LrEZoY8kUYmi7JpEN/p8ZQlVNNU5XOGKIKakal+nQsfIum9cQOYeeb/DMfmH5C1CtxPNVKK7qWyH4evzzXUD8nFuk8449dgtwDMrKTZ6ffIKAOaX/7t6+4E3m/HqEm+qN/9H8LSUPXqic9t1YiiB64A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=gGAOPC69NGgnNbFIIELRp/hMlB8yj3IgPCUzsuTIMnE=;
 b=l4SH0v4MCSRG3bVjVe057p/NZ/QHScfDyZyhIVs7ePchXC3BtoqU1y3EExX4N942GHSVpBA+0lU5dutVv5hDW9pAks38J1Rz7DD7Keo18gVmW5GDCkd1VDIbkRCaJkSbRr53tpUs9KqMlt3EP31GVVxX9bCNWzSSzLM7YUAAMVc=
Received: from BN8PR04CA0013.namprd04.prod.outlook.com (2603:10b6:408:70::26)
 by CH3PR12MB9145.namprd12.prod.outlook.com (2603:10b6:610:19b::8) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.22; Tue, 8 Oct
 2024 22:19:06 +0000
Received: from BN3PEPF0000B077.namprd04.prod.outlook.com
 (2603:10b6:408:70:cafe::94) by BN8PR04CA0013.outlook.office365.com
 (2603:10b6:408:70::26) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:19:06 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B077.mail.protection.outlook.com (10.167.243.122) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:19:06 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:19:05 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 11/15] cxl/pci: Update RAS handler interfaces to support CXL PCIe ports
Date: Tue, 8 Oct 2024 17:16:53 -0500
Message-ID: <20241008221657.1130181-12-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B077:EE_|CH3PR12MB9145:EE_
X-MS-Office365-Filtering-Correlation-Id: e635509d-a781-405c-b0ca-08dce7e73933
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|376014|82310400026|36860700013|7416014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?gmtzKOkiyuDktIdt054PnfpaIiIi2zSky2X5tHqIAzdTr2wXfMH09ivSY952?=
 =?us-ascii?Q?kytKA9IgcPwn1TX4+47eGGaI23ZEHWLnbmXprsb3cYtc9Zh4eEIrCcUy+D/b?=
 =?us-ascii?Q?XL+YWpJjOAdduLn38zPC4g11cUplyzH8FcH25nqH6/hrUII5iTldRMO0ItIn?=
 =?us-ascii?Q?XXr8nBkEGKV5urbkiMoPcesyhbhcJUEP+O09t9of42JJS8EEXNlMxkfUEH43?=
 =?us-ascii?Q?fx8607lsMqkGhtB6QtHqPG17DEZ+6kFU18Nj5FwW/a6aJyAmAqHNxkTV6Jji?=
 =?us-ascii?Q?Uf4jCXDyQwTu6dFvkhly7iXbjHT/wfkjyNe89TTKyBrEsYXeR6EPOSivKEDl?=
 =?us-ascii?Q?oisY350uQ8RqAgr2DFJOW6HT4DHhjM+A0MjK4og2Idjm8f9g46Aywjkcf+2P?=
 =?us-ascii?Q?e4/uKub8xleGEegsVEs0dtA7azGgkUcbKwuTiM0dMdMvx4ZI4szDn+RDraJg?=
 =?us-ascii?Q?z/MtN8GxIWFlqIL3TseiX05DrgYf+/nnUCydci9JFj2PcXv3kJVEfzW+eWhr?=
 =?us-ascii?Q?HLRm2oIH9a5Yhj4+yn7PXr/bI4WLlwfqdfwkKK0PCb8EqgY0LNotV8d4gytK?=
 =?us-ascii?Q?WKPNKZHrGQT0XXbi6ZTvAwFW4GSmkbNwGxzhkHitrKneoYWZcUtQMOV2pLpI?=
 =?us-ascii?Q?9yrbJ686JlRDBbGD2NzjVQrmzuY3FRXfMffc61MJhA0qK1V14/VndJsY2sig?=
 =?us-ascii?Q?r5OX0aR0nO/TzzW0UpJ1pQ/IRWHEv+V1oYkc78HVzsaOOXZ55K9ShRrTy5L4?=
 =?us-ascii?Q?V0Gov5p6jx6iVrhnxe232fpYUc0yWD2hgBBjBxgsptNUauNkblbTvOlYKHfn?=
 =?us-ascii?Q?QNcH+gylxB25wld+pJ6v6Z57MZUTsEjnpaUMeW1VESFZN7h9hguf1n5UpPnL?=
 =?us-ascii?Q?GZZ1afgLS614KAgEUQHngH5Ci5dn465R9CrWmnqD73Sd2osg+0aGmFc9EP4C?=
 =?us-ascii?Q?GM4AO4SZ/k4bNuoDHx+cE33UkrpqRW83PqrmqjyhrXLo/0Q4X2wDXHmwjhaL?=
 =?us-ascii?Q?7yWIovlH3XezkyTtN8fhFya3s+VDgmM1HMCmHsVwyZ8GG963zpARTqPJwc7A?=
 =?us-ascii?Q?Re9BpnzietXdHcLWOToeOqvtgygehZeaJiluLIrQGCJVeRSxki+iqk210oRY?=
 =?us-ascii?Q?lrrJyaE1LPeLc6B275vifX4Y+eQZfkYvfCYSI1ziUIgYD6/P5VmfWVEOpn/+?=
 =?us-ascii?Q?eZlsh3ZVWv0Sfr3C04TvXLiMcfdzW92RlzKTwEZgWzqzSCE9pHhrmSBObSfM?=
 =?us-ascii?Q?Qbyf+BRgA7avgBqCoLMIYTUd148zTW7S5tn3Bj1k9JM9CmRviPj/VstVjeB5?=
 =?us-ascii?Q?U62WwEUavV7aWOLV12/7xRzhZ2mXlCRgA0LTWfQksSXND8S+pXLgLaEYmrZA?=
 =?us-ascii?Q?01Ob8bwcfbCo9a2/V3w0YzQ1z0FT?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(376014)(82310400026)(36860700013)(7416014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:19:06.2137
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: e635509d-a781-405c-b0ca-08dce7e73933
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B077.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR12MB9145
Status: O
Content-Length: 3510
Lines: 99

CXL PCIe port protocol error handling support will be added to the
CXL drivers in the future. In preparation, refactor the existing
interfaces to support handling all CXL PCIe port protocol errors.

The driver's RAS support functions currently rely on a 'struct
cxl_dev_state' type parameter, which is not available for CXL port
devices. However, since the same CXL RAS capability structure is
needed across most CXL components and devices, a common handling
approach should be adopted.

To accommodate this, update the __cxl_handle_cor_ras() and
__cxl_handle_ras() functions to use a `struct device` instead of
`struct cxl_dev_state`.

No functional changes are introduced.

[1] CXL3.1 - 8.2.4 CXL.cache and CXL.mem Registers

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c | 17 ++++++++---------
 1 file changed, 8 insertions(+), 9 deletions(-)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index be181358a775..c3c82c051d73 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -686,7 +686,7 @@ void read_cdat_data(struct cxl_port *port)
 }
 EXPORT_SYMBOL_NS_GPL(read_cdat_data, CXL);
 
-static void __cxl_handle_cor_ras(struct cxl_dev_state *cxlds,
+static void __cxl_handle_cor_ras(struct device *dev,
 				 void __iomem *ras_base)
 {
 	void __iomem *addr;
@@ -699,13 +699,13 @@ static void __cxl_handle_cor_ras(struct cxl_dev_state *cxlds,
 	status = readl(addr);
 	if (status & CXL_RAS_CORRECTABLE_STATUS_MASK) {
 		writel(status & CXL_RAS_CORRECTABLE_STATUS_MASK, addr);
-		trace_cxl_aer_correctable_error(cxlds->cxlmd, status);
+		trace_cxl_aer_correctable_error(to_cxl_memdev(dev), status);
 	}
 }
 
 static void cxl_handle_endpoint_cor_ras(struct cxl_dev_state *cxlds)
 {
-	return __cxl_handle_cor_ras(cxlds, cxlds->regs.ras);
+	return __cxl_handle_cor_ras(&cxlds->cxlmd->dev, cxlds->regs.ras);
 }
 
 /* CXL spec rev3.0 8.2.4.16.1 */
@@ -729,8 +729,7 @@ static void header_log_copy(void __iomem *ras_base, u32 *log)
  * Log the state of the RAS status registers and prepare them to log the
  * next error status. Return 1 if reset needed.
  */
-static bool __cxl_handle_ras(struct cxl_dev_state *cxlds,
-				  void __iomem *ras_base)
+static bool __cxl_handle_ras(struct device *dev, void __iomem *ras_base)
 {
 	u32 hl[CXL_HEADERLOG_SIZE_U32];
 	void __iomem *addr;
@@ -757,7 +756,7 @@ static bool __cxl_handle_ras(struct cxl_dev_state *cxlds,
 	}
 
 	header_log_copy(ras_base, hl);
-	trace_cxl_aer_uncorrectable_error(cxlds->cxlmd, status, fe, hl);
+	trace_cxl_aer_uncorrectable_error(to_cxl_memdev(dev), status, fe, hl);
 	writel(status & CXL_RAS_UNCORRECTABLE_STATUS_MASK, addr);
 
 	return true;
@@ -765,7 +764,7 @@ static bool __cxl_handle_ras(struct cxl_dev_state *cxlds,
 
 static bool cxl_handle_endpoint_ras(struct cxl_dev_state *cxlds)
 {
-	return __cxl_handle_ras(cxlds, cxlds->regs.ras);
+	return __cxl_handle_ras(&cxlds->cxlmd->dev, cxlds->regs.ras);
 }
 
 #ifdef CONFIG_PCIEAER_CXL
@@ -865,13 +864,13 @@ EXPORT_SYMBOL_NS_GPL(cxl_dport_init_aer, CXL);
 static void cxl_handle_rdport_cor_ras(struct cxl_dev_state *cxlds,
 					  struct cxl_dport *dport)
 {
-	return __cxl_handle_cor_ras(cxlds, dport->regs.ras);
+	return __cxl_handle_cor_ras(&cxlds->cxlmd->dev, dport->regs.ras);
 }
 
 static bool cxl_handle_rdport_ras(struct cxl_dev_state *cxlds,
 				       struct cxl_dport *dport)
 {
-	return __cxl_handle_ras(cxlds, dport->regs.ras);
+	return __cxl_handle_ras(&cxlds->cxlmd->dev, dport->regs.ras);
 }
 
 /*
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (mail-mw2nam10on2060.outbound.protection.outlook.com [40.107.94.60])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 013E121503B;
	Tue,  8 Oct 2024 22:19:21 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.94.60
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425963; cv=fail; b=uaqWCzU3xPL463tS3iobfw+I7+Upd+sgNouKSa/pjzVCVF+GmOctEZX3nYB4Tq1B5CQHeVGJsCMu4duZMyrNxYzlyEg9YN/ATQTIxZMc+hYwOTLunmMdkJCkHtZQum9IFGArNmhZs9IAxAPjn9VwddvMP1Xpf40qtUiI/fZ5M3M=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425963; c=relaxed/simple;
	bh=GINvX/OHL84YEe4kS7yrZoMXhd5D0jOEt5jDC/9Ml/M=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=jNZeSwP7/j2WwGek15AwV+gSa3C55mEfOqm+DShLuhawOmSgsti1OFvy8aSDUcM3+q9gbNTpwfS3qL2RCwzAcCxwEDEdysqX9pDfnvqi78wHJE/nHVk4D/9YcJydASlyEcT6lBC6Le0eSF4KA87RnO2M9V4bXllnMWq5qXxL63U=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=DWoZWGwl; arc=fail smtp.client-ip=40.107.94.60
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="DWoZWGwl"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=yFKDY/dFGyRQZ+leCVbtEZnA5roK8JrmydzhPmzJYA87P0QqOYbDvURV7IkPyMiHC3rxJ8KLk75SszR8LSFmLLloWzbJlPNt+9IU/7sZMfT/Frpx7tkqwaYgY4uByrAAUfl4MuTpB/2ch+89iqQ/uoY8YXkueqFuejqQ+/I5pETTfUUb3MHub0Irp8p6uzcpwv36JBktCwYuSKBcKsoHhPA/SjSXyGeaAj6tYDIsUyWmKJm36BlHApkthDPktx1xVtsPcjmPLkYmrprqtTc71LBPr1xCpmcKb/qh13xnKFTwv6iFNYbh08RihgILLBU8VzOIJVAw9z1P0+kvllnzYA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=qyYdsHelXD/nU7DKZRelNExa46da8MbLvFPrf/G15TQ=;
 b=Uz5JiOeqBjwS9yOwdjGNqzJW/BggPJfKZpsjk2FUWvKyXCe1VK7RCIfgf3NjTU7lHJVmjCkCVZMzv8TEsNzQ7ZNpV7+ybRQr8qbnqk+MsA+ZIMajnflFU872v/wI6n3hK8bw/eD42WjwOXrfumMmnEjl541xvmYgFAAhyKetO8hz9ey1aQLDTpjOvto+xS+gu6Xq52SPGGB1v551CZPDKXFror2mc14kRme5w1BFqtXWEYsa5wYYCdEXrbPACR/X8NaMEBDRaYQhWMHc77ojTqLSIfIESEsoG7LJ+eh9wkpOKDCz/KeSpKmRNnVfgbobE0dLOPcfPItKmO9ee77qGw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=qyYdsHelXD/nU7DKZRelNExa46da8MbLvFPrf/G15TQ=;
 b=DWoZWGwlyjl3Y39hGgxyAvsmOWNtIB/6kpGDEqaYb1tnueM1caopvH6porglPUAsoIgh0SVctrV1xQOWUGeGsuRN80EyHj5WMpEt3aDhXENoONWZBMpUF1XwtqmyI2Ac2PZYzvn7grl8FNj6LrNspkEO4Fn+vW7Nr7VSBgC0D9s=
Received: from BLAPR03CA0085.namprd03.prod.outlook.com (2603:10b6:208:329::30)
 by BY5PR12MB4084.namprd12.prod.outlook.com (2603:10b6:a03:205::14) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:19:18 +0000
Received: from BN3PEPF0000B078.namprd04.prod.outlook.com
 (2603:10b6:208:329:cafe::d8) by BLAPR03CA0085.outlook.office365.com
 (2603:10b6:208:329::30) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:19:17 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B078.mail.protection.outlook.com (10.167.243.123) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:19:17 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:19:16 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 12/15] cxl/pci: Add error handler for CXL PCIe port RAS errors
Date: Tue, 8 Oct 2024 17:16:54 -0500
Message-ID: <20241008221657.1130181-13-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B078:EE_|BY5PR12MB4084:EE_
X-MS-Office365-Filtering-Correlation-Id: 29edf4d0-e21d-4360-a11e-08dce7e73fd9
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|36860700013|376014|82310400026|7416014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?sGFna7S+qN0f4pLFP/AQs776cXUZQPYWYoWCv3OPz1CkLjuemzNAAGD/3ArD?=
 =?us-ascii?Q?AaLlcqZorWWACxEl05AthGMERoDEUIVEisj6DwSxIgEn7ALPW+oC5gmjwGNU?=
 =?us-ascii?Q?ZmfCJsoMwkzfi5tpI0hz4RU1HMuwVp2cXvuZ/mjP4DN/ikbtmSL37Gb2AVNM?=
 =?us-ascii?Q?3qvMgSXy/hy232MX7tz8OKBIZ9Zaq/0s0RHo3KXpAZjr9Uz4OyWDs7lMiVgz?=
 =?us-ascii?Q?pOOY9I2+EEpbQlqkrlfDiR2bib+tSG/hfQu+/xYEM8swDvhIfweIQPGtN7EE?=
 =?us-ascii?Q?V9XiZrUahA5/WjOA60ocOoRT6QXjq+biJBpykV5maWtHFGXJgb4C0i+M0fZQ?=
 =?us-ascii?Q?wJRjzk3N3iSIHyDtR3MP0ePdR2uhdqQyiCFP8dPT0nWnAGHMPC6rjNQVsSzr?=
 =?us-ascii?Q?p2AxVb8l2uPuMj8kea5rn3Yorw99yrTTc5mjIMWYdXr9yIf4K8D9gHrhhukq?=
 =?us-ascii?Q?O93NtFByi1NEv9AeQEOtLgdRUBiRl0u1m4pp/K0GodVJnqlVC22KcPeFn5QL?=
 =?us-ascii?Q?aZzHBSvfkIEztqWTMu3hiuwthE2vO5woF5/yk1VXalk5KxMVnlVegpiU6iTB?=
 =?us-ascii?Q?9BadPv4mzxv/5vU3Taqd17wWrDP2RqfWpAH4eBYCYvu43TGJ5F9uzaeh3/1a?=
 =?us-ascii?Q?MLWen64FanGRrYRdt6eaU6/ekdLa/1xWf6g7+nNbMJ8OGk7PQ64C3egxsQD1?=
 =?us-ascii?Q?bQnz+leEbYubECn+AyNxzG0/qGIVSersUWZIVo62Eh2HmIxeFacbtrxOQfvM?=
 =?us-ascii?Q?Cf050eUsxHQ8SueiXem6/5tpVD5zvz974L9OXl6jnXNJDrKUjY5tagQhULtd?=
 =?us-ascii?Q?TTSAlrywfmqpi4v61Ei2feZ4VhA6TQJOY8RjY0K6RfB9XoCeCV4WH2SFHAhq?=
 =?us-ascii?Q?wjUXgaU5T0/r3Syif7bK6Qy2qYVDX/2GmKBFsznuRiGSQhRo5b0qg9KyT7EF?=
 =?us-ascii?Q?u3o6m8HJ5VpdiAOjqjtkvHkAfYa38BgL3rhOfpBwdDQzEwuwfWritbdPt6bV?=
 =?us-ascii?Q?u+h/oOLHMGZU+Q1982nPJaaMWPG5By4QlFFTsPbyEtO5FVimy+H+m4uBoVrw?=
 =?us-ascii?Q?kVNNWcmZwnA4GaSzflOxCDNwNHk6qD3q0rH4ifPnm22oOQSdPXhLT0B8G30A?=
 =?us-ascii?Q?jecTUe3p+KprIuEjiCpC8gZcqreCQwFQHFuPaFxLg7KLEvLOAyWBqqgfgKOt?=
 =?us-ascii?Q?J10CSIjyG5PD2D9xnfZuX4C6dbjFats8OIHYCvWfwaCQdHhjX5kJP1Gq4Cma?=
 =?us-ascii?Q?B/qjoemADyZ7eTlvjXPayg/oLwFqlN6mHK5GLreQJMG7CbbvBehnSBHKxjy3?=
 =?us-ascii?Q?QVMaKDfNm23A6jTDMerTqMGtIsQ/6G6rA0r2Q3eOkbvHoPk5ny2XuggGN/wq?=
 =?us-ascii?Q?Lp+xPJYYKkZm4rMKfnAZNpUitkJr?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(36860700013)(376014)(82310400026)(7416014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:19:17.3675
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 29edf4d0-e21d-4360-a11e-08dce7e73fd9
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B078.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BY5PR12MB4084
Status: O
Content-Length: 5131
Lines: 175

The CXL drivers do not contain error handlers for CXL PCIe port
device protocol errors. These are needed in order to handle and log
RAS protocol errors.

Add CXL PCIe port protocol error handlers to the CXL driver.

Provide access to RAS registers for the specific CXL PCIe port types:
root port, upstream switch port, and downstream switch port.

Also, register and unregister the CXL PCIe port error handlers with
the AER service driver using register_cxl_port_err_hndlrs() and
unregister_cxl_port_err_hndlrs(). Invoke the registration from
cxl_pci_driver_init() and the unregistration from cxl_pci_driver_exit().

[1] CXL3.1 - 12.2.2 CXL Root Ports, Downstream Switch Ports, and
             Upstream Switch Ports

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c | 83 ++++++++++++++++++++++++++++++++++++++++++
 drivers/cxl/cxl.h      |  5 +++
 drivers/cxl/pci.c      |  8 ++++
 3 files changed, 96 insertions(+)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index c3c82c051d73..7e3770f7a955 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -815,6 +815,89 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
 	}
 }
 
+static int match_uport(struct device *dev, const void *data)
+{
+	struct device *uport_dev = (struct device *)data;
+	struct cxl_port *port;
+
+	if (!is_cxl_port(dev))
+		return 0;
+
+	port = to_cxl_port(dev);
+
+	return port->uport_dev == uport_dev;
+}
+
+static void __iomem *cxl_pci_port_ras(struct pci_dev *pdev)
+{
+	void __iomem *ras_base;
+	struct cxl_port *port;
+
+	if (!pdev)
+		return NULL;
+
+	if ((pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT) ||
+	    (pci_pcie_type(pdev) == PCI_EXP_TYPE_DOWNSTREAM)) {
+		struct cxl_dport *dport;
+
+		port = find_cxl_port(&pdev->dev, &dport);
+		ras_base = dport ? dport->regs.ras : NULL;
+		put_device(&port->dev);
+		return ras_base;
+	} else if (pci_pcie_type(pdev) == PCI_EXP_TYPE_UPSTREAM) {
+		struct device *port_dev __free(put_device);
+
+		port_dev = bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport);
+		if (!port_dev)
+			return NULL;
+
+		port = to_cxl_port(port_dev);
+		if (!port)
+			return NULL;
+
+		ras_base = port ? port->uport_regs.ras : NULL;
+		return ras_base;
+	}
+
+	return NULL;
+}
+
+void cxl_cor_port_err_detected(struct pci_dev *pdev)
+{
+	void __iomem *ras_base = cxl_pci_port_ras(pdev);
+
+	__cxl_handle_cor_ras(&pdev->dev, ras_base);
+}
+EXPORT_SYMBOL_NS_GPL(cxl_cor_port_err_detected, CXL);
+
+pci_ers_result_t cxl_port_err_detected(struct pci_dev *pdev, pci_channel_state_t state)
+{
+	void __iomem *ras_base = cxl_pci_port_ras(pdev);
+	bool ue;
+
+	ue = __cxl_handle_ras(&pdev->dev, ras_base);
+	if (ue)
+		return PCI_ERS_RESULT_PANIC;
+
+	switch (state) {
+	case pci_channel_io_normal:
+		dev_err(&pdev->dev, "%s():%d: pci_channel_io_normal\n",
+			__func__, __LINE__);
+		return PCI_ERS_RESULT_CAN_RECOVER;
+	case pci_channel_io_frozen:
+		dev_err(&pdev->dev, "%s():%d: pci_channel_io_frozen\n",
+			__func__, __LINE__);
+		return PCI_ERS_RESULT_NEED_RESET;
+	case pci_channel_io_perm_failure:
+		dev_err(&pdev->dev, "%s():%d: pci_channel_io_perm_failure\n",
+			__func__, __LINE__);
+		return PCI_ERS_RESULT_DISCONNECT;
+	}
+
+	return PCI_ERS_RESULT_NEED_RESET;
+}
+EXPORT_SYMBOL_NS_GPL(cxl_port_err_detected, CXL);
+
 void cxl_uport_init_aer(struct cxl_port *port)
 {
 	/* uport may have more than 1 downstream EP. Check if already mapped. */
diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
index 7a5f2c33223e..06fcde4b88b5 100644
--- a/drivers/cxl/cxl.h
+++ b/drivers/cxl/cxl.h
@@ -10,6 +10,7 @@
 #include <linux/bitops.h>
 #include <linux/log2.h>
 #include <linux/node.h>
+#include <linux/pci.h>
 #include <linux/io.h>
 
 extern const struct nvdimm_security_ops *cxl_security_ops;
@@ -901,6 +902,10 @@ void cxl_coordinates_combine(struct access_coordinate *out,
 
 bool cxl_endpoint_decoder_reset_detected(struct cxl_port *port);
 
+pci_ers_result_t cxl_port_err_detected(struct pci_dev *pdev,
+				       pci_channel_state_t state);
+void cxl_cor_port_err_detected(struct pci_dev *pdev);
+
 /*
  * Unit test builds overrides this to __weak, find the 'strong' version
  * of these symbols in tools/testing/cxl/.
diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index 4be35dc22202..9179b34c35bb 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -978,6 +978,11 @@ static void cxl_reset_done(struct pci_dev *pdev)
 	}
 }
 
+static struct cxl_port_err_hndlrs cxl_port_hndlrs = {
+	.error_detected = cxl_port_err_detected,
+	.cor_error_detected = cxl_cor_port_err_detected
+};
+
 static const struct pci_error_handlers cxl_error_handlers = {
 	.error_detected	= cxl_error_detected,
 	.slot_reset	= cxl_slot_reset,
@@ -1054,11 +1059,14 @@ static int __init cxl_pci_driver_init(void)
 	if (rc)
 		pci_unregister_driver(&cxl_pci_driver);
 
+	register_cxl_port_hndlrs(&cxl_port_hndlrs);
+
 	return rc;
 }
 
 static void __exit cxl_pci_driver_exit(void)
 {
+	unregister_cxl_port_hndlrs();
 	cxl_cper_unregister_work(&cxl_cper_work);
 	cancel_work_sync(&cxl_cper_work);
 	pci_unregister_driver(&cxl_pci_driver);
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2081.outbound.protection.outlook.com [40.107.243.81])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 31DD921503B;
	Tue,  8 Oct 2024 22:19:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.81
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425972; cv=fail; b=h8BRGJuXjlWILfXbtxINbfIcUo13vYNpK1gQLaLsTSjZNNF3wO7h+FtzjboJTDvLGJekADZxaegL4Jr5ZoWR5zoygkBgmxOXFrTvGpvZFt8Kj1FpnSg3grgczvSglS9vfK2Myi7i2Qc1A2KZa6xaArhcRCPIi+HyDMlCzq6uSGc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425972; c=relaxed/simple;
	bh=JrXreU8bAVYSLae02dgo+C2Q1O9B1VPtNz8E5rdCVF8=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=aw0k3qMDVMgcJUq2TxYTR2CS2SUu/0AzHwjzPWGoSd9TrZtNaZZGKcru5gthrgbTgl0C3lYZo5Nnr/Ka9fWfppfbU00yMl0drTfgz+auHWlRfnNymVihzCqh0rBMPom/dzWJCEtCJX15x6DVZ+LXOvxJRiXseCF+JckVwJlIwXQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=vwR3gW7A; arc=fail smtp.client-ip=40.107.243.81
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="vwR3gW7A"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=tKoYwWnTN0fsoiq8xs/j2/TcnLeJ7GQQpRxd0iJJrt63W8foqXQ/BZV/Kb98EEPWm2Zm0UbnOhnBgi2pGIWrqQ3zqpcNht5Dghg7bu4LkYVxdaQJVghguAxpQnOurKuD+zSwRuAWZRLKOtl/w879unsLbqwN58aqQuVV+891UvAeE5h+ed/WUoE9WPV1HZ38uTAujZPAasixg5ZLKl1P0aajB8RasfiqQV9ldNsIYLfH/ZgLkia+RyXX8RMxg5MNJAofe0qJTc6J4aOUHqFVf9hsRgLCqg0IJTc66DorobQkiJzwZlslNXilzV7t/8wKdGeagIRqbLTL1BOf1A5k4g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=baLU/8n16ZjbbGjYZ9V333EBUkQ5W1UUAvVlCOa2Jhs=;
 b=oV+7JGyiugbtOOs6mFifMEbncgbGHHjFQfgQyR4yzcSJznMIgs+sGwansmDCkQpK8U8As5p4H7LGqTvpWfX6tWnLi0zYAERh28a/SwWcFGhBZCTGaygtcb3wbs64ckR5G5Ya/FNaD66Qv4ceHBF2LAj5edfUH0Tbx5Zc0n1t82EZzKR1oaUmd0GmK9YcrQCPq8DJ7pZnRruTFoUTOJBjuN21LS36diydDZSb4drnzQk089Fn7/wLDoTagRoI7D2b/y7zjQAyT9xDEvNl4HAhFj9Czb2CmZkB5KTjE7BpTC+OBGPpdzFG/Q27JWFWlOzjslPwzhlmxjAQ9pUrXQXbCA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=baLU/8n16ZjbbGjYZ9V333EBUkQ5W1UUAvVlCOa2Jhs=;
 b=vwR3gW7AHzEw2HpIVo0KjECJ9CZrU98Rtzlp53K9Xju6Dyf90q2MHxwH4G1UU1Obr8w9YeLb4rInpnLu2LwlOVO5L3TZNywvB8bb9gnx1DW/QvR94y7337Z9kdBice1UeU0HwOagBrCAIPfwAMz/9R3IVy32Vpjp3SNQO3F3DJs=
Received: from BLAPR05CA0042.namprd05.prod.outlook.com (2603:10b6:208:335::22)
 by IA0PR12MB8326.namprd12.prod.outlook.com (2603:10b6:208:40d::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.16; Tue, 8 Oct
 2024 22:19:28 +0000
Received: from BN3PEPF0000B074.namprd04.prod.outlook.com
 (2603:10b6:208:335:cafe::2) by BLAPR05CA0042.outlook.office365.com
 (2603:10b6:208:335::22) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.17 via Frontend
 Transport; Tue, 8 Oct 2024 22:19:28 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B074.mail.protection.outlook.com (10.167.243.119) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:19:28 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:19:27 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 13/15] cxl/pci: Add trace logging for CXL PCIe port RAS errors
Date: Tue, 8 Oct 2024 17:16:55 -0500
Message-ID: <20241008221657.1130181-14-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B074:EE_|IA0PR12MB8326:EE_
X-MS-Office365-Filtering-Correlation-Id: 2d056cbb-ef32-4b20-31ea-08dce7e7467a
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|36860700013|1800799024|82310400026|7416014|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?SSCA244ozanzgReeL6O0rNBuh8byD/8n4GSCm+hylyU2I7nGbcuxvGeAYR6N?=
 =?us-ascii?Q?hD9NL0nZ1SSdo8uO5CrHiI+YBx7on5FQHI7eAfRoOTYQhweHLquR8oZRX0zj?=
 =?us-ascii?Q?Z/64Qulfw/yhbW+sETyFtRwxOByKBqkf98yOuWu+kjOT17kj856MdY1g3CUB?=
 =?us-ascii?Q?QSuRI7B61YS8yw0qW2J5vSBVQCJDDmjaX+2gTzslNqQZGThfpJo7vejVSIPD?=
 =?us-ascii?Q?55W8+wlrzXXa1K+fs2u+xY6n2HBHb5UWLakBxrLEvviCmDJ6QBns64EIVvZ5?=
 =?us-ascii?Q?bEjsl3Tlx5byBI4cjr9os86sA3TiOLu8c4c158SNXtdEQVqsE8RchwAZgaKp?=
 =?us-ascii?Q?4CHZIQ4hSgZLRukFUHEOcBsQ4v8J0EJeMI9ErTQemNwG1mH1P06vTHs6RMuu?=
 =?us-ascii?Q?TTGnP9dnFosIH66JgMU5Fjj5ApiNfhErs9IxxZ6/JxeC0Gc/nsG6lw98P0dC?=
 =?us-ascii?Q?oDVg/Tx3g4qOIGhH3q5DqLUktyE0eO39zw1fMoIk6UfMFtvYAIgH505D8Otn?=
 =?us-ascii?Q?9uh1wPBFkUfyxMwQJcScblpV6lyYHlt6BVovk0xS0MkJ6ESzDtx2pkZCOvjl?=
 =?us-ascii?Q?JdDzMiGMYFWmUOfnnS7YfUwGMX0QKwgP8x1918jD+eZEaHiFa6BCciTp1qu6?=
 =?us-ascii?Q?kM3pqGFrqMJF2zie7ZQaH6KgLrJNJC8D3vadmNZFqVv5lx7M4wGzqRhAl3nC?=
 =?us-ascii?Q?KUOYxBt/qmyNh+tbKMCuvM8V5p2LzyCu8hLgq4qLtCynQ8dmJYLY4fpS2zJR?=
 =?us-ascii?Q?MuxFye/Ci+zKh/Em3OCQ9PMgWyet7Cc+bsJQcuVSmhzv/UpdtK8tjunT+Kfg?=
 =?us-ascii?Q?RQJk0ZV/zOjRWJTK/HIBF4qqf/PUOPS+wkeREBYwfHtdIybuWCidUW6q8iup?=
 =?us-ascii?Q?CWm+/wXg1T6/rcgmpAqU0wTRHZAalty2Mr3nuuGOzroQTASA5w6qZxjiBfiq?=
 =?us-ascii?Q?obwldmzU0QiJajO1qhYqnGfYLaVF8E1Gq5eLiSmOrtuJLCjvlpkXLP2w1yWk?=
 =?us-ascii?Q?HZt654DZ7QyH9X5AewE6FlZhfFwBI6pVjL4r8uCDyo7JZnqnfvuQDh/EZ0ed?=
 =?us-ascii?Q?ndu6xGcEE8yu4Mkua2Q//zAlPLpjtk4CTmWIeMZF3XfS/3XfyjIwpnUVDSJ9?=
 =?us-ascii?Q?hSINA+nfAuhBF6gHvxDFiBS3tYH7rve+9zxGGkxyFVD6KklGb+vbGs736pQi?=
 =?us-ascii?Q?pIZQKCJGUthdd5kvzIik7XxH7Bl2/NuXyqB5zZS90D1PSWYw8GNVds73lWRj?=
 =?us-ascii?Q?pfYySzBawTjVPbSngokvaGwNe7wVgAp7U8Ggcopb77b7aJVnu2rVNy5EzyZQ?=
 =?us-ascii?Q?3Q/2BOIrJSYVJcLIWu13pH5bowRCmFaShdjbSPXh/nmpI4QyoLtFtVcOBfJF?=
 =?us-ascii?Q?MxDawJZQinOFS7+ksY6i5QyG5a5w?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(36860700013)(1800799024)(82310400026)(7416014)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:19:28.4861
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 2d056cbb-ef32-4b20-31ea-08dce7e7467a
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B074.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB8326
Status: O
Content-Length: 3925
Lines: 118

The CXL drivers use kernel trace functions for logging endpoint and
RCH downstream port RAS errors. However, similar functionality is
required for CXL root ports, CXL downstream switch ports, and CXL
upstream switch ports.

Introduce trace logging functions for both RAS correctable and
uncorrectable errors specific to CXL PCIe ports. Additionally, update
the PCIe port error handlers to invoke these new trace functions.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c   | 16 ++++++++++----
 drivers/cxl/core/trace.h | 47 ++++++++++++++++++++++++++++++++++++++++
 2 files changed, 59 insertions(+), 4 deletions(-)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 7e3770f7a955..4706113d2582 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -697,10 +697,14 @@ static void __cxl_handle_cor_ras(struct device *dev,
 
 	addr = ras_base + CXL_RAS_CORRECTABLE_STATUS_OFFSET;
 	status = readl(addr);
-	if (status & CXL_RAS_CORRECTABLE_STATUS_MASK) {
-		writel(status & CXL_RAS_CORRECTABLE_STATUS_MASK, addr);
+	if (!(status & CXL_RAS_CORRECTABLE_STATUS_MASK))
+		return;
+	writel(status & CXL_RAS_CORRECTABLE_STATUS_MASK, addr);
+
+	if (is_cxl_memdev(dev))
 		trace_cxl_aer_correctable_error(to_cxl_memdev(dev), status);
-	}
+	else if (dev_is_pci(dev))
+		trace_cxl_port_aer_correctable_error(dev, status);
 }
 
 static void cxl_handle_endpoint_cor_ras(struct cxl_dev_state *cxlds)
@@ -756,7 +760,11 @@ static bool __cxl_handle_ras(struct device *dev, void __iomem *ras_base)
 	}
 
 	header_log_copy(ras_base, hl);
-	trace_cxl_aer_uncorrectable_error(to_cxl_memdev(dev), status, fe, hl);
+	if (is_cxl_memdev(dev))
+		trace_cxl_aer_uncorrectable_error(to_cxl_memdev(dev), status, fe, hl);
+	else if (dev_is_pci(dev))
+		trace_cxl_port_aer_uncorrectable_error(dev, status, fe, hl);
+
 	writel(status & CXL_RAS_UNCORRECTABLE_STATUS_MASK, addr);
 
 	return true;
diff --git a/drivers/cxl/core/trace.h b/drivers/cxl/core/trace.h
index 9167cfba7f59..6305c0eea627 100644
--- a/drivers/cxl/core/trace.h
+++ b/drivers/cxl/core/trace.h
@@ -48,6 +48,34 @@
 	{ CXL_RAS_UC_IDE_RX_ERR, "IDE Rx Error" }			  \
 )
 
+TRACE_EVENT(cxl_port_aer_uncorrectable_error,
+	    TP_PROTO(struct device *dev, u32 status, u32 fe, u32 *hl),
+	TP_ARGS(dev, status, fe, hl),
+	TP_STRUCT__entry(
+		__string(devname, dev_name(dev))
+		__string(host, dev_name(dev->parent))
+		__field(u32, status)
+		__field(u32, first_error)
+		__array(u32, header_log, CXL_HEADERLOG_SIZE_U32)
+	),
+	TP_fast_assign(
+		__assign_str(devname);
+		__assign_str(host);
+		__entry->status = status;
+		__entry->first_error = fe;
+		/*
+		 * Embed the 512B headerlog data for user app retrieval and
+		 * parsing, but no need to print this in the trace buffer.
+		 */
+		memcpy(__entry->header_log, hl, CXL_HEADERLOG_SIZE);
+	),
+	TP_printk("device=%s host=%s status: '%s' first_error: '%s'",
+		  __get_str(devname), __get_str(host),
+		  show_uc_errs(__entry->status),
+		  show_uc_errs(__entry->first_error)
+	)
+);
+
 TRACE_EVENT(cxl_aer_uncorrectable_error,
 	TP_PROTO(const struct cxl_memdev *cxlmd, u32 status, u32 fe, u32 *hl),
 	TP_ARGS(cxlmd, status, fe, hl),
@@ -96,6 +124,25 @@ TRACE_EVENT(cxl_aer_uncorrectable_error,
 	{ CXL_RAS_CE_PHYS_LAYER_ERR, "Received Error From Physical Layer" }	\
 )
 
+TRACE_EVENT(cxl_port_aer_correctable_error,
+	TP_PROTO(struct device *dev, u32 status),
+	TP_ARGS(dev, status),
+	TP_STRUCT__entry(
+		__string(devname, dev_name(dev))
+		__string(host, dev_name(dev->parent))
+		__field(u32, status)
+	),
+	TP_fast_assign(
+		__assign_str(devname);
+		__assign_str(host);
+		__entry->status = status;
+	),
+	TP_printk("device=%s host=%s status='%s'",
+		  __get_str(devname), __get_str(host),
+		  show_ce_errs(__entry->status)
+	)
+);
+
 TRACE_EVENT(cxl_aer_correctable_error,
 	TP_PROTO(const struct cxl_memdev *cxlmd, u32 status),
 	TP_ARGS(cxlmd, status),
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2045.outbound.protection.outlook.com [40.107.236.45])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 253FF216429;
	Tue,  8 Oct 2024 22:19:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.45
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425986; cv=fail; b=fAMbJcnqPhYLHQ6DFnYxyulxElIrdNLzCMTmFJ90F46AZ5d+YEAj5M0nABONDpeFRlOx+++/v6KEKkFkfZFIJSSgXsxSiRicp0uiWpbOl9Oe7mdHDRfRSReBZNvIhcS17kIhK53xhJycDrs/okyDD8/1jVV6llmfFsJCvJ4uArI=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425986; c=relaxed/simple;
	bh=WnI9cftdckMCCfAB/cCAoK83Qqfp8hCPGKlp157JaRo=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=NDU60jubb4x23vFR6HEWIbZ7NJ6w4n9xSAszzWzFaO+j+yF+0s4kxy+tcWGuzFQiCYwx+sp1GvFqqvjhH7VezNohWI1ETFhERbTQ9eRhYvjzr0r0M2azvtTdMBxAUkyf0irwZ7+twYdlM5a83FKFwEPaT4JKJ0CXOOo1FsGWeg8=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=C4T6F4yA; arc=fail smtp.client-ip=40.107.236.45
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="C4T6F4yA"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=YCLPIrZrq6aJk244w7JyaMtCO+7eWsAVCPFvn77ZEHLuzJ0DjReMj2RLXotOW0GKRGWVcgPtdLRAX2NWRipi5IfSn199nEOkP9oReF0l/jPO6bNQpjQcM2F6ug3iqtH4S3jLyl6xBQKIBhwtH6bgyvHu2RRwwa5nMhrXSG4YWftfKowbFuEJjwZvCRZXViqTSb2ZRUEhqPmO5um96VLTdBC9FmQxmBzl9l47WPTNfqNwBRIOm4BD0uMFYco7IzRuS2DWiWUAEx3gFtgiuQbIXa6UNBJlm2+uIxjuQI3iZt7lzqn0KMjOuIKO+KZCjJBowFqZYcbigwR1E6zWFOPyhg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=5IJezya7VDFnthrpvmaJErquhXQmSEGt3pjALQGFDAE=;
 b=qZgbUB0hIhoKFfZc946OszK/mi8qCMjcBEy0VK/Fw3mXVseJUOx9tWy4EZ32xidlB1ypVQOpgKkcygH9JcMdV1oiXEiFmwcG9+3UxUB4RtROlEK99JvTl8T34EvhBVfOHs3cK0v+/oaj0TsfCSfFE9ZJSHW1QxdiXXanmfAW82+en8+vCM1PE7UdJQDWH/GqXWN4573L6KT6AxveEJku5Ulo0W4VHSagnsBf7xnOdJg/5WxF0ZwLi9HoqVDzLGxqpYjyFEeFMql2x0G8EMkKvrdMgzwo/GtHe4kW5Yk/ZXUk4sXRSC1QAJQ9mVQ1Gh2LMC9tKc2InK4vJZUhcsasHQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=5IJezya7VDFnthrpvmaJErquhXQmSEGt3pjALQGFDAE=;
 b=C4T6F4yAJbXGBcpxSAS3HoRoQnFMzoEeVRJwsTuhUAu5OVdN9FnLw7hVYdAOSGmfHwFoJaZb6T4fOAYEkRkF5Iz0evx9CT0jPziy8a97srHP5E7fm3SBXKbN4wJqgwr2nqKPJVFk4Febrk9cVYoMhCdtYQ3NSD4+am4T5JSxrho=
Received: from BL0PR02CA0023.namprd02.prod.outlook.com (2603:10b6:207:3c::36)
 by DS7PR12MB5933.namprd12.prod.outlook.com (2603:10b6:8:7c::14) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.24; Tue, 8 Oct
 2024 22:19:39 +0000
Received: from BN3PEPF0000B071.namprd04.prod.outlook.com
 (2603:10b6:207:3c:cafe::37) by BL0PR02CA0023.outlook.office365.com
 (2603:10b6:207:3c::36) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.24 via Frontend
 Transport; Tue, 8 Oct 2024 22:19:39 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B071.mail.protection.outlook.com (10.167.243.116) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:19:39 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:19:38 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 14/15] cxl/aer/pci: Export pci_aer_unmask_internal_errors()
Date: Tue, 8 Oct 2024 17:16:56 -0500
Message-ID: <20241008221657.1130181-15-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B071:EE_|DS7PR12MB5933:EE_
X-MS-Office365-Filtering-Correlation-Id: eb7182a3-222b-4b78-d284-08dce7e74d11
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|376014|7416014|82310400026|36860700013|1800799024|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?l6vLoN211EEYs94sDCyQeu7KrVVX+Ls2CQGHvfMAavxPDFS8EYlD0gyvEzLA?=
 =?us-ascii?Q?eypAZ82NVp1lRgJ59W0vVIhhAFUNW3PAp618PSTjYhup20BtL7VUdB4yzF+E?=
 =?us-ascii?Q?j3aRiYkYSs3oBHTqQUEx1JA8zoz4rvZ4cCAWUt/KgnzgRoLgsQu9ZZ/4SuRb?=
 =?us-ascii?Q?R6+9jWBRWQQOTM3PQjFgvwVHZkQSUoi6U4wGwTtzG3HEp2ckxsWtqR/jXlq7?=
 =?us-ascii?Q?thjfVNbjqINogGlBAwhJP1J09OY5f+BPYsFXuNJk4DknpXgYExg25OTGxK9r?=
 =?us-ascii?Q?7Dmag3VuLMUNXU4t1PuTZeL7HSr9JdDn4XOP2fl9yidEbX5WaQDf8dllzogg?=
 =?us-ascii?Q?cdBC6Rnm9SR8VHuhW0z2LVlP942ReGl6D3ZFn8QRdkSI5UaOtZ7v3JyUf4Pi?=
 =?us-ascii?Q?4uw33X5edTSz3QDWnzPz5MPQZAO6F3Z+awq6HQlqWmmWk5ax1qU1mtr+Lrwf?=
 =?us-ascii?Q?6HtpJUcFrgOdMPJrgpjm03KcqxvYoWkZRgei+2MSL9AITzKpRVlzd4vNl8j1?=
 =?us-ascii?Q?VxAQDHXjnl1cINBnkKBbp0Py/a/DWsyGtVgXykIB0cupBBSdWRjzmy3PK0Nw?=
 =?us-ascii?Q?AhU1Dif0cKA7KbgvQ6BX0WTA1kTLDhYyRyim53fMJvwsabf5PSEi/bu8zps4?=
 =?us-ascii?Q?nlGSmQM83THJj4sZb2RlLfk+KhYgm4BJv1DEFQWw3q/hCrktPUq9AeJVXFJg?=
 =?us-ascii?Q?uOog3q1SVmyBMa6lFNr7/JsQqH9nh4aefR7K4RL3Jm61tRrKDqKZZimF/8gJ?=
 =?us-ascii?Q?qfzlbhRvR6X0vHCXbOijKFAvpuXnbNqEeJMdFVlfbhZ1fYdGjpfBUHCb5KzA?=
 =?us-ascii?Q?pK0BKXG9T0dNyHR7YfjHkvisPi1DNXlBhglJYuf3TuJcIFaRH13aVODTV+fS?=
 =?us-ascii?Q?qqYjVVoYNdTBtGia1F+sBwjhLBtDYP1x4mFTo0RMO4rTvecGof8lIaBv/a7T?=
 =?us-ascii?Q?ioLFVjfF20S/0/osKhRfBRSR0EFphgO0BHhTJAMFJPHW54MtdK23MCn6f++A?=
 =?us-ascii?Q?T8/PiVk8R4+dYbr0Qi49UbEQNF/LNjavdqeA8NCGzVwKtakS0lCAeuGRG2Aa?=
 =?us-ascii?Q?5IqRG4WoldEoATrTXxhY+0tQPF3+qvkRz5iLBal1NZP6TMRqMovTbP64Dk+E?=
 =?us-ascii?Q?jmwxfLo7YNi68IWGMQr/JWmZRYyAFlqZtI+JIX85e9CPJZLdrQSQ+a1X4dqW?=
 =?us-ascii?Q?pz/MNC9ysgE9pSuDx/GQ4w4MVNCj0Ak0cUUOpMUC/4IdXqreO89r6g6C149J?=
 =?us-ascii?Q?Wy7Qm5Jmv12xfcttSsWeSofqwuI1yhOQU++tMF3/uPFht7R09lYn2Pa1Cy3l?=
 =?us-ascii?Q?ymGeh04FXm6Pqj7uTIUzfSIz2fDgLipfUDeQiyF3NdnvhyAPbcl0cxm1uPZM?=
 =?us-ascii?Q?8xRn1wsgbVRkBfxXS71HNF32zy3F?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(376014)(7416014)(82310400026)(36860700013)(1800799024)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:19:39.5618
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: eb7182a3-222b-4b78-d284-08dce7e74d11
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B071.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS7PR12MB5933
Status: O
Content-Length: 2077
Lines: 60

The CXL driver needs to enable AER correctable and uncorrectable internal
errors in order to receive notification of protocol
errors. pci_aer_unmask_internal_errors() is currently defined as
'static' in the AER service driver.

Update the AER service driver, exporting pci_aer_unmask_internal_errors()
to CXL namespace.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/pci/pcie/aer.c | 6 ++++--
 include/linux/aer.h    | 2 ++
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
index 81a19028c4e7..1b4004932084 100644
--- a/drivers/pci/pcie/aer.c
+++ b/drivers/pci/pcie/aer.c
@@ -962,7 +962,6 @@ static bool is_internal_error(struct aer_err_info *info)
 	return info->status & PCI_ERR_UNC_INTN;
 }
 
-#ifdef CONFIG_PCIEAER_CXL
 /**
  * pci_aer_unmask_internal_errors - unmask internal errors
  * @dev: pointer to the pcie_dev data structure
@@ -973,7 +972,7 @@ static bool is_internal_error(struct aer_err_info *info)
  * Note: AER must be enabled and supported by the device which must be
  * checked in advance, e.g. with pcie_aer_is_native().
  */
-static void pci_aer_unmask_internal_errors(struct pci_dev *dev)
+void pci_aer_unmask_internal_errors(struct pci_dev *dev)
 {
 	int aer = dev->aer_cap;
 	u32 mask;
@@ -986,6 +985,9 @@ static void pci_aer_unmask_internal_errors(struct pci_dev *dev)
 	mask &= ~PCI_ERR_COR_INTERNAL;
 	pci_write_config_dword(dev, aer + PCI_ERR_COR_MASK, mask);
 }
+EXPORT_SYMBOL_NS_GPL(pci_aer_unmask_internal_errors, CXL);
+
+#ifdef CONFIG_PCIEAER_CXL
 
 static bool is_cxl_mem_dev(struct pci_dev *dev)
 {
diff --git a/include/linux/aer.h b/include/linux/aer.h
index 67fd04c5ae2b..c43d2b60b992 100644
--- a/include/linux/aer.h
+++ b/include/linux/aer.h
@@ -69,5 +69,7 @@ struct cxl_port_err_hndlrs {
 void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs);
 void unregister_cxl_port_hndlrs(void);
 struct cxl_port_err_hndlrs *find_cxl_port_hndlrs(void);
+
+void pci_aer_unmask_internal_errors(struct pci_dev *dev);
 #endif //_AER_H_
 
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2087.outbound.protection.outlook.com [40.107.223.87])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9D78521791F;
	Tue,  8 Oct 2024 22:19:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.87
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425997; cv=fail; b=c+bjKzPRym+imnbE5liUAeKpPR4oEPx4dvO7H59jHkVmwuvzk3cfq2g5m/Gt8gRXpEfqZFG11lniK6qERKskA6AZAmssqqLnH+8LLgEI3Q0jIugrXwM8ff6URrTSO0ibNT38KEpCjK2OpxLas59ZjlwiKdAsnUoqdFRytdeL138=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425997; c=relaxed/simple;
	bh=fHzw/BDXIHn7QLS7ZvIgVVhno6Co1TBG8mEbhXsLOaI=;
	h=From:To:Subject:Date:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=oheVOLcbqgb8KI+W+KuoEaBsVaksOJhgR9eRnThB2THVfJ6wBC7yTqMQ6a2xE90h7X3tvHdZIj1o6EdMBMyYWNz1b1qfJnLu+mx34WQCu25rJovP7aY3830F9AFKn8Oqui5zfk4J/jCAAsUIx3WgzEaHtXuEpR74N4WSJAI34LQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=A60qVngN; arc=fail smtp.client-ip=40.107.223.87
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="A60qVngN"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=TXUa+onA4IVTY6gtlsFa3HgP5AeFxatMhSiqfA5zjFJB6BFiGme+IsSZjVqmLWrTR5ugARcXOV8nKfazrqe3O6NrPD+IYgLR3Rt4ooxc5B9Hzj53i7C+60OEdKo/tGKDYW04WkLgVzIpL1iLPs1LGSyR7qE02sz39zdxIOx31T1i7M31+4juOIynWy1FGX3B95NwCJd9nfCrovjZZtUvRVgyCckBsV6dDbhRwiLShgUQ0QVT2UfJsUO8MuhFoRyvS7WaqjFYuuKPcHQVQEAvQ7ju8jE48b+pzWAzDwDYTGXC9vpC7661p89ZyZkBAyWFLpxBc1WdIMgJ6JpS/qZhPA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=r/1JBAXKH0wP+1tCXCRUlm5/st9vbuvv0hE9F+lBIso=;
 b=Z/eKYX6ySIVA37VQuOIaNPvDPBH97dVVJAZR185YycxOsqo8ZkZGovZlAE+dH+zKO32QHmlEy7rT0P5CLSCd0a4yIDdNkYsmwRmeeMoPWKRrT2O2CTrOrIz7dJD+D4jdq9f09CemQv2keFU3TIyGiR2Uhmt86CrZ07EmI1Dg80+9pl1c06MLwmEIijVZZGGzfUTfSdhSSzES4przc/KyNbHTdUnsei3MKaM1s6qsi0sjZ2vi1H6NeE2KwXZEIIkDlzY8Xdrt3FxvTbeNKEvwC3TzpvqUOzqfoUCReuBw2Yu226yhvqBMtTU1EbqW+fS3JV1Y/5CKt/5kC9A6YmYKxQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=r/1JBAXKH0wP+1tCXCRUlm5/st9vbuvv0hE9F+lBIso=;
 b=A60qVngNorjbQ3Sx/tFGdtTQoOPZf8bmVZSl/UlAECIW8blw1xdBHLGOXgp1KWGUR4IN1wwzdK/SFOQpyXLOlJo1fVOwwvCL4EUydqGDq+ESxtFJwv9DBA9WZfSmF9YDIcUZxVixH2qHf7kvowCsjepcLIkoAWfYwbFdF7kTjwA=
Received: from BLAPR05CA0048.namprd05.prod.outlook.com (2603:10b6:208:335::29)
 by SJ2PR12MB7920.namprd12.prod.outlook.com (2603:10b6:a03:4c6::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23; Tue, 8 Oct
 2024 22:19:51 +0000
Received: from BN3PEPF0000B074.namprd04.prod.outlook.com
 (2603:10b6:208:335:cafe::d6) by BLAPR05CA0048.outlook.office365.com
 (2603:10b6:208:335::29) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.17 via Frontend
 Transport; Tue, 8 Oct 2024 22:19:50 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B074.mail.protection.outlook.com (10.167.243.119) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:19:50 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:19:49 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 15/15] cxl/pci: Enable internal CE/UCE interrupts for CXL PCIe port devices
Date: Tue, 8 Oct 2024 17:16:57 -0500
Message-ID: <20241008221657.1130181-16-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B074:EE_|SJ2PR12MB7920:EE_
X-MS-Office365-Filtering-Correlation-Id: 8607cf10-952b-4600-14af-08dce7e753a3
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|82310400026|36860700013|7416014|1800799024|376014|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?ICJNj2fPAQfGWJ5wbJsDtJNj8g5xycv1ZPPPIzvFKJBaK9Ceu3hTHPQnxITt?=
 =?us-ascii?Q?cM0ZXPrYSO6KdkkEPzyuCoPTCgE5BnkWzHwqx/oHvWiPYCpriWrtUXDFkb1o?=
 =?us-ascii?Q?UdU1ufrGWAS4nZoDzaW4myY08w/5SCLyI1HFsz3xnE/OD8SKf6eRgCaaCHCj?=
 =?us-ascii?Q?iBfxDrtz7G0bbUKAXOm45elNm0quraDEBaCBFAYQ4S1ZHs5iwqGHzLPVuITC?=
 =?us-ascii?Q?G9DgRcQayf8yO1RI2JCeP617jv3+ddRNMlP/BGT6dwJWrVqPpEHB4N0AWzRe?=
 =?us-ascii?Q?B/lJnNsC7Veqy4naHm4KAj34tIaF346j+VpHtMMnU3Zl69whW+t3wHYlQCvw?=
 =?us-ascii?Q?DjpslGYSceE54USiynzMu/Qo82SKr4yL0VtMmWwuXL5/cwUITCJd+YseeF0a?=
 =?us-ascii?Q?dy/LjIiBYh9tLx0Rw49pieK7uOGB432BCs3VNUiLno7t70Ca7ic2WvN8Mnnx?=
 =?us-ascii?Q?g9ZaS1cE595EcF3W1MniFEqINhoGJlIC8WJ1ndjUShqMNwEElUhCYGapuzYd?=
 =?us-ascii?Q?YuKl0XOmQATM0odSJ7Ep6rV75E3KSAJSwRq8lL1gDNbntZ+4IXzHp6XgCpUq?=
 =?us-ascii?Q?Fmoq0xLXSiEfAGJbfrLgxcWFCLvwx4/ARfNPyYkjn4hm0T2QxAUgRl6fpNlH?=
 =?us-ascii?Q?xhXSqYid7uyvv41IrRJBianeyWoUq9nQ8tNn7yh1HGVyNtL+PQ3kPBwKEvuw?=
 =?us-ascii?Q?aDu4NLQ44274GgOp/koMozekDiwkkMVbQ4c6SJ2X40xB0JXmKziEI8qcuxth?=
 =?us-ascii?Q?OROuZUQARlME5EKqEjH7+VXako1VLB2mJ+ESNeIdvC54Sw9xmoLh2iA3RYhK?=
 =?us-ascii?Q?8FTIvbjmlubVNpA/HaiYvcPA7nxD5S10qkb9YJtUhGK62lgLXSef9iScfc+M?=
 =?us-ascii?Q?qdis72FaUdFrK9v7PXKkFDDUN5GBFaKuI+dPwsg9uM3is7ii/HUSJo2wrktO?=
 =?us-ascii?Q?LEj9zTgP6eLgPmkOrKi46oJ9DKpUPk12xj1JydfyTe9oxtPWXwgL9cvvf5Gj?=
 =?us-ascii?Q?pTYFljrfMieSqmfvo2+XjIosnDR0US19wMPvMDyjFNJpYsxqaMhRlINkQ/pT?=
 =?us-ascii?Q?m/ROE2WcJxBe6xgBP8S8Ar+SezbNZjgU0I3AGMACt2ATUfDwjNuvxuDQ9P12?=
 =?us-ascii?Q?I5f1vZhGj/PxFQKDIQLOmEGh1RHpijsFjJ7trsk8/Zev+y6VsfpecGFD0qs9?=
 =?us-ascii?Q?g0tXMcTGdONXHYVyZ0EfWtcFASUvgGl4nQbbjINst4MyDWRFPw1P2ibZBO22?=
 =?us-ascii?Q?3jwPkrSDbYxhnyAf9sD1HmKqCoJR2MKXC4Ti+WLVAUJcS5EHDWHrPm90HRz7?=
 =?us-ascii?Q?M0hVOq3GnReYaJTeUxfyVnAhpAGHHsCTlxC4dl4ZFH2kAHoJDuZ8ZIqjqsXz?=
 =?us-ascii?Q?rudqcvt3mVQAyrtTOv3HfpEqlIDk?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(82310400026)(36860700013)(7416014)(1800799024)(376014)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:19:50.5644
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 8607cf10-952b-4600-14af-08dce7e753a3
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B074.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ2PR12MB7920
Status: O
Content-Length: 1598
Lines: 49

The AER service drivers and CXL drivers are updated to handle PCIe
port protocol errors. But, the PCIe AER correctable and uncorrectable
internal errors are mask disabled for the PCIe port devices.

Enable the AER internal errors for CXL PCIe port devices.

Signed-off-by: Terry Bowman <terry.bowman@amd.com>
---
 drivers/cxl/core/pci.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
index 4706113d2582..1d84a7022c4d 100644
--- a/drivers/cxl/core/pci.c
+++ b/drivers/cxl/core/pci.c
@@ -908,6 +908,7 @@ EXPORT_SYMBOL_NS_GPL(cxl_port_err_detected, CXL);
 
 void cxl_uport_init_aer(struct cxl_port *port)
 {
+	struct pci_dev *pdev = to_pci_dev(port->uport_dev);
 	/* uport may have more than 1 downstream EP. Check if already mapped. */
 	if (port->uport_regs.ras) {
 		dev_warn(&port->dev, "RAS is already mapped\n");
@@ -920,12 +921,14 @@ void cxl_uport_init_aer(struct cxl_port *port)
 		dev_err(&port->dev, "Failed to map RAS capability.\n");
 		return;
 	}
+	pci_aer_unmask_internal_errors(pdev);
 }
 EXPORT_SYMBOL_NS_GPL(cxl_uport_init_aer, CXL);
 
 void cxl_dport_init_aer(struct cxl_dport *dport)
 {
 	struct device *dport_dev = dport->dport_dev;
+	struct pci_dev *pdev = to_pci_dev(dport_dev);
 
 	if (dport->rch) {
 		struct pci_host_bridge *host_bridge = to_pci_host_bridge(dport_dev);
@@ -949,6 +952,7 @@ void cxl_dport_init_aer(struct cxl_dport *dport)
 		dev_err(dport_dev, "Failed to map RAS capability.\n");
 		return;
 	}
+	pci_aer_unmask_internal_errors(pdev);
 }
 EXPORT_SYMBOL_NS_GPL(cxl_dport_init_aer, CXL);
 
-- 
2.34.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id ADF9319CD17;
	Thu, 10 Oct 2024 19:07:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728587249; cv=none; b=rCsGbu5Yo/QyPbzkJ718qL5Ji4Nz31WJ/n2Xz8GxhyTypjVLGhmqv/KJtxWQVgy9ft3fZm9gy6kMpwlKf91KlTgjl168+T2OFpjWg6ocTV2rnINvMhkgQz/KaOdv3oxNfIzqKfKrYYtiQJ001l5Qkty8dS/EZht9b+jQC17cBZc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728587249; c=relaxed/simple;
	bh=4FyLCZ7OLTy+fgNteG8kX8j3xWeYO0/AKTh/Grmb0oY=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition:In-Reply-To; b=XnY5oz45w2xtXK/1GqgNkWMybG/QlujwdYJxYTEpSLtOSiircVDGS6uaVWdG0AGVEljxe8HOiI5Iy5hwHeu9zqi91+fHtr/jQor3Y3VlflXzU1FaLfgvhcw9OqvnMl4oCzg4oOKgoSC2q6XDQwG2xjEsrsBh/8Fitv6ZosgI0X0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=iTRD7SRr; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="iTRD7SRr"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id DD778C4CEC5;
	Thu, 10 Oct 2024 19:07:28 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1728587249;
	bh=4FyLCZ7OLTy+fgNteG8kX8j3xWeYO0/AKTh/Grmb0oY=;
	h=Date:From:To:Cc:Subject:In-Reply-To:From;
	b=iTRD7SRrCnIRO/krFncVj3Ov/hK7kc/9xuHLBZDjWzil9InHhPACGxsseTRIm+QUN
	 vPcwiXqEjGVYB3zhun0ggw34PIh4CM2B0HNtaAzEiWcBDtKq2+dn51sJP58xWyNU01
	 XGsOl1R6XU38MZmrg1c+jg0YQKWI55/FfAOOlrxk4sD2rct4S7CZ7h10FAtgomQ7nY
	 c3X6TXadh5eqIQz2acEIzORqiv8+RcZT6o8/pQtWfQWMOM+LqND72j4KsTdf2i72Tx
	 jNQmCsGgehtMJyIgtmFB/qa7kTQ15E1bmlBd7xMpLNbJNNSbPOYoNz8ZdKBMi+LOAe
	 X9eyOHPkT2BtA==
Date: Thu, 10 Oct 2024 14:07:26 -0500
From: Bjorn Helgaas <helgaas@kernel.org>
To: Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	dave@stgolabs.net, jonathan.cameron@huawei.com,
	dave.jiang@intel.com, alison.schofield@intel.com,
	vishal.l.verma@intel.com, dan.j.williams@intel.com,
	bhelgaas@google.com, mahesh@linux.ibm.com, oohall@gmail.com,
	Benjamin.Cheatham@amd.com, rrichter@amd.com,
	nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Message-ID: <20241010190726.GA570880@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
Status: O
Content-Length: 14388
Lines: 244

On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
> This is a continuation of the CXL port error handling RFC from earlier.[1]
> The RFC resulted in the decision to add CXL PCIe port error handling to
> the existing RCH downstream port handling. This patchset adds the CXL PCIe
> port handling and logging.
> 
> The first 7 patches update the existing AER service driver to support CXL
> PCIe port protocol error handling and reporting. This includes AER service
> driver changes for adding correctable and uncorrectable error support, CXL
> specific recovery handling, and addition of CXL driver callback handlers.
> 
> The following 8 patches address CXL driver support for CXL PCIe port
> protocol errors. This includes the following changes to the CXL drivers:
> mapping CXL port and downstream port RAS registers, interface updates for
> common RCH and VH, adding port specific error handlers, and protocol error
> logging.
> 
> [1] - https://lore.kernel.org/linux-cxl/20240617200411.1426554
> -1-terry.bowman@amd.com/

Makes life easier if URLs are all on one line so they still work.

> Testing:
> 
> Below are test results for this patchset. This is using Qemu with a root
> port (0c:00.0), upstream switch port (0d:00.0),and downstream switch port
> (0e:00.0).
> 
> This was tested using aer-inject updated to support CE and UCE internal
> error injection. CXL RAS was set using a test patch (not upstreamed).
> 
>     Root port UCE:
>     root@tbowman-cxl:~/aer-inject# ./root-uce-inject.sh
>     [   27.318920] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0c:00.0
>     [   27.320164] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0c:00.0
>     [   27.321518] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   27.322483] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00400000/02000000
>     [   27.323243] pcieport 0000:0c:00.0:    [22] UncorrIntErr
>     [   27.325584] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   27.325584]
>     [   27.327171] cxl_port_aer_uncorrectable_error: device=0000:0c:00.0 host=pci0000:0c status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   27.333277] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   27.333872] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3857
>     [   27.334761] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   27.335716] Call Trace:
>     [   27.335985]  <TASK>
>     [   27.336226]  panic+0x2ed/0x320
>     [   27.336547]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   27.337037]  ? __pfx_aer_root_reset+0x10/0x10
>     [   27.337453]  cxl_do_recovery+0x304/0x310
>     [   27.337833]  aer_isr+0x3fd/0x700
>     [   27.338154]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   27.338572]  irq_thread_fn+0x1f/0x60
>     [   27.338923]  irq_thread+0x102/0x1b0
>     [   27.339267]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   27.339683]  ? __pfx_irq_thread+0x10/0x10
>     [   27.340059]  kthread+0xcd/0x100
>     [   27.340387]  ? __pfx_kthread+0x10/0x10
>     [   27.340748]  ret_from_fork+0x2f/0x50
>     [   27.341100]  ? __pfx_kthread+0x10/0x10
>     [   27.341466]  ret_from_fork_asm+0x1a/0x30
>     [   27.341842]  </TASK>
>     [   27.342281] Kernel Offset: 0x1ba00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   27.343221] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Root port CE:
>     root@tbowman-cxl:~/aer-inject# ./root-ce-inject.sh
>     [   19.444339] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0c:00.0
>     [   19.445530] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0c:00.0
>     [   19.446750] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [   19.447742] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00004000/0000a000
>     [   19.448549] pcieport 0000:0c:00.0:    [14] CorrIntErr
>     [   19.449223] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [   19.449223]
>     [   19.451415] cxl_port_aer_correctable_error: device=0000:0c:00.0 host=pci0000:0c status='Received Error From Physical Layer'
> 
>     Upstream switch port UCE:
>     root@tbowman-cxl:~/aer-inject# ./us-uce-inject.sh
>     [   45.236853] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0d:00.0
>     [   45.238101] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0d:00.0
>     [   45.239416] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   45.240412] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00400000/02000000
>     [   45.241159] pcieport 0000:0d:00.0:    [22] UncorrIntErr
>     [   45.242448] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   45.242448]
>     [   45.244008] cxl_port_aer_uncorrectable_error: device=0000:0d:00.0 host=0000:0c:00.0 status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   45.249129] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   45.249800] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3855
>     [   45.250795] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   45.251907] Call Trace:
>     [   45.253284]  <TASK>
>     [   45.253564]  panic+0x2ed/0x320
>     [   45.253909]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   45.255455]  ? __pfx_aer_root_reset+0x10/0x10
>     [   45.255915]  cxl_do_recovery+0x304/0x310
>     [   45.257219]  aer_isr+0x3fd/0x700
>     [   45.257572]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   45.258006]  irq_thread_fn+0x1f/0x60
>     [   45.258383]  irq_thread+0x102/0x1b0
>     [   45.258748]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   45.259196]  ? __pfx_irq_thread+0x10/0x10
>     [   45.259605]  kthread+0xcd/0x100
>     [   45.259956]  ? __pfx_kthread+0x10/0x10
>     [   45.260386]  ret_from_fork+0x2f/0x50
>     [   45.260879]  ? __pfx_kthread+0x10/0x10
>     [   45.261418]  ret_from_fork_asm+0x1a/0x30
>     [   45.261936]  </TASK>
>     [   45.262451] Kernel Offset: 0xc600000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   45.263467] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Upstream switch port CE:
>     root@tbowman-cxl:~/aer-inject# ./us-ce-inject.sh 
>     [   37.504029] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0d:00.0
>     [   37.506076] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0d:00.0
>     [   37.507599] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [   37.508759] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00004000/0000a000
>     [   37.509574] pcieport 0000:0d:00.0:    [14] CorrIntErr            
>     [   37.510180] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [   37.510180] 
>     [   37.512057] cxl_port_aer_correctable_error: device=0000:0d:00.0 host=0000:0c:00.0 status='Received Error From Physical Layer'
> 
>     Downstream switch port UCE:
>     root@tbowman-cxl:~/aer-inject# ./ds-uce-inject.sh
>     [   29.421532] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0e:00.0
>     [   29.422812] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0e:00.0
>     [   29.424551] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   29.425670] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00400000/02000000
>     [   29.426487] pcieport 0000:0e:00.0:    [22] UncorrIntErr
>     [   29.427111] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   29.427111]
>     [   29.428688] cxl_port_aer_uncorrectable_error: device=0000:0e:00.0 host=0000:0d:00.0 status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   29.430173] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   29.430862] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g844fd2319372 #3851
>     [   29.431874] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   29.433031] Call Trace:
>     [   29.433354]  <TASK>
>     [   29.433631]  panic+0x2ed/0x320
>     [   29.434010]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   29.434653]  ? __pfx_aer_root_reset+0x10/0x10
>     [   29.435179]  cxl_do_recovery+0x304/0x310
>     [   29.435626]  aer_isr+0x3fd/0x700
>     [   29.436027]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   29.436507]  irq_thread_fn+0x1f/0x60
>     [   29.436898]  irq_thread+0x102/0x1b0
>     [   29.437293]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   29.437758]  ? __pfx_irq_thread+0x10/0x10
>     [   29.438189]  kthread+0xcd/0x100
>     [   29.438551]  ? __pfx_kthread+0x10/0x10
>     [   29.438959]  ret_from_fork+0x2f/0x50
>     [   29.439362]  ? __pfx_kthread+0x10/0x10
>     [   29.439771]  ret_from_fork_asm+0x1a/0x30
>     [   29.440221]  </TASK>
>     [   29.440738] Kernel Offset: 0x10a00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   29.441812] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Downstream switch port CE:
>     root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
>     [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
>     [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
>     [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
>     [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
>     [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [  177.119521]
>     [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'

Thanks for the hints about how to test this; it's helpful to have
those in the email archives.  Remove the timestamps and non-relevant
call trace entries unless they add useful information.  AFAICT they're
just distractions in this case.

> Changes RFC->v1:
>  [Dan] Rename cxl_rch_handle_error() becomes cxl_handle_error()
>  [Dan] Add cxl_do_recovery()
>  [Jonathan] Flatten cxl_setup_parent_uport()
>  [Jonathan] Use cxl_component_regs instead of struct cxl_regs regs
>  [Jonathan] Rename cxl_dev_is_pci_type()
>  [Ming] bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport) can
>  replace these find_cxl_port() and device_find_child().
>  [Jonathan] Compact call to cxl_port_map_regs() in cxl_setup_parent_uport()
>  [Ming] Dont use endpoint as host to cxl_map_component_regs()
>  [Bjorn] Use "PCIe UIR/CIE" instesad of "AER UI/CIE"
>  [TODO][Bjorn] Dont use Kconfig to enable/disable a CXL external interface
> 
> Terry Bowman (15):
>   cxl/aer/pci: Add CXL PCIe port error handler callbacks in AER service
>     driver
>   cxl/aer/pci: Update is_internal_error() to be callable w/o
>     CONFIG_PCIEAER_CXL
>   cxl/aer/pci: Refactor AER driver's existing interfaces to support CXL
>     PCIe ports
>   cxl/aer/pci: Add CXL PCIe port correctable error support in AER
>     service driver
>   cxl/aer/pci: Update AER driver to read UCE fatal status for all CXL
>     PCIe port devices
>   cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to pci_ers_result type
>   cxl/aer/pci: Add CXL PCIe port uncorrectable error recovery in AER
>     service driver

I had to look at the patches to learn that all the above only touch
drivers/pci, aer.h, and pci.h.  Can you use the PCI subject line
conventions (e.g., "PCI/AER: ...") to make this more obvious?  Almost
all already include "CXL", so I don't think we'd really lose any
information.

>   cxl/pci: Change find_cxl_ports() to be non-static
>   cxl/pci: Map CXL PCIe downstream port RAS registers
>   cxl/pci: Map CXL PCIe upstream port RAS registers
>   cxl/pci: Update RAS handler interfaces to support CXL PCIe ports
>   cxl/pci: Add error handler for CXL PCIe port RAS errors
>   cxl/pci: Add trace logging for CXL PCIe port RAS errors
>   cxl/aer/pci: Export pci_aer_unmask_internal_errors()

Ditto here, and add something about CXL in the subject since this
doesn't export universally.

>   cxl/pci: Enable internal CE/UCE interrupts for CXL PCIe port devices
> 
>  drivers/cxl/core/core.h  |   3 +
>  drivers/cxl/core/pci.c   | 172 +++++++++++++++++++++++++++++++--------
>  drivers/cxl/core/port.c  |   4 +-
>  drivers/cxl/core/trace.h |  47 +++++++++++
>  drivers/cxl/cxl.h        |  14 +++-
>  drivers/cxl/mem.c        |  30 ++++++-
>  drivers/cxl/pci.c        |   8 ++
>  drivers/pci/pci.h        |   5 ++
>  drivers/pci/pcie/aer.c   | 123 ++++++++++++++++++++--------
>  drivers/pci/pcie/err.c   | 150 ++++++++++++++++++++++++++++++++++
>  include/linux/aer.h      |  16 ++++
>  include/linux/pci.h      |   3 +
>  12 files changed, 503 insertions(+), 72 deletions(-)
> 
> 
> base-commit: f7982d85e136ba7e26b31a725c1841373f81f84a

This doesn't apply cleanly on v6.12-rc1, and
f7982d85e136ba7e26b31a725c1841373f81f84a isn't upstream yet.  Where
is it?  I guess it relies on some other series that hasn't been merged
yet?

Bjorn

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6A34A1925B6;
	Thu, 10 Oct 2024 19:11:37 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728587497; cv=none; b=MNzGNflpkK6wQWAjibbzOdn7Wsto+aAkm/ohULzbEO/vaF3MilATsAIegCB0QLr4+aOk9Iga3Z1EbR/H2IFriJSfwbOrLUZscPhnSvq5TvzdAv/QfAxgxTGW3hX+kTKvSwbY15ZvQmkXGezu6sd6QKSOxd8gelnGJ03UsBWeMls=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728587497; c=relaxed/simple;
	bh=r8HhG9Dpfw304yRuKhN7YX4GSw7YfgMwFFG06xYAPZU=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition:In-Reply-To; b=HW9NMZJQz+n6ojk4NOtW3Io2K3Cp3LqTu3DnSBmB/hvx9Wgrgb+0d+JrTFNvffsRC94+sRCKY9OfVvh35w/ugDnqZmnMPdtjXwKDD7R/vgpsrOW7VWsASv+0b90x4Wy6uoMkpjvF40V/DXZuCO9fG/idyvcl84QA3Cww0CZXWCM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=LhZj38Ls; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="LhZj38Ls"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id B7DD1C4CEC5;
	Thu, 10 Oct 2024 19:11:36 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1728587497;
	bh=r8HhG9Dpfw304yRuKhN7YX4GSw7YfgMwFFG06xYAPZU=;
	h=Date:From:To:Cc:Subject:In-Reply-To:From;
	b=LhZj38LsNOF90G5cEKy1yrkiBO+a8lRNiDYw3v6qApwjWi0kbjK3TsPKXQKyH2ONY
	 AcvtyfzBtyPwTDEh25LsqLGwxIrk6zJHju/zCeVFpqABnuxbhhCTrrAJEDsS01CioF
	 ttiTDAVANxZS5hHRtgoSjLRj8dlCTiBW6v4jjU+CmrZsd6+jLcy311GKjocuUDHN56
	 WYRRU1sF6TrctGy7Nc2Gygc67WEQVEIeAsN9q/mkiSZ7dZeLt52StzXTuYdtR2dHIE
	 FqUF+jF2uf1A9EWX5Uk4OwvdWk87tkSM51aWxDpKKJbu6mznBfn7jg6kxhP7FOMu0L
	 iCFhzoyOEinkA==
Date: Thu, 10 Oct 2024 14:11:35 -0500
From: Bjorn Helgaas <helgaas@kernel.org>
To: Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	dave@stgolabs.net, jonathan.cameron@huawei.com,
	dave.jiang@intel.com, alison.schofield@intel.com,
	vishal.l.verma@intel.com, dan.j.williams@intel.com,
	bhelgaas@google.com, mahesh@linux.ibm.com, oohall@gmail.com,
	Benjamin.Cheatham@amd.com, rrichter@amd.com,
	nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
Subject: Re: [PATCH 03/15] cxl/aer/pci: Refactor AER driver's existing
 interfaces to support CXL PCIe ports
Message-ID: <20241010191135.GA571342@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20241008221657.1130181-4-terry.bowman@amd.com>
Status: O
Content-Length: 3803
Lines: 104

I would describe this more as "renaming" than "refactoring".

On Tue, Oct 08, 2024 at 05:16:45PM -0500, Terry Bowman wrote:
> The AER service driver already includes support for CXL restricted host
> (RCH) downstream port error handling. The current implementation is based
> CXl1.1 using a root complex event collector.
> 
> Update the function interfaces and parameters where necessary to add
> virtual hierarchy (VH) mode CXL PCIe port error handling alongside the RCH
> handling. The CXL PCIe port error handling will be added in a future patch.

"Virtual Hierarchy mode" sounds like something defined by the spec.
If so, add a citation and capitalize it the same way it's used in the
spec.

Same for "restricted host", at least in terms of styling.  That
support was added previously, so a citation probably isn't necessary
here, but since this is part of *adding* VH support, hints about VH
will be more helpful.

> Limit changes to refactoring variable and function names. No
> functional changes are added.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> ---
>  drivers/pci/pcie/aer.c | 28 ++++++++++++++--------------
>  1 file changed, 14 insertions(+), 14 deletions(-)
> 
> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
> index 1e72829a249f..dc8b17999001 100644
> --- a/drivers/pci/pcie/aer.c
> +++ b/drivers/pci/pcie/aer.c
> @@ -1030,7 +1030,7 @@ static int cxl_rch_handle_error_iter(struct pci_dev *dev, void *data)
>  	return 0;
>  }
>  
> -static void cxl_rch_handle_error(struct pci_dev *dev, struct aer_err_info *info)
> +static void cxl_handle_error(struct pci_dev *dev, struct aer_err_info *info)
>  {
>  	/*
>  	 * Internal errors of an RCEC indicate an AER error in an
> @@ -1053,30 +1053,30 @@ static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
>  	return *handles_cxl;
>  }
>  
> -static bool handles_cxl_errors(struct pci_dev *rcec)
> +static bool handles_cxl_errors(struct pci_dev *dev)
>  {
>  	bool handles_cxl = false;
>  
> -	if (pci_pcie_type(rcec) == PCI_EXP_TYPE_RC_EC &&
> -	    pcie_aer_is_native(rcec))
> -		pcie_walk_rcec(rcec, handles_cxl_error_iter, &handles_cxl);
> +	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC &&
> +	    pcie_aer_is_native(dev))
> +		pcie_walk_rcec(dev, handles_cxl_error_iter, &handles_cxl);
>  
>  	return handles_cxl;
>  }
>  
> -static void cxl_rch_enable_rcec(struct pci_dev *rcec)
> +static void cxl_enable_internal_errors(struct pci_dev *dev)
>  {
> -	if (!handles_cxl_errors(rcec))
> +	if (!handles_cxl_errors(dev))
>  		return;
>  
> -	pci_aer_unmask_internal_errors(rcec);
> -	pci_info(rcec, "CXL: Internal errors unmasked");
> +	pci_aer_unmask_internal_errors(dev);
> +	pci_info(dev, "CXL: Internal errors unmasked");
>  }
>  
>  #else
> -static inline void cxl_rch_enable_rcec(struct pci_dev *dev) { }
> -static inline void cxl_rch_handle_error(struct pci_dev *dev,
> -					struct aer_err_info *info) { }
> +static inline void cxl_enable_internal_errors(struct pci_dev *dev) { }
> +static inline void cxl_handle_error(struct pci_dev *dev,
> +				    struct aer_err_info *info) { }
>  #endif
>  
>  void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs)
> @@ -1134,7 +1134,7 @@ static void pci_aer_handle_error(struct pci_dev *dev, struct aer_err_info *info)
>  
>  static void handle_error_source(struct pci_dev *dev, struct aer_err_info *info)
>  {
> -	cxl_rch_handle_error(dev, info);
> +	cxl_handle_error(dev, info);
>  	pci_aer_handle_error(dev, info);
>  	pci_dev_put(dev);
>  }
> @@ -1512,7 +1512,7 @@ static int aer_probe(struct pcie_device *dev)
>  		return status;
>  	}
>  
> -	cxl_rch_enable_rcec(port);
> +	cxl_enable_internal_errors(port);
>  	aer_enable_rootport(rpc);
>  	pci_info(port, "enabled with IRQ %d\n", dev->irq);
>  	return 0;
> -- 
> 2.34.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2089.outbound.protection.outlook.com [40.107.92.89])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CCE5A29A0;
	Mon, 14 Oct 2024 17:22:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.89
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728926542; cv=fail; b=nHtQESanp1fNtT8X9PFjKEuEkyTZCX/z+x1oYnB5Ys4b+Zh+YkMByVyywMQuLSrLBjzL9x5ZE7Zh30uJ5CtlXfxNsaYupYK6W84kSkBa/AMmUlyNmWpQWp8aLjrV1nwC5NRKMOaXXCUeGuYhhDexbdg17OBqDbhxJSE1e1DRAs4=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728926542; c=relaxed/simple;
	bh=xsREzCo0JwbhCgvPFfBHe8JUmzgrfPZFbEbixZQAhXk=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=MTbu8y1NbrVzy8g3kJV2w78B0g1ONowIwa56vBVM1K6TxcxCZPU3PjR+jmc3q9L2tdgxrPOcMIFUxBKKozcAhvLpDiydKtCdXEJTTa86OAwSBBySiqqdyNQBEi/SIQHmS9GQlGSM0/XYxQwvh7ivN96GhBh4uIJsPW7IOggAprc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=GugmSQMS; arc=fail smtp.client-ip=40.107.92.89
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="GugmSQMS"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=SA9JiTu7JMQY0xPw/1bs+fw/UEqJl4t9mEB/xkCReslFwClBtEnvYFX1No5f9DOXHmIIo4BRM4sBQEWMEbYHVKV2CHcE6xEAy9d+YMLKSZ3vkjMtkeg+F4E5gcL16Az/VM8oVt+lVS0d+mantapPyCHVXt+4jzEnZqro508YbYC9BfQ3C8kGk+uQw4NEh5XJW/jbH0NbG7i/CrN+grsC+Fh1HEXFLnZfGxveZ/c24RJTzJUR/hIeq21iTFa8XS1f+saQEJdW7yO+nQh45xnQGlaMycJtGguxucRTiDEudNeP4gRzrwCrt4heUPxo3Flzvz07tcCPnkkYiYdh9NClyQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=79QooBCLTxW4hHAnGvEDAmE7HKfxn2m43jiGQISGU2g=;
 b=avK29iD1gIFKzBBipMbU1YiK97GCqw9a458yh3wUL+0tVh3iEmAn5C24NkfnewTNDA2NK2rwQL0jpYC9JcZNKjCpStLfs8xMP0xJV04hHln4PXfOCzyirziU46xEUQ/+/+VHAeXjJxUx8a1MPWSziUrxpJOmh/PMJmeM6BlyF1qEG+nFeMQSGlQ5GZYagCHLzcNhJLg51BYcpHMkFxJsPwbSgCZUkHg48Ux7US90GL1ZnO9rVb9WTsStwVQ420SO6c2/xA0J1fazgm0F2CGyvVRzoGmQ2RBP2f5Bzn2c4nT20HPnT4LgzMyLae8qn7ZKPyf9OBnOHJCpkv44GRjFUw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=79QooBCLTxW4hHAnGvEDAmE7HKfxn2m43jiGQISGU2g=;
 b=GugmSQMSXqJnp5+sA0WS9CZyczHCEBiNkhq6ZsIorw/u1RTeIHkq61Z6U6MqRwNKrX/AkhVXR5ItAgkAyszvRdG39R/APY+eB1l2cebJk0lMHKHNtFBnVOgQbn8UUXRLTp4tu/HjqHLxilRW9zAmdTS6Dn8Lep7gNkEZE6jlOCc=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 LV3PR12MB9409.namprd12.prod.outlook.com (2603:10b6:408:21d::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.27; Mon, 14 Oct
 2024 17:22:11 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Mon, 14 Oct 2024
 17:22:11 +0000
Message-ID: <17857590-4fca-4c55-b1d7-85a0b22519b6@amd.com>
Date: Mon, 14 Oct 2024 12:22:08 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Content-Language: en-US
To: Bjorn Helgaas <helgaas@kernel.org>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 jonathan.cameron@huawei.com, dave.jiang@intel.com,
 alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241010190726.GA570880@bhelgaas>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241010190726.GA570880@bhelgaas>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0179.namprd11.prod.outlook.com
 (2603:10b6:806:1bb::34) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|LV3PR12MB9409:EE_
X-MS-Office365-Filtering-Correlation-Id: 08ad837c-29e0-49d3-0d4c-08dcec74bcd1
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|376014|7416014|366016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?ZjdBZEVhenRINXZ2R2xOMStzWC8rV1J2bCtHVmUyWUNrYVhDbzNpSGdNVTRM?=
 =?utf-8?B?VzlXS3YzYlJJWlNPUE4xdXU3K0pHRUtKMzRpdkdHbjRidkpDblBXbTRWLy8x?=
 =?utf-8?B?RTUyV05nZWlVTldsRmRxYUE3dkErT0FTQ3RBRkVrR1FyQllrSndXZUFBbGdi?=
 =?utf-8?B?MkYvR1VZMzhjUW8vdDNHNXZjT2R5Y2FxNlJWTUF5b3VlUUlnSjl6bnIvUlRm?=
 =?utf-8?B?RkdRT2ZydWNhWFB3S1lOUnRqRnRUc2d0L3VXZWlGVTJ6ZkN5Q2hGRTd6cWEy?=
 =?utf-8?B?bm1nZW1UcVl6M1NQdjM2aDlJQlZkdDVHREFaTHNteUR0RWdwTHkzTm81VUl3?=
 =?utf-8?B?NVlyZUcyaDZEZHdEUkNBK1dHV3FjQUxMTnFTaDV1eEN2ckF6WE5MWXFqTFo0?=
 =?utf-8?B?cG5nMjZOVHF3TFpXRkIrMzExbm0rNlJabVZzQjBldHFPRWxHeG04emhnNGFI?=
 =?utf-8?B?RXZIYy9GWFRudlNzUU1xTjJwNkpuS05YRGtYM3hjSHpQYU1NeG5vZWd0cUhP?=
 =?utf-8?B?RFRUUEQ0R20vNE1KTGQ5bXV2THd2Qm1PSUlnZkJLZnhQOHl5NEEyeVlkdUZn?=
 =?utf-8?B?QTRkdEVxL3JCcDluNG9Hbm5MbmNtSlZhMGNncTlDSHZFQ09Nb0ovMmI0RUJz?=
 =?utf-8?B?aGFUVkZaNGUyaTc5TXNtZHR2ZGxDK25yVmdzTkQ0aXpFM1pQRjF1YTlsWTRX?=
 =?utf-8?B?ZUpvNWNNZWliMkJ4dFByZndYUjUvV3J5cnZQUk9WNHRIeERFbjhqME91Q24x?=
 =?utf-8?B?QitGK3J2NkFEWVNzWlFmTTNsejdYRk5FeUNDQlo1V2xtd1IrbXNKdEMrak5t?=
 =?utf-8?B?OTIxcU9hcVpHNURoN2w5NmlWU1duejRsbDI1OVFNeW8xa0pwNkhYUFBmV0Iz?=
 =?utf-8?B?c2F5TGpvRVVDd3Z5dkpZYnJOYXZFZ1RZNmxIcUdNL09tOTVGSCt4YjJBTXpS?=
 =?utf-8?B?eW4wRGxTaWZVa1RTclRjQXVqUXBmSlhJeXl4d2h2NE54cTBlVUt4V2duNlMz?=
 =?utf-8?B?LzFyaUFEblBaa3U4WGU5b2xQMzk3b3J0UUFOWXh5Ky80ZkJTenlJc3JRS08z?=
 =?utf-8?B?Y1lhbkVuRG13Tm9tUTVNV2prYmNBcVh6YWlJTzZIZ2RCUWFRNXAyZ1ZEK1Qv?=
 =?utf-8?B?YXcrT2t6MC93QWd4dkY2Ry96ei9HL3ZkRG5TYXJEdW50T3l3ZzI4emhsa1Fv?=
 =?utf-8?B?MXBtRndHOXNrcU5nakNvT0ZnY1JuZjhMMnNJNi8wQmh2dTJoN2VoL1p2ZTFS?=
 =?utf-8?B?anlCSG5xWXpBV2h4L1REN1psYUlnU0VNSGVIVlhCaHhhc3IzMVczSFhmUmo0?=
 =?utf-8?B?RVR6U2t1bzJTR0wwalJDb0lvSi9YZnVOa29ZVnJVUVB6VEZGQlozOTZmZWNU?=
 =?utf-8?B?YTI1cHZGTmdLWFhuUW5XcFFRRTFsK29PY3h3NzBiaUJFWXdsMUZhekZ1RFFZ?=
 =?utf-8?B?L2ZUWWpxellqeHRkaHFlb1RuejJzQnMvWFk1VHVZZFN0U2llK0dZV0dGeExl?=
 =?utf-8?B?aldqTkh6VmpxL24renhaUS9EQjIwSlhsM0JZK0VldkROaDM2T0s1V0U4cmxN?=
 =?utf-8?B?b0NCR1hjMHFSOFZ3bE5oWFBiZ2tJUVlydmFsOU5KY0JhNDJrYUZqOTc5aXdF?=
 =?utf-8?B?R2hTc2NOaXV5N2taSjRKQ2Y0dzl4azRxc3F2V0RMdm1aYTJUQzhXSkhqSjVZ?=
 =?utf-8?B?SzIxRUhWWkVrcUQxNmx3Vm13dS9kNUdtbG1PNnRlbjdzRDlBNXNkcHZnPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(376014)(7416014)(366016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?NlhwbFExclcvZTd6L1FKSEZKSGdWelhIcWJSV3M3MzlPWk1vaVlzdVB5d1FR?=
 =?utf-8?B?TXZ2Zmh1YWh6N1JjbC9ld0xFeTh5dWl1enk5NHlncGlJN01YZzF0MUJWL2FT?=
 =?utf-8?B?OVpDUXpNc1BhMUZIc0RGVDBWVDlOU3VjdGNhMjg1MkdOaHUvbDVieERTL1Fl?=
 =?utf-8?B?OFZJbVpnYkVld1hIYjdmRmFHdDZ1YkxvOW9PWVVUald2Rk4xY3Z3S0lsMk5s?=
 =?utf-8?B?MXFrZkxPNUJmeWpPSitJL0VzODFzWkNMcFVoVHl3WHFVQ2hiUFppaWxOWTB2?=
 =?utf-8?B?QlJyQzMvS0lGQmxqVXc2SFY2eGlTSDVBTG16ZXREbFNGS05tcnd2VFdHcjFO?=
 =?utf-8?B?VUlHVFpnSGxnR0ZEcjNBL25RNWwyaG5vQldXbkcvRVZ0UXB0UnJCaUxUaGxw?=
 =?utf-8?B?VUxubnpiWHdORzdYc3Y5dXpvU0RNVSs1cGU0OGhidUJzV29jaE1LNXZHQnZV?=
 =?utf-8?B?ZzRIRSs5UHQ0NWJvM01iZXdYejVCVlpFV2U5TGMxWTV4SFB4cmdRazBnRXZz?=
 =?utf-8?B?TENiRnNHVnZZc1l0TVhtSHNZRVUwckgyTUtVL1JvUnAzWGhUTkdYa0JmaGNa?=
 =?utf-8?B?bUdKY1F0bEpyYjQ4ek83clNmK3hUZ2hpQjJlVjZuNHVKMUIzV0tFZll0bUdJ?=
 =?utf-8?B?U2VrMEIvaDlGNnhPYy9PeXFHOU0zUEJvUWFjb3I1QmR1S0dXMHByV01Cekx1?=
 =?utf-8?B?WXJmTVFoRXFTc1JKaFQvdFdFejdFRG5OeDMydFZoZktyVVRXYndFUUFkUFBQ?=
 =?utf-8?B?amliWFBKTklRKzNkbkNROXhQYVQ1dC80QkRLd3RuQnoyaUROeG90ekRlbm9k?=
 =?utf-8?B?WmV0a2IwamdZNGx4a1lkU3ZZR2NNSmROZ2VWZEI3SGRhcFUzRlF3azBid0Fq?=
 =?utf-8?B?RUgzRG9uMlIyTWQ2VXpjQXdyM2thZXFBc0dSNGVoc3NEc1RCTEJrRlRmeEcr?=
 =?utf-8?B?NWlVa2d4VGgrSmRFZGdNWk8wQTIrdzZZQUo3K2pjV0VkL0N0czhkb0N3R1o3?=
 =?utf-8?B?WE9jc1N1aFFwMkVndDYycjNxdXZNK24rTlR1YlZEU0F4SnVWa25PVnAyN2kr?=
 =?utf-8?B?QjJNeTVEdHBXS3d6bHg5VzJ2VlFlMmx1elpXb1lmeVRBNjVwMXZ0dEtKeDdC?=
 =?utf-8?B?NGN3Tmh1ZWgyZjlyb1BxY2U3RDcrMlg4OERQNlQvTkdyaHpnQUJJSUk5Wmpj?=
 =?utf-8?B?ZzhqaUFtQ3lIMGM5UC96WVQrZmtTUXN6N29vVFh0RVRzZWJITWU2aFMxWUFl?=
 =?utf-8?B?RTNLS24wN2VjcnZRcFZOUzdPbVR2MCtrMCtVZ2Rrem5oRFJvZDhYN0JMQ1Nn?=
 =?utf-8?B?QlU2RzE4Y1p4UXgvazJoV1hkK2ZFM094b1psSE02bk1iV0lxeEJDek1qREtp?=
 =?utf-8?B?d09aK3hFQ3NtMk5jNkxRa1h4QnkvRzdWVkp4aWtFaURsbWduSjR0eEZPVTJu?=
 =?utf-8?B?aTNXZXJnK0laOVE0Vm1DN2lIV3d3OU13YW8xSi9pc2tNbTllV0hUUCtLYndp?=
 =?utf-8?B?UWlOOWgwRFFvOXVCVk0xMGJETUhEYlpYbEJGWmY4ZU15Y1RkUlJZL1RGZTNn?=
 =?utf-8?B?OGVnempSdGZXclpQVm40dysrYzlHcU16ckpyUjVCU0FpZ1V1TDd5bkRxdDNF?=
 =?utf-8?B?YnhkSU9lV0lBUHVBTVQwZDhRQjZwR0haL3F1WkNUdE4rd3BjOWxxcGNqYjY0?=
 =?utf-8?B?YkJZSTFZQVlEbUxQcGFLNjNjSGt6NFJLVFM4dXZ3WFVkZGM4MzJQTXpVTU9I?=
 =?utf-8?B?Z0VobmRveTgzN0JTdlNtcG43RDl2dGlZSlFmMU8waDBHMldMNWxrdHYwakpa?=
 =?utf-8?B?UTRDOXRobDZRbTArck9rQmIyclljQk1OaDZ1WDdVejRCb0E1ZUkyT2Z0VnZo?=
 =?utf-8?B?cXE4bnhaL01RcER3c2E1Y3FpQW1pd3VDb1JHZ2VXcXNvNk5IVkw3U0ZRd0c2?=
 =?utf-8?B?Sm9qSUszOHM1bG9MVDdmREgxd2ZxR3pPMXVka2YrVGlPYSttQUhZUjFhcWhC?=
 =?utf-8?B?dlFBU1NaWWR5Yit0RTAvczRmR1ovVmdvbHJTWGhNVWtlN0RkKy91ME14cTlm?=
 =?utf-8?B?UngrR3p0V1NtdUxMVHArTmVrWDhlOVU0dmlsZkQzYXFKdTkrNFB2RnNRSVpJ?=
 =?utf-8?Q?VLMiUp7XR+UL2HSaTZ04J3fnn?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 08ad837c-29e0-49d3-0d4c-08dcec74bcd1
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Oct 2024 17:22:10.9524
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: kuw9XbRHxMrCjj1uqGMpUwKftymYf5PeTQ+ur8wSlxBTuz8YWtjabC4swB+OhDGq4hgOSm1/hPAI2fGCIEn9FA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: LV3PR12MB9409
Status: O
Content-Length: 15190
Lines: 268

Hi Bjorn,

Thanks for taking the time to review. I added comments below.

On 10/10/24 14:07, Bjorn Helgaas wrote:
> On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
>> This is a continuation of the CXL port error handling RFC from earlier.[1]
>> The RFC resulted in the decision to add CXL PCIe port error handling to
>> the existing RCH downstream port handling. This patchset adds the CXL PCIe
>> port handling and logging.
>>
>> The first 7 patches update the existing AER service driver to support CXL
>> PCIe port protocol error handling and reporting. This includes AER service
>> driver changes for adding correctable and uncorrectable error support, CXL
>> specific recovery handling, and addition of CXL driver callback handlers.
>>
>> The following 8 patches address CXL driver support for CXL PCIe port
>> protocol errors. This includes the following changes to the CXL drivers:
>> mapping CXL port and downstream port RAS registers, interface updates for
>> common RCH and VH, adding port specific error handlers, and protocol error
>> logging.
>>
>> [1] - https://lore.kernel.org/linux-cxl/20240617200411.1426554
>> -1-terry.bowman@amd.com/
> 
> Makes life easier if URLs are all on one line so they still work.
> 

Ok.

>> Testing:
>>
>> Below are test results for this patchset. This is using Qemu with a root
>> port (0c:00.0), upstream switch port (0d:00.0),and downstream switch port
>> (0e:00.0).
>>
>> This was tested using aer-inject updated to support CE and UCE internal
>> error injection. CXL RAS was set using a test patch (not upstreamed).
>>
>>     Root port UCE:
>>     root@tbowman-cxl:~/aer-inject# ./root-uce-inject.sh
>>     [   27.318920] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0c:00.0
>>     [   27.320164] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0c:00.0
>>     [   27.321518] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>>     [   27.322483] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00400000/02000000
>>     [   27.323243] pcieport 0000:0c:00.0:    [22] UncorrIntErr
>>     [   27.325584] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>>     [   27.325584]
>>     [   27.327171] cxl_port_aer_uncorrectable_error: device=0000:0c:00.0 host=pci0000:0c status: 'Memory Address Parity Error'
>>     first_error: 'Memory Address Parity Error'
>>     [   27.333277] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>>     [   27.333872] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3857
>>     [   27.334761] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>>     [   27.335716] Call Trace:
>>     [   27.335985]  <TASK>
>>     [   27.336226]  panic+0x2ed/0x320
>>     [   27.336547]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>>     [   27.337037]  ? __pfx_aer_root_reset+0x10/0x10
>>     [   27.337453]  cxl_do_recovery+0x304/0x310
>>     [   27.337833]  aer_isr+0x3fd/0x700
>>     [   27.338154]  ? __pfx_irq_thread_fn+0x10/0x10
>>     [   27.338572]  irq_thread_fn+0x1f/0x60
>>     [   27.338923]  irq_thread+0x102/0x1b0
>>     [   27.339267]  ? __pfx_irq_thread_dtor+0x10/0x10
>>     [   27.339683]  ? __pfx_irq_thread+0x10/0x10
>>     [   27.340059]  kthread+0xcd/0x100
>>     [   27.340387]  ? __pfx_kthread+0x10/0x10
>>     [   27.340748]  ret_from_fork+0x2f/0x50
>>     [   27.341100]  ? __pfx_kthread+0x10/0x10
>>     [   27.341466]  ret_from_fork_asm+0x1a/0x30
>>     [   27.341842]  </TASK>
>>     [   27.342281] Kernel Offset: 0x1ba00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>>     [   27.343221] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
>>
>>     Root port CE:
>>     root@tbowman-cxl:~/aer-inject# ./root-ce-inject.sh
>>     [   19.444339] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0c:00.0
>>     [   19.445530] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0c:00.0
>>     [   19.446750] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>>     [   19.447742] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00004000/0000a000
>>     [   19.448549] pcieport 0000:0c:00.0:    [14] CorrIntErr
>>     [   19.449223] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>>     [   19.449223]
>>     [   19.451415] cxl_port_aer_correctable_error: device=0000:0c:00.0 host=pci0000:0c status='Received Error From Physical Layer'
>>
>>     Upstream switch port UCE:
>>     root@tbowman-cxl:~/aer-inject# ./us-uce-inject.sh
>>     [   45.236853] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0d:00.0
>>     [   45.238101] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0d:00.0
>>     [   45.239416] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>>     [   45.240412] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00400000/02000000
>>     [   45.241159] pcieport 0000:0d:00.0:    [22] UncorrIntErr
>>     [   45.242448] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>>     [   45.242448]
>>     [   45.244008] cxl_port_aer_uncorrectable_error: device=0000:0d:00.0 host=0000:0c:00.0 status: 'Memory Address Parity Error'
>>     first_error: 'Memory Address Parity Error'
>>     [   45.249129] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>>     [   45.249800] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3855
>>     [   45.250795] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>>     [   45.251907] Call Trace:
>>     [   45.253284]  <TASK>
>>     [   45.253564]  panic+0x2ed/0x320
>>     [   45.253909]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>>     [   45.255455]  ? __pfx_aer_root_reset+0x10/0x10
>>     [   45.255915]  cxl_do_recovery+0x304/0x310
>>     [   45.257219]  aer_isr+0x3fd/0x700
>>     [   45.257572]  ? __pfx_irq_thread_fn+0x10/0x10
>>     [   45.258006]  irq_thread_fn+0x1f/0x60
>>     [   45.258383]  irq_thread+0x102/0x1b0
>>     [   45.258748]  ? __pfx_irq_thread_dtor+0x10/0x10
>>     [   45.259196]  ? __pfx_irq_thread+0x10/0x10
>>     [   45.259605]  kthread+0xcd/0x100
>>     [   45.259956]  ? __pfx_kthread+0x10/0x10
>>     [   45.260386]  ret_from_fork+0x2f/0x50
>>     [   45.260879]  ? __pfx_kthread+0x10/0x10
>>     [   45.261418]  ret_from_fork_asm+0x1a/0x30
>>     [   45.261936]  </TASK>
>>     [   45.262451] Kernel Offset: 0xc600000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>>     [   45.263467] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
>>
>>     Upstream switch port CE:
>>     root@tbowman-cxl:~/aer-inject# ./us-ce-inject.sh 
>>     [   37.504029] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0d:00.0
>>     [   37.506076] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0d:00.0
>>     [   37.507599] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>>     [   37.508759] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00004000/0000a000
>>     [   37.509574] pcieport 0000:0d:00.0:    [14] CorrIntErr            
>>     [   37.510180] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>>     [   37.510180] 
>>     [   37.512057] cxl_port_aer_correctable_error: device=0000:0d:00.0 host=0000:0c:00.0 status='Received Error From Physical Layer'
>>
>>     Downstream switch port UCE:
>>     root@tbowman-cxl:~/aer-inject# ./ds-uce-inject.sh
>>     [   29.421532] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0e:00.0
>>     [   29.422812] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0e:00.0
>>     [   29.424551] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>>     [   29.425670] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00400000/02000000
>>     [   29.426487] pcieport 0000:0e:00.0:    [22] UncorrIntErr
>>     [   29.427111] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>>     [   29.427111]
>>     [   29.428688] cxl_port_aer_uncorrectable_error: device=0000:0e:00.0 host=0000:0d:00.0 status: 'Memory Address Parity Error'
>>     first_error: 'Memory Address Parity Error'
>>     [   29.430173] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>>     [   29.430862] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g844fd2319372 #3851
>>     [   29.431874] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>>     [   29.433031] Call Trace:
>>     [   29.433354]  <TASK>
>>     [   29.433631]  panic+0x2ed/0x320
>>     [   29.434010]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>>     [   29.434653]  ? __pfx_aer_root_reset+0x10/0x10
>>     [   29.435179]  cxl_do_recovery+0x304/0x310
>>     [   29.435626]  aer_isr+0x3fd/0x700
>>     [   29.436027]  ? __pfx_irq_thread_fn+0x10/0x10
>>     [   29.436507]  irq_thread_fn+0x1f/0x60
>>     [   29.436898]  irq_thread+0x102/0x1b0
>>     [   29.437293]  ? __pfx_irq_thread_dtor+0x10/0x10
>>     [   29.437758]  ? __pfx_irq_thread+0x10/0x10
>>     [   29.438189]  kthread+0xcd/0x100
>>     [   29.438551]  ? __pfx_kthread+0x10/0x10
>>     [   29.438959]  ret_from_fork+0x2f/0x50
>>     [   29.439362]  ? __pfx_kthread+0x10/0x10
>>     [   29.439771]  ret_from_fork_asm+0x1a/0x30
>>     [   29.440221]  </TASK>
>>     [   29.440738] Kernel Offset: 0x10a00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>>     [   29.441812] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
>>
>>     Downstream switch port CE:
>>     root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
>>     [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
>>     [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
>>     [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>>     [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
>>     [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
>>     [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>>     [  177.119521]
>>     [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'
> 
> Thanks for the hints about how to test this; it's helpful to have
> those in the email archives.  Remove the timestamps and non-relevant
> call trace entries unless they add useful information.  AFAICT they're
> just distractions in this case.
> 

I'll remove the test logging and details from the cover sheet. I'm unable to find how to 
attach using git tools. Instead of an atatachment, I can locate the log files and details 
on a public github. Let me know if this is not acceptable.

>> Changes RFC->v1:
>>  [Dan] Rename cxl_rch_handle_error() becomes cxl_handle_error()
>>  [Dan] Add cxl_do_recovery()
>>  [Jonathan] Flatten cxl_setup_parent_uport()
>>  [Jonathan] Use cxl_component_regs instead of struct cxl_regs regs
>>  [Jonathan] Rename cxl_dev_is_pci_type()
>>  [Ming] bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport) can
>>  replace these find_cxl_port() and device_find_child().
>>  [Jonathan] Compact call to cxl_port_map_regs() in cxl_setup_parent_uport()
>>  [Ming] Dont use endpoint as host to cxl_map_component_regs()
>>  [Bjorn] Use "PCIe UIR/CIE" instesad of "AER UI/CIE"
>>  [TODO][Bjorn] Dont use Kconfig to enable/disable a CXL external interface
>>
>> Terry Bowman (15):
>>   cxl/aer/pci: Add CXL PCIe port error handler callbacks in AER service
>>     driver
>>   cxl/aer/pci: Update is_internal_error() to be callable w/o
>>     CONFIG_PCIEAER_CXL
>>   cxl/aer/pci: Refactor AER driver's existing interfaces to support CXL
>>     PCIe ports
>>   cxl/aer/pci: Add CXL PCIe port correctable error support in AER
>>     service driver
>>   cxl/aer/pci: Update AER driver to read UCE fatal status for all CXL
>>     PCIe port devices
>>   cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to pci_ers_result type
>>   cxl/aer/pci: Add CXL PCIe port uncorrectable error recovery in AER
>>     service driver
> 
> I had to look at the patches to learn that all the above only touch
> drivers/pci, aer.h, and pci.h.  Can you use the PCI subject line
> conventions (e.g., "PCI/AER: ...") to make this more obvious?  Almost
> all already include "CXL", so I don't think we'd really lose any
> information.
> 

Yes, I'll change the patches' headlines to use capitalized "PCI/AER".

>>   cxl/pci: Change find_cxl_ports() to be non-static
>>   cxl/pci: Map CXL PCIe downstream port RAS registers
>>   cxl/pci: Map CXL PCIe upstream port RAS registers
>>   cxl/pci: Update RAS handler interfaces to support CXL PCIe ports
>>   cxl/pci: Add error handler for CXL PCIe port RAS errors
>>   cxl/pci: Add trace logging for CXL PCIe port RAS errors
>>   cxl/aer/pci: Export pci_aer_unmask_internal_errors()
> 
> Ditto here, and add something about CXL in the subject since this
> doesn't export universally.
> 

Ok.

>>   cxl/pci: Enable internal CE/UCE interrupts for CXL PCIe port devices
>>
>>  drivers/cxl/core/core.h  |   3 +
>>  drivers/cxl/core/pci.c   | 172 +++++++++++++++++++++++++++++++--------
>>  drivers/cxl/core/port.c  |   4 +-
>>  drivers/cxl/core/trace.h |  47 +++++++++++
>>  drivers/cxl/cxl.h        |  14 +++-
>>  drivers/cxl/mem.c        |  30 ++++++-
>>  drivers/cxl/pci.c        |   8 ++
>>  drivers/pci/pci.h        |   5 ++
>>  drivers/pci/pcie/aer.c   | 123 ++++++++++++++++++++--------
>>  drivers/pci/pcie/err.c   | 150 ++++++++++++++++++++++++++++++++++
>>  include/linux/aer.h      |  16 ++++
>>  include/linux/pci.h      |   3 +
>>  12 files changed, 503 insertions(+), 72 deletions(-)
>>
>>
>> base-commit: f7982d85e136ba7e26b31a725c1841373f81f84a
> 
> This doesn't apply cleanly on v6.12-rc1, and
> f7982d85e136ba7e26b31a725c1841373f81f84a isn't upstream yet.  Where
> is it?  I guess it relies on some other series that hasn't been merged
> yet?
> 
> Bjorn

Hmmm, I thought I was using a 6.11-rc7 commit. I will rebase to either 6.12-rc1 or rc2.

Regards,
Terry

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (mail-sn1nam02on2060.outbound.protection.outlook.com [40.107.96.60])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E98301BFE10;
	Mon, 14 Oct 2024 17:27:08 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.96.60
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728926830; cv=fail; b=bFlYlSCEkycBA4A7EQDsvsLO0gTYTE546rIVjxV5I4vyus4m/1CBACMIC8Kakria7IMis8oHN7TaZwtQk9j3ZroJhB5h6dQnOfQl5LwcpNZhy2Z9LsheOBToToZXQ1tExpNuxKOu3xBjy/11N3uoojr3QblLJuu2LZfbP2uVULc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728926830; c=relaxed/simple;
	bh=i/htXPDsGnMlQm3Vbsg6CZPQ5Vw6A8dAaZNE2tQOwXs=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=hoGLu32MZueKxVHTa1H9SxCTrHsY5AFdfwi/YmbXyNlEx+Gmxh14fs0NCg8AkhDOD5ca7wuo3u8QwDC9SuzJhanvWjZNKa/6EGoacMMN5+cEe2QebDbvJlnKBtVGx4HIbW3zJJdKGAyvT3SgM2aIm9N4JnwwvRLei6zPEB05IE4=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=TKPxhbPc; arc=fail smtp.client-ip=40.107.96.60
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="TKPxhbPc"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=kHVvbO0TZP8tQK330XZy7kEMsrCLV5XpXOnR3y4Ohx5wA09WRA3eebY5Cbx8yyLrI3QuhyK7GwVOI6VmEoFGmtbcQCIycJ0nxSMH8766ueRm2yDRf7Pow4SXy3rtHrbNCnnNpFfLbBZaX6/Kdayk9xMb5fQiVXz1y7jI6VKIcD9KsvB1IzOa6jHKRX7KoQ8J0BRjt2OnQ8Ft0FX62h1ensKu4B1oSVQ5RC6V4Pf85ZOMvSQkgCEmENMYCBuQlVof5knic7b6VoLGYFoqgqgFdu5tVzAJKHfE0xTvn+98M2OlEbJM2bRC4n9SD8u84T8Xw3VSofzPy7BylzZzpBcyQA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=NDJctiwIV8qaOsFIFqKUgRuyU3XG0WIzYBx7jAqoB1k=;
 b=dAeUo04xqGm32IUzZxty0wkdseKf1iBuEdIRLWI95Lh2FdtdAWQLC7nCzyx6iJ6odz/wTo1RDXvotyWiXNHeIH8MuVQmjoHXNv4E+mWhgSOKC2RVHMmGSxEVc+ZjMusQgTdT2JWQ/J3i1z8+73F9VyMMSCoxthcl0FXYVz7p53z0fiCg4hi7c+u7AMMbSQ7gho2Uo4VG80565jmu+ZOWT1pybU+Tp407JcAglU2psseZUOZKfq1E6v7W9uOcst+JxiK+FTIFY7vTsl09PW/R5V/DZED3fydqc/15rKImJ7rYFAYoeTtd8+GFeWP61QMnTpnVd58w4joD4yO9UM9JTg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=NDJctiwIV8qaOsFIFqKUgRuyU3XG0WIzYBx7jAqoB1k=;
 b=TKPxhbPcikL04yxfrywHnA1zsOcAMfAhAgkH0/D3kRD5s5J6IlwoNfAr3tnUJcI17vs/s6CJ1LR9E4CttKgD224z5oNRWJBiI2zmNIJeQm3NE6d/diAqc8HNMKBgKaHuBUGRB2J7pUrbEl1O1vXvdkcdv6DsUPckK+ys6SW3jEQ=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 SA1PR12MB8859.namprd12.prod.outlook.com (2603:10b6:806:37c::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.21; Mon, 14 Oct
 2024 17:27:06 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Mon, 14 Oct 2024
 17:27:05 +0000
Message-ID: <1cea169a-778f-432b-9e9e-1d753bedd041@amd.com>
Date: Mon, 14 Oct 2024 12:27:04 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 03/15] cxl/aer/pci: Refactor AER driver's existing
 interfaces to support CXL PCIe ports
Content-Language: en-US
To: Bjorn Helgaas <helgaas@kernel.org>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 jonathan.cameron@huawei.com, dave.jiang@intel.com,
 alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241010191135.GA571342@bhelgaas>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241010191135.GA571342@bhelgaas>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN6PR01CA0018.prod.exchangelabs.com (2603:10b6:805:b6::31)
 To DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|SA1PR12MB8859:EE_
X-MS-Office365-Filtering-Correlation-Id: 36858dbe-7681-46c7-2d57-08dcec756c9b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|376014|366016|1800799024;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?aFN2aXhYSFhUbTlYZy9qaWcvNWNUVnAvK3o4MFkvWVdrREU2S0lpUFpYS3F2?=
 =?utf-8?B?WW4ycVRHSmNsOTNndFJqaTBjTXc5cHNJTnphdk5MWFhTR293V2Jlc1haLzBO?=
 =?utf-8?B?Z3lMeDZiWkdDZ25QeW83NXBOQjBtdEtrd2wyQThaTzdkSzdnemkrdytTYWRu?=
 =?utf-8?B?SWtET1BveFhXRWdFNC8xZkRFNm9Lc0NSNnpRTHNJWTRRanU5WWRvVzFwZzVL?=
 =?utf-8?B?ZHg5cW9hMkZjSy9qUmg0UStTOThIQVUrakNXOVl3cEU1YkxsSDZhbituY0lE?=
 =?utf-8?B?cWhPMGx5SGc1WDQ3ZDVCTTByM1lXZVRETDNWRzd3MzM5N2MxTTNCc1EvcUFN?=
 =?utf-8?B?NGVrUGk1VWFMa2svajA1TnVXZi96S25HVGlQS01tMGVLSUhqM1YzWWFXVFZo?=
 =?utf-8?B?aTlBQmYvVi8xdTRsK285NXQ1VDgrVWJESERNVGlHTVUzblE4SzFYQWtVZWZt?=
 =?utf-8?B?LzZ3R3h3NmxuUTJjYUNCeWhVSWh3alV3MnBIRkxFSXg0ZGl4QUgwbWdFak5E?=
 =?utf-8?B?YmF5NjVCY3VlU0pKQktsS0x0RFhwN1Vsb01rTkpkaEZsZzg5dEU4aDJQZTk5?=
 =?utf-8?B?UmJBQmpiaE43eWt2bW9zemF0K2FXV2I5RkVjeWN1NW4vanV0WU1UWE5wTEIr?=
 =?utf-8?B?dEdyNkN5NFlKOGlnNHJhY3VOaHZmTVovU0NHemxRejJKeEEwU0g3YXBGc0M2?=
 =?utf-8?B?VDhveDQrMUhTeTJOZEdUeGdFbFhIZi9makMxb1hYZzFZTlRqeUN0WE50OHBq?=
 =?utf-8?B?a2F2MmI2dzFISE5FanhscDM1Vm1QeUl2NFlJenJidlFveUYvMlVQcU5GUko0?=
 =?utf-8?B?V2NzU3hQYW80SE8rM3U0MTJHM0swQ0xKSHZHeXcwdk5ONzVTejVpbjBLTHpi?=
 =?utf-8?B?YXI2ZURzZ1B0cU9pRXZQK1YwRTVMTFA5K1BwaG5zaHZCbXF5N2Zxd29yTWRH?=
 =?utf-8?B?NUhPa2w4VE41akdNd2x0dllURnB4S0x4TFdpMVBJMEVwNXZ0ZG5OVFFtUEhv?=
 =?utf-8?B?TDNJOHZ5bkNwZjQ0SDg5eDZjaUlmODFLaDJiK1Z5aDJ4ZUFzMURjaGF1TzlH?=
 =?utf-8?B?V0JUakx1UExBNnhWR1JwNE85RzZFYmVqWXNGS2RjSUo5NXM4Vi9aOGxrNEpm?=
 =?utf-8?B?QUkzamp5SzJWWTUyTW9xZmJPZ0FCUWhxQXJJRzF3SEVqTXgweHpsUUhVMGpy?=
 =?utf-8?B?RHVrK3NJL3djL0ovKzNtN2x5S2g3U1I4Um1NZG5hb0ttZ2UvWm9uVnVFbWM4?=
 =?utf-8?B?Y1NlV2RqT2MvdXMvVGdwWnhjZURmZ0Z3MUdyQWh3VStST21vendUYis3aUlt?=
 =?utf-8?B?Zk5URVk4cHV6Mm1hYkFRbi9SQ09aclp2RXdpUCt3UjNYL2JYejJUekN3T2ZG?=
 =?utf-8?B?Z1hpWmhKcmljVktmWkRCd2FnM29RWXBDdnVqUk52N2gxZWNGc1hJRGM4WDNx?=
 =?utf-8?B?czYxQmozRDQycHlUREVpQU1kNmZKektHSTBSUUdrVllWdGdaWVF6VzlTenB0?=
 =?utf-8?B?dGxCL2ExZWpsZzJpYUhVWXBhTHJPTnBPNjV4cndmd3JrZmNMRnVxOU9BL3Br?=
 =?utf-8?B?RU9mMDlPRE9sNlNRUDFtaFl3cXhqcDllWXhsbUlzZ1l2MUF2ckNaUEo5U0Jp?=
 =?utf-8?B?RXU1cUJZMTZHOWNMWURoYmNpWmd4c3lzVkpIWGdXTUZKZkQxb1ZXc29obXRn?=
 =?utf-8?B?MWRIVXp3UHVuUmFveldpU3I0SEI0UXZBSlpBeHp2QnI4NjYvZ2k4cENRPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(376014)(366016)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?cUlOMzFNeUlwSmI4V3FWOEtyWlpTWkJzbXhBUmJxTFppVFliRWo5bVRiVTRw?=
 =?utf-8?B?Tks0aklvVlAvdGxydVphbk1sSU1KRnJ5WVFLRUhmUDdvZFgycFZWU0ZoSnNy?=
 =?utf-8?B?UnRNdnFnaklPbFZpOXZQWnJmWjgrcWp3Y1p4eURUd256RmE2Q1ZNWStaSS9F?=
 =?utf-8?B?TER4ejlQc3dYdE95VXBONXFoTGM4bmhVMVVRVGxCejFhY3lzTU1TcUhnVTdB?=
 =?utf-8?B?UGNVeDhiVm8rVUlnZXp3YTNEWGNRTjVETUJRaFdmRFByWFlWSWk2TDZtc3Z1?=
 =?utf-8?B?WEZGQTlYTzZMQ3VCcHgzR2pTSWxuN3J3R040TFplQlhiM1BXQmF1ZWpSY242?=
 =?utf-8?B?cng5SDFPYWdCT05iRng3TklOWi9VZzFqdllzVXNwcml2c3NYc3RDT216TUox?=
 =?utf-8?B?c0x2WXQ5MXMxTE50MkZmUDBhWkoyNCtXR2dwQ1QxV1FjTENXb1FPZEVaSUxt?=
 =?utf-8?B?QWZFQy9kbEZjTlZ6THhkS0JIMXNZUW52WUIyZmp4SWhMTFNKbnRRak1LR1E5?=
 =?utf-8?B?bTN5RFZPTjM1dmtmSWplKzgrVDJpdWRBNGpMUHMySk1SYmFkV1EyYlpDbm1t?=
 =?utf-8?B?cTNJWkFnb0tJL1o0cVp6N0NZMk9nTmd4eHRjclhESm80aC9oeWlmVXZWcTVw?=
 =?utf-8?B?UU5mN2VURkl2OTBBZkkvVWdRY0hqUkhsNkE3cjZoV29zRE9tUVNBbWhtMXRm?=
 =?utf-8?B?NUN0L1N1aXZZbXl3SGU3VWpEQTJlNXM4eU1UVldLcHRTdWNwVXE2YTF6eC9Y?=
 =?utf-8?B?cFBNclRRWkFiVTBRQWorbWZTK1JQSUtzQWprZCs5TWFBRE13bUtFQTNvYVFJ?=
 =?utf-8?B?bFZ0ekF5VmRLMUg2ckhEMmI0OVl3T1ZYL3Y1R3hmdVAzejBpWXBRTVdESnBQ?=
 =?utf-8?B?MG1Xd0tUQUFZQXlrZ2VmU21tNUZQVGQzd1BoSTc2TFlqU24wNlAvdTNCbGZx?=
 =?utf-8?B?UGMvNzNaWTI3T1VIOEVUM0pRUWNqaUNmeFpjRmkxZkxpVmFQcldsdFNvNlZ2?=
 =?utf-8?B?M0ZDcFhYWk1MN0t6VzU4ZUhYSExHVWRkVGN3ZUNkUHBKbFhxUWdSOGRVTm83?=
 =?utf-8?B?bTJWdUltZDhVTDloT0lWK2dneHB1emtMT0NkWHFoQ0Nma25seTBXQjF1TmZI?=
 =?utf-8?B?RkdBTFNxbUZwRHdoR01JaWlyNVhJZHdSM2F5dlMzUzk3MldBQXoyNWI1SUVu?=
 =?utf-8?B?MXlxdERWQUorWlJ6QWNNTm9yU1hrZGVrUkZmd3JRc3JlUk0vLzJTTGxSeVUz?=
 =?utf-8?B?QXQ1NC8zRStVdS9hTzJqbnJWSk1UNUtzK24xazdEL0JleFR5bE9paFRIZUxr?=
 =?utf-8?B?K3hiTFRRdW1FNWZmS1FIZ1V4WGRNRWhjd1B0NmVscFN5ZWtHdVRDanoxRVQr?=
 =?utf-8?B?Y0xucGx5U1JRc1dyQmpFWGtuK3ppby9WbWpxRDQ2NnlibktIM2pkaHdTbTAw?=
 =?utf-8?B?MGVoOXFJMHpQbXpFNVB6L2txbG9lSStjc2MwY25LdzU1RjJSY3gwUkdGY3Fo?=
 =?utf-8?B?cGwrVVB4Zmd3Vlc4TEhRZzN0WStJVkVWemhvZUpiT0lYQ0IwZm94cXB4QjJJ?=
 =?utf-8?B?cEdlRHNTS2l0N0luM0dvQ3B2Y2xseFNzYlVLczMwRXBjNld0ZVl0VmVhRG8w?=
 =?utf-8?B?STRxc1B2M1VZRnNOVDlZSExPaldod1ZQc0szZS9xa1lSaUdacGtPYWo5OE9H?=
 =?utf-8?B?R0hUdzlYQ1d6b0QxMSsyclZZaXJsQ2pKS2xHVUtySTNiZHhTOGU0enpJdmc4?=
 =?utf-8?B?ejZpVFVjcDJmVisrRkpTdlJ5T1VDVVQrV2E0VTR1SXJnaElGdHYyR0ZBQVUv?=
 =?utf-8?B?ZC95b2JBSUFScUcybmZRdTZrbXlQNXlYZWFKZnFQbkdxZDRoSzBxVDMzdnNQ?=
 =?utf-8?B?cEVMaXRtUU5ZeGtMTzgwYWNaaVFvMUNqeEJmM2traUx4SkpnVnZuZzA5K1Vn?=
 =?utf-8?B?TWo0SnoydCtxUDZSUjR3eHZSSTB2K3dIMklzc1owRXFkaGdveE9FLzJKY1Qy?=
 =?utf-8?B?QWQ0Wng4SE5HelVCUWtaN3NWbDh1NGVRc3RRellOcFk0N01RbWVGZGJvazB6?=
 =?utf-8?B?ZUlvbFFFS1FvNEpwSEk1WjAwbVpMWVRzaEN5MlkvZERaclJMdUxWd2RPRWVC?=
 =?utf-8?Q?qpEQh0wQwHKMxx61teJtCSykh?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 36858dbe-7681-46c7-2d57-08dcec756c9b
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Oct 2024 17:27:05.8445
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 6yfZszYxltrFKDU06WWdMlCLe7frN59nkz+5O4WwYP6FJuXbaf0/SwGNz9qc+QfgqteLUDFviezGaZfNU9l8bg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB8859
Status: O
Content-Length: 4039
Lines: 117

Hi Bjorn,


On 10/10/24 14:11, Bjorn Helgaas wrote:
> I would describe this more as "renaming" than "refactoring".
> 

Good point. Renaming is more correct. Thanks. 

> On Tue, Oct 08, 2024 at 05:16:45PM -0500, Terry Bowman wrote:
>> The AER service driver already includes support for CXL restricted host
>> (RCH) downstream port error handling. The current implementation is based
>> CXl1.1 using a root complex event collector.
>>
>> Update the function interfaces and parameters where necessary to add
>> virtual hierarchy (VH) mode CXL PCIe port error handling alongside the RCH
>> handling. The CXL PCIe port error handling will be added in a future patch.
> 
> "Virtual Hierarchy mode" sounds like something defined by the spec.
> If so, add a citation and capitalize it the same way it's used in the
> spec.
> 
> Same for "restricted host", at least in terms of styling.  That
> support was added previously, so a citation probably isn't necessary
> here, but since this is part of *adding* VH support, hints about VH
> will be more helpful.
> 

Ok.

Regards,
Terry

>> Limit changes to refactoring variable and function names. No
>> functional changes are added.
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
>> ---
>>  drivers/pci/pcie/aer.c | 28 ++++++++++++++--------------
>>  1 file changed, 14 insertions(+), 14 deletions(-)
>>
>> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
>> index 1e72829a249f..dc8b17999001 100644
>> --- a/drivers/pci/pcie/aer.c
>> +++ b/drivers/pci/pcie/aer.c
>> @@ -1030,7 +1030,7 @@ static int cxl_rch_handle_error_iter(struct pci_dev *dev, void *data)
>>  	return 0;
>>  }
>>  
>> -static void cxl_rch_handle_error(struct pci_dev *dev, struct aer_err_info *info)
>> +static void cxl_handle_error(struct pci_dev *dev, struct aer_err_info *info)
>>  {
>>  	/*
>>  	 * Internal errors of an RCEC indicate an AER error in an
>> @@ -1053,30 +1053,30 @@ static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
>>  	return *handles_cxl;
>>  }
>>  
>> -static bool handles_cxl_errors(struct pci_dev *rcec)
>> +static bool handles_cxl_errors(struct pci_dev *dev)
>>  {
>>  	bool handles_cxl = false;
>>  
>> -	if (pci_pcie_type(rcec) == PCI_EXP_TYPE_RC_EC &&
>> -	    pcie_aer_is_native(rcec))
>> -		pcie_walk_rcec(rcec, handles_cxl_error_iter, &handles_cxl);
>> +	if (pci_pcie_type(dev) == PCI_EXP_TYPE_RC_EC &&
>> +	    pcie_aer_is_native(dev))
>> +		pcie_walk_rcec(dev, handles_cxl_error_iter, &handles_cxl);
>>  
>>  	return handles_cxl;
>>  }
>>  
>> -static void cxl_rch_enable_rcec(struct pci_dev *rcec)
>> +static void cxl_enable_internal_errors(struct pci_dev *dev)
>>  {
>> -	if (!handles_cxl_errors(rcec))
>> +	if (!handles_cxl_errors(dev))
>>  		return;
>>  
>> -	pci_aer_unmask_internal_errors(rcec);
>> -	pci_info(rcec, "CXL: Internal errors unmasked");
>> +	pci_aer_unmask_internal_errors(dev);
>> +	pci_info(dev, "CXL: Internal errors unmasked");
>>  }
>>  
>>  #else
>> -static inline void cxl_rch_enable_rcec(struct pci_dev *dev) { }
>> -static inline void cxl_rch_handle_error(struct pci_dev *dev,
>> -					struct aer_err_info *info) { }
>> +static inline void cxl_enable_internal_errors(struct pci_dev *dev) { }
>> +static inline void cxl_handle_error(struct pci_dev *dev,
>> +				    struct aer_err_info *info) { }
>>  #endif
>>  
>>  void register_cxl_port_hndlrs(struct cxl_port_err_hndlrs *_cxl_port_hndlrs)
>> @@ -1134,7 +1134,7 @@ static void pci_aer_handle_error(struct pci_dev *dev, struct aer_err_info *info)
>>  
>>  static void handle_error_source(struct pci_dev *dev, struct aer_err_info *info)
>>  {
>> -	cxl_rch_handle_error(dev, info);
>> +	cxl_handle_error(dev, info);
>>  	pci_aer_handle_error(dev, info);
>>  	pci_dev_put(dev);
>>  }
>> @@ -1512,7 +1512,7 @@ static int aer_probe(struct pcie_device *dev)
>>  		return status;
>>  	}
>>  
>> -	cxl_rch_enable_rcec(port);
>> +	cxl_enable_internal_errors(port);
>>  	aer_enable_rootport(rpc);
>>  	pci_info(port, "enabled with IRQ %d\n", dev->irq);
>>  	return 0;
>> -- 
>> 2.34.1
>>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4D7FE1B85C2;
	Mon, 14 Oct 2024 17:29:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728926973; cv=none; b=AZup8qe9gRhV3JrvQLPteVGFMam9RkJWEpSJhDlO27kVZzg8nxPd2H+ksYYfzHUC6UrR6wg6NUTYP70Tr9rUAyo1wqr+Ja7/8xQ5HXLtVpv87pSdiHZfDgqHjRvArFMb6/k+BpZQCLGlBg5CUxvCWKvbt3DgWDs+JzyADfOshao=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728926973; c=relaxed/simple;
	bh=UYsXEf6G0HnwwBXdadcjdUX9XZ4CIA8TewE2uVy2MiY=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition:In-Reply-To; b=SwQkiaalDg9+fhyNj865gPGF7w42t7tvuSdELJHJ2crtopNcAHlH6k3Pgi3gtJomisqa5N5xOVx5dTPfyaGSHN3SQ0I1YpqI3Z0n7ZkEVoVllmSthGUWqE4FftsKvrQ1owmqEFLsyDGYzJjcJeD9DgGxZeTzlwOWC5PCSwoqm1U=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=BXk9bav3; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="BXk9bav3"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 8B8E2C4CEC3;
	Mon, 14 Oct 2024 17:29:32 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1728926972;
	bh=UYsXEf6G0HnwwBXdadcjdUX9XZ4CIA8TewE2uVy2MiY=;
	h=Date:From:To:Cc:Subject:In-Reply-To:From;
	b=BXk9bav3KMeceQzMIW0JiD1qjXZa+9KEQ/jWc+X4FgSdbKaDgzxPdXyKvoTXpcwLZ
	 rY1/SJYE6URPC+NhMGmjL9uWmtX1SWTSiyFZ987hv7IaOXS0raS/TbklFyWo9+if2y
	 4Nezs8HfdgNua2YPsE9cFvmM5fhCsPXesoHy2X/M89WlHK2rpCocdKQ6di+JN+INxs
	 n47n1D9+ltQDl3pceruS9QVGroWBp6Cm2e8Hi2nZCk3W1NozdxcMme1gbL8tJ+OBYF
	 oYCquTREPByC13zxmuMPmHvgZmCa9+QkTG6R1HW5tt+m+9r5TeNxXB4S1Rm6QSR5Yg
	 Nw7l9Zo2W1msw==
Date: Mon, 14 Oct 2024 12:29:30 -0500
From: Bjorn Helgaas <helgaas@kernel.org>
To: Terry Bowman <Terry.Bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	dave@stgolabs.net, jonathan.cameron@huawei.com,
	dave.jiang@intel.com, alison.schofield@intel.com,
	vishal.l.verma@intel.com, dan.j.williams@intel.com,
	bhelgaas@google.com, mahesh@linux.ibm.com, oohall@gmail.com,
	Benjamin.Cheatham@amd.com, rrichter@amd.com,
	nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Message-ID: <20241014172930.GA612951@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <17857590-4fca-4c55-b1d7-85a0b22519b6@amd.com>
Status: O
Content-Length: 2161
Lines: 38

On Mon, Oct 14, 2024 at 12:22:08PM -0500, Terry Bowman wrote:
> On 10/10/24 14:07, Bjorn Helgaas wrote:
> > On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
> >> This is a continuation of the CXL port error handling RFC from earlier.[1]
> >> The RFC resulted in the decision to add CXL PCIe port error handling to
> >> the existing RCH downstream port handling. This patchset adds the CXL PCIe
> >> port handling and logging.
> ...

> >>     Downstream switch port CE:
> >>     root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
> >>     [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
> >>     [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
> >>     [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
> >>     [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
> >>     [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
> >>     [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
> >>     [  177.119521]
> >>     [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'
> > 
> > Thanks for the hints about how to test this; it's helpful to have
> > those in the email archives.  Remove the timestamps and non-relevant
> > call trace entries unless they add useful information.  AFAICT they're
> > just distractions in this case.
> 
> I'll remove the test logging and details from the cover sheet. I'm
> unable to find how to attach using git tools. Instead of an
> atatachment, I can locate the log files and details on a public
> github. Let me know if this is not acceptable.

It's fine to keep this in the cover sheet, and I'd rather have it
there, where lore will archive it reliably forever, than to have a
pointer to some other github that may eventually disappear even though
it's public today.

I just meant to remove irrelevant information like the timestamps.

Bjorn

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2072.outbound.protection.outlook.com [40.107.236.72])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 438C229A0;
	Mon, 14 Oct 2024 17:33:48 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.236.72
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728927230; cv=fail; b=sNVZtezH9iKan69MjMaB1ut/CUgxc+nVdgylTfSznn9/OjtAlsYCpgRn3kG3OnffCtG/yws3kad6g9LJ84+yy0aWXan7UBWFYLj7TpGB7ans5qTOwjwW0Tc6slc7FZwGDpbhcaavhrIzLA67pKpQG15IgjqEmb7IKMANy/qr5nc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728927230; c=relaxed/simple;
	bh=IOWiaKNmhgjZbprwVZkfyPiJHzV54wVUwY8DrhvNfNI=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=Rt4KjwQiyNVGz2AhwKfD26KMIE8MPM57a0QrA8Ij95K7Y0/pzYRHIBXzAHgDfCRQ/026jT4X5Z5LxK/rma7A6PDBANgny3R5eOWPRS2jjEnZajCyjnCJJ+ioi7pHmF+AzNiHtYR1X/tZHpBLR17FWDACk3lwyX6ZlbHNLbUr4bI=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=cEAVo5Up; arc=fail smtp.client-ip=40.107.236.72
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="cEAVo5Up"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=f+aadpL1kMs+1T9IIxEZ7g3iYD69/uTcf7jX+UjJuCvkryunPt7MjMpfoAiGqhN23qb46eIb9GWYTogqJgzrNfpysHsUxP6JmwBCeQSwwe0sGJXEPhLj7NbuWNQ+6ESHoLvWqFuz8Nf48W2d/w1jb3mHs1880lKBTdK6kMJzJ5+PYv+IBgbeYtMXZtFQ8/0ML1vbmmAZRoUzplIplnDhQmyk5BDLsrxCRyLgG6/BDqDjFPA9yDefRqagdjGukyuC7wIZ0Svd0hxgYxuFPdpkZ+oa9OGKUkaf0gFoEKlTKBk7gaNuaZvAvpoAZD4TVDZUKqPHER1FLim+Wer13+iNLQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=2xUIH/tZ7sBd64nODDdrfTJzm8M5jiAnJZbfdNqDSko=;
 b=qrM+QXCEYax80ChjdTZ2umDULgcOPadSlvlDJZYQok38ahfA4ojIvP4j1nYr3ESSDeesl3NrmslV4ZmNiHaHfatyxm35JR4ZRqc4JRfGHvug5hpl+YB9nncGsC5DD1m6To/Xvke1Lu9nXG06yDiV4BIprq2RD3Y83QGqxa2xpnKOWBxUM8fehpBggJLzG6+kkAFYWSLWaQ4BBVpQgUdlh2wnCHo0fVMcqmFppZeE+rPPpRPC/YEMLC6gkjbFgQDCWbWisiT/TRwLqwtZ8wox2jAK94gRc6TFvfmIEO2gOymvDnmaKzNusl/vprEzbl522kbQhrEpoIUU0TtEInPGuQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=2xUIH/tZ7sBd64nODDdrfTJzm8M5jiAnJZbfdNqDSko=;
 b=cEAVo5Upwj/ItPFmAmqDAcePXHv+TpHVCXKjlWHEjIavpkDrNnp2Nq2RxjUNAZvxQGVsySvGjIiSJVbTWwyaaxuk/jCRzUYx4r40VIH4HJGQrLZv0PimgHct0w1lGE99aREtNghdlEpEnvK5YP5XacVwG1y/n0SR97NPm8yR0/8=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 SJ2PR12MB8927.namprd12.prod.outlook.com (2603:10b6:a03:547::9) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.8048.27; Mon, 14 Oct 2024 17:33:46 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Mon, 14 Oct 2024
 17:33:46 +0000
Message-ID: <d9d87f72-6273-4adc-934c-e25ee79bb8c7@amd.com>
Date: Mon, 14 Oct 2024 12:33:44 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Content-Language: en-US
To: Bjorn Helgaas <helgaas@kernel.org>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 jonathan.cameron@huawei.com, dave.jiang@intel.com,
 alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241014172930.GA612951@bhelgaas>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241014172930.GA612951@bhelgaas>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0050.namprd11.prod.outlook.com
 (2603:10b6:806:d0::25) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|SJ2PR12MB8927:EE_
X-MS-Office365-Filtering-Correlation-Id: 69f4c50c-ad25-461a-61f7-08dcec765b3c
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|376014|7416014|366016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?UTRKTUNRaCtDNnFBejhXdlRyaHRhWkVDd2FwakpuRzVrZGI4dk5xNEhjMFJO?=
 =?utf-8?B?b09jN2ZFelhlYlpSeVJHRTBwMG9HYkYyZnkzSExqL0M1cFlmZWhXWTZwSzIw?=
 =?utf-8?B?UUlVMk5GVEtDcmdidmg4d2NzQkpMa3VrRFlLRWlvRnhTTzFQZjZYbGRndGY5?=
 =?utf-8?B?aUJmRkg3blFGOTVvSTZ4UVRTemVrN0x1b1JmV05WZmhEY1J6ZWRac3U2UDgz?=
 =?utf-8?B?T0Z1dUZTRlhLT3FnRXU4ZVhHNlZvWm5sN1JXam11bFVWUWpldlI2b1E1U0ta?=
 =?utf-8?B?S3AwK21Md1ZGS1VsNmhaWmQxVG5CRUc1ZE90OUJOaG1NUTRtMGZEbkhYenFU?=
 =?utf-8?B?VmtzTnUwcmhjQzd2ZjRXZnlzUS9IbUxrVklaQ1NlSjYyazhHZUVSM05kRzRh?=
 =?utf-8?B?T0pTdU9JQVdDcGJuQU9FWmZzVlFnN044MWNmMGNkc05LcythNlMxRm9ONXg3?=
 =?utf-8?B?YldJRVNwNkJURUw4RDdUNFlsL01uSEFaRTNmWU9zTzhab1BwUkRVL0lZY0gy?=
 =?utf-8?B?ZUFldEE1VjJ4Wlp1ZjZYK2ZMTHZobEdCWnZtb1JVY2txcTIzQmNtZTRFRERM?=
 =?utf-8?B?RlVGdDVUejMyb0NqV0s4RTZRMG9STm9zN0Z1NUVSdnRhZWRHMjlNamFoKy9h?=
 =?utf-8?B?bldkditKbTNZc0t3Um45QW41Z0V6Mmc0OWIxVFJwT0tZWnJ1UzJyeDFBMkVq?=
 =?utf-8?B?cEtya3JyakFhMjRWeFVTYTFReU5IMUx2dXhFTUh1cWlrYkQ2ODloUUNNbVp6?=
 =?utf-8?B?QWVCd3pOTzdjNTZybTJiMGRjNDFRSWI0YkhyWjd6U0tuNHNvbnhmSWV6N0xL?=
 =?utf-8?B?VEVNZHdpdmtHWkdOLzlvS0ZvYy9zbFVIOGFCdHRCc0dJMXZqZFVZYzNMejlp?=
 =?utf-8?B?cUVmQWc5WmJYbHFOREt4NlVIWDRQdGlQTlNPS1d1cmNXRXpuUG1wWjhpcDV4?=
 =?utf-8?B?OWljYTNHc3FDZEhyZmRoQmxhR1UrVWY4d0ZCYkdmb2pDQmxwR2owV2V0Rk5u?=
 =?utf-8?B?dU9sQnNMWExjcy9yNDB6aWtKZllTMUlEYThMOVI3R29tQVExcUZMbFVyRENW?=
 =?utf-8?B?cmhWUndVRW5FVDdnRTY0SnQ5T2tXak5MZGNITHZVL3M4L2l0ZS8xbWJIWEVM?=
 =?utf-8?B?ak1nZGVqUFhaNzRxbllYVmlXZ2NJbVRkdENNNEtRWEVnRFhZTHNmZVdNRXlY?=
 =?utf-8?B?TC9wcnljWldJeG1BMlNoV2pzbW5IajRCbm1HRW9TclgxeGpQODNHcmt1SHZ0?=
 =?utf-8?B?azZSWnpMVEVEMzF4WFhOODhMd1FPaURkMHUxcS9xZHRtU3VRVmc1L1lKbGN0?=
 =?utf-8?B?cFVyRG5hc0V2MmdNMTVVNm01bHl1c1ZqMjh2aVhzS0hmTjZ4ZmpwMDBOTjFm?=
 =?utf-8?B?SWpBR0FzQXFGelhMU0NGUHYzb2VySTZnUFRzZ0wrSFRwVDROK1cwdU9ad1BE?=
 =?utf-8?B?K3ZLbEo5UmN0b25ybnpOU1pGSGRJRUZKdiszNzI4bGZZZVdtb1pwMEl6WHVP?=
 =?utf-8?B?R2NUSk5GYUF5NGNIM0hpVGpIc2VVb21KelhRRlNvME5xcERjc3ZPWkVoclM0?=
 =?utf-8?B?RTFoc1FsdTg4eHlrdlFQcUFqb3N2a0daa2VjRDA2VnVVUlJWVklucGtBWi9Y?=
 =?utf-8?B?ckU2MUQ5NzFsa2YyRW5Vb2hCU3UrclZJQmxDd280NGRVU2JVOElKVWxqSWs1?=
 =?utf-8?B?bS9PTGRMb1QrSUcreGQrTzdtUWJOdGhXMzkxR2dWY213QmhMREJRMDRnPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(376014)(7416014)(366016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?M0xaVGxKNnhkYmtlaEMyTWM0SVRnOFBDS1puamdIL1VlNFdqNklGWHpZQXlQ?=
 =?utf-8?B?TFkreWhGUEVpZkxyRGU5TWJGdkFkNWZlVU1TMU5Lengya3h6M0Jyc0EwbEZs?=
 =?utf-8?B?RUVQQXQ5WDZFUTZiMDZKSUcva2w3UmRtRThqcGRXckNBdmxCUGNQTzRtZXdC?=
 =?utf-8?B?SmpacVIrSVBEc2FzRlBKRUVzSHUzdnBKMXZkZnA1NmxoajFMUDZPa2pMTnM1?=
 =?utf-8?B?cXpzbkdidFM5OFMwY2dzb1RtVERIdkkvODBRVHdCd0w3V1JFN05HdVBrZ1Z1?=
 =?utf-8?B?QWlrOS9SV3lUanE1YlpWUHdMZXQ1ZTNQQUc3bm5RVVE0WVYwV2RGL0p5TmVp?=
 =?utf-8?B?T09DSmhqL2hvV3o5RXVKblU4Y0tRTlNLdm95RnU4R3ZQa2pyWFplUVBkdm4v?=
 =?utf-8?B?QkNOTkI1WWpEcWphT1Y1d1VLR3hlNU40d2cxTEYvMDFkRE5GUmg0Q0NUMEx3?=
 =?utf-8?B?ZEwrV3dSOStCaEd6NGR0dmFZUzhHOE5ZdWFWSmMrYit1Mmxvam1kbCtyeFls?=
 =?utf-8?B?YVNJNWZseUVKNENQcnExcXBEcjdPSktjUEdCNXZYaXBsMVJFODJVRE1wNzBs?=
 =?utf-8?B?empNd3pkS25OY2xMTkJDa1BiRERmWHdKQ0hpN2VKS0pnL1NxdGFmV3hURVB3?=
 =?utf-8?B?SmprYU5vVVVMUzZ4d1JBaC8rbHJ2b2t5Y3lFbGJZVFJnWDNQV0JKRXF5eWtw?=
 =?utf-8?B?dGw4K1c3VHhqK1NMQUY4UDJjbFpTTUVocXBzTFBZbUk0a09aS2kxS254UHNk?=
 =?utf-8?B?dmkrc1pvT2xPSTJjWStYV2J5MmRGZ1hMZk01SUcwS1NmejlRZ2tEdHBuTnJ2?=
 =?utf-8?B?UzVidmsrczk3THJ3cmNzZVFwK3dvR2VNcGpJWHBFYUpIMVZkOEZWQThVeURu?=
 =?utf-8?B?NVNFVkFvZEdDQkdSSlBLZkxtVTFXNG1jd0VCV0pJQU5paUVlUDUxZzZvc2hF?=
 =?utf-8?B?RHJMbTZSRFhjYTlUL1hUYUU0TUpyOFVENytUdVoxcElNRXNmSFFqMHdGek9y?=
 =?utf-8?B?VlpMRlgrU2dNRC9GUUplNEU1SjJldm9HZldEZlIvMmh0WkNzNndXNCszeU1Y?=
 =?utf-8?B?bm5qSmp1VnNDU1VpU2xFeGVyVW15STlrbk1YSkFjWkJWbENmTU13ZnRKMG8z?=
 =?utf-8?B?ZDltQXk4N3c1T2tOMmZmNE41bzZCQnRYSy9xV1BBNFllTi81U2RFaTA2S09M?=
 =?utf-8?B?UWtpY1JnMitmM3d1dUNqaUhiY2tsUWhIZ09pendzUDBKMUVnZ3pEYW5oVjB6?=
 =?utf-8?B?UGxPRFZTR29SOTlRWnoyNVdCZEFHQitPejYrS3pMUWY2OEtCSU1LSzVHZzVE?=
 =?utf-8?B?ZHJsNjZ2ZG5PU1UyNDM5WG9YVXE0SmJPcTNZNWlwaXUwbUxhWGhic0x0THQ4?=
 =?utf-8?B?azBqQ0lxZGh2ait1Z2hhMyszMUZQMGdDWlc2Q2dOQnlkV0o3NEpBZkhjL1NJ?=
 =?utf-8?B?KzZMSHVvcGxHem1QWnU5RmRRa3R2V0doZldQbFk3T0VkMEoyNjFpZnhEYjhT?=
 =?utf-8?B?ZlF1ZFQwT1VZcCtrSWhJb2lhbWtiWEFscWgydlBkT2VOd25WT2k0RDdYMGc5?=
 =?utf-8?B?bUlkSjRmTVFBM0cvaGxkemtqZktLa1NmZUYxY29ENnc4ZXFoVlE3V2FjOW1C?=
 =?utf-8?B?Z2dmbHl1WEo1ZTNtdUJlQlNlMk5tR1ZJS0lCUkJuNkw4Sm5UZXAvb3JLWE1j?=
 =?utf-8?B?QmVLM0RBVkNUdmpvWFFHSElrbW9DWC9SV2Q4NHk0UkI5aXhxRGlLVGdYbHFP?=
 =?utf-8?B?NlNGdXI5M2wzYU1DSjJGV2F3Qm4yVTFMd0xHTkJvcGlnaTk1VndYYjdwb0NJ?=
 =?utf-8?B?NkEyZ1ViMWtVaExuYWRSYkdxUTFEbEpaM25YbUhzWUJEMEJJN3I3N3VaNVhl?=
 =?utf-8?B?VVdCMFdqV1BObTRDOHMybU5ROU5rcWppYThMV1puMmlpQTB5NXAzc1NlWEtt?=
 =?utf-8?B?emZyNkk4ejBoeFhqNDdkY2lJY3ZXcVh3WW1COUFkSWZOL2VsbzQ5SmhWRGhC?=
 =?utf-8?B?dXRzUVUrb1JTT2Q2czV3WmcxMHZiZUlCNEhGV3lmVHF3T1dUU0ZNalFpQ0ZK?=
 =?utf-8?B?am42UTlKTk5keVFkd3BMNWhHb1J4cjFWNGZJc3FnM2JvQ2I3elFSak5Rdnls?=
 =?utf-8?Q?AzsvTwQiU++rhn/TRzZZmRFmn?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 69f4c50c-ad25-461a-61f7-08dcec765b3c
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 14 Oct 2024 17:33:46.1938
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: yLPxfpCpaYTX04kYqfaEpuQMcNwz6TwgRpSDD9Sl4E14mclrNlmBJDDyBVQ8v37z0VTnNIa/26mdX0mUr2U6TQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ2PR12MB8927
Status: O
Content-Length: 2288
Lines: 46



On 10/14/24 12:29, Bjorn Helgaas wrote:
> On Mon, Oct 14, 2024 at 12:22:08PM -0500, Terry Bowman wrote:
>> On 10/10/24 14:07, Bjorn Helgaas wrote:
>>> On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
>>>> This is a continuation of the CXL port error handling RFC from earlier.[1]
>>>> The RFC resulted in the decision to add CXL PCIe port error handling to
>>>> the existing RCH downstream port handling. This patchset adds the CXL PCIe
>>>> port handling and logging.
>> ...
> 
>>>>     Downstream switch port CE:
>>>>     root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
>>>>     [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
>>>>     [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
>>>>     [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>>>>     [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
>>>>     [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
>>>>     [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>>>>     [  177.119521]
>>>>     [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'
>>>
>>> Thanks for the hints about how to test this; it's helpful to have
>>> those in the email archives.  Remove the timestamps and non-relevant
>>> call trace entries unless they add useful information.  AFAICT they're
>>> just distractions in this case.
>>
>> I'll remove the test logging and details from the cover sheet. I'm
>> unable to find how to attach using git tools. Instead of an
>> atatachment, I can locate the log files and details on a public
>> github. Let me know if this is not acceptable.
> 
> It's fine to keep this in the cover sheet, and I'd rather have it
> there, where lore will archive it reliably forever, than to have a
> pointer to some other github that may eventually disappear even though
> it's public today.
> 
> I just meant to remove irrelevant information like the timestamps.
> 
> Bjorn

Ok, I'll cleanup and leave here. Thanks.

Regards,
Terry

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 88B7A205E23;
	Wed, 16 Oct 2024 16:12:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729095126; cv=none; b=Rwjq3kRf3tQkO9SN1MrDzh7P0M4HpVvjPFbUFQOx7V2+mXBBlyCcUVzk6hE1HUJ12RQmUCwA1ypixqdvGuJxb/X95qPTROqabc5B/PL7Er2jkjwCrnFuqgJiO37PssvSlpbqVu/UqsO52iElS4Pfo29HF+WRlW9m24jqG6QiNJw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729095126; c=relaxed/simple;
	bh=olTAeeYy1NLCDapKRpMFnDBIFDr4TFhhnSmanR1b1mk=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=ehk5COW9KasvBTqZPNbxkdmYfEbgYDHEpKmgJ4ba1XSmA4BjN/jHjXcZHCV+/f6GZOlo9Z96F0CCWmcEBrkWXwWuCdFjnrlPMTmaLEuCgCDbb3pL89dF09c7QPEHFifCcQnGUu68vqfYW9qR9k8V+LZvBNXIskSJeWRXRLyw4Eg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.231])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTGDT5Fx0z6D8q7;
	Thu, 17 Oct 2024 00:11:21 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 6E5B51400DB;
	Thu, 17 Oct 2024 00:11:59 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 18:11:58 +0200
Date: Wed, 16 Oct 2024 17:11:57 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 02/15] cxl/aer/pci: Update is_internal_error() to be
 callable w/o CONFIG_PCIEAER_CXL
Message-ID: <20241016171157.00004898@Huawei.com>
In-Reply-To: <20241008221657.1130181-3-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-3-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100004.china.huawei.com (7.191.162.219) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 741
Lines: 20

On Tue, 8 Oct 2024 17:16:44 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> CXL port error handling will be updated in future and will use
> logic to determine if an error requires CXL or PCIe processing.
> Internal errors are one indicator to identify an error is a CXL
> protocol error.
> 
> is_internal_error() is currently limited by CONFIG_PCIEAER_CXL
> kernel config.
> 
> Update the is_internal_error() function's declaration such that it is
> always available regardless if CONFIG_PCIEAER_CXL kernel config
> is enabled or disabled.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
Given this has nothing specifically to do with CXL, this seems
sensible to me.

Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 66E2145008;
	Wed, 16 Oct 2024 16:22:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729095764; cv=none; b=NbZ+o/RfzsnK2YoKaX9biAuA+KCXroz1PuxSTTl1srBf7OcxO173L4MAuRo2IijkuQYUMkBhf6zlHqNh1ec/rV+zw3tMyJz+DULhL8OpjTy5fmElz4NSJva3YUS+xtGHminsDUhxcC4b6jILe3qbmbJ7u6yBYX0zDettlS7fCUg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729095764; c=relaxed/simple;
	bh=MvQA7IS7CGySYRfDQZKf2ZKM0e6XoSwsxyFBT+rE0GY=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=iTBy0TApgBWr5YT5XcfAGclerQmF7yPyjiAVKheL3HtLyYksvfjIZnMFQrLAs1WSPDkznGZ/PMHv1ag4WVHwzjTbZ78FkxmUQfkhqA66gI97JaaDPqOqhCPKi6V/VJeqvM6ZNq9EF9w36PALazqdylkfzyVPswvV0V0FKO0QjYo=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.31])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTGRX4hTvz6G9Mj;
	Thu, 17 Oct 2024 00:20:56 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id E06081400C9;
	Thu, 17 Oct 2024 00:22:37 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 18:22:37 +0200
Date: Wed, 16 Oct 2024 17:22:35 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 04/15] cxl/aer/pci: Add CXL PCIe port correctable error
 support in AER service driver
Message-ID: <20241016172235.00001e65@Huawei.com>
In-Reply-To: <20241008221657.1130181-5-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-5-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100004.china.huawei.com (7.191.162.219) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 2491
Lines: 71

On Tue, 8 Oct 2024 17:16:46 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The AER service driver currently does not manage CXL PCIe port
> protocol errors reported by CXL root ports, CXL upstream switch ports,
> and CXL downstream switch ports. Consequently, RAS protocol errors
> from CXL PCIe port devices are not properly logged or handled.
> 
> These errors are reported to the OS via the root port's AER correctable
> and uncorrectable internal error fields. While the AER driver supports
> handling downstream port protocol errors in restricted CXL host (RCH)
> mode also known as CXL1.1, it lacks the same functionality for CXL
> PCIe ports operating in virtual hierarchy (VH) mode, introduced in
> CXL2.0.
> 
> To address this gap, update the AER driver to handle CXL PCIe port
> device protocol correctable errors (CE).
> 
> The uncorrectable error handling (UCE) will be added in a future
> patch.
> 
> Make this update alongside the existing downstream port RCH error
> handling logic, extending support to CXL PCIe ports in VH.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
Minor comments inline.

J
> ---
>  drivers/pci/pcie/aer.c | 54 +++++++++++++++++++++++++++++++++---------
>  1 file changed, 43 insertions(+), 11 deletions(-)
> 
> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
> index dc8b17999001..1c996287d4ce 100644
> --- a/drivers/pci/pcie/aer.c
> +++ b/drivers/pci/pcie/aer.c
> @@ -40,6 +40,8 @@
>  #define AER_MAX_TYPEOF_COR_ERRS		16	/* as per PCI_ERR_COR_STATUS */
>  #define AER_MAX_TYPEOF_UNCOR_ERRS	27	/* as per PCI_ERR_UNCOR_STATUS*/
>  
> +#define CXL_DVSEC_PORT_EXTENSIONS	3

Duplicate of definition in drivers/cxl/cxlpci.h

Maybe wrap it up in an is_cxl_port() or similar? Or just 
move that to a header both places can exercise.


> +
>  struct aer_err_source {
>  	u32 status;			/* PCI_ERR_ROOT_STATUS */
>  	u32 id;				/* PCI_ERR_ROOT_ERR_SRC */
> @@ -941,6 +943,17 @@ static bool find_source_device(struct pci_dev *parent,
>  	return true;
>  }
>  
> +static bool is_pcie_cxl_port(struct pci_dev *dev)
> +{
> +	if ((pci_pcie_type(dev) != PCI_EXP_TYPE_ROOT_PORT) &&
> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_UPSTREAM) &&
> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_DOWNSTREAM))
> +		return false;
> +
> +	return (!!pci_find_dvsec_capability(dev, PCI_VENDOR_ID_CXL,
> +					    CXL_DVSEC_PORT_EXTENSIONS));

No need for the !! it will return the same without that clamping to 1/0
because any non 0 value is true.

> +}
> +

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id D8ACC210183;
	Wed, 16 Oct 2024 16:29:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729096148; cv=none; b=fLnR6x939sBt2Bz3UpLQnHA8QY5QDuDBxHlXBwvi0h00aOpo6k1LfAjmgg1p7apcN0JqE4WJ6nTZma5n2c13CvpCxDTtyhwxYIcrx5WG+GBAhQrcB4J6/6FW4PPlBn6oDq81GH8H/wRK8YPJVzbzyMAVSuJ1eBIOv5b+1SyBpQI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729096148; c=relaxed/simple;
	bh=m03GgYfpjhsbMSm0//osAxU4REPjr4beIsD/5qr/bus=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=iQOIL9L3Oij8CGxyEKri27gyvVKZ3ZGEbw31DH7ze7B+FQ2nqT7WOiLO3RrNHwXaebb8IgOB5WlSR9dpe/JWsOxgRhD4FLmND+FK+8+RfgrLIz1b4W9NdoV+Wmf/04zWBoS9447Zixh1VYSU0pPN/FjvvnJf+J7D5dXUuHW3On0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.231])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTGc74yg5z6JB1g;
	Thu, 17 Oct 2024 00:28:23 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 6CF221400DB;
	Thu, 17 Oct 2024 00:29:01 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 18:29:00 +0200
Date: Wed, 16 Oct 2024 17:28:59 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 05/15] cxl/aer/pci: Update AER driver to read UCE fatal
 status for all CXL PCIe port devices
Message-ID: <20241016172859.00004209@Huawei.com>
In-Reply-To: <20241008221657.1130181-6-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-6-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml500005.china.huawei.com (7.191.163.240) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 1591
Lines: 46

On Tue, 8 Oct 2024 17:16:47 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The AER service driver's aer_get_device_err_info() function does not
> read uncorrectable (UCE) fatal error status from PCIe upstream port
> devices. As a result, fatal errors are not logged or handled as needed
> for CXL PCIe upstream switch port devices.

I wonder why not?  Is this the first ever upstream port to
report an uncorrectable error (that didn't mean the link was
down) or is there something more subtle going on.

PCI folk, this one looks like it might cause problems to me.

> 
> Update the aer_get_device_err_info() function to read the UCE fatal
error_info()

> status for all CXL PCIe port devices.
> 
> The fatal error status will be used in future patches implementing
> CXL PCIe port error handling and logging.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> ---
>  drivers/pci/pcie/aer.c | 1 +
>  1 file changed, 1 insertion(+)
> 
> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
> index 1c996287d4ce..9b2872c8e20d 100644
> --- a/drivers/pci/pcie/aer.c
> +++ b/drivers/pci/pcie/aer.c
> @@ -1282,6 +1282,7 @@ int aer_get_device_error_info(struct pci_dev *dev, struct aer_err_info *info)
>  	} else if (type == PCI_EXP_TYPE_ROOT_PORT ||
>  		   type == PCI_EXP_TYPE_RC_EC ||
>  		   type == PCI_EXP_TYPE_DOWNSTREAM ||
> +		   type == PCI_EXP_TYPE_UPSTREAM ||
>  		   info->severity == AER_NONFATAL) {
>  
>  		/* Link is still healthy for IO reads */
So this comment makes me worried.  In general case the fatal
error may mean we can't talk to the USP?

Jonathan



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 85D1015E5CA;
	Wed, 16 Oct 2024 16:30:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729096219; cv=none; b=I5e/4cuWhndCyaGG1A9UlZNAmtabhcp7Sn2OphVP85Edm7vIykY32qbblqmkZ+qC6GQ9A8ZLW0TyaTn415+KK+F0GNHviPEgX+ehRlkuctvFbFNJIDio5yGEj0Su+bb4Ast3rKukQaaFmwLE9jKZ/TbvfNwIha/5IRNg4fwAE/0=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729096219; c=relaxed/simple;
	bh=ifgkVkIER1fekyXXjdFz/dVArNLvS3sJe+MD8HitC70=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=t/l0Jj/JuoRu1VFO0XfNsvVp4MZS6d61RH0HYRQoMN9+tfMB+06yVrR99+HIiVjWsohjfpoqVcAY9RPT5zaLvLf+vOZU7UROBux90vDO2qcz/30ZU3FCZtIdDU7J65cwXrh6tr7nYtnGSqNHnGen9un0qMUrMQAODgmuC85UaYc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTGcJ4qxZz6J67l;
	Thu, 17 Oct 2024 00:28:32 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id E977A140B39;
	Thu, 17 Oct 2024 00:30:13 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 18:30:13 +0200
Date: Wed, 16 Oct 2024 17:30:11 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 06/15] cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to
 pci_ers_result type
Message-ID: <20241016173011.000021e4@Huawei.com>
In-Reply-To: <20241008221657.1130181-7-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-7-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml500005.china.huawei.com (7.191.163.240) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 990
Lines: 32

On Tue, 8 Oct 2024 17:16:48 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The CXL AER service will be updated to support CXL PCIe port error
> handling in the future. These devices will use a system panic during
> recovery handling.

Recovery handling by panic? :) That's an interesting form of recovery..

> 
> Add PCI_ERS_RESULT_PANIC enumeration to pci_ers_result type.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> ---
>  include/linux/pci.h | 3 +++
>  1 file changed, 3 insertions(+)
> 
> diff --git a/include/linux/pci.h b/include/linux/pci.h
> index 4cf89a4b4cbc..6f7e7371161d 100644
> --- a/include/linux/pci.h
> +++ b/include/linux/pci.h
> @@ -857,6 +857,9 @@ enum pci_ers_result {
>  
>  	/* No AER capabilities registered for the driver */
>  	PCI_ERS_RESULT_NO_AER_DRIVER = (__force pci_ers_result_t) 6,
> +
> +	/* Device state requires system panic */
> +	PCI_ERS_RESULT_PANIC = (__force pci_ers_result_t) 7,
>  };
>  
>  /* PCI bus error event callbacks */


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 711B41FDF99;
	Wed, 16 Oct 2024 16:54:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729097676; cv=none; b=uhSZ73Ia7xgrSmeu/Y50198UHWXrqghl98MEddUtf3nUK34XpBJLpuU5P4YBMrifP8uZ86yzZN3FcOxGHzQSZ0ekG0e4PjZj0s1D36Qp2M1JOAux3JWlZFvjV2O3iss1wO0GX7Q1VqEMgZXe8AcLxUQyuB3AaMsE/5mpqtZT21c=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729097676; c=relaxed/simple;
	bh=PYlv1pv0ilaHXl9zv60mR5y5zmk1H8dbAl6VIgahPj4=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=mFFwbHegblbdRWS9RGDFRYg/nPcSrzKVkaHi+MBXrTtXZBcGEfmgb7zbdB5Cp9gGfTkI2p57JbQI0DWv/IkXfE9HQlGLSNJxu76qdbeIHEorGXPRz23gxxaJe7o0jg3Zee2L6LVYGFhRD8PbUIfxRtxQXQ7WY5/7bVbFer4hONw=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTH522zhRz6LDKl;
	Thu, 17 Oct 2024 00:49:58 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id A00E2140A86;
	Thu, 17 Oct 2024 00:54:28 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 18:54:27 +0200
Date: Wed, 16 Oct 2024 17:54:26 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable
 error recovery in AER service driver
Message-ID: <20241016175426.0000411e@Huawei.com>
In-Reply-To: <20241008221657.1130181-8-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-8-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml500003.china.huawei.com (7.191.162.67) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 7052
Lines: 204

On Tue, 8 Oct 2024 17:16:49 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The current pcie_do_recovery() handles device recovery as result of
> uncorrectable errors (UCE). But, CXL port devices require unique
> recovery handling.
> 
> Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
> specific handling to the new recovery function.
> 
> The CXL port UCE recovery must invoke the AER service driver's CXL port
> UCE callback. This is different than the standard pcie_do_recovery()
> recovery that calls the pci_driver::err_handler UCE handler instead.
> 
> Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
> "recover" the error. A panic is called instead of attempting recovery
> to avoid potential system corruption.
> 
> The uncorrectable support added here will be used to complete CXL PCIe
> port error handling in the future.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>

Hi Terry,

I'm a little bothered by the subtle difference in the bus walks
in here vs the existing cases. If we need them, comments needed
to explain why.

If we are going to have separate handling, see if you can share
a lot more of the code by factoring out common functions for
the pci and cxl handling with callbacks to handle the differences.

I've managed to get my head around this code a few times in the past
(I think!) and really don't fancy having two subtle variants to
consider next time we get a bug :( The RC_EC additions hurt my head.

Jonathan

>  static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
> diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
> index 31090770fffc..de12f2eb19ef 100644
> --- a/drivers/pci/pcie/err.c
> +++ b/drivers/pci/pcie/err.c
> @@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
>  	return 0;
>  }
>  
> +static int cxl_report_error_detected(struct pci_dev *dev,
> +				     pci_channel_state_t state,
> +				     enum pci_ers_result *result)
> +{
> +	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
> +	struct pci_driver *pdrv;
> +	pci_ers_result_t vote;
> +
> +	device_lock(&dev->dev);
> +	cxl_port_hndlrs = find_cxl_port_hndlrs();

Can we refactor to have a common function under this and report_error_detected()?

> +	pdrv = dev->driver;
> +	if (pci_dev_is_disconnected(dev)) {
> +		vote = PCI_ERS_RESULT_DISCONNECT;
> +	} else if (!pci_dev_set_io_state(dev, state)) {
> +		pci_info(dev, "can't recover (state transition %u -> %u invalid)\n",
> +			dev->error_state, state);
> +		vote = PCI_ERS_RESULT_NONE;
> +	} else if (!cxl_port_hndlrs || !cxl_port_hndlrs->error_detected) {
> +		if (dev->hdr_type != PCI_HEADER_TYPE_BRIDGE) {
> +			vote = PCI_ERS_RESULT_NO_AER_DRIVER;
> +			pci_info(dev, "can't recover (no error_detected callback)\n");
> +		} else {
> +			vote = PCI_ERS_RESULT_NONE;
> +		}
> +	} else {
> +		vote = cxl_port_hndlrs->error_detected(dev, state);
> +	}
> +	pci_uevent_ers(dev, vote);
> +	*result = merge_result(*result, vote);
> +	device_unlock(&dev->dev);
> +	return 0;
> +}

>  static int pci_pm_runtime_get_sync(struct pci_dev *pdev, void *data)
>  {
>  	pm_runtime_get_sync(&pdev->dev);
> @@ -188,6 +245,28 @@ static void pci_walk_bridge(struct pci_dev *bridge,
>  		cb(bridge, userdata);
>  }
>  
> +/**
> + * cxl_walk_bridge - walk bridges potentially AER affected
> + * @bridge:	bridge which may be a Port, an RCEC, or an RCiEP
> + * @cb:		callback to be called for each device found
> + * @userdata:	arbitrary pointer to be passed to callback
> + *
> + * If the device provided is a bridge, walk the subordinate bus, including
> + * the device itself and any bridged devices on buses under this bus.  Call
> + * the provided callback on each device found.
> + *
> + * If the device provided has no subordinate bus, e.g., an RCEC or RCiEP,
> + * call the callback on the device itself.
only call the callback on the device itself.

(as you call it as stated above either way).

> + */
> +static void cxl_walk_bridge(struct pci_dev *bridge,
> +			    int (*cb)(struct pci_dev *, void *),
> +			    void *userdata)
> +{
> +	cb(bridge, userdata);
> +	if (bridge->subordinate)
> +		pci_walk_bus(bridge->subordinate, cb, userdata);
The difference between this and pci_walk_bridge() is subtle and
I'd like to avoid having both if we can.

> +}
> +
>  pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>  		pci_channel_state_t state,
>  		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> @@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>  
>  	return status;
>  }
> +
> +pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
> +				 pci_channel_state_t state,
> +				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> +{
> +	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
> +	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
> +	int type = pci_pcie_type(bridge);
> +
> +	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
> +	    (type != PCI_EXP_TYPE_RC_EC) &&
> +	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
> +	    (type != PCI_EXP_TYPE_UPSTREAM)) {
> +		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
> +		return status;
> +	}
> +

Would similar trick to in pcie_do_recovery work here for the upstream
and downstream ports use pci_upstream_bridge() and for the others pass the dev into
pci_walk_bridge()?

> +	cxl_walk_bridge(bridge, pci_pm_runtime_get_sync, NULL);
> +
> +	pci_dbg(bridge, "broadcast error_detected message\n");
> +	if (state == pci_channel_io_frozen) {
> +		cxl_walk_bridge(bridge, cxl_report_frozen_detected, &status);
> +		if (reset_subordinates(bridge) != PCI_ERS_RESULT_RECOVERED) {
> +			pci_warn(bridge, "subordinate device reset failed\n");
> +			goto failed;
> +		}
> +	} else {
> +		cxl_walk_bridge(bridge, cxl_report_normal_detected, &status);
> +	}
> +
> +	if (status == PCI_ERS_RESULT_PANIC)
> +		panic("CXL cachemem error. Invoking panic");
> +
> +	if (status == PCI_ERS_RESULT_CAN_RECOVER) {
> +		status = PCI_ERS_RESULT_RECOVERED;
> +		pci_dbg(bridge, "broadcast mmio_enabled message\n");
> +		cxl_walk_bridge(bridge, report_mmio_enabled, &status);
> +	}
> +
> +	if (status == PCI_ERS_RESULT_NEED_RESET) {
> +		status = PCI_ERS_RESULT_RECOVERED;
> +		pci_dbg(bridge, "broadcast slot_reset message\n");
> +		report_slot_reset(bridge, &status);
> +		pci_walk_bridge(bridge, report_slot_reset, &status);
> +	}
> +
> +	if (status != PCI_ERS_RESULT_RECOVERED)
> +		goto failed;
> +
> +	pci_dbg(bridge, "broadcast resume message\n");
> +	cxl_walk_bridge(bridge, report_resume, &status);
> +
> +	if (host->native_aer || pcie_ports_native) {
> +		pcie_clear_device_status(bridge);
> +		pci_aer_clear_nonfatal_status(bridge);
> +	}
> +
> +	cxl_walk_bridge(bridge, pci_pm_runtime_put, NULL);
> +
> +	pci_info(bridge, "device recovery successful\n");
> +	return status;
> +
> +failed:
> +	cxl_walk_bridge(bridge, pci_pm_runtime_put, NULL);
> +
> +	pci_uevent_ers(bridge, PCI_ERS_RESULT_DISCONNECT);
> +
> +	pci_info(bridge, "device recovery failed\n");
> +
> +	return status;
> +}


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C395820FAAB;
	Wed, 16 Oct 2024 17:15:04 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729098909; cv=none; b=QaeAF1TJ9k4SNOLlGwuS/HS+2lZJVSIG7Jgp6nWOXmpZEA1g/K/2jZHjYjpewD91FUnZSp23VbfBuXh1phpFvcw3DkYz706C29sxnwIsuuI5LTPPWJ/Jz0jlhTDyUK+qLcYCcElI5S1m6YG/TjPxHBK3/N1Jri1DM3544WDnzVk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729098909; c=relaxed/simple;
	bh=mvysEIx3kKKtCVA9J7u3T8Wc7Mr5NH3+qMChI6Zy3zw=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=kCq7lqA1nWl75Hvbc5135/TAqsygfbLkjoaPZqd+AClDRgQ+bxaqSLdGoVZ3EH2Y9OqPZisB5DewLOjFNYR12hbPxqYorXIG5owtfO7XY32Lw6LqwWrs1Erhtypb8FywVlwjFgPBuLdUAz8Plk0K4ClTiZ3iLodeNvGLqXuRiOU=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTHc01PVMz6J789;
	Thu, 17 Oct 2024 01:13:20 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 8A78B140A46;
	Thu, 17 Oct 2024 01:15:01 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 19:15:00 +0200
Date: Wed, 16 Oct 2024 18:14:59 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 09/15] cxl/pci: Map CXL PCIe downstream port RAS
 registers
Message-ID: <20241016181459.00000b71@Huawei.com>
In-Reply-To: <20241008221657.1130181-10-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-10-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100001.china.huawei.com (7.191.160.183) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 6933
Lines: 196

On Tue, 8 Oct 2024 17:16:51 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> RAS registers are not mapped for CXL root ports, CXL downstream switch
> ports, or CXL upstream switch ports. To prepare for future RAS logging
> and handling, the driver needs updating to map PCIe port RAS registers.

Give the upstream port is in next patch, I'd just mention that you
are adding mapping of RP and DSP here (This confused me before I noticed
the next patch).
> 
> Refactor and rename cxl_setup_parent_dport() to be cxl_init_ep_ports_aer().
> Update the function such that it will iterate an endpoint's dports to map
> the RAS registers.
> 
> Rename cxl_dport_map_regs() to be cxl_dport_init_aer(). The new
> function name is a more accurate description of the function's work.
> 
> This update should also include checking for previously mapped registers
> within the topology, particularly with CXL switches. Endpoints under a
> CXL switch may share a common downstream and upstream port, ensure that
> the registers are only mapped once.

I don't understand why we need to do this for the ras registers but
it doesn't apply for HDM decoders for instance?  Why can't
we map these registers in cxl_port_probe()?

End of day here, so maybe I'm completely misunderstanding this.
Will take another look tomorrow morning.

> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> ---
>  drivers/cxl/core/pci.c | 37 ++++++++++++++++---------------------
>  drivers/cxl/cxl.h      |  7 ++++---
>  drivers/cxl/mem.c      | 27 +++++++++++++++++++++++++--
>  3 files changed, 45 insertions(+), 26 deletions(-)
> 
> diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
> index 51132a575b27..6f7bcdb389bf 100644
> --- a/drivers/cxl/core/pci.c
> +++ b/drivers/cxl/core/pci.c
> @@ -787,21 +787,6 @@ static void cxl_dport_map_rch_aer(struct cxl_dport *dport)
>  	dport->regs.dport_aer = dport_aer;
>  }
>  
> -static void cxl_dport_map_regs(struct cxl_dport *dport)
> -{
> -	struct cxl_register_map *map = &dport->reg_map;
> -	struct device *dev = dport->dport_dev;
> -
> -	if (!map->component_map.ras.valid)
> -		dev_dbg(dev, "RAS registers not found\n");
> -	else if (cxl_map_component_regs(map, &dport->regs.component,
> -					BIT(CXL_CM_CAP_CAP_ID_RAS)))
> -		dev_dbg(dev, "Failed to map RAS capability.\n");
> -
> -	if (dport->rch)
> -		cxl_dport_map_rch_aer(dport);
> -}
> -
>  static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
>  {
>  	void __iomem *aer_base = dport->regs.dport_aer;
> @@ -831,7 +816,7 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
>  	}
>  }
>  
> -void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport)
> +void cxl_dport_init_aer(struct cxl_dport *dport)
>  {
>  	struct device *dport_dev = dport->dport_dev;
>  
> @@ -840,15 +825,25 @@ void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport)
>  
>  		if (host_bridge->native_aer)
>  			dport->rcrb.aer_cap = cxl_rcrb_to_aer(dport_dev, dport->rcrb.base);
> +
> +		cxl_dport_map_rch_aer(dport);
> +		cxl_disable_rch_root_ints(dport);
>  	}
>  
> -	dport->reg_map.host = host;
> -	cxl_dport_map_regs(dport);
> +	/* dport may have more than 1 downstream EP. Check if already mapped. */
> +	if (dport->regs.ras) {
> +		dev_warn(dport_dev, "RAS is already mapped\n");

This is valid. Why are we warning?
However why do we need this dance here but not for other
root port registers etc.


> +		return;
> +	}
>  
> -	if (dport->rch)
> -		cxl_disable_rch_root_ints(dport);
> +	dport->reg_map.host = dport_dev;
> +	if (cxl_map_component_regs(&dport->reg_map, &dport->regs.component,
> +				   BIT(CXL_CM_CAP_CAP_ID_RAS))) {
> +		dev_err(dport_dev, "Failed to map RAS capability.\n");
> +		return;
> +	}
>  }
> -EXPORT_SYMBOL_NS_GPL(cxl_setup_parent_dport, CXL);
> +EXPORT_SYMBOL_NS_GPL(cxl_dport_init_aer, CXL);
>  
>  static void cxl_handle_rdport_cor_ras(struct cxl_dev_state *cxlds,
>  					  struct cxl_dport *dport)
> diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.h
> index 9afb407d438f..cb9e05e2912b 100644
> --- a/drivers/cxl/cxl.h
> +++ b/drivers/cxl/cxl.h
> @@ -592,6 +592,7 @@ struct cxl_dax_region {
>   * @parent_dport: dport that points to this port in the parent
>   * @decoder_ida: allocator for decoder ids
>   * @reg_map: component and ras register mapping parameters
> + * @uport_regs: mapped component registers
>   * @nr_dports: number of entries in @dports
>   * @hdm_end: track last allocated HDM decoder instance for allocation ordering
>   * @commit_end: cursor to track highest committed decoder for commit ordering
> @@ -612,6 +613,7 @@ struct cxl_port {
>  	struct cxl_dport *parent_dport;
>  	struct ida decoder_ida;
>  	struct cxl_register_map reg_map;
> +	struct cxl_component_regs uport_regs;
>  	int nr_dports;
>  	int hdm_end;
>  	int commit_end;
> @@ -761,10 +763,9 @@ struct cxl_dport *devm_cxl_add_rch_dport(struct cxl_port *port,
>  					 resource_size_t rcrb);
>  
>  #ifdef CONFIG_PCIEAER_CXL
> -void cxl_setup_parent_dport(struct device *host, struct cxl_dport *dport);
> +void cxl_dport_init_aer(struct cxl_dport *dport);
>  #else
> -static inline void cxl_setup_parent_dport(struct device *host,
> -					  struct cxl_dport *dport) { }
> +static inline void cxl_dport_init_aer(struct cxl_dport *dport) { }
>  #endif
>  
>  struct cxl_decoder *to_cxl_decoder(struct device *dev);
> diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.c
> index 7de232eaeb17..b7204f010785 100644
> --- a/drivers/cxl/mem.c
> +++ b/drivers/cxl/mem.c
> @@ -45,6 +45,30 @@ static int cxl_mem_dpa_show(struct seq_file *file, void *data)
>  	return 0;
>  }
>  
> +static bool dev_is_cxl_pci(struct device *dev, u32 pcie_type)
> +{
> +	struct pci_dev *pdev;
> +
> +	if (!dev_is_pci(dev))
> +		return false;
> +
> +	pdev = to_pci_dev(dev);
> +	if (pci_pcie_type(pdev) != pcie_type)
> +		return false;
> +
> +	return pci_find_dvsec_capability(pdev, PCI_VENDOR_ID_CXL,
> +					 CXL_DVSEC_REG_LOCATOR);
> +}
> +
> +static void cxl_init_ep_ports_aer(struct cxl_ep *ep)
> +{
> +	struct cxl_dport *dport = ep->dport;
> +
> +	if (dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_DOWNSTREAM) ||
> +	    dev_is_cxl_pci(dport->dport_dev, PCI_EXP_TYPE_ROOT_PORT))
> +		cxl_dport_init_aer(dport);
> +}
> +
>  static int devm_cxl_add_endpoint(struct device *host, struct cxl_memdev *cxlmd,
>  				 struct cxl_dport *parent_dport)
>  {
> @@ -62,6 +86,7 @@ static int devm_cxl_add_endpoint(struct device *host, struct cxl_memdev *cxlmd,
>  
>  		ep = cxl_ep_load(iter, cxlmd);
>  		ep->next = down;
> +		cxl_init_ep_ports_aer(ep);
>  	}
>  
>  	/* Note: endpoint port component registers are derived from @cxlds */
> @@ -166,8 +191,6 @@ static int cxl_mem_probe(struct device *dev)
>  	else
>  		endpoint_parent = &parent_port->dev;
>  
> -	cxl_setup_parent_dport(dev, dport);
> -
>  	device_lock(endpoint_parent);
>  	if (!endpoint_parent->driver) {
>  		dev_err(dev, "CXL port topology %s not enabled\n",


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2064.outbound.protection.outlook.com [40.107.243.64])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 28E8D187350;
	Wed, 16 Oct 2024 17:18:12 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.64
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099094; cv=fail; b=pUOqB3d9ih5cN+aZDIcnYv0uBEKB/vtdSHw3PdzHJJ+z1H5Uwty8rtBRaT1jbl/nrYa3oxPVCMdd/JQ27BMHBV9pZ/dHU2UTCzM5i8LAW/md6GlB6XbGCNZgQxfX4zKwony/W2jTKHLm+Icpg4tLiiurQDr+tgt0WwhU+Xak29E=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099094; c=relaxed/simple;
	bh=Mf2NQxwEUzG0hNGDOICUGIwO0we3+sciI2oA06ytgeE=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=lvn8Mo7s8HsezRp6CQpel1Lth1A0ZDfB36DvaQ8484vK940W0P5quPXzZ5jvbBxlYVWrfOxWlZQwkhKYw/a2BI0vQbswQvgq4qNXVJhmx0fBZ5PzpeLfhQ98eSl9JN1VTDcJwlohEeGUz246LWgcddFRybTbzWSg0XoeFSOPNbQ=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=a7c2u9XJ; arc=fail smtp.client-ip=40.107.243.64
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="a7c2u9XJ"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=QhUgy0o1ULuK4VdFZ5gkN1b0qi0xVwIx1oh4e8nSfxfsNJCwfeeqWctWGra8p/xX4Ht7JNM9xbYd9YINNW0lvUFQz7WsBx80XZ4w9OZ04dzdH0mwI/xgKfArB+DJUbIAoCsXg5pabncO0LCZMhpc8US1v4dCQeFQA/NKBSOtQgkc9M5JfDPMi3tPhh+AVWFsAAvO1uot8lusJFgQsaWPMA0kCLs7S95tgOJYAsEUdAt6bQE+kO48BR4NcrrZ1Bi4XO21AqRlLcSgp/XpEiqeCjPRj+wj6MyeWMSat843mbvbqxt9hpTwGBOdi6xyv4GZNdxHdAxyo15mEhvK+TrMqg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=m9vwyarPFx21K7HnD2vTsc3gLCvBS+sI6fYFVlnIzO8=;
 b=RUEn+fO5YbjtJg3JcIuVTYalJA5GV98I0ediAQvuRgnxp4SO9tBphBWmyC4ruTS+dEIk4Az+W2cO5DR3e+R58xfP+zXQBbvaUmCyYOBUHsydUX8WAx69xe8QpZedBJJihgyTKS6HlIdXfW5ak8UrAiXCylmlQ/4OiwiAP+bZQy9Vn5HJSLdM09IcqmU11RLe1hFZAKpwAzn2mka6eLvJIt9iLnFUFVf4q1GGYTl5tTVTRwFrU8TnKE6+0j9a4nhZpWDRYfxxHj/g+nQq/sCPClFv4DGNKLsIsbpGfSxv73qpurqVJ+Si57qLBgp/nhUcmHtn6jsUSpSHB1shvC0bJw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=m9vwyarPFx21K7HnD2vTsc3gLCvBS+sI6fYFVlnIzO8=;
 b=a7c2u9XJ8xHdIZ79s42jLohxRavvkC5Sx3jH+Jx+LZOESDbX9yVc0YrHI1Bmm/SSO0Ueqx7ME54tPNUEBJsOV4Byxy0v+iozGEgvevFGZPNZb+5bWNr6rmabIz03er/3jISai0Pq5ke0H2Yfs8CJEyfA+vsVCKILLA61kb+tjUI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 CH3PR12MB8234.namprd12.prod.outlook.com (2603:10b6:610:125::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8069.18; Wed, 16 Oct
 2024 17:18:08 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Wed, 16 Oct 2024
 17:18:08 +0000
Message-ID: <b7e89c01-72c9-4e26-bd88-6cfcfdc78033@amd.com>
Date: Wed, 16 Oct 2024 12:18:06 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 04/15] cxl/aer/pci: Add CXL PCIe port correctable error
 support in AER service driver
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-5-terry.bowman@amd.com>
 <20241016172235.00001e65@Huawei.com>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241016172235.00001e65@Huawei.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN4PR0501CA0121.namprd05.prod.outlook.com
 (2603:10b6:803:42::38) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|CH3PR12MB8234:EE_
X-MS-Office365-Filtering-Correlation-Id: 450c4e9e-be17-4e5f-9a10-08dcee068107
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|1800799024|366016|376014;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?cFFxN2Zkb1gxNC8wa3JqdHFPRno1K3BZMVJFcFo0eUNIWXgzSWlQU01xdklL?=
 =?utf-8?B?UzV4OCtKNE1Fd0g4VU9IL2p1RjFYaVMwVVpqbDdVZkthREUrOU5tVTRHVk9B?=
 =?utf-8?B?blFleEZQTGlqWE1sc3pvZlJnbjJSdEdJbm1zODAvN003Ymg1YWFJQlo0QTZT?=
 =?utf-8?B?TTVXRjFkU2ZYNjh6VU5JcnMrbzV4dmhiSHFYK3IxSGhYY1M3OFpFWWprY2sr?=
 =?utf-8?B?UHZSYjB0djYzVk02N2VKQThUMHM4K0pqUXVYdC8zbk92R3NNL0NMand5WFQv?=
 =?utf-8?B?M1BvMW9EOHljcFVoYkc3TU9QMWtLbWcwd2J5TzV1MmpOSS82QzEyS0FMd045?=
 =?utf-8?B?dVlEbS9COGIyclJzejFOcU56UWNsZ2hSY0hBZFJGM1JUem93amRWT3BoQWJV?=
 =?utf-8?B?TVc2WFhtTGFDc1lQT2ZLalJoTHp5ZklVblE0QjlBNnlFQWpzR1Y0dUJwcEpW?=
 =?utf-8?B?YUUyZmxDT1J6ZVo3VXJDL3JQOTVkRGhvN1BGbnBNZFZ5QUV2NVM3UnhjcGFZ?=
 =?utf-8?B?KzRubjZpbjloZXJ0b3RFZVJVOTVFQnNHYXoyQy9jemNPb1Q4ei9WRjFmN0ZL?=
 =?utf-8?B?bFcyb0s3MzNteGtHcTBKU2hsd1k2LzNJVEpYYU15a3lFTU5ObWYyTWdSb2lB?=
 =?utf-8?B?N3NRRUJyMEVVaFVJZXlrT3FUZDBrUDI0Uk1JalNXTmI4bGRmUWVWK3Q3MUN4?=
 =?utf-8?B?L3FadHVDZURvb29XU3lJSGFhZWVrZVBQVm5iOWJLOTIvY0dKb05WUkJ4RkhC?=
 =?utf-8?B?d1BveVlzYVBZa1A5cnpmU2F4VTdMbGtlemxvcWZkYXo1aUNxd1BkQm1Bdm5m?=
 =?utf-8?B?aTV2ZmtuWG1QdThHUHlKc0pyRG1iYU1PQzVDS2xWeDlEeUVISzFCMTNGRlYy?=
 =?utf-8?B?QjkyV0JBYUJqYStSRlM2ZjFJbFRKNkRFWUR1NTZUMEdtNm5QNU85QjhyRWto?=
 =?utf-8?B?dGdIQ1pSc0JXVml6U1FxMDJkRGdiVFk5L1ZSZU1uTGF3cDcrckVOalQzY1NX?=
 =?utf-8?B?QTFXd0YvNXNGQ1hWK3NLNmg2NkZMN2E2YmpWbHdMdkgxODlJTFZwOHRFN3hL?=
 =?utf-8?B?RjkwQmYra3pkWHRFaXdYSkZ0QVd5a1VMZ0tsQkZJMVZTZFg0Q2ZsY3c1aFBG?=
 =?utf-8?B?WVhBc3ArSDI5MGZOQVJJb2xLckFNNGJzdk9SVGJ2SEliMGpwNmtSL0RyS0dP?=
 =?utf-8?B?bEhBRjY1SVlSTkFKUnRKRGRHZXpDWlNPMUdTSUc1eEdYTUVxS3VHNS9TTXJG?=
 =?utf-8?B?dlplMERhZWVpZU5OWXRUdmE2ZkRYdmN3aklMZ3l4QUQ0OXc2SmJ3dXBHUFUr?=
 =?utf-8?B?VTgxNXJnc0dhRUdGd3dBNnpFa29YZlo5emFRY1J4WFRtUjBLVUtqSHJQSFhS?=
 =?utf-8?B?SS9wOE1VQ2dhTHhBbVlzeklETE9hYURLNGRPR0FvZkpRSEhKSlJLSFVnMDli?=
 =?utf-8?B?UEFCeU5YejdCeCtiUmJ5WGdMSUJEQ1hRQkQrelhKWFB5L2ZZNDR1NXY3ZjFK?=
 =?utf-8?B?WWtxVDJJYUFPbnQ0ZjZGZmlZQmlCalYxVHF4aGtqRHRwM2JjMzF4NVo1THk5?=
 =?utf-8?B?QUNVT0c0R050ZkNuWWdLNTExUWlidkF2TDVVM0FhNDdrenRGQUtaZUs0Qi9E?=
 =?utf-8?B?UWVOMU5WVVo2Rmo0KzFrSEs1bUZrWlowWnhTdmFNTjYrRzM0WGJsR3lGcW9a?=
 =?utf-8?B?elJxY0ZsZ2FiMlF6a2hDdFcvSHJxdkZ0WFB0MVBNeDNXNS9ZQUdYdWN3PT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(1800799024)(366016)(376014);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?YlJ2aFZkSDJPZUlmMHoyb29KbjMxL1RKNTBCQXJON1QzbC82dHZZWUVlcWZP?=
 =?utf-8?B?Z0U2WCt5UUdKaDhHcDdXTWg2MjZNdHc2REc4TiszbkNpVUJCT2oxY2gvcDBJ?=
 =?utf-8?B?SWdIeGhrM05adGJldE9lb2E5bUtlb3F1dnBPd1VyanFVUEMvSXREclIzV1pj?=
 =?utf-8?B?L2ZRMVFBeHJ1Z3BHQThqSnRKdnBFU29wWHpRZEJXeEg5WCt0RWQzSVcveUtk?=
 =?utf-8?B?dkZDNWxpMVBHVkp4SmJWUUZFd2k1K2hWbmxoRTEyM0dnWHhmVUphYUd6LzRW?=
 =?utf-8?B?RTdDN3ZkenVKU0JhakRVcUVFbnRUM1hGYitrME1OWGlFY2swZ3BteW8zVWhs?=
 =?utf-8?B?V0h2NGNVbWptNjNHWHFpVnZ1MklYcW9zWFYwNnBWcXdEZDhRb3czWU1za3d1?=
 =?utf-8?B?SDNZQ1FHMVZUa0p4WnV6N3BnemtWRkJwdm5qcTRicVhwR0ZOdFlWR2dzUDdk?=
 =?utf-8?B?L3NIRnQ1c2VGNEl1R3BhcEhmYlU3K2hMZDJJWXVwSHQ1T29tSkxlZ0daZTcr?=
 =?utf-8?B?NldjOFVjNlBYS3dJQVNFbGlEZUxTQi90enVvSURTbWlZaDNXSjNkT0crVE04?=
 =?utf-8?B?eGwzOXpHN1VBdzA2c3YrMCt5OEczLzFOeHdpVkFpMmxzUXA2TEhaM3RhVklt?=
 =?utf-8?B?MXZOR1V4OU9ZZjgzYUlvUTYvY25QcjNzeWYxV1hUR3Y1eFhtT0p1eUczUDFD?=
 =?utf-8?B?WDVwYVZWc1NYK29UOXlOK3hNWUhJaGx0TEo0Qmx3VnVnaGYwYzlKVXRZQVdv?=
 =?utf-8?B?aG9KZXBnSm5wWmhXeEtSU2FBL2ZWNEZCZXpzSDhYK2NBSllVTFhwNFNTdHpa?=
 =?utf-8?B?WmQ0YVNJaFhCeEM0amFiOG8rVkdyRVNhWk1ONTRkbVlYbGY4RUx0SnFDcDRV?=
 =?utf-8?B?dU9rK0VrbUdtdGRnUmtKSmpTa0hPM1Y4RkUrZDhXMkUwQ1BnYVdDL09IVmQ0?=
 =?utf-8?B?ZkhPaHFCYzNnMVZKZnBNSFF0bHkvUStjNWo2NU1Xc1lZbFdFR3J5TXA1TVBQ?=
 =?utf-8?B?MXBaZEV4a0xzNVIrUndWOVNKMlhhYzMvV3RjWTBGaXJ2SGwvQmJXckFpb3pC?=
 =?utf-8?B?RVFBTDN2OFMyY3htRVZnc1JpN1FqTjc1MnI5M1NndTlOdDNmY1NOOGVacDQy?=
 =?utf-8?B?NUU5a0tyUElmdG9KVTR1bFAwM0xERWlhS0FlY0VZL2VhdEk0Y04vTjJyVFAw?=
 =?utf-8?B?Y3J4RnNjZm9Pc2NyODkrYVdoVldTSDlHMkxrV2ZqWVVSQk5wSmcwQnMrUXFS?=
 =?utf-8?B?V3NkajZ5TUp1b09DaHB1ZTlRWGZHSjJsdFViTzRMR204YU5iU0hmZm1OaWt6?=
 =?utf-8?B?TFhiajloK0VJV1JmWkgveTF1dU5jcURaU0R5R09ON0RqM0NiWjVpS1VtWjlh?=
 =?utf-8?B?Sk1zdnRxNFJiZnVxMUd1SVJrVHVob09GZ2JibXQ2OG1ScmhHdnJrRHkwSmRT?=
 =?utf-8?B?Z0R3MnhRYzdkZ1NvOSt2dWZZS3gzUGl2aDR5cFVWMkxxTDk3YytpZkRQbFJM?=
 =?utf-8?B?Z1NnT2NiemZobW1FdDB5S2hkU3ZVdXVkRDdBZmxTNVRGSVhPTXJzaG8yR0ph?=
 =?utf-8?B?eWM5ejBVYjJmNzIvQkFSbGpLajByNlNudkFFdHNMcmM1U3hRSDVvdVJ4ZWdJ?=
 =?utf-8?B?QUlCV1pFM085eklhYVQ4NFhjM20wbDBtRkU3NSt6bHZGVHhyTWlNUFBXTXVx?=
 =?utf-8?B?N2JZdFh6VVpPSjhaMncyblQyZUxrZEN5TzU3eG96dmRSUXUrY3RpR204dm1q?=
 =?utf-8?B?OXl3emg1Y3pMdDBHbUllWXNJMUxBQnI5bnI0S2RZYmhqeHB1T2EraE5MNXBU?=
 =?utf-8?B?Ny91UjN4MGtYdklDdXIxdWZWUkVzRlNSSExVcHRwSDNOV0ZYUFJtNlczZk1M?=
 =?utf-8?B?UzVId3pUbWgydUgxbUk0S2M3N1E0dG82TTlxQmk4TTRUZTVOYVR3SlB0UUc3?=
 =?utf-8?B?OVdmc3ZkZXlWRnpFT0NiVVVVaExjdFJoSERGT2w2d2tOQVE4TnlaRFlBUkg3?=
 =?utf-8?B?ak04M1JnMFZZd1NRSFZ4M0lIMlVPRk54VzhqQ3NqTjNXWWZpWm81djZjWVlF?=
 =?utf-8?B?QU5pNDJVQlN1UUNpRWZVVnhlWG9pd2RnazZYeDVWdXRjREExc2tFWW0vRitG?=
 =?utf-8?Q?VMgli6oZUAwmKwBCz7h9l7MwJ?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 450c4e9e-be17-4e5f-9a10-08dcee068107
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Oct 2024 17:18:08.3396
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: J6yK8HRWDe4m5ATeoo2WVjC2n5UMsQ+Uu1Tvhx7BWMfMZUIdeqXB5pqI3Xg1sHvYAkhuJ56Oui90CxhJ4chxdg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH3PR12MB8234
Status: O
Content-Length: 2730
Lines: 82

Hi Jonathan,

On 10/16/24 11:22, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:46 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> The AER service driver currently does not manage CXL PCIe port
>> protocol errors reported by CXL root ports, CXL upstream switch ports,
>> and CXL downstream switch ports. Consequently, RAS protocol errors
>> from CXL PCIe port devices are not properly logged or handled.
>>
>> These errors are reported to the OS via the root port's AER correctable
>> and uncorrectable internal error fields. While the AER driver supports
>> handling downstream port protocol errors in restricted CXL host (RCH)
>> mode also known as CXL1.1, it lacks the same functionality for CXL
>> PCIe ports operating in virtual hierarchy (VH) mode, introduced in
>> CXL2.0.
>>
>> To address this gap, update the AER driver to handle CXL PCIe port
>> device protocol correctable errors (CE).
>>
>> The uncorrectable error handling (UCE) will be added in a future
>> patch.
>>
>> Make this update alongside the existing downstream port RCH error
>> handling logic, extending support to CXL PCIe ports in VH.
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> Minor comments inline.
> 
> J
>> ---
>>  drivers/pci/pcie/aer.c | 54 +++++++++++++++++++++++++++++++++---------
>>  1 file changed, 43 insertions(+), 11 deletions(-)
>>
>> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
>> index dc8b17999001..1c996287d4ce 100644
>> --- a/drivers/pci/pcie/aer.c
>> +++ b/drivers/pci/pcie/aer.c
>> @@ -40,6 +40,8 @@
>>  #define AER_MAX_TYPEOF_COR_ERRS		16	/* as per PCI_ERR_COR_STATUS */
>>  #define AER_MAX_TYPEOF_UNCOR_ERRS	27	/* as per PCI_ERR_UNCOR_STATUS*/
>>  
>> +#define CXL_DVSEC_PORT_EXTENSIONS	3
> 
> Duplicate of definition in drivers/cxl/cxlpci.h
> 
> Maybe wrap it up in an is_cxl_port() or similar? Or just 
> move that to a header both places can exercise.
> 
> 

Ok. I'll move the value '3' into the function call rather than use a #define.

>> +
>>  struct aer_err_source {
>>  	u32 status;			/* PCI_ERR_ROOT_STATUS */
>>  	u32 id;				/* PCI_ERR_ROOT_ERR_SRC */
>> @@ -941,6 +943,17 @@ static bool find_source_device(struct pci_dev *parent,
>>  	return true;
>>  }
>>  
>> +static bool is_pcie_cxl_port(struct pci_dev *dev)
>> +{
>> +	if ((pci_pcie_type(dev) != PCI_EXP_TYPE_ROOT_PORT) &&
>> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_UPSTREAM) &&
>> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_DOWNSTREAM))
>> +		return false;
>> +
>> +	return (!!pci_find_dvsec_capability(dev, PCI_VENDOR_ID_CXL,
>> +					    CXL_DVSEC_PORT_EXTENSIONS));
> 
> No need for the !! it will return the same without that clamping to 1/0
> because any non 0 value is true.
> 

Ok

Regards,
Terry
>> +}
>> +

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id D6131212641;
	Wed, 16 Oct 2024 17:21:14 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099277; cv=none; b=nrISeBmZBDC4t30SaPMCZZqkSiE8/AwMWkbwcXqK4CCEoCbBSyfKdPSJ+nOzBU1jAo/rP/swOgEA/NyDuQWNfvANH5DTAZ38ZxcHQWLASceNem+DTLXNF8HuA7M6eQd+GForcw21P7fYhYYkdTc46Xwd0VBGkJJKDRMbxL7NuNg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099277; c=relaxed/simple;
	bh=4FbU0E/CHSTfjUmrOg5/cvyBvQpN6UMJaVvsGY+WKqU=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=BwB+lo1/dscXMGUCNXnXQGpfsKLByWobv/Dz0WewUgMjkkHlo4UGkSoiUnUZBJprX2Rs2+sbc5M581xtp/5DjOz62dA2sTI2+WQzCkyZF7vrsHW5wLVE47EqogYMQDciZJ+6Fk16vrDY9+bsvjSzLejS3Hdd+he8zXs3UMpa0AI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTHl65kvGz6J7GS;
	Thu, 17 Oct 2024 01:19:30 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 7CF94140A46;
	Thu, 17 Oct 2024 01:21:12 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 19:21:11 +0200
Date: Wed, 16 Oct 2024 18:21:10 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 15/15] cxl/pci: Enable internal CE/UCE interrupts for
 CXL PCIe port devices
Message-ID: <20241016182110.00003455@Huawei.com>
In-Reply-To: <20241008221657.1130181-16-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-16-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100001.china.huawei.com (7.191.160.183) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 2048
Lines: 60

On Tue, 8 Oct 2024 17:16:57 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The AER service drivers and CXL drivers are updated to handle PCIe
> port protocol errors. But, the PCIe AER correctable and uncorrectable
> internal errors are mask disabled for the PCIe port devices.
> 
> Enable the AER internal errors for CXL PCIe port devices.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>

A while back I thought we had a discussion about just enabling these
for all devices and seeing if anyone screamed?

I'd love to do that rather than carefully enabling them for CXL devices
only ;)

If not, this looks fine to me.
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

> ---
>  drivers/cxl/core/pci.c | 4 ++++
>  1 file changed, 4 insertions(+)
> 
> diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
> index 4706113d2582..1d84a7022c4d 100644
> --- a/drivers/cxl/core/pci.c
> +++ b/drivers/cxl/core/pci.c
> @@ -908,6 +908,7 @@ EXPORT_SYMBOL_NS_GPL(cxl_port_err_detected, CXL);
>  
>  void cxl_uport_init_aer(struct cxl_port *port)
>  {
> +	struct pci_dev *pdev = to_pci_dev(port->uport_dev);
>  	/* uport may have more than 1 downstream EP. Check if already mapped. */
>  	if (port->uport_regs.ras) {
>  		dev_warn(&port->dev, "RAS is already mapped\n");
> @@ -920,12 +921,14 @@ void cxl_uport_init_aer(struct cxl_port *port)
>  		dev_err(&port->dev, "Failed to map RAS capability.\n");
>  		return;
>  	}
> +	pci_aer_unmask_internal_errors(pdev);
>  }
>  EXPORT_SYMBOL_NS_GPL(cxl_uport_init_aer, CXL);
>  
>  void cxl_dport_init_aer(struct cxl_dport *dport)
>  {
>  	struct device *dport_dev = dport->dport_dev;
> +	struct pci_dev *pdev = to_pci_dev(dport_dev);
>  
>  	if (dport->rch) {
>  		struct pci_host_bridge *host_bridge = to_pci_host_bridge(dport_dev);
> @@ -949,6 +952,7 @@ void cxl_dport_init_aer(struct cxl_dport *dport)
>  		dev_err(dport_dev, "Failed to map RAS capability.\n");
>  		return;
>  	}
> +	pci_aer_unmask_internal_errors(pdev);
>  }
>  EXPORT_SYMBOL_NS_GPL(cxl_dport_init_aer, CXL);
>  


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 43E3918891F;
	Wed, 16 Oct 2024 17:22:19 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099342; cv=none; b=TSilbH/ClsUrIckfHl3Hngk7KKp8VvN/rUvfPf6dj1t91/Mm/rnelcM4s0DZ/YJk990bNhvhYhOeiJTKSlRUzQmrK7pxPmeASNbBdpqMajD7yqUBz1J6sSb+/neOk1MsHawLqkGSLPrHU8OgKtF4Bp3fyonHQR4zby0eOmP6AN0=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099342; c=relaxed/simple;
	bh=6gutrC8qGlDmj46iGktrJ4nVuXpp6A65DS7uFgh7qnM=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=AITNBSlPVewqX9p3xj1Lmg1awE80mGAXC+ZIM+hVQk7oDvv7v+mpWO+FhWM/FO45cFq1C3d/VP60QZlqVCOC+V4/MDyvFz+JvNTHmoLYOK/CdVDpjZiEWcToLSsdXjz1eXROEeQHcT17UdBicbKks2l7BikcLzkNSj5JdtNI6oM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.231])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTHnb2hHmz6JB2t;
	Thu, 17 Oct 2024 01:21:39 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 3848C1408F9;
	Thu, 17 Oct 2024 01:22:17 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 19:22:16 +0200
Date: Wed, 16 Oct 2024 18:22:15 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 14/15] cxl/aer/pci: Export
 pci_aer_unmask_internal_errors()
Message-ID: <20241016182215.00006496@Huawei.com>
In-Reply-To: <20241008221657.1130181-15-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-15-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100001.china.huawei.com (7.191.160.183) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 644
Lines: 16

On Tue, 8 Oct 2024 17:16:56 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The CXL driver needs to enable AER correctable and uncorrectable internal
> errors in order to receive notification of protocol
> errors. pci_aer_unmask_internal_errors() is currently defined as
> 'static' in the AER service driver.
> 
> Update the AER service driver, exporting pci_aer_unmask_internal_errors()
> to CXL namespace.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

(subject to suggestion we just enable internal errors for all devices
and sit back and watch for error reports :))

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2046.outbound.protection.outlook.com [40.107.92.46])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5C375188580;
	Wed, 16 Oct 2024 17:24:15 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.46
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099456; cv=fail; b=MvIbSn+bKUtTPvX76sRGQVubVmHI4W4C2xa8N6F6ZWo4sztar+iTs0srGe90BDveISDHyyABsE+BJidhg+8kocVFZQoHdmHSAELDNSei4L7KZjDc49ckV56urBK7u+rXfvjayP/IWGwD4zKpFwz4SYlyu/QhYC4hgQYndDQ7JAQ=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099456; c=relaxed/simple;
	bh=ZiwBC9Jqars+05Ij7F3Ox65N43dQo8zT9ZDhSDul0M8=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=XqfQhOfcH6mT+ZH8z0dTjddpE3YrmUSGaVFvEzYfr7HqYt7dLmcHDKvgp8C8hlslci3z6qWK1vWE/gvAhsubadT7njbec/p2hgQJiaI9cb6evbplhrGODpYxLW+kPsHbEuSVOnPrrwfOu6gpyfYBofUJT5hMy2g+SW6hmDYIqlc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=q7HHwGBd; arc=fail smtp.client-ip=40.107.92.46
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="q7HHwGBd"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=hSLGWvUKcdnIYuG4jY+Mb4yJIKIz5I/3Za0UxNj32ww6LUiOlR/74jq9sFtRof5sQQ7bu/gA2828dtKvF+xWxyVgugmQcI6v22jYewl2wYTlvrmirdUEZ68ihx0jSAoMuzAgpCSzbXhBltCkrMXA1dhSQ9Dh7SOFY9prKzQpYaD2SkP/UpBuHWvyXPdZ0u0LFolbZCqC7gsMjEvHf9zE0VxCruF/qroRq20HV7GVUjaNKBKrySBMxZCDMCDrktvApue1GE5W9/MvWpbvRIEdRXhW4Y1QRLBClYzHONZgTHvhjJRzNe7NEefxZ05Uf9OV6viRatFljzzuGa3a7PTJEA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=OhC2oiZ3zBA3nNrm+3swFZ3kIVCvnc7X4qvDlRqcj4U=;
 b=K+/6OzO0p1l6SbAB4UIhTaNf3Q7iGfiJDUXR0wO46MAD3Vdx+VPkxFQH9B9ses8Wtjwq2iYZeP2slDc8ugg2Gp+jtXtdJCRKrelCALE9pWBtXIJ16VdG+ofpJCiEnoZr7wZ7yd5L9H4NlnKBAtQex7MmNdag75+SsNvaxdLUPw5HfmW9m2sP9FfI1EEyFLM39AAINu8m5Tfj5sW3g+ZNZI8DsYmcRcstvFTi9Fkr245kTivlNaiZJMpDyBlcEE+bFnpUzO5k1MgOWHeNHjSCNTUQv7+aA7+330bo/xFiqrm8bB2VUz9puVm92svqEOb9y16jvQ5HnnjlKNE0csz8NQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=OhC2oiZ3zBA3nNrm+3swFZ3kIVCvnc7X4qvDlRqcj4U=;
 b=q7HHwGBdBJirvqaK5yNEt5JP3fyB1kUWea0my21qzXf0iagZbSCzcGClwHTdC8hP3Z6OnQq8+wNmYs5SGTAAsCEoQ1PbbWTIeQBJLNEC/8CJP9SMpcjGQnHIHbZTkT9xzNeQ9vJGJJuGDzlLvtxbPPgSJpDbvttXjzIwqE4L5g4=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 BL1PR12MB5921.namprd12.prod.outlook.com (2603:10b6:208:398::5) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.8069.19; Wed, 16 Oct 2024 17:24:06 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Wed, 16 Oct 2024
 17:24:06 +0000
Message-ID: <32cfd1ab-9d65-4856-a7b3-c88bf5c0b728@amd.com>
Date: Wed, 16 Oct 2024 12:24:02 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 15/15] cxl/pci: Enable internal CE/UCE interrupts for CXL
 PCIe port devices
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-16-terry.bowman@amd.com>
 <20241016182110.00003455@Huawei.com>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241016182110.00003455@Huawei.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0112.namprd11.prod.outlook.com
 (2603:10b6:806:d1::27) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|BL1PR12MB5921:EE_
X-MS-Office365-Filtering-Correlation-Id: 85972e66-b004-4a27-355d-08dcee075698
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|7416014|366016|1800799024;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?WS9JQ3lmejVxZUFpS0JUVlBuckxaYlFmKzZ5bUVFeU5lSldQV2V2UVFMenJY?=
 =?utf-8?B?aW5UVlczOXNEVWtMRWVOQjlzRXVZb1B0US9NdThtQUZhK1I3WlBPZWMrVjRD?=
 =?utf-8?B?UlluZ1N4Tllkd3QxOHdQQWVTRjN6VGl0bUJnZEJpSTlnK0hFS1NVSkE4Y0Nz?=
 =?utf-8?B?WmJzNm9tNHd3a1FzYWtKdFBQMXBNMElQNVViSEJEQlc4WER6QkNtVnRPTVJl?=
 =?utf-8?B?SkZRQlFpMjBsd3c5MWNNRkJrdUJIeHZKdERiTUxIZm1wMEwwNDlmZzZQcFUw?=
 =?utf-8?B?LzBYaEVvK0RIRytmalF1SlQzZEtHUzNNbzJVMk1DSmo2eEtGNytoRGkwZkhG?=
 =?utf-8?B?MjF0UlY0Z2xGa1Bidk1mcWszK3BXQjBtd09KNDZMSk5tYlA5a0l6NUJYUmpH?=
 =?utf-8?B?S1RyVGJDYTJ4MmhpMWFYaUxnREJGNkJaRWl6aXRpblJKRzZuOWJUMzM5R3hv?=
 =?utf-8?B?TnNjcllGUHBaUGtCT0Z2Q3NkZ20vaitreWo1NFhQenBsU25hVnNFUmhYOS93?=
 =?utf-8?B?M2daRWlLQWRqK1BVWUljb0MxbnI1WkV5VFlyaFZ6RE54ZlFTOU9zbFp2Nk80?=
 =?utf-8?B?eEl5QmIvdDc0WnNCL3dJamJsTkUvUjMzdDZXRWFNWG9Hd2FlRStNclUrbEI0?=
 =?utf-8?B?Yi9JREdqeEZoVFI1cTJRM2orVGwzSDFpWHBVSFFGZGxBdU51RWZmRWJ4b3Fs?=
 =?utf-8?B?cFZ1eDR4ek5qZk1OUzdpbHlnNmdJV1lQSWxwdU54Q2hPVlFVZ2pvNWMwMUly?=
 =?utf-8?B?N0tlNW96Q1pDVkNGNjJoVWQzRnJLbWhGNjUrbVQxcEM4aDJBWG5UYlZwWW0x?=
 =?utf-8?B?c2xOVFhPRG5pOWxHaEh4ajBBcDhsZmxydU5KU2FMT1JNMWI2UVBjNjI4UGtx?=
 =?utf-8?B?MFhYbG90UkYreStiQ3N4OC9zZThUdHJXM0JScStqSWVLMkJXUnlOVitoRldT?=
 =?utf-8?B?dVoxZVRFbXVwSk1KTjRUUzdQUGdhYUNJaFVpYUhRQXNLcWxFaHFtMm05ZjNh?=
 =?utf-8?B?aHF2RDZWUlZCd09saFFVMEtwQmVIcjZQMlJhM1hhaVVPMk8yRnRnQjJkSFJT?=
 =?utf-8?B?d01DRktsU2Z4QkkzbVlSanlIajhCb09hTUprVTA1MmVBazEwZUVONTNNMStZ?=
 =?utf-8?B?bU9ZZE1SVnB3MjE1Y1JSeVZFMjh2amJaRmFRK2RLOGxSN3Rtdzc5K0ZmQysz?=
 =?utf-8?B?RHdsNm1uWmdKcE41VjFLODQ0Q1d2OTBTME1taWkrV3oxY0tjK3gvSGFzeUxv?=
 =?utf-8?B?QWNzMXlZdEp4eFZDVGRTTVRZbVRVSjg3TVhCdVlMVitaMzFaM2ZMWVo5K2ZP?=
 =?utf-8?B?elJ1QkxwNkNjQjQ2alo1NlRWVUkyVWJZVy9yTWxQS2ZXSWVERmRUajAwMHlI?=
 =?utf-8?B?eUxKa08wODZYT2ExNkgrNUFqWGl3RFN4WElHOUVseWcvNEJtUzJhaDZMOHpn?=
 =?utf-8?B?Y3kwZmo5cG1lWndiWmNJbGZxNFdaQUoybUtuUFR4bU5TTnoxM0VWTFFCLzVY?=
 =?utf-8?B?cXc0UEY3L28vV1BvM3IySzBVamFEQTdFOVdHdnhSU1lIZmxLWlZuaGN1ekJZ?=
 =?utf-8?B?bmxzL3FFdEVTRTM5SkZmRkV2b3VXU0ZGUlhYVGV2N3VNOWs2WFczNVgxZWpF?=
 =?utf-8?B?cXlFQ2lkUzArdGRBR0E0b0MxVlBBUDF0bXcvYml3c2FIUGhqNTlnNlhJN2hi?=
 =?utf-8?B?VVZHZ3FLRXB1MHVsOS9SNFpRbDRDRzlpYjBMV1pXWUNMSjVSeGVmbHNBPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(7416014)(366016)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?U09OdjBZR3ErOGF1VUhhMXVtKzRyRTlxUFl3YWhXb2VJbEtmODAxM1JJaU5l?=
 =?utf-8?B?L0xEVWxpSnI1MWxLUUxlaWtoODQ2SUtTMTVjRG1wVHZLZ3J3L2NJem9jMHFS?=
 =?utf-8?B?WHBwUTI0bDh0TlVoSFN1UnNvVEthdXpzODVkNnNJQWc5aFNDLzk4RTdRR1g4?=
 =?utf-8?B?R0VTQXZpbE8zWloyQ09POThneVc4eThtSzA2dnNyOTZ4dmpuZFRCU21uZHN3?=
 =?utf-8?B?N3N1L2lZYzVxNDhIRmM2VGlnRk8wcUlORUhRazk0eDBSWmd5NkFERnhKZTR6?=
 =?utf-8?B?QjJKeThlRm9mVlYzNkcvQVErRHlVVVIzejNjNFJUOWpISmI1YTMvRDJKK1NL?=
 =?utf-8?B?d1RGOVRDNVpXMDhTR2dOZmdZMXozaGFZSFhEMVFzYXA0QllUenBKQWdRdUNS?=
 =?utf-8?B?OU5ia3YvZVhrQXYvQ1dLV1VSUzhYSWpUeHNaSEExSi9YVEZUem81Y08yZ0lp?=
 =?utf-8?B?Yk5oVDAvTi9zR21WVjhuTWJsZkVPc1o4bGFmYjRxSHNIMjB1VHROaEdxSUxk?=
 =?utf-8?B?NUJ4UHgvQm1sUGhnRWIyNUdPQWNsbjJnTUlrKzdwZjRpQndmR0tyNjZFV1h0?=
 =?utf-8?B?Sy9JMklxZlZSVEYvN0hWMTdHUjZxUWY4SkNjTkppWHhjcWI1RVZORGxxOU1r?=
 =?utf-8?B?ZHdjYml1aTJ4QjZvNkxYY2t6RUFOcWRNSmVJdG0yOGo2SjhaWVRiV0U4RVBw?=
 =?utf-8?B?UnJtTUpGcmZlcW9SUHo4UTRrN2kvbWxIQzZBcmIzczJlbmtjTWFGQXd1NkVD?=
 =?utf-8?B?RWZRY0ZzRCtnZ1lQQ2pmOENRSWtqMktRUHVKeUc5RmxwY2toZFhjQi93WXBJ?=
 =?utf-8?B?ZWZrWDk0dmdLUXZVbGltcCtVV2Jvbm9QL2htcE10RDlKZW5PMzVVeWpndk83?=
 =?utf-8?B?MFdYMzRQdGppSEViU01ScS9qNklKUEpOSGV6RmNlYjZ5V3ExK1JmaW9jMnU4?=
 =?utf-8?B?dFgvYWxud1lJRmlGM2dvNnpEREFQSGo2MUE3V2orTnAwdHJOMjdMRklWSGdi?=
 =?utf-8?B?dHdUSk1qT2FLWnBKd1YvVUgzYWlZU0k4cjJjNm14bFZreUlSREFYdkxvcU4y?=
 =?utf-8?B?bXJxS3R3b1lycnVnTGdQUEZQRXFodXJXTzBSbFN4emlHOFBwd3ZBMWZ1QjhW?=
 =?utf-8?B?RXlIREFFcUx1TmUxT2c3SEZOSm50cDg5UG16dTBJRWMrS3RSL2pIMDkxTko4?=
 =?utf-8?B?MFhQY29QUE52TlpxQlNoWC8rMUcxMkJSYk1pYm1BS0FyemEyRHlXWGpTcWtY?=
 =?utf-8?B?ZEJxUWV3WGNaNi9qUzFhT1hHSm9sN0lzYWZZcytkSlU4MVpYR1hqUTJiSUZZ?=
 =?utf-8?B?Q1QxeXBMUDJ4UW1rbHloTXBRSU1LalhvRzVWa1ZyaFNjSWhYdHFLbjYwMXZy?=
 =?utf-8?B?VjVJSWdNZmFEOFdJdjFRNmVNNkh1eUtYd0ZGZ04zMmpjYUhWbHdva1lOaW54?=
 =?utf-8?B?QUVaWWNxeUF3bFM5enhvNE45cXhqOVgrYUdQN09MbnFrSmtrbCtoY0hmejhQ?=
 =?utf-8?B?TDEwbkF2SFdYNy9LbmtwU3QxMmdwU2hIZjRSTUlmZ3YxS0NHVkxSYUIvQ05q?=
 =?utf-8?B?WTUxbnRpdlVhTjVzMTkwdEcrZUpuTUMzYTEwamc3d2gvZGF2MzJ5cVNFa3Bw?=
 =?utf-8?B?SXBsMlQ2ZGRITTVjNTlmcGx2YlNRS0d6OUJrcGM3djIvN3Y1YmZXcTFVS0Zh?=
 =?utf-8?B?M1hNYUxDM0Vsc1N1SSs4S3FpOVo3Vy9LbVhxcitQVTNTUStWbGh2bG1Qdkl5?=
 =?utf-8?B?WDE0MTFheHVGbTc0V0tXNS9nUlpQdVRRVVhrSHFCeUdXc3lIcjJmajUyVWFZ?=
 =?utf-8?B?OVd1aGl1TGVRTkpnYVdXbGhzbHUvZTkrblNISmV3TkxXTTBYandQM09xQXhh?=
 =?utf-8?B?VnFhRlgxWGR3d2UrYS9GM0l5R0Q3MlBJNk13NEFNSDhFTklEQzhib2dhZ3lV?=
 =?utf-8?B?Y0J5TTJkcnhEZllxUVk4QVpPYmZNMElNUWFxRHNLck9LelBNSThFTXg1cjJF?=
 =?utf-8?B?ZFA5LzJXdGlLMzROTFh4dXNsN09FUXdFcVJnUFFGUXQvdFdnaDFYNnUxQVVk?=
 =?utf-8?B?bXhqYTE3U0FPZ1FiRk1jalNRVzB0aUN4Zlk1bWZQcFBSZkZ3emlaM2dBVTNV?=
 =?utf-8?Q?uNgpVklZ0lb7AOyimPvBCjxCJ?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 85972e66-b004-4a27-355d-08dcee075698
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Oct 2024 17:24:06.6443
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 8P99J2wQJWyoT9YlAVO+wKYQP40SCS01l2SxI6th+3VR3Qp9wGYS1L0ppAYyxxdDIyF+qAeKRAjm/qrFspJoDA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR12MB5921
Status: O
Content-Length: 960
Lines: 30

Hi Jonathan,

On 10/16/24 12:21, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:57 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> The AER service drivers and CXL drivers are updated to handle PCIe
>> port protocol errors. But, the PCIe AER correctable and uncorrectable
>> internal errors are mask disabled for the PCIe port devices.
>>
>> Enable the AER internal errors for CXL PCIe port devices.
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> 
> A while back I thought we had a discussion about just enabling these
> for all devices and seeing if anyone screamed?
> 
> I'd love to do that rather than carefully enabling them for CXL devices
> only ;)
> 
> If not, this looks fine to me.
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> 

These last 2 patches will be removed for v2. This is not necessary.
Internal AER errors for root ports and RCECs handling are already enabled 
by the AER driver. 

Regards,
Terry

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AE09714F135;
	Wed, 16 Oct 2024 17:29:38 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099781; cv=none; b=XW+LT0QaxC4OHkxv+f1Ev7v7b5fZvQ8viab/D6951GucnxbO3LeTeXN3U9zVeY0WUdLuKgpSy6vmL8qbSrpz5GIlIakNCn3ElF7DZLEnBbCRETnbJg9ZAzzGexfyFrdFe0/Y+dL3Vf/4P3uGEB4CQAL1j2oMZYc2XeHtMxYPhYU=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099781; c=relaxed/simple;
	bh=FBa78B8HNDpDY7veGaTsGLTQWiz/8xfW3Laic6zUQeE=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=AC9WalcDMEclkMBxWA3EEmKwZB+yjK8kG3m36IxhM46SoovT7qOxcSe8HVTNFUHsVUBaspbUMnSxI6VuiRRWX0L8nk92C53nY4AFh/EtrF0BWh6tnZIzxDuBD/xR6sBO91Y/1+m6FT/o4zDmp6xLB97Hm4Ogs8zEwbRDmWziJNo=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTHsW6rVhz6LDL2;
	Thu, 17 Oct 2024 01:25:03 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 392FC140A86;
	Thu, 17 Oct 2024 01:29:34 +0800 (CST)
Received: from localhost (10.203.177.66) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Wed, 16 Oct
 2024 19:29:33 +0200
Date: Wed, 16 Oct 2024 18:29:31 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <Terry.Bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 04/15] cxl/aer/pci: Add CXL PCIe port correctable error
 support in AER service driver
Message-ID: <20241016182931.0000519f@Huawei.com>
In-Reply-To: <b7e89c01-72c9-4e26-bd88-6cfcfdc78033@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-5-terry.bowman@amd.com>
	<20241016172235.00001e65@Huawei.com>
	<b7e89c01-72c9-4e26-bd88-6cfcfdc78033@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100001.china.huawei.com (7.191.160.183) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 3050
Lines: 90

On Wed, 16 Oct 2024 12:18:06 -0500
Terry Bowman <Terry.Bowman@amd.com> wrote:

> Hi Jonathan,
> 
> On 10/16/24 11:22, Jonathan Cameron wrote:
> > On Tue, 8 Oct 2024 17:16:46 -0500
> > Terry Bowman <terry.bowman@amd.com> wrote:
> >   
> >> The AER service driver currently does not manage CXL PCIe port
> >> protocol errors reported by CXL root ports, CXL upstream switch ports,
> >> and CXL downstream switch ports. Consequently, RAS protocol errors
> >> from CXL PCIe port devices are not properly logged or handled.
> >>
> >> These errors are reported to the OS via the root port's AER correctable
> >> and uncorrectable internal error fields. While the AER driver supports
> >> handling downstream port protocol errors in restricted CXL host (RCH)
> >> mode also known as CXL1.1, it lacks the same functionality for CXL
> >> PCIe ports operating in virtual hierarchy (VH) mode, introduced in
> >> CXL2.0.
> >>
> >> To address this gap, update the AER driver to handle CXL PCIe port
> >> device protocol correctable errors (CE).
> >>
> >> The uncorrectable error handling (UCE) will be added in a future
> >> patch.
> >>
> >> Make this update alongside the existing downstream port RCH error
> >> handling logic, extending support to CXL PCIe ports in VH.
> >>
> >> Signed-off-by: Terry Bowman <terry.bowman@amd.com>  
> > Minor comments inline.
> > 
> > J  
> >> ---
> >>  drivers/pci/pcie/aer.c | 54 +++++++++++++++++++++++++++++++++---------
> >>  1 file changed, 43 insertions(+), 11 deletions(-)
> >>
> >> diff --git a/drivers/pci/pcie/aer.c b/drivers/pci/pcie/aer.c
> >> index dc8b17999001..1c996287d4ce 100644
> >> --- a/drivers/pci/pcie/aer.c
> >> +++ b/drivers/pci/pcie/aer.c
> >> @@ -40,6 +40,8 @@
> >>  #define AER_MAX_TYPEOF_COR_ERRS		16	/* as per PCI_ERR_COR_STATUS */
> >>  #define AER_MAX_TYPEOF_UNCOR_ERRS	27	/* as per PCI_ERR_UNCOR_STATUS*/
> >>  
> >> +#define CXL_DVSEC_PORT_EXTENSIONS	3  
> > 
> > Duplicate of definition in drivers/cxl/cxlpci.h
> > 
> > Maybe wrap it up in an is_cxl_port() or similar? Or just 
> > move that to a header both places can exercise.
> > 
> >   
> 
> Ok. I'll move the value '3' into the function call rather than use a #define.
Not that's worse!

Find a way to have just one definition.

> 
> >> +
> >>  struct aer_err_source {
> >>  	u32 status;			/* PCI_ERR_ROOT_STATUS */
> >>  	u32 id;				/* PCI_ERR_ROOT_ERR_SRC */
> >> @@ -941,6 +943,17 @@ static bool find_source_device(struct pci_dev *parent,
> >>  	return true;
> >>  }
> >>  
> >> +static bool is_pcie_cxl_port(struct pci_dev *dev)
> >> +{
> >> +	if ((pci_pcie_type(dev) != PCI_EXP_TYPE_ROOT_PORT) &&
> >> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_UPSTREAM) &&
> >> +	    (pci_pcie_type(dev) != PCI_EXP_TYPE_DOWNSTREAM))
> >> +		return false;
> >> +
> >> +	return (!!pci_find_dvsec_capability(dev, PCI_VENDOR_ID_CXL,
> >> +					    CXL_DVSEC_PORT_EXTENSIONS));  
> > 
> > No need for the !! it will return the same without that clamping to 1/0
> > because any non 0 value is true.
> >   
> 
> Ok
> 
> Regards,
> Terry
> >> +}
> >> +  


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2060.outbound.protection.outlook.com [40.107.243.60])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 095CDD520;
	Wed, 16 Oct 2024 17:31:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.60
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729099905; cv=fail; b=H39wz37JwUhvXMsh8YSLwGcxKX3Dxn+npaSjp6UsjS44HYIhgwvtyrhY96vrBeM8dm838aBVXRf/3AvcdUvwgq2TukROA/ojDNh/wDz8FLdzD5E++ZgWOo2lljlVwnSUw2jFBqudnxcWJOqoti6z4egBXhrPRoZMvLNGaUHyRpc=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729099905; c=relaxed/simple;
	bh=fOY4HHZqK/NAIaHOy2qXTMHjV5mMsiVdn43b2Ml9RA0=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=gruT4sxn0Bb0xfjftXO7QC8KOdMihHlUfrZAj9gnzkuUv9tpB62+3RCzbXdbcaQzUJ/wTBGP1QGZKIZ+whf/tGWJuEkIUgAuxf3hL47/UXsmZa6ExyKNTV73TZMgJfub5KoheIhL545YBQwXljQi8adYGIea61WvH7lDgrJ+ikw=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=O7E5Nlm6; arc=fail smtp.client-ip=40.107.243.60
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="O7E5Nlm6"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=m3KAgAxcrITZNrdJLhoJveIzVA0SdH7x2Kd+FsSjtf9wq1cLvNbkTng+7aUtU9CqtFJCgccNg6kj8jiNX5ijNRiMRQJmMeebzitW9vWRfXLEE+gTMkrr3csRhxZD3fsOO6aMbMQttMI3o8e2fsaOogaSaGL4kp3vliSA7BTp7uu2abmV1c7IaQ8iO7Cr91bZ4kr0tVeZROsi27YmBLvK1dUtEpRlkXWeNGD6ClfUj0Xlg+z38SsOOSa3Vol9/KILOK+KhQPxVUpUdBHB5owcNjlyfYkibq3pj7SCO75uI9GFYuvMPeivLmxYKobjKdHaXK9OcYiympc56Rv2zs+q2Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=b+HTgjQRkfAXc9/pEARtXSZ3y3nKIInZXVvE4rxqNC0=;
 b=pfP1cIlO9TgWhIcmsxObc+a49+x3+t0O1ocDmMouslS20d2nRP41vjOXsiE5gz+LVglSgSSY8vTtawxvlDMXsE5L4rbecx3hX3Xn416xYo8c2HjhlIH2hsBYUAz6IWq8EQ2avN8tajmFJJEjAWcv/2ULfghxpZJabB00reKUcNauCfWbglb/8YtU9MTBKsft3eqsr8J8o0A2K7y9jU/UG6dvVU+Bvj7iXUIvPFfcd5EX0i4sG180muRh69l6dBe2PUFfEGHQZZaiaSCHwhKITxNChugQC2i9akZ98MGZfxTxK0B2FQ4GaFx9620PFckF8D9SvqVGh7utG1S1Pu4eFA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=b+HTgjQRkfAXc9/pEARtXSZ3y3nKIInZXVvE4rxqNC0=;
 b=O7E5Nlm6/QHDXfK8SH0WaCEcAUt1kzT6G5zE4qfA0ouY/MAsnf3s3I4c9efBvldWl3MJQzO1P6Hbvo7CrKH94ClFlkzqmpWYo/IhgRH5jWwDKCDHPE6XUygNa51848KL42vwQPF8GJ/QK0dK4qLAraQYAOYGvwB7k6+J3jPUe/s=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 PH0PR12MB7813.namprd12.prod.outlook.com (2603:10b6:510:286::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.25; Wed, 16 Oct
 2024 17:31:37 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Wed, 16 Oct 2024
 17:31:37 +0000
Message-ID: <6555a001-4f5e-40c0-bf27-38dd7a15c3d9@amd.com>
Date: Wed, 16 Oct 2024 12:31:35 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 06/15] cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to
 pci_ers_result type
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-7-terry.bowman@amd.com>
 <20241016173011.000021e4@Huawei.com>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241016173011.000021e4@Huawei.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA1P222CA0117.NAMP222.PROD.OUTLOOK.COM
 (2603:10b6:806:3c5::23) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|PH0PR12MB7813:EE_
X-MS-Office365-Filtering-Correlation-Id: 68ffdb53-1406-450e-085b-08dcee08633d
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|376014|7416014|1800799024;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?d29zU2FlK3hyYTlXODFxS3R6SENmaWdaS0d5ejlPbFZ5NjEwaE9zYjV0Sjds?=
 =?utf-8?B?NkU4U0Y1R2VYa2FNc0JJZldzK0wzcmU5WVNCTjFDaW85bTZLNXdneHhnY2N1?=
 =?utf-8?B?KzNadHdPdVhkLzJvWXNEWm5zMCtqVENEZEc4b2FhTTU3enZWMXdRZkhkUTlr?=
 =?utf-8?B?eTBWcTZEb09HVmYxaUJzMUpNc0RWZ3hNVCt6VUNCcHBnQml5VHZVQWN1dUg1?=
 =?utf-8?B?RHlsQjV5RE00OVliR3N3SThrQ1Y1ZVk5MXNBeS9qZVVqNitNSnJzYVRPVXVB?=
 =?utf-8?B?eEZab0RVVDJTYUM5SXhOanhZNlJEQzRYUUIzTFdXbHdDdkVZekRwQUcyM0lO?=
 =?utf-8?B?UFEvczlISm9uazRlRklKN3hlWTNuQ0Q5TEliZmlxbUEzZU8zQ3ZsMXRaTWN6?=
 =?utf-8?B?SjZBYzNheWxqRDZQdnVzVHBmUlRSNjU0YVFCckRIK2wwUjZwVTlubEM0amZ2?=
 =?utf-8?B?cHRXd3d5ZUJYMm5xWTJFUjdaUHArUUtvblJOYlp2ZVQ5S05XbDFodklmWmJl?=
 =?utf-8?B?aGY2OTI4aUF0aGtHbUtCMVd5VVUzMkVrUFJEcHB0ajVmV05nQURORVoxOXZL?=
 =?utf-8?B?WWM2NnF1NHZBYmgvT3U3TXhXNEN1RUdQYjltM1Fid3hWYzNzZ2JqYnpicUZu?=
 =?utf-8?B?VFRvTnk1TzFqN2w3RjQ2VWZtWUJVMlJtNG5memk2MTdQYWxWTFRueFg3dk5U?=
 =?utf-8?B?OFFNb0dZTU93ZGNueHhsdWxiS0dCMHFOR0dBcWgvNFMyaWpXaUJ0cWIwUkNy?=
 =?utf-8?B?YmY4cGwzSkMwaU0rZDZWem9YVXdPWFFKZ0RMZGZQS1E0Wk8yaktXRDlCa0or?=
 =?utf-8?B?b3U2RDFRMWlwMVVhV2VSN2xsV291R3NxOU9HWkZ2RkdyMmNnalNkdE1jVXhT?=
 =?utf-8?B?R3ZtMzZnNkl5ZHA2TXpHSmxtRWNqZko0VXlkcWxXVXFWT3QyTG12S09mTGRC?=
 =?utf-8?B?ZVFBRHdRUjRnQzE1TlZhOFF1ODFtbmNHbUFVTVBLMkwxSElGa0I4ODhUYmxR?=
 =?utf-8?B?cGtwdGVWS0dES1lLWnMrTGdQcGVuOStjTktOVEFXSG91Q2JCQ1dCMGhYeDE3?=
 =?utf-8?B?MnpSeXYwUnRocG9wdCtzY3RYSjQ0ZzYvY0V0RkxRWFlMTktCWnpoTmRsSkxz?=
 =?utf-8?B?c0labmcvVktkazlxYjQzYlArSWhuc3hvOS9hRVZSUTBRRDhHNjYrZElYYmFp?=
 =?utf-8?B?SVYraGRyMm5ZZ3R1S1kwS0dwNG5RaEdBMVplV0owbFM5YmJERld5OWx1YzZ2?=
 =?utf-8?B?aUxCM2pyS3dhUmcvc0Z6dWFtOXlKV1pFaXlYaUlNU3dtbHQ4NE11NnN3Vk9q?=
 =?utf-8?B?UEhETzhpbVEwWE9Xc3oxY1ErSmpncm1iZzc0NFAwbVYzeU5lcDVQOC9UTTl0?=
 =?utf-8?B?SXhTVlNyb1NaYkpDUkljSDFnQitTNHg2MW9OdlpZb2FJZFkyVjR1RUdvQnQ3?=
 =?utf-8?B?ekFwaEVtZFJUZjQ2dWEybmZSdDc3SVFGbU5uOFlVMWxHNk03RGUzV002MElD?=
 =?utf-8?B?NVVFZnBWVHlhczFPMEVlbXVVYklKaHh5TnBPd2R2MldRUldWRkRLRkxnQXdh?=
 =?utf-8?B?blVReVNwaGRvcng1S3NQeFoxdVY4RXRESjIyZGhQUkVPSXJnL3R3NTNybnRB?=
 =?utf-8?B?VDFBYjlCVC9zZjU0VCtydFZUSEs2N010TjZqR29MWWdvbjl4MnBlc21xWW5S?=
 =?utf-8?B?TXNlS1A5Nm95THc2YVV2V1ZEa0l5ZDU1OU1peXVPMThzMHNDTHdjck5RPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(376014)(7416014)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?WEZ0WDBVTG1VdmhZcEtrbWVxMzZDZStwTW5rbUprd3A1ai8yM2p4N2xtaEhz?=
 =?utf-8?B?ZXZZSEhKUTdyVVNackFxUGUvZkVIUVppek8wdmFFZkJ1YWdqdG9KVUVlTGhu?=
 =?utf-8?B?TzhvdXpYSHg3Y2NpbzZVS2lZYzd4VEpzOTRBb2dZZGFTSjJXcklnSmxUY1lW?=
 =?utf-8?B?TTVZVkFFMHI2VDJsZ1ZNTzlQZ1FtcDJGdnpUKzRHaVlkbkc3cnlkZk9yekd2?=
 =?utf-8?B?alQ2R0ZKNnBmRmk4emJTMG1Wcm9kZ05HT2k4K1VDeGVqcTVaOHdpMW9iL1cx?=
 =?utf-8?B?OVRlanpDUGdYMEpkOWdLVWRCRFlPaDk4eGhPSkxZcnlESUkwYzRxWFpiQTc5?=
 =?utf-8?B?STF2WmZkaW91T0dDajRqSkJtREtFbUdLVk83R29hckVwcTFwMWF2NlBjUVRw?=
 =?utf-8?B?SVlIVktqM3BNY2p5dk9DS0xRT2tYeEs5K3JmelNrcXowUTlpR29vSGF1MDlB?=
 =?utf-8?B?MEdVdWdTS0VrUm0rYTVzeExybUI1aGNvcGFjUHFwc0pqb3IyR0FONVFpWVVT?=
 =?utf-8?B?dWFKbDFVaFBJTnNaUGVMTzArUldDMEZ4OWJZUTN5V0xaeXc0OUVVZ0hIRkky?=
 =?utf-8?B?RU12ajZGVGtVUUQxdGxDV1dmTldPaDA1UTM2MjlMMWcycC8wdDl1TkVmZFp5?=
 =?utf-8?B?MmRzdmU1MVppd29BTWRRUzVTZ1JVNExkWUt5Nm1pR2dNTURwTmlzandjYy9Q?=
 =?utf-8?B?c3dyY3ZoVnFFeVBOWTVsTWVTbnRUTXlEWW5QM3dRbzB0TDViTnV1a0RjdjBi?=
 =?utf-8?B?OG84MjhRTHBnT3ZmemlyZFl6aTc4ZElUN29jblBsek9wT00ra0J6b3ZUTVZk?=
 =?utf-8?B?aXBRY0RGZk5FUmU2WWFMY0FjSlUvSjd3RzlTNkZZVE9rNXArTE1YcDhiZytE?=
 =?utf-8?B?UmpDRTlYck1DVURuMXdzMG9odW1nbjI4VWFYY2x1SmpUMGFzYmNlVDJGTXNp?=
 =?utf-8?B?elNoZFZ4TkpxUGN5K1VVOWVBdzJSSXJCSnpqMHF5dkJ5WEc4cWtERzA3UHAz?=
 =?utf-8?B?a1RCTVU0STVSa290eE1YNE9SVWNsSmdTN0ZrODQraWFpbk1wM1dKVm1nVE9V?=
 =?utf-8?B?a1RTNEJYcmdqNXYrTU5qWk41Q0EwVXJiZ29mcmpXcnN4eDIyWi9Fa2FRT21Q?=
 =?utf-8?B?Wm43MDl4b09QOWdFVDhXbWNRNE9uOUh4MUNreFZWVGo0bmZaaDhsbUF4cHhK?=
 =?utf-8?B?WHhMVjVuVFVLeG1FMHRGZEFNZ29IL3ZNVlBuc0dmazYzSnFoTENXemVOSTB6?=
 =?utf-8?B?SWJSdm1zNmZHSTZBbkZvNlRxRmtGNFFxUTNzTUlSRnQ3U2NqL0R0d1oyRE9v?=
 =?utf-8?B?VFhzZmVBdC80SkJuNzRtdk1QVE84My94RVl0NDhFSkVaaHVzaFl3Q3NtTmlr?=
 =?utf-8?B?VjNNUXFRL2QrTzNXK2orNXRmQ3Nkc1RuQnJxV3JvTDhoQXZ3aEpFeXRCQThO?=
 =?utf-8?B?aGVNa0s1Ui9ydnd5dkNtSWd6cktCcFc5ZVhtcS8yYzJMSVJsQlBHVUJnQWtY?=
 =?utf-8?B?WEhSREkxT2N4TXY2Y3EwRmg3VGRrMTU1UFpBUzRNOVBVTW5rczVOT0ZISTJh?=
 =?utf-8?B?NVVZV1VEcG8zL3NOODZXRFNsako0ZUFtRDZvNVJpSU5FdC9hQkRLYXZ2NXA1?=
 =?utf-8?B?d0Z2NUtUMnV5bk1scEpLQnJ2Wjc3ZHlFaTFDcmdZc3l1OS9Bd09Ed0d3SUZh?=
 =?utf-8?B?dzgwU2tWNEhPOEFGTG1JSGZwSzlJQlN0YVYzY1ViaGM1eWE4c2RPU3VBQ2Fr?=
 =?utf-8?B?MUo5MTNkWUV2Y0pLUUtqUWhNSmtLYVhsdERUSFRNTWdid3dLQUZnK0sydHpF?=
 =?utf-8?B?U0VIa0Zydys1TmhVWHhVd21FeFpreHUzU1dDZTFrSTlLS24yYXJLeEt0QzJ6?=
 =?utf-8?B?djBzQk5pcUJ5SVdoMGxzVE9zbGw1OVZuOXhEZGE4SHg4elBaZ2EvZm1KMGwr?=
 =?utf-8?B?enJ4Q2djY1RKUG9lWmJ6M29meVhCWDdxVjJxcFhORVFORksvYnBqVWIrQk1O?=
 =?utf-8?B?VzJaS3d3Mm5FdW5IeWxwZmgrNlNEd1cvOGVHbGhEb3hUenVLRHlFaFppUTBz?=
 =?utf-8?B?ZmxtbXhUcXNlNTRrNnY0NlpFZG1vYTIyTWNhemFsUi9MN3hDbGNXQytOUWhO?=
 =?utf-8?Q?mZnJbX/yMQl8TUPQNO58zH5TG?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 68ffdb53-1406-450e-085b-08dcee08633d
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Oct 2024 17:31:37.3507
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: VEAtaKuLkPiMrbiCqxqMVVoud+OYfQjdOPox3qNtTVgfwJ4ArxdX4pICUPW1wMOI7K7/9Mar1ZPKxjZlFI3J+A==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH0PR12MB7813
Status: O
Content-Length: 1319
Lines: 44



On 10/16/24 11:30, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:48 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> The CXL AER service will be updated to support CXL PCIe port error
>> handling in the future. These devices will use a system panic during
>> recovery handling.
> 
> Recovery handling by panic? :) That's an interesting form of recovery..
> 

Yes, Dan requested all UCE (fatal and non-fatal) are handled by panic in order 
to limit the  blast radius of corruption in the  case of UCE. 

The recovery logic in cxl_do_recovery() (not using the panic) is also tested as well.

Regards,
Terry

>>
>> Add PCI_ERS_RESULT_PANIC enumeration to pci_ers_result type.
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
>> ---
>>  include/linux/pci.h | 3 +++
>>  1 file changed, 3 insertions(+)
>>
>> diff --git a/include/linux/pci.h b/include/linux/pci.h
>> index 4cf89a4b4cbc..6f7e7371161d 100644
>> --- a/include/linux/pci.h
>> +++ b/include/linux/pci.h
>> @@ -857,6 +857,9 @@ enum pci_ers_result {
>>  
>>  	/* No AER capabilities registered for the driver */
>>  	PCI_ERS_RESULT_NO_AER_DRIVER = (__force pci_ers_result_t) 6,
>> +
>> +	/* Device state requires system panic */
>> +	PCI_ERS_RESULT_PANIC = (__force pci_ers_result_t) 7,
>>  };
>>  
>>  /* PCI bus error event callbacks */
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2079.outbound.protection.outlook.com [40.107.92.79])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B965F14A09E;
	Wed, 16 Oct 2024 18:07:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.92.79
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729102064; cv=fail; b=r7ZZZCsp4Jers39bAtwXNm6JS17nQS1Ti6myPxpK04XhSVH7kb2EYmIySGaCZy/ut/bu6rSvb79L68sqcPeZzOOrtXCGv2sqaernKY55Ne0DlZ7LSL4IEUiFC81QgXgAf2y8brjFUK03LKvTU14GWPuvIy2O8tnfECaU6+pe4Bg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729102064; c=relaxed/simple;
	bh=Y+ZqjkgfQqFwvhaxqJNE7mTfn4uJwn6Yo1xtN/6MUcw=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=nXWhUtvGfAsWb+SmdU0wzTV3hzvM73JhqNzCtubSGRlUiU0PRQ1pCzvgTmQdX0Q4RB5eXsYOefcHv7f0la0mIAKxzi7uTpQIegNhi/yphO/3OMmLab5h5RLOYRwefnNSaW6v0fGtwhQ0inO3zD7llCzI2v2eNHsvLRfqu31IFbo=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=qcArPhKc; arc=fail smtp.client-ip=40.107.92.79
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="qcArPhKc"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=sdfGd4ZLGMiHpXso3lFvOyEJaG+lUHMvnWa96BdMeJkof0wN6ktVw6+sBx2C2Q6riy0oBCZQv3lYaVf6qqGyuV06ENMPnh/0UO4Mq2gR8NfNuuhEMBOVISLeUk6HZPOVDlx/R6BLNazn5JVbrU+W4nyTZu0EHMA0PNt0ipazdaRkGaGNTnDoRC2zlEffvxykCJ+ZgKfdwvgV6azGnopiiAbAKKwhYBYoxoPFDKy7sq1lu0FqZbFnPCWLLuCgjhfOD1z+GEOvsSPg5y8d1I3gebrh5JmpDtfbON38R2RNQ9qzpAHXViJhGC/uxdLdAk59yYFqNX2p6UgrVdYvToeCGg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=Pzbvv4FBt7e41u5jlBOSUq1jEgvV/jW/zYV/xAzS3eA=;
 b=trnEf6Z4JwBl03C5yFI3Oi+MXGfgX6RyHbMmwMxWYmF+T8yPxIDznLOvCm8ScDXElulTAeoszozZOfvgpboToMVFOvKfMWOiowB0nYExXLDN3dfgOb5efT9V3ec+KNA6JW2u0EZrOFlC6J5k+maaU2xvU2ZmJyJelFNws6lbsXhW63XJB66tGqDS7r8QDkDWh3NO2DPLZGyz7jL2ozEfpJAtWIlBCm83lmw6Thru6SNPaZ3TJq2kKi+PZDnNC0bBMuysVf8f7g/+jSBaX8/96BF4aXNB/aJTwlKbbnPL40iCYZX1rvjqr0EX2WWJBBYwZwVmIOmRVZ05toxUxDms9A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Pzbvv4FBt7e41u5jlBOSUq1jEgvV/jW/zYV/xAzS3eA=;
 b=qcArPhKc2mwlQscpV1gcXpTSkQq4hIvGQOVICzTiI1/4gYCBWxE7L2klnjNKKszkYcRUxXvl7iduv955KNt9kE2oDRHLZ+1zHJDfQi8zh8uWL3d3FkcC8id8m2HZlCu2B+LguYR0n2YXkylLxA5W9z9ZrMswkH6T6YNZ+j3pz5I=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 DM6PR12MB4236.namprd12.prod.outlook.com (2603:10b6:5:212::14) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.8069.18; Wed, 16 Oct 2024 18:07:39 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Wed, 16 Oct 2024
 18:07:39 +0000
Message-ID: <ac5f05ec-5017-4ac7-b238-b90585e7a5bc@amd.com>
Date: Wed, 16 Oct 2024 13:07:37 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable error
 recovery in AER service driver
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-8-terry.bowman@amd.com>
 <20241016175426.0000411e@Huawei.com>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241016175426.0000411e@Huawei.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0207.namprd11.prod.outlook.com
 (2603:10b6:806:1bc::32) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|DM6PR12MB4236:EE_
X-MS-Office365-Filtering-Correlation-Id: b8b4c610-66bc-41fe-50e8-08dcee0d6bdd
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|1800799024|366016|376014;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?WC9saVN4NzRrTE1GYTRRQ0pqUTl4Y0pJUlI1RFZZbEtCcU1HUkFKRGlUOWp0?=
 =?utf-8?B?YXlWRDJtLzFWekswQWlBcDloc0poOFZMYXplS0RJUFIwQ3c2R1J2M0RpUDJ5?=
 =?utf-8?B?Z2dSeU40akZzazJ1cGxwczhjM0RKOEtrTzdBeFg4dExtM2QzanlJOFhBOUlD?=
 =?utf-8?B?ZElaTHYxQVFKWitnQjRhZVRkcHhuWUxQQ25IWmlUNVBnUG0xWk9VWVpheGVz?=
 =?utf-8?B?enBqWHl2dllNbjN6aTJKV2o5MkZtaXM5SDBnNUpralIyZ2VYZ3FObE1WZ3E5?=
 =?utf-8?B?YTUyUWcybitEbzNhVndSZWxDcU4rY3k2UFpSQ2dUNUEycUVzTWE3cDR5OS81?=
 =?utf-8?B?aWJKT1hKeWNIVmhJdGRVTFRrN05QWWdVUEk0VFNVRUhEcTg0anFNUEkraDV6?=
 =?utf-8?B?bDFFSDRqRWE3aHJYWEVrU21pUThwRGJwMTI5bXFpbUV3RXBwVHdLTGpscCtL?=
 =?utf-8?B?TWRsZ3ZnclJRN3NESkMvVGlicVN6Ui9aVjFlZzErRFdUTzJFUnVKRExoMVJ1?=
 =?utf-8?B?UC9zTDQxWGJMYlhVeWsxZ0ZLSkE4d05mWXU4ZjVEaVJ6THpCdGhFc3ZTS20x?=
 =?utf-8?B?bG1FbmQzWVNRTjdqc0d0T3Z2dG5uYlpYcVJ6dFNZMmZ5KzNOL2V1ZGhScVBz?=
 =?utf-8?B?aHQ1SlJlNGFVcU9zNjZrYkplNWhVaXZmdjVhV3hhT1dHcHpQNHljL2xsUUtn?=
 =?utf-8?B?eG9ZQmpHZngxVEd5VUFwS3pWQ0xkU1RyU2tlZm1tWUtOcThnSVIvY0I5WFV2?=
 =?utf-8?B?Zm9nbDVPa1hEb2RuTitEZVBzb1VtaFl5U05ZVUpmb3I0K2JQVVhYY3N3NUMx?=
 =?utf-8?B?eFAvaXJzcFg4RUhIREUwK0I3eTJPb0k5M09KTDVvTUVFNWdPbng0K0h4V0RL?=
 =?utf-8?B?ZVo0aG0xeldOMjZaUFZuMFV5N1V1aUlHMTlvYWNrWHNHdGx5djQ3V0NXUzI5?=
 =?utf-8?B?N1FKL1lGd0ZXS1NkUFFSK2pNWkhSNlI0cjVvRUJwK2RudURlMVR3RmpuOUZa?=
 =?utf-8?B?cFpMdXpscjFhTFlCUHdRUGp5Q21Kb1NjWUFXRDVCaHFzK0Evc0puN2IrSy85?=
 =?utf-8?B?MkZoYjEvSTJ2NWhTZVBOKytPOHRCZENDdHQxWFUrN25iS2E4ZkxIc3FJOFc5?=
 =?utf-8?B?VmxKc1JGVU41akYyT1VQVmd6eUNJa2RRTlRaMDQxNXFuSzdRWnk5ekhUa3Bs?=
 =?utf-8?B?dDlUczkyeko1UnJwSjBVQjc1WXYzSlFMT09WYXljVUVGaXdUcG9BSFU5WlZK?=
 =?utf-8?B?ZitqMlVxQjNyUHU3cUViSnFFWFJQNnNveUZ5MlUxbDh3VU4zZ01MV2xIamZm?=
 =?utf-8?B?VWd0NXRNM25ZMjI5b0JjQ3JHQ3NXWkRFMm9Uc1NydzRSWlNVSHhoT0gxWDZw?=
 =?utf-8?B?M2dpZlFPSG1uUUk0OUtCeEdkbHdVMWdLQUN4QjlUUVZZQ0c3L3N1MGorSFlL?=
 =?utf-8?B?dndtRXQrQmJPbllQaTYxRUt5Qk1WZ2djV1V2OERaWHJuY1A5eGVXaE1rTGZ4?=
 =?utf-8?B?aEVZVlQxQ0ErbXJ5WUhib2dZM3FZZ2EwNUVVNlNyVUQ4TnJ5N0FzQUZvaklI?=
 =?utf-8?B?NVI0MjBmTkhMaXVkbVBGcnE3ZnJUTUp5Z05Ld2lqV21FNlpBbll2dnNPOXg5?=
 =?utf-8?B?VFFoeHo1bzJNM08zSk1DOWQ0Z0ZoTVRvaC96cmxkaDhHc0xsVWIyWktIL3F3?=
 =?utf-8?B?ZDRqVmpkT2pNblVWbHpyN096eFc4K3JPRzdrRklQYWE2VlN2d0FVTDhRPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(1800799024)(366016)(376014);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?cEVxN1NicmI3YmlrWTRjYTAxMUtDUWdkU0lVb0ltc1JzdkZMakNFTHpiSi9x?=
 =?utf-8?B?N1BnYWFRZDJXVHM1K2I1VitncUtTSlFDdjlnUXBBdVdZTjh0cnFTOGZTNWk0?=
 =?utf-8?B?UnFEMmZVd1lFSWg2REY4UVZXQkNEY0srdTc3bTVYaWdXMjdPT1dXbmRhc1FF?=
 =?utf-8?B?Z3NaREo5NzBvTkl5cldmc0xaZnhHbXF1REJuZ0NISmRIaGZYd3VPMjJPdmZ6?=
 =?utf-8?B?K0ZXbFBsZDdrbGRYd0ZtejYwNjd5bE9jeFg0aWJYdEd5a1JoemJzcDdVNytZ?=
 =?utf-8?B?ajh6a0JCYzdCamh5SjMxYW1iQ1Z2UmtKR0Ixa0hHSUxQNUduUlpuRDg0eHp6?=
 =?utf-8?B?NGFKSFBUc0RNQ1Z0c3AxeWpZQ09BQnBCVU45eHpEVU85WEFNMU96ekpJZmFH?=
 =?utf-8?B?MG5FRmc1dGNTcHFrWm1BZVZZcFVvN201TUlFNnYzR3lGei9rYTRZRWpnYmU2?=
 =?utf-8?B?cjJHNnY0c1RBZVdFeTdmUExKK3RUN1ZFR1QvZnNscE5rdGw1dHE2eVVVRGN4?=
 =?utf-8?B?NWdocDhyTkpYTFRpRUlVSmloUzRndkM5cVpvQWRNcWNLR1RwbW9yTU1KUEVF?=
 =?utf-8?B?cnRGNjQzQXZxRmtaVGlFcUttUmZEbGVsZGtGMmY1TDdLbUtmQzZleDYvVUtG?=
 =?utf-8?B?Q1dCWUZEcU8wclZmajNWQ0dOSlVyZTFsMmIyamRDNnU5NVJVaFJtZXFEUCtK?=
 =?utf-8?B?cXZZZ2F6ekFxYTRsTWVvMkU4WjhkaXdUNkZmNFNBQktuU0FZWThaYXdteTRj?=
 =?utf-8?B?OTVrNHc4MG1LTkxhcFFRTXlDeTVqUXducXc4RXRTa09ZOVkvRnpjeURNNDcy?=
 =?utf-8?B?TzNkYzJSQUZ0ekw4SUUxRlFPTjB2SUpqdXk3WXVWbm9yM1RsYS91U0hkeUVq?=
 =?utf-8?B?VVIwcUZ3a1hZbUZNVlZTRHNJNVQvdU9BdWJGQ1hIL3FlV2tlbytnQlovbnVQ?=
 =?utf-8?B?Z0NNTnRWQWFqR2xhalp2VXJ1dkVWeDFVQnNsdlNGZFpiYjhadnJ4RmhudlBq?=
 =?utf-8?B?QlluVVlQR1piSGxPVTFrclZNcmdPRVlRTHhPMTZQNnZZcTJvdDhKVWdud0Iw?=
 =?utf-8?B?TDBWeG52TVgrOENxNnozdEVML3d2bUpkL2d6S0xpd0hpSFNqa1dmMEtrTUpk?=
 =?utf-8?B?c0lvQzl6dCtqN2RnK0ZYWGEyR1kxM3liQ1hlWmZFbU95VFNSR0pIbDJlc2xk?=
 =?utf-8?B?ZkxGcW11QlR3bHpleFowSzlyaE9SUE8vMFlrczVaREFxTHRhSVZ0RnkxaXdm?=
 =?utf-8?B?NEhJYTBXWlVwOTVIaG0yTWxPYUxmSjVrT003c0huSG85Rk1nRFpZbXFMd2lD?=
 =?utf-8?B?bTFzRlFLNWJFUlNaV3dOalF6bEM5eFYwclFvR1JwTEllSUpxdEhxeHR5ckRr?=
 =?utf-8?B?ckJxWCtsT1pZQklxWVRKOHQzbkJLaFNISjJsYzhQRklKeGJVTTdoS3U3MzZv?=
 =?utf-8?B?MkR5Uk51NGhhU0ZTcDB6WGFDaFA3ZzFoSS9XTWpSYVhEY3YySkIwMWhNdDhi?=
 =?utf-8?B?eEp4am1VdG1uTzV4NnYwOXZvMzZvRHNmWkg0ZEhwUC9DRVpmVER2V1RhNUtj?=
 =?utf-8?B?YTB5TUIyNy9Uczhhd1FZbW5NMkZBSStaekVZRlA0UDRjMm5SNnhFdHZIOVhr?=
 =?utf-8?B?TlZ4cDBuL3ozTnJZaVBFVXhRemN0ZUFPa29OVWV1UzQ0cEZPdFA5VkZZeDBp?=
 =?utf-8?B?Syt5VDZILzRCQkZBOElQYzhyZWYxa3hvOXNWYnFnZFdrLzlpVkEvWVFJM2wy?=
 =?utf-8?B?Y1pZUitXWlJYMHdIZmJOcTEvWHhBMVlCb1Z2aHU5bjlYZ0ZjOFNoekE4eWxn?=
 =?utf-8?B?YzlmSFFUZklGTEZLSkFpU0pHV0xKT2RPT1ovc0FZdE8yVzRLU1JEcTBWTSs4?=
 =?utf-8?B?aTB3a0tsUk1sU3VFeXM1MDg4dkNESUhTVU15NjlzWlFrR3kwKys5Y0xPN0Ev?=
 =?utf-8?B?VTVDVGN5M3QvWGNVQStsd1hTaExNYWxId05vVzV2MEZEb0RhRi9zTUd1dTRN?=
 =?utf-8?B?cGhHVUNMVnVMSWhQeVNLWmtMZkprV2R2U2FwdFhnZnhGWVpYUnVvbkxsTFAx?=
 =?utf-8?B?anFyUzVCMlR6eGpFUWtxSDB1aHhqQnBDTDlHSEVHWVJjMW9SM3BENWE4dFd0?=
 =?utf-8?Q?a/UDNLBhw17dFQ4AoU9uRld98?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b8b4c610-66bc-41fe-50e8-08dcee0d6bdd
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Oct 2024 18:07:39.3034
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 4vgj+3HOaiGnkL7D////TASB/hrT5fn+skCJz0YJePVGZE5DqnfvCPagYauxGVjC6uid8I+uMj/UiMdgGpxdsg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4236
Status: O
Content-Length: 7181
Lines: 199

Hi Jonathan,

On 10/16/24 11:54, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:49 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> The current pcie_do_recovery() handles device recovery as result of
>> uncorrectable errors (UCE). But, CXL port devices require unique
>> recovery handling.
>>
>> Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
>> specific handling to the new recovery function.
>>
>> The CXL port UCE recovery must invoke the AER service driver's CXL port
>> UCE callback. This is different than the standard pcie_do_recovery()
>> recovery that calls the pci_driver::err_handler UCE handler instead.
>>
>> Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
>> "recover" the error. A panic is called instead of attempting recovery
>> to avoid potential system corruption.
>>
>> The uncorrectable support added here will be used to complete CXL PCIe
>> port error handling in the future.
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> 
> Hi Terry,
> 
> I'm a little bothered by the subtle difference in the bus walks
> in here vs the existing cases. If we need them, comments needed
> to explain why.
> 

Yes, I will add more details in the commit message about "why".
I added explanation following your below comment.

> If we are going to have separate handling, see if you can share
> a lot more of the code by factoring out common functions for
> the pci and cxl handling with callbacks to handle the differences.
> 

Dan requested separate paths for the PCIe and CXL recovery. The intent,
as I understand, is to isolate the handling of PCIe and CXL protocol 
errors. This is to create 2 different classes of protocol errors.

> I've managed to get my head around this code a few times in the past
> (I think!) and really don't fancy having two subtle variants to
> consider next time we get a bug :( The RC_EC additions hurt my head.
> 
> Jonathan

Right, the UCE recovery logic is not straightforward. The code can  be 
refactored to take advantage of reuse. I'm interested in your thoughts 
after I have provided some responses here.

> 
>>  static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
>> diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
>> index 31090770fffc..de12f2eb19ef 100644
>> --- a/drivers/pci/pcie/err.c
>> +++ b/drivers/pci/pcie/err.c
>> @@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
>>  	return 0;
>>  }
>>  
>> +static int cxl_report_error_detected(struct pci_dev *dev,
>> +				     pci_channel_state_t state,
>> +				     enum pci_ers_result *result)
>> +{
>> +	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
>> +	struct pci_driver *pdrv;
>> +	pci_ers_result_t vote;
>> +
>> +	device_lock(&dev->dev);
>> +	cxl_port_hndlrs = find_cxl_port_hndlrs();
> 
> Can we refactor to have a common function under this and report_error_detected()?
> 

Sure, this can be refactored. 

The difference between cxl_report_error_detected() and report_error_detected() is the 
handlers that are called.

cxl_report_error_detected() calls the CXL driver's registered port error handler. 

report_error_recovery() calls the pcie_dev::err_handlers.

Let me know if I should refactor for common code here?


>> +	pdrv = dev->driver;
>> +	if (pci_dev_is_disconnected(dev)) {
>> +		vote = PCI_ERS_RESULT_DISCONNECT;
>> +	} else if (!pci_dev_set_io_state(dev, state)) {
>> +		pci_info(dev, "can't recover (state transition %u -> %u invalid)\n",
>> +			dev->error_state, state);
>> +		vote = PCI_ERS_RESULT_NONE;
>> +	} else if (!cxl_port_hndlrs || !cxl_port_hndlrs->error_detected) {
>> +		if (dev->hdr_type != PCI_HEADER_TYPE_BRIDGE) {
>> +			vote = PCI_ERS_RESULT_NO_AER_DRIVER;
>> +			pci_info(dev, "can't recover (no error_detected callback)\n");
>> +		} else {
>> +			vote = PCI_ERS_RESULT_NONE;
>> +		}
>> +	} else {
>> +		vote = cxl_port_hndlrs->error_detected(dev, state);
>> +	}
>> +	pci_uevent_ers(dev, vote);
>> +	*result = merge_result(*result, vote);
>> +	device_unlock(&dev->dev);
>> +	return 0;
>> +}
> 
>>  static int pci_pm_runtime_get_sync(struct pci_dev *pdev, void *data)
>>  {
>>  	pm_runtime_get_sync(&pdev->dev);
>> @@ -188,6 +245,28 @@ static void pci_walk_bridge(struct pci_dev *bridge,
>>  		cb(bridge, userdata);
>>  }
>>  
>> +/**
>> + * cxl_walk_bridge - walk bridges potentially AER affected
>> + * @bridge:	bridge which may be a Port, an RCEC, or an RCiEP
>> + * @cb:		callback to be called for each device found
>> + * @userdata:	arbitrary pointer to be passed to callback
>> + *
>> + * If the device provided is a bridge, walk the subordinate bus, including
>> + * the device itself and any bridged devices on buses under this bus.  Call
>> + * the provided callback on each device found.
>> + *
>> + * If the device provided has no subordinate bus, e.g., an RCEC or RCiEP,
>> + * call the callback on the device itself.
> only call the callback on the device itself.
> 
> (as you call it as stated above either way).
> 

Thanks. I will update the function header to include "only".

>> + */
>> +static void cxl_walk_bridge(struct pci_dev *bridge,
>> +			    int (*cb)(struct pci_dev *, void *),
>> +			    void *userdata)
>> +{
>> +	cb(bridge, userdata);
>> +	if (bridge->subordinate)
>> +		pci_walk_bus(bridge->subordinate, cb, userdata);
> The difference between this and pci_walk_bridge() is subtle and
> I'd like to avoid having both if we can.
> 

The cxl_walk_bridge() was added because pci_walk_bridge() does not report
CXL errors as needed. If the erroring device is a bridge then pci_walk_bridge() 
does not call report_error_detected() for the root port itself. If the bridge 
is a CXL root port then the CXL port error handler is not called. This has 2 
problems: 1. Error logging is not provided, 2. A result vote is not provided 
by the root port's CXL port handler.

>> +}
>> +
>>  pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>>  		pci_channel_state_t state,
>>  		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
>> @@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>>  
>>  	return status;
>>  }
>> +
>> +pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
>> +				 pci_channel_state_t state,
>> +				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
>> +{
>> +	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
>> +	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
>> +	int type = pci_pcie_type(bridge);
>> +
>> +	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
>> +	    (type != PCI_EXP_TYPE_RC_EC) &&
>> +	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
>> +	    (type != PCI_EXP_TYPE_UPSTREAM)) {
>> +		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
>> +		return status;
>> +	}
>> +
> 
> Would similar trick to in pcie_do_recovery work here for the upstream
> and downstream ports use pci_upstream_bridge() and for the others pass the dev into
> pci_walk_bridge()?
> 

Yes, that would be a good starting point to begin reuse refactoring.
I'm interested in getting yours and others feedback on the separation of the 
PCI and CXL protocol errors and how much separation is or not needed.


Regards,
Terry


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2053.outbound.protection.outlook.com [40.107.243.53])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3ED8618DF6E;
	Wed, 16 Oct 2024 18:16:38 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.53
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729102600; cv=fail; b=gq/rEQWWeRpSny1ymBX/zYc75jIKbSUPpyxlrQCHJzefsEKClVcSZNW5qCQmInB0VKHaTwUU4az8JB7sg98s+KfqFsSoWGoxusFXX9LfOHGZ6Q4xNcjNRuDgSnNEYK8BlUMt7OxXLsDpl/We4VzYdD4D05nIXcBnTt2or90K+bM=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729102600; c=relaxed/simple;
	bh=VSEXTE7nB7w50KpjQFIE71SkKdIDYjS5wMw8m6Y6I2Q=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=CsC5CWbd88i6xiMUfTsK/5X1+eqhOPAhoq2bBlOlTxbjDeAUCcvMGWLVFZGGb7lo6KIF9SibVn/zGQ22ECqELlNslOILPVVvT28g0thVISXHrs+vWssTucn1w/j5ksTdh3uPre06E9f8wfmj4p3Jd7W5UQPZqgaVrGflCRkzQbU=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=KpT/w1+i; arc=fail smtp.client-ip=40.107.243.53
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="KpT/w1+i"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=buO20J4FOpcR+1FQB9e0oQNAjfWYZmS7SClpB8dIRygj6NKSx9M4jJwgfmfaUs+ZV4aFCGZRyGQqctU87xX5yrRrX7UvYTSqZ+EILgewoDeiRHYWF0KSldQha6PjVNxakihDpoTMP95ZxqJyA6RTdRIIj2+Z3va9F6meLjilxZI3mkl1NofIYlZ/4YDMNOkJg44GSNL97LN5SKw0uyX3iSqBKI2WEzf3tgxR44CSkgm//8MPzX0sv6knvSvNMdlG6mDPA2wJS0T8ag/i2duRXpOcLGF53/EGdp/uSrlh0rsLEHy70zzurf6HV8jlodb8ePztICVsCLYm3zWf9rLD4w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=d8soGce1iuRNNkzJ9cgm20/zFtW9IG5N+vbbjhJ+ADM=;
 b=JB/knEC+diFTvFmn0ZN/Bl9chIY6YA7hMY0de8hcJLJSaXz+qLKjLYO/VL4g8l/ZTPqC6qkqjM1zCSsGEgIvEurZIkTd9lIJe+ytDUiPsY6fdoVMmObaH2PuM0ujFCwLcBohe+QBjg7Le2RyYRc9X2Hjv52VbRJQKnBOajnZTTzxkWakS4+9gfjLNKRDOaB97hI05ZLHoezjQe7WxXpenKEC6I8J98AQAC8RjcZrajmLFfqqQ9cM8cfN69yv0kB2BEM5P+y80vnuOO5d/Cl7Tjhcxk1DPVNRr5L+Rms90dKn4s+Hvr6HZ/yRoplnxveMcpd9yDo2ZiRxKgF/JWHL/A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=d8soGce1iuRNNkzJ9cgm20/zFtW9IG5N+vbbjhJ+ADM=;
 b=KpT/w1+iwMrfFk6j06LCEE+kjHXougTLmLLeCbwIwxhq5tNsHq+F+RlXvQRsmJpCty2LOy6fVc0iw/tIZqN2J/uzJd97DyxHCtAfC+iHxOrimpzzx0YxMLcVS+9kuvQTpbYRjxZSX2aXpFFu5xkAjtLwzX78ztE7UsgMRmC2ie4=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 IA1PR12MB7517.namprd12.prod.outlook.com (2603:10b6:208:41a::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.26; Wed, 16 Oct
 2024 18:16:36 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8048.020; Wed, 16 Oct 2024
 18:16:36 +0000
Message-ID: <4a298643-28f0-4aac-be2d-32b8ff835e2a@amd.com>
Date: Wed, 16 Oct 2024 13:16:34 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 09/15] cxl/pci: Map CXL PCIe downstream port RAS registers
Content-Language: en-US
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-10-terry.bowman@amd.com>
 <20241016181459.00000b71@Huawei.com>
From: Terry Bowman <Terry.Bowman@amd.com>
In-Reply-To: <20241016181459.00000b71@Huawei.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA9PR13CA0019.namprd13.prod.outlook.com
 (2603:10b6:806:21::24) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|IA1PR12MB7517:EE_
X-MS-Office365-Filtering-Correlation-Id: 01ff8bca-800c-4d47-f599-08dcee0eabcb
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|7416014|366016|376014;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?TTlzTGtPQm1sZzExSGtobUdTb3pwR2c1Z0E2QUR4UzhZY1p5UWRXdXRzZXJp?=
 =?utf-8?B?ZVU0cWRrK1lTOWxnL25hcFFvcUcwTklPNDI3M0RFVmRWZDNlRVcrbldRaFQ3?=
 =?utf-8?B?eXI1dkhPL3ZFcjdVRWxqZUFJVFJkVUxLNHk2NG1PL1BxYTNhR1BsdDlldjht?=
 =?utf-8?B?eURxRjJJYW5YUXlHekpkdGJOUE5GcDI0dERiMHIxUERlNVlSZ1RMSzBDckdp?=
 =?utf-8?B?OUpHYmY0QnlFWG8vK1psZkptQXpHSE9nU0VRdmFaTjVGczg0OWp2QkpaR1RT?=
 =?utf-8?B?WVVtRE4wc3ZxNFZrbGcvYnZ4K21KYnFoUW9EL3REd0NvMmhpck5NSTBBVDhk?=
 =?utf-8?B?V2luV1ZvQ29RYkhrTngwdUxObk5ZU2UwcjRKZHpNdEZ5NFNTSTlDcENWRUtH?=
 =?utf-8?B?ZS9IQUZ5Tmo0RzhhNE51NStBQUlDaXJwZUF3K2ZlOW9heGE2VlZlcUpaSGhO?=
 =?utf-8?B?V2xDY1hLaG82MmNUMmlBU3B0R0VWcW40SnJtRVVONm5NZE9xM2ZlMUVMTCtm?=
 =?utf-8?B?ZElQWkNXL2lnYVhQRVpQbDhub1RnSDRNUTVBZkc4TDRmdlBseWZmaTNhb3g1?=
 =?utf-8?B?QUpRZk9Rdzkwd3docGhOMW5ZMlhvcjZhMjBvYWpuOTVZUzdkTDViNWNYMnVO?=
 =?utf-8?B?TVhVZUp3a0N6MGdJbjJMMm1hV081VC9DclBhWUExNlRlR0dVQ1JQV0xNNDYw?=
 =?utf-8?B?U0ZJUGJST0NUa0lzMW1uMDZRSUZybzBjZkQ1MDRHSkUyd0NLMVBZNUFSM1JH?=
 =?utf-8?B?R1hlRlhGQ2N5dkcyYUtYOGVJNVIrc0xRbFFHS3VKNlVnbUVLaTN3OHk5RDhz?=
 =?utf-8?B?UklXWVhOcWJBWGxZaG1TazN3WmgyRUJ6QjBrOFFvVjhkUGUrOCtrSVUvRWhI?=
 =?utf-8?B?OWVBaDY1UjhPUVNpSmRhcCtxRk1tS3dwajVXTm1HTEFES2hVTXZxN3g0dXJT?=
 =?utf-8?B?Z0d2bWt3WVQ2MHQrVG4zcTFrM0VsNkNvbzA5SnIwSE5BUi9MSWRjR0VTZ09U?=
 =?utf-8?B?TFpWclMrb2dRTVYxQUFKWjdTZWQ3K3UxOWdyeFptdXpxdnkxYlJZQ0ttWmxZ?=
 =?utf-8?B?cEFWT0hZSFhCNEM1OVd5cFpZaTJZZ2JIN3JBc3RFd3NjN3V2RzdlZ3UzRnFP?=
 =?utf-8?B?K2J3R3RNMlNUT21ubUkvSXd1S1NXdm1hS2FGbnduR2svTnpEQk9qT3M4OUkw?=
 =?utf-8?B?ZHNaSDBBNGxzOG9INmdEZU5COFhzSnU1RHFVbWlnTmpFSEN1NWg4VnRybWgw?=
 =?utf-8?B?enkxUVd2WTNJMEVNMzRkSyt1SXVKM1dmUDlKS24yUWlUZC9XVENpb01VZFJF?=
 =?utf-8?B?b2FXUlZPTDUvZjRjTndTQzFmRkZ6eFNaekVhaWU4amRNQml6cEJtOXBlUXpV?=
 =?utf-8?B?OUZHUmYvc2swbGFzZjIxYm5TbjFLZklWU3d3V3NzcmlCR2EwOGpROE9MMEdO?=
 =?utf-8?B?cURueUFjZ0hqdHBYUVQ3L2I3OFZiWjZmZXpvRkZDT3hkdlNwZGxZN0dOTnE0?=
 =?utf-8?B?TC9hTSs4SE1Bait6aGNRQ3hZaG5jTUxjQ2NoaS9tQ0xOcWkrL3hyQWVWQ3oy?=
 =?utf-8?B?Mk9SR2NqSEgzdUVycE1Pc3EwMFFLaGdGWlhxdExISFArVk1sNHNJVlo3UjE5?=
 =?utf-8?B?K0F1TnBCVERiMXZCekl1NDJ2bnZFMGNNcjFYMmg1QWV0V0cvcFR1elhjN1g5?=
 =?utf-8?B?OVVCRWZCOCtySDFJZUUzM2RadTF6U2Vlb2RreWJsRTNFSVU1NUgxNkRBPT0=?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(7416014)(366016)(376014);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?TnNKNklnZDU4NXM2bTZRenRVOFVnd1p2YXE5dG54TkZ6OS8zcFMwenl1SHdk?=
 =?utf-8?B?VE4rN2JDT2UyRlVhSjFpM3BOUjlUUmJ6eGFVU2FRSnJ4MGFHYnpOc1pUcnps?=
 =?utf-8?B?enVhRWhhOVNNblo3eU43RmhQOEN1Y0NHelY1eHNRYmt4MXYrV21DWk9HOWYr?=
 =?utf-8?B?SVNTM2NsOUFPQXhwcDNaMGhiNGlhak5zQkpySFpOSnlCTC9PNFVJS3NVSVY1?=
 =?utf-8?B?RmYyUEg3SXE4b2tCekxqNm4wL1FFZ2xCRkVTU0VOcWJvcm50a3dxTktwd1Ex?=
 =?utf-8?B?SDF5T3FmaDI4VkZ3a2l6Tk1XWkdVek5PajVNOElaYklWTzloTjFaVjZXeklz?=
 =?utf-8?B?a09yMk5TZ1Q5NTl2TVE0bFpMWWNYcnU3WnUzL3ZTQUZkUllqbnFOODJqdHgz?=
 =?utf-8?B?cm5CaVc0VlVNMy9YSWR4MkdrejE3WjE4ZCtycVFBT2w0QU9PTTBGR3BPMkdr?=
 =?utf-8?B?VXc4clBjN0prYyt0OFFRdjI4SERoWWU4a0Z4UUZZbmxiUk1uNjBqbXBCbnla?=
 =?utf-8?B?YUJJUE1SVTdjRXpzMW9aS09tc2M1TE1yRTh4UlRpWmtsK3kwdHZzQkp4OFFE?=
 =?utf-8?B?MkllbmNnUjNJelF5bkNSY2hKZFZEbVVhVU9jenpHVXErT3dPZHBkNldlU2Ew?=
 =?utf-8?B?NHpSRjVzdEh2aUlkWUtGZVFVVUFqcGtYOWloTHRIbUpIUkMwRkFUOFpJdVBJ?=
 =?utf-8?B?Rzk5YWg5TkxWRnJvTlN4UUxFZ2ZDanJXZ0xSdDVWMHFxVGVsWGhmUU42Mngy?=
 =?utf-8?B?YjN2elJuQ2ZyM3FRdjlXN1JDcndZM0xXU3RIbHYyVVB0YWFLakZROS9pVm9S?=
 =?utf-8?B?djNCa0NUMVppeFpCUTFPTGZIMGErdVgzNTFlbUQ1RkZzTzRya0tqSXRLMUFq?=
 =?utf-8?B?Y2JGT09HQkRyMGxIc2lSSVdGbS9pRGhRS2wwYTh2UjNCTTNxcFhkVFY1T2NY?=
 =?utf-8?B?Q0xzdWEzVkZWaGlkL1hhbFkrS0Zmc0w1TGxKN2tyU085NmMyak9BSkl3TllZ?=
 =?utf-8?B?MGFKUWwyS3ZMUkhsMHJNQ3IwN0wxL0VOeTRMZ2x4UmZhcTE1dXNEeDRUWXZn?=
 =?utf-8?B?Q2F1UE1PMlRBbnFEY3ExT3QrYzc5R1gxYlgrUlBJYXFtWW92NHJhR3VaT1V6?=
 =?utf-8?B?VStGN0dFcnhnZ3ZIWlB0SDV2L2FCNUxna0NFQStDWFZGRUVHQnNHRUZPdllM?=
 =?utf-8?B?UHdXZjkwb0dMT0xadTV5ekFNK2ZSTTBCeisva2ZXZHp6cm9OZFhtTGtXNmJ0?=
 =?utf-8?B?RHord2JKVzg4V3pSdjVCODVxMXhjV2tlOEVFRHUwcnFqOEZlU0lIWG45SFFj?=
 =?utf-8?B?QW1idWJMNnhIc3BxVVZDakhwbFU2R2RFUFYxdm5jcVg0NDRlQWU1UmgwaDF1?=
 =?utf-8?B?R1pBZGtVYzN0YXFhMHovYzJoMmtNa3NTTlU1YUtDVFM3ZTU5aG5kcTRqa0FW?=
 =?utf-8?B?SHQ0OVU0dVNLMWVaamZtTEVSMHByWWVFWGV1YUJINDIrSzhTYnJZODZHOW83?=
 =?utf-8?B?Q1lhWjFXb2N6MkdxTlRRWitVcFhSNm1vclZPRExsRWVzZGpUaHV6OVZmYW4r?=
 =?utf-8?B?TGROU0xEcHlTcHcrZ3NOV0l3TTBFazBxeTg2K1laMFJrVjZtdDlPZEl3MWlD?=
 =?utf-8?B?Nm5STzN6UDlEQmE0cU91Y3pnb2ZMTGxxRHdjTEhpaDM0L3lPOUI1eXgweFc0?=
 =?utf-8?B?QldheEgxT3JtQm5YdVZ5TjN5cVRZVkxteTU0ODJtUGptbHY0K1Nha0FtMHVh?=
 =?utf-8?B?SlJBZzBON3BpdGp6cEVZSGNJQ1VFeENpOHVZNU5xV0hDcnFISGFjMGdKTlhk?=
 =?utf-8?B?Z24xMUdJakJ4dVE5ZW8vcWNwZWFsVU9oM0paVkp2YXBncFRBdE0wMXJwd1du?=
 =?utf-8?B?cDFYa0d0Z05pMFpCd3hPMzZFRk5JZDVaTTByZE92Qmo3ckpoWWZGR2xpaExF?=
 =?utf-8?B?eFBsTUZxZkZWRUJsNWNoUk5hUDFmcTZhYVFINFc5TFR1Z0tGc0VVZW1hSklM?=
 =?utf-8?B?c1F0ejJSaExlR0JhSG40cDFWd3RvOHgxc1crcUt1ZDFBamkwV1VSOWhsVVlP?=
 =?utf-8?B?MnA5R2FDSXN0ZEVOcjZ2UGVETWVrUlFtTHFBM1RrdFJ2b3ZhNmtZQU5DR0NQ?=
 =?utf-8?Q?HxLDpo0HixgZkzd8x2gJVV2Kv?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 01ff8bca-800c-4d47-f599-08dcee0eabcb
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 16 Oct 2024 18:16:36.0478
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: wi4aZ/t1vPl8F+781hrbYEEr+8ga6QyDZfxOCA92GWh7WEFv61gI0P9Bp2v+y1c7tRcYZivoLqQ6zfQd8HLdWA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA1PR12MB7517
Status: O
Content-Length: 1696
Lines: 48

Hi Jonathan,

On 10/16/24 12:14, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:51 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> RAS registers are not mapped for CXL root ports, CXL downstream switch
>> ports, or CXL upstream switch ports. To prepare for future RAS logging
>> and handling, the driver needs updating to map PCIe port RAS registers.
> 
> Give the upstream port is in next patch, I'd just mention that you
> are adding mapping of RP and DSP here (This confused me before I noticed
> the next patch).

Ok. Good point, 

>>
>> Refactor and rename cxl_setup_parent_dport() to be cxl_init_ep_ports_aer().
>> Update the function such that it will iterate an endpoint's dports to map
>> the RAS registers.
>>
>> Rename cxl_dport_map_regs() to be cxl_dport_init_aer(). The new
>> function name is a more accurate description of the function's work.
>>
>> This update should also include checking for previously mapped registers
>> within the topology, particularly with CXL switches. Endpoints under a
>> CXL switch may share a common downstream and upstream port, ensure that
>> the registers are only mapped once.
> 
> I don't understand why we need to do this for the ras registers but
> it doesn't apply for HDM decoders for instance?  Why can't
> we map these registers in cxl_port_probe()?
> 

We have seen downstream root ports with DVSECs that are not fully populated 
immediately after booting. The plan here was to push out the RAS register 
block mapping until as late as possible, in the memdev driver. 


> End of day here, so maybe I'm completely misunderstanding this.
> Will take another look tomorrow morning.
> 

Thanks for your reviews.

Regards,
Terry


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 612DD1DDA31;
	Thu, 17 Oct 2024 13:31:14 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729171878; cv=none; b=Q7N4MXW1R4LkIjEi1qCXm7bJfmyb29LV4IZa+4QW2LX3o8ysiOt/BbCuU4eSGt+Rmo3+dsVYAFWgMYupZ9ALU19XHSMZrkGntSzuH1RQZayd343kxtqPvcPPRiM9yKk3h5CrlpvSPt1cUhJbiaPR1JA3V1igGdXOpvTuQVokBns=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729171878; c=relaxed/simple;
	bh=AA0+BSw8gb7CWEmHQjYrvI9mdR0Nlru1/nmOVynku28=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=N8jUOy7+SaeXiw0k14ZFKZ/51wHk+dKFlLCfPd4gvSQQxHpaQAsRPd/1jpxEuu1mSh3cc440jzZ+DX2CCT2Hj6I6dlnDd3wE5JLb3+oe/+Ey1IHx+s+fIIHi5gNVn6K+l4tnJmDZvKVQJ3pW2aZoFzhziGXAiQiKQQ9CUDFqy7E=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTpbC4wtmz6FGr7;
	Thu, 17 Oct 2024 21:29:27 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id D8019140119;
	Thu, 17 Oct 2024 21:31:11 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 15:31:10 +0200
Date: Thu, 17 Oct 2024 14:31:08 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <Terry.Bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 06/15] cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to
 pci_ers_result type
Message-ID: <20241017143108.000075ff@Huawei.com>
In-Reply-To: <6555a001-4f5e-40c0-bf27-38dd7a15c3d9@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-7-terry.bowman@amd.com>
	<20241016173011.000021e4@Huawei.com>
	<6555a001-4f5e-40c0-bf27-38dd7a15c3d9@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml500002.china.huawei.com (7.191.160.78) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 1655
Lines: 53

On Wed, 16 Oct 2024 12:31:35 -0500
Terry Bowman <Terry.Bowman@amd.com> wrote:

> On 10/16/24 11:30, Jonathan Cameron wrote:
> > On Tue, 8 Oct 2024 17:16:48 -0500
> > Terry Bowman <terry.bowman@amd.com> wrote:
> >   
> >> The CXL AER service will be updated to support CXL PCIe port error
> >> handling in the future. These devices will use a system panic during
> >> recovery handling.  
> > 
> > Recovery handling by panic? :) That's an interesting form of recovery..
> >   
> 
> Yes, Dan requested all UCE (fatal and non-fatal) are handled by panic in order 
> to limit the  blast radius of corruption in the  case of UCE. 
That's fair enough.  Maybe it should be called attempted recovery handling ;)

This is fine.
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

Jonathan

> 
> The recovery logic in cxl_do_recovery() (not using the panic) is also tested as well.
> 
> Regards,
> Terry
> 
> >>
> >> Add PCI_ERS_RESULT_PANIC enumeration to pci_ers_result type.
> >>
> >> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> >> ---
> >>  include/linux/pci.h | 3 +++
> >>  1 file changed, 3 insertions(+)
> >>
> >> diff --git a/include/linux/pci.h b/include/linux/pci.h
> >> index 4cf89a4b4cbc..6f7e7371161d 100644
> >> --- a/include/linux/pci.h
> >> +++ b/include/linux/pci.h
> >> @@ -857,6 +857,9 @@ enum pci_ers_result {
> >>  
> >>  	/* No AER capabilities registered for the driver */
> >>  	PCI_ERS_RESULT_NO_AER_DRIVER = (__force pci_ers_result_t) 6,
> >> +
> >> +	/* Device state requires system panic */
> >> +	PCI_ERS_RESULT_PANIC = (__force pci_ers_result_t) 7,
> >>  };
> >>  
> >>  /* PCI bus error event callbacks */  
> >   


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0E5761DE2BF;
	Thu, 17 Oct 2024 13:43:20 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729172605; cv=none; b=tAZB+Ja68Dh/qGTb2TPhl0FeJiAPYc9riR102y73MMPRP7wg7hR2kuNmePR81ANJE9kswrLHX/zb+Fk5oT0mdAM4m9G+TK9MuxESY/pS5EoAksnbTaGNjKkMSEGIfs9eEC6SCfBuoCyZVp8LiadtJPQXUDInnSDP1u2kDq3NBcc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729172605; c=relaxed/simple;
	bh=5LyTqTZPGkMyvDmA1zwEAXFqSeskAN5N2Etr3ZM6CtQ=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=jrl95SEUYDNh0pIegZtWm+WFiHD4Ts6WvYrWg4mZOi13394cRVa+jqB8UA1FbfVtmpTXDUozUGQCX3ZdE+2K4o25qwFfXBSYeYhTUor434X91pK3OScVhytM56JTzjkz1k8Ax8LFGZksmIty7Bi6sDEGcaSA6tyL5QTQ0+/xvU8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.231])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTptP70TZz6HJb2;
	Thu, 17 Oct 2024 21:42:37 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 490CA1400F4;
	Thu, 17 Oct 2024 21:43:18 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 15:43:17 +0200
Date: Thu, 17 Oct 2024 14:43:15 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <Terry.Bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable
 error recovery in AER service driver
Message-ID: <20241017144315.0000074c@Huawei.com>
In-Reply-To: <ac5f05ec-5017-4ac7-b238-b90585e7a5bc@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-8-terry.bowman@amd.com>
	<20241016175426.0000411e@Huawei.com>
	<ac5f05ec-5017-4ac7-b238-b90585e7a5bc@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 8624
Lines: 227

On Wed, 16 Oct 2024 13:07:37 -0500
Terry Bowman <Terry.Bowman@amd.com> wrote:

> Hi Jonathan,
> 
> On 10/16/24 11:54, Jonathan Cameron wrote:
> > On Tue, 8 Oct 2024 17:16:49 -0500
> > Terry Bowman <terry.bowman@amd.com> wrote:
> >   
> >> The current pcie_do_recovery() handles device recovery as result of
> >> uncorrectable errors (UCE). But, CXL port devices require unique
> >> recovery handling.
> >>
> >> Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
> >> specific handling to the new recovery function.
> >>
> >> The CXL port UCE recovery must invoke the AER service driver's CXL port
> >> UCE callback. This is different than the standard pcie_do_recovery()
> >> recovery that calls the pci_driver::err_handler UCE handler instead.
> >>
> >> Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
> >> "recover" the error. A panic is called instead of attempting recovery
> >> to avoid potential system corruption.
> >>
> >> The uncorrectable support added here will be used to complete CXL PCIe
> >> port error handling in the future.
> >>
> >> Signed-off-by: Terry Bowman <terry.bowman@amd.com>  
> > 
> > Hi Terry,
> > 
> > I'm a little bothered by the subtle difference in the bus walks
> > in here vs the existing cases. If we need them, comments needed
> > to explain why.
> >   
> 
> Yes, I will add more details in the commit message about "why".
> I added explanation following your below comment.
> 
> > If we are going to have separate handling, see if you can share
> > a lot more of the code by factoring out common functions for
> > the pci and cxl handling with callbacks to handle the differences.
> >   
> 
> Dan requested separate paths for the PCIe and CXL recovery. The intent,
> as I understand, is to isolate the handling of PCIe and CXL protocol 
> errors. This is to create 2 different classes of protocol errors.
Function call chain wise I'm reasonably convinced that might be a good
idea.  But not code wise if it means we end up with more hard to review
code.

> 
> > I've managed to get my head around this code a few times in the past
> > (I think!) and really don't fancy having two subtle variants to
> > consider next time we get a bug :( The RC_EC additions hurt my head.
> > 
> > Jonathan  
> 
> Right, the UCE recovery logic is not straightforward. The code can  be 
> refactored to take advantage of reuse. I'm interested in your thoughts 
> after I have provided some responses here.
> 
> >   
> >>  static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
> >> diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
> >> index 31090770fffc..de12f2eb19ef 100644
> >> --- a/drivers/pci/pcie/err.c
> >> +++ b/drivers/pci/pcie/err.c
> >> @@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
> >>  	return 0;
> >>  }
> >>  
> >> +static int cxl_report_error_detected(struct pci_dev *dev,
> >> +				     pci_channel_state_t state,
> >> +				     enum pci_ers_result *result)
> >> +{
> >> +	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
> >> +	struct pci_driver *pdrv;
> >> +	pci_ers_result_t vote;
> >> +
> >> +	device_lock(&dev->dev);
> >> +	cxl_port_hndlrs = find_cxl_port_hndlrs();  
> > 
> > Can we refactor to have a common function under this and report_error_detected()?
> >   
> 
> Sure, this can be refactored. 
> 
> The difference between cxl_report_error_detected() and report_error_detected() is the 
> handlers that are called.
> 
> cxl_report_error_detected() calls the CXL driver's registered port error handler. 
> 
> report_error_recovery() calls the pcie_dev::err_handlers.
> 
> Let me know if I should refactor for common code here?

It certainly makes sense to do that somewhere in here.  Just have light
wrappers that provide callbacks so the bulk of the code is shared.

> 
> 
> >> +	pdrv = dev->driver;
> >> +	if (pci_dev_is_disconnected(dev)) {
> >> +		vote = PCI_ERS_RESULT_DISCONNECT;
> >> +	} else if (!pci_dev_set_io_state(dev, state)) {
> >> +		pci_info(dev, "can't recover (state transition %u -> %u invalid)\n",
> >> +			dev->error_state, state);
> >> +		vote = PCI_ERS_RESULT_NONE;
> >> +	} else if (!cxl_port_hndlrs || !cxl_port_hndlrs->error_detected) {
> >> +		if (dev->hdr_type != PCI_HEADER_TYPE_BRIDGE) {
> >> +			vote = PCI_ERS_RESULT_NO_AER_DRIVER;
> >> +			pci_info(dev, "can't recover (no error_detected callback)\n");
> >> +		} else {
> >> +			vote = PCI_ERS_RESULT_NONE;
> >> +		}
> >> +	} else {
> >> +		vote = cxl_port_hndlrs->error_detected(dev, state);
> >> +	}
> >> +	pci_uevent_ers(dev, vote);
> >> +	*result = merge_result(*result, vote);
> >> +	device_unlock(&dev->dev);
> >> +	return 0;
> >> +}  
> >   
> >>  static int pci_pm_runtime_get_sync(struct pci_dev *pdev, void *data)
> >>  {
> >>  	pm_runtime_get_sync(&pdev->dev);
> >> @@ -188,6 +245,28 @@ static void pci_walk_bridge(struct pci_dev *bridge,
> >>  		cb(bridge, userdata);
> >>  }
> >>  
> >> +/**
> >> + * cxl_walk_bridge - walk bridges potentially AER affected
> >> + * @bridge:	bridge which may be a Port, an RCEC, or an RCiEP
> >> + * @cb:		callback to be called for each device found
> >> + * @userdata:	arbitrary pointer to be passed to callback
> >> + *
> >> + * If the device provided is a bridge, walk the subordinate bus, including
> >> + * the device itself and any bridged devices on buses under this bus.  Call
> >> + * the provided callback on each device found.
> >> + *
> >> + * If the device provided has no subordinate bus, e.g., an RCEC or RCiEP,
> >> + * call the callback on the device itself.  
> > only call the callback on the device itself.
> > 
> > (as you call it as stated above either way).
> >   
> 
> Thanks. I will update the function header to include "only".
> 
> >> + */
> >> +static void cxl_walk_bridge(struct pci_dev *bridge,
> >> +			    int (*cb)(struct pci_dev *, void *),
> >> +			    void *userdata)
> >> +{
> >> +	cb(bridge, userdata);
> >> +	if (bridge->subordinate)
> >> +		pci_walk_bus(bridge->subordinate, cb, userdata);  
> > The difference between this and pci_walk_bridge() is subtle and
> > I'd like to avoid having both if we can.
> >   
> 
> The cxl_walk_bridge() was added because pci_walk_bridge() does not report
> CXL errors as needed. If the erroring device is a bridge then pci_walk_bridge() 
> does not call report_error_detected() for the root port itself. If the bridge 
> is a CXL root port then the CXL port error handler is not called. This has 2 
> problems: 1. Error logging is not provided, 2. A result vote is not provided 
> by the root port's CXL port handler.

So what happens for PCIe errors on the root port?  How are they reported?
What I'm failing to understand is why these should be different.
Maybe there is something missing on the PCIe side though!
That code plays a game with what bridge and I thought that was there to handle
this case.

> 
> >> +}
> >> +
> >>  pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
> >>  		pci_channel_state_t state,
> >>  		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> >> @@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
> >>  
> >>  	return status;
> >>  }
> >> +
> >> +pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
> >> +				 pci_channel_state_t state,
> >> +				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> >> +{
> >> +	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
> >> +	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
> >> +	int type = pci_pcie_type(bridge);
> >> +
> >> +	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
> >> +	    (type != PCI_EXP_TYPE_RC_EC) &&
> >> +	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
> >> +	    (type != PCI_EXP_TYPE_UPSTREAM)) {
> >> +		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
> >> +		return status;
> >> +	}
> >> +  
> > 
> > Would similar trick to in pcie_do_recovery work here for the upstream
> > and downstream ports use pci_upstream_bridge() and for the others pass the dev into
> > pci_walk_bridge()?
> >   
> 
> Yes, that would be a good starting point to begin reuse refactoring.
> I'm interested in getting yours and others feedback on the separation of the 
> PCI and CXL protocol errors and how much separation is or not needed.

Separation may make sense (I'm still thinking about it) for separate passes
through the topology and separate callbacks / handling when an error is seen.
What I don't want to see is two horribly complex separate walking codes if
we can possibly avoid it.  Long term to me that just means two sets of bugs
and problem corners instead of one.

Jonathan

> 
> 
> Regards,
> Terry
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 224F5C147;
	Thu, 17 Oct 2024 13:50:29 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729173033; cv=none; b=O4YlsCd37CO/eiNGjnuE1iNASl4mQPvElU8gPRc3fiSY6QAcuRUafg3okHVVGN6KqQnw6HKhekjP/vNNkRqWX3WJY57OvcjagWEiIb4eWqh/cmFriwxkYRSFmvzAEsjMe/hjoOEXaRRAMOgZDgV06ED1pZwT9wIWLLzeQ5AD+WI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729173033; c=relaxed/simple;
	bh=5xPrhuKuYkqwxlo94JQl2Xs8SYAd5QckIzmBS+1GY5k=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=nmL7DlGhbCSxYi1GZZlFvjQyNzGDP0MmDDGRdko+VPqMOTQvMUweq840sVgH1K8CowgGh7jXOe+BX3I8BAiu3jnDh+o+DZEJ9iEuprpveBhfuWLRarzei8YBOT5qYn1aQjfbUKXz9KqY9SIFSYR3g7+EZE1GP1t7LBnP+jS/K3U=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.231])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTpyD10pRz6D9BV;
	Thu, 17 Oct 2024 21:45:56 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id BD13E1400F4;
	Thu, 17 Oct 2024 21:50:27 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 15:50:26 +0200
Date: Thu, 17 Oct 2024 14:50:25 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <Terry.Bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 09/15] cxl/pci: Map CXL PCIe downstream port RAS
 registers
Message-ID: <20241017145025.00002fd3@Huawei.com>
In-Reply-To: <4a298643-28f0-4aac-be2d-32b8ff835e2a@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-10-terry.bowman@amd.com>
	<20241016181459.00000b71@Huawei.com>
	<4a298643-28f0-4aac-be2d-32b8ff835e2a@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 2394
Lines: 67

On Wed, 16 Oct 2024 13:16:34 -0500
Terry Bowman <Terry.Bowman@amd.com> wrote:

> Hi Jonathan,
> 
> On 10/16/24 12:14, Jonathan Cameron wrote:
> > On Tue, 8 Oct 2024 17:16:51 -0500
> > Terry Bowman <terry.bowman@amd.com> wrote:
> >   
> >> RAS registers are not mapped for CXL root ports, CXL downstream switch
> >> ports, or CXL upstream switch ports. To prepare for future RAS logging
> >> and handling, the driver needs updating to map PCIe port RAS registers.  
> > 
> > Give the upstream port is in next patch, I'd just mention that you
> > are adding mapping of RP and DSP here (This confused me before I noticed
> > the next patch).  
> 
> Ok. Good point, 
> 
> >>
> >> Refactor and rename cxl_setup_parent_dport() to be cxl_init_ep_ports_aer().
> >> Update the function such that it will iterate an endpoint's dports to map
> >> the RAS registers.
> >>
> >> Rename cxl_dport_map_regs() to be cxl_dport_init_aer(). The new
> >> function name is a more accurate description of the function's work.
> >>
> >> This update should also include checking for previously mapped registers
> >> within the topology, particularly with CXL switches. Endpoints under a
> >> CXL switch may share a common downstream and upstream port, ensure that
> >> the registers are only mapped once.  
> > 
> > I don't understand why we need to do this for the ras registers but
> > it doesn't apply for HDM decoders for instance?  Why can't
> > we map these registers in cxl_port_probe()?
> >   
> 
> We have seen downstream root ports with DVSECs that are not fully populated 
> immediately after booting. The plan here was to push out the RAS register 
> block mapping until as late as possible, in the memdev driver. 

That needs debugging because simply pushing it later like this is
only going to make the race harder to hit unless we understand the
'why' of that.   If there is a reason to delay, my gut feeling would
be to delay the cxl_port_probe() until things are stable rather
than just trying this a bit later.

This might be the whole link must train before CXL registers are
presented thing (a less than ideal corner of the CXL spec) but not
sure it would mean they weren't available in cxl_port_probe()

Jonathan



> 
> 
> > End of day here, so maybe I'm completely misunderstanding this.
> > Will take another look tomorrow morning.
> >   
> 
> Thanks for your reviews.
> 
> Regards,
> Terry
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AA9691DB346;
	Thu, 17 Oct 2024 13:57:07 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729173433; cv=none; b=io1A17+ylh/JemOSUixJiCgeW/216hnFuzhqAh7yaydECUe/26NW+u38CF+QLppfkb4KwDLvXqK+znut+Jv57uPnLeste2uguMcmXSpTg58vnbkwVBYFjUI+js6PNJKmvC1EO44skJWSBiODBZkGmoPAecd3c9Cr8Ka9/T+al3w=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729173433; c=relaxed/simple;
	bh=dtkFcsRlwUuU51KNJdQptg5gAjCKgrQm6G8DaP5HcO4=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=ZZeX+CUAddfBJoliskc6LlVF5NS8oM60vweEUU3OlVKFWEYhvTsOw4Ij27R8hQld7wAboMh1XbMv8PR7JBpLREplA29B6FJkpm2aziDTW1zWUUUzsRbFnQNwBFU6m6wL1UUcJrlpa7Qe6DtEIbD7brh8SaQhQNcTHHfdtjGEUo0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.31])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTq954nS0z6FHBC;
	Thu, 17 Oct 2024 21:55:21 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id DF2A01400C9;
	Thu, 17 Oct 2024 21:57:05 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 15:57:04 +0200
Date: Thu, 17 Oct 2024 14:57:02 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 12/15] cxl/pci: Add error handler for CXL PCIe port RAS
 errors
Message-ID: <20241017145702.00006e58@Huawei.com>
In-Reply-To: <20241008221657.1130181-13-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-13-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 2843
Lines: 98

On Tue, 8 Oct 2024 17:16:54 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The CXL drivers do not contain error handlers for CXL PCIe port
> device protocol errors. These are needed in order to handle and log
> RAS protocol errors.
> 
> Add CXL PCIe port protocol error handlers to the CXL driver.
> 
> Provide access to RAS registers for the specific CXL PCIe port types:
> root port, upstream switch port, and downstream switch port.
> 
> Also, register and unregister the CXL PCIe port error handlers with
> the AER service driver using register_cxl_port_err_hndlrs() and
> unregister_cxl_port_err_hndlrs(). Invoke the registration from
> cxl_pci_driver_init() and the unregistration from cxl_pci_driver_exit().
> 
> [1] CXL3.1 - 12.2.2 CXL Root Ports, Downstream Switch Ports, and
>              Upstream Switch Ports
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
A few comments inline.

Jonathan

> ---
>  drivers/cxl/core/pci.c | 83 ++++++++++++++++++++++++++++++++++++++++++
>  drivers/cxl/cxl.h      |  5 +++
>  drivers/cxl/pci.c      |  8 ++++
>  3 files changed, 96 insertions(+)
> 
> diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
> index c3c82c051d73..7e3770f7a955 100644
> --- a/drivers/cxl/core/pci.c
> +++ b/drivers/cxl/core/pci.c
> @@ -815,6 +815,89 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
>  	}
>  }
>  
> +static int match_uport(struct device *dev, const void *data)
> +{
> +	struct device *uport_dev = (struct device *)data;
> +	struct cxl_port *port;
> +
> +	if (!is_cxl_port(dev))
> +		return 0;
> +
> +	port = to_cxl_port(dev);
> +
> +	return port->uport_dev == uport_dev;
> +}
> +
> +static void __iomem *cxl_pci_port_ras(struct pci_dev *pdev)
> +{
> +	void __iomem *ras_base;
> +	struct cxl_port *port;
> +
> +	if (!pdev)
> +		return NULL;
Why would this happen?  Seems an odd check to have so maybe a comment.

> +
> +	if ((pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT) ||
> +	    (pci_pcie_type(pdev) == PCI_EXP_TYPE_DOWNSTREAM)) {
> +		struct cxl_dport *dport;
> +
> +		port = find_cxl_port(&pdev->dev, &dport);
Can in theory fail.
> +		ras_base = dport ? dport->regs.ras : NULL;
> +		put_device(&port->dev);
If it fails this is a null pointer dereference.

> +		return ras_base;
> +	} else if (pci_pcie_type(pdev) == PCI_EXP_TYPE_UPSTREAM) {
> +		struct device *port_dev __free(put_device);

Should be combined with the next line. We want it to be hard for anyone
to put code in between!

> +
> +		port_dev = bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport);
> +		if (!port_dev)
> +			return NULL;
> +
> +		port = to_cxl_port(port_dev);
> +		if (!port)
> +			return NULL;
> +
> +		ras_base = port ? port->uport_regs.ras : NULL;

Given check above, port exists. Remove one of the two
checks.

> +		return ras_base;
> +	}
> +
> +	return NULL;
> +}

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 05C8A1DDC11;
	Thu, 17 Oct 2024 14:05:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729173908; cv=none; b=Sdyf1mEfpWWbas1X9H4sFsVUs3BvFB/VvSlWa/nCy81UGTlxBp9DQJyJNIzgl62jpEayCiYTIJX1vp+J5Y+tDGNkBnY9ates5FnEmr4Ba4cSZjWz3QriMYUQP6hy++1AliLTJhCjfNGWQ/IOyCWHD7hcDIdbTyC8QQCY+/15xRE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729173908; c=relaxed/simple;
	bh=+3rz/W+dHpiPjeoMnrT+yefTBY9dgfAzpWlj2y0d7+0=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=mn4SBvdemSNuLXCm9hhdXc+8o+0HQzmf397kRMtO4OV73dOHxFH6IEDbPKLfYunTBmGpTmw7DWzqp/l+I17ezFoOHHkaddMSu8pZO7KW07j7JcpDzP8oCCvkATKcNt8xUC2Y6AzkhUl5mAHF3ePl63FMTwB3qFfRgtaIaoUEUP8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.216])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTqLD2TSKz6FGZM;
	Thu, 17 Oct 2024 22:03:16 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 96020140119;
	Thu, 17 Oct 2024 22:05:00 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 16:04:59 +0200
Date: Thu, 17 Oct 2024 15:04:57 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Terry Bowman <terry.bowman@amd.com>
CC: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <dave.jiang@intel.com>, <alison.schofield@intel.com>,
	<vishal.l.verma@intel.com>, <dan.j.williams@intel.com>,
	<bhelgaas@google.com>, <mahesh@linux.ibm.com>, <oohall@gmail.com>,
	<Benjamin.Cheatham@amd.com>, <rrichter@amd.com>, <nathan.fontenot@amd.com>,
	<smita.koralahallichannabasappa@amd.com>, <shiju.jose@huawei.com>
Subject: Re: [PATCH 13/15] cxl/pci: Add trace logging for CXL PCIe port RAS
 errors
Message-ID: <20241017150457.0000538d@Huawei.com>
In-Reply-To: <20241008221657.1130181-14-terry.bowman@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-14-terry.bowman@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 4646
Lines: 139

On Tue, 8 Oct 2024 17:16:55 -0500
Terry Bowman <terry.bowman@amd.com> wrote:

> The CXL drivers use kernel trace functions for logging endpoint and
> RCH downstream port RAS errors. However, similar functionality is
> required for CXL root ports, CXL downstream switch ports, and CXL
> upstream switch ports.
> 
> Introduce trace logging functions for both RAS correctable and
> uncorrectable errors specific to CXL PCIe ports. Additionally, update
> the PCIe port error handlers to invoke these new trace functions.
> 
> Signed-off-by: Terry Bowman <terry.bowman@amd.com>

+CC Shiju Jose

Shiju,

Could you check the tracepoints / vs rasdaemon etc

Terry,

Just a patch ordering question from me.

> ---
>  drivers/cxl/core/pci.c   | 16 ++++++++++----
>  drivers/cxl/core/trace.h | 47 ++++++++++++++++++++++++++++++++++++++++
>  2 files changed, 59 insertions(+), 4 deletions(-)
> 
> diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
> index 7e3770f7a955..4706113d2582 100644
> --- a/drivers/cxl/core/pci.c
> +++ b/drivers/cxl/core/pci.c
> @@ -697,10 +697,14 @@ static void __cxl_handle_cor_ras(struct device *dev,
>  
>  	addr = ras_base + CXL_RAS_CORRECTABLE_STATUS_OFFSET;
>  	status = readl(addr);
> -	if (status & CXL_RAS_CORRECTABLE_STATUS_MASK) {
> -		writel(status & CXL_RAS_CORRECTABLE_STATUS_MASK, addr);
> +	if (!(status & CXL_RAS_CORRECTABLE_STATUS_MASK))
> +		return;

Add a blank line here to make that early exit easier to spot.

> +	writel(status & CXL_RAS_CORRECTABLE_STATUS_MASK, addr);
> +
> +	if (is_cxl_memdev(dev))
>  		trace_cxl_aer_correctable_error(to_cxl_memdev(dev), status);
So after previous patch, this code will be called for ports without this
check in here?  Perhaps the two patches need to be swapped in order?


However, we already know the type of device at the callers. Maybe just
pass that in here.
> -	}
> +	else if (dev_is_pci(dev))
> +		trace_cxl_port_aer_correctable_error(dev, status);
>  }
>  
>  static void cxl_handle_endpoint_cor_ras(struct cxl_dev_state *cxlds)
> @@ -756,7 +760,11 @@ static bool __cxl_handle_ras(struct device *dev, void __iomem *ras_base)
>  	}
>  
>  	header_log_copy(ras_base, hl);
> -	trace_cxl_aer_uncorrectable_error(to_cxl_memdev(dev), status, fe, hl);
> +	if (is_cxl_memdev(dev))
> +		trace_cxl_aer_uncorrectable_error(to_cxl_memdev(dev), status, fe, hl);
> +	else if (dev_is_pci(dev))
> +		trace_cxl_port_aer_uncorrectable_error(dev, status, fe, hl);
> +
>  	writel(status & CXL_RAS_UNCORRECTABLE_STATUS_MASK, addr);
>  
>  	return true;
> diff --git a/drivers/cxl/core/trace.h b/drivers/cxl/core/trace.h
> index 9167cfba7f59..6305c0eea627 100644
> --- a/drivers/cxl/core/trace.h
> +++ b/drivers/cxl/core/trace.h
> @@ -48,6 +48,34 @@
>  	{ CXL_RAS_UC_IDE_RX_ERR, "IDE Rx Error" }			  \
>  )
>  
> +TRACE_EVENT(cxl_port_aer_uncorrectable_error,
> +	    TP_PROTO(struct device *dev, u32 status, u32 fe, u32 *hl),
> +	TP_ARGS(dev, status, fe, hl),
> +	TP_STRUCT__entry(
> +		__string(devname, dev_name(dev))
> +		__string(host, dev_name(dev->parent))
> +		__field(u32, status)
> +		__field(u32, first_error)
> +		__array(u32, header_log, CXL_HEADERLOG_SIZE_U32)
> +	),
> +	TP_fast_assign(
> +		__assign_str(devname);
> +		__assign_str(host);
> +		__entry->status = status;
> +		__entry->first_error = fe;
> +		/*
> +		 * Embed the 512B headerlog data for user app retrieval and
> +		 * parsing, but no need to print this in the trace buffer.
> +		 */
> +		memcpy(__entry->header_log, hl, CXL_HEADERLOG_SIZE);
> +	),
> +	TP_printk("device=%s host=%s status: '%s' first_error: '%s'",
> +		  __get_str(devname), __get_str(host),
> +		  show_uc_errs(__entry->status),
> +		  show_uc_errs(__entry->first_error)
> +	)
> +);
> +
>  TRACE_EVENT(cxl_aer_uncorrectable_error,
>  	TP_PROTO(const struct cxl_memdev *cxlmd, u32 status, u32 fe, u32 *hl),
>  	TP_ARGS(cxlmd, status, fe, hl),
> @@ -96,6 +124,25 @@ TRACE_EVENT(cxl_aer_uncorrectable_error,
>  	{ CXL_RAS_CE_PHYS_LAYER_ERR, "Received Error From Physical Layer" }	\
>  )
>  
> +TRACE_EVENT(cxl_port_aer_correctable_error,
> +	TP_PROTO(struct device *dev, u32 status),
> +	TP_ARGS(dev, status),
> +	TP_STRUCT__entry(
> +		__string(devname, dev_name(dev))
> +		__string(host, dev_name(dev->parent))
> +		__field(u32, status)
> +	),
> +	TP_fast_assign(
> +		__assign_str(devname);
> +		__assign_str(host);
> +		__entry->status = status;
> +	),
> +	TP_printk("device=%s host=%s status='%s'",
> +		  __get_str(devname), __get_str(host),
> +		  show_ce_errs(__entry->status)
> +	)
> +);
> +
>  TRACE_EVENT(cxl_aer_correctable_error,
>  	TP_PROTO(const struct cxl_memdev *cxlmd, u32 status),
>  	TP_ARGS(cxlmd, status),


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (mail-mw2nam12on2084.outbound.protection.outlook.com [40.107.244.84])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 308861DE885;
	Thu, 17 Oct 2024 14:50:54 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.244.84
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729176660; cv=fail; b=QGmPlfh27xe59dzLIjkPjiDI+UVVDUHxGyEmURtNLcrU5yl8Cap/2Kc6732U3RLVV20tk7s9hEPV3UGzQ93xs4lO+mdm43f5P++TpXW9XGa1IxyFkNycmkRV7qW37+jw8jhhCuDxKeqGXDkL1eGqEbPmRSbnZMjWcwXCQeub7PA=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729176660; c=relaxed/simple;
	bh=TIprjj4xU/A8U0VMphuwWTWfn1NoxXSlM19kkEthZh4=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=TZ6v0oc8+fILuwqLSUU7ooIlNr6QURM4LMlJimsQyeJA8rT2kIh6TwIilwczkQtLJe0NN9PpVEp0aBo8+90k9XdGRa9x5BHW+IOIRbr4gJjToCBiQW00rVTVvWC4iQ0CVxdZrFGZCB+qE0ZuuLTPCe0RF/Tok7XCNjXzA5yMjGU=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=srcilRw3; arc=fail smtp.client-ip=40.107.244.84
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="srcilRw3"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=okDN5nd/nyB7qMxicHckBMCsVYsq7f49479WwsAL1Ce82dGxw6we0yqrdx1ZWw3MWkUQYFcBALAKt+QkzXzOkz6Jk45HmsoosB2Ql3aHyonpgVx2y5oSnnJdZfJP6AvkIaWZKtm8T91/g4UdhXh5NOD78ussQ66j9axdv+hmReyDBJyiqfU1dpBMgsp1XfFOWFtO8dXJn4n8mF15PUxht9RNdBlRge57aFKY+EIWgTy9MSjI8cnmmNsULOPOmScMk+RkgmMZzeC0fvqSWSd5r5+uX0dL3pg2GSL2MhV/TcJ3rJvgeP2u9zQtL/KfQP5Stf45Eur8SNgJccoRLw7S7g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=cGznFHhLhj5AmQbJ33mBwc3tMDJ2ZAWOlMbmQ08Cy6k=;
 b=zOWdUCUAN4du01sh9JQMbtQ+PBt1UCqLg5p6i/+o4LuMGZSDCtjV95bCl0om/4xsa12/GF5GsmDgSEFswoeUOeMCus1HbIrK+ee1YPuuahURa/CFpMTVulBrm/kPRVNsAVluRCoj7sWHEIUHcp7WDeMyMVGLp27BB/BdPK3fYqClD7kJh8Egw/Ys3u55Z8Q1IBXE4fU7BCmMsHImtbqmfvIOLKLN3ZBB7jN2xVjwitduRQY2ACz5ftPCD6DTKQemwZJHMXtXY/K5tU7JEOAAvA2b8zwz+ZAVMPofhebqEwhvQREfBHDlvET6QUnD5p5KW6a+rsPGbkTC7jfCVdAmOg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=cGznFHhLhj5AmQbJ33mBwc3tMDJ2ZAWOlMbmQ08Cy6k=;
 b=srcilRw3FrkpaelGa6uSiQnPqyOq/Mbdmqe4mGmbhvmBL9XnexCxrBBSa83T0DUxR86Gcq9Ky04XJ9Sg7a1xSrddEHBYLYL8UhNCvofkPhBWrFWGfflGQFrN3Sq6o7WwfU4Qn4Y3Y+VBldXQyZpq+BJ5aIX4lr0pAe+Qn7W4IzQ=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 MW4PR12MB5626.namprd12.prod.outlook.com (2603:10b6:303:169::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.22; Thu, 17 Oct
 2024 14:50:52 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8069.018; Thu, 17 Oct 2024
 14:50:52 +0000
Message-ID: <d4fea4e2-412e-49b5-aec4-7bbe8c7709c5@amd.com>
Date: Thu, 17 Oct 2024 09:50:49 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 06/15] cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to
 pci_ers_result type
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
 Terry Bowman <Terry.Bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-7-terry.bowman@amd.com>
 <20241016173011.000021e4@Huawei.com>
 <6555a001-4f5e-40c0-bf27-38dd7a15c3d9@amd.com>
 <20241017143108.000075ff@Huawei.com>
Content-Language: en-US
From: "Bowman, Terry" <kibowman@amd.com>
In-Reply-To: <20241017143108.000075ff@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN6PR04CA0104.namprd04.prod.outlook.com
 (2603:10b6:805:f2::45) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|MW4PR12MB5626:EE_
X-MS-Office365-Filtering-Correlation-Id: ba6e8781-a3ae-4e56-4870-08dceebb18a5
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|1800799024|376014|7416014|366016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?bjZPWHl0WG9FNW1XckQ0ZDdacjd1VXkvUmZlajJJb2JHeW5xUGJPQy9oajVO?=
 =?utf-8?B?Qm1uMDc5MURZOVFubFhmY2N6OUh2SkFSZjdmSXlmOEpnOGtSVWYxQVozV2lG?=
 =?utf-8?B?aWZwdTFXSzJveWt6STRMY1c2M3F0cytmbk8xRWpLM0FEKzVsQkkxZGJkQThY?=
 =?utf-8?B?bDRZWUt6THVsSGx6SnBSNWsyMitiWitDeXNyYTR1TUtHc0N0Q0p3UXk5VGps?=
 =?utf-8?B?M3ZWWUhOVG5BTzJTMFJyM1c2aEFtSENYR3YzbkVKQWRiZVE4OExWekdvSDBT?=
 =?utf-8?B?NU44allKaVMvSzFLa0tVVU5QK3QrbWV2UitDM1h1dFI2cmNiV1owYWdwaFF3?=
 =?utf-8?B?VUpRYWVNaEFKVFJUQlBvblBWemJrTWNFcFQxdm9lbFFzd01PL1RTQ2NxUUYz?=
 =?utf-8?B?My9HT2dhekNBc1BMaTRPODd2TitaaHR2bjFJb25OUmFrODdkYm9ydDg3UlZ6?=
 =?utf-8?B?MUo4Uk1QaFcwOTFuZU01ZTVHNXVCZHM3N0RlVjJWSXNLZTRiN3YrOXFVRzNm?=
 =?utf-8?B?aGcrc2IzOHY1NEpzclptOUVDd3NEaExqY2w4TnRkS3lRcnNPSVNCdWt3Wk5V?=
 =?utf-8?B?S0xhbXBOb2RsMkVhQ1p5UlU2VUNmdUdvWmVkRDhIaXJQcklrekFyRFU2Sko1?=
 =?utf-8?B?WmwwMG1tYmFnTUVXYk5yRjdrN1RBR2tVTTJpRnlNZzE0ZjlyQ3hQWjFPbmhm?=
 =?utf-8?B?SFJMRzNITkFSK3JYRkxwN3ZWcmdrb2E5TERFZnI4U0dkcGtqVHpmZWtuMEdw?=
 =?utf-8?B?U0JXUStlTHl0c0NXbnFITjlvU2k1T0hVWHFKb1ZSR05kZERpV0xCR3IyKzBy?=
 =?utf-8?B?eTdmL2I1YTg4dVBvTVNMZTNSbzdZRDY2MzQySDBVcmN6MlhPdm1WRDhGUWZS?=
 =?utf-8?B?UDJzdlpGNzc1S3krSnk5R2Y2OVBRZUt2OTdiZkhkWTRhWDljWnA4NTd2VDE4?=
 =?utf-8?B?SUxVbXM5ekswaGJLTmhKUk14bklEU0NwWSs5Nkw0eFpPNzNLeklWcDRmbFZS?=
 =?utf-8?B?Z0xVek5DUU53ZGIvTmZ6OXlQdmgzMzhQTGEyMnJQempBSnNUNEFCaUpJc0pH?=
 =?utf-8?B?bWZmTVFyN1JWaEJkQ2EwY1YwemU1bzdqVDB2RjBoVzhrTjJIRi9JZi9BK2sz?=
 =?utf-8?B?dU1GMTIwdy84TDBPOXZwWUZQOGR0dk9oQjFEVndQYTRuWFd2TmFzMGNFUHdU?=
 =?utf-8?B?Z2ptUE9BT0o2QjVpQTI3QzAwQm1TNkZieVYyWHBNR2NmVVZ2TmUrM203ZVhY?=
 =?utf-8?B?dm5DeFplcmg0emMxZG1yVGF1ZUlQZng0aElzYy9WcitnSHVEWGwrQU90b0NF?=
 =?utf-8?B?TTB3aXYvM01nVGlwQ1owanRTUDFDRURYMWk1MlgzRWROMHk2bzlUdXJwR1Rt?=
 =?utf-8?B?dmxCdVB5MHNDam8zcUQ3cmVJczNFZUZuOVpBN0t4anA1Tnp6SlVmMTFRNWdY?=
 =?utf-8?B?Q25heWdTdFlFSHl3bjYxSG1XMlprRnovR0pQR05hY0JVbldFbWJTS3ZyWkpK?=
 =?utf-8?B?bitRYlhMZUJzNVVEbGdGbzdGVGVCaFBvMUN4MXZYbXFTWWdWMUdQUWh3eGtn?=
 =?utf-8?B?bUtiQ2hWYS85R202azV1cFdiVWRNWGgvQlhVYUN3YXR5TXoxVkZycVEvenJS?=
 =?utf-8?B?YndMcnB4TUN1T2FsYllEbkFDaENFbmR4cG9PWVo5RWNNOU9HMkdqWDgyN1ox?=
 =?utf-8?B?a3J1WE1nakNKR0dIbVpPbDMrYmJkU3hReDJHV0dSUzN4SnpOSzJVYzd2QjhL?=
 =?utf-8?Q?g+SfL/2p33KXb5YNciKrCvHEjhFzpU4lw9y1yd3?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(376014)(7416014)(366016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?VU1KT2NCbzVnZDV6c0NaSnEyUGZZdDNPYWZjUjR4THRyMWJ1aG80d3BCSnpL?=
 =?utf-8?B?MDQwRU8zb1U4SWM0bWxFYVlpQ2ZiS3p3N01xNTNqcCtVY3p2UkxPQVZ2SDZt?=
 =?utf-8?B?dnpOMzEwb1ZJbHR3UGh4bjNmS1VmcGRzNnBZUFJpOGY0Wmp2VU5GZ1dlU2do?=
 =?utf-8?B?bm1YdmFOVkhNa3M0czVjK25XZ0draTFvVWhjbTg5VHdQTWNuTTAvbVI3NG05?=
 =?utf-8?B?ZkZ3Y0NEbmpMSm0xa0VRNk1SWnVKUktHRWZoMGY1NnFETHJodWxlUDhnRml1?=
 =?utf-8?B?em1CcCs0NWdUN1lwYkgza0g4ek01SWl0b3BVdU5qVEwzRWtsWGtwWVZSbk13?=
 =?utf-8?B?QnZCZ2hSd2VOV1Z2WmcrZ2NVUE03eDRtblU5TUs0U1dXQmJjOUYzUXNIY3Rr?=
 =?utf-8?B?WHdTYnJUaEE0NDBibk8yUDcwRnJsMENLTjAybkp0TVpNeldVWjhuUlZDRDM5?=
 =?utf-8?B?UkpFN25yZkZhVURVQm5jTzBhbzhOcHBhUlByNXRaaFg2MGZIQzNjTlV6Szg2?=
 =?utf-8?B?dEJtc0RjS3NHWTZtWkVOeEpEa2J4L3BkZjNZd1VxajZOZ2hpeFE3Y0VodUhT?=
 =?utf-8?B?d1FvSG1Ta2JvdEN0a3hyaWlRZDRlaHdWeHpGMHh3NCszNHV6NVkvaWxMM3Yy?=
 =?utf-8?B?MG1zVHFRSTBNMUUzdTlqZXI3QVU1NmUya3laRjliUDVwZHhXcVlYejhYdnh6?=
 =?utf-8?B?U2Rtek94OTRqY3lTR2NpYjE1Y1hWSy9oTWRSd05MMXR5ZlV3L215RmJXNDJq?=
 =?utf-8?B?TTF6N0VwY2hLUituT2JPYUtIbTd4aHA2ODhKZ0o5bDNzOUJJRkdqOUhJTTQr?=
 =?utf-8?B?RWdOWld5eWpkK3FLUVZ5cmdEWStrSFNQclA4RHd6OEJaR1lCeUxNdTJ2ZnRx?=
 =?utf-8?B?YUw2OWJJVVZqWFZqKzhncXVweEgzeTIyL2NpNUFWZHh1SnIrTlhpMllhV0lT?=
 =?utf-8?B?eW5jVStIR1lSMkREUFVDSFFQL3VOWWphTFU3eWpyUkRWZWRiZWRmakxtRkNr?=
 =?utf-8?B?dHZmQ3Vna01VK29FaWJ3U0gycDJHM1lCUXE4Nnp4R09xRWk2ZzdKdHgxWXZu?=
 =?utf-8?B?N1R4YzgyTXRzMHovaGlCMFVVbVZQUjh6Wi92azdKYkJxWmUwbCs4TFkvTCta?=
 =?utf-8?B?RnZYdGxCRXZNTjVpdDMvb2NPY2pMdDczN0ZiUWZDWi83blZ6RVFEUXdKTDBV?=
 =?utf-8?B?eDNHeStrUmdURVhIbUlGc2VuSjhQOUxlbjk0ZEI5NDNXcjFCbCtEZUhzUGNj?=
 =?utf-8?B?K3lyNDhCRGdPaVAzaWU1bFpWUTk0Myt0S0tsbTFvalZVYnh2Zjh0ei9WK2tv?=
 =?utf-8?B?TzN3c3JwUVNvejcwaWRSVGt4c0N6akJYaDBkY0xNckd3aTYwUXJuTnJraXho?=
 =?utf-8?B?cnRmclA1MmVnZDRnK2dkTjdlSzB1eDVDMzB1SXNmb0huekVLalRZQlFmelRD?=
 =?utf-8?B?blZTUE41WUhyQ1NtOG9Vd213ZjJSaDB5YVp1L2hnck5nUUpQWUJPQ09XVXlU?=
 =?utf-8?B?YzNwYnRGRmdKcmNUSXpSZ1RlZVQyUXdVbU9LUmNLSnZMRzI3TGFWUjdrcU9W?=
 =?utf-8?B?aHdKWXpJam5OMmpXeW5jMXlOKzJsT3dQeXlHTWlvSEJiMU1xRTVqcFE4OXVN?=
 =?utf-8?B?SmZRVnQwNVJNNE42a2ptWFZ1M0VvSlJRTVpXMFY0R3l5NjJkaGxrbDJvelFm?=
 =?utf-8?B?Z1ZXTzc1WS9iUWFNNlIyYWFmNjhjSzB6aURTWGM3WHBNWkkvTGJNQ2syU1Jl?=
 =?utf-8?B?b0Q2OFpKOGJMbmc3VHhPc1R0VEFTUEluUllHMDlWWTRqeDRmY2hBY1IzSWZu?=
 =?utf-8?B?NmdFVmc5QmpVeUhkcUVUWGcyWDZySmhoSXQ5Ri8xRkw4RGpjb0JGdVlXeVhZ?=
 =?utf-8?B?MlN3bHhTN3MvK05OSFM3VFova0xwczZwZk5xaXVCby82NWNEVittVGh2amxP?=
 =?utf-8?B?bi9qNi9iZFNUdWxPMWhSaWJvY1FENTVvK2U2aG1DYmo1SGc4Qy9QMkZHOGhm?=
 =?utf-8?B?clhVUzA2UkhkeGZtdURaMnMxSTlIY1pUNVpsMkdaYklzYXFMODZwamVzRFFO?=
 =?utf-8?B?RzRJSW9LRDQvMDRqRzMzcGNTZWkvS3U1TlNIZXYrVlFhUzVYcTlOYWJSZVdk?=
 =?utf-8?Q?CdZetGogQ97aRY5ZEpHzvQpSB?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: ba6e8781-a3ae-4e56-4870-08dceebb18a5
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 Oct 2024 14:50:52.1117
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: /+zxM+1bgkM4MbdquwhI+Tj1djiBjyTok1CbmP8mC/nA2wONia4NVb3jY9BWlBZOuIdUciqP739C+NZ3rbUfJg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR12MB5626
Status: O
Content-Length: 1819
Lines: 62

Hi Jonathan,

On 10/17/2024 8:31 AM, Jonathan Cameron wrote:
> On Wed, 16 Oct 2024 12:31:35 -0500
> Terry Bowman <Terry.Bowman@amd.com> wrote:
> 
>> On 10/16/24 11:30, Jonathan Cameron wrote:
>>> On Tue, 8 Oct 2024 17:16:48 -0500
>>> Terry Bowman <terry.bowman@amd.com> wrote:
>>>    
>>>> The CXL AER service will be updated to support CXL PCIe port error
>>>> handling in the future. These devices will use a system panic during
>>>> recovery handling.
>>>
>>> Recovery handling by panic? :) That's an interesting form of recovery..
>>>    
>>
>> Yes, Dan requested all UCE (fatal and non-fatal) are handled by panic in order
>> to limit the  blast radius of corruption in the  case of UCE.
> That's fair enough.  Maybe it should be called attempted recovery handling ;)
> 
> This is fine.
> Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> 
> Jonathan
> 

I'll add "attempted" recovery to the commit message.

Regards,
Terry

>>
>> The recovery logic in cxl_do_recovery() (not using the panic) is also tested as well.
>>
>> Regards,
>> Terry
>>
>>>>
>>>> Add PCI_ERS_RESULT_PANIC enumeration to pci_ers_result type.
>>>>
>>>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
>>>> ---
>>>>   include/linux/pci.h | 3 +++
>>>>   1 file changed, 3 insertions(+)
>>>>
>>>> diff --git a/include/linux/pci.h b/include/linux/pci.h
>>>> index 4cf89a4b4cbc..6f7e7371161d 100644
>>>> --- a/include/linux/pci.h
>>>> +++ b/include/linux/pci.h
>>>> @@ -857,6 +857,9 @@ enum pci_ers_result {
>>>>   
>>>>   	/* No AER capabilities registered for the driver */
>>>>   	PCI_ERS_RESULT_NO_AER_DRIVER = (__force pci_ers_result_t) 6,
>>>> +
>>>> +	/* Device state requires system panic */
>>>> +	PCI_ERS_RESULT_PANIC = (__force pci_ers_result_t) 7,
>>>>   };
>>>>   
>>>>   /* PCI bus error event callbacks */
>>>    
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-DM6-obe.outbound.protection.outlook.com (mail-dm6nam12on2060.outbound.protection.outlook.com [40.107.243.60])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 958571DED70;
	Thu, 17 Oct 2024 16:21:41 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.243.60
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729182106; cv=fail; b=ctfFb4c8I5JvyttNMibV4hamYmcK0jCDjQLBv4k+/bop4hNJVIliyXyyKm+pXkZ7z7CUTPC//PcesksE2SlODYAes+H+un+pLLuraLUZJKm6kCMlQaIJETNGqrMnUZ/9Ong0quceUXfEswL3Lg6vaijnEGUxeBXaNxtVzXCak8c=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729182106; c=relaxed/simple;
	bh=oERP7EMZUsJCisaSaoRb/lE0F/D1Yh3XqW0H9Sn7e/k=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=QdUsXt6Qm2EB9bVD1YFfHOeZzgV2hI2bH8pXYP70NvTcjoGRh6vUcFHqkJV4t9adBodUO3nEuSHWH7GNVyU9QHSTozh8xJAbJ0GyX/uSaiNQYeLpCiFZF2OLWccaCThxiJYZ13A2nXIhZwj4a/vADNnN2Qf7MrEr0bhhOhMz8ME=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=EOmfiBV7; arc=fail smtp.client-ip=40.107.243.60
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="EOmfiBV7"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=WuaaX1kxXnePwrNhDAkJhrxcLwndcVbRjyzRBLP3O1fhX3Zgor+iPpxZTxYT/tG+3RfrqvYA/E0rEqGpoaLqKSBkrzx6++PnaWVmvgieRicsO0rddtXGAwVh+XOhX/UwqyEroUf+7wejfIEjNNCsVth7S/IxcerunqKzPw+KDzf6T+9v2ALtJsxV6c/QSVvpkTzZe6Xb/ih+0v6gQPo8QLLEO42DPe3Dq6g3lyu5nih7yKPV5LjKGh1KIMjwGALEeUujxUYV8t72OO8S6xMH1U3IMADSKCtbo/qsksgj0Gl9/QGhlKPIDLNedAuSY0cYjCQmzP08zynvXCpxSLVGJg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=aNv2pqDUa8rf8kw3Zft7jyvIgfYBQW5dnZnUgpdpN94=;
 b=pFcr3tqxoPlWWAZQ4nHeOTHO5sJqoyPFZUmJvEWadmMn8B/edJ0oNhxyENkijSrFlgWz8Nv4ax18s+LqG3PXa6L1lJpqSoeqTDbtN3AVmKiac8T3VjAYm8JXgid8zcEenYPbFKLJpkOqtsEGlBHguuCJhMH9jZ6Hv0caoBLHNeudTac8nHpLTnK0WOkZ/UhFQ61jprfCTziTA9MR2/tHTpSFB/Pn3BXDoineDTVPRrTMC1iKNv7VYn4uXWMsarrywJsg0Ra2EOFMJ2JT3jJDPz6BmT8PXoxHVtaqLHqU7Wd9OHo4fUIxHTRAWg0JQPV64ilgJR3GAs2iwzGcCoz/oQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=aNv2pqDUa8rf8kw3Zft7jyvIgfYBQW5dnZnUgpdpN94=;
 b=EOmfiBV7hVrz8mKW5XT9flQiP8Ttb2H9TmEicIQ0PsxVqVDnRhh3o7vHHaxI+cSHIgg7ClvyOy88EORUI0ivHa+LODJdGSvbtw3+LynEGom+xFya/gQdqbrSJC+zCxuT4kQBObDiAAlWkrFcIfFLIFoJW+XgROUkbCb1jBcmK2k=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 DS0PR12MB8785.namprd12.prod.outlook.com (2603:10b6:8:14c::18) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.8069.20; Thu, 17 Oct 2024 16:21:39 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8069.018; Thu, 17 Oct 2024
 16:21:38 +0000
Message-ID: <c756f2e4-2fa8-413a-b6b8-2f3ca8ec27a5@amd.com>
Date: Thu, 17 Oct 2024 11:21:36 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable error
 recovery in AER service driver
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
 Terry Bowman <Terry.Bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-8-terry.bowman@amd.com>
 <20241016175426.0000411e@Huawei.com>
 <ac5f05ec-5017-4ac7-b238-b90585e7a5bc@amd.com>
 <20241017144315.0000074c@Huawei.com>
Content-Language: en-US
From: "Bowman, Terry" <kibowman@amd.com>
In-Reply-To: <20241017144315.0000074c@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN6PR01CA0014.prod.exchangelabs.com (2603:10b6:805:b6::27)
 To DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|DS0PR12MB8785:EE_
X-MS-Office365-Filtering-Correlation-Id: 8064d394-f4c9-4d7c-ff1f-08dceec7c711
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|7416014|376014|1800799024|366016;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?MWdkbW9NMENmNkdxaU1rRkNTOU1rcmdINlg0UTBPZjlRUW1xUnZHdDlUSk8y?=
 =?utf-8?B?MndCSE5CbE1lV2t0TUluVkFlVklyemdEY2ZoelBNUGNCek5zaGVGRFJrc3c4?=
 =?utf-8?B?WDNYK3I2MDUvK1Job1pXQk1YOGhreTltYTNxdkFCWW5JaEs4cE9UUjBpbjV4?=
 =?utf-8?B?VkxoSHV2bFZBeDI1OVN0TzFZZzBpVCtROFBWWFZtWEpxQ1h6MWkrT2xodG96?=
 =?utf-8?B?d1ljTlU0MCtSQlNXRkZtV1REZEIvTnJRMjFlNjlCWk1qY2k1RkwyY1RkbVBV?=
 =?utf-8?B?bk5ISnNmK2liT21vamNmOGZ5ZzFuTTB2T2cxR3lmWFN2VDA0RDMra3pOM3FL?=
 =?utf-8?B?TWlEeGxEUEdtVnhCSENUL0ZsbnhqOUwzRnY3ZXIrUE94aENvUEtXU2M0ZWJI?=
 =?utf-8?B?cE90ZWJmamVwcFltZG5GYU41MTNjeXRUUDRZSGRsQXZQTnhTM3FtckdBU1Yz?=
 =?utf-8?B?MzNHV2ZvODNnZUEvVVNHMnR6UFlhc1VxVUVEamtQeXdpWXRsSjBsNTk0dXdw?=
 =?utf-8?B?OUNtMnRyU2tQeDdTdmo2c2M2THZqS2tlZVVqRyszbkg1VUlPY05QYThzbUQ2?=
 =?utf-8?B?eXk3YmhUdktHMHhFcUdsL2VIMlZ5WDFBSmxjU2J3L0V2NStQK09lVXBYUEx1?=
 =?utf-8?B?L0RmVDhvQ0ZicXdaeVZpWVBwQ2xvUnpjdnZ2eUtLS3NBazFrVmRSUmxBSWJw?=
 =?utf-8?B?UnFHZnBPWXNqUTM2WEllN2RSdXQvMEh6dTF0dERvR29DMGNyWVlaQmZXeTMw?=
 =?utf-8?B?cWlyVk1oQkxqMk5XTlNjU1RsQlZFNEF4dWhlT08xbWYwaDZYYm9vTkpZYTFH?=
 =?utf-8?B?RTQ0cGE0ODBvYitoU0lCZ29MU2lPQWlEK0pPbDBRdnB6alQvWEF6dEl2NWZB?=
 =?utf-8?B?cTRUbjVTTGJ2S1h0M0FlN0NEamU0OE9YaEhBSGMvR3hnR1ZtWWlEbUM2Uysz?=
 =?utf-8?B?ZytSRFdxZkNFVkNxdW13bk80T0V0VVRFb1VxUHZwY2xnOWRycEpKRFdnMVN6?=
 =?utf-8?B?cTlHUTBNT25CUTVGOHFzd0tWZ2U4Yzg4SitXY1Ftc3l6ZmdUdy9nbXZRVy9L?=
 =?utf-8?B?cGg0ZkRnVlJGMHZpK1hnTUFhdUlMdFF3NHpYVTZuUWxwV0dvTzA0VHFzRVlJ?=
 =?utf-8?B?UmIzV0g5eG00ellOUVlUdVhFS3FlMFVkeGRTd0o1Q3VYTWVwaUdwRWdUcW11?=
 =?utf-8?B?WGtrdVovTWR4anh5c0wyZkt2ZDhCcmdmSGU3bGtEd05qaiswaEFLRWdWOWh2?=
 =?utf-8?B?K2czU082VHNiejREMXpnQndPcG9YSkdSWitRdGVHSmVlRElCeXRYRlY5cklS?=
 =?utf-8?B?c0pBRzhpcUJ6b3E4eU5BT0N2UHg2VWV2YUxtUW9RWGZ4Q2lBdzJvSHFtUXo2?=
 =?utf-8?B?SXBFL0VFWkloc1pXNDl1TVZuN28zSTh5a1dlb29VTFkwWGpPVTIwM0kwL2o5?=
 =?utf-8?B?RGgwR21oaXhHZklkS1k0L0U1SWlLVlQ2VzFpdEVtK2l1VnJkd05lcm4rbXpN?=
 =?utf-8?B?Mit3QUFDYXVxWnVuQmVoU3o5VUNiRkJWWHZZOUpWbko3cSsyaW5XV0xBMWVY?=
 =?utf-8?B?U2VXN0VWL1UwWFRsNGM0QURkS1FTaFFTV0hTZ2o3ekZLdk1rd2RDNVd6bi8r?=
 =?utf-8?B?blc1a0ZoNSt3RExBcnlqZ2lzQTRnVHJRaFNtQTcxeEFIZlBwazVwTVE3NW0r?=
 =?utf-8?B?Q0FFODJSY253dU1hNEtYcUZ5UHpXT2syTTkwWTAxSEU1UDBLYSsrLzdNSUEx?=
 =?utf-8?Q?oKP6qNTT68/975FNn3YZaBiwTWf7pG0C2bKo7dU?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(7416014)(376014)(1800799024)(366016);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?UnE3UHJxYzIwdGtGeFcwaWFiWDNHcXpab1pwZEFGT2hIaUdrTGdLZXB3cTdV?=
 =?utf-8?B?dEI4eGJ1dlp0ekdlNDlZd1p5a3ZEVjVMbDd1NE0vcVFqaG1SOVZEZEFLR1F3?=
 =?utf-8?B?UGZnRzV3dnZyMFc4Zk1MZktDdXZCOVkxQjY0b0RrL1FXSzdXMWVxUzh4OStj?=
 =?utf-8?B?NHkvcWtUNlVVSlZWMUZOdlF5Y3dzOGtGeEhjbTRMOER0bk12aUFJRnp2a1N0?=
 =?utf-8?B?MlZzZHZzMVJOOGMyVnV2SjViNzJlQ2d0OFk1M3o1SGtCS1haWFRYTWYwZFR5?=
 =?utf-8?B?RnQ4eWR6M0QveXZTVVJzSG1ldEVnRzZkTW8yZ1JoVlBacjdKSUNiNGpOTDZW?=
 =?utf-8?B?M3pzMGt6Tkt6aWtWK0ZPSlY2R1VvdHV5VTNna2lWNjZDNythNVVQdzBONkN0?=
 =?utf-8?B?ek9kOHlESEZGekpvUzdzc2grRnE2cTE4dkYrV21qU21MT0JBeVRmLzFuaE9y?=
 =?utf-8?B?UU9RRU5vMjNmQlpHd0d0Tlp2ZlU5MmYxVzdHNUVDMFVTRjRHVTEvMGZkSy9I?=
 =?utf-8?B?WFhyTjFtT3czOStqRjVQeHFBTkhiNC9qVExRZlNrSng2Mm9TQkpDOHlVOWdP?=
 =?utf-8?B?bDRNUFNvdjczbVpHTUtJT1QreHdwTXVKWU5pMFczclVNVEhlc3FKRFducWVY?=
 =?utf-8?B?Q0dvaFg1blA0T3ZLOWRNYlJMSTFhRTJjdTA4aEVwdWdVNE53cW4xU2IyRUdj?=
 =?utf-8?B?ZDhNMDc5bFJueEVWc2haa2Y0RWRDdDd6d2krc3pTRzlCWjlHbUR2ak4yWWtO?=
 =?utf-8?B?YVBoaW1idXN0aEphdGdtSGxlbnZONWZ3MnpZR1FGNkRWRG1UeTJoL2ZSY2dE?=
 =?utf-8?B?TFBOanhFZDVrenFDSjkwQ0JJNm0vaXFnR0pJSFVCbjAyNURteHNsQ3JTVHBK?=
 =?utf-8?B?US9ibWxmQnVCMVBTNGpFYmRWb3J2WTVwdDBMMTN3dlVwS0JVTFU4K1VaZXRy?=
 =?utf-8?B?WXRVeUlPNkR2bXhKMjNRUmZFQ3hIdm9qTko0Ym5IN1BNUVhYa3RGaHBOaVFS?=
 =?utf-8?B?UXNyTmtlY2VtV2hlSDNyREpiUFZtQnVrV1V4eUU4VkRlUkQzMWJYR1U3Ny9i?=
 =?utf-8?B?Q1I5ZlF1SGpEZmtIV2FwT1MxUStweEY2Z2svNzlrSEVyNWwyWS9YUE15SFFh?=
 =?utf-8?B?Y0E4dHdoaWoyQVNGVVRBN09YSEJQbHBna1BjT3RVekJQdVdpdDkvcjJtblJX?=
 =?utf-8?B?am5XZWxQbllRQWtNVHVHcUQzZml3bVZWbkRJUG55NGY2MThwMjVsNnh0NGRL?=
 =?utf-8?B?UE9pZ01PWUhkNjlCWTFkblpVckF3NDdQS2ZIQUlVaFZGa1RHQ3NYTVlPMlMv?=
 =?utf-8?B?Wld6WWt6REZHeU0yV3BFeG9UN1Evay92aFJDQjRBaDB1UWxhc2RDMDRNcXor?=
 =?utf-8?B?YXRZdGprQUg3b3Y1Zm5kb2ZEUjR6c0hpSTQvYzRXMGxSSEtKWjdwcFArYzFG?=
 =?utf-8?B?MkNvL1cxKzJsSkpDeHF2Z0M5S2NqWUowSTkxK2VDMGhVL2tFQTRqOHhZakNZ?=
 =?utf-8?B?cU9Xcm5xTDdNNWpsNGI4M2l2U2MyRU1jWTdYaFZkSExxelBFQ1NQV3lNY05v?=
 =?utf-8?B?UGxZZjRBVlBqb2ZPKzQ1bWJ4cGErYWJsVndNNzlEL2NPRFpUWXoxMU9lR1lM?=
 =?utf-8?B?TFBXOEE2bVRDZXZydXZVY2lTYmdjSjFmMDF0UWtHcnkzalZHVVNVSUZCa3ZP?=
 =?utf-8?B?M0lTamlnNnNtTHVuc3luSi9CbG95SUxCemppZ2J3TWRQdGJGVytFaGVOSWtH?=
 =?utf-8?B?YWhvRGIvaHd6Zk5mSVlhUVNrUGFENFVqcXQ0WVRkMHFjTlRzWkZTV0dVWFpI?=
 =?utf-8?B?SVZhTDNzM3pEeVFWbm5KSSt5S1lCMGdVajg1TWlrWWE5N00vV0R6VmQ5cktS?=
 =?utf-8?B?bkFOZXN6dTFCdEt5emFvUHZFRm5CbzVVaGhSWGVuanB4ZW9GM005OWdTYkVw?=
 =?utf-8?B?bDE5bldCS2lMbHVERUE5cXY3UmF3S21mU3lYMlpnZ2xzTWNoMDJsa1AvSkJ4?=
 =?utf-8?B?V0d4ZXdRTTZKdjByS09sZTRQMGFWcEk0dDJYM1dXRk1iejVEekQybTNtRC9z?=
 =?utf-8?B?N09SbEczZFZUbzhVRWQwbnBMOUYzOWFHZjNpYzhhRU5UOGtWNnIxQUo5RzZQ?=
 =?utf-8?Q?fz6W5oTWTV/pnFBaEQPnKWQMg?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8064d394-f4c9-4d7c-ff1f-08dceec7c711
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 Oct 2024 16:21:38.7829
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: Sk6CT7eQmvfR64+AfZBYAMevf96Y6GqjhHxKYrInuxxntRLzTCOLcyiPMQwnp1RR+37quup2lUDpN4v27QA5rg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR12MB8785
Status: O
Content-Length: 9612
Lines: 249

Hi Jonathan,

On 10/17/2024 8:43 AM, Jonathan Cameron wrote:
> On Wed, 16 Oct 2024 13:07:37 -0500
> Terry Bowman <Terry.Bowman@amd.com> wrote:
> 
>> Hi Jonathan,
>>
>> On 10/16/24 11:54, Jonathan Cameron wrote:
>>> On Tue, 8 Oct 2024 17:16:49 -0500
>>> Terry Bowman <terry.bowman@amd.com> wrote:
>>>    
>>>> The current pcie_do_recovery() handles device recovery as result of
>>>> uncorrectable errors (UCE). But, CXL port devices require unique
>>>> recovery handling.
>>>>
>>>> Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
>>>> specific handling to the new recovery function.
>>>>
>>>> The CXL port UCE recovery must invoke the AER service driver's CXL port
>>>> UCE callback. This is different than the standard pcie_do_recovery()
>>>> recovery that calls the pci_driver::err_handler UCE handler instead.
>>>>
>>>> Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
>>>> "recover" the error. A panic is called instead of attempting recovery
>>>> to avoid potential system corruption.
>>>>
>>>> The uncorrectable support added here will be used to complete CXL PCIe
>>>> port error handling in the future.
>>>>
>>>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
>>>
>>> Hi Terry,
>>>
>>> I'm a little bothered by the subtle difference in the bus walks
>>> in here vs the existing cases. If we need them, comments needed
>>> to explain why.
>>>    
>>
>> Yes, I will add more details in the commit message about "why".
>> I added explanation following your below comment.
>>
>>> If we are going to have separate handling, see if you can share
>>> a lot more of the code by factoring out common functions for
>>> the pci and cxl handling with callbacks to handle the differences.
>>>    
>>
>> Dan requested separate paths for the PCIe and CXL recovery. The intent,
>> as I understand, is to isolate the handling of PCIe and CXL protocol
>> errors. This is to create 2 different classes of protocol errors.
> Function call chain wise I'm reasonably convinced that might be a good
> idea.  But not code wise if it means we end up with more hard to review
> code.
> 
>>
>>> I've managed to get my head around this code a few times in the past
>>> (I think!) and really don't fancy having two subtle variants to
>>> consider next time we get a bug :( The RC_EC additions hurt my head.
>>>
>>> Jonathan
>>
>> Right, the UCE recovery logic is not straightforward. The code can  be
>> refactored to take advantage of reuse. I'm interested in your thoughts
>> after I have provided some responses here.
>>
>>>    
>>>>   static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
>>>> diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
>>>> index 31090770fffc..de12f2eb19ef 100644
>>>> --- a/drivers/pci/pcie/err.c
>>>> +++ b/drivers/pci/pcie/err.c
>>>> @@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
>>>>   	return 0;
>>>>   }
>>>>   
>>>> +static int cxl_report_error_detected(struct pci_dev *dev,
>>>> +				     pci_channel_state_t state,
>>>> +				     enum pci_ers_result *result)
>>>> +{
>>>> +	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
>>>> +	struct pci_driver *pdrv;
>>>> +	pci_ers_result_t vote;
>>>> +
>>>> +	device_lock(&dev->dev);
>>>> +	cxl_port_hndlrs = find_cxl_port_hndlrs();
>>>
>>> Can we refactor to have a common function under this and report_error_detected()?
>>>    
>>
>> Sure, this can be refactored.
>>
>> The difference between cxl_report_error_detected() and report_error_detected() is the
>> handlers that are called.
>>
>> cxl_report_error_detected() calls the CXL driver's registered port error handler.
>>
>> report_error_recovery() calls the pcie_dev::err_handlers.
>>
>> Let me know if I should refactor for common code here?
> 
> It certainly makes sense to do that somewhere in here.  Just have light
> wrappers that provide callbacks so the bulk of the code is shared.
> 

Ok, Ill start on that. I have a v2 ready to-go without the reuse changes.
You want me to wait on sending v2 till it has reuse refactoring?

>>
>>
>>>> +	pdrv = dev->driver;
>>>> +	if (pci_dev_is_disconnected(dev)) {
>>>> +		vote = PCI_ERS_RESULT_DISCONNECT;
>>>> +	} else if (!pci_dev_set_io_state(dev, state)) {
>>>> +		pci_info(dev, "can't recover (state transition %u -> %u invalid)\n",
>>>> +			dev->error_state, state);
>>>> +		vote = PCI_ERS_RESULT_NONE;
>>>> +	} else if (!cxl_port_hndlrs || !cxl_port_hndlrs->error_detected) {
>>>> +		if (dev->hdr_type != PCI_HEADER_TYPE_BRIDGE) {
>>>> +			vote = PCI_ERS_RESULT_NO_AER_DRIVER;
>>>> +			pci_info(dev, "can't recover (no error_detected callback)\n");
>>>> +		} else {
>>>> +			vote = PCI_ERS_RESULT_NONE;
>>>> +		}
>>>> +	} else {
>>>> +		vote = cxl_port_hndlrs->error_detected(dev, state);
>>>> +	}
>>>> +	pci_uevent_ers(dev, vote);
>>>> +	*result = merge_result(*result, vote);
>>>> +	device_unlock(&dev->dev);
>>>> +	return 0;
>>>> +}
>>>    
>>>>   static int pci_pm_runtime_get_sync(struct pci_dev *pdev, void *data)
>>>>   {
>>>>   	pm_runtime_get_sync(&pdev->dev);
>>>> @@ -188,6 +245,28 @@ static void pci_walk_bridge(struct pci_dev *bridge,
>>>>   		cb(bridge, userdata);
>>>>   }
>>>>   
>>>> +/**
>>>> + * cxl_walk_bridge - walk bridges potentially AER affected
>>>> + * @bridge:	bridge which may be a Port, an RCEC, or an RCiEP
>>>> + * @cb:		callback to be called for each device found
>>>> + * @userdata:	arbitrary pointer to be passed to callback
>>>> + *
>>>> + * If the device provided is a bridge, walk the subordinate bus, including
>>>> + * the device itself and any bridged devices on buses under this bus.  Call
>>>> + * the provided callback on each device found.
>>>> + *
>>>> + * If the device provided has no subordinate bus, e.g., an RCEC or RCiEP,
>>>> + * call the callback on the device itself.
>>> only call the callback on the device itself.
>>>
>>> (as you call it as stated above either way).
>>>    
>>
>> Thanks. I will update the function header to include "only".
>>
>>>> + */
>>>> +static void cxl_walk_bridge(struct pci_dev *bridge,
>>>> +			    int (*cb)(struct pci_dev *, void *),
>>>> +			    void *userdata)
>>>> +{
>>>> +	cb(bridge, userdata);
>>>> +	if (bridge->subordinate)
>>>> +		pci_walk_bus(bridge->subordinate, cb, userdata);
>>> The difference between this and pci_walk_bridge() is subtle and
>>> I'd like to avoid having both if we can.
>>>    
>>
>> The cxl_walk_bridge() was added because pci_walk_bridge() does not report
>> CXL errors as needed. If the erroring device is a bridge then pci_walk_bridge()
>> does not call report_error_detected() for the root port itself. If the bridge
>> is a CXL root port then the CXL port error handler is not called. This has 2
>> problems: 1. Error logging is not provided, 2. A result vote is not provided
>> by the root port's CXL port handler.
> 
> So what happens for PCIe errors on the root port?  How are they reported?
> What I'm failing to understand is why these should be different.
> Maybe there is something missing on the PCIe side though!
> That code plays a game with what bridge and I thought that was there to handle
> this case.
> 

PCIe errors (not CXL errors) on a root port will be processed as they are today.

An AER error is treated as a CXL error if *all* of the following are met:
- The AER error is not an internal error
    - Check is in AER's is_internal_error(info) function.
- The device is not a CXL device
    - Check is in AER's handles_cxl_errors() function.

Root port device PCIe error processing will not call the the pci_dev::err_handlers::error_detected().
because of the walk_bridge() implementation. The result vote to direct handling
is determined by downstream devices. This has probably been Ok until now because ports have been
fairly vanilla and standard until CXL.


>>
>>>> +}
>>>> +
>>>>   pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>>>>   		pci_channel_state_t state,
>>>>   		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
>>>> @@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
>>>>   
>>>>   	return status;
>>>>   }
>>>> +
>>>> +pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
>>>> +				 pci_channel_state_t state,
>>>> +				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
>>>> +{
>>>> +	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
>>>> +	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
>>>> +	int type = pci_pcie_type(bridge);
>>>> +
>>>> +	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
>>>> +	    (type != PCI_EXP_TYPE_RC_EC) &&
>>>> +	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
>>>> +	    (type != PCI_EXP_TYPE_UPSTREAM)) {
>>>> +		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
>>>> +		return status;
>>>> +	}
>>>> +
>>>
>>> Would similar trick to in pcie_do_recovery work here for the upstream
>>> and downstream ports use pci_upstream_bridge() and for the others pass the dev into
>>> pci_walk_bridge()?
>>>    
>>
>> Yes, that would be a good starting point to begin reuse refactoring.
>> I'm interested in getting yours and others feedback on the separation of the
>> PCI and CXL protocol errors and how much separation is or not needed.
> 
> Separation may make sense (I'm still thinking about it) for separate passes
> through the topology and separate callbacks / handling when an error is seen.
> What I don't want to see is two horribly complex separate walking codes if
> we can possibly avoid it.  Long term to me that just means two sets of bugs
> and problem corners instead of one.
> 
> Jonathan
> 

I understand. I will look to make changes here for reuse.

Regards,
Terry


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2069.outbound.protection.outlook.com [40.107.93.69])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6FC711DED75;
	Thu, 17 Oct 2024 16:26:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.93.69
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729182415; cv=fail; b=gnLFFMK9Lk9BwZR1l/hC46FdEn/R0QD6nJpBUfwMtsl1mA6/H6BLhZXAmVRlYvrDIvT2CURr1Z/VYmMNu60+cINPVNLNOv6ST8czHELV0O3Eyc+ER2mSdBX5mSt/wyeQ3WAVSdb2a2tdkOG0LID/qOI6x/Sn3swnGr4iaJVbfGg=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729182415; c=relaxed/simple;
	bh=18SD88F0MWc4jNlx2ZqbqniM4oWY2CXdt8tKXU7aEDk=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=RthawvwYbbJwvBvswkUx1QXqn4YOm3UK3nedeF9Ps/wLs7Sz5iM9NRU9F5Jiv8Sjwa/+vtPFXRGSbBZIknRhI3o0+QAgy53wC7DWZqrpq1Dh2TrCFmpxUnfdyENKFGozJ5vc6tXYAzvt1FqfvYPmS8psm+4m46Adq0qOGLG445k=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=xb/EWgt1; arc=fail smtp.client-ip=40.107.93.69
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="xb/EWgt1"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=IIuUEenyUl5a/crHRw5CrN1nNR79MyTYVFkTo3IcwuYwrnDYwMymXtP+NP4C/lYdGnVoSd3tnzLAwWrew8X3y8fINKjTk5M3sDHlYjGFShwaWJK9/UWLN2YVV0P9T3XFBTpOwckunrqWpQK/BDwaNSjwlbO5u0TCl4MGI8OmqzRKu6Dxp+RnVYYSv3wUaHNHWCREk8hws2UB0NhWJpTYbIX0hZDfQliWs2rO1iK1L9p1ckntV7xyRW9TMjuf4fQ0UlCUh7nY+nBXfkDl8GsGY9FLlRWSnmgPEC7sx4ysS9rbaIAVisK3gT2qCt7tXnHczp7bdLQ8yS7Ll8TnlsvWWA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=n4KUU2khQNdFl+E2fwoGkot3U4xPB2cfdacT6YvIggA=;
 b=pTxHVsR4THRvQqwPJ1opEEn0i6zpw1OU1aNRLgL5y7jAL+7Kp/fPJaFoe8jtrrnaGAng1usZyfZsm+gj8VBqqrRcKAXdaQ3F+UbJMYLEKSWoFz5ff4yJ+lXIfVjdXIz69O+M1mye6qQVn87LMyEkhiZhn25ItUlfo50LqLrp+Iyduix1vJpB4xlqKQ7gjxbtlDVjSGZ9VMdx1jGQQailefSskuy/PPD3oH9oAt8H+a467J8S6xGNz6MZGYAeEQY4EWpvF6gLD+hNVuiOZAiduBx8LOQhoSvzOlUBuKhFZsd2e/hbX3CnzSQIfnxWvapX2/a3kSZRoe8is5tnbdnMHQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=n4KUU2khQNdFl+E2fwoGkot3U4xPB2cfdacT6YvIggA=;
 b=xb/EWgt1gwZmZLYW37xjuB0k7PewlGyxuLNDgjBleyFmSOogr85ibnrodLfWDlFhUaABJLft+8UgyLWPw0qHvvTNaP03d+xuLNjKjAZoWEU3eQ5HjA/HYyh8kel/KY5Nzbfa16N0aevj/RBix8rirVUmn9kmwpr6qFRZ3Gnz9KU=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 DM4PR12MB5796.namprd12.prod.outlook.com (2603:10b6:8:63::16) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.8048.27; Thu, 17 Oct 2024 16:26:47 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8069.018; Thu, 17 Oct 2024
 16:26:47 +0000
Message-ID: <20ccf961-606d-4247-a4bf-b53d5ea4a05a@amd.com>
Date: Thu, 17 Oct 2024 11:26:45 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 09/15] cxl/pci: Map CXL PCIe downstream port RAS registers
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
 Terry Bowman <Terry.Bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-10-terry.bowman@amd.com>
 <20241016181459.00000b71@Huawei.com>
 <4a298643-28f0-4aac-be2d-32b8ff835e2a@amd.com>
 <20241017145025.00002fd3@Huawei.com>
Content-Language: en-US
From: "Bowman, Terry" <kibowman@amd.com>
In-Reply-To: <20241017145025.00002fd3@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR12CA0014.namprd12.prod.outlook.com
 (2603:10b6:806:6f::19) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|DM4PR12MB5796:EE_
X-MS-Office365-Filtering-Correlation-Id: 797558ee-beed-4689-ce35-08dceec87f23
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|366016|1800799024|7416014|376014;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?ZDM3TGJVazRVU01HcWNqbGRNbHBBd3FreTdNa1Jtak90YklUcnN4b3pEaVRv?=
 =?utf-8?B?ZFpiSGk4VDZkUlZvNDhQbE5oUzRveFFjL21wem50SU9Mc1RjYjZHT01KSzQ5?=
 =?utf-8?B?ekZjSDZ5S1pzUG1udVRXanp4SXNnWTVnK3ZvWCtoSmtCUjdKQXIxQ3dVdGw0?=
 =?utf-8?B?M0Z1aHBCdCtualV4SnV6S3FzS1JPVDNBMWJycDZCSGJIeFZ6LzJkY1UzSmMw?=
 =?utf-8?B?cnNZZmNzdEJYelErS1JWbW1ld3c0RUhPTkYxTGNuVGFscXRWV3JCd25DRktk?=
 =?utf-8?B?L2xqM3oyckFrRjFGa0xmYWI2ZjNHNEpaeCtib3BhMHVQSUlRZ2ttdXBjUXZP?=
 =?utf-8?B?MS9tMFBmemZ3R2V6dGRvclczTE1hOWNrRDV1NUU5SDIzdHgvMkdTR003dENt?=
 =?utf-8?B?Vm1qTHlnSUdrL01qakJTZEhyaHM2SW5xdTlXU2JPUG5lVmNnZnZzLzE4TTJG?=
 =?utf-8?B?NVF0djdNRzZacDc1b1dlV3Q0TldtU0RaNk1FRDJ1SDZSQlNFTm1XY3ZoTFBr?=
 =?utf-8?B?enZ6V2FLNzBaZXp0RUdWd1lqOFduRnJUOWI2SWhLbUhJODFkN28vNFZ1VzJj?=
 =?utf-8?B?cGFZcDRXK0NLd0VZQVZlbk1SSVkxSEdUZTE3NzMyRHBCUk0wOHN4d0JRbG9P?=
 =?utf-8?B?bjFEUkg5ZTJlQlNiV0d4REs3S1F3UlV6NHIwR3ZKQWhRY0xBRWd2OW00MlRh?=
 =?utf-8?B?d3o3NTdkTERHSDc1T0pmRGNwamdhanJrUFRuVUR6a1ZNYTlGNUtoZUxrZk1Q?=
 =?utf-8?B?Q05WaGFTNmpEcCszeVk1RkdFazBIRG5EVHBvNEJVOTZvalJHc3lpTktFVWpk?=
 =?utf-8?B?dDY1QW14TmtuWklPMko1SFZ1VHNQUVovcFljbi9XZDJjS1lleGZVckx0VGtq?=
 =?utf-8?B?UUZFQklwSXgrcW5zZ3Bjd2N3VUNKb0V0NzVvczR1N1hnY1NydGNZcUJzZnNO?=
 =?utf-8?B?WkRCbFh4dC9sN0UzUlM5OEZ4TTVpOUpHMVlnQ1pyR2tJUDh5WWFiNEZ2N0wz?=
 =?utf-8?B?Q1V5K0RNb25WMTd6WWZvbFRpTEZMaEFWL3RZOTRzT1M3c0RtcmFhOXM3RTNZ?=
 =?utf-8?B?N0xsV3JZNTQwQWN6T3dFV2lBamc1eGVJVnNOMVo2Z0gzMDZ2N2pvc05LeitN?=
 =?utf-8?B?K0xSL294TmtBc0FiM3pqQWVrd2FNdEo5QURwTUZrUVFsV1JhRXRZQVJrVWs2?=
 =?utf-8?B?d0xWcUVXWktIU0xkZ1dtMnVjNExBN2VsZ3UwTHNwaVFXYng2MFl3VDdDVXpX?=
 =?utf-8?B?MGU2MlBnbXRJVXAzV2lVcTJLT2JCZ0RCdzRGZEk2dXl0VjJwWklsclB5RVlL?=
 =?utf-8?B?VWdhdU1DUjdWbXZTR1pUY1NtZlRTS0xPVVQrZEJkbGNzVWliWlJ3WXBNT2d3?=
 =?utf-8?B?S2Y0L2tQRlo1U1FRRDNTVTBzMWMvMlcwU0pKd0dSY09ISFBGSGZUVGF2THZj?=
 =?utf-8?B?d3pXUC9kTXdVRTBWVms4Vm9iYmtDREZ4VEZBUnlPNWxVUkhnNzdHUyswV1NO?=
 =?utf-8?B?cUt2U01VcHdmaFRVOCtyd1FvclBUVTNOODNRc1J2SWVlQ1ZwM1VGVFhTSEwr?=
 =?utf-8?B?Q1hpQytmd2M0VVVVUUVDMkVZOW12aUVNWHNsVmhKeGhPdWFDN1UxeFVOUWIx?=
 =?utf-8?B?STVtMjg5Z2kzNkJ0M0dVRXM5K3ZmbVpGTUFLeFk5cUM5QitPVzQxNWxqemhz?=
 =?utf-8?B?VTZ6ZUFnbUVhYzlDdFQvUnBoQzVRWURnU3RRUTBpQWg1RnBQRWlsbGMvRWRG?=
 =?utf-8?Q?RYjEad4tvHU1jWstYxmMFxV91/qNRV/6hPquL1D?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(366016)(1800799024)(7416014)(376014);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?NHVGd3RQQk5DS3JGckt4bWZrSmxuS3l1Wi9EaWhKQk93dWRkZkdFb0UvVzZw?=
 =?utf-8?B?UHFQcm9GNW52QkVVakp2TURyTUVWdk1pV1hwZnp0dW1XWEpDalNJOFpOSXh2?=
 =?utf-8?B?cjh6MDNaZXRCKzBxUHFsK2VtR013bUdrLzYxczdRSmNUdU1CMU1iLzQ3NFMw?=
 =?utf-8?B?aFI0R2JtYWt3eVJXVDRlV2RwMU83VGIyMzcyWEg4QkRuNUlGSWpTZEphUjRU?=
 =?utf-8?B?ZWtsYzhoeUJjR3FmWDZLeXQ1VUV4Y29GVFVvYnh2M0ptZHBvaWlWLzNBMUJ1?=
 =?utf-8?B?bWlWUWFEcTE3azF4ZDJCTEo3NUJ1OXJMajMwTGxSekt0dkpzemJGbWJadFhQ?=
 =?utf-8?B?SVNwVlB1SHhCdzFITzNLa3JYVlZVcGZLL3hoVVkxcUNUaTVSQVNWQU1kOHlz?=
 =?utf-8?B?N1BvMEt3cGFOUXVvMkIvclVKVGI4cnZkWXhyWmNXZkd3RFBrWFYydWN6REcw?=
 =?utf-8?B?a05CcytOL2NqS1JoS242REhDblN5RVI1OTVUUnVMcXJNSFJvN2Y3enJ2QURl?=
 =?utf-8?B?cENFMGwxdDJWTmlsUXozTnZQUDYwYmdMVkxjV1dvR2hxYWdYODkvb0ppeHJi?=
 =?utf-8?B?c3NPR2dWWDljd3RhalNXMFphMTNWdGpJcjVZQVlPQzBkeUUwRk1QNzcvUEl4?=
 =?utf-8?B?aHFXdDJOWVFLZFJ0R2EvcG9Fek5kaEp4M0JNcW9Na25CQnNPRjVacXBNaFVR?=
 =?utf-8?B?VkpqSGhPWDRnaG1XM2RrNGtPaFFCaTU4Z3I3c3UwcjF0b3BKZ0V1WmhpVmd4?=
 =?utf-8?B?MnRYQjR6b1QzalhZOGxiV2grS1lUUVNTZ3VCSW9UeWxGV2ZKSzFPbXliaFVL?=
 =?utf-8?B?QXdXdUpMOEFZZFNjeFVPUFlUQXg0dThJOWlQbFl5c2g1TWhnaFVSUW5iRlFW?=
 =?utf-8?B?cUdmcktjRGI4NHR6MFZqUU9adVprdGpLN21aS1NyRmZ6bnFtMWJRMCtGWEk4?=
 =?utf-8?B?UHVoYldGdGNHWXZ2VTRPdlpGQ3c0eEQyM0c0MHdRQ1M2ZkptMVJWSmxYclA0?=
 =?utf-8?B?SUNmSVZaTE0yeTUxcndYMGNVS2Ewa01vR3JMdHVyUG9MOXQ3MWRrUjhkQ1RI?=
 =?utf-8?B?cnNqOGhXaWNDMkZ4ZzNNdFdhNXZPYmN6eS83cVU3bVczcEVMYURFYmZmUFZN?=
 =?utf-8?B?K0xLZ1Fhbm1DNk9zNy9aUVlyZGEvK0R0OEo5dmNSQldUVlV3L1haeDdDdkNE?=
 =?utf-8?B?eVUzN3VNZUZVQktZWiswa25Tclo1cThuV3IxeE9qMGZvZTE1SENPQ1hFeldj?=
 =?utf-8?B?TVYvaW5vUEJFajRPYWppcGU3NmFKZDVMM2VKZVV2ci93cW45SHUxSFFXaEZa?=
 =?utf-8?B?dUovdU9qNWVNN1BsTjZkTE8yN3FpUkpCS0RpaExGR3J2SVJ4cUlGVEc4bnNS?=
 =?utf-8?B?S2VBZnZId2I2QnYvZXA2L2tFQ28xUkxwei9aVUhYMVVlSGF2bHBQNG9VcGls?=
 =?utf-8?B?RVJNSzdtS0pQcWNZLzlmL3BvYmNDT2xLMHRrM0lvNkJiWkIwK3lJMklPdW5M?=
 =?utf-8?B?bytVbk8xNGwySWhVTGlPcFYzY0lxNXpEeXRyU1hjeldlaFlVK0lRc2dHWDds?=
 =?utf-8?B?aGxHM1luTTRXM1JXS0ZPblViSmFydkQxRXNIelFZM1UrRmNCVXlWTjR6RnRu?=
 =?utf-8?B?UGN3MUJlME92Q3FiZGltZkp1YVBSU2owekZ0L0FSV1dQcFZlYW14bzVZWUN4?=
 =?utf-8?B?NCtmQUh1dEc4WUFCWnYvRDU1dWdWamtVcDJtN3hDUlNQV25URDR4ajgxZmg4?=
 =?utf-8?B?ZWpWWFFDTjUrNGw4OGpCcDgrQmxtNE1MT01wMlMza0VEcGY1c0E4MTNlbG1J?=
 =?utf-8?B?ZVVHUHpOSmFvZEhTZkRYQW1SbUhhZnE0R3h4RWQ0d0YrdVQ3NEUzdS9WWnZu?=
 =?utf-8?B?djY3UVlnNlZiTHJVSnUvN0pEcXE2Sml3bmFlRkgwWmcrVFAzbWQ4bUh0N1Z5?=
 =?utf-8?B?d0FNeU8xa1hqZDg1QTh5S3d0L1FVNG1oZ3hsc1IrYWhuMW56YzNqVG9tcVQx?=
 =?utf-8?B?Uk5yUGM3dnpiV0ZNdG5ZemZRVlJDZHFFeFB5TGVvQ2xNL1dpazFCSllmdVdy?=
 =?utf-8?B?b0tMQktHT1hrQXp0VHB3Zy9HZnNwdTVJUktMdEgzTE1WSWxyR2pONTRqYXhl?=
 =?utf-8?Q?VJ7z9Oo+je+zi8Nn+9vg5DSHa?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 797558ee-beed-4689-ce35-08dceec87f23
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 Oct 2024 16:26:47.5524
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: iQ9DmZG8WCC2Fex2px8CZR6YsTlTEJ9/abZ8dtPm7vby/+hwDGqtbY0jFEd9TRIzp4+4yqz0809gcHdc8KD6Xg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR12MB5796
Status: O
Content-Length: 2544
Lines: 68

Hi Jonathan,

On 10/17/2024 8:50 AM, Jonathan Cameron wrote:
> On Wed, 16 Oct 2024 13:16:34 -0500
> Terry Bowman <Terry.Bowman@amd.com> wrote:
> 
>> Hi Jonathan,
>>
>> On 10/16/24 12:14, Jonathan Cameron wrote:
>>> On Tue, 8 Oct 2024 17:16:51 -0500
>>> Terry Bowman <terry.bowman@amd.com> wrote:
>>>    
>>>> RAS registers are not mapped for CXL root ports, CXL downstream switch
>>>> ports, or CXL upstream switch ports. To prepare for future RAS logging
>>>> and handling, the driver needs updating to map PCIe port RAS registers.
>>>
>>> Give the upstream port is in next patch, I'd just mention that you
>>> are adding mapping of RP and DSP here (This confused me before I noticed
>>> the next patch).
>>
>> Ok. Good point,
>>
>>>>
>>>> Refactor and rename cxl_setup_parent_dport() to be cxl_init_ep_ports_aer().
>>>> Update the function such that it will iterate an endpoint's dports to map
>>>> the RAS registers.
>>>>
>>>> Rename cxl_dport_map_regs() to be cxl_dport_init_aer(). The new
>>>> function name is a more accurate description of the function's work.
>>>>
>>>> This update should also include checking for previously mapped registers
>>>> within the topology, particularly with CXL switches. Endpoints under a
>>>> CXL switch may share a common downstream and upstream port, ensure that
>>>> the registers are only mapped once.
>>>
>>> I don't understand why we need to do this for the ras registers but
>>> it doesn't apply for HDM decoders for instance?  Why can't
>>> we map these registers in cxl_port_probe()?
>>>    
>>
>> We have seen downstream root ports with DVSECs that are not fully populated
>> immediately after booting. The plan here was to push out the RAS register
>> block mapping until as late as possible, in the memdev driver.
> 
> That needs debugging because simply pushing it later like this is
> only going to make the race harder to hit unless we understand the
> 'why' of that.   If there is a reason to delay, my gut feeling would
> be to delay the cxl_port_probe() until things are stable rather
> than just trying this a bit later.
> 
> This might be the whole link must train before CXL registers are
> presented thing (a less than ideal corner of the CXL spec) but not
> sure it would mean they weren't available in cxl_port_probe()
> 
> Jonathan
> 
> 
> 

My understanding is there is no spec defined expectation for when CXL
config registers are ready.

We need Dan's feedback. He has asked several times for this to be located after
adding the endpoint in the memdev driver.

Regards,
Terry


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f180.google.com (mail-pl1-f180.google.com [209.85.214.180])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BAFF31DEFDA;
	Thu, 17 Oct 2024 16:34:45 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.180
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729182890; cv=none; b=UVrIS2Cfu9ys64n7e9Anj2xkAD70T5yrEgMyZ9tLlo0SHblsZIWo/QZASUwRZiT0uK/ggN9R/N0vrJX1N5hGevfG4fInvlsgHUj3r5JNS1IRIBNTo4JbZH1TDqzec0fdxacOf0cyxC0Ft7lyBRA6kmOz8i8GdMiTvjbvLzmBYaI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729182890; c=relaxed/simple;
	bh=AVebd7qah8QoBqQQs2NW2//l+cRwyNlFUWnp8SiLRb4=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=K8Fb6Wrs1pp9vie021iDBt7PUesB6cIBZL0YqEDoZvAHvXQqlkAsYFH1OxqLyoGe33fiGLr0AqYQig24kvoxL7ZhlbMOGu5ekYc3sg4KPXvAiCpe1XiyPcyoAQM6gZkDFvjKJzT7g1nA40z2FKbAIY4XDVrrF7oySNCMU4roHQg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=Y1zzQMbz; arc=none smtp.client-ip=209.85.214.180
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="Y1zzQMbz"
Received: by mail-pl1-f180.google.com with SMTP id d9443c01a7336-20c714cd9c8so12448525ad.0;
        Thu, 17 Oct 2024 09:34:45 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1729182885; x=1729787685; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=7azZRjBjM0rYf8Dvd4mI5u+wLb53xlXGjBTm5rdH+Tk=;
        b=Y1zzQMbzXHgRQF8KT7vi+/44VX3eH5OPlKxzqDCBpjiZo7UAB5dlwb8DC7CRhGA9Aw
         d0HlJE/KhJ7DjFwvIw+eT84RpbUussLFfqfSq81i5hHUyhNF7FolYLt+Xq+iOoTapnqq
         uN0mhWBNdMRt8WFhvx1C6aTFEnU3/gjUrC1OzaYlZ9Jr7j/Pnbz2IHhipt0ew9qiTmi2
         Z4SCceD5Oh0fHBocBXB1Ompq1qt7A6dCEh1Y2hrezUqh/ktfUZ6lrIYokz+Fjod3ZwYy
         IiLGH/MpeLF98rr/e30//Hvd0iAVH7pPENIUfNkZKGmqzbmAO9oWLHjo70kXwRqXQL9Q
         0IFg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1729182885; x=1729787685;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=7azZRjBjM0rYf8Dvd4mI5u+wLb53xlXGjBTm5rdH+Tk=;
        b=CzgfHkTJvPqvaM8e4ONxr60MYoV+ZStleahFeTvFTnLj2lJMhj8vmSwBdkKNqI2h1v
         s+cMpB3jhuVPBOipeIpwuAEKydTNIIY5eHOKcbHxSDZKJYDlTwY1+MnCmwOnvR6RNBvF
         bO4iCe2UJ0lpca/6QC0rInZd1VCM246gi6JpetKROWnlmhRUC64D76JLLyrC9H1tUrnE
         zZ5O5YWyFH/Lq5AqvvBzyMGY2QGUt4bcMunKlXuFL9HceM4MrfTPQ09ftDghLMiL0EnJ
         W6GwqBL1+1KYcKPGYueXH5kOBvV+RuN9GP8RKSmrD9UXmoteKCBkYahoDARpqPuTOlDK
         QIyQ==
X-Forwarded-Encrypted: i=1; AJvYcCUJ/xnkaxsG4xwBkBvTbqjbNGpvNIe0FN1kz8kVUiXVmzIGY99JYYNhLDuT2LNzcO7kYtG4UfCKsx1If5kE@vger.kernel.org, AJvYcCWn5IPis2/qkpP+CFmmi1KwTjEiaQ0B8Y6uiwAoitda0i3jQ6/rBg8GFaqaGfPqwPbLgrhkW7j1YtjR@vger.kernel.org, AJvYcCXFFv7lsOIdjfAviVegrNHfTS3K/oaEmCYCryv67zSjUiw0SsPJXKnA0EUtrEM1cY6GD2zOofd4MP0=@vger.kernel.org
X-Gm-Message-State: AOJu0YyUjSVyXroUV0hsGcR0QVxJjomTOUkWgt7+HlIg9oLfbgsc2xgs
	uU8cuYfwkw6Gpm3D/vFJ0y6UjzhZBQWUn4Rp3chGfWeSO06OyBuX
X-Google-Smtp-Source: AGHT+IEvSE7bcbW5iMeCar6RQ8E7bsc++y7hOdnobGC80HtcjwTt17/04ZvXNdGZyveXrCYeqajDdQ==
X-Received: by 2002:a17:902:ecc1:b0:20c:c482:1d62 with SMTP id d9443c01a7336-20cc4821f06mr224244025ad.61.1729182884692;
        Thu, 17 Oct 2024 09:34:44 -0700 (PDT)
Received: from fan ([2601:646:8f03:9fee:f922:7a97:d87e:e588])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-20d1805b0d0sm46542655ad.253.2024.10.17.09.34.42
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 17 Oct 2024 09:34:44 -0700 (PDT)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Thu, 17 Oct 2024 09:34:22 -0700
To: Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	dave@stgolabs.net, jonathan.cameron@huawei.com,
	dave.jiang@intel.com, alison.schofield@intel.com,
	vishal.l.verma@intel.com, dan.j.williams@intel.com,
	bhelgaas@google.com, mahesh@linux.ibm.com, oohall@gmail.com,
	Benjamin.Cheatham@amd.com, rrichter@amd.com,
	nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Message-ID: <ZxE8jn9M7twa4v2u@fan>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
Status: O
Content-Length: 13625
Lines: 230

On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
> This is a continuation of the CXL port error handling RFC from earlier.[1]
> The RFC resulted in the decision to add CXL PCIe port error handling to
> the existing RCH downstream port handling. This patchset adds the CXL PCIe
> port handling and logging.
> 
> The first 7 patches update the existing AER service driver to support CXL
> PCIe port protocol error handling and reporting. This includes AER service
> driver changes for adding correctable and uncorrectable error support, CXL
> specific recovery handling, and addition of CXL driver callback handlers.
> 
> The following 8 patches address CXL driver support for CXL PCIe port
> protocol errors. This includes the following changes to the CXL drivers:
> mapping CXL port and downstream port RAS registers, interface updates for
> common RCH and VH, adding port specific error handlers, and protocol error
> logging.
> 
> [1] - https://lore.kernel.org/linux-cxl/20240617200411.1426554
> -1-terry.bowman@amd.com/
> 
> Testing:
> 
> Below are test results for this patchset. This is using Qemu with a root
> port (0c:00.0), upstream switch port (0d:00.0),and downstream switch port
> (0e:00.0).
> 
> This was tested using aer-inject updated to support CE and UCE internal
> error injection. CXL RAS was set using a test patch (not upstreamed).

Hi Terry,
Can you share the aer-inject repo for the testing or the test patch?

Fan
> 
>     Root port UCE:
>     root@tbowman-cxl:~/aer-inject# ./root-uce-inject.sh
>     [   27.318920] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0c:00.0
>     [   27.320164] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0c:00.0
>     [   27.321518] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   27.322483] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00400000/02000000
>     [   27.323243] pcieport 0000:0c:00.0:    [22] UncorrIntErr
>     [   27.325584] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   27.325584]
>     [   27.327171] cxl_port_aer_uncorrectable_error: device=0000:0c:00.0 host=pci0000:0c status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   27.333277] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   27.333872] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3857
>     [   27.334761] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   27.335716] Call Trace:
>     [   27.335985]  <TASK>
>     [   27.336226]  panic+0x2ed/0x320
>     [   27.336547]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   27.337037]  ? __pfx_aer_root_reset+0x10/0x10
>     [   27.337453]  cxl_do_recovery+0x304/0x310
>     [   27.337833]  aer_isr+0x3fd/0x700
>     [   27.338154]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   27.338572]  irq_thread_fn+0x1f/0x60
>     [   27.338923]  irq_thread+0x102/0x1b0
>     [   27.339267]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   27.339683]  ? __pfx_irq_thread+0x10/0x10
>     [   27.340059]  kthread+0xcd/0x100
>     [   27.340387]  ? __pfx_kthread+0x10/0x10
>     [   27.340748]  ret_from_fork+0x2f/0x50
>     [   27.341100]  ? __pfx_kthread+0x10/0x10
>     [   27.341466]  ret_from_fork_asm+0x1a/0x30
>     [   27.341842]  </TASK>
>     [   27.342281] Kernel Offset: 0x1ba00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   27.343221] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Root port CE:
>     root@tbowman-cxl:~/aer-inject# ./root-ce-inject.sh
>     [   19.444339] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0c:00.0
>     [   19.445530] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0c:00.0
>     [   19.446750] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [   19.447742] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00004000/0000a000
>     [   19.448549] pcieport 0000:0c:00.0:    [14] CorrIntErr
>     [   19.449223] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [   19.449223]
>     [   19.451415] cxl_port_aer_correctable_error: device=0000:0c:00.0 host=pci0000:0c status='Received Error From Physical Layer'
> 
>     Upstream switch port UCE:
>     root@tbowman-cxl:~/aer-inject# ./us-uce-inject.sh
>     [   45.236853] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0d:00.0
>     [   45.238101] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0d:00.0
>     [   45.239416] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   45.240412] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00400000/02000000
>     [   45.241159] pcieport 0000:0d:00.0:    [22] UncorrIntErr
>     [   45.242448] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   45.242448]
>     [   45.244008] cxl_port_aer_uncorrectable_error: device=0000:0d:00.0 host=0000:0c:00.0 status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   45.249129] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   45.249800] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3855
>     [   45.250795] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   45.251907] Call Trace:
>     [   45.253284]  <TASK>
>     [   45.253564]  panic+0x2ed/0x320
>     [   45.253909]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   45.255455]  ? __pfx_aer_root_reset+0x10/0x10
>     [   45.255915]  cxl_do_recovery+0x304/0x310
>     [   45.257219]  aer_isr+0x3fd/0x700
>     [   45.257572]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   45.258006]  irq_thread_fn+0x1f/0x60
>     [   45.258383]  irq_thread+0x102/0x1b0
>     [   45.258748]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   45.259196]  ? __pfx_irq_thread+0x10/0x10
>     [   45.259605]  kthread+0xcd/0x100
>     [   45.259956]  ? __pfx_kthread+0x10/0x10
>     [   45.260386]  ret_from_fork+0x2f/0x50
>     [   45.260879]  ? __pfx_kthread+0x10/0x10
>     [   45.261418]  ret_from_fork_asm+0x1a/0x30
>     [   45.261936]  </TASK>
>     [   45.262451] Kernel Offset: 0xc600000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   45.263467] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Upstream switch port CE:
>     root@tbowman-cxl:~/aer-inject# ./us-ce-inject.sh 
>     [   37.504029] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0d:00.0
>     [   37.506076] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0d:00.0
>     [   37.507599] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [   37.508759] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00004000/0000a000
>     [   37.509574] pcieport 0000:0d:00.0:    [14] CorrIntErr            
>     [   37.510180] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [   37.510180] 
>     [   37.512057] cxl_port_aer_correctable_error: device=0000:0d:00.0 host=0000:0c:00.0 status='Received Error From Physical Layer'
> 
>     Downstream switch port UCE:
>     root@tbowman-cxl:~/aer-inject# ./ds-uce-inject.sh
>     [   29.421532] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0e:00.0
>     [   29.422812] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0e:00.0
>     [   29.424551] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
>     [   29.425670] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00400000/02000000
>     [   29.426487] pcieport 0000:0e:00.0:    [22] UncorrIntErr
>     [   29.427111] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
>     [   29.427111]
>     [   29.428688] cxl_port_aer_uncorrectable_error: device=0000:0e:00.0 host=0000:0d:00.0 status: 'Memory Address Parity Error'
>     first_error: 'Memory Address Parity Error'
>     [   29.430173] Kernel panic - not syncing: CXL cachemem error. Invoking panic
>     [   29.430862] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g844fd2319372 #3851
>     [   29.431874] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
>     [   29.433031] Call Trace:
>     [   29.433354]  <TASK>
>     [   29.433631]  panic+0x2ed/0x320
>     [   29.434010]  ? __pfx_cxl_report_normal_detected+0x10/0x10
>     [   29.434653]  ? __pfx_aer_root_reset+0x10/0x10
>     [   29.435179]  cxl_do_recovery+0x304/0x310
>     [   29.435626]  aer_isr+0x3fd/0x700
>     [   29.436027]  ? __pfx_irq_thread_fn+0x10/0x10
>     [   29.436507]  irq_thread_fn+0x1f/0x60
>     [   29.436898]  irq_thread+0x102/0x1b0
>     [   29.437293]  ? __pfx_irq_thread_dtor+0x10/0x10
>     [   29.437758]  ? __pfx_irq_thread+0x10/0x10
>     [   29.438189]  kthread+0xcd/0x100
>     [   29.438551]  ? __pfx_kthread+0x10/0x10
>     [   29.438959]  ret_from_fork+0x2f/0x50
>     [   29.439362]  ? __pfx_kthread+0x10/0x10
>     [   29.439771]  ret_from_fork_asm+0x1a/0x30
>     [   29.440221]  </TASK>
>     [   29.440738] Kernel Offset: 0x10a00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
>     [   29.441812] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---
> 
>     Downstream switch port CE:
>     root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
>     [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
>     [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
>     [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
>     [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
>     [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
>     [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
>     [  177.119521]
>     [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'
> 
> Changes RFC->v1:
>  [Dan] Rename cxl_rch_handle_error() becomes cxl_handle_error()
>  [Dan] Add cxl_do_recovery()
>  [Jonathan] Flatten cxl_setup_parent_uport()
>  [Jonathan] Use cxl_component_regs instead of struct cxl_regs regs
>  [Jonathan] Rename cxl_dev_is_pci_type()
>  [Ming] bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport) can
>  replace these find_cxl_port() and device_find_child().
>  [Jonathan] Compact call to cxl_port_map_regs() in cxl_setup_parent_uport()
>  [Ming] Dont use endpoint as host to cxl_map_component_regs()
>  [Bjorn] Use "PCIe UIR/CIE" instesad of "AER UI/CIE"
>  [TODO][Bjorn] Dont use Kconfig to enable/disable a CXL external interface
> 
> Terry Bowman (15):
>   cxl/aer/pci: Add CXL PCIe port error handler callbacks in AER service
>     driver
>   cxl/aer/pci: Update is_internal_error() to be callable w/o
>     CONFIG_PCIEAER_CXL
>   cxl/aer/pci: Refactor AER driver's existing interfaces to support CXL
>     PCIe ports
>   cxl/aer/pci: Add CXL PCIe port correctable error support in AER
>     service driver
>   cxl/aer/pci: Update AER driver to read UCE fatal status for all CXL
>     PCIe port devices
>   cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to pci_ers_result type
>   cxl/aer/pci: Add CXL PCIe port uncorrectable error recovery in AER
>     service driver
>   cxl/pci: Change find_cxl_ports() to be non-static
>   cxl/pci: Map CXL PCIe downstream port RAS registers
>   cxl/pci: Map CXL PCIe upstream port RAS registers
>   cxl/pci: Update RAS handler interfaces to support CXL PCIe ports
>   cxl/pci: Add error handler for CXL PCIe port RAS errors
>   cxl/pci: Add trace logging for CXL PCIe port RAS errors
>   cxl/aer/pci: Export pci_aer_unmask_internal_errors()
>   cxl/pci: Enable internal CE/UCE interrupts for CXL PCIe port devices
> 
>  drivers/cxl/core/core.h  |   3 +
>  drivers/cxl/core/pci.c   | 172 +++++++++++++++++++++++++++++++--------
>  drivers/cxl/core/port.c  |   4 +-
>  drivers/cxl/core/trace.h |  47 +++++++++++
>  drivers/cxl/cxl.h        |  14 +++-
>  drivers/cxl/mem.c        |  30 ++++++-
>  drivers/cxl/pci.c        |   8 ++
>  drivers/pci/pci.h        |   5 ++
>  drivers/pci/pcie/aer.c   | 123 ++++++++++++++++++++--------
>  drivers/pci/pcie/err.c   | 150 ++++++++++++++++++++++++++++++++++
>  include/linux/aer.h      |  16 ++++
>  include/linux/pci.h      |   3 +
>  12 files changed, 503 insertions(+), 72 deletions(-)
> 
> 
> base-commit: f7982d85e136ba7e26b31a725c1841373f81f84a
> -- 
> 2.34.1
> 

-- 
Fan Ni

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM11-DM6-obe.outbound.protection.outlook.com (mail-dm6nam11on2061.outbound.protection.outlook.com [40.107.223.61])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A17511DF72F;
	Thu, 17 Oct 2024 16:42:36 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.223.61
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729183361; cv=fail; b=k2HIZzfnk/LpJjWYpgtRNVoIr52XXGfFNepaoSpOTqb/DMfDYtq4s7BY5JHYmFC0+xPt92F+alNB9pLrKPae+fvR3zqseL+H5AREA3WwMQ5u2jFNZahOeqRshmzeyCD2Gbj4eMn9nd6UTwXhsHHXG+ImNGuEeV8QSiddwcd4BE0=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729183361; c=relaxed/simple;
	bh=2JnpQilfUiwyUsN1+eOJEQQ3O12OngQl2AAJUEoB59U=;
	h=Message-ID:Date:Subject:To:Cc:References:From:In-Reply-To:
	 Content-Type:MIME-Version; b=H1eo0PWHdyaqEP2Mua8DUpiniVpWZ+zBjsLLbdAC3Ue770Rr9mcnJ/UZIZMvNxT7hpxyVVjO7ztaNXm5r/mWQHY1G8Yv2XE6HYc9+vzNIi9V/jCRgdde4AbIXg41f7RBt9+2kIJILmYBcpGuhexTvsHBD2H29fQ+i8U5/BeDtIc=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=UlBYLhmK; arc=fail smtp.client-ip=40.107.223.61
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="UlBYLhmK"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=h1RmfntUUwOT6a7flgowzJM/6W8sgxkoPcEYuWmfe3Xfhi/YyX59ep6lC2xapGOylNgjle0R6vMl726oybXLV5D32wkDZKAYS7dW8qtiTYxMMeG3TZj/bn+GA3DdCcP3+mTrSdGh/Iq+HGBLEgSqIbxgCPt2TO+FCrnwkkXtV50Lj5/YKrTgAmepcysiUxPHsfp7pimEzVBKu7+azXQQRsdurUVHYHv35CfQZg4UbNFNmKFZLei73C9+of8i6LX/meW3VR2u2Yr+xtNfGHiNSOZYwz2pWxmPMcwLv9kSl25R8yV33Z8QqEkvWbyh7TIb3fNnYLmA6MOit+ceA7sLtw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=OZIARfJLoopyINeZB2L8xkCS8TKdu2uOGppZienCz4I=;
 b=DN0ZA4CvmeClvQJXAcrHed/dRSiGSa294KWEMkjCZsDhcltxgJZJBXBZ01XC7VYQwCNr4kX7mFCU4lujrmhZNPZc13zbdLLE3XEA8QbVUCFG2bLJZT+64Iarkb2JTe68FNQxOMcIAg+TSFJt6EDLv5uaFH/58iVN9uFNbO2+phMRMTNEVqofA8jt1aEevjh2epvtpX9Ofrxi7B0Hqd938vGZ54NNfX1+g0xsSub9Zy2Gc+8g0A6eVHXnLVmxEHrHxr7uCBcJ9Nv/anSrvA52kjbOHrtz1ab0Z7LRWycvmBa+Ukp0GL4R4ECS4Nuc5KTWhPbNwCSgi1hLGA2fgU+jKw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=OZIARfJLoopyINeZB2L8xkCS8TKdu2uOGppZienCz4I=;
 b=UlBYLhmKhpSKpgd+QerbL3ZJ0hnmi4B/lACnikV21ARhByJI9wixjdF0q//QSVlLLbWM6zKM8SdjwjVDG9D5lfie1h7/gimbs5raEcf0W7rFvh8GUXT8142jcMq9tdXIKTvZpx6bsH2OyA/CNFRkIw4ROPRcOEnZy/fH52bVC0g=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 SA1PR12MB6775.namprd12.prod.outlook.com (2603:10b6:806:25a::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8048.31; Thu, 17 Oct
 2024 16:42:32 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8069.018; Thu, 17 Oct 2024
 16:42:31 +0000
Message-ID: <c40d024d-e06c-42e2-b5fc-299a8af8290b@amd.com>
Date: Thu, 17 Oct 2024 11:42:29 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 12/15] cxl/pci: Add error handler for CXL PCIe port RAS
 errors
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
 Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 dave.jiang@intel.com, alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <20241008221657.1130181-13-terry.bowman@amd.com>
 <20241017145702.00006e58@Huawei.com>
Content-Language: en-US
From: "Bowman, Terry" <kibowman@amd.com>
In-Reply-To: <20241017145702.00006e58@Huawei.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA1PR02CA0010.namprd02.prod.outlook.com
 (2603:10b6:806:2cf::16) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|SA1PR12MB6775:EE_
X-MS-Office365-Filtering-Correlation-Id: 26aef17f-cc30-4007-88e4-08dceecab1ee
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|7416014|366016|1800799024;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?U3lrYUFSbHlRcElBS3VtVkRwWGJnMTJQaklYVnNuem9weStySXM5NWdlRzJ1?=
 =?utf-8?B?UU9oMEVaeUIwUlllc3JTMlJXdnRsb2NGc3puZTVsSHBXQitGK25WTmU1clds?=
 =?utf-8?B?NDZKYmdGbWdVajkvYy9YRC9YeHYyZ3FBL096dUdtOUViWFp3R1paY3oyUk52?=
 =?utf-8?B?SThjcTkraTJHeXJ3N1BGUDNkUmNsQjlKYmhBRVFUZi9qdWNxWTcvc0VUdERX?=
 =?utf-8?B?SUpVNTAvUXlxaXE1ZExwWTNTVlhpLzlrZk9rY2w5cWhBUWVsOXJydnhXRXln?=
 =?utf-8?B?bW03Q0pzUDdJRzFWdWhyNEFZWkYwOW55eWZ1YnVVdkZXd2NjK2s3cDZrVmVn?=
 =?utf-8?B?Y016RjFsK3J2cVFkKzY0d3cwNVhLclJaU0s1UCtXbSsycWNKWVVjK1RHZ0dR?=
 =?utf-8?B?N0ZIZkJhM2lucDZLUEtoRmdRLzIwQWdkUndabjdsV1JmdzFmaVJ2enczMDZN?=
 =?utf-8?B?SENYOUMrTEdxU0JRR3JrWE9XRnZCejVSVUcrb2RDWjFsL011cmw0TnZQRGp2?=
 =?utf-8?B?OGRENHZFa0xLcGxORHlzSlNjRTlMUEE0NUR4bGY2cEovWGdFU1Q0dkJxbEsy?=
 =?utf-8?B?ZXJJc3dOeUVpTGZpSzNiRGVnekU0V04yRFMzcmg5MHltekVPM2loNkRraGV5?=
 =?utf-8?B?akt3cXZPVklBN3A2RlFzSy9DMXRaWlBJTDJ1T3VSNUdyaUt4ZHFjSVM4bkN5?=
 =?utf-8?B?SVNTLzZoR0IwOFNFWE1UcFdKbGRsOFdFdHphMGpVb29maHVJVUNSVForVkM0?=
 =?utf-8?B?cDFycmJVWkdsUzNKcTZmQVU0bDdzdXRDdXRYWEc4TkY5Y0Q5TlZWcXIyaGFx?=
 =?utf-8?B?aVNZd0cvMVZacTBBTHZYTkd2RFVveFp6a0N5YnhWQWttZXJ0eEgyUXRFc1lN?=
 =?utf-8?B?K2hJdDZ3V21VTVY5ZnVVeEplMng0Vlh5b3JoMXJHcmlLL1ZsQ2FweVdxa0Yr?=
 =?utf-8?B?RThVekExUTJFVzY4UmFBQmRMN0FxSzJodnJnRHlHZS9TNWtSZmdRM1NveWFy?=
 =?utf-8?B?WWFlR0VQQWc2SFBRTUhGemtnYVdjZ0I5YmQ0QnJweHNBdFR1c0lHZFpLK1Vv?=
 =?utf-8?B?SXF2VDdXd1N1NjFjNmVDcHBHSmdsc2VYMnUxNWwra3MvTlNEblR0UFozblhw?=
 =?utf-8?B?QndXR2R4MHdpT2lhNXV6NUdpTnpQYUJrek1DVmN6WTJIT2ZDNUszaEFVRng4?=
 =?utf-8?B?QnBoRWhHeVpzTHdKck41L3hvNDM2WGh6aWljeGRLOHc1RWM3Qnh1bERPb2NM?=
 =?utf-8?B?OUJtWFl0NnNsWkpGVkNJank3aGRtczNVOHFPS2lmWmdERGFqYUNVbGtDeTVR?=
 =?utf-8?B?bm01NTlUaWgrZ3JCanhraEd2QUhKMTlDNFJzU01QNmFtU3dSbzVzcnhnK3N5?=
 =?utf-8?B?c0F2SGlpY21xZkpuMzN5aTN3YWk3b08vZVlpQUZBelhrUHlIcmJRVi95djNL?=
 =?utf-8?B?OCtrbjNlYVd2UXFFNmR0eS9EK1Q2QnVwSW5iVmF4Umd1dDlBUzN4UFVhYVNp?=
 =?utf-8?B?ZUszakV1WUNDSk1jZlZMaGtMYmFKZGtWbzlTZ3pwRmJtRElPUDB2MktKeEoy?=
 =?utf-8?B?cHh0ei8yb2NMRzZTaDZiMUJmenB1YndINjRkcUZRQ0gveHQxeVhBOU5qZ0d6?=
 =?utf-8?B?NjF6TERqb2FrckNWZzJYc2wyRjNlQ05vTkpOcUhXRytpWVdmUTdIR2xqRnpX?=
 =?utf-8?B?bDVONjBXWENLWmdhK2JKTDNGcmNLMHp6VFpTeE5ZOGtIdzhkQkZJMHFWU0xw?=
 =?utf-8?Q?8AnJHNVL0SrqhSLvyIRNZbTjGsPRK6pqnWwnSKo?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(7416014)(366016)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?b1plYytaMVpiajhoMXVCS0MwblBLSi9TOVYzR1JPejY4TlhGL2xSdEZiWmM2?=
 =?utf-8?B?Y2h1SWVZV3VybHR3WDN1Y3diOU5UWGxxdDdSVC9udVRDZEtBUy9vZlAwVUl4?=
 =?utf-8?B?NzVMcUJScDg2RmhyN3d2L0QrZDZ1NmE4cWhOWm5mbngwak9WZG9LcXdQb1Zm?=
 =?utf-8?B?N2thVE1VNzBSUGFxeTdGKzJ0b3hYWk92OGQ4bG00RnVqL09tM0lqam1IenFn?=
 =?utf-8?B?OVdmM1NwOEF1RGhYR3JzT2JHYmVaNWRBSjA2UVJqaDhYOXZsOE9RQXUramNF?=
 =?utf-8?B?WU5vM3VCV3dPN00zYmE4aXZtN25EMzJ5THJxV3FsK1hQV3pIZXVnZlBaWVVi?=
 =?utf-8?B?b2VoK1kzckJMRWhLQTVtcEFyN05wYVFJQXVycHU5SXhEQ3JBTVVXKzVoS3Jr?=
 =?utf-8?B?NDViYkJWN1RkNk5xN21BR1ladDFTKzFMTEVIZ0gwUU1lNHJ2K3grUkcxMURt?=
 =?utf-8?B?OS9pcWl1WFBqUkNDQTBoNEkrd2laUnpFRUNZWnpCRGk5a0E2aU5oM1Vjb21X?=
 =?utf-8?B?SEFoSzVLUGNsS1hVZ29Wb05hZVQ3RElCNDZDbnBYdmZhRXMyRlZza3BFdFYv?=
 =?utf-8?B?Y0tmVENVVHMzZzlCakhUd0xEbkN4aFBzbk9RNXFrc1JEV3lnQng3VitVTDVu?=
 =?utf-8?B?WktKVVptcGZEVXZwR1duSDZmZE1nUm9NcTRQbXVVT1BNak5TYU95czVDTjVn?=
 =?utf-8?B?cUt6c2JlRTRoa1hHNGFFRjBUODRMN3NPNEV4WFBtdWF4a3JjYS9zcTNIYW5G?=
 =?utf-8?B?cW56TGVkMDBTWmlwNTRQSXphOVp1K282RE5Yekx2R1A1VTNGSDhQdlVGR3FN?=
 =?utf-8?B?OFM2SkhSUVVtSFFveDdDL1ZIa1MxSVIxUkJCWmY1MGxOUzJ6V20vSHIzUjdp?=
 =?utf-8?B?RWQ1N3hzK2FuNGVlVitUVVE5OFFZNnRqWTdoYU9iWjFrWVI2cEk4c2x4WUFN?=
 =?utf-8?B?L2VkRnRGaWVKdFFYdTR4dmM4a2Z1T1kycUtuUFNTSVVjelJxNmhWSThNY0J5?=
 =?utf-8?B?VkRzUnhlYmhrYllqY3dJNno5bVowNld3VUFpS3AwRDMzYW9lbm9JdTNCVTd5?=
 =?utf-8?B?Zm9yUUlaVnBDWFM2SlY3UW1YNWQrdnlwSXBVczk4clA5TDYvSXNuU3JseWFP?=
 =?utf-8?B?czY5d2dJWW5XYlhBYTZDZEJjKzN3QXliSXd3WkRsOGZnVGlzODN1OU1kSE13?=
 =?utf-8?B?cW5tMlVBTjZ1SXhxQmlDWG0vdUU0bXZxYTI2dndmZzNEa01ZNDVlL0RmSjhT?=
 =?utf-8?B?c2NMT0lMY3RTd24wYWFPODJTbVpqb25MSUwxQW9NZnhIOVJydTR5SGp0aFo1?=
 =?utf-8?B?bGRxTkN6S2laYlc0UjNlNTQ0WGROQkQwOFlwOXRGT0k1TmNTYXN6b2xXdWJL?=
 =?utf-8?B?cXFHd2J2MlpuWi84U0t6YS95UllNdmNYMnZZLzN4a09yVDl2a1FTeTdNeFpE?=
 =?utf-8?B?TkV3d2tEZVBydEhEVDIweE0rZExFOFZmSlRDUXlzdDJZSlJHVG02R29kN1ZD?=
 =?utf-8?B?N2RnalFMQmFvdjhRN0pJMjR1UGNhdUpCL1YxTHNPVWpERjFCcEZUbTh5VUtZ?=
 =?utf-8?B?bUVJWkFLcTdaRGNKZk1pMTNDMEVYUlVibUxiSWlzRy9sK1VVNUZRbkthQWtK?=
 =?utf-8?B?bUdFZklxUkhJRXd4cy9wbGRyQnBPajlnQ1dNanBoc0c2TkQ5UFRXY2JsV2V4?=
 =?utf-8?B?bWRTVFZPUWVPbnFQeEhjUUV0aVEwZGIrbzZhUlBrbW1mR0ZMaTI0eWlreFVU?=
 =?utf-8?B?UWlZNnJLUklRaTJUdjk1Ui9KM2gvZmdUK0R2bG9NMkJiSVR3ckhxbFphY1Fa?=
 =?utf-8?B?dGNqQW1mUVlXMW5EeTg5REJRZUxlTVNIUSs3TnNTdDBqMndnSk1iKy9pMW1x?=
 =?utf-8?B?aE5OdzZMcU1QL05oaFczQ0xKcVY2VFgxZGxRV2pZNDZ2VFRPQm1QdkJndGF6?=
 =?utf-8?B?clRNd0tDd2VGMkVuN0VjejY3SUxJK2RvcGlJWTBkSWNFRXBIQUQ0bVlwdGg0?=
 =?utf-8?B?RnlJd0p4ejFmeGQxR3gzeXd2ZTUyMjM2MHd2UG1SN2p5MWgrVUdMM2w5N3l3?=
 =?utf-8?B?a01heDZ6Z3FYQzY5dERhL2FOZUhsdzQyeGlEWVBnWlZUcXlDYlpmbFRSSjgz?=
 =?utf-8?Q?bCHs9InQNqH109Dwgir4jM7fn?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 26aef17f-cc30-4007-88e4-08dceecab1ee
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 Oct 2024 16:42:31.7632
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: B5yK/vuaS/FVcq1aQVNf6wVJBQzwjfwRvDNY8wenpiFYFyYI7eBfjcop0Kp6/efJALAvQHEpSiJzfIJd5dB+bg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA1PR12MB6775
Status: O
Content-Length: 3391
Lines: 115

Hi Jonathan,

On 10/17/2024 8:57 AM, Jonathan Cameron wrote:
> On Tue, 8 Oct 2024 17:16:54 -0500
> Terry Bowman <terry.bowman@amd.com> wrote:
> 
>> The CXL drivers do not contain error handlers for CXL PCIe port
>> device protocol errors. These are needed in order to handle and log
>> RAS protocol errors.
>>
>> Add CXL PCIe port protocol error handlers to the CXL driver.
>>
>> Provide access to RAS registers for the specific CXL PCIe port types:
>> root port, upstream switch port, and downstream switch port.
>>
>> Also, register and unregister the CXL PCIe port error handlers with
>> the AER service driver using register_cxl_port_err_hndlrs() and
>> unregister_cxl_port_err_hndlrs(). Invoke the registration from
>> cxl_pci_driver_init() and the unregistration from cxl_pci_driver_exit().
>>
>> [1] CXL3.1 - 12.2.2 CXL Root Ports, Downstream Switch Ports, and
>>               Upstream Switch Ports
>>
>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>
> A few comments inline.
> 
> Jonathan
> 
>> ---
>>   drivers/cxl/core/pci.c | 83 ++++++++++++++++++++++++++++++++++++++++++
>>   drivers/cxl/cxl.h      |  5 +++
>>   drivers/cxl/pci.c      |  8 ++++
>>   3 files changed, 96 insertions(+)
>>
>> diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c
>> index c3c82c051d73..7e3770f7a955 100644
>> --- a/drivers/cxl/core/pci.c
>> +++ b/drivers/cxl/core/pci.c
>> @@ -815,6 +815,89 @@ static void cxl_disable_rch_root_ints(struct cxl_dport *dport)
>>   	}
>>   }
>>   
>> +static int match_uport(struct device *dev, const void *data)
>> +{
>> +	struct device *uport_dev = (struct device *)data;
>> +	struct cxl_port *port;
>> +
>> +	if (!is_cxl_port(dev))
>> +		return 0;
>> +
>> +	port = to_cxl_port(dev);
>> +
>> +	return port->uport_dev == uport_dev;
>> +}
>> +
>> +static void __iomem *cxl_pci_port_ras(struct pci_dev *pdev)
>> +{
>> +	void __iomem *ras_base;
>> +	struct cxl_port *port;
>> +
>> +	if (!pdev)
>> +		return NULL;
> Why would this happen?  Seems an odd check to have so maybe a comment.
> 


This is called directly from cxl_port_err_detected() and cxl_cor_port_err_detected().
We moved the pdev validation check into cxl_pci_port_ras().


>> +
>> +	if ((pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT) ||
>> +	    (pci_pcie_type(pdev) == PCI_EXP_TYPE_DOWNSTREAM)) {
>> +		struct cxl_dport *dport;
>> +
>> +		port = find_cxl_port(&pdev->dev, &dport);
> Can in theory fail>> +		ras_base = dport ? dport->regs.ras : NULL;
>> +		put_device(&port->dev);
> If it fails this is a null pointer dereference.
> 
>> +		return ras_base;
>> +	} else if (pci_pcie_type(pdev) == PCI_EXP_TYPE_UPSTREAM) {
>> +		struct device *port_dev __free(put_device);
> 
> Should be combined with the next line. We want it to be hard for anyone
> to put code in between!
> 
>> +
>> +		port_dev = bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport);
>> +		if (!port_dev)
>> +			return NULL;
>> +
>> +		port = to_cxl_port(port_dev);
>> +		if (!port)
>> +			return NULL;
>> +
>> +		ras_base = port ? port->uport_regs.ras : NULL;
> 
> Given check above, port exists. Remove one of the two
> checks.
> 
>> +		return ras_base;
>> +	}
>> +
>> +	return NULL;
>> +}

I have v2 changed (not posted yet) to use the following at the top of the function for the
if and else blocks using 'port'. Is not needed for dport.

struct cxl_port *port __free(put_cxl_port) = NULL;

Regards,
Terry


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 438841DE2C8;
	Thu, 17 Oct 2024 17:08:15 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=185.176.79.56
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729184901; cv=none; b=qMTf1rDh/XYomYWldWXQrc8YThJuHqTzYOm76nEnMMmBE8RbG6Q3+1uzsBx5BnEYwmql/f2g3Tjm1BfmQiM+YEEbHghhvE/LzHL8azQJuehh44Y1UnZSwQC43nXA3mq5KVGRIUencCzr2AWtftx6ueh02hVaiRI3DIbEgSVzf5s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729184901; c=relaxed/simple;
	bh=j93455ZXaGgpi6kTTtELZ3GhwIidte/wJbX20pcw7TY=;
	h=Date:From:To:CC:Subject:Message-ID:In-Reply-To:References:
	 MIME-Version:Content-Type; b=QrZkkEez8w5D3SB5pD0YTafdA0stRarL9EbrPGT55/rN/z0eg0EPDcznKwrVwM/RAetOCmdaL6yAfzpI/3UgHe0SfigqjasDPyUPye7jgXwPk+Ld3u1CNiIKL4yB1l1qTNq/93ZH2h9k9eahoPVfPqk7ITJFwdelyqib0K07JyQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com; spf=pass smtp.mailfrom=huawei.com; arc=none smtp.client-ip=185.176.79.56
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=Huawei.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=huawei.com
Received: from mail.maildlp.com (unknown [172.18.186.31])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4XTvLQ2bRPz6D9K8;
	Fri, 18 Oct 2024 01:03:42 +0800 (CST)
Received: from frapeml500008.china.huawei.com (unknown [7.182.85.71])
	by mail.maildlp.com (Postfix) with ESMTPS id 31D9D14011A;
	Fri, 18 Oct 2024 01:08:14 +0800 (CST)
Received: from localhost (10.126.174.164) by frapeml500008.china.huawei.com
 (7.182.85.71) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.1.2507.39; Thu, 17 Oct
 2024 19:08:13 +0200
Date: Thu, 17 Oct 2024 18:08:11 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: "Bowman, Terry" <kibowman@amd.com>
CC: Terry Bowman <Terry.Bowman@amd.com>, <ming4.li@intel.com>,
	<linux-cxl@vger.kernel.org>, <linux-kernel@vger.kernel.org>,
	<linux-pci@vger.kernel.org>, <dave@stgolabs.net>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>
Subject: Re: [PATCH 07/15] cxl/aer/pci: Add CXL PCIe port uncorrectable
 error recovery in AER service driver
Message-ID: <20241017180811.0000306a@Huawei.com>
In-Reply-To: <c756f2e4-2fa8-413a-b6b8-2f3ca8ec27a5@amd.com>
References: <20241008221657.1130181-1-terry.bowman@amd.com>
	<20241008221657.1130181-8-terry.bowman@amd.com>
	<20241016175426.0000411e@Huawei.com>
	<ac5f05ec-5017-4ac7-b238-b90585e7a5bc@amd.com>
	<20241017144315.0000074c@Huawei.com>
	<c756f2e4-2fa8-413a-b6b8-2f3ca8ec27a5@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 frapeml500008.china.huawei.com (7.182.85.71)
Status: O
Content-Length: 9116
Lines: 228

On Thu, 17 Oct 2024 11:21:36 -0500
"Bowman, Terry" <kibowman@amd.com> wrote:

> Hi Jonathan,
> 
> On 10/17/2024 8:43 AM, Jonathan Cameron wrote:
> > On Wed, 16 Oct 2024 13:07:37 -0500
> > Terry Bowman <Terry.Bowman@amd.com> wrote:
> >   
> >> Hi Jonathan,
> >>
> >> On 10/16/24 11:54, Jonathan Cameron wrote:  
> >>> On Tue, 8 Oct 2024 17:16:49 -0500
> >>> Terry Bowman <terry.bowman@amd.com> wrote:
> >>>      
> >>>> The current pcie_do_recovery() handles device recovery as result of
> >>>> uncorrectable errors (UCE). But, CXL port devices require unique
> >>>> recovery handling.
> >>>>
> >>>> Create a cxl_do_recovery() function parallel to pcie_do_recovery(). Add CXL
> >>>> specific handling to the new recovery function.
> >>>>
> >>>> The CXL port UCE recovery must invoke the AER service driver's CXL port
> >>>> UCE callback. This is different than the standard pcie_do_recovery()
> >>>> recovery that calls the pci_driver::err_handler UCE handler instead.
> >>>>
> >>>> Treat all CXL PCIe port UCE errors as fatal and call kernel panic to
> >>>> "recover" the error. A panic is called instead of attempting recovery
> >>>> to avoid potential system corruption.
> >>>>
> >>>> The uncorrectable support added here will be used to complete CXL PCIe
> >>>> port error handling in the future.
> >>>>
> >>>> Signed-off-by: Terry Bowman <terry.bowman@amd.com>  
> >>>
> >>> Hi Terry,
> >>>
> >>> I'm a little bothered by the subtle difference in the bus walks
> >>> in here vs the existing cases. If we need them, comments needed
> >>> to explain why.
> >>>      
> >>
> >> Yes, I will add more details in the commit message about "why".
> >> I added explanation following your below comment.
> >>  
> >>> If we are going to have separate handling, see if you can share
> >>> a lot more of the code by factoring out common functions for
> >>> the pci and cxl handling with callbacks to handle the differences.
> >>>      
> >>
> >> Dan requested separate paths for the PCIe and CXL recovery. The intent,
> >> as I understand, is to isolate the handling of PCIe and CXL protocol
> >> errors. This is to create 2 different classes of protocol errors.  
> > Function call chain wise I'm reasonably convinced that might be a good
> > idea.  But not code wise if it means we end up with more hard to review
> > code.
> >   
> >>  
> >>> I've managed to get my head around this code a few times in the past
> >>> (I think!) and really don't fancy having two subtle variants to
> >>> consider next time we get a bug :( The RC_EC additions hurt my head.
> >>>
> >>> Jonathan  
> >>
> >> Right, the UCE recovery logic is not straightforward. The code can  be
> >> refactored to take advantage of reuse. I'm interested in your thoughts
> >> after I have provided some responses here.
> >>  
> >>>      
> >>>>   static int handles_cxl_error_iter(struct pci_dev *dev, void *data)
> >>>> diff --git a/drivers/pci/pcie/err.c b/drivers/pci/pcie/err.c
> >>>> index 31090770fffc..de12f2eb19ef 100644
> >>>> --- a/drivers/pci/pcie/err.c
> >>>> +++ b/drivers/pci/pcie/err.c
> >>>> @@ -86,6 +86,63 @@ static int report_error_detected(struct pci_dev *dev,
> >>>>   	return 0;
> >>>>   }
> >>>>   
> >>>> +static int cxl_report_error_detected(struct pci_dev *dev,
> >>>> +				     pci_channel_state_t state,
> >>>> +				     enum pci_ers_result *result)
> >>>> +{
> >>>> +	struct cxl_port_err_hndlrs *cxl_port_hndlrs;
> >>>> +	struct pci_driver *pdrv;
> >>>> +	pci_ers_result_t vote;
> >>>> +
> >>>> +	device_lock(&dev->dev);
> >>>> +	cxl_port_hndlrs = find_cxl_port_hndlrs();  
> >>>
> >>> Can we refactor to have a common function under this and report_error_detected()?
> >>>      
> >>
> >> Sure, this can be refactored.
> >>
> >> The difference between cxl_report_error_detected() and report_error_detected() is the
> >> handlers that are called.
> >>
> >> cxl_report_error_detected() calls the CXL driver's registered port error handler.
> >>
> >> report_error_recovery() calls the pcie_dev::err_handlers.
> >>
> >> Let me know if I should refactor for common code here?  
> > 
> > It certainly makes sense to do that somewhere in here.  Just have light
> > wrappers that provide callbacks so the bulk of the code is shared.
> >   
> 
> Ok, Ill start on that. I have a v2 ready to-go without the reuse changes.
> You want me to wait on sending v2 till it has reuse refactoring?

I'd imagine we might have some time after v2, so go ahead - experiments
with refactoring can come later.


> >>>> + */
> >>>> +static void cxl_walk_bridge(struct pci_dev *bridge,
> >>>> +			    int (*cb)(struct pci_dev *, void *),
> >>>> +			    void *userdata)
> >>>> +{
> >>>> +	cb(bridge, userdata);
> >>>> +	if (bridge->subordinate)
> >>>> +		pci_walk_bus(bridge->subordinate, cb, userdata);  
> >>> The difference between this and pci_walk_bridge() is subtle and
> >>> I'd like to avoid having both if we can.
> >>>      
> >>
> >> The cxl_walk_bridge() was added because pci_walk_bridge() does not report
> >> CXL errors as needed. If the erroring device is a bridge then pci_walk_bridge()
> >> does not call report_error_detected() for the root port itself. If the bridge
> >> is a CXL root port then the CXL port error handler is not called. This has 2
> >> problems: 1. Error logging is not provided, 2. A result vote is not provided
> >> by the root port's CXL port handler.  
> > 
> > So what happens for PCIe errors on the root port?  How are they reported?
> > What I'm failing to understand is why these should be different.
> > Maybe there is something missing on the PCIe side though!
> > That code plays a game with what bridge and I thought that was there to handle
> > this case.
> >   
> 
> PCIe errors (not CXL errors) on a root port will be processed as they are today.
Sure, I was just failing to understand why the code didn't need to check
for error_detected on the root port, but the CXL code does.

> 
> An AER error is treated as a CXL error if *all* of the following are met:
> - The AER error is not an internal error
>     - Check is in AER's is_internal_error(info) function.
> - The device is not a CXL device
>     - Check is in AER's handles_cxl_errors() function.
> 
> Root port device PCIe error processing will not call the the pci_dev::err_handlers::error_detected().
> because of the walk_bridge() implementation. The result vote to direct handling
> is determined by downstream devices. This has probably been Ok until now because ports have been
> fairly vanilla and standard until CXL.

Ah. Got it - Root ports didn't have the handler.
So is there any harm in making them run it? (well not as they don't have it -
actually they do.  There is one in portdrv)
That way the two codes look more similar.  Also, does this mean there were
runtime pm and other calls that didn't hit the root port for PCIe that should have
done?

Comes back to I don't want too complex bits of code.  I'm fine with changing
the PCIe one to add new handling needed for CXL.

Just to be clear I'm fine with totally separate call paths just with lots
of code reuse.   That may mean a few precursor patches touching only the
PCIe code to make it fit for reuse.

Jonathan



> 
> 
> >>  
> >>>> +}
> >>>> +
> >>>>   pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
> >>>>   		pci_channel_state_t state,
> >>>>   		pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> >>>> @@ -276,3 +355,74 @@ pci_ers_result_t pcie_do_recovery(struct pci_dev *dev,
> >>>>   
> >>>>   	return status;
> >>>>   }
> >>>> +
> >>>> +pci_ers_result_t cxl_do_recovery(struct pci_dev *bridge,
> >>>> +				 pci_channel_state_t state,
> >>>> +				 pci_ers_result_t (*reset_subordinates)(struct pci_dev *pdev))
> >>>> +{
> >>>> +	struct pci_host_bridge *host = pci_find_host_bridge(bridge->bus);
> >>>> +	pci_ers_result_t status = PCI_ERS_RESULT_CAN_RECOVER;
> >>>> +	int type = pci_pcie_type(bridge);
> >>>> +
> >>>> +	if ((type != PCI_EXP_TYPE_ROOT_PORT) &&
> >>>> +	    (type != PCI_EXP_TYPE_RC_EC) &&
> >>>> +	    (type != PCI_EXP_TYPE_DOWNSTREAM) &&
> >>>> +	    (type != PCI_EXP_TYPE_UPSTREAM)) {
> >>>> +		pci_dbg(bridge, "Unsupported device type (%x)\n", type);
> >>>> +		return status;
> >>>> +	}
> >>>> +  
> >>>
> >>> Would similar trick to in pcie_do_recovery work here for the upstream
> >>> and downstream ports use pci_upstream_bridge() and for the others pass the dev into
> >>> pci_walk_bridge()?
> >>>      
> >>
> >> Yes, that would be a good starting point to begin reuse refactoring.
> >> I'm interested in getting yours and others feedback on the separation of the
> >> PCI and CXL protocol errors and how much separation is or not needed.  
> > 
> > Separation may make sense (I'm still thinking about it) for separate passes
> > through the topology and separate callbacks / handling when an error is seen.
> > What I don't want to see is two horribly complex separate walking codes if
> > we can possibly avoid it.  Long term to me that just means two sets of bugs
> > and problem corners instead of one.
> > 
> > Jonathan
> >   
> 
> I understand. I will look to make changes here for reuse.
> 
> Regards,
> Terry
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM04-BN8-obe.outbound.protection.outlook.com (mail-bn8nam04on2065.outbound.protection.outlook.com [40.107.100.65])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 140821DF733;
	Thu, 17 Oct 2024 17:27:10 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.100.65
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729186036; cv=fail; b=blM6reP1qZG1sIKofL3JhDUCyEMuyKG1hLjK09RyXNzJ6NraDVNIKxZ2x3HgZ+A8eQHAmQua9IB43HZZtFoRB3AKZxA0wuDpn+FRF++n3V2HhzT/HSMHhESySOu5EsPb2SN7oQTf18lWwyIunxdAEdi4Lcct9O9buqQ6Y6BTEvQ=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729186036; c=relaxed/simple;
	bh=/yaWDRpo3gC+tY5QCnnGq568x9R5XhGGTkKpYWVogaI=;
	h=Content-Type:Message-ID:Date:Subject:To:Cc:References:From:
	 In-Reply-To:MIME-Version; b=hYdTyGoCy7MaBlbSHo/RBc+B56wrvV24rSFE+/Lu4bvr8hPYdquH84A6wxkrPjcGXQDaX9Gy84tpIvK20VH825Vqm6/QzbAtpvWWUyq2fuHB/1T2JnByyxp9dT0kuEoeyRJf0jxGEbsZfg3jx9wz4JFklfHjgPT7T9M3VAlC23E=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=Uc1KarTo; arc=fail smtp.client-ip=40.107.100.65
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="Uc1KarTo"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=e2c8ZJkrbdu/EMulCpOW7WRs9T7XIpamp6Z93ELFZyuouHsYn9UpcOU55ZyfhtiJtIhEbYbKTDmS7fQLzBi/6avlPDT9jpNOIse0R3do/vIzww6oYFfEtwZIFetGBo57Bqb9+ErWUTvfF+6SnWLeudNo/O4xSwIK/l2VsNNjL75JSvSzvc1Ym1A+JeOCic+LuiSW47vMyR3cxo+eszA6/fnu/ku6wjdS9sfZ17Ut5i9kkvj9RNkAEZySp87dHoNufTRrWlfCG78Cm2qiVkTlGlwVfcq1E3IUCiMQdFNBp6J5XfQG/JYfy9mkh+SjXJ0C/fSLUzGK3IN0sPUYNyNyzw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=DfBXXvZMNgxZ6NDQVNHPxWp7it4JkFAzoIRvKaFv46w=;
 b=DjIbbF2xzLKpP0qnWQ3GPnzWBJCPHBGmrPbE9tU3F1uBnjmazM19TxU2t7P4Mt5gin9nyoWBE1WO3IEAxqoLyr/7NpRSgBq2QZxjPHN/20vg5/tiGco4G884oBPFPxjiNIiPYJh+7D+TcqImI9RMyDKI7VMfElXSGAeLYbpc2FyXreJNNvddsqIZI0s7cR5FcbokYqy4EYgLqeTvWcfWV943L8u2PAYLMXmkyXvLjpxQ2bu475gYaL4iy5J5vmPJ/hyrL/8w4yzM+ZzVNILvuKN4Uv7FWEGtE165hDBLT9fdeFuDyAXb/pIWLw82t4lA3c2tFEEUyYuySQY/9gT/GQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=DfBXXvZMNgxZ6NDQVNHPxWp7it4JkFAzoIRvKaFv46w=;
 b=Uc1KarToJdrt3GUwllB0OW10THEunKnHDiHQC7msFe8OHuwnxXK2KycOcEX3DwlORD7jGkgWxX7Lj0xZ90w3NCFJvk/LUsYGp+d/UxaMXKDSfpTxC4NChOiITozue9tDrfuPt1vIMjJVV4mNjl2wv0UySlwNBd6lTeyfTelM80k=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from DS0PR12MB6390.namprd12.prod.outlook.com (2603:10b6:8:ce::7) by
 PH8PR12MB7375.namprd12.prod.outlook.com (2603:10b6:510:215::12) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8069.20; Thu, 17 Oct
 2024 17:27:07 +0000
Received: from DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f]) by DS0PR12MB6390.namprd12.prod.outlook.com
 ([fe80::38ec:7496:1a35:599f%6]) with mapi id 15.20.8069.018; Thu, 17 Oct 2024
 17:27:07 +0000
Content-Type: multipart/mixed; boundary="------------oaxNO8EGBJE59h5ts0mynRBJ"
Message-ID: <8c34b676-e71a-42e8-96fe-485ffeaa8328@amd.com>
Date: Thu, 17 Oct 2024 12:27:04 -0500
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
To: Fan Ni <nifan.cxl@gmail.com>, Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
 linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, dave@stgolabs.net,
 jonathan.cameron@huawei.com, dave.jiang@intel.com,
 alison.schofield@intel.com, vishal.l.verma@intel.com,
 dan.j.williams@intel.com, bhelgaas@google.com, mahesh@linux.ibm.com,
 oohall@gmail.com, Benjamin.Cheatham@amd.com, rrichter@amd.com,
 nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
References: <20241008221657.1130181-1-terry.bowman@amd.com>
 <ZxE8jn9M7twa4v2u@fan>
Content-Language: en-US
From: "Bowman, Terry" <kibowman@amd.com>
In-Reply-To: <ZxE8jn9M7twa4v2u@fan>
X-ClientProxiedBy: SN4PR0501CA0032.namprd05.prod.outlook.com
 (2603:10b6:803:40::45) To DS0PR12MB6390.namprd12.prod.outlook.com
 (2603:10b6:8:ce::7)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: DS0PR12MB6390:EE_|PH8PR12MB7375:EE_
X-MS-Office365-Filtering-Correlation-Id: 97755ea1-eeb5-4f55-9c29-08dceed0ec8f
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;ARA:13230040|376014|7416014|366016|1800799024;
X-Microsoft-Antispam-Message-Info: 
	=?utf-8?B?cG94bmNnYnorRWJ1R2s1THA1UTQxWlZUeDZIU3RXVzNycnlvZTh2S0MreVk4?=
 =?utf-8?B?QVNyaGRpb09sM29adWFlbVNtbS9VNWRTcmpKbHZtckMzZFg3bGw4ckRkUDVm?=
 =?utf-8?B?c25SNW5KRUFCQmR4RG5GeFF6ZVVacVovN0lVSVI0U09melJXZ2RlRnFLcGJH?=
 =?utf-8?B?eTNsM1RXNEZWRFB4Qy9SWG85ZEZZR1hPbWs3bjVaZzV3eThKTUY2aTkwelFp?=
 =?utf-8?B?cHlrVGRpT2t6NGFlRXV2VTcweEFreUhpTFEwRmsvOTlWUm1PVittWXV5MnJs?=
 =?utf-8?B?c1VLU25HVnkvY2ZGdGVpOTh6azdTMWtvZDdXckJnZWNjWDZGKzMrUWY3c0tX?=
 =?utf-8?B?NGMyM0QwR1hwSldaRHRxNlZTcDZwbE5hNDlONUY3Uys4Y0o0TVRDRVN3d1ho?=
 =?utf-8?B?VEtqSGtGamZhdW4rbktsd3dmY1dHLzdQL0U4eHdZL0VycXFFaFkyRDZjdnZa?=
 =?utf-8?B?ZFo4K2JRUmZHU2tveUppdytCLzZpOHlYQWJ0U3hsK3J2QkVZNVNTdHo2L1FT?=
 =?utf-8?B?eFRrT3FJRVN5ckNHUjRYTW8yRm0xN1c0NzViSEZiNnBTOTgycFVrc0FxVjRY?=
 =?utf-8?B?UllmSnVSbGI5ZEVjSXNvYzAzSDlNVGlQUXdJS1hrVXlqUklGV09kZEgxOXZR?=
 =?utf-8?B?a09JUkpmcEFjcVlqOHNXMHNWd2xoL0hwZzduY2h6THBLYnZuQy90RzNJMktZ?=
 =?utf-8?B?WjV3aHZXcHZldm5IMUZyZHFmZXRxR0NEMGNnS2FBdkpudStJVFpYUHFGdGRG?=
 =?utf-8?B?ZTJRaE8zTGswd1U1UnZyeGFVRWI1R3JpelBnOHR1SGErbDIzQjlQYWM1ZzAw?=
 =?utf-8?B?RzFnNnROUkFrUDJoTC83SGhvN0dyNDdZNmtvemhEU3Z6UzkzK2hZVkNjTVh1?=
 =?utf-8?B?ZFFRS2xwSDZTeGxWdTlQcFRidXJ3dEtpZEpHWVF0dHBESEZOczJldTdUSlN1?=
 =?utf-8?B?Y3o0aTB2NUVkTGcyakgzY1VsOWVqZm9xcTBGeDlyNDNEdi9CTzBkb1VjYWRs?=
 =?utf-8?B?NnFmYlFPeWdETGlBdTBwbXJIWmdQSjRld2FSSDkwdThOd3JCWktGRVRiNXRO?=
 =?utf-8?B?N3psSFVLbVozeVVKVkVZNU5wUkVvOHgvTkZjbWE3Rk1Db2VDdVR2VkxjLzI4?=
 =?utf-8?B?UURtY2crNk1acmxkcVEzRDhyREFGWEZNSDBvano0YU5LNzJtTXNPbEdJZVoz?=
 =?utf-8?B?NUJMNnRoV1BnN0s2Y2pSYXdEQVNyL2NOZ2QvVlRZWG95UXpvSGxJbDVjcEFT?=
 =?utf-8?B?TmJ0SmlpUDVYejhtWEdHTzRNWTRsVXFPUnBKMWVNS3hmUEhuanU2S2h3Q1Nn?=
 =?utf-8?B?RDlyVjBZN2J0ci9ReklKOEJ4OE16dkVabE90bGVaY3JzeXhYK3FDMzdVM0wx?=
 =?utf-8?B?NHV4ZGFJdGprVUlMaTFINEdMN2NBL0UxS04wSUI3VDEyQXpucXRoR0dKUWQ3?=
 =?utf-8?B?TCs1NUg2TldscElaSmZJaW80Tjl2MjBZVlRrYkJxSUYvc2lmTDE2bzV3NEZ3?=
 =?utf-8?B?YUQwUjljSXJWaStNcVJaT2ZjRXJkWkdqSFdtc0RFK3hiais4VzNUeG13Mlh4?=
 =?utf-8?B?QVdmdWxZZzVVM1R4RStKNU01N0VHYUdoNHdSUzFnUkJzeVRKUEZOS1VpdVBY?=
 =?utf-8?B?WGo2N3YwQmZRSW9IZ05NOUJlN2ovZ3doY2Q5cW4zVDdmTXMvVjVGcXRpUEFI?=
 =?utf-8?B?WEVhTkNVWTZyR2NjS04wdHZmNWh1RjVMZk1Wd1FKMHJNdzZDVGV3cndQYVlV?=
 =?utf-8?B?VlVvWGxvMDIwbVA4T3lIYkJTNWUwd3NGMk5STEYrbnRyYkFyVHdYbGYyTkRH?=
 =?utf-8?B?T3Q3WFI1Z2grY1hFRlUwZz09?=
X-Forefront-Antispam-Report: 
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DS0PR12MB6390.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230040)(376014)(7416014)(366016)(1800799024);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: 
	=?utf-8?B?NlJZV0FJcERRUVAwMWFPallNa0VobUFuazUvc0FrR2sxZ1pxcVlwbzgyM1Uz?=
 =?utf-8?B?T0FxLzVMRDNySzg1bk1NVHZCaGFGVXBSUFJNZkdWM1F4N0ZZWWRzRlJCOXVj?=
 =?utf-8?B?RzI0V1dsREFxWnFXNDY2NTBIY2dPUlYzV0d3NXVlV0RJRkZDaTBRYVJZMFV1?=
 =?utf-8?B?UUdJWjd0WllrSG1mTnRBOUI2aVpWSUhrVFhFcXV3Q3VIQmFRZTVRK2VsNEVO?=
 =?utf-8?B?SUxHN2VRSVJieWk1dTBzam9ndlNSV1ljeEpVQlZMNW81UGxTdDNSY0ZCQU1w?=
 =?utf-8?B?K3A5RWQ5SlFtSlJLVkVlZEtETDlsZjcxbGZTZCtycDVYVGdnU0NhYi9RSys5?=
 =?utf-8?B?SThJR05uTDZMZkEyL2FDN0VhV1F6bFE1OE4rUi9yeHJOemhPL2JJUGEzeGIw?=
 =?utf-8?B?YVFpQkxjby9EVzFmRFo1Z1E2OWtOc0FJUENuTHFXQVNkZW9FeVQ4L3FoVDBm?=
 =?utf-8?B?cGozMzhiclhORzhXa3JMekZNU3Z5cDFFWHdpckk4Z2Q1Wi9Pb3ovc1poZnNR?=
 =?utf-8?B?UDZBMmc2Y3pzbTNCOVVyNDdFL2t5bjNpcy80WjJ0TjNpQVFsZUdyU3pYZjAy?=
 =?utf-8?B?YWNNa1BjMEZ6blpUTVVrcjRHRWs1dDJCdkxqQ3g1enJDRStxUi9DUzNkSkNN?=
 =?utf-8?B?Sk52dFhWNTlONnBxbjJJenNGaDAvUXRGcTQxTHcrR1VBRkxHRmdiQm80VE1q?=
 =?utf-8?B?dnB3K1p2MDlqS0pJdXlnZU9KQnNwNzh4bnNTckJycXBqUm1MMWovV0VzZFFm?=
 =?utf-8?B?S3JwTzVzWm5qT2tFamJ3Mnh6Z1ZUREdRWld5SGw1NFI4WWgyVDRGa29uNnZU?=
 =?utf-8?B?bXpIU0xlaE8zT0gzd1FvRjhwMGJHL0NvSzV6NGNzSmpVaXlTTlVjL3dKaEtz?=
 =?utf-8?B?YUNsd20wQ09WUDFPSXhsS0wveGdJRG43SmZrcmJrM3ROaU9XaFBxcUVzYmFS?=
 =?utf-8?B?SkNKRml6b2dyMXpTaTNDTDA5QlVXcXZZaE9MbGc0YUJIUWhoR1ZEeURUb1o4?=
 =?utf-8?B?bXBuN2NtZ0ZQa2FSMkk3cm0yRUdLekdsWjNUT3hqalBaVTJpNDVKQnlrcytG?=
 =?utf-8?B?d1lCT2ZpaE83WGJiY3ZZUUhhelZBRDZORkUxSXZOZDRSZ2FkTHgxbENhRmpS?=
 =?utf-8?B?VXZDZXhHOTdQWE54Z1N6ajdqdW1rcjhvNTJsWHRwVVdhRlNDUjJjT2ZVVlND?=
 =?utf-8?B?Y0lESUFXQk5UQjBWZnBUelBWTEV6cmg4OXFmMGhyMjczcWRFZ0I2eTNsc1VG?=
 =?utf-8?B?QmVMTmNGbjJLLzJlYkJVbllMY2YyTElxUFAzYkhPbHgzSERBNytNNzRXR29W?=
 =?utf-8?B?SjhFVExtV0kxSXZ4bU1BWEtYb3FWMCszOEhraHZlWnlvVVU5Y3I2Uyt6ZHRR?=
 =?utf-8?B?b25NNFFMVDZodjU2S25yZ2VlL3RlVS80eXNSSklwT1d0Ym5SbXptbURhUzlR?=
 =?utf-8?B?NW9vcnBHWm5YN09WeEsxYmllVlhucys4Z1NXdHdrRzRhU0JZaHh5M1pnaDZV?=
 =?utf-8?B?VmJWR0lQR1V6ajVUVEFDcFVSeFMxNVFYRmNiM0VjZXJ3K1ZuRDVaeFhlOVV3?=
 =?utf-8?B?ZmlaRGdEbnB0RlhGNTQ1YkRLbUozTWFpWTdYdnhnSDVlS1d0djhmZ1ZlY1U1?=
 =?utf-8?B?SmVOcjcra200QmltSEdHakVocEpTbUtpRjVXckVhMkpWZzhxVmJxZTgyWm56?=
 =?utf-8?B?UkVscmpEaDdPS3dzbnVqVkJ3aytaeWw1VzVMU2J1My9rSmRyVUhJakhBTHA4?=
 =?utf-8?B?SVFKdUpwUEtKZktJVHl0ZDF0TEpPMEpTNFZ2Q2NqMHkwSU5Mb2VzZG9xSzJ2?=
 =?utf-8?B?ejlBSysvZFRPUWM3amZGUU5RL0ExKy80SFM2SVdqd2dSVVJyWDMzRmx3ZU9F?=
 =?utf-8?B?R0tEZUVLUDhCNWRjTko2Y2I4MythdnN1VXRLa1FJQ0RsNTB2QTBEd1huK3Yz?=
 =?utf-8?B?RHNPZy9jdlVsK0NjOFlFZ3VzaGN3YlovN3Y2R0lsYmJhcjhSaUJKRjlvZ2l1?=
 =?utf-8?B?Yjk1NHFua0xhS1I2YzBCSlZEa2U1aHNteE5WekVDQTkzcHNKcTRZbnh3ZTdl?=
 =?utf-8?B?YktBREFLaUk4NytHekZiWjNkZE9UOWFKdC80a2YvOXZrQ09RYVZqb24rdm1r?=
 =?utf-8?Q?GqHip3ra9A8qtJyIUUkDc11/7?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 97755ea1-eeb5-4f55-9c29-08dceed0ec8f
X-MS-Exchange-CrossTenant-AuthSource: DS0PR12MB6390.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 17 Oct 2024 17:27:07.1493
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: uz0G69spAlIUh+MlQDBncivHdiGhVQv/CAAA8vZcVvFy6vWXHHHbvSuZOBz2RFdAMFUCtyKDHphnGE68VaeeIA==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH8PR12MB7375
Status: RO
X-Status: A
Content-Length: 6185
Lines: 110

--------------oaxNO8EGBJE59h5ts0mynRBJ
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

Hi Fan,

On 10/17/2024 11:34 AM, Fan Ni wrote:
> On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
>> This is a continuation of the CXL port error handling RFC from earlier.[1]
>> The RFC resulted in the decision to add CXL PCIe port error handling to
>> the existing RCH downstream port handling. This patchset adds the CXL PCIe
>> port handling and logging.
>>
>> The first 7 patches update the existing AER service driver to support CXL
>> PCIe port protocol error handling and reporting. This includes AER service
>> driver changes for adding correctable and uncorrectable error support, CXL
>> specific recovery handling, and addition of CXL driver callback handlers.
>>
>> The following 8 patches address CXL driver support for CXL PCIe port
>> protocol errors. This includes the following changes to the CXL drivers:
>> mapping CXL port and downstream port RAS registers, interface updates for
>> common RCH and VH, adding port specific error handlers, and protocol error
>> logging.
>>
>> [1] - https://lore.kernel.org/linux-cxl/20240617200411.1426554
>> -1-terry.bowman@amd.com/
>>
>> Testing:
>>
>> Below are test results for this patchset. This is using Qemu with a root
>> port (0c:00.0), upstream switch port (0d:00.0),and downstream switch port
>> (0e:00.0).
>>
>> This was tested using aer-inject updated to support CE and UCE internal
>> error injection. CXL RAS was set using a test patch (not upstreamed).
> 
> Hi Terry,
> Can you share the aer-inject repo for the testing or the test patch?
> 
> Fan

Sure, but, its easiest to attach the patch here.

Origin was https://github.com/jderrick/aer-inject.git
Base is 81701cbb30e35a1a76c3876f55692f91bdb9751b

Regards,
Terry
--------------oaxNO8EGBJE59h5ts0mynRBJ
Content-Type: text/plain; charset=UTF-8;
 name="0001-aer-inject-Add-internal-error-injection.patch"
Content-Disposition: attachment;
 filename="0001-aer-inject-Add-internal-error-injection.patch"
Content-Transfer-Encoding: base64

RnJvbSBjYTkyNzc4NjZiNTA2NzIzZjQ2ZjNhY2Q3YjI2NGZmYTgwYzM3Mjc2IE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBUZXJyeSBCb3dtYW4gPHRlcnJ5LmJvd21hbkBhbWQuY29tPgpE
YXRlOiBUaHUsIDE3IE9jdCAyMDI0IDEyOjEyOjU4IC0wNTAwClN1YmplY3Q6IFtQQVRDSF0gYWVy
LWluamVjdDogQWRkIGludGVybmFsIGVycm9yIGluamVjdGlvbgoKQWRkIGNvcnJlY3RlZCAoQ0Up
IGFuZCB1bmNvcnJlY3RlZCAoVUNFKSBBRVIgaW50ZXJuYWwgZXJyb3IgaW5qZWN0aW9uCnN1cHBv
cnQuCgpTaWduZWQtb2ZmLWJ5OiBUZXJyeSBCb3dtYW4gPHRlcnJ5LmJvd21hbkBhbWQuY29tPgot
LS0KIGFlci5oICAgfCAyICsrCiBhZXIubGV4IHwgMiArKwogYWVyLnkgICB8IDggKysrKy0tLS0K
IDMgZmlsZXMgY2hhbmdlZCwgOCBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQoKZGlmZiAt
LWdpdCBhL2Flci5oIGIvYWVyLmgKaW5kZXggYTBhZDE1Mi4uZTU1YTczMSAxMDA2NDQKLS0tIGEv
YWVyLmgKKysrIGIvYWVyLmgKQEAgLTMwLDExICszMCwxMyBAQCBzdHJ1Y3QgYWVyX2Vycm9yX2lu
agogI2RlZmluZSAgUENJX0VSUl9VTkNfTUFMRl9UTFAJMHgwMDA0MDAwMAkvKiBNYWxmb3JtZWQg
VExQICovCiAjZGVmaW5lICBQQ0lfRVJSX1VOQ19FQ1JDCTB4MDAwODAwMDAJLyogRUNSQyBFcnJv
ciBTdGF0dXMgKi8KICNkZWZpbmUgIFBDSV9FUlJfVU5DX1VOU1VQCTB4MDAxMDAwMDAJLyogVW5z
dXBwb3J0ZWQgUmVxdWVzdCAqLworI2RlZmluZSAgUENJX0VSUl9VTkNfSU5URVJOQUwgICAweDAw
NDAwMDAwICAgICAgLyogSW50ZXJuYWwgZXJyb3IgKi8KICNkZWZpbmUgIFBDSV9FUlJfQ09SX1JD
VlIJMHgwMDAwMDAwMQkvKiBSZWNlaXZlciBFcnJvciBTdGF0dXMgKi8KICNkZWZpbmUgIFBDSV9F
UlJfQ09SX0JBRF9UTFAJMHgwMDAwMDA0MAkvKiBCYWQgVExQIFN0YXR1cyAqLwogI2RlZmluZSAg
UENJX0VSUl9DT1JfQkFEX0RMTFAJMHgwMDAwMDA4MAkvKiBCYWQgRExMUCBTdGF0dXMgKi8KICNk
ZWZpbmUgIFBDSV9FUlJfQ09SX1JFUF9ST0xMCTB4MDAwMDAxMDAJLyogUkVQTEFZX05VTSBSb2xs
b3ZlciAqLwogI2RlZmluZSAgUENJX0VSUl9DT1JfUkVQX1RJTUVSCTB4MDAwMDEwMDAJLyogUmVw
bGF5IFRpbWVyIFRpbWVvdXQgKi8KKyNkZWZpbmUgIFBDSV9FUlJfQ09SX0NJTlRFUk5BTAkweDAw
MDA0MDAwCS8qIEludGVybmFsIGVycm9yICovCiAKIGV4dGVybiB2b2lkIGluaXRfYWVyKHN0cnVj
dCBhZXJfZXJyb3JfaW5qICplcnIpOwogZXh0ZXJuIHZvaWQgc3VibWl0X2FlcihzdHJ1Y3QgYWVy
X2Vycm9yX2luaiAqZXJyKTsKZGlmZiAtLWdpdCBhL2Flci5sZXggYi9hZXIubGV4CmluZGV4IDYx
MjFlNGUuLjRmYWRkMGUgMTAwNjQ0Ci0tLSBhL2Flci5sZXgKKysrIGIvYWVyLmxleApAQCAtODIs
MTEgKzgyLDEzIEBAIHN0YXRpYyBzdHJ1Y3Qga2V5IHsKIAlLRVlWQUwoTUFMRl9UTFAsIFBDSV9F
UlJfVU5DX01BTEZfVExQKSwKIAlLRVlWQUwoRUNSQywgUENJX0VSUl9VTkNfRUNSQyksCiAJS0VZ
VkFMKFVOU1VQLCBQQ0lfRVJSX1VOQ19VTlNVUCksCisJS0VZVkFMKElOVEVSTkFMLCBQQ0lfRVJS
X1VOQ19JTlRFUk5BTCksCiAJS0VZVkFMKFJDVlIsIFBDSV9FUlJfQ09SX1JDVlIpLAogCUtFWVZB
TChCQURfVExQLCBQQ0lfRVJSX0NPUl9CQURfVExQKSwKIAlLRVlWQUwoQkFEX0RMTFAsIFBDSV9F
UlJfQ09SX0JBRF9ETExQKSwKIAlLRVlWQUwoUkVQX1JPTEwsIFBDSV9FUlJfQ09SX1JFUF9ST0xM
KSwKIAlLRVlWQUwoUkVQX1RJTUVSLCBQQ0lfRVJSX0NPUl9SRVBfVElNRVIpLAorCUtFWVZBTChD
SU5URVJOQUwsIFBDSV9FUlJfQ09SX0NJTlRFUk5BTCksCiB9OwogCiBzdGF0aWMgaW50IGNtcF9r
ZXkoY29uc3Qgdm9pZCAqYXYsIGNvbnN0IHZvaWQgKmJ2KQpkaWZmIC0tZ2l0IGEvYWVyLnkgYi9h
ZXIueQppbmRleCBlNWVjYzdkLi41MDBkYzk3IDEwMDY0NAotLS0gYS9hZXIueQorKysgYi9hZXIu
eQpAQCAtMzQsOCArMzQsOCBAQCBzdGF0aWMgdm9pZCBpbml0KHZvaWQpOwogCiAldG9rZW4gQUVS
IERPTUFJTiBCVVMgREVWIEZOIFBDSV9JRCBVTkNPUl9TVEFUVVMgQ09SX1NUQVRVUyBIRUFERVJf
TE9HCiAldG9rZW4gPG51bT4gVFJBSU4gRExQIFBPSVNPTl9UTFAgRkNQIENPTVBfVElNRSBDT01Q
X0FCT1JUIFVOWF9DT01QIFJYX09WRVIKLSV0b2tlbiA8bnVtPiBNQUxGX1RMUCBFQ1JDIFVOU1VQ
Ci0ldG9rZW4gPG51bT4gUkNWUiBCQURfVExQIEJBRF9ETExQIFJFUF9ST0xMIFJFUF9USU1FUgor
JXRva2VuIDxudW0+IE1BTEZfVExQIEVDUkMgVU5TVVAgSU5URVJOQUwKKyV0b2tlbiA8bnVtPiBS
Q1ZSIEJBRF9UTFAgQkFEX0RMTFAgUkVQX1JPTEwgUkVQX1RJTUVSIENJTlRFUk5BTAogJXRva2Vu
IDxudW0+IFNZTUJPTCBOVU1CRVIKICV0b2tlbiA8c3RyPiBQQ0lfSURfU1RSCiAKQEAgLTc3LDE0
ICs3NywxNCBAQCB1bmNvcl9zdGF0dXNfbGlzdDogLyogZW1wdHkgKi8JCQl7ICQkID0gMDsgfQog
CTsKIAogdW5jb3Jfc3RhdHVzOiBUUkFJTiB8IERMUCB8IFBPSVNPTl9UTFAgfCBGQ1AgfCBDT01Q
X1RJTUUgfCBDT01QX0FCT1JUCi0JfCBVTlhfQ09NUCB8IFJYX09WRVIgfCBNQUxGX1RMUCB8IEVD
UkMgfCBVTlNVUCB8IE5VTUJFUgorCXwgVU5YX0NPTVAgfCBSWF9PVkVSIHwgTUFMRl9UTFAgfCBF
Q1JDIHwgVU5TVVAgfCBJTlRFUk5BTCB8IE5VTUJFUgogCTsKIAogY29yX3N0YXR1c19saXN0OiAv
KiBlbXB0eSAqLwkJCXsgJCQgPSAwOyB9CiAJfCBjb3Jfc3RhdHVzX2xpc3QgY29yX3N0YXR1cwkJ
eyAkJCA9ICQxIHwgJDI7IH0KIAk7CiAKLWNvcl9zdGF0dXM6IFJDVlIgfCBCQURfVExQIHwgQkFE
X0RMTFAgfCBSRVBfUk9MTCB8IFJFUF9USU1FUiB8IE5VTUJFUgorY29yX3N0YXR1czogUkNWUiB8
IEJBRF9UTFAgfCBCQURfRExMUCB8IFJFUF9ST0xMIHwgUkVQX1RJTUVSIHwgQ0lOVEVSTkFMIHwg
TlVNQkVSCiAJOwogCiAlJSAKLS0gCjIuMzQuMQoK

--------------oaxNO8EGBJE59h5ts0mynRBJ--

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AB9B2768E1;
	Fri, 18 Oct 2024 23:22:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1729293762; cv=none; b=Wcu3BI11DUra7Ap7tPlBHVe/zUiXecsycqijX78ghS+paDZ3Nf8bRe3ldFPgC1BxM2GVMfyLnA8c+K9Tgp0itiv7nQQttLSgw0mZj3VdZN0MoQWVcuMovCLVnFe9m2f7O39EEkWbmheR4hUUc6Hr7YGjh1KhQ1biF44+EqU2KhY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1729293762; c=relaxed/simple;
	bh=Awclod2d4QNoDtBeg3hpjMzIstaYpw+65mTAfcX0CYw=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition:In-Reply-To; b=sm+brZGbLwDw1aBQgvcxf2o01m3fNJaDhAmGG+kMjnWXpgn9LpmN4r8kzt7mte/LjSjBXMNvYf3v3EoVz87BJkTBBEljuSsizwekirWYRGKXvqykJxAzCVoY1ZX/KrXI9wZ95oHri6666vCuERrA30NuW+BqEWNVlVYHQztKwLg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=npjpqc5I; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="npjpqc5I"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 0B197C4CEC6;
	Fri, 18 Oct 2024 23:22:41 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1729293762;
	bh=Awclod2d4QNoDtBeg3hpjMzIstaYpw+65mTAfcX0CYw=;
	h=Date:From:To:Cc:Subject:In-Reply-To:From;
	b=npjpqc5I2N8hguVXQPfSuVWDblo3YQ18gaMgoVtSptw9nZsKZGPvE4vj0x5fpkbDE
	 Kj87kkwO0sVyTpAVG/9gM4AffPFkMgEsmlwW//bW0k2+G7aRivdyhBuIgK9v3Y3JCg
	 1vi0D+ekKKfDgI4BV0bX74rPqQAcqmHdvsGKeTEMkJH0f1/81BLAbfNKYX2NRPjnCQ
	 xNAgFL7xWVMAVMTs18mMgGGctk4sLO2XjWHDuNIMFFUnbX1120Ob9OUdvFQPkheIFB
	 WP+2COMO73oGgarqSgynbMHQofmFKlHpa8CWmR1Rd9MNM4NBXYOb90Xmnj0Twqp80I
	 Uf4BIMfvSEFgQ==
Date: Fri, 18 Oct 2024 18:22:40 -0500
From: Bjorn Helgaas <helgaas@kernel.org>
To: Terry Bowman <terry.bowman@amd.com>
Cc: ming4.li@intel.com, linux-cxl@vger.kernel.org,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	dave@stgolabs.net, jonathan.cameron@huawei.com,
	dave.jiang@intel.com, alison.schofield@intel.com,
	vishal.l.verma@intel.com, dan.j.williams@intel.com,
	bhelgaas@google.com, mahesh@linux.ibm.com, oohall@gmail.com,
	Benjamin.Cheatham@amd.com, rrichter@amd.com,
	nathan.fontenot@amd.com, smita.koralahallichannabasappa@amd.com
Subject: Re: [PATCH 0/15] Enable CXL PCIe port protocol error handling and
 logging
Message-ID: <20241018232240.GA768749@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20241008221657.1130181-1-terry.bowman@amd.com>
Status: O
Content-Length: 1141
Lines: 23

On Tue, Oct 08, 2024 at 05:16:42PM -0500, Terry Bowman wrote:
> This is a continuation of the CXL port error handling RFC from earlier.[1]
> The RFC resulted in the decision to add CXL PCIe port error handling to
> the existing RCH downstream port handling. This patchset adds the CXL PCIe
> port handling and logging.
> 
> The first 7 patches update the existing AER service driver to support CXL
> PCIe port protocol error handling and reporting. This includes AER service
> driver changes for adding correctable and uncorrectable error support, CXL
> specific recovery handling, and addition of CXL driver callback handlers.
> 
> The following 8 patches address CXL driver support for CXL PCIe port
> protocol errors. This includes the following changes to the CXL drivers:
> mapping CXL port and downstream port RAS registers, interface updates for
> common RCH and VH, adding port specific error handlers, and protocol error
> logging.

Looks like all my comments at
https://lore.kernel.org/r/20241010190726.GA570880@bhelgaas still
apply.

URL broken across lines, distracting timestamps, patch subjects,
no clue about the base commit.

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2043.outbound.protection.outlook.com [40.107.237.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id BDBFC2C859;
	Tue,  8 Oct 2024 22:17:09 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=fail smtp.client-ip=40.107.237.43
ARC-Seal: i=2; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728425832; cv=fail; b=JuFiP+5DRE8uwA8D0pnDYA0FPpdtz6UDI2HpjnIdtlOyTM6Hhpor1xHAqWVFco19bcwHMAUSzDxIvfFeCaDfdZe9d+o64IWTxEWDSrpmLmhqvLdzcAo4i5hUQzwA13WIQLobB4Frl0S8OhPrnnBuUWVn6xPPSZ8qUdYRhuZ2vp4=
ARC-Message-Signature: i=2; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728425832; c=relaxed/simple;
	bh=riaH1Yr+nm6klnhj+xroZ3EyggBC4ZntJByd/BeMajo=;
	h=From:To:Subject:Date:Message-ID:MIME-Version:Content-Type; b=NXhwTxtuMGlzcTYivUPtmLumC/n8ajsdw3+thZrwNuOFbTwj4H84qg4Fia2UaIBrskf3Vsdme/iSiOSmEHtLwYWNWVV5nDt1ECTVjDVS/dYue+flLpLDn8eD6hrmjwsvrSSFceS4uAUTg88yTA4uXT+1nF3DNm4rD9ha9enlJck=
ARC-Authentication-Results: i=2; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com; spf=fail smtp.mailfrom=amd.com; dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b=LM+ZDg1A; arc=fail smtp.client-ip=40.107.237.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=amd.com
Authentication-Results: smtp.subspace.kernel.org; spf=fail smtp.mailfrom=amd.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=amd.com header.i=@amd.com header.b="LM+ZDg1A"
ARC-Seal: i=1; a=rsa-sha256; s=arcselector10001; d=microsoft.com; cv=none;
 b=nVy4sl89yGo1XMEwzt0z5wu3pF84WyW25sfqETXKZH/cSowx+ta93FxXLdrRyNfDw3k3btA9H6b6HIGEQBupVSWd6FXM6PW2N5F5K38i4Smf4jbRKDkh9Y/MReoiT2MqT+ZWnZY+s/AtQB8emPJh5uvFQlCqiLeh5drTtVm354nPFiYWjggvcNz4OvtlssuQ24cWa8+y96i4P5G+4FqKbUNepFRmaOHT5zvPPye7x58Bl1DC+Ol6CDz8Tgc+5XEwDHXIiqfLz4Wc99PUGvPhaBR0q0ut1PDP8Beb8IwL3EEbRNK0eMzsvYaRsW++2ZUfwT5Gbl8ueFg0XmWY8qkw8Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector10001;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=oxtFjGCAJFjFkboF9hIlXGZMAMO50hX0GdXXxTaztKE=;
 b=NWzTQRYHtTDmVd/0p9UbTHGCw2dVHDVc43K2asuaOANF+cYqV5eIlG5ZAoRXHYE8UNYCpmIFuQ/f4Go5h5R4kGnf3T2XLcmkLoqqEELlrC45nCD8j8jO8q2y6nf4/yPpgyma3cNcfkipHO2TgeNZX1qIHC9B7xT98UPwavTK8nDeDUzVQHNF/NmI0fCLKhGVQJYeXvFEsq4xA7shh125aJzMxyLxhWTR+Coyw3ZdfqM21z8AKvuAP8/kBBScOqEH1BjPqff5pfEkc11EGrEhCHpd3BwdjM3iyQR0SmnoMG6DsUF7P58psAwk7YA4sZMrOvckjHfa2/qPpireflRquQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none (0)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=oxtFjGCAJFjFkboF9hIlXGZMAMO50hX0GdXXxTaztKE=;
 b=LM+ZDg1A5VW89aJYCFMZc+HulYSIWG/y58EpO9SjWD6OVOkv5lQNIvyguv3yuGcgaQTqOFMyCKIBOQHyGxCyiD13ZWFP5EeMoBkkioY9HmwZ2mgg3y5Q/tylH2xft+bvvllP7ogdnXNNoc3b95JTOlRgJrc2H4VC0U8CcLQjguE=
Received: from MN2PR15CA0052.namprd15.prod.outlook.com (2603:10b6:208:237::21)
 by SJ0PR12MB8616.namprd12.prod.outlook.com (2603:10b6:a03:485::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.24; Tue, 8 Oct
 2024 22:17:04 +0000
Received: from BN3PEPF0000B075.namprd04.prod.outlook.com
 (2603:10b6:208:237:cafe::7d) by MN2PR15CA0052.outlook.office365.com
 (2603:10b6:208:237::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.8026.23 via Frontend
 Transport; Tue, 8 Oct 2024 22:17:04 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; dkim=none (message not signed)
 header.d=none;dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com; pr=C
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN3PEPF0000B075.mail.protection.outlook.com (10.167.243.120) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.8048.13 via Frontend Transport; Tue, 8 Oct 2024 22:17:04 +0000
Received: from ethanolx7ea3host.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.39; Tue, 8 Oct
 2024 17:17:03 -0500
From: Terry Bowman <terry.bowman@amd.com>
To: <ming4.li@intel.com>, <linux-cxl@vger.kernel.org>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<dave@stgolabs.net>, <jonathan.cameron@huawei.com>, <dave.jiang@intel.com>,
	<alison.schofield@intel.com>, <vishal.l.verma@intel.com>,
	<dan.j.williams@intel.com>, <bhelgaas@google.com>, <mahesh@linux.ibm.com>,
	<oohall@gmail.com>, <Benjamin.Cheatham@amd.com>, <rrichter@amd.com>,
	<nathan.fontenot@amd.com>, <smita.koralahallichannabasappa@amd.com>,
	<terry.bowman@amd.com>
Subject: [PATCH 0/15] Enable CXL PCIe port protocol error handling and logging
Date: Tue, 8 Oct 2024 17:16:42 -0500
Message-ID: <20241008221657.1130181-1-terry.bowman@amd.com>
X-Mailer: git-send-email 2.34.1
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Type: text/plain
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN3PEPF0000B075:EE_|SJ0PR12MB8616:EE_
X-MS-Office365-Filtering-Correlation-Id: d53620de-1392-49ed-b3a2-08dce7e6f070
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: 
	BCL:0;ARA:13230040|1800799024|7416014|376014|36860700013|82310400026|921020;
X-Microsoft-Antispam-Message-Info: 
	=?us-ascii?Q?P+PiHEFvI07/o1InX9wvpdX0xpyDKtYO+s2f85RtBjVdiwIczrxx2+CrYCwP?=
 =?us-ascii?Q?EIdNhsc7UIpRpYeC6a0IwY5w1bqzp9MGIy0ixkBaVrURvjgCCcMwXboBu+cA?=
 =?us-ascii?Q?CoryIoc/eKzo4EurtyjtJOT/SqYb83EkVHlgpGmZtwev+zt4a0SVnnaRr1f2?=
 =?us-ascii?Q?3+tvXxqqBCgKKAdU2IPGB9mqaXmUACZHyhsefUGcV4o8jxV8efh1IgEwlVOB?=
 =?us-ascii?Q?n8DP1l9rIy+QzyWYsBLM/prBpxtVBQllhrRoGyJonqHZPRayXVts4yhAQAB8?=
 =?us-ascii?Q?r0L5nvQp3+O8DRJDlGcjrBH/WEAuLKETXRlw9OsDZVD7pQ+vffBtqSnF71WO?=
 =?us-ascii?Q?/Q+ZbklTx41aLnbybepBsXnFrzdKOK2MSFAr/5Cxpmwx87xW6AKqw5fAMVls?=
 =?us-ascii?Q?6HrC6OXJ1WTsKiTpqEdEAOg5SoExy0cjPNTLYUueaG3uOU6SjumK6lCXjinU?=
 =?us-ascii?Q?4fXm86FAflMH6VDSd3+LnugsDldBNNQS5VGz2RBX93jbqa1VOiqYAQWrnMoG?=
 =?us-ascii?Q?2FaaNJXJF1qF7lJHQtQGRmaXhkJIfJbZVUCJboSTd8WONgkH130Vffi/8tMI?=
 =?us-ascii?Q?V906buqAxMtQl8SFbkVoQA09xbiB2/nxt4KNDS6Rp/CvRMGVi7TDIZw2cENw?=
 =?us-ascii?Q?jAdvCl9eSuBnrp20jUy+6gA6WocSIF6B3Xq89g9my+nLHli5gRGccKsV8aQq?=
 =?us-ascii?Q?QW1O2yGRsGPW/39Fgg4upxFAm6k911hC1l8Xo8O//cJE+DAyXsiW5PghvkUL?=
 =?us-ascii?Q?yEZa/2dJZZtZUw9iO63vLnhAqLwneK6fyiSXlZQwwVMq/ZBHiwGRP7pyGQbh?=
 =?us-ascii?Q?Yl3Gx38JCIwSSPEJwsHVdf4P0Vag4CbRJq2pmZK0n/kKCnuO0IPZn1/owWx2?=
 =?us-ascii?Q?x1gdYMYDaKxT5uLNc/cRZPGRIcSxLUYTTUpStCBJ8NXawlTNNML53iKaPu9K?=
 =?us-ascii?Q?rYJqAyvQpgkzFfM044gaYC1+bQVX/AyO/mNxxFfeLxZGsOnwstY1EZ5DGCWU?=
 =?us-ascii?Q?eCYMjL3nPw7oq2WfTo+l6EWRFnBemkfKWjERencs15M8/cTLYnWCunyl0i9s?=
 =?us-ascii?Q?Et4at3IO73DkWNXqPpHQKrQJcFdL1OajxRBZAKGXw767cGKFl20sHeBifHQ8?=
 =?us-ascii?Q?eEHXLjDV52mDTlNi3NbiMxjEvrjLmh3TPIRNXPaXkE63a3iYU/nI4mQhxeld?=
 =?us-ascii?Q?AlXl/YvKqkVdY4453NXJqTnsFJWSdcKqFu5Q0N+JZXOZP0JQVNVObL9LFKC+?=
 =?us-ascii?Q?G4rFr9145HbX2uceJeBAgeNVdQSXgAmeniV8yPGlwE49td8VSS0xsPV07Me5?=
 =?us-ascii?Q?uRJteobavMwwXMCiNNDX/QCSkeOz7ie3EwYV8FVbAVpzeEJnQRBT4sK4xgFH?=
 =?us-ascii?Q?9OQph2mcN275jJ41xCvGxGCCa5UQtNTnDYk35iDwJolPvnTmSA=3D=3D?=
X-Forefront-Antispam-Report: 
	CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(13230040)(1800799024)(7416014)(376014)(36860700013)(82310400026)(921020);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Oct 2024 22:17:04.1554
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: d53620de-1392-49ed-b3a2-08dce7e6f070
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: 
	BN3PEPF0000B075.namprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR12MB8616
Status: RO
Content-Length: 13024
Lines: 221

This is a continuation of the CXL port error handling RFC from earlier.[1]
The RFC resulted in the decision to add CXL PCIe port error handling to
the existing RCH downstream port handling. This patchset adds the CXL PCIe
port handling and logging.

The first 7 patches update the existing AER service driver to support CXL
PCIe port protocol error handling and reporting. This includes AER service
driver changes for adding correctable and uncorrectable error support, CXL
specific recovery handling, and addition of CXL driver callback handlers.

The following 8 patches address CXL driver support for CXL PCIe port
protocol errors. This includes the following changes to the CXL drivers:
mapping CXL port and downstream port RAS registers, interface updates for
common RCH and VH, adding port specific error handlers, and protocol error
logging.

[1] - https://lore.kernel.org/linux-cxl/20240617200411.1426554
-1-terry.bowman@amd.com/

Testing:

Below are test results for this patchset. This is using Qemu with a root
port (0c:00.0), upstream switch port (0d:00.0),and downstream switch port
(0e:00.0).

This was tested using aer-inject updated to support CE and UCE internal
error injection. CXL RAS was set using a test patch (not upstreamed).

    Root port UCE:
    root@tbowman-cxl:~/aer-inject# ./root-uce-inject.sh
    [   27.318920] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0c:00.0
    [   27.320164] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0c:00.0
    [   27.321518] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
    [   27.322483] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00400000/02000000
    [   27.323243] pcieport 0000:0c:00.0:    [22] UncorrIntErr
    [   27.325584] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
    [   27.325584]
    [   27.327171] cxl_port_aer_uncorrectable_error: device=0000:0c:00.0 host=pci0000:0c status: 'Memory Address Parity Error'
    first_error: 'Memory Address Parity Error'
    [   27.333277] Kernel panic - not syncing: CXL cachemem error. Invoking panic
    [   27.333872] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3857
    [   27.334761] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
    [   27.335716] Call Trace:
    [   27.335985]  <TASK>
    [   27.336226]  panic+0x2ed/0x320
    [   27.336547]  ? __pfx_cxl_report_normal_detected+0x10/0x10
    [   27.337037]  ? __pfx_aer_root_reset+0x10/0x10
    [   27.337453]  cxl_do_recovery+0x304/0x310
    [   27.337833]  aer_isr+0x3fd/0x700
    [   27.338154]  ? __pfx_irq_thread_fn+0x10/0x10
    [   27.338572]  irq_thread_fn+0x1f/0x60
    [   27.338923]  irq_thread+0x102/0x1b0
    [   27.339267]  ? __pfx_irq_thread_dtor+0x10/0x10
    [   27.339683]  ? __pfx_irq_thread+0x10/0x10
    [   27.340059]  kthread+0xcd/0x100
    [   27.340387]  ? __pfx_kthread+0x10/0x10
    [   27.340748]  ret_from_fork+0x2f/0x50
    [   27.341100]  ? __pfx_kthread+0x10/0x10
    [   27.341466]  ret_from_fork_asm+0x1a/0x30
    [   27.341842]  </TASK>
    [   27.342281] Kernel Offset: 0x1ba00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
    [   27.343221] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---

    Root port CE:
    root@tbowman-cxl:~/aer-inject# ./root-ce-inject.sh
    [   19.444339] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0c:00.0
    [   19.445530] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0c:00.0
    [   19.446750] pcieport 0000:0c:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
    [   19.447742] pcieport 0000:0c:00.0:   device [8086:7075] error status/mask=00004000/0000a000
    [   19.448549] pcieport 0000:0c:00.0:    [14] CorrIntErr
    [   19.449223] aer_event: 0000:0c:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
    [   19.449223]
    [   19.451415] cxl_port_aer_correctable_error: device=0000:0c:00.0 host=pci0000:0c status='Received Error From Physical Layer'

    Upstream switch port UCE:
    root@tbowman-cxl:~/aer-inject# ./us-uce-inject.sh
    [   45.236853] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0d:00.0
    [   45.238101] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0d:00.0
    [   45.239416] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
    [   45.240412] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00400000/02000000
    [   45.241159] pcieport 0000:0d:00.0:    [22] UncorrIntErr
    [   45.242448] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
    [   45.242448]
    [   45.244008] cxl_port_aer_uncorrectable_error: device=0000:0d:00.0 host=0000:0c:00.0 status: 'Memory Address Parity Error'
    first_error: 'Memory Address Parity Error'
    [   45.249129] Kernel panic - not syncing: CXL cachemem error. Invoking panic
    [   45.249800] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g1fb9097c3728 #3855
    [   45.250795] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
    [   45.251907] Call Trace:
    [   45.253284]  <TASK>
    [   45.253564]  panic+0x2ed/0x320
    [   45.253909]  ? __pfx_cxl_report_normal_detected+0x10/0x10
    [   45.255455]  ? __pfx_aer_root_reset+0x10/0x10
    [   45.255915]  cxl_do_recovery+0x304/0x310
    [   45.257219]  aer_isr+0x3fd/0x700
    [   45.257572]  ? __pfx_irq_thread_fn+0x10/0x10
    [   45.258006]  irq_thread_fn+0x1f/0x60
    [   45.258383]  irq_thread+0x102/0x1b0
    [   45.258748]  ? __pfx_irq_thread_dtor+0x10/0x10
    [   45.259196]  ? __pfx_irq_thread+0x10/0x10
    [   45.259605]  kthread+0xcd/0x100
    [   45.259956]  ? __pfx_kthread+0x10/0x10
    [   45.260386]  ret_from_fork+0x2f/0x50
    [   45.260879]  ? __pfx_kthread+0x10/0x10
    [   45.261418]  ret_from_fork_asm+0x1a/0x30
    [   45.261936]  </TASK>
    [   45.262451] Kernel Offset: 0xc600000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
    [   45.263467] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---

    Upstream switch port CE:
    root@tbowman-cxl:~/aer-inject# ./us-ce-inject.sh 
    [   37.504029] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0d:00.0
    [   37.506076] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0d:00.0
    [   37.507599] pcieport 0000:0d:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
    [   37.508759] pcieport 0000:0d:00.0:   device [19e5:a128] error status/mask=00004000/0000a000
    [   37.509574] pcieport 0000:0d:00.0:    [14] CorrIntErr            
    [   37.510180] aer_event: 0000:0d:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
    [   37.510180] 
    [   37.512057] cxl_port_aer_correctable_error: device=0000:0d:00.0 host=0000:0c:00.0 status='Received Error From Physical Layer'

    Downstream switch port UCE:
    root@tbowman-cxl:~/aer-inject# ./ds-uce-inject.sh
    [   29.421532] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00000000/00400000 into device 0000:0e:00.0
    [   29.422812] pcieport 0000:0c:00.0: AER: Uncorrectable (Fatal) error message received from 0000:0e:00.0
    [   29.424551] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Uncorrectable (Fatal), type=Transaction Layer, (Receiver ID)
    [   29.425670] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00400000/02000000
    [   29.426487] pcieport 0000:0e:00.0:    [22] UncorrIntErr
    [   29.427111] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Fatal, Uncorrectable Internal Error, TLP Header=Not available
    [   29.427111]
    [   29.428688] cxl_port_aer_uncorrectable_error: device=0000:0e:00.0 host=0000:0d:00.0 status: 'Memory Address Parity Error'
    first_error: 'Memory Address Parity Error'
    [   29.430173] Kernel panic - not syncing: CXL cachemem error. Invoking panic
    [   29.430862] CPU: 12 UID: 0 PID: 122 Comm: irq/24-aerdrv Not tainted 6.11.0-rc1-port-error-g844fd2319372 #3851
    [   29.431874] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
    [   29.433031] Call Trace:
    [   29.433354]  <TASK>
    [   29.433631]  panic+0x2ed/0x320
    [   29.434010]  ? __pfx_cxl_report_normal_detected+0x10/0x10
    [   29.434653]  ? __pfx_aer_root_reset+0x10/0x10
    [   29.435179]  cxl_do_recovery+0x304/0x310
    [   29.435626]  aer_isr+0x3fd/0x700
    [   29.436027]  ? __pfx_irq_thread_fn+0x10/0x10
    [   29.436507]  irq_thread_fn+0x1f/0x60
    [   29.436898]  irq_thread+0x102/0x1b0
    [   29.437293]  ? __pfx_irq_thread_dtor+0x10/0x10
    [   29.437758]  ? __pfx_irq_thread+0x10/0x10
    [   29.438189]  kthread+0xcd/0x100
    [   29.438551]  ? __pfx_kthread+0x10/0x10
    [   29.438959]  ret_from_fork+0x2f/0x50
    [   29.439362]  ? __pfx_kthread+0x10/0x10
    [   29.439771]  ret_from_fork_asm+0x1a/0x30
    [   29.440221]  </TASK>
    [   29.440738] Kernel Offset: 0x10a00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
    [   29.441812] ---[ end Kernel panic - not syncing: CXL cachemem error. Invoking panic ]---

    Downstream switch port CE:
    root@tbowman-cxl:~/aer-inject# ./ds-ce-inject.sh
    [  177.114442] pcieport 0000:0c:00.0: aer_inject: Injecting errors 00004000/00000000 into device 0000:0e:00.0
    [  177.115602] pcieport 0000:0c:00.0: AER: Correctable error message received from 0000:0e:00.0
    [  177.116973] pcieport 0000:0e:00.0: PCIe Bus Error: severity=Correctable, type=Transaction Layer, (Receiver ID)
    [  177.117985] pcieport 0000:0e:00.0:   device [19e5:a129] error status/mask=00004000/0000a000
    [  177.118809] pcieport 0000:0e:00.0:    [14] CorrIntErr
    [  177.119521] aer_event: 0000:0e:00.0 PCIe Bus Error: severity=Corrected, Corrected Internal Error, TLP Header=Not available
    [  177.119521]
    [  177.122037] cxl_port_aer_correctable_error: device=0000:0e:00.0 host=0000:0d:00.0 status='Received Error From Physical Layer'

Changes RFC->v1:
 [Dan] Rename cxl_rch_handle_error() becomes cxl_handle_error()
 [Dan] Add cxl_do_recovery()
 [Jonathan] Flatten cxl_setup_parent_uport()
 [Jonathan] Use cxl_component_regs instead of struct cxl_regs regs
 [Jonathan] Rename cxl_dev_is_pci_type()
 [Ming] bus_find_device(&cxl_bus_type, NULL, &pdev->dev, match_uport) can
 replace these find_cxl_port() and device_find_child().
 [Jonathan] Compact call to cxl_port_map_regs() in cxl_setup_parent_uport()
 [Ming] Dont use endpoint as host to cxl_map_component_regs()
 [Bjorn] Use "PCIe UIR/CIE" instesad of "AER UI/CIE"
 [TODO][Bjorn] Dont use Kconfig to enable/disable a CXL external interface

Terry Bowman (15):
  cxl/aer/pci: Add CXL PCIe port error handler callbacks in AER service
    driver
  cxl/aer/pci: Update is_internal_error() to be callable w/o
    CONFIG_PCIEAER_CXL
  cxl/aer/pci: Refactor AER driver's existing interfaces to support CXL
    PCIe ports
  cxl/aer/pci: Add CXL PCIe port correctable error support in AER
    service driver
  cxl/aer/pci: Update AER driver to read UCE fatal status for all CXL
    PCIe port devices
  cxl/aer/pci: Introduce PCI_ERS_RESULT_PANIC to pci_ers_result type
  cxl/aer/pci: Add CXL PCIe port uncorrectable error recovery in AER
    service driver
  cxl/pci: Change find_cxl_ports() to be non-static
  cxl/pci: Map CXL PCIe downstream port RAS registers
  cxl/pci: Map CXL PCIe upstream port RAS registers
  cxl/pci: Update RAS handler interfaces to support CXL PCIe ports
  cxl/pci: Add error handler for CXL PCIe port RAS errors
  cxl/pci: Add trace logging for CXL PCIe port RAS errors
  cxl/aer/pci: Export pci_aer_unmask_internal_errors()
  cxl/pci: Enable internal CE/UCE interrupts for CXL PCIe port devices

 drivers/cxl/core/core.h  |   3 +
 drivers/cxl/core/pci.c   | 172 +++++++++++++++++++++++++++++++--------
 drivers/cxl/core/port.c  |   4 +-
 drivers/cxl/core/trace.h |  47 +++++++++++
 drivers/cxl/cxl.h        |  14 +++-
 drivers/cxl/mem.c        |  30 ++++++-
 drivers/cxl/pci.c        |   8 ++
 drivers/pci/pci.h        |   5 ++
 drivers/pci/pcie/aer.c   | 123 ++++++++++++++++++++--------
 drivers/pci/pcie/err.c   | 150 ++++++++++++++++++++++++++++++++++
 include/linux/aer.h      |  16 ++++
 include/linux/pci.h      |   3 +
 12 files changed, 503 insertions(+), 72 deletions(-)


base-commit: f7982d85e136ba7e26b31a725c1841373f81f84a
-- 
2.34.1


