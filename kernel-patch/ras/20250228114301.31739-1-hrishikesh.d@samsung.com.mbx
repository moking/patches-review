From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f179.google.com (mail-pl1-f179.google.com [209.85.214.179])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2913B2356C0;
	Mon,  3 Mar 2025 20:00:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.179
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741032060; cv=none; b=OIT0UhityM/yw2MeG1arjRVYEzNAL04vHzNFvf6e0Kt37GSGdZQDzk2Tae4II0hNaYvY2W8+E/dR6qAn3kKl+fXfvsm72drm3CprfMDEZhg1xys5MV2yDYe3ki96Tz8ot0VcNNrTT6NVWbokGViQA2Z9Dh3GkMscXurp8Xh9eZo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741032060; c=relaxed/simple;
	bh=tT37Gvv9uhcGOPTFEOztOSnc1eG43/eY83F51iOT7SA=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=VV8MSMjO1xO9M46AyUJcXgTYZL/277eBJf3/MCXjDyHhFc9Y/poq6Ot6YkMxLg1Ls0UexeuIk/2F8tT5JcY0rR6n5oZtAvGe++c82DG1B6yYCwkv+Lgx6+zbqr6zFX+iSC3Xv5Nu4sgXiR4wd96VKBoaeBRgv/NRzpnURCbFjzc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.179
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f179.google.com with SMTP id d9443c01a7336-2234daaf269so64641335ad.3;
        Mon, 03 Mar 2025 12:00:58 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741032058; x=1741636858;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=DVlIeIIYEUcXVpBH0ZR2aYcLcX0jlCTjHLmqUh5GcV4=;
        b=jR/GkN8J0QSmBTLMm8A7fp3k9elaO/VKw9pp0eZErqAz6BZAtPe70kWb4551qBdgk9
         xVtMoFmv9jgYMqI4zsCpr0O+21dYukOTFSp3zpE3Z5leyuJ2p5eoKHja6sfCjBfXXv9c
         TH4BNlfhwYLi3F8X+fBqWvFcU2vaJVL5wPiMo4mc846+EJpys4wIIS4AR3J6hyKwtwiH
         DkHTa29A4dcTdZbPeZ51kj3r7FzAfSgbaGFVOOdjXtn6BQctinRbampFAlV5dTiutupU
         QSqgMwoTxUJW78rvjzJytUt5YTEYvmibvkl7b0HUULHucr4y6tGcR6CV9MmcF4964lEK
         9oaQ==
X-Forwarded-Encrypted: i=1; AJvYcCUoPiuppRt0HNU7j0zLoMMw4S+jzvn9YW71+TIEX0aGv/QbQ2OH3//gw9thNIYb+3hM8XbwYaTcTq8i@vger.kernel.org, AJvYcCWe+N0/NR6dC1Dm0raFD5uIpDSbh459OMoMUc9ppQucAjkjNdaPZD7b69wOPM24GnCON7F96a2ppmDjK9M=@vger.kernel.org, AJvYcCX2KuyQDdF2kV5Nj4nu2dB8MBDwpDxBFej24N40Ii25lagjVTKkmUA8irIt6SAlMpLcCb/4vSNUssLzlUa3XUWOZw==@vger.kernel.org
X-Gm-Message-State: AOJu0Yx9/6MEZtwApFshed7fz2fAoo4iP+BlgGkowHo4zB03UIKcpYv7
	XjDVzs0ZwHPY3+1Fi75U+4pU5ZBAj47SFsx+V8/+eU90olC2HQMF
X-Gm-Gg: ASbGncsBsQdMaWYtWA7e4X7+1WeLjHEC0MH4zpvMm+DNKLEkY6gMt9gpwYAQoq7WNQL
	65Z0TWowMhEC12lAFxrnjkxTlCkxpdiyf42RRme2+908ASrzcSpb/Zs3cayKt05XKoqoBUGPjWt
	nj6XtyIhQk2Etq1dQxSCfa436TOB2GYU+FEqs+vwmQdFgKDIe86xHCzgVDMGACYw24PNbWZUPx2
	x3tP+K6kTwb/HBxErerWDobs6CCpY/ndSZRBCEdlOR454qWnLS1yW+u7HGNLwlhWmcZQ7N/Gh8/
	yiiIN30GodLeY4rxcvOwRaodfzjcNQciKH4S8EOXdcCWND7oH+B1xSA/Lqb5bdNDcTg9lknM9F+
	n8N4=
X-Google-Smtp-Source: AGHT+IGknxLLIXBeT5c31Vvl+cZh8b06bZmuGqUJWYc+uYhvP7flXlsd/7jPzf+IyTyzNISceBSJ8Q==
X-Received: by 2002:a05:6a00:2d1d:b0:736:4536:26cc with SMTP id d2e1a72fcca58-73645362c6fmr10629091b3a.23.1741032058394;
        Mon, 03 Mar 2025 12:00:58 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d2e1a72fcca58-7363f2e8a34sm4076852b3a.168.2025.03.03.12.00.57
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 12:00:57 -0800 (PST)
Date: Tue, 4 Mar 2025 05:00:55 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Hrishikesh Deleep <hrishikesh.d@samsung.com>
Cc: shradha.t@samsung.com, 18255117159@163.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, bhelgaas@google.com, cassel@kernel.org,
	fan.ni@samsung.com, jingoohan1@gmail.com,
	linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-perf-users@vger.kernel.org,
	lpieralisi@kernel.org, manivannan.sadhasivam@linaro.org,
	mark.rutland@arm.com, nifan.cxl@gmail.com, pankaj.dubey@samsung.com,
	renyu.zj@linux.alibaba.com, robh@kernel.org, will@kernel.org,
	xueshuai@linux.alibaba.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250303200055.GA1881771@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250228114813epcas5p32127b99d3a0adf6900a104468b48768d@epcas5p3.samsung.com>
 <20250228114301.31739-1-hrishikesh.d@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250228114301.31739-1-hrishikesh.d@samsung.com>

Hello,

> Thanks for adding the support!
> 
> Tested the patch in one of our internal SoC with DesginWare PCIe controller. The patch works fine.

I assume this was for an entire series, not any specific patch.

> Tested-by: Hrishikesh Deleep <hrishikesh.d@samsung.com>

Thank you for testing!  I will add your tag to the current branch.

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout3.samsung.com (mailout3.samsung.com [203.254.224.33])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8A5871D79A3
	for <linux-perf-users@vger.kernel.org>; Mon,  3 Mar 2025 09:49:08 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.33
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740995352; cv=none; b=i5bBZkK9L5JLgCj/setME1GUzj4YL5nbaBywzBeiLDmXkPIF5zKFIGIwotKsTNAY+923+GHokr+3gI0A3IC33G228Zq3xzyAQ2vg4Ii3RqE84+ERvQm6LSJUglKvmPWj7SG3ZIU/byOPzl9SbzKqiLAkqDxeebwT1d2i7GAyCMg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740995352; c=relaxed/simple;
	bh=dBpyRD3Af4A+AiBhDTBakcxsh6+4fPaRYfan0doQJdg=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:MIME-Version:
	 Content-Type:References; b=bDgdgduJXEScOQgTWw0e60W9Al4E5ECvV4FWO6aPw/6ROWfN5zFrvDqRvZvQxbGA7gFaelhA4254GPdiPSoNaL6oQ4u7hSe3e2bmOBk/q3FG/gEY8dPy6O5bHQZlJgDpr02mlGmkZipBzolbcglXFzkBKo0swxKuXVPOQwqeCTY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=dVuqAp1W; arc=none smtp.client-ip=203.254.224.33
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="dVuqAp1W"
Received: from epcas5p4.samsung.com (unknown [182.195.41.42])
	by mailout3.samsung.com (KnoxPortal) with ESMTP id 20250303094900epoutp03d9781331c6d4676cca071bfa460d7fbf~pQgnUt1tp2019320193epoutp03I
	for <linux-perf-users@vger.kernel.org>; Mon,  3 Mar 2025 09:49:00 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout3.samsung.com 20250303094900epoutp03d9781331c6d4676cca071bfa460d7fbf~pQgnUt1tp2019320193epoutp03I
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740995340;
	bh=A6rXyxrSkX4HADIgbY5HWK2vNlIuc7WBXS7Zq+Ms0JI=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=dVuqAp1WcRurfwCGQ8t3Ms9B0fFGX3lOBlAO2BclgS0K8Ut60gawC/sPdJJsdv/BA
	 8XxQzamtIPPmg3t2AsL9LRe2aGV11+ZLZsophekOsA8n2Oby46Q2w5uvwEOreZF2zL
	 yWgL/qsVHPjVKkCZEdBtoHyK0g2wjPnG6Y8PPo3s=
Received: from epsnrtp2.localdomain (unknown [182.195.42.163]) by
	epcas5p2.samsung.com (KnoxPortal) with ESMTP id
	20250303094900epcas5p20c3abf562a30579b79a224889f449ef3~pQgmoK8Wm2511625116epcas5p28;
	Mon,  3 Mar 2025 09:49:00 +0000 (GMT)
Received: from epsmgec5p1new.samsung.com (unknown [182.195.38.174]) by
	epsnrtp2.localdomain (Postfix) with ESMTP id 4Z5vCY4lGHz4x9Q0; Mon,  3 Mar
	2025 09:48:57 +0000 (GMT)
Received: from epcas5p4.samsung.com ( [182.195.41.42]) by
	epsmgec5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	6A.54.19710.90B75C76; Mon,  3 Mar 2025 18:48:57 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTPA id
	20250228114813epcas5p32127b99d3a0adf6900a104468b48768d~oXM1p_I5X0606706067epcas5p39;
	Fri, 28 Feb 2025 11:48:13 +0000 (GMT)
Received: from epsmgmcp1.samsung.com (unknown [182.195.42.82]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250228114813epsmtrp2153ec45f033bf4373aece964cf49075a~oXM1pBsIZ2226522265epsmtrp2e;
	Fri, 28 Feb 2025 11:48:13 +0000 (GMT)
X-AuditID: b6c32a44-363dc70000004cfe-0b-67c57b09f171
Received: from epsmtip1.samsung.com ( [182.195.34.30]) by
	epsmgmcp1.samsung.com (Symantec Messaging Gateway) with SMTP id
	77.F6.33707.D72A1C76; Fri, 28 Feb 2025 20:48:13 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip1.samsung.com (KnoxPortal) with ESMTPA id
	20250228114810epsmtip1d1899f45fb2e472c25ba58375dd1b3b5~oXMyy6Y-Z1263712637epsmtip1y;
	Fri, 28 Feb 2025 11:48:10 +0000 (GMT)
From: Hrishikesh Deleep <hrishikesh.d@samsung.com>
To: shradha.t@samsung.com
Cc: 18255117159@163.com, Jonathan.Cameron@Huawei.com,
	a.manzanares@samsung.com, bhelgaas@google.com, cassel@kernel.org,
	fan.ni@samsung.com, jingoohan1@gmail.com, kw@linux.com,
	linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-perf-users@vger.kernel.org,
	lpieralisi@kernel.org, manivannan.sadhasivam@linaro.org,
	mark.rutland@arm.com, nifan.cxl@gmail.com, pankaj.dubey@samsung.com,
	renyu.zj@linux.alibaba.com, robh@kernel.org, will@kernel.org,
	xueshuai@linux.alibaba.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Date: Fri, 28 Feb 2025 17:13:01 +0530
Message-Id: <20250228114301.31739-1-hrishikesh.d@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrOJsWRmVeSWpSXmKPExsWy7bCmli5n9dF0g6tnlC2utP9mt5h+WNFi
	SVOGxbEJK5gtmlbfZbVY8WUmu8WqhdfYLBp6frNabHp8jdXi8q45bBZn5x1ns7iydR2LRcuf
	FhaLuy2drBZLr19ksvi7bS+jxaKtX9gtFja/ZLT4v2cHu0Xv4VqLljumFu9/bmZzEPNYvGIK
	q8eaeWsYPXbOusvusWBTqUfLkbesHptWdbJ53Lm2h81j50NLjydXpjN5bF5S79G3ZRWjx+dN
	cgE8Udk2GamJKalFCql5yfkpmXnptkrewfHO8aZmBoa6hpYW5koKeYm5qbZKLj4Bum6ZOUDf
	KimUJeaUAoUCEouLlfTtbIryS0tSFTLyi0tslVILUnIKTAr0ihNzi0vz0vXyUkusDA0MjEyB
	ChOyMzZdecxWcMi5Yvr++AbGxVZdjJwcEgImElfXvmTvYuTiEBLYzSix/MglKOcTo8SmpScY
	QarAnL0flGE6Dkz5yARRtJNRouXKDxYI5wujxNzW7SwgVWwCRhLfmvaC2SICkhJf+trAOpgF
	prNIfFn5khkkISwQJvHv5w0wm0VAVeLJqU9gDbwCthJz248zQqyTl1i94QBYDaeAtcSqc9OZ
	IGoEJU7OfAJWzwxU07x1NjPIAgmBfk6Jl7/bmCCaXSQ2vT3KBmELS7w6voUdwpaS+PxuL1Q8
	W2LPoetQywokljQ8g6qxlzhwZQ7QAg6gBZoS63fpQ4RlJaaeWscEsZdPovf3E6hVvBI75sHY
	ahKvZ09khbBlJC7NWswCYXtIzJm0GRq+fYwS2x48YZnAqDALyT+zkPwzC2H1AkbmVYySqQXF
	uempyaYFhnmp5fBYTs7P3cQIzgFaLjsYb8z/p3eIkYmD8RCjBAezkghvYdCRdCHelMTKqtSi
	/Pii0pzU4kOMpsAAn8gsJZqcD8xCeSXxhiaWBiZmZmYmlsZmhkrivM07W9KFBNITS1KzU1ML
	Uotg+pg4OKUamLL47RhrX++ostmTZ+vcdetqu8P8CsP6M+V1ca7BsdNu8D8Qdvg5V2djyZKt
	DSYqOdp7JC6eOWfNb5gQtPhBIKel+6fHLzku7mxkW/n3yH//CWcuXk6dkKPeNoexvnvXfePs
	L+mTo3fskfw4/ZR6+np21ftqEs8SxZneRWbt3/r+66Ekv2N5AjK/e5cGfva9Kvpz1UnF5adl
	gvZNFAlR9OeJVek4PKOh/1nQVMNbc6fWf9Vie6+wjHvrzpBXUqEfGz7suyqyyK3swPJLbrYX
	+9xW6ji/WRBRo77Yb71irXrwYr607GfJ71a0h7Vav3a7lyc5y+t97ocDfK7TIkybbus9zD40
	KbjZoeX9lSmXg5RYijMSDbWYi4oTAWfWAtSKBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrAIsWRmVeSWpSXmKPExsWy7bCSnG7tooPpBodPcllcaf/NbjH9sKLF
	kqYMi2MTVjBbNK2+y2qx4stMdotVC6+xWTT0/Ga12PT4GqvF5V1z2CzOzjvOZnFl6zoWi5Y/
	LSwWd1s6WS2WXr/IZPF3215Gi0Vbv7BbLGx+yWjxf88Odovew7UWLXdMLd7/3MzmIOaxeMUU
	Vo8189YweuycdZfdY8GmUo+WI29ZPTat6mTzuHNtD5vHzoeWHk+uTGfy2Lyk3qNvyypGj8+b
	5AJ4orhsUlJzMstSi/TtErgyNl15zFZwyLli+v74BsbFVl2MnBwSAiYSB6Z8ZOpi5OIQEtjO
	KHHn1hVWiISMxNV1J9kgbGGJlf+es0MUfWKUeLJpITNIgk3ASOJb014WEFtEQFLiS18b2CRm
	gfUsElvOPQRLCAuESOyetglsKouAqsSTU5/A4rwCthJz248zQmyQl1i94QDYUE4Ba4lV56Yz
	gdhCAlYSe7bcZ4WoF5Q4OfMJUC8H0AJ1ifXzhEDCzECtzVtnM09gFJyFpGoWQtUsJFULGJlX
	MYqmFhTnpucmFxjqFSfmFpfmpesl5+duYgRHslbQDsZl6//qHWJk4mA8xCjBwawkwjsr9kC6
	EG9KYmVValF+fFFpTmrxIUZpDhYlcV7lnM4UIYH0xJLU7NTUgtQimCwTB6dUA1NLy8WShiQ+
	Zt0fgcZli7dz8/66ou6yScjil83rMxp5+89MvhoqdfrnrMNND7OZ3x2xOFi2cPZLa2NBybVG
	Yn+59HSbGDmOdDvOfxi4yJf1/R9H9jdy244lTb+5fe6Vkoeis1x1XzPMWDN1Qb3J2cP/eVf4
	fFZ6ffMmb6jMxdqqFd+L1Xl/3pFX/MHpEHhTu27lxM5Pql2z7LmNW06YlH/8vIXx96Gik3MX
	vGPTub1sq8Wl38dsWLj4had1qByQrc4xKHY5+uR//U7WGR785yK/LZjlplMoLZQ9a7ZHHs/+
	IkODiEl+M/cvf35RbGGq/nJ9oZWn2OR/Rj2ZWP1S9B6ba9jZm+xiS41ipyrfWz1TiaU4I9FQ
	i7moOBEALB5gqlMDAAA=
X-CMS-MailID: 20250228114813epcas5p32127b99d3a0adf6900a104468b48768d
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250228114813epcas5p32127b99d3a0adf6900a104468b48768d
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250228114813epcas5p32127b99d3a0adf6900a104468b48768d@epcas5p3.samsung.com>

>Subject: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
> PCIe DW
>Date: Fri, 21 Feb 2025 18:45:43 +0530
>Message-Id: <20250221131548.59616-1-shradha.t@samsung.com>
>X-Mailer: git-send-email 2.17.1
>Precedence: bulk
>X-Mailing-List: linux-kernel@vger.kernel.org
>List-Id: <linux-kernel.vger.kernel.org>
>List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
>List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
>MIME-Version: 1.0
>Content-Transfer-Encoding: 8bit
>X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrBJsWRmVeSWpSXmKPExsWy7bCmum7f2p3pBpev8Fhcaf/NbjH9sKLF
>	kqYMi2MTVjBbNK2+y2qx4stMdotVC6+xWTT0/Ga12PT4GqvF5V1z2CzOzjvOZnFl6zoWi5Y/
>	LSwWd1s6WS2WXr/IZPF3215Gi0Vbv7BbLGx+yWjxf88Odovew7UWLXdMLd7/3MzmIOaxeMUU
>	Vo8189YweuycdZfdY8GmUo+WI29ZPTat6mTzuHNtD5vHzoeWHk+uTGfy2Lyk3qNvyypGj8+b
>	5AJ4orJtMlITU1KLFFLzkvNTMvPSbZW8g+Od403NDAx1DS0tzJUU8hJzU22VXHwCdN0yc4C+
>	VVIoS8wpBQoFJBYXK+nb2RTll5akKmTkF5fYKqUWpOQUmBToFSfmFpfmpevlpZZYGRoYGJkC
>	FSZkZ9w5vYalYLZqxYb7X5gaGB/IdjFyckgImEi83vKXqYuRi0NIYDejxLsX7UwgCSGBT4wS
>	u6dkQySA7IMTF7PDdKyZ08QKkdjJKHFn3nso5wujxL2+j2BVbAJaEo1fu5hBbBGBVkaJI8/E
>	QIqYBbYxSxxYsQIsISwQJPFjXRsLiM0ioCrx/e98oGYODl4BK4k9K+0htslLrN5wAKycV0BQ
>	4uTMJ2DlzEDx5q2zmSFqvnBIfJnNB2G7SCzadQPqUmGJV8e3QNlSEp/f7WWDsNMlVm6eAdWb
>	I/Ft8xImCNte4sCVOSwgJzALaEqs36UPEZaVmHpqHRPEWj6J3t9PoMp5JXbMg7GVJb783cMC
>	YUtKzDt2mRXC9pDYufkh2EghgViJ/v+2ExjlZyF5ZhaSZ2YhLF7AyLyKUTK1oDg3PTXZtMAw
>	L7UcHq3J+bmbGMFJXstlB+ON+f/0DjEycTAeYpTgYFYS4dUt2ZEuxJuSWFmVWpQfX1Sak1p8
>	iNEUGMATmaVEk/OBeSavJN7QxNLAxMzMzMTS2MxQSZy3eWdLupBAemJJanZqakFqEUwfEwen
>	VAOTyWph2UVGD0z1j0+NvfvEdnGQ413ON1OnCFx4vMfJeqvN3Mp7Kx86NXwKsN+sdkziZXTt
>	kesTTnswSfQ/W1W2UrvUr+Mf14yGGbL9V1cY802NfhC1Su7CI57OFPH5lz5En/srKjG9MXbJ
>	wbvLF2vMuPtkX2nEE4bFtdvOlN1YvEY1xMF6apLnj5CG0sSSXn3PgKUsajzVWQ/TfU7n/lD5
>	bfjrwVJLhqPcRqoTSkq8zi29HTM1wO3dCcNfq6we9H4Sbrx8ef67MN+3L8NLzveyuAo5iV1+
>	s8+BVbngfu6khvO+c9YriUadC2QxkJvBY3eiVHQx3yuDqBXzeubVRsnkfzzpt9tl19/cGTOv
>	1GuzKrEUZyQaajEXFScCAMosolJ7BAAA
>X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrJIsWRmVeSWpSXmKPExsWy7bCSvG537Y50g2MLlC2utP9mt5h+WNFi
>	SVOGxbEJK5gtmlbfZbVY8WUmu8WqhdfYLBp6frNabHp8jdXi8q45bBZn5x1ns7iydR2LRcuf
>	FhaLuy2drBZLr19ksvi7bS+jxaKtX9gtFja/ZLT4v2cHu0Xv4VqLljumFu9/bmZzEPNYvGIK
>	q8eaeWsYPXbOusvusWBTqUfLkbesHptWdbJ53Lm2h81j50NLjydXpjN5bF5S79G3ZRWjx+dN
>	cgE8UVw2Kak5mWWpRfp2CVwZd06vYSmYrVqx4f4XpgbGB7JdjJwcEgImEmvmNLF2MXJxCAls
>	Z5Q4cm4FE0RCUuLzxXVQtrDEyn/P2SGKPjFKnLi3HyzBJqAl0fi1ixkkISLQySix98g7sCpm
>	gXPMEjM/tzCCVAkLBEicWbwezGYRUJX4/nc+UBEHB6+AlcSelfYQG+QlVm84wAxi8woISpyc
>	+YQFpIRZQF1i/TwhkDAzUEnz1tnMExj5ZyGpmoVQNQtJ1QJG5lWMoqkFxbnpuckFhnrFibnF
>	pXnpesn5uZsYwbGpFbSDcdn6v3qHGJk4GA8xSnAwK4nw6pbsSBfiTUmsrEotyo8vKs1JLT7E
>	KM3BoiTOq5zTmSIkkJ5YkpqdmlqQWgSTZeLglGpg4pjMtu2b3EL3R9/vnl2nEvFC55TM2YSA
>	my6J94qZeTt8782a/COa5zfzt5k3prcfseJ7luLkekH78Adlm03yN7mZkk1XMM56/M3uTPar
>	ex8KP295FMh6s2nhnKm/5osxdX5TKq3b61nX9iT1YXNdyKerQsdqYjgT+VaEJK99GX3A6He8
>	1XIWZ2vz9ffnsnQutJ2jtMajR/n7bM0NmbNmena/SZXhnfzD5alN2PFWrd0vK8Je8Blf3/b1
>	x9bwBX5/Yl/s/XhNzGKZrer2uvBbUQqvGNOWb17bYhX/xT3W2q3tpEjcHY7SxiIpxtc63+us
>	rinukH9y8IUFl3ej4vrW9/u/5z0wPMPHsW9quEntZSWW4oxEQy3mouJEAI4aFoM8AwAA
>X-CMS-MailID: 20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5
>X-Msg-Generator: CA
>Content-Type: text/plain; charset="utf-8"
>X-Sendblock-Type: REQ_APPROVE
>CMS-TYPE: 105P
>DLP-Filter: Pass
>X-CFilter-Loop: Reflected
>X-CMS-RootMailID: 20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5
>References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
>
>DesignWare controller provides a vendor specific extended capability
>called RASDES as an IP feature. This extended capability  provides
>hardware information like:
> - Debug registers to know the state of the link or controller. 
> - Error injection mechanisms to inject various PCIe errors including
>   sequence number, CRC
> - Statistical counters to know how many times a particular event
>   occurred
>
>However, in Linux we do not have any generic or custom support to be
>able to use this feature in an efficient manner. This is the reason we
>are proposing this framework. Debug and bring up time of high-speed IPs
>are highly dependent on costlier hardware analyzers and this solution
>will in some ways help to reduce the HW analyzer usage.
>
>The debugfs entries can be used to get information about underlying
>hardware and can be shared with user space. Separate debugfs entries has
>been created to cater to all the DES hooks provided by the controller.
>The debugfs entries interacts with the RASDES registers in the required
>sequence and provides the meaningful data to the user. This eases the
>effort to understand and use the register information for debugging.
>
>This series creates a generic debugfs framework for DesignWare PCIe
>controllers where other debug features apart from RASDES can also be
>added as and when required.
>
>v7:
>    - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
>      into this series to remove dependancy as discussed
>    - Addressed style related change requests from v6
>
>v6: https://lore.kernel.org/all/20250214105007.97582-1-shradha.t@samsung.com/
>    - Addressed Niklas's comment to make vsec ID finding similar to perf
>    - Minor changes in the driver to make the debugfs file common and
>      not specefic to RASDES so that other developers can add debug
>      related features to this file.
>
>v5: https://lore.kernel.org/all/20250121111421.35437-1-shradha.t@samsung.com/
>    - Addressed Fan's comment to split the patches for easier review
>    - Addressed Bjorn's comment to fix vendor specific cap search
>    - Addressed style related change requests from v4
>    - Added rasdes debugfs init call to common designware files for host
>      and EP.
>
>v4: https://lore.kernel.org/lkml/20241206074456.17401-1-shradha.t@samsung.com/
>    - Addressed comments from Manivannan, Bjorn and Jonathan
>    - Addressed style related change requests from v3
>    - Added Documentation under Documentation/ABI/testing and kdoc stype
>      comments wherever required for better understanding
>    - Enhanced error injection to include all possible error groups
>    - Removed debugfs init call from common designware file and left it
>      up to individual platform drivers to init/deinit as required.
>
>v3: https://lore.kernel.org/all/20240625093813.112555-1-shradha.t@samsung.com/
>    - v2 had suggestions about moving this framework to perf/EDAC instead of a
>      controller specific debugfs but after discussions we decided to go ahead
>      with the same. Rebased and posted v3 with minor style changes.
>
>v2: https://lore.kernel.org/lkml/20231130115044.53512-1-shradha.t@samsung.com/
>    - Addressed comments from Krzysztof WilczyÅ„ski, Bjorn Helgaas and
>      posted v2 with a changed implementation for a better code design
>
>v1: https://lore.kernel.org/all/20210518174618.42089-1-shradha.t@samsung.com/T/
>
>[1] https://lore.kernel.org/all/20250218-pcie-qcom-ptm-v1-0-16d7e480d73e@linaro.org/
>
>Manivannan Sadhasivam (1):
>  perf/dwc_pcie: Move common DWC struct definitions to 'pcie-dwc.h'
>
>Shradha Todi (4):
>  PCI: dwc: Add helper to find the Vendor Specific Extended Capability
>    (VSEC)
>  Add debugfs based silicon debug support in DWC
>  Add debugfs based error injection support in DWC
>  Add debugfs based statistical counter support in DWC
>
> Documentation/ABI/testing/debugfs-dwc-pcie    | 144 +++++
> MAINTAINERS                                   |   1 +
> drivers/pci/controller/dwc/Kconfig            |  10 +
> drivers/pci/controller/dwc/Makefile           |   1 +
> .../controller/dwc/pcie-designware-debugfs.c  | 564 ++++++++++++++++++
> .../pci/controller/dwc/pcie-designware-ep.c   |   5 +
> .../pci/controller/dwc/pcie-designware-host.c |   6 +
> drivers/pci/controller/dwc/pcie-designware.c  |  46 ++
> drivers/pci/controller/dwc/pcie-designware.h  |  21 +
> drivers/perf/dwc_pcie_pmu.c                   |  25 +-
> include/linux/pcie-dwc.h                      |  36 ++
> 11 files changed, 837 insertions(+), 22 deletions(-)
> create mode 100644 Documentation/ABI/testing/debugfs-dwc-pcie
> create mode 100644 drivers/pci/controller/dwc/pcie-designware-debugfs.c
> create mode 100644 include/linux/pcie-dwc.h
>
>-- 
>2.17.1
>
>

Thanks for adding the support!

Tested the patch in one of our internal SoC with DesginWare PCIe controller. The patch works fine.

Tested-by: Hrishikesh Deleep <hrishikesh.d@samsung.com>


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f174.google.com (mail-pl1-f174.google.com [209.85.214.174])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CDF37268C48;
	Tue, 25 Feb 2025 14:30:05 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.174
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740493807; cv=none; b=aoNpMq4wjO+Cw2t1MyqO1qOln7FoScGCNL8ZBFZqWtDURgtSeoE4HbCtXKJ0gwvpygGrfWaswLXop8hkHkRZKn9NwEW5Ea38Psvk/nkuAKHSK9x0Kq5mVcOTpW2otrSG+nhz75I6hgm6+E2nqifn7y8jhSqeHhPY3FHv4c6jcsE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740493807; c=relaxed/simple;
	bh=eGc3wu2FWrg3YdBJdGL+LGOwL6146dZ8BpFENFejErA=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=I3I5M+inWscXquOyZ/U3zx+xIz1i2N5p5VexApjz0joxdI+hegm8et4bth9noB2mvqX820fvYlEl7aMak7OoY28kzj0f7o5wl7dFY3W4OsqL94LKYdCuMqAAby2Ok+f9/wjsLU6XY69iu860q8kBsCAscgIFbndenyQi/1/y3d8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.174
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f174.google.com with SMTP id d9443c01a7336-221057b6ac4so109299965ad.2;
        Tue, 25 Feb 2025 06:30:05 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740493805; x=1741098605;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=DG3YidYogPh0t3kYDq7/qV85q51q4l91jIf6MGtnfZg=;
        b=ONM7ypGLZU+yp8x8jvlz9VixMPNhIUleD4vyjxpMIoHsVSAnmbKbSM3HDr4fsiZ0zb
         kEPxha/IKz3ecXyvcR4+rjF6++kFupUSw7VjPGl3SSiMy8LBIoA7oZ0wydBkxdEqhW1Z
         D2lN4uTOXbNKmJsv6RUyJHeUNQlmjCfSKGUBosMoSxYsJ91EV0buABIUscsD5OwrnYw1
         TOwHhkeghOtbGVjUwqBA2mFvHewxWQnaRSOT3oRs+Tw4PckXqhf71Zjs3hNgwOThQyQ/
         6bn3ZwI9qNEJDDug5daV77qsyxlGz8jILWLFWFwtwQTjGFTUJuLqTErmPlICVfZBQIrM
         3OhA==
X-Forwarded-Encrypted: i=1; AJvYcCVSyXjRHq67sWXzA7WCllEomtcm8JNUwQMHFu0h8Y8yu68Go8TT0p//qRPW7T3ytUKVGfZ+gMqEbLYuEf0NJKw9qg==@vger.kernel.org, AJvYcCWVdMyfaHcHRoc1HGu8ad+GE3t42GPq/AojJcSJpBD5NqtaaFdWfn+FjN40+iteiia/MF+ZNfKFjBU=@vger.kernel.org
X-Gm-Message-State: AOJu0YxgeraB3A9AuITjZ43WVE6ae97QATo7XK+cuJMLMPEqE4owf5xT
	OAIvbt+HeG/Evw7cOgMedLWZZ/Pi/xj/DosDTU3TVwYVt20loksw
X-Gm-Gg: ASbGncvjtk7R0IHNd//VHmHF34ccEFkLt4Z8Z0rFxJG6cCnXHRZbkEHJmJVNWb4hqzF
	iVcSbjd4jJYyNgrRBQk3qxeLHnnPw0abv+6d2/UQIMwC/CGezwR5iyQ6yogs1qXrNoPGtGVcJ3H
	tmOnri4pdfqqiRskgwHGFnH0H8DcF/bv+Fhn+ykr7MzntNFGJISSsuxDi4dtYT26Gxl/O3FVErM
	gKOUbYzK+TpBLosBJuHuGjylTlIhqSq4LtVGVV2TerWbJTuqup/VwmLx0+0nS9d3xU3k0IUE4W1
	apQW0HRQjI3nf+s/b8OHvM7OcrBOVuWR+b4UA+HRTy5YRzm5RrVLYuFlYLo7
X-Google-Smtp-Source: AGHT+IHy6OrD/YH6k+g/XZQG11rxQoJ71aizZlrzOaFRpQvw8/aJiJt0N98sszSOwWUy7SbLW5HkyQ==
X-Received: by 2002:a05:6a20:a11d:b0:1ee:d384:7553 with SMTP id adf61e73a8af0-1eef5558ec8mr34863278637.30.1740493804970;
        Tue, 25 Feb 2025 06:30:04 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d2e1a72fcca58-7347a81eb02sm1607319b3a.131.2025.02.25.06.30.03
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 06:30:04 -0800 (PST)
Date: Tue, 25 Feb 2025 23:30:01 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250225143001.GA1556729@rocinante>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>

Hello,

> DesignWare controller provides a vendor specific extended capability
> called RASDES as an IP feature. This extended capability  provides
> hardware information like:
>  - Debug registers to know the state of the link or controller. 
>  - Error injection mechanisms to inject various PCIe errors including
>    sequence number, CRC
>  - Statistical counters to know how many times a particular event
>    occurred
> 
> However, in Linux we do not have any generic or custom support to be
> able to use this feature in an efficient manner. This is the reason we
> are proposing this framework. Debug and bring up time of high-speed IPs
> are highly dependent on costlier hardware analyzers and this solution
> will in some ways help to reduce the HW analyzer usage.
> 
> The debugfs entries can be used to get information about underlying
> hardware and can be shared with user space. Separate debugfs entries has
> been created to cater to all the DES hooks provided by the controller.
> The debugfs entries interacts with the RASDES registers in the required
> sequence and provides the meaningful data to the user. This eases the
> effort to understand and use the register information for debugging.
> 
> This series creates a generic debugfs framework for DesignWare PCIe
> controllers where other debug features apart from RASDES can also be
> added as and when required.

Applied to controller/dwc, thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 91326244195;
	Mon, 24 Feb 2025 17:08:33 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740416913; cv=none; b=BR0jajcUQ5GB9tjtIyOIuEJtchc/bbYLtdR8TTXlwaZYmbmeBjVIi+NS257bbwK48Lrf/4MgbchxB/kZS1kDgPHFqiyqPTboWloHs9zgO/uhDQ1/iKSmap5AsWlMdQe9GZT5/LkJyRxoS9f3PHBmsGsF7ZKbi2/D4fZuArmEEK8=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740416913; c=relaxed/simple;
	bh=I5InXa5iPxIUg/XL60LjkpRPCQ4Lls7ukDWRdePp2vA=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=Au7EuIKxQTbjL7wVCnxhpkH/tS+rye2Rd9P0+DJFOMJk2bxVCcGSeM0mSoeBlE1E+beRTFpJ9tVWcy+1QPXB2RJC9eiqed9286MGIea/RvvthDy1nZv6Wy2R0ABviDzT1pDIm+QTLDrjEPsN5VYi0BGH9slSCGQOHwrJh3nKXuI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=eubje9Yl; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="eubje9Yl"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id E7EA5C4CED6;
	Mon, 24 Feb 2025 17:08:28 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1740416913;
	bh=I5InXa5iPxIUg/XL60LjkpRPCQ4Lls7ukDWRdePp2vA=;
	h=Date:From:To:Cc:Subject:References:In-Reply-To:From;
	b=eubje9YlzJi0bBqI0AJSqLsQzrWoa05DCF4dgQBTG67+gfFKVSE6L+hh0/t4ZwX+w
	 rnVqn/tMyeSMSBJwS9FEuM7TaD2jxfme7QAgZvFBJO15SathlzjfJGvKPymY9/iSWY
	 XLcJlIPqc9Y2GYkObgbSNBWu5Wpff8xnVxjdKOzue5JmJDWG/Agwp9RbJfT7zC60v8
	 jeYEZze2FbDMF+Of/JG5USwIcNmOZCLhtJrkiG13XUrQdF/xePJhxFUq7CSfkIXRrE
	 X9x8ZpRa90FZlDRgpQqN2k4w+b/RGXWvg9PMxKohOc0yEPuAfykOvnwvAHyicbye/5
	 gwpDw0eztSzVA==
Date: Mon, 24 Feb 2025 18:08:26 +0100
From: Niklas Cassel <cassel@kernel.org>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, fan.ni@samsung.com,
	nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <Z7yniizCTdBvUBI0@ryzen>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>

Hello Shradha,

On Fri, Feb 21, 2025 at 06:45:43PM +0530, Shradha Todi wrote:
> DesignWare controller provides a vendor specific extended capability
> called RASDES as an IP feature. This extended capability  provides
> hardware information like:
>  - Debug registers to know the state of the link or controller. 
>  - Error injection mechanisms to inject various PCIe errors including
>    sequence number, CRC
>  - Statistical counters to know how many times a particular event
>    occurred
> 
> However, in Linux we do not have any generic or custom support to be
> able to use this feature in an efficient manner. This is the reason we
> are proposing this framework. Debug and bring up time of high-speed IPs
> are highly dependent on costlier hardware analyzers and this solution
> will in some ways help to reduce the HW analyzer usage.
> 
> The debugfs entries can be used to get information about underlying
> hardware and can be shared with user space. Separate debugfs entries has
> been created to cater to all the DES hooks provided by the controller.
> The debugfs entries interacts with the RASDES registers in the required
> sequence and provides the meaningful data to the user. This eases the
> effort to understand and use the register information for debugging.
> 
> This series creates a generic debugfs framework for DesignWare PCIe
> controllers where other debug features apart from RASDES can also be
> added as and when required.
> 
> v7:
>     - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
>       into this series to remove dependancy as discussed
>     - Addressed style related change requests from v6

I tested this series, and one thing that I noticed:

# for f in /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/counter_enable; do echo 1 > $f; done

# grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/ctl_skp_os_parity_err/counter_enable:Counter Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/deskew_uncompleted_err/counter_enable:Counter Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/framing_err_in_l0/counter_enable:Counter Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/margin_crc_parity_err/counter_enable:Counter Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_1st/counter_enable:Counter Disabled
/sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_2nd/counter_enable:Counter Disabled

that there are some events that cannot be enabled when testing on my platform,
rk3588, perhaps this is because my version of the DWC IP does not have these
events.

(Because all the other events can be enabled successfully:
# grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Enabled | wc -l
29
)


So the question is, how do we want to handle that?

E.g. counter_enable_write() could theoretically read back the
dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
register after doing the
ww_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);

to actually check if it could enable the event.

If counter_enable_write() could not enable the specific event, should it
perhaps return a failure to user space?

Or, do we want to keep the current behavior of just letting counter_enable_write()
return success, even for events that are not supported by the specific DWC PCIe
implementation?


Kind regards,
Niklas



From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout2.samsung.com (mailout2.samsung.com [203.254.224.25])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CE142205E04
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.25
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221971; cv=none; b=cK9au2/mh+uKxXHpuHrqChrPiUK7y+gVCPrg2mnRk2TfRHGHfaZCuo1u8Hd5g5tWUBrYJSXHRnDbIm1VX0fPmPldOVlH6brt36KCGttL/75II39Mt97PMC93uYe7ZzgamaIKjV9G+RhJtjlFlBtM/yGmZnenmHlixhKFkUFo49k=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221971; c=relaxed/simple;
	bh=F+7hgIHXKwy4XkfrX/Tv5E5Ob7pgP01m8EMAPNRiKnY=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:Content-Type:
	 References; b=X5ZZl7vl64y5m1SfDG3ooCC9B+SRuYgMdGqup7vJ88hhWwriVlcBb+SeqkkFvVVxtMguMfSjzavD6LT/yNUhwFqFlqratK+4hs8aoCfr7xVOIgNFzP5rDZr4FY7vz3MzEXXtM4LaNWnz6WR+QMaEif/f7VkbXRfWErcSVusw564=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=rGc1r6yl; arc=none smtp.client-ip=203.254.224.25
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="rGc1r6yl"
Received: from epcas5p1.samsung.com (unknown [182.195.41.39])
	by mailout2.samsung.com (KnoxPortal) with ESMTP id 20250222105927epoutp0212a602503e24048b2ae9fc394a7d2020~mgqi9dxtA3101231012epoutp02E
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:27 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.samsung.com 20250222105927epoutp0212a602503e24048b2ae9fc394a7d2020~mgqi9dxtA3101231012epoutp02E
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221967;
	bh=z6f4nMvOZhyzDf2i0PcLJ5jRQ2jdAo61YqVs07awoek=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=rGc1r6yleyhcpSeH3PfCbJNGXuULATAO0xiRRxerKOTuU0wC+D5b1OhBF7oV3Ohs/
	 fc8g5vpwWuN2jCLPeSAm/CiS/1L9/w1AQWI+9zPVIlA8OHxZB+CtiCg6msdcS3Iv0G
	 zMyRLgQiNQQhuGuMGRzHP5FqzuyHKzT5YHjEnY4c=
Received: from epsnrtp4.localdomain (unknown [182.195.42.165]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTP id
	20250222105926epcas5p41fb34d3445510c9f0dab91b2f7f3a59c~mgqiKPYg-2088720887epcas5p49;
	Sat, 22 Feb 2025 10:59:26 +0000 (GMT)
Received: from epsmgec5p1new.samsung.com (unknown [182.195.38.175]) by
	epsnrtp4.localdomain (Postfix) with ESMTP id 4Z0PC03NM3z4x9Pw; Sat, 22 Feb
	2025 10:59:24 +0000 (GMT)
Received: from epcas5p4.samsung.com ( [182.195.41.42]) by
	epsmgec5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	21.22.19710.C0EA9B76; Sat, 22 Feb 2025 19:59:24 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132043epcas5p27fde98558b13b3311cdc467e8f246380~mO8nAdHi_1832518325epcas5p2o;
	Fri, 21 Feb 2025 13:20:43 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250221132043epsmtrp2fb6af07052063d3524500efe8fea4b11~mO8m-AojY1951819518epsmtrp2M;
	Fri, 21 Feb 2025 13:20:43 +0000 (GMT)
X-AuditID: b6c32a44-363dc70000004cfe-45-67b9ae0cda57
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	8B.59.18729.BAD78B76; Fri, 21 Feb 2025 22:20:43 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132040epsmtip235ddeb74662141dea8de29ac3d819bec~mO8kA6IBJ0684606846epsmtip2-;
	Fri, 21 Feb 2025 13:20:40 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 5/5] Add debugfs based statistical counter support in DWC
Date: Fri, 21 Feb 2025 18:45:48 +0530
Message-Id: <20250221131548.59616-6-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
X-Brightmail-Tracker: H4sIAAAAAAAAA0VTe0xTVxze6W1vC6HspiA7sIh45x6QFdtJywGBsUnwZiNZjTNuLlm5wrUl
	lLa0ZczNTYQ6HgqRRQcDeWOohcAsUN6kAwRx4OJa0W2wDASHM25REHGIrLSw/ff9vt/3nd/j
	nMPDBFfwAF6K2sDo1LSKxD3Z1sHgEKFXc5dCVJflhxy5K1xUMrgd1Wcr0fAZE4ayG6c4yLT4
	LReZayZwlHV6hYMstyc4yN59HkfjlSM4crQ3s5HxqZGNpoz5HHTh5nUWWrX2AVTbvshFNTl3
	AVrr7eSiwsEvkHFSgv5+0orH+lF1prMcqqmyCVBdZVNcqtqSQRmH7nMoizkfpyYnenGqazqC
	mnWUsKjW+uNUUZsZUAuWQJnXodQoJUMnM7ogRp2kSU5RK6LJd/fL98glUpFYKI5A4WSQmk5j
	osm4BJkwPkXlnJYM+oRWZTgpGa3XkztjonSaDAMTpNToDdEko01WacO0oXo6TZ+hVoSqGUOk
	WCR6Q+IUJqYqu+rGudqzyk8vnVhjZYGOgwXAgweJMNjb7WAXAE+egOgB8HG3mesOHgJ4rn2O
	5Q6WAJzLu8fetCyXz3PXsYDoA/Dyg2Nu0SKAo9Zp1noCJ0LgiUcF2Dr2JU4COHTHb12EEVYM
	2kwmV8KHSIB5A9+7TmITL8Mq06CL5xORMGv4JstdbRts/M7m4j2I3dB8rcTVEiQmedBhe7Qh
	ioO/WS0b7fnAP0fauG4cABf+6sPdWAEvtpZibqyCS631G943oc1x3unlObsLhi3dO930Vnju
	arNLghHesHBldkPOh52Vm/gluLjau1HWH1YO2zluTMHSMhvu3koRgD9ZZthnQGDZ/yWqATAD
	f0arT1MwSRKtWM1k/ndtSZo0C3A96ZC4TnCr6lnoAGDxwACAPIz05QsNnQoBP5k++hmj08h1
	GSpGPwAkzgUWYwFbkjTOP6E2yMVhEaIwqVQaFrFLKiZf4Od0GRUCQkEbmFSG0TK6TR+L5xGQ
	xTL2PdUO9u8tr7p3OfxnJXvIRrXIS8nXGoXy/lfLc7fGPN539RiWGCva/U3AK2NjU7La3NK8
	il+Xx1+83nZB3vFL5Kl9W270jHnsKjGXWt+j7T/cPnorePXHlr1rsvmVYt0DXvr97Yr4NNFo
	fnzHs/fvHk4VfPlVaHPmttrPk4KWhm6wZwufzOjQPw+vNYymeBVm9h+INnzMvzgl2XFgZLRu
	XBvzUY63XZlu/z3xeDE6nf1OxaUGaZOq4utqXd4d+xE/SdNibHPZkbcarlQdLviAs/+kr/dz
	wfa3PbloIVDW4z+/lF40/YdBPj/6+qnA8JrqQ1Ef+sh6n08Q8uOVO5bnKuZmDq6RbL2SFodg
	Oj39L4kdTUhbBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFmpgkeLIzCtJLcpLzFFi42LZdlhJXnd17Y50g6+z5S2utP9mt5h+WNFi
	SVOGxbEJK5gtmlbfZbVY8WUmu8WqhdfYLBp6frNabHp8jdXi8q45bBZn5x1ns7iydR2LRcuf
	FhaLuy2drBZLr19ksvi7bS+jxaKtX9gtFja/ZLT4v2cHu0Xv4VqLljumFu9/bmZzEPNYvGIK
	q8eaeWsYPXbOusvusWBTqUfLkbesHptWdbJ53Lm2h81j50NLjydXpjN5bF5S79G3ZRWjx+dN
	cgE8UVw2Kak5mWWpRfp2CVwZOxefZS+YklGxsfE/UwPj9vAuRk4OCQETiR+zX7B3MXJxCAns
	ZpQ4feAPM0RCUuLzxXVMELawxMp/z6GKPjFKXH55ng0kwSagJdH4tYsZJCEi0MkosffIO7Aq
	ZoFzzBIzP7cwglQJC/hIdBw6yA5iswioSsxfcRhsBa+AlUTDsetQK+QlVm84ABbnFLCWWHVu
	OlhcCKhmz5b7rBMY+RYwMqxilEwtKM5Nzy02LDDMSy3XK07MLS7NS9dLzs/dxAiOJC3NHYzb
	V33QO8TIxMF4iFGCg1lJhFe3ZEe6EG9KYmVValF+fFFpTmrxIUZpDhYlcV7xF70pQgLpiSWp
	2ampBalFMFkmDk6pBqaweEOledoPPhQ8KeXba516k7l10sbibRPnLvz06kH+7sfZtXMqC5bI
	xrypj++8Pm1nlsi16e94ukslJtvJaCwLK+S/Uh+dJChQsTspehb7ktfiPYEfteoZPcq45P1k
	7Cf5/bDe1drt/fCJXXx29ZW5CdfmHdl2eH7umnX3d4UuX3uBy6joipDVqjeTosTtk902OPF2
	zswqU/Q4c3ZqnJjSDjaj06dmHZMWjf7uui1565Pu1KW/5tY77L+1vPKcmKiHwbGj5aXJfo2b
	t1js8fmtoSot2cuU/KA0X7UqKGhOfumWWw9sPt54KXf0qWXYvCq3+NUhk+Jfie5vk3Sa+MZ1
	ft/7+CbrOmEDjQkq0UosxRmJhlrMRcWJAF6i09UTAwAA
X-CMS-MailID: 20250221132043epcas5p27fde98558b13b3311cdc467e8f246380
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132043epcas5p27fde98558b13b3311cdc467e8f246380
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>

Add support to provide statistical counter interface to userspace. This set
of debug registers are part of the RASDES feature present in DesignWare
PCIe controllers.

Signed-off-by: Shradha Todi <shradha.t@samsung.com>
---
 Documentation/ABI/testing/debugfs-dwc-pcie    |  61 +++++
 .../controller/dwc/pcie-designware-debugfs.c  | 229 +++++++++++++++++-
 2 files changed, 289 insertions(+), 1 deletion(-)

diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
index 6ee0897fe753..650a89b0511e 100644
--- a/Documentation/ABI/testing/debugfs-dwc-pcie
+++ b/Documentation/ABI/testing/debugfs-dwc-pcie
@@ -81,3 +81,64 @@ Description:	rasdes_err_inj is the directory which can be used to inject errors
 
 			<count>
 				Number of errors to be injected
+
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/counter_enable
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	rasdes_event_counters is the directory which can be used to collect
+		statistical data about the number of times a certain event has occurred
+		in the controller. The list of possible events are:
+
+		1) EBUF Overflow
+		2) EBUF Underrun
+		3) Decode Error
+		4) Running Disparity Error
+		5) SKP OS Parity Error
+		6) SYNC Header Error
+		7) Rx Valid De-assertion
+		8) CTL SKP OS Parity Error
+		9) 1st Retimer Parity Error
+		10) 2nd Retimer Parity Error
+		11) Margin CRC and Parity Error
+		12) Detect EI Infer
+		13) Receiver Error
+		14) RX Recovery Req
+		15) N_FTS Timeout
+		16) Framing Error
+		17) Deskew Error
+		18) Framing Error In L0
+		19) Deskew Uncompleted Error
+		20) Bad TLP
+		21) LCRC Error
+		22) Bad DLLP
+		23) Replay Number Rollover
+		24) Replay Timeout
+		25) Rx Nak DLLP
+		26) Tx Nak DLLP
+		27) Retry TLP
+		28) FC Timeout
+		29) Poisoned TLP
+		30) ECRC Error
+		31) Unsupported Request
+		32) Completer Abort
+		33) Completion Timeout
+		34) EBUF SKP Add
+		35) EBUF SKP Del
+
+		(RW) Write 1 to enable the event counter and write 0 to disable the event counter.
+		Read will return whether the counter is currently enabled or disabled. Counter is
+		disabled by default.
+
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/counter_value
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	(RO) Read will return the current value of the event counter. To reset the counter,
+		counter should be disabled and enabled back using the 'counter_enable' attribute.
+
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/lane_select
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	(RW) Some lanes in the event list are lane specific events. These include
+		events 1) - 11) and 34) - 35).
+		Write lane number for which counter needs to be enabled/disabled/dumped.
+		Read will return the current selected lane number. Lane0 is selected by default.
diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
index b7260edd2336..dca1e9999113 100644
--- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
+++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
@@ -31,6 +31,17 @@
 
 #define ERR_INJ_ENABLE_REG		0x30
 
+#define RAS_DES_EVENT_COUNTER_DATA_REG	0xc
+
+#define RAS_DES_EVENT_COUNTER_CTRL_REG	0x8
+#define EVENT_COUNTER_GROUP_SELECT	GENMASK(27, 24)
+#define EVENT_COUNTER_EVENT_SELECT	GENMASK(23, 16)
+#define EVENT_COUNTER_LANE_SELECT	GENMASK(11, 8)
+#define EVENT_COUNTER_STATUS		BIT(7)
+#define EVENT_COUNTER_ENABLE		GENMASK(4, 2)
+#define PER_EVENT_ON			0x3
+#define PER_EVENT_OFF			0x1
+
 #define DWC_DEBUGFS_BUF_MAX		128
 
 /**
@@ -113,6 +124,61 @@ static const u32 err_inj_type_mask[] = {
 	EINJ5_TYPE,
 };
 
+/**
+ * struct dwc_pcie_event_counter - Store details about each event counter supported in DWC RASDES
+ * @name: Name of the error counter
+ * @group_no: Group number that the event belongs to. Value ranges from 0 - 4
+ * @event_no: Event number of the particular event. Value ranges from -
+ *		Group 0: 0 - 10
+ *		Group 1: 5 - 13
+ *		Group 2: 0 - 7
+ *		Group 3: 0 - 5
+ *		Group 4: 0 - 1
+ */
+struct dwc_pcie_event_counter {
+	const char *name;
+	u32 group_no;
+	u32 event_no;
+};
+
+static const struct dwc_pcie_event_counter event_list[] = {
+	{"ebuf_overflow", 0x0, 0x0},
+	{"ebuf_underrun", 0x0, 0x1},
+	{"decode_err", 0x0, 0x2},
+	{"running_disparity_err", 0x0, 0x3},
+	{"skp_os_parity_err", 0x0, 0x4},
+	{"sync_header_err", 0x0, 0x5},
+	{"rx_valid_deassertion", 0x0, 0x6},
+	{"ctl_skp_os_parity_err", 0x0, 0x7},
+	{"retimer_parity_err_1st", 0x0, 0x8},
+	{"retimer_parity_err_2nd", 0x0, 0x9},
+	{"margin_crc_parity_err", 0x0, 0xA},
+	{"detect_ei_infer", 0x1, 0x5},
+	{"receiver_err", 0x1, 0x6},
+	{"rx_recovery_req", 0x1, 0x7},
+	{"n_fts_timeout", 0x1, 0x8},
+	{"framing_err", 0x1, 0x9},
+	{"deskew_err", 0x1, 0xa},
+	{"framing_err_in_l0", 0x1, 0xc},
+	{"deskew_uncompleted_err", 0x1, 0xd},
+	{"bad_tlp", 0x2, 0x0},
+	{"lcrc_err", 0x2, 0x1},
+	{"bad_dllp", 0x2, 0x2},
+	{"replay_num_rollover", 0x2, 0x3},
+	{"replay_timeout", 0x2, 0x4},
+	{"rx_nak_dllp", 0x2, 0x5},
+	{"tx_nak_dllp", 0x2, 0x6},
+	{"retry_tlp", 0x2, 0x7},
+	{"fc_timeout", 0x3, 0x0},
+	{"poisoned_tlp", 0x3, 0x1},
+	{"ecrc_error", 0x3, 0x2},
+	{"unsupported_request", 0x3, 0x3},
+	{"completer_abort", 0x3, 0x4},
+	{"completion_timeout", 0x3, 0x5},
+	{"ebuf_skp_add", 0x4, 0x0},
+	{"ebuf_skp_del", 0x4, 0x1},
+};
+
 static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
 {
 	struct dw_pcie *pci = file->private_data;
@@ -230,6 +296,127 @@ static ssize_t err_inj_write(struct file *file, const char __user *buf, size_t c
 	return count;
 }
 
+static void set_event_number(struct dwc_pcie_rasdes_priv *pdata, struct dw_pcie *pci,
+			     struct dwc_pcie_rasdes_info *rinfo)
+{
+	u32 val;
+
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
+	val &= ~EVENT_COUNTER_ENABLE;
+	val &= ~(EVENT_COUNTER_GROUP_SELECT | EVENT_COUNTER_EVENT_SELECT);
+	val |= FIELD_PREP(EVENT_COUNTER_GROUP_SELECT, event_list[pdata->idx].group_no);
+	val |= FIELD_PREP(EVENT_COUNTER_EVENT_SELECT, event_list[pdata->idx].event_no);
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
+}
+
+static ssize_t counter_enable_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
+	ssize_t pos;
+	u32 val;
+
+	mutex_lock(&rinfo->reg_event_lock);
+	set_event_number(pdata, pci, rinfo);
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
+	mutex_unlock(&rinfo->reg_event_lock);
+	val = FIELD_GET(EVENT_COUNTER_STATUS, val);
+	if (val)
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter Enabled\n");
+	else
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter Disabled\n");
+
+	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
+}
+
+static ssize_t counter_enable_write(struct file *file, const char __user *buf,
+				    size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	u32 val, enable;
+
+	val = kstrtou32_from_user(buf, count, 0, &enable);
+	if (val)
+		return val;
+
+	mutex_lock(&rinfo->reg_event_lock);
+	set_event_number(pdata, pci, rinfo);
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
+	if (enable)
+		val |= FIELD_PREP(EVENT_COUNTER_ENABLE, PER_EVENT_ON);
+	else
+		val |= FIELD_PREP(EVENT_COUNTER_ENABLE, PER_EVENT_OFF);
+
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
+	mutex_unlock(&rinfo->reg_event_lock);
+
+	return count;
+}
+
+static ssize_t counter_lane_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
+	ssize_t pos;
+	u32 val;
+
+	mutex_lock(&rinfo->reg_event_lock);
+	set_event_number(pdata, pci, rinfo);
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
+	mutex_unlock(&rinfo->reg_event_lock);
+	val = FIELD_GET(EVENT_COUNTER_LANE_SELECT, val);
+	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane: %d\n", val);
+
+	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
+}
+
+static ssize_t counter_lane_write(struct file *file, const char __user *buf,
+				  size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	u32 val, lane;
+
+	val = kstrtou32_from_user(buf, count, 0, &lane);
+	if (val)
+		return val;
+
+	mutex_lock(&rinfo->reg_event_lock);
+	set_event_number(pdata, pci, rinfo);
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
+	val &= ~(EVENT_COUNTER_LANE_SELECT);
+	val |= FIELD_PREP(EVENT_COUNTER_LANE_SELECT, lane);
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
+	mutex_unlock(&rinfo->reg_event_lock);
+
+	return count;
+}
+
+static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
+	ssize_t pos;
+	u32 val;
+
+	mutex_lock(&rinfo->reg_event_lock);
+	set_event_number(pdata, pci, rinfo);
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
+	mutex_unlock(&rinfo->reg_event_lock);
+	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
+
+	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
+}
+
 #define dwc_debugfs_create(name)			\
 debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
 			&dbg_ ## name ## _fops)
@@ -249,6 +436,23 @@ static const struct file_operations dwc_pcie_err_inj_ops = {
 	.write = err_inj_write,
 };
 
+static const struct file_operations dwc_pcie_counter_enable_ops = {
+	.open = simple_open,
+	.read = counter_enable_read,
+	.write = counter_enable_write,
+};
+
+static const struct file_operations dwc_pcie_counter_lane_ops = {
+	.open = simple_open,
+	.read = counter_lane_read,
+	.write = counter_lane_write,
+};
+
+static const struct file_operations dwc_pcie_counter_value_ops = {
+	.open = simple_open,
+	.read = counter_value_read,
+};
+
 static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
 {
 	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
@@ -258,7 +462,7 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
 
 static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 {
-	struct dentry *rasdes_debug, *rasdes_err_inj;
+	struct dentry *rasdes_debug, *rasdes_err_inj, *rasdes_event_counter, *rasdes_events;
 	struct dwc_pcie_rasdes_info *rasdes_info;
 	struct dwc_pcie_rasdes_priv *priv_tmp;
 	struct device *dev = pci->dev;
@@ -277,6 +481,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 	/* Create subdirectories for Debug, Error injection, Statistics */
 	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
 	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
+	rasdes_event_counter = debugfs_create_dir("rasdes_event_counter", dir);
 
 	mutex_init(&rasdes_info->reg_event_lock);
 	rasdes_info->ras_cap_offset = ras_cap;
@@ -299,6 +504,28 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
 				    &dwc_pcie_err_inj_ops);
 	}
+
+	/* Create debugfs files for Statistical counter subdirectory */
+	for (i = 0; i < ARRAY_SIZE(event_list); i++) {
+		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
+		if (!priv_tmp) {
+			ret = -ENOMEM;
+			goto err_deinit;
+		}
+
+		priv_tmp->idx = i;
+		priv_tmp->pci = pci;
+		rasdes_events = debugfs_create_dir(event_list[i].name, rasdes_event_counter);
+		if (event_list[i].group_no == 0 || event_list[i].group_no == 4) {
+			debugfs_create_file("lane_select", 0644, rasdes_events,
+					    priv_tmp, &dwc_pcie_counter_lane_ops);
+		}
+		debugfs_create_file("counter_value", 0444, rasdes_events, priv_tmp,
+				    &dwc_pcie_counter_value_ops);
+		debugfs_create_file("counter_enable", 0644, rasdes_events, priv_tmp,
+				    &dwc_pcie_counter_enable_ops);
+	}
+
 	return 0;
 
 err_deinit:
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout1.samsung.com (mailout1.samsung.com [203.254.224.24])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 27CE620AF67
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:11 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.24
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221954; cv=none; b=GqE0TsoXmA3f0mxQ2yuB5FFgwPokvKAOX8DpD/fRMvfBwwtQ2+PoK/lktOt1nMowi4lP0lJrR9u5p0k82lWaF4smYrUy74oYdu1yLr7+kwZwHhjTnvh4XCaYXeXjD/I0hrZd0FzUyGBVt9X8jcgCLxXvJ5FrHUuoYYeIz6ZW2NY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221954; c=relaxed/simple;
	bh=IU4D9P66rcXqVX2QpLPkErMi2fV+zIesymeVGlSjcig=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:Content-Type:
	 References; b=HryJQ2+E/o/iyPsvy6I6aihbq/33VLKpD7Xtoh/aGfmVEcoYdKNmzDQz+uewR6ru2R/PEs7pri6EV7Fd4r8MhA4NPlnikt+J75oj5Cun9ScxA5Udi8iTNkZw1esjgRBL5JAoJHGBnpvfypHbNBP84CCuECTKio30b4VLN1m0kwA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=VLmQffxj; arc=none smtp.client-ip=203.254.224.24
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="VLmQffxj"
Received: from epcas5p3.samsung.com (unknown [182.195.41.41])
	by mailout1.samsung.com (KnoxPortal) with ESMTP id 20250222105909epoutp018bffe370e4680b959dd03c93cd280204~mgqSYPr0f1850518505epoutp01h
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:09 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.samsung.com 20250222105909epoutp018bffe370e4680b959dd03c93cd280204~mgqSYPr0f1850518505epoutp01h
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221949;
	bh=WV2F5kFF2eQG4mwm95oOYvl4a0oTGlcASHC3wW3MN80=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=VLmQffxj26GM2cKGCIxRd4LY2RBlFP41oFTSWyhi4w9STsrXPjB+sU0MN930rdjbz
	 pW5p8mJNrc27HLpH/YIt3tkKer4QvgKy5Ih36XOONRMoZ8/5RIHIDttMbbJlKXtK7H
	 awoXgHq3spyXEQE8g0RIQUfuAhTgSbQim5WUmWWk=
Received: from epsnrtp2.localdomain (unknown [182.195.42.163]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250222105908epcas5p374fbcea14c3beb3a22e447b44868bda0~mgqRK1BUI0419204192epcas5p37;
	Sat, 22 Feb 2025 10:59:08 +0000 (GMT)
Received: from epsmges5p2new.samsung.com (unknown [182.195.38.183]) by
	epsnrtp2.localdomain (Postfix) with ESMTP id 4Z0PBf2s78z4x9Pt; Sat, 22 Feb
	2025 10:59:06 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmges5p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	F6.0B.19933.AFDA9B76; Sat, 22 Feb 2025 19:59:06 +0900 (KST)
Received: from epsmtrp1.samsung.com (unknown [182.195.40.13]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTPA id
	20250221132039epcas5p31913eab0acec1eb5e7874897a084c725~mO8jFSuCe1687416874epcas5p3X;
	Fri, 21 Feb 2025 13:20:39 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp1.samsung.com (KnoxPortal) with ESMTP id
	20250221132039epsmtrp1d732a928118ec902b19646a9c107ddd3~mO8jEUNkn3135131351epsmtrp1I;
	Fri, 21 Feb 2025 13:20:39 +0000 (GMT)
X-AuditID: b6c32a4a-c1fda70000004ddd-ac-67b9adfa4c79
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	99.59.18729.7AD78B76; Fri, 21 Feb 2025 22:20:39 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132036epsmtip239bbfc8d2110e7dfeca37e78d74bc091~mO8gNLdXG0774707747epsmtip2G;
	Fri, 21 Feb 2025 13:20:36 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Date: Fri, 21 Feb 2025 18:45:47 +0530
Message-Id: <20250221131548.59616-5-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
X-Brightmail-Tracker: H4sIAAAAAAAAA0WTe0xTVxjAd3pvby9g5fIYHjsELDNTNqBVWg8gvlByM91GsrElW5Z6pdcW
	KbddH6JmbkWKTiKvZY7JkIh0hBVhhAoWBYeAwDSwMAi6jGYYGQwNAwc6B8LW0rL99zvf9zvn
	O+c755BYYC8hIjM4I6vnGI2Y8MWbOze9Ej1f16KSXJoNQEOnFwSotHM9sp5Uo+7iGgydrHXy
	Uc3ceQGyVQ4TyHx2gY8aHwzz0eC1cgL1VfQQaKipHkeW5xYcOS1n+OibuwM8tNjcBtClpjkB
	qsydBOifVocAFXSeQJYRGZr+207sDKGrar7g05crLgO6pcwpoC82mmhL1xSfbrSdIeiR4VaC
	brkfT48NlfJou/VTuvCKDdCzjWGpq97P3KZmGSWrj2C5dK0yg1Mlife9rUhWyOQSabQ0Hm0V
	R3BMFpsk3rM/NTolQ+M6rTjiCKMxuUKpjMEgjt2+Ta81GdkItdZgTBKzOqVGF6eLMTBZBhOn
	iuFYY4JUItksc4kHMtXVV8t4up/SjjYtWTEzmN6bD3xISMXBz5aeYfnAlwykrgPYMPrYO/gT
	wL571XzP4CmAA4+6iZUpo7kNuCfRBuC5G9Neaw7A4bpqntsiqCiY8yQfc3MwlQdg13iIW8Ko
	Zgy219QsJ4IoGjrKhnE349QGOHHvd1ecJIVUArzzl7+nWjisbWhf1n2oRGjrL+W514HUGAnP
	/tLD90h74N2cKczDQfBhzxWBh0VwsuiUl1XwW/tXXkcDn9qtPA/vgO1D5bi7LkZtgt9di/WE
	18Fzt+uXFYxaDQsWxry6EDoqVjgSzi224h5eCyu6B73boeEd5ylvhwoBfPLlb7xiEFb2f4mL
	ANjAWlZnyFKxBpluM8dm/3dt6dqsRrD8pKNed4D7ozMxHYBHgg4ASUwcLIw2OlSBQiVz7Dir
	1yr0Jg1r6AAyV/9KMNGL6VrXn+CMCmlcvCROLpfHxW+RS8VrhLktFlUgpWKMbCbL6lj9yjwe
	6SMy8w47PgiN3RuJ80SKnhThRuuPoC2yqvXY8aleYtfuyIP8VRvXBf8wLp+4eSK3RHurJHxn
	duwixryMd119lFY4cT7yrZmpjiRjSlCi+l3Zjnx/H7yw3T8hDdYF5IXjt53aWltff2VVx67H
	B0vXVLxkFn39QmiiXP/hkWTYUFKOBpOJj5XP2skbD17tDXeW7O+Tc6MBxZ9TqZ/cmgOvUe8l
	5i1prBxzWunMwWYzBybm/fxSFvyKtoL68aIDz38eOjwfbddYcsz18+9M2r8fM4U40Udhg9cX
	sJkCc9vD7RPW/jfHfLe8kXdh/WpB0oZQjeRodn9uOjkS/+uhQ0LFTTM1+4cYN6gZaRSmNzD/
	AliZQORbBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrHLMWRmVeSWpSXmKPExsWy7bCSvO7y2h3pBvtuSlhcaf/NbjH9sKLF
	kqYMi2MTVjBbNK2+y2qx4stMdotVC6+xWTT0/Ga12PT4GqvF5V1z2CzOzjvOZnFl6zoWi5Y/
	LSwWd1s6WS2WXr/IZPF3215Gi0Vbv7BbLGx+yWjxf88Odovew7UWLXdMLd7/3MzmIOaxeMUU
	Vo8189YweuycdZfdY8GmUo+WI29ZPTat6mTzuHNtD5vHzoeWHk+uTGfy2Lyk3qNvyypGj8+b
	5AJ4orhsUlJzMstSi/TtErgylm2fxVRwKbRi678lzA2M7127GDk5JARMJB40b2ABsYUEdjNK
	vJthBxGXlPh8cR0ThC0ssfLfc/YuRi6gmk+MEif2bQNrYBPQkmj82sUMkhAR6GSU2HvkHVgV
	s8A5ZomZn1sYQaqEBTwkdsy6BtbBIqAq8fzGC6AODg5eASuJ09/5ITbIS6zecIAZxOYUsJZY
	dW46E8RFVhJ7ttxnncDIt4CRYRWjZGpBcW56brFhgWFearlecWJucWleul5yfu4mRnAUaWnu
	YNy+6oPeIUYmDsZDjBIczEoivLolO9KFeFMSK6tSi/Lji0pzUosPMUpzsCiJ84q/6E0REkhP
	LEnNTk0tSC2CyTJxcEo1ME0NrXt9W5UnxsC8vnODVvuTStH2pO6vX1oeB5vscmyd/fMLW0RX
	RMKm6w0Vj5okjmm+f8/8cja37yStvLI/8Yr7S169jzmfF7lMJKLlwTkur6wHL123TH4xJU/o
	++69N89asGyVdt5tonZwTXf6Ta08XdvbpZ6fJc36fk6tO36qI6/puMDmdVNfFhiWWbw667r/
	5fcZL+cxNPvsY/8892NawPWLa24rZfhzpSu+CDuZz3tw7RVG9l0Tg7Ol3/ieVTq/vHmKyI5b
	lllTLEQSlgXwxDQsqeO9F7DCQHHbto0PTy7/bP6/8lLIiyCrphJv28cLDX6yTC10fu11IWJO
	WRyP7ToL05s/BWYqv2zKnqLEUpyRaKjFXFScCAACJQ+rEQMAAA==
X-CMS-MailID: 20250221132039epcas5p31913eab0acec1eb5e7874897a084c725
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132039epcas5p31913eab0acec1eb5e7874897a084c725
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>

Add support to provide error injection interface to userspace. This set
of debug registers are part of the RASDES feature present in DesignWare
PCIe controllers.

Signed-off-by: Shradha Todi <shradha.t@samsung.com>
---
 Documentation/ABI/testing/debugfs-dwc-pcie    |  70 ++++++++
 .../controller/dwc/pcie-designware-debugfs.c  | 165 +++++++++++++++++-
 2 files changed, 233 insertions(+), 2 deletions(-)

diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
index e8ed34e988ef..6ee0897fe753 100644
--- a/Documentation/ABI/testing/debugfs-dwc-pcie
+++ b/Documentation/ABI/testing/debugfs-dwc-pcie
@@ -11,3 +11,73 @@ Contact:	Shradha Todi <shradha.t@samsung.com>
 Description:	(RW) Write the lane number to be checked as valid or invalid. Read
 		will return the status of PIPE RXVALID signal of the selected lane.
 		The default selected lane is Lane0.
+
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	rasdes_err_inj is the directory which can be used to inject errors in the
+		system. The possible errors that can be injected are:
+
+		1) TLP LCRC error injection TX Path - tx_lcrc
+		2) 16b CRC error injection of ACK/NAK DLLP - b16_crc_dllp
+		3) 16b CRC error injection of Update-FC DLLP - b16_crc_upd_fc
+		4) TLP ECRC error injection TX Path - tx_ecrc
+		5) TLP's FCRC error injection TX Path - fcrc_tlp
+		6) Parity error of TSOS - parity_tsos
+		7) Parity error on SKPOS - parity_skpos
+		8) LCRC error injection RX Path - rx_lcrc
+		9) ECRC error injection RX Path - rx_ecrc
+		10) TLPs SEQ# error - tlp_err_seq
+		11) DLLPS ACK/NAK SEQ# error - ack_nak_dllp_seq
+		12) ACK/NAK DLLPs transmission block - ack_nak_dllp
+		13) UpdateFC DLLPs transmission block - upd_fc_dllp
+		14) Always transmission for NAK DLLP - nak_dllp
+		15) Invert SYNC header - inv_sync_hdr_sym
+		16) COM/PAD TS1 order set - com_pad_ts1
+		17) COM/PAD TS2 order set - com_pad_ts2
+		18) COM/FTS FTS order set - com_fts
+		19) COM/IDL E-idle order set - com_idl
+		20) END/EDB symbol - end_edb
+		21) STP/SDP symbol - stp_sdp
+		22) COM/SKP SKP order set - com_skp
+		23) Posted TLP Header credit value control - posted_tlp_hdr
+		24) Non-Posted TLP Header credit value control - non_post_tlp_hdr
+		25) Completion TLP Header credit value control - cmpl_tlp_hdr
+		26) Posted TLP Data credit value control - posted_tlp_data
+		27) Non-Posted TLP Data credit value control - non_post_tlp_data
+		28) Completion TLP Data credit value control - cmpl_tlp_data
+		29) Generates duplicate TLPs - duplicate_dllp
+		30) Generates Nullified TLPs - nullified_tlp
+
+		(WO) Write to the attribute will prepare controller to inject the respective
+		error in the next transmission of data. Parameter required to write will
+		change in the following ways:
+
+		i) Errors 9) - 10) are sequence errors. The write command for these will be
+
+			echo <count> <diff> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
+
+			<count>
+				Number of errors to be injected
+			<diff>
+				The difference to add or subtract from natural sequence number to
+				generate sequence error. Range (-4095 : 4095)
+
+		ii) Errors 23) - 28) are credit value error insertions. Write command:
+
+			echo <count> <diff> <vc> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
+
+			<count>
+				Number of errors to be injected
+			<diff>
+				The difference to add or subtract from UpdateFC credit value.
+				Range (-4095 : 4095)
+			<vc>
+				Target VC number
+
+		iii) All other errors. Write command:
+
+			echo <count> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
+
+			<count>
+				Number of errors to be injected
diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
index 3887a6996706..b7260edd2336 100644
--- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
+++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
@@ -17,6 +17,20 @@
 #define PIPE_DETECT_LANE		BIT(17)
 #define LANE_SELECT			GENMASK(3, 0)
 
+#define ERR_INJ0_OFF			0x34
+#define EINJ_VAL_DIFF			GENMASK(28, 16)
+#define EINJ_VC_NUM			GENMASK(14, 12)
+#define EINJ_TYPE_SHIFT			8
+#define EINJ0_TYPE			GENMASK(11, 8)
+#define EINJ1_TYPE			BIT(8)
+#define EINJ2_TYPE			GENMASK(9, 8)
+#define EINJ3_TYPE			GENMASK(10, 8)
+#define EINJ4_TYPE			GENMASK(10, 8)
+#define EINJ5_TYPE			BIT(8)
+#define EINJ_COUNT			GENMASK(7, 0)
+
+#define ERR_INJ_ENABLE_REG		0x30
+
 #define DWC_DEBUGFS_BUF_MAX		128
 
 /**
@@ -33,6 +47,72 @@ struct dwc_pcie_rasdes_info {
 	struct mutex reg_event_lock;
 };
 
+/**
+ * struct dwc_pcie_rasdes_priv - Stores file specific private data information
+ * @pci: Reference to the dw_pcie structure
+ * @idx: Index to point to specific file related information in array of structs
+ *
+ * All debugfs files will have this struct as its private data.
+ */
+struct dwc_pcie_rasdes_priv {
+	struct dw_pcie *pci;
+	int idx;
+};
+
+/**
+ * struct dwc_pcie_err_inj - Store details about each error injection supported by DWC RASDES
+ * @name: Name of the error that can be injected
+ * @err_inj_group: Group number to which the error belongs to. Value can range from 0 - 5
+ * @err_inj_type: Each group can have multiple types of error
+ */
+struct dwc_pcie_err_inj {
+	const char *name;
+	u32 err_inj_group;
+	u32 err_inj_type;
+};
+
+static const struct dwc_pcie_err_inj err_inj_list[] = {
+	{"tx_lcrc", 0x0, 0x0},
+	{"b16_crc_dllp", 0x0, 0x1},
+	{"b16_crc_upd_fc", 0x0, 0x2},
+	{"tx_ecrc", 0x0, 0x3},
+	{"fcrc_tlp", 0x0, 0x4},
+	{"parity_tsos", 0x0, 0x5},
+	{"parity_skpos", 0x0, 0x6},
+	{"rx_lcrc", 0x0, 0x8},
+	{"rx_ecrc", 0x0, 0xb},
+	{"tlp_err_seq", 0x1, 0x0},
+	{"ack_nak_dllp_seq", 0x1, 0x1},
+	{"ack_nak_dllp", 0x2, 0x0},
+	{"upd_fc_dllp", 0x2, 0x1},
+	{"nak_dllp", 0x2, 0x2},
+	{"inv_sync_hdr_sym", 0x3, 0x0},
+	{"com_pad_ts1", 0x3, 0x1},
+	{"com_pad_ts2", 0x3, 0x2},
+	{"com_fts", 0x3, 0x3},
+	{"com_idl", 0x3, 0x4},
+	{"end_edb", 0x3, 0x5},
+	{"stp_sdp", 0x3, 0x6},
+	{"com_skp", 0x3, 0x7},
+	{"posted_tlp_hdr", 0x4, 0x0},
+	{"non_post_tlp_hdr", 0x4, 0x1},
+	{"cmpl_tlp_hdr", 0x4, 0x2},
+	{"posted_tlp_data", 0x4, 0x4},
+	{"non_post_tlp_data", 0x4, 0x5},
+	{"cmpl_tlp_data", 0x4, 0x6},
+	{"duplicate_dllp", 0x5, 0x0},
+	{"nullified_tlp", 0x5, 0x1},
+};
+
+static const u32 err_inj_type_mask[] = {
+	EINJ0_TYPE,
+	EINJ1_TYPE,
+	EINJ2_TYPE,
+	EINJ3_TYPE,
+	EINJ4_TYPE,
+	EINJ5_TYPE,
+};
+
 static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
 {
 	struct dw_pcie *pci = file->private_data;
@@ -93,6 +173,63 @@ static ssize_t rx_valid_write(struct file *file, const char __user *buf, size_t
 	return lane_detect_write(file, buf, count, ppos);
 }
 
+static ssize_t err_inj_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
+	struct dw_pcie *pci = pdata->pci;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	u32 val, counter, vc_num, err_group, type_mask;
+	int val_diff = 0;
+	char *kern_buf;
+
+	err_group = err_inj_list[pdata->idx].err_inj_group;
+	type_mask = err_inj_type_mask[err_group];
+
+	kern_buf = memdup_user_nul(buf, count);
+	if (IS_ERR(kern_buf))
+		return PTR_ERR(kern_buf);
+
+	if (err_group == 4) {
+		val = sscanf(kern_buf, "%u %d %u", &counter, &val_diff, &vc_num);
+		if ((val != 3) || (val_diff < -4095 || val_diff > 4095)) {
+			kfree(kern_buf);
+			return -EINVAL;
+		}
+	} else if (err_group == 1) {
+		val = sscanf(kern_buf, "%u %d", &counter, &val_diff);
+		if ((val != 2) || (val_diff < -4095 || val_diff > 4095)) {
+			kfree(kern_buf);
+			return -EINVAL;
+		}
+	} else {
+		val = kstrtou32(kern_buf, 0, &counter);
+		if (val) {
+			kfree(kern_buf);
+			return val;
+		}
+	}
+
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group));
+	val &= ~(type_mask | EINJ_COUNT);
+	val |= ((err_inj_list[pdata->idx].err_inj_type << EINJ_TYPE_SHIFT) & type_mask);
+	val |= FIELD_PREP(EINJ_COUNT, counter);
+
+	if (err_group == 1 || err_group == 4) {
+		val &= ~(EINJ_VAL_DIFF);
+		val |= FIELD_PREP(EINJ_VAL_DIFF, val_diff);
+	}
+	if (err_group == 4) {
+		val &= ~(EINJ_VC_NUM);
+		val |= FIELD_PREP(EINJ_VC_NUM, vc_num);
+	}
+
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group), val);
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ_ENABLE_REG, (0x1 << err_group));
+
+	kfree(kern_buf);
+	return count;
+}
+
 #define dwc_debugfs_create(name)			\
 debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
 			&dbg_ ## name ## _fops)
@@ -107,6 +244,11 @@ static const struct file_operations dbg_ ## name ## _fops = {	\
 DWC_DEBUGFS_FOPS(lane_detect);
 DWC_DEBUGFS_FOPS(rx_valid);
 
+static const struct file_operations dwc_pcie_err_inj_ops = {
+	.open = simple_open,
+	.write = err_inj_write,
+};
+
 static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
 {
 	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
@@ -116,10 +258,11 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
 
 static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 {
-	struct dentry *rasdes_debug;
+	struct dentry *rasdes_debug, *rasdes_err_inj;
 	struct dwc_pcie_rasdes_info *rasdes_info;
+	struct dwc_pcie_rasdes_priv *priv_tmp;
 	struct device *dev = pci->dev;
-	int ras_cap;
+	int ras_cap, i, ret;
 
 	ras_cap = dw_pcie_find_rasdes_capability(pci);
 	if (!ras_cap) {
@@ -133,6 +276,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 
 	/* Create subdirectories for Debug, Error injection, Statistics */
 	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
+	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
 
 	mutex_init(&rasdes_info->reg_event_lock);
 	rasdes_info->ras_cap_offset = ras_cap;
@@ -142,7 +286,24 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
 	dwc_debugfs_create(lane_detect);
 	dwc_debugfs_create(rx_valid);
 
+	/* Create debugfs files for Error injection subdirectory */
+	for (i = 0; i < ARRAY_SIZE(err_inj_list); i++) {
+		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
+		if (!priv_tmp) {
+			ret = -ENOMEM;
+			goto err_deinit;
+		}
+
+		priv_tmp->idx = i;
+		priv_tmp->pci = pci;
+		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
+				    &dwc_pcie_err_inj_ops);
+	}
 	return 0;
+
+err_deinit:
+	dwc_pcie_rasdes_debugfs_deinit(pci);
+	return ret;
 }
 
 void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout4.samsung.com (mailout4.samsung.com [203.254.224.34])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 14EBE20ADE6
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:04 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.34
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221947; cv=none; b=ey65/CamKMKqn6qsZLXt/a4CkaVu2B0Ryx4U//7TkvqQbvJ34cX1tz1tfm7zlah/KAUU+4lh7JzuB0EYjpCSg5cY5zzjjZlABSgSMhcoAoedA2JhisLzrmdhrJ7tDdPoiInPMT1B73un1XQ/LpSovtnbTRSRouCsAbVDnIq5yqw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221947; c=relaxed/simple;
	bh=UErRy9Sw4+TXAHSMmOVde1Pi1qst9FmVWm11bO2eWmc=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:Content-Type:
	 References; b=EKoFyj2WSL8oAPTlqFZI96tVwkoXLaar8xxkPXLh925K/dZ6wQNVhFUJWATrwIY0v728BNcjkmWXZDdRAhYgPnEBJpPHQgO6buRsMfKgGUONxSEUK5LfqKjEeg6TSTn4HsPvS3Qa7FanBS2ImQAkhFNo4y/PJGpiWMnel0U/AEY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=YdhfHQ4o; arc=none smtp.client-ip=203.254.224.34
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="YdhfHQ4o"
Received: from epcas5p2.samsung.com (unknown [182.195.41.40])
	by mailout4.samsung.com (KnoxPortal) with ESMTP id 20250222105903epoutp045fb17d61bde731a13464d2038336b647~mgqMrreTC1971219712epoutp04w
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:59:03 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout4.samsung.com 20250222105903epoutp045fb17d61bde731a13464d2038336b647~mgqMrreTC1971219712epoutp04w
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221943;
	bh=iSdQRQyM2uFwkHH+hdSLfO37l0/r8LVgCgbkFMLODJw=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=YdhfHQ4oVL+jYrjIPIyAU9P0bEc7bvXjTH2i4vk/9BQWvGdbTGunQnx9IzTiXqAAA
	 H1Pg/1qcimwOONIbsEgkguYaeE4/XNnlmI4T4q+lH2TIkyDt9nT+bpyeUGdbcDoOMO
	 rCh/C6ms+gMMZXgun5UwC+uFTfJfyvqeDtmL5l+k=
Received: from epsnrtp4.localdomain (unknown [182.195.42.165]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTP id
	20250222105902epcas5p12535730417f5320269778e70eb9adc18~mgqMB0gGV1724917249epcas5p1B;
	Sat, 22 Feb 2025 10:59:02 +0000 (GMT)
Received: from epsmgec5p1new.samsung.com (unknown [182.195.38.180]) by
	epsnrtp4.localdomain (Postfix) with ESMTP id 4Z0PBX6PN2z4x9Pv; Sat, 22 Feb
	2025 10:59:00 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmgec5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	CA.12.19710.4FDA9B76; Sat, 22 Feb 2025 19:59:00 +0900 (KST)
Received: from epsmtrp1.samsung.com (unknown [182.195.40.13]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTPA id
	20250221132035epcas5p47221a5198df9bf86020abcefdfded789~mO8fWGfF42570425704epcas5p4k;
	Fri, 21 Feb 2025 13:20:35 +0000 (GMT)
Received: from epsmgms1p2new.samsung.com (unknown [182.195.42.42]) by
	epsmtrp1.samsung.com (KnoxPortal) with ESMTP id
	20250221132035epsmtrp1068507ee0e753fde911714b6ad54e3ad~mO8fVGF833121131211epsmtrp1k;
	Fri, 21 Feb 2025 13:20:35 +0000 (GMT)
X-AuditID: b6c32a44-36bdd70000004cfe-24-67b9adf41b9f
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	80.3F.18949.3AD78B76; Fri, 21 Feb 2025 22:20:35 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132032epsmtip2990f5d7d3223c90064ce128a52b2e813~mO8caHK4o0684606846epsmtip28;
	Fri, 21 Feb 2025 13:20:32 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Date: Fri, 21 Feb 2025 18:45:46 +0530
Message-Id: <20250221131548.59616-4-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
X-Brightmail-Tracker: H4sIAAAAAAAAA0WTe0xbVRzHPfe2twWH3vGYBwyzu4wsAyntKN1hPMYiIZfMhDISNRjDarlp
	CaVt+pgwIVSozjFhY2524ICCIF2Zg5RHyitrgAx14KYg2xRkQ0ICPpG6ZLIy+5r+9/md7/d7
	fjm/cw4XD50iorjFKj2jVUmVFBHMGpzYvy/B9cWQXHDblYDmTm1xkHliD+qoVqAb56w4qu5e
	ZCOrq5GDbG3zBDJ+tMVG9p/n2Wh2+DKBZlqmCDQ3cI2FTI9NLLRoOs1GnXe+xZB7cAyg9gEX
	B7XVrAH0ZNTBQXUTlci0kIz+eNRHZO6iP7NeYNNXW64CeqhpkUNb7AbaNPkbm7bbThP0wvwo
	QQ89SKFX5swY3ddRRdf32wC9ad8t2VFQkqZgpEWMlseoZOqiYpU8nTqaX/hKYbJYIEwQpqCD
	FE8lLWXSqaxXJQnZxUrPaSneCanS4FmSSHU6KjEjTas26BmeQq3Tp1OMpkipEWn4OmmpzqCS
	81WM/pBQIDiQ7DEeL1F0zHdxND8wZZa2T1hGcOq1WsDlQlIEP3ZX1IJgbig5AmBvTxPLX/wF
	4IzzHvAXDwG09Ex7lCBfwnjpdkAYA/BKqxXzCqGkC8Dm33leJsg4+N7ftbiXw8n3AZxc3eUN
	4OQgDp1Wq08II7Ph+BmnL8wiY+Fj5wLbyyHkIdi+vYr7u70Eu3udPg4iU6HtGzPm3QiSK1zo
	nlkn/KYs2FC3HAiEwfWpfo6fo+Da2Q8CLIdX+i4FPEr4sK8D8/Nh6Jy7zPIOAyf3w57hRP9y
	NLz49TWfBSefg3VbKwF7CHS0POUY6HKPBqYSCVtuzLL9TMOGrU7MP6F6AOvcJtY5sLvp/xYW
	AGwgktHoSuWMLFkjVDHv/HdrMnWpHfhedFyWA9xt3eaPA4wLxgHk4lR4SILeIQ8NKZKWn2S0
	6kKtQcnoxkGyZ4ANeFSETO35Eip9oVCUIhCJxWJRSpJYSL0QUjNkkoeScqmeKWEYDaN9msO4
	QVFGLH9r6XD+0t3ce+U/yZbib2JUSWRnZWZnqitv/MTL2/EXlsNizAX63AdHCcNmY8Snbblv
	0/vCovZMVnSvLSdZinvl0xn1Bwfi1wduTYtWH/FNrVXumtfXjj+hJ2PA2pm8mtKKiBziZGy0
	7cjYG5UlVdvsD+38t1KDBL1xWFnawK2Cncdks5V5/Irq+Xcnn9178cfMvS9mGL5UpJrB2Y07
	O5e5z69ayooaGmOGv7s+PRVOj5h/uZmoUm7EWsxWXub9z7scvc+E7Tig/id1QbK6UH3/q+Gu
	P8eOOMrzNJv917M3m40zb07lSDKSNmZl328zzTmSDbFxNLh95Pyv8vPHKqI1gxRLp5AK43Ct
	TvovVCc0t1oEAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFmpgkeLIzCtJLcpLzFFi42LZdlhJXndx7Y50g4tNwhZX2n+zW0w/rGix
	pCnD4tiEFcwWTavvslqs+DKT3WLVwmtsFg09v1ktNj2+xmpxedccNouz846zWVzZuo7FouVP
	C4vF3ZZOVoul1y8yWfzdtpfRYtHWL+wWC5tfMlr837OD3aL3cK1Fyx1Ti/c/N7M5iHksXjGF
	1WPNvDWMHjtn3WX3WLCp1KPlyFtWj02rOtk87lzbw+ax86Glx5Mr05k8Ni+p9+jbsorR4/Mm
	uQCeKC6blNSczLLUIn27BK6MJdeWsxfcSq1YsHAaSwNje1gXIyeHhICJRMOMC4xdjFwcQgK7
	GSWedrxhg0hISny+uI4JwhaWWPnvOTtE0SdGiSud/1lAEmwCWhKNX7uYQRIiAp2MEnuPvAOr
	YhY4xywx83MLI0iVsICbxKHuA2CjWARUJf4cuMMKYvMKWEks+veMGWKFvMTqDQfAbE4Ba4lV
	56aD1QsB1ezZcp91AiPfAkaGVYySqQXFuem5xYYFRnmp5XrFibnFpXnpesn5uZsYwZGkpbWD
	cc+qD3qHGJk4GA8xSnAwK4nw6pbsSBfiTUmsrEotyo8vKs1JLT7EKM3BoiTO++11b4qQQHpi
	SWp2ampBahFMlomDU6qBad5KjXXOaVU/7r37ki8jcIzp+818w6tLNjw0scwOP3jtebHo380l
	rw2Ef2dZed4s2KmVLyJz2v771JAl1QKi7fNKrDZvSDy6W+CpoN9a84btfx88L7gZZ3z1hmn3
	tM3f/89r/X9472yLL2pdPAvztppO4I5y+Vd0TNVjVqPJZkW+3ScfP3uS9bpC/bWopPmWhJPf
	2jd5Vvav+CV07GuIwAPOczf6smYsmZiVtyGtSjNoW63g4z2SF5K4J/GrrLCc9sRht0b+zDiG
	bzNuVt1X2WZ5xWzLXUvNyqrjJe0X5ThWuP6/dGPrXpNrqneL2CvNPz+T5xCUKC7+8P73C7VC
	9XNyAg9uvwl/Nl10paWbaakSS3FGoqEWc1FxIgAB/lHIEwMAAA==
X-CMS-MailID: 20250221132035epcas5p47221a5198df9bf86020abcefdfded789
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132035epcas5p47221a5198df9bf86020abcefdfded789
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>

Add support to provide silicon debug interface to userspace. This set
of debug registers are part of the RASDES feature present in DesignWare
PCIe controllers.

Signed-off-by: Shradha Todi <shradha.t@samsung.com>
---
 Documentation/ABI/testing/debugfs-dwc-pcie    |  13 ++
 drivers/pci/controller/dwc/Kconfig            |  10 +
 drivers/pci/controller/dwc/Makefile           |   1 +
 .../controller/dwc/pcie-designware-debugfs.c  | 176 ++++++++++++++++++
 .../pci/controller/dwc/pcie-designware-ep.c   |   5 +
 .../pci/controller/dwc/pcie-designware-host.c |   6 +
 drivers/pci/controller/dwc/pcie-designware.c  |   6 +
 drivers/pci/controller/dwc/pcie-designware.h  |  21 +++
 include/linux/pcie-dwc.h                      |   2 +
 9 files changed, 240 insertions(+)
 create mode 100644 Documentation/ABI/testing/debugfs-dwc-pcie
 create mode 100644 drivers/pci/controller/dwc/pcie-designware-debugfs.c

diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
new file mode 100644
index 000000000000..e8ed34e988ef
--- /dev/null
+++ b/Documentation/ABI/testing/debugfs-dwc-pcie
@@ -0,0 +1,13 @@
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_debug/lane_detect
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	(RW) Write the lane number to be checked for detection.	Read
+		will return whether PHY indicates receiver detection on the
+		selected lane. The default selected lane is Lane0.
+
+What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_debug/rx_valid
+Date:		Feburary 2025
+Contact:	Shradha Todi <shradha.t@samsung.com>
+Description:	(RW) Write the lane number to be checked as valid or invalid. Read
+		will return the status of PIPE RXVALID signal of the selected lane.
+		The default selected lane is Lane0.
diff --git a/drivers/pci/controller/dwc/Kconfig b/drivers/pci/controller/dwc/Kconfig
index b6d6778b0698..48a10428a492 100644
--- a/drivers/pci/controller/dwc/Kconfig
+++ b/drivers/pci/controller/dwc/Kconfig
@@ -6,6 +6,16 @@ menu "DesignWare-based PCIe controllers"
 config PCIE_DW
 	bool
 
+config PCIE_DW_DEBUGFS
+	default y
+	depends on DEBUG_FS
+	depends on PCIE_DW_HOST || PCIE_DW_EP
+	bool "DWC PCIe debugfs entries"
+	help
+	  Enables debugfs entries for the DW PCIe Controller. These entries
+	  provide all debug features related to DW controller including the RAS
+	  DES features to help in debug, error injection and statistical counters.
+
 config PCIE_DW_HOST
 	bool
 	select PCIE_DW
diff --git a/drivers/pci/controller/dwc/Makefile b/drivers/pci/controller/dwc/Makefile
index a8308d9ea986..54565eedc52c 100644
--- a/drivers/pci/controller/dwc/Makefile
+++ b/drivers/pci/controller/dwc/Makefile
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0
 obj-$(CONFIG_PCIE_DW) += pcie-designware.o
+obj-$(CONFIG_PCIE_DW_DEBUGFS) += pcie-designware-debugfs.o
 obj-$(CONFIG_PCIE_DW_HOST) += pcie-designware-host.o
 obj-$(CONFIG_PCIE_DW_EP) += pcie-designware-ep.o
 obj-$(CONFIG_PCIE_DW_PLAT) += pcie-designware-plat.o
diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
new file mode 100644
index 000000000000..3887a6996706
--- /dev/null
+++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
@@ -0,0 +1,176 @@
+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Synopsys DesignWare PCIe controller debugfs driver
+ *
+ * Copyright (C) 2025 Samsung Electronics Co., Ltd.
+ *		http://www.samsung.com
+ *
+ * Author: Shradha Todi <shradha.t@samsung.com>
+ */
+
+#include <linux/debugfs.h>
+
+#include "pcie-designware.h"
+
+#define SD_STATUS_L1LANE_REG		0xb0
+#define PIPE_RXVALID			BIT(18)
+#define PIPE_DETECT_LANE		BIT(17)
+#define LANE_SELECT			GENMASK(3, 0)
+
+#define DWC_DEBUGFS_BUF_MAX		128
+
+/**
+ * struct dwc_pcie_rasdes_info - Stores controller common information
+ * @ras_cap_offset: RAS DES vendor specific extended capability offset
+ * @reg_event_lock: Mutex used for RASDES shadow event registers
+ *
+ * Any parameter constant to all files of the debugfs hierarchy for a single controller
+ * will be stored in this struct. It is allocated and assigned to controller specific
+ * struct dw_pcie during initialization.
+ */
+struct dwc_pcie_rasdes_info {
+	u32 ras_cap_offset;
+	struct mutex reg_event_lock;
+};
+
+static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dw_pcie *pci = file->private_data;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
+	ssize_t pos;
+	u32 val;
+
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
+	val = FIELD_GET(PIPE_DETECT_LANE, val);
+	if (val)
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane Detected\n");
+	else
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane Undetected\n");
+
+	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
+}
+
+static ssize_t lane_detect_write(struct file *file, const char __user *buf,
+				 size_t count, loff_t *ppos)
+{
+	struct dw_pcie *pci = file->private_data;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	u32 lane, val;
+
+	val = kstrtou32_from_user(buf, count, 0, &lane);
+	if (val)
+		return val;
+
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
+	val &= ~(LANE_SELECT);
+	val |= FIELD_PREP(LANE_SELECT, lane);
+	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG, val);
+
+	return count;
+}
+
+static ssize_t rx_valid_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
+{
+	struct dw_pcie *pci = file->private_data;
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
+	ssize_t pos;
+	u32 val;
+
+	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
+	val = FIELD_GET(PIPE_RXVALID, val);
+	if (val)
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "RX Valid\n");
+	else
+		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "RX Invalid\n");
+
+	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
+}
+
+static ssize_t rx_valid_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
+{
+	return lane_detect_write(file, buf, count, ppos);
+}
+
+#define dwc_debugfs_create(name)			\
+debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
+			&dbg_ ## name ## _fops)
+
+#define DWC_DEBUGFS_FOPS(name)					\
+static const struct file_operations dbg_ ## name ## _fops = {	\
+	.open = simple_open,				\
+	.read = name ## _read,				\
+	.write = name ## _write				\
+}
+
+DWC_DEBUGFS_FOPS(lane_detect);
+DWC_DEBUGFS_FOPS(rx_valid);
+
+static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
+{
+	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
+
+	mutex_destroy(&rinfo->reg_event_lock);
+}
+
+static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
+{
+	struct dentry *rasdes_debug;
+	struct dwc_pcie_rasdes_info *rasdes_info;
+	struct device *dev = pci->dev;
+	int ras_cap;
+
+	ras_cap = dw_pcie_find_rasdes_capability(pci);
+	if (!ras_cap) {
+		dev_dbg(dev, "no RASDES capability available\n");
+		return -ENODEV;
+	}
+
+	rasdes_info = devm_kzalloc(dev, sizeof(*rasdes_info), GFP_KERNEL);
+	if (!rasdes_info)
+		return -ENOMEM;
+
+	/* Create subdirectories for Debug, Error injection, Statistics */
+	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
+
+	mutex_init(&rasdes_info->reg_event_lock);
+	rasdes_info->ras_cap_offset = ras_cap;
+	pci->debugfs->rasdes_info = rasdes_info;
+
+	/* Create debugfs files for Debug subdirectory */
+	dwc_debugfs_create(lane_detect);
+	dwc_debugfs_create(rx_valid);
+
+	return 0;
+}
+
+void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
+{
+	dwc_pcie_rasdes_debugfs_deinit(pci);
+	debugfs_remove_recursive(pci->debugfs->debug_dir);
+}
+
+int dwc_pcie_debugfs_init(struct dw_pcie *pci)
+{
+	char dirname[DWC_DEBUGFS_BUF_MAX];
+	struct device *dev = pci->dev;
+	struct debugfs_info *debugfs;
+	struct dentry *dir;
+	int ret;
+
+	/* Create main directory for each platform driver */
+	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
+	dir = debugfs_create_dir(dirname, NULL);
+	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
+	if (!debugfs)
+		return -ENOMEM;
+
+	debugfs->debug_dir = dir;
+	pci->debugfs = debugfs;
+	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
+	if (ret)
+		dev_dbg(dev, "RASDES debugfs init failed\n");
+
+	return 0;
+}
diff --git a/drivers/pci/controller/dwc/pcie-designware-ep.c b/drivers/pci/controller/dwc/pcie-designware-ep.c
index 72418160e658..f9d7f3f989ad 100644
--- a/drivers/pci/controller/dwc/pcie-designware-ep.c
+++ b/drivers/pci/controller/dwc/pcie-designware-ep.c
@@ -814,6 +814,7 @@ void dw_pcie_ep_cleanup(struct dw_pcie_ep *ep)
 {
 	struct dw_pcie *pci = to_dw_pcie_from_ep(ep);
 
+	dwc_pcie_debugfs_deinit(pci);
 	dw_pcie_edma_remove(pci);
 }
 EXPORT_SYMBOL_GPL(dw_pcie_ep_cleanup);
@@ -989,6 +990,10 @@ int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
 
 	dw_pcie_ep_init_non_sticky_registers(pci);
 
+	ret = dwc_pcie_debugfs_init(pci);
+	if (ret)
+		goto err_remove_edma;
+
 	return 0;
 
 err_remove_edma:
diff --git a/drivers/pci/controller/dwc/pcie-designware-host.c b/drivers/pci/controller/dwc/pcie-designware-host.c
index ffaded8f2df7..2081e8c72d12 100644
--- a/drivers/pci/controller/dwc/pcie-designware-host.c
+++ b/drivers/pci/controller/dwc/pcie-designware-host.c
@@ -548,6 +548,10 @@ int dw_pcie_host_init(struct dw_pcie_rp *pp)
 	if (pp->ops->post_init)
 		pp->ops->post_init(pp);
 
+	ret = dwc_pcie_debugfs_init(pci);
+	if (ret)
+		goto err_stop_link;
+
 	return 0;
 
 err_stop_link:
@@ -572,6 +576,8 @@ void dw_pcie_host_deinit(struct dw_pcie_rp *pp)
 {
 	struct dw_pcie *pci = to_dw_pcie_from_pp(pp);
 
+	dwc_pcie_debugfs_deinit(pci);
+
 	pci_stop_root_bus(pp->bridge->bus);
 	pci_remove_root_bus(pp->bridge->bus);
 
diff --git a/drivers/pci/controller/dwc/pcie-designware.c b/drivers/pci/controller/dwc/pcie-designware.c
index a7c0671c6715..3d1d95d9e380 100644
--- a/drivers/pci/controller/dwc/pcie-designware.c
+++ b/drivers/pci/controller/dwc/pcie-designware.c
@@ -323,6 +323,12 @@ static u16 dw_pcie_find_vsec_capability(struct dw_pcie *pci,
 	return 0;
 }
 
+u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci)
+{
+	return dw_pcie_find_vsec_capability(pci, dwc_pcie_rasdes_vsec_ids);
+}
+EXPORT_SYMBOL_GPL(dw_pcie_find_rasdes_capability);
+
 int dw_pcie_read(void __iomem *addr, int size, u32 *val)
 {
 	if (!IS_ALIGNED((uintptr_t)addr, size)) {
diff --git a/drivers/pci/controller/dwc/pcie-designware.h b/drivers/pci/controller/dwc/pcie-designware.h
index 501d9ddfea16..7f9807d4e5de 100644
--- a/drivers/pci/controller/dwc/pcie-designware.h
+++ b/drivers/pci/controller/dwc/pcie-designware.h
@@ -437,6 +437,11 @@ struct dw_pcie_ops {
 	void	(*stop_link)(struct dw_pcie *pcie);
 };
 
+struct debugfs_info {
+	struct dentry		*debug_dir;
+	void			*rasdes_info;
+};
+
 struct dw_pcie {
 	struct device		*dev;
 	void __iomem		*dbi_base;
@@ -465,6 +470,7 @@ struct dw_pcie {
 	struct reset_control_bulk_data	core_rsts[DW_PCIE_NUM_CORE_RSTS];
 	struct gpio_desc		*pe_rst;
 	bool			suspended;
+	struct debugfs_info	*debugfs;
 };
 
 #define to_dw_pcie_from_pp(port) container_of((port), struct dw_pcie, pp)
@@ -478,6 +484,7 @@ void dw_pcie_version_detect(struct dw_pcie *pci);
 
 u8 dw_pcie_find_capability(struct dw_pcie *pci, u8 cap);
 u16 dw_pcie_find_ext_capability(struct dw_pcie *pci, u8 cap);
+u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci);
 
 int dw_pcie_read(void __iomem *addr, int size, u32 *val);
 int dw_pcie_write(void __iomem *addr, int size, u32 val);
@@ -806,4 +813,18 @@ dw_pcie_ep_get_func_from_ep(struct dw_pcie_ep *ep, u8 func_no)
 	return NULL;
 }
 #endif
+
+#ifdef CONFIG_PCIE_DW_DEBUGFS
+int dwc_pcie_debugfs_init(struct dw_pcie *pci);
+void dwc_pcie_debugfs_deinit(struct dw_pcie *pci);
+#else
+static inline int dwc_pcie_debugfs_init(struct dw_pcie *pci)
+{
+	return 0;
+}
+static inline void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
+{
+}
+#endif
+
 #endif /* _PCIE_DESIGNWARE_H */
diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
index 40f3545731c8..6436e7fadc75 100644
--- a/include/linux/pcie-dwc.h
+++ b/include/linux/pcie-dwc.h
@@ -28,6 +28,8 @@ static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
 	  .vsec_id = 0x02, .vsec_rev = 0x4 },
 	{ .vendor_id = PCI_VENDOR_ID_QCOM,
 	  .vsec_id = 0x02, .vsec_rev = 0x4 },
+	{ .vendor_id = PCI_VENDOR_ID_SAMSUNG,
+	  .vsec_id = 0x02, .vsec_rev = 0x4 },
 	{} /* terminator */
 };
 
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout2.samsung.com (mailout2.samsung.com [203.254.224.25])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 72FD420A5E0
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:58:59 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.25
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221941; cv=none; b=PxD6Fbd5HUlNlNNkuK8Se/LHaNk5nTs1OaeyHIpmcJEE513AgWdoP3QdvZlNTY3tsQmS1j2gX/BZ2sUI+LGtLor0/YKXcNRaZYtpzZCRpr4wv9aAoVIAgiEcjOpiW2ZKG14r7fa56om+e3RDzzZ4WkOqypFKCwuPz6aMYSuwp7s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221941; c=relaxed/simple;
	bh=cueEm+OrWqNBIOOcoFP6l+BctEXzgi2OEUN9dowOhZs=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:Content-Type:
	 References; b=FDmjA5Cypp0eDWKRKbUwxsfqiVud2m6/U20xafCY+8wezS3bGvVS1i+5uHy0dJenvkG+i7fKBqT3Kb0IYur26H3k74M24x+N4hD3IueFl/QBJ3B1HiUFxHmnDvjEFDIcp6iX9jT4vpyTPe80LUNuhSSGrChkE8TjMH+D5cbPNyI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=s4V3hfOC; arc=none smtp.client-ip=203.254.224.25
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="s4V3hfOC"
Received: from epcas5p4.samsung.com (unknown [182.195.41.42])
	by mailout2.samsung.com (KnoxPortal) with ESMTP id 20250222105857epoutp023142f05d3118576a878b3190739ed2cd~mgqHa1QlQ3039330393epoutp02H
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:58:57 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.samsung.com 20250222105857epoutp023142f05d3118576a878b3190739ed2cd~mgqHa1QlQ3039330393epoutp02H
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221937;
	bh=8xaQoVyMvAnEJND9PMyo7aPtb90ClrusWZzGMSDtc3o=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=s4V3hfOCov0IeoPlongmyGjHMpDgKgAgG73WigL0HVNVHk9nuUuXpJUtL3ynxio2C
	 nkZ0v7OjjcXcC5XWWYlMqnOGEbc6dis0HYUt99mml8zHrL+A9BZzeBrAtBvXmz+sEE
	 anaj0zpAbTpBy5tNva27y+DkJkC6PNvJcdin7rqQ=
Received: from epsnrtp2.localdomain (unknown [182.195.42.163]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTP id
	20250222105856epcas5p12ad9cbcbef8a224e9d3a88be15ee847a~mgqGuSki30600806008epcas5p1O;
	Sat, 22 Feb 2025 10:58:56 +0000 (GMT)
Received: from epsmges5p2new.samsung.com (unknown [182.195.38.175]) by
	epsnrtp2.localdomain (Postfix) with ESMTP id 4Z0PBQ745Wz4x9Pw; Sat, 22 Feb
	2025 10:58:54 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmges5p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	13.0B.19933.EEDA9B76; Sat, 22 Feb 2025 19:58:54 +0900 (KST)
Received: from epsmtrp1.samsung.com (unknown [182.195.40.13]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTPA id
	20250221132029epcas5p1e56dd355e7ac912ceb25325595de0d24~mO8ZeZAZz3253332533epcas5p1t;
	Fri, 21 Feb 2025 13:20:29 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp1.samsung.com (KnoxPortal) with ESMTP id
	20250221132029epsmtrp140aa667a60d9a943a41b0767fed556f4~mO8Zdax1P3135131351epsmtrp1-;
	Fri, 21 Feb 2025 13:20:29 +0000 (GMT)
X-AuditID: b6c32a4a-b87c770000004ddd-97-67b9adee2473
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	94.59.18729.C9D78B76; Fri, 21 Feb 2025 22:20:29 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132026epsmtip28eeedfe94505e67c2d2eb7881fe08e40~mO8WlvRVu0587405874epsmtip2i;
	Fri, 21 Feb 2025 13:20:25 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 2/5] PCI: dwc: Add helper to find the Vendor Specific
 Extended Capability (VSEC)
Date: Fri, 21 Feb 2025 18:45:45 +0530
Message-Id: <20250221131548.59616-3-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
X-Brightmail-Tracker: H4sIAAAAAAAAA0WTf0xbVRTHc/v62kKAvHSMXWrY4BGj1MAolHrLQImS7WWQjYjRhM2wZ3kW
	1tLWtjglMeNHYYPJDxmMOVk3GJNSOjAtIGWMVSCbAcFNGnQIywaIIkHmVhYXYFraov997jnf
	k+85597Lw/jfcQS8PJWe0apoJcnxZ/cOR70U/ec1uzy28nkccp5a56LG4QjUWpKLbtWaMFTS
	MYsjk+sLLjI3T3FQ0WfrOLLOT+Fosr+Jg8aNtznI2dPJRoYNAxvNGipwdPWnuyy02XsDoJYe
	Fxc1ly4B9M9AHxdVDX+KDDMJaPWZjZMSQl0x1eOUxWgBlP3CLJe6bC2gDCMrOGU1V3ComakB
	DmV/KKUWnI0sytZ6kqruNgPqiXV3RkCWIimXoXMYbTijkqlz8lTyZDItM/vN7ARJrChaJEWv
	kuEqOp9JJlPTM6L35ynd05LhH9HKAncog9bpyL2vJWnVBXomPFet0yeTjCZHqRFrYnR0vq5A
	JY9RMfpEUWxsXIJbeEyRO1v+O65ZJj7+dWgTFIHioErgx4OEGP447sQrgT+PT1wH8M5kB8t7
	eAygpajdl3kK4M8bE9h2yfTNcz7VDQCXztaBrQSfcAFouJ+6xRxCCIvXKj0FwUQZgCOLIVsF
	GNGLQYfJ5EnsIBg4M3edvcVs4kX4zf1RDwcSifDcsy6W120P7Pja4dH7EfugeaLR4wyJBzzo
	MjfhXlEqrKv6G3h5B/zjdjfXywK4VFPuYzlst533jaCET22tPoPXocPZ5DbmubuLgl39e73h
	MNgw2umRYEQQrFpf8MkDYZ9xmyOha3OA7eVQaLw16WuHgqvOasy7oWoAZ+ubsFqw+8L/FpcB
	MINQRqPLlzO6BE2cijnx37XJ1PlW4HnSwoN94OGDRzFDgMUDQwDyMDI4MFrfJ+cH5tCfFDJa
	dba2QMnohkCCe4GfY4KdMrX7T6j02SKxNFYskUjE0niJiNwVWGo3yPmEnNYzCobRMNrtOhbP
	T1DE8l/5wCQ8VLxngXvgr/RdS8vxwn6uZfpe2vTxaqUx0fKWhrZNBQgDghQRLVd/kIycWH6f
	g7uS6mqlgm/bjgz2nDGeFzYKsk5r9Iv9zMtR3dqwI/PjvPIrha7I0/cWhlJGBayytcR9l+Lm
	HJmvYHPHG9q/r886uUEojn3VQpkb09O0VsfERMtgWbc1uGHww/4zj0efvJfWPPbuO4eyyLdL
	VKfCpsfkl5QKaWTLyM21zBLoOFobUruIdh7lX/uSKXxjf1xN09gLlrOOyZrnlZNC2WFDjFl4
	5+Iv811tbZ3k4dvFUWmlKTLxowMV9oyS3yIulstWrfiKoy/LbsuIDo2vu0uydbm0SIhpdfS/
	P6S5kFsEAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFmpgkeLIzCtJLcpLzFFi42LZdlhJXndu7Y50g4brTBZX2n+zW0w/rGix
	pCnD4tiEFcwWTavvslqs+DKT3WLVwmtsFg09v1ktNj2+xmpxedccNouz846zWVzZuo7FouVP
	C4vF3ZZOVoul1y8yWfzdtpfRYtHWL+wWC5tfMlr837OD3aL3cK1Fyx1Ti/c/N7M5iHksXjGF
	1WPNvDWMHjtn3WX3WLCp1KPlyFtWj02rOtk87lzbw+ax86Glx5Mr05k8Ni+p9+jbsorR4/Mm
	uQCeKC6blNSczLLUIn27BK6Mu20vWAteC1Q8PfSXsYGxka+LkZNDQsBE4tb+aUxdjFwcQgK7
	GSW6ms6zQyQkJT5fXMcEYQtLrPz3nB2i6BOjxJbTr1lBEmwCWhKNX7uYQRIiAp2MEnuPvAOr
	YhY4xywx83MLI0iVsECyRPf0CWA2i4CqxPZ7p1hAbF4BK4lpP9dDrZCXWL3hADOIzSlgLbHq
	3HSwuBBQzZ4t91knMPItYGRYxSiZWlCcm55bbFhgmJdarlecmFtcmpeul5yfu4kRHElamjsY
	t6/6oHeIkYmD8RCjBAezkgivbsmOdCHelMTKqtSi/Pii0pzU4kOM0hwsSuK84i96U4QE0hNL
	UrNTUwtSi2CyTBycUg1Mqp8bH0k/ZrlvFRWulzuPjelfnltjmPTv/Lyrrt2XbOaWiPP0h9+b
	41fnZMfpvWz6D56EdP/CGUbrPFM+Hn3g9r3woOCSzPWNP6t/9Exw1Pv+rfnNh321vefZRS5K
	zRVbGrVp5VHXT4rKZRnHj79606xzflfD/261h0/kt3Id6pM9+iJ50xeL27HnVjSwpXUpZafJ
	aEq9yNY9UbHReDebVEnFo8N9NS5fxV6/3fl4SbqdoreCUfWc2heB/6M3FE95cjNL7PhCwYjU
	U2euqAgE6d/rZ5Z0M7tZW5nh5nM90/u3buA7Vl37khXV84JUtEJPL92yyTu+o2nZrwkKgZ/e
	HpuZcbTPfdN2qwOnn/QosRRnJBpqMRcVJwIAqOTWsBMDAAA=
X-CMS-MailID: 20250221132029epcas5p1e56dd355e7ac912ceb25325595de0d24
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132029epcas5p1e56dd355e7ac912ceb25325595de0d24
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132029epcas5p1e56dd355e7ac912ceb25325595de0d24@epcas5p1.samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>

dw_pcie_find_vsec_capability() is used by upcoming DWC APIs to find the
VSEC capabilities like PTM, RAS etc.

Co-developed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Shradha Todi <shradha.t@samsung.com>
---
 drivers/pci/controller/dwc/pcie-designware.c | 40 ++++++++++++++++++++
 1 file changed, 40 insertions(+)

diff --git a/drivers/pci/controller/dwc/pcie-designware.c b/drivers/pci/controller/dwc/pcie-designware.c
index 145e7f579072..a7c0671c6715 100644
--- a/drivers/pci/controller/dwc/pcie-designware.c
+++ b/drivers/pci/controller/dwc/pcie-designware.c
@@ -16,6 +16,7 @@
 #include <linux/gpio/consumer.h>
 #include <linux/ioport.h>
 #include <linux/of.h>
+#include <linux/pcie-dwc.h>
 #include <linux/platform_device.h>
 #include <linux/sizes.h>
 #include <linux/types.h>
@@ -283,6 +284,45 @@ u16 dw_pcie_find_ext_capability(struct dw_pcie *pci, u8 cap)
 }
 EXPORT_SYMBOL_GPL(dw_pcie_find_ext_capability);
 
+static u16 __dw_pcie_find_vsec_capability(struct dw_pcie *pci, u16 vendor_id,
+					  u16 vsec_id)
+{
+	u16 vsec = 0;
+	u32 header;
+
+	if (vendor_id != dw_pcie_readw_dbi(pci, PCI_VENDOR_ID))
+		return 0;
+
+	while ((vsec = dw_pcie_find_next_ext_capability(pci, vsec,
+						       PCI_EXT_CAP_ID_VNDR))) {
+		header = dw_pcie_readl_dbi(pci, vsec + PCI_VNDR_HEADER);
+		if (PCI_VNDR_HEADER_ID(header) == vsec_id)
+			return vsec;
+	}
+
+	return 0;
+}
+
+static u16 dw_pcie_find_vsec_capability(struct dw_pcie *pci,
+					const struct dwc_pcie_vsec_id *vsec_ids)
+{
+	const struct dwc_pcie_vsec_id *vid;
+	u16 vsec;
+	u32 header;
+
+	for (vid = vsec_ids; vid->vendor_id; vid++) {
+		vsec = __dw_pcie_find_vsec_capability(pci, vid->vendor_id,
+						      vid->vsec_id);
+		if (vsec) {
+			header = dw_pcie_readl_dbi(pci, vsec + PCI_VNDR_HEADER);
+			if (PCI_VNDR_HEADER_REV(header) == vid->vsec_rev)
+				return vsec;
+		}
+	}
+
+	return 0;
+}
+
 int dw_pcie_read(void __iomem *addr, int size, u32 *val)
 {
 	if (!IS_ALIGNED((uintptr_t)addr, size)) {
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout1.samsung.com (mailout1.samsung.com [203.254.224.24])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B40BF205E04
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:58:53 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.24
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221935; cv=none; b=kOYDm++lbgGCsal39LWmjsflNCLKKhrZ9BJbBNKBsfM2uVBiLmpxts3FFxlhZAtYRi3obbreYXoGJ0d135M8W+DVom1pEIFUyVqDyepTBNiYDbeROJEXG6qYoa0yJPDEbwvU//Qoq4Wy/KXCjuH/HQhdqs5iCh279KVx//VTDu4=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221935; c=relaxed/simple;
	bh=JB6byI0VSDtl7Av9dZCdm+hYPVy/LdDQkRZJqMY1vTs=;
	h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:Content-Type:
	 References; b=gxIUJRggA0vdsuYcD6dG92OjfeJSiQgPHrlrXEHXKL63ZyHy85xcjyt97VNzmOD1cVOa5wFp41F0RkE5IXV0/qmvKjqvvhx5qhaSVk3/FdYA5uG0gUvvm0HraeIyqCdhoY1qcS/v7UGYLe5ms5vJ0pEk4/nhO1NZur3wF2J0OKA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=PBZ0eJGW; arc=none smtp.client-ip=203.254.224.24
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="PBZ0eJGW"
Received: from epcas5p4.samsung.com (unknown [182.195.41.42])
	by mailout1.samsung.com (KnoxPortal) with ESMTP id 20250222105851epoutp01793425a69f54fdc39db0eff33edfeefb~mgqCAe8ka2488624886epoutp01H
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:58:51 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.samsung.com 20250222105851epoutp01793425a69f54fdc39db0eff33edfeefb~mgqCAe8ka2488624886epoutp01H
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221931;
	bh=j8iNv4rUSK4BcCyI65khem7cbMSrm4/FPAbuC68UIbI=;
	h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
	b=PBZ0eJGWwiWdQ4/eN6cy1x0TfafzMBa6ivvMkbHpTM1Lv7qZytcehHbNFm2j66nft
	 o/ZWIWINwmx5EGuMiDn33MOkrQB16uoMk82sscdYXIVQbgsymHNPX2fDovE2ZNNCOC
	 F92neLKEnnD8Ghz13PdPcXti+vbwCxsx+w4bCX74=
Received: from epsnrtp4.localdomain (unknown [182.195.42.165]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250222105851epcas5p3ff9deb2962954f25f151002e63fdf2f4~mgqBUL3zx3197831978epcas5p36;
	Sat, 22 Feb 2025 10:58:51 +0000 (GMT)
Received: from epsmges5p3new.samsung.com (unknown [182.195.38.179]) by
	epsnrtp4.localdomain (Postfix) with ESMTP id 4Z0PBK1wF6z4x9Pq; Sat, 22 Feb
	2025 10:58:49 +0000 (GMT)
Received: from epcas5p3.samsung.com ( [182.195.41.41]) by
	epsmges5p3new.samsung.com (Symantec Messaging Gateway) with SMTP id
	CB.7C.19956.9EDA9B76; Sat, 22 Feb 2025 19:58:49 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTPA id
	20250221132024epcas5p13d6e617805e4ef0c081227b08119871b~mO8VR5tw13253332533epcas5p1f;
	Fri, 21 Feb 2025 13:20:24 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250221132024epsmtrp28d6db9df4df799ab7b304a5441da1e75~mO8VQ3UAr1906719067epsmtrp2V;
	Fri, 21 Feb 2025 13:20:24 +0000 (GMT)
X-AuditID: b6c32a4b-fe9f470000004df4-90-67b9ade92214
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	03.59.18729.89D78B76; Fri, 21 Feb 2025 22:20:24 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132021epsmtip27b96bcc645abda7a5dbb604b12c1bd58~mO8SYgc580769307693epsmtip2I;
	Fri, 21 Feb 2025 13:20:21 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 1/5] perf/dwc_pcie: Move common DWC struct definitions to
 'pcie-dwc.h'
Date: Fri, 21 Feb 2025 18:45:44 +0530
Message-Id: <20250221131548.59616-2-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20250221131548.59616-1-shradha.t@samsung.com>
X-Brightmail-Tracker: H4sIAAAAAAAAA0WTf0xbVRTHvX197QNX8gK4Xcis+HBT0ELLWrgw6uYk+AwzwRljojFQ6bMg
	pe3ea+ccEhmUDHA0kG3hh4Djl3bAYGuBlK0YhDl0BsKyytTABtsiguwXvwlDbWnR/z7nnO/3
	nnvPvZfAAn8QhBJZOiPD6lRaSuDP7xmMiJDMnO/VSOcahch1Yl2IKgefR80FmehquRVDBW0T
	OLIuVgtRa8OYAOWfXMeR7e4Yjm5cqhWg4fohAXJ1d/CR+YmZjybMJThquXmdhzZ6+gBq7F4U
	oobCGYD+cTqEqGwwD5nHFejhml2wfzvdZD2N0+317YDurZkQ0mdtJtp85T5O21pLBPT4mFNA
	907F0/dclTza3vwFbelqBfSCTZy67f3sxExGpWbYMEaXoVdn6TRKKuWdtNfTFLFSmUQWj+Ko
	MJ0qh1FSSQdTJclZWvdpqbAjKq3JnUpVcRwV/WoiqzcZmbBMPWdUUoxBrTXIDVGcKocz6TRR
	OsaYIJNKYxRuYXp2ZvFkDW74RXz0wpO9+eCrkFLgR0BSDucqV3ilwJ8IJC8D+Gt1H+YN5gGc
	LunBvcEygG1VTmzL8mVnmU/VB+DGxSK+pxBILgJYtBrjYQEZCY8vlW4agskiAK/8sd1jwMge
	DPZbre4CQQSRH8Bpe7BHwyd3wbqB34CHRWQCdBRbfc2eg20X+jfZj9wLW0cqed78JAHvdPs0
	SbBwaQV4OQjODnUJvRwKFx70CbysgefsVT69Fi7bm33r7IP9rlq+ZzsYGQE7L0V708/CM9c6
	NiUYGQDL1u/55CLoqN/icLi44eR7OQTWX72Be5mGy8NbU7QAOH+xEC8H4pr/W5wFoBWEMAYu
	R8NwCsMeHfPpf3eWoc+xgc33HJniAHcmH0UNAB4BBgAkMCpYJDE6NIEiteqzYwyrT2NNWoYb
	AAr3/Cqw0Gcy9O4PoTOmyeTxUnlsbKw8fk+sjNohKuw1awJJjcrIZDOMgWG3fDzCLzSf90r+
	GtUke7mpIAIq1roipr9xdSZZ2NvZU0Llm49OVeEx1x7Mjyvto2HqnTCZ4LfFyIqij7esWe4W
	nnLkfL26Mvqh+bUFXgXRWJHc8J5yrYUTs3zRtiOHynN3vPjS2+Bkdx19+HpC9dBE2s+J7Nyu
	uG/F+eVP4XlRGvrjw/T979MDnMW1Usa2W3c0d66b6hDvHjWl3xpZ+qlU4vpzSv70Xy/EVbcf
	qv3uo32/p/TlSYoPHrC0f8KOjDWRLaLVM83chF+J+iF2wlg3vDPRGvDu4xntWynTAad/LP48
	CsDHFbMNt1Zy1blBmCjc4BQq/W+eM/39xjHs8uz5GpOJCA/Zf5vic5kqWSTGcqp/ARlCwRtY
	BAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrHLMWRmVeSWpSXmKPExsWy7bCSvO6M2h3pBjeuKFpcaf/NbjH9sKLF
	kqYMi2MTVjBbNK2+y2qx4stMdotVC6+xWTT0/Ga12PT4GqvF5V1z2CzOzjvOZnFl6zoWi5Y/
	LSwWd1s6WS2WXr/IZPF3215Gi0Vbv7BbLGx+yWjxf88Odovew7UWLXdMLd7/3MzmIOaxeMUU
	Vo8189YweuycdZfdY8GmUo+WI29ZPTat6mTzuHNtD5vHzoeWHk+uTGfy2Lyk3qNvyypGj8+b
	5AJ4orhsUlJzMstSi/TtErgyOh7MYi24Klex4Y91A+NsyS5GTg4JAROJ7vW9zF2MXBxCArsZ
	Jf4tus8EkZCU+HxxHZQtLLHy33N2EFtI4BOjxNR9fiA2m4CWROPXLrBmEYFORom9R96xgzjM
	AueYJWZ+bmEEqRIWiJQ4/HcdK4jNIqAqMffQTbA4r4CVxI6OFcwQG+QlVm84AGZzClhLrDo3
	nQlim5XEni33WScw8i1gZFjFKJlaUJybnltsWGCYl1quV5yYW1yal66XnJ+7iREcRVqaOxi3
	r/qgd4iRiYPxEKMEB7OSCK9uyY50Id6UxMqq1KL8+KLSnNTiQ4zSHCxK4rziL3pThATSE0tS
	s1NTC1KLYLJMHJxSDUym4elv3BlMv+18P89D84ifnLL+orNHd20ODt57/PVpvie1k3hFZFYo
	bLqwuY7JK4bvvIjWColp7rY/N1ScbRC+N7367D/Bsgj+QOu7hoclJH133hZvPfi0m7Gs7+9x
	0+JKE7mW03LRtwTjS7S2vD9QNVnU0mPRVzOms3l1h3+8KS7Jnf+5rjBxfrkph9CM/fczVTsj
	bocd6gu2TFj0Upbl5avz0jf4ud4p960WOPFv/W+mx5sOZ6T4qdRftw6v+5m6Yj+TuK6o/Ntt
	KypMGhekbSr88H3NEj7W51Xmz4+4rPR0LX2j+oTxgLMy4/eDy379u3Btlu2r3tXv1bc/PrU1
	ITqY9eZ8l0a2Q0cXpT1TYinOSDTUYi4qTgQAxli9+xEDAAA=
X-CMS-MailID: 20250221132024epcas5p13d6e617805e4ef0c081227b08119871b
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132024epcas5p13d6e617805e4ef0c081227b08119871b
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132024epcas5p13d6e617805e4ef0c081227b08119871b@epcas5p1.samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>

From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>

Since these are common to all Desginware PCIe IPs, move them to a new
header 'pcie-dwc.h', so that other drivers like debugfs, perf and sysfs
could make use of them.

Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Shradha Todi <shradha.t@samsung.com>
---
 MAINTAINERS                 |  1 +
 drivers/perf/dwc_pcie_pmu.c | 25 +++----------------------
 include/linux/pcie-dwc.h    | 34 ++++++++++++++++++++++++++++++++++
 3 files changed, 38 insertions(+), 22 deletions(-)
 create mode 100644 include/linux/pcie-dwc.h

diff --git a/MAINTAINERS b/MAINTAINERS
index 3864d473f52f..6474a2d83de4 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
@@ -18167,6 +18167,7 @@ S:	Maintained
 F:	Documentation/devicetree/bindings/pci/snps,dw-pcie-ep.yaml
 F:	Documentation/devicetree/bindings/pci/snps,dw-pcie.yaml
 F:	drivers/pci/controller/dwc/*designware*
+F:	include/linux/pcie-dwc.h
 
 PCI DRIVER FOR TI DRA7XX/J721E
 M:	Vignesh Raghavendra <vigneshr@ti.com>
diff --git a/drivers/perf/dwc_pcie_pmu.c b/drivers/perf/dwc_pcie_pmu.c
index cccecae9823f..da30f2c2d674 100644
--- a/drivers/perf/dwc_pcie_pmu.c
+++ b/drivers/perf/dwc_pcie_pmu.c
@@ -13,6 +13,7 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
+#include <linux/pcie-dwc.h>
 #include <linux/perf_event.h>
 #include <linux/pci.h>
 #include <linux/platform_device.h>
@@ -99,26 +100,6 @@ struct dwc_pcie_dev_info {
 	struct list_head dev_node;
 };
 
-struct dwc_pcie_pmu_vsec_id {
-	u16 vendor_id;
-	u16 vsec_id;
-	u8 vsec_rev;
-};
-
-/*
- * VSEC IDs are allocated by the vendor, so a given ID may mean different
- * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
- */
-static const struct dwc_pcie_pmu_vsec_id dwc_pcie_pmu_vsec_ids[] = {
-	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
-	  .vsec_id = 0x02, .vsec_rev = 0x4 },
-	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
-	  .vsec_id = 0x02, .vsec_rev = 0x4 },
-	{ .vendor_id = PCI_VENDOR_ID_QCOM,
-	  .vsec_id = 0x02, .vsec_rev = 0x4 },
-	{} /* terminator */
-};
-
 static ssize_t cpumask_show(struct device *dev,
 					 struct device_attribute *attr,
 					 char *buf)
@@ -529,14 +510,14 @@ static void dwc_pcie_unregister_pmu(void *data)
 
 static u16 dwc_pcie_des_cap(struct pci_dev *pdev)
 {
-	const struct dwc_pcie_pmu_vsec_id *vid;
+	const struct dwc_pcie_vsec_id *vid;
 	u16 vsec;
 	u32 val;
 
 	if (!pci_is_pcie(pdev) || !(pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT))
 		return 0;
 
-	for (vid = dwc_pcie_pmu_vsec_ids; vid->vendor_id; vid++) {
+	for (vid = dwc_pcie_rasdes_vsec_ids; vid->vendor_id; vid++) {
 		vsec = pci_find_vsec_capability(pdev, vid->vendor_id,
 						vid->vsec_id);
 		if (vsec) {
diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
new file mode 100644
index 000000000000..40f3545731c8
--- /dev/null
+++ b/include/linux/pcie-dwc.h
@@ -0,0 +1,34 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/*
+ * Copyright (C) 2021-2023 Alibaba Inc.
+ *
+ * Copyright 2025 Linaro Ltd.
+ * Author: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
+ */
+
+#ifndef LINUX_PCIE_DWC_H
+#define LINUX_PCIE_DWC_H
+
+#include <linux/pci_ids.h>
+
+struct dwc_pcie_vsec_id {
+	u16 vendor_id;
+	u16 vsec_id;
+	u8 vsec_rev;
+};
+
+/*
+ * VSEC IDs are allocated by the vendor, so a given ID may mean different
+ * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
+ */
+static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
+	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
+	  .vsec_id = 0x02, .vsec_rev = 0x4 },
+	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
+	  .vsec_id = 0x02, .vsec_rev = 0x4 },
+	{ .vendor_id = PCI_VENDOR_ID_QCOM,
+	  .vsec_id = 0x02, .vsec_rev = 0x4 },
+	{} /* terminator */
+};
+
+#endif /* LINUX_PCIE_DWC_H */
-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout2.samsung.com (mailout2.samsung.com [203.254.224.25])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A9159208986
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:57:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.25
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740221850; cv=none; b=ZtJrf31iTpXxJHsV/dywpXJ3NazgdNU5Wg7MYL4wEKsq8Df54KrE9E5rS7CeqJeewSvVvRfOKhl/BZsmmwq6unJt1LiuIzhFZkPqiJ8HX5H6cpEK55fHYBXVdS0cuMHvB7E3qN04gmeQmZOHCbYjKD4LC+TD/RIobiOEJQ6t81s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740221850; c=relaxed/simple;
	bh=e0erdF0twJYNSVrbGQobI/jjDPZ3kjL8JPlHMSiooE0=;
	h=From:To:Cc:Subject:Date:Message-Id:MIME-Version:Content-Type:
	 References; b=l13GStFTl6Q2RNwqzjQ3QXjLHaC1NJIKtegC0r5cN+R/ffI4Dus1WfesKgRlUDHA5loeBtsc5EblefwnczDgQqSucu+JKjT7S//rWByCiZEBzxpUJbHG8QNxfimmORH9SGkS61jnobUKLfLHOl9yQfKJ2iaHWZY/Q98anOpjO2k=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=K2BjfV6J; arc=none smtp.client-ip=203.254.224.25
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="K2BjfV6J"
Received: from epcas5p4.samsung.com (unknown [182.195.41.42])
	by mailout2.samsung.com (KnoxPortal) with ESMTP id 20250222105720epoutp02e99eaff60de2235ac36ee36aa7ebea65~mgotVEzTv3101231012epoutp02l
	for <linux-perf-users@vger.kernel.org>; Sat, 22 Feb 2025 10:57:20 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.samsung.com 20250222105720epoutp02e99eaff60de2235ac36ee36aa7ebea65~mgotVEzTv3101231012epoutp02l
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1740221841;
	bh=GDrRxJdDKDeQsLoUyWU3HU1LlEhYeBjbVEKvneEwPbA=;
	h=From:To:Cc:Subject:Date:References:From;
	b=K2BjfV6J4lGxm2jng5QbMlEiDd/yVjk2Gf7pu/EKg9Pwtss+fG++f7ezAYmA97utv
	 Dc8pesvP94ekih+7oTRj6sy4RzDvkfLeM1yFB2oYG4An3nTGrlPLDtFfvlXRwCcvO+
	 tg7An4jbN48dfe6u59V9GPaVH/3YfcsPMgKPpF6Q=
Received: from epsnrtp4.localdomain (unknown [182.195.42.165]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250222105720epcas5p30631c60540b66daefad7ce8b0694f303~mgosqZVgq0573205732epcas5p3p;
	Sat, 22 Feb 2025 10:57:20 +0000 (GMT)
Received: from epsmgec5p1new.samsung.com (unknown [182.195.38.176]) by
	epsnrtp4.localdomain (Postfix) with ESMTP id 4Z0P8Z29D0z4x9Pv; Sat, 22 Feb
	2025 10:57:18 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmgec5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	BF.F1.19710.E8DA9B76; Sat, 22 Feb 2025 19:57:18 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTPA id
	20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5~mO8JJOwUe2791427914epcas5p4r;
	Fri, 21 Feb 2025 13:20:11 +0000 (GMT)
Received: from epsmgmcp1.samsung.com (unknown [182.195.42.82]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250221132011epsmtrp22f7624b78aa3385ffea22835fa5d06a6~mO8JIRaK91906719067epsmtrp26;
	Fri, 21 Feb 2025 13:20:11 +0000 (GMT)
X-AuditID: b6c32a44-363dc70000004cfe-8d-67b9ad8eb5a4
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgmcp1.samsung.com (Symantec Messaging Gateway) with SMTP id
	EB.3F.33707.B8D78B76; Fri, 21 Feb 2025 22:20:11 +0900 (KST)
Received: from cheetah.samsungds.net (unknown [107.109.115.53]) by
	epsmtip2.samsung.com (KnoxPortal) with ESMTPA id
	20250221132008epsmtip24b146ccec521cc047535442a2ce80e91~mO8GTgdud0684606846epsmtip2x;
	Fri, 21 Feb 2025 13:20:08 +0000 (GMT)
From: Shradha Todi <shradha.t@samsung.com>
To: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com, Shradha Todi <shradha.t@samsung.com>
Subject: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Date: Fri, 21 Feb 2025 18:45:43 +0530
Message-Id: <20250221131548.59616-1-shradha.t@samsung.com>
X-Mailer: git-send-email 2.17.1
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrBJsWRmVeSWpSXmKPExsWy7bCmum7f2p3pBpev8Fhcaf/NbjH9sKLF
	kqYMi2MTVjBbNK2+y2qx4stMdotVC6+xWTT0/Ga12PT4GqvF5V1z2CzOzjvOZnFl6zoWi5Y/
	LSwWd1s6WS2WXr/IZPF3215Gi0Vbv7BbLGx+yWjxf88Odovew7UWLXdMLd7/3MzmIOaxeMUU
	Vo8189YweuycdZfdY8GmUo+WI29ZPTat6mTzuHNtD5vHzoeWHk+uTGfy2Lyk3qNvyypGj8+b
	5AJ4orJtMlITU1KLFFLzkvNTMvPSbZW8g+Od403NDAx1DS0tzJUU8hJzU22VXHwCdN0yc4C+
	VVIoS8wpBQoFJBYXK+nb2RTll5akKmTkF5fYKqUWpOQUmBToFSfmFpfmpevlpZZYGRoYGJkC
	FSZkZ9w5vYalYLZqxYb7X5gaGB/IdjFyckgImEi83vKXqYuRi0NIYDejxLsX7UwgCSGBT4wS
	u6dkQySA7IMTF7PDdKyZ08QKkdjJKHFn3nso5wujxL2+j2BVbAJaEo1fu5hBbBGBVkaJI8/E
	QIqYBbYxSxxYsQIsISwQJPFjXRsLiM0ioCrx/e98oGYODl4BK4k9K+0htslLrN5wAKycV0BQ
	4uTMJ2DlzEDx5q2zmSFqvnBIfJnNB2G7SCzadQPqUmGJV8e3QNlSEp/f7WWDsNMlVm6eAdWb
	I/Ft8xImCNte4sCVOSwgJzALaEqs36UPEZaVmHpqHRPEWj6J3t9PoMp5JXbMg7GVJb783cMC
	YUtKzDt2mRXC9pDYufkh2EghgViJ/v+2ExjlZyF5ZhaSZ2YhLF7AyLyKUTK1oDg3PTXZtMAw
	L7UcHq3J+bmbGMFJXstlB+ON+f/0DjEycTAeYpTgYFYS4dUt2ZEuxJuSWFmVWpQfX1Sak1p8
	iNEUGMATmaVEk/OBeSavJN7QxNLAxMzMzMTS2MxQSZy3eWdLupBAemJJanZqakFqEUwfEwen
	VAOTyWph2UVGD0z1j0+NvfvEdnGQ413ON1OnCFx4vMfJeqvN3Mp7Kx86NXwKsN+sdkziZXTt
	kesTTnswSfQ/W1W2UrvUr+Mf14yGGbL9V1cY802NfhC1Su7CI57OFPH5lz5En/srKjG9MXbJ
	wbvLF2vMuPtkX2nEE4bFtdvOlN1YvEY1xMF6apLnj5CG0sSSXn3PgKUsajzVWQ/TfU7n/lD5
	bfjrwVJLhqPcRqoTSkq8zi29HTM1wO3dCcNfq6we9H4Sbrx8ef67MN+3L8NLzveyuAo5iV1+
	s8+BVbngfu6khvO+c9YriUadC2QxkJvBY3eiVHQx3yuDqBXzeubVRsnkfzzpt9tl19/cGTOv
	1GuzKrEUZyQaajEXFScCAMosolJ7BAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrJIsWRmVeSWpSXmKPExsWy7bCSvG537Y50g2MLlC2utP9mt5h+WNFi
	SVOGxbEJK5gtmlbfZbVY8WUmu8WqhdfYLBp6frNabHp8jdXi8q45bBZn5x1ns7iydR2LRcuf
	FhaLuy2drBZLr19ksvi7bS+jxaKtX9gtFja/ZLT4v2cHu0Xv4VqLljumFu9/bmZzEPNYvGIK
	q8eaeWsYPXbOusvusWBTqUfLkbesHptWdbJ53Lm2h81j50NLjydXpjN5bF5S79G3ZRWjx+dN
	cgE8UVw2Kak5mWWpRfp2CVwZd06vYSmYrVqx4f4XpgbGB7JdjJwcEgImEmvmNLF2MXJxCAls
	Z5Q4cm4FE0RCUuLzxXVQtrDEyn/P2SGKPjFKnLi3HyzBJqAl0fi1ixkkISLQySix98g7sCpm
	gXPMEjM/tzCCVAkLBEicWbwezGYRUJX4/nc+UBEHB6+AlcSelfYQG+QlVm84wAxi8woISpyc
	+YQFpIRZQF1i/TwhkDAzUEnz1tnMExj5ZyGpmoVQNQtJ1QJG5lWMoqkFxbnpuckFhnrFibnF
	pXnpesn5uZsYwbGpFbSDcdn6v3qHGJk4GA8xSnAwK4nw6pbsSBfiTUmsrEotyo8vKs1JLT7E
	KM3BoiTOq5zTmSIkkJ5YkpqdmlqQWgSTZeLglGpg4pjMtu2b3EL3R9/vnl2nEvFC55TM2YSA
	my6J94qZeTt8782a/COa5zfzt5k3prcfseJ7luLkekH78Adlm03yN7mZkk1XMM56/M3uTPar
	ex8KP295FMh6s2nhnKm/5osxdX5TKq3b61nX9iT1YXNdyKerQsdqYjgT+VaEJK99GX3A6He8
	1XIWZ2vz9ffnsnQutJ2jtMajR/n7bM0NmbNmena/SZXhnfzD5alN2PFWrd0vK8Je8Blf3/b1
	x9bwBX5/Yl/s/XhNzGKZrer2uvBbUQqvGNOWb17bYhX/xT3W2q3tpEjcHY7SxiIpxtc63+us
	rinukH9y8IUFl3ej4vrW9/u/5z0wPMPHsW9quEntZSWW4oxEQy3mouJEAI4aFoM8AwAA
X-CMS-MailID: 20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>

DesignWare controller provides a vendor specific extended capability
called RASDES as an IP feature. This extended capability  provides
hardware information like:
 - Debug registers to know the state of the link or controller. 
 - Error injection mechanisms to inject various PCIe errors including
   sequence number, CRC
 - Statistical counters to know how many times a particular event
   occurred

However, in Linux we do not have any generic or custom support to be
able to use this feature in an efficient manner. This is the reason we
are proposing this framework. Debug and bring up time of high-speed IPs
are highly dependent on costlier hardware analyzers and this solution
will in some ways help to reduce the HW analyzer usage.

The debugfs entries can be used to get information about underlying
hardware and can be shared with user space. Separate debugfs entries has
been created to cater to all the DES hooks provided by the controller.
The debugfs entries interacts with the RASDES registers in the required
sequence and provides the meaningful data to the user. This eases the
effort to understand and use the register information for debugging.

This series creates a generic debugfs framework for DesignWare PCIe
controllers where other debug features apart from RASDES can also be
added as and when required.

v7:
    - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
      into this series to remove dependancy as discussed
    - Addressed style related change requests from v6

v6: https://lore.kernel.org/all/20250214105007.97582-1-shradha.t@samsung.com/
    - Addressed Niklas's comment to make vsec ID finding similar to perf
    - Minor changes in the driver to make the debugfs file common and
      not specefic to RASDES so that other developers can add debug
      related features to this file.

v5: https://lore.kernel.org/all/20250121111421.35437-1-shradha.t@samsung.com/
    - Addressed Fan's comment to split the patches for easier review
    - Addressed Bjorn's comment to fix vendor specific cap search
    - Addressed style related change requests from v4
    - Added rasdes debugfs init call to common designware files for host
      and EP.

v4: https://lore.kernel.org/lkml/20241206074456.17401-1-shradha.t@samsung.com/
    - Addressed comments from Manivannan, Bjorn and Jonathan
    - Addressed style related change requests from v3
    - Added Documentation under Documentation/ABI/testing and kdoc stype
      comments wherever required for better understanding
    - Enhanced error injection to include all possible error groups
    - Removed debugfs init call from common designware file and left it
      up to individual platform drivers to init/deinit as required.

v3: https://lore.kernel.org/all/20240625093813.112555-1-shradha.t@samsung.com/
    - v2 had suggestions about moving this framework to perf/EDAC instead of a
      controller specific debugfs but after discussions we decided to go ahead
      with the same. Rebased and posted v3 with minor style changes.

v2: https://lore.kernel.org/lkml/20231130115044.53512-1-shradha.t@samsung.com/
    - Addressed comments from Krzysztof WilczyÅ„ski, Bjorn Helgaas and
      posted v2 with a changed implementation for a better code design

v1: https://lore.kernel.org/all/20210518174618.42089-1-shradha.t@samsung.com/T/

[1] https://lore.kernel.org/all/20250218-pcie-qcom-ptm-v1-0-16d7e480d73e@linaro.org/

Manivannan Sadhasivam (1):
  perf/dwc_pcie: Move common DWC struct definitions to 'pcie-dwc.h'

Shradha Todi (4):
  PCI: dwc: Add helper to find the Vendor Specific Extended Capability
    (VSEC)
  Add debugfs based silicon debug support in DWC
  Add debugfs based error injection support in DWC
  Add debugfs based statistical counter support in DWC

 Documentation/ABI/testing/debugfs-dwc-pcie    | 144 +++++
 MAINTAINERS                                   |   1 +
 drivers/pci/controller/dwc/Kconfig            |  10 +
 drivers/pci/controller/dwc/Makefile           |   1 +
 .../controller/dwc/pcie-designware-debugfs.c  | 564 ++++++++++++++++++
 .../pci/controller/dwc/pcie-designware-ep.c   |   5 +
 .../pci/controller/dwc/pcie-designware-host.c |   6 +
 drivers/pci/controller/dwc/pcie-designware.c  |  46 ++
 drivers/pci/controller/dwc/pcie-designware.h  |  21 +
 drivers/perf/dwc_pcie_pmu.c                   |  25 +-
 include/linux/pcie-dwc.h                      |  36 ++
 11 files changed, 837 insertions(+), 22 deletions(-)
 create mode 100644 Documentation/ABI/testing/debugfs-dwc-pcie
 create mode 100644 drivers/pci/controller/dwc/pcie-designware-debugfs.c
 create mode 100644 include/linux/pcie-dwc.h

-- 
2.17.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f44.google.com (mail-pj1-f44.google.com [209.85.216.44])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5F56C265CB7
	for <linux-perf-users@vger.kernel.org>; Tue,  4 Mar 2025 15:30:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.44
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741102204; cv=none; b=B2WFeGh9P6ODMym26rQW2W/FIlRSp0nXB9Iv62Rvtu5LFPKuklbfDjUC7FCySkacTZetsZgkQtMsSnW1bkcakjPbwTtR7VnPKcwbNVy7wv1jp3maf9nByvSB0xbe+7Z8g4Gg+YryqaKFE7GMu1o78SrJDJl1zAg8B33Iii1SaDg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741102204; c=relaxed/simple;
	bh=DvT37mlLylWirMmvziApQyMOyXFz2tPHw47pSw/2Ns0=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=HGJMNk/T12RjIyVSMISzQBAKaiuhCoiU9/WlZIEdgoF6n8CzPTt2+63UjsCnmhz2SOcpVeh1WWAhejS9UsPo01v2nXqn/M+eu9z7P5WgIwn1PwHWkmYW+4Mp0a/O3guedn5d3alExO9s3bcJG58jFkhTClZ6dIPVOWSXu1x3Uqo=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=f0qihsw6; arc=none smtp.client-ip=209.85.216.44
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="f0qihsw6"
Received: by mail-pj1-f44.google.com with SMTP id 98e67ed59e1d1-2fee05829edso6058221a91.3
        for <linux-perf-users@vger.kernel.org>; Tue, 04 Mar 2025 07:30:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1741102202; x=1741707002; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=66psdEYIrVGR86JKMR8+mqBEFxkGfgmcukM2sBzapxc=;
        b=f0qihsw6h6E1twiuVjL+pwN2kHj+/eIdoqLQS/bM5Pu1Rcst++qQvUyQnyW4fIl3Fw
         XHmrKq6oSDnN+xGBU+RPFbDbngaZY06NTdSdDc8lixsezuXDonsQtMs1DGPVU1+5o06U
         geZyewK6D+0sAxdjsYLg23YV+TA2kHt7sp/cAAWt0tKecJxorvOrQFJpAWJlOX6rGtXT
         aiRCAFZPNplSmEsb20L7Yjy3Oy5aNa4dIG6QvrRILp33DAlP208t+V8sni5oafxqCkrI
         KowpbOlG9gjuYfBw6xi5OHCkdKYAOqnd31j/Smi9wHgI5RTMl4TKXW0BpSlgeTgElKoe
         wKNQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741102202; x=1741707002;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=66psdEYIrVGR86JKMR8+mqBEFxkGfgmcukM2sBzapxc=;
        b=fDba4cz7GfLQuFAjdv+CqtibJlpZKl/AJrknO2ytq1XxgX/pqchq3GTWFWN8nMEHE+
         zOfmp2YxS2u+WP8GTaxv32Bb4qSraCqn8JMCWOicsrkT885FlC/im/d7Au8tWc6sCeEa
         UcJlYdD++POXVZpNLqGFj6V82xpFWjgdvYbtB41Hthyl7WSxoe/cpdxf3uzRUEqv9v3H
         iurI6Z1gH+bLdFBprWRR+2WomnB1S2XjdJXjICvKCvTVnMVBzX0tZk6Dq8I5qqLmgJp5
         sAZw9oq1DbiSjpvggcpsbCqjbiAV8NwUKairTLd+95FNrlGvHu4iGWIy3BiOMBRG3HSJ
         lkmA==
X-Forwarded-Encrypted: i=1; AJvYcCWvGMXeCjhvlhnyqOE0RTc1i86aQn16NpQ0LERyoyXduHaP2iCF1gAz2SMOOOYANocCWMMSm5RrbceIV45Bavoh@vger.kernel.org
X-Gm-Message-State: AOJu0YzvJr+kOzSCU67DOH52NVjCsV3x86Wo75IMtofcaG/w5zb2lfBm
	AepJ5i0gUVufKbeOwpvLyqIg4ghasxgiaCUWYwdTeVz2g9PcdE1LJqGcnOZDtQ==
X-Gm-Gg: ASbGncuTe+GX35BZE9avL6z4A8KwDwLNtboY14IrN8ALMFhS1dD0ojYwFHlI/Hr9CiP
	UaWHoJRA0yp6rVRPluTt7+bMPkCKDZ0vJ3n8KReqePSYMCDl7cqduv2Sc7491zbIyUbSBlMwQ96
	anvfMZf7t1W0r7yyTrNVlv+xs2TZDU60Jlhlw1dU3klhiOgCMIDF67Zj5wascklCTTVjVb2pN2z
	xRAN7p48rW6B6Em9ygPAjFy2QeIYjGyu0fZegOTcpetZ9DWx4a7Z71mVLkhqQfa19ae6cErkbCo
	qag9qNgL65vI7ge0+2pnZDXcaR4U8ZS1PwYTiMSrHtk9Qc9hSQ4WiDo=
X-Google-Smtp-Source: AGHT+IHDLoudvsE8ThGCBDtv8xpmDC4PMrV1KRLn9yaD488OmdYvS42vvygcsTzqkS+txl9sTFzPNQ==
X-Received: by 2002:a05:6a20:7348:b0:1ee:be88:f5cf with SMTP id adf61e73a8af0-1f2f4e00bfbmr34435609637.32.1741102202650;
        Tue, 04 Mar 2025 07:30:02 -0800 (PST)
Received: from thinkpad ([120.60.51.199])
        by smtp.gmail.com with ESMTPSA id 41be03b00d2f7-aee7de38003sm10265993a12.33.2025.03.04.07.29.55
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 07:30:01 -0800 (PST)
Date: Tue, 4 Mar 2025 20:59:52 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, fan.ni@samsung.com,
	nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250304152952.pal66goo2dwegevh@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
 <20250303095200.GB1065658@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250303095200.GB1065658@rocinante>

On Mon, Mar 03, 2025 at 06:52:00PM +0900, Krzysztof WilczyÅ„ski wrote:
> Hello,
> 
> [...]
> > +		29) Generates duplicate TLPs - duplicate_dllp
> > +		30) Generates Nullified TLPs - nullified_tlp
> 
> Would the above field called "duplicate_dllp" for duplicate TLPs be
> a potential typo?  Perhaps this should be called "duplicate_tlp"?
> 

Looks like a typo. As per Synopsys documentation, there is only 'duplicate TLP'
field.

Good catch!

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f182.google.com (mail-pl1-f182.google.com [209.85.214.182])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9A54C13C67C;
	Tue,  4 Mar 2025 06:50:04 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.182
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741071006; cv=none; b=svUy4UO3WnFb/CbYOJ+7GGbLBXcAnfWJD7jJqTplMEnAF37wtXt4URoq+w9PBn/no7Ty8WW7gnONpI+8DmZ+QWXvUTtB/h6VB4dKf31epkqYD7mISJhoncZkLO8jt7kXcsoIsvl+8oKfXjnhEo3af8EDSXzmnqdiVMYMPqIxlbI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741071006; c=relaxed/simple;
	bh=xKkQdbXWEuT09IaRYhW1OQKL5RSJXdUnAd1yXKspPdg=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=AbS7iQtsbCkOiG7zLD+QBagmE6Q5WH1fL+jnV6WnjASwdf2qGdax0IeSeU1F2HCkuXUEvfu5GJaHM2zdP5E7oK/bgpEJrxe7nLK/zJIArhFOKBQ5byuLYx6IcDIQ0ba/xFAupAgfZRcF8IOI+yQgHBWGnO0ReKXlEE/1ItSWNbI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.182
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f182.google.com with SMTP id d9443c01a7336-22355618fd9so89754665ad.3;
        Mon, 03 Mar 2025 22:50:04 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741071004; x=1741675804;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=wdiYB6hv/Q3Efvv78nZapqYNYn3PY60w2vwZzb6NEH4=;
        b=j+HQ9POuA7SNB6pcvSuH37F32ewhyhqHBro+VQ01ujrKbkc95ZycV/iTwmv3muKpQV
         w14YoIFdJbrPeGZrKeq4Qaz6ptHjor7JV+JI0UnEay5J+O30ra+kCsrwyPa2wPcwJXvI
         RM5tKZ5GPqBHZsxYLlPoUhUibL2cqDtbJJt+QN6/rq+7AXhQJkpJMCgeaeQJ4+SZksph
         FFFbe4apdFtsuAPy70Qanp9obK2r0CiU/8cd3jVp+XVQ30PcJgCYNIGHRLt7M/gbMuj6
         ecT4RwvVGbOevXBGQvwwK8QSWuUJNd8BamC6mb52RpGnvt2rw2TVFng+CQAwMXAfJf57
         3dWg==
X-Forwarded-Encrypted: i=1; AJvYcCXHMjCil5r+eAbxiCiMtTf8UuD5fMyg8mVafNQsEUsS6pHZoo71mwCfir9k5OUrXpIjPYMStgDZZhw=@vger.kernel.org, AJvYcCXNmt63B9bnLxjU6CGb0gjNhz+Fx4Guk9vHn7c4IDw9GgJxPZRIGy5lUDyS1/Au1oh9fTa42oQ2hYRybWql5/tBgg==@vger.kernel.org
X-Gm-Message-State: AOJu0Yw2u7FA4zjM/52gavp7s2MFNp35PqgW+33FGy75QsRJgn1Ubnct
	PSCigWW308iDK20ficT9nRpuHxwtqdPRWY5hyEjjjlMBibZiMSktxS0q2eBcrmA=
X-Gm-Gg: ASbGncupyqa9DXHQTqhJvGkbSiCxXrMolb/cHjJbkLmHUOmgbfpXqeZQ1N8jiVUu/JA
	ZyX//8UkXV37fcJRD+Cts6HLdpeTkk6rWuuEQ8oLgEzPUISW8tOhIc6Ki7+pvjcl60JkFEUc3aJ
	NxN/Ut6QYaUGe+6r/ujH5y69DJVcgGHWg528QD7OPlmHQQa1GV99CU/qJuNn3MUwBq6Xd/CHjvv
	NCRk/td5eWRapIRcngOfGMPMQi1zG6eLkrL4wTIPneyUmyD0xcwj3H0E9ddT/nsAGrDxRvExZoE
	nyE2daBzvsPYfVT6TToCdKSJ2wyoI51MTzixin9CTzs7pnNoMMpF2T+568oWz0AZ+Bgd8hwCq7F
	Wu6s=
X-Google-Smtp-Source: AGHT+IGcV4aYk/OpEVH73Ug+c1C0USAo6FdZmKpOcH30W1Dx1DXHv8XdmGwDQ56GkfHpVhuZmtZPUA==
X-Received: by 2002:a17:902:ea0c:b0:21f:136a:a374 with SMTP id d9443c01a7336-22369268794mr260988655ad.43.1741071003728;
        Mon, 03 Mar 2025 22:50:03 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-223501f9dc2sm87929895ad.61.2025.03.03.22.50.02
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 22:50:03 -0800 (PST)
Date: Tue, 4 Mar 2025 15:50:00 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250304065000.GB2615015@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
 <20250303095200.GB1065658@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250303095200.GB1065658@rocinante>

Hello,

[...]
> > +		29) Generates duplicate TLPs - duplicate_dllp
> > +		30) Generates Nullified TLPs - nullified_tlp
> 
> Would the above field called "duplicate_dllp" for duplicate TLPs be
> a potential typo?  Perhaps this should be called "duplicate_tlp"?
> 
> I wanted to make sure we have the correct field name.

Fan or Shradha, any thoughts on this?

Would the problem be with the name of the property of the description?

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f174.google.com (mail-pl1-f174.google.com [209.85.214.174])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A705F1FFC60;
	Mon,  3 Mar 2025 19:51:52 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.174
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741031514; cv=none; b=nWJrYu08cfxLEOJ7WSP4ZYLsUM+pX+tYkSBhWwOU/Ue9uTm0NZu8V97KLNSR0WyUmhChjBsNGwggQeuBO3CXgN+1Eylxj+USfq1B+4ngEsmBPTks+9gJ4i3oAb742uQ1+2Qzwm2blDCw86I8QlAT3Sx3i20hNpqdqY2IF3sAs90=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741031514; c=relaxed/simple;
	bh=rS4tGKwmmJxA0t9e576pQhZJ6lWPHUT5n/rffY7QZyM=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=fPpjUG3EpLiwPRuJYy6r/FvZ//Hx5u4QKBDnSCluvYZ30WP4e8kFd27BUNw9/l8KPe5oh8HEn5BRp3U/QCktvhs1iPGm+KvCcwM2xqSNg3ChxPQrdwn7l8/VVRJxa79L7YQjAx2jb5NeHLHoR6u5deVQMch7MMmPXLPhUl9XOaA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.174
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f174.google.com with SMTP id d9443c01a7336-22334203781so92984545ad.0;
        Mon, 03 Mar 2025 11:51:52 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741031512; x=1741636312;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=k2CKI4zBybc+xDXiR4bNdoML7mcL6qio7NNqVOxcVnU=;
        b=YBY6uSrroRnFDto9V3jZItZB8Cl/DpFUSIUNJ1HwKeJBAjcAoyfp5k1S0zMScn7z7T
         B7fMXiv8pmUuIYadAvO2henoaFOFQct9cbUUUxDotyKwVuQoU/hqr5R2esRrSqkLvQSn
         fXpT76UbxFgziwAdfIDpkchgyFFmQfbfn9Bmino/VGXEPQnG/TbrbIp3KniRG3x4CWgE
         enH831orz1GAyxecxBbox5OmftKsNCGVMVVB0tpdgt6vPE4enGnbvtaiI2qqU7Jy4RkC
         /e1tn/LENEdLprmGYQvkF8MjNUF/4wx+JToBvIqXdpeEZ+/YMYQO6ayVFOvksNsPi0AA
         dvQQ==
X-Forwarded-Encrypted: i=1; AJvYcCVRepblAPwVg9JuMG3almlZKVLOpiIKDg1yAtqxz/9OUms9mzZO2fBuWrpB+XC/zEb+wx29DNYJWag=@vger.kernel.org, AJvYcCXb/ie4xuvTuLBBGAgJMvtyqEg7W7WPwsadZ0g0Jeu2NGUS/FjFC5WvMCc14NXMwFIKhhdnorMAKkqoSuBymadHrg==@vger.kernel.org
X-Gm-Message-State: AOJu0Yxx2xHjq5VU568agwTiymo98P0OFq1VRf27QV+BQ8fzOMoFRl7F
	2YezwuUIdUZvd9qFnrID9IHKygwui0s/S/wpjRhb5hCKq+7MpaYIhamJqEz46rk=
X-Gm-Gg: ASbGnctmRKRHbyspxchzjT7VYF9PWX7X8wDswexSnZZVLPrtLkGU/Rk2tLIoZHHd2Ij
	mP6r/sqnN6rlFti9VE102s5ar/i1BvMV5TUF/jqdAC9Tcp30u8dAgsJI55eBz6tEUNzM99uKXP2
	qVXUKUZq1sJArkIJijqLA/6Vc0oXRgmmzXJPBM+PkUlI9DPZ2W1q3p3slaVyJHM1BpWSleWZ6RP
	yWEa3L3UBYj7GiHLyNOG9ktMD849OOs9ALR176K5Vy5FGNQXPeJHOlLl9jrMROqslUPUmZ0VrOG
	j1hoTr4gDHQ1JQ01sJUYJxsjhY6iAUyAt2LwYNoyjWjljUspFGaMmASxLE4MyHKburqr/0D8Gx2
	FQiY=
X-Google-Smtp-Source: AGHT+IH+EFbEps/Env/viwecJzf7dRRJVQvIfNTlMDSlf181d0a4uYVPYlR1DNAdfEAQSeUvTmrcqA==
X-Received: by 2002:a05:6a00:4b10:b0:736:47d3:b2f2 with SMTP id d2e1a72fcca58-7366e6414a5mr863083b3a.12.1741031511942;
        Mon, 03 Mar 2025 11:51:51 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d2e1a72fcca58-734a00255d8sm9272490b3a.88.2025.03.03.11.51.51
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 11:51:51 -0800 (PST)
Date: Tue, 4 Mar 2025 04:51:49 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250303195149.GA1814481@rocinante>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
 <20250225143001.GA1556729@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250225143001.GA1556729@rocinante>

Hello,

[...]
> Applied to controller/dwc, thank you!

Updated the current branch with a few missing "Reviewed-by" tags from Fan Ni.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f182.google.com (mail-pl1-f182.google.com [209.85.214.182])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6088F1E7C25;
	Mon,  3 Mar 2025 19:46:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.182
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741031211; cv=none; b=Z2yuTEZ5YVzQhfMR3mgMFokKR9lLQl6DuFIK1jgP3aDKX1FHuz7UZF7Deu86xsz6UcFWxCZmALPiyrnjqGLUyEtuQe4OUWz6mDvxr3we7buK6AIuLTUruOovTgVjiPx82RTXxHp360Hn71EBZ0z2ri6smyTvJHdLOgj7upNLBzw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741031211; c=relaxed/simple;
	bh=Ao8ukNGyO5FRpxXAyl7CTfc4UjJiCkXhlRi57KBMtQM=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=smVAgGEanUASMcjB7nuShvVowgyhwoznBcUDB+Pc7ydu9kf1pQjyAn5Ft1E0IN8EY+oKrO24+VXQH9713bC3JhaejEsJt4g+6y7dJlOolZPs2OMPO7VBvwbkWxaxR8LWTVN8CPIoBokqgJI5xTecdwHkg2zSPBzhJhXMhXvvmUM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.182
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f182.google.com with SMTP id d9443c01a7336-22398e09e39so33204795ad.3;
        Mon, 03 Mar 2025 11:46:50 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741031210; x=1741636010;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=8Dek+FDPeZjeeIpsF2E44gvfK0e/oZIfm/67LelXRus=;
        b=nmB9gQU+OgeyqFTMadVuu+Y5SO0GNM/QnglWh01pg0eCurB1PL4/YRLCRfKg5kh8A5
         4yuS98HzJ/YrGoML7Bafcitb3acm0ZD+6JUD+1f6Zs5+77xdN2AQvwcx296ugOo0IOEK
         xZi5biSabIfXe6S0BIuAa5XzDh0zddU1DW+qFBiu4TBi6bTkpNGZz5itluYh94/D98vE
         YfkyguCzjJAQGNIBkO9xVuYfZevA1ay16l2Idy70xzFR1tmo6YcBnoUvNqRj3A4jV/9B
         B50r/Erw8AQtvlJt+eAgzc3izh6bZmPMcgxmSErcNTKy52PLfDPxJwNijPoJTp7GyIs3
         /muQ==
X-Forwarded-Encrypted: i=1; AJvYcCUubeZg5K75Io7D2NtiuB6wR/39bPPIHWyuGkaAvis4D0zUsYluVAqzDDzh9ev/6ugZjKc9OtkRR6+a@vger.kernel.org, AJvYcCXFpFpxR/JjkWX8WM8JqrPf8NiE52Iwdx95ydWj4NPEVMr5BX1J6YWez6lBBi+PcoxDTsJj9toM4yT+Y7bh96r4hA==@vger.kernel.org, AJvYcCXLIyWCszDshqMMlumnl2mdwA3/EYjKBkTFSxoo5kiAWJeF4RjX8sQJczcrLFWohVTYcW7FEVSN6+Cb/X8=@vger.kernel.org
X-Gm-Message-State: AOJu0YxaR//r2RkGZbIYb/tLHnUbmikRT7y/31yxQwCwUzJS1CC3dO4L
	qrjMIoL9QSQR4n6OLMZCqo76CicmmqKGjKvD19FJiPXHSM9X8Rbv
X-Gm-Gg: ASbGncuCQELgoE3ndmT6joMfBFrdt3WUa8o+7Pxc9wiUomvQN1FNswtSD6nxEiaNxnQ
	fw2vYEb+3RbN5ncwv6d1CE3kwGG2V5IIOXld1Yw7n6z0tqrk2Bo9OUNudTbhPSEGlY7ROnE+D4N
	3ULiEhnrgR73XFWaX2IrpJJJYC4dwj13SIYBfrC7URK1BiU6LFY4BT3/q1P9XYV9P14XPSVmAy9
	ccakm34g/CLfFWlGUyA4u1ged1GtMBh9oGBoC5W6snHTXMVZUX5ZY4CX31UbdB0KOrUj4O7Wnvt
	evcHaBgKdmNNGdLwFmjMGkpBkqzTjKp3yQF3nyKFSHB2ycahabz3rOI4aNTb50AgKLJWbY/96m2
	oZmk=
X-Google-Smtp-Source: AGHT+IFb6LGLr6n2gvyZ7SSG3EPL8TvaZlZ1WJzOGXC85Bkw4k+sVACmwEySy6Gx9cQRP604zBwk+w==
X-Received: by 2002:aa7:98cf:0:b0:736:339b:8290 with SMTP id d2e1a72fcca58-736339b83admr10650834b3a.17.1741031209589;
        Mon, 03 Mar 2025 11:46:49 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d2e1a72fcca58-734a004026dsm9251122b3a.155.2025.03.03.11.46.48
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 11:46:48 -0800 (PST)
Date: Tue, 4 Mar 2025 04:46:47 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Fan Ni <nifan.cxl@gmail.com>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250303194647.GC1552306@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z8XrYxP_pZr6tFU8@debian>

Hello,

[...]
> > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > +{
> > +	char dirname[DWC_DEBUGFS_BUF_MAX];
> > +	struct device *dev = pci->dev;
> > +	struct debugfs_info *debugfs;
> > +	struct dentry *dir;
> > +	int ret;
> > +
> > +	/* Create main directory for each platform driver */
> > +	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > +	dir = debugfs_create_dir(dirname, NULL);
> > +	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > +	if (!debugfs)
> > +		return -ENOMEM;
> > +
> > +	debugfs->debug_dir = dir;
> > +	pci->debugfs = debugfs;
> > +	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > +	if (ret)
> > +		dev_dbg(dev, "RASDES debugfs init failed\n");
> 
> What will happen if ret != 0? still return 0? 

Given that callers of dwc_pcie_debugfs_init() check for errors,
this probably should correctly bubble up any failure coming from
dwc_pcie_rasdes_debugfs_init().

I made updates to the code directly on the current branch, have a look:

  https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=1ff54f4cbaed9ec6994844967c36cf7ada4cbe5e

Let me know if this is OK with you.

Good catch, thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f53.google.com (mail-pj1-f53.google.com [209.85.216.53])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EE5021C9EB1;
	Mon,  3 Mar 2025 19:42:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.53
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741030952; cv=none; b=S7FKTi3TX3qZ/zMJL+dD/HU6BdVnCIbhi2nTsjGYvD+LDXgH7oMdssvJ/iBI2y+Itjf69zP1hyAsPm7Z1l2fNhBvDOljNBisFjQjB4wzb0y8y0vrLLVb46RkmYHw0cRR8WqLkX+Ixy1LQWUFXMfcfrhIgDAKqoC2WqrJclSD1iI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741030952; c=relaxed/simple;
	bh=E166rXmV2gKxDo6lvtPbk6l4dZeaRFuu0JgC4cRRb6E=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=eLyIZ8RLUSoDBx5SmXtG+ykUQIhtbuECCqAu6fAe2EN4QDrWb18Z5nQ/0kAXASV2hCMz4Z4XJHZ/Oi4TgT9RvvSmiKtvbi/oGD3KLxbFa9D2VIaSLCnmGnzrgPz6A7w+gN+XVexRCqts2UDvEWN83pgG3GBwo0j5fgHduGvowek=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.216.53
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pj1-f53.google.com with SMTP id 98e67ed59e1d1-2fef5c978ccso2557636a91.1;
        Mon, 03 Mar 2025 11:42:30 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741030950; x=1741635750;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=jr7DtT+cBeW7vunNHQDeXWMsjvqkgvHyclExXYfY/bw=;
        b=IrFa5DMr9jb5fy4OZIJBbqabybWiL9SqAB8iGghE9Ca4sKEmSDxF0VNAx8bCU38TV3
         QuXaTQbHfSuaZteYbiz54/xKkUjCmdK8iHtekqGHw/TH1NXWfxBE9jRImUn1wVMVnANd
         EufkZeCL74x/hVAupWzVkya3MCuuWwfl3bVWCjPqPO9yn9yIx+Z5gP6LEw2I+ZYz6GGh
         BbWkfvhtlOnep0D1n3dS1ehRkBpqz4IiOiH74wWbOB80/1qTWhoB2zaOPh9b6MCYP4Nt
         QVtMcsfBIdTjAEs7scFSa8wO3LWNJ56DXj+p9YX+uUcW3hxcj671f/CrKjRYmBvY98FZ
         D2Aw==
X-Forwarded-Encrypted: i=1; AJvYcCVFG2OXTRAxVSWrD7+n77RY7hkNNaAFU+8eBCse+i272Gyon6PIchlnUphwbgEinH7IJ9lEy+mNWsGLaQyYo8IAfQ==@vger.kernel.org, AJvYcCVgm8VG2g7oDbhtWpct8K6iiT+wb3BY1NOkMMWObWRxD9dj5hvZbwqmukB8juP7rn1t2YpexzoL0eWX@vger.kernel.org, AJvYcCXG0MAhwJUFHkfbK6VR7HFjPV9lOMcpH/CLkeQVugyin7zi53MN4HAzqtFrzfUAZjNiVdOFxD/bzX1Ab20=@vger.kernel.org
X-Gm-Message-State: AOJu0YxVUJo4plKAjzE1XDH8GAKaiLsLM/zauToFVKpqlREqDiukkgAd
	F0APBNuhyoHtfjlt87Gu0USLoed22wVXO/VXACoZvJBW+YrYjPFr
X-Gm-Gg: ASbGncvpU6yzInTifvlnAfAhB3HEVbn1VV30U2qX96k3Rl53x85XoCes6dX8NDp5jTJ
	NVzGz4SK0aoTNxd3tSVekuIQ7/URc5/RS9oMgYvRLWVWOFG52OTpPsgNPndf5ZZxgZKgeTcNr6n
	BhfuqUBZAc+17W+L0zInDCdz699eGw1LlvutBj8EkJbbt2GM71X/UGwTag95L368PHVvCmdR8fS
	qWDLEYJXZBfSuJM9kKWh7QtrdKl5Grg/XQghmNQTxlrdilZtqFvP2uOXEXKsQl6zvWRTZKSajVH
	GzVAmp+RGAavFYpzG3HLoKE6121xd36V4T9jRABSx0ILRN8137D+hVUnD5aWM5Yj5eOG32bD0gN
	BCLg=
X-Google-Smtp-Source: AGHT+IHYCQVs+/iE6vvKrmK1B/IMxzVg0/4kX5VfDcWNz3937RP9zksebTa9YiaF4RmT8h+1QZFM1w==
X-Received: by 2002:a17:90b:1b47:b0:2fa:e9b:33b3 with SMTP id 98e67ed59e1d1-2febab2bdecmr20911899a91.6.1741030950198;
        Mon, 03 Mar 2025 11:42:30 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 98e67ed59e1d1-2fea67a7ddesm9360259a91.27.2025.03.03.11.42.29
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 11:42:29 -0800 (PST)
Date: Tue, 4 Mar 2025 04:42:28 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Fan Ni <nifan.cxl@gmail.com>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <20250303194228.GB1552306@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
 <Z8XuuNb6TRevUlHH@debian>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z8XuuNb6TRevUlHH@debian>

Hello,

[...]
> > +static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> > +{
> > +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> > +	struct dw_pcie *pci = pdata->pci;
> > +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> > +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> > +	ssize_t pos;
> > +	u32 val;
> > +
> > +	mutex_lock(&rinfo->reg_event_lock);
> > +	set_event_number(pdata, pci, rinfo);
> > +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> > +	mutex_unlock(&rinfo->reg_event_lock);
> > +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
> > +
> > +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> > +}
> 
> Do we need to check whether the counter is enabled or not for the event
> before retrieving the counter value?

I believe, we have a patch that aims to address, have a look at:

  https://lore.kernel.org/linux-pci/20250225171239.19574-1-manivannan.sadhasivam@linaro.org

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f51.google.com (mail-qv1-f51.google.com [209.85.219.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CB3B721B9EC;
	Mon,  3 Mar 2025 18:02:41 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.51
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741024964; cv=none; b=GM7D9NuIRazzXL7JgPmBs/7oWdLA1X9RV7RWNKIR4xEnqtyy3cGJkj/WiJKOsUjghBTQ1I82cTaf7mi6trUXTGJrZv/C1yPIZZYnK2t7TQAINLI4jQP4OoJuo0YJZZ+rcST/ynPUEpJKj5fJOSB/4na77l1Y7K+qgf/7+Jntjvw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741024964; c=relaxed/simple;
	bh=b8cpnI0t1ZGE/4GhGe0WJPPFmne1LjgPLSwPpkjCOuU=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=l/Qlit8YxHYOXt+byXYq2Q6IzevtN/Ww1W05tHkWrLZVnwryIJfedDFTQvmULe3VMa9cP6AlALv0XMa9EOAWzr7TWOHRDO3QJ/1rd1qqbkxiOUJkRLN1fDytRu7mDck3TZRKm066Jgy209X1rAv7sK6OEIncofgH/N3h4YABq8g=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=OovLkFaM; arc=none smtp.client-ip=209.85.219.51
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="OovLkFaM"
Received: by mail-qv1-f51.google.com with SMTP id 6a1803df08f44-6e897847086so35399936d6.3;
        Mon, 03 Mar 2025 10:02:41 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741024961; x=1741629761; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=uaH51U1EARjWt1wUptMoCo83LSnQN+HwOWnZIFYX+bw=;
        b=OovLkFaMr6EnwYXcSIiP2SH4+CnqgQ94k7zf5Az2wqyhF2504PhpzSPehs8HsGge4f
         iWiMRKCf/x+dt4KN7IXkjENqiPFG4BT3382PmbAWwC879/vCO1sihk0CwjSUxRKNNlgG
         xi8nly5rbRfXs/Je/W+vrIzkWpPzNSyzCAlCjXNqKfvpZ4r/LlC6tNK6eLz/crEzy4gH
         8hTUbJQ7q640Lt4X17eYs0y8ktWPxMDoKZyRjeLYukrBzDMaDjIDEWzMpGYfj6ltb5s5
         89jB/hQgJ8rArjLJMGYk34KW+OV0ayCcfo6AQ7n71q2QM8ey76J1GrOr460m/jKjBp2H
         ZZCQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741024961; x=1741629761;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=uaH51U1EARjWt1wUptMoCo83LSnQN+HwOWnZIFYX+bw=;
        b=M0e0LN8EjnSWJk9nqJOOGXVf63Yrzu2D3iTj+SnqdDbdmJwCBYP1GLCly0R8IL8GOU
         pluTM+H0bsFhR23jjFZLTrBh/Vo88vus93+Mp/msXYDn3npLMTyxTsf7aYj9rvECuGuA
         ntYd3r0V4gV4pZgN9rAfZHzZjDa/G5/ZrIJ2aeRNRvl7/YXkipkIDAiY3WERDs7kyfNn
         ZAd64GGKuClyWGoCIBx05ZgC4XE4S3StutNEIDEcN0l36MTcfjpxvL0Yscv3gDNQJ/Te
         61qZbSuAS9wTsReTy/hybR9XrS0wMT0+ZF9F8yVpBVEKKYi6wbZxCWcityuM6tS7rh0z
         en4w==
X-Forwarded-Encrypted: i=1; AJvYcCUY2IL7I3elXvKC8C7NWZfPG8NOPrd+pR5I4JgTMTV0FpviBl3hPc1PDVDOhrB4UXwAAttuGZHHuG4MtPd5gwnnCg==@vger.kernel.org, AJvYcCVRUZyXpZzH+ZKrDKiRAqFesyj9QfEpGYEaO0GRiBkY6OkZ9ZipMecjgvroVMC4kwncyvq6YsSYKOI=@vger.kernel.org
X-Gm-Message-State: AOJu0YxeRseeT+XTjdmorcrHLN1pLs4D7GzIAkU5YPIf0PF6Dl0fTUjR
	AfewlG415V646qbI/L2kq9iknKWR6imS2aIqFM1X/xJIwjxaWoBB
X-Gm-Gg: ASbGncvdjAgJS3ZGKiZ9dP0cZBWlfOoNhYI4yKT9HX9SmiR7az5/tbgLlmEYMeE4ke0
	LzveC2DNmczRhf12zidEbg4aCVX5IITHHsuDCQyfzGBWSBrvppPzUQ9gK8srWz5qW+b5WkWAotr
	F9PiCX7Kq71VCp6jK+slmBZQ2amHRRWBLgrxeR0YXgP0+wL1JC/jtJyfu1vfWFCA+G4c6U9gcWE
	ex38gAVmWOtm8l8H/y4J4GC8Ajl8tebNahaodB/XimEbm42OXOZckMehhZyikYEFYv6G2Np/clU
	PpniDuqCWU5UM3aQAZfw5ge8hryNQZEvduql9wnS
X-Google-Smtp-Source: AGHT+IHjzkfcwb10GrGN3uoaAD93gQYyAxTYz59dkNKhr3SqimWrYHhjEzDaYdTtiZWAuzKMb2Txaw==
X-Received: by 2002:a05:6214:2aad:b0:6e8:9ac9:55ad with SMTP id 6a1803df08f44-6e8a0d94f85mr225579736d6.37.1741024960502;
        Mon, 03 Mar 2025 10:02:40 -0800 (PST)
Received: from debian ([2607:fb90:8e63:c2b3:5405:c8bf:c1d1:41d5])
        by smtp.gmail.com with ESMTPSA id 6a1803df08f44-6e89763479csm55795596d6.2.2025.03.03.10.02.35
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 10:02:39 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 10:02:32 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <Z8XuuNb6TRevUlHH@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-6-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:48PM +0530, Shradha Todi wrote:
> Add support to provide statistical counter interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
One comment inline.
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>
> ---
>  Documentation/ABI/testing/debugfs-dwc-pcie    |  61 +++++
>  .../controller/dwc/pcie-designware-debugfs.c  | 229 +++++++++++++++++-
>  2 files changed, 289 insertions(+), 1 deletion(-)
> 
> diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
> index 6ee0897fe753..650a89b0511e 100644
> --- a/Documentation/ABI/testing/debugfs-dwc-pcie
> +++ b/Documentation/ABI/testing/debugfs-dwc-pcie
> @@ -81,3 +81,64 @@ Description:	rasdes_err_inj is the directory which can be used to inject errors
>  
>  			<count>
>  				Number of errors to be injected

...

> +
> +static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}

Do we need to check whether the counter is enabled or not for the event
before retrieving the counter value?

Fan
> +
>  #define dwc_debugfs_create(name)			\
>  debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
>  			&dbg_ ## name ## _fops)
> @@ -249,6 +436,23 @@ static const struct file_operations dwc_pcie_err_inj_ops = {
>  	.write = err_inj_write,
>  };
>  
> +static const struct file_operations dwc_pcie_counter_enable_ops = {
> +	.open = simple_open,
> +	.read = counter_enable_read,
> +	.write = counter_enable_write,
> +};
> +
> +static const struct file_operations dwc_pcie_counter_lane_ops = {
> +	.open = simple_open,
> +	.read = counter_lane_read,
> +	.write = counter_lane_write,
> +};
> +
> +static const struct file_operations dwc_pcie_counter_value_ops = {
> +	.open = simple_open,
> +	.read = counter_value_read,
> +};
> +
>  static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  {
>  	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> @@ -258,7 +462,7 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  
>  static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  {
> -	struct dentry *rasdes_debug, *rasdes_err_inj;
> +	struct dentry *rasdes_debug, *rasdes_err_inj, *rasdes_event_counter, *rasdes_events;
>  	struct dwc_pcie_rasdes_info *rasdes_info;
>  	struct dwc_pcie_rasdes_priv *priv_tmp;
>  	struct device *dev = pci->dev;
> @@ -277,6 +481,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  	/* Create subdirectories for Debug, Error injection, Statistics */
>  	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
>  	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
> +	rasdes_event_counter = debugfs_create_dir("rasdes_event_counter", dir);
>  
>  	mutex_init(&rasdes_info->reg_event_lock);
>  	rasdes_info->ras_cap_offset = ras_cap;
> @@ -299,6 +504,28 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
>  				    &dwc_pcie_err_inj_ops);
>  	}
> +
> +	/* Create debugfs files for Statistical counter subdirectory */
> +	for (i = 0; i < ARRAY_SIZE(event_list); i++) {
> +		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
> +		if (!priv_tmp) {
> +			ret = -ENOMEM;
> +			goto err_deinit;
> +		}
> +
> +		priv_tmp->idx = i;
> +		priv_tmp->pci = pci;
> +		rasdes_events = debugfs_create_dir(event_list[i].name, rasdes_event_counter);
> +		if (event_list[i].group_no == 0 || event_list[i].group_no == 4) {
> +			debugfs_create_file("lane_select", 0644, rasdes_events,
> +					    priv_tmp, &dwc_pcie_counter_lane_ops);
> +		}
> +		debugfs_create_file("counter_value", 0444, rasdes_events, priv_tmp,
> +				    &dwc_pcie_counter_value_ops);
> +		debugfs_create_file("counter_enable", 0644, rasdes_events, priv_tmp,
> +				    &dwc_pcie_counter_enable_ops);
> +	}
> +
>  	return 0;
>  
>  err_deinit:
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qt1-f170.google.com (mail-qt1-f170.google.com [209.85.160.170])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B71FB1EE7D9;
	Mon,  3 Mar 2025 17:54:07 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.160.170
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741024449; cv=none; b=XNTh2ue70oLSJ3nt9TzYPKKF2TUVZdxkEIyyXwo985drxaoLOx30oDBxU+A1ViYdDL2OlOfnfspiNM5RHKnPdUb413mtg5kl+/JeS/uLG7tSHHB1L+sCME/WWrj/qK2QgEwquEIbX90mxSZV+l8Bv63fBZMT+UF9uTLcWGWqxpE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741024449; c=relaxed/simple;
	bh=yxVJvYEUDsoKJV1wCmsoaaeYh2FTwyxTP5JAyCXHebQ=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=qePnBOVov13gL2pfVYUKIPwkicvIR1y3jKf+W23vzh8sQ1ih93B4HIBjBnFHdn/ZE9dlTVkhCkZx+w1PCV13U6J2h0Wnbn5sKfyZQGpurlRMfEzNFeBudI7XGvVfsPrOWLA4ABEy9me5a+Xfwi3mDbGc3YepTq3hf0JkkRRS0xA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=f1X1dVCC; arc=none smtp.client-ip=209.85.160.170
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="f1X1dVCC"
Received: by mail-qt1-f170.google.com with SMTP id d75a77b69052e-471f9d11176so51257491cf.0;
        Mon, 03 Mar 2025 09:54:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741024446; x=1741629246; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=Xs6XW5l5LKVJDuEGs9QvIzhw0zb2Kt99VbZtVOkoILA=;
        b=f1X1dVCCfUoamz2kXpwJArFfNz8WfotAxG8M6SzGjLN24Ksau8o/5EZZOLStuyt8hA
         RC3ejTEg1bg17N776Z5BLspCV+C/ElNQF6yd49Bh1I3yOIsCN6Yqyuj1q5lvuN0p1AkZ
         BI1SUemUWAEhypVh3TIQcFcZElYx9ohszszw4G0r6aebziKLGJXM/Ywfq7DrFrv+c3wN
         EV+NCQ58Nriy6Zj6E9Ln2sfWCUBg9ztlyyKov6LuB0FwewW6YULjzbl+YCgcqZKz09BF
         fhzxzQHEJa4Ghq0qig/7Y/qEJlxkXei5dsyDnsWejqPI1W3nNjZx1QWr+a9kkZNdRKgQ
         cnYA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741024446; x=1741629246;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=Xs6XW5l5LKVJDuEGs9QvIzhw0zb2Kt99VbZtVOkoILA=;
        b=NceFncezI8OatT2OZht4tECAxjg3F1l5QREKJ4VMj0KGlOk/CnuVxYFWYd0ZAn1QUo
         0eZlr6DSdCp4Wbh+M+I2/o72xZR7LXv9d5hmgFm5kP37auWNTfKgRHHMN9++mwADRydD
         oWYxyXQ5J4nV781oZmj0QYRlbQHeQ1MXv4/WLmPjUucPuNVRpIAqY+3OT7dvRo3LO7Pr
         alWpCX76b/WyDu+lVe0F+U4JWMgbC2YNLR0jg/P2JHvug45xpyQlW29Q4g+JHIxCAkf4
         UZj1YzY2tRmUzjSvuAzrYWjdRn8xIUS3Dz35+cXJbL356VIQlhpjzaf9sRlZGIP7eaA3
         MBVQ==
X-Forwarded-Encrypted: i=1; AJvYcCUA3O9E59v/dOEBhJsk76MNPyx7ryYoETOGPfPHai0zLxg8el+hHzhpO6Q3dh7t2/nasPI7X9IIixM=@vger.kernel.org, AJvYcCXir3rTOSQZIMDkxOgvSQSXw6+0v/t8zWyiaoSK3nDdp8P+IXymL/6Y78LH6H9gsKZy1syQthey+Y2h7sJJar+qoQ==@vger.kernel.org
X-Gm-Message-State: AOJu0Yw+/tYEX+Yyr7hJvN9wAd8XsFMKFQ11QM/BxsX5qHiSc8RbJcwM
	rxKvq0EqrjINdu6T+RE4xF3MSqlIMrm5fw2Sh1B4gKUewvR2FKct
X-Gm-Gg: ASbGncvcg0vYW98N77nV2wv193lAq4GBznv39C7mtGh8tZv4wguhVBL9DlJsp2zmvBY
	s52yy+XzhiW6P9Zam+SZnJwEVsnTs8o6qcGw+iGT+hoiMHLY2LFlr3QG+fky72fj721tJA6Zkm5
	YUTJtntitvxXSdpW4l2c7o5lIqJ7hKmul0SZUZ9Ttw9sUAQg0+LMC04TFP7FN2+wIeCQVPFKXf8
	znJ3c1uHDo3CsFBvwbk57YWLsHG11mA4WvqXvofFWCTDhNFZWOZaVpxlhh51/TZNB5n8jL9jQVM
	OJuFJuY4aoqAYRN98WuaNBOzP8tkveZZaKqgi1bW
X-Google-Smtp-Source: AGHT+IH5I40jDDNiG/MrI51Au0ev3ZByHeIEUlYPK0MqfEH3LZQnhNrts3S3dQV0K/kx8mhNB74A9w==
X-Received: by 2002:ac8:5d11:0:b0:471:f0d6:8f32 with SMTP id d75a77b69052e-474bc0ff3aemr204772191cf.34.1741024446316;
        Mon, 03 Mar 2025 09:54:06 -0800 (PST)
Received: from debian ([2607:fb90:8e63:c2b3:5405:c8bf:c1d1:41d5])
        by smtp.gmail.com with ESMTPSA id d75a77b69052e-474b6d20896sm52931581cf.74.2025.03.03.09.53.59
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 09:54:05 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 09:53:57 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <Z8XstSB-BE6JG5hk@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-5-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:47PM +0530, Shradha Todi wrote:
> Add support to provide error injection interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>
> ---

LGTM.

Reviewed-by: Fan Ni <fan.ni@samsung.com>

>  Documentation/ABI/testing/debugfs-dwc-pcie    |  70 ++++++++
>  .../controller/dwc/pcie-designware-debugfs.c  | 165 +++++++++++++++++-
>  2 files changed, 233 insertions(+), 2 deletions(-)
> 
> diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
> index e8ed34e988ef..6ee0897fe753 100644
> --- a/Documentation/ABI/testing/debugfs-dwc-pcie
> +++ b/Documentation/ABI/testing/debugfs-dwc-pcie
> @@ -11,3 +11,73 @@ Contact:	Shradha Todi <shradha.t@samsung.com>
>  Description:	(RW) Write the lane number to be checked as valid or invalid. Read
>  		will return the status of PIPE RXVALID signal of the selected lane.
>  		The default selected lane is Lane0.
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	rasdes_err_inj is the directory which can be used to inject errors in the
> +		system. The possible errors that can be injected are:
> +
> +		1) TLP LCRC error injection TX Path - tx_lcrc
> +		2) 16b CRC error injection of ACK/NAK DLLP - b16_crc_dllp
> +		3) 16b CRC error injection of Update-FC DLLP - b16_crc_upd_fc
> +		4) TLP ECRC error injection TX Path - tx_ecrc
> +		5) TLP's FCRC error injection TX Path - fcrc_tlp
> +		6) Parity error of TSOS - parity_tsos
> +		7) Parity error on SKPOS - parity_skpos
> +		8) LCRC error injection RX Path - rx_lcrc
> +		9) ECRC error injection RX Path - rx_ecrc
> +		10) TLPs SEQ# error - tlp_err_seq
> +		11) DLLPS ACK/NAK SEQ# error - ack_nak_dllp_seq
> +		12) ACK/NAK DLLPs transmission block - ack_nak_dllp
> +		13) UpdateFC DLLPs transmission block - upd_fc_dllp
> +		14) Always transmission for NAK DLLP - nak_dllp
> +		15) Invert SYNC header - inv_sync_hdr_sym
> +		16) COM/PAD TS1 order set - com_pad_ts1
> +		17) COM/PAD TS2 order set - com_pad_ts2
> +		18) COM/FTS FTS order set - com_fts
> +		19) COM/IDL E-idle order set - com_idl
> +		20) END/EDB symbol - end_edb
> +		21) STP/SDP symbol - stp_sdp
> +		22) COM/SKP SKP order set - com_skp
> +		23) Posted TLP Header credit value control - posted_tlp_hdr
> +		24) Non-Posted TLP Header credit value control - non_post_tlp_hdr
> +		25) Completion TLP Header credit value control - cmpl_tlp_hdr
> +		26) Posted TLP Data credit value control - posted_tlp_data
> +		27) Non-Posted TLP Data credit value control - non_post_tlp_data
> +		28) Completion TLP Data credit value control - cmpl_tlp_data
> +		29) Generates duplicate TLPs - duplicate_dllp
> +		30) Generates Nullified TLPs - nullified_tlp
> +
> +		(WO) Write to the attribute will prepare controller to inject the respective
> +		error in the next transmission of data. Parameter required to write will
> +		change in the following ways:
> +
> +		i) Errors 9) - 10) are sequence errors. The write command for these will be
> +
> +			echo <count> <diff> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> +			<diff>
> +				The difference to add or subtract from natural sequence number to
> +				generate sequence error. Range (-4095 : 4095)
> +
> +		ii) Errors 23) - 28) are credit value error insertions. Write command:
> +
> +			echo <count> <diff> <vc> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> +			<diff>
> +				The difference to add or subtract from UpdateFC credit value.
> +				Range (-4095 : 4095)
> +			<vc>
> +				Target VC number
> +
> +		iii) All other errors. Write command:
> +
> +			echo <count> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> index 3887a6996706..b7260edd2336 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -17,6 +17,20 @@
>  #define PIPE_DETECT_LANE		BIT(17)
>  #define LANE_SELECT			GENMASK(3, 0)
>  
> +#define ERR_INJ0_OFF			0x34
> +#define EINJ_VAL_DIFF			GENMASK(28, 16)
> +#define EINJ_VC_NUM			GENMASK(14, 12)
> +#define EINJ_TYPE_SHIFT			8
> +#define EINJ0_TYPE			GENMASK(11, 8)
> +#define EINJ1_TYPE			BIT(8)
> +#define EINJ2_TYPE			GENMASK(9, 8)
> +#define EINJ3_TYPE			GENMASK(10, 8)
> +#define EINJ4_TYPE			GENMASK(10, 8)
> +#define EINJ5_TYPE			BIT(8)
> +#define EINJ_COUNT			GENMASK(7, 0)
> +
> +#define ERR_INJ_ENABLE_REG		0x30
> +
>  #define DWC_DEBUGFS_BUF_MAX		128
>  
>  /**
> @@ -33,6 +47,72 @@ struct dwc_pcie_rasdes_info {
>  	struct mutex reg_event_lock;
>  };
>  
> +/**
> + * struct dwc_pcie_rasdes_priv - Stores file specific private data information
> + * @pci: Reference to the dw_pcie structure
> + * @idx: Index to point to specific file related information in array of structs
> + *
> + * All debugfs files will have this struct as its private data.
> + */
> +struct dwc_pcie_rasdes_priv {
> +	struct dw_pcie *pci;
> +	int idx;
> +};
> +
> +/**
> + * struct dwc_pcie_err_inj - Store details about each error injection supported by DWC RASDES
> + * @name: Name of the error that can be injected
> + * @err_inj_group: Group number to which the error belongs to. Value can range from 0 - 5
> + * @err_inj_type: Each group can have multiple types of error
> + */
> +struct dwc_pcie_err_inj {
> +	const char *name;
> +	u32 err_inj_group;
> +	u32 err_inj_type;
> +};
> +
> +static const struct dwc_pcie_err_inj err_inj_list[] = {
> +	{"tx_lcrc", 0x0, 0x0},
> +	{"b16_crc_dllp", 0x0, 0x1},
> +	{"b16_crc_upd_fc", 0x0, 0x2},
> +	{"tx_ecrc", 0x0, 0x3},
> +	{"fcrc_tlp", 0x0, 0x4},
> +	{"parity_tsos", 0x0, 0x5},
> +	{"parity_skpos", 0x0, 0x6},
> +	{"rx_lcrc", 0x0, 0x8},
> +	{"rx_ecrc", 0x0, 0xb},
> +	{"tlp_err_seq", 0x1, 0x0},
> +	{"ack_nak_dllp_seq", 0x1, 0x1},
> +	{"ack_nak_dllp", 0x2, 0x0},
> +	{"upd_fc_dllp", 0x2, 0x1},
> +	{"nak_dllp", 0x2, 0x2},
> +	{"inv_sync_hdr_sym", 0x3, 0x0},
> +	{"com_pad_ts1", 0x3, 0x1},
> +	{"com_pad_ts2", 0x3, 0x2},
> +	{"com_fts", 0x3, 0x3},
> +	{"com_idl", 0x3, 0x4},
> +	{"end_edb", 0x3, 0x5},
> +	{"stp_sdp", 0x3, 0x6},
> +	{"com_skp", 0x3, 0x7},
> +	{"posted_tlp_hdr", 0x4, 0x0},
> +	{"non_post_tlp_hdr", 0x4, 0x1},
> +	{"cmpl_tlp_hdr", 0x4, 0x2},
> +	{"posted_tlp_data", 0x4, 0x4},
> +	{"non_post_tlp_data", 0x4, 0x5},
> +	{"cmpl_tlp_data", 0x4, 0x6},
> +	{"duplicate_dllp", 0x5, 0x0},
> +	{"nullified_tlp", 0x5, 0x1},
> +};
> +
> +static const u32 err_inj_type_mask[] = {
> +	EINJ0_TYPE,
> +	EINJ1_TYPE,
> +	EINJ2_TYPE,
> +	EINJ3_TYPE,
> +	EINJ4_TYPE,
> +	EINJ5_TYPE,
> +};
> +
>  static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
>  {
>  	struct dw_pcie *pci = file->private_data;
> @@ -93,6 +173,63 @@ static ssize_t rx_valid_write(struct file *file, const char __user *buf, size_t
>  	return lane_detect_write(file, buf, count, ppos);
>  }
>  
> +static ssize_t err_inj_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	u32 val, counter, vc_num, err_group, type_mask;
> +	int val_diff = 0;
> +	char *kern_buf;
> +
> +	err_group = err_inj_list[pdata->idx].err_inj_group;
> +	type_mask = err_inj_type_mask[err_group];
> +
> +	kern_buf = memdup_user_nul(buf, count);
> +	if (IS_ERR(kern_buf))
> +		return PTR_ERR(kern_buf);
> +
> +	if (err_group == 4) {
> +		val = sscanf(kern_buf, "%u %d %u", &counter, &val_diff, &vc_num);
> +		if ((val != 3) || (val_diff < -4095 || val_diff > 4095)) {
> +			kfree(kern_buf);
> +			return -EINVAL;
> +		}
> +	} else if (err_group == 1) {
> +		val = sscanf(kern_buf, "%u %d", &counter, &val_diff);
> +		if ((val != 2) || (val_diff < -4095 || val_diff > 4095)) {
> +			kfree(kern_buf);
> +			return -EINVAL;
> +		}
> +	} else {
> +		val = kstrtou32(kern_buf, 0, &counter);
> +		if (val) {
> +			kfree(kern_buf);
> +			return val;
> +		}
> +	}
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group));
> +	val &= ~(type_mask | EINJ_COUNT);
> +	val |= ((err_inj_list[pdata->idx].err_inj_type << EINJ_TYPE_SHIFT) & type_mask);
> +	val |= FIELD_PREP(EINJ_COUNT, counter);
> +
> +	if (err_group == 1 || err_group == 4) {
> +		val &= ~(EINJ_VAL_DIFF);
> +		val |= FIELD_PREP(EINJ_VAL_DIFF, val_diff);
> +	}
> +	if (err_group == 4) {
> +		val &= ~(EINJ_VC_NUM);
> +		val |= FIELD_PREP(EINJ_VC_NUM, vc_num);
> +	}
> +
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group), val);
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ_ENABLE_REG, (0x1 << err_group));
> +
> +	kfree(kern_buf);
> +	return count;
> +}
> +
>  #define dwc_debugfs_create(name)			\
>  debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
>  			&dbg_ ## name ## _fops)
> @@ -107,6 +244,11 @@ static const struct file_operations dbg_ ## name ## _fops = {	\
>  DWC_DEBUGFS_FOPS(lane_detect);
>  DWC_DEBUGFS_FOPS(rx_valid);
>  
> +static const struct file_operations dwc_pcie_err_inj_ops = {
> +	.open = simple_open,
> +	.write = err_inj_write,
> +};
> +
>  static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  {
>  	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> @@ -116,10 +258,11 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  
>  static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  {
> -	struct dentry *rasdes_debug;
> +	struct dentry *rasdes_debug, *rasdes_err_inj;
>  	struct dwc_pcie_rasdes_info *rasdes_info;
> +	struct dwc_pcie_rasdes_priv *priv_tmp;
>  	struct device *dev = pci->dev;
> -	int ras_cap;
> +	int ras_cap, i, ret;
>  
>  	ras_cap = dw_pcie_find_rasdes_capability(pci);
>  	if (!ras_cap) {
> @@ -133,6 +276,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  
>  	/* Create subdirectories for Debug, Error injection, Statistics */
>  	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
> +	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
>  
>  	mutex_init(&rasdes_info->reg_event_lock);
>  	rasdes_info->ras_cap_offset = ras_cap;
> @@ -142,7 +286,24 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  	dwc_debugfs_create(lane_detect);
>  	dwc_debugfs_create(rx_valid);
>  
> +	/* Create debugfs files for Error injection subdirectory */
> +	for (i = 0; i < ARRAY_SIZE(err_inj_list); i++) {
> +		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
> +		if (!priv_tmp) {
> +			ret = -ENOMEM;
> +			goto err_deinit;
> +		}
> +
> +		priv_tmp->idx = i;
> +		priv_tmp->pci = pci;
> +		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
> +				    &dwc_pcie_err_inj_ops);
> +	}
>  	return 0;
> +
> +err_deinit:
> +	dwc_pcie_rasdes_debugfs_deinit(pci);
> +	return ret;
>  }
>  
>  void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f43.google.com (mail-pj1-f43.google.com [209.85.216.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7538B1F4C83;
	Mon,  3 Mar 2025 17:48:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.43
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741024112; cv=none; b=VZ4lZRL8OYyfM8iRCvzYwv+Yf7A/sDn2kKR0GH7wYg/LaS/Jg5EgZxt3YNK55F0ivLYe8cOEjDjw772k6pxnt2uNtY6y0PaE7U4XN/W3f0yjL9HmheiS+PYgE5bMSyGf/gr6eG5iVA4tOJn4MFH/LbbkJdcXD7KPr8/w5AUiBWI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741024112; c=relaxed/simple;
	bh=hBl1SA34t69342MAMDAQhPCtUn7lM7R+xds081nYH7Y=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=nndWxz/uRtIvneFc9LkDB38Qm1t40ErgL+6H11lRqCOOHkJHih9zgemHAHzmT354et4l/T96ftCZEAumVPjkNhNaPYHEfrxxJMw420eu79g04QVE7ATHVEwPSIaOgjpbfEdcm0ZtqMLowrEjIrKZAIfYiTXcyVi2qWUrt6RUImc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=Z/xymZAO; arc=none smtp.client-ip=209.85.216.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="Z/xymZAO"
Received: by mail-pj1-f43.google.com with SMTP id 98e67ed59e1d1-2feb867849fso6150718a91.3;
        Mon, 03 Mar 2025 09:48:30 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741024110; x=1741628910; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=WmKXbHEtnA7BYynURcro/0mObW5wKzmiR29K1zakwMQ=;
        b=Z/xymZAOs2ewb1FnyCXhkAY3hODOnM9QniCq2+bOUIHhKkV/x63sYsCJVaff1gQj9y
         9w4qsRxoBq6g2Bda37hhWWDEbdVApq/D1numYA48D+5zWvdJjUUkNU+MIVgMrjVBHsEo
         jRK5N+ohz1KuiQRyRIwzX+DOQ+LQuoHMdy4w6u0BIbgig+uP3GmuL4h/xdLDXb8lXvCt
         DeFTLi5Q3qs7o0bqwS1ZpnsJ+rRG8yXn3bbazOkoXtg+ONI6TUDaunXprmx65rWRzGz1
         sRcpqiug/asZ9/J5lHlJ6eYeDU/wiibVvmEji9wgvnfi4qVvsdHpYy2sT9X8cbTHi2yX
         4sdg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741024110; x=1741628910;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=WmKXbHEtnA7BYynURcro/0mObW5wKzmiR29K1zakwMQ=;
        b=qKaRwbVQX0Yji6AVaXpgxti6knIp+ivSiaE+PdnGQhxKjjrvhlMwBFZaoByfC0S4rK
         AHZkAY5GrLT6VQuxKmr7N6FGH37aBbuOQKOQH09gU6Z4YHgL7PYoqoP7YuyuGnplsNtD
         rGspJtCCbU+L8izIKl3po9PsdtLNaUx8cvsy+83dfQrUCj7uv2gqtgIVUUYtcW3G9MRD
         wKR6ef961hdzp/bX2h/4GjPhQC7RXmYNO85OQ1BmxMMT385E0XJVrKDFDe4+HoEYP+h2
         W6loidTighXvJs41FFSi5lXijgzCp4iYUEzmpwVCD2RDLPd0JLMlz/ayiY2y9Fyd9o/5
         8zyw==
X-Forwarded-Encrypted: i=1; AJvYcCVDSpjvysOW1LYfSOa++Ndo+/VGbCNT8rx53UisFUEaR1/hF7m18VXC1Lj+6vaTAgz83kmscEq34pM=@vger.kernel.org, AJvYcCVSmZN/4HCMvIUd6UcL0H7t2mG96YcEvRPZPlK7taBcZbxA5Hkqr2APFE1bIPm82MOeFhlecTOdWxTCuFp89lskvQ==@vger.kernel.org
X-Gm-Message-State: AOJu0Ywh6al6yhpVLsq0MoSBsAZ2SjenMoQg04LIcwADso2QNyjee9Uw
	UrDz/3/d+Va+FfX+TXtKxUO7hSraRZG2RdyvfeiLtqUyNZP88TKD
X-Gm-Gg: ASbGncuFmWDOTpnp3gB/V0s7di9n35C1JdGW1bEWStO58yIW22LltDR1daRyX9rat51
	cGWMryHr1FWnm90gviK4hSZ0t0ToZzkNbFPvEbptIgq0uY+KGs0QANEHM3vuxhO+T8OpyLkXknz
	hJAgwA9jL0Pydn2xKXUDXBi7ERr8JYUDF+Ckjk7bTTC0mYsxMdPYcQQMYsRgQLzrr5g4A8xh56Y
	4alf/GrPNrEQyNbZFFDlGLqP0/XDiGqNeC61nRJ3WdrJB5+3PcwD0xLWK/6gZhtHoYuBJkrGc0+
	5mGyUrFWdPpxo2+x+4tx1uhQ4jAoh8PoT9Fo3MrC
X-Google-Smtp-Source: AGHT+IHk7Hi95mZJV5rMYiwuC/J8v0hurAfh0yJTj+vgRhEnZZgJvNnI5Cjq+bi6h/usz4umguhtlw==
X-Received: by 2002:a17:90b:3a89:b0:2fe:8c4f:e7c4 with SMTP id 98e67ed59e1d1-2febab760a0mr22194123a91.15.1741024106330;
        Mon, 03 Mar 2025 09:48:26 -0800 (PST)
Received: from debian ([2607:fb90:8e63:c2b3:5405:c8bf:c1d1:41d5])
        by smtp.gmail.com with ESMTPSA id 98e67ed59e1d1-2fe825baa8csm11465771a91.14.2025.03.03.09.48.21
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 09:48:25 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 09:48:19 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <Z8XrYxP_pZr6tFU8@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-4-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:46PM +0530, Shradha Todi wrote:
> Add support to provide silicon debug interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

One comment inline.
> ---
>  Documentation/ABI/testing/debugfs-dwc-pcie    |  13 ++
>  drivers/pci/controller/dwc/Kconfig            |  10 +
>  drivers/pci/controller/dwc/Makefile           |   1 +
>  .../controller/dwc/pcie-designware-debugfs.c  | 176 ++++++++++++++++++
>  .../pci/controller/dwc/pcie-designware-ep.c   |   5 +
>  .../pci/controller/dwc/pcie-designware-host.c |   6 +
>  drivers/pci/controller/dwc/pcie-designware.c  |   6 +
>  drivers/pci/controller/dwc/pcie-designware.h  |  21 +++
>  include/linux/pcie-dwc.h                      |   2 +
>  9 files changed, 240 insertions(+)
>  create mode 100644 Documentation/ABI/testing/debugfs-dwc-pcie
>  create mode 100644 drivers/pci/controller/dwc/pcie-designware-debugfs.c
> 

...

> +
> +static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
> +{
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +
> +	mutex_destroy(&rinfo->reg_event_lock);
> +}
> +
> +static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
> +{
> +	struct dentry *rasdes_debug;
> +	struct dwc_pcie_rasdes_info *rasdes_info;
> +	struct device *dev = pci->dev;
> +	int ras_cap;
> +
> +	ras_cap = dw_pcie_find_rasdes_capability(pci);
> +	if (!ras_cap) {
> +		dev_dbg(dev, "no RASDES capability available\n");
> +		return -ENODEV;
> +	}
> +
> +	rasdes_info = devm_kzalloc(dev, sizeof(*rasdes_info), GFP_KERNEL);
> +	if (!rasdes_info)
> +		return -ENOMEM;
> +
> +	/* Create subdirectories for Debug, Error injection, Statistics */
> +	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
> +
> +	mutex_init(&rasdes_info->reg_event_lock);
> +	rasdes_info->ras_cap_offset = ras_cap;
> +	pci->debugfs->rasdes_info = rasdes_info;
> +
> +	/* Create debugfs files for Debug subdirectory */
> +	dwc_debugfs_create(lane_detect);
> +	dwc_debugfs_create(rx_valid);
> +
> +	return 0;
> +}
> +
> +void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> +{
> +	dwc_pcie_rasdes_debugfs_deinit(pci);
> +	debugfs_remove_recursive(pci->debugfs->debug_dir);
> +}
> +
> +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +{
> +	char dirname[DWC_DEBUGFS_BUF_MAX];
> +	struct device *dev = pci->dev;
> +	struct debugfs_info *debugfs;
> +	struct dentry *dir;
> +	int ret;
> +
> +	/* Create main directory for each platform driver */
> +	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> +	dir = debugfs_create_dir(dirname, NULL);
> +	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> +	if (!debugfs)
> +		return -ENOMEM;
> +
> +	debugfs->debug_dir = dir;
> +	pci->debugfs = debugfs;
> +	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> +	if (ret)
> +		dev_dbg(dev, "RASDES debugfs init failed\n");

What will happen if ret != 0? still return 0? 

Fan
> +
> +	return 0;
> +}
> diff --git a/drivers/pci/controller/dwc/pcie-designware-ep.c b/drivers/pci/controller/dwc/pcie-designware-ep.c
> index 72418160e658..f9d7f3f989ad 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-ep.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-ep.c
> @@ -814,6 +814,7 @@ void dw_pcie_ep_cleanup(struct dw_pcie_ep *ep)
>  {
>  	struct dw_pcie *pci = to_dw_pcie_from_ep(ep);
>  
> +	dwc_pcie_debugfs_deinit(pci);
>  	dw_pcie_edma_remove(pci);
>  }
>  EXPORT_SYMBOL_GPL(dw_pcie_ep_cleanup);
> @@ -989,6 +990,10 @@ int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
>  
>  	dw_pcie_ep_init_non_sticky_registers(pci);
>  
> +	ret = dwc_pcie_debugfs_init(pci);
> +	if (ret)
> +		goto err_remove_edma;
> +
>  	return 0;
>  
>  err_remove_edma:
> diff --git a/drivers/pci/controller/dwc/pcie-designware-host.c b/drivers/pci/controller/dwc/pcie-designware-host.c
> index ffaded8f2df7..2081e8c72d12 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-host.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-host.c
> @@ -548,6 +548,10 @@ int dw_pcie_host_init(struct dw_pcie_rp *pp)
>  	if (pp->ops->post_init)
>  		pp->ops->post_init(pp);
>  
> +	ret = dwc_pcie_debugfs_init(pci);
> +	if (ret)
> +		goto err_stop_link;
> +
>  	return 0;
>  
>  err_stop_link:
> @@ -572,6 +576,8 @@ void dw_pcie_host_deinit(struct dw_pcie_rp *pp)
>  {
>  	struct dw_pcie *pci = to_dw_pcie_from_pp(pp);
>  
> +	dwc_pcie_debugfs_deinit(pci);
> +
>  	pci_stop_root_bus(pp->bridge->bus);
>  	pci_remove_root_bus(pp->bridge->bus);
>  
> diff --git a/drivers/pci/controller/dwc/pcie-designware.c b/drivers/pci/controller/dwc/pcie-designware.c
> index a7c0671c6715..3d1d95d9e380 100644
> --- a/drivers/pci/controller/dwc/pcie-designware.c
> +++ b/drivers/pci/controller/dwc/pcie-designware.c
> @@ -323,6 +323,12 @@ static u16 dw_pcie_find_vsec_capability(struct dw_pcie *pci,
>  	return 0;
>  }
>  
> +u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci)
> +{
> +	return dw_pcie_find_vsec_capability(pci, dwc_pcie_rasdes_vsec_ids);
> +}
> +EXPORT_SYMBOL_GPL(dw_pcie_find_rasdes_capability);
> +
>  int dw_pcie_read(void __iomem *addr, int size, u32 *val)
>  {
>  	if (!IS_ALIGNED((uintptr_t)addr, size)) {
> diff --git a/drivers/pci/controller/dwc/pcie-designware.h b/drivers/pci/controller/dwc/pcie-designware.h
> index 501d9ddfea16..7f9807d4e5de 100644
> --- a/drivers/pci/controller/dwc/pcie-designware.h
> +++ b/drivers/pci/controller/dwc/pcie-designware.h
> @@ -437,6 +437,11 @@ struct dw_pcie_ops {
>  	void	(*stop_link)(struct dw_pcie *pcie);
>  };
>  
> +struct debugfs_info {
> +	struct dentry		*debug_dir;
> +	void			*rasdes_info;
> +};
> +
>  struct dw_pcie {
>  	struct device		*dev;
>  	void __iomem		*dbi_base;
> @@ -465,6 +470,7 @@ struct dw_pcie {
>  	struct reset_control_bulk_data	core_rsts[DW_PCIE_NUM_CORE_RSTS];
>  	struct gpio_desc		*pe_rst;
>  	bool			suspended;
> +	struct debugfs_info	*debugfs;
>  };
>  
>  #define to_dw_pcie_from_pp(port) container_of((port), struct dw_pcie, pp)
> @@ -478,6 +484,7 @@ void dw_pcie_version_detect(struct dw_pcie *pci);
>  
>  u8 dw_pcie_find_capability(struct dw_pcie *pci, u8 cap);
>  u16 dw_pcie_find_ext_capability(struct dw_pcie *pci, u8 cap);
> +u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci);
>  
>  int dw_pcie_read(void __iomem *addr, int size, u32 *val);
>  int dw_pcie_write(void __iomem *addr, int size, u32 val);
> @@ -806,4 +813,18 @@ dw_pcie_ep_get_func_from_ep(struct dw_pcie_ep *ep, u8 func_no)
>  	return NULL;
>  }
>  #endif
> +
> +#ifdef CONFIG_PCIE_DW_DEBUGFS
> +int dwc_pcie_debugfs_init(struct dw_pcie *pci);
> +void dwc_pcie_debugfs_deinit(struct dw_pcie *pci);
> +#else
> +static inline int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +{
> +	return 0;
> +}
> +static inline void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> +{
> +}
> +#endif
> +
>  #endif /* _PCIE_DESIGNWARE_H */
> diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
> index 40f3545731c8..6436e7fadc75 100644
> --- a/include/linux/pcie-dwc.h
> +++ b/include/linux/pcie-dwc.h
> @@ -28,6 +28,8 @@ static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
>  	  .vsec_id = 0x02, .vsec_rev = 0x4 },
>  	{ .vendor_id = PCI_VENDOR_ID_QCOM,
>  	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_SAMSUNG,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
>  	{} /* terminator */
>  };
>  
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f174.google.com (mail-pl1-f174.google.com [209.85.214.174])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9F8F7215061;
	Mon,  3 Mar 2025 17:22:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.174
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741022580; cv=none; b=gdYhNtGFF/c/RQBLdbP5O6aUbyKAVnUVvDTgWz3vHiX2ll65aTO2eIXeIn2/0HQ76F4UkjrD8zMKQmY9jJP6dT3JIwXKvHJOWpaGoPCEGhRQ0+DC7Rett5nu5nqf520b5Y7y6KPBww91DwEKDq7IFu+FWSTbXiNdy+6J56mVCxQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741022580; c=relaxed/simple;
	bh=BojXVM7TuWbWt/szVo1jrbABw+mVS2arDbx8q9WpoZY=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=U6Mh6R/Y/8K93Luqa1nU3xrzItoPylyRNABwoWgHzdvDMwPTzc/VDq6k3Wqn8gVXzGllOFTgUIouHKps1MYEPVSTS9jDi7zlc4QFaFbUgA/aah08Pj05oWorHhwCjyS2rPQjqiK7VsdNW92V/zPkDQCJOJW3cckX/hI7BZ+gGrw=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=amwY23J5; arc=none smtp.client-ip=209.85.214.174
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="amwY23J5"
Received: by mail-pl1-f174.google.com with SMTP id d9443c01a7336-22382657540so39851015ad.2;
        Mon, 03 Mar 2025 09:22:58 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741022578; x=1741627378; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=INEL+mkWEKLq34Mczv2nLd5ND0XQsLg0DNbt4SnzHDQ=;
        b=amwY23J5gsz1xRWkInms3FLDMAzTeRbTYqN5DBJhjmnjWucir9X3AqhED8a5BqSnOd
         53prtB6uMxMceCGb9KaSKkiRKphtyu7s1Fc+fBzjfS6KqFn3EoClu67pQmNcg7OfXTJA
         TuiyHW8Q9WP81zE5i+2H9Ys2mw1ek9JoFkE8Jwohc0YKcyVJowh0wffnhnXmLl+n2i1r
         8O8WTm+Kbvdx1e0nAQ72+OARKs4zv6TcQxp1l5YT8ozAaGYCNlrdxDvsWdabv2H1Wn3z
         JzyYTHKlxNPXUQi+jYq7DgdmUlLdg8qZR8bHP6H4VjwwRZtWIgw3UgXfWNV6Qp9pRJMz
         3zdw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741022578; x=1741627378;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=INEL+mkWEKLq34Mczv2nLd5ND0XQsLg0DNbt4SnzHDQ=;
        b=Ozr+CuYyENEPwF2gM2g07QVQ18xWlZUBZDe/3D0zF+UtXkM8w7FcI4zufm4ECEE9RU
         g9Ahnl75GZEnz8b/XeVHWG8x5k2PFWcM+UPtqEWARPIyNawkDX4fLf4ifjS06GXLQ3Xb
         ckZ3XKPD+DfuD92qNKbLtBtFwujbFmpS0Z7vFtUTCiQYdhvx9BHaJftSqNkSn27gg82c
         tmKsnhMKB0f7C46tCJkUXqXhMJZqGr8B+jtmIkJk+LIuZyMAKqRAy3E0OdX1sesg5CTx
         e8qqlvAWOjn+tm2tDXfqUjVexJ0l2wmMn+ZjEQIE2HxwTQldALqq6d3QznffjNDEJykU
         HL+w==
X-Forwarded-Encrypted: i=1; AJvYcCU/0mVeBnfLS/VfwooAM7FPAvjGUyIV9sAfPz9Ggi8ycW0hQ5f0MdtHWPY6Bo27+GfPIr5lQIWpmZc=@vger.kernel.org, AJvYcCXcjNMFIdbVct/xi7UDOCbCE2MsDxHluLVKincnYpnms2+U8isLSmHpGRfKP2Zw56v9RN+NZt7rBWYCiGQUKfaKiw==@vger.kernel.org
X-Gm-Message-State: AOJu0YwOmAQLbMXUnv50uH2pTvF1KapilnUDOJ+AidaSAdN2vVf/M4Fk
	hrkvzEAdZVi18dwk/H9SkbxIP/EeMeSHn2L8KRldFLXJlslRqumw
X-Gm-Gg: ASbGncs6u5+3cywXiT3sgoB46YwZcIKk0gKMnIkQM148QSqc0WbIqFQ39X53UmwBxjb
	SajxXraIvLfmbz52/x/IaXcck+F3cijLD9eMn3Yj/FJ70UhnBxLdMMbAXzYalbDomk0Njfk3HXm
	SwvHiKImFBlrOaeA+cRNyg8sJ0VEgGx3PuIAiCqLKZ2KlfUs/xwHNQRn/zzdNAOUrA7nOoJpbBO
	oaVvC9pDmag1NfxfOI7q4DtmM8hYFMUmAcla0O8xnrHjBu2epWf1cnSc55c54i44b1ROaFy7Doc
	w6W7CC++j14Nzv6P42r0MoyqATQnkg8YSKI5smrp
X-Google-Smtp-Source: AGHT+IGYNi+2VxBOSdALmg07N0zm4mXQing5p3PqQ+CWp+YUijGcJXrzBi5jiCAbCilBAkdB5b8amA==
X-Received: by 2002:a17:903:fa5:b0:220:f40c:71e9 with SMTP id d9443c01a7336-22368f71f0dmr184667325ad.9.1741022576289;
        Mon, 03 Mar 2025 09:22:56 -0800 (PST)
Received: from debian ([2607:fb90:8e63:c2b3:5405:c8bf:c1d1:41d5])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-223504c596esm80333925ad.152.2025.03.03.09.22.52
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 09:22:55 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 09:22:50 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 2/5] PCI: dwc: Add helper to find the Vendor Specific
 Extended Capability (VSEC)
Message-ID: <Z8XlapjLRfz44hF7@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132029epcas5p1e56dd355e7ac912ceb25325595de0d24@epcas5p1.samsung.com>
 <20250221131548.59616-3-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-3-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:45PM +0530, Shradha Todi wrote:
> dw_pcie_find_vsec_capability() is used by upcoming DWC APIs to find the
How are about "Add dw_pcie_find_ext_capability(), which will be used by
..."

Other than that,


Reviewed-by: Fan Ni <fan.ni@samsung.com>

> VSEC capabilities like PTM, RAS etc.
> 
> Co-developed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>
> ---
>  drivers/pci/controller/dwc/pcie-designware.c | 40 ++++++++++++++++++++
>  1 file changed, 40 insertions(+)
> 
> diff --git a/drivers/pci/controller/dwc/pcie-designware.c b/drivers/pci/controller/dwc/pcie-designware.c
> index 145e7f579072..a7c0671c6715 100644
> --- a/drivers/pci/controller/dwc/pcie-designware.c
> +++ b/drivers/pci/controller/dwc/pcie-designware.c
> @@ -16,6 +16,7 @@
>  #include <linux/gpio/consumer.h>
>  #include <linux/ioport.h>
>  #include <linux/of.h>
> +#include <linux/pcie-dwc.h>
>  #include <linux/platform_device.h>
>  #include <linux/sizes.h>
>  #include <linux/types.h>
> @@ -283,6 +284,45 @@ u16 dw_pcie_find_ext_capability(struct dw_pcie *pci, u8 cap)
>  }
>  EXPORT_SYMBOL_GPL(dw_pcie_find_ext_capability);
>  
> +static u16 __dw_pcie_find_vsec_capability(struct dw_pcie *pci, u16 vendor_id,
> +					  u16 vsec_id)
> +{
> +	u16 vsec = 0;
> +	u32 header;
> +
> +	if (vendor_id != dw_pcie_readw_dbi(pci, PCI_VENDOR_ID))
> +		return 0;
> +
> +	while ((vsec = dw_pcie_find_next_ext_capability(pci, vsec,
> +						       PCI_EXT_CAP_ID_VNDR))) {
> +		header = dw_pcie_readl_dbi(pci, vsec + PCI_VNDR_HEADER);
> +		if (PCI_VNDR_HEADER_ID(header) == vsec_id)
> +			return vsec;
> +	}
> +
> +	return 0;
> +}
> +
> +static u16 dw_pcie_find_vsec_capability(struct dw_pcie *pci,
> +					const struct dwc_pcie_vsec_id *vsec_ids)
> +{
> +	const struct dwc_pcie_vsec_id *vid;
> +	u16 vsec;
> +	u32 header;
> +
> +	for (vid = vsec_ids; vid->vendor_id; vid++) {
> +		vsec = __dw_pcie_find_vsec_capability(pci, vid->vendor_id,
> +						      vid->vsec_id);
> +		if (vsec) {
> +			header = dw_pcie_readl_dbi(pci, vsec + PCI_VNDR_HEADER);
> +			if (PCI_VNDR_HEADER_REV(header) == vid->vsec_rev)
> +				return vsec;
> +		}
> +	}
> +
> +	return 0;
> +}
> +
>  int dw_pcie_read(void __iomem *addr, int size, u32 *val)
>  {
>  	if (!IS_ALIGNED((uintptr_t)addr, size)) {
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-qv1-f51.google.com (mail-qv1-f51.google.com [209.85.219.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C73E81C84A0;
	Mon,  3 Mar 2025 17:19:45 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.219.51
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741022387; cv=none; b=gfq//pgMTLqjvZbBsaw6zSTVh+a3T6g8itL5CPvmDjQnFVmGmDUEk7PwEpfQz703Wo4eVJj0RuRwj2aB4oKjZM4GIiGhpPCT9DbRb4ooEyQknl16upXwDXl0qA/5CHtkS8ldkuTQifJjSWUNxts0UWb4/zgzmHRU2APmr0IEgNw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741022387; c=relaxed/simple;
	bh=pcJq6VhwCjfaynCr86urxIunhUrIjpzsnVvjguFK+6A=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=fWdWw+3j0zcUtRO8JnV8gwlA4B54/yNmRhqia1dIfRfUC5cGrjtkWHgnBuBMvL000IbWKbvRbvTFhlZPmu/ozCm7p+MDgOFGyVg7m2Lo8jvSL8leB+kKjx5NjQCRKkRFZ0pSSrn3gvPxgxl/DxmJJmQo4HHymi3KV45kG+PX0AA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=OHRGWsgJ; arc=none smtp.client-ip=209.85.219.51
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="OHRGWsgJ"
Received: by mail-qv1-f51.google.com with SMTP id 6a1803df08f44-6dcd4f1aaccso79089916d6.2;
        Mon, 03 Mar 2025 09:19:45 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741022385; x=1741627185; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=LRLgSxdqlBvInXl2DZuy/8p0+JAmavEVWC8IUWE/7IY=;
        b=OHRGWsgJz6902CqePRbBJMqqUunL55qU+AQ4z2l1ZiS5UHizMvxtAJQ/79ScAb8J6x
         0OVs/3adYeQLgVWaPE9ZbAlBnBLKAqwxj06wxNyTXE3qP7kwMU3fpMeMKK8cVheFlARf
         lDdwwg3vee0d7QMIeI9zvHFoFDytMKrU4hMT874TbWUSbWwKQQJOj95RdjgCetlzfmCu
         j6kGXQTrWNdmhCbbVa1AuV8FyC5WZsm0YcbBiqAOEzlj7oEDH6Wqy/aiprXrFegJ4h1N
         LduJc7D5qGVdetbdgMh7wdrn0DXhIP2HPl4lztDbr+77VyAkrX8FEFK3u115KuEfTgLx
         uo1w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741022385; x=1741627185;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=LRLgSxdqlBvInXl2DZuy/8p0+JAmavEVWC8IUWE/7IY=;
        b=cZ2ROyngppwt09wVz8OTSGfe03mWZyxRtwjd9DNazmWgtSaRmmxKotGqT5rrCDj5lT
         MJ1ZqWJQ5Rxv0ast2MHf+7sDg8BXORGP0wVuN1mnvXvyVpcdfFTzXl1asPxAvbawuuN9
         4U9Gm3Y+bGFVMEfc7hcoaXQakoKvQm7KFUQQ0ZNuukbl3GKv0owcuR5ANtJMTfY1j9IZ
         cU9Y9SraMbrh3OiSTVGp3UcvwtN82MGQmQRBlw4qqBoDSKIrjXYohJOIw0vYEu4ktQke
         GTG7hNNGo1pYEYAwrZ7uyps1vGVvHLbbov5k8rs3Hh5FSzsYvqt2b02vG4fqPwVXtU2i
         VTGg==
X-Forwarded-Encrypted: i=1; AJvYcCW8yQ9g7ARwpZxhrje3R1slYPThwtWVshw4ErOw5RcOdiqAfmBrNn4D6HPxVG0o8Ar07RddtDMnVBghfv/gW68Oyw==@vger.kernel.org, AJvYcCWdRZKjwEvDmksQn4j1688iaSya3YJYF6JiMkzdwixOdONy3vBt8jZEEnyViOPvkXi6Edgp+gvZ1Nk=@vger.kernel.org
X-Gm-Message-State: AOJu0YzAKV9s2/dWjEtWkeDTmIM4EOrV/JBa+KO0HSG9iiqX1pyu/TCN
	2lkliEFGOKrcWN7jFAq0IYNoTovh0KyMTUuRUnHzqWUaz3+ZbTvL
X-Gm-Gg: ASbGnct1hcC520Nl5HnjnI1aDT5nT2nIA1kER1xaURBnhD+LngcBlaStifxF7bpy6aI
	0CAWuYJ3gxi+7XEGhQ0TGusaU7x40Z/hXOL1InzfJlY7gAP2GwrTysw5VhVtigvnmpN7E4DOmtq
	QJjh6aR+SFJlG2ulv7prLHFxH50T4yarnp637dgFliaMEyg2dQYX5mruxVmrlZUW8nEMl3WXp5n
	RRZlsbjWQybSJyvJii4EyH8CIvx24/lvXPR9UvZBb8wgzSzDsTMEAcbDafKpuer8P65/gTN22bD
	34yn56TLSKgKxS1LFh62JEtx5X9R9P7MU0dPiGOM
X-Google-Smtp-Source: AGHT+IG0zVy7lg60mYfgSImCsh74mBuzqU36VHUksDzxDuyNJ/s3ohxIrUrwvRq5twPzh4X1lLXSdA==
X-Received: by 2002:ad4:5ec9:0:b0:6d4:c6d:17fe with SMTP id 6a1803df08f44-6e8a0d066f7mr250591406d6.25.1741022384595;
        Mon, 03 Mar 2025 09:19:44 -0800 (PST)
Received: from debian ([2607:fb90:8e63:c2b3:5405:c8bf:c1d1:41d5])
        by smtp.gmail.com with ESMTPSA id af79cd13be357-7c378da08f2sm617957485a.81.2025.03.03.09.19.40
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 09:19:44 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 09:19:38 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, kw@linux.com, robh@kernel.org,
	bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, nifan.cxl@gmail.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 1/5] perf/dwc_pcie: Move common DWC struct definitions
 to 'pcie-dwc.h'
Message-ID: <Z8XkqnQir1CfilvM@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132024epcas5p13d6e617805e4ef0c081227b08119871b@epcas5p1.samsung.com>
 <20250221131548.59616-2-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-2-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:44PM +0530, Shradha Todi wrote:
> From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> 
> Since these are common to all Desginware PCIe IPs, move them to a new
> header 'pcie-dwc.h', so that other drivers like debugfs, perf and sysfs
> could make use of them.
> 
> Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

Reviewed-by: Fan Ni <fan.ni@samsung.com>

> ---
>  MAINTAINERS                 |  1 +
>  drivers/perf/dwc_pcie_pmu.c | 25 +++----------------------
>  include/linux/pcie-dwc.h    | 34 ++++++++++++++++++++++++++++++++++
>  3 files changed, 38 insertions(+), 22 deletions(-)
>  create mode 100644 include/linux/pcie-dwc.h
> 
> diff --git a/MAINTAINERS b/MAINTAINERS
> index 3864d473f52f..6474a2d83de4 100644
> --- a/MAINTAINERS
> +++ b/MAINTAINERS
> @@ -18167,6 +18167,7 @@ S:	Maintained
>  F:	Documentation/devicetree/bindings/pci/snps,dw-pcie-ep.yaml
>  F:	Documentation/devicetree/bindings/pci/snps,dw-pcie.yaml
>  F:	drivers/pci/controller/dwc/*designware*
> +F:	include/linux/pcie-dwc.h
>  
>  PCI DRIVER FOR TI DRA7XX/J721E
>  M:	Vignesh Raghavendra <vigneshr@ti.com>
> diff --git a/drivers/perf/dwc_pcie_pmu.c b/drivers/perf/dwc_pcie_pmu.c
> index cccecae9823f..da30f2c2d674 100644
> --- a/drivers/perf/dwc_pcie_pmu.c
> +++ b/drivers/perf/dwc_pcie_pmu.c
> @@ -13,6 +13,7 @@
>  #include <linux/errno.h>
>  #include <linux/kernel.h>
>  #include <linux/list.h>
> +#include <linux/pcie-dwc.h>
>  #include <linux/perf_event.h>
>  #include <linux/pci.h>
>  #include <linux/platform_device.h>
> @@ -99,26 +100,6 @@ struct dwc_pcie_dev_info {
>  	struct list_head dev_node;
>  };
>  
> -struct dwc_pcie_pmu_vsec_id {
> -	u16 vendor_id;
> -	u16 vsec_id;
> -	u8 vsec_rev;
> -};
> -
> -/*
> - * VSEC IDs are allocated by the vendor, so a given ID may mean different
> - * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
> - */
> -static const struct dwc_pcie_pmu_vsec_id dwc_pcie_pmu_vsec_ids[] = {
> -	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{ .vendor_id = PCI_VENDOR_ID_QCOM,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{} /* terminator */
> -};
> -
>  static ssize_t cpumask_show(struct device *dev,
>  					 struct device_attribute *attr,
>  					 char *buf)
> @@ -529,14 +510,14 @@ static void dwc_pcie_unregister_pmu(void *data)
>  
>  static u16 dwc_pcie_des_cap(struct pci_dev *pdev)
>  {
> -	const struct dwc_pcie_pmu_vsec_id *vid;
> +	const struct dwc_pcie_vsec_id *vid;
>  	u16 vsec;
>  	u32 val;
>  
>  	if (!pci_is_pcie(pdev) || !(pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT))
>  		return 0;
>  
> -	for (vid = dwc_pcie_pmu_vsec_ids; vid->vendor_id; vid++) {
> +	for (vid = dwc_pcie_rasdes_vsec_ids; vid->vendor_id; vid++) {
>  		vsec = pci_find_vsec_capability(pdev, vid->vendor_id,
>  						vid->vsec_id);
>  		if (vsec) {
> diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
> new file mode 100644
> index 000000000000..40f3545731c8
> --- /dev/null
> +++ b/include/linux/pcie-dwc.h
> @@ -0,0 +1,34 @@
> +/* SPDX-License-Identifier: GPL-2.0 */
> +/*
> + * Copyright (C) 2021-2023 Alibaba Inc.
> + *
> + * Copyright 2025 Linaro Ltd.
> + * Author: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> + */
> +
> +#ifndef LINUX_PCIE_DWC_H
> +#define LINUX_PCIE_DWC_H
> +
> +#include <linux/pci_ids.h>
> +
> +struct dwc_pcie_vsec_id {
> +	u16 vendor_id;
> +	u16 vsec_id;
> +	u8 vsec_rev;
> +};
> +
> +/*
> + * VSEC IDs are allocated by the vendor, so a given ID may mean different
> + * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
> + */
> +static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
> +	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_QCOM,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{} /* terminator */
> +};
> +
> +#endif /* LINUX_PCIE_DWC_H */
> -- 
> 2.17.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f172.google.com (mail-pl1-f172.google.com [209.85.214.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A4F312BB04;
	Mon,  3 Mar 2025 09:52:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740995525; cv=none; b=h+6M9oh9Zt3wj0f8I/7X2OhDtIqEvUEFF0bOBEoEuRY/tImcPhqcclwLNuqayJSILXGBXXDkissMj/ikGVt5SST2/eR9h05w0oX4fNd4wQu9Lenhcsxh0ukBTD8/YVURmN3Wgg0nHFkt5cA3zBqb+8YKufIVbEY0MaFrU9Gy7nA=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740995525; c=relaxed/simple;
	bh=MAcogLOHTDP8IrUlz+d1JPodWURGuPl7w4VJy92YRTk=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=pAIpNu6J5CS9WGhhfnGgrf+VuMZPyuTwCQr0vKP0sEfXN/365T4PMikirvluCC9xz5/CLmwH0B1R4e1bI58qM4Nq0DIgpVYdiDQ81B4pM3ivsf91U+cbXhR4rZGm1/y5FCP4Fa4tcf8aXLqPgDxdI4qtMnCsDTVImEg4W88nv2k=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f172.google.com with SMTP id d9443c01a7336-2239f8646f6so20014035ad.2;
        Mon, 03 Mar 2025 01:52:03 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740995523; x=1741600323;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=40J+Ql5K6IK0gLn8z0lNt2yYrMqV11O1QyGkgGVKClI=;
        b=FBYWWX6A9nk9F06Pjau918QKv2paEiG1O86nxbQ9e22IYzTMDhYTD6G57LTa6RcKyN
         nrr0iAbstC5MT8dravb9wcLGFeJP7fo3NH7iWSUFQCxvIMj2m6L6hca7sTwjXpb1m/8Z
         Ds14KMoxTEcPHEaeJu2wrRtfjeU9CLOe/J2rDalb1u4gSpuhZNVyb5K4YI34RBAWnLgM
         ij5RY49TszV0cic4whKX+k4IeNg0IfTdHBtqr/goId+XSkLNi89XLC6jd/vjagI14kgV
         11zQESktxY/LrNrFwAZ6xqeCIlu36XQobqPOlZI8LMSjdb3diwRl+WTKoLiCxlTd5Hbe
         93Bw==
X-Forwarded-Encrypted: i=1; AJvYcCUWYyr4/OTrSngYvyidww+YJqZf2tMPh3sCCXIbrkvNNrlSJWuWJscfxksizb9OZ56EPBN47QBaK379TTS3E2XIzg==@vger.kernel.org, AJvYcCWcX0Q8nnd9bcVNFUPen9iyMiW8TH34GHhG/c3sKameW7yMMQimBXzAEnYI5jKy+cVK8Rpzw2Az+jQ=@vger.kernel.org
X-Gm-Message-State: AOJu0Ywt1+3LKTuguMLZOLIK6zmR/2LNc4UVoN+9Ga2pewT4S8R38EQM
	qZ6S2DY+DxCW6nt+0S2jnoBhFmF2ALMd5A2M/cXRHk2pltMMnQSN
X-Gm-Gg: ASbGncv8mmwixv0fVOq5Flp5Yxg0LUsRB4ssVHUUjxw9RclIFWu/gtjcnHqXs2mawfm
	NXT/0L89HumOlGBSyEkSL/rNw2cWaSNuSzaxeqw6XqHeRdnnUrKJiNWaXeUW3eZ1FnytE59f9qF
	xxtbUOMQFZUcF51NQ5LPPn399yBLQVRIQIWEkxEF83z7CqsUUoresUkO+azrQixvB5dU/Kl0gJX
	DDd52IRDMzh/nhhIwMZcVJSTKxTwhS6g6RyBGXQumY01LIzYSl5G9AXELHO63kDVQYWSzUx3w2K
	6l6u+Z9ewt0p9EmzmV67RhvQXvHNi81DYeYV05mQp5Cy7DtM0M8Npmw1Q4Sn37h3p28HfLF7q6v
	4yAI=
X-Google-Smtp-Source: AGHT+IEWAfT5Z97RfY9VXKqz6TqnQKfcazGhBUq366+ebKsHwhmWqH4G2doQhibh2hZGJVaVQ0CoDQ==
X-Received: by 2002:a17:902:fc48:b0:223:66bb:8993 with SMTP id d9443c01a7336-22369207c1fmr208309815ad.43.1740995522806;
        Mon, 03 Mar 2025 01:52:02 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 98e67ed59e1d1-2fea67532a2sm8540087a91.9.2025.03.03.01.52.01
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 01:52:02 -0800 (PST)
Date: Mon, 3 Mar 2025 18:52:00 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250303095200.GB1065658@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-5-shradha.t@samsung.com>

Hello,

[...]
> +		29) Generates duplicate TLPs - duplicate_dllp
> +		30) Generates Nullified TLPs - nullified_tlp

Would the above field called "duplicate_dllp" for duplicate TLPs be
a potential typo?  Perhaps this should be called "duplicate_tlp"?

I wanted to make sure we have the correct field name.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f179.google.com (mail-pl1-f179.google.com [209.85.214.179])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id CA5F120FA9C;
	Wed, 26 Feb 2025 06:48:52 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.179
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740552534; cv=none; b=NLTZer4N/JI902lCjv6dkOKeX1BViGr6N2FLKwZ1yDmbhHPmXj0FMjie1gKIXAWJWukG6dJ/RwB6RfO9UKy1K74dvsfy2gQ9xnhwmgrE2L++V6WIlFC3Wu5vwIjeuNVb1/7mejU3P5GRPY68nNaFDLmxD+zE+QlD5vmUhq9lJfg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740552534; c=relaxed/simple;
	bh=gC7PSBjyRUnVpAoH8oaR/sRgc92k/ei7rpPXG+RmbiQ=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=PX4c3tBIA4af7v4q13VO0AH455FA/g2czjljzrHEYKnwILdTKUzCw2OYiLFxw7GLWeUEUtW8KwVpDriQAjSQoAP9x6XPXMzjfYcAkMWrluhWSo3VVSHITpNL3o9T2aKBIqYV5MPK4mb2ZyhmK//+MY8fFOQKdclfWdbrx/ktZO0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.179
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f179.google.com with SMTP id d9443c01a7336-22334203781so1829215ad.0;
        Tue, 25 Feb 2025 22:48:52 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740552532; x=1741157332;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=BFPHzWF9dvrF9nnBiTWLXmH6iPscf0ArvWzi8p1a6zg=;
        b=aEw4C1Ig7pUPmccjvUWp3FfIggCwsguGDZ6uvZxGM3cAv+I+3AY5l1JzSiwXBCpgky
         HiHh94eayPrrUXD1KOjp4B+1MrWDesjqOeqZUmH20fRUAlWpVhjGowtPARQtWrxPtR+g
         iRPObpuG/0SQAVKeJZXGnOJzBdNNlzGK/gQHpl5XLyGvBNyxwbA+9ZMJHp0istwkNCjN
         RFLAcFS2xu1GjfGYLaznvFPhvdLqOhP4qhlorXWe8teqp9zqYsFDHUWmwxPw+jepMfdw
         HIXvk2QBgp1qPju2sMHKB50KPuYIeCmwX6FSxjhKKDpEslqKF1jdK30qqz/8qRtDHIUs
         FuEw==
X-Forwarded-Encrypted: i=1; AJvYcCUKUase9qpBbrqzpDwLuM/7EMkMAHxPh9c650CoJgWMqv7bVrwPkXxRoWM/aJlJGc9iQm6fGxOsQ6HlQbVIT4PJZA==@vger.kernel.org, AJvYcCUQt/7XoGIiExwje0OdFVtEPvRxeUtMh0LreFzdFDLiM05cQYjz1bD2ijDwL4QIokfSx9Ny/wSxmGn7@vger.kernel.org, AJvYcCWYYnZj/f/dPhRPzLL7ov51LF+s0H2ceF+OzyDMCNeiSMGsg32m+umVB+hl1MKoYQ/SaFaewDCPyRFbd1E=@vger.kernel.org
X-Gm-Message-State: AOJu0YwvOFy3Jt0DWxaca2xsxsAPdNmS2ZMIrEKYaM0YlGFyHZ//pKHj
	WeHEMLzkDYpI+vyhWl4WJMK3WG3UqRdaoTgNSkIaOEZwThB00jH+
X-Gm-Gg: ASbGncuv4lJrRGPLPNDXveu3pl3S5ysiZVAslLPq9xKvH4gbod2DZe7FAvmPhWnQJoF
	3mCC7RiZ2qySTWf4IrhfdAj5R84J2RV52zSmdtkyDGNUX8LdSO9hVM/IGyeuMmLakmqzlGmN0+V
	SIcMQy9F5At58xXy9hoOT0gsS4ID+/boxnwpvtnf9fppQztqz9PMosOH+3ohtYvoXhGs185Oca/
	5/dZuyO21toHc4wEw3xBuJF1k2pNjtpN1dHI2DpHSnUmekRZedl9IgPe07HY4v7FeY9F3e1NOb3
	82UHRJaY6K/81Y597JX9zQIbdDSRMLpnKFszE5gEusdnVH7VrDI+mCthGkHzKpNKJZOFGcFaza8
	fhg4=
X-Google-Smtp-Source: AGHT+IGcE5VWjeLtYFuzMnR4StCCXIyHnVIwT6r2xYT1E3w/+YsuMDqsIDN1v9y0CaB1GqFIti/+Mw==
X-Received: by 2002:a62:b419:0:b0:725:4a1b:38ec with SMTP id d2e1a72fcca58-7341406be25mr35814240b3a.3.1740552532025;
        Tue, 25 Feb 2025 22:48:52 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 41be03b00d2f7-aedab119e3csm2394339a12.76.2025.02.25.22.48.51
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 22:48:51 -0800 (PST)
Date: Wed, 26 Feb 2025 15:48:49 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shuai Xue <xueshuai@linux.alibaba.com>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 1/5] perf/dwc_pcie: Move common DWC struct definitions
 to 'pcie-dwc.h'
Message-ID: <20250226064849.GA951736@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132024epcas5p13d6e617805e4ef0c081227b08119871b@epcas5p1.samsung.com>
 <20250221131548.59616-2-shradha.t@samsung.com>
 <855b4178-cbd5-4d95-a2eb-32c5ee0e5894@linux.alibaba.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <855b4178-cbd5-4d95-a2eb-32c5ee0e5894@linux.alibaba.com>

Hello,

> > Since these are common to all Desginware PCIe IPs, move them to a new
> > header 'pcie-dwc.h', so that other drivers like debugfs, perf and sysfs
> > could make use of them.
[...]
> LGTM. Thanks.
> 
> Reviewed-by: Shuai Xue <xueshuai@linux.alibaba.com>

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from out30-98.freemail.mail.aliyun.com (out30-98.freemail.mail.aliyun.com [115.124.30.98])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 72902EBE;
	Wed, 26 Feb 2025 01:55:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=115.124.30.98
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740534952; cv=none; b=t1oW0UR1SShhWvJolEpFa1iNEXT+qmPIYV82zb5u/gGwJlOzwJUdN4kqES6a3s2MJNLwkWbTDUuGLTu0HZVl9rsvPujHM9Vyw35VUV64sfzGrWPduA1+rykDzCqbSjhcy+UkNeT9RhuXPQls+hUjau0djqbii4beMkW3FBP/hZg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740534952; c=relaxed/simple;
	bh=hpo8SdVEcKI6pEDAOsFUUwXI4aD7oAd5zuM5+KJpZsY=;
	h=Message-ID:Date:MIME-Version:Subject:To:Cc:References:From:
	 In-Reply-To:Content-Type; b=HRmB3bMSLF4399HT+gARNNwEGDyy610MaG8TI1gAm7ijMuUY9RbnB2uMqcPD6MoOR/XwRFSN4/Nxp8OWdLz2BiUJUi6SCGgjoHqPspqIkSZ17M0tqxedrPdTvF1XpMbWQXXCBqyUIqcBSxxtYACNPRAVT8SMD54wTma398NIjzc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linux.alibaba.com; spf=pass smtp.mailfrom=linux.alibaba.com; dkim=pass (1024-bit key) header.d=linux.alibaba.com header.i=@linux.alibaba.com header.b=dw8z0bBs; arc=none smtp.client-ip=115.124.30.98
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linux.alibaba.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linux.alibaba.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=linux.alibaba.com header.i=@linux.alibaba.com header.b="dw8z0bBs"
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=linux.alibaba.com; s=default;
	t=1740534940; h=Message-ID:Date:MIME-Version:Subject:To:From:Content-Type;
	bh=SYGXr6ObxBCz/rMlq9BwzU4N8B+1nvlSFrvEr4NdUT8=;
	b=dw8z0bBsxUhOZMmHzHYtDeeO/j2jLAMVUXVXhxEjqNYE9YRkzPf7d/qty8zCitUGUcshbJP+GFz8MBXx/ubsquf0fOvy6RzrI22HBHtScSSadwJPAQ8ihtye8xrdLXDhb0VlsqEM8ZWL9jEi0lEAssEMFcg70ak6tyCJ8+5iPFo=
Received: from 30.246.161.128(mailfrom:xueshuai@linux.alibaba.com fp:SMTPD_---0WQGACDe_1740534937 cluster:ay36)
          by smtp.aliyun-inc.com;
          Wed, 26 Feb 2025 09:55:38 +0800
Message-ID: <855b4178-cbd5-4d95-a2eb-32c5ee0e5894@linux.alibaba.com>
Date: Wed, 26 Feb 2025 09:55:35 +0800
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [PATCH v7 1/5] perf/dwc_pcie: Move common DWC struct definitions
 to 'pcie-dwc.h'
To: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
 linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
 linux-perf-users@vger.kernel.org
Cc: manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, kw@linux.com,
 robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
 Jonathan.Cameron@Huawei.com, fan.ni@samsung.com, nifan.cxl@gmail.com,
 a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org,
 18255117159@163.com, renyu.zj@linux.alibaba.com, will@kernel.org,
 mark.rutland@arm.com
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132024epcas5p13d6e617805e4ef0c081227b08119871b@epcas5p1.samsung.com>
 <20250221131548.59616-2-shradha.t@samsung.com>
From: Shuai Xue <xueshuai@linux.alibaba.com>
In-Reply-To: <20250221131548.59616-2-shradha.t@samsung.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit



åœ¨ 2025/2/21 21:15, Shradha Todi å†™é“:
> From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> 
> Since these are common to all Desginware PCIe IPs, move them to a new
> header 'pcie-dwc.h', so that other drivers like debugfs, perf and sysfs
> could make use of them.
> 
> Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>
> ---
>   MAINTAINERS                 |  1 +
>   drivers/perf/dwc_pcie_pmu.c | 25 +++----------------------
>   include/linux/pcie-dwc.h    | 34 ++++++++++++++++++++++++++++++++++
>   3 files changed, 38 insertions(+), 22 deletions(-)
>   create mode 100644 include/linux/pcie-dwc.h
> 
> diff --git a/MAINTAINERS b/MAINTAINERS
> index 3864d473f52f..6474a2d83de4 100644
> --- a/MAINTAINERS
> +++ b/MAINTAINERS
> @@ -18167,6 +18167,7 @@ S:	Maintained
>   F:	Documentation/devicetree/bindings/pci/snps,dw-pcie-ep.yaml
>   F:	Documentation/devicetree/bindings/pci/snps,dw-pcie.yaml
>   F:	drivers/pci/controller/dwc/*designware*
> +F:	include/linux/pcie-dwc.h
>   
>   PCI DRIVER FOR TI DRA7XX/J721E
>   M:	Vignesh Raghavendra <vigneshr@ti.com>
> diff --git a/drivers/perf/dwc_pcie_pmu.c b/drivers/perf/dwc_pcie_pmu.c
> index cccecae9823f..da30f2c2d674 100644
> --- a/drivers/perf/dwc_pcie_pmu.c
> +++ b/drivers/perf/dwc_pcie_pmu.c
> @@ -13,6 +13,7 @@
>   #include <linux/errno.h>
>   #include <linux/kernel.h>
>   #include <linux/list.h>
> +#include <linux/pcie-dwc.h>
>   #include <linux/perf_event.h>
>   #include <linux/pci.h>
>   #include <linux/platform_device.h>
> @@ -99,26 +100,6 @@ struct dwc_pcie_dev_info {
>   	struct list_head dev_node;
>   };
>   
> -struct dwc_pcie_pmu_vsec_id {
> -	u16 vendor_id;
> -	u16 vsec_id;
> -	u8 vsec_rev;
> -};
> -
> -/*
> - * VSEC IDs are allocated by the vendor, so a given ID may mean different
> - * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
> - */
> -static const struct dwc_pcie_pmu_vsec_id dwc_pcie_pmu_vsec_ids[] = {
> -	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{ .vendor_id = PCI_VENDOR_ID_QCOM,
> -	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> -	{} /* terminator */
> -};
> -
>   static ssize_t cpumask_show(struct device *dev,
>   					 struct device_attribute *attr,
>   					 char *buf)
> @@ -529,14 +510,14 @@ static void dwc_pcie_unregister_pmu(void *data)
>   
>   static u16 dwc_pcie_des_cap(struct pci_dev *pdev)
>   {
> -	const struct dwc_pcie_pmu_vsec_id *vid;
> +	const struct dwc_pcie_vsec_id *vid;
>   	u16 vsec;
>   	u32 val;
>   
>   	if (!pci_is_pcie(pdev) || !(pci_pcie_type(pdev) == PCI_EXP_TYPE_ROOT_PORT))
>   		return 0;
>   
> -	for (vid = dwc_pcie_pmu_vsec_ids; vid->vendor_id; vid++) {
> +	for (vid = dwc_pcie_rasdes_vsec_ids; vid->vendor_id; vid++) {
>   		vsec = pci_find_vsec_capability(pdev, vid->vendor_id,
>   						vid->vsec_id);
>   		if (vsec) {
> diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
> new file mode 100644
> index 000000000000..40f3545731c8
> --- /dev/null
> +++ b/include/linux/pcie-dwc.h
> @@ -0,0 +1,34 @@
> +/* SPDX-License-Identifier: GPL-2.0 */
> +/*
> + * Copyright (C) 2021-2023 Alibaba Inc.
> + *
> + * Copyright 2025 Linaro Ltd.
> + * Author: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> + */
> +
> +#ifndef LINUX_PCIE_DWC_H
> +#define LINUX_PCIE_DWC_H
> +
> +#include <linux/pci_ids.h>
> +
> +struct dwc_pcie_vsec_id {
> +	u16 vendor_id;
> +	u16 vsec_id;
> +	u8 vsec_rev;
> +};
> +
> +/*
> + * VSEC IDs are allocated by the vendor, so a given ID may mean different
> + * things to different vendors.  See PCIe r6.0, sec 7.9.5.2.
> + */
> +static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
> +	{ .vendor_id = PCI_VENDOR_ID_ALIBABA,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_AMPERE,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_QCOM,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{} /* terminator */
> +};
> +
> +#endif /* LINUX_PCIE_DWC_H */

LGTM. Thanks.

Reviewed-by: Shuai Xue <xueshuai@linux.alibaba.com>

Shuai

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f181.google.com (mail-pl1-f181.google.com [209.85.214.181])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2D6DD21ABA2;
	Tue, 25 Feb 2025 14:47:59 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.181
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740494881; cv=none; b=ni5OBXNxh/w/va/uHjYrML7qifBPLNiPiGdjbjXnO3TbGgsC5uHE/ZGTNHCUnC6xbM6FJGY5962ZwwS+Yu6Da3DwWDCkRlqGz4jBx/4FNwQsZ4OEN9/ZUPa/a4LWmLnkeNW57Fz+g2uZrk9FHaIcF2lumaLAtLn2vULfrmOoQ90=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740494881; c=relaxed/simple;
	bh=mdUuuqIXJweoUeEecxQyPPnc+0OGiJKwMkgKfyVt1BU=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=bsqdnhZAbiQ4WmqTxPAdYx2mrRM4xUA86yuKfze8gB8Zw2pTBw/I/nQZFg3p2KolWAAO1ltU+S6Rv/xyWNRFFZNYvOpQzDHAm/rv5vsimiL2M2gCm+zJURU7Qf2K3Xhghlt+xShN1IfW5id3AZHe9u9qbuIuuePM7rR+PAZVaHo=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.181
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f181.google.com with SMTP id d9443c01a7336-220bfdfb3f4so14706045ad.2;
        Tue, 25 Feb 2025 06:47:59 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740494879; x=1741099679;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=H9fUAMMSFfpBE9zde4jyNVpOAHmdzHBHI3cebG5cFgg=;
        b=nrNNMmDMHs5+UF/RuVqU6WDHe8CcNGAs0w/0rm3i++GAsnt0n8qOynz5PE6brjH5OH
         eVWDDCjkLtniavTQZtA+0WXbyPGfqS5wh1HDfHuJVr2uoszwwSzwDcZ9/JbfDWNgvYay
         W/KPwb+ZSu0T7lVJ/nSWES7a4C0ji7dkoM3CQ+twSuJ1fworsfhw6jYX6G98Pf4IfnFM
         VpFL2JVEPvvCM+lj2eptoz+zCCacjbnCOUOXpeU3Q1LD4wLS2aJqUa35SRTe0Uv8pSJN
         kA8fEGjhh1lUE59k1q1XTErPzZyirTMrHX/EbpQH4XEx6M2eYUVoJ7ng1mTy4W4UBXNc
         PYog==
X-Forwarded-Encrypted: i=1; AJvYcCWy7Km0UqFgWUD8D2mJugI5zrzEeMyx9cwvhNVMiBzCAsC6QQ+Uf3NTrQPYtnhZSaKOykZJa3T1vOpuwFAd/NkcuA==@vger.kernel.org, AJvYcCXAxkeqgDwR1pGR047dcktUsWA+5F6Cz8ucYxkAUJfF3ZaxOfKHdvcobsf5WVEGAqM8XedHfPUYVrU=@vger.kernel.org
X-Gm-Message-State: AOJu0Yyx2yiGPiuYFkN2lyCs0Jbhr26D8TFG5HXRRQrw7iCEfCg9ZrAM
	4amircMt38W8o3P8ZKgA7ebbLOw2eXK04Czrca1Gh5VGeV65K2pI
X-Gm-Gg: ASbGncu1aQ6B2Hn4Di8kHtrjInQacCVkfSUu0Nv9MPe0Et0tAEasYGjbklg/p3hs/xZ
	Xe/JPF2pOhKVuEthUVHiBrl8RF/O9x329lGKbnhBM+V5Y/N2qQ8XRBXhlCdjUqXBr0WkVMHDdWk
	FM2T4zZgT8U4LZ2/ZhHFbOZ8UR9nZwDargrFdWtsJYmx7w2hq7XS022aqX1+NKDvgn4dzIk4zFB
	6CJThRBqnBFl/qAyp7GRfk/e/hdzZc7tNCWkEJ741Y3VjxqSE7qm3Ks/9wCHtaYgGeglph5UUbw
	h9Kd9I3BvGfq6zQd/FtlnPPmOZJASwePosk1aBjfg798qogzFIfDZltICGJ7
X-Google-Smtp-Source: AGHT+IFJlOv8carYE6+UU235OdYaIvzKkWJV3Kr/Y5yUb/0j804xN8YoKlVnPeDtE+lBocpwiZJ8YA==
X-Received: by 2002:a05:6a00:c92:b0:732:1840:8382 with SMTP id d2e1a72fcca58-73426ae9b30mr24918884b3a.0.1740494879299;
        Tue, 25 Feb 2025 06:47:59 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 41be03b00d2f7-aeda7f8538fsm1488011a12.31.2025.02.25.06.47.58
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 06:47:58 -0800 (PST)
Date: Tue, 25 Feb 2025 23:47:57 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 1/5] perf/dwc_pcie: Move common DWC struct definitions
 to 'pcie-dwc.h'
Message-ID: <20250225144757.GA1660448@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132024epcas5p13d6e617805e4ef0c081227b08119871b@epcas5p1.samsung.com>
 <20250221131548.59616-2-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250221131548.59616-2-shradha.t@samsung.com>

Hello,

> Since these are common to all Desginware PCIe IPs, move them to a new
> header 'pcie-dwc.h', so that other drivers like debugfs, perf and sysfs
> could make use of them.
> 
> Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

We are still missing feedback from the perf maintainers.

Especially, as I would like to take this patch via the PCI tree, if there
is no objection.

Thank you, Niklas, for pointing this out.  Appreciated.

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9366B270ECB;
	Tue, 25 Feb 2025 14:35:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740494132; cv=none; b=Rl2G3BVNXxwhtCb1U/8jj4tKfUXLykhX5qoqgfV6Tj9Tq4pnu2655mqUNcwlfb1I2fFELqBSLe0iZ4IGq1YSqFc6b1TKuVY0h+69e3BRBdO50ZDZ7/f8fwz6zRQPaWXYMm8PgdTpX3GcvHOX4cjQ+BsoMMX5RtPAoJasFYWjSE4=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740494132; c=relaxed/simple;
	bh=cbtKDD3eUOS+sdzuwx+f9hBpWAvAFS/SyQ4YGdqd6Mk=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=frVqyWuRQgRIzyJolJzQF3s/aSI59C2m2Wo5bIoliLmde+6gspckJMmquz+EDlyzuTdKwaRHC1y8jPwVRZMDu4JH+sMzFJYjJRpMxlerbs3FchJrWvj7OWcYVZe3QNAiLvwmUEmDuGlTkHHyKs6WI5pqzl2b2m30ErLFaku5fYk=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=r8f3yZvj; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="r8f3yZvj"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id F11A0C4CEE8;
	Tue, 25 Feb 2025 14:35:27 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1740494132;
	bh=cbtKDD3eUOS+sdzuwx+f9hBpWAvAFS/SyQ4YGdqd6Mk=;
	h=Date:From:To:Cc:Subject:References:In-Reply-To:From;
	b=r8f3yZvj6glDk0Tl6Ruw/u8+8ujoAUZt22G0OqJjvBqdqE+u1Qwltqu1+JBbvyPLt
	 KIT0fHwdI+kF0q7M4O6MdEhtC+1CEbSukUvteTZzdDiyQY9dtehS2rIDd1rAkJCDDd
	 eB9jaqfAxpq96FAi16Qmz9PGaDXDi2nOxYwjmMMN8YSbzS6UyCuaDQrUIcSu0jU/ow
	 VeO9Fx/p//NqKI2B8xptU36u5s7nvl+/H/f/h9auyqCmXByU25jGso2WBqbBFwRVDV
	 vkG5icBx3VYlfnO8oCmutzq7ergr7st/bPjtX06E3prnGiD1jjB+D8h4i9iAZTJ1N/
	 aujNSqYX4Xpow==
Date: Tue, 25 Feb 2025 15:35:25 +0100
From: Niklas Cassel <cassel@kernel.org>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <Z73VLYudJVPkdbGN@ryzen>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
 <Z7yniizCTdBvUBI0@ryzen>
 <20250225082835.dl4yleybs3emyboq@thinkpad>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250225082835.dl4yleybs3emyboq@thinkpad>

On Tue, Feb 25, 2025 at 01:58:35PM +0530, Manivannan Sadhasivam wrote:
> On Mon, Feb 24, 2025 at 06:08:26PM +0100, Niklas Cassel wrote:
> > Hello Shradha,
> > 
> > On Fri, Feb 21, 2025 at 06:45:43PM +0530, Shradha Todi wrote:
> > > DesignWare controller provides a vendor specific extended capability
> > > called RASDES as an IP feature. This extended capability  provides
> > > hardware information like:
> > >  - Debug registers to know the state of the link or controller. 
> > >  - Error injection mechanisms to inject various PCIe errors including
> > >    sequence number, CRC
> > >  - Statistical counters to know how many times a particular event
> > >    occurred
> > > 
> > > However, in Linux we do not have any generic or custom support to be
> > > able to use this feature in an efficient manner. This is the reason we
> > > are proposing this framework. Debug and bring up time of high-speed IPs
> > > are highly dependent on costlier hardware analyzers and this solution
> > > will in some ways help to reduce the HW analyzer usage.
> > > 
> > > The debugfs entries can be used to get information about underlying
> > > hardware and can be shared with user space. Separate debugfs entries has
> > > been created to cater to all the DES hooks provided by the controller.
> > > The debugfs entries interacts with the RASDES registers in the required
> > > sequence and provides the meaningful data to the user. This eases the
> > > effort to understand and use the register information for debugging.
> > > 
> > > This series creates a generic debugfs framework for DesignWare PCIe
> > > controllers where other debug features apart from RASDES can also be
> > > added as and when required.
> > > 
> > > v7:
> > >     - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
> > >       into this series to remove dependancy as discussed
> > >     - Addressed style related change requests from v6
> > 
> > I tested this series, and one thing that I noticed:
> > 
> > # for f in /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/counter_enable; do echo 1 > $f; done
> > 
> > # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/ctl_skp_os_parity_err/counter_enable:Counter Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/deskew_uncompleted_err/counter_enable:Counter Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/framing_err_in_l0/counter_enable:Counter Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/margin_crc_parity_err/counter_enable:Counter Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_1st/counter_enable:Counter Disabled
> > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_2nd/counter_enable:Counter Disabled
> > 
> > that there are some events that cannot be enabled when testing on my platform,
> > rk3588, perhaps this is because my version of the DWC IP does not have these
> > events.
> > 
> > (Because all the other events can be enabled successfully:
> > # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Enabled | wc -l
> > 29
> > )
> > 
> > 
> > So the question is, how do we want to handle that?
> >
> 
> This is a really good question.
>  
> > E.g. counter_enable_write() could theoretically read back the
> > dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> > register after doing the
> > ww_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> > 
> > to actually check if it could enable the event.
> > 
> > If counter_enable_write() could not enable the specific event, should it
> > perhaps return a failure to user space?
> > 
> 
> Yes, it would be appropriate to return -EOPNOTSUPP in that case. But I'd like to
> merge this series asap. So this patch can come on top of this series.

I agree that returning an error is probably the nicest thing.

However, this series has been picked up already :)

Is there anyone who volunteers on implementing the proposed feature?

If you have time, it would be interesting to see if you see the same behavior
on QCOM SoCs. (Assuming that your DWC PCIe controller does not implement all
events that Samsung DWC PCIe controller does.)


Kind regards,
Niklas

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f172.google.com (mail-pl1-f172.google.com [209.85.214.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C3EEA2698A8;
	Tue, 25 Feb 2025 14:33:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740494010; cv=none; b=YZRhBb3aepPgIiOeqHdNHeDZlHjuEmBGDIJQev7z+3khG9jdj/tXqoD4xZislTm6jkVJJckPKUJzquzes8/PlhcKQJumXYKz/xiIKIo14IDfgpNmeqPdMY6TEqiME/vQbr1yySxglURYQj11yBsw+ladj75fdvkA3eCNUo5vJ9o=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740494010; c=relaxed/simple;
	bh=2E/xivADWUmMltm294B490hpFTUkS2KD5I5zSos4jPk=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=DJj5B9HYgdmY5mz2+HwytO8Nde87NVlfY+3mkBRS2W040hAjq7unL9P7os3BtpC5ndcAgWkxAKK8dZo29zUrUIPxXW+nrIXOClM/fIaY3g8yEvEWnGENCMB6yWCpbwybLMVHDUjo0C3QR1kd1roauMyPlIVuC9PJPvvyt9L6SHc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f172.google.com with SMTP id d9443c01a7336-220f4dd756eso119740795ad.3;
        Tue, 25 Feb 2025 06:33:28 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740494008; x=1741098808;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=wfjw1HKQVvRq0BsR7wxCvBaXgth/Ba/pzPz08eLvgdM=;
        b=wSAvAissHnZ1Y7bzHhOIl+ZcSR1lwMG6fEl8rOB+iXwvOKO4E4Csj8+eltaHBV6H+e
         ZzTz+I5T9vq1TjX8PKUmGjECer7CMBEBvpYiBM35H25LASHA0PpzU1CxNR8L620DsDYJ
         95R9jN8t9rjxgwkQFXHlp7o0L3+mbTG+ujk5UjJLlqyXozTMJyQ7liXUIZX+w7ZHq8//
         tKJ1fijgMYLG9H6tccRTdVscVRNysGSDuK4FiUlnyi4StfkO+96qafv36MmituI2Wega
         Ls7Bm9GT+sZ/b/g65agKvcwF/NtYm3+azCkbVmMTP9j79+UDDQrFa0cC6g+mc3G1mrB5
         pOGg==
X-Forwarded-Encrypted: i=1; AJvYcCU/5VdUtPEIdnnhdZ/2srnfiE1uw317Q/CsuZiyLVlqBQoYyNguae/9069GZIyyEcCyQVmEONNqCSMXiwo=@vger.kernel.org, AJvYcCUgP3nzIwFPhImsHtRiXg+QWEl1J6QdglUujgp7Yk8RkOY6F8IR44XGFHOwdfOKlp1Fs8llCN/Na3Y7@vger.kernel.org, AJvYcCUnfRQ0ggnBxJmw6dOltDq/SbFqjFoev3RKaJkbpAvmZIxftIGwdva72MbK3bjhKRO0AXpugmsOXzHCSGmOOBv/uQ==@vger.kernel.org
X-Gm-Message-State: AOJu0Yz/W5VnS2SvAIaf3vGHmAXNoe4scbqP1GRC8ppJnMlGxvAez6Up
	IbfAunvbgPgWIt6RmtYYQQfW+OQCel8wSKH2H2KmsiFK0VKAHo9SKkhW9IPatKQ=
X-Gm-Gg: ASbGnct+roD2vZOMlHXBDllK8zmnIQZX3Ar8qOFrQly5UzSrZITGgCjdGqU9hQqPo+/
	pH0rApUWkfO/3CN1+Qo7H43Fbl26ucwsWqO1sTxkR40DrNwkoKuIXKz5UQHs5Jk9QfrXgwI3tXf
	nrPeNP/C9z4hGjldGE7hTrSDTZ1BGWbLUHXm6IidttD8mVPIPKmQNuIbrJZc4Sb6TJaepQWV6UH
	jm88jjO5jkoZLSZMGp8E2UC7UE4bioxxm3VHbZUt04SRCZXMt4kWwx/+wMAabNy/77IxYYL+TkQ
	cHDV3oyAFdGoS63Wk3SCK45WiuORD1Y+lB5PJybLUeOLyem/L+CD83rCoX/H
X-Google-Smtp-Source: AGHT+IFiIC1p2JsvGz1HBLa46/0n3Ly+kaAqBACASxC9/r77WzUjMbOSLV/Jfp7om7mV9KcQCdz2UQ==
X-Received: by 2002:a05:6a20:d492:b0:1f1:458:fe80 with SMTP id adf61e73a8af0-1f10458fe98mr2109104637.25.1740494007946;
        Tue, 25 Feb 2025 06:33:27 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 41be03b00d2f7-aeda75a224esm1420946a12.15.2025.02.25.06.33.27
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 06:33:27 -0800 (PST)
Date: Tue, 25 Feb 2025 23:33:25 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Niklas Cassel <cassel@kernel.org>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, fan.ni@samsung.com,
	nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250225143325.GB1556729@rocinante>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
 <Z7yniizCTdBvUBI0@ryzen>
 <20250225082835.dl4yleybs3emyboq@thinkpad>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250225082835.dl4yleybs3emyboq@thinkpad>

Hello,

[...]
> Yes, it would be appropriate to return -EOPNOTSUPP in that case. But I'd like to
> merge this series asap. So this patch can come on top of this series.

I pulled the series so that we can get some mileage out of the 0-day bot,
so to speak, and also get some testing via the linux-next tree.

That said, while looking at the code, there have been bits where I wanted
to get some clarification.  Nothing will be a blocker.

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f174.google.com (mail-pl1-f174.google.com [209.85.214.174])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 15AEB1A2C04
	for <linux-perf-users@vger.kernel.org>; Tue, 25 Feb 2025 08:28:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.174
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740472124; cv=none; b=jdH9nJqa44dgpDRHMepN3Dhzy2K35BrDVD8HFVLBE3GvJc1W20xOVyJQW4QBVm+XTwI9dS9N16KWDufN6tOQhkm7bvGnVpdACIvWDwmWaZvxaTiVI/ctKeRUu2B030Bj7dZNvfslHEWvmjSGoTPDvet/n78iXtEwyg8P8WWZWt0=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740472124; c=relaxed/simple;
	bh=ZBu2O8F+O0lq76BGmqBcGCD16yBaXXF7E8cefYSt1yQ=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=uF9nzkOoMBAOMgGN+hMC2PZx5l8CKuetygM0kAgALutIw10Tnu1tmv0Kyl2QIygMu0f3Q6HdTefNZ32k3zqR3cv6z1bLdUPqCrWNkJwQPiXieYYmP18XZmYRi8smn28vqpWzCE1Pkyu5dHt5DnL3YaQ/uyg5vffHhxOJsYJEYDY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=HYLm3EZe; arc=none smtp.client-ip=209.85.214.174
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="HYLm3EZe"
Received: by mail-pl1-f174.google.com with SMTP id d9443c01a7336-220e6028214so114838915ad.0
        for <linux-perf-users@vger.kernel.org>; Tue, 25 Feb 2025 00:28:42 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1740472122; x=1741076922; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=SQhuTT3keTFG3C8+wYIEtpMC3dYXL5RKzFQ+SXkD8fQ=;
        b=HYLm3EZeD/MmeUVxZ7CioUtHLoI7BIEWTtNXhk2bCFMFdHX2CebG5hVKO4zwQ+YsyF
         C5i+aj1XyFKPTxInqu2MZxsFRvPJ7lKWqi8iEGuKAdbwfS2rTupRcJc1d9iwHQGjThwx
         idLvDzpjlCopdG82NljaHYquIwY/cW3S2d2ngu62sB/BPpZ0Ca0Ckk3Fx9bqTRCjPGpX
         nH000uWxiAPjoQqbUOZBIDA5+AalAV0I7djcbWDMPgzOozR37qU0mjcIEEwGZaB5fvJa
         BGhFEupvedjUmdLOT0LJJyM7XfHyd3BZ3/u+IL1AGac/Qjav5AJ5FqkGvYdaQHoOtMvj
         HlzA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740472122; x=1741076922;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=SQhuTT3keTFG3C8+wYIEtpMC3dYXL5RKzFQ+SXkD8fQ=;
        b=Dgo3ef4xf+4Ykuo66E6a8Wt2OPxXBZgWMOeuMp9UIIbeKkLHb88Ru+O0R1WpmwYv8U
         RuQumEyWT8Uz29GIVnsJdRh14/B8q1xq+zcRHqWi8eMWfyYgdEkQ2gcDqrOLk+ED+vFp
         UVRW4YuxJfYROubDoQz8kwqYJPR4xtq8Amp0AjChpl+1rQdKavtNBwpuFZcTqFzMzjHU
         SsqPwyKtwWOq8K7osI7xu2YgTUAImZAqdDkdGpSxrG+GXKDHzx+JcBYuDqEuulsjNt+m
         QPcNdOOWvsAkJSywv75T8fNouX7rNcdyWzSVta2LnuqVY80r7HCtG422YArGyH/VRJsl
         cuEA==
X-Forwarded-Encrypted: i=1; AJvYcCWk2iLKKmsOYr6PxIARR7LVLBzR7BZt26SEulpj6t0KBgskEaMvFdOJi/Ct5KsUmboG0eddgKsQFqGeFVfdVAGI@vger.kernel.org
X-Gm-Message-State: AOJu0YwQq4YZZxWy3V1Qiz01BZGbnkIDinGzE9gqqS9vbujfzVTcNjTE
	MgtoDHS06KRSOyCpfRbuHylYJOt5KoGfuZtizBAhcxO8u7ap3rFxdq2lDD24uFnBWJMmJau0Ai8
	=
X-Gm-Gg: ASbGncva+xN/YakL/ibKLXMexGUGxRcY/Le/y7g5Qq4JkCRkt956IkRFWhBBB1N6c7j
	iL7/zQw/Ju5i+sxjSzjqMQfrReA+MJGEyEHZpelWyAd8C7Vi2X+Bv/utwBYO/hUK7vuCtDVcCiB
	UtLY1wWtKLfX6kQoOVK6wvPLvvLsWOpjb13PQuPmT9vcTtGtT6kBKkW1cdCX+v23c6kb90MVWDw
	xeFYOK1B7vtLfw98XeA1ZcZrEheQBq/uYeB/8yJva01gW47Yrqw4DRHEWvdidSAzJZOoeRTDsbh
	vEr8i+agJCl3J1ZNdiqT4HUV+vv6OxHH1Zz3
X-Google-Smtp-Source: AGHT+IHEpwYAv8u3qb59FV+xDfGctwCas/kzce4Z4IGvei21yGE+B1pj/P69NtHMGX6VmXsFeRHsJg==
X-Received: by 2002:a17:903:1c1:b0:216:3466:7414 with SMTP id d9443c01a7336-221a0025b25mr313420375ad.44.1740472122399;
        Tue, 25 Feb 2025 00:28:42 -0800 (PST)
Received: from thinkpad ([36.255.17.214])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-2230a0b7790sm8728625ad.254.2025.02.25.00.28.36
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 00:28:41 -0800 (PST)
Date: Tue, 25 Feb 2025 13:58:35 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Niklas Cassel <cassel@kernel.org>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250225082835.dl4yleybs3emyboq@thinkpad>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
 <Z7yniizCTdBvUBI0@ryzen>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z7yniizCTdBvUBI0@ryzen>

On Mon, Feb 24, 2025 at 06:08:26PM +0100, Niklas Cassel wrote:
> Hello Shradha,
> 
> On Fri, Feb 21, 2025 at 06:45:43PM +0530, Shradha Todi wrote:
> > DesignWare controller provides a vendor specific extended capability
> > called RASDES as an IP feature. This extended capability  provides
> > hardware information like:
> >  - Debug registers to know the state of the link or controller. 
> >  - Error injection mechanisms to inject various PCIe errors including
> >    sequence number, CRC
> >  - Statistical counters to know how many times a particular event
> >    occurred
> > 
> > However, in Linux we do not have any generic or custom support to be
> > able to use this feature in an efficient manner. This is the reason we
> > are proposing this framework. Debug and bring up time of high-speed IPs
> > are highly dependent on costlier hardware analyzers and this solution
> > will in some ways help to reduce the HW analyzer usage.
> > 
> > The debugfs entries can be used to get information about underlying
> > hardware and can be shared with user space. Separate debugfs entries has
> > been created to cater to all the DES hooks provided by the controller.
> > The debugfs entries interacts with the RASDES registers in the required
> > sequence and provides the meaningful data to the user. This eases the
> > effort to understand and use the register information for debugging.
> > 
> > This series creates a generic debugfs framework for DesignWare PCIe
> > controllers where other debug features apart from RASDES can also be
> > added as and when required.
> > 
> > v7:
> >     - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
> >       into this series to remove dependancy as discussed
> >     - Addressed style related change requests from v6
> 
> I tested this series, and one thing that I noticed:
> 
> # for f in /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/counter_enable; do echo 1 > $f; done
> 
> # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/ctl_skp_os_parity_err/counter_enable:Counter Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/deskew_uncompleted_err/counter_enable:Counter Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/framing_err_in_l0/counter_enable:Counter Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/margin_crc_parity_err/counter_enable:Counter Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_1st/counter_enable:Counter Disabled
> /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_2nd/counter_enable:Counter Disabled
> 
> that there are some events that cannot be enabled when testing on my platform,
> rk3588, perhaps this is because my version of the DWC IP does not have these
> events.
> 
> (Because all the other events can be enabled successfully:
> # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Enabled | wc -l
> 29
> )
> 
> 
> So the question is, how do we want to handle that?
>

This is a really good question.
 
> E.g. counter_enable_write() could theoretically read back the
> dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> register after doing the
> ww_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> 
> to actually check if it could enable the event.
> 
> If counter_enable_write() could not enable the specific event, should it
> perhaps return a failure to user space?
> 

Yes, it would be appropriate to return -EOPNOTSUPP in that case. But I'd like to
merge this series asap. So this patch can come on top of this series.

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f50.google.com (mail-pj1-f50.google.com [209.85.216.50])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E882C1FCFE6
	for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 08:54:47 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.50
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740300890; cv=none; b=LeGTvelvI60F/AMcZIjiOufIyJ24X/AWsvGWNJU659/YBiIWD9Y7xKn4n2zwCfj5KW/9hc01Jz2lr4xiJ/XzYE8vfI7U14C4xqAf5UTzeoh1qJ8QH3Wb6kpv7128Bp2WxJJdyPPkOH+KoOVxTghMT4mX0yI5Vm2CHsaBYjjxuW0=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740300890; c=relaxed/simple;
	bh=GMR3wHAQ7OLAK+0WIGs23NaDK/GUoW4XVGEi7BLl23E=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=fA/Ms98AraavTRNV1wAC0EJVIPrkaEp14GFd+Fctp3hW+0GXYMd7gAqq1ls1TRBidbd44faKjJLDkWPEFOQ2h3EtC02YHEDdCQu4xbeB0Yq0DmHGnQ7nLHG4V+w9mTl2jDlYiiHv0kbOh2NW3xXD4QRrzT7Pz7FFvr9bSkOz/zk=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=mZZpN81q; arc=none smtp.client-ip=209.85.216.50
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="mZZpN81q"
Received: by mail-pj1-f50.google.com with SMTP id 98e67ed59e1d1-2fbf77b2b64so7122065a91.2
        for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 00:54:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1740300887; x=1740905687; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=qhtfFGtrm/r/EdIHI4NWAw5GAp/ALVl3MX5Mqx7Mu6w=;
        b=mZZpN81q4EwmaNxbyQ76GUdXpvL0vVkpzq2qdDqCEZrVTkdQw4vziVlWHLXXhlc0gx
         yJ7MK5S2zYwJoo3Az2QCeNp+YsagLtcYlG0ns1utCLOJVTaf7KLXIZPSaK4imimZS/AE
         FbcEh+tM3qAIdfelXCiAStk+SKTcWBTdpdhG48/DKmUv3E0IZX5S4DkeyQ5rtfTU61Wa
         fU0McnMyCLZl5J/QVrX/xbAfzVdBT5V/HnWlwo3WkiwG1uT36QOo1tw6KxVoExJKIPFI
         Bb+hakIMfFt2NrFmpVfx8WXAe1Ja/tO0iL9U3/awXqRfyw7e9+CL8bMr1UOfgLnmdBHp
         mD/A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740300887; x=1740905687;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=qhtfFGtrm/r/EdIHI4NWAw5GAp/ALVl3MX5Mqx7Mu6w=;
        b=KBQOsR9ZZm1vfIrza4aLu1ft9DsykdltKrjkcf7jKFW4XI9oyUjnwCK53Aw6hb3qw4
         3W6w9aNHSwbgSQwTf4yFs+Ef2AAZlyrw9haFnRTwLYs42cHfCIcEJYdPyI92vnJRD3IZ
         ZUIPjP3acTMuVypo3nrjJAZokAECO9MsQONnWc8q8dLTQOziiY+OP+xfygrzQj1xbUuu
         EqiiP3u7NhB2hYLBm/vAmCv+XhIqxENw+b4u87GF5fFZi/pyrszeHcOZLGfYIKhgy1Mu
         TTO1TKu5vZ7qmpZgAaDyuuIIH4O7F3RnnCW4k792WtkSwUauHrgWHVFzt2dUh2kLLryh
         /Uug==
X-Forwarded-Encrypted: i=1; AJvYcCVPw+bfsuwiDhMntdn+2+2+9+OQ26dKHeyjyUPV3p3/QfS4ExWqwEnUbtGcOMvVxPvCWMSqwiqnGfKLf6hgIRBn@vger.kernel.org
X-Gm-Message-State: AOJu0YyV6RwZ33mkdCMXPXDiEhyKosGR0QTBxbutTf2BhkfPq0wNeOYL
	EucwtjfG9LK385JxoAkYkzO4noNdoIHBNVYt/oON1cZJAkoURBxxlv0jlAjDSw==
X-Gm-Gg: ASbGnctKpjftEJgeAoSIWRt1p1JpEFuVCx9z4F2oYr3rqr2f/BlafWcXfN/4uEJWKUg
	QN3s68fWvp5YjVPMPrk6/qyYT5VSbOx0o8hnXKjWaCNIRE8lMqgnfawnH/tUoOJ1Xtejiif5c+M
	tGEs1qPruXpdgDuh2wPUIiVMZK8qg+JrUv83xc11Kye+KHmbb3O2px+Z/OupWdvscoFOEEO/I3f
	yrzNbOXrZhfVJmdV6CYGrhSTYwJXRpps5RvEUVR/LdHVRga61YSMZNJA5en4wBMo72aO7XXjsuM
	50D10wVF8GZl1kzeRRyICyWp8iL/77m6f+K3n3w=
X-Google-Smtp-Source: AGHT+IEccR+ch+6Bpf4ueioZ0PgXfplXUF7AWlKJxIQS4x0ObG/yscvNDoElJGtPW6a87MTyMeTVtQ==
X-Received: by 2002:a17:90b:5106:b0:2f9:9ddd:68b9 with SMTP id 98e67ed59e1d1-2fce7b1da4amr13812767a91.26.1740300887190;
        Sun, 23 Feb 2025 00:54:47 -0800 (PST)
Received: from thinkpad ([220.158.156.216])
        by smtp.gmail.com with ESMTPSA id 98e67ed59e1d1-2fcbaaf9785sm6461472a91.1.2025.02.23.00.54.41
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 23 Feb 2025 00:54:46 -0800 (PST)
Date: Sun, 23 Feb 2025 14:24:39 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@Huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <20250223085439.esnpificf3xxih56@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250221131548.59616-6-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:48PM +0530, Shradha Todi wrote:
> Add support to provide statistical counter interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>

- Mani

> ---
>  Documentation/ABI/testing/debugfs-dwc-pcie    |  61 +++++
>  .../controller/dwc/pcie-designware-debugfs.c  | 229 +++++++++++++++++-
>  2 files changed, 289 insertions(+), 1 deletion(-)
> 
> diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
> index 6ee0897fe753..650a89b0511e 100644
> --- a/Documentation/ABI/testing/debugfs-dwc-pcie
> +++ b/Documentation/ABI/testing/debugfs-dwc-pcie
> @@ -81,3 +81,64 @@ Description:	rasdes_err_inj is the directory which can be used to inject errors
>  
>  			<count>
>  				Number of errors to be injected
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/counter_enable
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	rasdes_event_counters is the directory which can be used to collect
> +		statistical data about the number of times a certain event has occurred
> +		in the controller. The list of possible events are:
> +
> +		1) EBUF Overflow
> +		2) EBUF Underrun
> +		3) Decode Error
> +		4) Running Disparity Error
> +		5) SKP OS Parity Error
> +		6) SYNC Header Error
> +		7) Rx Valid De-assertion
> +		8) CTL SKP OS Parity Error
> +		9) 1st Retimer Parity Error
> +		10) 2nd Retimer Parity Error
> +		11) Margin CRC and Parity Error
> +		12) Detect EI Infer
> +		13) Receiver Error
> +		14) RX Recovery Req
> +		15) N_FTS Timeout
> +		16) Framing Error
> +		17) Deskew Error
> +		18) Framing Error In L0
> +		19) Deskew Uncompleted Error
> +		20) Bad TLP
> +		21) LCRC Error
> +		22) Bad DLLP
> +		23) Replay Number Rollover
> +		24) Replay Timeout
> +		25) Rx Nak DLLP
> +		26) Tx Nak DLLP
> +		27) Retry TLP
> +		28) FC Timeout
> +		29) Poisoned TLP
> +		30) ECRC Error
> +		31) Unsupported Request
> +		32) Completer Abort
> +		33) Completion Timeout
> +		34) EBUF SKP Add
> +		35) EBUF SKP Del
> +
> +		(RW) Write 1 to enable the event counter and write 0 to disable the event counter.
> +		Read will return whether the counter is currently enabled or disabled. Counter is
> +		disabled by default.
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/counter_value
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	(RO) Read will return the current value of the event counter. To reset the counter,
> +		counter should be disabled and enabled back using the 'counter_enable' attribute.
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_event_counters/<event>/lane_select
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	(RW) Some lanes in the event list are lane specific events. These include
> +		events 1) - 11) and 34) - 35).
> +		Write lane number for which counter needs to be enabled/disabled/dumped.
> +		Read will return the current selected lane number. Lane0 is selected by default.
> diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> index b7260edd2336..dca1e9999113 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -31,6 +31,17 @@
>  
>  #define ERR_INJ_ENABLE_REG		0x30
>  
> +#define RAS_DES_EVENT_COUNTER_DATA_REG	0xc
> +
> +#define RAS_DES_EVENT_COUNTER_CTRL_REG	0x8
> +#define EVENT_COUNTER_GROUP_SELECT	GENMASK(27, 24)
> +#define EVENT_COUNTER_EVENT_SELECT	GENMASK(23, 16)
> +#define EVENT_COUNTER_LANE_SELECT	GENMASK(11, 8)
> +#define EVENT_COUNTER_STATUS		BIT(7)
> +#define EVENT_COUNTER_ENABLE		GENMASK(4, 2)
> +#define PER_EVENT_ON			0x3
> +#define PER_EVENT_OFF			0x1
> +
>  #define DWC_DEBUGFS_BUF_MAX		128
>  
>  /**
> @@ -113,6 +124,61 @@ static const u32 err_inj_type_mask[] = {
>  	EINJ5_TYPE,
>  };
>  
> +/**
> + * struct dwc_pcie_event_counter - Store details about each event counter supported in DWC RASDES
> + * @name: Name of the error counter
> + * @group_no: Group number that the event belongs to. Value ranges from 0 - 4
> + * @event_no: Event number of the particular event. Value ranges from -
> + *		Group 0: 0 - 10
> + *		Group 1: 5 - 13
> + *		Group 2: 0 - 7
> + *		Group 3: 0 - 5
> + *		Group 4: 0 - 1
> + */
> +struct dwc_pcie_event_counter {
> +	const char *name;
> +	u32 group_no;
> +	u32 event_no;
> +};
> +
> +static const struct dwc_pcie_event_counter event_list[] = {
> +	{"ebuf_overflow", 0x0, 0x0},
> +	{"ebuf_underrun", 0x0, 0x1},
> +	{"decode_err", 0x0, 0x2},
> +	{"running_disparity_err", 0x0, 0x3},
> +	{"skp_os_parity_err", 0x0, 0x4},
> +	{"sync_header_err", 0x0, 0x5},
> +	{"rx_valid_deassertion", 0x0, 0x6},
> +	{"ctl_skp_os_parity_err", 0x0, 0x7},
> +	{"retimer_parity_err_1st", 0x0, 0x8},
> +	{"retimer_parity_err_2nd", 0x0, 0x9},
> +	{"margin_crc_parity_err", 0x0, 0xA},
> +	{"detect_ei_infer", 0x1, 0x5},
> +	{"receiver_err", 0x1, 0x6},
> +	{"rx_recovery_req", 0x1, 0x7},
> +	{"n_fts_timeout", 0x1, 0x8},
> +	{"framing_err", 0x1, 0x9},
> +	{"deskew_err", 0x1, 0xa},
> +	{"framing_err_in_l0", 0x1, 0xc},
> +	{"deskew_uncompleted_err", 0x1, 0xd},
> +	{"bad_tlp", 0x2, 0x0},
> +	{"lcrc_err", 0x2, 0x1},
> +	{"bad_dllp", 0x2, 0x2},
> +	{"replay_num_rollover", 0x2, 0x3},
> +	{"replay_timeout", 0x2, 0x4},
> +	{"rx_nak_dllp", 0x2, 0x5},
> +	{"tx_nak_dllp", 0x2, 0x6},
> +	{"retry_tlp", 0x2, 0x7},
> +	{"fc_timeout", 0x3, 0x0},
> +	{"poisoned_tlp", 0x3, 0x1},
> +	{"ecrc_error", 0x3, 0x2},
> +	{"unsupported_request", 0x3, 0x3},
> +	{"completer_abort", 0x3, 0x4},
> +	{"completion_timeout", 0x3, 0x5},
> +	{"ebuf_skp_add", 0x4, 0x0},
> +	{"ebuf_skp_del", 0x4, 0x1},
> +};
> +
>  static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
>  {
>  	struct dw_pcie *pci = file->private_data;
> @@ -230,6 +296,127 @@ static ssize_t err_inj_write(struct file *file, const char __user *buf, size_t c
>  	return count;
>  }
>  
> +static void set_event_number(struct dwc_pcie_rasdes_priv *pdata, struct dw_pcie *pci,
> +			     struct dwc_pcie_rasdes_info *rinfo)
> +{
> +	u32 val;
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> +	val &= ~EVENT_COUNTER_ENABLE;
> +	val &= ~(EVENT_COUNTER_GROUP_SELECT | EVENT_COUNTER_EVENT_SELECT);
> +	val |= FIELD_PREP(EVENT_COUNTER_GROUP_SELECT, event_list[pdata->idx].group_no);
> +	val |= FIELD_PREP(EVENT_COUNTER_EVENT_SELECT, event_list[pdata->idx].event_no);
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> +}
> +
> +static ssize_t counter_enable_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +	val = FIELD_GET(EVENT_COUNTER_STATUS, val);
> +	if (val)
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter Enabled\n");
> +	else
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter Disabled\n");
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}
> +
> +static ssize_t counter_enable_write(struct file *file, const char __user *buf,
> +				    size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	u32 val, enable;
> +
> +	val = kstrtou32_from_user(buf, count, 0, &enable);
> +	if (val)
> +		return val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> +	if (enable)
> +		val |= FIELD_PREP(EVENT_COUNTER_ENABLE, PER_EVENT_ON);
> +	else
> +		val |= FIELD_PREP(EVENT_COUNTER_ENABLE, PER_EVENT_OFF);
> +
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +
> +	return count;
> +}
> +
> +static ssize_t counter_lane_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +	val = FIELD_GET(EVENT_COUNTER_LANE_SELECT, val);
> +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane: %d\n", val);
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}
> +
> +static ssize_t counter_lane_write(struct file *file, const char __user *buf,
> +				  size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	u32 val, lane;
> +
> +	val = kstrtou32_from_user(buf, count, 0, &lane);
> +	if (val)
> +		return val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> +	val &= ~(EVENT_COUNTER_LANE_SELECT);
> +	val |= FIELD_PREP(EVENT_COUNTER_LANE_SELECT, lane);
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +
> +	return count;
> +}
> +
> +static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	mutex_lock(&rinfo->reg_event_lock);
> +	set_event_number(pdata, pci, rinfo);
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> +	mutex_unlock(&rinfo->reg_event_lock);
> +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}
> +
>  #define dwc_debugfs_create(name)			\
>  debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
>  			&dbg_ ## name ## _fops)
> @@ -249,6 +436,23 @@ static const struct file_operations dwc_pcie_err_inj_ops = {
>  	.write = err_inj_write,
>  };
>  
> +static const struct file_operations dwc_pcie_counter_enable_ops = {
> +	.open = simple_open,
> +	.read = counter_enable_read,
> +	.write = counter_enable_write,
> +};
> +
> +static const struct file_operations dwc_pcie_counter_lane_ops = {
> +	.open = simple_open,
> +	.read = counter_lane_read,
> +	.write = counter_lane_write,
> +};
> +
> +static const struct file_operations dwc_pcie_counter_value_ops = {
> +	.open = simple_open,
> +	.read = counter_value_read,
> +};
> +
>  static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  {
>  	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> @@ -258,7 +462,7 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  
>  static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  {
> -	struct dentry *rasdes_debug, *rasdes_err_inj;
> +	struct dentry *rasdes_debug, *rasdes_err_inj, *rasdes_event_counter, *rasdes_events;
>  	struct dwc_pcie_rasdes_info *rasdes_info;
>  	struct dwc_pcie_rasdes_priv *priv_tmp;
>  	struct device *dev = pci->dev;
> @@ -277,6 +481,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  	/* Create subdirectories for Debug, Error injection, Statistics */
>  	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
>  	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
> +	rasdes_event_counter = debugfs_create_dir("rasdes_event_counter", dir);
>  
>  	mutex_init(&rasdes_info->reg_event_lock);
>  	rasdes_info->ras_cap_offset = ras_cap;
> @@ -299,6 +504,28 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
>  				    &dwc_pcie_err_inj_ops);
>  	}
> +
> +	/* Create debugfs files for Statistical counter subdirectory */
> +	for (i = 0; i < ARRAY_SIZE(event_list); i++) {
> +		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
> +		if (!priv_tmp) {
> +			ret = -ENOMEM;
> +			goto err_deinit;
> +		}
> +
> +		priv_tmp->idx = i;
> +		priv_tmp->pci = pci;
> +		rasdes_events = debugfs_create_dir(event_list[i].name, rasdes_event_counter);
> +		if (event_list[i].group_no == 0 || event_list[i].group_no == 4) {
> +			debugfs_create_file("lane_select", 0644, rasdes_events,
> +					    priv_tmp, &dwc_pcie_counter_lane_ops);
> +		}
> +		debugfs_create_file("counter_value", 0444, rasdes_events, priv_tmp,
> +				    &dwc_pcie_counter_value_ops);
> +		debugfs_create_file("counter_enable", 0644, rasdes_events, priv_tmp,
> +				    &dwc_pcie_counter_enable_ops);
> +	}
> +
>  	return 0;
>  
>  err_deinit:
> -- 
> 2.17.1
> 

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f182.google.com (mail-pl1-f182.google.com [209.85.214.182])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 35DE21FCFEE
	for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 08:53:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.182
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740300825; cv=none; b=B26x5zzktwkXNZTJl7oYCnelqlKEz2AmIiComiZsGtMP8G1gQ/Rny4TVIGyiXXOorxmoQs1HvgmYmZAEruA+TFfKB4b5PbR9wCGXNMGgBxgqklRfZwCMckdClOQsxUSwiERoOMDWIqk7ug6+IqrWpu8QVtuXox0dEkHxILR+DEw=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740300825; c=relaxed/simple;
	bh=kaO4m8IWQkKU3HGciEEc1UMPAVK0wdyopUtB7E2ue1Y=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=c8NSs5i61cAHgdnqSzA4KJuEMJj7mJPJWLLD7REsR2TWZPFwSIFbAMSm0IxvqeL5lopj655zZoyeC73g67TcRqezPg5D9u4HuIdfbphLuv9Zd8t/eNG/l/iyB5Uxa9vhmHQoqP7Ds67aF7PF/EPxrwzpPEuAY3+OwJgsZKNetzI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=FX7D8WK3; arc=none smtp.client-ip=209.85.214.182
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="FX7D8WK3"
Received: by mail-pl1-f182.google.com with SMTP id d9443c01a7336-2211acda7f6so75252335ad.3
        for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 00:53:42 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1740300822; x=1740905622; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=Ad9dzdTy8RTwSvQ6ETQBmoHLcKIOzrrIpSyMRpInjto=;
        b=FX7D8WK3+Spw6+AXJ4oo6omu94tdyuxbwaQ2+LaEI/4bYTDuU93rUvBiUw6VPDSdLK
         9v2ZwWUsU9iqLumBz3JjGVssd1vH0vpYWAskbNsVdnAiEHwJ7OULfdBRot2AIgILaiuv
         ha5W5X28tNERA6xYwHMwtXAc3ceBY5ZQ/xLG2zHmJF8Q50ZTLMB+DVyGrE10B2bhfw1u
         Iu66TKGQ1DoAdF8CaqGFw14txXecaDRe2pkNUVuefIgfnue9oGNRoHlggtIrzTKNE5qh
         D4GNvA+i2M+O4gh1KMpaWCFZEqxW8Zu3Z7gO38nLE+HjfgLaBlJUZinN71gi5K0BY0ta
         J7SA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740300822; x=1740905622;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=Ad9dzdTy8RTwSvQ6ETQBmoHLcKIOzrrIpSyMRpInjto=;
        b=brBAUM5dVhqknXLOfoPizSoFV3sQqQfYOMyvd+uzg43H/K9JyDF1hcN8Oe/o0h4DiE
         OLfpy7lx0TASjAlsLtzWUGpUI6fwqAmR2yl03DeGZuPs7CozgyLFqsq6uunz5a2vjiF5
         oVasMi3Pyn0tDzOFixhjY5uGQYbfuQQcphCN9JbOQixvOTM7J2c1y+XFl//aBe1REiNW
         oQnhcRbVD9pXRQQ7//ooEbcrtLhILQZYEd0JiOJ4/ci+D+YztMtLlETyxnhWiKli8L3y
         KlXPco8v6Y56LRl0rAp/eNLbJXLNnJ86FNs4SwHVJY6QFOt3H4/y/pApeBf/P457Mcv/
         G0EQ==
X-Forwarded-Encrypted: i=1; AJvYcCV4W7DoxA8q4EYi429TG0PupTfvMo56+ya5+uH6IBLJS/toaWfQr+0RtTnpLG2a6B9Hw0mL4nTUn2eQMMlMaiGC@vger.kernel.org
X-Gm-Message-State: AOJu0Yw++ZSabmRWlxtiJaA+hvv+2e6HC/kOAA4taPdfZpuWefY2tlNU
	8fYirBuCkCMb8j4zT1v7s5op/xSZ/gOYSlzfqo0KicYBa/D6M+h1HQRFxAgVlg==
X-Gm-Gg: ASbGncufrPAjqK1dQvafiexVvkMdwqeMnbTUcrNPFUditOyhd7lIeyO9AOkneQZut2e
	PRRe6Tm3xHW0uuQQlXUE4ue6Ys0qjE4Pw4U1Hs0nu3xLm3qBB60BCYu1IXDWvvMTR59VKgVG6/U
	0useA0R8geQEvqYrXG+IsCo3d9/Ek3uE4pXcQbh/s0NDS5OxMT1bgdK+CMRdVANQ+CfznQILLxS
	KurWJEPTsbeYK9WLcHD1vugzZBgeqSDgxUgjggo6ynl42a1Nc+1WyP1QhTi9j2TnZpqd2RTKBAv
	o1JUlNijJ/BQC05FQGu9quAqKv6A1UyFLIKYpj0=
X-Google-Smtp-Source: AGHT+IEz7p5KlVP+Ilo+be7FWF08jgj28/sTosNcYmT3M/2Xud7EjsRe7o7bLRLnPa/TUc1mn9/r5g==
X-Received: by 2002:a17:902:da8c:b0:220:c813:dfcb with SMTP id d9443c01a7336-2219ffa7c51mr132859635ad.39.1740300822494;
        Sun, 23 Feb 2025 00:53:42 -0800 (PST)
Received: from thinkpad ([220.158.156.216])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-220d5364351sm161848705ad.76.2025.02.23.00.53.36
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 23 Feb 2025 00:53:41 -0800 (PST)
Date: Sun, 23 Feb 2025 14:23:34 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@Huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250223085334.l22epoycjhwqbtkd@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250221131548.59616-5-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:47PM +0530, Shradha Todi wrote:
> Add support to provide error injection interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>

- Mani

> ---
>  Documentation/ABI/testing/debugfs-dwc-pcie    |  70 ++++++++
>  .../controller/dwc/pcie-designware-debugfs.c  | 165 +++++++++++++++++-
>  2 files changed, 233 insertions(+), 2 deletions(-)
> 
> diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
> index e8ed34e988ef..6ee0897fe753 100644
> --- a/Documentation/ABI/testing/debugfs-dwc-pcie
> +++ b/Documentation/ABI/testing/debugfs-dwc-pcie
> @@ -11,3 +11,73 @@ Contact:	Shradha Todi <shradha.t@samsung.com>
>  Description:	(RW) Write the lane number to be checked as valid or invalid. Read
>  		will return the status of PIPE RXVALID signal of the selected lane.
>  		The default selected lane is Lane0.
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	rasdes_err_inj is the directory which can be used to inject errors in the
> +		system. The possible errors that can be injected are:
> +
> +		1) TLP LCRC error injection TX Path - tx_lcrc
> +		2) 16b CRC error injection of ACK/NAK DLLP - b16_crc_dllp
> +		3) 16b CRC error injection of Update-FC DLLP - b16_crc_upd_fc
> +		4) TLP ECRC error injection TX Path - tx_ecrc
> +		5) TLP's FCRC error injection TX Path - fcrc_tlp
> +		6) Parity error of TSOS - parity_tsos
> +		7) Parity error on SKPOS - parity_skpos
> +		8) LCRC error injection RX Path - rx_lcrc
> +		9) ECRC error injection RX Path - rx_ecrc
> +		10) TLPs SEQ# error - tlp_err_seq
> +		11) DLLPS ACK/NAK SEQ# error - ack_nak_dllp_seq
> +		12) ACK/NAK DLLPs transmission block - ack_nak_dllp
> +		13) UpdateFC DLLPs transmission block - upd_fc_dllp
> +		14) Always transmission for NAK DLLP - nak_dllp
> +		15) Invert SYNC header - inv_sync_hdr_sym
> +		16) COM/PAD TS1 order set - com_pad_ts1
> +		17) COM/PAD TS2 order set - com_pad_ts2
> +		18) COM/FTS FTS order set - com_fts
> +		19) COM/IDL E-idle order set - com_idl
> +		20) END/EDB symbol - end_edb
> +		21) STP/SDP symbol - stp_sdp
> +		22) COM/SKP SKP order set - com_skp
> +		23) Posted TLP Header credit value control - posted_tlp_hdr
> +		24) Non-Posted TLP Header credit value control - non_post_tlp_hdr
> +		25) Completion TLP Header credit value control - cmpl_tlp_hdr
> +		26) Posted TLP Data credit value control - posted_tlp_data
> +		27) Non-Posted TLP Data credit value control - non_post_tlp_data
> +		28) Completion TLP Data credit value control - cmpl_tlp_data
> +		29) Generates duplicate TLPs - duplicate_dllp
> +		30) Generates Nullified TLPs - nullified_tlp
> +
> +		(WO) Write to the attribute will prepare controller to inject the respective
> +		error in the next transmission of data. Parameter required to write will
> +		change in the following ways:
> +
> +		i) Errors 9) - 10) are sequence errors. The write command for these will be
> +
> +			echo <count> <diff> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> +			<diff>
> +				The difference to add or subtract from natural sequence number to
> +				generate sequence error. Range (-4095 : 4095)
> +
> +		ii) Errors 23) - 28) are credit value error insertions. Write command:
> +
> +			echo <count> <diff> <vc> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> +			<diff>
> +				The difference to add or subtract from UpdateFC credit value.
> +				Range (-4095 : 4095)
> +			<vc>
> +				Target VC number
> +
> +		iii) All other errors. Write command:
> +
> +			echo <count> > /sys/kernel/debug/dwc_pcie_<dev>/rasdes_err_inj/<error>
> +
> +			<count>
> +				Number of errors to be injected
> diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> index 3887a6996706..b7260edd2336 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -17,6 +17,20 @@
>  #define PIPE_DETECT_LANE		BIT(17)
>  #define LANE_SELECT			GENMASK(3, 0)
>  
> +#define ERR_INJ0_OFF			0x34
> +#define EINJ_VAL_DIFF			GENMASK(28, 16)
> +#define EINJ_VC_NUM			GENMASK(14, 12)
> +#define EINJ_TYPE_SHIFT			8
> +#define EINJ0_TYPE			GENMASK(11, 8)
> +#define EINJ1_TYPE			BIT(8)
> +#define EINJ2_TYPE			GENMASK(9, 8)
> +#define EINJ3_TYPE			GENMASK(10, 8)
> +#define EINJ4_TYPE			GENMASK(10, 8)
> +#define EINJ5_TYPE			BIT(8)
> +#define EINJ_COUNT			GENMASK(7, 0)
> +
> +#define ERR_INJ_ENABLE_REG		0x30
> +
>  #define DWC_DEBUGFS_BUF_MAX		128
>  
>  /**
> @@ -33,6 +47,72 @@ struct dwc_pcie_rasdes_info {
>  	struct mutex reg_event_lock;
>  };
>  
> +/**
> + * struct dwc_pcie_rasdes_priv - Stores file specific private data information
> + * @pci: Reference to the dw_pcie structure
> + * @idx: Index to point to specific file related information in array of structs
> + *
> + * All debugfs files will have this struct as its private data.
> + */
> +struct dwc_pcie_rasdes_priv {
> +	struct dw_pcie *pci;
> +	int idx;
> +};
> +
> +/**
> + * struct dwc_pcie_err_inj - Store details about each error injection supported by DWC RASDES
> + * @name: Name of the error that can be injected
> + * @err_inj_group: Group number to which the error belongs to. Value can range from 0 - 5
> + * @err_inj_type: Each group can have multiple types of error
> + */
> +struct dwc_pcie_err_inj {
> +	const char *name;
> +	u32 err_inj_group;
> +	u32 err_inj_type;
> +};
> +
> +static const struct dwc_pcie_err_inj err_inj_list[] = {
> +	{"tx_lcrc", 0x0, 0x0},
> +	{"b16_crc_dllp", 0x0, 0x1},
> +	{"b16_crc_upd_fc", 0x0, 0x2},
> +	{"tx_ecrc", 0x0, 0x3},
> +	{"fcrc_tlp", 0x0, 0x4},
> +	{"parity_tsos", 0x0, 0x5},
> +	{"parity_skpos", 0x0, 0x6},
> +	{"rx_lcrc", 0x0, 0x8},
> +	{"rx_ecrc", 0x0, 0xb},
> +	{"tlp_err_seq", 0x1, 0x0},
> +	{"ack_nak_dllp_seq", 0x1, 0x1},
> +	{"ack_nak_dllp", 0x2, 0x0},
> +	{"upd_fc_dllp", 0x2, 0x1},
> +	{"nak_dllp", 0x2, 0x2},
> +	{"inv_sync_hdr_sym", 0x3, 0x0},
> +	{"com_pad_ts1", 0x3, 0x1},
> +	{"com_pad_ts2", 0x3, 0x2},
> +	{"com_fts", 0x3, 0x3},
> +	{"com_idl", 0x3, 0x4},
> +	{"end_edb", 0x3, 0x5},
> +	{"stp_sdp", 0x3, 0x6},
> +	{"com_skp", 0x3, 0x7},
> +	{"posted_tlp_hdr", 0x4, 0x0},
> +	{"non_post_tlp_hdr", 0x4, 0x1},
> +	{"cmpl_tlp_hdr", 0x4, 0x2},
> +	{"posted_tlp_data", 0x4, 0x4},
> +	{"non_post_tlp_data", 0x4, 0x5},
> +	{"cmpl_tlp_data", 0x4, 0x6},
> +	{"duplicate_dllp", 0x5, 0x0},
> +	{"nullified_tlp", 0x5, 0x1},
> +};
> +
> +static const u32 err_inj_type_mask[] = {
> +	EINJ0_TYPE,
> +	EINJ1_TYPE,
> +	EINJ2_TYPE,
> +	EINJ3_TYPE,
> +	EINJ4_TYPE,
> +	EINJ5_TYPE,
> +};
> +
>  static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
>  {
>  	struct dw_pcie *pci = file->private_data;
> @@ -93,6 +173,63 @@ static ssize_t rx_valid_write(struct file *file, const char __user *buf, size_t
>  	return lane_detect_write(file, buf, count, ppos);
>  }
>  
> +static ssize_t err_inj_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> +	struct dw_pcie *pci = pdata->pci;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	u32 val, counter, vc_num, err_group, type_mask;
> +	int val_diff = 0;
> +	char *kern_buf;
> +
> +	err_group = err_inj_list[pdata->idx].err_inj_group;
> +	type_mask = err_inj_type_mask[err_group];
> +
> +	kern_buf = memdup_user_nul(buf, count);
> +	if (IS_ERR(kern_buf))
> +		return PTR_ERR(kern_buf);
> +
> +	if (err_group == 4) {
> +		val = sscanf(kern_buf, "%u %d %u", &counter, &val_diff, &vc_num);
> +		if ((val != 3) || (val_diff < -4095 || val_diff > 4095)) {
> +			kfree(kern_buf);
> +			return -EINVAL;
> +		}
> +	} else if (err_group == 1) {
> +		val = sscanf(kern_buf, "%u %d", &counter, &val_diff);
> +		if ((val != 2) || (val_diff < -4095 || val_diff > 4095)) {
> +			kfree(kern_buf);
> +			return -EINVAL;
> +		}
> +	} else {
> +		val = kstrtou32(kern_buf, 0, &counter);
> +		if (val) {
> +			kfree(kern_buf);
> +			return val;
> +		}
> +	}
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group));
> +	val &= ~(type_mask | EINJ_COUNT);
> +	val |= ((err_inj_list[pdata->idx].err_inj_type << EINJ_TYPE_SHIFT) & type_mask);
> +	val |= FIELD_PREP(EINJ_COUNT, counter);
> +
> +	if (err_group == 1 || err_group == 4) {
> +		val &= ~(EINJ_VAL_DIFF);
> +		val |= FIELD_PREP(EINJ_VAL_DIFF, val_diff);
> +	}
> +	if (err_group == 4) {
> +		val &= ~(EINJ_VC_NUM);
> +		val |= FIELD_PREP(EINJ_VC_NUM, vc_num);
> +	}
> +
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ0_OFF + (0x4 * err_group), val);
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + ERR_INJ_ENABLE_REG, (0x1 << err_group));
> +
> +	kfree(kern_buf);
> +	return count;
> +}
> +
>  #define dwc_debugfs_create(name)			\
>  debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
>  			&dbg_ ## name ## _fops)
> @@ -107,6 +244,11 @@ static const struct file_operations dbg_ ## name ## _fops = {	\
>  DWC_DEBUGFS_FOPS(lane_detect);
>  DWC_DEBUGFS_FOPS(rx_valid);
>  
> +static const struct file_operations dwc_pcie_err_inj_ops = {
> +	.open = simple_open,
> +	.write = err_inj_write,
> +};
> +
>  static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  {
>  	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> @@ -116,10 +258,11 @@ static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
>  
>  static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  {
> -	struct dentry *rasdes_debug;
> +	struct dentry *rasdes_debug, *rasdes_err_inj;
>  	struct dwc_pcie_rasdes_info *rasdes_info;
> +	struct dwc_pcie_rasdes_priv *priv_tmp;
>  	struct device *dev = pci->dev;
> -	int ras_cap;
> +	int ras_cap, i, ret;
>  
>  	ras_cap = dw_pcie_find_rasdes_capability(pci);
>  	if (!ras_cap) {
> @@ -133,6 +276,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  
>  	/* Create subdirectories for Debug, Error injection, Statistics */
>  	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
> +	rasdes_err_inj = debugfs_create_dir("rasdes_err_inj", dir);
>  
>  	mutex_init(&rasdes_info->reg_event_lock);
>  	rasdes_info->ras_cap_offset = ras_cap;
> @@ -142,7 +286,24 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
>  	dwc_debugfs_create(lane_detect);
>  	dwc_debugfs_create(rx_valid);
>  
> +	/* Create debugfs files for Error injection subdirectory */
> +	for (i = 0; i < ARRAY_SIZE(err_inj_list); i++) {
> +		priv_tmp = devm_kzalloc(dev, sizeof(*priv_tmp), GFP_KERNEL);
> +		if (!priv_tmp) {
> +			ret = -ENOMEM;
> +			goto err_deinit;
> +		}
> +
> +		priv_tmp->idx = i;
> +		priv_tmp->pci = pci;
> +		debugfs_create_file(err_inj_list[i].name, 0200, rasdes_err_inj, priv_tmp,
> +				    &dwc_pcie_err_inj_ops);
> +	}
>  	return 0;
> +
> +err_deinit:
> +	dwc_pcie_rasdes_debugfs_deinit(pci);
> +	return ret;
>  }
>  
>  void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> -- 
> 2.17.1
> 

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f172.google.com (mail-pl1-f172.google.com [209.85.214.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id D7CC71FC7CE
	for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 08:51:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740300703; cv=none; b=nbcInk+PP758NDhOWQuXXTRFiWBtotkVnkqekQ/MdBImb9q7rAXZbu5yJ+WWyf7jWBCRJOudCxRjpjSI5f9FJo2UbaKzpIhHPwhOtINiZmir+UvtHtIWrAf5w2UYH2rKhOK0EIiSD2g22c/vxvJJDoL2rbWaYXaKLASk0HlhwnE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740300703; c=relaxed/simple;
	bh=umVkSvUGkkxTauK/pxEwPN78xMIveH6ByF2IWcrD6as=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=hrtlycgPHEz4lg8Mr91aZruFGszClRkksBT/o9cCmkRV4VuhMOCGTmJpRfMheCN6Zu9AWdpz5FeJgPyC0IadSAQ1Ea+5bYa2X9khygkUnP22bJCblrCSqdJl5TjYYhFRk+1KGVqQ6tqzkexcYm67uGW6oDN/iEGBT+rOSAvaMck=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=YH0bVki6; arc=none smtp.client-ip=209.85.214.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="YH0bVki6"
Received: by mail-pl1-f172.google.com with SMTP id d9443c01a7336-220c8f38febso72157615ad.2
        for <linux-perf-users@vger.kernel.org>; Sun, 23 Feb 2025 00:51:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1740300700; x=1740905500; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=XIm5BB1LEcTt9ZhK89dRkHFeWOjSTT1fKFwAkUk/sFk=;
        b=YH0bVki6sB3oXLTVnlvirAtTc2FaflK2q5vujrNrs3mgBElXdLzbjM7aG+H+2w8YPD
         1iaxphDkIe5oUyNoFmZiyNgCth4Wbef/wciDSsRIRu/vCMZLsKip0khCNl7ggDN1F0Sk
         C7GfKutjWzwbjE10MCjskl5JIVv2DuNdLpOXKIBWb2hUeWjrbFWNIbrzp1JwStRGFvv1
         bI7gvyPp5RosF+1co4yFaLPO9eREPiqw9sMWtU7Lz067zYy1biv4raKZINo7plbFhNRS
         Cnh54vSTkfjKuPCk+KXXFnVYyPxkZb1ok+JZ+SsvyJFnu86g2MGKVdaHcKgxPbgxHRUV
         K2VA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740300700; x=1740905500;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=XIm5BB1LEcTt9ZhK89dRkHFeWOjSTT1fKFwAkUk/sFk=;
        b=KEys2k5hg2LMXI2XwbOKsHeAATKLxtNyAfvFlIl/XfZ9Cu9T6HZ/zNkepPDIeG3Kiz
         8hkNroLJ52aY65iv4t7o8Y4E8Utbo6GlDPYe/LWRCk0NWZEZLMFuNKqju6nC69bxHVD8
         kUksrX2EbkoEDXq2cxAS50OL8ZT+7F41CkV1EzMurvjdn0OobTR78p+TcGsI1VuQNVTe
         DH+ua/ip+3TWdGHsOyjMORH7wjlV5AZGIgrS+KFE4heAzzI16kzRTlLHkdYuT5HzcxVi
         7wxe2DK0euxRedf7mc6QJ5BAjAo51Y3ikvaKCYF3MRIppBloIPgAUjgEnayCdpcf5H2m
         l5uw==
X-Forwarded-Encrypted: i=1; AJvYcCXgQsGAq0BA48qnZs9zzMnSXokL6GvGqqq0lYMw16d0gp4K7Al0+ZRlukf/XzfhYnkeYPX1J9pqLKwmWczTaCSV@vger.kernel.org
X-Gm-Message-State: AOJu0YyoVfFgc/w3WUIvpVyTaGPJCAxRWb66Kbb0MoG8uLodXx2aCL7N
	v2SREEKfeO78zoJSqrDOORb3tOKPcozFW5ZwOPJQDSAdKg1QpKgT4ZbWMVDw7w==
X-Gm-Gg: ASbGnctXmKjrolHN5Hm/gwDnHrG/4rH/6jQQFO86IWq7Hr3+lDYorhEgYBv2R/sfThS
	R9pRMwUC2amb1/oTwF/wE4Ch0nUHjgo/V0ldEPFhvhq94Rpt5bnBiHw+oBIcJhiRSAmteKr7WVl
	4igU9pzxuQaaF2m0/I9+7a8sYZslT3UENs8yIj5wfunk9/z9l6gfSQ3NgKl0+LBxOAaxHmRmO1M
	hkyL/oFbMN+Sk60+NM/Ofihz9K/ABNM7qL2zOrPeqHXLFZ59vR8RYmehbpGx6MSN3MSfVwOEnt2
	FZPszyA0P3qptrHdLxSIsHJ5HbfxNvJSKgefJZ8=
X-Google-Smtp-Source: AGHT+IHq0sGn3xeyBwz3ek21iZZA/kc/HnQSGVkeM0v6QVIzQYojTaCIpKnZZd6PCRI/Uu53/9SdKw==
X-Received: by 2002:a17:903:41c7:b0:220:f40c:71e9 with SMTP id d9443c01a7336-2219ff8288amr144157375ad.9.1740300700070;
        Sun, 23 Feb 2025 00:51:40 -0800 (PST)
Received: from thinkpad ([220.158.156.216])
        by smtp.gmail.com with ESMTPSA id d2e1a72fcca58-7325b03f169sm16417131b3a.63.2025.02.23.00.51.34
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 23 Feb 2025 00:51:39 -0800 (PST)
Date: Sun, 23 Feb 2025 14:21:33 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Shradha Todi <shradha.t@samsung.com>
Cc: linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@Huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250223085133.kjjx3ee4qe7m6z43@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250221131548.59616-4-shradha.t@samsung.com>

On Fri, Feb 21, 2025 at 06:45:46PM +0530, Shradha Todi wrote:
> Add support to provide silicon debug interface to userspace. This set
> of debug registers are part of the RASDES feature present in DesignWare
> PCIe controllers.
> 
> Signed-off-by: Shradha Todi <shradha.t@samsung.com>

Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>

- Mani

> ---
>  Documentation/ABI/testing/debugfs-dwc-pcie    |  13 ++
>  drivers/pci/controller/dwc/Kconfig            |  10 +
>  drivers/pci/controller/dwc/Makefile           |   1 +
>  .../controller/dwc/pcie-designware-debugfs.c  | 176 ++++++++++++++++++
>  .../pci/controller/dwc/pcie-designware-ep.c   |   5 +
>  .../pci/controller/dwc/pcie-designware-host.c |   6 +
>  drivers/pci/controller/dwc/pcie-designware.c  |   6 +
>  drivers/pci/controller/dwc/pcie-designware.h  |  21 +++
>  include/linux/pcie-dwc.h                      |   2 +
>  9 files changed, 240 insertions(+)
>  create mode 100644 Documentation/ABI/testing/debugfs-dwc-pcie
>  create mode 100644 drivers/pci/controller/dwc/pcie-designware-debugfs.c
> 
> diff --git a/Documentation/ABI/testing/debugfs-dwc-pcie b/Documentation/ABI/testing/debugfs-dwc-pcie
> new file mode 100644
> index 000000000000..e8ed34e988ef
> --- /dev/null
> +++ b/Documentation/ABI/testing/debugfs-dwc-pcie
> @@ -0,0 +1,13 @@
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_debug/lane_detect
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	(RW) Write the lane number to be checked for detection.	Read
> +		will return whether PHY indicates receiver detection on the
> +		selected lane. The default selected lane is Lane0.
> +
> +What:		/sys/kernel/debug/dwc_pcie_<dev>/rasdes_debug/rx_valid
> +Date:		Feburary 2025
> +Contact:	Shradha Todi <shradha.t@samsung.com>
> +Description:	(RW) Write the lane number to be checked as valid or invalid. Read
> +		will return the status of PIPE RXVALID signal of the selected lane.
> +		The default selected lane is Lane0.
> diff --git a/drivers/pci/controller/dwc/Kconfig b/drivers/pci/controller/dwc/Kconfig
> index b6d6778b0698..48a10428a492 100644
> --- a/drivers/pci/controller/dwc/Kconfig
> +++ b/drivers/pci/controller/dwc/Kconfig
> @@ -6,6 +6,16 @@ menu "DesignWare-based PCIe controllers"
>  config PCIE_DW
>  	bool
>  
> +config PCIE_DW_DEBUGFS
> +	default y
> +	depends on DEBUG_FS
> +	depends on PCIE_DW_HOST || PCIE_DW_EP
> +	bool "DWC PCIe debugfs entries"
> +	help
> +	  Enables debugfs entries for the DW PCIe Controller. These entries
> +	  provide all debug features related to DW controller including the RAS
> +	  DES features to help in debug, error injection and statistical counters.
> +
>  config PCIE_DW_HOST
>  	bool
>  	select PCIE_DW
> diff --git a/drivers/pci/controller/dwc/Makefile b/drivers/pci/controller/dwc/Makefile
> index a8308d9ea986..54565eedc52c 100644
> --- a/drivers/pci/controller/dwc/Makefile
> +++ b/drivers/pci/controller/dwc/Makefile
> @@ -1,5 +1,6 @@
>  # SPDX-License-Identifier: GPL-2.0
>  obj-$(CONFIG_PCIE_DW) += pcie-designware.o
> +obj-$(CONFIG_PCIE_DW_DEBUGFS) += pcie-designware-debugfs.o
>  obj-$(CONFIG_PCIE_DW_HOST) += pcie-designware-host.o
>  obj-$(CONFIG_PCIE_DW_EP) += pcie-designware-ep.o
>  obj-$(CONFIG_PCIE_DW_PLAT) += pcie-designware-plat.o
> diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> new file mode 100644
> index 000000000000..3887a6996706
> --- /dev/null
> +++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -0,0 +1,176 @@
> +// SPDX-License-Identifier: GPL-2.0
> +/*
> + * Synopsys DesignWare PCIe controller debugfs driver
> + *
> + * Copyright (C) 2025 Samsung Electronics Co., Ltd.
> + *		http://www.samsung.com
> + *
> + * Author: Shradha Todi <shradha.t@samsung.com>
> + */
> +
> +#include <linux/debugfs.h>
> +
> +#include "pcie-designware.h"
> +
> +#define SD_STATUS_L1LANE_REG		0xb0
> +#define PIPE_RXVALID			BIT(18)
> +#define PIPE_DETECT_LANE		BIT(17)
> +#define LANE_SELECT			GENMASK(3, 0)
> +
> +#define DWC_DEBUGFS_BUF_MAX		128
> +
> +/**
> + * struct dwc_pcie_rasdes_info - Stores controller common information
> + * @ras_cap_offset: RAS DES vendor specific extended capability offset
> + * @reg_event_lock: Mutex used for RASDES shadow event registers
> + *
> + * Any parameter constant to all files of the debugfs hierarchy for a single controller
> + * will be stored in this struct. It is allocated and assigned to controller specific
> + * struct dw_pcie during initialization.
> + */
> +struct dwc_pcie_rasdes_info {
> +	u32 ras_cap_offset;
> +	struct mutex reg_event_lock;
> +};
> +
> +static ssize_t lane_detect_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dw_pcie *pci = file->private_data;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
> +	val = FIELD_GET(PIPE_DETECT_LANE, val);
> +	if (val)
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane Detected\n");
> +	else
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Lane Undetected\n");
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}
> +
> +static ssize_t lane_detect_write(struct file *file, const char __user *buf,
> +				 size_t count, loff_t *ppos)
> +{
> +	struct dw_pcie *pci = file->private_data;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	u32 lane, val;
> +
> +	val = kstrtou32_from_user(buf, count, 0, &lane);
> +	if (val)
> +		return val;
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
> +	val &= ~(LANE_SELECT);
> +	val |= FIELD_PREP(LANE_SELECT, lane);
> +	dw_pcie_writel_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG, val);
> +
> +	return count;
> +}
> +
> +static ssize_t rx_valid_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> +{
> +	struct dw_pcie *pci = file->private_data;
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> +	ssize_t pos;
> +	u32 val;
> +
> +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + SD_STATUS_L1LANE_REG);
> +	val = FIELD_GET(PIPE_RXVALID, val);
> +	if (val)
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "RX Valid\n");
> +	else
> +		pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "RX Invalid\n");
> +
> +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> +}
> +
> +static ssize_t rx_valid_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
> +{
> +	return lane_detect_write(file, buf, count, ppos);
> +}
> +
> +#define dwc_debugfs_create(name)			\
> +debugfs_create_file(#name, 0644, rasdes_debug, pci,	\
> +			&dbg_ ## name ## _fops)
> +
> +#define DWC_DEBUGFS_FOPS(name)					\
> +static const struct file_operations dbg_ ## name ## _fops = {	\
> +	.open = simple_open,				\
> +	.read = name ## _read,				\
> +	.write = name ## _write				\
> +}
> +
> +DWC_DEBUGFS_FOPS(lane_detect);
> +DWC_DEBUGFS_FOPS(rx_valid);
> +
> +static void dwc_pcie_rasdes_debugfs_deinit(struct dw_pcie *pci)
> +{
> +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> +
> +	mutex_destroy(&rinfo->reg_event_lock);
> +}
> +
> +static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
> +{
> +	struct dentry *rasdes_debug;
> +	struct dwc_pcie_rasdes_info *rasdes_info;
> +	struct device *dev = pci->dev;
> +	int ras_cap;
> +
> +	ras_cap = dw_pcie_find_rasdes_capability(pci);
> +	if (!ras_cap) {
> +		dev_dbg(dev, "no RASDES capability available\n");
> +		return -ENODEV;
> +	}
> +
> +	rasdes_info = devm_kzalloc(dev, sizeof(*rasdes_info), GFP_KERNEL);
> +	if (!rasdes_info)
> +		return -ENOMEM;
> +
> +	/* Create subdirectories for Debug, Error injection, Statistics */
> +	rasdes_debug = debugfs_create_dir("rasdes_debug", dir);
> +
> +	mutex_init(&rasdes_info->reg_event_lock);
> +	rasdes_info->ras_cap_offset = ras_cap;
> +	pci->debugfs->rasdes_info = rasdes_info;
> +
> +	/* Create debugfs files for Debug subdirectory */
> +	dwc_debugfs_create(lane_detect);
> +	dwc_debugfs_create(rx_valid);
> +
> +	return 0;
> +}
> +
> +void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> +{
> +	dwc_pcie_rasdes_debugfs_deinit(pci);
> +	debugfs_remove_recursive(pci->debugfs->debug_dir);
> +}
> +
> +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +{
> +	char dirname[DWC_DEBUGFS_BUF_MAX];
> +	struct device *dev = pci->dev;
> +	struct debugfs_info *debugfs;
> +	struct dentry *dir;
> +	int ret;
> +
> +	/* Create main directory for each platform driver */
> +	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> +	dir = debugfs_create_dir(dirname, NULL);
> +	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> +	if (!debugfs)
> +		return -ENOMEM;
> +
> +	debugfs->debug_dir = dir;
> +	pci->debugfs = debugfs;
> +	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> +	if (ret)
> +		dev_dbg(dev, "RASDES debugfs init failed\n");
> +
> +	return 0;
> +}
> diff --git a/drivers/pci/controller/dwc/pcie-designware-ep.c b/drivers/pci/controller/dwc/pcie-designware-ep.c
> index 72418160e658..f9d7f3f989ad 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-ep.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-ep.c
> @@ -814,6 +814,7 @@ void dw_pcie_ep_cleanup(struct dw_pcie_ep *ep)
>  {
>  	struct dw_pcie *pci = to_dw_pcie_from_ep(ep);
>  
> +	dwc_pcie_debugfs_deinit(pci);
>  	dw_pcie_edma_remove(pci);
>  }
>  EXPORT_SYMBOL_GPL(dw_pcie_ep_cleanup);
> @@ -989,6 +990,10 @@ int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
>  
>  	dw_pcie_ep_init_non_sticky_registers(pci);
>  
> +	ret = dwc_pcie_debugfs_init(pci);
> +	if (ret)
> +		goto err_remove_edma;
> +
>  	return 0;
>  
>  err_remove_edma:
> diff --git a/drivers/pci/controller/dwc/pcie-designware-host.c b/drivers/pci/controller/dwc/pcie-designware-host.c
> index ffaded8f2df7..2081e8c72d12 100644
> --- a/drivers/pci/controller/dwc/pcie-designware-host.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-host.c
> @@ -548,6 +548,10 @@ int dw_pcie_host_init(struct dw_pcie_rp *pp)
>  	if (pp->ops->post_init)
>  		pp->ops->post_init(pp);
>  
> +	ret = dwc_pcie_debugfs_init(pci);
> +	if (ret)
> +		goto err_stop_link;
> +
>  	return 0;
>  
>  err_stop_link:
> @@ -572,6 +576,8 @@ void dw_pcie_host_deinit(struct dw_pcie_rp *pp)
>  {
>  	struct dw_pcie *pci = to_dw_pcie_from_pp(pp);
>  
> +	dwc_pcie_debugfs_deinit(pci);
> +
>  	pci_stop_root_bus(pp->bridge->bus);
>  	pci_remove_root_bus(pp->bridge->bus);
>  
> diff --git a/drivers/pci/controller/dwc/pcie-designware.c b/drivers/pci/controller/dwc/pcie-designware.c
> index a7c0671c6715..3d1d95d9e380 100644
> --- a/drivers/pci/controller/dwc/pcie-designware.c
> +++ b/drivers/pci/controller/dwc/pcie-designware.c
> @@ -323,6 +323,12 @@ static u16 dw_pcie_find_vsec_capability(struct dw_pcie *pci,
>  	return 0;
>  }
>  
> +u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci)
> +{
> +	return dw_pcie_find_vsec_capability(pci, dwc_pcie_rasdes_vsec_ids);
> +}
> +EXPORT_SYMBOL_GPL(dw_pcie_find_rasdes_capability);
> +
>  int dw_pcie_read(void __iomem *addr, int size, u32 *val)
>  {
>  	if (!IS_ALIGNED((uintptr_t)addr, size)) {
> diff --git a/drivers/pci/controller/dwc/pcie-designware.h b/drivers/pci/controller/dwc/pcie-designware.h
> index 501d9ddfea16..7f9807d4e5de 100644
> --- a/drivers/pci/controller/dwc/pcie-designware.h
> +++ b/drivers/pci/controller/dwc/pcie-designware.h
> @@ -437,6 +437,11 @@ struct dw_pcie_ops {
>  	void	(*stop_link)(struct dw_pcie *pcie);
>  };
>  
> +struct debugfs_info {
> +	struct dentry		*debug_dir;
> +	void			*rasdes_info;
> +};
> +
>  struct dw_pcie {
>  	struct device		*dev;
>  	void __iomem		*dbi_base;
> @@ -465,6 +470,7 @@ struct dw_pcie {
>  	struct reset_control_bulk_data	core_rsts[DW_PCIE_NUM_CORE_RSTS];
>  	struct gpio_desc		*pe_rst;
>  	bool			suspended;
> +	struct debugfs_info	*debugfs;
>  };
>  
>  #define to_dw_pcie_from_pp(port) container_of((port), struct dw_pcie, pp)
> @@ -478,6 +484,7 @@ void dw_pcie_version_detect(struct dw_pcie *pci);
>  
>  u8 dw_pcie_find_capability(struct dw_pcie *pci, u8 cap);
>  u16 dw_pcie_find_ext_capability(struct dw_pcie *pci, u8 cap);
> +u16 dw_pcie_find_rasdes_capability(struct dw_pcie *pci);
>  
>  int dw_pcie_read(void __iomem *addr, int size, u32 *val);
>  int dw_pcie_write(void __iomem *addr, int size, u32 val);
> @@ -806,4 +813,18 @@ dw_pcie_ep_get_func_from_ep(struct dw_pcie_ep *ep, u8 func_no)
>  	return NULL;
>  }
>  #endif
> +
> +#ifdef CONFIG_PCIE_DW_DEBUGFS
> +int dwc_pcie_debugfs_init(struct dw_pcie *pci);
> +void dwc_pcie_debugfs_deinit(struct dw_pcie *pci);
> +#else
> +static inline int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +{
> +	return 0;
> +}
> +static inline void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
> +{
> +}
> +#endif
> +
>  #endif /* _PCIE_DESIGNWARE_H */
> diff --git a/include/linux/pcie-dwc.h b/include/linux/pcie-dwc.h
> index 40f3545731c8..6436e7fadc75 100644
> --- a/include/linux/pcie-dwc.h
> +++ b/include/linux/pcie-dwc.h
> @@ -28,6 +28,8 @@ static const struct dwc_pcie_vsec_id dwc_pcie_rasdes_vsec_ids[] = {
>  	  .vsec_id = 0x02, .vsec_rev = 0x4 },
>  	{ .vendor_id = PCI_VENDOR_ID_QCOM,
>  	  .vsec_id = 0x02, .vsec_rev = 0x4 },
> +	{ .vendor_id = PCI_VENDOR_ID_SAMSUNG,
> +	  .vsec_id = 0x02, .vsec_rev = 0x4 },
>  	{} /* terminator */
>  };
>  
> -- 
> 2.17.1
> 

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout4.samsung.com (mailout4.samsung.com [203.254.224.34])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E0318132111
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:46 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.34
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741144608; cv=none; b=Wp7a8VqCTQWAlu36p9PYPuH1ofUk7JnbZ3fyrHLQ0+BcmpWl+JzvfKA7/M9hGLV7iH7qREhUQqBxJpRr+ccQu0FfkTUMycomvbi+iMgT19z2nOyqOTTgctjJ804iQsgHs0XiNOkD+VaTsIy9vWTZg/GWVHbFjLe4tjeehYzg/pI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741144608; c=relaxed/simple;
	bh=aQs0s0mc62itgISldMpMaFv5obruag2Z3oivBTsK8fc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=FXCMQv3r3N/s5OIRgBBlZykSRq61F0PmmaxIfOyMQh7HPQvpAiZ7EVTvEGY/MZ7MSz+QXDY1s765qOBnYEAYl9MEFamgzSpbPOGozhop0C86HAim1pmDZzjy4oX1aEpvIniNyzcUWrFdYzkVqvkrMuRuMeGsw+PIh1uD6tR3LZE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=LY+QI2iI; arc=none smtp.client-ip=203.254.224.34
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="LY+QI2iI"
Received: from epcas5p3.samsung.com (unknown [182.195.41.41])
	by mailout4.samsung.com (KnoxPortal) with ESMTP id 20250305031644epoutp04a31ed1533fd7ece08f2d846f22b45bc8~pycsQeRde0750407504epoutp04o
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:44 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout4.samsung.com 20250305031644epoutp04a31ed1533fd7ece08f2d846f22b45bc8~pycsQeRde0750407504epoutp04o
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741144604;
	bh=aQs0s0mc62itgISldMpMaFv5obruag2Z3oivBTsK8fc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=LY+QI2iIGFYA36txNAyDr3oY5ZUrkIousHs6MUlyQDk2wD1+GJzEBIrwtqEf5Lui5
	 /zy4YFZb+eaMst1WkLABxYBhEHxJ7REOke+vV8LYgXLMAHx6+0iU++6T3qM14L32pn
	 JF/ZgS0VHCE95MRDnmD0gFfMFrCoLoQZNkWoomRM=
Received: from epsnrtp1.localdomain (unknown [182.195.42.162]) by
	epcas5p2.samsung.com (KnoxPortal) with ESMTP id
	20250305031644epcas5p29a0d00ec7271f43e0cb448fbf3697345~pycr4YPYs1527015270epcas5p28;
	Wed,  5 Mar 2025 03:16:44 +0000 (GMT)
Received: from epsmges5p1new.samsung.com (unknown [182.195.38.181]) by
	epsnrtp1.localdomain (Postfix) with ESMTP id 4Z6yQ25whFz4x9Q2; Wed,  5 Mar
	2025 03:16:42 +0000 (GMT)
Received: from epcas5p3.samsung.com ( [182.195.41.41]) by
	epsmges5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	F2.02.20052.A12C7C76; Wed,  5 Mar 2025 12:16:42 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTPA id
	20250304171047epcas5p38c683bd8cbc6ea4fc82377aebc2428e0~pqLnopuGX2766727667epcas5p36;
	Tue,  4 Mar 2025 17:10:47 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250304171047epsmtrp21378ba7aca27944c3795cea39249de95~pqLnmmsVG2056620566epsmtrp2r;
	Tue,  4 Mar 2025 17:10:47 +0000 (GMT)
X-AuditID: b6c32a49-3fffd70000004e54-a0-67c7c21a2917
Received: from epsmtip1.samsung.com ( [182.195.34.30]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	24.D4.18729.71437C76; Wed,  5 Mar 2025 02:10:47 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip1.samsung.com
	(KnoxPortal) with ESMTPA id
	20250304171044epsmtip129b87446f6672498fe5275da77041a94~pqLk5ayRH0826908269epsmtip1n;
	Tue,  4 Mar 2025 17:10:44 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: "'Fan Ni'" <nifan.cxl@gmail.com>,
	=?UTF-8?Q?'Krzysztof_Wilczy=C5=84ski'?= <kw@linux.com>
Cc: <linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<linux-arm-kernel@lists.infradead.org>, <linux-perf-users@vger.kernel.org>,
	<manivannan.sadhasivam@linaro.org>, <lpieralisi@kernel.org>,
	<robh@kernel.org>, <bhelgaas@google.com>, <jingoohan1@gmail.com>,
	<Jonathan.Cameron@huawei.com>, <a.manzanares@samsung.com>,
	<pankaj.dubey@samsung.com>, <cassel@kernel.org>, <18255117159@163.com>,
	<xueshuai@linux.alibaba.com>, <renyu.zj@linux.alibaba.com>,
	<will@kernel.org>, <mark.rutland@arm.com>
In-Reply-To: <Z8YZEALV71PUkXpF@debian>
Subject: RE: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Date: Tue, 4 Mar 2025 22:40:43 +0530
Message-ID: <061401db8d28$5f0a4b40$1d1ee1c0$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQJfby7SiE0e/TbLvAHLJIl0P7SXpgHkH4XnAk8q5KUB3hA60AHBUHtxAYzlJhCyEHTswA==
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA02Te1BUVRzHPXt37y7qMldc47iCgxuWSMCuLsvZEGuU8hZOojTOZA50gzu7
	xLK7s48eTgMEmwWDiRP52ICFeMRuhMXDQMExHjKKobA7IAkliBZRsjwyeSy0y5Xiv8/5ne/v
	9/39zpkfD/N5jAt5yWoDrVNTKhG+mn2hNSgoRNjSoRCbfwhCjk/muOhM6xZUlqlEV/MqMVQ5
	fY6LbCW9OMrIneOgmnu9HGS/WICjn4o6cOSor2Yj07yJjQZN2RxU3tfNQq4LzQB9VT/NRSVZ
	owAtNjVwkWkgHI3P1OIvCsjSynwOWVVUBchG8yCXLK4xkqa2vzhkjS0bJwd6m3CycUhOjjjO
	sMjasnTyszobIKdqNseuPZKyS0lTSbQugFYnapKS1YooUUxcwt6EcJlYEiKRowhRgJpKpaNE
	0ftjQ15OVrmHFAW8S6mM7lAspdeLwnbv0mmMBjpAqdEbokS0NkmllWpD9VSq3qhWhKppw/MS
	sXhHuFv4VoqyLbcK13b6v28duItlgD6/HODFg4QU/nm/G/ewD3EJwPacZ3PAajdPAlhQYAbM
	4RGA9q5CsJzRdakLYy6aAcxabMOZw+8A5lofcj0qnHgOjjjmMQ8LiHg4Omlne0QYkcmG9Qs9
	HM+FF/EMfJx/0y3i8dYTh+CNia2eMJsIhAu3Tiy58Qk5vD0/ymF4Hbx2boTtYYwIhhUlYxjT
	UQCcuV/BYbwOw59P9XMZjS9sn8ld6hQSFi/Yc7OI6/GCRDR0WlRM7nr4R0cdl2EhnHrYjDOs
	gNbas0/qq+Cj2jIWwy/AK44CtqcMRgTB8xfDmLA//OJ6NYux9YYn5kaeyPmwoWiZn4bTriY2
	wxth0VU7Jw+IzCsmM6+YzLxiAvP/bsWAbQMbaa0+VUHrw7USNf3ef/+dqEmtAUsrsP2VBjB4
	1xnaAlg80AIgDxMJ+KU5HQoffhL1wTFap0nQGVW0vgWEu5/7FCbckKhx75DakCCRysVSmUwm
	le+USUS+/KxGk8KHUFAGOoWmtbRuOY/F8xJmsDbkfKk/6Yy5Pj80niPcWfGtvxjfJ4geSupt
	fSr2QG/wUdvBB5HiwHYrVxa3J+5jNGY5ev7G6Tf6eqzDMOZgIH+/77r+4mvmfd+VU5//9kvm
	rPz4a3aB0bVp8VD6sZNrbpVwfV9PKKzrj9xizb08aTKp9h7JPHBayUpLb5sxaCxrPh3v1vit
	9b7Ds219UznhHRGZfrbCHI+0t8tj2vykf8dHQGFP1KZt91y1r0ZeifT7MI3P8ldSzqnhMdVx
	rJjnXPX9mG5zocD1oHQ2qvrXyeCMl7rznWX2H1vivnb903nZyuesmliwdO7WpffvkKUdHsoe
	3vb2nY/ecYSZUyyzWcV5ld+I2HolJdmO6fTUv/FzBj2LBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrMIsWRmVeSWpSXmKPExsWy7bCSnK64yfF0g5l3uCyutP9mt5h+WNFi
	SVOGxbEJK5gtVnyZyW6xauE1NouGnt+sFpseX2O1uLxrDpvF2XnH2SyubF3HYtHyp4XF4m5L
	J6vF0usXmSz+btvLaLFo6xd2i4XNLxkt/u/ZwW7RcsfU4v3PzWwOIh6LV0xh9Vgzbw2jx85Z
	d9k9Fmwq9Wg58pbVY9OqTjaPO9f2sHnsfGjp8eTKdCaPzUvqPfq2rGL0+LxJLoAnissmJTUn
	syy1SN8ugSvj0aT7jAVrRStO/LrJ2sB4SLCLkZNDQsBE4tzuc8xdjFwcQgK7GSVOvL7HCpGQ
	lPh8cR0ThC0ssfLfc3aIomeMEv2fnrGAJNgEdCSeXPnDDGKLCMRJvPx0mQWkiFlgGovE/7Nn
	GCE6pjBJXL32CWwUp4CaxI8p58E6hAUCJH5u6gezWQRUJP5d6GUEsXkFLCVu/HnJCmELSpyc
	+QRsG7OAtkTvw1ZGGHvZwtfMEOcpSPx8uowV4oowiVsTb7JD1IhLHP3ZwzyBUXgWklGzkIya
	hWTULCQtCxhZVjFKphYU56bnFhsWGOallusVJ+YWl+al6yXn525iBKcDLc0djNtXfdA7xMjE
	wXiIUYKDWUmE1/TzsXQh3pTEyqrUovz4otKc1OJDjNIcLErivOIvelOEBNITS1KzU1MLUotg
	skwcnFINTKIPjrub7Oo/UecW0iAeHfB0e4X1n8+z+ZMXWqYJ8EmL8xzzLzWV2jnDW2zK5Yc/
	/iz7UKracb5h2rvPZmvipsr2X+J+3V5jNdUla+3kbfZ/q8S782K8f577tu0yW8G25yYHC99v
	KlbPTT79ZwfPh8u1mZVvZoVfNDvc9ihxaxvzZdel0sWLpWX3Jb3dcG+qT5nVfv+a7t33gtnW
	qaT3J1102sVzsXure/TeXws4XRbd8J97S1SXO1/cRIgl6s/siECZvvOvpDxYzU2y754Ja4wN
	3n7s6rsFk3/+97gXd8DOZfndRxYLdtrJ/ubblFP66m3Gj5ObFt8UkpjW6jLZSSn2QraW7smv
	WqIBN9OqrZRYijMSDbWYi4oTAfA3KJV2AwAA
X-CMS-MailID: 20250304171047epcas5p38c683bd8cbc6ea4fc82377aebc2428e0
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132043epcas5p27fde98558b13b3311cdc467e8f246380
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
	<20250221131548.59616-6-shradha.t@samsung.com> <Z8XuuNb6TRevUlHH@debian>
	<20250303194228.GB1552306@rocinante> <Z8YZEALV71PUkXpF@debian>



> -----Original Message-----
> From: Fan Ni <nifan.cxl=40gmail.com>
> Sent: 04 March 2025 02:33
> To: Krzysztof Wilczy=C5=84ski=20<kw=40linux.com>=0D=0A>=20Cc:=20Fan=20Ni=
=20<nifan.cxl=40gmail.com>;=20Shradha=20Todi=20<shradha.t=40samsung.com>;=
=20linux-kernel=40vger.kernel.org;=20linux-=0D=0A>=20pci=40vger.kernel.org;=
=20linux-arm-kernel=40lists.infradead.org;=20linux-perf-users=40vger.kernel=
.org;=20manivannan.sadhasivam=40linaro.org;=0D=0A>=20lpieralisi=40kernel.or=
g;=20robh=40kernel.org;=20bhelgaas=40google.com;=20jingoohan1=40gmail.com;=
=20Jonathan.Cameron=40huawei.com;=0D=0A>=20a.manzanares=40samsung.com;=20pa=
nkaj.dubey=40samsung.com;=20cassel=40kernel.org;=2018255117159=40163.com;=
=0D=0A>=20xueshuai=40linux.alibaba.com;=20renyu.zj=40linux.alibaba.com;=20w=
ill=40kernel.org;=20mark.rutland=40arm.com=0D=0A>=20Subject:=20Re:=20=5BPAT=
CH=20v7=205/5=5D=20Add=20debugfs=20based=20statistical=20counter=20support=
=20in=20DWC=0D=0A>=20=0D=0A>=20On=20Tue,=20Mar=2004,=202025=20at=2004:42:28=
AM=20+0900,=20Krzysztof=20Wilczy=C5=84ski=20wrote:=0D=0A>=20>=20Hello,=0D=
=0A>=20>=0D=0A>=20>=20=5B...=5D=0D=0A>=20>=20>=20>=20+static=20ssize_t=20co=
unter_value_read(struct=20file=20*file,=20char=20__user=0D=0A>=20>=20>=20>=
=20+*buf,=20size_t=20count,=20loff_t=20*ppos)=20=7B=0D=0A>=20>=20>=20>=20+=
=09struct=20dwc_pcie_rasdes_priv=20*pdata=20=3D=20file->private_data;=0D=0A=
>=20>=20>=20>=20+=09struct=20dw_pcie=20*pci=20=3D=20pdata->pci;=0D=0A>=20>=
=20>=20>=20+=09struct=20dwc_pcie_rasdes_info=20*rinfo=20=3D=20pci->debugfs-=
>rasdes_info;=0D=0A>=20>=20>=20>=20+=09char=20debugfs_buf=5BDWC_DEBUGFS_BUF=
_MAX=5D;=0D=0A>=20>=20>=20>=20+=09ssize_t=20pos;=0D=0A>=20>=20>=20>=20+=09u=
32=20val;=0D=0A>=20>=20>=20>=20+=0D=0A>=20>=20>=20>=20+=09mutex_lock(&rinfo=
->reg_event_lock);=0D=0A>=20>=20>=20>=20+=09set_event_number(pdata,=20pci,=
=20rinfo);=0D=0A>=20>=20>=20>=20+=09val=20=3D=20dw_pcie_readl_dbi(pci,=20ri=
nfo->ras_cap_offset=20+=20RAS_DES_EVENT_COUNTER_DATA_REG);=0D=0A>=20>=20>=
=20>=20+=09mutex_unlock(&rinfo->reg_event_lock);=0D=0A>=20>=20>=20>=20+=09p=
os=20=3D=20scnprintf(debugfs_buf,=20DWC_DEBUGFS_BUF_MAX,=20=22Counter=0D=0A=
>=20>=20>=20>=20+value:=20%d=5Cn=22,=20val);=0D=0A>=20>=20>=20>=20+=0D=0A>=
=20>=20>=20>=20+=09return=20simple_read_from_buffer(buf,=20count,=20ppos,=
=20debugfs_buf,=0D=0A>=20>=20>=20>=20+pos);=20=7D=0D=0A>=20>=20>=0D=0A>=20>=
=20>=20Do=20we=20need=20to=20check=20whether=20the=20counter=20is=20enabled=
=20or=20not=20for=20the=0D=0A>=20>=20>=20event=20before=20retrieving=20the=
=20counter=20value?=0D=0A>=20>=0D=0A>=20>=20I=20believe,=20we=20have=20a=20=
patch=20that=20aims=20to=20address,=20have=20a=20look=20at:=0D=0A>=20>=0D=
=0A>=20>=0D=0A>=20>=20https://lore.kernel.org/linux-pci/20250225171239.1957=
4-1-manivannan.sa=0D=0A>=20>=20dhasivam=40linaro.org=0D=0A>=20=0D=0A>=20May=
be=20I=20missed=20something,=20that=20seems=20to=20fix=20counter_enable_rea=
d(),=20but=20here=20is=20to=20retrieve=20counter=20value.=0D=0A>=20How=20dw=
_pcie_readl_dbi()=20can=20return=20something=20like=20=22Counter=20Disabled=
=22?=0D=0A>=20=0D=0A>=20Fan=0D=0A=0D=0AHey=20Fan,=0D=0ASo=20the=20counter=
=20value=20will=20show=200=20in=20case=20it=20is=20disabled=20so=20there=20=
will=20not=20be=20any=20issues=20as=20per=20say.=20We=20could=20add=20the=
=0D=0Acheck=20here=20but=20I=20feel=20I=20have=20already=20exposed=20the=20=
functionality=20to=20check=20if=20a=20counter=20is=20enabled=20or=20disable=
d,=20(by=20reading=20the=0D=0Acounter_enable=20debugfs=20entry)=20so=20this=
=20could=20be=20handled=20in=20user=20space=20to=20only=20read=20the=20coun=
ter=20if=20it's=20enabled.=0D=0A=0D=0A>=20>=0D=0A>=20>=20Thank=20you=21=0D=
=0A>=20>=0D=0A>=20>=20=09Krzysztof=0D=0A=0D=0A

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout4.samsung.com (mailout4.samsung.com [203.254.224.34])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 67B46170A13
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.34
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741144605; cv=none; b=sPMG5U33wRn1nvJHEUisTS0pk8wt7nMeZ3fWSTQtcnHx4WX0R8II4b1/72Gls/8EkbhKpqafmH1Q/FYutxkO4bIlZ4b2wkPq1PYUtSbDoM2uK38k+SEcgGmIid/AgbGsbE+NsXDSF3E6GBsoTjxpyJd0Cj4V12Sipww5QE1q8cY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741144605; c=relaxed/simple;
	bh=yUnqr75OoCvUiSRApxk6t53XmWVcdinIUHGuIV/vlgc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=a2lMRbYZn6jg/JpqJD1GpuJ002v+8gv8AWckFTdDVPzL7SgZtlEKJ7JD1l+N2qG0vNlNbcB5uGt7KQTQYx3wIXE84gIOvP0/dHM84XxpvzP6U1jWvZdyEVjNSbJM/I/zenG7DKgzAVQTGgHNx0cn+PYDS9rfkRDuxnGGw5SIbQg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=HNnxajzQ; arc=none smtp.client-ip=203.254.224.34
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="HNnxajzQ"
Received: from epcas5p1.samsung.com (unknown [182.195.41.39])
	by mailout4.samsung.com (KnoxPortal) with ESMTP id 20250305031641epoutp0491389e67f7c183a383e38041a216143b~pyco4OVMR0750407504epoutp04k
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:41 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout4.samsung.com 20250305031641epoutp0491389e67f7c183a383e38041a216143b~pyco4OVMR0750407504epoutp04k
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741144601;
	bh=yUnqr75OoCvUiSRApxk6t53XmWVcdinIUHGuIV/vlgc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=HNnxajzQW9ktUHZKaLgXr2GuMbqGysHb4ZcKmdsdw/rKaaX+9P2LbfWEDUYkkyxln
	 2EkFpFJAhj9rgaU2ssd2jmpUSXRV7292Bu5pRVMEhn32zUaBEBxEX5foLMRGfmej5l
	 eWz4S+gdXbxpbthBtuuX+/wzkeMQqEa/xtrfwRYM=
Received: from epsnrtp4.localdomain (unknown [182.195.42.165]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTP id
	20250305031640epcas5p17112cb670dbd138db618b188e4c14264~pycoJdGRR1492314923epcas5p1D;
	Wed,  5 Mar 2025 03:16:40 +0000 (GMT)
Received: from epsmges5p1new.samsung.com (unknown [182.195.38.179]) by
	epsnrtp4.localdomain (Postfix) with ESMTP id 4Z6yPy4SPRz4x9Px; Wed,  5 Mar
	2025 03:16:38 +0000 (GMT)
Received: from epcas5p3.samsung.com ( [182.195.41.41]) by
	epsmges5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	E0.02.20052.612C7C76; Wed,  5 Mar 2025 12:16:38 +0900 (KST)
Received: from epsmtrp1.samsung.com (unknown [182.195.40.13]) by
	epcas5p1.samsung.com (KnoxPortal) with ESMTPA id
	20250304170103epcas5p167ff23f37994f7465edfcf0c7228128b~pqDHjxXv62873728737epcas5p1a;
	Tue,  4 Mar 2025 17:01:03 +0000 (GMT)
Received: from epsmgms1p2new.samsung.com (unknown [182.195.42.42]) by
	epsmtrp1.samsung.com (KnoxPortal) with ESMTP id
	20250304170103epsmtrp1341325dae096ffea3adb264573f4dbea~pqDHij8aB2899628996epsmtrp1s;
	Tue,  4 Mar 2025 17:01:03 +0000 (GMT)
X-AuditID: b6c32a49-3d20270000004e54-99-67c7c216f562
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	54.69.18949.EC137C76; Wed,  5 Mar 2025 02:01:03 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip2.samsung.com
	(KnoxPortal) with ESMTPA id
	20250304170100epsmtip25c61f68cfcc753ee4402054c958c813f~pqDEvT7ue0734807348epsmtip2G;
	Tue,  4 Mar 2025 17:01:00 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: =?iso-8859-2?Q?'Krzysztof_Wilczy=F1ski'?= <kw@linux.com>, "'Manivannan
 Sadhasivam'" <manivannan.sadhasivam@linaro.org>
Cc: <linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<linux-arm-kernel@lists.infradead.org>, <linux-perf-users@vger.kernel.org>,
	<lpieralisi@kernel.org>, <robh@kernel.org>, <bhelgaas@google.com>,
	<jingoohan1@gmail.com>, <Jonathan.Cameron@huawei.com>, <fan.ni@samsung.com>,
	<nifan.cxl@gmail.com>, <a.manzanares@samsung.com>,
	<pankaj.dubey@samsung.com>, <cassel@kernel.org>, <18255117159@163.com>,
	<xueshuai@linux.alibaba.com>, <renyu.zj@linux.alibaba.com>,
	<will@kernel.org>, <mark.rutland@arm.com>
In-Reply-To: <20250304153509.GA2310180@rocinante>
Subject: RE: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Date: Tue, 4 Mar 2025 22:30:58 +0530
Message-ID: <061301db8d27$02e0ced0$08a26c70$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="iso-8859-2"
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQJfby7SiE0e/TbLvAHLJIl0P7SXpgJyxCsJAS8UdNQCRCuPiwHsN3CQAvWEj/yyBTAYoA==
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA02Te0xbVRzHPb19Mce8Fhhn6LTcoZFNunYUdljG3CLBa7Zl+FqY/gFXuGmR
	0tY+nOKCwKoIQy0DNmhGeXVYeWWjQEAeg4K8ZkkmDSN0qNvqwjAbOHkKiJQWw3+fc87nd87v
	e04OF+NlcAK4SXINrZJTMoK9jdncExwcstPaLxEuOl5E9qxlDrrcE4hMmVLUpzdjKLNmgoXM
	s8UcVF0+ykbpucss1HB/lIVGfrzCRjZjPxvZm+qZSLeiY6IJXTYLXb19i4FWmzsAqmia5aDy
	8w8BWmtv4SDdnTA0vWRhH/UjK80FLLLWWAvIVsMEhyxr0JK63kcssqE6m03eGW1nk613I0in
	/TKDtJi+IL9trAbk3w0vxGx/P/mwlKYSaRWflicoEpPkkkji+Dtxr8eFhQtFIaIIdJDgy6kU
	OpKIOhETEp0kW09K8D+hZNr1qRhKrSb2HzmsUmg1NF+qUGsiCVqZKFOKlQI1laLWyiUCOa05
	JBIKD4Sti/HJ0oymGqAc2PnpojULSwcLfjnAiwtxMRy6bWPlgG1cHt4GoLN70jN4AmB+6SWO
	y+Lh8wAWPw7YrCgxmD1SB4Bd+nrPYBLA1cxOlsti469Cp30Fc7Evfg7eL+xkuyQMv8CEjUOz
	wLXghYvgnKNlg33wE9D8r2ODmXgQXLtYtbGRNx4B8yqymG5+Fg4WOzcYwwXwwZDBw/tgVfmf
	mLs9Plz6w13ri5+GI+Y6ttvxhz8t5WKuJiBe6QWNv9k8BVFw4O48w80+cKq/kePmAPjwu688
	LIE/WIo8vgzOW0we/zXYZb/CdPNuWDhUz3AftgN+s+z0ON6wxbjJe+DsarvH3wWNfSMsPSAM
	W7IZtmQzbMlm2JKhDDCrwS5aqU6R0OowpUhOn/3/zRMUKQ1g4y/sfbMFTPw+I7ACBhdYAeRi
	hK93ZU6/hOedSH2WSqsUcSqtjFZbQdj6jedhAX4JivXPJNfEicQRQnF4eLg4IjRcRPh7n2/V
	SXi4hNLQyTStpFWbdQyuV0A6w38p7dCvu6281B33PhoZPzn38Zq4Y9+0iZaFSOsYDr2St9RR
	miY49njhWrR4LfTIK50Xu21nnwtcienNr3pQnXbdp3Pg0iBLH1n3XsxCdu3zx3tjB7VPmo+e
	ahtjTP2V8TURlZ0anfTuDbTn3unS66aXGgMT7LIKviW0bS3Q/2lTfLnt2C/6blNzfJww/2Vt
	ApU2Y1398ODb56aCHGccsfOfB493xY5PflAyPl1Uc+vnxfaxoilB6P632qZV1/C8m3VEifAN
	Rb7fcNnwU6ICbLzgS3pyYdTitJn/uaGoOZA7d6HnzNRMI3eobKxQn3O1c9BysyQ2T7J9OHqy
	8BH3++xngvoIplpKifZiKjX1H1EEwT+UBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA02Sa0hTYRzGfXcuO45Wpznz1VnmqCiteVZab1BRH8Jjdwr6ENQaeZia07GT
	3SOzVWpZpka4dDkzm1NHzjQtu2kpBSnlssv0g7TsKlpe8pbGXIHffvA8v4f/hz+FSb7gAVRs
	wgFOn6COl5MivLpBHrSkRdmkYa6fwpDj3KgQXW0IRkUpMagx04KhlNIOAln6c4XIam4jUfKF
	UQLZP7YRqPVeHolemppI5Kiy4cgwZsBRhyGNQDffvhKgP9UPACqs6hci8+mvAE3U1QiRoT0C
	9QxXkmt92RuWHIItM5UBttbYIWQL7Ems4Wk3wdqtaSTb3lZHsrWdK1mX46qArSw6yV68YwVs
	n33Otmm7RKuiufjYg5w+bM1eUcyLviGgG5pxuNlZDpKBSZwOvClIh8N8o4VIByJKQt8HMN+U
	J/AE/rDvle0f+8CS8c9CT6kLwNG2N8AdkPRi6HKMYW6W0sdhnnMEd5cw2ozDjsxK4DFuC+Cd
	lBahu+VNK+GAs2bS9qE3Qcu4c5Jxeh6cyCom3CymV8LLhedwD8+Ez3Ndk4zRDCwyjwg8HAqL
	zd8xz3lz4fAnjyuld8JWSznp6fjBZ8MXsEzgY5wyZZwyZZwyZZyiFADcCvw5Ha/VaHmlbmkC
	d0jBq7V8UoJGsS9RaweTzxASUgPqrL2KeiCgQD2AFCaXiiP6GjUScbT6yFFOn6jSJ8VzfD2Q
	UbjcTzz4PSNaQmvUB7j9HKfj9P9TAeUdkCy4u/YHsS+PezsRfOsBE5eq89MhSXlV9rve4/yx
	NcU9y+Wrz5SkK649CXtxS/4tWLpj4Vi1zMaP/3x5MzN/Vvcm46nNltDuVb2OnOuyx18i/SRx
	WZ3dM294yQLjfDOSmciNgQb/Ff0lrukcW1pQkqq6u310/8DFtFrteleDVRpVfz+l6P3R6dm0
	ThGkkexmTgye+aD6sCcnt3124ZKdofbzDN/cKR4x22zvozbOz/nlUj7qmm9QqgLC8R1bd2+W
	BcOHDOX8SW/Dlz3NWKpbz1xZVOH1bUMFqAt/12XaohKBsKbImtcVp9kF9y71j8RmGEKfn21N
	XOa9bp2WGaikfs+W43yMWhmC6Xn1X5Rmp217AwAA
X-CMS-MailID: 20250304170103epcas5p167ff23f37994f7465edfcf0c7228128b
X-Msg-Generator: CA
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132039epcas5p31913eab0acec1eb5e7874897a084c725
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
	<20250221131548.59616-5-shradha.t@samsung.com>
	<20250303095200.GB1065658@rocinante>
	<20250304152952.pal66goo2dwegevh@thinkpad>
	<20250304153509.GA2310180@rocinante>



> -----Original Message-----
> From: Krzysztof Wilczy=F1ski=20<kw=40linux.com>=0D=0A>=20Sent:=2004=20Mar=
ch=202025=2021:05=0D=0A>=20To:=20Manivannan=20Sadhasivam=20<manivannan.sadh=
asivam=40linaro.org>=0D=0A>=20Cc:=20Shradha=20Todi=20<shradha.t=40samsung.c=
om>;=20linux-kernel=40vger.kernel.org;=20linux-pci=40vger.kernel.org;=20lin=
ux-arm-=0D=0A>=20kernel=40lists.infradead.org;=20linux-perf-users=40vger.ke=
rnel.org;=20lpieralisi=40kernel.org;=20robh=40kernel.org;=20bhelgaas=40goog=
le.com;=0D=0A>=20jingoohan1=40gmail.com;=20Jonathan.Cameron=40huawei.com;=
=20fan.ni=40samsung.com;=20nifan.cxl=40gmail.com;=0D=0A>=20a.manzanares=40s=
amsung.com;=20pankaj.dubey=40samsung.com;=20cassel=40kernel.org;=2018255117=
159=40163.com;=0D=0A>=20xueshuai=40linux.alibaba.com;=20renyu.zj=40linux.al=
ibaba.com;=20will=40kernel.org;=20mark.rutland=40arm.com=0D=0A>=20Subject:=
=20Re:=20=5BPATCH=20v7=204/5=5D=20Add=20debugfs=20based=20error=20injection=
=20support=20in=20DWC=0D=0A>=20=0D=0A>=20Hello,=0D=0A>=20=0D=0A>=20=5B....=
=5D=0D=0A>=20>=20>=20>=20+=09=0929)=20Generates=20duplicate=20TLPs=20-=20du=
plicate_dllp=0D=0A>=20>=20>=20>=20+=09=0930)=20Generates=20Nullified=20TLPs=
=20-=20nullified_tlp=0D=0A>=20>=20>=0D=0A>=20>=20>=20Would=20the=20above=20=
field=20called=20=22duplicate_dllp=22=20for=20duplicate=20TLPs=20be=0D=0A>=
=20>=20>=20a=20potential=20typo?=20=20Perhaps=20this=20should=20be=20called=
=20=22duplicate_tlp=22?=0D=0A>=20>=20>=0D=0A>=20>=0D=0A>=20>=20Looks=20like=
=20a=20typo.=20As=20per=20Synopsys=20documentation,=20there=20is=20only=20'=
duplicate=20TLP'=0D=0A>=20>=20field.=0D=0A>=20>=0D=0A>=20>=20Good=20catch=
=21=0D=0A>=20=0D=0A>=20Updated.=20=20Thank=20you=21=0D=0A>=20=0D=0A=0D=0ASo=
rry,=20this=20was=20a=20typo.=20Krzysztof,=20we=20need=20another=20change=
=20for=20this=20typo.=0D=0A=0D=0Adiff=20--git=20a/drivers/pci/controller/dw=
c/pcie-designware-debugfs.c=20b/drivers/pci/controller/dwc/pcie-designware-=
debugfs.c=0D=0Aindex=20729ac14ff700..4d77db3ca6ae=20100644=0D=0A---=20a/dri=
vers/pci/controller/dwc/pcie-designware-debugfs.c=0D=0A+++=20b/drivers/pci/=
controller/dwc/pcie-designware-debugfs.c=0D=0A=40=40=20-113,7=20+113,7=20=
=40=40=20static=20const=20struct=20dwc_pcie_err_inj=20err_inj_list=5B=5D=20=
=3D=20=7B=0D=0A=20=20=20=20=20=20=20=20=7B=22posted_tlp_data=22,=200x4,=200=
x4=7D,=0D=0A=20=20=20=20=20=20=20=20=7B=22non_post_tlp_data=22,=200x4,=200x=
5=7D,=0D=0A=20=20=20=20=20=20=20=20=7B=22cmpl_tlp_data=22,=200x4,=200x6=7D,=
=0D=0A-=20=20=20=20=20=20=20=7B=22duplicate_dllp=22,=200x5,=200x0=7D,=0D=0A=
+=20=20=20=20=20=20=20=7B=22duplicate_tlp=22,=200x5,=200x0=7D,=0D=0A=20=20=
=20=20=20=20=20=20=7B=22nullified_tlp=22,=200x5,=200x1=7D,=0D=0A=20=7D;=0D=
=0A=0D=0ASo=20sorry=20for=20the=20inconvenience=21=20Should=20I=20post=20a=
=20patch=20for=20this?=0D=0A=0D=0A>=20=09Krzysztof=0D=0A=0D=0A

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f175.google.com (mail-pl1-f175.google.com [209.85.214.175])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 58BBE24C063;
	Tue,  4 Mar 2025 15:46:41 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.175
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741103202; cv=none; b=UQe7feSLN0iLxnuDC/YUqZBAO5peZXSPo42+xKeDfccHqAV5NpMHQ4GQFqcA7wy2GflF4o5ddqo7/9a6Khdh8+MwnnrtXArAg14G4qoZDwqN44/C7808X1pAyyQwq3qrUz2PNPXkUcz/VQmmbDQ5cyb9BRkEYG9hnHL16UX95BE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741103202; c=relaxed/simple;
	bh=msyzO0UYK4O7STic7nVv1CFyyWG3MIkiJBnBLQ9y/KQ=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=FORaG4S3hdK6BbyyCU1t/I1Z09JROBNH+k4myrCNkZKdopnUE3cLOuVkMUFdS6hyFNEaY2DorCjzkapJQK8sjDXtfzB7/n+Xqc8iTUaWISY7Hahk2ubEkkjso2F+vBC6zOBbW412MgNoX2cjt3MqPeqLLgARg16C8R5ISPBMiMM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.175
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f175.google.com with SMTP id d9443c01a7336-22382657540so63595355ad.2;
        Tue, 04 Mar 2025 07:46:41 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741103200; x=1741708000;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=rW1cKuRtFgc98VoZXyjtJAQFKd78PcnO2hM7lIoduzI=;
        b=ADv5vCOTXRfip53oPUwGGyUjgLOK7cllqlm1/AUgZZWQuS8FMvq0KPVyHRiyvpqpHN
         t3QStcx4Q1XyplFUXuHRjIxurQt3zNn0GUGQyK9lhBKold8Dud+9WUNRjXsVJYdpdRas
         ockWE8gnfyrqHaa+2zoV+v2Ojf45cftJHFt3wL2y7LJosZVqJcYSpEgz5WJw0CGkIhyG
         RTHoCwVIXzSF+AZ9jptH1f/9LgeWP0GNAvB4hqCpWJ+IHcNgudCgVRBTw46u4wWscFSi
         hyBqCX3APUuYgziBIfeqDfGmgD7WNoFm5q3eXyZlUfGcUUWO7NTBfUG6UEMroTiQqJXt
         DqIA==
X-Forwarded-Encrypted: i=1; AJvYcCV0FUZCcO20MpJx26F9d008rkDxiH0AAcmoeRB5T9EFDAEb3BwCPy6yDgKNhjSBBWCY38F+4ftTIUc7sE+JxgUbDw==@vger.kernel.org, AJvYcCVHagZ+J8gZFgFv8TChFx6t7UduwGj1BPbfi1PDBEdMpNcmQGlgHEgI56fCpRKK+teqRUO0bpHzANldp1n+fFmO0q8=@vger.kernel.org, AJvYcCVW2rbx6fTnbG6tu5UChAXuaqzmOAn6SLi2aI2LVXrixxAK/SfWPe109BWIeS/wLkerhyC36Onsgb8n65o=@vger.kernel.org, AJvYcCVpq3FHYEhkJYq0sTr7RNvxV7sgG4y9N7Sh/7XqpUO9twtUc8jhbqYnAd+r2/VZ6IdZcyrenGWs5Grz@vger.kernel.org
X-Gm-Message-State: AOJu0Yx5l7z0y+YSKdwVmngNob3XA3kPEKAgotuC/1434MelchFFzwjJ
	osKPWwruwfT8hwrmwPxUwmSX2uX3jzIYYI3MA3s2dIZ7O70Si+Kf
X-Gm-Gg: ASbGnctZGk+s1MVjO97dS6jaNw7ULvUk68CGGscs5BPi99c6ktwBSHsWo+x//qqc/7I
	Oh6BHeslbzLDE/zCWPj8CybshbtxAEiDqMwNB4Jp3SpYSxTp1zHGMx8wcmZUQFZhexS2k/AgmcA
	BZ5FfZX0nxBPxY71s7zdCwMyVUBmIs3Qri+rh+/y1Lcf46OyhXJp6Kv+2xAaJuLr2Ough/mMuOD
	VvvpY4zEYwXP9JlqgSwWKMvrRf1M5yYJYvSmSV1dlDn/8xmapxbudeRPU/CvQMF/IPlptOvhag1
	LvdNXrviXGh2O9PQ2Qaadw5gek16gRLifhQ29L3OjR6/ZHqXpHEMOMqApEu5Sgrcj4rXPEnTjRA
	Saaw=
X-Google-Smtp-Source: AGHT+IEzaN/r/FxaRDaAv2WPggcOLIm/6Vm7eMmJxC9+tfE4ygUZ5mXkWtuc2TbBMjwycyUGGLoq3Q==
X-Received: by 2002:a17:903:230c:b0:223:7006:4db2 with SMTP id d9443c01a7336-22370064ea3mr216436475ad.31.1741103200544;
        Tue, 04 Mar 2025 07:46:40 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-223504e18b3sm96918945ad.182.2025.03.04.07.46.39
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 07:46:40 -0800 (PST)
Date: Wed, 5 Mar 2025 00:46:38 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Geert Uytterhoeven <geert@linux-m68k.org>
Cc: Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250304154638.GB2310180@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
 <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>

Hello,

> This patch is now commit 1ff54f4cbaed9ec6 ("PCI: dwc: Add debugfs
> based Silicon Debug support for DWC") in pci/next (next-20250304).
> 
> On Mon, 3 Mar 2025 at 20:47, Krzysztof WilczyÅ„ski <kw@linux.com> wrote:
> > [...]
> > > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > > +{
> > > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > > +   struct device *dev = pci->dev;
> > > > +   struct debugfs_info *debugfs;
> > > > +   struct dentry *dir;
> > > > +   int ret;
> > > > +
> > > > +   /* Create main directory for each platform driver */
> > > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > > +   dir = debugfs_create_dir(dirname, NULL);
> > > > +   debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > > +   if (!debugfs)
> > > > +           return -ENOMEM;
> > > > +
> > > > +   debugfs->debug_dir = dir;
> > > > +   pci->debugfs = debugfs;
> > > > +   ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > > +   if (ret)
> > > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> > >
> > > What will happen if ret != 0? still return 0?
> 
> And that is exactly what happens on Gray Hawk Single with R-Car
> V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
> dwc_pcie_rasdes_debugfs_init() to return -ENODEV.

Thank you for testing and for catching this issue.  Much appreciated.

> > Given that callers of dwc_pcie_debugfs_init() check for errors,
> 
> Debugfs issues should never be propagated upstream!

Makes complete sense.  Sorry for breaking things here!

> > this probably should correctly bubble up any failure coming from
> > dwc_pcie_rasdes_debugfs_init().
> >
> > I made updates to the code directly on the current branch, have a look:
> 
> So while applying, you changed this like:
> 
>             ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
>     -       if (ret)
>     -               dev_dbg(dev, "RASDES debugfs init failed\n");
>     +       if (ret) {
>     +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
>     +               return ret;
>     +       }
> 
>             return 0;
> 
> Hence this is now a fatal error, causing the probe to fail.

I removed the changed, and also move the log level to be a warning, per:

  https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=c6759a967e69aba16aef0d92f43e527b112e98a5

Would this be acceptable here?

Mani, would this be acceptable to you, too?  Given that you posted the
following recently:

  https://lore.kernel.org/linux-pci/20250303200055.GA1881771@rocinante/T/#mab9cbd5834390d259afea056eee9a73d8c3b435f

That said, perhaps moving the log level to a debug would be better served here.

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f173.google.com (mail-pl1-f173.google.com [209.85.214.173])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 923A127E1C9;
	Tue,  4 Mar 2025 15:35:13 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.173
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741102515; cv=none; b=VdhF7VANgOcNm1IE09+GagKVLETM4V9Iiv/LLWd5OJXTl9Z0JLMhqPBa1U+NI2uKTaPU5+l2GPY5UedmC73MzPSqPOR/ZACpiJds/QzCdZGDS08VcMrraJKD8/TRTT6uOq29SrrcLDLY3+qVhu+qlUD1j124ppfi5dDuNU+tHkQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741102515; c=relaxed/simple;
	bh=25lxY0rRFzscOEISUUTmtF8cqJFNHESfhXic2drv9Xc=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=AEg+wG2W38UCTL+mu+fOEjaSGQ8ovUwyW5lgjwszS6qpAJGNwCKqnrbveKJiTT08KqBXtGJ0c1x9QGZTcz336Uojgu9IFjVQgeZsUXBLRMxM/eX6Ngsj9CL1KGfj3MVsPIQ7rdPGhZUi3wiYcoF2M88Je6AQP2DfrRsjuvDoPos=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.173
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f173.google.com with SMTP id d9443c01a7336-2239c066347so52775695ad.2;
        Tue, 04 Mar 2025 07:35:13 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741102513; x=1741707313;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=aPksOpIsWmD4LD84U/zyiEQF/6uAhUOVlj8rScJ6yGY=;
        b=MxGyosFLpa+q5WnPDwFlu4Mf6J9WfI7gwf3+SXdVXWTHgxhc0K/Aj3Mtk6MEYfmIEY
         NoYNeLTQRgWfoRwUft8/APav2coBkND7dVLVCW/rTUmMSkd+lKvOP5lRD0L8R/1/F9RG
         jB/pl3LdnjuC8cOfR9/TK7NWVZMRQ61axRPoCzTmyfqYaa7MzDcmVOI1mBCEndjy9nwu
         bOXmxpsIJhk8GMjxNHTK5WsOrp4RxKLeZZzpdRFXXyZjUNBpoKKJBljfRw43YamNcRR8
         Xp0lNSMZSoHN7EzP21yriMLbH5usK0moyF9Glh/TPlb+LXvYQD1AlCV2i338UJnNLFLc
         xFrg==
X-Forwarded-Encrypted: i=1; AJvYcCUvYJ3B8hNRltxWwsO3VsvSPaz52Ib4OD2yFL8jMtsZUkbaohq9OGvESHKuLC+rzDi3U9Ha3ZKdDcFX@vger.kernel.org, AJvYcCVrWbv9WA0VHbbPcMIETCv/j0lnlIKDTu2nMK9QXfjekRjmrE39mFqHQ7bakk0EQC+xdVNxRksKmCcurtZqGjpSZw==@vger.kernel.org, AJvYcCWGAHG0brgQy2RWjwyZKFM6jMz3S9WQiCFKPvwfXmoZsRhfc4DK4dX0+vYNYX4W66SGG9sHmH1c4f0UKYE=@vger.kernel.org
X-Gm-Message-State: AOJu0YxKpyGxowldE8IXSTmiMEI1hFT0hONAZOx814UZXJ9zE1EwMaxI
	RxhZtzx3izJ4GTLGWlJn7vp3KA/o/iMw+pvRUTsJTbt06ygWs0IM
X-Gm-Gg: ASbGncsaveqgrrwsTrqHStgY4xFjR/gYGlrHfL0VUoRZczjEU1791rPVQA5h0xVbnJp
	bv+qUcqfDfcbk8r9k2SskNRlWRXFVvAF74mz/SNEyGoo02DuDpIB6bi3p9PD6L/QBtVLrLrTfWW
	z/9+XlDRcD01Hzc2WUhPHDTXabKzOU5XHbFSIZfC6IHEL338+ofzPRtm28+5ohKJjkdoiJ+ckYi
	ZRkr5iBpbOkZE8iD37YrmxjMB/62j+T/WX+HwVur1WjEPubjl+w+kBIBPvbEwOdaK9R+IVup96A
	5p6NY9rIxZ0+NZeb62Qnyt/mTzaobuIq6V6zckGx/WFCYH0AWNmfbXyo8IiQsihw9sAE2T0mHYF
	9FuA=
X-Google-Smtp-Source: AGHT+IHqM19CmKxrc3+/5zghLWm7z3K7HlW9tJVgM1xGFI0z5/AxnNorz6ln5aNsioCk4N/uTqY9lA==
X-Received: by 2002:a17:902:eccc:b0:215:6489:cfb8 with SMTP id d9443c01a7336-22368f6365emr341829405ad.10.1741102512747;
        Tue, 04 Mar 2025 07:35:12 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-2235053e41asm96451805ad.255.2025.03.04.07.35.11
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 07:35:12 -0800 (PST)
Date: Wed, 5 Mar 2025 00:35:09 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, fan.ni@samsung.com,
	nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250304153509.GA2310180@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
 <20250303095200.GB1065658@rocinante>
 <20250304152952.pal66goo2dwegevh@thinkpad>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250304152952.pal66goo2dwegevh@thinkpad>

Hello,

[....]
> > > +		29) Generates duplicate TLPs - duplicate_dllp
> > > +		30) Generates Nullified TLPs - nullified_tlp
> > 
> > Would the above field called "duplicate_dllp" for duplicate TLPs be
> > a potential typo?  Perhaps this should be called "duplicate_tlp"?
> > 
> 
> Looks like a typo. As per Synopsys documentation, there is only 'duplicate TLP'
> field.
> 
> Good catch!

Updated.  Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f45.google.com (mail-pj1-f45.google.com [209.85.216.45])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 87F892780F4
	for <linux-perf-users@vger.kernel.org>; Tue,  4 Mar 2025 15:32:17 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.45
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741102339; cv=none; b=ZKs0T9Hh74sOwsfVpPfctK/luD2bRNmpWG2RkFYx0seeloyKnCQGzgWGZpVVxs5lQ11Iym5q6Z5ibIh+Q9u6H3OsRWhuM6fbzVCWRGfZIuxlFftQUh5JZzVOzMdo6UUOn8NPG60enacrmuyyVVkQ8QLmxVV8B2sLehewKjHL/w8=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741102339; c=relaxed/simple;
	bh=jHsoS/QfB3OLT+xMvFjIYwKmEM5bHtcU7LWt7y8mak8=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=ERKXbUH+eAO9/Ap88Ehe0nx7DLQWxe0cs+mUgyfiJTl8YEDy+ygOoMIgKIijREtk7tSoLZ8EpJmwC8/6PS1yZxQ8nM70fxy2TrFIHho+nVz8HgHLbIFD20v67wpAzOu5FVllFSbejNDy1ELGPuHDITHuJ8BWygqS7mv0f01QKXQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=PcHRxeoJ; arc=none smtp.client-ip=209.85.216.45
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="PcHRxeoJ"
Received: by mail-pj1-f45.google.com with SMTP id 98e67ed59e1d1-2feb9076cdcso9872432a91.0
        for <linux-perf-users@vger.kernel.org>; Tue, 04 Mar 2025 07:32:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1741102337; x=1741707137; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=9J55i6SaAxXDmk71XUiDvvdHDUMorv5pKHh75B2QGvY=;
        b=PcHRxeoJRnnQsqqnpmTbzdbJFuUoQ6wslJvBQ1oXtZ6vlbZ6aI4+N14wW2b8UzUPxD
         /4WdAv8otbQKOIfVurvDb67QKRHwWuADKVpEFmvbBEUzy09otdz6SB+Q1FmmKFWYnL0G
         +Wo4JsWoPhupopYXMMzgma901JP6G5E+WHm6rQSkBFtNlhdszAnhDHFC6wxrvzEhVZDQ
         he/qzQQIGyRHK7n+/AyUYR1/y5AZqocZfAkyin6P3kLx5K8EbTbcwJBstocmJR1tErbA
         VrEL+Y+s0hn++WB4IUEuYsutvL+TzXzLRd1AO/UwNM6YVPJ0+vBpn7cbl0eud2eIm3XS
         /elw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741102337; x=1741707137;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=9J55i6SaAxXDmk71XUiDvvdHDUMorv5pKHh75B2QGvY=;
        b=JM/0L6MQLJy+tlZXT6wxr2sZSdexigQ4lkjmGraCyqqDcoER1xpTT8Ee/vB6FCU7go
         s/GSwJbkpjVa2oJPC26m9IRd2QIHaSjW1b1EldJdwHbd9ZqqF3o42ocnBEzH4HUmDFLr
         lsu7fxDpEnWqtFgdr5Ljt2oqYLahUYexZvJwRRdX1Rud7uk4YWdubbHScDUehXLZDSyl
         h60kQP1brj/VwfZV0EDZxvOsuo3t9WKB02MtAz8KHA6Mkhsur3T8B3q22CLPa4PIz7tq
         BvoeMf9/0noP5hb+pSNaD/rAoWj0qfrcubFsY3grsN91hIzAeyEVYo7jKQcFnOiuHv4m
         uO0w==
X-Forwarded-Encrypted: i=1; AJvYcCXBXgUL1WjWHRnE3M4PxCB9BYhNq/Fe28TtZeEiYifmpXYjpRVzHoByeBFGCDbCvxCOyGlFFOX6W0V5gFKWKgQ+@vger.kernel.org
X-Gm-Message-State: AOJu0YyJFsWtWbiBB4tmmAGAn2YqF1AYbNpiCn/DaTXQTwoNzfiBB2lJ
	6lBDLJU9IjtTNty7t1VQk2it9weYFbsw0zxqajU0I0v5oGCnyVM6K2qxlHiBRw==
X-Gm-Gg: ASbGncsIpJDZDSKLPT84NWDs8zCPgai0Zpd0R2TgxivsB+v62HVHrP8zE6RbI3xOSTY
	1+i9YdloiTy+gvAsmqjuyTIncZhBZKt8gEETMsr7PVjMuN+hB5B6eh3+Nx9HH27b6G4FmhmA/1q
	D2q6edFOqStv2nr2iJ/TYl58GLf83F5TVU3C+T6GbvJICepIUq4kVJrAwYyo20FcpDEBNakV0CS
	AIrc45iNpdM1hYNJC/Zo/e+ig5BFPidD0F4t5fUooEwLDBrS0J3/k1uwTF4RBt3cXa64qXTeEsu
	0jp7FFq85/5YymUTlZg1qGjTC7NsPf/RSHzE0LvJsZNnK3yeGigvuw4=
X-Google-Smtp-Source: AGHT+IGGf95zBxRvPRSEYDsTC4/BBUP78sumCmzYhxc9letUVVeTQ59a5edLgdJXdoWT1eIqtoqw6w==
X-Received: by 2002:a17:90b:2888:b0:2fe:b907:562f with SMTP id 98e67ed59e1d1-2febab5e112mr30851643a91.14.1741102336858;
        Tue, 04 Mar 2025 07:32:16 -0800 (PST)
Received: from thinkpad ([120.60.51.199])
        by smtp.gmail.com with ESMTPSA id 98e67ed59e1d1-2fe8284f076sm13309640a91.42.2025.03.04.07.32.09
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 07:32:16 -0800 (PST)
Date: Tue, 4 Mar 2025 21:02:06 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Fan Ni <nifan.cxl@gmail.com>
Cc: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>,
	Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <20250304153206.gr7footrqrpc5uxf@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
 <Z8XuuNb6TRevUlHH@debian>
 <20250303194228.GB1552306@rocinante>
 <Z8YZEALV71PUkXpF@debian>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z8YZEALV71PUkXpF@debian>

On Mon, Mar 03, 2025 at 01:03:12PM -0800, Fan Ni wrote:
> On Tue, Mar 04, 2025 at 04:42:28AM +0900, Krzysztof WilczyÅ„ski wrote:
> > Hello,
> > 
> > [...]
> > > > +static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> > > > +{
> > > > +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> > > > +	struct dw_pcie *pci = pdata->pci;
> > > > +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> > > > +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> > > > +	ssize_t pos;
> > > > +	u32 val;
> > > > +
> > > > +	mutex_lock(&rinfo->reg_event_lock);
> > > > +	set_event_number(pdata, pci, rinfo);
> > > > +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> > > > +	mutex_unlock(&rinfo->reg_event_lock);
> > > > +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
> > > > +
> > > > +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> > > > +}
> > > 
> > > Do we need to check whether the counter is enabled or not for the event
> > > before retrieving the counter value?
> > 
> > I believe, we have a patch that aims to address, have a look at:
> > 
> >   https://lore.kernel.org/linux-pci/20250225171239.19574-1-manivannan.sadhasivam@linaro.org
> 
> Maybe I missed something, that seems to fix counter_enable_read(), but
> here is to retrieve counter value. 
> How dw_pcie_readl_dbi() can return something like "Counter Disabled"? 
> 

Only way to know if a counter is enabled by reading back the status. And that is
what the patch is doing.

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f176.google.com (mail-pl1-f176.google.com [209.85.214.176])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4F38024EA92
	for <linux-perf-users@vger.kernel.org>; Tue,  4 Mar 2025 15:18:25 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.176
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741101506; cv=none; b=CNu/G8Un/ftPF7zCEhV3H5d00RmIXmSDMuVEIRZejbVKo6MY9xeCuPITDBvkuKzuUjGINPCZn52vjsrYlG4Q95t/8XT+P1YR0pLVbUWNKPkPcbPDH8RQ7kx4XQWQtDV4wcaSecPsJrUt1sz6mBr710eGKBjhc54Fe+wgoGuTKxc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741101506; c=relaxed/simple;
	bh=Nfbb4Q2xiDkH6WLiFI7e76Q6PwRDTA9H9+XvuWdYO9M=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=iiBg8OJ5gYp1d+jg0GTAHW7uxMgkFUK79hdbZ9+fxsrqsPCoSQNq1P9HJjNqIv5ZLM7fo/jPobIjZK535A29ZYVbTXc94zkONwRF3rjll9dc+zYDSqns08k6s0XOcqFzNM7vHSskTTi1jX//Jjrfk0fKmXnnRs2f5wPHaHW5oj4=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=gBIbM/7U; arc=none smtp.client-ip=209.85.214.176
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="gBIbM/7U"
Received: by mail-pl1-f176.google.com with SMTP id d9443c01a7336-22328dca22fso86932755ad.1
        for <linux-perf-users@vger.kernel.org>; Tue, 04 Mar 2025 07:18:25 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1741101504; x=1741706304; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=KzhE+tdJAYWvPcPUwSdrS55NblQcSF6sK2zBz4cziEo=;
        b=gBIbM/7UCn3d+kG8XQQpXgjv6oo4359Az4NnhRvQG+OrZfNy37HWbUI6mXw5KqCHhH
         TN/VygfvNKNe497X57clJASH+VZQaIHPlbwaiW25ebDH9QtnXib+9HHy7Y7VFEiCJc+0
         U6ORj5nJcfQTJnuISlGSu2QKJys2DcjF9JWIjL2ZDYXn0GW5v+baNmvKmzUWgSviPKUa
         +pz2PZJPk1H6e0PFFtX+/9JS+ayLoZlPhgkvw7FqIaZ3vpHaioJX/BrbbMaNU3vxZUKi
         mA7vfCrejLi428a5pJ8iKs16cicAo9+tgbEkDiktMQHaJK8sJcird1xYiJfZFyBJh/HC
         0m9w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741101504; x=1741706304;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=KzhE+tdJAYWvPcPUwSdrS55NblQcSF6sK2zBz4cziEo=;
        b=f2B8sO7+kHv1w4xXxMA2Qn+JpRsva2N6tRgnYuD36hV3Sd2GQzn4IlnXgCS/0C+svI
         s7y+x132w+R60j8BxrckPP2MKO0CB4+0ZSCvlTe9TY6kRTGfVlXyPI/AIcTtIQxNB70/
         NnNPWn0EjC9N0ZNsiMJwrKREMtRZkt0LW2bxENmJh1DmE6RAU3QSyw0zSzwRsqKnM9/t
         id2Q1fwuRoLhGQrdfgyT639ABDWP00VF1O3ZjVHoBSyMnCH+R1N63la87DHecpUohX5a
         XU3PIMm5fbxvjeCVAY9/vxkjsS7qphn4hokDXyRrc44Jyz6m11CqV3Ib6gjHwwXFe8Fe
         e+mA==
X-Forwarded-Encrypted: i=1; AJvYcCWP0IRLhrTdcfBVwmK+HjIUX1S7w1LniK66++JCPp49e/WpyDKFhiMchnXiMa51mMJ/0WlcCaxjRN0fhYwqqlbV@vger.kernel.org
X-Gm-Message-State: AOJu0YxtElpu22oUsMtdwEbWLI3gphhrY9cQ2oFmsaLFW5AKZxLNcyq6
	zJjC7+BQYVqn6UK7a6JDjQHUNJaWGjZyo0ZIBbNnOI+BbR4q8AJoazt0Dhvxaw==
X-Gm-Gg: ASbGncvRrHBxiYl80Reo2J2Goq8GHdOGYuVv9RCHvRYlZSlUkFwWbQg9lbqGDE0fvg1
	Ptz1nOeHe45el/92R2SePJDDgzKzqowXHnwrAli9nzdTdy34iAkHsMtuDHlSWJ+MaW+tZ+Gk2mL
	4a0DTMX4wZDWBtpza/ZYjlBPvSgNXq6KfJhdZIIcl7RRRjLtkmW6h0aold6dVOEK55v9eBQM/gN
	k04EOAqzSLnw2M3zkQroaBk035489b6J9PT6dpWNZeDKRduRrRUWwreAgDMCRK5338t6f3se+yf
	mFx/CBLRqB2ogagm19rHhOujd08TyB3Y2pFR2Vyp2RT/8NsM0FcaQzs=
X-Google-Smtp-Source: AGHT+IE5m+vrO6nNhOZDvuax+Cu982tB5v2FtygKBkyOtqqZSXWNrXN1iB/dSPoQj7bI+IrEJ3ckng==
X-Received: by 2002:a17:902:e752:b0:21f:45d:21fb with SMTP id d9443c01a7336-22368f61965mr234071745ad.3.1741101503081;
        Tue, 04 Mar 2025 07:18:23 -0800 (PST)
Received: from thinkpad ([120.60.51.199])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-223504db7a6sm95889145ad.160.2025.03.04.07.18.16
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 07:18:22 -0800 (PST)
Date: Tue, 4 Mar 2025 20:48:14 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
Cc: Geert Uytterhoeven <geert@linux-m68k.org>, Fan Ni <nifan.cxl@gmail.com>,
	Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250304151814.6xu7cbpwpqrvcad5@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250303194647.GC1552306@rocinante>

+ Geert (who reported the regression in -next)

On Tue, Mar 04, 2025 at 04:46:47AM +0900, Krzysztof WilczyÅ„ski wrote:
> Hello,
> 
> [...]
> > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > +{
> > > +	char dirname[DWC_DEBUGFS_BUF_MAX];
> > > +	struct device *dev = pci->dev;
> > > +	struct debugfs_info *debugfs;
> > > +	struct dentry *dir;
> > > +	int ret;
> > > +
> > > +	/* Create main directory for each platform driver */
> > > +	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > +	dir = debugfs_create_dir(dirname, NULL);
> > > +	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > +	if (!debugfs)
> > > +		return -ENOMEM;
> > > +
> > > +	debugfs->debug_dir = dir;
> > > +	pci->debugfs = debugfs;
> > > +	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > +	if (ret)
> > > +		dev_dbg(dev, "RASDES debugfs init failed\n");
> > 
> > What will happen if ret != 0? still return 0? 
> 
> Given that callers of dwc_pcie_debugfs_init() check for errors,
> this probably should correctly bubble up any failure coming from
> dwc_pcie_rasdes_debugfs_init().
> 
> I made updates to the code directly on the current branch, have a look:
> 
>   https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=1ff54f4cbaed9ec6994844967c36cf7ada4cbe5e
> 
> Let me know if this is OK with you.
> 

If the SoC has no RASDES capability, then this call is bound to fail (which will
break existing platforms). I'd propose to return 0 if
dw_pcie_find_rasdes_capability() fails in addition to this change:

diff --git a/drivers/pci/controller/dwc/pcie-designware-debugfs.c b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
index dca1e9999113..7277a21e30d5 100644
--- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
+++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
@@ -471,7 +471,7 @@ static int dwc_pcie_rasdes_debugfs_init(struct dw_pcie *pci, struct dentry *dir)
        ras_cap = dw_pcie_find_rasdes_capability(pci);
        if (!ras_cap) {
                dev_dbg(dev, "no RASDES capability available\n");
-               return -ENODEV;
+               return 0;
        }
 
        rasdes_info = devm_kzalloc(dev, sizeof(*rasdes_info), GFP_KERNEL);

This will fix the regressions like the one reported by Geert:

https://lore.kernel.org/linux-pci/CAMuHMdWuCJAd-mCpCoseThureCKnnep4T-Z0h1_WJ1BOf2ZeDg@mail.gmail.com/

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-ua1-f49.google.com (mail-ua1-f49.google.com [209.85.222.49])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EE60627935A;
	Tue,  4 Mar 2025 14:57:16 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.49
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741100238; cv=none; b=AAkSOj/RUyXq6IB7XCU9R/UuT9/ryh4hy/wLT6B2wekLcmbZg7H5DgKLL/qQI0m6BLPqqJX5cVguJeNZr+wN+2zvsioCwpVo32Z8oQE4+iYYUlzl5vRK2g1N0zpvjv+04dXpslTm2g+4j4jzxrrc3kVnMRyaanfYz168gNrjsmg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741100238; c=relaxed/simple;
	bh=x1CoI5BgFiS3Owp5p1mD+l1Q9+YlbNW4fVkZBG1ygbI=;
	h=MIME-Version:References:In-Reply-To:From:Date:Message-ID:Subject:
	 To:Cc:Content-Type; b=l/UysQV4P5Nwe4x4y18B9CNcW1cOhKapwkbGAsxituHaeYtTOtEs0RjFpu0xHPszo/v1bmxbQ/s4+zYBqxv25qR66xDRQUzPMR7izlayl6cpIc+edYWzZlaRfgIU7leAmMixcYhAwjmnFRrxuhtXLTuyvPJ72Dwri4sQHpQtuNg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.222.49
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-ua1-f49.google.com with SMTP id a1e0cc1a2514c-8670fd79990so2174947241.3;
        Tue, 04 Mar 2025 06:57:16 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741100234; x=1741705034;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=cnx0gcUzGjGC6Jmsd1CoV+gv4tw/ToY0SgPfV1Ikf3c=;
        b=bo4gx59NtGFcyB3XsAtkLhwkURZ/JIn1S1lJ2RZe24WNDPTS3RfTwkA8OYktvgmOqI
         VbMXYSAjwRIjoSM4WKy/J3ANU/14Kvyg4Yz4oVzPlMpi99oMFGgFlof7OpA85XjlrZ1v
         XaYnpFIuGUW8l8Mn7vpsa3Ueq9KphEACv/32p31l3D0xZUiYC1hRutBzkS41tQR3jyhW
         P3TiJ01CsPyyJVopdFGpGdiPY4Gtefi7SEsmG8oNeT2AN3y++A4OdpIeCX5G1kGgVRs8
         sywZwOXRwt8SMQ+giYvZe1ur1XegRscRvBLOOX10YkUfLI6TKHylam+h0y/KhJIP04w8
         X5hQ==
X-Forwarded-Encrypted: i=1; AJvYcCUFFJo9yOZTO61uy/1x58+zqCTscJUreJ/EPBh3UD35ACfNzIYshGZ1bFast/uE3y5vRJEE3btUlikU3i0=@vger.kernel.org, AJvYcCUJFIdznuWB/As86r4/P6GZiRfCFK9NpZZUpQjioV+IlEUhFHSo47E3bQ7Gqr/R89kKo7yQo/MQfWXX@vger.kernel.org, AJvYcCWFaJM9hUqBKzFvkH7fyA5PAHcgkDfgaoHzhb9/kfAcN1UOjP5bURWOUiuSI/GX0Mylyh3a8FsvFwCVMoNPZKANeQ==@vger.kernel.org, AJvYcCXvyvdi1z0eAvg8IWMmqDi6bDjf9dkjtkM9zPkApc2fb5bOYHksMkyW2Pj6cIJxAd7R188XlOPJYhgfCNqKkGogdcM=@vger.kernel.org
X-Gm-Message-State: AOJu0YzAkxID0NhasrsCmQkUTAkMdlaIMo6BIUNo/Mh73Y2VBeafxDCU
	fz98cxDPwhN6/Bih/ulvKR8580fcHRv5FJCh+4dymVANaOKcrjHyvvxHpN26
X-Gm-Gg: ASbGnctOrPcmLNaXN/tjI7hu19GDV4m6u2hb93ft9QPDRgUNgq1FuqbwQHSPTk8CwR/
	BF9kEuoBMjU7Tqu0M8xqMsh2C2v5107MSy+90uRw1k/sLd78w2zsP3JctkeeXt+28ZhmqsXSD/B
	KUVdIsmZtt32uA7QYJDtyDy0EjdUhDKTfnY+NTYxH/uWHuGP1W8B0sjhn3MkAxCK9pDUFORzr3B
	JIef7jUqUwmx6uggdL6ZfZJQy5jdPbrz8y2KKiIdS8DKID2SUf3voRo5xnd/NIUah7JxQh6oOVT
	4B1Yf5b9Lzh2TAFiznMuMTzthuPdfcv8ccARASfe7beBI99EAJ7lo9cZ0r+Q+wTKAiojU84ml2v
	Ymn9hFo0=
X-Google-Smtp-Source: AGHT+IEvgn6ehT30BZbeKFHQWWEjO2KSYu1Wgtk15cF0fx7ifrHdaALThSfwaugd/Uj+xUfo2dgZzQ==
X-Received: by 2002:a05:6102:3346:b0:4bb:e14a:944b with SMTP id ada2fe7eead31-4c044ee23d6mr10543904137.20.1741100234161;
        Tue, 04 Mar 2025 06:57:14 -0800 (PST)
Received: from mail-ua1-f41.google.com (mail-ua1-f41.google.com. [209.85.222.41])
        by smtp.gmail.com with ESMTPSA id ada2fe7eead31-4c16ba4f676sm2014309137.21.2025.03.04.06.57.13
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Tue, 04 Mar 2025 06:57:13 -0800 (PST)
Received: by mail-ua1-f41.google.com with SMTP id a1e0cc1a2514c-86b2e0a227fso2391229241.2;
        Tue, 04 Mar 2025 06:57:13 -0800 (PST)
X-Forwarded-Encrypted: i=1; AJvYcCVStgJU6BIZpmcddXV2OLPQBDS5X8OhTDvLzFuU7ru81ldXn9ImzW6HsjmF1rnzEFNlOnSsBU2ASwasthA=@vger.kernel.org, AJvYcCWCfsiq4VujOiusWTfeIpfqrqMfM2OnRRyDKq3uPqfOf5qHq8S5104uH/P1uzoyL/fSdC3uUr6o2m4zG/rpZOwdpg==@vger.kernel.org, AJvYcCWlxk+GsN0ZW2+w4ndfcSYOsRKcVY42uONxci0ivl2kbzfcXPR4Nf5XaBNNTgpD53rg8Z8rH9jtclHP@vger.kernel.org, AJvYcCXoPX2gBY6QX2hBHUr11XhFBBk/jjfCoOwSkwEL9THCrXlRTa91EB17A++PuP5A5zyXjfRumIxiZKIvipwjVSPINAM=@vger.kernel.org
X-Received: by 2002:a05:6102:3346:b0:4bb:e14a:944b with SMTP id
 ada2fe7eead31-4c044ee23d6mr10543879137.20.1741100233150; Tue, 04 Mar 2025
 06:57:13 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <20250221131548.59616-1-shradha.t@samsung.com> <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com> <Z8XrYxP_pZr6tFU8@debian> <20250303194647.GC1552306@rocinante>
In-Reply-To: <20250303194647.GC1552306@rocinante>
From: Geert Uytterhoeven <geert@linux-m68k.org>
Date: Tue, 4 Mar 2025 15:57:01 +0100
X-Gmail-Original-Message-ID: <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
X-Gm-Features: AQ5f1JqCho8yfOlMgARNkOLJkO3vQy-dmfB5AhRkVmxo4nrVO_CH507OBRi_NRQ
Message-ID: <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
To: =?UTF-8?Q?Krzysztof_Wilczy=C5=84ski?= <kw@linux.com>
Cc: Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>, 
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, 
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org, 
	manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, robh@kernel.org, 
	bhelgaas@google.com, jingoohan1@gmail.com, Jonathan.Cameron@huawei.com, 
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org, 
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com, 
	will@kernel.org, mark.rutland@arm.com, 
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>, 
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

Hi Krzysztof,

(CC corrected)

This patch is now commit 1ff54f4cbaed9ec6 ("PCI: dwc: Add debugfs
based Silicon Debug support for DWC") in pci/next (next-20250304).

On Mon, 3 Mar 2025 at 20:47, Krzysztof Wilczy=C5=84ski <kw@linux.com> wrote=
:
> [...]
> > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > +{
> > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > +   struct device *dev =3D pci->dev;
> > > +   struct debugfs_info *debugfs;
> > > +   struct dentry *dir;
> > > +   int ret;
> > > +
> > > +   /* Create main directory for each platform driver */
> > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(de=
v));
> > > +   dir =3D debugfs_create_dir(dirname, NULL);
> > > +   debugfs =3D devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > +   if (!debugfs)
> > > +           return -ENOMEM;
> > > +
> > > +   debugfs->debug_dir =3D dir;
> > > +   pci->debugfs =3D debugfs;
> > > +   ret =3D dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > +   if (ret)
> > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> >
> > What will happen if ret !=3D 0? still return 0?

And that is exactly what happens on Gray Hawk Single with R-Car
V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
dwc_pcie_rasdes_debugfs_init() to return -ENODEV.

> Given that callers of dwc_pcie_debugfs_init() check for errors,

Debugfs issues should never be propagated upstream!

> this probably should correctly bubble up any failure coming from
> dwc_pcie_rasdes_debugfs_init().
>
> I made updates to the code directly on the current branch, have a look:

So while applying, you changed this like:

            ret =3D dwc_pcie_rasdes_debugfs_init(pci, dir);
    -       if (ret)
    -               dev_dbg(dev, "RASDES debugfs init failed\n");
    +       if (ret) {
    +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
    +               return ret;
    +       }

            return 0;

Hence this is now a fatal error, causing the probe to fail.
Unfortunately something fails during cleanup:

    pcie-rcar-gen4 e65d0000.pcie: failed to initialize RAS DES debugfs
    ------------[ cut here ]------------
    WARNING: CPU: 3 PID: 36 at kernel/irq/irqdomain.c:393
irq_domain_remove+0xa8/0xb0
    CPU: 3 UID: 0 PID: 36 Comm: kworker/u16:1 Not tainted
6.14.0-rc1-arm64-renesas-00134-g12c8c1363538 #2884
    Hardware name: Renesas Gray Hawk Single board based on r8a779h0 (DT)
    Workqueue: async async_run_entry_fn
    pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=3D--)
    pc : irq_domain_remove+0xa8/0xb0
    lr : irq_domain_remove+0x2c/0xb0
    sp : ffff8000819b3b10
    x29: ffff8000819b3b10 x28: 0000000000000000 x27: 0000000000000000
    x26: ffff00044011d800 x25: ffff80008053294c x24: ffff000441740400
    x23: ffff0004413a30f0 x22: ffff0004413a3130 x21: ffff0004413a3130
    x20: ffff8000815c0ec8 x19: ffff0004415f8240 x18: 00000000ffffffff
    x17: 6775626564205345 x16: 0000000000000020 x15: ffff8000819b37b0
    x14: 0000000000000004 x13: ffff8000813e9dd8 x12: 0000000000000000
    x11: ffff0004404b6448 x10: ffff800080e85400 x9 : 1fffe00088334301
    x8 : 0000000000000001 x7 : ffff0004419a1800 x6 : ffff0004419a1808
    x5 : ffff000441349030 x4 : fffffffffffffdc1 x3 : 0000000000000000
    x2 : ffff0004403e0000 x1 : 0000000000000000 x0 : ffff00044134f630
    Call trace:
     irq_domain_remove+0xa8/0xb0 (P)
     dw_pcie_host_init+0x394/0x710
     rcar_gen4_pcie_probe+0x104/0x2f8
     platform_probe+0x64/0xbc
     really_probe+0xb8/0x294
     __driver_probe_device+0x74/0x124
     driver_probe_device+0x3c/0x158
     __device_attach_driver+0xd4/0x154
     bus_for_each_drv+0x84/0xe0
     __device_attach_async_helper+0xac/0xd0
     async_run_entry_fn+0x30/0xd8
     process_one_work+0x144/0x280
     worker_thread+0x2c4/0x3cc
     kthread+0x128/0x1e0
     ret_from_fork+0x10/0x20
    ---[ end trace 0000000000000000 ]---

Worse, the PCI bus is still registered, so running "lspci" causes an Oops:

    Unable to handle kernel NULL pointer dereference at virtual
address 0000000000000004
    Mem abort info:
      ESR =3D 0x0000000096000004
      EC =3D 0x25: DABT (current EL), IL =3D 32 bits
      SET =3D 0, FnV =3D 0
      EA =3D 0, S1PTW =3D 0
      FSC =3D 0x04: level 0 translation fault
    Data abort info:
      ISV =3D 0, ISS =3D 0x00000004, ISS2 =3D 0x00000000
      CM =3D 0, WnR =3D 0, TnD =3D 0, TagAccess =3D 0
      GCS =3D 0, Overlay =3D 0, DirtyBit =3D 0, Xs =3D 0
    user pgtable: 4k pages, 48-bit VAs, pgdp=3D0000000483b53000
    [0000000000000004] pgd=3D0000000000000000, p4d=3D0000000000000000
    Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
    CPU: 3 UID: 0 PID: 707 Comm: lspci Tainted: G
W6.14.0-rc1-arm64-renesas-00134-g12c8c1363538 #2884
    Tainted: [W]=3DWARN
    Hardware name: Renesas Gray Hawk Single board based on r8a779h0 (DT)
    pstate: 204000c5 (nzCv daIF +PAN -UAO -TCO -DIT -SSBS BTYPE=3D--)
    pc : pci_generic_config_read+0x34/0xac
    lr : pci_generic_config_read+0x20/0xac
    sp : ffff8000825cbbf0
    x29: ffff8000825cbbf0 x28: ffff0004491c4b84 x27: 0000000000000004
    x26: 000000000000000f x25: ffff0004491c4b80 x24: 0000000000000040
    x23: 0000000000000040 x22: ffff8000825cbc64 x21: ffff8000816fb4f8
    x20: ffff8000825cbc14 x19: 0000000000000004 x18: 0000000000000000
    x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
    x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
    x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
    x8 : 0000000000000000 x7 : ffff000442c653c0 x6 : ffff8000805163d0
    x5 : ffff8000804f3334 x4 : ffff8000825cbc14 x3 : ffff800080531990
    x2 : 0000000000000004 x1 : 0000000000000000 x0 : 0000000000000004
    Call trace:
     pci_generic_config_read+0x34/0xac (P)
     pci_user_read_config_dword+0x78/0x118
     pci_read_config+0xe4/0x29c
     sysfs_kf_bin_read+0x8c/0x9c
     kernfs_fop_read_iter+0x9c/0x19c
     vfs_read+0x24c/0x330
     __arm64_sys_pread64+0xac/0xc8
     invoke_syscall+0x44/0x100
     el0_svc_common.constprop.0+0x3c/0xd4
     do_el0_svc+0x18/0x20
     el0_svc+0x24/0xa8
     el0t_64_sync_handler+0x104/0x130
     el0t_64_sync+0x154/0x158
    Code: 7100067f 540002a0 71000a7f 54000160 (b9400000)
    ---[ end trace 0000000000000000 ]---
    note: lspci[707] exited with irqs disabled
    note: lspci[707] exited with preempt_count 1

Gr{oetje,eeting}s,

                        Geert

--=20
Geert Uytterhoeven -- There's lots of Linux beyond ia32 -- geert@linux-m68k=
.org

In personal conversations with technical people, I call myself a hacker. Bu=
t
when I'm talking to journalists I just say "programmer" or something like t=
hat.
                                -- Linus Torvalds

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-ua1-f45.google.com (mail-ua1-f45.google.com [209.85.222.45])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B787378F39;
	Tue,  4 Mar 2025 14:54:31 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.222.45
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741100073; cv=none; b=EuAPInipnRK0RZyk4tNReVxQEj5deh2Z7aWXEM08mSz+x+msT86YK+GNEd80gsLp13ciK+6MM9yq1v0F6GuwJs2qlPzgMMbR8QeNOvJp4Z8EMxiYmsGJwXd1/iqmAr8yC3gyQzcAJySimttrxv126l2C5LOCGz6ug1+fMIhSFsk=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741100073; c=relaxed/simple;
	bh=sVEyCtEGAOXazpVA2ds1qgcN+T0Oqk82q0Ztht3CXw0=;
	h=MIME-Version:References:In-Reply-To:From:Date:Message-ID:Subject:
	 To:Cc:Content-Type; b=kakRb4tozD+R4lUj6pRbH+cBnb9TAxgOp13ctYpCy4Vf8QKQQgqUSU32jzmZi7klU8yvywZPFKORzIMCyInOR2AdmDehsza4jgtAC9BAwKK+Kbmig87FvZPrYby3X4QJefY/Djk0GWrmVgxa7CUhPmnc+N6ExWIW7cQxVQF/qns=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.222.45
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-ua1-f45.google.com with SMTP id a1e0cc1a2514c-86b7185d653so1010116241.0;
        Tue, 04 Mar 2025 06:54:31 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741100069; x=1741704869;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=fpoi690aUnKUgZbv3KZKnYeAytIZyP2VWb9kHfjEXMw=;
        b=OYQopbxqNBoCr7D7GpdVuMNfjt6FgEIYSFU4Xu8U0ZCAR69kbNRSqZgN20d/z7u+JN
         DKowDpSX8wOHgMH691Azf3gbnNLgUGu9DFq3OmkoUXEnwuZ7HQM9HQiZoSb4jp4lYfH+
         ojbRN0yicpR9Wm1WCMhG8UdY1sZExUTUWj6a7vsjredfyVjNS1AGhkHSrmGZ1+bnYS5w
         MTQyOxA+v166Al97ofm02Ka7DmQGjoO627iy6JEXClF90JG2T7W4MSOV9UaLov+41ZPP
         R1kjP/iLuZ1bFQBMAM4k8JljZdfGY9Tq5xB2UMswTpWj5acfc1GLFtY+EfB6MMgT8rM9
         k0TQ==
X-Forwarded-Encrypted: i=1; AJvYcCUCIXRLGa8CSGR40FREC62epBVhEn/IkWCCfzmX1JlYjUbiiKIKowwMAJhy54B/vPmIfeOcoMPuNKAj@vger.kernel.org, AJvYcCVfQc2shXZdj5YmaInrZXAz3IhN05joKlX64PEm18aUKP0ZGMFg01uYhbotiHZGEbTYh8XyO8yDunzYPKFcWZzOfA==@vger.kernel.org, AJvYcCXn3gRSgPQ4aa/0ZkMx8cTE5wiKWO31023gRqFntIQLNOPfCb/GyZDCaY8NmWuDgJWcrfNruGomY8csbZM=@vger.kernel.org
X-Gm-Message-State: AOJu0YxFAmIRoZtLev2RdY5m2mM4S4xdvc12W2RhYlwtxT75ooqwvU83
	f5+EGmlTBs2+56pJunOM5e4jTZDv1zjGLVC3OO/FZU7MJ0IpFFQOvEtaCR/4
X-Gm-Gg: ASbGncsn88Zz+t6LsPVtyESWFIoR7NPu4nARoTxPCBEKIQk3QAd9uBX/2LggyAoS99P
	u+tHzwbC0LsuPZHTdTZXOPuMy1Rz/jAfxOqL5Hzsed8OhNzy1JkhZ7Hq9JL2wCxQ5kliS38OOuQ
	kWDXofZZuhBXYsJiRFwTmnhfPILlNDPqsUZoG3DU9xUFem1Of/sHtsLV9v4eROVq3L4HgtkqIiK
	888HCEPZS82qdSwbWWCvw1FSDdpweB+m9pFEPCFNrnQP6pDQcUZrFPe8qAWrsleC/ImAwkavQXV
	uV5R8srBXh1RQpwkOZPXghhfpE6qU76YC+Qdr1oj2JPPn49j2zftG8HMeUekPdaUVBDNBbUx6p3
	6rnW6j7U=
X-Google-Smtp-Source: AGHT+IFoEN2r9PD3tRNXvn/TNdb+XIZlXcc57x+b2pgw7O9q6aBtHJRcsftY7LcRCguPcZbzifvppw==
X-Received: by 2002:a05:6102:3f4f:b0:4bb:4c52:6730 with SMTP id ada2fe7eead31-4c04490eb5cmr11583572137.12.1741100069314;
        Tue, 04 Mar 2025 06:54:29 -0800 (PST)
Received: from mail-ua1-f49.google.com (mail-ua1-f49.google.com. [209.85.222.49])
        by smtp.gmail.com with ESMTPSA id ada2fe7eead31-4c16ba4f676sm2013591137.21.2025.03.04.06.54.28
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Tue, 04 Mar 2025 06:54:29 -0800 (PST)
Received: by mail-ua1-f49.google.com with SMTP id a1e0cc1a2514c-86b2b14303fso2345214241.2;
        Tue, 04 Mar 2025 06:54:28 -0800 (PST)
X-Forwarded-Encrypted: i=1; AJvYcCVOU6rr6VEwGBzS40rnugao0IP5ZG0RpUsWOiA+g3mTfCV13n00Dzgq9b2AGmj5vlCDYRtnasO9O/FNP4o=@vger.kernel.org, AJvYcCXCGlduA+gcX6YlMyPCPLKBQSxVSlcxwA8vVelNVFwBUee2HJuzT3R/Vb8YStFGst/xlRGxCR7bWsYK@vger.kernel.org, AJvYcCXMFs7p5D5eSt68nkQk+CSViVRKgExOC5fZUj+dlazH99Sv5MDYx3pTgAsO9+/T3aKTi/Qb4JD46d72ofsj/JV/RA==@vger.kernel.org
X-Received: by 2002:a05:6102:3ecc:b0:4bb:5d61:127e with SMTP id
 ada2fe7eead31-4c044d4ab20mr10413122137.25.1741100068657; Tue, 04 Mar 2025
 06:54:28 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <20250221131548.59616-1-shradha.t@samsung.com> <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com> <Z8XrYxP_pZr6tFU8@debian> <20250303194647.GC1552306@rocinante>
In-Reply-To: <20250303194647.GC1552306@rocinante>
From: Geert Uytterhoeven <geert@linux-m68k.org>
Date: Tue, 4 Mar 2025 15:54:16 +0100
X-Gmail-Original-Message-ID: <CAMuHMdWuCJAd-mCpCoseThureCKnnep4T-Z0h1_WJ1BOf2ZeDg@mail.gmail.com>
X-Gm-Features: AQ5f1JoqtMy8hoZL8-viYrcUOUZmi4FtvLdHdpQ6zdyS-NBLZrj7ILd0QVxTKVI
Message-ID: <CAMuHMdWuCJAd-mCpCoseThureCKnnep4T-Z0h1_WJ1BOf2ZeDg@mail.gmail.com>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
To: =?UTF-8?Q?Krzysztof_Wilczy=C5=84ski?= <kw@linux.com>
Cc: Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>, 
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, 
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org, 
	manivannan.sadhasivam@linaro.org, lpieralisi@kernel.org, robh@kernel.org, 
	bhelgaas@google.com, jingoohan1@gmail.com, Jonathan.Cameron@huawei.com, 
	a.manzanares@samsung.com, pankaj.dubey@samsung.com, cassel@kernel.org, 
	18255117159@163.com, xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com, 
	will@kernel.org, mark.rutland@arm.com, 
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>, 
	Linux-Renesas <linux-renesas-soc@vger.kernel.or>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

Hi Krzysztof,

This patch is now commit 1ff54f4cbaed9ec6 ("PCI: dwc: Add debugfs
based Silicon Debug support for DWC") in pci/next (next-20250304).

On Mon, 3 Mar 2025 at 20:47, Krzysztof Wilczy=C5=84ski <kw@linux.com> wrote=
:
> [...]
> > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > +{
> > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > +   struct device *dev =3D pci->dev;
> > > +   struct debugfs_info *debugfs;
> > > +   struct dentry *dir;
> > > +   int ret;
> > > +
> > > +   /* Create main directory for each platform driver */
> > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(de=
v));
> > > +   dir =3D debugfs_create_dir(dirname, NULL);
> > > +   debugfs =3D devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > +   if (!debugfs)
> > > +           return -ENOMEM;
> > > +
> > > +   debugfs->debug_dir =3D dir;
> > > +   pci->debugfs =3D debugfs;
> > > +   ret =3D dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > +   if (ret)
> > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> >
> > What will happen if ret !=3D 0? still return 0?

And that is exactly what happens on Gray Hawk Single with R-Car
V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
dwc_pcie_rasdes_debugfs_init() to return -ENODEV.

> Given that callers of dwc_pcie_debugfs_init() check for errors,

Debugfs issues should never be propagated upstream!

> this probably should correctly bubble up any failure coming from
> dwc_pcie_rasdes_debugfs_init().
>
> I made updates to the code directly on the current branch, have a look:

So while applying, you changed this like:

            ret =3D dwc_pcie_rasdes_debugfs_init(pci, dir);
    -       if (ret)
    -               dev_dbg(dev, "RASDES debugfs init failed\n");
    +       if (ret) {
    +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
    +               return ret;
    +       }

            return 0;

Hence this is now a fatal error, causing the probe to fail.
Unfortunately something fails during cleanup:

    pcie-rcar-gen4 e65d0000.pcie: failed to initialize RAS DES debugfs
    ------------[ cut here ]------------
    WARNING: CPU: 3 PID: 36 at kernel/irq/irqdomain.c:393
irq_domain_remove+0xa8/0xb0
    CPU: 3 UID: 0 PID: 36 Comm: kworker/u16:1 Not tainted
6.14.0-rc1-arm64-renesas-00134-g12c8c1363538 #2884
    Hardware name: Renesas Gray Hawk Single board based on r8a779h0 (DT)
    Workqueue: async async_run_entry_fn
    pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=3D--)
    pc : irq_domain_remove+0xa8/0xb0
    lr : irq_domain_remove+0x2c/0xb0
    sp : ffff8000819b3b10
    x29: ffff8000819b3b10 x28: 0000000000000000 x27: 0000000000000000
    x26: ffff00044011d800 x25: ffff80008053294c x24: ffff000441740400
    x23: ffff0004413a30f0 x22: ffff0004413a3130 x21: ffff0004413a3130
    x20: ffff8000815c0ec8 x19: ffff0004415f8240 x18: 00000000ffffffff
    x17: 6775626564205345 x16: 0000000000000020 x15: ffff8000819b37b0
    x14: 0000000000000004 x13: ffff8000813e9dd8 x12: 0000000000000000
    x11: ffff0004404b6448 x10: ffff800080e85400 x9 : 1fffe00088334301
    x8 : 0000000000000001 x7 : ffff0004419a1800 x6 : ffff0004419a1808
    x5 : ffff000441349030 x4 : fffffffffffffdc1 x3 : 0000000000000000
    x2 : ffff0004403e0000 x1 : 0000000000000000 x0 : ffff00044134f630
    Call trace:
     irq_domain_remove+0xa8/0xb0 (P)
     dw_pcie_host_init+0x394/0x710
     rcar_gen4_pcie_probe+0x104/0x2f8
     platform_probe+0x64/0xbc
     really_probe+0xb8/0x294
     __driver_probe_device+0x74/0x124
     driver_probe_device+0x3c/0x158
     __device_attach_driver+0xd4/0x154
     bus_for_each_drv+0x84/0xe0
     __device_attach_async_helper+0xac/0xd0
     async_run_entry_fn+0x30/0xd8
     process_one_work+0x144/0x280
     worker_thread+0x2c4/0x3cc
     kthread+0x128/0x1e0
     ret_from_fork+0x10/0x20
    ---[ end trace 0000000000000000 ]---

Worse, the PCI bus is still registered, so running "lspci" causes an Oops:

    Unable to handle kernel NULL pointer dereference at virtual
address 0000000000000004
    Mem abort info:
      ESR =3D 0x0000000096000004
      EC =3D 0x25: DABT (current EL), IL =3D 32 bits
      SET =3D 0, FnV =3D 0
      EA =3D 0, S1PTW =3D 0
      FSC =3D 0x04: level 0 translation fault
    Data abort info:
      ISV =3D 0, ISS =3D 0x00000004, ISS2 =3D 0x00000000
      CM =3D 0, WnR =3D 0, TnD =3D 0, TagAccess =3D 0
      GCS =3D 0, Overlay =3D 0, DirtyBit =3D 0, Xs =3D 0
    user pgtable: 4k pages, 48-bit VAs, pgdp=3D0000000483b53000
    [0000000000000004] pgd=3D0000000000000000, p4d=3D0000000000000000
    Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
    CPU: 3 UID: 0 PID: 707 Comm: lspci Tainted: G        W
6.14.0-rc1-arm64-renesas-00134-g12c8c1363538 #2884
    Tainted: [W]=3DWARN
    Hardware name: Renesas Gray Hawk Single board based on r8a779h0 (DT)
    pstate: 204000c5 (nzCv daIF +PAN -UAO -TCO -DIT -SSBS BTYPE=3D--)
    pc : pci_generic_config_read+0x34/0xac
    lr : pci_generic_config_read+0x20/0xac
    sp : ffff8000825cbbf0
    x29: ffff8000825cbbf0 x28: ffff0004491c4b84 x27: 0000000000000004
    x26: 000000000000000f x25: ffff0004491c4b80 x24: 0000000000000040
    x23: 0000000000000040 x22: ffff8000825cbc64 x21: ffff8000816fb4f8
    x20: ffff8000825cbc14 x19: 0000000000000004 x18: 0000000000000000
    x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
    x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
    x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
    x8 : 0000000000000000 x7 : ffff000442c653c0 x6 : ffff8000805163d0
    x5 : ffff8000804f3334 x4 : ffff8000825cbc14 x3 : ffff800080531990
    x2 : 0000000000000004 x1 : 0000000000000000 x0 : 0000000000000004
    Call trace:
     pci_generic_config_read+0x34/0xac (P)
     pci_user_read_config_dword+0x78/0x118
     pci_read_config+0xe4/0x29c
     sysfs_kf_bin_read+0x8c/0x9c
     kernfs_fop_read_iter+0x9c/0x19c
     vfs_read+0x24c/0x330
     __arm64_sys_pread64+0xac/0xc8
     invoke_syscall+0x44/0x100
     el0_svc_common.constprop.0+0x3c/0xd4
     do_el0_svc+0x18/0x20
     el0_svc+0x24/0xa8
     el0t_64_sync_handler+0x104/0x130
     el0t_64_sync+0x154/0x158
    Code: 7100067f 540002a0 71000a7f 54000160 (b9400000)
    ---[ end trace 0000000000000000 ]---
    note: lspci[707] exited with irqs disabled
    note: lspci[707] exited with preempt_count 1

Gr{oetje,eeting}s,

                        Geert

--=20
Geert Uytterhoeven -- There's lots of Linux beyond ia32 -- geert@linux-m68k=
.org

In personal conversations with technical people, I call myself a hacker. Bu=
t
when I'm talking to journalists I just say "programmer" or something like t=
hat.
                                -- Linus Torvalds

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f172.google.com (mail-pl1-f172.google.com [209.85.214.172])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1190B1487DD;
	Tue,  4 Mar 2025 06:44:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.172
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741070697; cv=none; b=OVC9WT23w9vxiZG4E3FBXgWeCuEuygE6Os4qDP3dfmwbV+SX5bUPzoOmYA519j8GXRuoQVF3I7u52BwK8aA6XqjPR9/GMNKeRO5Rk6oZMRx7oVR1Q8O3v420DpyR7G6ktAuhYt1HmSbSUlsheIlhnhOOC+5Fqj2kScrOfXPTwTs=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741070697; c=relaxed/simple;
	bh=CKmhCwChjYX0WnRaI3mh9Oz+ZEy7hRLTy56Sg3qI4g4=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=TK2LYi95FZJJShRDrkTa2qeSRni4GLRKZ8QtSQsqO27ZorfTdN5IDIp4EirEnJgQd5Nepk2HE9wCD66TdMuYBTz0PL4zBu+KOhCmtVkGiVBgpxixB3SoENhTnO3tgWv+3u74LQsDHzCyu2v2nnDE+CiLU2zHXjFfi2F4zqKMM78=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.172
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f172.google.com with SMTP id d9443c01a7336-22385253e2bso62616665ad.1;
        Mon, 03 Mar 2025 22:44:55 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741070695; x=1741675495;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=k/NqaLvRye4Cq0LyeXwhNE1kNW2vwV2kBs1us3jXtWU=;
        b=AregjSHUBSdQhpCnuq3ZuDB4O/SjcRKP79vdvECPgLA4X1ZNoqKVqhF6Jdj7QhMajO
         FwXZHT3NDpBqBwNWPkrNYh2vjrnWzBcufLtUa/sKPP9NA12xuqe/YinqcJwVcPPuAJH6
         fkchhEbSRdhyY2+kebAX8Ri+AgLAHgFkRr0Oa8wVRZlg7SDYU7D6iTnKuq32MUEvroa4
         YNPoPqlyDPXdiPdX2ra6SclxskEpLkNx5oW9Px2WoZE3f5yi2+g36YrTwa8SSdkkAFZB
         mPwqOySilbN+iRet2/LKcpvMsfXcHCoEA6e8mdYdKW8LGKTy4hDoEomQzAimfPxTWUNT
         DN6Q==
X-Forwarded-Encrypted: i=1; AJvYcCUsu6bxSE+Mh3DhBBx48x2eGpUqh40ngWf2sscL9c5RFVDwvZI+ZbTJzdAuGS1VXEx4Xo6gbm8HOFaGm/wlhaMq+A==@vger.kernel.org, AJvYcCV/o11uGUnPwZO5LFYwHKVK7hTBMnNkmFO7Hq6rFQw93vkop7+hTv/fwSNF1g0E0mebSJlamD06SDcFsTs=@vger.kernel.org, AJvYcCX4Fi0sh+L6185YNiY3d1flocZ9CRoMYbdgBbK1iuDwedYeI+sWzFULp5zrc5cZPKlhE06DrU3IUMAE@vger.kernel.org
X-Gm-Message-State: AOJu0Ywx1z8xRAiFIsl62PhDicGS4yojm9jR+Z8YnwP+1qRvDyudjbV8
	1E/cZf/1S1GF5wtsjyE7n7B0PvE4lpqPYVP4EA/aYqoK5ywQbbR9
X-Gm-Gg: ASbGnct7h6kvb5sb7s+ymiKMJ3UsFHBcsP2hLiPZ9e8Lq+3yl/sj4nPEceT8GW3J5ow
	SAY9eawHNEfjg4dnLpwJN+AGL70wbx3neKRLweT2lzJHNr9azfB+aNk3lOD6KV9ELc4qhmDM8MA
	gc/Q4JLhs0kkjwZt4Jekj9ltJqRery5uG8pfXVwIpTV9qkFIGyuCehcxfMZi8KT6mK6WrpxVu1A
	AuuirwcsWmgDQ3maeZQTSkQVPXpzHzpsWiSX8DPB00RLIcCdb2EW9Dqf12QycCQ+0rA887O1jdc
	1bxkF0BOBE1AF/P/gKUkekisG+nCAgA4rFJQ3mFBNqUf/6AerBFtz0t6p2xqiiPo+RtrnAxXqly
	gf3w=
X-Google-Smtp-Source: AGHT+IHubZ3OFPwp+4oYsLj435L9jVCvESdk0kEc9gOPZuvwk4jvcIWYRz8EL7NQ2ybDdZ4+kOA+fA==
X-Received: by 2002:a17:903:244d:b0:216:69ca:770b with SMTP id d9443c01a7336-22368f73bbcmr222052325ad.12.1741070695120;
        Mon, 03 Mar 2025 22:44:55 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-223504c5cc6sm88516415ad.112.2025.03.03.22.44.53
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 22:44:54 -0800 (PST)
Date: Tue, 4 Mar 2025 15:44:52 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Fan Ni <nifan.cxl@gmail.com>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250304064452.GA2615015@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
 <Z8YWILtSbQnvVqbF@debian>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Z8YWILtSbQnvVqbF@debian>

Hello,

[...]
> > > What will happen if ret != 0? still return 0? 
> > 
> > Given that callers of dwc_pcie_debugfs_init() check for errors,
> > this probably should correctly bubble up any failure coming from
> > dwc_pcie_rasdes_debugfs_init().
> > 
> > I made updates to the code directly on the current branch, have a look:
> > 
> >   https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=1ff54f4cbaed9ec6994844967c36cf7ada4cbe5e
> > 
> > Let me know if this is OK with you.
> 
> It looks good to me.
> 
> Feel free to add,
> Reviewed-by: Fan Ni <fan.ni@samsung.com>

Will do.  Thank you.

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f170.google.com (mail-pl1-f170.google.com [209.85.214.170])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1A4D71E9B3D;
	Mon,  3 Mar 2025 21:03:17 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.170
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741035799; cv=none; b=QaHwbbS7+vf2Dby9mAIH6qKRteuRV6Erlp0tzl2qUKRcT8fChHxOc4ETImeZfKmRhIxpqRvowzwMJOBUIVnjav2SU5PB2J9EBoB/1rTh3DLeetvvahnbUgzPy5Km7aLWyyFsMA6UxUdAfTq78eRCEZx1ux0cvc6uAN5n2ya2mBI=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741035799; c=relaxed/simple;
	bh=cwtgwMtlhWsPzlpXc8XSzTumsmavKHIDAJ+Sj83kK8g=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=pntEAOhAG1ayYGywWGbHLOcrrJK3AvT7C2O6t1+vLcLg061Xto+KBfVb50stpmLq3pekDTpVSyOoHZiQ+C1a18W95c3vktcBMXztd/fTiPiAzAAV9fsIC6dy1c43EbA1yFfCRJxS7h9NviTELLCVYgoenMPH+dv0hWHhPh+eiuI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=nEIUtNQE; arc=none smtp.client-ip=209.85.214.170
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="nEIUtNQE"
Received: by mail-pl1-f170.google.com with SMTP id d9443c01a7336-2239c066347so35282865ad.2;
        Mon, 03 Mar 2025 13:03:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741035797; x=1741640597; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=B9HBpbXIy/k/ZzJzT43ntRHVnDGFv2MuASArIvtm8UM=;
        b=nEIUtNQEknXXf2OPK0lXdP/AWrX/8uyttDIaXvuvVRVhWltYAOIAyvR8U5ePHC+3b+
         QOq79e27xK2pXNy+fy3985tMv1dhPKAUfSEQFTQ6JyP8DDeFMwfl80W3+bPyaRgXA1SL
         enwIS6vUutTu1+iLHZOtXvD4VqpdBmEZ4TsmjbIUcV6+KfUIqs/qMFjjbMjpf3a3J0wF
         UTDbwMVG4Da+Vc253KRSC3O3CwFz1zgVm6oTNOBvKeIoaGGU7RQrTHHrxiy/vf3yCPQy
         Bdz39KB25jpClgA2wJ6ANx4E8mIfH8VSryvt+loGonrSGnmS8O+4JMSDAUaUUMRG+6KJ
         3JAw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741035797; x=1741640597;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=B9HBpbXIy/k/ZzJzT43ntRHVnDGFv2MuASArIvtm8UM=;
        b=r6aSxn0eKteLkLeLxIeDyMLkqUBWbvcmYthhVLURIHVETIYTvkotnCcf66bZ8MzBvO
         o/5jXxNuTdi2w1HoER7klqlV0SnvSutkHfsrehAa1khjh0NQZtyv6EAC1YICWMh5tCAf
         5OeH254Imaf2o2uRXAIcAEBHBuLgL54JSedIz7VALt6Ibtggj7sOXPezfWz0oOWtXEoV
         DI38RAFQJ7hwVKth+sqMU9WENfdD3hf0dTbA2rXAZJGUDwNtfGQWvPRzGC5oEfqJATuq
         5wq9ZpVXY5NQmBvOzpeE4Ymh0EhB1ttbPXq+0xyi4I/2jqBob7ZezpvQb3cgUX2nzUrQ
         PSZQ==
X-Forwarded-Encrypted: i=1; AJvYcCUx2NHTa1wco+HP/zWSbNivoz5kGbgot9LfGW5JfoMhuHtUUT+748ECLslQ4b/wu30rdbtaK4TrVBAsb7nwu7no9w==@vger.kernel.org, AJvYcCV7QiJxFn70b1YvUu7TCJSPfC+1vNnlbe+rZBBL0LiUKk2/nwXkpVUPEa6DekZuoK6DMC8F8BcSBdpK@vger.kernel.org, AJvYcCWBO4WWBG/J9T4+pVKBjU3kQZLm/U80K79YzqLanEngU+iao9IL3AYHR4GCi1iR8tun+dzNtJRn20ZESjE=@vger.kernel.org
X-Gm-Message-State: AOJu0YzzD3pgz6HosBxK7yToHH3TEicId+VodBIWGJJveHMMuNgXXy2x
	+am6Daxzr+0i26wx/H+UeEu2xTjyytU2Q6zfR4nhRglbznvQd8zb
X-Gm-Gg: ASbGncuGm9jgL8cLHe+SiGLHzzkrrxj5CikkZkVgUjvxaAG+yykH23VWmHBzopeuDEr
	tw84fTw3+sFToki5Yf7cryQRLVlOqgAdkAZvBRjuXje1WC58pjhkoKoimI9pXqe1ESXuuUL2Xy1
	w/ubqh8drShwFA6QlcEzGJwOJjhmclIPW/1sTXup9ypTO7sgGn7zdyX2T6+peEyBBgfmzAiBTSo
	qL+9c6aM8Ghvq8SohcpCoWLnwlwKRjQHYBu7P4nt87yqjZJ1StZe+xrbswY4g5w3HNm8nebUhB+
	VRDSOEEdLcaxhKWA/NAm+qkGr6OOMq2/XJhay+o2
X-Google-Smtp-Source: AGHT+IHInytWSAP68J0pF/25lZDGpVvx/ij28c4zW0D1/qGfM3LkSyEL79EClseudwK/bIrxfeuiDg==
X-Received: by 2002:a05:6a00:3cd1:b0:736:34a2:8a20 with SMTP id d2e1a72fcca58-73634a28b18mr15869743b3a.21.1741035797227;
        Mon, 03 Mar 2025 13:03:17 -0800 (PST)
Received: from debian ([2607:fb90:37e1:4bed:f057:b35a:e3e2:4c5f])
        by smtp.gmail.com with ESMTPSA id d2e1a72fcca58-73630744c23sm5969768b3a.15.2025.03.03.13.03.14
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 13:03:16 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 13:03:12 -0800
To: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
Cc: Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <Z8YZEALV71PUkXpF@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
 <Z8XuuNb6TRevUlHH@debian>
 <20250303194228.GB1552306@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250303194228.GB1552306@rocinante>

On Tue, Mar 04, 2025 at 04:42:28AM +0900, Krzysztof WilczyÅ„ski wrote:
> Hello,
> 
> [...]
> > > +static ssize_t counter_value_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> > > +{
> > > +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> > > +	struct dw_pcie *pci = pdata->pci;
> > > +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> > > +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> > > +	ssize_t pos;
> > > +	u32 val;
> > > +
> > > +	mutex_lock(&rinfo->reg_event_lock);
> > > +	set_event_number(pdata, pci, rinfo);
> > > +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> > > +	mutex_unlock(&rinfo->reg_event_lock);
> > > +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter value: %d\n", val);
> > > +
> > > +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf, pos);
> > > +}
> > 
> > Do we need to check whether the counter is enabled or not for the event
> > before retrieving the counter value?
> 
> I believe, we have a patch that aims to address, have a look at:
> 
>   https://lore.kernel.org/linux-pci/20250225171239.19574-1-manivannan.sadhasivam@linaro.org

Maybe I missed something, that seems to fix counter_enable_read(), but
here is to retrieve counter value. 
How dw_pcie_readl_dbi() can return something like "Counter Disabled"? 

Fan
> 
> Thank you!
> 
> 	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f47.google.com (mail-pj1-f47.google.com [209.85.216.47])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4FE6711CA9;
	Mon,  3 Mar 2025 20:50:46 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.47
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741035047; cv=none; b=uClUfcaltGVy77w9kzaIDTVrEyqufbhf+A6L33mt6531IeT+/W44Dy1dWmJn7LwOSefvdxpIdB5wCsEhssJsESkUNoGrA4yTVD5dDDIKJYs6yDnqmpxs7R0X6JYqBPTLZ98YAW3SN200hfzi2vBACFa3OKzYQPI/wzuwoBs4ips=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741035047; c=relaxed/simple;
	bh=RKvL1Q2g46VN5bp/cUMDFTi+QQZE6l5UR/9YqkN1B50=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=hCgrQzbphZiHBmrUfXqvRyKduJjrZ5oWZ8APeqhrOV+jC6e1FJFF3xFyW7c+JF7gzlvKKVD8oegIES6RuSMaCeuB8oATZRrr1McHPbrhpsK5bauo7PdRsufI1m237iiv+lS0wmqW0RpPhiw6Ks6b7fNimJtykZnVHjcReFbiCO8=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=UUKLuSTz; arc=none smtp.client-ip=209.85.216.47
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="UUKLuSTz"
Received: by mail-pj1-f47.google.com with SMTP id 98e67ed59e1d1-2fea795bafeso7532274a91.1;
        Mon, 03 Mar 2025 12:50:46 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741035045; x=1741639845; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=DeBNmmMi2sz0NauGtZCPku7As8wMc8IwVYWILITKobE=;
        b=UUKLuSTzB+yQXVDASBAezzb7Nbxsslxhp2XhuWiT6wIsTVrQ001m3bdVvt0mydJ7m8
         RbMKSINGdWTSE1WhD7Lb6nTQEIs+J62oDTt7skaG14gJaQwF1ucSyZyaJ/dvympJNjI8
         v6vQK9zMmbI2m6w9l3CC4V6p+s6jImVlmqRD2e7UCl1imPe5NfvZlvE8BDTovvfmh7Nw
         Rn/6Rhi42nrLhy+w1UAs14ykxxTX9ACXMwJj8O+N5jZ2XwB5VLoH1AP+CAgussx0wpvZ
         LC+FT9Jo6zpGgT+dQ0nV2n5e5jXuxgqk3PLZDsas8A9Ld0R3Due4lB7nqwwj6sRsTpEh
         sWFg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741035045; x=1741639845;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=DeBNmmMi2sz0NauGtZCPku7As8wMc8IwVYWILITKobE=;
        b=tRdPB1ScwY4dypDWWu+HWGZqbsrV6LneXA+67Id2Hk9h9+Eq/A3KO7DZyqp64ImZVh
         GnW0uzOEHDI5Fc5AsyI/DsMxNtQjwUFoLqYADLmSovMF0W3RAhUF0GiaoqxHMkS/FIg7
         mwfthfO7TdtjMi4VRUMnm9hlpwl+s4DcCSaRJIOjJzthn/jmPTHIJg7Ke1eIzdj+pJYe
         AFaWHiy5IXSih5oOXYeok9Sbvqe1p4bScOnrD3HII5LvPJUPKQEyR4nHkTqntUlkU7HS
         9p9JMil++9Ds2L/PFygyZ7eB2blzNY2pPN8Wk/nYWsBHLP6JO8ckxwKNPxL0cFqEqWoJ
         jPsQ==
X-Forwarded-Encrypted: i=1; AJvYcCU0qIFpA7id/mUB52wAesH04IYqI4AmBDtyjIqbZcqdZYCBjfigl9F5U10+oUrjvFu5JpPeXaIP9IkW@vger.kernel.org, AJvYcCVy8WLRN69i5sksGHpk/ER/SZykfrAuCBHNHtg8H0cqTArjt1fAubmMG8bGVMD5pKPPt30NLoqNzAbsdYveoa2XPg==@vger.kernel.org, AJvYcCW1uBRW76YX0erlyb6dEdg4cJ7hrp0aMhuX7l4ZqkRYLZWalFITHu2vV20Scnp79UDLzCmBJcszZxf9BlI=@vger.kernel.org
X-Gm-Message-State: AOJu0YzXHrfd9ypfQKcrdFiXzRK6YnXvHIc/2Twtlfy/nYfSJ9M2Wook
	1/bbQWCTCHiYzjwNLtprZF/QZucs12C3nJ//pWN/yb+AjSw93eoe
X-Gm-Gg: ASbGncs4pJGLhBbVWgJz+UUuW+b56HApoFEvVLO04wesSwIXD+Pn99OW33bobmDwhuB
	D3wFNedaBgokHbnEg/1PnyuQRxGDF7i+cPo5ghXMOUAi33sc/4b+TY0RBdCt023DhvB/dppuawI
	7aLFWgto3EZrcJUzuYimNRZrE9lRvSPQIqoNPLIP4Q8fiEUaWl54W3dFreQhCQA92My4uwimSXQ
	uTmmghDJ7XPOrsFKX6850TLHCFO5uHg0wU0kt72b3zYIcTAsLE6NYT22xSeQnu+7dgO7QAme3+m
	wLYtSxjSrjm8ig6n6MBp5WmvmPKH7dwSTR3d6nEy
X-Google-Smtp-Source: AGHT+IGh1THqn567WjqVqxs2mA94q92PxAVet1ueAXS1LUHZPvR/E7EsrK6tGQWCWBCacVWMkBiPLw==
X-Received: by 2002:a17:90b:2e0f:b0:2fa:2252:f436 with SMTP id 98e67ed59e1d1-2ff33b88525mr982923a91.3.1741035045487;
        Mon, 03 Mar 2025 12:50:45 -0800 (PST)
Received: from debian ([2607:fb90:37e1:4bed:f057:b35a:e3e2:4c5f])
        by smtp.gmail.com with ESMTPSA id d9443c01a7336-223504c603bsm82393025ad.121.2025.03.03.12.50.42
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 03 Mar 2025 12:50:44 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Mon, 3 Mar 2025 12:50:40 -0800
To: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
Cc: Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <Z8YWILtSbQnvVqbF@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250303194647.GC1552306@rocinante>

On Tue, Mar 04, 2025 at 04:46:47AM +0900, Krzysztof WilczyÅ„ski wrote:
> Hello,
> 
> [...]
> > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > +{
> > > +	char dirname[DWC_DEBUGFS_BUF_MAX];
> > > +	struct device *dev = pci->dev;
> > > +	struct debugfs_info *debugfs;
> > > +	struct dentry *dir;
> > > +	int ret;
> > > +
> > > +	/* Create main directory for each platform driver */
> > > +	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > +	dir = debugfs_create_dir(dirname, NULL);
> > > +	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > +	if (!debugfs)
> > > +		return -ENOMEM;
> > > +
> > > +	debugfs->debug_dir = dir;
> > > +	pci->debugfs = debugfs;
> > > +	ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > +	if (ret)
> > > +		dev_dbg(dev, "RASDES debugfs init failed\n");
> > 
> > What will happen if ret != 0? still return 0? 
> 
> Given that callers of dwc_pcie_debugfs_init() check for errors,
> this probably should correctly bubble up any failure coming from
> dwc_pcie_rasdes_debugfs_init().
> 
> I made updates to the code directly on the current branch, have a look:
> 
>   https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=1ff54f4cbaed9ec6994844967c36cf7ada4cbe5e
> 
> Let me know if this is OK with you.

It looks good to me.

Feel free to add,
Reviewed-by: Fan Ni <fan.ni@samsung.com>

Fan
> 
> Good catch, thank you!
> 
> 	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f50.google.com (mail-pj1-f50.google.com [209.85.216.50])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1697A19DFA4
	for <linux-perf-users@vger.kernel.org>; Tue, 25 Feb 2025 17:15:09 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.50
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1740503712; cv=none; b=lVXaE1dRplgroIqoLspic3riRyQUU59g2DH253Apq41HNg5LPSaSwgBYvlpRZ6PBYSP/RIIPJbOOK/sQ3tBDtBMOc/RxgduxmBwRME1TS+tOEBXlV1KxzpyObkFqqaveJL4NM1GufXBoTN61cQmpqDV8Jnk1kh8+iHwTINJjh7I=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1740503712; c=relaxed/simple;
	bh=bL79cNVobOr1HRq/LkKge12+uGo654Ifd9y3+CyTMfc=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=ipoPEzDSynrUsMTZ2vE7Wdjl0wfjvVTeuha1r8++TV3E6f6TBqrql2QCuVzMSZAk4EvgIbfZV8xq40bPffeymBf1ee3AeJohcUfm+qCgq+eNTBcnh7vcu46U8sCCdGwWVsBj5UoyGbRK6istwutgJSKqmN96v+06jJgm+jIJ3Bg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=rm+HC3RI; arc=none smtp.client-ip=209.85.216.50
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="rm+HC3RI"
Received: by mail-pj1-f50.google.com with SMTP id 98e67ed59e1d1-2f9d3d0f55dso9077312a91.1
        for <linux-perf-users@vger.kernel.org>; Tue, 25 Feb 2025 09:15:09 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1740503709; x=1741108509; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=FF54yqkuvwX1pBRnFH8QcIU5TxlTBf1rKceF/MbIVBs=;
        b=rm+HC3RIaWhCKUU89MCfoXEI2TGwnmgKO51HfnF1iTpYVF0H4GGjviL3KN7tRo1l4h
         JRJ5F8PN6ae2vnrjZwyyfGdWcg8GILEOHtjMSZsoXEzHvLESsa7SZ3rylZRVHtIseFtz
         ectkD2rkofFa05sDoG8T2lQgUznRmu76psdkObr5Wh/M7hMgtpr9bcVAjbrp9hnpuJY0
         zIpJBVGt2aTHVuy/bLk6TxgU4n2RUrAxaRqShqie0IEOn6ApSZM1kQHGj/VaYziqs/Fs
         mtv4C6C5F/BneqSc++UIB2Gn2kgMOO9affc/aT0BGRmYYwHpIygb1g/Cs5SFdYDayFfj
         0Kgw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1740503709; x=1741108509;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=FF54yqkuvwX1pBRnFH8QcIU5TxlTBf1rKceF/MbIVBs=;
        b=uQ54ch87LpFomuxney11BWpmtZNRu+2L+STc6NQi7EiGl5k922eV6ps9PgCBqF+lEE
         9SvhU8QyY46wd7nIN8Q6s3ecrd3yZ4OesUy3roPwMvD192Xr2DBkex4e9naDPwh6iJat
         IWGKmUtw8Ler43eAzp3BPxyQQIgqnQkABY4gVUM8IIuIMuhWrE+GOn6OrTwnlI6ImB6u
         GW6gCcF4o9aw93LgSvIS2mxhirzVlPFQH4fDwQaONQodoo/DkiWJtEU6HscgFeU2Tmuq
         ED1O2Ty4YIKcIuoh4ustlTxUhVe+3xG9SI2pDbqhW4OsGuEuMgIm8VEBQ4FfnMe/ml+l
         rCPA==
X-Forwarded-Encrypted: i=1; AJvYcCUOCAHa8coHbpEQ1NVaOvB7gX0+uHJn/jddMAYuAfGnvP9fZsUNEmxSroutjAsE8ohouwuL1vNA2m85uoJRguHn@vger.kernel.org
X-Gm-Message-State: AOJu0Yz3G73WkUDm/r69qEnRV5/Cx8AvjmR7D/i1i/hpDUjNb+RObG55
	QM6o9TZAwwU7zq15X6hRHw4cHpYHjsZo1kinS07Xks4U9VR2Y6ktt+yn0K0uuA==
X-Gm-Gg: ASbGncu98fHqVRqb6RMh4HKH/lQKAOFgoyx84/yYk6BCXzHO8goRKynudmxoRA0a6TS
	5xPEX0wrSZtccM6V4O92pZippLMDqaH6AFgYv4sA4E8/XWu17Bzkjg0cNNKtjZHWhcnDH28us2w
	TuLfq258FCu0tcvngI8gW/R/1h1txrs7gppyxzLY5wGppssZ5FN7b5lLzbs4HnWXUEeUsNbpXWG
	No0o6m4LSZ1qWBjEfBT7fh+oVDbCBY/4ZeUokme+zi7NwLYtCgQRRO6Kq0UiFjaLQXB93sTulMI
	BAY0dfaIvPwk6TO0WNGHT3ks0sW9RIluaMjX
X-Google-Smtp-Source: AGHT+IFbyIk/t2FBVqbowzwmc33Cu/Xhw0HHnO9qzMEv+9/uViTPYk/jm8Aw+qCax7VxnPMgSI0asg==
X-Received: by 2002:a17:90b:3506:b0:2ee:dcf6:1c77 with SMTP id 98e67ed59e1d1-2fe7e33b210mr241444a91.16.1740503708928;
        Tue, 25 Feb 2025 09:15:08 -0800 (PST)
Received: from thinkpad ([120.60.68.212])
        by smtp.gmail.com with ESMTPSA id 98e67ed59e1d1-2fceae302e7sm8889686a91.0.2025.02.25.09.15.03
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 25 Feb 2025 09:15:08 -0800 (PST)
Date: Tue, 25 Feb 2025 22:45:01 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Niklas Cassel <cassel@kernel.org>
Cc: Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	kw@linux.com, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	fan.ni@samsung.com, nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 0/5] Add support for debugfs based RAS DES feature in
 PCIe DW
Message-ID: <20250225171501.ahjmawunnpyc7wwa@thinkpad>
References: <CGME20250221132011epcas5p4dea1e9ae5c09afaabcd1822f3a7d15c5@epcas5p4.samsung.com>
 <20250221131548.59616-1-shradha.t@samsung.com>
 <Z7yniizCTdBvUBI0@ryzen>
 <20250225082835.dl4yleybs3emyboq@thinkpad>
 <Z73VLYudJVPkdbGN@ryzen>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <Z73VLYudJVPkdbGN@ryzen>

On Tue, Feb 25, 2025 at 03:35:25PM +0100, Niklas Cassel wrote:
> On Tue, Feb 25, 2025 at 01:58:35PM +0530, Manivannan Sadhasivam wrote:
> > On Mon, Feb 24, 2025 at 06:08:26PM +0100, Niklas Cassel wrote:
> > > Hello Shradha,
> > > 
> > > On Fri, Feb 21, 2025 at 06:45:43PM +0530, Shradha Todi wrote:
> > > > DesignWare controller provides a vendor specific extended capability
> > > > called RASDES as an IP feature. This extended capability  provides
> > > > hardware information like:
> > > >  - Debug registers to know the state of the link or controller. 
> > > >  - Error injection mechanisms to inject various PCIe errors including
> > > >    sequence number, CRC
> > > >  - Statistical counters to know how many times a particular event
> > > >    occurred
> > > > 
> > > > However, in Linux we do not have any generic or custom support to be
> > > > able to use this feature in an efficient manner. This is the reason we
> > > > are proposing this framework. Debug and bring up time of high-speed IPs
> > > > are highly dependent on costlier hardware analyzers and this solution
> > > > will in some ways help to reduce the HW analyzer usage.
> > > > 
> > > > The debugfs entries can be used to get information about underlying
> > > > hardware and can be shared with user space. Separate debugfs entries has
> > > > been created to cater to all the DES hooks provided by the controller.
> > > > The debugfs entries interacts with the RASDES registers in the required
> > > > sequence and provides the meaningful data to the user. This eases the
> > > > effort to understand and use the register information for debugging.
> > > > 
> > > > This series creates a generic debugfs framework for DesignWare PCIe
> > > > controllers where other debug features apart from RASDES can also be
> > > > added as and when required.
> > > > 
> > > > v7:
> > > >     - Moved the patches to make finding VSEC IDs common from Mani's patchset [1]
> > > >       into this series to remove dependancy as discussed
> > > >     - Addressed style related change requests from v6
> > > 
> > > I tested this series, and one thing that I noticed:
> > > 
> > > # for f in /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/counter_enable; do echo 1 > $f; done
> > > 
> > > # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/ctl_skp_os_parity_err/counter_enable:Counter Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/deskew_uncompleted_err/counter_enable:Counter Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/framing_err_in_l0/counter_enable:Counter Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/margin_crc_parity_err/counter_enable:Counter Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_1st/counter_enable:Counter Disabled
> > > /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/retimer_parity_err_2nd/counter_enable:Counter Disabled
> > > 
> > > that there are some events that cannot be enabled when testing on my platform,
> > > rk3588, perhaps this is because my version of the DWC IP does not have these
> > > events.
> > > 
> > > (Because all the other events can be enabled successfully:
> > > # grep "" /sys/kernel/debug/dwc_pcie_a40000000.pcie/rasdes_event_counter/*/* | grep Enabled | wc -l
> > > 29
> > > )
> > > 
> > > 
> > > So the question is, how do we want to handle that?
> > >
> > 
> > This is a really good question.
> >  
> > > E.g. counter_enable_write() could theoretically read back the
> > > dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG);
> > > register after doing the
> > > ww_pcie_writel_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_CTRL_REG, val);
> > > 
> > > to actually check if it could enable the event.
> > > 
> > > If counter_enable_write() could not enable the specific event, should it
> > > perhaps return a failure to user space?
> > > 
> > 
> > Yes, it would be appropriate to return -EOPNOTSUPP in that case. But I'd like to
> > merge this series asap. So this patch can come on top of this series.
> 
> I agree that returning an error is probably the nicest thing.
> 
> However, this series has been picked up already :)
> 
> Is there anyone who volunteers on implementing the proposed feature?
> 

I did and submitted the fix [1].

> If you have time, it would be interesting to see if you see the same behavior
> on QCOM SoCs. (Assuming that your DWC PCIe controller does not implement all
> events that Samsung DWC PCIe controller does.)
> 

Yeah, I observed the same behavior on the Qcom platform, though only 2 counters
were not supported. But I also noticed a null ptr dereference due to refclk
dependency, so submitted a fix for that also.

- Mani

[1] https://lore.kernel.org/linux-pci/20250225171239.19574-1-manivannan.sadhasivam@linaro.org/

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout2.samsung.com (mailout2.samsung.com [203.254.224.25])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EF147839F4
	for <linux-perf-users@vger.kernel.org>; Sat,  8 Mar 2025 16:00:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.25
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741449633; cv=none; b=hrRcfK8+RguR9fbdlgD2NHzNQBVHrBxE6lzuyCV0dr4Z/ngamHmZQs5j1IYySA2wdMyIlAPCnLLodMxIAfVDwyp575+/kK5NPxtOmsj+xS8Rz+k+sWMowxZAw5c4fMhYvD4p2mnbAePvmObZB6d5ct2x0W5N1p/2NLvbDS4QLYA=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741449633; c=relaxed/simple;
	bh=x2Kk7zM0eOg+x2C4vQ/WSq9xOyqsqVq7QtUIFCoh00Q=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=XGuwgX4ktsMbg79BdaSMV8axy4ghNleRPgjIM96xgF7nGt3r4NTGQHnLlsUCq8dy1BdODev8kChCpL+DnAPWlTzm0YY0Ml1ED6oAAeOlcN6zvblNL4fxIRIbFCwsgNvLCPE95axx3/iiQ7KaNMbqpamcZLlSnXMoCtSLRHix1bw=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=p8tH4Cgy; arc=none smtp.client-ip=203.254.224.25
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="p8tH4Cgy"
Received: from epcas5p1.samsung.com (unknown [182.195.41.39])
	by mailout2.samsung.com (KnoxPortal) with ESMTP id 20250308155411epoutp020e662cfaeddb2554ffae82e8dd07d445~q3t4fwKi40383103831epoutp02b
	for <linux-perf-users@vger.kernel.org>; Sat,  8 Mar 2025 15:54:11 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.samsung.com 20250308155411epoutp020e662cfaeddb2554ffae82e8dd07d445~q3t4fwKi40383103831epoutp02b
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741449251;
	bh=x2Kk7zM0eOg+x2C4vQ/WSq9xOyqsqVq7QtUIFCoh00Q=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=p8tH4CgyJFH6eqasRyYeM3RAuXuKF/5JGxOiakhX29CtDdG+g8ni1x1kVob47+y42
	 ho5MrYSAHHwSz+w5q63081gK5gsaxl2Nwsth735NvODZaDjDLviHqIS2r1yfL2mJIx
	 vnzPdsBlVUqHupzEbH6zMurPdsFb/QcMCWRGkhKo=
Received: from epsnrtp3.localdomain (unknown [182.195.42.164]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250308155409epcas5p31ec0bded70d0235ef1078dad3134d8b0~q3t27g-tx2173221732epcas5p3l;
	Sat,  8 Mar 2025 15:54:09 +0000 (GMT)
Received: from epsmges5p1new.samsung.com (unknown [182.195.38.176]) by
	epsnrtp3.localdomain (Postfix) with ESMTP id 4Z974b6Tccz4x9Pp; Sat,  8 Mar
	2025 15:54:07 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmges5p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	2D.91.20052.F186CC76; Sun,  9 Mar 2025 00:54:07 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTPA id
	20250307094754epcas5p49b48fe616b8f4cbe880f979fa1341708~qfEyNozm60463904639epcas5p4-;
	Fri,  7 Mar 2025 09:47:54 +0000 (GMT)
Received: from epsmgms1p1new.samsung.com (unknown [182.195.42.41]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250307094754epsmtrp20a5e1096d994e76a5c86cef66f52243d~qfEyMlfzP2554325543epsmtrp2T;
	Fri,  7 Mar 2025 09:47:54 +0000 (GMT)
X-AuditID: b6c32a49-3d20270000004e54-5d-67cc681f2b8f
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgms1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	2F.E4.18729.9C0CAC76; Fri,  7 Mar 2025 18:47:53 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip2.samsung.com
	(KnoxPortal) with ESMTPA id
	20250307094751epsmtip280ce2f05b4121b89120543ee4f99d4b0~qfEvdJFPB3075730757epsmtip2l;
	Fri,  7 Mar 2025 09:47:51 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: "'Fan Ni'" <nifan.cxl@gmail.com>
Cc: =?UTF-8?Q?'Krzysztof_Wilczy=C5=84ski'?= <kw@linux.com>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<linux-arm-kernel@lists.infradead.org>, <linux-perf-users@vger.kernel.org>,
	<manivannan.sadhasivam@linaro.org>, <lpieralisi@kernel.org>,
	<robh@kernel.org>, <bhelgaas@google.com>, <jingoohan1@gmail.com>,
	<Jonathan.Cameron@huawei.com>, <a.manzanares@samsung.com>,
	<pankaj.dubey@samsung.com>, <cassel@kernel.org>, <18255117159@163.com>,
	<xueshuai@linux.alibaba.com>, <renyu.zj@linux.alibaba.com>,
	<will@kernel.org>, <mark.rutland@arm.com>
In-Reply-To: <Z8fSWcR_aXyxmFEZ@debian>
Subject: RE: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Date: Fri, 7 Mar 2025 15:17:50 +0530
Message-ID: <075501db8f45$ff6f9620$fe4ec260$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQJfby7SiE0e/TbLvAHLJIl0P7SXpgHkH4XnAk8q5KUB3hA60AHBUHtxAYzlJhAB7JKozgKp5GvQse/7dKA=
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA01Te0xTVxzO6W1vC1pzrQWOxE12fSyIPAptd7sAI5txd4MpmXNLSBxe4Kwl
	lNumD9kjKowyAkEEpwGqYRYrAoIsRV7KS0AZCCMLDYYBnXM4cYy5ASMwZFtLy8Z/3+873/l9
	v++c/ASYaAn3F6SyBqRjGTWJe3ObegJfDt6pGlSGZV0Ipey5K3yqpOclyvq5irpXVIVRVQtl
	fKrGMopTmQUrPMr20yiPGrl1CaeGyvtwyt54g0uZnpu41KQpj0ddffAdh1ptagdUReMCn7Jk
	PwXUP20tfMo0IaOeLTfgMWL6StV5Hl1bXgvoVvMkn75sM9Km3lkebavJw+mJ0Tacbv1RQU/Z
	Szh0g/U0XXizBtDzthfjNyekRaoQk4J0AYhN1qSkssooMvZI4huJMnmYJFiioF4hA1gmHUWR
	B+Ligw+mqp0hyYATjNropOIZvZ4MjY7UaYwGFKDS6A1RJNKmqLVSbYieSdcbWWUIiwyvSsLC
	wmVO4fE0lWWxi6+dC/94ds7OyQT1knzgJYCEFJbNZvHygbdARNwG8Iu/xrjuYg7Azou9HHex
	COD8QB93/Uqdfcajagdw6dcnuLuYBrC/oGNNhRP74ZT9OebCYmI3XLJXApcII9q4cCzn/NqB
	F7EXPn1yhp8PBIJtxLtw8I89Lprr1H/zswV30UJCAW3PUl20kNgK+8um1tpjRBCstMxg7oEC
	4PLjSp5LLiaS4PAMdEv84N3lAszlColrXrC+zuoJcAA+GFzlu/E2+EvfTQ/2h/O/teNurITV
	DaWe/mq42GDluPFrsMt+ievywohAWH8r1E2/AC8M3OC4fbfAMytTHrkQtpSv411wYbXNM8J2
	WH5vhFcESPOGZOYNycwbIpj/d7sMuDVgO9Lq05VIL9NKWJTx338na9JtYG0F9r3VAiYf/h7S
	DTgC0A2gACPFwr3NA0qRMIX55FOk0yTqjGqk7wYy52sXY/4+yRrnDrGGRIlUESaVy+VSRYRc
	QvoJs1tNShGhZAwoDSEt0q3f4wi8/DM5ddLAzRNnhbUn76yGb/EtCC++7pdYbesIOeHgi4sj
	RJ3GoObxk3feaRRadozdz3Uk9c1GHCs2zCxcVQthqObcTCMaHfIbLz32VSebo+lvjWsbfvjn
	fPPru2VHUmLZvNhTPXkidpOvtHBsE4i+WNWV9mYC+gD5+FIfnYqxlvrKZ3MDv7WUEocMEYr9
	3sHL4qoY2eHv67cW7URDS48S7p42H9cxLenjA007ciqID69Nf73ydm/3uZz58p4OugRzeDXG
	cY+OWMfOZkZW/63I+MERuIeNHA69vfS4Im1XULa9oeNgRldRkg2ffh8ao9SfjaPCL33uRx/N
	is6kD11/75HDQXL1KkayD9PpmX8BI1MvCosEAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFrrPIsWRmVeSWpSXmKPExsWy7bCSvO7JA6fSDR48sbG40v6b3WL6YUWL
	JU0ZFscmrGC2WPFlJrvFqoXX2Cwaen6zWmx6fI3V4vKuOWwWZ+cdZ7O4snUdi0XLnxYWi7st
	nawWS69fZLL4u20vo8WirV/YLRY2v2S0+L9nB7tFyx1Ti/c/N7M5iHgsXjGF1WPNvDWMHjtn
	3WX3WLCp1KPlyFtWj02rOtk87lzbw+ax86Glx5Mr05k8Ni+p9+jbsorR4/MmuQCeKC6blNSc
	zLLUIn27BK6M86t2Mhc8VK5oWzSZtYHxmUwXIyeHhICJxNorr1lAbCGB3YwSV+4EQMQlJT5f
	XMcEYQtLrPz3nL2LkQuo5hmjxMWTL1lBEmwCOhJPrvxhBrFFBFQkflxZxghSxCxwgUWia8Fd
	Voipd5gkJh0wBrE5BdQkXj7vZQexhQUCJH5u6gdrZgFqPvFsIVsXIwcHr4ClxKb3mSBhXgFB
	iZMzn4AdxyygLdH7sJURxl628DUzxHEKEj+fLmMFaRURSJI4/1oCokRc4ujPHuYJjMKzkEya
	hWTSLCSTZiFpWcDIsopRMrWgODc9t9iwwDAvtVyvODG3uDQvXS85P3cTIzgNaGnuYNy+6oPe
	IUYmDsZDjBIczEoivGrbT6UL8aYkVlalFuXHF5XmpBYfYpTmYFES5xV/0ZsiJJCeWJKanZpa
	kFoEk2Xi4JRqYGp4cYvpRKBbxsXti15M/haQE3swIUPuD0+x0JmExvMnyz6FzvTe1N7l0/Ns
	8oZTUpVRfHYf/p6xKq+Z150soFEruadlZUSRpGLMw2kPHkxoWaH5T+TDv5Svezx6PTbvSjI7
	GMbsddc48Ere+gtN+pcdo+/OT73dFlT1zZvNpEZJRHe10I5JHywu/i/Zn6+a9m+91s8WPqsr
	k39KiQpEvuxQNJklv0/YoXX69BMFB52/9U9e82qOijvfs5X/otw27l00cdmjnJ8pFs8rl2ju
	cp2Voeh+0+/8igu24n+ztj08Jb7NsNgv9JOTjcCxdv9Xs69uZqr898/qfde9+CifjydL/c4Z
	aVS0iB/TLYs4vVaJpTgj0VCLuag4EQCVKSVzcgMAAA==
X-CMS-MailID: 20250307094754epcas5p49b48fe616b8f4cbe880f979fa1341708
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132043epcas5p27fde98558b13b3311cdc467e8f246380
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
	<20250221131548.59616-6-shradha.t@samsung.com> <Z8XuuNb6TRevUlHH@debian>
	<20250303194228.GB1552306@rocinante> <Z8YZEALV71PUkXpF@debian>
	<061401db8d28$5f0a4b40$1d1ee1c0$@samsung.com> <Z8fSWcR_aXyxmFEZ@debian>



> -----Original Message-----
> From: Fan Ni <nifan.cxl=40gmail.com>
> Sent: 05 March 2025 09:56
> To: Shradha Todi <shradha.t=40samsung.com>
> Cc: 'Fan Ni' <nifan.cxl=40gmail.com>; 'Krzysztof Wilczy=C5=84ski'=20<kw=
=40linux.com>;=20linux-kernel=40vger.kernel.org;=20linux-pci=40vger.kernel.=
org;=0D=0A>=20linux-arm-kernel=40lists.infradead.org;=20linux-perf-users=40=
vger.kernel.org;=20manivannan.sadhasivam=40linaro.org;=20lpieralisi=40kerne=
l.org;=0D=0A>=20robh=40kernel.org;=20bhelgaas=40google.com;=20jingoohan1=40=
gmail.com;=20Jonathan.Cameron=40huawei.com;=20a.manzanares=40samsung.com;=
=0D=0A>=20pankaj.dubey=40samsung.com;=20cassel=40kernel.org;=2018255117159=
=40163.com;=20xueshuai=40linux.alibaba.com;=20renyu.zj=40linux.alibaba.com;=
=0D=0A>=20will=40kernel.org;=20mark.rutland=40arm.com=0D=0A>=20Subject:=20R=
e:=20=5BPATCH=20v7=205/5=5D=20Add=20debugfs=20based=20statistical=20counter=
=20support=20in=20DWC=0D=0A>=20=0D=0A>=20On=20Tue,=20Mar=2004,=202025=20at=
=2010:40:43PM=20+0530,=20Shradha=20Todi=20wrote:=0D=0A>=20>=0D=0A>=20>=0D=
=0A>=20>=20>=20-----Original=20Message-----=0D=0A>=20>=20>=20From:=20Fan=20=
Ni=20<nifan.cxl=40gmail.com>=0D=0A>=20>=20>=20Sent:=2004=20March=202025=200=
2:33=0D=0A>=20>=20>=20To:=20Krzysztof=20Wilczy=C5=84ski=20<kw=40linux.com>=
=0D=0A>=20>=20>=20Cc:=20Fan=20Ni=20<nifan.cxl=40gmail.com>;=20Shradha=20Tod=
i=0D=0A>=20>=20>=20<shradha.t=40samsung.com>;=20linux-kernel=40vger.kernel.=
org;=20linux-=0D=0A>=20>=20>=20pci=40vger.kernel.org;=20linux-arm-kernel=40=
lists.infradead.org;=0D=0A>=20>=20>=20linux-perf-users=40vger.kernel.org;=
=20manivannan.sadhasivam=40linaro.org;=0D=0A>=20>=20>=20lpieralisi=40kernel=
.org;=20robh=40kernel.org;=20bhelgaas=40google.com;=0D=0A>=20>=20>=20jingoo=
han1=40gmail.com;=20Jonathan.Cameron=40huawei.com;=0D=0A>=20>=20>=20a.manza=
nares=40samsung.com;=20pankaj.dubey=40samsung.com;=0D=0A>=20>=20>=20cassel=
=40kernel.org;=2018255117159=40163.com;=20xueshuai=40linux.alibaba.com;=0D=
=0A>=20>=20>=20renyu.zj=40linux.alibaba.com;=20will=40kernel.org;=20mark.ru=
tland=40arm.com=0D=0A>=20>=20>=20Subject:=20Re:=20=5BPATCH=20v7=205/5=5D=20=
Add=20debugfs=20based=20statistical=20counter=0D=0A>=20>=20>=20support=20in=
=20DWC=0D=0A>=20>=20>=0D=0A>=20>=20>=20On=20Tue,=20Mar=2004,=202025=20at=20=
04:42:28AM=20+0900,=20Krzysztof=20Wilczy=C5=84ski=20wrote:=0D=0A>=20>=20>=
=20>=20Hello,=0D=0A>=20>=20>=20>=0D=0A>=20>=20>=20>=20=5B...=5D=0D=0A>=20>=
=20>=20>=20>=20>=20+static=20ssize_t=20counter_value_read(struct=20file=20*=
file,=20char=0D=0A>=20>=20>=20>=20>=20>=20+__user=20*buf,=20size_t=20count,=
=20loff_t=20*ppos)=20=7B=0D=0A>=20>=20>=20>=20>=20>=20+=09struct=20dwc_pcie=
_rasdes_priv=20*pdata=20=3D=20file->private_data;=0D=0A>=20>=20>=20>=20>=20=
>=20+=09struct=20dw_pcie=20*pci=20=3D=20pdata->pci;=0D=0A>=20>=20>=20>=20>=
=20>=20+=09struct=20dwc_pcie_rasdes_info=20*rinfo=20=3D=20pci->debugfs->ras=
des_info;=0D=0A>=20>=20>=20>=20>=20>=20+=09char=20debugfs_buf=5BDWC_DEBUGFS=
_BUF_MAX=5D;=0D=0A>=20>=20>=20>=20>=20>=20+=09ssize_t=20pos;=0D=0A>=20>=20>=
=20>=20>=20>=20+=09u32=20val;=0D=0A>=20>=20>=20>=20>=20>=20+=0D=0A>=20>=20>=
=20>=20>=20>=20+=09mutex_lock(&rinfo->reg_event_lock);=0D=0A>=20>=20>=20>=
=20>=20>=20+=09set_event_number(pdata,=20pci,=20rinfo);=0D=0A>=20>=20>=20>=
=20>=20>=20+=09val=20=3D=20dw_pcie_readl_dbi(pci,=20rinfo->ras_cap_offset=
=20+=20RAS_DES_EVENT_COUNTER_DATA_REG);=0D=0A>=20>=20>=20>=20>=20>=20+=09mu=
tex_unlock(&rinfo->reg_event_lock);=0D=0A>=20>=20>=20>=20>=20>=20+=09pos=20=
=3D=20scnprintf(debugfs_buf,=20DWC_DEBUGFS_BUF_MAX,=20=22Counter=0D=0A>=20>=
=20>=20>=20>=20>=20+value:=20%d=5Cn=22,=20val);=0D=0A>=20>=20>=20>=20>=20>=
=20+=0D=0A>=20>=20>=20>=20>=20>=20+=09return=20simple_read_from_buffer(buf,=
=20count,=20ppos,=0D=0A>=20>=20>=20>=20>=20>=20+debugfs_buf,=20pos);=20=7D=
=0D=0A>=20>=20>=20>=20>=0D=0A>=20>=20>=20>=20>=20Do=20we=20need=20to=20chec=
k=20whether=20the=20counter=20is=20enabled=20or=20not=20for=0D=0A>=20>=20>=
=20>=20>=20the=20event=20before=20retrieving=20the=20counter=20value?=0D=0A=
>=20>=20>=20>=0D=0A>=20>=20>=20>=20I=20believe,=20we=20have=20a=20patch=20t=
hat=20aims=20to=20address,=20have=20a=20look=20at:=0D=0A>=20>=20>=20>=0D=0A=
>=20>=20>=20>=0D=0A>=20>=20>=20>=20https://lore.kernel.org/linux-pci/202502=
25171239.19574-1-manivanna=0D=0A>=20>=20>=20>=20n.sa=0D=0A>=20>=20>=20>=20d=
hasivam=40linaro.org=0D=0A>=20>=20>=0D=0A>=20>=20>=20Maybe=20I=20missed=20s=
omething,=20that=20seems=20to=20fix=20counter_enable_read(),=20but=20here=
=20is=20to=20retrieve=20counter=20value.=0D=0A>=20>=20>=20How=20dw_pcie_rea=
dl_dbi()=20can=20return=20something=20like=20=22Counter=20Disabled=22?=0D=
=0A>=20>=20>=0D=0A>=20>=20>=20Fan=0D=0A>=20>=0D=0A>=20>=20Hey=20Fan,=0D=0A>=
=20>=20So=20the=20counter=20value=20will=20show=200=20in=20case=20it=20is=
=20disabled=20so=20there=20will=0D=0A>=20>=20not=20be=20any=20issues=20as=
=20per=20say.=20We=20could=20add=20the=20check=20here=20but=20I=20feel=20I=
=0D=0A>=20>=20have=20already=20exposed=20the=20functionality=20to=20check=
=20if=20a=20counter=20is=20enabled=20or=20disabled,=20(by=20reading=20the=
=20counter_enable=20debugfs=20entry)=0D=0A>=20so=20this=20could=20be=20hand=
led=20in=20user=20space=20to=20only=20read=20the=20counter=20if=20it's=20en=
abled.=0D=0A>=20Ok.=0D=0A>=20Returning=200=20when=20the=20counter=20is=20di=
sabled=20makes=20sense=20to=20me.=0D=0A>=20=0D=0A>=20Just=20some=20thought.=
=0D=0A>=20=0D=0A>=20It=20seems=20natural=20to=20me=20if=20we=20make=20=22co=
unter_value=22=20only=20visiable=20to=20users=20when=20the=20counter=20is=
=20enabled.=0D=0A>=20=0D=0A=0D=0AHey=20Fan,=0D=0A=0D=0AThis=20looks=20like=
=20a=20good=20suggestion=20to=20me.=20I=20have=20implemented=20this=20and=
=20in=20the=20process=20of=20testing.=20Since=20there=20is=20no=20support=
=20in=20the=0D=0Adebugfs=20framework=20for=20conditionally=20hiding=20certa=
in=20files=20from=20user,=20the=20custom=20implementation=20is=20a=20little=
=20tricky=20and=20will=20need=20some=0D=0Adiscussion=20before=20taking=20in=
.=20So=20let's=20take=20this=20up=20as=20a=20top=20up=20patch=20and=20live=
=20with=20returning=200=20when=20the=20counter=20is=20disabled=20for=20now?=
=0D=0A=0D=0AThanks=20a=20lot=20for=20the=20suggestion.=0D=0AShradha=20=0D=
=0A=0D=0A>=20Fan=0D=0A>=20>=0D=0A>=20>=20>=20>=0D=0A>=20>=20>=20>=20Thank=
=20you=21=0D=0A>=20>=20>=20>=0D=0A>=20>=20>=20>=20=09Krzysztof=0D=0A>=20>=
=0D=0A>=20>=0D=0A=0D=0A

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4C9F81957E4;
	Wed,  5 Mar 2025 17:38:27 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741196308; cv=none; b=phtqB1s79B2bE4A09sLigSPxYO39gKSBNxV7biwjEdBZhZQ0JCzdFLy7l0j8P8irNuKzge2qVCyRQwwexExZg9cjE1Qv7D1QCyhj1eQ+10D718aT9bBMHu3F1pI/ugTWrCPGHPlMMLESquV6RJU9cSrjKSSULy4I7Ne6wuM3Xrs=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741196308; c=relaxed/simple;
	bh=ijeMNbdG6/t/MFEhbiYg7NxdfQyaCwL0KeoeZZihREw=;
	h=Date:From:To:Cc:Subject:Message-ID:MIME-Version:Content-Type:
	 Content-Disposition:In-Reply-To; b=tHrEvKlb228smlQ92OXil3HgWWRFK44eontkbughOoXJfGJBPHMgomgXlOEls+nNLyWBWPn9i+0zEywIG/KyQL133uq8mNZyGb2wbdqZhJqD8Ue2KabQf1r0BnVD5BEMR49dbd2xxUa1Ar5jpfPx0hCwd3KDg90JzxBwQ/Xg8m0=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=TV3flwBU; arc=none smtp.client-ip=10.30.226.201
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="TV3flwBU"
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 906A8C4CED1;
	Wed,  5 Mar 2025 17:38:27 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1741196307;
	bh=ijeMNbdG6/t/MFEhbiYg7NxdfQyaCwL0KeoeZZihREw=;
	h=Date:From:To:Cc:Subject:In-Reply-To:From;
	b=TV3flwBUO/G0FQf09lT08iTdwkyHwQLxOvyCqIuBuMonT1GOwm0cUoemhaPTTHeix
	 h+8jch8k0QjY3uKAtLRojI7MG+hBjyNZ702wCXv2vaLEbYNJVD0++H/MhU33skYvp3
	 7quINAI0nSkLMZ6a32qOQKcn+Faf0eFW03TjGB52SmUHh/l+w0PQgL7Q5H489hEgZy
	 AL0uN49J4r0jqbO9L/62YHpoW6QE1Gzqo3Ifnxki16OdKKp78RkRCluQYYiioTTVqS
	 T7gISCH9FLq5trvXbfXhw+9xoxwOGynufWk1wMnppCXeDJmuuJncKkgnHJODMYbjna
	 NOYdAqxliI+Jg==
Date: Wed, 5 Mar 2025 11:38:26 -0600
From: Bjorn Helgaas <helgaas@kernel.org>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>,
	Geert Uytterhoeven <geert@linux-m68k.org>,
	Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250305173826.GA303920@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250304171154.njoygsvfd567pb66@thinkpad>

On Tue, Mar 04, 2025 at 10:41:54PM +0530, Manivannan Sadhasivam wrote:
> On Wed, Mar 05, 2025 at 12:46:38AM +0900, Krzysztof WilczyÅ„ski wrote:
> > > On Mon, 3 Mar 2025 at 20:47, Krzysztof WilczyÅ„ski <kw@linux.com> wrote:
> > > > [...]
> > > > > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > > > > +{
> > > > > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > > > > +   struct device *dev = pci->dev;
> > > > > > +   struct debugfs_info *debugfs;
> > > > > > +   struct dentry *dir;
> > > > > > +   int ret;
> > > > > > +
> > > > > > +   /* Create main directory for each platform driver */
> > > > > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > > > > +   dir = debugfs_create_dir(dirname, NULL);
> > > > > > +   debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > > > > +   if (!debugfs)
> > > > > > +           return -ENOMEM;
> > > > > > +
> > > > > > +   debugfs->debug_dir = dir;
> > > > > > +   pci->debugfs = debugfs;
> > > > > > +   ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > > > > +   if (ret)
> > > > > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> > > > >
> > > > > What will happen if ret != 0? still return 0?
> > > 
> > > And that is exactly what happens on Gray Hawk Single with R-Car
> > > V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
> > > dwc_pcie_rasdes_debugfs_init() to return -ENODEV.
> > > 
> > > Debugfs issues should never be propagated upstream!
> ...

> > > So while applying, you changed this like:
> > > 
> > >             ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > >     -       if (ret)
> > >     -               dev_dbg(dev, "RASDES debugfs init failed\n");
> > >     +       if (ret) {
> > >     +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
> > >     +               return ret;
> > >     +       }
> > > 
> > >             return 0;
> > > 
> > > Hence this is now a fatal error, causing the probe to fail.

> Even though debugfs_init() failure is not supposed to fail the probe(),
> dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
> failure would be canolically correct IMO.

I'm not sure about this.  What's the requirement to propagate
devm_kzalloc() failures?  I think devres will free any allocs that
were successful regardless.

IIUC, we resolved the Gray Hawk Single issue by changing
dwc_pcie_rasdes_debugfs_init() to return success without doing
anything when there's no RAS DES Capability.

But dwc_pcie_debugfs_init() can still return failure, and that still
causes dw_pcie_ep_init_registers() to fail, which breaks the "don't
propagate debugfs issues upstream" rule:

  int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
  {
          ...
          ret = dwc_pcie_debugfs_init(pci);
          if (ret)
                  goto err_remove_edma;

          return 0;

  err_remove_edma:
          dw_pcie_edma_remove(pci);

          return ret;
  }

We can say that kzalloc() failure should "never" happen, and therefore
it's OK to fail the driver probe if it happens, but that doesn't seem
like a strong argument for breaking the "don't propagate debugfs
issues" rule.  And someday there may be other kinds of failures from
dwc_pcie_debugfs_init().

Bjorn

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f178.google.com (mail-pl1-f178.google.com [209.85.214.178])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 89E651F03D2;
	Wed,  5 Mar 2025 07:44:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.178
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741160692; cv=none; b=YNimkBcJeKsmASv202Z09dQyeR2Ny1EHRLhTYVWe8MJmjNR/UbgbIr7HXXQRyvB6grDbgoRe6jT75Wj2LyeyUJWX7/bhveo5dDFLEFx0a4w5zFV0Xr5DPpYQvj/AmC+KTAV4aH2zfRy90N0orvx8nc3TDn/4vtJt3nXJsw2zAHY=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741160692; c=relaxed/simple;
	bh=0dEcLmlYtdtIaBCfzqrBq2Ae4dODzcrZobeRn4yhLFg=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=GF2QzSuvsCwDViQ3+zNQ6ylrDIIdFRaNUzOTokAfRjeXMr2jaEWa86BuYh6ByTnjiG+RQn+AodlKnPM4CnSWy9JxUNsr/Uw1uL8dnsqY5BM8W+L4AhEYFIy1ntlvmLNzl5Lq/nSwJrdI3Slsy6KdWArGN1/jZkHzdMYhU5AgRLM=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.178
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f178.google.com with SMTP id d9443c01a7336-2237cf6a45dso65606935ad.2;
        Tue, 04 Mar 2025 23:44:50 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741160690; x=1741765490;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=ViTLKygErdiplFKeTsB+hgfn7l7mcJeHlaXg11bXs0I=;
        b=ICnVA/lI15SR0GYd53vYgStM//mchS4Tf5MQFSNEHDJd9jGGXegecutAub9nxklcTY
         nPemPuhTg7A/zYw5dUpLqkBmyM+sesz43csIs9uVM0/jm1hOBhZJPAUv1W86AH8Ra0Ya
         8+Z1x+/5wTw1B/MZ9K35QJtfkuQ0bg3EQ7uZ8ZIw1JYMfgYxTmNIGOOMwbF2qc5SZhkd
         uAGGvhA8z+Gcv6UNa/ki3CKWEOJzK0zsQ8B6TJN9BNq5K0c8E0oG9n/WNW74CDZScaYM
         i1Ma998cq20KFCgzkNI02LjWijZ39d8e/O9wzX7Dyi7jhXgOhvlNfG0LjD8dsoHphgTP
         9GCQ==
X-Forwarded-Encrypted: i=1; AJvYcCVhezIr7hROfkYJRL8nqBJGnU6z+sOfBDNkik+jdIIpg9aLklD5NPFg75uqgTZd4OWCxhVuTGWvnpYs@vger.kernel.org, AJvYcCW8ejponUAColE/HAtl2SqLifIwQo/QapfYaBg3SGvaY5bW1+ApJN8K6W0X82Ao3qtSZxpvOmBEbFIZ2seXJRKCiVc=@vger.kernel.org, AJvYcCWvOwG3RRmsDS/EHQye7bYNpDNKyEIvqXbhbOAOaZMnxJwuu8OCTNYBn4JoChGFwfuv0ADFgPaFWJ1ibrY=@vger.kernel.org, AJvYcCXDTuGJZ27AfMKoB7RyeY/aA4VXO9+BGbDBhh13HUWcHDCfU6XHg4SM/K366/xoDagzvKmR4etoeAwmrcrJWLXWTw==@vger.kernel.org
X-Gm-Message-State: AOJu0YwHK7Zk9KTPKK3e+RrvrzcceVgEdmAoSJSrFz6o7FySb82Oithb
	naYeAVBQHJHw7M02rQbXT7RGt0nFMj4eZzkbCQol6IqGrtk+Xl4E
X-Gm-Gg: ASbGncvuMv5sFn4PUvcrEQ77fhlbJnCzdC5+0iBLcN+yTwjYwmPVoDthjTCDed8tPyD
	uLkU4LphHprGuOAYn2RqQRXiHVa+TAlk71FzaFL4f8rqnnWmkXzUJSf1PzioZietlW+yp8PGOyS
	mQR+QjHsQOi48pDjRy6XUfstgxO5tiyPpgJm9P8q9TLeiPiBSYtJKZKpxFyUhpWW+RgAuBAFwlm
	c7uSqBNxeIXE7gjR1JQGZQMv/G3HEVOBYpFe0fRE7FLkGZM1S7t+H8J6LY8A+Lw/pO/NnhzxUKW
	J+xjAuk2dmLMf7v+Ucg4AoV19WD9Lbg9Ijn05lNoW+Yd3z/4iiuvWBgJciXfq5fr1vrzNQ0MknJ
	8hmU=
X-Google-Smtp-Source: AGHT+IFkECmzs4mja49rj6DCPMiWTzRluzyzBjPs7V57SQJNUYO0IDGjrEZGfcUcPpPyncsq8K2mSA==
X-Received: by 2002:a17:902:f548:b0:220:f5d7:6405 with SMTP id d9443c01a7336-223f1c80b35mr33650085ad.16.1741160689723;
        Tue, 04 Mar 2025 23:44:49 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-223504c7efcsm107522695ad.154.2025.03.04.23.44.48
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 23:44:49 -0800 (PST)
Date: Wed, 5 Mar 2025 16:44:47 +0900
From: 'Krzysztof =?utf-8?Q?Wilczy=C5=84ski'?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: 'Geert Uytterhoeven' <geert@linux-m68k.org>,
	'Fan Ni' <nifan.cxl@gmail.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com,
	'Yoshihiro Shimoda' <yoshihiro.shimoda.uh@renesas.com>,
	'Linux-Renesas' <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250305074447.GC847772@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
 <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
 <20250304154638.GB2310180@rocinante>
 <061201db8d25$dd1e2bd0$975a8370$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <061201db8d25$dd1e2bd0$975a8370$@samsung.com>

Hello,

> I think we shouldn't move the log level to be a WARN. I believe many
> controllers might not support RAS DES feature in their design and giving
> a warn dump would draw unnecessary attention.

There will be no backtrack printed with neither dev_err() nor dev_warn(),
which is what we were using here.  Using dev_WARN() or the WARN() macro
directly would be an overkill in this case, indeed.

> My opinion is to silently let it fail unless the user is actually
> interested in getting the RAS DES feature up.

I think, what we have there now is fine.  We don't error on the lack of RAS
DES capability when the platform does not support it, and only return an
error following a memory allocation failure, which should ideally never
happen.

That said, have a look at the following:

  https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/log/?h=controller/dwc

This is how the code looks like at the moment.

We can still move it to dev_dbg(), so basically suppress any errors or
warnings from being printed outside of the debug log level, if you think
it would be better.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f175.google.com (mail-pl1-f175.google.com [209.85.214.175])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2188B84D08;
	Wed,  5 Mar 2025 07:26:35 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.175
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741159597; cv=none; b=fJcmP4uMiwFXx8Z4H6ThTC3gEwve7inhWSIdQI3/8ydoPGTVxZe7aJ8JcUZR8r8N9rN+wRjIOsJEV2ey5PqTNdtFw8eFZKwB7PFZ/phEgtQijDeXKG4ic53YjuQv58n/gShoGsF05KCLylM05yNr3Nj8r61ctDWKT10Ppyh6TFE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741159597; c=relaxed/simple;
	bh=o0D0OR4ETeM6TgdeTYRWURr8ShM7XjsdgCXgPgCLuM4=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=KU53z8t08RsV1GNY5vhKiDhKUSxtp+TJ/C2mu904iachPASXxmhB95VBI6N/5uBWtOj+fS9aJwU5a7b9/Eax9Dp1P1KBKAvte3hdC0ct+P0UB6hBcGXSx8LJEbHEqozPTCzrYpebXtF5Sw4XXXfs7dfgkgvYJ0b8uA+nXL/oVGE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.175
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f175.google.com with SMTP id d9443c01a7336-22185cddbffso8425615ad.1;
        Tue, 04 Mar 2025 23:26:35 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741159595; x=1741764395;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=HNgzDD9KflnZOadx5j+UnJGC4H2dSOBqjrhq830X+Ig=;
        b=E4qPt9Ks/f+Uvc8FREFMMebjgMcIObSLc+zefBI4uBeYI+aTlPtEPbDvXV5xwxjLu9
         8QfaTiq6K2tGoDAjmjmDwDYW6FCP5Jc449DduRHbJ9fZWDGJ1dHNMqfNjszRIsBAmvf+
         d2Ezhi3FZqT5HqfLwIvp8mryFCgWvPATWFVeLPG08c6vPRUK3NjDs4zrWv+HhxRMsHT0
         4jQ6/ja7W3bWiaAfMXiAnoEFQFe77jGplE7dlmgEKHac4XlDbiX9rux2eEszTqdQIJ4K
         1Wll+1WKtaPgs3EMoMvDjYCFU1Suq6yOU4Hp1FwWI6BOhHs1HdDYgMsbhwzd+Sg0Ipx9
         XM/Q==
X-Forwarded-Encrypted: i=1; AJvYcCU2CFkrOrtLjhA65HfjJJgmAqzGSjqbFr1aadGoi7TmNhXVo48Hv9pFurw5H24q+ygxsbkX4ebwaelt@vger.kernel.org, AJvYcCVHKSefhuxW6TycnHRDIF0D6PwkzHDoSPP7JBoSzt3iRkg9lF6mxhDgW4nBn+PDi5epFESscek934l2+fcoaVW8Kw==@vger.kernel.org, AJvYcCVwfSFwCMjFjoyXhz+elXRXM/AMN9uqTiCajTk5JxAJpY9WsrCWz3u5k8PM5yRVcsmFv08uotZqwfGI/PM=@vger.kernel.org
X-Gm-Message-State: AOJu0YxXkWyrQqNgT57VPOBYaNsJhH/ksLf22bpB7ZxNxBsiJn3X3iMR
	ZL7pTMUJb/FS3/RVp3ihGB77I0QJJ6jHzO+PpAf8D1g5HKJjZ1NbLB7HQpKpAt4=
X-Gm-Gg: ASbGncvsLLathL468EIz478vQir7pTYgd/1TW8tB/HvpqcVzJ4OEz0VIerF69quzc9E
	oCzAdg+wFT1Z+vs37rlL4Ru/2Tak+ACFUkWzCPsQdoDVUg5tcV1mN4kGJ+OuyZ2g6ftd7RLzSJz
	K+AaPL/DQD5KqncwtLQ6OvW1WD7/XjLdkQAW56TxImb9XQ5xfvCf6FfvfNVJUfne74z9xRhmJ1J
	vLqpVKI2QQyvdA2gms0W4yQT3KX0+1RIgxuany4hThSAarr6cj/j+IT99X4QF5ykSQVkNPQ8P0S
	DUC8WRoDU7eKbAXajVEy3I+at/V6s0iebI5/mtn4FoGtL8QH9l+6SNpzBsqMT9vGW3wEuXVAp14
	bj0g=
X-Google-Smtp-Source: AGHT+IH4t9c1giK1O3kPlJL0PRn7mp5PNA7gzv7H2Tv8w5GXPqUFHbxAbvmymLda57tcg7gd3IxW4g==
X-Received: by 2002:a05:6a00:9a0:b0:736:38b1:51c3 with SMTP id d2e1a72fcca58-7366e75b316mr10877398b3a.10.1741159595256;
        Tue, 04 Mar 2025 23:26:35 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d2e1a72fcca58-736881fa8easm449243b3a.39.2025.03.04.23.26.34
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 23:26:34 -0800 (PST)
Date: Wed, 5 Mar 2025 16:26:32 +0900
From: 'Krzysztof =?utf-8?Q?Wilczy=C5=84ski'?= <kw@linux.com>
To: Shradha Todi <shradha.t@samsung.com>
Cc: 'Manivannan Sadhasivam' <manivannan.sadhasivam@linaro.org>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, fan.ni@samsung.com,
	nifan.cxl@gmail.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 4/5] Add debugfs based error injection support in DWC
Message-ID: <20250305072632.GB847772@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132039epcas5p31913eab0acec1eb5e7874897a084c725@epcas5p3.samsung.com>
 <20250221131548.59616-5-shradha.t@samsung.com>
 <20250303095200.GB1065658@rocinante>
 <20250304152952.pal66goo2dwegevh@thinkpad>
 <20250304153509.GA2310180@rocinante>
 <061301db8d27$02e0ced0$08a26c70$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <061301db8d27$02e0ced0$08a26c70$@samsung.com>

Hello,

[...]
> > > > > +		29) Generates duplicate TLPs - duplicate_dllp
> > > > > +		30) Generates Nullified TLPs - nullified_tlp
> > > >
> > > > Would the above field called "duplicate_dllp" for duplicate TLPs be
> > > > a potential typo?  Perhaps this should be called "duplicate_tlp"?
> > > >
> > >
> > > Looks like a typo. As per Synopsys documentation, there is only 'duplicate TLP'
> > > field.
> > >
> > > Good catch!
> > 
> > Updated.  Thank you!
> > 
> 
> Sorry, this was a typo. Krzysztof, we need another change for this typo.

Not a problem.  I am glad we caught this early.

[...]
> --- a/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ b/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -113,7 +113,7 @@ static const struct dwc_pcie_err_inj err_inj_list[] = {
>         {"posted_tlp_data", 0x4, 0x4},
>         {"non_post_tlp_data", 0x4, 0x5},
>         {"cmpl_tlp_data", 0x4, 0x6},
> -       {"duplicate_dllp", 0x5, 0x0},
> +       {"duplicate_tlp", 0x5, 0x0},
>         {"nullified_tlp", 0x5, 0x1},
>  };

Oh here too.  No worries.  I missed this one. :)

> So sorry for the inconvenience! Should I post a patch for this?

No, no need.  I will update this directly on the branch.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f170.google.com (mail-pl1-f170.google.com [209.85.214.170])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 1A2D019258E;
	Wed,  5 Mar 2025 04:26:10 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.170
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741148772; cv=none; b=AlHfL9xlAxyPecP9mIltsp7KyahAwQpvSE7gyrD/So8bEO9gk35I/f9hAW7WL9WnOZIm0C9ldHJVtIfDHLEIis4hTtLD991GjHH62vZRn83W4Av6ns6OrdvMkpki7N1exOwQtDhszkzJNIwZgbYou78ag/37pA13KGG56uEauVo=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741148772; c=relaxed/simple;
	bh=Ma9rbC5Lm1hcZ0TRRXqeaYpaIEccVc7d1Sur+2dI6bA=;
	h=From:Date:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=XvIxKhxEGJMx2NFysXiQe8V5L8LasOke40ic2bNZPRk+H1rl8KLX1nEazUIH2yJO+VBiYE/TQ3zccYGnOKcCEJM77t92BBqr8Vo9V0oFZE0xPt+b6qQjYqua1cfdeF/M7NYbDD+kbq8DAuBxmDpTYO6Ovq/SVvrmIad8kdXlzOY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com; spf=pass smtp.mailfrom=gmail.com; dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b=BZZ5iXXn; arc=none smtp.client-ip=209.85.214.170
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="BZZ5iXXn"
Received: by mail-pl1-f170.google.com with SMTP id d9443c01a7336-2232b12cd36so87521765ad.0;
        Tue, 04 Mar 2025 20:26:10 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1741148770; x=1741753570; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=lDbPu0GoIrMl1ekfCD/PMILNRbV5SLzILd3Nw6UHcyw=;
        b=BZZ5iXXnZkls8MGlK7mGB0Vi/yERJ2Uzd4k/d9yW5GwfiSpsFny1oFxvV3wHSlbviH
         +7exKVdMrxGmUi44mU2VEY7IOBItWyB62PtcttjSLGFDl3k1J8wZQeC+kWu0cooEG3Wm
         4E6xUeSU2O++VkFIrURU9cPTz328Is9WLEpErRk28mv0m3NeqMHhgTO3ALXhxZBHBN+E
         /pEo0f36HPsv1YBxEBlOLpmPdoRY8G0TlH92EmTo9WHW72apzBsPR39b/IlgyVSYbI/w
         KzZeyIBxx18VASYFBkfH9F08lMsvSh68vUzpR+uexE/ZWFL1mBWn/M2WZQrq9m65pwao
         SQ1w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741148770; x=1741753570;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=lDbPu0GoIrMl1ekfCD/PMILNRbV5SLzILd3Nw6UHcyw=;
        b=I3t9u8B7WJ865plYyZTuxLDOy3G4wtmZjqCC1/MLQv/DqYsqm+ftspFB+jaqEcr831
         zipaSibBmXLvYFUoAiEg3l63vTSWGsBkG3nMww+PfOeXiSq0oRt+EzRtXsexbm27skZ8
         YvykqSwTQMoWxq7fpWFSu+LlBfPEZENY2M/W3Z4OFBf5vdhTxEMMHgqApWryMD8EHbXY
         a58n2qvxZbUhBWOUpPFsD5D5QcH+wn4ZC2rTRCzYQ29mkhlOIVtWhQTXoBe8wFIoZgSQ
         bfyEVARvBqZwIJkQR7cHu1efG5P8lWUw4RUNQLVo15BnMa0lySwgYxUDcAlXdHsLtJKA
         Q31g==
X-Forwarded-Encrypted: i=1; AJvYcCXBKsNwWNI5//Gq6hUoBsFTUShhckCR3FLbjwstgfTw8G0m6oIRuJOgGruuLNcX1Lo45cAD9HRv+9Bt6+Y=@vger.kernel.org, AJvYcCXh5prK6wAUZcBfIyzMeVmhDWdlbWcWU2VcymUNaHy8SW29AD6UDX6kwDrxiOfXGrdNAONM5pPw0yehjHtzYhB3JA==@vger.kernel.org, AJvYcCXnfk+OTmOGsJYUCCl3iKWXiBlDlLJQcVuA7zzss3U5pE27QQPiwBRwzKCYbGT6qKQVpm39GUhdKopj@vger.kernel.org
X-Gm-Message-State: AOJu0YwZ+TU1jxbU1MSr/6KjZSfRKfLWMT/XOn+XOt87MO2AuWZSfhqj
	3kQTzTZxcKkgpYwNr0bPaGLogKJkaFRqrHfG+Qye70ZQPEFddL8w
X-Gm-Gg: ASbGncvn0gs9unvM5E3GI7EgzB+4duXNkpEUsxtVjNd/vXUuK+UFRuLDG/MYc8qRMjT
	qHwlKW0FhuX+dDoeOQKPDjgDbZq8oKtW+zuwsxLT7mNSZSTsTAQvtR2sH56NvlZjgfG8e6VCplx
	cPgN7YIudAyMbRWG8w0UGy1O3XgL8MGxWtsUf/QUAVl62MEgfUQxQXoNY6r7h+Uqr8Uqop53cZ+
	ttK83CSex3uI9e8tMhJxRozb7XipWgnJ6Dbim4hqUDZb70UfvqgXjDWruvOWkkH67ZlRPdgsOBz
	3ahjSpuFIUL5lUb0ehno49wfwCsB4uYlyZ1iUA==
X-Google-Smtp-Source: AGHT+IE5O1ZVuOwmp//oQrwhNgSp7QZxuUhf3G7FCkClB32cJAQnuuVkN/3c86LEBjvOfGY+rzBunA==
X-Received: by 2002:a05:6a00:23c4:b0:736:3f4d:4d49 with SMTP id d2e1a72fcca58-73682b8b965mr2481120b3a.8.1741148770219;
        Tue, 04 Mar 2025 20:26:10 -0800 (PST)
Received: from debian ([2601:646:8f03:9fee:cf74:c30d:9ff:fbc6])
        by smtp.gmail.com with ESMTPSA id d2e1a72fcca58-736560f5e6esm5099715b3a.104.2025.03.04.20.26.04
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 20:26:09 -0800 (PST)
From: Fan Ni <nifan.cxl@gmail.com>
X-Google-Original-From: Fan Ni <fan.ni@samsung.com>
Date: Tue, 4 Mar 2025 20:26:01 -0800
To: Shradha Todi <shradha.t@samsung.com>
Cc: 'Fan Ni' <nifan.cxl@gmail.com>,
	'Krzysztof =?utf-8?Q?Wilczy=C5=84ski'?= <kw@linux.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, manivannan.sadhasivam@linaro.org,
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com,
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com,
	a.manzanares@samsung.com, pankaj.dubey@samsung.com,
	cassel@kernel.org, 18255117159@163.com, xueshuai@linux.alibaba.com,
	renyu.zj@linux.alibaba.com, will@kernel.org, mark.rutland@arm.com
Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in
 DWC
Message-ID: <Z8fSWcR_aXyxmFEZ@debian>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132043epcas5p27fde98558b13b3311cdc467e8f246380@epcas5p2.samsung.com>
 <20250221131548.59616-6-shradha.t@samsung.com>
 <Z8XuuNb6TRevUlHH@debian>
 <20250303194228.GB1552306@rocinante>
 <Z8YZEALV71PUkXpF@debian>
 <061401db8d28$5f0a4b40$1d1ee1c0$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <061401db8d28$5f0a4b40$1d1ee1c0$@samsung.com>

On Tue, Mar 04, 2025 at 10:40:43PM +0530, Shradha Todi wrote:
> 
> 
> > -----Original Message-----
> > From: Fan Ni <nifan.cxl@gmail.com>
> > Sent: 04 March 2025 02:33
> > To: Krzysztof WilczyÅ„ski <kw@linux.com>
> > Cc: Fan Ni <nifan.cxl@gmail.com>; Shradha Todi <shradha.t@samsung.com>; linux-kernel@vger.kernel.org; linux-
> > pci@vger.kernel.org; linux-arm-kernel@lists.infradead.org; linux-perf-users@vger.kernel.org; manivannan.sadhasivam@linaro.org;
> > lpieralisi@kernel.org; robh@kernel.org; bhelgaas@google.com; jingoohan1@gmail.com; Jonathan.Cameron@huawei.com;
> > a.manzanares@samsung.com; pankaj.dubey@samsung.com; cassel@kernel.org; 18255117159@163.com;
> > xueshuai@linux.alibaba.com; renyu.zj@linux.alibaba.com; will@kernel.org; mark.rutland@arm.com
> > Subject: Re: [PATCH v7 5/5] Add debugfs based statistical counter support in DWC
> > 
> > On Tue, Mar 04, 2025 at 04:42:28AM +0900, Krzysztof WilczyÅ„ski wrote:
> > > Hello,
> > >
> > > [...]
> > > > > +static ssize_t counter_value_read(struct file *file, char __user
> > > > > +*buf, size_t count, loff_t *ppos) {
> > > > > +	struct dwc_pcie_rasdes_priv *pdata = file->private_data;
> > > > > +	struct dw_pcie *pci = pdata->pci;
> > > > > +	struct dwc_pcie_rasdes_info *rinfo = pci->debugfs->rasdes_info;
> > > > > +	char debugfs_buf[DWC_DEBUGFS_BUF_MAX];
> > > > > +	ssize_t pos;
> > > > > +	u32 val;
> > > > > +
> > > > > +	mutex_lock(&rinfo->reg_event_lock);
> > > > > +	set_event_number(pdata, pci, rinfo);
> > > > > +	val = dw_pcie_readl_dbi(pci, rinfo->ras_cap_offset + RAS_DES_EVENT_COUNTER_DATA_REG);
> > > > > +	mutex_unlock(&rinfo->reg_event_lock);
> > > > > +	pos = scnprintf(debugfs_buf, DWC_DEBUGFS_BUF_MAX, "Counter
> > > > > +value: %d\n", val);
> > > > > +
> > > > > +	return simple_read_from_buffer(buf, count, ppos, debugfs_buf,
> > > > > +pos); }
> > > >
> > > > Do we need to check whether the counter is enabled or not for the
> > > > event before retrieving the counter value?
> > >
> > > I believe, we have a patch that aims to address, have a look at:
> > >
> > >
> > > https://lore.kernel.org/linux-pci/20250225171239.19574-1-manivannan.sa
> > > dhasivam@linaro.org
> > 
> > Maybe I missed something, that seems to fix counter_enable_read(), but here is to retrieve counter value.
> > How dw_pcie_readl_dbi() can return something like "Counter Disabled"?
> > 
> > Fan
> 
> Hey Fan,
> So the counter value will show 0 in case it is disabled so there will not be any issues as per say. We could add the
> check here but I feel I have already exposed the functionality to check if a counter is enabled or disabled, (by reading the
> counter_enable debugfs entry) so this could be handled in user space to only read the counter if it's enabled.
Ok. 
Returning 0 when the counter is disabled makes sense to me.

Just some thought.

It seems natural to me if we make "counter_value" only visiable to
users when the counter is enabled. 

Fan
> 
> > >
> > > Thank you!
> > >
> > > 	Krzysztof
> 
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout3.samsung.com (mailout3.samsung.com [203.254.224.33])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9DEA517C7C4
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.33
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741144606; cv=none; b=naV01vW5gNgcgZ2/6CT2KwfvYPUMbdKNWIzw7j0t3+wSMN4J5nqUT2qmVgkL1PvWXdY0pNY/HXnj7oiRGkB2aCrqB0G9RN6sq2n2x3oc5bkFxu8PVr9SsrPHzHjYSDTDeXcAR3gDHLJmbRa0EdsF+lb1NfsCj6H4GtpDHPabeKQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741144606; c=relaxed/simple;
	bh=EsR4nGnyBDS/VIb+LpQZpmXrF5wEoCQl1Mo8HIK7ch4=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=OqWAl4altxVM/rjvkPqnWr/jqw4yhiCw9RGCuGnRbZv8GIYMM6+vcr7c+1gjjLYCMhXNyvIHrUaJfrJtXM1Hpu77YppCmoTlV3soNq7pgmHTOq4griplcOP8PFUS2iaITesvhhyvvEq14JdWqRooFMygqXxx0kfHNUryO4+2TlE=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=S2kU2CI2; arc=none smtp.client-ip=203.254.224.33
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="S2kU2CI2"
Received: from epcas5p3.samsung.com (unknown [182.195.41.41])
	by mailout3.samsung.com (KnoxPortal) with ESMTP id 20250305031635epoutp0302a0c49791f1f8ef3308cc09de9e47df~pycj1ZoYE0874808748epoutp03r
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 03:16:35 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout3.samsung.com 20250305031635epoutp0302a0c49791f1f8ef3308cc09de9e47df~pycj1ZoYE0874808748epoutp03r
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741144595;
	bh=EsR4nGnyBDS/VIb+LpQZpmXrF5wEoCQl1Mo8HIK7ch4=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=S2kU2CI2xje+emjK4Jg/RqSa3jUUwct/k0/OAPWmDVT7bNcG9njUDddd6pyFnPPXs
	 580vcBYClflQEHljRseFhrwy9+azvOjBcElBcpeZahTb6D0f8ueNkft4vzkWrk5Thr
	 fKX5zjSmjSk36yE/SQiEF+IZvo1XWpzH1NeUZioM=
Received: from epsnrtp1.localdomain (unknown [182.195.42.162]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250305031635epcas5p32f97f9dce2000f5a89b131741355e606~pycjCzNs01185711857epcas5p38;
	Wed,  5 Mar 2025 03:16:35 +0000 (GMT)
Received: from epsmges5p2new.samsung.com (unknown [182.195.38.181]) by
	epsnrtp1.localdomain (Postfix) with ESMTP id 4Z6yPs2WBxz4x9Pr; Wed,  5 Mar
	2025 03:16:33 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmges5p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	DD.49.19933.112C7C76; Wed,  5 Mar 2025 12:16:33 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTPA id
	20250304165250epcas5p39c2b800a8bfb14a9c5c1b01865e65869~pp78jai0Z1538215382epcas5p3e;
	Tue,  4 Mar 2025 16:52:50 +0000 (GMT)
Received: from epsmgmc1p1new.samsung.com (unknown [182.195.42.40]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250304165250epsmtrp2f94931dc5f059ee5cd572b39f5f6e6ac~pp78iRIID0997409974epsmtrp2Y;
	Tue,  4 Mar 2025 16:52:50 +0000 (GMT)
X-AuditID: b6c32a4a-c1fda70000004ddd-9b-67c7c2114726
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgmc1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	FF.51.23488.2EF27C76; Wed,  5 Mar 2025 01:52:50 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip2.samsung.com
	(KnoxPortal) with ESMTPA id
	20250304165247epsmtip2e395c7a173fdc48666237081c1b53dbb~pp75iQzcE3269232692epsmtip22;
	Tue,  4 Mar 2025 16:52:46 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: =?UTF-8?Q?'Krzysztof_Wilczy=C5=84ski'?= <kw@linux.com>, "'Geert
 Uytterhoeven'" <geert@linux-m68k.org>
Cc: "'Fan Ni'" <nifan.cxl@gmail.com>, <linux-kernel@vger.kernel.org>,
	<linux-pci@vger.kernel.org>, <linux-arm-kernel@lists.infradead.org>,
	<linux-perf-users@vger.kernel.org>, <manivannan.sadhasivam@linaro.org>,
	<lpieralisi@kernel.org>, <robh@kernel.org>, <bhelgaas@google.com>,
	<jingoohan1@gmail.com>, <Jonathan.Cameron@huawei.com>,
	<a.manzanares@samsung.com>, <pankaj.dubey@samsung.com>, <cassel@kernel.org>,
	<18255117159@163.com>, <xueshuai@linux.alibaba.com>,
	<renyu.zj@linux.alibaba.com>, <will@kernel.org>, <mark.rutland@arm.com>,
	"'Yoshihiro Shimoda'" <yoshihiro.shimoda.uh@renesas.com>, "'Linux-Renesas'"
	<linux-renesas-soc@vger.kernel.org>
In-Reply-To: <20250304154638.GB2310180@rocinante>
Subject: RE: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Date: Tue, 4 Mar 2025 22:22:36 +0530
Message-ID: <061201db8d25$dd1e2bd0$975a8370$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQJfby7SiE0e/TbLvAHLJIl0P7SXpgHiQm8TAh/83CQB4BrFQwHvpDbsAQ7NFRkCkbJgbLH/1d8A
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA01Ta0xTZxjOaU8vgHWH4sYHC0t3ZHEwuRRpPVVQjGQ5ypZ0YHRjWfAEDuXS
	mz0FcS4ZGx1TghaYl7UgwrgEuga0pQiMyuQqZm4SWVkmLBaYiog0A4ncZL3Axr/nfd7nvTzf
	l5dN55axAtmZcjWpkhNSlOkNt/aE7Ajz7R6QRNqv+WDD3y6zsMs9b2O1X2dg/SUNdOzRn1Ya
	1jCvY2GGahsTyy9eZmCmCRsDu99RwcTuVg4wsWFLE4xZpp7TMM2KBsbGNGcZWN3IEA1bbbVC
	2A+WeRZWXTAFYWudbSxMMyrAZhfNTOyFdY4Z54/XNFxg4MZKI4S368dYeJUpB9f0zjBwk+Es
	Ex+1dTLx7p4zzqRdhE8OX6bh5tov8YVfSmH8fIsBwudMb4m3JmfHZJBEGqnikfJURVqmXBKL
	JiSlHEwRCCP5YXwRthvlyQkZGYvGfyAOez9T6nSP8nIJaY6TEhMUhUbsi1EpctQkL0NBqWNR
	UpkmVUYrwylCRuXIJeFyUr2HHxkZJXAKj2dnDLZb6EpHVN7N608Y+dAtfhHkxQZINOhs/YZZ
	BHmzuchPEJht6WF4gn8gMPRIS/cECxC4ojVCGyWtXdPrJVYINNc10F0JLvIEAit23IWZyE4w
	Obzi5rch2WBVX+FuS0d0DKD/TsdyJbwQPhi80uTu6occBo12O+zCMBIM9NcMTg2bzUFEoP1l
	kovmIL5gUDfpltCR90B99TTdsxAPLP5dz/DMSga63i6GR+MP+haL3Q4AcscLFNbdXXcQD6ZN
	NqYH+4GnAy0sDw4Ec8+t67wENJq/Xx8gBQvmWpoH7wc/D1fArt3oSAho7ojw0EHg4p0mmmfu
	VnBueXJdzgFtlRt4O5hf7YQ9OABU9t9nlECofpM1/SZr+k0W9P9Pq4JgAxRAKimZhKQEyig5
	efK/D09VyEyQ+zhCD7dB9oeO8G6Ixoa6IcCmo9s4NUUDEi4njTj1OalSpKhypCTVDQmcz11K
	D3w9VeG8Lrk6hR8tiowWCoXRol1CPurPKWjXSLiIhFCT2SSpJFUbdTS2V2A+7WqVd2i8TLb3
	RuB+aryk9I8gv/KA2fm4AwlJxz7T5q1aXnGo8+nN4kPvNN47yO06VXxdvPbXBJl/YzRhV1lm
	1Md1lZfQm7f8svz74dMjpwu15eP+CTKD7KmgLPhcwfiBpXKfj4qOWOsMJ7eUjTwwh5jSM3u7
	DsWEpJ+YWcz+SrpTfwFfEidmjSOJO2oIiy2h/6XPdCLv09+NZ4ZGw4ilqomsvVUgAkRtae84
	Kn8cfMn+xhdTD3V9L167Z+6zSGcuth7bI3sVFGfv3z7kEDk+tF3lrTmOjn2SXJ975Bkv4Ecj
	OaO9DSfn9Zgdt5892C1MLy38VaU9Lsy1v/vmb77afcYTj1GYyiD4oXQVRfwLARpbpaUEAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrNIsWRmVeSWpSXmKPExsWy7bCSvO4j/ePpBm+O8Fhcaf/NbjH9sKLF
	kqYMi2MTVjBbPLu1l8lixZeZ7BarFl5js2jo+c1qsenxNVaLy7vmsFmcnXeczeLK1nUsFltf
	vmOyaPnTwmJxt6WT1WLp9YtMFn+37WW0WLT1C7vFwuaXjBb/9+xgt2i5Y2rx/udmNouvez+z
	OYh7LF4xhdVjzbw1jB47Z91l91iwqdSj5chbVo9NqzrZPO5c28PmcehwB1DyoaXHkyvTmTw2
	L6n3+HZmIotH35ZVjB6fN8kF8EVx2aSk5mSWpRbp2yVwZfw518pasEepYnb/Z9YGxr9SXYyc
	HBICJhLb9r9m62Lk4hAS2M0osW3BRRaIhKTE54vrmCBsYYmV/56zQxQ9Y5T4MGsiM0iCTUBH
	4smVP2C2iEC2xJTbNxhBipgF1rNKnLn8khmi4wmTxJWPi1lBqjgFDCVOzl3HCGILC3hJrHz4
	EGwdi4CKxKwNq4BWcHDwClhK7PwRDBLmFRCUODnzCVgJs4C2RO/DVkYYe9nC18wQ1ylI/Hy6
	jBXiiCiJmUf2s0LUiEsc/dnDPIFReBaSUbOQjJqFZNQsJC0LGFlWMUqmFhTnpucmGxYY5qWW
	6xUn5haX5qXrJefnbmIEpw8tjR2M77416R9iZOJgPMQowcGsJMJr+vlYuhBvSmJlVWpRfnxR
	aU5q8SFGaQ4WJXHelYYR6UIC6YklqdmpqQWpRTBZJg5OqQYmlr/h53kuaXvxZ39nmpl5wCE+
	u12S+9zRxxsfqmjZagreer5VaNJRYUGWh2b+PzXqs2LS718JOOK7yiW/zVhl9vum+mdMIlPU
	DHVXr9/RGN3+eYbRfhWn63suKpbM/dfPVnHp/zWR3ENuCVFt769W9L+V0jtvZ8Yz4Rl7naX/
	5BV3Qk5O7T1a1ZRf+v7W/4MfT3wvTPXevUMmZOeSmnS2OZ3VD2PF3mSdb0xYoRT3Ncvr+Y7J
	3fenT1t7P3/SAn6hVQZTGY4tb5FctWn1ZOOy84JdD/1Kl8QWcCR98RF9p8kmOm366s3bF0Ts
	6Pj54kDPfkaZzkwzhwvGy0/0v3ojyXWuSGLy9YfvzN6+6H+cqMRSnJFoqMVcVJwIAAaza3SO
	AwAA
X-CMS-MailID: 20250304165250epcas5p39c2b800a8bfb14a9c5c1b01865e65869
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132035epcas5p47221a5198df9bf86020abcefdfded789
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
	<20250221131548.59616-4-shradha.t@samsung.com> <Z8XrYxP_pZr6tFU8@debian>
	<20250303194647.GC1552306@rocinante>
	<CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
	<20250304154638.GB2310180@rocinante>



> -----Original Message-----
> From: Krzysztof Wilczy=C5=84ski=20<kw=40linux.com>=0D=0A>=20Sent:=2004=20=
March=202025=2021:17=0D=0A>=20To:=20Geert=20Uytterhoeven=20<geert=40linux-m=
68k.org>=0D=0A>=20Cc:=20Fan=20Ni=20<nifan.cxl=40gmail.com>;=20Shradha=20Tod=
i=20<shradha.t=40samsung.com>;=20linux-kernel=40vger.kernel.org;=20linux-=
=0D=0A>=20pci=40vger.kernel.org;=20linux-arm-kernel=40lists.infradead.org;=
=20linux-perf-users=40vger.kernel.org;=20manivannan.sadhasivam=40linaro.org=
;=0D=0A>=20lpieralisi=40kernel.org;=20robh=40kernel.org;=20bhelgaas=40googl=
e.com;=20jingoohan1=40gmail.com;=20Jonathan.Cameron=40huawei.com;=0D=0A>=20=
a.manzanares=40samsung.com;=20pankaj.dubey=40samsung.com;=20cassel=40kernel=
.org;=2018255117159=40163.com;=0D=0A>=20xueshuai=40linux.alibaba.com;=20ren=
yu.zj=40linux.alibaba.com;=20will=40kernel.org;=20mark.rutland=40arm.com;=
=20Yoshihiro=20Shimoda=0D=0A>=20<yoshihiro.shimoda.uh=40renesas.com>;=20Lin=
ux-Renesas=20<linux-renesas-soc=40vger.kernel.org>=0D=0A>=20Subject:=20Re:=
=20=5BPATCH=20v7=203/5=5D=20Add=20debugfs=20based=20silicon=20debug=20suppo=
rt=20in=20DWC=0D=0A>=20=0D=0A>=20Hello,=0D=0A>=20=0D=0A>=20>=20This=20patch=
=20is=20now=20commit=201ff54f4cbaed9ec6=20(=22PCI:=20dwc:=20Add=20debugfs=
=0D=0A>=20>=20based=20Silicon=20Debug=20support=20for=20DWC=22)=20in=20pci/=
next=20(next-20250304).=0D=0A>=20>=0D=0A>=20>=20On=20Mon,=203=20Mar=202025=
=20at=2020:47,=20Krzysztof=20Wilczy=C5=84ski=20<kw=40linux.com>=20wrote:=0D=
=0A>=20>=20>=20=5B...=5D=0D=0A>=20>=20>=20>=20>=20+int=20dwc_pcie_debugfs_i=
nit(struct=20dw_pcie=20*pci)=20=7B=0D=0A>=20>=20>=20>=20>=20+=20=20=20char=
=20dirname=5BDWC_DEBUGFS_BUF_MAX=5D;=0D=0A>=20>=20>=20>=20>=20+=20=20=20str=
uct=20device=20*dev=20=3D=20pci->dev;=0D=0A>=20>=20>=20>=20>=20+=20=20=20st=
ruct=20debugfs_info=20*debugfs;=0D=0A>=20>=20>=20>=20>=20+=20=20=20struct=
=20dentry=20*dir;=0D=0A>=20>=20>=20>=20>=20+=20=20=20int=20ret;=0D=0A>=20>=
=20>=20>=20>=20+=0D=0A>=20>=20>=20>=20>=20+=20=20=20/*=20Create=20main=20di=
rectory=20for=20each=20platform=20driver=20*/=0D=0A>=20>=20>=20>=20>=20+=20=
=20=20snprintf(dirname,=20DWC_DEBUGFS_BUF_MAX,=20=22dwc_pcie_%s=22,=20dev_n=
ame(dev));=0D=0A>=20>=20>=20>=20>=20+=20=20=20dir=20=3D=20debugfs_create_di=
r(dirname,=20NULL);=0D=0A>=20>=20>=20>=20>=20+=20=20=20debugfs=20=3D=20devm=
_kzalloc(dev,=20sizeof(*debugfs),=20GFP_KERNEL);=0D=0A>=20>=20>=20>=20>=20+=
=20=20=20if=20(=21debugfs)=0D=0A>=20>=20>=20>=20>=20+=20=20=20=20=20=20=20=
=20=20=20=20return=20-ENOMEM;=0D=0A>=20>=20>=20>=20>=20+=0D=0A>=20>=20>=20>=
=20>=20+=20=20=20debugfs->debug_dir=20=3D=20dir;=0D=0A>=20>=20>=20>=20>=20+=
=20=20=20pci->debugfs=20=3D=20debugfs;=0D=0A>=20>=20>=20>=20>=20+=20=20=20r=
et=20=3D=20dwc_pcie_rasdes_debugfs_init(pci,=20dir);=0D=0A>=20>=20>=20>=20>=
=20+=20=20=20if=20(ret)=0D=0A>=20>=20>=20>=20>=20+=20=20=20=20=20=20=20=20=
=20=20=20dev_dbg(dev,=20=22RASDES=20debugfs=20init=20failed=5Cn=22);=0D=0A>=
=20>=20>=20>=0D=0A>=20>=20>=20>=20What=20will=20happen=20if=20ret=20=21=3D=
=200?=20still=20return=200?=0D=0A>=20>=0D=0A>=20>=20And=20that=20is=20exact=
ly=20what=20happens=20on=20Gray=20Hawk=20Single=20with=20R-Car=0D=0A>=20>=
=20V4M:=20dw_pcie_find_rasdes_capability()=20returns=20NULL,=20causing=0D=
=0A>=20>=20dwc_pcie_rasdes_debugfs_init()=20to=20return=20-ENODEV.=0D=0A>=
=20=0D=0A>=20Thank=20you=20for=20testing=20and=20for=20catching=20this=20is=
sue.=20=20Much=20appreciated.=0D=0A>=20=0D=0A>=20>=20>=20Given=20that=20cal=
lers=20of=20dwc_pcie_debugfs_init()=20check=20for=20errors,=0D=0A>=20>=0D=
=0A>=20>=20Debugfs=20issues=20should=20never=20be=20propagated=20upstream=
=21=0D=0A>=20=0D=0A>=20Makes=20complete=20sense.=20=20Sorry=20for=20breakin=
g=20things=20here=21=0D=0A>=20=0D=0A>=20>=20>=20this=20probably=20should=20=
correctly=20bubble=20up=20any=20failure=20coming=20from=0D=0A>=20>=20>=20dw=
c_pcie_rasdes_debugfs_init().=0D=0A>=20>=20>=0D=0A>=20>=20>=20I=20made=20up=
dates=20to=20the=20code=20directly=20on=20the=20current=20branch,=20have=20=
a=20look:=0D=0A>=20>=0D=0A>=20>=20So=20while=20applying,=20you=20changed=20=
this=20like:=0D=0A>=20>=0D=0A>=20>=20=20=20=20=20=20=20=20=20=20=20=20=20re=
t=20=3D=20dwc_pcie_rasdes_debugfs_init(pci,=20dir);=0D=0A>=20>=20=20=20=20=
=20-=20=20=20=20=20=20=20if=20(ret)=0D=0A>=20>=20=20=20=20=20-=20=20=20=20=
=20=20=20=20=20=20=20=20=20=20=20dev_dbg(dev,=20=22RASDES=20debugfs=20init=
=20failed=5Cn=22);=0D=0A>=20>=20=20=20=20=20+=20=20=20=20=20=20=20if=20(ret=
)=20=7B=0D=0A>=20>=20=20=20=20=20+=20=20=20=20=20=20=20=20=20=20=20=20=20=
=20=20dev_err(dev,=20=22failed=20to=20initialize=20RAS=20DES=20debugfs=5Cn=
=22);=0D=0A>=20>=20=20=20=20=20+=20=20=20=20=20=20=20=20=20=20=20=20=20=20=
=20return=20ret;=0D=0A>=20>=20=20=20=20=20+=20=20=20=20=20=20=20=7D=0D=0A>=
=20>=0D=0A>=20>=20=20=20=20=20=20=20=20=20=20=20=20=20return=200;=0D=0A>=20=
>=0D=0A>=20>=20Hence=20this=20is=20now=20a=20fatal=20error,=20causing=20the=
=20probe=20to=20fail.=0D=0A>=20=0D=0A>=20I=20removed=20the=20changed,=20and=
=20also=20move=20the=20log=20level=20to=20be=20a=20warning,=20per:=0D=0A>=
=20=0D=0A=0D=0AHey=20Krzysztof,=0D=0AI=20think=20we=20shouldn't=20move=20th=
e=20log=20level=20to=20be=20a=20WARN.=20I=20believe=20many=20controllers=20=
might=20not=20support=0D=0ARAS=20DES=20feature=20in=20their=20design=20and=
=20giving=20a=20warn=20dump=20would=20draw=20unnecessary=20attention.=0D=0A=
My=20opinion=20is=20to=20silently=20let=20it=20fail=20unless=20the=20user=
=20is=20actually=20interested=20in=20getting=20the=20RAS=20DES=20feature=20=
up.=0D=0AWe=20can=20wait=20for=20Mani's=20response=20though.=20But=20good=
=20catch=20to=20also=20add=20the=20error=20type,=20that's=20definitely=20a=
=20more=0D=0Ainformative=20error=20log.=0D=0A=0D=0A>=20=0D=0A>=20https://we=
b.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=3Dcontrolle=
r/dwc&id=3Dc6759a967e69aba16aef0d92f43e527b=0D=0A>=20112e98a5=0D=0A>=20=0D=
=0A>=20Would=20this=20be=20acceptable=20here?=0D=0A>=20=0D=0A>=20Mani,=20wo=
uld=20this=20be=20acceptable=20to=20you,=20too?=20=20Given=20that=20you=20p=
osted=20the=20following=20recently:=0D=0A>=20=0D=0A>=20=20=20https://lore.k=
ernel.org/linux-pci/20250303200055.GA1881771=40rocinante/T/=23mab9cbd583439=
0d259afea056eee9a73d8c3b435f=0D=0A>=20=0D=0A>=20That=20said,=20perhaps=20mo=
ving=20the=20log=20level=20to=20a=20debug=20would=20be=20better=20served=20=
here.=0D=0A>=20=0D=0A>=20=09Krzysztof=0D=0A=0D=0A

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f181.google.com (mail-pl1-f181.google.com [209.85.214.181])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 3B561255246;
	Tue,  4 Mar 2025 17:58:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.181
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741111125; cv=none; b=fFjxqezUy47jIB2g8u1HJG2ylo1XslH0/41YFbj4kl/ISrTlR1WgyJCKJgRb9Htg+XWPyRwM1Q5qV09NK6bSkskiHnwa2azLQTYypLcWgZv+UE/bkhlBbAQtD8PhZyyhuJFDl4mZlCiPAMUpkBaxLhOZVT16EvxzsHpyRGa4EsM=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741111125; c=relaxed/simple;
	bh=Ujw4MWb/0WOb7SwC+35n2U8PfAcDz24lLFOjDyOaR6g=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=gT/1FcFF0sXqbSApN5g+iVeeckrPvqRL0m2aLJ2mBJLDesCB70w8ALsov95IOAO2w/4LGy7y/Jphs+6dQHFLWFiNr82RYhnTA5XEZ+X5RHFKqBVBnYDee9NK+k2R2Tucw3WkREKJvB40W6wy2z6jqhgXofItGBbPFLWXyhi0vhI=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.181
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f181.google.com with SMTP id d9443c01a7336-2235189adaeso969055ad.0;
        Tue, 04 Mar 2025 09:58:43 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741111123; x=1741715923;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=Wa+NEDuZcYixtAYlNBsjFq3LjZunv0045SB9vkqgOdQ=;
        b=WlT/bH6DTaCOn/cthLwS3C6oxBedIPoNDoIoEWSKPP8aK1PX+SFSupy3r6ubSJE4CG
         Yd9NR2vcoXO5p+FmsBjfI2w9N+EaM7u8tMnRWl2qCGUHxMNOGurtuGPpfFo7aZkUYa1N
         k0k2+iapURyCdDpPo4Oguy7WecZ6sLRJiZ98VpW2PqIcn66XgTOU5VhAdKSHboAhy220
         fqlw9LQfXhlDGcu28SJPVBS1gtFkkjSsappKLMvppzXMj3ZASAvk0Gh4XIG9UbMU2J8J
         XZ37kO8t8yoH/xcC9nIvmtQ3TTwIfWeycHCVulxWlnGTtqjYE1VqYUhvgZJpAfbXyQPz
         bX1w==
X-Forwarded-Encrypted: i=1; AJvYcCUCfbBdehQ0nMYmnCtg2prlgV3qBB9IDEU9xIvlNR8Rer36kypyBGIwRoinnsY5LwJGBxThpFiRL4W6RaDhgy+5VQ==@vger.kernel.org, AJvYcCUZq9GVP4XtmOAsPtokmGbmpkqKf7s9TbDIyOW7qcyP9SHMr/XIa1LOls8kojlQoWVwm2bzV+D1jmxrrHgy/WhzCD0=@vger.kernel.org, AJvYcCX67ACzPQFgCqBCiThYfP/0YLSdZONbAK06GW7XfANoLR6pW58TlLzfRLTYHNBwLDPeP/fMV8XvSpjudys=@vger.kernel.org, AJvYcCXRf3n7N2qNxPLODIdCG3Dc2hlt8hktYJInqEI2f/HI1kpkYAE1XQgek7adzOKCWo4d4haFBiP0EciI@vger.kernel.org
X-Gm-Message-State: AOJu0Yz1dHQE2L6BvaoTlhPxe8LPuM2R7FQR9qjrQh+mU8VW3V3RJId8
	hx9PcqCtMYOe8ML8kNRaDGW2eB99Dm3mh8yASiqJG+ZbBVOSyqHU
X-Gm-Gg: ASbGnctNZV09i8tc3t3EEU9OHL827SxkqHnLCTqu8K9gHsRkoZcMARgWKNRbDcrQWKH
	S2a1KaS7430bJkZAnP0Ahc6JL3RiF+Oyckc6lqOzbJK6jIm4pt+VQVxsSrAiTwDstN3ZUfBPg2I
	kcjic1eG6wchOq7UaKBbqg9yDqJQNumclUFAapZuSSj9EhWd0fAL6Rx2pMuhoU4DM8Cu+4OUruY
	hnpixUU7iC+cDpKFNBHohYgHZRaEkHkKV5f1MJXWuki2w/VMrb1OyB3vGKuMTK1wapEKCXhINij
	+MsqHAH9JbF4K6d2syghzyfZ4qvaZhjn3KwuvhIg/91FJdpsVTESTIur1sJsi2J8cTz/IdvzzUt
	obXc=
X-Google-Smtp-Source: AGHT+IGxJOcaLpgJti6tTG0QJg+XMjirIbznemnIcFt44IjryR0KVwwvI5ls/IBoAD0A13h4IrVAXw==
X-Received: by 2002:a17:902:d48c:b0:21f:40de:ae4e with SMTP id d9443c01a7336-223f1d3ed62mr895285ad.9.1741111123284;
        Tue, 04 Mar 2025 09:58:43 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id d9443c01a7336-22350531a43sm98524575ad.238.2025.03.04.09.58.42
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 09:58:42 -0800 (PST)
Date: Wed, 5 Mar 2025 02:58:41 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Geert Uytterhoeven <geert@linux-m68k.org>, Fan Ni <nifan.cxl@gmail.com>,
	Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250304175841.GF2310180@rocinante>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
 <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
 <20250304154638.GB2310180@rocinante>
 <20250304171154.njoygsvfd567pb66@thinkpad>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250304171154.njoygsvfd567pb66@thinkpad>

Hello,

[...]
> > > > > > +   ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > > > > +   if (ret)
> > > > > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> > > > >
> > > > > What will happen if ret != 0? still return 0?
> > > 
> > > And that is exactly what happens on Gray Hawk Single with R-Car
> > > V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
> > > dwc_pcie_rasdes_debugfs_init() to return -ENODEV.
> > 
> > Thank you for testing and for catching this issue.  Much appreciated.
> > 
> > > > Given that callers of dwc_pcie_debugfs_init() check for errors,
> > > 
> > > Debugfs issues should never be propagated upstream!
> > 
> > Makes complete sense.  Sorry for breaking things here!
> > 
> > > > this probably should correctly bubble up any failure coming from
> > > > dwc_pcie_rasdes_debugfs_init().
> > > >
> > > > I made updates to the code directly on the current branch, have a look:
> > > 
> > > So while applying, you changed this like:
> > > 
> > >             ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > >     -       if (ret)
> > >     -               dev_dbg(dev, "RASDES debugfs init failed\n");
> > >     +       if (ret) {
> > >     +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
> > >     +               return ret;
> > >     +       }
> > > 
> > >             return 0;
> > > 
> > > Hence this is now a fatal error, causing the probe to fail.
> > 
> > I removed the changed, and also move the log level to be a warning, per:
> > 
> >   https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=c6759a967e69aba16aef0d92f43e527b112e98a5
> > 
> > Would this be acceptable here?
> > 
> > Mani, would this be acceptable to you, too?  Given that you posted the
> > following recently:
> > 
> >   https://lore.kernel.org/linux-pci/20250303200055.GA1881771@rocinante/T/#mab9cbd5834390d259afea056eee9a73d8c3b435f
> > 
> > That said, perhaps moving the log level to a debug would be better served here.
> > 
> 
> Even though debugfs_init() failure is not supposed to fail the probe(),
> dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
> failure would be canolically correct IMO.
> 
> So I would still opt to have my version + your previous one.

Sounds good!

I combined both changes (squashed your fix for the RAS DES capability
detection) together directly on the branch.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f43.google.com (mail-pj1-f43.google.com [209.85.216.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 5A5D324EA83
	for <linux-perf-users@vger.kernel.org>; Tue,  4 Mar 2025 17:12:04 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.43
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741108326; cv=none; b=orfdipbLxb8ciuB+lzm3a380378WDWex8XM7jvpLrBbl9DX444ijfq/F7ry8ICsVHU9gv93EC4QYW9C6F9tGXTZ7RYotM3Ki/8EYPmlX+7tGQJ6Py3gkxzvYya3pTcSu2YhSx+WZMLDkEdKY7dEjwx06kac93OxxXxF5ihWgpCc=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741108326; c=relaxed/simple;
	bh=qUPNYhbM7EM4tXTnq0Udx6d1pN2xoKCqq336L8Pjv1c=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=L7pJb8rA4UjA+mHf7aM4rHrxlx6We+nrSDJA8RkfRqXM21JPrBJ5cY3re5CMuHLzs6p1IxFBcMqp2zWNNaeOE9NzYYKs/Ff2WXIho+g239n2NsF5lmeZkmuYZNsVJCu2g5nh5DP4Us2QDECarbQi170sabIMA+hZ2qRMR3vNeiA=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=K9wFxLbn; arc=none smtp.client-ip=209.85.216.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="K9wFxLbn"
Received: by mail-pj1-f43.google.com with SMTP id 98e67ed59e1d1-2feb867849fso8076028a91.3
        for <linux-perf-users@vger.kernel.org>; Tue, 04 Mar 2025 09:12:04 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1741108324; x=1741713124; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=cKWAtQRLCp0qz4UwlvN+WFU+keHMUnNOhmFv6iaIYQU=;
        b=K9wFxLbn1cb+SuQFCyRUKGLDXcCQ+0FK12TRKX27v0hZroWk9jBp2q6INElk40XNTR
         nPeca/AidNdKKjyqJPcrmrfWF2VWVczG6L5PI1KuN91+bv4mXU0gveq0Q2hNKsBflS6O
         psm8zvi1727i0x+9AF+oZCYgOOMlMnH6yl03utPaK50+bN8KC9Ty8HQdTm0hrQGaNUYH
         w6LExT31IDynMont9PjMax7iJdhL2t7y/Gg4hqS2gYM4gsAWskFnRZtgXr9O03BZ9BiL
         y5cWpOV4NRYlKygcgyWIdfOPB+Zr27HZycZTnvxRAkARE64clrpg0xSs+s2s7YjVZB5X
         Af1A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741108324; x=1741713124;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=cKWAtQRLCp0qz4UwlvN+WFU+keHMUnNOhmFv6iaIYQU=;
        b=SrJxs+gX1YwZjjsDEW+HY1l3fsxIXkXphE19sP6I3IlvdO6SdblJXYJ+SaqmDWypS0
         7lm9Tox2OR2cE2u9UQSF7oqYcuZTpRYNuOy2IhEZ1Ap4SR8Ci00Pnokd1OTEQgI4LVEJ
         KZoFvugvh1QqUPCFNfT8i3VuL/6mTJ2cG3vTB9BRNJJ4kWAIT2WL4wBDxnnerbOAiebJ
         hJcQovacseAAXPkKXxfcbxRuZOknnhN83J55pnFcsuIr9BYAGiTiuZ7ZyM/yhaIJ48ba
         uFMOK/aZzLAhqw7P7mMuMyMR/hjIXIO479TnI/5oxPlSl5jP+Oh8x69RDdK6L0tkaAih
         wXvw==
X-Forwarded-Encrypted: i=1; AJvYcCU0z4WhS0d2WTCNcKkRZUNTr5QzJpR/qjznr82BmW4aUqLtpl2KXprPe42c8Cvyipl3O20QcAgsUhmpsYVOgfEu@vger.kernel.org
X-Gm-Message-State: AOJu0YxWdWhbrGgPTv7F8Nj2iIxVX6HEEdtLuoupnzIf+z5l8m0LUEbq
	VzldecwxQvg3XKS2o380yKvO3Oe32mTVLPxxs0Wy4aUM9q/BT8C5lMwDx4akfw==
X-Gm-Gg: ASbGncu3/7AOJV//nPnr3fRAQFUYM7zNLlbpxeFRRiJxsw+0oSbD/rqE8RD5Y+ZgJAV
	XfWUwyY4gvUXIpD5z4FJxbv1o0Hb0X/D6um5p5R0MWWC4PVC30onspBXNeLJ9IbjumS2AXSEIiy
	kVqZJnG4h32oZbRIf0ZJL5YOX0RssRALSy8FsF0XDJh2x0m6Gs7BF8qgbhCV8hQq35y8EkYilEg
	er/IIue3sayYRKRQScRswR5nFPuwutXYyiJit5nPX5ntNqVfGK7CW4hNAHt9EJy4OOOpmAEumyg
	75U241IdxTTtXIfdP5j56RpekvVns1o/eeMAFy7HiGe1ZlfmPwtLj6E=
X-Google-Smtp-Source: AGHT+IHAxbyCgHNleOV6pyn/ykxc9Lgl0VZqS9TI0AHJNMb4FhegCiAgjJqpVwILV7hlEejAmOZObw==
X-Received: by 2002:a17:90b:1c09:b0:2f2:3efd:96da with SMTP id 98e67ed59e1d1-2ff497a01bbmr70685a91.24.1741108323433;
        Tue, 04 Mar 2025 09:12:03 -0800 (PST)
Received: from thinkpad ([120.60.51.199])
        by smtp.gmail.com with ESMTPSA id 98e67ed59e1d1-2fea6753137sm11340607a91.6.2025.03.04.09.11.56
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 04 Mar 2025 09:12:02 -0800 (PST)
Date: Tue, 4 Mar 2025 22:41:54 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
Cc: Geert Uytterhoeven <geert@linux-m68k.org>, Fan Ni <nifan.cxl@gmail.com>,
	Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250304171154.njoygsvfd567pb66@thinkpad>
References: <20250221131548.59616-1-shradha.t@samsung.com>
 <CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
 <20250221131548.59616-4-shradha.t@samsung.com>
 <Z8XrYxP_pZr6tFU8@debian>
 <20250303194647.GC1552306@rocinante>
 <CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
 <20250304154638.GB2310180@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250304154638.GB2310180@rocinante>

On Wed, Mar 05, 2025 at 12:46:38AM +0900, Krzysztof WilczyÅ„ski wrote:
> Hello,
> 
> > This patch is now commit 1ff54f4cbaed9ec6 ("PCI: dwc: Add debugfs
> > based Silicon Debug support for DWC") in pci/next (next-20250304).
> > 
> > On Mon, 3 Mar 2025 at 20:47, Krzysztof WilczyÅ„ski <kw@linux.com> wrote:
> > > [...]
> > > > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > > > +{
> > > > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > > > +   struct device *dev = pci->dev;
> > > > > +   struct debugfs_info *debugfs;
> > > > > +   struct dentry *dir;
> > > > > +   int ret;
> > > > > +
> > > > > +   /* Create main directory for each platform driver */
> > > > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > > > +   dir = debugfs_create_dir(dirname, NULL);
> > > > > +   debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > > > +   if (!debugfs)
> > > > > +           return -ENOMEM;
> > > > > +
> > > > > +   debugfs->debug_dir = dir;
> > > > > +   pci->debugfs = debugfs;
> > > > > +   ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > > > +   if (ret)
> > > > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> > > >
> > > > What will happen if ret != 0? still return 0?
> > 
> > And that is exactly what happens on Gray Hawk Single with R-Car
> > V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
> > dwc_pcie_rasdes_debugfs_init() to return -ENODEV.
> 
> Thank you for testing and for catching this issue.  Much appreciated.
> 
> > > Given that callers of dwc_pcie_debugfs_init() check for errors,
> > 
> > Debugfs issues should never be propagated upstream!
> 
> Makes complete sense.  Sorry for breaking things here!
> 
> > > this probably should correctly bubble up any failure coming from
> > > dwc_pcie_rasdes_debugfs_init().
> > >
> > > I made updates to the code directly on the current branch, have a look:
> > 
> > So while applying, you changed this like:
> > 
> >             ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> >     -       if (ret)
> >     -               dev_dbg(dev, "RASDES debugfs init failed\n");
> >     +       if (ret) {
> >     +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
> >     +               return ret;
> >     +       }
> > 
> >             return 0;
> > 
> > Hence this is now a fatal error, causing the probe to fail.
> 
> I removed the changed, and also move the log level to be a warning, per:
> 
>   https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/commit/?h=controller/dwc&id=c6759a967e69aba16aef0d92f43e527b112e98a5
> 
> Would this be acceptable here?
> 
> Mani, would this be acceptable to you, too?  Given that you posted the
> following recently:
> 
>   https://lore.kernel.org/linux-pci/20250303200055.GA1881771@rocinante/T/#mab9cbd5834390d259afea056eee9a73d8c3b435f
> 
> That said, perhaps moving the log level to a debug would be better served here.
> 

Even though debugfs_init() failure is not supposed to fail the probe(),
dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
failure would be canolically correct IMO.

So I would still opt to have my version + your previous one.

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f43.google.com (mail-pj1-f43.google.com [209.85.216.43])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 7433A2E339F;
	Wed,  5 Mar 2025 19:09:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.43
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741201800; cv=none; b=Rw3LJ5BTJv8QMKQ8Q8npFgTAA93LqzqCbGUz9NlMhpSFTMm7xoL5vWhUCouthtvx9bU4g/8PozzTe02iePq6fnspZUFsOCk2z6w+BhrCzcJzFtt3HO/nputvd/YAHreGJ2pRAOdmtQpKYo837jGLJhRLSVAyBK+2XY/75glVarQ=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741201800; c=relaxed/simple;
	bh=KW8symAa9+ElA7tol8KYpclJp8NcgDvhtncZvNKzDks=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=WpTNBoBS0rU415N/pBq0KRuk4MGh3TYkk55r7NcaftjBLLSw7GwIMyyiNm9EiBurGIFUurirtsjcGF62g+LCZeefeEo0ATiV0c8soHc/sgqyXR3ah8M0G/N79m6EoYFc7I5ZKXUppDoj/MtyOjv5/m4eeme3IsunRupQRo4zzYQ=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.216.43
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pj1-f43.google.com with SMTP id 98e67ed59e1d1-2ff615a114bso306894a91.0;
        Wed, 05 Mar 2025 11:09:58 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741201798; x=1741806598;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=Zodeiabiec4o+24nRPQhB7bjurm79o/P+gs1t8Gp0w0=;
        b=a6qjIMSEtnzUT0DE0JD6g7ecO+bUMzqm9xFhijJqyfx+GiaSAprV5VPtfgXes09hV/
         mwtJuGkrFPh3qagG2n9aSdpEdYZohi4QHlMqcbOAPPFs3oxe82UcNJeJwF+8OKNGPpX8
         Jm86/biXjK2gH5eEesQQav4KpiTbAw5FB+Zh+JzBS1PvdMQ8OaIxHk8WPSBpKgdtqrt7
         Ha9c40XlIzkObFz/ihGwm7a035eN/3jYJ9ScQyIwl9jCbj5JP2jwKa0Et9JREaz/Rdzx
         v1lqFpG/2Q21URm3RlM/hOEGBCVikZOg9AnIVUGDQ0M//evr8FsgLNrHpMX7bBEkPEzv
         NPeQ==
X-Forwarded-Encrypted: i=1; AJvYcCUyxAmHRBnDgjkZVJemCXEaFHgTMincMIepQixOT1FYNtZMjhHL+gF2Fuw2ha5KvQU5XCSFTI8jLDjARRU=@vger.kernel.org, AJvYcCW1g2/3le/85SCV1lQIK2p0uMPxUwZa9N5Nr6lHjZeRC1gxa1rK2t3m/n2QetXJnYFQJ1JL2zkQn8CO@vger.kernel.org, AJvYcCWEDegVTSIqphc+M0zDp3jXn5Cf2QDAn3w64iKQrBPV36zBk7RtXezEZcVCQk+H6jjWSl7S5d67z0kFGtT7aCIR4TA=@vger.kernel.org, AJvYcCXef0zkBurVqxdRS3EypgQlAFAK1D2+g9GQ2iqaiCHN89XB0DIXSJZN+or53xCvh7sPsTPDKS+PZ166LbrP4eXF3w==@vger.kernel.org
X-Gm-Message-State: AOJu0YyshFbjHYlb/LRLlnXxidSlUW/xB7V9VEzFqQopkysjZvrKpdAL
	ERhKWfJfrPr5AHFc0IEpeyleeBTmBAl6td0M+eg20odOQ6lnwBSo
X-Gm-Gg: ASbGnctZvhEi/V0J7AB4tzfah+wCSyCdRhvxqj7IboqvW1caeEC8iICA/cMew3Cvy78
	4t85P5mBYuZ8MIyadrZQhhOeBnpOk5BA9RIvmFxedw0q13Me82C08eC3mEX2uUbvcJrCb5r+Byh
	E6umDsQhmJ18fMNCh7IOSZ8GxbN4LZwA9CznYIT/f934Y6SMGoqRq8LClxgJHdlui++vcN6xlus
	6Bw4U2Gzywa2wqjsodrx2KpLCN9jULuL/oazg4+C8dF6LXzurkP8PUa84BM7oQsuyA5GbZFfEMK
	cXAC0Nyd+2uDZDkfZKhzRq5t60iOcUYkZW9Sz5JagrTDmzGiXJ6MI9SW3hxinU5bLIR6nd3bGSb
	FKlM=
X-Google-Smtp-Source: AGHT+IGNbRJpJbMeXjomF31jB4KIZE5TJ2wjy21GKVWmGQR/3PyTIYjAGlF+BWxQ8A3iKolTn3utJQ==
X-Received: by 2002:a17:90b:3ec5:b0:2ea:8aac:6ac1 with SMTP id 98e67ed59e1d1-2ff617b5145mr663825a91.15.1741201797566;
        Wed, 05 Mar 2025 11:09:57 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 98e67ed59e1d1-2ff53eda418sm1213607a91.45.2025.03.05.11.09.56
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 11:09:57 -0800 (PST)
Date: Thu, 6 Mar 2025 04:09:55 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Bjorn Helgaas <helgaas@kernel.org>,
	Geert Uytterhoeven <geert@linux-m68k.org>,
	Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250305190955.GK847772@rocinante>
References: <20250304171154.njoygsvfd567pb66@thinkpad>
 <20250305173826.GA303920@bhelgaas>
 <20250305182833.cgrwbrcwzjscxmku@thinkpad>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250305182833.cgrwbrcwzjscxmku@thinkpad>

Hello,

[...]
> > > Even though debugfs_init() failure is not supposed to fail the probe(),
> > > dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
> > > failure would be canolically correct IMO.
> > 
> > I'm not sure about this.  What's the requirement to propagate
> > devm_kzalloc() failures?  I think devres will free any allocs that
> > were successful regardless.
> > 
> > IIUC, we resolved the Gray Hawk Single issue by changing
> > dwc_pcie_rasdes_debugfs_init() to return success without doing
> > anything when there's no RAS DES Capability.
> > 
> > But dwc_pcie_debugfs_init() can still return failure, and that still
> > causes dw_pcie_ep_init_registers() to fail, which breaks the "don't
> > propagate debugfs issues upstream" rule:
> > 
> >   int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
> >   {
> >           ...
> >           ret = dwc_pcie_debugfs_init(pci);
> >           if (ret)
> >                   goto err_remove_edma;
> > 
> >           return 0;
> > 
> >   err_remove_edma:
> >           dw_pcie_edma_remove(pci);
> > 
> >           return ret;
> >   }
> > 
> > We can say that kzalloc() failure should "never" happen, and therefore
> > it's OK to fail the driver probe if it happens, but that doesn't seem
> > like a strong argument for breaking the "don't propagate debugfs
> > issues" rule.  And someday there may be other kinds of failures from
> > dwc_pcie_debugfs_init().
> > 
> 
> Fine with me. I was not too sure about propagating failure either.

What if we do this?

diff --git i/drivers/pci/controller/dwc/pcie-designware-debugfs.c w/drivers/pci/controller/dwc/pcie-designware-debugfs.c
index 586a9d107434..fddf71f014c4 100644
--- i/drivers/pci/controller/dwc/pcie-designware-debugfs.c
+++ w/drivers/pci/controller/dwc/pcie-designware-debugfs.c
@@ -162,7 +162,7 @@ void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
 	debugfs_remove_recursive(pci->debugfs->debug_dir);
 }

-int dwc_pcie_debugfs_init(struct dw_pcie *pci)
+void dwc_pcie_debugfs_init(struct dw_pcie *pci)
 {
 	char dirname[DWC_DEBUGFS_BUF_MAX];
 	struct device *dev = pci->dev;
@@ -174,17 +174,15 @@ int dwc_pcie_debugfs_init(struct dw_pcie *pci)
 	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
 	dir = debugfs_create_dir(dirname, NULL);
 	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
-	if (!debugfs)
-		return -ENOMEM;
+	if (!debugfs) {
+		dev_err(dev, "failed to allocate memory for debugfs\n");
+		return;
+	}

 	debugfs->debug_dir = dir;
 	pci->debugfs = debugfs;
 	err = dwc_pcie_rasdes_debugfs_init(pci, dir);
-	if (err) {
-		dev_err(dev, "failed to initialize RAS DES debugfs, err=%d\n",
-			err);
-		return err;
-	}
-
-	return 0;
+	if (err)
+		dev_warn(dev, "failed to initialize RAS DES debugfs, err=%d",
+			 err);
 }
diff --git i/drivers/pci/controller/dwc/pcie-designware-ep.c w/drivers/pci/controller/dwc/pcie-designware-ep.c
index c6e76a07c2c9..11ff292ca87d 100644
--- i/drivers/pci/controller/dwc/pcie-designware-ep.c
+++ w/drivers/pci/controller/dwc/pcie-designware-ep.c
@@ -838,9 +838,7 @@ int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)

 	dw_pcie_ep_init_non_sticky_registers(pci);

-	ret = dwc_pcie_debugfs_init(pci);
-	if (ret)
-		goto err_remove_edma;
+	dwc_pcie_debugfs_init(pci);

 	return 0;

diff --git i/drivers/pci/controller/dwc/pcie-designware-host.c w/drivers/pci/controller/dwc/pcie-designware-host.c
index 2081e8c72d12..6501fb062c70 100644
--- i/drivers/pci/controller/dwc/pcie-designware-host.c
+++ w/drivers/pci/controller/dwc/pcie-designware-host.c
@@ -548,9 +548,7 @@ int dw_pcie_host_init(struct dw_pcie_rp *pp)
 	if (pp->ops->post_init)
 		pp->ops->post_init(pp);

-	ret = dwc_pcie_debugfs_init(pci);
-	if (ret)
-		goto err_stop_link;
+	dwc_pcie_debugfs_init(pci);

 	return 0;

diff --git i/drivers/pci/controller/dwc/pcie-designware.h w/drivers/pci/controller/dwc/pcie-designware.h
index 7f9807d4e5de..dd129718fb41 100644
--- i/drivers/pci/controller/dwc/pcie-designware.h
+++ w/drivers/pci/controller/dwc/pcie-designware.h
@@ -815,12 +815,11 @@ dw_pcie_ep_get_func_from_ep(struct dw_pcie_ep *ep, u8 func_no)
 #endif

 #ifdef CONFIG_PCIE_DW_DEBUGFS
-int dwc_pcie_debugfs_init(struct dw_pcie *pci);
+void dwc_pcie_debugfs_init(struct dw_pcie *pci);
 void dwc_pcie_debugfs_deinit(struct dw_pcie *pci);
 #else
-static inline int dwc_pcie_debugfs_init(struct dw_pcie *pci)
+static inline void dwc_pcie_debugfs_init(struct dw_pcie *pci)
 {
-	return 0;
 }
 static inline void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
 {

I think this would be fine, especially given the rules around debugfs and
a quick look around Git history to see what the prefernce would be typically.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f51.google.com (mail-pj1-f51.google.com [209.85.216.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 191281A840E
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 18:28:43 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.51
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741199325; cv=none; b=XO5qiQWaDCxGp6m1XYqmBumSTswzeRp2MBfY/rT0+AE8XIy0FF2MScsLiM8lDkTMfA1vPcFRFgGgyb/3Soy/thcpjidVe2k8EDhP6mwnhXFObcEN29ui5WCFH+b6Dx7u7p19tVZONvoW5JaoYreDnpXKPLvfgCZluQaqIfjD58s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741199325; c=relaxed/simple;
	bh=NXQNTWJeiSFzjPLlih2rgrST7ZU+kwSlPLsGUkO6i4Q=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=DnEwAESm+ICznqlLv+xm915BPD1JxZJA1iXU4kG8w4dxMB4pJj9+S+UJhVos5wyt6L4V7XPMEhveIBqNM0Gw20RvBIIXjiK6ikzOCwIW8dzGhZiKlcP55sND029pM/2ZUfqLJe4aIbYRZfKKT8gqZZ98e8CsW9IKd5y/8WF7A/U=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org; spf=pass smtp.mailfrom=linaro.org; dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b=rawN+bV5; arc=none smtp.client-ip=209.85.216.51
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=linaro.org
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=linaro.org header.i=@linaro.org header.b="rawN+bV5"
Received: by mail-pj1-f51.google.com with SMTP id 98e67ed59e1d1-2feb9076a1cso12447099a91.0
        for <linux-perf-users@vger.kernel.org>; Wed, 05 Mar 2025 10:28:43 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google; t=1741199323; x=1741804123; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date:from:to
         :cc:subject:date:message-id:reply-to;
        bh=IlUZuaZqa3JLI6rAH+eSKbr5zwilBRdu2UhafBOdrdc=;
        b=rawN+bV57J1B+RzCmZ77uY16uIki+f4lQ9ppIpAkWldjdzIMnlkOIEnCKIAOSOoOGh
         jjkd8TApQJ5n5ruGtpwgOVUfEhGfijcHsYT3n1Lgxot7HWpAEs4033eFWCbcs96WjKh4
         Shg1NLPB9a7KkAA1MexVwFCjo2lSgPJSSk5PWnfaIKds+1qKqn60LIEYTR8TyCkrCjBy
         I+H/B5fyojgxbNVaYXHGwkTySQA5rx9rBSLgztiGEDsiThM6W4QD0by8V20kTq2F/k7H
         WKXJP/nejCrj4h0a4U+O+Cf8sR0SHPVoB1BemiMXZ2cUCARNCV+m5V7+laeDq2CIRyar
         dQiA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741199323; x=1741804123;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=IlUZuaZqa3JLI6rAH+eSKbr5zwilBRdu2UhafBOdrdc=;
        b=Suz6wVsMGfBILE4jQLjeXD9kyjaNjVsTlPS2qxDEuGjrzFiGrIvR20QSpewaqSgy2I
         FIy/452KFwR3SvCyp61smZDb0UCjjUGF5pZsz4yuSoJHGqt2u2sf2hrVlXB8dmlqeqg7
         0LJ1gAoXZ/zUikrl6uOxtCneVqhtSLowwMirTFdeyiDjcb29/GadIhg32i4gDUk4iDNR
         Pk60Sy/E/dP+CsydMmdm9d/B785hJT9ETEqSZ5h5wKQaSCxY/rKeOANyYQi5L+RQ6rzI
         tmge3wpLFSSTGmJtl1b91CRBDJ2bsE352oBIGffTrEiCqquYOr0CtQvJ7vkP+vhG7OND
         8xxA==
X-Forwarded-Encrypted: i=1; AJvYcCVoEvimnOHNexcTG/foChB77ZMmjOvjZZ9q8Ay4sy/yHoOkBufns/PLFSO5m0YWu9hgumZOSavLKgcfLWb833hK@vger.kernel.org
X-Gm-Message-State: AOJu0Yzq3eUWtru5FLj/J7011m7Bqy00kEuiov2NX+4zKl1QjtLnkZQJ
	RFQ5SRwqCRM72djWR7cu63vq0jZM1QirRv6DJRZziORAVxY7cUcrF8fCtvzmTg==
X-Gm-Gg: ASbGncv4+ysJ672ZXn6lInhLxY8vaU0fQAQ4/rzC/kJTyAb1KhyyNkeOH5L1VK7of8U
	+eQbfAgiM7M4W8Sc9lWRHPEECU0BVBRb5oL22/bZYwMcbzvkh6IKPKLQg8xVRWhT+Z9lJHLuhad
	FrSZsci+3LVje6wzr/5rhN2wOVjiJHY5YJw4+kQC2iaWuAohST1+DZIS8aYNJfTr2Kz9rHw8GWf
	AUQPZH9S+We3l2v7ZZ7VSg18z5vz6xymnU6lB2T5hSxt9tys8necbYGdbuWKqVJWQQOcm2Qxn1F
	tX/xl3T0Q3XvnRUZaiWLnWdbkBpLxK0uiRIioynVsp4cjnz0YdUYyMj9
X-Google-Smtp-Source: AGHT+IF+TGwksJJjKWkdx/R8tEcgWJtus8Acn/xVNQz9+4wgbYvkHfwKDe4CHqeQdGOj/ucT3x99Xw==
X-Received: by 2002:a05:6a21:3986:b0:1f0:e84c:866f with SMTP id adf61e73a8af0-1f3494967f1mr8474146637.21.1741199323380;
        Wed, 05 Mar 2025 10:28:43 -0800 (PST)
Received: from thinkpad ([120.60.140.239])
        by smtp.gmail.com with ESMTPSA id 41be03b00d2f7-aee7ddf2444sm12428366a12.3.2025.03.05.10.28.36
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 10:28:42 -0800 (PST)
Date: Wed, 5 Mar 2025 23:58:33 +0530
From: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
To: Bjorn Helgaas <helgaas@kernel.org>
Cc: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>,
	Geert Uytterhoeven <geert@linux-m68k.org>,
	Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250305182833.cgrwbrcwzjscxmku@thinkpad>
References: <20250304171154.njoygsvfd567pb66@thinkpad>
 <20250305173826.GA303920@bhelgaas>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20250305173826.GA303920@bhelgaas>

On Wed, Mar 05, 2025 at 11:38:26AM -0600, Bjorn Helgaas wrote:
> On Tue, Mar 04, 2025 at 10:41:54PM +0530, Manivannan Sadhasivam wrote:
> > On Wed, Mar 05, 2025 at 12:46:38AM +0900, Krzysztof WilczyÅ„ski wrote:
> > > > On Mon, 3 Mar 2025 at 20:47, Krzysztof WilczyÅ„ski <kw@linux.com> wrote:
> > > > > [...]
> > > > > > > +int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > > > > > > +{
> > > > > > > +   char dirname[DWC_DEBUGFS_BUF_MAX];
> > > > > > > +   struct device *dev = pci->dev;
> > > > > > > +   struct debugfs_info *debugfs;
> > > > > > > +   struct dentry *dir;
> > > > > > > +   int ret;
> > > > > > > +
> > > > > > > +   /* Create main directory for each platform driver */
> > > > > > > +   snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> > > > > > > +   dir = debugfs_create_dir(dirname, NULL);
> > > > > > > +   debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > > > > > > +   if (!debugfs)
> > > > > > > +           return -ENOMEM;
> > > > > > > +
> > > > > > > +   debugfs->debug_dir = dir;
> > > > > > > +   pci->debugfs = debugfs;
> > > > > > > +   ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > > > > > +   if (ret)
> > > > > > > +           dev_dbg(dev, "RASDES debugfs init failed\n");
> > > > > >
> > > > > > What will happen if ret != 0? still return 0?
> > > > 
> > > > And that is exactly what happens on Gray Hawk Single with R-Car
> > > > V4M: dw_pcie_find_rasdes_capability() returns NULL, causing
> > > > dwc_pcie_rasdes_debugfs_init() to return -ENODEV.
> > > > 
> > > > Debugfs issues should never be propagated upstream!
> > ...
> 
> > > > So while applying, you changed this like:
> > > > 
> > > >             ret = dwc_pcie_rasdes_debugfs_init(pci, dir);
> > > >     -       if (ret)
> > > >     -               dev_dbg(dev, "RASDES debugfs init failed\n");
> > > >     +       if (ret) {
> > > >     +               dev_err(dev, "failed to initialize RAS DES debugfs\n");
> > > >     +               return ret;
> > > >     +       }
> > > > 
> > > >             return 0;
> > > > 
> > > > Hence this is now a fatal error, causing the probe to fail.
> 
> > Even though debugfs_init() failure is not supposed to fail the probe(),
> > dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
> > failure would be canolically correct IMO.
> 
> I'm not sure about this.  What's the requirement to propagate
> devm_kzalloc() failures?  I think devres will free any allocs that
> were successful regardless.
> 
> IIUC, we resolved the Gray Hawk Single issue by changing
> dwc_pcie_rasdes_debugfs_init() to return success without doing
> anything when there's no RAS DES Capability.
> 
> But dwc_pcie_debugfs_init() can still return failure, and that still
> causes dw_pcie_ep_init_registers() to fail, which breaks the "don't
> propagate debugfs issues upstream" rule:
> 
>   int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
>   {
>           ...
>           ret = dwc_pcie_debugfs_init(pci);
>           if (ret)
>                   goto err_remove_edma;
> 
>           return 0;
> 
>   err_remove_edma:
>           dw_pcie_edma_remove(pci);
> 
>           return ret;
>   }
> 
> We can say that kzalloc() failure should "never" happen, and therefore
> it's OK to fail the driver probe if it happens, but that doesn't seem
> like a strong argument for breaking the "don't propagate debugfs
> issues" rule.  And someday there may be other kinds of failures from
> dwc_pcie_debugfs_init().
> 

Fine with me. I was not too sure about propagating failure either.

- Mani

-- 
à®®à®£à®¿à®µà®£à¯à®£à®©à¯ à®šà®¤à®¾à®šà®¿à®µà®®à¯

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout3.samsung.com (mailout3.samsung.com [203.254.224.33])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 55E1A2E3396
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 12:57:19 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.33
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741179441; cv=none; b=r6oaIYsfeoAYp3qAsIG+VANYxrvu+JBPiswZo+346jQS0l0Ksy7nIja2G59e8PZPNeOLsopPZNKd7Eykop9wo8tgnOvDZ1mzfChnH/OuVtxP7pOBYZzD6P/55Aa4/gIBMXGowJPkTWrMefaEd42PwzF/tnpcZ7sDZJeUsel9unU=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741179441; c=relaxed/simple;
	bh=gd5LQxYSNobGONqsfWu3J4CvsQJn9S8T/g4qqw/qSsQ=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=RxY4iwa48K0cs+EUEVx+9arLEW8DqGGfzXXWNpm+iTNgEkA/8MB8+qNhKWXleCYGFlzHf3UtByoaiDFQz8SD9ooQ7+Gb0GU9r1hsKhoC+hnOlPFCx3ims1W3HOn+YJt+vUDvLjVFNgoYdTi26bbus+iNyJSyiuuHYojzxHAP0wc=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=o+kurU52; arc=none smtp.client-ip=203.254.224.33
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="o+kurU52"
Received: from epcas5p3.samsung.com (unknown [182.195.41.41])
	by mailout3.samsung.com (KnoxPortal) with ESMTP id 20250305125717epoutp03c5f615a37e3095867693531b36eecbe5~p6XkWQB9F2293622936epoutp03J
	for <linux-perf-users@vger.kernel.org>; Wed,  5 Mar 2025 12:57:17 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout3.samsung.com 20250305125717epoutp03c5f615a37e3095867693531b36eecbe5~p6XkWQB9F2293622936epoutp03J
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741179437;
	bh=gd5LQxYSNobGONqsfWu3J4CvsQJn9S8T/g4qqw/qSsQ=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=o+kurU52q76p8064cA/1np7LRzyqDOvytsjGSNEDr0eAzDZtCgr0kyQJc58YJ4liv
	 ClOOHf9oBdHbEAjf6+XDjOVdPczNytOQBXJafOXSE9hyYTSCW2Lw8Buc02nuNwq8V5
	 pkDnpUHIJ7w9Fefjxy5j1AlCRLwBDooBLLDrXx0A=
Received: from epsnrtp3.localdomain (unknown [182.195.42.164]) by
	epcas5p3.samsung.com (KnoxPortal) with ESMTP id
	20250305125716epcas5p322c88e6ed91a5222a4693b12e9234e1b~p6XjsaVpt1709517095epcas5p3K;
	Wed,  5 Mar 2025 12:57:16 +0000 (GMT)
Received: from epsmges5p2new.samsung.com (unknown [182.195.38.174]) by
	epsnrtp3.localdomain (Postfix) with ESMTP id 4Z7CHt4xThz4x9Pp; Wed,  5 Mar
	2025 12:57:14 +0000 (GMT)
Received: from epcas5p1.samsung.com ( [182.195.41.39]) by
	epsmges5p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	BD.F8.19933.A2A48C76; Wed,  5 Mar 2025 21:57:14 +0900 (KST)
Received: from epsmtrp1.samsung.com (unknown [182.195.40.13]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTPA id
	20250305090444epcas5p4acfc664ce6db58fb94e563626d6dba98~p3MhwhOu-1500615006epcas5p4c;
	Wed,  5 Mar 2025 09:04:44 +0000 (GMT)
Received: from epsmgmc1p1new.samsung.com (unknown [182.195.42.40]) by
	epsmtrp1.samsung.com (KnoxPortal) with ESMTP id
	20250305090444epsmtrp18b28e75d93a81114b71ebefec3d4f9cf~p3MhviHD91135411354epsmtrp1b;
	Wed,  5 Mar 2025 09:04:44 +0000 (GMT)
X-AuditID: b6c32a4a-b87c770000004ddd-30-67c84a2aac7e
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgmc1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	13.5D.23488.CA318C76; Wed,  5 Mar 2025 18:04:44 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip2.samsung.com
	(KnoxPortal) with ESMTPA id
	20250305090440epsmtip2174139d7bcd7df32de34daa127ba8ad4~p3MemAZKR0782607826epsmtip2M;
	Wed,  5 Mar 2025 09:04:40 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: =?iso-8859-2?Q?'Krzysztof_Wilczy=F1ski'?= <kw@linux.com>
Cc: "'Geert Uytterhoeven'" <geert@linux-m68k.org>, "'Fan Ni'"
	<nifan.cxl@gmail.com>, <linux-kernel@vger.kernel.org>,
	<linux-pci@vger.kernel.org>, <linux-arm-kernel@lists.infradead.org>,
	<linux-perf-users@vger.kernel.org>, <manivannan.sadhasivam@linaro.org>,
	<lpieralisi@kernel.org>, <robh@kernel.org>, <bhelgaas@google.com>,
	<jingoohan1@gmail.com>, <Jonathan.Cameron@huawei.com>,
	<a.manzanares@samsung.com>, <pankaj.dubey@samsung.com>, <cassel@kernel.org>,
	<18255117159@163.com>, <xueshuai@linux.alibaba.com>,
	<renyu.zj@linux.alibaba.com>, <will@kernel.org>, <mark.rutland@arm.com>,
	"'Yoshihiro Shimoda'" <yoshihiro.shimoda.uh@renesas.com>, "'Linux-Renesas'"
	<linux-renesas-soc@vger.kernel.org>
In-Reply-To: <20250305074447.GC847772@rocinante>
Subject: RE: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Date: Wed, 5 Mar 2025 14:34:39 +0530
Message-ID: <065b01db8dad$a2f0a4a0$e8d1ede0$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="iso-8859-2"
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQJfby7SiE0e/TbLvAHLJIl0P7SXpgHiQm8TAh/83CQB4BrFQwHvpDbsAQ7NFRkCkbJgbAIxNbulA4ETfrmx01XmsA==
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA02TfUxTVxiHOb39glhyBVwPbNp6ZVsGK7ZYusOK25IpuWE6URaXuBjWwV2L
	lLbrh+IyNpQGsKKgwwkNNoLAgDkSyoeglBFAunVDIzY1E0ioAhEdHxsdGQHGWloW/nvOOc+b
	9/zOycvGwr5lRbGzVHpKq5IpCWYIvaP/jdcFMSk/y4WuoteQs2iZha7270S1ZxVosKwBQ1OP
	bTTU4KlkoaZqFxPllywzkPWpi4Ee3q5ioiGLnYmc7c101D49S0PGFSMdjRnPMVDdowc0tNph
	A6im3cNC1QXTAK11d7KQcTQBzS21MtHftgXme1zyRkM5g7xpuQnILvMYi7xuNZDGgRkGaW06
	xyRHXd1Msq+/2HvoTiQnnFdpZGvtN+Tib5fo5MW2JkAuWHekhh7LTlJQskxKy6dUGerMLJV8
	L/FBWvr76QkSoUggSkRvEXyVLIfaS+w7kCpIzlJ60xP8kzKlwbuVKtPpiN3vJGnVBj3FV6h1
	+r0EpclUasSaOJ0sR2dQyeNUlP5tkVAYn+AVP81WXHw+ztBYYe6v5jlWPhjhmkAwG+JieLb8
	PjCBEHYYfgfAApsD8y/+AtA084DhXywCuGI9z9woGfdYGT4Ow20A3q7a45eeAVhfeQH4Dpj4
	m3DCuYL5OAJPgitdM3SfhOEOBuwpLFyXgnEhdE8NrHM4ngIb3W6vxGbT8Wh4uYTrQw6eCIsn
	tvkMDr4V/lI5QfcxhsfBKYc5wLGwvvoF5r8bHy5N1jP8bU/Apf5x4He48O5SyXoyiP8UDP+Y
	rwsU7INFNXXAz+Hwub2N5ecoOF1aGGA5bGytCPhKuNhaS/Pzu7DXWUX383Z4xdFM8zcLhReW
	JwIOB3ZaNngX9Kx2B/xIaBl8yCgDhHlTNvOmbOZN2cybMlwH9CYQSWl0OXJKl6CJV1Gn/v/x
	DHWOFaxPR0xKJ3CPz8f1ARob9AHIxogIzguHXR7GyZSd/pLSqtO1BiWl6wMJ3ve+hEVty1B7
	x0ulTxeJE4ViiUQiTtwjERFcTkGXUR6Gy2V6KpuiNJR2o47GDo7Kp30dc1R0Q/K4I1d0emyE
	3pOnszfM2v7UTEVNb3nloDxi4aBJ6ryXWsH7pCWvjVdhOHyNEdKPVd1yHjXYYew/945/XH7i
	CzJ0J5dq31GHBnql3+1XaGmT/z7ZP1Q0MCmeH453T5q2CghDifRkReT3Z5KeMLu3xEoOTwfx
	5lZzR4SDp4rTqphDZVcEGZ6ID+/ao1NeMpSO8i1Pa1vKTdIGtSU7aI2TfRz7Xb57yFrfHmO+
	Nev66syBzl6hIe3lI8ON0txgR4k1JdfzkeQ8N/pIUNrny8nS5LWg+yj8s0zeoV3Ds4cqtz9r
	ruH1zN+p+FHwKoF3Z0XHU6WuR9fyjgl/4LUQdJ1CJorBtDrZf2vNyhamBAAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrOIsWRmVeSWpSXmKPExsWy7bCSvO4a4RPpBhdeClhcaf/NbjH9sKLF
	kqYMi2MTVjBbPLu1l8lixZeZ7BarFl5js2jo+c1qsenxNVaLy7vmsFmcnXeczeLK1nUsFltf
	vmOyaPnTwmJxt6WT1WLp9YtMFn+37WW0WLT1C7vFwuaXjBb/9+xgt2i5Y2rx/udmNouvez+z
	OYh7LF4xhdVjzbw1jB47Z91l91iwqdSj5chbVo9NqzrZPO5c28PmcehwB1DyoaXHkyvTmTw2
	L6n3+HZmIotH35ZVjB6fN8kF8EVx2aSk5mSWpRbp2yVwZdz9+Iyl4IVgxd+OGcwNjM/4uhg5
	OSQETCQefNnE2sXIxSEksJtRYsWNNmaIhKTE54vrmCBsYYmV/56zg9hCAs8YJd59kwex2QR0
	JJ5c+QNWLyJgI/Fn51sWEJtZ4AGrxNtb1RD125glNu0RBbE5BQwkHj47wghiCwt4Sax8+BCo
	noODRUBFYlKPOIjJK2Ap0fEErJpXQFDi5MwnUBMNJJYs/MUEYWtLLFv4GupKBYmfT5exQlyQ
	JfHz8ANGiBpxiaM/e5gnMArPQjJqFpJRs5CMmoWkZQEjyypGydSC4tz03GTDAsO81HK94sTc
	4tK8dL3k/NxNjOC0oaWxg/Hdtyb9Q4xMHIyHGCU4mJVEeF+fOp4uxJuSWFmVWpQfX1Sak1p8
	iFGag0VJnHelYUS6kEB6YklqdmpqQWoRTJaJg1OqgYllU+/ZbS7nDVSiWZOsX3psLnPw4Z7B
	6/n7Wkxx+Z5eToPSL1a523UbltTM9Ahc9E9GM/Cgot3Ta9K1saIVC5+0i1YE+Pk9uiT648AM
	zS6tnE7lPv4eH9kkjo1KU/52y+94qy8WYXdp14UzXC9N+OIiQg9vLp+k8+Xgik/db1oe5wr+
	8O04wpuo99dI7drthVvnmTMpKi7w/idjk6GaeHH/09X/pxbctOMO9NsaErRpUr2B0EHlusyN
	O3S3PQm4x81Q6nVM5FjtMpX2w2wb1JeVrz5r09KVylLzV81cZm+ED1Pvm6m/7rRFWHd2Mx1g
	mbul7ELg4vPrShIP+Wb8+M695LKs6OInC3flnD3pqsRSnJFoqMVcVJwIAE1XIcOKAwAA
X-CMS-MailID: 20250305090444epcas5p4acfc664ce6db58fb94e563626d6dba98
X-Msg-Generator: CA
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250221132035epcas5p47221a5198df9bf86020abcefdfded789
References: <20250221131548.59616-1-shradha.t@samsung.com>
	<CGME20250221132035epcas5p47221a5198df9bf86020abcefdfded789@epcas5p4.samsung.com>
	<20250221131548.59616-4-shradha.t@samsung.com> <Z8XrYxP_pZr6tFU8@debian>
	<20250303194647.GC1552306@rocinante>
	<CAMuHMdWens9ZZrjNH1Bd2AN3PJEP1KSUGdiJcBCt0uPGH_GiiA@mail.gmail.com>
	<20250304154638.GB2310180@rocinante>
	<061201db8d25$dd1e2bd0$975a8370$@samsung.com>
	<20250305074447.GC847772@rocinante>



> -----Original Message-----
> From: 'Krzysztof Wilczy=F1ski'=20<kw=40linux.com>=0D=0A>=20Sent:=2005=20M=
arch=202025=2013:15=0D=0A>=20To:=20Shradha=20Todi=20<shradha.t=40samsung.co=
m>=0D=0A>=20Cc:=20'Geert=20Uytterhoeven'=20<geert=40linux-m68k.org>;=20'Fan=
=20Ni'=20<nifan.cxl=40gmail.com>;=20linux-kernel=40vger.kernel.org;=20linux=
-=0D=0A>=20pci=40vger.kernel.org;=20linux-arm-kernel=40lists.infradead.org;=
=20linux-perf-users=40vger.kernel.org;=20manivannan.sadhasivam=40linaro.org=
;=0D=0A>=20lpieralisi=40kernel.org;=20robh=40kernel.org;=20bhelgaas=40googl=
e.com;=20jingoohan1=40gmail.com;=20Jonathan.Cameron=40huawei.com;=0D=0A>=20=
a.manzanares=40samsung.com;=20pankaj.dubey=40samsung.com;=20cassel=40kernel=
.org;=2018255117159=40163.com;=0D=0A>=20xueshuai=40linux.alibaba.com;=20ren=
yu.zj=40linux.alibaba.com;=20will=40kernel.org;=20mark.rutland=40arm.com;=
=20'Yoshihiro=20Shimoda'=0D=0A>=20<yoshihiro.shimoda.uh=40renesas.com>;=20'=
Linux-Renesas'=20<linux-renesas-soc=40vger.kernel.org>=0D=0A>=20Subject:=20=
Re:=20=5BPATCH=20v7=203/5=5D=20Add=20debugfs=20based=20silicon=20debug=20su=
pport=20in=20DWC=0D=0A>=20=0D=0A>=20Hello,=0D=0A>=20=0D=0A>=20>=20I=20think=
=20we=20shouldn't=20move=20the=20log=20level=20to=20be=20a=20WARN.=20I=20be=
lieve=20many=0D=0A>=20>=20controllers=20might=20not=20support=20RAS=20DES=
=20feature=20in=20their=20design=20and=0D=0A>=20>=20giving=20a=20warn=20dum=
p=20would=20draw=20unnecessary=20attention.=0D=0A>=20=0D=0A>=20There=20will=
=20be=20no=20backtrack=20printed=20with=20neither=20dev_err()=20nor=20dev_w=
arn(),=20which=20is=20what=20we=20were=20using=20here.=20=20Using=20dev_WAR=
N()=20or=0D=0A>=20the=20WARN()=20macro=20directly=20would=20be=20an=20overk=
ill=20in=20this=20case,=20indeed.=0D=0A>=20=0D=0A=0D=0AOh=20sorry,=20I=20th=
ought=20we=20were=20talking=20about=20WARN()=20here.=0D=0A=0D=0A>=20>=20My=
=20opinion=20is=20to=20silently=20let=20it=20fail=20unless=20the=20user=20i=
s=20actually=0D=0A>=20>=20interested=20in=20getting=20the=20RAS=20DES=20fea=
ture=20up.=0D=0A>=20=0D=0A>=20I=20think,=20what=20we=20have=20there=20now=
=20is=20fine.=20=20We=20don't=20error=20on=20the=20lack=20of=20RAS=20DES=20=
capability=20when=20the=20platform=20does=20not=20support=20it,=0D=0Aand=0D=
=0A>=20only=20return=20an=20error=20following=20a=20memory=20allocation=20f=
ailure,=20which=20should=20ideally=20never=20happen.=0D=0A>=20=0D=0A>=20Tha=
t=20said,=20have=20a=20look=20at=20the=20following:=0D=0A>=20=0D=0A>=20=20=
=20https://web.git.kernel.org/pub/scm/linux/kernel/git/pci/pci.git/log/?h=
=3Dcontroller/dwc=0D=0A>=20=0D=0A>=20This=20is=20how=20the=20code=20looks=
=20like=20at=20the=20moment.=0D=0A>=20=0D=0A>=20We=20can=20still=20move=20i=
t=20to=20dev_dbg(),=20so=20basically=20suppress=20any=20errors=20or=20warni=
ngs=20from=20being=20printed=20outside=20of=20the=20debug=20log=20level,=0D=
=0Aif=20you=0D=0A>=20think=20it=20would=20be=20better.=0D=0A>=20=0D=0A=0D=
=0ANo,=20the=20current=20version=20looks=20perfect.=20Thanks=21=0D=0A=0D=0A=
>=20Thank=20you=21=0D=0A>=20=0D=0A>=20=09Krzysztof=0D=0A=0D=0A

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pj1-f52.google.com (mail-pj1-f52.google.com [209.85.216.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 919171EDA10;
	Thu,  6 Mar 2025 09:02:38 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.216.52
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741251760; cv=none; b=QEN6MsD0vt/SBM6U0hmXqtKhAT0BCN+7h0e2BtylbAXZRc9VVn6mhahOeRuK+MlsAXli+lMsxjCxU4jCCWK6BuFVJ4FObaL1S4kZlxlJAsF3b4+zQovxtCLeCc50LZXLOQonyv3nBY/MI0MvPyvV8CIXfsIVHg4Rk3VQaiLYJdg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741251760; c=relaxed/simple;
	bh=EmzY32j5rrDzC9R6X90mqEI/cN8KHLb58ft9sgUPtjY=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=ofUhNJX/mQ+8zqs0Gk/TdLKCvvwW7HJd1ONpqG8VXR77bRMIkNje0isVZfjQ3BqA1uyG4hdMnpr/CFsnJPiwEZWtph8Nj8XM5+qafoOOxcGF6lQrXpY0LOqsUmulRtnwSWfq8zRAz0Deq151Ot2TBDOzSkuCenAoRo4OaovwBJg=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.216.52
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pj1-f52.google.com with SMTP id 98e67ed59e1d1-2feb91a25bdso666538a91.1;
        Thu, 06 Mar 2025 01:02:38 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741251758; x=1741856558;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=61ZqbVDQw/xvqBk0WBOL0pupyCSc6ErVs2yZMS/tx8g=;
        b=AQ5FqP6VfPPNcJYnrmq4XpuuJUSq07vOciGMMquxTeXLO4mgsJCK6ir5+QB+BeTBjj
         hVhTmrFddAm8saH2cuDrlUai4JiXBHZZypqfQ99b9LwGldbkb+lZkTBv7GLWeWpDlvF4
         F4QeWOGJanJ2KAHJkqGS2fIJT7gRy+wblfYRbxlHb7sbqmV3mUPEXHe//+VhQ3Ccl5ZK
         kwNhDqfO+tE+cG1q6/MW4apXONeUkF7Iar8VL6vUmW+HdF65KhLNMOCEeIV5QPv8GtFV
         mHdA/3iVbSNN07pb/GwYidMSiCDSH3o5GQ4QjfELqJ6mOyYwxmhan3FD+0KHJLCCd0b2
         XHKw==
X-Forwarded-Encrypted: i=1; AJvYcCUfArC9EKanpeTNI6iMvsdyO4LuiH6gwetQZWZU2Czp08t0Ckuq8WN6qUKaV6vas1+kvvvhkMtQ1IHn@vger.kernel.org, AJvYcCWmRtKSSUCc2x5bHtX8dwGmW4hmRCPPagr3OhcqQuZP2NmvsIFTeYt/9d0q3vxhn+DLQ16UhMizsscvrsJHTzVkLQ==@vger.kernel.org, AJvYcCXlXvaerZWUNODoU3oqOvGajzWhBoa1Oh4vEZ4gu6VmXMm8zC+xyUHQ1n/9O1FemHuvo2oku2A/QVgfipYXJJEr2dk=@vger.kernel.org, AJvYcCXn1k4xkNsbR9W0DaQoUV84Af9S8nryi2Chh9WlY5oOR+XMUcmL261J+cvNrf+hvCj+x286oDqqH69a0zg=@vger.kernel.org
X-Gm-Message-State: AOJu0YyaaAvOdf35JnE70AkrYp2A0xtagsau6wH+NsRqPNFlibtRb8JM
	M5sgLtVophYz8U6dothx+KY2X8lSHJIkkQD2GOy7A+emn0rCj51B
X-Gm-Gg: ASbGncvZCkaZAC+czwhUqNv0MYc3f2KlDuTbGau0R9FwrMLLof3oN6peGk/aSCoeVKY
	TkfOoDq9Hdn+IvIGSxIPsWp3gLbSS5lNJzb5OCZRB5us3XnK4OoZYwrMmIZpjNPM8woYqN1prjG
	PRLHOs+XuCV4gaohM5cuM4FOF3KrHWtlwqo6Ty37DGaPA5CfswVIyjNGHacgueAFxgFGEW4qmy+
	UDs3MhlSGEvJWeJJC7YK12ZC5eBTaYKs19ANCH6juO5OP5nhw4oYqzBzhzSb9y0OCkGwg6p3Tnm
	xt1mQTZNTm9kxeofNYJPLlI5+qHvTnmZqGGhpSFzqr5ey2wMGtMXo5NkeNrkEzpTRALL/IWqwbH
	GNf0=
X-Google-Smtp-Source: AGHT+IEVObRPs9r9DCgAFKVxTkcg7YE/ev/oTYXjSeBAHqcHwBFpzXUfu6D3RSOSTJvuqgree5Nh5A==
X-Received: by 2002:a17:90b:4c07:b0:2ff:6ac2:c5a6 with SMTP id 98e67ed59e1d1-2ff6ac2c770mr1605779a91.31.1741251757794;
        Thu, 06 Mar 2025 01:02:37 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 98e67ed59e1d1-2ff4e75ed7csm2641751a91.3.2025.03.06.01.02.36
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 06 Mar 2025 01:02:37 -0800 (PST)
Date: Thu, 6 Mar 2025 18:02:34 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Geert Uytterhoeven <geert@linux-m68k.org>
Cc: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>,
	Bjorn Helgaas <helgaas@kernel.org>, Fan Ni <nifan.cxl@gmail.com>,
	Shradha Todi <shradha.t@samsung.com>, linux-kernel@vger.kernel.org,
	linux-pci@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250306090234.GA390800@rocinante>
References: <20250304171154.njoygsvfd567pb66@thinkpad>
 <20250305173826.GA303920@bhelgaas>
 <20250305182833.cgrwbrcwzjscxmku@thinkpad>
 <20250305190955.GK847772@rocinante>
 <CAMuHMdVRSjkss3gPnocXpfPQ=mEo4AevpaU=fdGvm=kb3RTmcQ@mail.gmail.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAMuHMdVRSjkss3gPnocXpfPQ=mEo4AevpaU=fdGvm=kb3RTmcQ@mail.gmail.com>

Hello,

[...]
> Another issue is that the caller does not handle failures correctly,
> given (A) the irqdomain WARNING I got, and (B) the half-registered
> PCI bus, oopsing on "lspci"...

This is something we will look into.  A more robust DesignWare core is
something we would definitely want to have.

Sorry about the issues with this...

[...]
> > -int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> > +void dwc_pcie_debugfs_init(struct dw_pcie *pci)
> >  {
> >         char dirname[DWC_DEBUGFS_BUF_MAX];
> >         struct device *dev = pci->dev;
> > @@ -174,17 +174,15 @@ int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> >         snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
> >         dir = debugfs_create_dir(dirname, NULL);
> >         debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> > -       if (!debugfs)
> > -               return -ENOMEM;
> > +       if (!debugfs) {
> > +               dev_err(dev, "failed to allocate memory for debugfs\n");
> 
> There is no need to print an error message when a memory allocation
> fails, as the memory allocation core already takes care of that.
> So please drop the dev_err() call.

Done.  Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-vk1-f177.google.com (mail-vk1-f177.google.com [209.85.221.177])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A423E1FC119;
	Thu,  6 Mar 2025 08:22:49 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.221.177
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741249371; cv=none; b=FbzSJp8/3IEpZYxZGbIDoRIQp0tfzZsPQyXgllR07/g6Pd3/98zwPJaLA0mvPl9WY4jwxwFhXd6k/4KpgYUgWkzp2Hnqa5oe+bSV+si7LaHBh32oRICVPZ7HoGn16Q7NX4OhbbHXyvq8P9weBNEvwpKpO64/cYf7x5WF+WSP4dg=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741249371; c=relaxed/simple;
	bh=pukdi8UtngLWSTK0RiOB7GIFMpGrGcHkmXsaY8bzxNo=;
	h=MIME-Version:References:In-Reply-To:From:Date:Message-ID:Subject:
	 To:Cc:Content-Type; b=lZJVX/ug/O8se+b4kjo+35gQvKGkqz8qFZd+oi3Ry71qQrINSj8ISwgJthvDf1ngme2yvoyq/g5io9AfTjKf9blew2GrGMThmycrD9DH4xUV8QehwHpEEsi5HAk9oXyHdmjlK6v1admkoO1IcL6NM4f0k/s8WUcbBCL3ku1Ch90=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.221.177
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=linux-m68k.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-vk1-f177.google.com with SMTP id 71dfb90a1353d-523bf140eccso510520e0c.0;
        Thu, 06 Mar 2025 00:22:49 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741249368; x=1741854168;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=FRrVZ0Qb4mFOKQncQdIGVomsgNpOi0dxaE9w627ruA0=;
        b=eGanvIMXSJWnPiFV4dC92Nw+PWCua4AcTfk4ndQNEUGS3LUvWQ1vQOsdSMZjxupD7N
         UY10WWViE0FWGkAiRcTgch+zOw3a7p4oW+ciNOMum8QJsgSJQKwcVelKWvjFew8qSjtY
         TDTyA+XVhjcXJ+MKtX8/FWelm76I1z39OSEKQmr8nJGJIdDLr16V1LHK9duQaXunTTIz
         KF2g7p3r20E/776NKCHEQMI7mQwC4hY/5QbZN8ezHAWI4DuhfaCN0DQLjSuhbur6DrzR
         ygfRSrp+GAjrA0m6F9dV6LZ9z6iUm99r1V/F0bSdaJkN0WKZeIiz9t7DUTpm5ctlM+hH
         Yhrw==
X-Forwarded-Encrypted: i=1; AJvYcCUwIuKa7Cn7f8tEE5lmjOKktiCQDBKZrioj1tXZiymQMpsKeFoQ/UVIkaWa8xjivxEo7ZQP5UteKHcVE0briVuqFg==@vger.kernel.org, AJvYcCVTo9Tsxvz2Q1fi/KpMhw42Xpg58MYGcaTgbJVWwQxlyE1PG76xcPO88hRVnjQeHZTfMm4ZsEPeaG8I@vger.kernel.org, AJvYcCVsOUXveQoQFzFPppUY5EuGNiZfsXGBd8oytbRA6gDl8BOg9kIf1oYrR0ropwERXeqTDNgM7I2scq7vyO0=@vger.kernel.org, AJvYcCWayD2tqK+rG5bxaTr7B1/nH6G2fyeI/6oA38Mu1z6wq+srOv9nrae2eTDa85RVfyuKahlVEIRVsmHAaz06UfHsYaI=@vger.kernel.org
X-Gm-Message-State: AOJu0Ywqp/Lq5g7Y0fZxR39dJKkYoE09UVENgKv6uTn6Oe3SUIF32XlM
	EAWK2VgUKhUw8/YnDk2J/gMj/6c+CNal9PlYkniyPaNk6lJtQxiD9t+IoXbC
X-Gm-Gg: ASbGncuSBKBmIPnNmvW2ZNKFBz72ZTMQN8eQ+JBi40/7MBfHB2WvG5o/tlO3klHbVGm
	ABF1Z4kMr6PJy1Xiu5L0chW66kt8sZ1tvOnIVH0WPrL9OR3eA6yPSJNfmjU21HbPYYWbsn3/UR8
	9SmOgWFa03Brk41+hPXXmk7y7V4sU+G1g/2AZfRbf8EMD0r3PPdFMZHNIBYwyO2rYql95+Jq3xo
	SMC8AQ7AlBH6E56py0FfB1y774jvxiPG5vK/rktPSX9U8onRbc+DAFQYFo557xI5zWTuDsQQFmh
	Sqeg5VPDf+773QZnXKf7zREjJewIQs3N1sb/2uk8FYut3UImwasj68VkYsM9y5VF4ra2qisg+EK
	qRAMkHgg=
X-Google-Smtp-Source: AGHT+IEF7Bk+YzM0FJVs21ZthTCQsIgAALWxRqcwaxTWxnJ87UxJKa7kaDN1WW94AZpty8Xphy+TTA==
X-Received: by 2002:a05:6122:4d19:b0:50d:39aa:7881 with SMTP id 71dfb90a1353d-523d4f005f9mr1580065e0c.0.1741249367680;
        Thu, 06 Mar 2025 00:22:47 -0800 (PST)
Received: from mail-ua1-f41.google.com (mail-ua1-f41.google.com. [209.85.222.41])
        by smtp.gmail.com with ESMTPSA id 71dfb90a1353d-523d8a85320sm119527e0c.8.2025.03.06.00.22.46
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Thu, 06 Mar 2025 00:22:46 -0800 (PST)
Received: by mail-ua1-f41.google.com with SMTP id a1e0cc1a2514c-860f0e91121so1761709241.0;
        Thu, 06 Mar 2025 00:22:46 -0800 (PST)
X-Forwarded-Encrypted: i=1; AJvYcCVAfut96joLXAyWozfcykF+WpHhLbQtoDpjHrCD60tzyXlwCX8SrZhxm9JO9MNhYeuKbOPIi7gotObBmX7a0qbtyvc=@vger.kernel.org, AJvYcCVdAK6Q7KYjQy9b2qw6HAFQOfv/lb7fk3CSsnftfhhNGn1KTYqicbbk+KUKc8DQXFg1ef/yUbu4H85OC/4kCrf8LQ==@vger.kernel.org, AJvYcCWj79hA4cxkZIRy8OQv92gN/vrtipYascz63x5WHO6oLMdvWRFMsJ+POg3Xotv8XWcps8y4Tok3U0keNpg=@vger.kernel.org, AJvYcCXWMIzzShLJJ38t/LAzL7Ww7kdkRyPNb0PR3pWMlK7uF0dDYlOhv+pZHuw9d4n4bW3z3GjdOW2DMGeG@vger.kernel.org
X-Received: by 2002:a67:f948:0:b0:4c1:b01f:8c7 with SMTP id
 ada2fe7eead31-4c2f66d367bmr1172152137.8.1741249365980; Thu, 06 Mar 2025
 00:22:45 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <20250304171154.njoygsvfd567pb66@thinkpad> <20250305173826.GA303920@bhelgaas>
 <20250305182833.cgrwbrcwzjscxmku@thinkpad> <20250305190955.GK847772@rocinante>
In-Reply-To: <20250305190955.GK847772@rocinante>
From: Geert Uytterhoeven <geert@linux-m68k.org>
Date: Thu, 6 Mar 2025 09:22:34 +0100
X-Gmail-Original-Message-ID: <CAMuHMdVRSjkss3gPnocXpfPQ=mEo4AevpaU=fdGvm=kb3RTmcQ@mail.gmail.com>
X-Gm-Features: AQ5f1JrhQM2yc1IEyYpQi2IEGHYpY6yhiE8-bZMdZwiJJ0QwJlNhyHxfSkZ8qMU
Message-ID: <CAMuHMdVRSjkss3gPnocXpfPQ=mEo4AevpaU=fdGvm=kb3RTmcQ@mail.gmail.com>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
To: =?UTF-8?Q?Krzysztof_Wilczy=C5=84ski?= <kw@linux.com>
Cc: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>, Bjorn Helgaas <helgaas@kernel.org>, 
	Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>, 
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, 
	linux-arm-kernel@lists.infradead.org, linux-perf-users@vger.kernel.org, 
	lpieralisi@kernel.org, robh@kernel.org, bhelgaas@google.com, 
	jingoohan1@gmail.com, Jonathan.Cameron@huawei.com, a.manzanares@samsung.com, 
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com, 
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com, will@kernel.org, 
	mark.rutland@arm.com, Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>, 
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

Hi Krzysztof,

On Wed, 5 Mar 2025 at 20:10, Krzysztof Wilczy=C5=84ski <kw@linux.com> wrote=
:
> [...]
> > > > Even though debugfs_init() failure is not supposed to fail the prob=
e(),
> > > > dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating=
 that
> > > > failure would be canolically correct IMO.
> > >
> > > I'm not sure about this.  What's the requirement to propagate
> > > devm_kzalloc() failures?  I think devres will free any allocs that
> > > were successful regardless.
> > >
> > > IIUC, we resolved the Gray Hawk Single issue by changing
> > > dwc_pcie_rasdes_debugfs_init() to return success without doing
> > > anything when there's no RAS DES Capability.
> > >
> > > But dwc_pcie_debugfs_init() can still return failure, and that still
> > > causes dw_pcie_ep_init_registers() to fail, which breaks the "don't
> > > propagate debugfs issues upstream" rule:
> > >
> > >   int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
> > >   {
> > >           ...
> > >           ret =3D dwc_pcie_debugfs_init(pci);
> > >           if (ret)
> > >                   goto err_remove_edma;
> > >
> > >           return 0;
> > >
> > >   err_remove_edma:
> > >           dw_pcie_edma_remove(pci);
> > >
> > >           return ret;
> > >   }
> > >
> > > We can say that kzalloc() failure should "never" happen, and therefor=
e
> > > it's OK to fail the driver probe if it happens, but that doesn't seem
> > > like a strong argument for breaking the "don't propagate debugfs
> > > issues" rule.  And someday there may be other kinds of failures from
> > > dwc_pcie_debugfs_init().

pcie-designware-debugfs.c only does small allocations.  If any of
these fail, you have much bigger problems, and the system will die soon,
irrespective of propagating the -ENOMEM or not...

Another issue is that the caller does not handle failures correctly,
given (A) the irqdomain WARNING I got, and (B) the half-registered
PCI bus, oopsing on "lspci"...

> > Fine with me. I was not too sure about propagating failure either.
>
> What if we do this?
>
> diff --git i/drivers/pci/controller/dwc/pcie-designware-debugfs.c w/drive=
rs/pci/controller/dwc/pcie-designware-debugfs.c
> index 586a9d107434..fddf71f014c4 100644
> --- i/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ w/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -162,7 +162,7 @@ void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
>         debugfs_remove_recursive(pci->debugfs->debug_dir);
>  }
>
> -int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +void dwc_pcie_debugfs_init(struct dw_pcie *pci)
>  {
>         char dirname[DWC_DEBUGFS_BUF_MAX];
>         struct device *dev =3D pci->dev;
> @@ -174,17 +174,15 @@ int dwc_pcie_debugfs_init(struct dw_pcie *pci)
>         snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(de=
v));
>         dir =3D debugfs_create_dir(dirname, NULL);
>         debugfs =3D devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> -       if (!debugfs)
> -               return -ENOMEM;
> +       if (!debugfs) {
> +               dev_err(dev, "failed to allocate memory for debugfs\n");

There is no need to print an error message when a memory allocation
fails, as the memory allocation core already takes care of that.
So please drop the dev_err() call.

> +               return;
> +       }
>

Gr{oetje,eeting}s,

                        Geert

--=20
Geert Uytterhoeven -- There's lots of Linux beyond ia32 -- geert@linux-m68k=
.org

In personal conversations with technical people, I call myself a hacker. Bu=
t
when I'm talking to journalists I just say "programmer" or something like t=
hat.
                                -- Linus Torvalds

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mail-pl1-f173.google.com (mail-pl1-f173.google.com [209.85.214.173])
	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 70EAB2571C6;
	Wed,  5 Mar 2025 21:57:35 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=209.85.214.173
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741211857; cv=none; b=Rquon8wcHx3hvbJTn+ap1RlcXy/9XD1Ka7qaFZIabZ3+pFBE+VlGugk74+BpkRohbSfLm62qgLFvM7ASjUA+eOqOQ0H1gMII8EXAVckSkG0TRUwtIQnQnVPVCnb6xoyrfmbkyJ5dJdQDdC6+QP8unEjm9fY9mUQTJxa877sCGFE=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741211857; c=relaxed/simple;
	bh=pXA55zWb3OLx17xkUOLHzdtk1lZRc2oejxk9utsYbcI=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=HPf+szcXlj+PkDx8fx1wMyo+UqkHk6JCtSwr7O2fv0P1pNNSLnPZ8mRDUBugfx5sekORocg7GENsF27/OHUAK8NYX444VZzq5IHQKRyfLX32V6cfTh/lUFqntTYgrqrgCOYOvB4zqFLdm6JDC1x6JivnhHW55KJMcdANvjH8WQY=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com; spf=pass smtp.mailfrom=gmail.com; arc=none smtp.client-ip=209.85.214.173
Authentication-Results: smtp.subspace.kernel.org; dmarc=fail (p=none dis=none) header.from=linux.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=gmail.com
Received: by mail-pl1-f173.google.com with SMTP id d9443c01a7336-22113560c57so137423925ad.2;
        Wed, 05 Mar 2025 13:57:35 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1741211854; x=1741816654;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:from:date:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=G5oLj+118MekjPiNQhRObsqao3JOH+wuRmhMOoWyOZI=;
        b=lSA8E3FkoOTtRoNF39xTPLwpfw5dljYujIsdGtqLChKKl1a0pC1OpnahfFleIkLxtH
         nfqKe2CHgnnGTID7LdWS7YSVpTY+QE8s4f7IHqc35A6bW2f19Y5DgmSLYiLLONLlJ81E
         9geTuhREoIiOMvTwGcBeGiRw+7IN5C8VUVT0KzvQ6MfBMb/yg0W1kd3DoqaWqtyDksf8
         PwKRkkCXlEe9cugn3abFkHI7ev5gDJAl00Vub7JgQBhCx7jA+lKGh1Lr6BWhP3ylGWTM
         mZOtAtEb3EaEx1iHZENT/nuYrbFZuc3jzq19VIO+Ho/BVemkZTtf+ZhEyiKKHteLaOmc
         OJZQ==
X-Forwarded-Encrypted: i=1; AJvYcCV+MvpFMj59JwBOZyHyV1NHBbUi4HaScU+c0P8pBPT5xFkAYsrhXKo4RZxMCAbQJC0rWPzCveg+VcikflgVqgQd0HY=@vger.kernel.org, AJvYcCVbZABflsbLXbvzMbCphfnxasfjQ6bw9HoxRTpmYC6kywAQ/SMS3cxQQoJudvgE4xEwF35y1Yr57XmptjJF6POPZw==@vger.kernel.org, AJvYcCWjOLSRvfQPX6S1OVVXJbG66WvqTi4hjO1oUOd/1Nuzz2Ea9Z4kUG6+xCDoJ3b1h9xb1pz54uUcvMJC@vger.kernel.org, AJvYcCXPJY7YFyFhQ0ZxAY82ipll/qgrYdO/y9o7FMLqv5OY27oUCveJ/BurhhycXGspRCcb7cIZFgkVQgbAWvU=@vger.kernel.org
X-Gm-Message-State: AOJu0YygUezAjq7czkwR2Y0OD6+8HkTr+zL79MD9Dkr0L5dqwHHfjHMf
	KqsWlqztjXi5z/Guig6VhQ8IONk0ox7SY/yQD4/hFQ9GN47aTJvk
X-Gm-Gg: ASbGncuLRtlSkjybb30jQXWK2bHsM5jgohT+oW5OulD68lIR7hsA3B6BAEBJS1t+9Wr
	OBbbuk7Q1QxOkGc9BAoOiNh7gXB4yGAbqFDVqD+ofaJJJ2FFy8YjJkb/+azZD2sqb9a+hJ+Tw+1
	eowfgUyrK2QA/xbtFJkGGd9pPRKdFIOhhBrOtawXyVMPdTVXCcXFXbWZsRIfVMby/evqRt47ygy
	iD3ir6QZYAex9H5ZYYVucjSsDudWGYx61BLjcahnrT4bZEc7oUD2lXLM4w2J7ANL0ogDSTpR5jm
	9PWLUmtY76SRT49727Q2h0UYmmKtEwsGi7OtQWO9yfmPMBWfSANxq2WXtAd3dt5uVx40E8kmpSc
	BS9A=
X-Google-Smtp-Source: AGHT+IGuIOJavdPgCJ9sCafNt1cSRA420lYDVSVad8g7o0o+KgD598cgIajBU5IrPyUL8MNnaUygNQ==
X-Received: by 2002:a05:6a21:1f81:b0:1ee:d6ff:5abd with SMTP id adf61e73a8af0-1f34947e736mr9366143637.14.1741211854471;
        Wed, 05 Mar 2025 13:57:34 -0800 (PST)
Received: from localhost (fpd11144dd.ap.nuro.jp. [209.17.68.221])
        by smtp.gmail.com with UTF8SMTPSA id 41be03b00d2f7-aee7dec415asm12522672a12.54.2025.03.05.13.57.33
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Wed, 05 Mar 2025 13:57:33 -0800 (PST)
Date: Thu, 6 Mar 2025 06:57:31 +0900
From: Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kw@linux.com>
To: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Bjorn Helgaas <helgaas@kernel.org>,
	Geert Uytterhoeven <geert@linux-m68k.org>,
	Fan Ni <nifan.cxl@gmail.com>, Shradha Todi <shradha.t@samsung.com>,
	linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-perf-users@vger.kernel.org, lpieralisi@kernel.org,
	robh@kernel.org, bhelgaas@google.com, jingoohan1@gmail.com,
	Jonathan.Cameron@huawei.com, a.manzanares@samsung.com,
	pankaj.dubey@samsung.com, cassel@kernel.org, 18255117159@163.com,
	xueshuai@linux.alibaba.com, renyu.zj@linux.alibaba.com,
	will@kernel.org, mark.rutland@arm.com,
	Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>,
	Linux-Renesas <linux-renesas-soc@vger.kernel.org>
Subject: Re: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Message-ID: <20250305215731.GL847772@rocinante>
References: <20250304171154.njoygsvfd567pb66@thinkpad>
 <20250305173826.GA303920@bhelgaas>
 <20250305182833.cgrwbrcwzjscxmku@thinkpad>
 <20250305190955.GK847772@rocinante>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20250305190955.GK847772@rocinante>

> > > > Even though debugfs_init() failure is not supposed to fail the probe(),
> > > > dwc_pcie_rasdes_debugfs_init() has a devm_kzalloc() and propagating that
> > > > failure would be canolically correct IMO.
> > > 
> > > I'm not sure about this.  What's the requirement to propagate
> > > devm_kzalloc() failures?  I think devres will free any allocs that
> > > were successful regardless.
> > > 
> > > IIUC, we resolved the Gray Hawk Single issue by changing
> > > dwc_pcie_rasdes_debugfs_init() to return success without doing
> > > anything when there's no RAS DES Capability.
> > > 
> > > But dwc_pcie_debugfs_init() can still return failure, and that still
> > > causes dw_pcie_ep_init_registers() to fail, which breaks the "don't
> > > propagate debugfs issues upstream" rule:
> > > 
> > >   int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
> > >   {
> > >           ...
> > >           ret = dwc_pcie_debugfs_init(pci);
> > >           if (ret)
> > >                   goto err_remove_edma;
> > > 
> > >           return 0;
> > > 
> > >   err_remove_edma:
> > >           dw_pcie_edma_remove(pci);
> > > 
> > >           return ret;
> > >   }
> > > 
> > > We can say that kzalloc() failure should "never" happen, and therefore
> > > it's OK to fail the driver probe if it happens, but that doesn't seem
> > > like a strong argument for breaking the "don't propagate debugfs
> > > issues" rule.  And someday there may be other kinds of failures from
> > > dwc_pcie_debugfs_init().
> > > 
> > 
> > Fine with me. I was not too sure about propagating failure either.
> 
> What if we do this?
> 
> diff --git i/drivers/pci/controller/dwc/pcie-designware-debugfs.c w/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> index 586a9d107434..fddf71f014c4 100644
> --- i/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> +++ w/drivers/pci/controller/dwc/pcie-designware-debugfs.c
> @@ -162,7 +162,7 @@ void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
>  	debugfs_remove_recursive(pci->debugfs->debug_dir);
>  }
> 
> -int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +void dwc_pcie_debugfs_init(struct dw_pcie *pci)
>  {
>  	char dirname[DWC_DEBUGFS_BUF_MAX];
>  	struct device *dev = pci->dev;
> @@ -174,17 +174,15 @@ int dwc_pcie_debugfs_init(struct dw_pcie *pci)
>  	snprintf(dirname, DWC_DEBUGFS_BUF_MAX, "dwc_pcie_%s", dev_name(dev));
>  	dir = debugfs_create_dir(dirname, NULL);
>  	debugfs = devm_kzalloc(dev, sizeof(*debugfs), GFP_KERNEL);
> -	if (!debugfs)
> -		return -ENOMEM;
> +	if (!debugfs) {
> +		dev_err(dev, "failed to allocate memory for debugfs\n");
> +		return;
> +	}
> 
>  	debugfs->debug_dir = dir;
>  	pci->debugfs = debugfs;
>  	err = dwc_pcie_rasdes_debugfs_init(pci, dir);
> -	if (err) {
> -		dev_err(dev, "failed to initialize RAS DES debugfs, err=%d\n",
> -			err);
> -		return err;
> -	}
> -
> -	return 0;
> +	if (err)
> +		dev_warn(dev, "failed to initialize RAS DES debugfs, err=%d",
> +			 err);
>  }
> diff --git i/drivers/pci/controller/dwc/pcie-designware-ep.c w/drivers/pci/controller/dwc/pcie-designware-ep.c
> index c6e76a07c2c9..11ff292ca87d 100644
> --- i/drivers/pci/controller/dwc/pcie-designware-ep.c
> +++ w/drivers/pci/controller/dwc/pcie-designware-ep.c
> @@ -838,9 +838,7 @@ int dw_pcie_ep_init_registers(struct dw_pcie_ep *ep)
> 
>  	dw_pcie_ep_init_non_sticky_registers(pci);
> 
> -	ret = dwc_pcie_debugfs_init(pci);
> -	if (ret)
> -		goto err_remove_edma;
> +	dwc_pcie_debugfs_init(pci);
> 
>  	return 0;
> 
> diff --git i/drivers/pci/controller/dwc/pcie-designware-host.c w/drivers/pci/controller/dwc/pcie-designware-host.c
> index 2081e8c72d12..6501fb062c70 100644
> --- i/drivers/pci/controller/dwc/pcie-designware-host.c
> +++ w/drivers/pci/controller/dwc/pcie-designware-host.c
> @@ -548,9 +548,7 @@ int dw_pcie_host_init(struct dw_pcie_rp *pp)
>  	if (pp->ops->post_init)
>  		pp->ops->post_init(pp);
> 
> -	ret = dwc_pcie_debugfs_init(pci);
> -	if (ret)
> -		goto err_stop_link;
> +	dwc_pcie_debugfs_init(pci);
> 
>  	return 0;
> 
> diff --git i/drivers/pci/controller/dwc/pcie-designware.h w/drivers/pci/controller/dwc/pcie-designware.h
> index 7f9807d4e5de..dd129718fb41 100644
> --- i/drivers/pci/controller/dwc/pcie-designware.h
> +++ w/drivers/pci/controller/dwc/pcie-designware.h
> @@ -815,12 +815,11 @@ dw_pcie_ep_get_func_from_ep(struct dw_pcie_ep *ep, u8 func_no)
>  #endif
> 
>  #ifdef CONFIG_PCIE_DW_DEBUGFS
> -int dwc_pcie_debugfs_init(struct dw_pcie *pci);
> +void dwc_pcie_debugfs_init(struct dw_pcie *pci);
>  void dwc_pcie_debugfs_deinit(struct dw_pcie *pci);
>  #else
> -static inline int dwc_pcie_debugfs_init(struct dw_pcie *pci)
> +static inline void dwc_pcie_debugfs_init(struct dw_pcie *pci)
>  {
> -	return 0;
>  }
>  static inline void dwc_pcie_debugfs_deinit(struct dw_pcie *pci)
>  {
> 
> I think this would be fine, especially given the rules around debugfs and
> a quick look around Git history to see what the prefernce would be typically.

Changed dev_warn() to dev_err() per Bjorn's feedback off mailing list,
and squashed against the current code on the branch.

Thank you!

	Krzysztof

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from mailout4.samsung.com (mailout4.samsung.com [203.254.224.34])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id E4CD71DE3C9
	for <linux-perf-users@vger.kernel.org>; Sat,  8 Mar 2025 15:54:06 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=203.254.224.34
ARC-Seal: i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741449249; cv=none; b=j6Iz0S+mR8bIrOJvZ8vYQLNYWl++s9Z4H2gOOSD+DOVftfsPgfD7znt+6KKZArS5tCQ2Ulhz2NxYYZIINwBnRofzlD8IePzJ3S8DWM2FPMmZBHZxUYnxiRRU10lNy+IPNhWNeaHIyvvn+zZ7PBJm9w8epMS76EI/ygb79KzSm1s=
ARC-Message-Signature: i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741449249; c=relaxed/simple;
	bh=i/3C21Ouc5wb7m+EDDkgsSLMwPz7bLpJ3rYm+hP4Uyc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:Message-ID:MIME-Version:
	 Content-Type:References; b=MSIuo1aINHvbVJbl+x/G/j+gF7eZ1MxTJvgM+hnpXpfrpu3qVxfjv1wfQTimqpJzstac9JmzIeDoLJgmmAdoMOXeqmbEuzd+EukIYcX/vxbx6v4sJM2oJjkSETQkyXad+hb9snxmxtxRx08r+5gpQbeRZTlkJJ2MFlAMZHD0RTU=
ARC-Authentication-Results: i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com; spf=pass smtp.mailfrom=samsung.com; dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b=dNAlUtBv; arc=none smtp.client-ip=203.254.224.34
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=samsung.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samsung.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=samsung.com header.i=@samsung.com header.b="dNAlUtBv"
Received: from epcas5p2.samsung.com (unknown [182.195.41.40])
	by mailout4.samsung.com (KnoxPortal) with ESMTP id 20250308155404epoutp04a693056b46e7864a65637674aef30fca~q3tyWzMgQ1104711047epoutp04I
	for <linux-perf-users@vger.kernel.org>; Sat,  8 Mar 2025 15:54:04 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout4.samsung.com 20250308155404epoutp04a693056b46e7864a65637674aef30fca~q3tyWzMgQ1104711047epoutp04I
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
	s=mail20170921; t=1741449244;
	bh=i/3C21Ouc5wb7m+EDDkgsSLMwPz7bLpJ3rYm+hP4Uyc=;
	h=From:To:Cc:In-Reply-To:Subject:Date:References:From;
	b=dNAlUtBvWU+htWdxzpD8J/U6LU4UvPGjU11TezQby00F4saXZHe1iRHUUqP2eamZO
	 HAS2f2PTv2BiRmSZwSEHqlMWbJD3KwCxaPxMIIyWMd/GZJulhzxLQqJ/vtb1RhQosQ
	 TPX5tb1YorkST6y6S6DW8fJS01bV7rkp6fM78mBc=
Received: from epsnrtp2.localdomain (unknown [182.195.42.163]) by
	epcas5p4.samsung.com (KnoxPortal) with ESMTP id
	20250308155404epcas5p4132d2632e3ceb47fb6e35c789c35faca~q3txzkTg70499304993epcas5p4u;
	Sat,  8 Mar 2025 15:54:04 +0000 (GMT)
Received: from epsmges5p2new.samsung.com (unknown [182.195.38.177]) by
	epsnrtp2.localdomain (Postfix) with ESMTP id 4Z974V56MTz4x9Pt; Sat,  8 Mar
	2025 15:54:02 +0000 (GMT)
Received: from epcas5p3.samsung.com ( [182.195.41.41]) by
	epsmges5p2new.samsung.com (Symantec Messaging Gateway) with SMTP id
	50.14.19933.A186CC76; Sun,  9 Mar 2025 00:54:02 +0900 (KST)
Received: from epsmtrp2.samsung.com (unknown [182.195.40.14]) by
	epcas5p2.samsung.com (KnoxPortal) with ESMTPA id
	20250307093725epcas5p21294e7d29137ea21d796443ec5a7352d~qe7oZNUzp0034000340epcas5p2-;
	Fri,  7 Mar 2025 09:37:25 +0000 (GMT)
Received: from epsmgmc1p1new.samsung.com (unknown [182.195.42.40]) by
	epsmtrp2.samsung.com (KnoxPortal) with ESMTP id
	20250307093725epsmtrp26a951bd218eefa7ccff21c0651d036b5~qe7oYM4rD2029620296epsmtrp2q;
	Fri,  7 Mar 2025 09:37:25 +0000 (GMT)
X-AuditID: b6c32a4a-b87c770000004ddd-de-67cc681a4c85
Received: from epsmtip2.samsung.com ( [182.195.34.31]) by
	epsmgmc1p1new.samsung.com (Symantec Messaging Gateway) with SMTP id
	E3.8F.23488.45EBAC76; Fri,  7 Mar 2025 18:37:24 +0900 (KST)
Received: from FDSFTE462 (unknown [107.122.81.248]) by epsmtip2.samsung.com
	(KnoxPortal) with ESMTPA id
	20250307093721epsmtip231d01e7dfbab692194535a6d9e733a1f~qe7lKsuCD2446924469epsmtip2x;
	Fri,  7 Mar 2025 09:37:21 +0000 (GMT)
From: "Shradha Todi" <shradha.t@samsung.com>
To: =?iso-8859-2?Q?'Krzysztof_Wilczy=F1ski'?= <kw@linux.com>, "'Geert
 Uytterhoeven'" <geert@linux-m68k.org>
Cc: "'Manivannan Sadhasivam'" <manivannan.sadhasivam@linaro.org>, "'Bjorn
 Helgaas'" <helgaas@kernel.org>, "'Fan Ni'" <nifan.cxl@gmail.com>,
	<linux-kernel@vger.kernel.org>, <linux-pci@vger.kernel.org>,
	<linux-arm-kernel@lists.infradead.org>, <linux-perf-users@vger.kernel.org>,
	<lpieralisi@kernel.org>, <robh@kernel.org>, <bhelgaas@google.com>,
	<jingoohan1@gmail.com>, <Jonathan.Cameron@huawei.com>,
	<a.manzanares@samsung.com>, <pankaj.dubey@samsung.com>, <cassel@kernel.org>,
	<18255117159@163.com>, <xueshuai@linux.alibaba.com>,
	<renyu.zj@linux.alibaba.com>, <will@kernel.org>, <mark.rutland@arm.com>,
	"'Yoshihiro Shimoda'" <yoshihiro.shimoda.uh@renesas.com>, "'Linux-Renesas'"
	<linux-renesas-soc@vger.kernel.org>
In-Reply-To: <20250306090234.GA390800@rocinante>
Subject: RE: [PATCH v7 3/5] Add debugfs based silicon debug support in DWC
Date: Fri, 7 Mar 2025 15:07:20 +0530
Message-ID: <075401db8f44$88861bc0$99925340$@samsung.com>
Precedence: bulk
X-Mailing-List: linux-perf-users@vger.kernel.org
List-Id: <linux-perf-users.vger.kernel.org>
List-Subscribe: <mailto:linux-perf-users+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-perf-users+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="iso-8859-2"
Content-Transfer-Encoding: quoted-printable
X-Mailer: Microsoft Outlook 16.0
Thread-Index: AQEfDkyGHW8mDgaJp4uj/OEWTCMyQwKytmxvAcZ+scYBKKrTNAJ2u5flAr85U7YCi7TZA7R1SUug
Content-Language: en-in
X-Brightmail-Tracker: H4sIAAAAAAAAA02Te0ybVRjGPb0zU/atAznUyGo3SXahtltbDg5EGSOfMCOLLiYYLg18tkhv
	a4swdBOhAuvYAhsbUJHLYMgaQIUxigPUsg0hJQtycWFDRRAGU8Yo4mq52NLO8N/vvOd53vc8
	5+QwyKwyOpuRqtQRGqVEzqVtoVzv2b07iC2zSvnrjl1oON9BR6U9L6K6HBm6XdRARtNjXSQ0
	Z22ioYalcjoy1YzSUHahg4paJkepaOjbChoaqOyloeG2Zgpqm50nIf2KnoLG9aep6MrPgyS0
	er0LoMttS3RUkzsL0HqnmY7090Xokb2Vhv7ustFeg3htQwkVb6xsBHiHcZyOV7ek4/qbf1Hx
	FtNpGn5/tJOGW3oKnJsTIfjUcCkJb637BF+2FlPwc9dMALe1BMR6x6WFyghJCqHhEMpkVUqq
	UhrGjXk78VCiSMwXBAlCUDCXo5QoiDBu5JHYoKhUufMKuJwPJfJ0ZylWotVyX341VKNK1xEc
	mUqrC+MS6hS5WqjmaSUKbbpSylMSulcEfP5+kVOYlCZbmz5PUhftyKxp/46aDWoDDMCLATEh
	rBn7ke5iFnYDwLlsrQFscfIigPNVg1T3YhnAx6s2YACMDYf5Edtd7wLwq9pGj+gBgBajgeJq
	RcP2wanhFbKLfTAFfNBjJLlEZGycCm3dMxudvDA+/OzOey7NdiwaXp2Y2PBSsF0wr2KN5mIm
	FgKHrKsUN2+DfeVTG0zGeHC63+jhvbC+5iHZHYcD7X/UU91z4+DNmRGyW+MHb9kLya4zQOwn
	L1i1NkJyGyKhY7KX7ubtcK73mofZ0DbfRXOzFF5tLfMMkMPl1jqPNxx+P1xBcfML8GJ/M8k9
	zBuedUx5NExornzKO+HSaqdH7w8rbw9RiwDXuCmbcVM246Zsxk0ZqgHFBPwJtVYhJbQi9X4l
	kfH/iyerFC1g44vsiTaDid8WeBZAYgALgAwy14cZ2N4vZTFTJCeyCI0qUZMuJ7QWIHLeeDGZ
	7Zuscv4xpS5RIAzhC8VisTDkgFjA9WPmduilLEwq0RFpBKEmNE99JIYXO5t0JNoWUZrbcszE
	Nx//6M+yo2+2lgDHB7Jb1EM3IqPS5OewgaX4zCu+zYyCHTzzs8VffM2qv2uo0mSIF7GkzM5O
	/cWMk/aScH3Bhb4LC18GNL3+6Tf167PivIW4O3t178Sv/z54KTohb/KHMz3Zi1kGQ+K/VnMS
	L1+3utO+srXvgOhdenm1bfxX1XNjj/cdNM02db4/kqFgPilHOeH64I57gfnz845Tx4RnY8qK
	QNTnnNqJfwIuH46pyRg4+qRs5e7hwhMHS9qCnudfyvEesVuzWBHdWyJYoLshIWnaJ5B5/JkM
	v63bfjH4vhEfOpP00snzD/NOLVs+nn3rXrC41Hs9x5rQ4d/OpWhlEsEeskYr+Q9Ta3POqwQA
	AA==
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrLIsWRmVeSWpSXmKPExsWy7bCSvG7ovlPpBksLLK60/2a3mH5Y0WJJ
	U4bFsQkrmC2e3drLZPHqzFo2ixVfZrJbrFp4jc2ioec3q8Wmx9dYLS7vmsNmcXbecTaLK1vX
	sVhsffmOyaLlTwuLxd2WTlaLpdcvMln83baX0WLR1i/sFgubXzJa/N+zg92i5Y6pxfufm9ks
	vu79zOYg4bF4xRRWjzXz1jB67Jx1l91jwaZSj5Yjb1k9Nq3qZPO4c20Pm8ehwx1AyYeWHk+u
	TGfy2Lyk3uPbmYksHn1bVjF6fN4kF8AXxWWTkpqTWZZapG+XwJWx9vk/xoLTohUH7n9haWDc
	LNjFyMEhIWAiseO9VBcjJ4eQwG5GiWezbEBsCQFJic8X1zFB2MISK/89Z+9i5AKqecYo8fV8
	NxtIgk1AR+LJlT/MILaIQK7E8jstrCBFzAKfWSXmN35jhOh4zCTx6u9nFpBtnAIGEq3no0Ea
	hAW8JFY+fMgCYrMIqEi0zfkHNpRXwFLi8pm/LBC2oMTJmU/AbGag1iULfzFB2NoSyxa+Zoa4
	TkHi59NlrBBHREkceX6VGaJGXOLozx7mCYzCs5CMmoVk1Cwko2YhaVnAyLKKUTK1oDg3PTfZ
	sMAwL7Vcrzgxt7g0L10vOT93EyM4hWhp7GB8961J/xAjEwfjIUYJDmYlEV617afShXhTEiur
	Uovy44tKc1KLDzFKc7AoifOuNIxIFxJITyxJzU5NLUgtgskycXBKNTDZnfJrYdEr3bUww05f
	cOOF/87PTZpXSzzzfmxQfeSe8uU9XFU+v17nR7x/Hyzo2Xp44pQ0y0835rvsCn/9WkJFKSt8
	jn3puWiWlaeyy0tE6z/sOPP+keGDhRvuT9iT7eNulHQ+WXS70aPsllPx0n+u8vq41db2iWQ/
	PXVIKav924Hsy6l/2+4EH9FcZyQd/es4a53L9LT4D6enVZy+YvA5R6ygZtPHvQILo5/d1kj7
	LTp5PeMC0ZaGn0k1u+6kHH3q+fZPbveXiIaaJXc4nU4E6e6/fjBc+f2ZrL7PR/K69c9/ub/j
	ueq0Mu8XeuevHviVqt/NLh5wRoehbU1RYunLs1tnWwUdazLknXf2xncmJZbijERDLeai4kQA
	ys3uW5ADAAA=
X-CMS-MailID: 20250307093725epcas5p21294e7d29137ea21d796443ec5a7352d
X-Msg-Generator: CA
X-Sendblock-Type: REQ_APPROVE
CMS-TYPE: 105P
DLP-Filter: Pass
X-CFilter-Loop: Reflected
X-CMS-RootMailID: 20250306090240epcas5p4f5ce09cf67a116dd3c976bfc846f1b14
References: <20250304171154.njoygsvfd567pb66@thinkpad>
	<20250305173826.GA303920@bhelgaas>
	<20250305182833.cgrwbrcwzjscxmku@thinkpad>
	<20250305190955.GK847772@rocinante>
	<CAMuHMdVRSjkss3gPnocXpfPQ=mEo4AevpaU=fdGvm=kb3RTmcQ@mail.gmail.com>
	<CGME20250306090240epcas5p4f5ce09cf67a116dd3c976bfc846f1b14@epcas5p4.samsung.com>
	<20250306090234.GA390800@rocinante>



> -----Original Message-----
> From: Krzysztof Wilczy=F1ski=20<kw=40linux.com>=0D=0A>=20Sent:=2006=20Mar=
ch=202025=2014:33=0D=0A>=20To:=20Geert=20Uytterhoeven=20<geert=40linux-m68k=
.org>=0D=0A>=20Cc:=20Manivannan=20Sadhasivam=20<manivannan.sadhasivam=40lin=
aro.org>;=20Bjorn=20Helgaas=20<helgaas=40kernel.org>;=20Fan=20Ni=0D=0A>=20<=
nifan.cxl=40gmail.com>;=20Shradha=20Todi=20<shradha.t=40samsung.com>;=20lin=
ux-kernel=40vger.kernel.org;=20linux-pci=40vger.kernel.org;=20linux-=0D=0A>=
=20arm-kernel=40lists.infradead.org;=20linux-perf-users=40vger.kernel.org;=
=20lpieralisi=40kernel.org;=20robh=40kernel.org;=20bhelgaas=40google.com;=
=0D=0A>=20jingoohan1=40gmail.com;=20Jonathan.Cameron=40huawei.com;=20a.manz=
anares=40samsung.com;=20pankaj.dubey=40samsung.com;=0D=0A>=20cassel=40kerne=
l.org;=2018255117159=40163.com;=20xueshuai=40linux.alibaba.com;=20renyu.zj=
=40linux.alibaba.com;=20will=40kernel.org;=0D=0A>=20mark.rutland=40arm.com;=
=20Yoshihiro=20Shimoda=20<yoshihiro.shimoda.uh=40renesas.com>;=20Linux-Rene=
sas=20<linux-renesas-=0D=0A>=20soc=40vger.kernel.org>=0D=0A>=20Subject:=20R=
e:=20=5BPATCH=20v7=203/5=5D=20Add=20debugfs=20based=20silicon=20debug=20sup=
port=20in=20DWC=0D=0A>=20=0D=0A>=20Hello,=0D=0A>=20=0D=0A>=20=5B...=5D=0D=
=0A>=20>=20Another=20issue=20is=20that=20the=20caller=20does=20not=20handle=
=20failures=20correctly,=0D=0A>=20>=20given=20(A)=20the=20irqdomain=20WARNI=
NG=20I=20got,=20and=20(B)=20the=20half-registered=20PCI=0D=0A>=20>=20bus,=
=20oopsing=20on=20=22lspci=22...=0D=0A>=20=0D=0A>=20This=20is=20something=
=20we=20will=20look=20into.=20=20A=20more=20robust=20DesignWare=20core=20is=
=20something=20we=20would=20definitely=20want=20to=20have.=0D=0A>=20=0D=0A=
=0D=0AThe=20issue=20here=20was=20that=20=22=20pci_host_probe(bridge)=22=20w=
as=20being=20called=20right=20before=20doing=20the=20debugfs=20init.=0D=0AS=
o=20upon=20failure,=20the=20cleanup=20path=20should=20have=20included:=0D=
=0A=20=20=20=20=20=20=20=20pci_stop_root_bus(pp->bridge->bus);=0D=0A=20=20=
=20=20=20=20=20=20pci_remove_root_bus(pp->bridge->bus);=0D=0A=0D=0AI=20miss=
ed=20that,=20which=20was=20probably=20causing=20the=20half-registered=20PCI=
=20bus.=20Since=20we=20are=20going=20with=20no=20error=0D=0Apropagation=20n=
ow,=20there=20is=20no=20issue=20anymore.=20Sorry=20for=20missing=20that.=0D=
=0A=0D=0A>=20Sorry=20about=20the=20issues=20with=20this...=0D=0A>=20=0D=0A>=
=20=5B...=5D=0D=0A>=20>=20>=20-int=20dwc_pcie_debugfs_init(struct=20dw_pcie=
=20*pci)=0D=0A>=20>=20>=20+void=20dwc_pcie_debugfs_init(struct=20dw_pcie=20=
*pci)=0D=0A>=20>=20>=20=20=7B=0D=0A>=20>=20>=20=20=20=20=20=20=20=20=20char=
=20dirname=5BDWC_DEBUGFS_BUF_MAX=5D;=0D=0A>=20>=20>=20=20=20=20=20=20=20=20=
=20struct=20device=20*dev=20=3D=20pci->dev;=20=40=40=20-174,17=20+174,15=20=
=40=40=20int=0D=0A>=20>=20>=20dwc_pcie_debugfs_init(struct=20dw_pcie=20*pci=
)=0D=0A>=20>=20>=20=20=20=20=20=20=20=20=20snprintf(dirname,=20DWC_DEBUGFS_=
BUF_MAX,=20=22dwc_pcie_%s=22,=20dev_name(dev));=0D=0A>=20>=20>=20=20=20=20=
=20=20=20=20=20dir=20=3D=20debugfs_create_dir(dirname,=20NULL);=0D=0A>=20>=
=20>=20=20=20=20=20=20=20=20=20debugfs=20=3D=20devm_kzalloc(dev,=20sizeof(*=
debugfs),=20GFP_KERNEL);=0D=0A>=20>=20>=20-=20=20=20=20=20=20=20if=20(=21de=
bugfs)=0D=0A>=20>=20>=20-=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20retur=
n=20-ENOMEM;=0D=0A>=20>=20>=20+=20=20=20=20=20=20=20if=20(=21debugfs)=20=7B=
=0D=0A>=20>=20>=20+=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20dev_err(dev=
,=20=22failed=20to=20allocate=20memory=20for=0D=0A>=20>=20>=20+=20debugfs=
=5Cn=22);=0D=0A>=20>=0D=0A>=20>=20There=20is=20no=20need=20to=20print=20an=
=20error=20message=20when=20a=20memory=20allocation=0D=0A>=20>=20fails,=20a=
s=20the=20memory=20allocation=20core=20already=20takes=20care=20of=20that.=
=0D=0A>=20>=20So=20please=20drop=20the=20dev_err()=20call.=0D=0A>=20=0D=0A>=
=20Done.=20=20Thank=20you=21=0D=0A>=20=0D=0A>=20=09Krzysztof=0D=0A=0D=0A

