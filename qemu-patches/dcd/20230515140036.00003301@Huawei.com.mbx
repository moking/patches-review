From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3E848C77B75
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 13:01:50 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S242063AbjEONBS (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 09:01:18 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:48068 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S242094AbjEONAl (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 09:00:41 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 561F3A4
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 06:00:39 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKfWd5sLTz6J6vH;
        Mon, 15 May 2023 20:56:29 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 14:00:37 +0100
Date: Mon, 15 May 2023 14:00:36 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>, <navneet.singh@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <20230515140036.00003301@Huawei.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
X-Status: A
Content-Length: 9897
Lines: 253

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> Since the early draft of DCD support in kernel is out
> (https://lore.kernel.org/linux-cxl/20230417164126.GA1904906@bgt-140510-bm03/T/#t),
> this patch series provide dcd emulation in qemu so people who are interested
> can have an early try. It is noted that the patch series may need to be updated
> accordingly if the kernel side implementation changes.
> 
> To support DCD emulation, the patch series add DCD related mailbox command
> support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory device
> with dynamic capacity extent and region representative.
> To support read/write to the dynamic capacity of the device, a host backend
> is provided and necessary check mechnism is added to ensure the dynamic
> capacity accessed is backed with active dc extents.
> Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not supported
> , but we add two qmp interfaces for adding/releasing dynamic capacity extents.
> Also, the support for multiple hosts sharing the same DCD case is missing.
> 
> Things we can try with the patch series together with kernel dcd code:
> 1. Create DC regions to cover the address range of the dynamic capacity
> regions.
> 2. Add/release dynamic capacity extents to the device and notify the
> kernel.
> 3. Test kernel side code to accept added dc extents and create dax devices,
> and release dc extents and notify the device
> 4. Online the memory range backed with dc extents and let application use
> them.
> 
> The patch series is based on Jonathan's local qemu branch:
> https://gitlab.com/jic23/qemu/-/tree/cxl-2023-02-28
> 
> Simple tests peformed with the patch series:
> 1 Install cxl modules:
> 
> modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
> 
> 2 Create dc regions:
> 
> region=$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> echo 0x10000000 > /sys/bus/cxl/devices/$region/size
> echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> echo 1 > /sys/bus/cxl/devices/$region/commit
> echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> 
> /home/fan/cxl/tools-and-scripts# cxl list
> [
>   {
>     "memdevs":[
>       {
>         "memdev":"mem0",
>         "pmem_size":536870912,
>         "ram_size":0,
>         "serial":0,
>         "host":"0000:0d:00.0"
>       }
>     ]
>   },
>   {
>     "regions":[
>       {
>         "region":"region0",
>         "resource":45365592064,
>         "size":268435456,
>         "interleave_ways":1,
>         "interleave_granularity":256,
>         "decode_state":"commit"
>       }
>     ]
>   }
> ]
> 
> 3 Add two dc extents (128MB each) through qmp interface
> 
> { "execute": "qmp_capabilities" }
> 
> { "execute": "cxl-add-dynamic-capacity-event",
> 	"arguments": {
> 		 "path": "/machine/peripheral/cxl-pmem0",
> 		"region-id" : 0,
> 		 "num-extent": 2,
> 		"dpa":0,
> 		"extent-len": 128
> 	}
> }
> 
> /home/fan/cxl/tools-and-scripts# lsmem
> RANGE                                  SIZE   STATE REMOVABLE   BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes    0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes   32-79
> 0x0000000a90000000-0x0000000a9fffffff  256M offline           338-339
> 
> Memory block size:       128M
> Total online memory:       8G
> Total offline memory:    256M
> 
> 
> 4.Online the momory with 'daxctl online-memory dax0.0' to online the memory
> 
> /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
> [  230.730553] Fallback order for Node 0: 0 1
> [  230.730825] Fallback order for Node 1: 1 0
> [  230.730953] Built 2 zonelists, mobility grouping on.  Total pages: 2042541
> [  230.731110] Policy zone: Normal
> onlined memory for 1 device
> 
> root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> RANGE                                  SIZE   STATE REMOVABLE BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes  0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes 32-79
> 0x0000000a90000000-0x0000000a97ffffff  128M  online       yes   338
> 0x0000000a98000000-0x0000000a9fffffff  128M offline             339
> 
> Memory block size:       128M
> Total online memory:     8.1G
> Total offline memory:    128M
> 
> 5 using dc extents as regular memory
> 
> /home/fan/cxl/ndctl# numactl --membind=1 ls
> CONTRIBUTING.md  README.md  clean_config.sh  cscope.out   git-version-gen
> ndctl	       scripts	test.h      version.h.in COPYING		 acpi.h
> config.h.meson   cxl	  make-git-snapshot.sh	ndctl.spec.in  sles	tools
> Documentation	 build	    contrib	     daxctl	  meson.build		rhel
> tags	topology.png LICENSES	 ccan	    cscope.files
> git-version  meson_options.txt	rpmbuild.sh    test	util
> 
> 
> QEMU command line cxl configuration:
> 
> RP1="-object memory-backend-file,id=cxl-mem1,share=on,mem-path=/tmp/cxltest.raw,size=512M \
> -object memory-backend-file,id=cxl-mem2,share=on,mem-path=/tmp/cxltest2.raw,size=512M \
> -object memory-backend-file,id=cxl-lsa1,share=on,mem-path=/tmp/lsa.raw,size=512M \
> -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
> -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,dc-memdev=cxl-mem2,id=cxl-pmem0,num-dc-regions=1\
> -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=8k"
> 
> 
> Kernel DCD support used to test the changes
> 
> The code is tested with the posted kernel dcd support:
> https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=for-6.5/dcd-preview
> 

Very nice!  +CC Navneet who may want to comment on the below (and the
emulation as well)

I've not had a chance to look at the code on the kernel side yet.


> commit: f425bc34c600e2a3721d6560202962ec41622815
> 
> To make the test work, we have made the following changes to the above kernel commit:
> 
> diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> index 5f04bbc18af5..5f421d3c5cef 100644
> --- a/drivers/cxl/core/mbox.c
> +++ b/drivers/cxl/core/mbox.c
> @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_MEM_COMMAND_ID_MAX] = {
>  	CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
>  	CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
>  	CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
> +	CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
>  };
>  
>  /*
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 291c716abd49..ae10e3cf43a1 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *cxlr)
>  		}
>  		cxlds->dc_list_gen_num = extent_gen_num;
>  		dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
> -		enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
> +		/*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/

Some race condition that means we need to enable the DCD event earlier?

>  	}
>  	return 0;
>  err:
> @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds, struct resource *alloc_dpa_re
>  				dev_dax->align, memremap_compat_align()))) {
>  		rc = alloc_dev_dax_range(dev_dax, hpa,
>  					resource_size(alloc_dpa_res));
> -		return rc;
> +		if (rc)
> +			return rc;

No idea on this one as it's in the code I haven't looked at yet!

>  	}
>  
>  	rc = xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index 9e45b1056022..653bec203838 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state *cxlds)
>  
>  	/* Driver enables DCD interrupt after creating the dc cxl_region */
>  	rc = cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYPE_DCD,
> -					IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
> +					IRQF_SHARED | IRQF_ONESHOT);

This will be otherside of the removal of the enable above.

>  	if (rc) {
>  		dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
>  		return rc;
> diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.h
> index 6ca85861750c..910a48259239 100644
> --- a/include/uapi/linux/cxl_mem.h
> +++ b/include/uapi/linux/cxl_mem.h
> @@ -47,6 +47,7 @@
>  	___C(SCAN_MEDIA, "Scan Media"),                                   \
>  	___C(GET_SCAN_MEDIA, "Get Scan Media Results"),                   \
>  	___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"),         \
> +	___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),         \
>  	___C(MAX, "invalid / last command")
>  
>  #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
> 
> 
> 
> Fan Ni (7):
>   hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
>     payload of identify memory device command
>   hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
>     and mailbox command support
>   hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
>     device supports in qemu command line
>   hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
>   hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
>     dynamic capacity response
>   Add qmp interfaces to add/release dynamic capacity extents
>   hw/mem/cxl_type3: add read/write support to dynamic capacity
> 
>  hw/cxl/cxl-mailbox-utils.c  | 389 +++++++++++++++++++++++++++-
>  hw/mem/cxl_type3.c          | 492 +++++++++++++++++++++++++++++++-----
>  include/hw/cxl/cxl_device.h |  50 +++-
>  include/hw/cxl/cxl_events.h |  16 ++
>  qapi/cxl.json               |  44 ++++
>  5 files changed, 924 insertions(+), 67 deletions(-)
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DBBC0C7EE22
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 13:02:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S242064AbjEONCy (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 09:02:54 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49318 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S242073AbjEONCr (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 09:02:47 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E1CA319A1
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 06:02:45 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.226])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKfZ40PhTz6J70t;
        Mon, 15 May 2023 20:58:36 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 14:02:43 +0100
Date: Mon, 15 May 2023 14:02:42 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 1/7] hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field
 to output payload of identify memory device command
Message-ID: <20230515140242.00006764@Huawei.com>
In-Reply-To: <20230511175609.2091136-2-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p2e2dd6a5b681f73870e33869af0247c06@uscas1p2.samsung.com>
        <20230511175609.2091136-2-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 1918
Lines: 56

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Based on CXL spec 3.0 Table 8-94 (Identify Memory Device Output
> Payload), dynamic capacity event log size should be part of
> output of the Identify command.
> Add dc_event_log_size to the output payload for the host to get the info.
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>

Trivial formatting aside, looks good to me.

Jonathan


> ---
>  hw/cxl/cxl-mailbox-utils.c | 6 +++++-
>  1 file changed, 5 insertions(+), 1 deletion(-)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 9f8e6722d7..7ff4fbdf22 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -21,6 +21,8 @@
>  #include "sysemu/hostmem.h"
>  
>  #define CXL_CAPACITY_MULTIPLIER   (256 * MiB)
> +/* Experimental value: dynamic capacity event log size */
> +#define CXL_DC_EVENT_LOG_SIZE 8
>  
>  /*
>   * How to add a new command, example. The command set FOO, with cmd BAR.
> @@ -519,8 +521,9 @@ static CXLRetCode cmd_identify_memory_device(struct cxl_cmd *cmd,
>          uint16_t inject_poison_limit;
>          uint8_t poison_caps;
>          uint8_t qos_telemetry_caps;
> +		uint16_t dc_event_log_size;
Qemu uses 4 space indentation not tabs.

>      } QEMU_PACKED *id;
> -    QEMU_BUILD_BUG_ON(sizeof(*id) != 0x43);
> +    QEMU_BUILD_BUG_ON(sizeof(*id) != 0x45);
>  
>      CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
>      CXLType3Class *cvc = CXL_TYPE3_GET_CLASS(ct3d);
> @@ -543,6 +546,7 @@ static CXLRetCode cmd_identify_memory_device(struct cxl_cmd *cmd,
>      st24_le_p(id->poison_list_max_mer, 256);
>      /* No limit - so limited by main poison record limit */
>      stw_le_p(&id->inject_poison_limit, 0);
> +	stw_le_p(&id->dc_event_log_size, CXL_DC_EVENT_LOG_SIZE);
>  
>      *len = sizeof(*id);
>      return CXL_MBOX_SUCCESS;


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 87973C7EE22
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 13:55:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S234266AbjEONzE (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 09:55:04 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59636 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233813AbjEONzD (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 09:55:03 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 004FDE6E
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 06:55:01 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKgp24gj9z67mZc;
        Mon, 15 May 2023 21:54:02 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 14:54:59 +0100
Date: Mon, 15 May 2023 14:54:58 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 2/7] hw/cxl/cxl-mailbox-utils: Add dynamic capacity region
 representative and mailbox command support
Message-ID: <20230515145458.0000725b@Huawei.com>
In-Reply-To: <20230511175609.2091136-3-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc@uscas1p1.samsung.com>
        <20230511175609.2091136-3-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 5648
Lines: 171

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Per cxl spec 3.0, add dynamic capacity region representative based on
> Table 8-126 and extend the cxl type3 device definition to include dc region
> information. Also, based on info in 8.2.9.8.9.1, add 'Get Dynamic Capacity
> Configuration' mailbox support.
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/cxl/cxl-mailbox-utils.c  | 68 +++++++++++++++++++++++++++++++++++++
>  include/hw/cxl/cxl_device.h | 16 +++++++++
>  2 files changed, 84 insertions(+)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 7ff4fbdf22..61c77e52d8 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -81,6 +81,8 @@ enum {
>          #define GET_POISON_LIST        0x0
>          #define INJECT_POISON          0x1
>          #define CLEAR_POISON           0x2
> +	DCD_CONFIG = 0x48, /*8.2.9.8.9*/

Always include which spec version in references.  Stuff keeps moving.

> +		#define GET_DC_REGION_CONFIG   0x0

Called simply Dynamic Capacity Configuration in spec.  Sure it's
all regions today, but who knows in future so we should match
naming.  GET_DC_CONFIG should do.

>      PHYSICAL_SWITCH = 0x51
>          #define IDENTIFY_SWITCH_DEVICE      0x0
>  };
> @@ -935,6 +937,70 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
>      return CXL_MBOX_SUCCESS;
>  }
>  
> +/*
> + * cxl spec 3.0: 8.2.9.8.9.2
> + * Get Dynamic Capacity Configuration
> + **/
> +static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len)
> +{
> +	struct get_dyn_cap_config_in_pl {
> +		uint8_t region_cnt;
> +		uint8_t start_region_id;
> +	} QEMU_PACKED;
> +
> +    struct get_dyn_cap_config_out_pl {
> +		uint8_t num_regions;
> +		uint8_t rsvd1[7];
> +		struct {
> +			uint64_t base;
> +			uint64_t decode_len;
> +			uint64_t region_len;
> +			uint64_t block_size;
> +			uint32_t dsmadhandle;
> +			uint8_t flags;
> +			uint8_t rsvd2[3];
> +		} QEMU_PACKED records[];
> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_config_in_pl *in = (void *)cmd->payload;
> +	struct get_dyn_cap_config_out_pl *out = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	uint16_t record_count = 0, i = 0;
> +	uint16_t out_pl_len;
> +
> +	if (in->start_region_id >= ct3d->dc.num_regions)
> +		record_count = 0;

Probably an error return rather than 0 records. Invalid input seems most appropriate.
My expectation, though the text doesn't call it out is that first issued command is
for 0 records to just get the Number of Available Regions, then rest of entries
will be right size.    A similar case for Get Supported Features calls out
"The device shall return Invalid Input if Starting Feature Index is greater than the
Device Supported Features value"

> +	else if (ct3d->dc.num_regions - in->start_region_id < in->region_cnt)
> +		record_count = ct3d->dc.num_regions - in->start_region_id;
> +	else
> +		record_count = in->region_cnt;

Do the last two conditions with min() ?

> +
> +	out_pl_len = sizeof(*out) + record_count * sizeof(out->records[0]);
> +	assert(out_pl_len <= CXL_MAILBOX_MAX_PAYLOAD_SIZE);
> +
> +	memset(out, 0, out_pl_len);
> +	out->num_regions = record_count;
> +	for (; i < record_count; i++) {

i = 0 here makes more sense to me.

> +		stq_le_p(&out->records[i].base,
> +			ct3d->dc.regions[in->start_region_id+i].base);

Spaces around +

> +		stq_le_p(&out->records[i].decode_len,
> +			ct3d->dc.regions[in->start_region_id+i].decode_len);
> +		stq_le_p(&out->records[i].region_len,
> +			ct3d->dc.regions[in->start_region_id+i].len);
> +		stq_le_p(&out->records[i].block_size,
> +			ct3d->dc.regions[in->start_region_id+i].block_size);
> +		stl_le_p(&out->records[i].dsmadhandle,
> +			ct3d->dc.regions[in->start_region_id+i].dsmadhandle);
> +		out->records[i].flags
> +			= ct3d->dc.regions[in->start_region_id+i].flags;
> +	}
> +
> +	*len = out_pl_len;
> +	return CXL_MBOX_SUCCESS;
> +}
> +
>  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
>  #define IMMEDIATE_DATA_CHANGE (1 << 2)
>  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> @@ -973,6 +1039,8 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
>          cmd_media_inject_poison, 8, 0 },
>      [MEDIA_AND_POISON][CLEAR_POISON] = { "MEDIA_AND_POISON_CLEAR_POISON",
>          cmd_media_clear_poison, 72, 0 },
> +	[DCD_CONFIG][GET_DC_REGION_CONFIG] = { "DCD_GET_DC_REGION_CONFIG",
> +		cmd_dcd_get_dyn_cap_config, 2, 0 },
>  };
>  
>  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index e285369693..8a04e53e90 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -383,6 +383,17 @@ typedef struct CXLPoison {
>  typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
>  #define CXL_POISON_LIST_LIMIT 256
>  
> +#define DCD_MAX_REGION_NUM 8
> +
> +typedef struct CXLDCD_Region {
> +	uint64_t base;
> +	uint64_t decode_len; /* in multiples of 256MB */
> +	uint64_t len;
> +	uint64_t block_size;
> +	uint32_t dsmadhandle;
> +	uint8_t flags;
> +} CXLDCD_Region;
> +
>  struct CXLType3Dev {
>      /* Private */
>      PCIDevice parent_obj;
> @@ -414,6 +425,11 @@ struct CXLType3Dev {
>      unsigned int poison_list_cnt;
>      bool poison_list_overflowed;
>      uint64_t poison_list_overflow_ts;
> +
> +	struct dynamic_capacity {
> +		uint8_t num_regions; // 1-8
Or none if it's not present :)

> +		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
> +	} dc;
>  };
>  
>  #define TYPE_CXL_TYPE3 "cxl-type3"


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id EB7B8C7EE22
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 13:59:11 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S238300AbjEON7K (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 09:59:10 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34122 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S238705AbjEON7G (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 09:59:06 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CF7EF2D6D
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 06:58:38 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKgpX6yMgz6J724;
        Mon, 15 May 2023 21:54:28 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 14:58:36 +0100
Date: Mon, 15 May 2023 14:58:35 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Nathan Fontenot <nafonten@amd.com>
CC: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 2/7] hw/cxl/cxl-mailbox-utils: Add dynamic capacity region
 representative and mailbox command support
Message-ID: <20230515145835.000076b9@Huawei.com>
In-Reply-To: <5cf2a93d-1a20-c87b-5276-69feb5056e72@amd.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc@uscas1p1.samsung.com>
        <20230511175609.2091136-3-fan.ni@samsung.com>
        <5cf2a93d-1a20-c87b-5276-69feb5056e72@amd.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100005.china.huawei.com (7.191.160.25) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
X-Status: A
Content-Length: 6057
Lines: 173

On Thu, 11 May 2023 16:53:23 -0500
Nathan Fontenot <nafonten@amd.com> wrote:

> On 5/11/23 12:56, Fan Ni wrote:
> > From: Fan Ni <nifan@outlook.com>
> > 
> > Per cxl spec 3.0, add dynamic capacity region representative based on
> > Table 8-126 and extend the cxl type3 device definition to include dc region
> > information. Also, based on info in 8.2.9.8.9.1, add 'Get Dynamic Capacity
> > Configuration' mailbox support.
> > 
> > Signed-off-by: Fan Ni <fan.ni@samsung.com>
> > ---
> >  hw/cxl/cxl-mailbox-utils.c  | 68 +++++++++++++++++++++++++++++++++++++
> >  include/hw/cxl/cxl_device.h | 16 +++++++++
> >  2 files changed, 84 insertions(+)
> > 
> > diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> > index 7ff4fbdf22..61c77e52d8 100644
> > --- a/hw/cxl/cxl-mailbox-utils.c
> > +++ b/hw/cxl/cxl-mailbox-utils.c
> > @@ -81,6 +81,8 @@ enum {
> >          #define GET_POISON_LIST        0x0
> >          #define INJECT_POISON          0x1
> >          #define CLEAR_POISON           0x2
> > +	DCD_CONFIG = 0x48, /*8.2.9.8.9*/
> > +		#define GET_DC_REGION_CONFIG   0x0
> >      PHYSICAL_SWITCH = 0x51
> >          #define IDENTIFY_SWITCH_DEVICE      0x0
> >  };
> > @@ -935,6 +937,70 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
> >      return CXL_MBOX_SUCCESS;
> >  }
> >  
> > +/*
> > + * cxl spec 3.0: 8.2.9.8.9.2
> > + * Get Dynamic Capacity Configuration
> > + **/
> > +static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
> > +		CXLDeviceState *cxl_dstate,
> > +		uint16_t *len)
> > +{
> > +	struct get_dyn_cap_config_in_pl {
> > +		uint8_t region_cnt;
> > +		uint8_t start_region_id;
> > +	} QEMU_PACKED;
> > +
> > +    struct get_dyn_cap_config_out_pl {
> > +		uint8_t num_regions;
> > +		uint8_t rsvd1[7];
> > +		struct {
> > +			uint64_t base;
> > +			uint64_t decode_len;
> > +			uint64_t region_len;
> > +			uint64_t block_size;
> > +			uint32_t dsmadhandle;
> > +			uint8_t flags;
> > +			uint8_t rsvd2[3];
> > +		} QEMU_PACKED records[];  
> 
> Could you declare CXLDCD_Region as QEMU_PACKED and use it here instead of
> re-defining the region structure?

Could be done, but care needed on the endian conversions.  I wouldn't
mind seeing this always held as little endian state though. We'd have
done that anyway if it was a memory mapped command set rather than read
via the mailbox so there is plenty of precedence.

Jonathan

> 
> > +	} QEMU_PACKED;
> > +
> > +	struct get_dyn_cap_config_in_pl *in = (void *)cmd->payload;
> > +	struct get_dyn_cap_config_out_pl *out = (void *)cmd->payload;
> > +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> > +	uint16_t record_count = 0, i = 0;
> > +	uint16_t out_pl_len;
> > +
> > +	if (in->start_region_id >= ct3d->dc.num_regions)
> > +		record_count = 0;
> > +	else if (ct3d->dc.num_regions - in->start_region_id < in->region_cnt)
> > +		record_count = ct3d->dc.num_regions - in->start_region_id;
> > +	else
> > +		record_count = in->region_cnt;
> > +
> > +	out_pl_len = sizeof(*out) + record_count * sizeof(out->records[0]);
> > +	assert(out_pl_len <= CXL_MAILBOX_MAX_PAYLOAD_SIZE);
> > +
> > +	memset(out, 0, out_pl_len);
> > +	out->num_regions = record_count;
> > +	for (; i < record_count; i++) {
> > +		stq_le_p(&out->records[i].base,
> > +			ct3d->dc.regions[in->start_region_id+i].base);
> > +		stq_le_p(&out->records[i].decode_len,
> > +			ct3d->dc.regions[in->start_region_id+i].decode_len);
> > +		stq_le_p(&out->records[i].region_len,
> > +			ct3d->dc.regions[in->start_region_id+i].len);
> > +		stq_le_p(&out->records[i].block_size,
> > +			ct3d->dc.regions[in->start_region_id+i].block_size);
> > +		stl_le_p(&out->records[i].dsmadhandle,
> > +			ct3d->dc.regions[in->start_region_id+i].dsmadhandle);
> > +		out->records[i].flags
> > +			= ct3d->dc.regions[in->start_region_id+i].flags;  
> 
> In this loop your reading from 'in' and writing to 'out' where in and out both
> point to the same payload buffer. It works because of the structure layouts but
> feels like a bug waiting to happen. Perhaps saving start_region to a local variable
> and using that for the loop?

Does it work?  There is a memset of out above.
Definitely need a local copy of start_region_id before that.
This might only be working because of good fortune / compilers being 'clever'.

Jonathan


> 
> -Nathan
> 
> > +	}
> > +
> > +	*len = out_pl_len;
> > +	return CXL_MBOX_SUCCESS;
> > +}
> > +
> >  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
> >  #define IMMEDIATE_DATA_CHANGE (1 << 2)
> >  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> > @@ -973,6 +1039,8 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
> >          cmd_media_inject_poison, 8, 0 },
> >      [MEDIA_AND_POISON][CLEAR_POISON] = { "MEDIA_AND_POISON_CLEAR_POISON",
> >          cmd_media_clear_poison, 72, 0 },
> > +	[DCD_CONFIG][GET_DC_REGION_CONFIG] = { "DCD_GET_DC_REGION_CONFIG",
> > +		cmd_dcd_get_dyn_cap_config, 2, 0 },
> >  };
> >  
> >  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> > diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> > index e285369693..8a04e53e90 100644
> > --- a/include/hw/cxl/cxl_device.h
> > +++ b/include/hw/cxl/cxl_device.h
> > @@ -383,6 +383,17 @@ typedef struct CXLPoison {
> >  typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
> >  #define CXL_POISON_LIST_LIMIT 256
> >  
> > +#define DCD_MAX_REGION_NUM 8
> > +
> > +typedef struct CXLDCD_Region {
> > +	uint64_t base;
> > +	uint64_t decode_len; /* in multiples of 256MB */
> > +	uint64_t len;
> > +	uint64_t block_size;
> > +	uint32_t dsmadhandle;
> > +	uint8_t flags;
> > +} CXLDCD_Region;
> > +
> >  struct CXLType3Dev {
> >      /* Private */
> >      PCIDevice parent_obj;
> > @@ -414,6 +425,11 @@ struct CXLType3Dev {
> >      unsigned int poison_list_cnt;
> >      bool poison_list_overflowed;
> >      uint64_t poison_list_overflow_ts;
> > +
> > +	struct dynamic_capacity {
> > +		uint8_t num_regions; // 1-8
> > +		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
> > +	} dc;
> >  };
> >  
> >  #define TYPE_CXL_TYPE3 "cxl-type3"  


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2CA5BC77B7D
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 14:04:32 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239271AbjEOOEb (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 10:04:31 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39468 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239880AbjEOOE2 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 10:04:28 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D5AC62695
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 07:03:48 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKgwD0Ltyz6J6nV;
        Mon, 15 May 2023 21:59:24 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 15:03:31 +0100
Date: Mon, 15 May 2023 15:03:30 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 3/7] hw/mem/cxl_type3: Add a parameter to pass number of
 DC regions the device supports in qemu command line
Message-ID: <20230515150330.000033d8@Huawei.com>
In-Reply-To: <20230511175609.2091136-4-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p13ee26532e3a1de36f6081f970190eeed@uscas1p1.samsung.com>
        <20230511175609.2091136-4-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 2901
Lines: 88

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Add a property 'num-dc-regions' to ct3_props to allow users to create DC
> regions.
> With the change, users can control the number of DC regions the device
> supports.
> To make it easier, other parameters of the region like region base, length,
> and block size are hard coded. If desired, these parameters
> can be added easily.
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>

Ok. This is fine for initial testing, but we need to figure out how to actually
handle DCD regions and how to back them with memory.
Probably a 3rd memory backend to cover all the DCD regions?
Default perhaps to an even spread of a few regions (no real point in doing
more than 2 for initial support, fall back to 1 region if size is too small).
We will want to be able to mess with regions from the FM-API but lots more to
do there before that matters and we can still have default config for any
regions we define now.

Jonathan

> ---
>  hw/mem/cxl_type3.c | 32 ++++++++++++++++++++++++++++++++
>  1 file changed, 32 insertions(+)
> 
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 2b483d3d8e..b9c375d9b4 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -684,6 +684,34 @@ static void ct3d_reg_write(void *opaque, hwaddr offset, uint64_t value,
>      }
>  }
>  
> +/*
> + * Create a dc region to test "Get Dynamic Capacity Configuration" command.
> + */
> +static int cxl_create_toy_regions(CXLType3Dev *ct3d)
> +{
> +	int i;
> +	uint64_t region_base = ct3d->hostvmem?ct3d->hostvmem->size
> +		+ ct3d->hostpmem->size:ct3d->hostpmem->size;
> +	uint64_t region_len = 1024*1024*1024;
> +	uint64_t decode_len = 4; /* 4*256MB */
> +	uint64_t blk_size = 2*1024*1024;
> +	struct CXLDCD_Region *region;
> +
> +	for (i = 0; i < ct3d->dc.num_regions; i++) {
> +		region = &ct3d->dc.regions[i];
> +		region->base = region_base;
> +		region->decode_len = decode_len;
> +		region->len = region_len;
> +		region->block_size = blk_size;
> +		/* dsmad_handle is set when creating cdat table entries */
> +		region->flags = 0;
> +
> +		region_base += region->len;
> +	}
> +
> +	return 0;
> +}
> +
>  static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>  {
>      DeviceState *ds = DEVICE(ct3d);
> @@ -752,6 +780,9 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>          g_free(p_name);
>      }
>  
> +	if (cxl_create_toy_regions(ct3d))
> +		return false;
> +
>      return true;
>  }
>  
> @@ -1036,6 +1067,7 @@ static Property ct3_props[] = {
>      DEFINE_PROP_UINT64("sn", CXLType3Dev, sn, UI64_NULL),
>      DEFINE_PROP_STRING("cdat", CXLType3Dev, cxl_cstate.cdat.filename),
>      DEFINE_PROP_UINT16("spdm", CXLType3Dev, spdm_port, 0),
> +	DEFINE_PROP_UINT8("num-dc-regions", CXLType3Dev, dc.num_regions, 0),
>      DEFINE_PROP_END_OF_LIST(),
>  };
>  


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1C820C77B7D
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 14:09:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S237144AbjEOOJY (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 10:09:24 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:44400 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229568AbjEOOJX (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 10:09:23 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 11D13172B
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 07:09:21 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKh2t73htz6J72P;
        Mon, 15 May 2023 22:05:10 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 15:09:18 +0100
Date: Mon, 15 May 2023 15:09:17 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 4/7] hw/mem/cxl_type3: Add DC extent representative to cxl
 type3 device
Message-ID: <20230515150917.000038ef@Huawei.com>
In-Reply-To: <20230511175609.2091136-5-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530@uscas1p2.samsung.com>
        <20230511175609.2091136-5-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100006.china.huawei.com (7.191.160.224) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 6580
Lines: 212

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Add dynamic capacity extent information to the definition of
> CXLType3Dev and add get DC extent list mailbox command based on
> CXL.spec.3.0:.8.2.9.8.9.2.
> 
> With this command, we can create dc regions as below:
> 
> region=$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> 
> echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> echo 0x30000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> 
> echo 0x30000000 > /sys/bus/cxl/devices/$region/size
> echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> echo 1 > /sys/bus/cxl/devices/$region/commit
> echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
Hi Fan,

A few comments inline,

Thanks,

Jonathan

> ---
>  hw/cxl/cxl-mailbox-utils.c  | 73 ++++++++++++++++++++++++++++++++++++-
>  hw/mem/cxl_type3.c          |  1 +
>  include/hw/cxl/cxl_device.h | 23 ++++++++++++
>  3 files changed, 96 insertions(+), 1 deletion(-)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 61c77e52d8..ed2ac154cb 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -83,6 +83,7 @@ enum {
>          #define CLEAR_POISON           0x2
>  	DCD_CONFIG = 0x48, /*8.2.9.8.9*/
>  		#define GET_DC_REGION_CONFIG   0x0
> +		#define GET_DYN_CAP_EXT_LIST   0x1
>      PHYSICAL_SWITCH = 0x51
>          #define IDENTIFY_SWITCH_DEVICE      0x0
>  };
> @@ -938,7 +939,7 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
>  }
>  
>  /*
> - * cxl spec 3.0: 8.2.9.8.9.2
> + * cxl spec 3.0: 8.2.9.8.9.1

Push that back to earlier patch.

>   * Get Dynamic Capacity Configuration
>   **/
>  static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
> @@ -1001,6 +1002,73 @@ static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
>  	return CXL_MBOX_SUCCESS;
>  }
>  
> +/*
> + * cxl spec 3.0: 8.2.9.8.9.2
> + * Get Dynamic Capacity Extent List (Opcode 4810h)
> + **/
> +static CXLRetCode cmd_dcd_get_dyn_cap_ext_list(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len)
> +{
> +	struct get_dyn_cap_ext_list_in_pl {
> +		uint32_t extent_cnt;
> +		uint32_t start_extent_id;
> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_ext_list_out_pl {
> +		uint32_t count;
> +		uint32_t total_extents;
> +		uint32_t generation_num;
> +		uint8_t rsvd[4];
> +		struct {
> +			uint64_t start_dpa;
> +			uint64_t len;
> +			uint8_t tag[0x10];
> +			uint16_t shared_seq;
> +			uint8_t rsvd[6];
> +		} QEMU_PACKED records[];
> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_ext_list_in_pl *in = (void *)cmd->payload;
> +	struct get_dyn_cap_ext_list_out_pl *out = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	uint16_t record_count = 0, i = 0, record_done = 0;
> +	CXLDCDExtentList *extent_list = &ct3d->dc.extents;
> +	CXLDCD_Extent *ent;
> +	uint16_t out_pl_len;
> +
> +	if (in->start_extent_id > ct3d->dc.total_extent_count)
> +		return CXL_MBOX_INVALID_INPUT;
> +
> +	if (ct3d->dc.total_extent_count - in->start_extent_id < in->extent_cnt)
> +		record_count = ct3d->dc.total_extent_count - in->start_extent_id;
> +	else
> +		record_count = in->extent_cnt;
> +
> +	out_pl_len = sizeof(*out) + record_count * sizeof(out->records[0]);
> +	assert(out_pl_len <= CXL_MAILBOX_MAX_PAYLOAD_SIZE);
> +
> +	memset(out, 0, out_pl_len);
> +	stl_le_p(&out->count, record_count);
> +	stl_le_p(&out->total_extents, ct3d->dc.total_extent_count);
> +	stl_le_p(&out->generation_num, ct3d->dc.ext_list_gen_seq);
> +
> +	QTAILQ_FOREACH(ent, extent_list, node) {
> +		if (i++ < in->start_extent_id)
> +			continue;
> +		stq_le_p(&out->records[i].start_dpa, ent->start_dpa);

I has been incrementing for the records skipped.  By now it may be well off
the end of records.  You need a separate index for the ones you are filling
that is incremented only when you write one.
record_done for example.
	out->records[record_done].len etc


> +		stq_le_p(&out->records[i].len, ent->len);
> +		memcpy(&out->records[i].tag, ent->tag, 0x10);
> +		stw_le_p(&out->records[i].shared_seq, ent->shared_seq);
> +		record_done++;
> +		if (record_done == record_count)
> +			break;
> +	}
> +
> +	*len = out_pl_len;
> +	return CXL_MBOX_SUCCESS;
> +}
> +
>  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
>  #define IMMEDIATE_DATA_CHANGE (1 << 2)
>  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> @@ -1041,6 +1109,9 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
>          cmd_media_clear_poison, 72, 0 },
>  	[DCD_CONFIG][GET_DC_REGION_CONFIG] = { "DCD_GET_DC_REGION_CONFIG",
>  		cmd_dcd_get_dyn_cap_config, 2, 0 },
> +	[DCD_CONFIG][GET_DYN_CAP_EXT_LIST] = {
> +		"DCD_GET_DYNAMIC_CAPACITY_EXTENT_LIST", cmd_dcd_get_dyn_cap_ext_list,
> +		8, 0 },
>  };
>  
>  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index b9c375d9b4..23954711b5 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -708,6 +708,7 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
>  
>  		region_base += region->len;
>  	}
> +	QTAILQ_INIT(&ct3d->dc.extents);
>  
>  	return 0;
>  }
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index 8a04e53e90..20ad5e7411 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -385,6 +385,25 @@ typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
>  
>  #define DCD_MAX_REGION_NUM 8
>  
> +typedef struct CXLDCD_Extent_raw {
> +	uint64_t start_dpa;
> +	uint64_t len;
> +	uint8_t tag[0x10];
> +	uint16_t shared_seq;
> +	uint8_t rsvd[0x6];
> +} QEMU_PACKED CXLDCExtent_raw;

What's this for?

> +
> +typedef struct CXLDCD_Extent {
> +	uint64_t start_dpa;
> +	uint64_t len;
> +	uint8_t tag[0x10];
> +	uint16_t shared_seq;
> +	uint8_t rsvd[0x6];
> +
> +	QTAILQ_ENTRY(CXLDCD_Extent) node;
> +} CXLDCD_Extent;
> +typedef QTAILQ_HEAD(, CXLDCD_Extent) CXLDCDExtentList;
> +
>  typedef struct CXLDCD_Region {
>  	uint64_t base;
>  	uint64_t decode_len; /* in multiples of 256MB */
> @@ -429,6 +448,10 @@ struct CXLType3Dev {
>  	struct dynamic_capacity {
>  		uint8_t num_regions; // 1-8
>  		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
> +		CXLDCDExtentList extents;
> +
> +		uint32_t total_extent_count;
> +		uint32_t ext_list_gen_seq;
>  	} dc;
>  };
>  


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C5E65C77B75
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 14:38:03 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S240191AbjEOOiD (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 10:38:03 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33932 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229679AbjEOOiC (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 10:38:02 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7E8FF10A
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 07:37:59 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKhlc1k38z67nTp;
        Mon, 15 May 2023 22:37:00 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 15:37:56 +0100
Date: Mon, 15 May 2023 15:37:55 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 5/7] hw/cxl/cxl-mailbox-utils: Add mailbox commands to
 support add/release dynamic capacity response
Message-ID: <20230515153755.00002bfc@Huawei.com>
In-Reply-To: <20230511175609.2091136-6-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p1a998a2d4a20c370f0172db93d537ed39@uscas1p1.samsung.com>
        <20230511175609.2091136-6-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100005.china.huawei.com (7.191.160.25) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
X-Status: A
Content-Length: 10309
Lines: 340

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Per CXL spec 3.0, we implemented the two mailbox commands:
> Add Dynamic Capacity Response (Opcode 4802h) 8.2.9.8.9.3, and
> Release Dynamic Capacity Response (Opcode 4803h) 8.2.9.8.9.4.
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/cxl/cxl-mailbox-utils.c  | 223 ++++++++++++++++++++++++++++++++++++
>  include/hw/cxl/cxl_device.h |   3 +-
>  2 files changed, 225 insertions(+), 1 deletion(-)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index ed2ac154cb..7212934627 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -84,6 +84,8 @@ enum {
>  	DCD_CONFIG = 0x48, /*8.2.9.8.9*/
>  		#define GET_DC_REGION_CONFIG   0x0
>  		#define GET_DYN_CAP_EXT_LIST   0x1
> +		#define ADD_DYN_CAP_RSP        0x2
> +		#define RELEASE_DYN_CAP        0x3
>      PHYSICAL_SWITCH = 0x51
>          #define IDENTIFY_SWITCH_DEVICE      0x0
>  };
> @@ -1069,6 +1071,221 @@ static CXLRetCode cmd_dcd_get_dyn_cap_ext_list(struct cxl_cmd *cmd,
>  	return CXL_MBOX_SUCCESS;
>  }
>  
> +static inline int test_bits(const unsigned long *addr, int nr, int size)

Not obvious what this does from the name.  Please add some docs.

> +{
> +	unsigned long res = find_next_zero_bit(addr, size + nr, nr);
> +
> +	if (res >= nr + size)
> +		return 1;
> +	else
> +		return 0;
> +}
> +
> +static uint8_t find_region_id(struct CXLType3Dev *dev, uint64_t dpa

Operates only on things in dev->dc, so perhaps pass that instead.

> +		, uint64_t len)

comma on previous line.

> +{
> +	int8_t i = dev->dc.num_regions-1;
> +
> +	while (i > 0 && dpa < dev->dc.regions[i].base)
> +		i--;
> +
> +	if (dpa < dev->dc.regions[i].base
> +			|| dpa + len > dev->dc.regions[i].base + dev->dc.regions[i].len)
> +		return dev->dc.num_regions;
> +
> +	return i;
> +}
> +
> +static CXLRetCode detect_malformed_extent_list(CXLType3Dev *dev, void *data)
> +{
> +	struct updated_dc_extent_list_in_pl {
This is same as used in next function.  Pull it out of the functions and
use that type rather than mapping via a void *data pointer.  

> +		uint32_t num_entries_updated;
> +		uint8_t rsvd[4];
> +		struct {
> +			uint64_t start_dpa;
> +			uint64_t len;
> +			uint8_t rsvd[8];
> +		} QEMU_PACKED updated_entries[];
> +	} QEMU_PACKED;
> +
> +	struct updated_dc_extent_list_in_pl *in = data;
> +	unsigned long *blk_bitmap;
> +	uint64_t min_block_size = dev->dc.regions[0].block_size;
> +	struct CXLDCD_Region *region = &dev->dc.regions[0];
> +	uint32_t i;
> +	uint64_t dpa, len;
> +	uint8_t rid;
> +
> +	for (i = 1; i < dev->dc.num_regions; i++) {
> +		region = &dev->dc.regions[i];
> +		if (min_block_size > region->block_size)
> +			min_block_size = region->block_size;
> +	}
> +	blk_bitmap = bitmap_new((region->len + region->base
> +				- dev->dc.regions[0].base) / min_block_size);
> +	g_assert(blk_bitmap);

Abort in bitmap_new() anyway so no need for this.  Most qemu allocations
don't need to be checked as they fail hard anyway so we never get to the checks.

> +	bitmap_zero(blk_bitmap, (region->len + region->base
> +				- dev->dc.regions[0].base) / min_block_size);

bitmap_new() seems to use a g_malloc0 internally so no need to zero again here
I think.

> +
> +	for (i = 0; i < in->num_entries_updated; i++) {
> +		dpa = in->updated_entries[i].start_dpa;
> +		len = in->updated_entries[i].len;
> +
> +		rid = find_region_id(dev, dpa, len);
> +		if (rid == dev->dc.num_regions) {

Use a goto and single cleanup path having set ret or similar to
the particular issue.

> +			g_free(blk_bitmap);
> +			return CXL_MBOX_INVALID_PA;
> +		}
> +		region = &dev->dc.regions[rid];
> +		if (dpa % region->block_size || len % region->block_size) {
> +			g_free(blk_bitmap);
> +			return CXL_MBOX_INVALID_EXTENT_LIST;
goto from here as well.. etc.

> +		}
> +		/* the dpa range already covered by some other extents in the list */
> +		if (test_bits(blk_bitmap, dpa/min_block_size, len/min_block_size)) {
> +			g_free(blk_bitmap);
> +			return CXL_MBOX_INVALID_EXTENT_LIST;
> +		}
> +		bitmap_set(blk_bitmap, dpa/min_block_size, len/min_block_size);
> +	}
> +
> +	g_free(blk_bitmap);
> +	return CXL_MBOX_SUCCESS;
> +}
> +
> +/*
> + * cxl spec 3.0: 8.2.9.8.9.3
> + * Add Dynamic Capacity Response (opcode 4802h)
> + * Assuming extent list is updated when a extent is added, when receiving
> + * the response, verify and ensure the extent is utilized by the host, and
> + * update extent list  as needed.

Double space in middle of sentence

> + **/
> +static CXLRetCode cmd_dcd_add_dyn_cap_rsp(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len_unused)
> +{
> +	struct add_dyn_cap_ext_list_in_pl {
> +		uint32_t num_entries_updated;
> +		uint8_t rsvd[4];
> +		struct {
> +			uint64_t start_dpa;
> +			uint64_t len;
> +			uint8_t rsvd[8];
> +		} QEMU_PACKED updated_entries[];

These extent list entries keep turning up in the code. Pull that out of here
to be a general 'Extent list element' or similar.

> +	} QEMU_PACKED;
> +
> +	struct add_dyn_cap_ext_list_in_pl *in = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	CXLDCDExtentList *extent_list = &ct3d->dc.extents;
> +	CXLDCD_Extent *ent;
> +	uint32_t i;
> +	uint64_t dpa, len;
> +	CXLRetCode rs;
> +
> +	if (in->num_entries_updated == 0)
> +		return CXL_MBOX_SUCCESS;
> +
> +	rs = detect_malformed_extent_list(ct3d, in);
> +	if (rs != CXL_MBOX_SUCCESS)
> +		return rs;
> +
> +	for (i = 0; i < in->num_entries_updated; i++) {
> +		dpa = in->updated_entries[i].start_dpa;
> +		len = in->updated_entries[i].len;
> +
> +		/* Todo: check following
> +		 * One or more of the updated extent lists contain Starting DPA
> +		 * or Lengths that are out of range of a current extent list
> +		 * maintained by the device.
> +		 **/
> +
> +		QTAILQ_FOREACH(ent, extent_list, node) {

Add some comments here.  Is this a repeated entry test?

> +			if (ent->start_dpa == dpa && ent->len == len)
> +				return CXL_MBOX_INVALID_PA;
> +			if (ent->start_dpa <= dpa
> +				&& dpa + len <= ent->start_dpa + ent->len) {

Comment needed on this one. Why is it shrinking an existing entry?

> +				ent->start_dpa = dpa;
> +				ent->len = len;
> +				break;

If you break here I think it will only result in return CXL_MBOX_SUCCESS so
might as well do that here.

> +			} else if ((dpa < ent->start_dpa + ent->len
> +				&& dpa + len > ent->start_dpa + ent->len)

Above is new entry would contain existing one.

> +				|| (dpa < ent->start_dpa && dpa + len > ent->start_dpa))
> +				return CXL_MBOX_INVALID_EXTENT_LIST;
> +		}
> +		// a new extent added

Why?  This function generally need more documentation.

> +		if (!ent) {
> +			ent = g_new0(CXLDCD_Extent, 1);
> +			assert(ent);

No need.  g_new0 will already have blown up before you get here.

> +			ent->start_dpa = dpa;
> +			ent->len = len;
> +			memset(ent->tag, 0, 0x10);
Allocated empty just above, still empty so no need to set it again.
> +			ent->shared_seq = 0;
> +			QTAILQ_INSERT_TAIL(extent_list, ent, node);
> +		}
> +	}
> +
> +	return CXL_MBOX_SUCCESS;
> +}
> +
> +/*
> + * Spec 3.0: 8.2.9.8.9.4
> + * Release Dynamic Capacity (opcode 4803h)
> + **/
> +static CXLRetCode cmd_dcd_release_dcd_capacity(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len_unused)
> +{
> +	struct release_dcd_cap_in_pl {
> +		uint32_t num_entries_updated;
> +		uint8_t rsvd[4];
> +		struct {
> +			uint64_t start_dpa;
> +			uint64_t len;
> +			uint8_t rsvd[8];
> +		} QEMU_PACKED updated_entries[];
> +	} QEMU_PACKED;
> +
> +	struct release_dcd_cap_in_pl *in = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	CXLDCDExtentList *extent_list = &ct3d->dc.extents;
> +	CXLDCD_Extent *ent;
> +	uint32_t i;
> +	uint64_t dpa, len;
> +	CXLRetCode rs;
> +
> +	if (in->num_entries_updated == 0)
> +		return CXL_MBOX_INVALID_INPUT;
> +
> +	rs = detect_malformed_extent_list(ct3d, in);
> +	if (rs != CXL_MBOX_SUCCESS)
> +		return rs;
> +
> +		/* Todo: check following
> +		 * One or more of the updated extent lists contain Starting DPA
> +		 * or Lengths that are out of range of a current extent list
> +		 * maintained by the device.
> +		 **/
> +
> +	for (i = 0; i < in->num_entries_updated; i++) {
> +		dpa = in->updated_entries[i].start_dpa;
> +		len = in->updated_entries[i].len;
> +
> +		QTAILQ_FOREACH(ent, extent_list, node) {
> +			if (ent->start_dpa == dpa && ent->len == len)

Do the remove here and comment on 'found entry' not needed.
Note I think you can release partial extents so that will need handling at some point.

> +				break;
> +			else if ((dpa < ent->start_dpa + ent->len
> +				&& dpa + len > ent->start_dpa + ent->len)
> +				|| (dpa < ent->start_dpa && dpa + len > ent->start_dpa))
Comment on this condition and why it's a problem.

> +				return CXL_MBOX_INVALID_EXTENT_LIST;
> +		}
> +		/* found the entry, release it */
> +		if (ent)
> +			QTAILQ_REMOVE(extent_list, ent, node);
> +	}
> +
> +	return CXL_MBOX_SUCCESS;
> +}
> +
>  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
>  #define IMMEDIATE_DATA_CHANGE (1 << 2)
>  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> @@ -1112,6 +1329,12 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
>  	[DCD_CONFIG][GET_DYN_CAP_EXT_LIST] = {
>  		"DCD_GET_DYNAMIC_CAPACITY_EXTENT_LIST", cmd_dcd_get_dyn_cap_ext_list,
>  		8, 0 },
> +	[DCD_CONFIG][ADD_DYN_CAP_RSP] = {
> +		"ADD_DCD_DYNAMIC_CAPACITY_RESPONSE", cmd_dcd_add_dyn_cap_rsp,
> +		~0, IMMEDIATE_DATA_CHANGE },
> +	[DCD_CONFIG][RELEASE_DYN_CAP] = {
> +		"RELEASE_DCD_DYNAMIC_CAPACITY", cmd_dcd_release_dcd_capacity,
> +		~0, IMMEDIATE_DATA_CHANGE },
>  };
>  
>  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index 20ad5e7411..c0c8fcc24b 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -131,7 +131,8 @@ typedef enum {
>      CXL_MBOX_INCORRECT_PASSPHRASE = 0x14,
>      CXL_MBOX_UNSUPPORTED_MAILBOX = 0x15,
>      CXL_MBOX_INVALID_PAYLOAD_LENGTH = 0x16,
> -    CXL_MBOX_MAX = 0x17
> +	CXL_MBOX_INVALID_EXTENT_LIST = 0x17,

0x1e in the spec.

> +	CXL_MBOX_MAX = 0x18
>  } CXLRetCode;
>  
>  struct cxl_cmd;


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 945EAC77B7D
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 14:53:36 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S240191AbjEOOxf (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 10:53:35 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41386 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S240135AbjEOOxd (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 10:53:33 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8EE23198B
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 07:53:31 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKj4b0W0Qz67M5Q;
        Mon, 15 May 2023 22:51:43 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 15:53:27 +0100
Date: Mon, 15 May 2023 15:53:26 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 6/7] Add qmp interfaces to add/release dynamic capacity
 extents
Message-ID: <20230515155326.0000093f@Huawei.com>
In-Reply-To: <20230511175609.2091136-7-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p27cf2915c8184225bfd581fb6f6dfb2d9@uscas1p2.samsung.com>
        <20230511175609.2091136-7-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500005.china.huawei.com (7.191.163.240) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 9026
Lines: 307

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Since fabric manager emulation is not supported yet, the change implements
> the functions to add/release dynamic capacity extents as QMP interfaces.

This makes sense at least as a stop gap.

> 
> 1. Add dynamic capacity extents:
> 
> For example, the command to add two continuous extents (each is 128MB
> long) to region 0 (starting at dpa offset 0) looks like below:
> 
> { "execute": "qmp_capabilities" }
> 
> { "execute": "cxl-add-dynamic-capacity-event",
>     "arguments": {
> 	"path": "/machine/peripheral/cxl-pmem0",
> 	"region-id" : 0,
> 	"num-extent": 2,
What does num-extent mean? 
A multiple entry injection mechanism makes sense but this
doesn't seem be one.  Look at the error injection stuff done
to ensure we could inject multiple of those as one atomic operation
to trigger the various multi error handling paths.

> 	"dpa":0,
> 	"extent-len": 128
> 	}
> }
> 
> 2. Release dynamic capacity extents:
> 
> For example, the command to release an extent of size 128MB from region
> 0 (starting at dpa offset 0) look like below:
> 
> { "execute": "cxl-release-dynamic-capacity-event",
> 	"arguments": {
> 		 "path": "/machine/peripheral/cxl-pmem0",
> 		"region-id" : 0,
> 		 "num-extent": 1 ,
> 		"dpa":0,
> 		"extent-len": 128
> 	}
> }
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/mem/cxl_type3.c          | 127 ++++++++++++++++++++++++++++++++++++
>  include/hw/cxl/cxl_events.h |  16 +++++
>  qapi/cxl.json               |  44 +++++++++++++
>  3 files changed, 187 insertions(+)
> 
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 23954711b5..70d47d43b9 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -1651,6 +1651,133 @@ void qmp_cxl_inject_memory_module_event(const char *path, CxlEventLog log,
>      }
>  }
>  
> +static const QemuUUID dynamic_capacity_uuid = {
> +	.data = UUID(0xca95afa7, 0xf183, 0x4018, 0x8c, 0x2f,
> +			0x95, 0x26, 0x8e, 0x10, 0x1a, 0x2a),
> +};
> +
> +static void qmp_cxl_process_dynamic_capacity_event(const char *path, CxlEventLog log,
> +		uint8_t flags, uint8_t type, uint16_t hid, uint8_t rid, uint32_t extent_cnt,
> +		CXLDCExtent_raw *extents, Error **errp)
> +{
> +	Object *obj = object_resolve_path(path, NULL);
> +	CXLEventDynamicCapacity dCap;
> +	CXLEventRecordHdr *hdr = &dCap.hdr;
> +	CXLDeviceState *cxlds;
> +	CXLType3Dev *dcd;
> +	int i;
> +
> +	if (!obj) {
> +		error_setg(errp, "Unable to resolve path");
> +		return;
> +	}
> +	if (!object_dynamic_cast(obj, TYPE_CXL_TYPE3)) {
> +		error_setg(errp, "Path not point to a valid CXL type3 device");
> +		return;
> +	}
> +
> +	dcd = CXL_TYPE3(obj);
> +	cxlds = &dcd->cxl_dstate;
> +	memset(&dCap, 0, sizeof(dCap));
> +
> +	if (!dcd->dc.num_regions) {
> +		error_setg(errp, "No dynamic capacity support from the device");
> +		return;
> +	}
> +
> +	/*
> +	 * 8.2.9.1.5
> +	 * All Dynamic Capacity event records shall set the Event Record
> +	 * Severity field in the Common Event Record Format to Informational
> +	 * Event. All Dynamic Capacity related events shall be logged in the
> +	 * Dynamic Capacity Event Log.
> +	 */
> +	assert(flags & (1<<CXL_EVENT_TYPE_INFO));

Given this requirement, why pass in those flags at all? Just set it in here instead
thus ensuring it's always right.

> +	cxl_assign_event_header(hdr, &dynamic_capacity_uuid, flags, sizeof(dCap));
> +
> +	/*
> +	 * 00h: add capacity
> +	 * 01h: release capacity

Enum for these so the input is typed.

> +	 * 02h: forced capacity release
> +	 * 03h: region configuration updated
> +	 * 04h: Add capacity response
> +	 * 05h: capacity released
> +	 **/
> +	dCap.type = type;
> +	stw_le_p(&dCap.host_id, hid);
> +	dCap.updated_region_id = rid;
> +	for (i = 0; i < extent_cnt; i++) {
> +		extents[i].start_dpa += dcd->dc.regions[rid].base;

Mixture of handling endian conversion and not.  Whilst we still have
a bunch of cleanup to do around this, new code should handle endian
conversions always.  If touching code with problems, a precursor patch
to fix that code up before adding new stuff would be great as well.

> +		memcpy(&dCap.dynamic_capacity_extent, &extents[i]
> +				, sizeof(CXLDCExtent_raw));

comma on previous line.

> +
> +		if (cxl_event_insert(cxlds, CXL_EVENT_TYPE_DYNAMIC_CAP,
> +					(CXLEventRecordRaw *)&dCap)) {
> +			;

?  Failure here indicates a bug or an overflow of the event log.
Both want handling.

> +		}
> +		cxl_event_irq_assert(dcd);
> +	}
> +}
> +
> +#define MEM_BLK_SIZE_MB 128
> +void qmp_cxl_add_dynamic_capacity_event(const char *path, uint8_t region_id,
> +		uint32_t num_exent, uint64_t dpa, uint64_t extent_len_MB, Error **errp)
> +{
> +	uint8_t flags = 1 << CXL_EVENT_TYPE_INFO;

As above, no point in handling flags out here if they always have same value.
Push them to where it matters.

> +	CXLDCExtent_raw *extents;
> +	int i;
> +
> +	if (extent_len_MB < MEM_BLK_SIZE_MB) {
> +		error_setg(errp,
> +			"extent size cannot be smaller than memory block size (%dMB)",
> +			MEM_BLK_SIZE_MB);
> +		return;
> +	}
> +
> +	extents = g_new0(CXLDCExtent_raw, num_exent);

Ah. Raw extents used in here. Either combine the different definitions or bring
that one forwards to this patch.

> +	for (i = 0; i < num_exent; i++) {
> +		extents[i].start_dpa = dpa;
> +		extents[i].len = extent_len_MB*1024*1024;
> +		memset(extents[i].tag, 0, 0x10);
> +		extents[i].shared_seq = 0;
> +		dpa += extents[i].len;
> +	}
> +
> +	qmp_cxl_process_dynamic_capacity_event(path, CXL_EVENT_LOG_INFORMATIONAL,
> +			flags, 0x0, 0, region_id, num_exent, extents, errp);
> +
> +	g_free(extents);
> +}
> +
> +void qmp_cxl_release_dynamic_capacity_event(const char *path, uint8_t region_id,
> +		uint32_t num_exent, uint64_t dpa, uint64_t extent_len_MB, Error **errp)
> +{
> +	uint8_t flags = 1 << CXL_EVENT_TYPE_INFO;
> +	CXLDCExtent_raw *extents;
> +	int i;
> +
> +	if (extent_len_MB < MEM_BLK_SIZE_MB) {
> +		error_setg(errp,
> +			"extent size cannot be smaller than memory block size (%dMB)",
> +			MEM_BLK_SIZE_MB);
> +		return;
> +	}
> +
> +	extents = g_new0(CXLDCExtent_raw, num_exent);
> +	for (i = 0; i < num_exent; i++) {
> +		extents[i].start_dpa = dpa;
> +		extents[i].len = extent_len_MB*1024*1024;
> +		memset(extents[i].tag, 0, 0x10);
> +		extents[i].shared_seq = 0;
> +		dpa += extents[i].len;
> +	}
> +
> +	qmp_cxl_process_dynamic_capacity_event(path, CXL_EVENT_LOG_INFORMATIONAL,
> +			flags, 0x1, 0, region_id, num_exent, extents, errp);
> +
> +	g_free(extents);
> +}
> +
>  static void ct3_class_init(ObjectClass *oc, void *data)
>  {
>      DeviceClass *dc = DEVICE_CLASS(oc);
> diff --git a/include/hw/cxl/cxl_events.h b/include/hw/cxl/cxl_events.h
> index 089ba2091f..dd00458d1d 100644
> --- a/include/hw/cxl/cxl_events.h
> +++ b/include/hw/cxl/cxl_events.h
> @@ -165,4 +165,20 @@ typedef struct CXLEventMemoryModule {
>      uint8_t reserved[0x3d];
>  } QEMU_PACKED CXLEventMemoryModule;
>  
> +/*
> + * Dynamic Capacity Event Record
> + * CXL Rev 3.0 Section 8.2.9.2.1.5: Table 8-47
> + * All fields little endian.
> + */
> +typedef struct CXLEventDynamicCapacity {
> +	CXLEventRecordHdr hdr;
> +	uint8_t type;
> +	uint8_t reserved1;
> +	uint16_t host_id;
> +	uint8_t updated_region_id;
> +	uint8_t reserved2[3];
> +	uint8_t dynamic_capacity_extent[0x28]; /* defined in cxl_device.h */
> +	uint8_t reserved[0x20];
> +} QEMU_PACKED CXLEventDynamicCapacity;
> +
>  #endif /* CXL_EVENTS_H */
> diff --git a/qapi/cxl.json b/qapi/cxl.json
> index 8b3d30cd71..c9a9a45ce4 100644
> --- a/qapi/cxl.json
> +++ b/qapi/cxl.json
> @@ -264,3 +264,47 @@
>              'type': 'CxlCorErrorType'
>    }
>  }
> +
> +##
> +# @cxl-add-dynamic-capacity-event:
> +#
> +# Command to add dynamic capacity extent event
> +#
> +# @path: CXL DCD canonical QOM path
> +# @region-id: region id
> +# @num-extent: number of extents to add, test only
Moving towards 
> +# @dpa: start dpa for the operation
> +# @extent-len: extent size in MB
> +#
> +# Since: 8.0
> +##
> +{ 'command': 'cxl-add-dynamic-capacity-event',
> +  'data': { 'path': 'str',
> +           'region-id': 'uint8',
> +           'num-extent': 'uint32',

Look at how cxl-inject-uncorrectable-errors is done
as that handles a set of records all in one command and
we want similar here - so that we generate what it would
look like if the fm-api was used.

> +           'dpa':'uint64',
> +           'extent-len': 'uint64'
> +  }
> +}
> +
> +##
> +# @cxl-release-dynamic-capacity-event:
> +#
> +# Command to add dynamic capacity extent event
> +#
> +# @path: CXL DCD canonical QOM path
> +# @region-id: region id
> +# @num-extent: number of extents to add, test only
> +# @dpa: start dpa for the operation
> +# @extent-len: extent size in MB
> +#
> +# Since: 8.0
> +##
> +{ 'command': 'cxl-release-dynamic-capacity-event',
> +  'data': { 'path': 'str',
> +           'region-id': 'uint8',
> +           'num-extent': 'uint32',
> +           'dpa':'uint64',
> +           'extent-len': 'uint64'
> +  }
> +}


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 23DD5C77B75
	for <linux-cxl@archiver.kernel.org>; Mon, 15 May 2023 15:22:32 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S242411AbjEOPWb (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 15 May 2023 11:22:31 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38020 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S242405AbjEOPWY (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 15 May 2023 11:22:24 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7C5B22137
        for <linux-cxl@vger.kernel.org>; Mon, 15 May 2023 08:22:16 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QKjkh4JzHz67lp8;
        Mon, 15 May 2023 23:21:16 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Mon, 15 May
 2023 16:22:13 +0100
Date: Mon, 15 May 2023 16:22:12 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [RFC 7/7] hw/mem/cxl_type3: add read/write support to dynamic
 capacity
Message-ID: <20230515162212.0000275c@Huawei.com>
In-Reply-To: <20230511175609.2091136-8-fan.ni@samsung.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p2c037608a1dd26b19cf970f97ce434c6d@uscas1p2.samsung.com>
        <20230511175609.2091136-8-fan.ni@samsung.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500005.china.huawei.com (7.191.163.240) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 23744
Lines: 704

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> From: Fan Ni <nifan@outlook.com>
> 
> Before the change, read from or write to dynamic capacity of the memory
> device is not support as 1) no host backed file/memory is provided for
> it; 2) no address space is created for the dynamic capacity.

Ah nice. I should have read ahead.  Probably makes sense to reorder things
so that when we present DCD region it will work.

> 
> With the change, add code to support following:
> 1. add a new property to type3 device "dc-memdev" to point to host
>    memory backend for dynamic capacity;
> 2. add a bitmap for each region to track whether a block is host backed,
> which will be used for address check when read/write dynamic capacity;
> 3. add namespace for dynamic capacity for read/write support;
> 4. create cdat entries for each dynamic capacity region;
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/cxl/cxl-mailbox-utils.c  |  21 ++-
>  hw/mem/cxl_type3.c          | 336 +++++++++++++++++++++++++++++-------
>  include/hw/cxl/cxl_device.h |   8 +-
>  3 files changed, 298 insertions(+), 67 deletions(-)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 7212934627..efe61e67fb 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -391,9 +391,11 @@ static CXLRetCode cmd_firmware_update_get_info(struct cxl_cmd *cmd,
>          char fw_rev4[0x10];
>      } QEMU_PACKED *fw_info;
>      QEMU_BUILD_BUG_ON(sizeof(*fw_info) != 0x50);
> +	CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
>  
>      if ((cxl_dstate->vmem_size < CXL_CAPACITY_MULTIPLIER) ||
> -        (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER)) {
> +			(cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) ||

Keep old alignment

> +		(ct3d->dc.total_dynamic_capicity < CXL_CAPACITY_MULTIPLIER)) {

We should think about the separation between what goes in cxl_dstate and directly
in ct3d. That boundary has been blurring for a while and getting some review
comments.

>          return CXL_MBOX_INTERNAL_ERROR;
>      }
>  
> @@ -534,7 +536,9 @@ static CXLRetCode cmd_identify_memory_device(struct cxl_cmd *cmd,
>      CXLType3Class *cvc = CXL_TYPE3_GET_CLASS(ct3d);
>  
>      if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER)) ||
> -        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))) {
> +		(!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER)) ||
> +		(!QEMU_IS_ALIGNED(ct3d->dc.total_dynamic_capicity,
> +						CXL_CAPACITY_MULTIPLIER))) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
>  
> @@ -543,7 +547,8 @@ static CXLRetCode cmd_identify_memory_device(struct cxl_cmd *cmd,
>  
>      snprintf(id->fw_revision, 0x10, "BWFW VERSION %02d", 0);
>  
> -    stq_le_p(&id->total_capacity, cxl_dstate->mem_size / CXL_CAPACITY_MULTIPLIER);
> +	stq_le_p(&id->total_capacity,
> +			cxl_dstate->static_mem_size / CXL_CAPACITY_MULTIPLIER);

Pull the rename out as a precursor patch.

>      stq_le_p(&id->persistent_capacity, cxl_dstate->pmem_size / CXL_CAPACITY_MULTIPLIER);
>      stq_le_p(&id->volatile_capacity, cxl_dstate->vmem_size / CXL_CAPACITY_MULTIPLIER);
>      stl_le_p(&id->lsa_size, cvc->get_lsa_size(ct3d));
> @@ -568,9 +573,12 @@ static CXLRetCode cmd_ccls_get_partition_info(struct cxl_cmd *cmd,
>          uint64_t next_pmem;
>      } QEMU_PACKED *part_info = (void *)cmd->payload;
>      QEMU_BUILD_BUG_ON(sizeof(*part_info) != 0x20);
> +	CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
>  
>      if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER)) ||
> -        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))) {
> +		(!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER)) ||
> +		(!QEMU_IS_ALIGNED(ct3d->dc.total_dynamic_capicity,
> +						CXL_CAPACITY_MULTIPLIER))) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
>  
> @@ -881,9 +889,8 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
>      struct clear_poison_pl *in = (void *)cmd->payload;
>  
>      dpa = ldq_le_p(&in->dpa);
> -    if (dpa + 64 > cxl_dstate->mem_size) {
> -        return CXL_MBOX_INVALID_PA;
> -    }
> +	if (dpa + 64 > cxl_dstate->static_mem_size && ct3d->dc.num_regions == 0)

This test will need expanding to include DPAs in DC regions.

> +		return CXL_MBOX_INVALID_PA;
>  
>      QLIST_FOREACH(ent, poison_list, node) {
>          /*
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 70d47d43b9..334660bd0f 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -33,8 +33,8 @@ enum {
>  };
>  
>  static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
> -                                         int dsmad_handle, MemoryRegion *mr,
> -                                         bool is_pmem, uint64_t dpa_base)
> +		int dsmad_handle, uint8_t flags,
> +		uint64_t dpa_base, uint64_t size)
>  {
>      g_autofree CDATDsmas *dsmas = NULL;
>      g_autofree CDATDslbis *dslbis0 = NULL;
> @@ -53,9 +53,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
>              .length = sizeof(*dsmas),
>          },
>          .DSMADhandle = dsmad_handle,
> -        .flags = is_pmem ? CDAT_DSMAS_FLAG_NV : 0,
> +		.flags = flags,
>          .DPA_base = dpa_base,
> -        .DPA_length = int128_get64(mr->size),
> +		.DPA_length = size,
>      };
>  
>      /* For now, no memory side cache, plausiblish numbers */
> @@ -137,9 +137,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
>           * NV: Reserved - the non volatile from DSMAS matters
>           * V: EFI_MEMORY_SP
>           */
> -        .EFI_memory_type_attr = is_pmem ? 2 : 1,
> +		.EFI_memory_type_attr = flags ? 2 : 1,

Fix all these alignment changes (spaces vs tabs)

>          .DPA_offset = 0,
> -        .DPA_length = int128_get64(mr->size),
> +		.DPA_length = size,
>      };
>  
>      /* Header always at start of structure */
> @@ -158,14 +158,15 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>      g_autofree CDATSubHeader **table = NULL;
>      CXLType3Dev *ct3d = priv;
>      MemoryRegion *volatile_mr = NULL, *nonvolatile_mr = NULL;
> +	MemoryRegion *dc_mr = NULL;
>      int dsmad_handle = 0;
>      int cur_ent = 0;
>      int len = 0;
>      int rc, i;
> +	uint64_t vmr_size = 0, pmr_size = 0;
>  
> -    if (!ct3d->hostpmem && !ct3d->hostvmem) {
> -        return 0;
> -    }
> +	if (!ct3d->hostpmem && !ct3d->hostvmem && !ct3d->dc.num_regions)
> +		return 0;
>  
>      if (ct3d->hostvmem) {
>          volatile_mr = host_memory_backend_get_memory(ct3d->hostvmem);
> @@ -173,6 +174,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>              return -EINVAL;
>          }
>          len += CT3_CDAT_NUM_ENTRIES;
> +		vmr_size = volatile_mr->size;
>      }
>  
>      if (ct3d->hostpmem) {
> @@ -181,7 +183,19 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>              return -EINVAL;
>          }
>          len += CT3_CDAT_NUM_ENTRIES;
> -    }
> +		pmr_size = nonvolatile_mr->size;
> +	}
> +
> +	if (ct3d->dc.num_regions) {
> +		if (ct3d->dc.host_dc) {
> +			dc_mr = host_memory_backend_get_memory(ct3d->dc.host_dc);
> +			if (!dc_mr)
> +				return -EINVAL;
> +			len += CT3_CDAT_NUM_ENTRIES * ct3d->dc.num_regions;
> +		} else {
> +			return -EINVAL;
> +		}
> +	}
>  
>      table = g_malloc0(len * sizeof(*table));
>      if (!table) {
> @@ -189,23 +203,45 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>      }
>  
>      /* Now fill them in */
> -    if (volatile_mr) {
> -        rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
> -                                           false, 0);
> -        if (rc < 0) {
> -            return rc;
> -        }
> -        cur_ent = CT3_CDAT_NUM_ENTRIES;
> -    }
> +	if (volatile_mr) {
> +		rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++,
> +				0, 0, vmr_size);
> +		if (rc < 0)
> +			return rc;
Without the tabs / spaces accidental conversion this diff should look a lot
clearer..
> +		cur_ent = CT3_CDAT_NUM_ENTRIES;
> +	}
> +
> +	if (nonvolatile_mr) {
> +		rc = ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_handle++,
> +				CDAT_DSMAS_FLAG_NV, vmr_size, pmr_size);
> +		if (rc < 0)
> +			goto error_cleanup;
> +		cur_ent += CT3_CDAT_NUM_ENTRIES;
> +	}
> +
> +	if (dc_mr) {
> +		uint64_t region_base = vmr_size + pmr_size;
> +
> +		/*
> +		 * Currently we create cdat entries for each region, should we only
> +		 * create dsmas table instead??

I don't think it does any harm to have a lot of similar entries. We may want to reconsider
this in the longer term to make sure that more complex code paths are handled where
things are shared.  What combinations does the spec allow?
One entry for all regions with them all sharing a single dsmad handle?


> +		 * We assume all dc regions are non-volatile for now.
> +		 *
> +		 */
> +		for (i = 0; i < ct3d->dc.num_regions; i++) {
> +			rc = ct3_build_cdat_entries_for_mr(&(table[cur_ent])
> +					, dsmad_handle++
> +					, CDAT_DSMAS_FLAG_NV|CDAT_DSMAS_FLAG_DYNAMIC_CAP
> +					, region_base, ct3d->dc.regions[i].len);
> +			if (rc < 0)
> +				goto error_cleanup;
> +			ct3d->dc.regions[i].dsmadhandle = dsmad_handle-1;
> +
> +			cur_ent += CT3_CDAT_NUM_ENTRIES;
> +			region_base += ct3d->dc.regions[i].len;
> +		}
> +	}
>  
> -    if (nonvolatile_mr) {
> -        rc = ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_handle++,
> -                nonvolatile_mr, true, (volatile_mr ? volatile_mr->size : 0));
> -        if (rc < 0) {
> -            goto error_cleanup;
> -        }
> -        cur_ent += CT3_CDAT_NUM_ENTRIES;
> -    }
>      assert(len == cur_ent);
>  
>      *cdat_table = g_steal_pointer(&table);
> @@ -706,6 +742,11 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
>  		/* dsmad_handle is set when creating cdat table entries */
>  		region->flags = 0;
>  
> +		region->blk_bitmap = bitmap_new(region->len / region->block_size);
> +		if (!region->blk_bitmap)
> +			return -1;
> +		bitmap_zero(region->blk_bitmap, region->len / region->block_size);
> +
>  		region_base += region->len;
>  	}
>  	QTAILQ_INIT(&ct3d->dc.extents);
> @@ -713,11 +754,24 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
>  	return 0;
>  }
>  
> +static void cxl_destroy_toy_regions(CXLType3Dev *ct3d)

Why toy?  They work after this so no longer toys ;)

> +{
> +	int i;
> +	struct CXLDCD_Region *region;
> +
> +	for (i = 0; i < ct3d->dc.num_regions; i++) {
> +		region = &ct3d->dc.regions[i];
> +		if (region->blk_bitmap)
> +			g_free(region->blk_bitmap);
Why is check needed? Is there a path where we call this function
without the bitmap having been allocated successfully?

> +	}
> +}
> +
>  static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>  {
>      DeviceState *ds = DEVICE(ct3d);
>  
> -    if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem) {
> +	if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem
> +			&& !ct3d->dc.num_regions) {
>          error_setg(errp, "at least one memdev property must be set");
>          return false;
>      } else if (ct3d->hostmem && ct3d->hostpmem) {
> @@ -754,7 +808,7 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>          }
>          address_space_init(&ct3d->hostvmem_as, vmr, v_name);
>          ct3d->cxl_dstate.vmem_size = vmr->size;
> -        ct3d->cxl_dstate.mem_size += vmr->size;
> +		ct3d->cxl_dstate.static_mem_size += vmr->size;
>          g_free(v_name);
>      }
>  
> @@ -777,12 +831,47 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>          }
>          address_space_init(&ct3d->hostpmem_as, pmr, p_name);
>          ct3d->cxl_dstate.pmem_size = pmr->size;
> -        ct3d->cxl_dstate.mem_size += pmr->size;
> +		ct3d->cxl_dstate.static_mem_size += pmr->size;
>          g_free(p_name);
>      }
>  
> -	if (cxl_create_toy_regions(ct3d))
> -		return false;
> +	ct3d->dc.total_dynamic_capicity = 0;
> +	if (ct3d->dc.host_dc) {
> +		MemoryRegion *dc_mr;
> +		char *dc_name;
> +		uint64_t total_region_size = 0;
> +		int i;
> +
> +		dc_mr = host_memory_backend_get_memory(ct3d->dc.host_dc);
> +		if (!dc_mr) {
> +			error_setg(errp, "dynamic capacity must have backing device");
> +			return false;

> +		}
> +		/* FIXME: set dc as nonvolatile for now */
That's fine. I think to do anything else we'll want multiple backends anyway.
Perhaps rename the parameter to reflect that it's volatile for now though otherwise
we'll end up deprecating another memory region command line parameter and people will
begin to get grumpy ;)

> +		memory_region_set_nonvolatile(dc_mr, true);
> +		memory_region_set_enabled(dc_mr, true);
> +		host_memory_backend_set_mapped(ct3d->dc.host_dc, true);
> +		if (ds->id) {
> +			dc_name = g_strdup_printf("cxl-dcd-dpa-dc-space:%s", ds->id);
> +		} else {
> +			dc_name = g_strdup("cxl-dcd-dpa-dc-space");
> +		}
> +		address_space_init(&ct3d->dc.host_dc_as, dc_mr, dc_name);
> +
> +		if (cxl_create_toy_regions(ct3d)) {
> +			return false;
> +		}
> +
> +		for (i = 0; i < ct3d->dc.num_regions; i++) {
> +			total_region_size += ct3d->dc.regions[i].len;
> +		}
> +		/* Make sure the host backend is large enough to cover all dc range */
> +		assert(total_region_size <= dc_mr->size);
> +		assert(dc_mr->size % (256*1024*1024) == 0);
> +
> +		ct3d->dc.total_dynamic_capicity = total_region_size;
> +		g_free(dc_name);
> +	}
>  
>      return true;
>  }
> @@ -890,6 +979,10 @@ err_release_cdat:
>  err_free_special_ops:
>      g_free(regs->special_ops);
>  err_address_space_free:
> +	if (ct3d->dc.host_dc) {
> +		cxl_destroy_toy_regions(ct3d);
> +		address_space_destroy(&ct3d->dc.host_dc_as);
> +	}
>      if (ct3d->hostpmem) {
>          address_space_destroy(&ct3d->hostpmem_as);
>      }
> @@ -909,6 +1002,10 @@ static void ct3_exit(PCIDevice *pci_dev)
>      cxl_doe_cdat_release(cxl_cstate);
>      spdm_sock_fini(ct3d->doe_spdm.socket);
>      g_free(regs->special_ops);
> +	if (ct3d->dc.host_dc) {
> +		cxl_destroy_toy_regions(ct3d);
> +		address_space_destroy(&ct3d->dc.host_dc_as);
> +	}
>      if (ct3d->hostpmem) {
>          address_space_destroy(&ct3d->hostpmem_as);
>      }
> @@ -917,6 +1014,100 @@ static void ct3_exit(PCIDevice *pci_dev)
>      }
>  }
>  
> +static void set_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
> +		uint64_t len)
> +{
> +	int i;
> +	CXLDCD_Region *region = NULL;
> +
> +	if (dpa < ct3d->dc.regions[0].base
> +		|| dpa >= ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicity)
> +		return;
> +
> +	/*
> +	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
> +	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
> +	 * Region 7 for the highest DPA.
> +	 * So we check from the last region to find where the dpa belongs.
> +	 * access across multiple regions is not allowed.
> +	 **/
> +	for (i = ct3d->dc.num_regions-1; i >= 0; i--) {
> +		region = &ct3d->dc.regions[i];
> +		if (dpa >= region->base)
> +			break;
> +	}
> +
> +	bitmap_set(region->blk_bitmap, (dpa-region->base)/region->block_size,
> +			len/region->block_size);
> +}
> +
> +static bool test_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
> +		uint64_t len)
> +{
> +	int i;
> +	CXLDCD_Region *region = NULL;
> +	uint64_t nbits;
> +	long nr;
> +
> +	if (dpa < ct3d->dc.regions[0].base
> +		   || dpa >= ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicity)
> +		return false;
> +
> +	/*
> +	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
> +	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
> +	 * Region 7 for the highest DPA.
> +	 * So we check from the last region to find where the dpa belongs.
> +	 * access across multiple regions is not allowed.
> +	 **/
> +	for (i = ct3d->dc.num_regions-1; i >= 0; i--) {
> +		region = &ct3d->dc.regions[i];
> +		if (dpa >= region->base)
> +			break;
> +	}
> +
> +	nr = (dpa-region->base)/region->block_size;
> +	nbits = (len + region->block_size-1)/region->block_size;
> +	if (find_next_zero_bit(region->blk_bitmap, nr+nbits, nr)
> +			>= nr+nbits)
> +		return true;
> +
> +	return false;

return find_next_zero_bit(...) >= nr + nbits;

> +}
> +
> +static void clear_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
> +		uint64_t len)
> +{
> +	int i;
> +	CXLDCD_Region *region = NULL;
> +	uint64_t nbits;
> +	long nr;
> +
> +	if (dpa < ct3d->dc.regions[0].base
> +		|| dpa >= ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicity)
> +		return;
> +
> +	/*
> +	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
> +	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
> +	 * Region 7 for the highest DPA.
> +	 * So we check from the last region to find where the dpa belongs.
> +	 * access across multiple regions is not allowed.
> +	 **/
> +	for (i = ct3d->dc.num_regions-1; i >= 0; i--) {
> +		region = &ct3d->dc.regions[i];
> +		if (dpa >= region->base)
> +			break;
> +	}
> +
> +	nr = (dpa-region->base) / region->block_size;
> +	nbits = (len + region->block_size-1) / region->block_size;

Why handle non precise multiple?  

> +	for (i = 0; i < nbits; i++) {
> +		clear_bit(nr, region->blk_bitmap);
> +		nr++;
> +	}

bitmap_clear()?



> +
>  static bool cxl_type3_dpa(CXLType3Dev *ct3d, hwaddr host_addr, uint64_t *dpa)
>  {
>      uint32_t *cache_mem = ct3d->cxl_cstate.crb.cache_mem_registers;
> @@ -973,16 +1164,24 @@ static int cxl_type3_hpa_to_as_and_dpa(CXLType3Dev *ct3d,
>                                         AddressSpace **as,
>                                         uint64_t *dpa_offset)
>  {
> -    MemoryRegion *vmr = NULL, *pmr = NULL;
> +	MemoryRegion *vmr = NULL, *pmr = NULL, *dc_mr = NULL;
> +	uint64_t vmr_size = 0, pmr_size = 0, dc_size = 0;
>  
>      if (ct3d->hostvmem) {
>          vmr = host_memory_backend_get_memory(ct3d->hostvmem);
> +		vmr_size = int128_get64(vmr->size);
>      }
>      if (ct3d->hostpmem) {
>          pmr = host_memory_backend_get_memory(ct3d->hostpmem);
> +		pmr_size = int128_get64(pmr->size);
>      }
> +	if (ct3d->dc.host_dc) {
> +		dc_mr = host_memory_backend_get_memory(ct3d->dc.host_dc);
> +		/* Do we want dc_size to be dc_mr->size or not?? */
> +		dc_size = ct3d->dc.total_dynamic_capicity;
> +	}
>  
> -    if (!vmr && !pmr) {
> +	if (!vmr && !pmr && !dc_mr) {
>          return -ENODEV;
>      }
>  
> @@ -990,20 +1189,22 @@ static int cxl_type3_hpa_to_as_and_dpa(CXLType3Dev *ct3d,
>          return -EINVAL;
>      }
>  
> -    if (*dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
> +    if (*dpa_offset >= vmr_size + pmr_size + dc_size ||
> +       (*dpa_offset >= vmr_size + pmr_size && ct3d->dc.num_regions == 0)) {
>          return -EINVAL;
>      }
>  
> -    if (vmr) {
> -        if (*dpa_offset < int128_get64(vmr->size)) {
> -            *as = &ct3d->hostvmem_as;
> -        } else {
> -            *as = &ct3d->hostpmem_as;
> -            *dpa_offset -= vmr->size;
> -        }
> -    } else {
> -        *as = &ct3d->hostpmem_as;
> -    }
> +	if (*dpa_offset < vmr_size)
> +		*as = &ct3d->hostvmem_as;
> +	else if (*dpa_offset < vmr_size + pmr_size) {
> +		*as = &ct3d->hostpmem_as;
> +		*dpa_offset -= vmr_size;
> +	} else {
> +		if (!test_region_block_backed(ct3d, *dpa_offset, size))
> +			return -ENODEV;
> +		*as = &ct3d->dc.host_dc_as;
> +		*dpa_offset -= (vmr_size + pmr_size);
> +	}
>  
>      return 0;
>  }
> @@ -1069,6 +1270,8 @@ static Property ct3_props[] = {
>      DEFINE_PROP_STRING("cdat", CXLType3Dev, cxl_cstate.cdat.filename),
>      DEFINE_PROP_UINT16("spdm", CXLType3Dev, spdm_port, 0),
>  	DEFINE_PROP_UINT8("num-dc-regions", CXLType3Dev, dc.num_regions, 0),
> +	DEFINE_PROP_LINK("dc-memdev", CXLType3Dev, dc.host_dc,
> +					TYPE_MEMORY_BACKEND, HostMemoryBackend *),

Perhaps volatile-dc-memdev?  leaves us space for a persistent one in future.
If anyone every cares that is ;)

>      DEFINE_PROP_END_OF_LIST(),
>  };
>  
> @@ -1135,34 +1338,41 @@ static void set_lsa(CXLType3Dev *ct3d, const void *buf, uint64_t size,
>  
>  static bool set_cacheline(CXLType3Dev *ct3d, uint64_t dpa_offset, uint8_t *data)
>  {
> -    MemoryRegion *vmr = NULL, *pmr = NULL;
> +	MemoryRegion *vmr = NULL, *pmr = NULL, *dc_mr = NULL;
>      AddressSpace *as;
> +	uint64_t vmr_size = 0, pmr_size = 0, dc_size = 0;
>  
>      if (ct3d->hostvmem) {
>          vmr = host_memory_backend_get_memory(ct3d->hostvmem);
> +		vmr_size = int128_get64(vmr->size);
>      }
>      if (ct3d->hostpmem) {
>          pmr = host_memory_backend_get_memory(ct3d->hostpmem);
> +		pmr_size = int128_get64(pmr->size);
>      }
> +	if (ct3d->dc.host_dc) {
> +		dc_mr = host_memory_backend_get_memory(ct3d->dc.host_dc);
> +		dc_size = ct3d->dc.total_dynamic_capicity;
> +	}
>  
> -    if (!vmr && !pmr) {
> +    if (!vmr && !pmr && !dc_mr) {
>          return false;
>      }
>  
> -    if (dpa_offset + 64 > int128_get64(ct3d->cxl_dstate.mem_size)) {
> -        return false;
> -    }
> +	if (dpa_offset >= vmr_size + pmr_size + dc_size)
> +		return false;
> +	if (dpa_offset + 64 >= vmr_size + pmr_size && ct3d->dc.num_regions == 0)
> +		return false;
>  
> -    if (vmr) {
> -        if (dpa_offset <= int128_get64(vmr->size)) {
> -            as = &ct3d->hostvmem_as;
> -        } else {
> -            as = &ct3d->hostpmem_as;
> -            dpa_offset -= vmr->size;
> -        }
> -    } else {
> -        as = &ct3d->hostpmem_as;
> -    }
> +	if (dpa_offset < vmr_size) {
> +		as = &ct3d->hostvmem_as;
> +	} else if (dpa_offset < vmr_size + pmr_size) {
> +		as = &ct3d->hostpmem_as;
> +		dpa_offset -= vmr->size;
> +	} else {
> +		as = &ct3d->dc.host_dc_as;
> +		dpa_offset -= (vmr_size + pmr_size);
> +	}
>  
>      address_space_write(as, dpa_offset, MEMTXATTRS_UNSPECIFIED, &data, 64);
>      return true;
> @@ -1711,6 +1921,14 @@ static void qmp_cxl_process_dynamic_capacity_event(const char *path, CxlEventLog
>  		memcpy(&dCap.dynamic_capacity_extent, &extents[i]
>  				, sizeof(CXLDCExtent_raw));
>  
> +		if (dCap.type == 0x0)

Enum values as suggested in earlier patch.

> +			set_region_block_backed(dcd, extents[i].start_dpa, extents[i].len);
> +		else if (dCap.type == 0x1)
> +			clear_region_block_backed(dcd, extents[i].start_dpa,
> +					extents[i].len);
> +		else
> +			error_setg(errp, "DC event not support yet, no bitmap op");
> +
>  		if (cxl_event_insert(cxlds, CXL_EVENT_TYPE_DYNAMIC_CAP,
>  					(CXLEventRecordRaw *)&dCap)) {
>  			;
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index c0c8fcc24b..d9b6776e2c 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -211,7 +211,7 @@ typedef struct cxl_device_state {
>      } timestamp;
>  
>      /* memory region size, HDM */
> -    uint64_t mem_size;
> +	uint64_t static_mem_size;
>      uint64_t pmem_size;
>      uint64_t vmem_size;
>  
> @@ -412,6 +412,7 @@ typedef struct CXLDCD_Region {
>  	uint64_t block_size;
>  	uint32_t dsmadhandle;
>  	uint8_t flags;
> +	unsigned long *blk_bitmap;
>  } CXLDCD_Region;
>  
>  struct CXLType3Dev {
> @@ -447,12 +448,17 @@ struct CXLType3Dev {
>      uint64_t poison_list_overflow_ts;
>  
>  	struct dynamic_capacity {
> +		HostMemoryBackend *host_dc;
> +		AddressSpace host_dc_as;
> +
> +		uint8_t num_hosts; //Table 7-55

Not visible here as far as I can see. So leave it for now.

>  		uint8_t num_regions; // 1-8
>  		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
>  		CXLDCDExtentList extents;
>  
>  		uint32_t total_extent_count;
>  		uint32_t ext_list_gen_seq;
> +		uint64_t total_dynamic_capicity; // 256M aligned
capacity

>  	} dc;
>  };
>  


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 11751C77B7A
	for <linux-cxl@archiver.kernel.org>; Tue, 16 May 2023 14:39:28 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232509AbjEPOj1 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 16 May 2023 10:39:27 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49604 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229664AbjEPOj0 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 16 May 2023 10:39:26 -0400
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 83C53131
        for <linux-cxl@vger.kernel.org>; Tue, 16 May 2023 07:39:23 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1684247963; x=1715783963;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=nWu3Ox8VOdN3RmYdX+3yl69Ipyh4ZSTmT9UuTFd98rA=;
  b=MWR33z4zZi2dGhj/TGHrOtCxaFO1pzSTkBbBCWPjB7551ZW1Pc+bDr2r
   HefkvzTSuBaDYYHu1mnl0bXTqpkrU7MYAAl+98A3LK6MUJH1Ef+L77uCn
   Ig2x7xaBcXAlyyS6XsIteGK//8PFXCo539s8kZAiRybd6COPLf8jm95aI
   37u29CYYufN3OY1zmvjaR2hWrBD1hXVFrHUXsnGuO50H98eie9YPx5tgY
   8cWvPme/H/2+9+1MhS4fVD9XZkFKht6opBBXiasObYzH2fhmFsbW/nkc8
   YbJCYjaTTdUSir3cNkTGhAzYXDhePf2niq//rKbBl+ljoVDdleZGXqlXz
   Q==;
X-IronPort-AV: E=McAfee;i="6600,9927,10711"; a="331111299"
X-IronPort-AV: E=Sophos;i="5.99,278,1677571200"; 
   d="scan'208";a="331111299"
Received: from orsmga005.jf.intel.com ([10.7.209.41])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 16 May 2023 07:39:23 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6600,9927,10711"; a="875646341"
X-IronPort-AV: E=Sophos;i="5.99,278,1677571200"; 
   d="scan'208";a="875646341"
Received: from fmsmsx603.amr.corp.intel.com ([10.18.126.83])
  by orsmga005.jf.intel.com with ESMTP; 16 May 2023 07:39:22 -0700
Received: from fmsmsx612.amr.corp.intel.com (10.18.126.92) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Tue, 16 May 2023 07:39:21 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx612.amr.corp.intel.com (10.18.126.92) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Tue, 16 May 2023 07:39:21 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23 via Frontend Transport; Tue, 16 May 2023 07:39:21 -0700
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (104.47.70.105)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.23; Tue, 16 May 2023 07:39:20 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ehYw0HEd9AkzfjRe4RCHG6pWXhlf3uP19VipyObpjwKCXfcM5Nj/gIwWVeJ5f9cE+wxlF/rctdaTTRzqUWxuER31ZPgGd11CA6SVVhn7Fh7Hn44OszllX7R2UegjyPVFvc5rISg0KE+/29C8CEnstkGAPFmBYynQmTKcChhaOWpgQsFdLxTWlPiWt5akH7aeu9lJcgXpVBRvla6saPX4TsWbQOhLmv4y7x68xhBCeykRWYc57DFBbO9+VMMMC63/DZuhbMC2MX0QUvdlsdsGXKIeKhfzech7JeQBnbxmClf6TpB5ZclHinvP5RE/dtVqb1Hh1mHBK4r6njOlnnAxBQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=4evhmvRKrkE968Q3ujCgpI3pWJ6mbAAwbpDojMb+RQc=;
 b=bI/aUNwHV8di+eQ8sMkzqgDuG/yg+S59YUn4l5gv52NXnAaoo8bf0avUcTUAFNAntd2F2nTbOB0L+JfCXp1PKZpdKbMDlLOAHU4blTmlgvn23Q0u2Q7dlFMtK3+CdjvmO5dnaZPSQzDMPemJQ9wldijct+BIZOGj9N8RXzFkX1x1SMyle98QbuqNNWrK/HObHK6/US8bqAVR6HnpsRYfeDfC2sG9H3EKycKGIXZWi3McZW5RQx4TaqL3Ga6s8Xw1k9YeAWPsVzxUt3ZMiXGPh/596H2CKFefinGFm7h61N1mQ6r4QQsM3Sju/cImLkp/ciY7K+hqbA2Q8M1K2feqvw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from BN9PR11MB5322.namprd11.prod.outlook.com (2603:10b6:408:137::18)
 by DM4PR11MB5309.namprd11.prod.outlook.com (2603:10b6:5:390::5) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6387.30; Tue, 16 May
 2023 14:39:16 +0000
Received: from BN9PR11MB5322.namprd11.prod.outlook.com
 ([fe80::f598:71b7:8869:2eae]) by BN9PR11MB5322.namprd11.prod.outlook.com
 ([fe80::f598:71b7:8869:2eae%5]) with mapi id 15.20.6387.033; Tue, 16 May 2023
 14:39:16 +0000
From: "Singh, Navneet" <navneet.singh@intel.com>
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        Fan Ni <fan.ni@samsung.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "Browy, Christopher" <cbrowy@avery-design.com>,
        "Weiny, Ira" <ira.weiny@intel.com>,
        "Williams, Dan J" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: RE: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK9bUhcAgAGsJJA=
Date: Tue, 16 May 2023 14:39:16 +0000
Message-ID: <BN9PR11MB5322075F544ED276667F0C1FF9799@BN9PR11MB5322.namprd11.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
 <20230515140036.00003301@Huawei.com>
In-Reply-To: <20230515140036.00003301@Huawei.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: BN9PR11MB5322:EE_|DM4PR11MB5309:EE_
x-ms-office365-filtering-correlation-id: b354db51-7a16-4642-19b2-08db561b534a
x-ld-processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: s0/ltCdB1viySH6sinvpUTuTgktcbtJetAl1aPRAly+IusEoc7RlCPBaXQrpuRrI/OcMda+1DZRgZj2w5ucrQNy5Aa+Rwv18yU02Iwskp98JQ4XIAXHvWPFkXhYYRkPlXQ5kAQu7HEgjMdG58iMvNMUxKagjEI9Ct6nLGFeFtZJZpo4wvzoCi8sWbZq0V96/AXSf5p30Jtdtuh0rejMDyAK7BcNEWXFCip3nR5a8lNIH+PxfQVcexHQB4RI4fMrMmEswTCd05DtHxtc2DrrGTCM8nwTacICfRvUSitHInuz4ac2uVW1Cyl/OhvCD9CHmoayOoVJr3PASQ8wg3162WeycpL0afcSs6Um643DQWUmDlC+rIZL7YmeJZOTgCcclChwb7EDGk8TMj2wesqm8eGavjtZhkumHblfv8H1AzOq1cfCDrNNHj0MasnZIfalXfkB3sFxPQ1DE2NevDkjfgGX1RJXTD405V/sB7hZtYiTfpKoorTLsIF+Lg2gqcgBpwEnh8bd4cPY6qeHyJyjK7zn8sKuYsbZsMH0RnpIoM6lY08pAVqXCgiuxOYokVx7gePkHhH8Jmt52Cb3l8EalLc/TFf0NX1pp80C1/dYhrDQ0yK1WBXRQ7aou8WWxMSPDD9xPymkzGDnUzK2t1UglPw==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN9PR11MB5322.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(366004)(136003)(39860400002)(376002)(396003)(346002)(451199021)(33656002)(64756008)(54906003)(45080400002)(110136005)(316002)(478600001)(66476007)(66946007)(66556008)(966005)(4326008)(66446008)(86362001)(7696005)(76116006)(55016003)(5660300002)(8676002)(52536014)(7416002)(8936002)(82960400001)(2906002)(122000001)(38070700005)(41300700001)(38100700002)(26005)(186003)(53546011)(9686003)(6506007)(55236004)(83380400001)(71200400001);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?us-ascii?Q?uKQwfzNTXNslZu4QgydbsmYtKGSUmgLIygM8LXB+RDEumH2lTLNxrt2D6gih?=
 =?us-ascii?Q?BO39pCUx2Qj1ANG7dwTFo7HktAyWoXbR3Kckn+4hDr00TF0M3sOgW+a3FG/r?=
 =?us-ascii?Q?0Ht82PQDNZex26R9TEg7QBmMxr8fXL0GXcxM+ys9rswAJZo3DIzm1Jv6Uozi?=
 =?us-ascii?Q?gKr3MKlBn3bLb8C3fTNIIqCg7KF4AbFaf/bVnweYeVZ12U6XwGpY2gTq/wN2?=
 =?us-ascii?Q?NqmrAwBJvz+PYpjjUiXuJdxcqcZzuOm0E0c/SngS3GfwBQD7ijf+bBdaSJ2o?=
 =?us-ascii?Q?Zl/4EtfKRMIoxYZclIvdNC7ywqMtpKUxbgdAiKTD4Gj+9bXTcqKWlqlHcbVU?=
 =?us-ascii?Q?EKn0I4QDH1z/GAuHM2Rva7Gn1JepevqYTAoo+KEUOfjbi0pzT5xHoKzctZLD?=
 =?us-ascii?Q?DF/HXO2VV0vm5yRSzUJlP+KpY9kEPb48S/7E0DFkWamrQ4eS+HCuCAmlujQ6?=
 =?us-ascii?Q?MvspRdN516F60ajRQoad4kWk0RvOvPscbbH+wUHjJA4daHMNQnqkUJEqnbRK?=
 =?us-ascii?Q?0p8tZZzpOv6gVwUaY/MUgOYPWXLWYNvZooC57V7ZAZ/RRP009NMVKib0ZYWF?=
 =?us-ascii?Q?oZgmMzIeem+bVMx7LxHff15EyylI2VoO3myaX6IIWTkecVViQbklOoPlVmum?=
 =?us-ascii?Q?7HnriQM03xCOlKl8gGK17MFvbQjAxmEhA6Q9698vwLAUmWdnAOP7z/JwEtuq?=
 =?us-ascii?Q?JND/BRDUT/LMHcCIsoFkJBOicfQ0MbCYgD7yrGyx3HQiERLHUzQPAlYVEFXe?=
 =?us-ascii?Q?uPr+LKIX/SIhOpYYmwGFqLXNlFbrwIXjdRgsHXaH3B4s0uBe+HKovaD/+ptP?=
 =?us-ascii?Q?NU0hOs42CJ8RmNrQYYcmwb8TWMn/2YX3nosEgnZZb+J8KZV+9CpkeusLuq0T?=
 =?us-ascii?Q?dhhWLMrygSffyFAG2X3MgilrFbrRYF+tKeeHiEUH/lEiNlnkfVGFSJ6xuyvu?=
 =?us-ascii?Q?OJHKKfCb3kUJR+51lslHe35YkTjsZjavT7a3zzLe0QresvDKqf7O8XfvH+hw?=
 =?us-ascii?Q?dz7WQdD5WiQOqtKdEpC1BiM3eKppFIU8RS3bzghKMo4zfXCHz4qt/MbO+tlk?=
 =?us-ascii?Q?gVTy6akgAFfGJIdvYZ58aLORjnu2q3J/mBYG2tvee6uquVE9OIOhGw7qmUQe?=
 =?us-ascii?Q?XivtNh3liGs3qXfSHdmTo00v+Kv9zaiYMU6b0huvt/LWdyl1E3rSbsI02J6Y?=
 =?us-ascii?Q?xWJA/N6yJaGNbvB7OVtv+8j2sbE7br993QFekQACP+sNfoZ06EPk1yo2n+gk?=
 =?us-ascii?Q?edKDyq8lQ2Z2/hekt/LnTcgNTueBJkR6h74LHA+NLbaer2K8Tl4WKz4ibzOT?=
 =?us-ascii?Q?L/dKqNS2YQjofDJZafGQiIzgz5NYb8FxJP1wR+iatlkKhF3MEDnqi3XV6zOL?=
 =?us-ascii?Q?1JBgoZ576DoEMCn5YD1AliC2WUM5Sxbhr1vOhyQKAoAAYQ3xoaiMpzfk6RKt?=
 =?us-ascii?Q?g8Jc1w8ow2PfNp/7Fgau5mt+46+/uDV7fHJBV93nVCOkKeWeqzVYcqZCi98F?=
 =?us-ascii?Q?LWcgMiaQw5g2v+kmdIbYn6/FIOpRBEyxgp1tE/UH51/ojuy4DGcGycpKqaRC?=
 =?us-ascii?Q?k72YXZBTlDdkNCprLBGzkGRpzMDWUKL69pIzgrR7?=
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: BN9PR11MB5322.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b354db51-7a16-4642-19b2-08db561b534a
X-MS-Exchange-CrossTenant-originalarrivaltime: 16 May 2023 14:39:16.4449
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: eGZy/HURcDQwMsOPiz6skV2ILILB3cioqxDli+nD+8UR+tcW4OJab3W34DcChtASbBSzGq4vg8pB1QRosqlm+w==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR11MB5309
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Content-Length: 11012
Lines: 288



-----Original Message-----
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>=20
Sent: Monday, May 15, 2023 6:31 PM
To: Fan Ni <fan.ni@samsung.com>
Cc: qemu-devel@nongnu.org; linux-cxl@vger.kernel.org; gregory.price@memverg=
e.com; hchkuo@avery-design.com.tw; Browy, Christopher <cbrowy@avery-design.=
com>; Weiny, Ira <ira.weiny@intel.com>; Williams, Dan J <dan.j.williams@int=
el.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net; nmt=
adam.samsung@gmail.com; nifan@outlook.com; Singh, Navneet <navneet.singh@in=
tel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu

On Thu, 11 May 2023 17:56:40 +0000
Fan Ni <fan.ni@samsung.com> wrote:

> Since the early draft of DCD support in kernel is out=20
> (https://lore.kernel.org/linux-cxl/20230417164126.GA1904906@bgt-140510
> -bm03/T/#t), this patch series provide dcd emulation in qemu so people=20
> who are interested can have an early try. It is noted that the patch=20
> series may need to be updated accordingly if the kernel side=20
> implementation changes.
>=20
> To support DCD emulation, the patch series add DCD related mailbox=20
> command support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3=20
> memory device with dynamic capacity extent and region representative.
> To support read/write to the dynamic capacity of the device, a host=20
> backend is provided and necessary check mechnism is added to ensure=20
> the dynamic capacity accessed is backed with active dc extents.
> Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not=20
> supported , but we add two qmp interfaces for adding/releasing dynamic ca=
pacity extents.
> Also, the support for multiple hosts sharing the same DCD case is missing=
.
>=20
> Things we can try with the patch series together with kernel dcd code:
> 1. Create DC regions to cover the address range of the dynamic=20
> capacity regions.
> 2. Add/release dynamic capacity extents to the device and notify the=20
> kernel.
> 3. Test kernel side code to accept added dc extents and create dax=20
> devices, and release dc extents and notify the device 4. Online the=20
> memory range backed with dc extents and let application use them.
>=20
> The patch series is based on Jonathan's local qemu branch:
> https://gitlab.com/jic23/qemu/-/tree/cxl-2023-02-28
>=20
> Simple tests peformed with the patch series:
> 1 Install cxl modules:
>=20
> modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
>=20
> 2 Create dc regions:
>=20
> region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> echo 0x10000000 > /sys/bus/cxl/devices/$region/size echo  "decoder2.0"=20
> > /sys/bus/cxl/devices/$region/target0
> echo 1 > /sys/bus/cxl/devices/$region/commit
> echo $region > /sys/bus/cxl/drivers/cxl_region/bind
>=20
> /home/fan/cxl/tools-and-scripts# cxl list [
>   {
>     "memdevs":[
>       {
>         "memdev":"mem0",
>         "pmem_size":536870912,
>         "ram_size":0,
>         "serial":0,
>         "host":"0000:0d:00.0"
>       }
>     ]
>   },
>   {
>     "regions":[
>       {
>         "region":"region0",
>         "resource":45365592064,
>         "size":268435456,
>         "interleave_ways":1,
>         "interleave_granularity":256,
>         "decode_state":"commit"
>       }
>     ]
>   }
> ]
>=20
> 3 Add two dc extents (128MB each) through qmp interface
>=20
> { "execute": "qmp_capabilities" }
>=20
> { "execute": "cxl-add-dynamic-capacity-event",
> 	"arguments": {
> 		 "path": "/machine/peripheral/cxl-pmem0",
> 		"region-id" : 0,
> 		 "num-extent": 2,
> 		"dpa":0,
> 		"extent-len": 128
> 	}
> }
>=20
> /home/fan/cxl/tools-and-scripts# lsmem
> RANGE                                  SIZE   STATE REMOVABLE   BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes    0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes   32-79
> 0x0000000a90000000-0x0000000a9fffffff  256M offline           338-339
>=20
> Memory block size:       128M
> Total online memory:       8G
> Total offline memory:    256M
>=20
>=20
> 4.Online the momory with 'daxctl online-memory dax0.0' to online the=20
> memory
>=20
> /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0 [ =20
> 230.730553] Fallback order for Node 0: 0 1 [  230.730825] Fallback=20
> order for Node 1: 1 0 [  230.730953] Built 2 zonelists, mobility=20
> grouping on.  Total pages: 2042541 [  230.731110] Policy zone: Normal=20
> onlined memory for 1 device
>=20
> root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> RANGE                                  SIZE   STATE REMOVABLE BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes  0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes 32-79
> 0x0000000a90000000-0x0000000a97ffffff  128M  online       yes   338
> 0x0000000a98000000-0x0000000a9fffffff  128M offline             339
>=20
> Memory block size:       128M
> Total online memory:     8.1G
> Total offline memory:    128M
>=20
> 5 using dc extents as regular memory
>=20
> /home/fan/cxl/ndctl# numactl --membind=3D1 ls
> CONTRIBUTING.md  README.md  clean_config.sh  cscope.out   git-version-gen
> ndctl	       scripts	test.h      version.h.in COPYING		 acpi.h
> config.h.meson   cxl	  make-git-snapshot.sh	ndctl.spec.in  sles	tools
> Documentation	 build	    contrib	     daxctl	  meson.build		rhel
> tags	topology.png LICENSES	 ccan	    cscope.files
> git-version  meson_options.txt	rpmbuild.sh    test	util
>=20
>=20
> QEMU command line cxl configuration:
>=20
> RP1=3D"-object=20
> memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=3D/tmp/cxltest.raw,=
siz
> e=3D512M \ -object=20
> memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/cxltest2.raw=
,si
> ze=3D512M \ -object=20
> memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/lsa.raw,size=
=3D51
> 2M \ -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \ -device=20
> cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=3D2 \ -devi=
ce=20
> cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,dc-memdev=3D=
cxl-m
> em2,id=3Dcxl-pmem0,num-dc-regions=3D1\
> -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleave-g=
ranularity=3D8k"
>=20
>=20
> Kernel DCD support used to test the changes
>=20
> The code is tested with the posted kernel dcd support:
> https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=3Dfor
> -6.5/dcd-preview
>=20

Very nice!  +CC Navneet who may want to comment on the below (and the emula=
tion as well)

I've not had a chance to look at the code on the kernel side yet.


> commit: f425bc34c600e2a3721d6560202962ec41622815
>=20
> To make the test work, we have made the following changes to the above ke=
rnel commit:
>=20
> diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c index=20
> 5f04bbc18af5..5f421d3c5cef 100644
> --- a/drivers/cxl/core/mbox.c
> +++ b/drivers/cxl/core/mbox.c
> @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_MEM_=
COMMAND_ID_MAX] =3D {
>  	CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
>  	CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
>  	CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
> +	CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
>  };
> =20
>  /*
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c=20
> index 291c716abd49..ae10e3cf43a1 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *cx=
lr)
>  		}
>  		cxlds->dc_list_gen_num =3D extent_gen_num;
>  		dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
> -		enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
> +		/*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/

Some race condition that means we need to enable the DCD event earlier?
Navneet - I have been working on the DCD feature last few weeks and this ha=
s been removed and will be handled like other Events.
>  	}
>  	return 0;
>  err:
> @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds, =
struct resource *alloc_dpa_re
>  				dev_dax->align, memremap_compat_align()))) {
>  		rc =3D alloc_dev_dax_range(dev_dax, hpa,
>  					resource_size(alloc_dpa_res));
> -		return rc;
> +		if (rc)
> +			return rc;

No idea on this one as it's in the code I haven't looked at yet!
Navneet - This is also fixed , in last moment changes this bug got introduc=
ed.

>  	}
> =20
>  	rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);=20
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c index=20
> 9e45b1056022..653bec203838 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state=20
> *cxlds)
> =20
>  	/* Driver enables DCD interrupt after creating the dc cxl_region */
>  	rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYPE_=
DCD,
> -					IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
> +					IRQF_SHARED | IRQF_ONESHOT);

This will be otherside of the removal of the enable above.

>  	if (rc) {
>  		dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
>  		return rc;
> diff --git a/include/uapi/linux/cxl_mem.h=20
> b/include/uapi/linux/cxl_mem.h index 6ca85861750c..910a48259239 100644
> --- a/include/uapi/linux/cxl_mem.h
> +++ b/include/uapi/linux/cxl_mem.h
> @@ -47,6 +47,7 @@
>  	___C(SCAN_MEDIA, "Scan Media"),                                   \
>  	___C(GET_SCAN_MEDIA, "Get Scan Media Results"),                   \
>  	___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"),         \
> +	___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),         \
>  	___C(MAX, "invalid / last command")
> =20
>  #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
>=20
>=20
>=20
> Fan Ni (7):
>   hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
>     payload of identify memory device command
>   hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
>     and mailbox command support
>   hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
>     device supports in qemu command line
>   hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
>   hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
>     dynamic capacity response
>   Add qmp interfaces to add/release dynamic capacity extents
>   hw/mem/cxl_type3: add read/write support to dynamic capacity
>=20
>  hw/cxl/cxl-mailbox-utils.c  | 389 +++++++++++++++++++++++++++-
>  hw/mem/cxl_type3.c          | 492 +++++++++++++++++++++++++++++++-----
>  include/hw/cxl/cxl_device.h |  50 +++-  include/hw/cxl/cxl_events.h | =20
> 16 ++
>  qapi/cxl.json               |  44 ++++
>  5 files changed, 924 insertions(+), 67 deletions(-)
>=20


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 186EBC7EE23
	for <linux-cxl@archiver.kernel.org>; Mon,  5 Jun 2023 17:36:11 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229960AbjFERgK (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 5 Jun 2023 13:36:10 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51506 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229834AbjFERgI (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 5 Jun 2023 13:36:08 -0400
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2090F91
        for <linux-cxl@vger.kernel.org>; Mon,  5 Jun 2023 10:36:06 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1685986566; x=1717522566;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=L/rGtwjCSmKK6qOUsU8ii93FJgmh+N3lLBhCdgBy9BI=;
  b=Rvw1XEYOTGDXyRg9I8S3quGFeprUh128HLantS67frHKzZ1J81/iWwsm
   hEOZc6dM3Wy2OS5YNwqKnihKa6h1BYJu5ymzp438G7o/YbuvIYHlRHC06
   /iVodOCxdaDKpwfHcQOGmn60qwdiidbfSnbYbv/oXY3BQ2e5IRtNoRAbF
   1v/FXT6/ByiEBwE94zDJBj41ZB8Ecf5Zy1EAgvr+4hka2qJXULVMpUhBZ
   qTDwZwiWkMxEjNFMG1iVDEDwuEL7f3Cb3ErJgWm5++2jJ49RgphV8uCCr
   5NGCPcSmp6bNr/JRvbOoDN6bwFHbW0RNU89ko7bGyVIFCmbCk5X2gxPpD
   w==;
X-IronPort-AV: E=McAfee;i="6600,9927,10732"; a="384739601"
X-IronPort-AV: E=Sophos;i="6.00,218,1681196400"; 
   d="scan'208";a="384739601"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 05 Jun 2023 10:36:02 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6600,9927,10732"; a="778646934"
X-IronPort-AV: E=Sophos;i="6.00,218,1681196400"; 
   d="scan'208";a="778646934"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by fmsmga004.fm.intel.com with ESMTP; 05 Jun 2023 10:36:02 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Mon, 5 Jun 2023 10:36:01 -0700
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Mon, 5 Jun 2023 10:36:01 -0700
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23 via Frontend Transport; Mon, 5 Jun 2023 10:36:01 -0700
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.168)
 by edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.23; Mon, 5 Jun 2023 10:36:00 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ese0mUrSIAb39DSmA7zR4DNSz3RWzwPQJ2FeVhBgMrRMeJohe2F/a+1BU0AE2Rm07aRE5r/QNyacccmd26VaWvfSsH3A1U9nCHLGl5hZi2NeFcBM85/BFi8rxBZ7WwaFK9GAiIaIvc3yC9xoB9eBuOriN0rvWnj91cTbJajbNuIlfqCp71J5WJcBztEgtTjzZZSZ6WV4yQVh5rCigQlhhJx6m2BsYuFVF/AenxssMHCLGYncIiv7bFrEFiliqBYUNw4x0O3lbOMa3v/Vs2bFoRdgVZyUhUUEW4pg9yRcjZA87AOWDuONAF2ER6xJXMCKckHk1qidKFYoMkUiYgheDg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=GwI8b0c6pwlLUYguo8qR6461pDxkkXvRys7okam9GKY=;
 b=MoQGiJHOgmkUQyLs9eqt0BMLtENNsxSjP6u9V9iVht8bNRGORs69xvnWT+VxUgYhtMOKbEOPT3/G8CpSwvGSjilbnjtWF/JvUZdFJg3mH1+XNE0wuxJURTvoRtj3EQ7CBFi7nTehZzDal85Ci6n6kHOQquP7V6PJxiQhpKoglfAWG7veOrDSG3uEUFiGs8NQN785rx53jXHTxLLhvIXt5eUv7d9RZLHGD2TtM275oj6fnCBfC331fg2bCP7rGo1j6mpZzKCE5aNGIeIcYCB5nTeEFQv/2b0NJIhdDB3/+HSAvD/ZMJwSpCgkiR/dV70rU5VDePbLHw6rETTToi/42A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by SN7PR11MB6773.namprd11.prod.outlook.com (2603:10b6:806:266::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Mon, 5 Jun
 2023 17:35:57 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::9679:34f7:f1b:1e7c]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::9679:34f7:f1b:1e7c%6]) with mapi id 15.20.6455.030; Mon, 5 Jun 2023
 17:35:57 +0000
Date: Mon, 5 Jun 2023 10:35:48 -0700
From: Ira Weiny <ira.weiny@intel.com>
To: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
 <20230511175609.2091136-1-fan.ni@samsung.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
X-ClientProxiedBy: BYAPR07CA0090.namprd07.prod.outlook.com
 (2603:10b6:a03:12b::31) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|SN7PR11MB6773:EE_
X-MS-Office365-Filtering-Correlation-Id: aa06ab74-cd45-4841-7ff1-08db65eb51ca
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 6L/RwLtIetu3XxF8zRbYi+rdGaYecGXIwC/7rIznpUaty1iTdeAQZUD4Hp+o0NnNBWWREy8Pl7GQNNz+bDPk1ioEfwHdveheOwimitF0sSPtx2WA0HcbpYL2WAk2mJxiHv07O9uj5xV0JenTOQo+sm1l0j1q4ZdBEReJvvJ8ExI05HKAj3yTWhOVdEX7r7z/hWaWdyElYRHlmgPNDpR6Gv4p3SBarOwJeLO5s0xbFwYA5WEixKkuup55UDrhAQg/rIRaiA2SWT12d6xto4TcJgMlBHnICeUEYamAO61Qu09qSlXWg1G2p2PEyVmgXL6tskNHjHl73z3io3hebKGtZjMZgmvWAsA1hAxc+ApOzD2hVqfLfhC9c5eRP4lIETV1u/fxG6IZYADIjeyo5ic5kgKVlcUtfP5SScjAER3BA+VL0Uo2GQg5nKoYRAiuRdDVQgOuxyHi7f5/N6VSmtkmQ8+ALEzd6SsxL1jRTUgxCSZnSd95BbuPiT6PREYUPGiAllG0PBq0XgOkMDaWewqbbntN/oPQYodvfaz/oOgRWpc=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(366004)(39860400002)(136003)(396003)(346002)(376002)(451199021)(83380400001)(38100700002)(86362001)(82960400001)(478600001)(110136005)(41300700001)(6666004)(6486002)(966005)(54906003)(8936002)(5660300002)(8676002)(44832011)(7416002)(66476007)(66556008)(66946007)(4326008)(2906002)(316002)(26005)(6512007)(6506007)(9686003)(186003);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?NUoJ3//VIjf3dfcw7JsPi2Sb21BvEXU8LoKv7KklFs+cZvI7VxzKwi10T8Zf?=
 =?us-ascii?Q?XFzVjQW/EBSFTBCsvKKAhatlhBJpdjF0I/TpRvX8CFeINcvF0h6F9r3gPF9w?=
 =?us-ascii?Q?vwpTxgXXnMnExAtWUSIoYJJnD3hwH1BDnXmqqk/LNCDmyIS4PK8Tcbumhjx2?=
 =?us-ascii?Q?IEHuQtveJWrFWVi3s4FqlxboWzHz99evgvwajoldMACvhlGm2PaEYpUZqeug?=
 =?us-ascii?Q?UyLCiZeU3qYn7R5VVdn1Lzxz+JY/9T2REuVhb+iCFSd6Dn5nZ/3SfT8wGvvt?=
 =?us-ascii?Q?cgjonB7kUIgiE7Nvt7S+RuypctViEmMqyQYdIYjIk6AKj9mcEIBJ+brrsqhd?=
 =?us-ascii?Q?MA79q9Kjypn+/GuMDyEACNrKxJEVlVP42tAJIV13LhEvgpy/UBClk+QFCcCL?=
 =?us-ascii?Q?hkQvaV3jCKkJHyARbCIiWq0JBfgEiqGYNkk2ajGpYArAiU1JurfXzHZC5i6b?=
 =?us-ascii?Q?1nB8nN3qZMwMYnr4ZcDqGlqOgYZZwXZWHf121lwaycPP4rDhSLhAqt8oOjiM?=
 =?us-ascii?Q?Wm0M8wBTyTepoh2XBlbArKJmX4auFIIO9mnNVgUPl1ZS3H3AnUgQ95qnvt/U?=
 =?us-ascii?Q?gkvTVHC9oF5vaSfLYw0g/nPZeBlxavdlxI8wr894RsXF/X9QYh2QkyvR/wL1?=
 =?us-ascii?Q?HsE8Xy832JQDTLEGjwpgSJenAZquH13wYxbcJC/IkPguELArIq0HxkfmxX0V?=
 =?us-ascii?Q?imZboPpj9vlkjSyViQ8cHXvLIIGPAlGoj+5ouYJMN7/19nSZ65PYC+7eiGQ9?=
 =?us-ascii?Q?eHecrSHFq0yjii6j86wtSka259g/Y4rWzIFLQj3p8KmCPLiV3jENjxdwswTz?=
 =?us-ascii?Q?TFGLY9fjbIM+KDcIrWHxqZyutLKpN9W9oK6lqWfWllTjDSNyUU5lQuurT6wv?=
 =?us-ascii?Q?5i9RMRgEgjU8ymZiJDFHNNWxz3x9cdqOE02NQmHC2Sz8NH8xWCmNhI1RbRAQ?=
 =?us-ascii?Q?67gEreCTlxgpxLPYZHtpCqBCiyPxn3XBHSZVbsYzrKeqvWvQPWc8DcpRoKz+?=
 =?us-ascii?Q?GxlsVAaOx9bcy4JCk0jv+7zxMVyBJEdY9GEKd/wYoWAe8E/e3ryh3y+i4MI7?=
 =?us-ascii?Q?7hNTFBQR4LG/1JkwIyVLS+6LO8PIkv3aUZ0Vw51dQzGxiQOyfHc63CQ5zjhN?=
 =?us-ascii?Q?9GhpNLXVTWVRf6TSRGPiEV3R1Vc0aH8UOPaxydAYFASHET5iJhy6QA8XcAgr?=
 =?us-ascii?Q?nM1rGnbHmNxi2X3VIMRJJkihPqZ8tO/9oRQVVqpyG8dzV0wNXe94gSH+bGpZ?=
 =?us-ascii?Q?EcVESJMrg46jq+gn21WVBNy3L7sNdKCT8korPZfOkzwHzHBmL1oH2zrzx3br?=
 =?us-ascii?Q?lUeALgvpzAmbjFKufLSvfbUbe50LyYKHup71TEi1c9oqrnUgw4dm6MH3UX0p?=
 =?us-ascii?Q?VP3LVwtl+yLS8+dwNq2GYjEpCNwAzMSB2pk8JU3hQhYC1Lin43c8zXEAzBC/?=
 =?us-ascii?Q?9SJsqvmhYbxS3T6K09+wWnNCyzISbguNnuykcMvy+befCqpSeFZFzD3hqPXb?=
 =?us-ascii?Q?pgO+jxdCnbh+6R8EpkMAUPm4+aHM+ftNfemxPgFmkA6W8NRulVmOfiRNE5k3?=
 =?us-ascii?Q?Ef/jXmEHDTIgyLNjgbtnhIWrcGVgNsr4SnqH0pkF?=
X-MS-Exchange-CrossTenant-Network-Message-Id: aa06ab74-cd45-4841-7ff1-08db65eb51ca
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 05 Jun 2023 17:35:57.1308
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: ei9QzqQ2fz2RaXxRcjg5UYl5kWrK9xaDNDY+c5hQ+ueWmFPW0gWX9ueKpz9tPaTATxVMBnreDxrfPdeLL3FCyQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN7PR11MB6773
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 9621
Lines: 247

Fan Ni wrote:
> Since the early draft of DCD support in kernel is out
> (https://lore.kernel.org/linux-cxl/20230417164126.GA1904906@bgt-140510-bm03/T/#t),
> this patch series provide dcd emulation in qemu so people who are interested
> can have an early try. It is noted that the patch series may need to be updated
> accordingly if the kernel side implementation changes.

Fan,

Do you have a git tree we can pull this from which is updated to a more
recent CXL branch from Jonathan?

Thanks,
Ira

> 
> To support DCD emulation, the patch series add DCD related mailbox command
> support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory device
> with dynamic capacity extent and region representative.
> To support read/write to the dynamic capacity of the device, a host backend
> is provided and necessary check mechnism is added to ensure the dynamic
> capacity accessed is backed with active dc extents.
> Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not supported
> , but we add two qmp interfaces for adding/releasing dynamic capacity extents.
> Also, the support for multiple hosts sharing the same DCD case is missing.
> 
> Things we can try with the patch series together with kernel dcd code:
> 1. Create DC regions to cover the address range of the dynamic capacity
> regions.
> 2. Add/release dynamic capacity extents to the device and notify the
> kernel.
> 3. Test kernel side code to accept added dc extents and create dax devices,
> and release dc extents and notify the device
> 4. Online the memory range backed with dc extents and let application use
> them.
> 
> The patch series is based on Jonathan's local qemu branch:
> https://gitlab.com/jic23/qemu/-/tree/cxl-2023-02-28
> 
> Simple tests peformed with the patch series:
> 1 Install cxl modules:
> 
> modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
> 
> 2 Create dc regions:
> 
> region=$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> echo 0x10000000 > /sys/bus/cxl/devices/$region/size
> echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> echo 1 > /sys/bus/cxl/devices/$region/commit
> echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> 
> /home/fan/cxl/tools-and-scripts# cxl list
> [
>   {
>     "memdevs":[
>       {
>         "memdev":"mem0",
>         "pmem_size":536870912,
>         "ram_size":0,
>         "serial":0,
>         "host":"0000:0d:00.0"
>       }
>     ]
>   },
>   {
>     "regions":[
>       {
>         "region":"region0",
>         "resource":45365592064,
>         "size":268435456,
>         "interleave_ways":1,
>         "interleave_granularity":256,
>         "decode_state":"commit"
>       }
>     ]
>   }
> ]
> 
> 3 Add two dc extents (128MB each) through qmp interface
> 
> { "execute": "qmp_capabilities" }
> 
> { "execute": "cxl-add-dynamic-capacity-event",
> 	"arguments": {
> 		 "path": "/machine/peripheral/cxl-pmem0",
> 		"region-id" : 0,
> 		 "num-extent": 2,
> 		"dpa":0,
> 		"extent-len": 128
> 	}
> }
> 
> /home/fan/cxl/tools-and-scripts# lsmem
> RANGE                                  SIZE   STATE REMOVABLE   BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes    0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes   32-79
> 0x0000000a90000000-0x0000000a9fffffff  256M offline           338-339
> 
> Memory block size:       128M
> Total online memory:       8G
> Total offline memory:    256M
> 
> 
> 4.Online the momory with 'daxctl online-memory dax0.0' to online the memory
> 
> /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
> [  230.730553] Fallback order for Node 0: 0 1
> [  230.730825] Fallback order for Node 1: 1 0
> [  230.730953] Built 2 zonelists, mobility grouping on.  Total pages: 2042541
> [  230.731110] Policy zone: Normal
> onlined memory for 1 device
> 
> root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> RANGE                                  SIZE   STATE REMOVABLE BLOCK
> 0x0000000000000000-0x000000007fffffff    2G  online       yes  0-15
> 0x0000000100000000-0x000000027fffffff    6G  online       yes 32-79
> 0x0000000a90000000-0x0000000a97ffffff  128M  online       yes   338
> 0x0000000a98000000-0x0000000a9fffffff  128M offline             339
> 
> Memory block size:       128M
> Total online memory:     8.1G
> Total offline memory:    128M
> 
> 5 using dc extents as regular memory
> 
> /home/fan/cxl/ndctl# numactl --membind=1 ls
> CONTRIBUTING.md  README.md  clean_config.sh  cscope.out   git-version-gen
> ndctl	       scripts	test.h      version.h.in COPYING		 acpi.h
> config.h.meson   cxl	  make-git-snapshot.sh	ndctl.spec.in  sles	tools
> Documentation	 build	    contrib	     daxctl	  meson.build		rhel
> tags	topology.png LICENSES	 ccan	    cscope.files
> git-version  meson_options.txt	rpmbuild.sh    test	util
> 
> 
> QEMU command line cxl configuration:
> 
> RP1="-object memory-backend-file,id=cxl-mem1,share=on,mem-path=/tmp/cxltest.raw,size=512M \
> -object memory-backend-file,id=cxl-mem2,share=on,mem-path=/tmp/cxltest2.raw,size=512M \
> -object memory-backend-file,id=cxl-lsa1,share=on,mem-path=/tmp/lsa.raw,size=512M \
> -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
> -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,dc-memdev=cxl-mem2,id=cxl-pmem0,num-dc-regions=1\
> -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=8k"
> 
> 
> Kernel DCD support used to test the changes
> 
> The code is tested with the posted kernel dcd support:
> https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=for-6.5/dcd-preview
> 
> commit: f425bc34c600e2a3721d6560202962ec41622815
> 
> To make the test work, we have made the following changes to the above kernel commit:
> 
> diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> index 5f04bbc18af5..5f421d3c5cef 100644
> --- a/drivers/cxl/core/mbox.c
> +++ b/drivers/cxl/core/mbox.c
> @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_MEM_COMMAND_ID_MAX] = {
>  	CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
>  	CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
>  	CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
> +	CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
>  };
>  
>  /*
> diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> index 291c716abd49..ae10e3cf43a1 100644
> --- a/drivers/cxl/core/region.c
> +++ b/drivers/cxl/core/region.c
> @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *cxlr)
>  		}
>  		cxlds->dc_list_gen_num = extent_gen_num;
>  		dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
> -		enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
> +		/*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/
>  	}
>  	return 0;
>  err:
> @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds, struct resource *alloc_dpa_re
>  				dev_dax->align, memremap_compat_align()))) {
>  		rc = alloc_dev_dax_range(dev_dax, hpa,
>  					resource_size(alloc_dpa_res));
> -		return rc;
> +		if (rc)
> +			return rc;
>  	}
>  
>  	rc = xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);
> diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> index 9e45b1056022..653bec203838 100644
> --- a/drivers/cxl/pci.c
> +++ b/drivers/cxl/pci.c
> @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state *cxlds)
>  
>  	/* Driver enables DCD interrupt after creating the dc cxl_region */
>  	rc = cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYPE_DCD,
> -					IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
> +					IRQF_SHARED | IRQF_ONESHOT);
>  	if (rc) {
>  		dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
>  		return rc;
> diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.h
> index 6ca85861750c..910a48259239 100644
> --- a/include/uapi/linux/cxl_mem.h
> +++ b/include/uapi/linux/cxl_mem.h
> @@ -47,6 +47,7 @@
>  	___C(SCAN_MEDIA, "Scan Media"),                                   \
>  	___C(GET_SCAN_MEDIA, "Get Scan Media Results"),                   \
>  	___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"),         \
> +	___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),         \
>  	___C(MAX, "invalid / last command")
>  
>  #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
> 
> 
> 
> Fan Ni (7):
>   hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
>     payload of identify memory device command
>   hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
>     and mailbox command support
>   hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
>     device supports in qemu command line
>   hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
>   hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
>     dynamic capacity response
>   Add qmp interfaces to add/release dynamic capacity extents
>   hw/mem/cxl_type3: add read/write support to dynamic capacity
> 
>  hw/cxl/cxl-mailbox-utils.c  | 389 +++++++++++++++++++++++++++-
>  hw/mem/cxl_type3.c          | 492 +++++++++++++++++++++++++++++++-----
>  include/hw/cxl/cxl_device.h |  50 +++-
>  include/hw/cxl/cxl_events.h |  16 ++
>  qapi/cxl.json               |  44 ++++
>  5 files changed, 924 insertions(+), 67 deletions(-)
> 
> -- 
> 2.25.1



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 486F8C7EE24
	for <linux-cxl@archiver.kernel.org>; Mon,  5 Jun 2023 17:51:29 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233775AbjFERv2 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 5 Jun 2023 13:51:28 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:56776 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229559AbjFERv1 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 5 Jun 2023 13:51:27 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B7D96A7
        for <linux-cxl@vger.kernel.org>; Mon,  5 Jun 2023 10:51:23 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230605175121usoutp019a8d87ed9c5cbf548bb87c1df9a03e95~l1K5udd1n0739407394usoutp01G;
        Mon,  5 Jun 2023 17:51:21 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230605175121usoutp019a8d87ed9c5cbf548bb87c1df9a03e95~l1K5udd1n0739407394usoutp01G
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1685987481;
        bh=anqBY59qGQhBDGVKDYJ1tnrIgHvtgPXK8unN9EWispg=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=uuEVHH52S80MrLQ+UVgmRIpOhgr0x6hh8OThRxy1xGQbnHMW4xhQX+SniprlG119C
         J/RNDLXAsHwhK33qXPnGcIeqyy+3SMIO0t5JDIKYYX1t8u0GkWZOfGIJOiNTXZ3VDw
         rm6K0vmAKlCrE4r5p5Z31Dnc1oea8wpmaj34IsAA=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230605175120uscas1p2e0acaa807d13eac2c7ce6077bdc08ced~l1K5h3hcW0175801758uscas1p2Q;
        Mon,  5 Jun 2023 17:51:20 +0000 (GMT)
Received: from uscas1p1.samsung.com ( [182.198.245.206]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id 19.AF.51475.8902E746; Mon, 
        5 Jun 2023 13:51:20 -0400 (EDT)
Received: from ussmgxs1new.samsung.com (u89.gpu85.samsung.co.kr
        [203.254.195.89]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230605175120uscas1p133d49fa845805bda83677dd29cdf7c1e~l1K5Lfyyg2337423374uscas1p1b;
        Mon,  5 Jun 2023 17:51:20 +0000 (GMT)
X-AuditID: cbfec36d-8a3ff7000001c913-7c-647e20989a2d
Received: from SSI-EX4.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs1new.samsung.com (USCPEXMTA) with SMTP id 91.9F.38326.8902E746; Mon, 
        5 Jun 2023 13:51:20 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX4.ssi.samsung.com (105.128.2.229) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Mon, 5 Jun 2023 10:51:19 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Mon,
        5 Jun 2023 10:51:19 -0700
From: Fan Ni <fan.ni@samsung.com>
To: Ira Weiny <ira.weiny@intel.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK99FUkAgAAEUYA=
Date: Mon, 5 Jun 2023 17:51:19 +0000
Message-ID: <20230605175112.GA2290821@bgt-140510-bm03>
In-Reply-To: <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="us-ascii"
Content-ID: <68A82B7ED06BE445AEEF7B0E3BBA5CE0@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFrrEKsWRmVeSWpSXmKPExsWy7djXc7ozFOpSDDb9NrboPr+B0WL61AuM
        FqtvrmG0aGh6xGLRsvs9k8X+p89ZLFYtvMZmcX7WKRaL5xOfM1ksXfKI2eJ47w4WB26PC5Mn
        sHosbnD12DnrLrtHy5G3QN6el0weGz/+Z/d4cm0zk8fm1y+YPabOrvf4vEkugCuKyyYlNSez
        LLVI3y6BK+NZE2vB2siKQyeWMjYwHnbrYuTkkBAwkbjX+Z+1i5GLQ0hgJaPEnWsHWCCcViaJ
        9mM32GCqDu5bwAaRWMso0bnnLlTVR0aJ27+7mSCcpYwSDa0nmEFa2AQUJfZ1bQdrFxFQljj9
        7ypYO7PAFRaJ61PXMYEkhAWcJSYvP8HYxcgBVOQicemZH4RpJbHmngRIBYuAisSOU53sIDav
        gJnEm6uXGEFsTgFriaezV7CC2IwCYhLfT60Bm8gsIC5x68l8JoirBSUWzd7DDGGLSfzb9RDq
        G0WJ+99fskPU60gs2P2JDWQts4CdxNUL0RBhbYllC18zQ6wVlDg58wkLRKukxMEVN6Ds6ZwS
        q05bQNguEhcfv4WKS0tcvT6VGWSkhECyxKqPXBDhHIn5S7ZAlVhLLPyznmkCo8osJEfPQnLQ
        LISDZiE5aBaSgxYwsq5iFC8tLs5NTy02zEst1ytOzC0uzUvXS87P3cQITHan/x3O3cG449ZH
        vUOMTByMhxglOJiVRHh3eVWnCPGmJFZWpRblxxeV5qQWH2KU5mBREuc1tD2ZLCSQnliSmp2a
        WpBaBJNl4uCUamBas6f4nXPFg6IczZCTM680v4o9ZOcpG/XaYpfof+V9founhRUfatFZbWce
        ymF0ReZHutQLbtOnq16khpfvnzbpZOsq2UDdFK9zawpjWcJufxa9OG3+U4l69f6Ef/kfOTZX
        2tsuDGpyc7nVtnybn3Rd4hy5DUz3nJRcPWXidb/fsIk4bmKx7vf20J/S2sXdMT0FNv7Xi4Im
        5632uCse8lf6uIGa+o2ow4dFJml2aPWvLxXMz9q58eisa8LbWb4e0bjz/1FFmODi661T/zRM
        /TbD7HGz8fnzUcvM4tq/qSmf4gs9dee50CrGdAemCczToppmth7gtXjXG1l0IiR1xoqGeIkp
        s6X6lC5tjFXQSFRiKc5INNRiLipOBABUSX1R5QMAAA==
X-Brightmail-Tracker: H4sIAAAAAAAAA01Se0hTURzu3Hu33W0NjkvzZA9qZomVZojdXmaYdU0Kg5TMwka7qeSrO62V
        YEOscMtQhj02q1mzRE1KozRN0/VSqYmkPWhJvtbQTIsamc2cl8j/vu98j9/vB4fEpd8ILzIp
        NYNhU+XJMr6ISFJjhasuLc5WrLZVz6e0ljuAuljUAaiKd5WAUuf0ElRu/VeMahqwEVR5STef
        sujbCMpWaMOoUlMvTj3PryVCxXSHroBH31CH03V6q4DOffJlijXYMfru2KSA7u+uweiaoc84
        XWQ4RX+vXhQl2ifaqGCSk44xbEDIQVHiYA4v/XasquVFKVAD8zYNEJIIBqHmRiNfA0SkFFYA
        1K3V4RwZA+hDsZbgSClAPy40464IHy5BjZoHfBd2h96o3dk1HcfhawK9KarCXMIcGIZ0t14A
        DSCnTFtR5+AuDq5HlR+Ry0HApai2LU/gwhIYjIa7OgE3qxGgX4/NPJcghBvQgKFsGgM4Fzna
        KqfrceiJ3vdfw7gTIDI1WHAOeyB7n5PH4SWox2EXcP6VyFj/je/aAYchqKsjjntegW6WDOHc
        Dm6o9XI/wUXnoeayt0QBQPoZ0/QzmvT/m/QzmvQzmoyAVw48M5XKlASVMjCVOe6vlKcoM1MT
        /A+lpVSDqW/R7jTH1oKn78f8WwBGghaASFzmLnm4I0shlSjkJ04ybFo8m5nMKFvAfJKQeUqk
        4YXxUpggz2COMEw6w/5TMVLopcaWB4h/aO1tm4f3ta6J04/sTBkd3HLPORITY3jp/sziMdKq
        smHlA+O8+ia6/2sTqxILzna6jeWLh65Eecfsl1izz2936I7b2yNMoUeEExeztpJRbmiyr9UP
        sLECM3gyvlunlk/8HM26GlmxLtC3d9aa34a0jHuJhbnL8keqTPY8RfdagbevldVFhx0tM/N6
        xiPn1JVt8Tr9GnvgzLKE1VmwT48uXYcLHMU3l0f/KVafEWmC9lpXG0d9hgvuIyMUa6rOhSwU
        ie+m7VIL3/mIiw4b8hq0nyJCw1Y4tLMTKoPDe4JvTG76cj9xT8ABNxhdn/0qRBdk0qpexVqF
        2etkhDJRHuiHs0r5X69TbJyFAwAA
X-CMS-MailID: 20230605175120uscas1p133d49fa845805bda83677dd29cdf7c1e
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 11142
Lines: 295

On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:
> Fan Ni wrote:
> > Since the early draft of DCD support in kernel is out
> > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/20230417=
164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiG=
sqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGNOk$ =
),
> > this patch series provide dcd emulation in qemu so people who are inter=
ested
> > can have an early try. It is noted that the patch series may need to be=
 updated
> > accordingly if the kernel side implementation changes.
>=20
> Fan,
>=20
> Do you have a git tree we can pull this from which is updated to a more
> recent CXL branch from Jonathan?
>=20
> Thanks,
> Ira

Hi Ira,

I have a git tree of the patch series based on Jonathan's branch
cxl-2023-02-28: https://github.com/moking/qemu-dev/tree/dcd-rfe.

That may be not new enough to include some of the recent patches, but I can
rebase it to a newer branch if you can tell me which branch you want to use=
.

Thanks,
Fan

>=20
> >=20
> > To support DCD emulation, the patch series add DCD related mailbox comm=
and
> > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory devi=
ce
> > with dynamic capacity extent and region representative.
> > To support read/write to the dynamic capacity of the device, a host bac=
kend
> > is provided and necessary check mechnism is added to ensure the dynamic
> > capacity accessed is backed with active dc extents.
> > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not su=
pported
> > , but we add two qmp interfaces for adding/releasing dynamic capacity e=
xtents.
> > Also, the support for multiple hosts sharing the same DCD case is missi=
ng.
> >=20
> > Things we can try with the patch series together with kernel dcd code:
> > 1. Create DC regions to cover the address range of the dynamic capacity
> > regions.
> > 2. Add/release dynamic capacity extents to the device and notify the
> > kernel.
> > 3. Test kernel side code to accept added dc extents and create dax devi=
ces,
> > and release dc extents and notify the device
> > 4. Online the memory range backed with dc extents and let application u=
se
> > them.
> >=20
> > The patch series is based on Jonathan's local qemu branch:
> > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-20=
23-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFd=
wKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$=20
> >=20
> > Simple tests peformed with the patch series:
> > 1 Install cxl modules:
> >=20
> > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
> >=20
> > 2 Create dc regions:
> >=20
> > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> > echo 0x10000000 > /sys/bus/cxl/devices/$region/size
> > echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> > echo 1 > /sys/bus/cxl/devices/$region/commit
> > echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> >=20
> > /home/fan/cxl/tools-and-scripts# cxl list
> > [
> >   {
> >     "memdevs":[
> >       {
> >         "memdev":"mem0",
> >         "pmem_size":536870912,
> >         "ram_size":0,
> >         "serial":0,
> >         "host":"0000:0d:00.0"
> >       }
> >     ]
> >   },
> >   {
> >     "regions":[
> >       {
> >         "region":"region0",
> >         "resource":45365592064,
> >         "size":268435456,
> >         "interleave_ways":1,
> >         "interleave_granularity":256,
> >         "decode_state":"commit"
> >       }
> >     ]
> >   }
> > ]
> >=20
> > 3 Add two dc extents (128MB each) through qmp interface
> >=20
> > { "execute": "qmp_capabilities" }
> >=20
> > { "execute": "cxl-add-dynamic-capacity-event",
> > 	"arguments": {
> > 		 "path": "/machine/peripheral/cxl-pmem0",
> > 		"region-id" : 0,
> > 		 "num-extent": 2,
> > 		"dpa":0,
> > 		"extent-len": 128
> > 	}
> > }
> >=20
> > /home/fan/cxl/tools-and-scripts# lsmem
> > RANGE                                  SIZE   STATE REMOVABLE   BLOCK
> > 0x0000000000000000-0x000000007fffffff    2G  online       yes    0-15
> > 0x0000000100000000-0x000000027fffffff    6G  online       yes   32-79
> > 0x0000000a90000000-0x0000000a9fffffff  256M offline           338-339
> >=20
> > Memory block size:       128M
> > Total online memory:       8G
> > Total offline memory:    256M
> >=20
> >=20
> > 4.Online the momory with 'daxctl online-memory dax0.0' to online the me=
mory
> >=20
> > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
> > [  230.730553] Fallback order for Node 0: 0 1
> > [  230.730825] Fallback order for Node 1: 1 0
> > [  230.730953] Built 2 zonelists, mobility grouping on.  Total pages: 2=
042541
> > [  230.731110] Policy zone: Normal
> > onlined memory for 1 device
> >=20
> > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> > RANGE                                  SIZE   STATE REMOVABLE BLOCK
> > 0x0000000000000000-0x000000007fffffff    2G  online       yes  0-15
> > 0x0000000100000000-0x000000027fffffff    6G  online       yes 32-79
> > 0x0000000a90000000-0x0000000a97ffffff  128M  online       yes   338
> > 0x0000000a98000000-0x0000000a9fffffff  128M offline             339
> >=20
> > Memory block size:       128M
> > Total online memory:     8.1G
> > Total offline memory:    128M
> >=20
> > 5 using dc extents as regular memory
> >=20
> > /home/fan/cxl/ndctl# numactl --membind=3D1 ls
> > CONTRIBUTING.md  README.md  clean_config.sh  cscope.out   git-version-g=
en
> > ndctl	       scripts	test.h      version.h.in COPYING		 acpi.h
> > config.h.meson   cxl	  make-git-snapshot.sh	ndctl.spec.in  sles	tools
> > Documentation	 build	    contrib	     daxctl	  meson.build		rhel
> > tags	topology.png LICENSES	 ccan	    cscope.files
> > git-version  meson_options.txt	rpmbuild.sh    test	util
> >=20
> >=20
> > QEMU command line cxl configuration:
> >=20
> > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=3D=
/tmp/cxltest.raw,size=3D512M \
> > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/cx=
ltest2.raw,size=3D512M \
> > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/ls=
a.raw,size=3D512M \
> > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
> > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,dc=
-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\
> > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleave=
-granularity=3D8k"
> >=20
> >=20
> > Kernel DCD support used to test the changes
> >=20
> > The code is tested with the posted kernel dcd support:
> > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/kernel=
/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJBm!RH=
zXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21q=
5Iza3M$=20
> >=20
> > commit: f425bc34c600e2a3721d6560202962ec41622815
> >=20
> > To make the test work, we have made the following changes to the above =
kernel commit:
> >=20
> > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> > index 5f04bbc18af5..5f421d3c5cef 100644
> > --- a/drivers/cxl/core/mbox.c
> > +++ b/drivers/cxl/core/mbox.c
> > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_ME=
M_COMMAND_ID_MAX] =3D {
> >  	CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
> >  	CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
> >  	CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
> > +	CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
> >  };
> > =20
> >  /*
> > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> > index 291c716abd49..ae10e3cf43a1 100644
> > --- a/drivers/cxl/core/region.c
> > +++ b/drivers/cxl/core/region.c
> > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *=
cxlr)
> >  		}
> >  		cxlds->dc_list_gen_num =3D extent_gen_num;
> >  		dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
> > -		enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
> > +		/*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/
> >  	}
> >  	return 0;
> >  err:
> > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds=
, struct resource *alloc_dpa_re
> >  				dev_dax->align, memremap_compat_align()))) {
> >  		rc =3D alloc_dev_dax_range(dev_dax, hpa,
> >  					resource_size(alloc_dpa_res));
> > -		return rc;
> > +		if (rc)
> > +			return rc;
> >  	}
> > =20
> >  	rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);
> > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> > index 9e45b1056022..653bec203838 100644
> > --- a/drivers/cxl/pci.c
> > +++ b/drivers/cxl/pci.c
> > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state =
*cxlds)
> > =20
> >  	/* Driver enables DCD interrupt after creating the dc cxl_region */
> >  	rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYP=
E_DCD,
> > -					IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
> > +					IRQF_SHARED | IRQF_ONESHOT);
> >  	if (rc) {
> >  		dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
> >  		return rc;
> > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.=
h
> > index 6ca85861750c..910a48259239 100644
> > --- a/include/uapi/linux/cxl_mem.h
> > +++ b/include/uapi/linux/cxl_mem.h
> > @@ -47,6 +47,7 @@
> >  	___C(SCAN_MEDIA, "Scan Media"),                                   \
> >  	___C(GET_SCAN_MEDIA, "Get Scan Media Results"),                   \
> >  	___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"),         \
> > +	___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),         \
> >  	___C(MAX, "invalid / last command")
> > =20
> >  #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
> >=20
> >=20
> >=20
> > Fan Ni (7):
> >   hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
> >     payload of identify memory device command
> >   hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
> >     and mailbox command support
> >   hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
> >     device supports in qemu command line
> >   hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
> >   hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
> >     dynamic capacity response
> >   Add qmp interfaces to add/release dynamic capacity extents
> >   hw/mem/cxl_type3: add read/write support to dynamic capacity
> >=20
> >  hw/cxl/cxl-mailbox-utils.c  | 389 +++++++++++++++++++++++++++-
> >  hw/mem/cxl_type3.c          | 492 +++++++++++++++++++++++++++++++-----
> >  include/hw/cxl/cxl_device.h |  50 +++-
> >  include/hw/cxl/cxl_events.h |  16 ++
> >  qapi/cxl.json               |  44 ++++
> >  5 files changed, 924 insertions(+), 67 deletions(-)
> >=20
> > --=20
> > 2.25.1
>=20
> =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id EFFCDC7EE25
	for <linux-cxl@archiver.kernel.org>; Wed,  7 Jun 2023 18:31:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230424AbjFGSbP (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Wed, 7 Jun 2023 14:31:15 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:46976 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230219AbjFGSbN (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Wed, 7 Jun 2023 14:31:13 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A72D9E79
        for <linux-cxl@vger.kernel.org>; Wed,  7 Jun 2023 11:31:09 -0700 (PDT)
Received: from uscas1p2.samsung.com (unknown [182.198.245.207])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230607183108usoutp0134783ad18167962300d210b06fd9ccd0~mdANq7yWc1898518985usoutp01H;
        Wed,  7 Jun 2023 18:31:08 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230607183108usoutp0134783ad18167962300d210b06fd9ccd0~mdANq7yWc1898518985usoutp01H
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1686162668;
        bh=PmCOE2J5E5WCbnaLCneJHFc3Oh48+OBpYXQhn+M3ZAU=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=nEFX178QASY2GEUNgUSlRnunIyd04crhvmlDUzXlSn5rfVE6iRUuB8s2vZLqXSjwF
         iLiRrVXN8+A53q00993EMZZ8HaPMcXlkEg1nETwVzYrS8/XZYtcSsH8F4hy4odtZgl
         8VNFTjO0cnidFqzh24zfhc4hCbuRPCm17UR2qijY=
Received: from ussmges2new.samsung.com (u111.gpu85.samsung.co.kr
        [203.254.195.111]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230607183108uscas1p29036b118f6c1a73df6d373d61360405c~mdANX78_k2687226872uscas1p2e;
        Wed,  7 Jun 2023 18:31:08 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges2new.samsung.com (USCPEMTA) with SMTP id 33.6C.42611.CECC0846; Wed, 
        7 Jun 2023 14:31:08 -0400 (EDT)
Received: from ussmgxs2new.samsung.com (u91.gpu85.samsung.co.kr
        [203.254.195.91]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230607183107uscas1p2c41fdce65faa305ba7fd2598ec801b65~mdANBsqyK0137001370uscas1p2y;
        Wed,  7 Jun 2023 18:31:07 +0000 (GMT)
X-AuditID: cbfec36f-249ff7000000a673-21-6480ccec5c3c
Received: from SSI-EX3.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs2new.samsung.com (USCPEXMTA) with SMTP id 8F.57.44215.BECC0846; Wed, 
        7 Jun 2023 14:31:07 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX3.ssi.samsung.com (105.128.2.228) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Wed, 7 Jun 2023 11:31:06 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Wed,
        7 Jun 2023 11:31:06 -0700
From: Fan Ni <fan.ni@samsung.com>
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
CC: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        "Ira Weiny" <ira.weiny@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK99FUkAgAAEUYCAAyq+gIAABQqA
Date: Wed, 7 Jun 2023 18:31:06 +0000
Message-ID: <20230607183059.GA2354376@bgt-140510-bm03>
In-Reply-To: <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-ID: <7B8924E83A75D7488D909233119FDCA9@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrAKsWRmVeSWpSXmKPExsWy7djX87pvzjSkGNy8w2rRfX4Do8X0qRcY
        LVbfXMNo0dD0iMWiZfd7Jov9T5+zWKxaeI3N4vysUywWzyc+Z7JYuuQRs8Xx3h0sFo+vX2R1
        4PG4MHkCq8fiBlePnbPusnu0HHkL5O15yeQxeeFFZo+NH/+zezy5tpnJY/PrF8weU2fXe3ze
        JBfAHcVlk5Kak1mWWqRvl8CVsfbGIqaC5gbGiul/HrA3MK7P7WLk5JAQMJHY9nwicxcjF4eQ
        wEpGiV275jJBOK1MEofP/GCEqbr49QgLRGIto8TTqR+gnI+MEq87rkO1LGWU+L/5KytIC5uA
        osS+ru1sILaIgKXE0jXrwZYwC7xikfj6dDILSEJYwFli8vITQDs4gIpcJC4984Ood5PYsnMa
        M4jNIqAicanlEzuIzStgJjH7y31WkHJOgViJAxfBpjAKiEl8P7WGCcRmFhCXuPVkPhPE1YIS
        i2bvYYawxST+7XrIBmErStz//pIdol5P4sbUKWwQtp3E5cbprBC2tsSyha+ZIdYKSpyc+YQF
        oldS4uCKG2DPSwis5pQ4feUwC8g9EkDnnz4KVSMt8ffuMiaIcLLEqo9cEOEciflLtkCVWEss
        /LOeaQKjyiwkV89CctEsJBfNQnLRLCQXLWBkXcUoXlpcnJueWmyUl1quV5yYW1yal66XnJ+7
        iRGYCE//O5y/g/H6rY96hxiZOBgPMUpwMCuJ8GbZ16cI8aYkVlalFuXHF5XmpBYfYpTmYFES
        5zW0PZksJJCeWJKanZpakFoEk2Xi4JRqYCr9pTFbInZh+Fnncxv/mT3Qi/GeZ/35p/PH9FzP
        t11b+K7N0fmYaPh6UWXszivFGxjiFgeVflzk8Vvpnb5m2Dbvm6+yX0W8X9uecs3v8eJJYdVy
        81V1AjdqPy4oUb3x5Y/304/+ffJrG/acf/ee8Zf9FblXDA3Nuzk7S2tDbh/YfH3/Q9+Hh/8G
        q4roH2teeuPXobNcR1r/swmxP/T3U4hca9vKELghsE7ccG5FT10228H3F/by6KcU57Usy7H7
        tHyNqUrn7GfxaxPOKZnyqrbfya/9dik7dkKmTYGuZtM/xzNzFnP4O0eXiB35/U4vIs8+7Im0
        3gR1HW7laev7BO6/SP166Uf5ybcCDcEMB5RYijMSDbWYi4oTARPG477zAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA02Se0hTYRjG+c45287M0WlafhYZWX9U6rqZnNA0sMupoCISzQtz5cnUqbFp
        phLOHBgLrVwqHWmpbSq60Ka5ieYtzaxozsJrZaTOlkWaWVChOQ/B/vu9PM/7PN8HL44KF7G1
        eFxSCi1Lkkg9uU5YnAIp8Jl+qYjZkZPrTV431wGyuLAPkDXDekAqrn7ESGXzN4Rsm5zCyOqy
        AS5pZp5j5NStKYTUaT+iZE+eCSPHBy2c/c5Un/omh7qvOEg1Me94lLLr69LUYkModZkFpR7O
        LvKoiYF6hKqf/oRShSVZ1JzB4+SKcKeAGFoad4mWbQ+MdrrwYKgcuZijAJeL/37gKUBtogrw
        cUj4Qst8F6YCTriQqAHwz3AXaheExCyAw5V8VtABWGEyYXaBS2yErSoj186uxF6o09eidhNK
        fMbg/KR62eRCBEN15TOgAviS6QDstx5n/YdgQ1PRcgFGbIb9yu88OwsIP1jyY4zDlrUiMDe/
        nWff5RNRsN2yHAmINfDXcz1iZ5RwgyMT9xD2BwTUtphRlldD2/gCh+WNcOyXjcf6RXCo8DaX
        5UD4OruYw7IXrCibRtk3rIK9dyYwdtcddlQNYTcBZBzqGIcoxiGKcYhiHKJKAacauKXK5Ymx
        l+W7kug0kVySKE9NihWdS040gKUbebHwJMIERkdmRZ0AwUEngDjq6SqID8qKEQpiJOkZtCxZ
        LEuV0vJOsA7HPN0EtvBbYiERK0mhE2j6Ii37ryI4f60C0e61PNYpRQ1VZo/wU4HG+x14P3i/
        +o048km078w+YcNo2Eos96nyMJoPFoNaXlvd45tDmK09mWFt/Cu63JyjUXd+NurV5cEnRgfT
        tGKy60tA+0oT2e+TEOGxRq/JtmpKNbxMytsvwgAib2fNG46dVG9Iy2obKpjHfMSNpztP5fy+
        6peSr9kU4N4rCh0oCpGS1QtInsukr/UaPyS74lCyS8fOEqvKn2lcbzT+nLo7sW63Leh0d5Wz
        d1TknKj7/FgeUvCy5NWRcaNgz9O3vYqEHumcN1q026yuCdVuuZGSUTyTEQ66q5Wgo86Q/in9
        bEiLZjHSa9PBM2pz8CN/T0x+QbJzGyqTS/4BAQG+SJIDAAA=
X-CMS-MailID: 20230607183107uscas1p2c41fdce65faa305ba7fd2598ec801b65
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
        <20230605175112.GA2290821@bgt-140510-bm03>
        <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 16007
Lines: 380

On Wed, Jun 07, 2023 at 06:13:01PM +0000, Shesha Bhushan Sreenivasamurthy w=
rote:
> Hi Fan,
>    I am implementing DCD FMAPI commands and planning to start pushing cha=
nges to the below branch. That requires the contributions you have made. Ca=
n your changes be pushed to the below branch ?
>=20
> https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-2023=
-05-25__;!!EwVzqGoTKBqv-0DWAJBm!Vt5uIqwW-L4c4gh02ulI4M762JNQ3_aE9k9lb6QlwE2=
xm6T23ic7ig7Y77i1VN7l_RX_ySIQhre_z7Q0JA$=20

Can you push changes to the branch directly? I think it is Jonathan's priva=
te
branch. However, I can fork the branch and rebase my patch series atop and
share with you the new repo if that helps you move forward your
work.
Let me know your thought.

Fan

>=20
>=20
> From: Fan Ni <fan.ni@samsung.com>
> Sent: Monday, June 5, 2023 10:51 AM
> To: Ira Weiny <ira.weiny@intel.com>
> Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@huawe=
i.com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl@v=
ger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; h=
chkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design=
.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@in=
tel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <da=
ve@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; ni=
fan@outlook.com <nifan@outlook.com>
> Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu=20
> =A0
> On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:
> > Fan Ni wrote:
> > > Since the early draft of DCD support in kernel is out
> > > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/202304=
17164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcS=
iGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGNOk=
$ ),
> > > this patch series provide dcd emulation in qemu so people who are int=
erested
> > > can have an early try. It is noted that the patch series may need to =
be updated
> > > accordingly if the kernel side implementation changes.
> >=20
> > Fan,
> >=20
> > Do you have a git tree we can pull this from which is updated to a more
> > recent CXL branch from Jonathan?
> >=20
> > Thanks,
> > Ira
>=20
> Hi Ira,
>=20
> I have a git tree of the patch series based on Jonathan's branch
> cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__gi=
thub.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=3DDwIFAg&c=3DnKjWec2b6R0mOyPaz7=
xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3Dw6dicn5kXEG4Imk6Tp=
ICIjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3D3yeO9RN5FY3gPfO2y19X057Y=
eqRTTQTQNfNA-Gfir_Q&e=3D .
>=20
> That may be not new enough to include some of the recent patches, but I c=
an
> rebase it to a newer branch if you can tell me which branch you want to u=
se.
>=20
> Thanks,
> Fan
>=20
> >=20
> > >=20
> > > To support DCD emulation, the patch series add DCD related mailbox co=
mmand
> > > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory de=
vice
> > > with dynamic capacity extent and region representative.
> > > To support read/write to the dynamic capacity of the device, a host b=
ackend
> > > is provided and necessary check mechnism is added to ensure the dynam=
ic
> > > capacity accessed is backed with active dc extents.
> > > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not =
supported
> > > , but we add two qmp interfaces for adding/releasing dynamic capacity=
 extents.
> > > Also, the support for multiple hosts sharing the same DCD case is mis=
sing.
> > >=20
> > > Things we can try with the patch series together with kernel dcd code=
:
> > > 1. Create DC regions to cover the address range of the dynamic capaci=
ty
> > > regions.
> > > 2. Add/release dynamic capacity extents to the device and notify the
> > > kernel.
> > > 3. Test kernel side code to accept added dc extents and create dax de=
vices,
> > > and release dc extents and notify the device
> > > 4. Online the memory range backed with dc extents and let application=
 use
> > > them.
> > >=20
> > > The patch series is based on Jonathan's local qemu branch:
> > > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-=
2023-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeU=
FdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$=20
> > >=20
> > > Simple tests peformed with the patch series:
> > > 1 Install cxl modules:
> > >=20
> > > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
> > >=20
> > > 2 Create dc regions:
> > >=20
> > > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> > > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> > > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> > > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> > > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> > > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> > > echo 0x10000000 > /sys/bus/cxl/devices/$region/size
> > > echo=A0 "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> > > echo 1 > /sys/bus/cxl/devices/$region/commit
> > > echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> > >=20
> > > /home/fan/cxl/tools-and-scripts# cxl list
> > > [
> > >=A0=A0 {
> > >=A0=A0=A0=A0 "memdevs":[
> > >=A0=A0=A0=A0=A0=A0 {
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "memdev":"mem0",
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "pmem_size":536870912,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "ram_size":0,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "serial":0,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "host":"0000:0d:00.0"
> > >=A0=A0=A0=A0=A0=A0 }
> > >=A0=A0=A0=A0 ]
> > >=A0=A0 },
> > >=A0=A0 {
> > >=A0=A0=A0=A0 "regions":[
> > >=A0=A0=A0=A0=A0=A0 {
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "region":"region0",
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "resource":45365592064,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "size":268435456,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_ways":1,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_granularity":256,
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "decode_state":"commit"
> > >=A0=A0=A0=A0=A0=A0 }
> > >=A0=A0=A0=A0 ]
> > >=A0=A0 }
> > > ]
> > >=20
> > > 3 Add two dc extents (128MB each) through qmp interface
> > >=20
> > > { "execute": "qmp_capabilities" }
> > >=20
> > > { "execute": "cxl-add-dynamic-capacity-event",
> > >=A0=A0=A0=A0=A0 "arguments": {
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "path": "/machine/periphera=
l/cxl-pmem0",
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "region-id" : 0,
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "num-extent": 2,
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "dpa":0,
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "extent-len": 128
> > >=A0=A0=A0=A0=A0 }
> > > }
> > >=20
> > > /home/fan/cxl/tools-and-scripts# lsmem
> > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE=A0=A0 BLOCK
> > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0=A0=A0 0-15
> > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0=A0 32-79
> > > 0x0000000a90000000-0x0000000a9fffffff=A0 256M offline=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0 338-339
> > >=20
> > > Memory block size:=A0=A0=A0=A0=A0=A0 128M
> > > Total online memory:=A0=A0=A0=A0=A0=A0 8G
> > > Total offline memory:=A0=A0=A0 256M
> > >=20
> > >=20
> > > 4.Online the momory with 'daxctl online-memory dax0.0' to online the =
memory
> > >=20
> > > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
> > > [=A0 230.730553] Fallback order for Node 0: 0 1
> > > [=A0 230.730825] Fallback order for Node 1: 1 0
> > > [=A0 230.730953] Built 2 zonelists, mobility grouping on.=A0 Total pa=
ges: 2042541
> > > [=A0 230.731110] Policy zone: Normal
> > > onlined memory for 1 device
> > >=20
> > > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE BLOCK
> > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0 0-15
> > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=
=A0=A0=A0 yes 32-79
> > > 0x0000000a90000000-0x0000000a97ffffff=A0 128M=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0 338
> > > 0x0000000a98000000-0x0000000a9fffffff=A0 128M offline=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0 339
> > >=20
> > > Memory block size:=A0=A0=A0=A0=A0=A0 128M
> > > Total online memory:=A0=A0=A0=A0 8.1G
> > > Total offline memory:=A0=A0=A0 128M
> > >=20
> > > 5 using dc extents as regular memory
> > >=20
> > > /home/fan/cxl/ndctl# numactl --membind=3D1 ls
> > > CONTRIBUTING.md=A0 README.md=A0 clean_config.sh=A0 cscope.out=A0=A0 g=
it-version-gen
> > > ndctl=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 scripts=A0=A0 test.h=A0=
=A0=A0=A0=A0 version.h.in COPYING=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 acpi.h
> > > config.h.meson=A0=A0 cxl=A0=A0=A0=A0=A0=A0=A0=A0=A0 make-git-snapshot=
.sh=A0=A0 ndctl.spec.in=A0 sles=A0=A0=A0=A0 tools
> > > Documentation=A0=A0=A0=A0=A0=A0=A0 build=A0=A0=A0=A0=A0=A0 contrib=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 daxctl=A0=A0=A0=A0=A0=A0=A0 meson.build=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 rhel
> > > tags=A0=A0=A0=A0=A0=A0=A0 topology.png LICENSES=A0=A0=A0 ccan=A0=A0=
=A0=A0=A0=A0=A0 cscope.files
> > > git-version=A0 meson_options.txt=A0=A0=A0=A0=A0 rpmbuild.sh=A0=A0=A0 =
test=A0=A0=A0=A0 util
> > >=20
> > >=20
> > > QEMU command line cxl configuration:
> > >=20
> > > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=
=3D/tmp/cxltest.raw,size=3D512M \
> > > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/=
cxltest2.raw,size=3D512M \
> > > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/=
lsa.raw,size=3D512M \
> > > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
> > > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> > > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,=
dc-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\
> > > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interlea=
ve-granularity=3D8k"
> > >=20
> > >=20
> > > Kernel DCD support used to test the changes
> > >=20
> > > The code is tested with the posted kernel dcd support:
> > > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/kern=
el/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJBm!=
RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr2=
1q5Iza3M$=20
> > >=20
> > > commit: f425bc34c600e2a3721d6560202962ec41622815
> > >=20
> > > To make the test work, we have made the following changes to the abov=
e kernel commit:
> > >=20
> > > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> > > index 5f04bbc18af5..5f421d3c5cef 100644
> > > --- a/drivers/cxl/core/mbox.c
> > > +++ b/drivers/cxl/core/mbox.c
> > > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_=
MEM_COMMAND_ID_MAX] =3D {
> > >=A0=A0=A0=A0=A0 CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
> > >=A0=A0=A0=A0=A0 CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
> > >=A0=A0=A0=A0=A0 CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD,=
 0),
> > > +=A0=A0 CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
> > >=A0 };
> > >=A0=20
> > >=A0 /*
> > > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> > > index 291c716abd49..ae10e3cf43a1 100644
> > > --- a/drivers/cxl/core/region.c
> > > +++ b/drivers/cxl/core/region.c
> > > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region=
 *cxlr)
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 }
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 cxlds->dc_list_gen_num =3D ext=
ent_gen_num;
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_dbg(cxlds->dev, "No of pre=
allocated extents :%d\n", rc);
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 enable_irq(cxlds->cxl_irq[CXL_EVENT_T=
YPE_DCD]);
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 /*enable_irq(cxlds->cxl_irq[CXL_EVENT=
_TYPE_DCD]);*/
> > >=A0=A0=A0=A0=A0 }
> > >=A0=A0=A0=A0=A0 return 0;
> > >=A0 err:
> > > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxl=
ds, struct resource *alloc_dpa_re
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0 dev_dax->align, memremap_compat_align()))) {
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rc =3D alloc_dev_dax_range(dev=
_dax, hpa,
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 resource_size(alloc_dpa_res));
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (rc)
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;
> > >=A0=A0=A0=A0=A0 }
> > >=A0=20
> > >=A0=A0=A0=A0=A0 rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax,=
 GFP_KERNEL);
> > > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> > > index 9e45b1056022..653bec203838 100644
> > > --- a/drivers/cxl/pci.c
> > > +++ b/drivers/cxl/pci.c
> > > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_stat=
e *cxlds)
> > >=A0=20
> > >=A0=A0=A0=A0=A0 /* Driver enables DCD interrupt after creating the dc =
cxl_region */
> > >=A0=A0=A0=A0=A0 rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings=
, CXL_EVENT_TYPE_DCD,
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_A=
UTOEN);
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT);
> > >=A0=A0=A0=A0=A0 if (rc) {
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_err(cxlds->dev, "Failed to=
 get interrupt for event dc log\n");
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;
> > > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_me=
m.h
> > > index 6ca85861750c..910a48259239 100644
> > > --- a/include/uapi/linux/cxl_mem.h
> > > +++ b/include/uapi/linux/cxl_mem.h
> > > @@ -47,6 +47,7 @@
> > >=A0=A0=A0=A0=A0 ___C(SCAN_MEDIA, "Scan Media"),=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 \
> > >=A0=A0=A0=A0=A0 ___C(GET_SCAN_MEDIA, "Get Scan Media Results"),=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \
> > >=A0=A0=A0=A0=A0 ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents=
"),=A0=A0=A0=A0=A0=A0=A0=A0 \
> > > +=A0=A0 ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),=A0=
=A0=A0=A0=A0=A0=A0=A0 \
> > >=A0=A0=A0=A0=A0 ___C(MAX, "invalid / last command")
> > >=A0=20
> > >=A0 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
> > >=20
> > >=20
> > >=20
> > > Fan Ni (7):
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
> > >=A0=A0=A0=A0 payload of identify memory device command
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dynamic capacity region represent=
ative
> > >=A0=A0=A0=A0 and mailbox command support
> > >=A0=A0 hw/mem/cxl_type3: Add a parameter to pass number of DC regions =
the
> > >=A0=A0=A0=A0 device supports in qemu command line
> > >=A0=A0 hw/mem/cxl_type3: Add DC extent representative to cxl type3 dev=
ice
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/r=
elease
> > >=A0=A0=A0=A0 dynamic capacity response
> > >=A0=A0 Add qmp interfaces to add/release dynamic capacity extents
> > >=A0=A0 hw/mem/cxl_type3: add read/write support to dynamic capacity
> > >=20
> > >=A0 hw/cxl/cxl-mailbox-utils.c=A0 | 389 +++++++++++++++++++++++++++-
> > >=A0 hw/mem/cxl_type3.c=A0=A0=A0=A0=A0=A0=A0=A0=A0 | 492 ++++++++++++++=
+++++++++++++++++-----
> > >=A0 include/hw/cxl/cxl_device.h |=A0 50 +++-
> > >=A0 include/hw/cxl/cxl_events.h |=A0 16 ++
> > >=A0 qapi/cxl.json=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 |=A0 44 ++=
++
> > >=A0 5 files changed, 924 insertions(+), 67 deletions(-)
> > >=20
> > > --=20
> > > 2.25.1
> >=20
> > =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id F39EBC7EE23
	for <linux-cxl@archiver.kernel.org>; Wed,  7 Jun 2023 18:39:00 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229822AbjFGSjA (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Wed, 7 Jun 2023 14:39:00 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53942 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233006AbjFGSiz (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Wed, 7 Jun 2023 14:38:55 -0400
Received: from mx0b-0016f401.pphosted.com (mx0a-0016f401.pphosted.com [67.231.148.174])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AC8191725
        for <linux-cxl@vger.kernel.org>; Wed,  7 Jun 2023 11:38:46 -0700 (PDT)
Received: from pps.filterd (m0045849.ppops.net [127.0.0.1])
        by mx0a-0016f401.pphosted.com (8.17.1.19/8.17.1.19) with ESMTP id 357I7MUA027507;
        Wed, 7 Jun 2023 11:13:04 -0700
Received: from pps.reinject (localhost [127.0.0.1])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r2a7bvyx2-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Wed, 07 Jun 2023 11:13:04 -0700
Received: from m0045849.ppops.net (m0045849.ppops.net [127.0.0.1])
        by pps.reinject (8.17.1.5/8.17.1.5) with ESMTP id 357ID32e003250;
        Wed, 7 Jun 2023 11:13:03 -0700
Received: from nam04-mw2-obe.outbound.protection.outlook.com (mail-mw2nam04lp2169.outbound.protection.outlook.com [104.47.73.169])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r2a7bvywy-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Wed, 07 Jun 2023 11:13:03 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=jhiIq45c424x8VYR7GSp5B83DOE/Xx18ArTcJxBbtaipiHRC56zW/uJw2UNzRVWiwgj5IDbI2VTZdCs/bJq+H1w9MlF3YKClpHUnG1l6XSAVuCj+9Cigr7xlT5xER8BtC3l/mu5yPwvos1oh2nJLft/7gZtjYGAJ84EYQNQL9JgzJX5XZI4HvZXKB+8+HJoA8kk3n118S+gNhAYT3/8Q8t8wgZUjqAw57WLAX5NiTW5X1XXy3CaZ8PtVrJQ/QfJV1dfRISfUnK1vUGXE8zEjVIDw0FenD0CRdq4VtJQ4e8NDT8MWjwurPKHpk/GfkGC5dNlQws5xtnLkBHu+0PNZ8g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=mW4TBilgOTe5bw6pCHYuRNJDAm4BOVCMzPtN2aAVfh0=;
 b=YZPhAhgDeo8ZN95Ovs/yihh9dMl2iUYfBr3Pjm2D27+hOABEAPZ/NqFAH/d1yPfvcY8wAliz5MQTXyxrlriGcMuTc8Dbi2sx5UU4524i3s/TKfeNhk2J8rqkdEQoAvvd7sbiUUfvXxZpjGX5eNrKTFc6cVNoJX5zmAm5OhY+Bn9Xhrn3qzfdWVvURUEF3QdebMD8VG7iS81RAojbrQQHPWFZGs2NX8c3bdcW7O89P7i03MMwWmpRKj3p6M9zia6oFsQxKq8F+fAgLOYzkU9ILp3haSChoZsBNNb/9f1OefUXcynlu8pTZXCoAW/oxxGvwRtgVsyt1R8DjoEpYH1ePw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=marvell.com; dmarc=pass action=none header.from=marvell.com;
 dkim=pass header.d=marvell.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=marvell.onmicrosoft.com; s=selector1-marvell-onmicrosoft-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=mW4TBilgOTe5bw6pCHYuRNJDAm4BOVCMzPtN2aAVfh0=;
 b=F/oDBxoGeGwhX6L4mO7yT6BJXKvLVuuCZcsARgTWYCij4IZydpOMyDrE9Gy7jqnkiv7vhqx4gcoiQDD4GvvCawCEFRsjpt0klcJZZO12tsue/YFFEYnYDm7YPs5taQajw8o4yaj6EAMGMQeFQWgx0B/XXnS/mJ6P+RM66GUlQx8=
Received: from DM6PR18MB2844.namprd18.prod.outlook.com (2603:10b6:5:16f::29)
 by MN2PR18MB3624.namprd18.prod.outlook.com (2603:10b6:208:261::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Wed, 7 Jun
 2023 18:13:01 +0000
Received: from DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864]) by DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864%6]) with mapi id 15.20.6477.016; Wed, 7 Jun 2023
 18:13:01 +0000
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
To: Fan Ni <fan.ni@samsung.com>,
        Jonathan Cameron <Jonathan.Cameron@Huawei.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK98n/AAgAAEVoCAAymO8A==
Date: Wed, 7 Jun 2023 18:13:01 +0000
Message-ID: <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
 <20230605175112.GA2290821@bgt-140510-bm03>
In-Reply-To: <20230605175112.GA2290821@bgt-140510-bm03>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
msip_labels: 
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR18MB2844:EE_|MN2PR18MB3624:EE_
x-ms-office365-filtering-correlation-id: a580ea23-aa3a-46d9-d849-08db6782d486
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: nzeCi7XOSsnLBw7whN3ytF8OKCGPTrxHNC9GJV/h8qAImLOyQEnkXPQHqzpjtndJfiTJ5yVs8W6AZzyoNOYjCqzudPo+rIHwpTC3gnUAhi30hpmPHIb6pHEumuqjBjh/44BupFjfGwF1+sXa5jGA/8lyHSJB5a/moT8uGMSzrPLJSBlLpm/3DH/G4f0jE/IypB3AuPcCcGJRe0xkejTeAY3vANpo02k5YCSzRS6I+AbOCFFsOKU7wryAdf/D5hrCah4aS9c+T7LCwYYOSnIImOkaoTdfQ+ky2Q87a2Q0NIwhoKRHK3dJnFioRhcvB1+SY7tsg184Js23qmHthcQIOAKriHDmQfgSAo/PuG/ZYCp0DW/VqPGefpNcEl5mjdN1bSyb1bgslxDubOvIkoL9P6iPfJbeg55EEie6BClD/qSai9oj0Vp4zEGq/CdOFfDQz4INPuSPxG4UjaqAsPabVCqJVpCIVP696JWzUVSE/0vK6hWTIswjbKUlEOvCHNbC5Y5KKUhm1VpY2CoktsbysBbRXkBxtr7iWO/QzyBOxfaG/3ZAJtS5Y8iX92leHfQZJqLcIsdRJQZElqD7sSmf5yeAV1DoTAcqZuyLnq8Iq5POKhp24BWOc22bajVCUyFL92kLqzJ318DbIOSKvLp9vg==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR18MB2844.namprd18.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(39860400002)(366004)(376002)(396003)(346002)(136003)(451199021)(6506007)(53546011)(26005)(9686003)(7416002)(52536014)(83380400001)(122000001)(86362001)(2906002)(186003)(33656002)(316002)(55016003)(38070700005)(5660300002)(30864003)(8676002)(8936002)(41300700001)(38100700002)(91956017)(66476007)(66556008)(76116006)(66446008)(4326008)(966005)(66946007)(110136005)(54906003)(64756008)(45080400002)(478600001)(71200400001)(7696005);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?iso-8859-1?Q?ho42Q4yMm1OASFQ7wIqKnIgLe1KJxFkxA8eNgfS/TAFJOFyrtiIIpqMf8l?=
 =?iso-8859-1?Q?zlquDnoA+ZNkRmsB3dOd1+g5sSOP2aT9sIY1uie4o7gSgfqbE3eWHtGLL1?=
 =?iso-8859-1?Q?JqhvSCWD2Y0odS2RVP1byaepoxAAtTAD2OFhOsds79zymnyLBsdQj8XYvF?=
 =?iso-8859-1?Q?C/Z+3W2RPN4PjgLhEIp2j4f/WROwmSNZVuNLTrwMOONvkZubBvgnfT7RMz?=
 =?iso-8859-1?Q?Pdw/dGLbGZWQCU4aEVjozPlywt929qriK4e7Rjrq9fDySdhtah4IRQ6HMj?=
 =?iso-8859-1?Q?2sf8bPXtkh4oGhJFGsD7n32tVVeusqniT7/oFJ9nVQq8qWZmHrP4w+DjZo?=
 =?iso-8859-1?Q?gFD7tUvKIENS+roSNqCQmRgyhJnUSNLSwCuZzPZq68qKO0F+AggncnjaWv?=
 =?iso-8859-1?Q?vRc94bIt3T4FvoEmCkBvjyGXet+uYfLnHITb89RZuQxzWrTtsyBB3RRP+U?=
 =?iso-8859-1?Q?3LoWhD+1OOOGEMeCaZm4DHo3WK58lwOkQFRs80MfEiM5FqqiIk9rdp8j7s?=
 =?iso-8859-1?Q?YUDDPUw2FrUUUZ4Xz2Gn3IUY1WJyVIClNbUNHXeVWU5gVt25ATpsdXt/JJ?=
 =?iso-8859-1?Q?EgfGH7Fq65RquU2MPlymH8KWKNr6SxryG2wv1wgd/WyysYnpeHsIpzC+y5?=
 =?iso-8859-1?Q?7sg6pT5NH/X01RZAKDaxfhp0vLk3LCOYynmw4sDXYO+Rz6gCBrheHhl6SA?=
 =?iso-8859-1?Q?QGLHxSaeoapkS1ZsmTzzM2Aot1Vx3n49hkUZLE4Bs/bSTLN3xOZ1/pb2Zx?=
 =?iso-8859-1?Q?uhze24WuyU3xNWkikSTUpwpjYcMCL5IN5WQze4TTWaQGcKnYdFMCZMgh0Y?=
 =?iso-8859-1?Q?Vys8e30F5F5jtVNl1tTjHXJ6fommB0RCb8s/62g1f+LZh5iT9IW2hXhF9F?=
 =?iso-8859-1?Q?4+nWLlhY5q+RxnsadbGoGoLs6CnJEGaMN7BTHUFxaCmsjPLFIILPwLx/1s?=
 =?iso-8859-1?Q?GzjggpxvMBNDflLpk2szzMiZXxV907uC62KP4JVhFngA59KUzbPESCiL0j?=
 =?iso-8859-1?Q?tpBSeQPodoV9zPIALJdHapgMM5gSLqCi8jSuv9WEUwSbizErLL3ioBBzzr?=
 =?iso-8859-1?Q?IOmvYRIj+AkvgrnQmrEX6bGI4O2ORMAEeC44tayKbQ1V7CuLu0K7TSqacR?=
 =?iso-8859-1?Q?BGusOyxH9BlOOqFOj22IMJrrT/G65IHHrU0/AIj0JFDsdJNJ8JbPPARdrC?=
 =?iso-8859-1?Q?lp0gi8NQKURLq/FpJLDyO27TAKloMlRT1EwKrlV7AYmMpQDkLOlNpvh99g?=
 =?iso-8859-1?Q?U9junjvCaoN2+SNNQZaM4/s/6OKhM2lqUKxwCDBq6r95ONM8GlTt49jpH+?=
 =?iso-8859-1?Q?YjcFXG5VadlodxysmGJpjKfFue35UteSrbwVc+6lxxbGxnK0F3NBQacz/u?=
 =?iso-8859-1?Q?0Y1DtX01cYCdu/OkNuPt1jG4Id9Mgup5Wa34vayrqfiGxyD1azG0BSLisg?=
 =?iso-8859-1?Q?RK2zJbZRwm59AYtIh/1XZ9xrQsM6ZXtEJFUK5PTI9U8yF+E3jL1E/1Ahoa?=
 =?iso-8859-1?Q?G+zgJXeCBv08+4dAeKY/avfdEYaKsMNeUw3cysHK3b6hVhQBy4sDZuB2S8?=
 =?iso-8859-1?Q?dTYTxwm7tZuqxu7to+BfksXMjTeoWJoianlYgaj9kVYlRmHg+2OAQ+n6C6?=
 =?iso-8859-1?Q?brpstqnLeoYmL/wv3VKMdxgHsjiIlnaCHq?=
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: marvell.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR18MB2844.namprd18.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: a580ea23-aa3a-46d9-d849-08db6782d486
X-MS-Exchange-CrossTenant-originalarrivaltime: 07 Jun 2023 18:13:01.1983
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 70e1fb47-1155-421d-87fc-2e58f638b6e0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: qcxsrM5bbSxk06WV64CxM3ssgf/YGBvsI1JHFUAsb7SbV0tcRk/hGQmhSQawal23rlzOqhZxU5wIY7gkD0F0Xw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN2PR18MB3624
X-Proofpoint-ORIG-GUID: fBJxay3rNmkMSkP_J1TnmH8SEATLKHFU
X-Proofpoint-GUID: _PUDY8uDdLFL1xHMZCmgoE_dsSFnuCdE
X-Proofpoint-Virus-Version: vendor=baseguard
 engine=ICAP:2.0.254,Aquarius:18.0.957,Hydra:6.0.573,FMLib:17.11.176.26
 definitions=2023-06-07_09,2023-06-07_01,2023-05-22_02
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 15956
Lines: 368

Hi Fan,=0A=
   I am implementing DCD FMAPI commands and planning to start pushing chang=
es to the below branch. That requires the contributions you have made. Can =
your changes be pushed to the below branch ?=0A=
=0A=
https://gitlab.com/jic23/qemu/-/tree/cxl-2023-05-25=0A=
=0A=
=0A=
From: Fan Ni <fan.ni@samsung.com>=0A=
Sent: Monday, June 5, 2023 10:51 AM=0A=
To: Ira Weiny <ira.weiny@intel.com>=0A=
Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@huawei.=
com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl@vge=
r.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; hch=
kuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.c=
om <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@inte=
l.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave=
@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifa=
n@outlook.com <nifan@outlook.com>=0A=
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =0A=
=A0=0A=
On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:=0A=
> Fan Ni wrote:=0A=
> > Since the early draft of DCD support in kernel is out=0A=
> > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/20230417=
164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiG=
sqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGNOk$ =
),=0A=
> > this patch series provide dcd emulation in qemu so people who are inter=
ested=0A=
> > can have an early try. It is noted that the patch series may need to be=
 updated=0A=
> > accordingly if the kernel side implementation changes.=0A=
> =0A=
> Fan,=0A=
> =0A=
> Do you have a git tree we can pull this from which is updated to a more=
=0A=
> recent CXL branch from Jonathan?=0A=
> =0A=
> Thanks,=0A=
> Ira=0A=
=0A=
Hi Ira,=0A=
=0A=
I have a git tree of the patch series based on Jonathan's branch=0A=
cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__gith=
ub.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=3DDwIFAg&c=3DnKjWec2b6R0mOyPaz7xt=
fQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3Dw6dicn5kXEG4Imk6TpIC=
IjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3D3yeO9RN5FY3gPfO2y19X057Yeq=
RTTQTQNfNA-Gfir_Q&e=3D .=0A=
=0A=
That may be not new enough to include some of the recent patches, but I can=
=0A=
rebase it to a newer branch if you can tell me which branch you want to use=
.=0A=
=0A=
Thanks,=0A=
Fan=0A=
=0A=
> =0A=
> > =0A=
> > To support DCD emulation, the patch series add DCD related mailbox comm=
and=0A=
> > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory devi=
ce=0A=
> > with dynamic capacity extent and region representative.=0A=
> > To support read/write to the dynamic capacity of the device, a host bac=
kend=0A=
> > is provided and necessary check mechnism is added to ensure the dynamic=
=0A=
> > capacity accessed is backed with active dc extents.=0A=
> > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not su=
pported=0A=
> > , but we add two qmp interfaces for adding/releasing dynamic capacity e=
xtents.=0A=
> > Also, the support for multiple hosts sharing the same DCD case is missi=
ng.=0A=
> > =0A=
> > Things we can try with the patch series together with kernel dcd code:=
=0A=
> > 1. Create DC regions to cover the address range of the dynamic capacity=
=0A=
> > regions.=0A=
> > 2. Add/release dynamic capacity extents to the device and notify the=0A=
> > kernel.=0A=
> > 3. Test kernel side code to accept added dc extents and create dax devi=
ces,=0A=
> > and release dc extents and notify the device=0A=
> > 4. Online the memory range backed with dc extents and let application u=
se=0A=
> > them.=0A=
> > =0A=
> > The patch series is based on Jonathan's local qemu branch:=0A=
> > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-20=
23-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFd=
wKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$ =0A=
> > =0A=
> > Simple tests peformed with the patch series:=0A=
> > 1 Install cxl modules:=0A=
> > =0A=
> > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem=0A=
> > =0A=
> > 2 Create dc regions:=0A=
> > =0A=
> > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)=0A=
> > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region=0A=
> > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity=0A=
> > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways=0A=
> > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode=0A=
> > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size=0A=
> > echo 0x10000000 > /sys/bus/cxl/devices/$region/size=0A=
> > echo=A0 "decoder2.0" > /sys/bus/cxl/devices/$region/target0=0A=
> > echo 1 > /sys/bus/cxl/devices/$region/commit=0A=
> > echo $region > /sys/bus/cxl/drivers/cxl_region/bind=0A=
> > =0A=
> > /home/fan/cxl/tools-and-scripts# cxl list=0A=
> > [=0A=
> >=A0=A0 {=0A=
> >=A0=A0=A0=A0 "memdevs":[=0A=
> >=A0=A0=A0=A0=A0=A0 {=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "memdev":"mem0",=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "pmem_size":536870912,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "ram_size":0,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "serial":0,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "host":"0000:0d:00.0"=0A=
> >=A0=A0=A0=A0=A0=A0 }=0A=
> >=A0=A0=A0=A0 ]=0A=
> >=A0=A0 },=0A=
> >=A0=A0 {=0A=
> >=A0=A0=A0=A0 "regions":[=0A=
> >=A0=A0=A0=A0=A0=A0 {=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "region":"region0",=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "resource":45365592064,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "size":268435456,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_ways":1,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_granularity":256,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0 "decode_state":"commit"=0A=
> >=A0=A0=A0=A0=A0=A0 }=0A=
> >=A0=A0=A0=A0 ]=0A=
> >=A0=A0 }=0A=
> > ]=0A=
> > =0A=
> > 3 Add two dc extents (128MB each) through qmp interface=0A=
> > =0A=
> > { "execute": "qmp_capabilities" }=0A=
> > =0A=
> > { "execute": "cxl-add-dynamic-capacity-event",=0A=
> >=A0=A0=A0=A0=A0 "arguments": {=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "path": "/machine/peripheral/=
cxl-pmem0",=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "region-id" : 0,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "num-extent": 2,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "dpa":0,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "extent-len": 128=0A=
> >=A0=A0=A0=A0=A0 }=0A=
> > }=0A=
> > =0A=
> > /home/fan/cxl/tools-and-scripts# lsmem=0A=
> > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE=A0=A0 BLOCK=0A=
> > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0=A0 0-15=0A=
> > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0 32-79=0A=
> > 0x0000000a90000000-0x0000000a9fffffff=A0 256M offline=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0 338-339=0A=
> > =0A=
> > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > Total online memory:=A0=A0=A0=A0=A0=A0 8G=0A=
> > Total offline memory:=A0=A0=A0 256M=0A=
> > =0A=
> > =0A=
> > 4.Online the momory with 'daxctl online-memory dax0.0' to online the me=
mory=0A=
> > =0A=
> > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0=0A=
> > [=A0 230.730553] Fallback order for Node 0: 0 1=0A=
> > [=A0 230.730825] Fallback order for Node 1: 1 0=0A=
> > [=A0 230.730953] Built 2 zonelists, mobility grouping on.=A0 Total page=
s: 2042541=0A=
> > [=A0 230.731110] Policy zone: Normal=0A=
> > onlined memory for 1 device=0A=
> > =0A=
> > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem=0A=
> > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE BLOCK=0A=
> > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0 0-15=0A=
> > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=A0=
=A0=A0 yes 32-79=0A=
> > 0x0000000a90000000-0x0000000a97ffffff=A0 128M=A0 online=A0=A0=A0=A0=A0=
=A0 yes=A0=A0 338=0A=
> > 0x0000000a98000000-0x0000000a9fffffff=A0 128M offline=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0 339=0A=
> > =0A=
> > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > Total online memory:=A0=A0=A0=A0 8.1G=0A=
> > Total offline memory:=A0=A0=A0 128M=0A=
> > =0A=
> > 5 using dc extents as regular memory=0A=
> > =0A=
> > /home/fan/cxl/ndctl# numactl --membind=3D1 ls=0A=
> > CONTRIBUTING.md=A0 README.md=A0 clean_config.sh=A0 cscope.out=A0=A0 git=
-version-gen=0A=
> > ndctl=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 scripts=A0=A0 test.h=A0=A0=
=A0=A0=A0 version.h.in COPYING=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0 acpi.h=0A=
> > config.h.meson=A0=A0 cxl=A0=A0=A0=A0=A0=A0=A0=A0=A0 make-git-snapshot.s=
h=A0=A0 ndctl.spec.in=A0 sles=A0=A0=A0=A0 tools=0A=
> > Documentation=A0=A0=A0=A0=A0=A0=A0 build=A0=A0=A0=A0=A0=A0 contrib=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 daxctl=A0=A0=A0=A0=A0=A0=A0 meson.build=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 rhel=0A=
> > tags=A0=A0=A0=A0=A0=A0=A0 topology.png LICENSES=A0=A0=A0 ccan=A0=A0=A0=
=A0=A0=A0=A0 cscope.files=0A=
> > git-version=A0 meson_options.txt=A0=A0=A0=A0=A0 rpmbuild.sh=A0=A0=A0 te=
st=A0=A0=A0=A0 util=0A=
> > =0A=
> > =0A=
> > QEMU command line cxl configuration:=0A=
> > =0A=
> > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=3D=
/tmp/cxltest.raw,size=3D512M \=0A=
> > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/cx=
ltest2.raw,size=3D512M \=0A=
> > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/ls=
a.raw,size=3D512M \=0A=
> > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \=0A=
> > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \=0A=
> > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,dc=
-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\=0A=
> > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleave=
-granularity=3D8k"=0A=
> > =0A=
> > =0A=
> > Kernel DCD support used to test the changes=0A=
> > =0A=
> > The code is tested with the posted kernel dcd support:=0A=
> > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/kernel=
/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJBm!RH=
zXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21q=
5Iza3M$ =0A=
> > =0A=
> > commit: f425bc34c600e2a3721d6560202962ec41622815=0A=
> > =0A=
> > To make the test work, we have made the following changes to the above =
kernel commit:=0A=
> > =0A=
> > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c=0A=
> > index 5f04bbc18af5..5f421d3c5cef 100644=0A=
> > --- a/drivers/cxl/core/mbox.c=0A=
> > +++ b/drivers/cxl/core/mbox.c=0A=
> > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_ME=
M_COMMAND_ID_MAX] =3D {=0A=
> >=A0=A0=A0=A0=A0 CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),=0A=
> >=A0=A0=A0=A0=A0 CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),=0A=
> >=A0=A0=A0=A0=A0 CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0=
),=0A=
> > +=A0=A0 CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),=0A=
> >=A0 };=0A=
> >=A0 =0A=
> >=A0 /*=0A=
> > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c=0A=
> > index 291c716abd49..ae10e3cf43a1 100644=0A=
> > --- a/drivers/cxl/core/region.c=0A=
> > +++ b/drivers/cxl/core/region.c=0A=
> > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *=
cxlr)=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 }=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 cxlds->dc_list_gen_num =3D exten=
t_gen_num;=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_dbg(cxlds->dev, "No of preal=
located extents :%d\n", rc);=0A=
> > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 enable_irq(cxlds->cxl_irq[CXL_EVENT_TYP=
E_DCD]);=0A=
> > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 /*enable_irq(cxlds->cxl_irq[CXL_EVENT_T=
YPE_DCD]);*/=0A=
> >=A0=A0=A0=A0=A0 }=0A=
> >=A0=A0=A0=A0=A0 return 0;=0A=
> >=A0 err:=0A=
> > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds=
, struct resource *alloc_dpa_re=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0 dev_dax->align, memremap_compat_align()))) {=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rc =3D alloc_dev_dax_range(dev_d=
ax, hpa,=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 resource_size(alloc_dpa_res));=0A=
> > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (rc)=0A=
> > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> >=A0=A0=A0=A0=A0 }=0A=
> >=A0 =0A=
> >=A0=A0=A0=A0=A0 rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, G=
FP_KERNEL);=0A=
> > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c=0A=
> > index 9e45b1056022..653bec203838 100644=0A=
> > --- a/drivers/cxl/pci.c=0A=
> > +++ b/drivers/cxl/pci.c=0A=
> > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state =
*cxlds)=0A=
> >=A0 =0A=
> >=A0=A0=A0=A0=A0 /* Driver enables DCD interrupt after creating the dc cx=
l_region */=0A=
> >=A0=A0=A0=A0=A0 rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings, =
CXL_EVENT_TYPE_DCD,=0A=
> > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTO=
EN);=0A=
> > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT);=0A=
> >=A0=A0=A0=A0=A0 if (rc) {=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_err(cxlds->dev, "Failed to g=
et interrupt for event dc log\n");=0A=
> >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.=
h=0A=
> > index 6ca85861750c..910a48259239 100644=0A=
> > --- a/include/uapi/linux/cxl_mem.h=0A=
> > +++ b/include/uapi/linux/cxl_mem.h=0A=
> > @@ -47,6 +47,7 @@=0A=
> >=A0=A0=A0=A0=A0 ___C(SCAN_MEDIA, "Scan Media"),=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0 \=0A=
> >=A0=A0=A0=A0=A0 ___C(GET_SCAN_MEDIA, "Get Scan Media Results"),=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> >=A0=A0=A0=A0=A0 ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents")=
,=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > +=A0=A0 ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),=A0=
=A0=A0=A0=A0=A0=A0=A0 \=0A=
> >=A0=A0=A0=A0=A0 ___C(MAX, "invalid / last command")=0A=
> >=A0 =0A=
> >=A0 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a=0A=
> > =0A=
> > =0A=
> > =0A=
> > Fan Ni (7):=0A=
> >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output=
=0A=
> >=A0=A0=A0=A0 payload of identify memory device command=0A=
> >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representat=
ive=0A=
> >=A0=A0=A0=A0 and mailbox command support=0A=
> >=A0=A0 hw/mem/cxl_type3: Add a parameter to pass number of DC regions th=
e=0A=
> >=A0=A0=A0=A0 device supports in qemu command line=0A=
> >=A0=A0 hw/mem/cxl_type3: Add DC extent representative to cxl type3 devic=
e=0A=
> >=A0=A0 hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/rel=
ease=0A=
> >=A0=A0=A0=A0 dynamic capacity response=0A=
> >=A0=A0 Add qmp interfaces to add/release dynamic capacity extents=0A=
> >=A0=A0 hw/mem/cxl_type3: add read/write support to dynamic capacity=0A=
> > =0A=
> >=A0 hw/cxl/cxl-mailbox-utils.c=A0 | 389 +++++++++++++++++++++++++++-=0A=
> >=A0 hw/mem/cxl_type3.c=A0=A0=A0=A0=A0=A0=A0=A0=A0 | 492 ++++++++++++++++=
+++++++++++++++-----=0A=
> >=A0 include/hw/cxl/cxl_device.h |=A0 50 +++-=0A=
> >=A0 include/hw/cxl/cxl_events.h |=A0 16 ++=0A=
> >=A0 qapi/cxl.json=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 |=A0 44 ++++=
=0A=
> >=A0 5 files changed, 924 insertions(+), 67 deletions(-)=0A=
> > =0A=
> > -- =0A=
> > 2.25.1=0A=
> =0A=
> =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DAC60C7EE23
	for <linux-cxl@archiver.kernel.org>; Wed,  7 Jun 2023 18:53:39 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232822AbjFGSxi (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Wed, 7 Jun 2023 14:53:38 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60180 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229642AbjFGSxh (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Wed, 7 Jun 2023 14:53:37 -0400
Received: from mx0b-0016f401.pphosted.com (mx0b-0016f401.pphosted.com [67.231.156.173])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 92EAF1FE9
        for <linux-cxl@vger.kernel.org>; Wed,  7 Jun 2023 11:53:33 -0700 (PDT)
Received: from pps.filterd (m0045851.ppops.net [127.0.0.1])
        by mx0b-0016f401.pphosted.com (8.17.1.19/8.17.1.19) with ESMTP id 357I71eQ019896;
        Wed, 7 Jun 2023 11:52:21 -0700
Received: from pps.reinject (localhost [127.0.0.1])
        by mx0b-0016f401.pphosted.com (PPS) with ESMTPS id 3r2a75bwks-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Wed, 07 Jun 2023 11:52:21 -0700
Received: from m0045851.ppops.net (m0045851.ppops.net [127.0.0.1])
        by pps.reinject (8.17.1.5/8.17.1.5) with ESMTP id 357IlNWM011285;
        Wed, 7 Jun 2023 11:52:20 -0700
Received: from nam10-mw2-obe.outbound.protection.outlook.com (mail-mw2nam10lp2107.outbound.protection.outlook.com [104.47.55.107])
        by mx0b-0016f401.pphosted.com (PPS) with ESMTPS id 3r2a75bwkp-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Wed, 07 Jun 2023 11:52:20 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=g/0P6OLIEefTXn+ZIwA7g/SEhi4czSiRzEszghKJv5i5NuiloKZGPiE6eV6VPv0Uk8OtkEChq0AZr7rk03MMhsmcMMziEfmbiAi69qRfRHVTD/LNiNJZ9mKz4c20q4FFH7sObsrWvHem42/lgBTsKBWQFS5NT+DNfghgTi0632v7EYRWZ3UIqbenu161A3dRnCOzzeMwdWa5wg/A9Ss1V/LqhCtoXLE2VMd1hUH66iSjyCXko5o1XFwmM//kN7PLk85Xclyi1MoaaPYpeA5fLVgcaQSDnrq0jw6Aeeq82dIwoqoDPGtzJpB9jAfYbba9l3GgLweyPv9Hs0xTmfSdgw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=WcZWpz/VPxsxHy71F0pqJBtCL0c+ZN//F8E/UnBe8Jw=;
 b=AXIKl8FFarQEyjv2Q+Ryo4ym2+M2OLclfK1Tv5V0tfvNoHkWIYjVbe+i+KO3laTMPYHnRhvP8Nsd4iCyAT49wWNRsUDFSPaWz4GRM5v6V06FKoETsTv5KCVwWUqZQYPWqEMb8ej4DQsPBPYZvwyiJ+NvphUV+zaWwOzQQ7zL0kMkGLNpUCbCjb4ZvjlnExsXzBLrasdKTD/XfdnwHXxJdr0e5r6hMuuDTZNgH6nCykEbLJvTVAC23cz01Hy0qH8wOZMQgJDsqnrTF8M4VCaopBc50QTIuE9REW12djxAru8NKahOI9ap8CfFbXavaJHi9pvMzjIbABhIXqVJNbca2Q==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=marvell.com; dmarc=pass action=none header.from=marvell.com;
 dkim=pass header.d=marvell.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=marvell.onmicrosoft.com; s=selector1-marvell-onmicrosoft-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=WcZWpz/VPxsxHy71F0pqJBtCL0c+ZN//F8E/UnBe8Jw=;
 b=oXBeutEQvoCodAGKgGo6lN416eutTPaJHgFyjOu4QZXQlkrCDnxxSxvxHK2UvFzmqtSwrLj8DuJNiMIlFecAYRDMylcoANfDILgyUQ8DSF5Y7ju2zrT90qXf9wiB0LlAp8PYoLIrBFRui9Y7lpMiINhCOXuIiiBImdr6UdXQp4s=
Received: from DM6PR18MB2844.namprd18.prod.outlook.com (2603:10b6:5:16f::29)
 by SA3PR18MB5392.namprd18.prod.outlook.com (2603:10b6:806:2f4::9) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Wed, 7 Jun
 2023 18:52:16 +0000
Received: from DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864]) by DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864%6]) with mapi id 15.20.6477.016; Wed, 7 Jun 2023
 18:52:15 +0000
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
To: Fan Ni <fan.ni@samsung.com>
CC: Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK98n/AAgAAEVoCAAymO8IAABjkAgAAFXhI=
Date: Wed, 7 Jun 2023 18:52:14 +0000
Message-ID: <DM6PR18MB284486E36310719093C8A6D6AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
        <20230605175112.GA2290821@bgt-140510-bm03>
        <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <20230607183059.GA2354376@bgt-140510-bm03>
In-Reply-To: <20230607183059.GA2354376@bgt-140510-bm03>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
msip_labels: 
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR18MB2844:EE_|SA3PR18MB5392:EE_
x-ms-office365-filtering-correlation-id: 754734a0-dd6c-4afa-b23a-08db67884f7c
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: 4oQjpSeI3Udabn1hVJ8vkTQ6TjLYb0I7IGsL1JzGHoLxQ2A/b8aaPEtjh6VDK1NKVxBjknDjMOMWS4Rlo1yz/FqmBUDsbBHtr/1cxMwOxZcvWtoNgdN+PunOK/TaxQbRg+yTivaZQs9o6HmL3PjDntBGHXrYXVNXTx5nK0KYADycU5TW+7Qd+7O5KH3vKbSP98XQU+CqpYEbGm1WWNj0xoTM0+v7jChc/StK2eKG2HopuBwOfwJLU4FwN+iGj2+zTXes2t0vZQ+rtJy6ujL6/4Bllnd2Cw0xM2y9isdA4z39PeYxdlHC5rU9jCsRRe5L2LJF+NY65leXtrc11J6oMxkdfTe9mWQ9bg38O3Dhb9lvGdbU90IRG1DoivcyUqIQyE7DpetuEbfbKOaBNMSFzNCFGpE1kcC+99Kv6pmQ2EryWr7ZHL8c8meXK6FbQmhWUnftTgvbwKDjMk+wBwPu5sILizi7PVWtvIQVf1kAbSTuFaw99MtAOtF6WCBpPtLcGPPOYJvThk0QXbi3glousSlXRRz/FkZgTH8hPTc61XeFjh3aIgaLUEWpX/frG7mv9wCTcbW3Uiu1bzKk/LwDcU0rQnlDjMv7Y3TiktP8aAIeX0Mg3McItrLLYzaNOKRRFbauRMDbbzURGLfK4BReGA==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR18MB2844.namprd18.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(396003)(136003)(366004)(376002)(346002)(39860400002)(451199021)(478600001)(7696005)(45080400002)(71200400001)(186003)(54906003)(966005)(26005)(6506007)(53546011)(9686003)(2906002)(30864003)(7416002)(66556008)(33656002)(83380400001)(55016003)(38100700002)(4326008)(6916009)(122000001)(91956017)(66476007)(66946007)(76116006)(52536014)(66446008)(8676002)(86362001)(5660300002)(8936002)(64756008)(316002)(38070700005)(41300700001);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?iso-8859-1?Q?abUutJ5bGnJte9m8hsg1z3O0e/PEk0dYf59DQORkARIoWcdreTEr6FtceX?=
 =?iso-8859-1?Q?ZnKda7vwtJxFdGc1CpZQgs5EDScrPaeVZcFHH24ueMP4ETLhrAjL+e8+aL?=
 =?iso-8859-1?Q?MXkUae21fdf1757gVwjuSI1rn62DHvm7OZ0mKGDfySbmX9tsa4r0IWSIWL?=
 =?iso-8859-1?Q?Al3nhnVO0oTG4M0x+3pTVRtIvVqIojh8KZWYrhoXWfTj/Z9FCuTAaTVa5D?=
 =?iso-8859-1?Q?Zqin7v7qKQK5te6gGC8eljHfyL/IRhQ0PlKBhx/m1lU8aJuvU4R9mlI2+1?=
 =?iso-8859-1?Q?4FlH43L9lj3pa+vcjiFEhRjmk3+2dRNJTZoA7S/YUl7uWvsOY0T6xxMw95?=
 =?iso-8859-1?Q?McEsrFhHxmXdARcZ2LdRFmqBVHESvCIy6+fZUHOUKoIA6gXHYwLK1pwaOc?=
 =?iso-8859-1?Q?6z3zO9WT8sq55O8EB4AG/QT/9tSX8PNRfEAD0RO1atm1znXIXBw8lqY7bn?=
 =?iso-8859-1?Q?RNJz7JhcSFQqWqUb3XITKlZ+h6x5aSniTTK2Lz0EMrG3idG6CJ2Z2fR39p?=
 =?iso-8859-1?Q?H4YS0d/wTdcYbGma8aHQu3SQ07vAiVP43cmhAwp7rqGgVUP/9tSKhkD78h?=
 =?iso-8859-1?Q?13FmsTosqkXP7vBYUDJ1WgoUnLNYMynMbfwEWj1zP8y6wrwVu0GnshH6ZN?=
 =?iso-8859-1?Q?rzWNnZQg8cp+YKCM4eVHnZq6eNFdTtIbxtx4jWQs8YJM3Ef4Ssyai2Sgii?=
 =?iso-8859-1?Q?98fuqz8ePYWlcfh0urcab28abBUKiH/ITDeoSLoxi/rc3e6J2X7I6nnMMt?=
 =?iso-8859-1?Q?K7jCdpYDKY7lkVTyWLWXNOUt5Ewn+kImRcpqNwLEnofiLG0bnvDNdyeuR0?=
 =?iso-8859-1?Q?YS8npLAI24YkzOZKbWHY5g0gYbHA0LcnrOQkWPzRGVcNuomZL0CIHX4duK?=
 =?iso-8859-1?Q?04f6gNU+VzfSOgd1LQO8hvA8nx1EOgXBEp/aUY46gxWK9OLmjA5ehJBhEA?=
 =?iso-8859-1?Q?LL7g5qU2VMMH2cVN9A4aNjZ9Xf3iXDcge/9vUiPE+9qxcUwMzQsxzI/2OK?=
 =?iso-8859-1?Q?7HuBWWAPgRRH6+3oelb1QRlIxCpk3sXrIz0HjZkexXOSGtLFlhvvuc7wW4?=
 =?iso-8859-1?Q?3/7jRm2ltcXP/2yGegQqWv1hrBfsNb5krstQkgV1mbzzWEIdTQfvY1Eiak?=
 =?iso-8859-1?Q?Vg6c1k3O7nkc6apCJ4dWakZRGYWei2tzk9f081FNG1LSiXfzZBstEv1vA6?=
 =?iso-8859-1?Q?Jb8aA3/BYNb1RrStSrT7VJZlbIOwOHt5Mwj1/zPMjZV5RpT+cZxhGnK0gV?=
 =?iso-8859-1?Q?Q90bNhBnSNnScmD3m9NER29DlwTdvxhQcDeT1BBIDMgyMBzv7FXjylBFXB?=
 =?iso-8859-1?Q?vTD43ueg5JkQCfdt5FyidWdT6I+3J5kxj2S6rzr/CS9E32a2m0z35KoMLV?=
 =?iso-8859-1?Q?OESHBXPUXQntzDJonrtUIhcY/8+2+XjMI7/eN0JFPMAle78ohLf7NBALIP?=
 =?iso-8859-1?Q?TZXR9sdJGOWFktGHzu7PnPoSd1GZEZEAK8GAuG/e8/sLclplk+iW9DNSKv?=
 =?iso-8859-1?Q?UGapKcvUkE91TUMN/ocJpLgS3K8TXI3U5+tlOAJKGhwX8cPVsOmLsXP5GN?=
 =?iso-8859-1?Q?OI1FOd81BvKhPmhorShezhzHLf8mDTQTaTvpLEMVqj/uqOtdlISNWVtrBA?=
 =?iso-8859-1?Q?xDkN8Br6Mjdro8fTL93rsvPB95mjXoLnr+?=
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: marvell.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR18MB2844.namprd18.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 754734a0-dd6c-4afa-b23a-08db67884f7c
X-MS-Exchange-CrossTenant-originalarrivaltime: 07 Jun 2023 18:52:14.9393
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 70e1fb47-1155-421d-87fc-2e58f638b6e0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: LpRMCUj0cnQEXdnz1xqHbeUbHpkJGTMPQlkCpjJ24aszNlnW251y5+7sZ5QEmY5rfk1iy/Q3Hs4ykPHyGGcwsQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA3PR18MB5392
X-Proofpoint-ORIG-GUID: zZcFSZ2jsmOJIsk4N7ith8KUWbcFpzZ4
X-Proofpoint-GUID: Soffke7rSpYedCNNTteIREYQoUSbNJzu
X-Proofpoint-Virus-Version: vendor=baseguard
 engine=ICAP:2.0.254,Aquarius:18.0.957,Hydra:6.0.573,FMLib:17.11.176.26
 definitions=2023-06-07_10,2023-06-07_01,2023-05-22_02
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 18123
Lines: 411

=0A=
=0A=
=0A=
From: Fan Ni <fan.ni@samsung.com>=0A=
Sent: Wednesday, June 7, 2023 11:31 AM=0A=
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>; qemu-devel@nongnu.org <=
qemu-devel@nongnu.org>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.or=
g>; gregory.price@memverge.com <gregory.price@memverge.com>; hchkuo@avery-d=
esign.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@=
avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.com>; Ada=
m Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.n=
et>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.c=
om <nifan@outlook.com>; Ira Weiny <ira.weiny@intel.com>=0A=
Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =
=0A=
=A0=0A=
External Email=0A=
=0A=
----------------------------------------------------------------------=0A=
On Wed, Jun 07, 2023 at 06:13:01PM +0000, Shesha Bhushan Sreenivasamurthy w=
rote:=0A=
> Hi Fan,=0A=
>=A0=A0=A0 I am implementing DCD FMAPI commands and planning to start pushi=
ng changes to the below branch. That requires the contributions you have ma=
de. Can your changes be pushed to the below branch ?=0A=
> =0A=
> https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-2023=
-05-25__;!!EwVzqGoTKBqv-0DWAJBm!Vt5uIqwW-L4c4gh02ulI4M762JNQ3_aE9k9lb6QlwE2=
xm6T23ic7ig7Y77i1VN7l_RX_ySIQhre_z7Q0JA$ =0A=
=0A=
Can you push changes to the branch directly? I think it is Jonathan's priva=
te=0A=
branch. However, I can fork the branch and rebase my patch series atop and=
=0A=
share with you the new repo if that helps you move forward your=0A=
work.=0A=
Let me know your thought.=0A=
=0A=
ss - I saw commits from others, so assumed you can. Since it is Jonathan's =
private repo, I will step back and let him answer.=0A=
=0A=
Fan=0A=
=0A=
> =0A=
> =0A=
> From: Fan Ni <fan.ni@samsung.com>=0A=
> Sent: Monday, June 5, 2023 10:51 AM=0A=
> To: Ira Weiny <ira.weiny@intel.com>=0A=
> Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@huawe=
i.com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl@v=
ger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; h=
chkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design=
.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@in=
tel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <da=
ve@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; ni=
fan@outlook.com <nifan@outlook.com>=0A=
> Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =0A=
> =A0=0A=
> On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:=0A=
> > Fan Ni wrote:=0A=
> > > Since the early draft of DCD support in kernel is out=0A=
> > > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/202304=
17164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcS=
iGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGNOk=
$ ),=0A=
> > > this patch series provide dcd emulation in qemu so people who are int=
erested=0A=
> > > can have an early try. It is noted that the patch series may need to =
be updated=0A=
> > > accordingly if the kernel side implementation changes.=0A=
> > =0A=
> > Fan,=0A=
> > =0A=
> > Do you have a git tree we can pull this from which is updated to a more=
=0A=
> > recent CXL branch from Jonathan?=0A=
> > =0A=
> > Thanks,=0A=
> > Ira=0A=
> =0A=
> Hi Ira,=0A=
> =0A=
> I have a git tree of the patch series based on Jonathan's branch=0A=
> cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__gi=
thub.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=3DDwIFAg&c=3DnKjWec2b6R0mOyPaz7=
xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3Dw6dicn5kXEG4Imk6Tp=
ICIjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3D3yeO9RN5FY3gPfO2y19X057Y=
eqRTTQTQNfNA-Gfir_Q&e=3D .=0A=
> =0A=
> That may be not new enough to include some of the recent patches, but I c=
an=0A=
> rebase it to a newer branch if you can tell me which branch you want to u=
se.=0A=
> =0A=
> Thanks,=0A=
> Fan=0A=
> =0A=
> > =0A=
> > > =0A=
> > > To support DCD emulation, the patch series add DCD related mailbox co=
mmand=0A=
> > > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory de=
vice=0A=
> > > with dynamic capacity extent and region representative.=0A=
> > > To support read/write to the dynamic capacity of the device, a host b=
ackend=0A=
> > > is provided and necessary check mechnism is added to ensure the dynam=
ic=0A=
> > > capacity accessed is backed with active dc extents.=0A=
> > > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not =
supported=0A=
> > > , but we add two qmp interfaces for adding/releasing dynamic capacity=
 extents.=0A=
> > > Also, the support for multiple hosts sharing the same DCD case is mis=
sing.=0A=
> > > =0A=
> > > Things we can try with the patch series together with kernel dcd code=
:=0A=
> > > 1. Create DC regions to cover the address range of the dynamic capaci=
ty=0A=
> > > regions.=0A=
> > > 2. Add/release dynamic capacity extents to the device and notify the=
=0A=
> > > kernel.=0A=
> > > 3. Test kernel side code to accept added dc extents and create dax de=
vices,=0A=
> > > and release dc extents and notify the device=0A=
> > > 4. Online the memory range backed with dc extents and let application=
 use=0A=
> > > them.=0A=
> > > =0A=
> > > The patch series is based on Jonathan's local qemu branch:=0A=
> > > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-=
2023-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeU=
FdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$ =0A=
> > > =0A=
> > > Simple tests peformed with the patch series:=0A=
> > > 1 Install cxl modules:=0A=
> > > =0A=
> > > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem=0A=
> > > =0A=
> > > 2 Create dc regions:=0A=
> > > =0A=
> > > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)=0A=
> > > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region=0A=
> > > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity=0A=
> > > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways=0A=
> > > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode=0A=
> > > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size=0A=
> > > echo 0x10000000 > /sys/bus/cxl/devices/$region/size=0A=
> > > echo=A0 "decoder2.0" > /sys/bus/cxl/devices/$region/target0=0A=
> > > echo 1 > /sys/bus/cxl/devices/$region/commit=0A=
> > > echo $region > /sys/bus/cxl/drivers/cxl_region/bind=0A=
> > > =0A=
> > > /home/fan/cxl/tools-and-scripts# cxl list=0A=
> > > [=0A=
> > >=A0=A0 {=0A=
> > >=A0=A0=A0=A0 "memdevs":[=0A=
> > >=A0=A0=A0=A0=A0=A0 {=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "memdev":"mem0",=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "pmem_size":536870912,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "ram_size":0,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "serial":0,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "host":"0000:0d:00.0"=0A=
> > >=A0=A0=A0=A0=A0=A0 }=0A=
> > >=A0=A0=A0=A0 ]=0A=
> > >=A0=A0 },=0A=
> > >=A0=A0 {=0A=
> > >=A0=A0=A0=A0 "regions":[=0A=
> > >=A0=A0=A0=A0=A0=A0 {=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "region":"region0",=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "resource":45365592064,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "size":268435456,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_ways":1,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_granularity":256,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0 "decode_state":"commit"=0A=
> > >=A0=A0=A0=A0=A0=A0 }=0A=
> > >=A0=A0=A0=A0 ]=0A=
> > >=A0=A0 }=0A=
> > > ]=0A=
> > > =0A=
> > > 3 Add two dc extents (128MB each) through qmp interface=0A=
> > > =0A=
> > > { "execute": "qmp_capabilities" }=0A=
> > > =0A=
> > > { "execute": "cxl-add-dynamic-capacity-event",=0A=
> > >=A0=A0=A0=A0=A0 "arguments": {=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "path": "/machine/periphera=
l/cxl-pmem0",=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "region-id" : 0,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "num-extent": 2,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "dpa":0,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "extent-len": 128=0A=
> > >=A0=A0=A0=A0=A0 }=0A=
> > > }=0A=
> > > =0A=
> > > /home/fan/cxl/tools-and-scripts# lsmem=0A=
> > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE=A0=A0 BLOCK=
=0A=
> > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0=A0=A0 0-15=0A=
> > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0=A0 32-79=0A=
> > > 0x0000000a90000000-0x0000000a9fffffff=A0 256M offline=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0 338-339=0A=
> > > =0A=
> > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > Total online memory:=A0=A0=A0=A0=A0=A0 8G=0A=
> > > Total offline memory:=A0=A0=A0 256M=0A=
> > > =0A=
> > > =0A=
> > > 4.Online the momory with 'daxctl online-memory dax0.0' to online the =
memory=0A=
> > > =0A=
> > > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0=0A=
> > > [=A0 230.730553] Fallback order for Node 0: 0 1=0A=
> > > [=A0 230.730825] Fallback order for Node 1: 1 0=0A=
> > > [=A0 230.730953] Built 2 zonelists, mobility grouping on.=A0 Total pa=
ges: 2042541=0A=
> > > [=A0 230.731110] Policy zone: Normal=0A=
> > > onlined memory for 1 device=0A=
> > > =0A=
> > > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem=0A=
> > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE BLOCK=0A=
> > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=A0=
=A0=A0=A0 yes=A0 0-15=0A=
> > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=A0=
=A0=A0=A0 yes 32-79=0A=
> > > 0x0000000a90000000-0x0000000a97ffffff=A0 128M=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0 338=0A=
> > > 0x0000000a98000000-0x0000000a9fffffff=A0 128M offline=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0 339=0A=
> > > =0A=
> > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > Total online memory:=A0=A0=A0=A0 8.1G=0A=
> > > Total offline memory:=A0=A0=A0 128M=0A=
> > > =0A=
> > > 5 using dc extents as regular memory=0A=
> > > =0A=
> > > /home/fan/cxl/ndctl# numactl --membind=3D1 ls=0A=
> > > CONTRIBUTING.md=A0 README.md=A0 clean_config.sh=A0 cscope.out=A0=A0 g=
it-version-gen=0A=
> > > ndctl=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 scripts=A0=A0 test.h=A0=
=A0=A0=A0=A0 version.h.in COPYING=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 acpi.h=0A=
> > > config.h.meson=A0=A0 cxl=A0=A0=A0=A0=A0=A0=A0=A0=A0 make-git-snapshot=
.sh=A0=A0 ndctl.spec.in=A0 sles=A0=A0=A0=A0 tools=0A=
> > > Documentation=A0=A0=A0=A0=A0=A0=A0 build=A0=A0=A0=A0=A0=A0 contrib=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 daxctl=A0=A0=A0=A0=A0=A0=A0 meson.build=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0 rhel=0A=
> > > tags=A0=A0=A0=A0=A0=A0=A0 topology.png LICENSES=A0=A0=A0 ccan=A0=A0=
=A0=A0=A0=A0=A0 cscope.files=0A=
> > > git-version=A0 meson_options.txt=A0=A0=A0=A0=A0 rpmbuild.sh=A0=A0=A0 =
test=A0=A0=A0=A0 util=0A=
> > > =0A=
> > > =0A=
> > > QEMU command line cxl configuration:=0A=
> > > =0A=
> > > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=
=3D/tmp/cxltest.raw,size=3D512M \=0A=
> > > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/=
cxltest2.raw,size=3D512M \=0A=
> > > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/=
lsa.raw,size=3D512M \=0A=
> > > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \=0A=
> > > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \=0A=
> > > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,=
dc-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\=0A=
> > > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interlea=
ve-granularity=3D8k"=0A=
> > > =0A=
> > > =0A=
> > > Kernel DCD support used to test the changes=0A=
> > > =0A=
> > > The code is tested with the posted kernel dcd support:=0A=
> > > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/kern=
el/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJBm!=
RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr2=
1q5Iza3M$ =0A=
> > > =0A=
> > > commit: f425bc34c600e2a3721d6560202962ec41622815=0A=
> > > =0A=
> > > To make the test work, we have made the following changes to the abov=
e kernel commit:=0A=
> > > =0A=
> > > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c=0A=
> > > index 5f04bbc18af5..5f421d3c5cef 100644=0A=
> > > --- a/drivers/cxl/core/mbox.c=0A=
> > > +++ b/drivers/cxl/core/mbox.c=0A=
> > > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_=
MEM_COMMAND_ID_MAX] =3D {=0A=
> > >=A0=A0=A0=A0=A0 CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),=0A=
> > >=A0=A0=A0=A0=A0 CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),=
=0A=
> > >=A0=A0=A0=A0=A0 CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD,=
 0),=0A=
> > > +=A0=A0 CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),=0A=
> > >=A0 };=0A=
> > >=A0 =0A=
> > >=A0 /*=0A=
> > > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c=0A=
> > > index 291c716abd49..ae10e3cf43a1 100644=0A=
> > > --- a/drivers/cxl/core/region.c=0A=
> > > +++ b/drivers/cxl/core/region.c=0A=
> > > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region=
 *cxlr)=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 }=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 cxlds->dc_list_gen_num =3D ext=
ent_gen_num;=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_dbg(cxlds->dev, "No of pre=
allocated extents :%d\n", rc);=0A=
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 enable_irq(cxlds->cxl_irq[CXL_EVENT_T=
YPE_DCD]);=0A=
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 /*enable_irq(cxlds->cxl_irq[CXL_EVENT=
_TYPE_DCD]);*/=0A=
> > >=A0=A0=A0=A0=A0 }=0A=
> > >=A0=A0=A0=A0=A0 return 0;=0A=
> > >=A0 err:=0A=
> > > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxl=
ds, struct resource *alloc_dpa_re=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0 dev_dax->align, memremap_compat_align()))) {=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rc =3D alloc_dev_dax_range(dev=
_dax, hpa,=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 resource_size(alloc_dpa_res));=
=0A=
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (rc)=0A=
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > >=A0=A0=A0=A0=A0 }=0A=
> > >=A0 =0A=
> > >=A0=A0=A0=A0=A0 rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax,=
 GFP_KERNEL);=0A=
> > > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c=0A=
> > > index 9e45b1056022..653bec203838 100644=0A=
> > > --- a/drivers/cxl/pci.c=0A=
> > > +++ b/drivers/cxl/pci.c=0A=
> > > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_stat=
e *cxlds)=0A=
> > >=A0 =0A=
> > >=A0=A0=A0=A0=A0 /* Driver enables DCD interrupt after creating the dc =
cxl_region */=0A=
> > >=A0=A0=A0=A0=A0 rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings=
, CXL_EVENT_TYPE_DCD,=0A=
> > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_A=
UTOEN);=0A=
> > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT);=0A=
> > >=A0=A0=A0=A0=A0 if (rc) {=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_err(cxlds->dev, "Failed to=
 get interrupt for event dc log\n");=0A=
> > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_me=
m.h=0A=
> > > index 6ca85861750c..910a48259239 100644=0A=
> > > --- a/include/uapi/linux/cxl_mem.h=0A=
> > > +++ b/include/uapi/linux/cxl_mem.h=0A=
> > > @@ -47,6 +47,7 @@=0A=
> > >=A0=A0=A0=A0=A0 ___C(SCAN_MEDIA, "Scan Media"),=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 \=0A=
> > >=A0=A0=A0=A0=A0 ___C(GET_SCAN_MEDIA, "Get Scan Media Results"),=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > >=A0=A0=A0=A0=A0 ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents=
"),=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > +=A0=A0 ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),=A0=
=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > >=A0=A0=A0=A0=A0 ___C(MAX, "invalid / last command")=0A=
> > >=A0 =0A=
> > >=A0 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a=0A=
> > > =0A=
> > > =0A=
> > > =0A=
> > > Fan Ni (7):=0A=
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output=
=0A=
> > >=A0=A0=A0=A0 payload of identify memory device command=0A=
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dynamic capacity region represent=
ative=0A=
> > >=A0=A0=A0=A0 and mailbox command support=0A=
> > >=A0=A0 hw/mem/cxl_type3: Add a parameter to pass number of DC regions =
the=0A=
> > >=A0=A0=A0=A0 device supports in qemu command line=0A=
> > >=A0=A0 hw/mem/cxl_type3: Add DC extent representative to cxl type3 dev=
ice=0A=
> > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/r=
elease=0A=
> > >=A0=A0=A0=A0 dynamic capacity response=0A=
> > >=A0=A0 Add qmp interfaces to add/release dynamic capacity extents=0A=
> > >=A0=A0 hw/mem/cxl_type3: add read/write support to dynamic capacity=0A=
> > > =0A=
> > >=A0 hw/cxl/cxl-mailbox-utils.c=A0 | 389 +++++++++++++++++++++++++++-=
=0A=
> > >=A0 hw/mem/cxl_type3.c=A0=A0=A0=A0=A0=A0=A0=A0=A0 | 492 ++++++++++++++=
+++++++++++++++++-----=0A=
> > >=A0 include/hw/cxl/cxl_device.h |=A0 50 +++-=0A=
> > >=A0 include/hw/cxl/cxl_events.h |=A0 16 ++=0A=
> > >=A0 qapi/cxl.json=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 |=A0 44 ++=
++=0A=
> > >=A0 5 files changed, 924 insertions(+), 67 deletions(-)=0A=
> > > =0A=
> > > -- =0A=
> > > 2.25.1=0A=
> > =0A=
> > =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4A028C7EE29
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Jun 2023 09:43:33 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233016AbjFHJnc convert rfc822-to-8bit (ORCPT
        <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Jun 2023 05:43:32 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:45208 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S235189AbjFHJna (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Jun 2023 05:43:30 -0400
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8296926B6
        for <linux-cxl@vger.kernel.org>; Thu,  8 Jun 2023 02:43:26 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4QcK3M64cSz6GCpY;
        Thu,  8 Jun 2023 17:41:19 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.23; Thu, 8 Jun
 2023 10:43:23 +0100
Date: Thu, 8 Jun 2023 10:43:22 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
CC: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        "Ira Weiny" <ira.weiny@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <20230608104322.0000632f@Huawei.com>
In-Reply-To: <DM6PR18MB284486E36310719093C8A6D6AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
        <20230605175112.GA2290821@bgt-140510-bm03>
        <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
        <20230607183059.GA2354376@bgt-140510-bm03>
        <DM6PR18MB284486E36310719093C8A6D6AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="ISO-8859-1"
Content-Transfer-Encoding: 8BIT
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100005.china.huawei.com (7.191.160.25) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 15820
Lines: 310

On Wed, 7 Jun 2023 18:52:14 +0000
Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com> wrote:

> From: Fan Ni <fan.ni@samsung.com>
> Sent: Wednesday, June 7, 2023 11:31 AM
> To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
> Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>; qemu-devel@nongnu.org <qemu-devel@nongnu.org>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; hchkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.com <nifan@outlook.com>; Ira Weiny <ira.weiny@intel.com>
> Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu 
> 
> External Email
> 
> ----------------------------------------------------------------------
> On Wed, Jun 07, 2023 at 06:13:01PM +0000, Shesha Bhushan Sreenivasamurthy wrote:
> > Hi Fan,
> > I am implementing DCD FMAPI commands and planning to start pushing changes to the below branch. That requires the contributions you have made. Can your changes be pushed to the below branch ?
> > 
> > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-2023-05-25__;!!EwVzqGoTKBqv-0DWAJBm!Vt5uIqwW-L4c4gh02ulI4M762JNQ3_aE9k9lb6QlwE2xm6T23ic7ig7Y77i1VN7l_RX_ySIQhre_z7Q0JA$   
> 
> Can you push changes to the branch directly? I think it is Jonathan's private
> branch. However, I can fork the branch and rebase my patch series atop and
> share with you the new repo if that helps you move forward your
> work.
> Let me know your thought.
> 
> ss - I saw commits from others, so assumed you can. Since it is Jonathan's private repo, I will step back and let him answer.

I tend to apply stuff in manually rather than given more people commit access
to that particular gitlab tree. 

Easiest option is to fork on gitlab and share the path of your own fork.

I normally queue reasonably mature stuff up on my tree, but that's about managing
the series sent with intent of being applied upstream + providing a fairly stable test
branch.  It's not intended as a general place for stuff in development (though I might
sneak out an extra branch myself from time to time if I want to talk about it :)

Jonathan

> 
> Fan
> 
> > 
> > 
> > From: Fan Ni <fan.ni@samsung.com>
> > Sent: Monday, June 5, 2023 10:51 AM
> > To: Ira Weiny <ira.weiny@intel.com>
> > Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@huawei.com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; hchkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.com <nifan@outlook.com>
> > Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu 
> > 
> > On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:  
> > > Fan Ni wrote:  
> > > > Since the early draft of DCD support in kernel is out
> > > > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/20230417164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGNOk$ ),
> > > > this patch series provide dcd emulation in qemu so people who are interested
> > > > can have an early try. It is noted that the patch series may need to be updated
> > > > accordingly if the kernel side implementation changes.  
> > > 
> > > Fan,
> > > 
> > > Do you have a git tree we can pull this from which is updated to a more
> > > recent CXL branch from Jonathan?
> > > 
> > > Thanks,
> > > Ira  
> > 
> > Hi Ira,
> > 
> > I have a git tree of the patch series based on Jonathan's branch
> > cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=https-3A__github.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=DwIFAg&c=nKjWec2b6R0mOyPaz7xtfQ&r=Zta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=w6dicn5kXEG4Imk6TpICIjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3yeO9RN5FY3gPfO2y19X057YeqRTTQTQNfNA-Gfir_Q&e= .
> > 
> > That may be not new enough to include some of the recent patches, but I can
> > rebase it to a newer branch if you can tell me which branch you want to use.
> > 
> > Thanks,
> > Fan
> >   
> > >   
> > > > 
> > > > To support DCD emulation, the patch series add DCD related mailbox command
> > > > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory device
> > > > with dynamic capacity extent and region representative.
> > > > To support read/write to the dynamic capacity of the device, a host backend
> > > > is provided and necessary check mechnism is added to ensure the dynamic
> > > > capacity accessed is backed with active dc extents.
> > > > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not supported
> > > > , but we add two qmp interfaces for adding/releasing dynamic capacity extents.
> > > > Also, the support for multiple hosts sharing the same DCD case is missing.
> > > > 
> > > > Things we can try with the patch series together with kernel dcd code:
> > > > 1. Create DC regions to cover the address range of the dynamic capacity
> > > > regions.
> > > > 2. Add/release dynamic capacity extents to the device and notify the
> > > > kernel.
> > > > 3. Test kernel side code to accept added dc extents and create dax devices,
> > > > and release dc extents and notify the device
> > > > 4. Online the memory range backed with dc extents and let application use
> > > > them.
> > > > 
> > > > The patch series is based on Jonathan's local qemu branch:
> > > > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-2023-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$ 
> > > > 
> > > > Simple tests peformed with the patch series:
> > > > 1 Install cxl modules:
> > > > 
> > > > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem
> > > > 
> > > > 2 Create dc regions:
> > > > 
> > > > region=$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> > > > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> > > > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> > > > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> > > > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> > > > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> > > > echo 0x10000000 > /sys/bus/cxl/devices/$region/size
> > > > echo "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> > > > echo 1 > /sys/bus/cxl/devices/$region/commit
> > > > echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> > > > 
> > > > /home/fan/cxl/tools-and-scripts# cxl list
> > > > [
> > > > {
> > > > "memdevs":[
> > > > {
> > > > "memdev":"mem0",
> > > > "pmem_size":536870912,
> > > > "ram_size":0,
> > > > "serial":0,
> > > > "host":"0000:0d:00.0"
> > > > }
> > > > ]
> > > > },
> > > > {
> > > > "regions":[
> > > > {
> > > > "region":"region0",
> > > > "resource":45365592064,
> > > > "size":268435456,
> > > > "interleave_ways":1,
> > > > "interleave_granularity":256,
> > > > "decode_state":"commit"
> > > > }
> > > > ]
> > > > }
> > > > ]
> > > > 
> > > > 3 Add two dc extents (128MB each) through qmp interface
> > > > 
> > > > { "execute": "qmp_capabilities" }
> > > > 
> > > > { "execute": "cxl-add-dynamic-capacity-event",
> > > > "arguments": {
> > > > "path": "/machine/peripheral/cxl-pmem0",
> > > > "region-id" : 0,
> > > > "num-extent": 2,
> > > > "dpa":0,
> > > > "extent-len": 128
> > > > }
> > > > }
> > > > 
> > > > /home/fan/cxl/tools-and-scripts# lsmem
> > > > RANGE SIZE STATE REMOVABLE BLOCK
> > > > 0x0000000000000000-0x000000007fffffff 2G online yes 0-15
> > > > 0x0000000100000000-0x000000027fffffff 6G online yes 32-79
> > > > 0x0000000a90000000-0x0000000a9fffffff 256M offline 338-339
> > > > 
> > > > Memory block size: 128M
> > > > Total online memory: 8G
> > > > Total offline memory: 256M
> > > > 
> > > > 
> > > > 4.Online the momory with 'daxctl online-memory dax0.0' to online the memory
> > > > 
> > > > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
> > > > [ 230.730553] Fallback order for Node 0: 0 1
> > > > [ 230.730825] Fallback order for Node 1: 1 0
> > > > [ 230.730953] Built 2 zonelists, mobility grouping on. Total pages: 2042541
> > > > [ 230.731110] Policy zone: Normal
> > > > onlined memory for 1 device
> > > > 
> > > > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
> > > > RANGE SIZE STATE REMOVABLE BLOCK
> > > > 0x0000000000000000-0x000000007fffffff 2G online yes 0-15
> > > > 0x0000000100000000-0x000000027fffffff 6G online yes 32-79
> > > > 0x0000000a90000000-0x0000000a97ffffff 128M online yes 338
> > > > 0x0000000a98000000-0x0000000a9fffffff 128M offline 339
> > > > 
> > > > Memory block size: 128M
> > > > Total online memory: 8.1G
> > > > Total offline memory: 128M
> > > > 
> > > > 5 using dc extents as regular memory
> > > > 
> > > > /home/fan/cxl/ndctl# numactl --membind=1 ls
> > > > CONTRIBUTING.md README.md clean_config.sh cscope.out git-version-gen
> > > > ndctl scripts test.h version.h.in COPYING acpi.h
> > > > config.h.meson cxl make-git-snapshot.sh ndctl.spec.in sles tools
> > > > Documentation build contrib daxctl meson.build rhel
> > > > tags topology.png LICENSES ccan cscope.files
> > > > git-version meson_options.txt rpmbuild.sh test util
> > > > 
> > > > 
> > > > QEMU command line cxl configuration:
> > > > 
> > > > RP1="-object memory-backend-file,id=cxl-mem1,share=on,mem-path=/tmp/cxltest.raw,size=512M \
> > > > -object memory-backend-file,id=cxl-mem2,share=on,mem-path=/tmp/cxltest2.raw,size=512M \
> > > > -object memory-backend-file,id=cxl-lsa1,share=on,mem-path=/tmp/lsa.raw,size=512M \
> > > > -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
> > > > -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> > > > -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,dc-memdev=cxl-mem2,id=cxl-pmem0,num-dc-regions=1\
> > > > -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=8k"
> > > > 
> > > > 
> > > > Kernel DCD support used to test the changes
> > > > 
> > > > The code is tested with the posted kernel dcd support:
> > > > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=for-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21q5Iza3M$ 
> > > > 
> > > > commit: f425bc34c600e2a3721d6560202962ec41622815
> > > > 
> > > > To make the test work, we have made the following changes to the above kernel commit:
> > > > 
> > > > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
> > > > index 5f04bbc18af5..5f421d3c5cef 100644
> > > > --- a/drivers/cxl/core/mbox.c
> > > > +++ b/drivers/cxl/core/mbox.c
> > > > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_MEM_COMMAND_ID_MAX] = {
> > > > CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
> > > > CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
> > > > CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
> > > > + CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
> > > > };
> > > > 
> > > > /*
> > > > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
> > > > index 291c716abd49..ae10e3cf43a1 100644
> > > > --- a/drivers/cxl/core/region.c
> > > > +++ b/drivers/cxl/core/region.c
> > > > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *cxlr)
> > > > }
> > > > cxlds->dc_list_gen_num = extent_gen_num;
> > > > dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
> > > > - enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
> > > > + /*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/
> > > > }
> > > > return 0;
> > > > err:
> > > > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds, struct resource *alloc_dpa_re
> > > > dev_dax->align, memremap_compat_align()))) {
> > > > rc = alloc_dev_dax_range(dev_dax, hpa,
> > > > resource_size(alloc_dpa_res));
> > > > - return rc;
> > > > + if (rc)
> > > > + return rc;
> > > > }
> > > > 
> > > > rc = xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);
> > > > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
> > > > index 9e45b1056022..653bec203838 100644
> > > > --- a/drivers/cxl/pci.c
> > > > +++ b/drivers/cxl/pci.c
> > > > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state *cxlds)
> > > > 
> > > > /* Driver enables DCD interrupt after creating the dc cxl_region */
> > > > rc = cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYPE_DCD,
> > > > - IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
> > > > + IRQF_SHARED | IRQF_ONESHOT);
> > > > if (rc) {
> > > > dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
> > > > return rc;
> > > > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.h
> > > > index 6ca85861750c..910a48259239 100644
> > > > --- a/include/uapi/linux/cxl_mem.h
> > > > +++ b/include/uapi/linux/cxl_mem.h
> > > > @@ -47,6 +47,7 @@
> > > > ___C(SCAN_MEDIA, "Scan Media"), \
> > > > ___C(GET_SCAN_MEDIA, "Get Scan Media Results"), \
> > > > ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"), \
> > > > + ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"), \
> > > > ___C(MAX, "invalid / last command")
> > > > 
> > > > #define ___C(a, b) CXL_MEM_COMMAND_ID_##a
> > > > 
> > > > 
> > > > 
> > > > Fan Ni (7):
> > > > hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
> > > > payload of identify memory device command
> > > > hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
> > > > and mailbox command support
> > > > hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
> > > > device supports in qemu command line
> > > > hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
> > > > hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
> > > > dynamic capacity response
> > > > Add qmp interfaces to add/release dynamic capacity extents
> > > > hw/mem/cxl_type3: add read/write support to dynamic capacity
> > > > 
> > > > hw/cxl/cxl-mailbox-utils.c | 389 +++++++++++++++++++++++++++-
> > > > hw/mem/cxl_type3.c | 492 +++++++++++++++++++++++++++++++-----
> > > > include/hw/cxl/cxl_device.h | 50 +++-
> > > > include/hw/cxl/cxl_events.h | 16 ++
> > > > qapi/cxl.json | 44 ++++
> > > > 5 files changed, 924 insertions(+), 67 deletions(-)
> > > > 
> > > > -- 
> > > > 2.25.1  
> > > 
> > >  


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B9BC8C7EE23
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Jun 2023 15:21:46 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S235456AbjFHPVp (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Jun 2023 11:21:45 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52474 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232018AbjFHPVo (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Jun 2023 11:21:44 -0400
Received: from mx0b-0016f401.pphosted.com (mx0b-0016f401.pphosted.com [67.231.156.173])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1A05E2D56
        for <linux-cxl@vger.kernel.org>; Thu,  8 Jun 2023 08:21:41 -0700 (PDT)
Received: from pps.filterd (m0045851.ppops.net [127.0.0.1])
        by mx0b-0016f401.pphosted.com (8.17.1.19/8.17.1.19) with ESMTP id 358ErvTQ021076;
        Thu, 8 Jun 2023 08:20:21 -0700
Received: from pps.reinject (localhost [127.0.0.1])
        by mx0b-0016f401.pphosted.com (PPS) with ESMTPS id 3r30eu33yy-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Thu, 08 Jun 2023 08:20:21 -0700
Received: from m0045851.ppops.net (m0045851.ppops.net [127.0.0.1])
        by pps.reinject (8.17.1.5/8.17.1.5) with ESMTP id 358FCvqb023906;
        Thu, 8 Jun 2023 08:20:20 -0700
Received: from nam02-bn1-obe.outbound.protection.outlook.com (mail-bn1nam02lp2049.outbound.protection.outlook.com [104.47.51.49])
        by mx0b-0016f401.pphosted.com (PPS) with ESMTPS id 3r30eu33yr-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Thu, 08 Jun 2023 08:20:20 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=EjZlwuN77DkA2K2Brdyr91METojyzU6RmfDIIivHdAtDPnuoAdTebr/H8EbEwy2Saf28cOI5ZrV5lV1IFnmg7ipHD4LXdRrnFmwcnnYNak2bkxGj0BHFFLraDUrc3yaFAYhezR52z2vyWZV7UnojkeHaMmxhtd7lMtaEEsV6w/Zdeu2e1wYwZhDhTyMlKcqAO/G1COaxHB2B6Iv6uAnwiDU26oooK9phyHa4PqyzoZsNCAv8oJZrvQkRpThZF7L7c4GIWNBZ0VwqEibx+t1NemvYxndYV6vtrBjKeSDE+YSKJPsvtUbufdXdXIgdDogiZcskCsyIWzfPud6NCDfDJA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=DbG9O9am0XH9e0kSxCeWCnq4jLgCZj6BB8e2DsN8qyk=;
 b=b+5Rk50FgpYAlfzhAoll9NHJ5M2m1MMj5vpfrIdcAQRobMJ/M75Uf1shAQopwqCf3/hBqn6FLpV7iI8VgJaj6P4NNBeIyKmW106evu4WwZo5nhAfi9qZbxh1LUjAYqwu+1Fb1lteFWtTcabk5SVyO6rnbWjggKbaOYxdadHQskJw2547tK8rBJ48isdrX03Ld7Ay3/UZFszc9DqHVuGMmrjrG9LNDvBxDOnZR5wz5ILVv4aF3FuBr1nud7PPlpD2GuakSTZFXNKrOG9YryHBN9sKlXA1C0hgKHQz9XkVb7G2XcjLKbPvJcSfeYskhKZe3JhwZY2SLsRKEgJw4q3prg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=marvell.com; dmarc=pass action=none header.from=marvell.com;
 dkim=pass header.d=marvell.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=marvell.onmicrosoft.com; s=selector1-marvell-onmicrosoft-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=DbG9O9am0XH9e0kSxCeWCnq4jLgCZj6BB8e2DsN8qyk=;
 b=tP3y6RIVIdncZoVeYnksw+mnW4ZO7FkgSza3RLM44J91dl6sdGPmyKaAwiljKRnYKxIeK/C1bJ86eGjwJPlWQoGtVsk+R301fm3UFc/DXmBCyy9+ZMZK61h1U2L2nlT0Mr6NmkIoQpq4jxoF7/l0eLeJldUl/bxqBRRcBvhe8tk=
Received: from DM6PR18MB2844.namprd18.prod.outlook.com (2603:10b6:5:16f::29)
 by CH0PR18MB4370.namprd18.prod.outlook.com (2603:10b6:610:d5::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Thu, 8 Jun
 2023 15:20:16 +0000
Received: from DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864]) by DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864%6]) with mapi id 15.20.6477.016; Thu, 8 Jun 2023
 15:20:15 +0000
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
CC: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>
Subject: Re: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK98n/AAgAAEVoCAAymO8IAABjkAgAAFXhKAAPmEAIAAXICD
Date: Thu, 8 Jun 2023 15:20:15 +0000
Message-ID: <DM6PR18MB2844B37EE5A5AB7005EECCB3AF50A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
        <20230605175112.GA2290821@bgt-140510-bm03>
        <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
        <20230607183059.GA2354376@bgt-140510-bm03>
        <DM6PR18MB284486E36310719093C8A6D6AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <20230608104322.0000632f@Huawei.com>
In-Reply-To: <20230608104322.0000632f@Huawei.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
msip_labels: 
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR18MB2844:EE_|CH0PR18MB4370:EE_
x-ms-office365-filtering-correlation-id: 22c14f73-3842-4272-d0ac-08db6833dca5
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: eoTu4Atv9lfGjPOHfO6YAHkoy0MtkQq/ZnkM0ilFcrB2mBDqKJMNXIhvI6NNm8w6unErh0tZTVsSsoMnL82HtVgw05ew7kiRvrGOl0O91LlTJkXiPSdmfsxhiE68KBFLxDUSSawMaltuDFVMOBI2vlJiFJ4BmkL2/84nf90p1q1iJs/GZ0o7zL0gpliY17JLwpExP1VnyWItI/GQuiN1pxKGzKCxY1CJhLdQL3XWJqIASmPn4VgJzIaWeewLGx8voFjcPvtwYoqxRPqrMPGmEdknwLhOtApKHJfM/Ld7a1AqN/551SKOMIcnH8YtPtzY2i3J56qNWxXUT8NP21U4kGkzDkPRFC3G6FTvwxsoU+OzbjNGUGTrybnejLDdlacYoNbmfFtz+HBmnZ5KzhDo8GygLmm19zLYUsfdI0ZY0tf/xdZXDyInIOPqU5LxtIxSPAXJ7nnHnvP4kwdRuKAY1zs/QxA6YrFA1wpohsrwm3kutke9O+b9LTC/EP3Z3u76qCVkBELivoAEg6iUUFZ9vIeswf+wL/ct0hqsaIsCHYVxRjaIgAs9fQg/P5o3nTW9WcrqqJIBx1tAwIpQ7vpO4jPH9/gVYjrEAdRiutNvO2OmvWFKHPkSHi5kbo8D2czKYa4JLQHbxi8yog5aXjjkZw==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR18MB2844.namprd18.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(376002)(396003)(346002)(366004)(136003)(39860400002)(451199021)(54906003)(66476007)(71200400001)(45080400002)(478600001)(52536014)(6916009)(5660300002)(8676002)(7416002)(38070700005)(86362001)(33656002)(8936002)(2906002)(30864003)(4326008)(64756008)(91956017)(122000001)(66446008)(66556008)(316002)(55016003)(76116006)(66946007)(38100700002)(41300700001)(83380400001)(26005)(6506007)(9686003)(53546011)(186003)(966005)(7696005);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?iso-8859-1?Q?cP3VNRHdnkCwCCODWpNrw8HE9w7XO9KS4DDwjLKyXgckKq0t0TGse4+EMD?=
 =?iso-8859-1?Q?AzQGzzfbW43kQy0YWXMrxaO0AY2r272omBH7gM0snRWivsYwz+KwEYr6cA?=
 =?iso-8859-1?Q?enfmzJLyT4yALa/HG0xWIzw950LTqsk56Ev85rwi/+SB2+sMVpTfwvoHcX?=
 =?iso-8859-1?Q?SHzpiqBSV/iED2QMRpPrVH4MTaa8SD+ykHN1wvCXOOdNjWrznZynrluWKv?=
 =?iso-8859-1?Q?qV/BtA5ha2JRzLVIAsi0LBfoMBZSlIl91fnyT42n2xmKHQMAPsP63OpjUv?=
 =?iso-8859-1?Q?0gnG/HB5kAxFzhaZ8ZS4JwODhbrV1KL6H2rKYgEW7SRrGiXMV1KycswIRO?=
 =?iso-8859-1?Q?UKPIFn2Yzo9fRRVm3KkhHMFaDwkVOsVwgkPqqZsvG8o20XTincphmV7O/P?=
 =?iso-8859-1?Q?bFzes8JFurTiVsV8w3+p/muFuD1UrmvQphbsN2cEf9eeKYb/lsr1ODdt61?=
 =?iso-8859-1?Q?BHNWiyC6LLfNQm6Iow2EvamR8v/ht2AGLcDMLFGaRljmiPegO5RrSuif2Q?=
 =?iso-8859-1?Q?Y8xKoXFL44ZvFAT4GqaimzNl/Q2S9y6JR2q11y4QzwYPP0PvoglqO8MQfe?=
 =?iso-8859-1?Q?x/WPCsF1rTQd0gZOBcVFMMLqXCZF1FdmvDJeOii2TRtSM/G1ezGjcEd12I?=
 =?iso-8859-1?Q?sZksUmgMPjhReUeQeB0cjmMNxtjdgVl1k1lbcvHNuq/XYlmJiG9mX/i+Ik?=
 =?iso-8859-1?Q?EIp8h1jBfZjOFU2cgVd1j/3qmjpf8+/9FSWWuztwnh2F64iREYw17mmYYU?=
 =?iso-8859-1?Q?/GLT0T0JiORJoKINgzrfjRxZer3ki8kXCvnPYymZCW2yapfcp2Kn9wTwV7?=
 =?iso-8859-1?Q?EEQ9ieQPJII7IGQN9j57tM0Q45cWSXuoKdvW873J/DzHbMqmfs0qyg9hqb?=
 =?iso-8859-1?Q?yGZ/8N4ozK0uhO0luxLaW7fZFicpkcfoFKAuOoXfSdV/4b0JcjJWuh4IBY?=
 =?iso-8859-1?Q?dYTz+zP7mRc22LH0U4W8rILGS0tChCws0woKEJpbBZ9R8PI8LNU9B8L8Jn?=
 =?iso-8859-1?Q?sCu5QO3BQHC/MLq+cuDJVfM/u0W55wAAT4peey1Ugala6McgZZ7lz0zApd?=
 =?iso-8859-1?Q?ZBCs5fFX9WWwo0HVDK3cdJ6SkkW6k0R+VEPXcDHy6dOLotNdtOMkzfhXOE?=
 =?iso-8859-1?Q?4Divb0Db4Yuct0AteirlytyDAS+5bTYBgG6+HOnzRlMuBhvYiMBROq44BF?=
 =?iso-8859-1?Q?327W18Y0wRp4asyLeqJNiGyJ7SRzxnUWAVF71G08UPhkmzxrIjclGp36dg?=
 =?iso-8859-1?Q?UXgC45aiyjYudtcLCpaQB1TlariGuAFvz/6opVS8nr7BM5RyM2bzzeXtUp?=
 =?iso-8859-1?Q?lXhRbxf5YkoAKlxO4Ar0LVFCT3kMAW8NKwX8uwjgrr+2qbB4ceMJtLIeTu?=
 =?iso-8859-1?Q?NU5QwEdo3tFsaWMATcWjpwz/ekc+pDGTcU56POjoPfEdPhoR6hRqyuBXmN?=
 =?iso-8859-1?Q?tM1ov9y4XFy/fdS73RfEV3yET9tFoVZjtlYi/QG/vb7yiyYw4FFKDd8YHM?=
 =?iso-8859-1?Q?UndIX2WU6OboIwWoW2y08cqZD8uSxUy9MtI3TELVBKZ++qTSNSjzpHmaKg?=
 =?iso-8859-1?Q?2raOeO+RtVY7rvCrMil3p8a+xJSFqoJjxwUwTibJajj5VQInpIV1rXI6lG?=
 =?iso-8859-1?Q?T/kEoneoRjIM0=3D?=
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: marvell.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR18MB2844.namprd18.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 22c14f73-3842-4272-d0ac-08db6833dca5
X-MS-Exchange-CrossTenant-originalarrivaltime: 08 Jun 2023 15:20:15.7142
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 70e1fb47-1155-421d-87fc-2e58f638b6e0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: jP/o9F9u4/PppssvOthBrV4uo3ZHLT5kC7vgyxAEMPxiDaICTLYDbRmT0dP13BkJXM9IYgRvkeNYU7lnMQT5iw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH0PR18MB4370
X-Proofpoint-ORIG-GUID: cS7JNnRAagZPlvLGFpz8vfoX8cMGj6BP
X-Proofpoint-GUID: i0wW3mH_SPsuoiUCxD-gkhavMdvtylx2
X-Proofpoint-Virus-Version: vendor=baseguard
 engine=ICAP:2.0.254,Aquarius:18.0.957,Hydra:6.0.573,FMLib:17.11.176.26
 definitions=2023-06-08_11,2023-06-08_01,2023-05-22_02
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 20549
Lines: 455

=0A=
=0A=
=0A=
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>=0A=
Sent: Thursday, June 8, 2023 2:43 AM=0A=
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
Cc: Fan Ni <fan.ni@samsung.com>; qemu-devel@nongnu.org <qemu-devel@nongnu.o=
rg>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.org>; gregory.price@m=
emverge.com <gregory.price@memverge.com>; hchkuo@avery-design.com.tw <hchku=
o@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@avery-design.com>; =
dan.j.williams@intel.com <dan.j.williams@intel.com>; Adam Manzanares <a.man=
zanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.net>; nmtadam.samsun=
g@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.com <nifan@outlook.c=
om>; Ira Weiny <ira.weiny@intel.com>=0A=
Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =
=0A=
=A0=0A=
External Email=0A=
=0A=
----------------------------------------------------------------------=0A=
On Wed, 7 Jun 2023 18:52:14 +0000=0A=
Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com> wrote:=0A=
=0A=
> From: Fan Ni <fan.ni@samsung.com>=0A=
> Sent: Wednesday, June 7, 2023 11:31 AM=0A=
> To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
> Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>; qemu-devel@nongnu.org=
 <qemu-devel@nongnu.org>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.=
org>; gregory.price@memverge.com <gregory.price@memverge.com>; hchkuo@avery=
-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com <cbrow=
y@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.com>; A=
dam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@stgolabs=
.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook=
.com <nifan@outlook.com>; Ira Weiny <ira.weiny@intel.com>=0A=
> Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu=
 =0A=
> =A0=0A=
> External Email=0A=
> =0A=
> ----------------------------------------------------------------------=0A=
> On Wed, Jun 07, 2023 at 06:13:01PM +0000, Shesha Bhushan Sreenivasamurthy=
 wrote:=0A=
> > Hi Fan,=0A=
> >=A0=A0=A0 I am implementing DCD FMAPI commands and planning to start pus=
hing changes to the below branch. That requires the contributions you have =
made. Can your changes be pushed to the below branch ?=0A=
> > =0A=
> > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-20=
23-05-25__;!!EwVzqGoTKBqv-0DWAJBm!Vt5uIqwW-L4c4gh02ulI4M762JNQ3_aE9k9lb6Qlw=
E2xm6T23ic7ig7Y77i1VN7l_RX_ySIQhre_z7Q0JA$=A0=A0 =0A=
> =0A=
> Can you push changes to the branch directly? I think it is Jonathan's pri=
vate=0A=
> branch. However, I can fork the branch and rebase my patch series atop an=
d=0A=
> share with you the new repo if that helps you move forward your=0A=
> work.=0A=
> Let me know your thought.=0A=
> =0A=
> ss - I saw commits from others, so assumed you can. Since it is Jonathan'=
s private repo, I will step back and let him answer.=0A=
=0A=
I tend to apply stuff in manually rather than given more people commit acce=
ss=0A=
to that particular gitlab tree. =0A=
=0A=
Easiest option is to fork on gitlab and share the path of your own fork.=0A=
=0A=
I normally queue reasonably mature stuff up on my tree, but that's about ma=
naging=0A=
the series sent with intent of being applied upstream + providing a fairly =
stable test=0A=
branch.=A0 It's not intended as a general place for stuff in development (t=
hough I might=0A=
sneak out an extra branch myself from time to time if I want to talk about =
it :)=0A=
=0A=
Jonathan=0A=
=0A=
ss - Thanks ! I have forked Jonathan's repo on Gitlab and will work of cxl-=
2023-05-25 branch. I will apply Fan's patch manually and continue ..=0A=
=0A=
> =0A=
> Fan=0A=
> =0A=
> > =0A=
> > =0A=
> > From: Fan Ni <fan.ni@samsung.com>=0A=
> > Sent: Monday, June 5, 2023 10:51 AM=0A=
> > To: Ira Weiny <ira.weiny@intel.com>=0A=
> > Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@hua=
wei.com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl=
@vger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>;=
 hchkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-desi=
gn.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@=
intel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <=
dave@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; =
nifan@outlook.com <nifan@outlook.com>=0A=
> > Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =0A=
> > =A0=0A=
> > On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:=A0 =0A=
> > > Fan Ni wrote:=A0 =0A=
> > > > Since the early draft of DCD support in kernel is out=0A=
> > > > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/2023=
0417164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPI=
cSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGN=
Ok$ ),=0A=
> > > > this patch series provide dcd emulation in qemu so people who are i=
nterested=0A=
> > > > can have an early try. It is noted that the patch series may need t=
o be updated=0A=
> > > > accordingly if the kernel side implementation changes.=A0 =0A=
> > > =0A=
> > > Fan,=0A=
> > > =0A=
> > > Do you have a git tree we can pull this from which is updated to a mo=
re=0A=
> > > recent CXL branch from Jonathan?=0A=
> > > =0A=
> > > Thanks,=0A=
> > > Ira=A0 =0A=
> > =0A=
> > Hi Ira,=0A=
> > =0A=
> > I have a git tree of the patch series based on Jonathan's branch=0A=
> > cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__=
github.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=3DDwIFAg&c=3DnKjWec2b6R0mOyPa=
z7xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3Dw6dicn5kXEG4Imk6=
TpICIjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3D3yeO9RN5FY3gPfO2y19X05=
7YeqRTTQTQNfNA-Gfir_Q&e=3D .=0A=
> > =0A=
> > That may be not new enough to include some of the recent patches, but I=
 can=0A=
> > rebase it to a newer branch if you can tell me which branch you want to=
 use.=0A=
> > =0A=
> > Thanks,=0A=
> > Fan=0A=
> >=A0=A0 =0A=
> > >=A0=A0 =0A=
> > > > =0A=
> > > > To support DCD emulation, the patch series add DCD related mailbox =
command=0A=
> > > > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory =
device=0A=
> > > > with dynamic capacity extent and region representative.=0A=
> > > > To support read/write to the dynamic capacity of the device, a host=
 backend=0A=
> > > > is provided and necessary check mechnism is added to ensure the dyn=
amic=0A=
> > > > capacity accessed is backed with active dc extents.=0A=
> > > > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is no=
t supported=0A=
> > > > , but we add two qmp interfaces for adding/releasing dynamic capaci=
ty extents.=0A=
> > > > Also, the support for multiple hosts sharing the same DCD case is m=
issing.=0A=
> > > > =0A=
> > > > Things we can try with the patch series together with kernel dcd co=
de:=0A=
> > > > 1. Create DC regions to cover the address range of the dynamic capa=
city=0A=
> > > > regions.=0A=
> > > > 2. Add/release dynamic capacity extents to the device and notify th=
e=0A=
> > > > kernel.=0A=
> > > > 3. Test kernel side code to accept added dc extents and create dax =
devices,=0A=
> > > > and release dc extents and notify the device=0A=
> > > > 4. Online the memory range backed with dc extents and let applicati=
on use=0A=
> > > > them.=0A=
> > > > =0A=
> > > > The patch series is based on Jonathan's local qemu branch:=0A=
> > > > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cx=
l-2023-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOI=
eUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$ =0A=
> > > > =0A=
> > > > Simple tests peformed with the patch series:=0A=
> > > > 1 Install cxl modules:=0A=
> > > > =0A=
> > > > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem=0A=
> > > > =0A=
> > > > 2 Create dc regions:=0A=
> > > > =0A=
> > > > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)=0A=
> > > > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region=0A=
> > > > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity=0A=
> > > > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways=0A=
> > > > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode=0A=
> > > > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size=0A=
> > > > echo 0x10000000 > /sys/bus/cxl/devices/$region/size=0A=
> > > > echo=A0 "decoder2.0" > /sys/bus/cxl/devices/$region/target0=0A=
> > > > echo 1 > /sys/bus/cxl/devices/$region/commit=0A=
> > > > echo $region > /sys/bus/cxl/drivers/cxl_region/bind=0A=
> > > > =0A=
> > > > /home/fan/cxl/tools-and-scripts# cxl list=0A=
> > > > [=0A=
> > > >=A0=A0 {=0A=
> > > >=A0=A0=A0=A0 "memdevs":[=0A=
> > > >=A0=A0=A0=A0=A0=A0 {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "memdev":"mem0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "pmem_size":536870912,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "ram_size":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "serial":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "host":"0000:0d:00.0"=0A=
> > > >=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0 ]=0A=
> > > >=A0=A0 },=0A=
> > > >=A0=A0 {=0A=
> > > >=A0=A0=A0=A0 "regions":[=0A=
> > > >=A0=A0=A0=A0=A0=A0 {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "region":"region0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "resource":45365592064,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "size":268435456,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_ways":1,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_granularity":256,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "decode_state":"commit"=0A=
> > > >=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0 ]=0A=
> > > >=A0=A0 }=0A=
> > > > ]=0A=
> > > > =0A=
> > > > 3 Add two dc extents (128MB each) through qmp interface=0A=
> > > > =0A=
> > > > { "execute": "qmp_capabilities" }=0A=
> > > > =0A=
> > > > { "execute": "cxl-add-dynamic-capacity-event",=0A=
> > > >=A0=A0=A0=A0=A0 "arguments": {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "path": "/machine/periphe=
ral/cxl-pmem0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "region-id" : 0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "num-extent": 2,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "dpa":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "extent-len": 128=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > > }=0A=
> > > > =0A=
> > > > /home/fan/cxl/tools-and-scripts# lsmem=0A=
> > > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE=A0=A0 BL=
OCK=0A=
> > > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0=A0=A0 0-15=0A=
> > > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0=A0 32-79=0A=
> > > > 0x0000000a90000000-0x0000000a9fffffff=A0 256M offline=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0 338-339=0A=
> > > > =0A=
> > > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > > Total online memory:=A0=A0=A0=A0=A0=A0 8G=0A=
> > > > Total offline memory:=A0=A0=A0 256M=0A=
> > > > =0A=
> > > > =0A=
> > > > 4.Online the momory with 'daxctl online-memory dax0.0' to online th=
e memory=0A=
> > > > =0A=
> > > > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0=0A=
> > > > [=A0 230.730553] Fallback order for Node 0: 0 1=0A=
> > > > [=A0 230.730825] Fallback order for Node 1: 1 0=0A=
> > > > [=A0 230.730953] Built 2 zonelists, mobility grouping on.=A0 Total =
pages: 2042541=0A=
> > > > [=A0 230.731110] Policy zone: Normal=0A=
> > > > onlined memory for 1 device=0A=
> > > > =0A=
> > > > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem=0A=
> > > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE BLOCK=0A=
> > > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0 0-15=0A=
> > > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=
=A0=A0=A0=A0 yes 32-79=0A=
> > > > 0x0000000a90000000-0x0000000a97ffffff=A0 128M=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0 338=0A=
> > > > 0x0000000a98000000-0x0000000a9fffffff=A0 128M offline=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0 339=0A=
> > > > =0A=
> > > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > > Total online memory:=A0=A0=A0=A0 8.1G=0A=
> > > > Total offline memory:=A0=A0=A0 128M=0A=
> > > > =0A=
> > > > 5 using dc extents as regular memory=0A=
> > > > =0A=
> > > > /home/fan/cxl/ndctl# numactl --membind=3D1 ls=0A=
> > > > CONTRIBUTING.md=A0 README.md=A0 clean_config.sh=A0 cscope.out=A0=A0=
 git-version-gen=0A=
> > > > ndctl=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 scripts=A0=A0 test.h=
=A0=A0=A0=A0=A0 version.h.in COPYING=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 acpi.h=0A=
> > > > config.h.meson=A0=A0 cxl=A0=A0=A0=A0=A0=A0=A0=A0=A0 make-git-snapsh=
ot.sh=A0=A0 ndctl.spec.in=A0 sles=A0=A0=A0=A0 tools=0A=
> > > > Documentation=A0=A0=A0=A0=A0=A0=A0 build=A0=A0=A0=A0=A0=A0 contrib=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 daxctl=A0=A0=A0=A0=A0=A0=A0 meson.build=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rhel=0A=
> > > > tags=A0=A0=A0=A0=A0=A0=A0 topology.png LICENSES=A0=A0=A0 ccan=A0=A0=
=A0=A0=A0=A0=A0 cscope.files=0A=
> > > > git-version=A0 meson_options.txt=A0=A0=A0=A0=A0 rpmbuild.sh=A0=A0=
=A0 test=A0=A0=A0=A0 util=0A=
> > > > =0A=
> > > > =0A=
> > > > QEMU command line cxl configuration:=0A=
> > > > =0A=
> > > > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-pat=
h=3D/tmp/cxltest.raw,size=3D512M \=0A=
> > > > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tm=
p/cxltest2.raw,size=3D512M \=0A=
> > > > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tm=
p/lsa.raw,size=3D512M \=0A=
> > > > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \=0A=
> > > > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,sl=
ot=3D2 \=0A=
> > > > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa=
1,dc-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\=0A=
> > > > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interl=
eave-granularity=3D8k"=0A=
> > > > =0A=
> > > > =0A=
> > > > Kernel DCD support used to test the changes=0A=
> > > > =0A=
> > > > The code is tested with the posted kernel dcd support:=0A=
> > > > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/ke=
rnel/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJB=
m!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7l=
r21q5Iza3M$ =0A=
> > > > =0A=
> > > > commit: f425bc34c600e2a3721d6560202962ec41622815=0A=
> > > > =0A=
> > > > To make the test work, we have made the following changes to the ab=
ove kernel commit:=0A=
> > > > =0A=
> > > > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c=0A=
> > > > index 5f04bbc18af5..5f421d3c5cef 100644=0A=
> > > > --- a/drivers/cxl/core/mbox.c=0A=
> > > > +++ b/drivers/cxl/core/mbox.c=0A=
> > > > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CX=
L_MEM_COMMAND_ID_MAX] =3D {=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),=
=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOA=
D, 0),=0A=
> > > > +=A0=A0 CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),=0A=
> > > >=A0 };=0A=
> > > >=A0 =0A=
> > > >=A0 /*=0A=
> > > > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c=
=0A=
> > > > index 291c716abd49..ae10e3cf43a1 100644=0A=
> > > > --- a/drivers/cxl/core/region.c=0A=
> > > > +++ b/drivers/cxl/core/region.c=0A=
> > > > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_regi=
on *cxlr)=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 cxlds->dc_list_gen_num =3D e=
xtent_gen_num;=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_dbg(cxlds->dev, "No of p=
reallocated extents :%d\n", rc);=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 enable_irq(cxlds->cxl_irq[CXL_EVENT=
_TYPE_DCD]);=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 /*enable_irq(cxlds->cxl_irq[CXL_EVE=
NT_TYPE_DCD]);*/=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0=A0 return 0;=0A=
> > > >=A0 err:=0A=
> > > > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *c=
xlds, struct resource *alloc_dpa_re=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0 dev_dax->align, memremap_compat_align()))) {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rc =3D alloc_dev_dax_range(d=
ev_dax, hpa,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 resource_size(alloc_dpa_res))=
;=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (rc)=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=
=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > >=A0 =0A=
> > > >=A0=A0=A0=A0=A0 rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_da=
x, GFP_KERNEL);=0A=
> > > > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c=0A=
> > > > index 9e45b1056022..653bec203838 100644=0A=
> > > > --- a/drivers/cxl/pci.c=0A=
> > > > +++ b/drivers/cxl/pci.c=0A=
> > > > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_st=
ate *cxlds)=0A=
> > > >=A0 =0A=
> > > >=A0=A0=A0=A0=A0 /* Driver enables DCD interrupt after creating the d=
c cxl_region */=0A=
> > > >=A0=A0=A0=A0=A0 rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settin=
gs, CXL_EVENT_TYPE_DCD,=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_A=
UTOEN);=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT);=0A=
> > > >=A0=A0=A0=A0=A0 if (rc) {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_err(cxlds->dev, "Failed =
to get interrupt for event dc log\n");=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_=
mem.h=0A=
> > > > index 6ca85861750c..910a48259239 100644=0A=
> > > > --- a/include/uapi/linux/cxl_mem.h=0A=
> > > > +++ b/include/uapi/linux/cxl_mem.h=0A=
> > > > @@ -47,6 +47,7 @@=0A=
> > > >=A0=A0=A0=A0=A0 ___C(SCAN_MEDIA, "Scan Media"),=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(GET_SCAN_MEDIA, "Get Scan Media Results"),=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity exten=
ts"),=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > > +=A0=A0 ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),=
=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(MAX, "invalid / last command")=0A=
> > > >=A0 =0A=
> > > >=A0 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a=0A=
> > > > =0A=
> > > > =0A=
> > > > =0A=
> > > > Fan Ni (7):=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to outp=
ut=0A=
> > > >=A0=A0=A0=A0 payload of identify memory device command=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dynamic capacity region represe=
ntative=0A=
> > > >=A0=A0=A0=A0 and mailbox command support=0A=
> > > >=A0=A0 hw/mem/cxl_type3: Add a parameter to pass number of DC region=
s the=0A=
> > > >=A0=A0=A0=A0 device supports in qemu command line=0A=
> > > >=A0=A0 hw/mem/cxl_type3: Add DC extent representative to cxl type3 d=
evice=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add=
/release=0A=
> > > >=A0=A0=A0=A0 dynamic capacity response=0A=
> > > >=A0=A0 Add qmp interfaces to add/release dynamic capacity extents=0A=
> > > >=A0=A0 hw/mem/cxl_type3: add read/write support to dynamic capacity=
=0A=
> > > > =0A=
> > > >=A0 hw/cxl/cxl-mailbox-utils.c=A0 | 389 +++++++++++++++++++++++++++-=
=0A=
> > > >=A0 hw/mem/cxl_type3.c=A0=A0=A0=A0=A0=A0=A0=A0=A0 | 492 ++++++++++++=
+++++++++++++++++++-----=0A=
> > > >=A0 include/hw/cxl/cxl_device.h |=A0 50 +++-=0A=
> > > >=A0 include/hw/cxl/cxl_events.h |=A0 16 ++=0A=
> > > >=A0 qapi/cxl.json=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 |=A0 44 =
++++=0A=
> > > >=A0 5 files changed, 924 insertions(+), 67 deletions(-)=0A=
> > > > =0A=
> > > > -- =0A=
> > > > 2.25.1=A0 =0A=
> > > =0A=
> > >=A0 =0A=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 91D44C7EE37
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Jun 2023 15:44:05 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S237200AbjFHPoE (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Jun 2023 11:44:04 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33000 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S237142AbjFHPns (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Jun 2023 11:43:48 -0400
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id F3D5B2D78
        for <linux-cxl@vger.kernel.org>; Thu,  8 Jun 2023 08:43:30 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1686239015; x=1717775015;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=A1t1+MknLwWpTxQRmh9U05w4/DizYJcLe1G5PYLNom0=;
  b=mNnZqRQDVO3JpddvoRzRq0ICVWOO85qEm02Csg/UoG4HiAKzSejkARUn
   knePkidZVC0d6FuN4Y3TxCHnwI92oPUuz/Y0Lboqkp3oQfZilnE0rbglf
   dXQNPwvRXZrho+l38jzOcxYHbVS6sC1GbjTNVvJ2OP8Wd3LKEqUHVuCBL
   m6dDr5o5kJCdNF4ix+e7R23R1xC2lsh/UoReYj+EvFPkXiJtCNTZYWAmR
   POu7INxkuSvV23fihS2p1yu7x2ymcrHzzZSH/wOILslhTmyWIoIGsE04k
   LkB5lHYwWDFu7xhKQWswRDfDwPOPuIgvI5vCNbNSq3Gc6Uzltw527M+fG
   A==;
X-IronPort-AV: E=McAfee;i="6600,9927,10735"; a="354831918"
X-IronPort-AV: E=Sophos;i="6.00,227,1681196400"; 
   d="scan'208";a="354831918"
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
  by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 08 Jun 2023 08:43:28 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6600,9927,10735"; a="775107146"
X-IronPort-AV: E=Sophos;i="6.00,227,1681196400"; 
   d="scan'208";a="775107146"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by fmsmga008.fm.intel.com with ESMTP; 08 Jun 2023 08:43:26 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Thu, 8 Jun 2023 08:43:24 -0700
Received: from fmsmsx602.amr.corp.intel.com (10.18.126.82) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Thu, 8 Jun 2023 08:43:23 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23 via Frontend Transport; Thu, 8 Jun 2023 08:43:23 -0700
Received: from NAM12-MW2-obe.outbound.protection.outlook.com (104.47.66.48) by
 edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.23; Thu, 8 Jun 2023 08:43:23 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=JsXc0L2qT8NTlGxIwIaMyi+gk3T4l0Ipba/2JDSs8e3CiJKPYVPfs3/ABwsfioqtZQSJc38DKc+JHKIEVPiEzMRoueXiTHzkh/zVlb6t2rUvIJ/VKaLYl2K90xWu48cn4SPNeqHEJ5+ywovM7bfs0fl/l52STH31IZ32nkZ5etcex0PMAWrk9fNQJZ7U5+4OEc82FZZy+a9YtuWUccmliuNotUZ3NvzQBW55+OxvFL2jX5wZm2Sm7rxq9oZnlGhHCmiTsEMhSIVI8dT4L3acpZczMVcDhrl8yNvsbHFjGMdtIMUbmGkCqSyKvvs/ZBQnLyKiDc38p01jOhcBWMqVYg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=IQtZdN2dkNmFZl8waYwBgpoPjoCIZy5+56yudstrFjI=;
 b=mbj3RkTivfhjKHnvKfVIUNWCPFrbK+ckEg/aQsXMAuEpGaBH2mJT1HRpR1yWbeC71H326lwlbgLd9IPtWJLFHWhJ/QE2ipbNaHw9qCMU3jARWqYm9FeFX4n+nPzcf1BnXCARQucSPBmc0nKpKaMYQoxmlcp1aIiJksDDcW+wVpmoZtvZGwdwdIPe/vjQlVG+1ouamMts+8xedNs/DVrhqUkjQOmVuGHSH8fR59pvUD0LJqhzAOXIgO7GPGnG58Xi9pyNSGC4QE96gcHNRAsk73avA/aEbotPc2m3qoea1L5CQiM+GDqBSMzSssp5oJd1fzW7sdr7pZ/pp2F0FJQzyw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by MN2PR11MB4550.namprd11.prod.outlook.com (2603:10b6:208:267::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Thu, 8 Jun
 2023 15:43:20 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::7237:cab8:f7f:52a5]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::7237:cab8:f7f:52a5%6]) with mapi id 15.20.6455.037; Thu, 8 Jun 2023
 15:43:20 +0000
Date: Thu, 8 Jun 2023 08:43:11 -0700
From: Ira Weiny <ira.weiny@intel.com>
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>,
        Fan Ni <fan.ni@samsung.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <6481f70fca5c2_c82be29440@iweiny-mobl.notmuch>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
 <20230511175609.2091136-1-fan.ni@samsung.com>
 <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
 <20230605175112.GA2290821@bgt-140510-bm03>
 <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
X-ClientProxiedBy: BY3PR03CA0002.namprd03.prod.outlook.com
 (2603:10b6:a03:39a::7) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|MN2PR11MB4550:EE_
X-MS-Office365-Filtering-Correlation-Id: 8bda20cc-8738-4c2b-fbc8-08db683715c9
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: Q0l+Kr4+AyrOVmVCGlziYyJL9dR/mvYJbidIpWFk8jbtF7nFzf6noqerVh8RDxVL7bABAmNV014Z88haw245DFbwUK/KZLVAFghQ2rZcOutNQD/MlUpKwkmoAZ/QyktJvj2xygK6q1pzH5wN8E8M+kVlpztAHU29MGWJaO/wybxhYOYX93h+X8kfDGA6Pe8uMjBrt0fhnopXQL6epu7LzWg7yR5xIfMJ17wN21Hl0TOEIxjYc5aBltz7BQTPEiDwr/EsCTR4mXKgqGsN8MZOVlpPxu0gTvhOaVpy6zcTcwXwdYxOUAWPDSpVlByqzbgrfRYT4cjvbBGNsTlLlgrw6nQHqQA2w7TL6u2KF3vcrCdU2vUfhjWS5U9TriMkMzk5VnQNStcrOrDAz2n2Rxisvtju82jNYVXEdgHuBsEvOnkyv7xPUV8PUI4wwmR9TT7Zzj1JhSkbg1sg0O1ziy/hBbvjG9pYkRbr388zfaMrowHSJtdwKnKNnVuNc9TQG0aFE6HMLCEQOb+kjV5i4WEQlPEfjlb+p9s0zDL9/lNDW+A=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(396003)(366004)(39860400002)(376002)(346002)(136003)(451199021)(26005)(9686003)(6506007)(6512007)(44832011)(316002)(83380400001)(66556008)(4326008)(66476007)(66946007)(966005)(6486002)(6666004)(107886003)(186003)(478600001)(110136005)(54906003)(4744005)(2906002)(5660300002)(8676002)(8936002)(82960400001)(86362001)(7416002)(41300700001)(38100700002);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?+1D0SlJMfaW1rlEW6Yof0dSl5gZIFF0eRMG0D98jrMNYT4H6Ukz2yGpcyf9o?=
 =?us-ascii?Q?R1DEbagIUxwYtd0vmw2oyXKF5oUL2oiOlEvFAvQymu8lXbzcEUlcucdbh7lp?=
 =?us-ascii?Q?Z49pKA2bj4KGMXS2T4S7HFl81Hvve5nRt4WHey2AjhNojl0I8YYGicMkapZp?=
 =?us-ascii?Q?0W+P6pU9ynYTRHV0VdoijUWPzE0657I5dSSMmj2a0x5Rllkp9/WhRalgLcei?=
 =?us-ascii?Q?YAwScHHUQGOQv5Ru2T91Pw1X+Q/GaksKE4gMW1Ws2qaHom7hZC0ZcZw0hAfF?=
 =?us-ascii?Q?wUH6CYMsF5ePFyRbBVlhG5cLKzpdcU4dr2byfTvlXS1RmDLkhgMXZviZzkWH?=
 =?us-ascii?Q?bj+e7WpHw0O5YmshCzMToFYCBPeFlZrFMdgnpHetcULo5uzj4+S1tK/eUQFY?=
 =?us-ascii?Q?hJYgzQopw4FyewutvUG26pDSnHwQ9GgLaYMI1F3q/a0EleRS5NqRBiCf8mAQ?=
 =?us-ascii?Q?MzLZgu7UVBnNW8PW217uNGfKGVtPJ5Ajprl1uRTSM9cfOsnX8aFPy70k4QYk?=
 =?us-ascii?Q?EWbTWELnpapZ2qarMFkHSHsnu2qd56gqS+voyR4SB35cBxcfUeVgcItHXFmS?=
 =?us-ascii?Q?GBbO5do9LzUyeYf61XXb7f78HT+bUa2CcnWdW3dbX4epdrudiryv3iYmExIt?=
 =?us-ascii?Q?EFiSN9KOXLjbhp6mPlR2Jlk2Mgh6XeKG4L3H1PBGuRprD/r3uQR7elthzQJ+?=
 =?us-ascii?Q?WWQclqYq0V79OVrZ0m3TDDF+fmjzJ9DSJsqRo5SB6IOB4DNb1944e8g54xDC?=
 =?us-ascii?Q?0oc3tHOXL7Swas0l1ZQ6B34GKub//DnTC+Y1MYhwu0IEGd80Hzf4NV89JYuc?=
 =?us-ascii?Q?mU7nPt9BSIjiqBxnjSIsmAqPQLMVxc+Mdn1wYqyu4orZjGjOgXRCyidbWe1I?=
 =?us-ascii?Q?HXZ/Ug0yHW0C3pI+ZFnSpJnxquveV9Vd/C1iEHj1zyaBdYpnfPNFPbAdNjOk?=
 =?us-ascii?Q?P8+Lg4vWM4l1GUOdtZC8UfEzRCLh1L/zPknQYKPemuMc0twPzWE3gTpT+t0D?=
 =?us-ascii?Q?XmYaE+sJ78MTa4zJf8NWq9Q/bz2wLXtZuMcT0GojgC7c1CCySfH4uQwuMm1a?=
 =?us-ascii?Q?0oxG9UwiyH1s95HnAE16OHXWwPHpFdklxPi3hX/CjcCgvEjvAChvQtnCkW1e?=
 =?us-ascii?Q?SGs6Q3Y4AJOYPUAIeGdQ+zdnuZosKTEXquDRR312f6a1UAefRPpxBPEs3IAH?=
 =?us-ascii?Q?2FxZDkE9o/K39nTPxdpMqdzjw7Efuo6jZL+O7sU5WILoPUVCoZujPMb+x+JZ?=
 =?us-ascii?Q?nyY1TTQSeRJjQPBikSBXBjwvCveus4vsbpBkWWQnvRrd+U2jDrcpDxLzLJWF?=
 =?us-ascii?Q?lTjJ++qpk4NCAznh+FFfGKMR0miAMI+dmi4F7SBcyqkJfnESvwEoA96l+PD3?=
 =?us-ascii?Q?7u9aRkslwE5w8yIZ6YnAwBcyYo5ZFTITcu0ouudaZO/TRl7emaojLDXGQHzi?=
 =?us-ascii?Q?H4urdwK2Ff+i7eTwW2b1gtbK1q8D/3u+ptgDH21E1/LffFdpkUS9alh17G1L?=
 =?us-ascii?Q?2ewdOR1wUUsCozP4ydOvtm5RrBZKys4blocJs/jO6lqX3rronkD0TUiFNoQA?=
 =?us-ascii?Q?rpBwx02R+16OiATBJTJN2jZtmGMs9k0mjFlbMMRK?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 8bda20cc-8738-4c2b-fbc8-08db683715c9
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Jun 2023 15:43:20.2806
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: CZ/58zJj7o2V1sN90Dl4gTR9njfgW/0qH+4zcYLmDNPy1HKjCVHP4yeYSibNoFUTPo7+nJL5htTz3xI4FCsT2Q==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN2PR11MB4550
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 363
Lines: 10

Shesha Bhushan Sreenivasamurthy wrote:
> Hi Fan,
>    I am implementing DCD FMAPI commands and planning to start pushing changes to the below branch. That requires the contributions you have made. Can your changes be pushed to the below branch ?
> 
> https://gitlab.com/jic23/qemu/-/tree/cxl-2023-05-25

This is the branch I'm trying to use as well.

Thanks,
Ira

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DF626C7EE29
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Jun 2023 16:56:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231144AbjFHQ4x (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Jun 2023 12:56:53 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:35102 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233385AbjFHQ4w (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Jun 2023 12:56:52 -0400
Received: from mx0b-0016f401.pphosted.com (mx0a-0016f401.pphosted.com [67.231.148.174])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 9DE7A1730
        for <linux-cxl@vger.kernel.org>; Thu,  8 Jun 2023 09:56:49 -0700 (PDT)
Received: from pps.filterd (m0045849.ppops.net [127.0.0.1])
        by mx0a-0016f401.pphosted.com (8.17.1.19/8.17.1.19) with ESMTP id 3588D2qE023579;
        Thu, 8 Jun 2023 09:55:35 -0700
Received: from pps.reinject (localhost [127.0.0.1])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r329c3uwa-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Thu, 08 Jun 2023 09:55:35 -0700
Received: from m0045849.ppops.net (m0045849.ppops.net [127.0.0.1])
        by pps.reinject (8.17.1.5/8.17.1.5) with ESMTP id 358Geaj8026953;
        Thu, 8 Jun 2023 09:55:34 -0700
Received: from nam11-bn8-obe.outbound.protection.outlook.com (mail-bn8nam11lp2168.outbound.protection.outlook.com [104.47.58.168])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r329c3uw7-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Thu, 08 Jun 2023 09:55:34 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=OGMrEVilbdl5j4iKn+tbFy6SmdNG70jtqfLi6UiybfFSGMxYIOej3CYMcT5xi+RkiQu0jHdpYNR1J7HG8S6lCxdC5Ol3ZN/e/FGwMu3Ivi6llmLQ7Qoxuf3UXiLDlMJdYOzISkMnEXqkAF+L55y36NvPp3bNnM7zkw2c6xieJ662KQUMA+aKFRwSMATomhqiqbnOQA8QxjSObSAKQo18d36BC9/3pw1MJm6In/uZBs7aIX3BDfDMeAivfzNNWvphyAec2Tug/PYP/SN/yitINWcq9os2dKijWPgZs2KFQpuwTuDpIqA5isozICEFVGPHhO6aNcsdkPWwKDt5tCnS6A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ogjJHimvFmoSpZZuSnQ/JRA/zkIjG99kRpYY5lj9swI=;
 b=NvhNlcSKYsFkeJ87hC2aFZqL9oyzoGLgB6ZWm6vimjQNnTnDM7bdrBFsOwf9kLRdYXtcxUmqeKzegmDK56j0v/GtjcmO1o4O12d0LYXaLNswaRLkmBSTr7F0ZDy5oRdi7crdDL2jV0pwDawI8ZvuELxP4cLYDB+ONnPfG3c64q0tJN4pAGORo2eV7LMW8v01i+xGLpJ4Z/b9np1IT+DXVP2CpUypk9zYKxB1Mrcc+cABOmnyhTKo2yOPB6472T9lvblN+cRuy/lMHIdxmcHngbFW8DkHvI2tcrWd35wqavC3E4vzoyzaP+sxlkO9Tf5Xi6DYqloErUDaTgDSPpnPow==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=marvell.com; dmarc=pass action=none header.from=marvell.com;
 dkim=pass header.d=marvell.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=marvell.onmicrosoft.com; s=selector1-marvell-onmicrosoft-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ogjJHimvFmoSpZZuSnQ/JRA/zkIjG99kRpYY5lj9swI=;
 b=QZSCLnnYqsKT9RDrZ/Dhn0cv05efhjtgxrGJDwRSW1iVb44pqhHRHNjt/RZ6jeORwIkpWA2qGcOoK2F7WfSYMBsSOaodfeSSAHAqfvLeRbzNxZSvf7a7U8DJku7lpsYVa4Qklfc0IKp6H4ddNlNVs3XkSwmy232d7KKpKZFsS3w=
Received: from DM6PR18MB2844.namprd18.prod.outlook.com (2603:10b6:5:16f::29)
 by SJ0PR18MB4865.namprd18.prod.outlook.com (2603:10b6:a03:404::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6477.19; Thu, 8 Jun
 2023 16:55:29 +0000
Received: from DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864]) by DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864%6]) with mapi id 15.20.6477.016; Thu, 8 Jun 2023
 16:55:29 +0000
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
CC: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>
Subject: Re: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK98n/AAgAAEVoCAAymO8IAABjkAgAAFXhKAAPmEAIAAXICDgAAb9Gk=
Date: Thu, 8 Jun 2023 16:55:29 +0000
Message-ID: <DM6PR18MB28447B61A0D857865A499879AF50A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
        <20230511175609.2091136-1-fan.ni@samsung.com>
        <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
        <20230605175112.GA2290821@bgt-140510-bm03>
        <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
        <20230607183059.GA2354376@bgt-140510-bm03>
        <DM6PR18MB284486E36310719093C8A6D6AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <20230608104322.0000632f@Huawei.com>
 <DM6PR18MB2844B37EE5A5AB7005EECCB3AF50A@DM6PR18MB2844.namprd18.prod.outlook.com>
In-Reply-To: <DM6PR18MB2844B37EE5A5AB7005EECCB3AF50A@DM6PR18MB2844.namprd18.prod.outlook.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
msip_labels: 
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR18MB2844:EE_|SJ0PR18MB4865:EE_
x-ms-office365-filtering-correlation-id: 9717229b-ce5b-4bc7-afde-08db68412a26
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: WrEi1yzRlXAQ+WzXsYtEc+WqgQMs7REtg7Am/FzBcJdRjdNduFtHYkWGYEZOvB4tvqTaiUnu/R1BV62SrVd8bbCyrh8gaxZa35GUEGm0HX/skkV8EOzjEFXdXsq0/dNvg0ouPF9ScgS+CJh2RU5RE0YHx66s9WUG7b/IS32vZTPxgVq6xZR95Jf7HqTrBlsrDbLZupk7X8qEWSXthBpxmNfgEOk1r08Neq+pCSmo7QbehQxsdRNr7VzcbvYIbPC6wCqGvCtHXETwBlHytdHV/TMfgyh8+qdZLLtj3Cnfzu2wvt2ziNKhIfD5Umh/ne7UAvudEF5Zugud+bQMqzPYmLvvmULoVfSxFwXO9Mzmn1uhiI+nga2OLpRE22RMkB1TyIpNz2H95Fm/USCrmc+6EW4ZG0Tws+mKRCy/HOJBywDObYIeINsynoOUZOKFnvjpHOhrulAjkzEBqU/iX2CfWhEP5orzF7Lt4YObOEpN46DRfE3S/x883w3vfmx8aJkPTJfqPYUvUWvr6me2DVXiZrtQ9znQSTd/W8/jT1W1BYJoLm5GZ69XhtR8Repapul7190G9w1Fs55n1KQTUjKNgCaeUzBa5OTUu8fyKJgQOtc=
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR18MB2844.namprd18.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(39850400004)(396003)(376002)(136003)(366004)(346002)(451199021)(186003)(83380400001)(2940100002)(478600001)(38070700005)(71200400001)(45080400002)(9686003)(53546011)(6506007)(26005)(8936002)(55016003)(86362001)(122000001)(66556008)(316002)(7416002)(66446008)(76116006)(6916009)(66476007)(91956017)(5660300002)(7696005)(66946007)(30864003)(2906002)(4326008)(966005)(64756008)(38100700002)(33656002)(52536014)(41300700001)(8676002)(54906003);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?iso-8859-1?Q?X0l3U8LQEGPGDpkqH3G/3m9SzJmyKeKC0OaPhhbXZNPOlCwnd1bGQLpOpq?=
 =?iso-8859-1?Q?v40h4vSGMPJBF/7tNj0To8M1YwAmcHwJJNP+7116I98kItYvxgP19bFU++?=
 =?iso-8859-1?Q?ypRjGrD1rox4XsAr39FyPH8Tcj7zBKv33W6de7v184h7DWcTRR1S5drJbb?=
 =?iso-8859-1?Q?Bdz3xYDztwWo5C4SFNhi4bncMcBJdi4SpWQYEY5hLyfDbyyeS93QEbBgev?=
 =?iso-8859-1?Q?gdeWxvWaZNS0X6zJ8hvryRr9m1x70YVu2T3WUjuXbJT4lOG6QBdMzjlzOA?=
 =?iso-8859-1?Q?IZMXTW6Py+vowh/AjWGs92AqA4GIn7TOlrANhu/gcdHMsa9RkX4K6ppK1U?=
 =?iso-8859-1?Q?s7fse6DTjI91QBpZDNoSh7tgM1R9E9/sBLKpXvXTlVg50WwB/zqnpW/IpU?=
 =?iso-8859-1?Q?41afwTMR9fMO2h2RVV213Jlf2qzxxnmHA8r0trhp5AMHn6XGw6ee9ujgxW?=
 =?iso-8859-1?Q?AUZAXHe3MVUP+u+3x7heO7NuxHMyx4cbZDan/agXVOOyshCUNSyvUc+4fo?=
 =?iso-8859-1?Q?AE4HEMEogs6tNcbgdCFQg81HpElJPkXLWQUjLCZTRXITl8FuZCwa9sbaPM?=
 =?iso-8859-1?Q?CsnOxfX1lsbXJ9xF6Pp0Y6/CC23UwgC0QOQUttikXzOYMcVNbuOtA75KwK?=
 =?iso-8859-1?Q?0b0nSHA42Gokkov4fPTb5NHqzyQs8lHmHS6GTxfSH02uv7625xpU/jxSh4?=
 =?iso-8859-1?Q?W6uVCDxzBvtECv8PV+tgetnzSFTaKyK0UTpcySg+SJD7iixZEVipjy5auF?=
 =?iso-8859-1?Q?6yZ1EzbGbKyx0LNqLPZ7KVu+91Z+0/tbmeFmB3c+N4I02/zlxwVwSx3MLy?=
 =?iso-8859-1?Q?QC7iyaAw7Gjlv+IJ9aSkGdV/UbJWE57dQroaUjP15E6vxlfv4+nNkkaan7?=
 =?iso-8859-1?Q?Hbt6h1xv+N5a4lCI/LwzOwQ33fCMkkS7ntDhKsAWdrAdu1MjNnviDLAL3a?=
 =?iso-8859-1?Q?D/fiwxn2Tus88DICrVBQaqSDlWqyu8GHeIA4bJuspJHYdt2C93nLYDjqb4?=
 =?iso-8859-1?Q?PfRULjefxmMTLvtRipm4nso2whM+6qeN39JaiFCM31hfupR7sgZxV8wBrh?=
 =?iso-8859-1?Q?maH3O63UvWCzXMqyMSzJrqL/VZRWkodtr3fNmRN/U8sNcDX5Kk1Zaoeii6?=
 =?iso-8859-1?Q?rYx+CaoEt/rKFkAeIvzcp9J0ZEmf+q5Y/v1FRHtrZOBaCjxDmoonBgoua6?=
 =?iso-8859-1?Q?kspRG1E6ohqPmRJtINMII2rL76EquagokI8LGd4xhfSFwW0824+ZaO4OIr?=
 =?iso-8859-1?Q?XIMJCUbeR3gIi1fELqxmIiz9k4YAMEkEkKvrbU9nmAvR8XMPvaB2lPa+40?=
 =?iso-8859-1?Q?cmUHZBctbhcx8Wp1XdStpzMLx3UXvMk5095pk/N/AXB67oaBdIx2h8KB0g?=
 =?iso-8859-1?Q?+p2CEf0jKMD5sj4QhjLqw39w8YoG+OdUSB8gl66isSiK9PqGMJD9bV1NXw?=
 =?iso-8859-1?Q?YHjAmaHtaVGtMNjQwqwTKYjejf29sjOjEwwTwSBf9emwgRlS0b56NKzH5c?=
 =?iso-8859-1?Q?Rkj3bzBUht4cy2poc5FjIAVl0dqhvlQeqyN78MaVd16DkAI4iSM4EdnuUt?=
 =?iso-8859-1?Q?OXPxZagobLMtD82RTwWjxTd1OEOaa7nVobGbxC1Raqmcb1DMUSlyI5DvqY?=
 =?iso-8859-1?Q?hb7S1jZZEoCdA=3D?=
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: marvell.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR18MB2844.namprd18.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 9717229b-ce5b-4bc7-afde-08db68412a26
X-MS-Exchange-CrossTenant-originalarrivaltime: 08 Jun 2023 16:55:29.2077
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 70e1fb47-1155-421d-87fc-2e58f638b6e0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: dpY72ero8g3pbWWb4jmNwbkKUupZhDA2OQ5qQDhgwVTjM35a9fdnQBbdEjPx4qJBidYkP3nqXaqkCm/lIoG/SQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR18MB4865
X-Proofpoint-GUID: 8IuKfNFmquPD8AKH39PYGpzAOdI9Gxyk
X-Proofpoint-ORIG-GUID: AU4vBXyjRJwuAEm0N1PoVFXkjB5-_wKR
X-Proofpoint-Virus-Version: vendor=baseguard
 engine=ICAP:2.0.254,Aquarius:18.0.957,Hydra:6.0.573,FMLib:17.11.176.26
 definitions=2023-06-08_12,2023-06-08_01,2023-05-22_02
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 21515
Lines: 474

Here is the repo where I am committing my changes=0A=
=0A=
https://gitlab.com/sheshas/qemu-fmapi/-/commits/cxl-2023-05-25=0A=
=0A=
=0A=
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
Sent: Thursday, June 8, 2023 8:20 AM=0A=
To: Jonathan Cameron <Jonathan.Cameron@Huawei.com>=0A=
Cc: Fan Ni <fan.ni@samsung.com>; qemu-devel@nongnu.org <qemu-devel@nongnu.o=
rg>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.org>; gregory.price@m=
emverge.com <gregory.price@memverge.com>; hchkuo@avery-design.com.tw <hchku=
o@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@avery-design.com>; =
dan.j.williams@intel.com <dan.j.williams@intel.com>; Adam Manzanares <a.man=
zanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.net>; nmtadam.samsun=
g@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.com <nifan@outlook.c=
om>; Ira Weiny <ira.weiny@intel.com>=0A=
Subject: Re: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qe=
mu =0A=
=A0=0A=
=0A=
=0A=
=0A=
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>=0A=
Sent: Thursday, June 8, 2023 2:43 AM=0A=
To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
Cc: Fan Ni <fan.ni@samsung.com>; qemu-devel@nongnu.org <qemu-devel@nongnu.o=
rg>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.org>; gregory.price@m=
emverge.com <gregory.price@memverge.com>; hchkuo@avery-design.com.tw <hchku=
o@avery-design.com.tw>; cbrowy@avery-design.com <cbrowy@avery-design.com>; =
dan.j.williams@intel.com <dan.j.williams@intel.com>; Adam Manzanares <a.man=
zanares@samsung.com>; dave@stgolabs.net <dave@stgolabs.net>; nmtadam.samsun=
g@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook.com <nifan@outlook.c=
om>; Ira Weiny <ira.weiny@intel.com>=0A=
Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =
=0A=
=A0=0A=
External Email=0A=
=0A=
----------------------------------------------------------------------=0A=
On Wed, 7 Jun 2023 18:52:14 +0000=0A=
Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com> wrote:=0A=
=0A=
> From: Fan Ni <fan.ni@samsung.com>=0A=
> Sent: Wednesday, June 7, 2023 11:31 AM=0A=
> To: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
> Cc: Jonathan Cameron <Jonathan.Cameron@Huawei.com>; qemu-devel@nongnu.org=
 <qemu-devel@nongnu.org>; linux-cxl@vger.kernel.org <linux-cxl@vger.kernel.=
org>; gregory.price@memverge.com <gregory.price@memverge.com>; hchkuo@avery=
-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com <cbrow=
y@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.com>; A=
dam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@stgolabs=
.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; nifan@outlook=
.com <nifan@outlook.com>; Ira Weiny <ira.weiny@intel.com>=0A=
> Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu=
 =0A=
> =A0=0A=
> External Email=0A=
> =0A=
> ----------------------------------------------------------------------=0A=
> On Wed, Jun 07, 2023 at 06:13:01PM +0000, Shesha Bhushan Sreenivasamurthy=
 wrote:=0A=
> > Hi Fan,=0A=
> >=A0=A0=A0 I am implementing DCD FMAPI commands and planning to start pus=
hing changes to the below branch. That requires the contributions you have =
made. Can your changes be pushed to the below branch ?=0A=
> > =0A=
> > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-20=
23-05-25__;!!EwVzqGoTKBqv-0DWAJBm!Vt5uIqwW-L4c4gh02ulI4M762JNQ3_aE9k9lb6Qlw=
E2xm6T23ic7ig7Y77i1VN7l_RX_ySIQhre_z7Q0JA$=A0=A0 =0A=
> =0A=
> Can you push changes to the branch directly? I think it is Jonathan's pri=
vate=0A=
> branch. However, I can fork the branch and rebase my patch series atop an=
d=0A=
> share with you the new repo if that helps you move forward your=0A=
> work.=0A=
> Let me know your thought.=0A=
> =0A=
> ss - I saw commits from others, so assumed you can. Since it is Jonathan'=
s private repo, I will step back and let him answer.=0A=
=0A=
I tend to apply stuff in manually rather than given more people commit acce=
ss=0A=
to that particular gitlab tree. =0A=
=0A=
Easiest option is to fork on gitlab and share the path of your own fork.=0A=
=0A=
I normally queue reasonably mature stuff up on my tree, but that's about ma=
naging=0A=
the series sent with intent of being applied upstream + providing a fairly =
stable test=0A=
branch.=A0 It's not intended as a general place for stuff in development (t=
hough I might=0A=
sneak out an extra branch myself from time to time if I want to talk about =
it :)=0A=
=0A=
Jonathan=0A=
=0A=
ss - Thanks ! I have forked Jonathan's repo on Gitlab and will work of cxl-=
2023-05-25 branch. I will apply Fan's patch manually and continue ..=0A=
=0A=
> =0A=
> Fan=0A=
> =0A=
> > =0A=
> > =0A=
> > From: Fan Ni <fan.ni@samsung.com>=0A=
> > Sent: Monday, June 5, 2023 10:51 AM=0A=
> > To: Ira Weiny <ira.weiny@intel.com>=0A=
> > Cc: qemu-devel@nongnu.org <qemu-devel@nongnu.org>; jonathan.cameron@hua=
wei.com <jonathan.cameron@huawei.com>; linux-cxl@vger.kernel.org <linux-cxl=
@vger.kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>;=
 hchkuo@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-desi=
gn.com <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@=
intel.com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <=
dave@stgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>; =
nifan@outlook.com <nifan@outlook.com>=0A=
> > Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =0A=
> > =A0=0A=
> > On Mon, Jun 05, 2023 at 10:35:48AM -0700, Ira Weiny wrote:=A0 =0A=
> > > Fan Ni wrote:=A0 =0A=
> > > > Since the early draft of DCD support in kernel is out=0A=
> > > > (https://urldefense.com/v3/__https://lore.kernel.org/linux-cxl/2023=
0417164126.GA1904906@bgt-140510-bm03/T/*t__;Iw!!EwVzqGoTKBqv-0DWAJBm!RHzXPI=
cSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21LzAGN=
Ok$ ),=0A=
> > > > this patch series provide dcd emulation in qemu so people who are i=
nterested=0A=
> > > > can have an early try. It is noted that the patch series may need t=
o be updated=0A=
> > > > accordingly if the kernel side implementation changes.=A0 =0A=
> > > =0A=
> > > Fan,=0A=
> > > =0A=
> > > Do you have a git tree we can pull this from which is updated to a mo=
re=0A=
> > > recent CXL branch from Jonathan?=0A=
> > > =0A=
> > > Thanks,=0A=
> > > Ira=A0 =0A=
> > =0A=
> > Hi Ira,=0A=
> > =0A=
> > I have a git tree of the patch series based on Jonathan's branch=0A=
> > cxl-2023-02-28: https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__=
github.com_moking_qemu-2Ddev_tree_dcd-2Drfe&d=3DDwIFAg&c=3DnKjWec2b6R0mOyPa=
z7xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3Dw6dicn5kXEG4Imk6=
TpICIjdA6KJ-xt84dtHui-Y0fv5H13bijtzEvjxECKE5MHYf&s=3D3yeO9RN5FY3gPfO2y19X05=
7YeqRTTQTQNfNA-Gfir_Q&e=3D .=0A=
> > =0A=
> > That may be not new enough to include some of the recent patches, but I=
 can=0A=
> > rebase it to a newer branch if you can tell me which branch you want to=
 use.=0A=
> > =0A=
> > Thanks,=0A=
> > Fan=0A=
> >=A0=A0 =0A=
> > >=A0=A0 =0A=
> > > > =0A=
> > > > To support DCD emulation, the patch series add DCD related mailbox =
command=0A=
> > > > support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory =
device=0A=
> > > > with dynamic capacity extent and region representative.=0A=
> > > > To support read/write to the dynamic capacity of the device, a host=
 backend=0A=
> > > > is provided and necessary check mechnism is added to ensure the dyn=
amic=0A=
> > > > capacity accessed is backed with active dc extents.=0A=
> > > > Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is no=
t supported=0A=
> > > > , but we add two qmp interfaces for adding/releasing dynamic capaci=
ty extents.=0A=
> > > > Also, the support for multiple hosts sharing the same DCD case is m=
issing.=0A=
> > > > =0A=
> > > > Things we can try with the patch series together with kernel dcd co=
de:=0A=
> > > > 1. Create DC regions to cover the address range of the dynamic capa=
city=0A=
> > > > regions.=0A=
> > > > 2. Add/release dynamic capacity extents to the device and notify th=
e=0A=
> > > > kernel.=0A=
> > > > 3. Test kernel side code to accept added dc extents and create dax =
devices,=0A=
> > > > and release dc extents and notify the device=0A=
> > > > 4. Online the memory range backed with dc extents and let applicati=
on use=0A=
> > > > them.=0A=
> > > > =0A=
> > > > The patch series is based on Jonathan's local qemu branch:=0A=
> > > > https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cx=
l-2023-02-28__;!!EwVzqGoTKBqv-0DWAJBm!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOI=
eUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7lr21OO3UHEM$ =0A=
> > > > =0A=
> > > > Simple tests peformed with the patch series:=0A=
> > > > 1 Install cxl modules:=0A=
> > > > =0A=
> > > > modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem=0A=
> > > > =0A=
> > > > 2 Create dc regions:=0A=
> > > > =0A=
> > > > region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)=0A=
> > > > echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region=0A=
> > > > echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity=0A=
> > > > echo 1 > /sys/bus/cxl/devices/$region/interleave_ways=0A=
> > > > echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode=0A=
> > > > echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size=0A=
> > > > echo 0x10000000 > /sys/bus/cxl/devices/$region/size=0A=
> > > > echo=A0 "decoder2.0" > /sys/bus/cxl/devices/$region/target0=0A=
> > > > echo 1 > /sys/bus/cxl/devices/$region/commit=0A=
> > > > echo $region > /sys/bus/cxl/drivers/cxl_region/bind=0A=
> > > > =0A=
> > > > /home/fan/cxl/tools-and-scripts# cxl list=0A=
> > > > [=0A=
> > > >=A0=A0 {=0A=
> > > >=A0=A0=A0=A0 "memdevs":[=0A=
> > > >=A0=A0=A0=A0=A0=A0 {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "memdev":"mem0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "pmem_size":536870912,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "ram_size":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "serial":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "host":"0000:0d:00.0"=0A=
> > > >=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0 ]=0A=
> > > >=A0=A0 },=0A=
> > > >=A0=A0 {=0A=
> > > >=A0=A0=A0=A0 "regions":[=0A=
> > > >=A0=A0=A0=A0=A0=A0 {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "region":"region0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "resource":45365592064,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "size":268435456,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_ways":1,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "interleave_granularity":256,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0 "decode_state":"commit"=0A=
> > > >=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0 ]=0A=
> > > >=A0=A0 }=0A=
> > > > ]=0A=
> > > > =0A=
> > > > 3 Add two dc extents (128MB each) through qmp interface=0A=
> > > > =0A=
> > > > { "execute": "qmp_capabilities" }=0A=
> > > > =0A=
> > > > { "execute": "cxl-add-dynamic-capacity-event",=0A=
> > > >=A0=A0=A0=A0=A0 "arguments": {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "path": "/machine/periphe=
ral/cxl-pmem0",=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "region-id" : 0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "num-extent": 2,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "dpa":0,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 "extent-len": 128=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > > }=0A=
> > > > =0A=
> > > > /home/fan/cxl/tools-and-scripts# lsmem=0A=
> > > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE=A0=A0 BL=
OCK=0A=
> > > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0=A0=A0 0-15=0A=
> > > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0=A0 32-79=0A=
> > > > 0x0000000a90000000-0x0000000a9fffffff=A0 256M offline=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0 338-339=0A=
> > > > =0A=
> > > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > > Total online memory:=A0=A0=A0=A0=A0=A0 8G=0A=
> > > > Total offline memory:=A0=A0=A0 256M=0A=
> > > > =0A=
> > > > =0A=
> > > > 4.Online the momory with 'daxctl online-memory dax0.0' to online th=
e memory=0A=
> > > > =0A=
> > > > /home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0=0A=
> > > > [=A0 230.730553] Fallback order for Node 0: 0 1=0A=
> > > > [=A0 230.730825] Fallback order for Node 1: 1 0=0A=
> > > > [=A0 230.730953] Built 2 zonelists, mobility grouping on.=A0 Total =
pages: 2042541=0A=
> > > > [=A0 230.731110] Policy zone: Normal=0A=
> > > > onlined memory for 1 device=0A=
> > > > =0A=
> > > > root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem=0A=
> > > > RANGE=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 SIZE=A0=A0 STATE REMOVABLE BLOCK=0A=
> > > > 0x0000000000000000-0x000000007fffffff=A0=A0=A0 2G=A0 online=A0=A0=
=A0=A0=A0=A0 yes=A0 0-15=0A=
> > > > 0x0000000100000000-0x000000027fffffff=A0=A0=A0 6G=A0 online=A0=A0=
=A0=A0=A0=A0 yes 32-79=0A=
> > > > 0x0000000a90000000-0x0000000a97ffffff=A0 128M=A0 online=A0=A0=A0=A0=
=A0=A0 yes=A0=A0 338=0A=
> > > > 0x0000000a98000000-0x0000000a9fffffff=A0 128M offline=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0 339=0A=
> > > > =0A=
> > > > Memory block size:=A0=A0=A0=A0=A0=A0 128M=0A=
> > > > Total online memory:=A0=A0=A0=A0 8.1G=0A=
> > > > Total offline memory:=A0=A0=A0 128M=0A=
> > > > =0A=
> > > > 5 using dc extents as regular memory=0A=
> > > > =0A=
> > > > /home/fan/cxl/ndctl# numactl --membind=3D1 ls=0A=
> > > > CONTRIBUTING.md=A0 README.md=A0 clean_config.sh=A0 cscope.out=A0=A0=
 git-version-gen=0A=
> > > > ndctl=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 scripts=A0=A0 test.h=
=A0=A0=A0=A0=A0 version.h.in COPYING=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 acpi.h=0A=
> > > > config.h.meson=A0=A0 cxl=A0=A0=A0=A0=A0=A0=A0=A0=A0 make-git-snapsh=
ot.sh=A0=A0 ndctl.spec.in=A0 sles=A0=A0=A0=A0 tools=0A=
> > > > Documentation=A0=A0=A0=A0=A0=A0=A0 build=A0=A0=A0=A0=A0=A0 contrib=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 daxctl=A0=A0=A0=A0=A0=A0=A0 meson.build=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rhel=0A=
> > > > tags=A0=A0=A0=A0=A0=A0=A0 topology.png LICENSES=A0=A0=A0 ccan=A0=A0=
=A0=A0=A0=A0=A0 cscope.files=0A=
> > > > git-version=A0 meson_options.txt=A0=A0=A0=A0=A0 rpmbuild.sh=A0=A0=
=A0 test=A0=A0=A0=A0 util=0A=
> > > > =0A=
> > > > =0A=
> > > > QEMU command line cxl configuration:=0A=
> > > > =0A=
> > > > RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-pat=
h=3D/tmp/cxltest.raw,size=3D512M \=0A=
> > > > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tm=
p/cxltest2.raw,size=3D512M \=0A=
> > > > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tm=
p/lsa.raw,size=3D512M \=0A=
> > > > -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \=0A=
> > > > -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,sl=
ot=3D2 \=0A=
> > > > -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa=
1,dc-memdev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\=0A=
> > > > -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interl=
eave-granularity=3D8k"=0A=
> > > > =0A=
> > > > =0A=
> > > > Kernel DCD support used to test the changes=0A=
> > > > =0A=
> > > > The code is tested with the posted kernel dcd support:=0A=
> > > > https://urldefense.com/v3/__https://git.kernel.org/pub/scm/linux/ke=
rnel/git/cxl/cxl.git/log/?h=3Dfor-6.5*dcd-preview__;Lw!!EwVzqGoTKBqv-0DWAJB=
m!RHzXPIcSiGsqUciUIH6HnlG_W--4L5CHfvcOIeUFdwKFhAujXuFDxjymmpCdOu7SLr61rww7l=
r21q5Iza3M$ =0A=
> > > > =0A=
> > > > commit: f425bc34c600e2a3721d6560202962ec41622815=0A=
> > > > =0A=
> > > > To make the test work, we have made the following changes to the ab=
ove kernel commit:=0A=
> > > > =0A=
> > > > diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c=0A=
> > > > index 5f04bbc18af5..5f421d3c5cef 100644=0A=
> > > > --- a/drivers/cxl/core/mbox.c=0A=
> > > > +++ b/drivers/cxl/core/mbox.c=0A=
> > > > @@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CX=
L_MEM_COMMAND_ID_MAX] =3D {=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),=
=0A=
> > > >=A0=A0=A0=A0=A0 CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOA=
D, 0),=0A=
> > > > +=A0=A0 CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),=0A=
> > > >=A0 };=0A=
> > > >=A0 =0A=
> > > >=A0 /*=0A=
> > > > diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c=
=0A=
> > > > index 291c716abd49..ae10e3cf43a1 100644=0A=
> > > > --- a/drivers/cxl/core/region.c=0A=
> > > > +++ b/drivers/cxl/core/region.c=0A=
> > > > @@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_regi=
on *cxlr)=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 cxlds->dc_list_gen_num =3D e=
xtent_gen_num;=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_dbg(cxlds->dev, "No of p=
reallocated extents :%d\n", rc);=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 enable_irq(cxlds->cxl_irq[CXL_EVENT=
_TYPE_DCD]);=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 /*enable_irq(cxlds->cxl_irq[CXL_EVE=
NT_TYPE_DCD]);*/=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > >=A0=A0=A0=A0=A0 return 0;=0A=
> > > >=A0 err:=0A=
> > > > @@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *c=
xlds, struct resource *alloc_dpa_re=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0 dev_dax->align, memremap_compat_align()))) {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 rc =3D alloc_dev_dax_range(d=
ev_dax, hpa,=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 resource_size(alloc_dpa_res))=
;=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (rc)=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=
=0A=
> > > >=A0=A0=A0=A0=A0 }=0A=
> > > >=A0 =0A=
> > > >=A0=A0=A0=A0=A0 rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_da=
x, GFP_KERNEL);=0A=
> > > > diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c=0A=
> > > > index 9e45b1056022..653bec203838 100644=0A=
> > > > --- a/drivers/cxl/pci.c=0A=
> > > > +++ b/drivers/cxl/pci.c=0A=
> > > > @@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_st=
ate *cxlds)=0A=
> > > >=A0 =0A=
> > > >=A0=A0=A0=A0=A0 /* Driver enables DCD interrupt after creating the d=
c cxl_region */=0A=
> > > >=A0=A0=A0=A0=A0 rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settin=
gs, CXL_EVENT_TYPE_DCD,=0A=
> > > > -=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_A=
UTOEN);=0A=
> > > > +=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 IRQF_SHARED | IRQF_ONESHOT);=0A=
> > > >=A0=A0=A0=A0=A0 if (rc) {=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 dev_err(cxlds->dev, "Failed =
to get interrupt for event dc log\n");=0A=
> > > >=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 return rc;=0A=
> > > > diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_=
mem.h=0A=
> > > > index 6ca85861750c..910a48259239 100644=0A=
> > > > --- a/include/uapi/linux/cxl_mem.h=0A=
> > > > +++ b/include/uapi/linux/cxl_mem.h=0A=
> > > > @@ -47,6 +47,7 @@=0A=
> > > >=A0=A0=A0=A0=A0 ___C(SCAN_MEDIA, "Scan Media"),=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(GET_SCAN_MEDIA, "Get Scan Media Results"),=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(GET_DC_EXTENT_LIST, "Get dynamic capacity exten=
ts"),=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > > +=A0=A0 ___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),=
=A0=A0=A0=A0=A0=A0=A0=A0 \=0A=
> > > >=A0=A0=A0=A0=A0 ___C(MAX, "invalid / last command")=0A=
> > > >=A0 =0A=
> > > >=A0 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a=0A=
> > > > =0A=
> > > > =0A=
> > > > =0A=
> > > > Fan Ni (7):=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to outp=
ut=0A=
> > > >=A0=A0=A0=A0 payload of identify memory device command=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add dynamic capacity region represe=
ntative=0A=
> > > >=A0=A0=A0=A0 and mailbox command support=0A=
> > > >=A0=A0 hw/mem/cxl_type3: Add a parameter to pass number of DC region=
s the=0A=
> > > >=A0=A0=A0=A0 device supports in qemu command line=0A=
> > > >=A0=A0 hw/mem/cxl_type3: Add DC extent representative to cxl type3 d=
evice=0A=
> > > >=A0=A0 hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add=
/release=0A=
> > > >=A0=A0=A0=A0 dynamic capacity response=0A=
> > > >=A0=A0 Add qmp interfaces to add/release dynamic capacity extents=0A=
> > > >=A0=A0 hw/mem/cxl_type3: add read/write support to dynamic capacity=
=0A=
> > > > =0A=
> > > >=A0 hw/cxl/cxl-mailbox-utils.c=A0 | 389 +++++++++++++++++++++++++++-=
=0A=
> > > >=A0 hw/mem/cxl_type3.c=A0=A0=A0=A0=A0=A0=A0=A0=A0 | 492 ++++++++++++=
+++++++++++++++++++-----=0A=
> > > >=A0 include/hw/cxl/cxl_device.h |=A0 50 +++-=0A=
> > > >=A0 include/hw/cxl/cxl_events.h |=A0 16 ++=0A=
> > > >=A0 qapi/cxl.json=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 |=A0 44 =
++++=0A=
> > > >=A0 5 files changed, 924 insertions(+), 67 deletions(-)=0A=
> > > > =0A=
> > > > -- =0A=
> > > > 2.25.1=A0 =0A=
> > > =0A=
> > >=A0 =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id EBC90C7EE25
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Jun 2023 18:10:39 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S235067AbjFHSKi (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Jun 2023 14:10:38 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40080 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232256AbjFHSKh (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Jun 2023 14:10:37 -0400
Received: from APC01-TYZ-obe.outbound.protection.outlook.com (mail-tyzapc01olkn2044.outbound.protection.outlook.com [40.92.107.44])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D3CF1194
        for <linux-cxl@vger.kernel.org>; Thu,  8 Jun 2023 11:10:35 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=WmbG2UEql+gCF58mOJ8SS+B4Qr011tkJJvhDRxXwPIvOR30j79WauMlK5chAiHBYPimstGmFbisNSxZiQF6XkI5VCSPfjCSW5ux9ZfoOXYjEh89LhGbJofVRoFbd0AzwEdLAEts5QiRqGD8rZ+IlS1uaecCO689xReqXMvlUUxMwdtLjt6jW4viwE+4gfqk7Ng8Fv9ogUxj6jFTkbXh8ZbYpSSIH3YJ8gkGyHzp1kR3Z59PD9yBnearCCcny9HPIAgQnMYT/H0DJuAA1eYdyvKX6DlsgKeHZq2w7VwaQculz3Nuj4T+VNPT0hBCbxK/0XvcjGo5waUxANKzuQdoA2A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=IHMSw/jr9b39nHptmAwUX4guO68jnnNCcK1LcX7VFo0=;
 b=OId1yOU8VYUnKEtpIQm2DvAMurV1ES+0lYDvYYMPJbfOD6ljjQZ9SQQVtwJfSFCbLCpEzVGENBQHDfgeVQggevoFu8MRdPZ6X96lASgDjCB8LZpyE+R6SYI+n5Otb4ye7oGcpXoQ4dbPVQA002bbCU3pFS8bv8FulqyA1bD1wUJvt0cVabb9gWMgtbDOHtZKinP7P5+hF5y2AlzkjrhipYa1RzM6w+EJpBgULu+84eDdH7Etz28z8S1TWU8Xa+X2Ymd9PV9KH8RcDWVvqCshmYW2xzOS50tVIVmZAtZYowecb9oSqlylywuD30rjVLKonV07ZwpC5q2YPS3k0OfgIg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=none; dmarc=none;
 dkim=none; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=outlook.com;
 s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=IHMSw/jr9b39nHptmAwUX4guO68jnnNCcK1LcX7VFo0=;
 b=id9LvR0Bi9KlgCkPsGZrajSH2EDzQjjVYgRTovnPOqsKs98UC0hGoNI/+ten6ImRyfV6q50+shz7cL3tw83w3jK8ckrWr+RPc+Xw4ovNXrFilMDulCRYFKnq3DcPVeYFvr0Ix7Il3AsBUn8Q4H8Nk1anV4mdt1mMwAZxj12BY3vSgK4y9igWE9Ht1oxEswjk2ILXshUMrfxPKrt5Rbrk+Ttx8q22i1VEEDD0miysiArZiz6GfLX2AK9FAL4Oy4BRTD9/wi6KL6ltWs/kcDNXd0mikr6P5bX82enCES/PApfUjDfaUvE2G0vPb9VqPEgOymp5rM3DJIiJKeB7X8j1tg==
Received: from SG2PR06MB3397.apcprd06.prod.outlook.com (2603:1096:4:7a::17) by
 SI2PR06MB5290.apcprd06.prod.outlook.com (2603:1096:4:1e6::9) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.6455.32; Thu, 8 Jun 2023 18:10:30 +0000
Received: from SG2PR06MB3397.apcprd06.prod.outlook.com
 ([fe80::33a7:c9e1:75ae:3227]) by SG2PR06MB3397.apcprd06.prod.outlook.com
 ([fe80::33a7:c9e1:75ae:3227%4]) with mapi id 15.20.6455.030; Thu, 8 Jun 2023
 18:10:29 +0000
Date: Thu, 8 Jun 2023 11:10:16 -0700
From: "nifan@outlook.com" <nifan@outlook.com>
To: Ira Weiny <ira.weiny@intel.com>, sheshas@marvell.com
Cc: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>,
        Fan Ni <fan.ni@samsung.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <SG2PR06MB3397ED98E693C77C97345792B250A@SG2PR06MB3397.apcprd06.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
 <20230511175609.2091136-1-fan.ni@samsung.com>
 <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
 <20230605175112.GA2290821@bgt-140510-bm03>
 <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <6481f70fca5c2_c82be29440@iweiny-mobl.notmuch>
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
In-Reply-To: <6481f70fca5c2_c82be29440@iweiny-mobl.notmuch>
X-TMN: [MFhblnyWeXvtqiRMGNDzoSpSt9Dw65qMRgVWrFtb0co=]
X-ClientProxiedBy: BYAPR01CA0033.prod.exchangelabs.com (2603:10b6:a02:80::46)
 To SG2PR06MB3397.apcprd06.prod.outlook.com (2603:1096:4:7a::17)
X-Microsoft-Original-Message-ID: <ZIIZiLKJ9Cdp0eAy@outlook.com>
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SG2PR06MB3397:EE_|SI2PR06MB5290:EE_
X-MS-Office365-Filtering-Correlation-Id: d8d4c245-1b45-446e-6769-08db684ba44b
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: k/4WKWoVCgNIt3N036b+jm98pcqUa6DTNpNtm87kV1Euvnr5bdUWkaTwoamOBL0jpNzLNmzOBATj53gG09JMiVnTLGqyXxq/Z85iS56bmLyNuZKuKrv98ucbiQ84VaYm11odxRS5aexED1t2DQH7jskDCS7199Z8yzxx1u43PT9NuTfZLB7iBV/C3FaH0TfHeweEe8mOE9s2RxypZlPYm8FyZ9zETeVcGo0OZhXTQ9+Qg+coLTSUHNDd4Vul+qbPEujRW5fEnAVaLXCvPrBx19Qg4nFxM0RLQpWNT/Xh+DuCDJWRdrihM/Fo4kk/zfgGMi+JE4JY14SNy5RYU/b9FvAXjGVjc52ZsuFebBooPgWaXU7N/Yil35x8H4ZQ38UWdutF6DRIE3WhP+HVCs9xVxbhUMFLqo2pBIzMskiodgMtSt1B3pvAaR6TyKD7agt8jQRbyzpD7V0eYpiMLghsQdfG5N4S+u7kUCUIngvbxcPTSEgCw9pvwQAcw9Tdjhv9pqLDJuzZ/S+/6m9n1MO+rVNdCC84vGm2/PbRlOrJ1JWQsxfU2t/T19kgKQyxdb6w2wpkeNyMzwrl4Rev/XKfrQrDhNU2JwF26bo4iih2TG8iZwB4y8CltoUt/XHDfFui50WNn7H9rph7HyADPe98Dg==
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?SFNRbUg0K1VNM1htYVNRaUxiTjhydXM5VHBnR2VnKy9BazNvT3JyTkI4TFQw?=
 =?utf-8?B?a2dCbmg2Y09UcENkZmFEd05sYk5maU1BcEhKbk1BbnhsZVdIL3JoRGZyRDhM?=
 =?utf-8?B?RnkyOTJuVksyOWZ4eXZRUHdweDlKN2NvRlhsL2xYaktsWk5rZjRlL2txTzhv?=
 =?utf-8?B?MTYxcVRjOTZOOXJ3azJKREVxQlVJd2tsVWtaY0h0WGZwTHZ4eGJHYVJWdmNC?=
 =?utf-8?B?UUJxMm5qWWNPVUdlZnhTVDd5OVg1MDBlbVRrajVFZkp4QXlDS0pIOFdKSXJ3?=
 =?utf-8?B?by95NFh2YjdDZlg5VEtvd2pCalJla0dqYlRrTkZORWVzVVVnbWtwaGFnOXRY?=
 =?utf-8?B?RDYvWXRtRUk5QU1OSWgvRGl6VlBCZWVYeWpmeXIyYjZTQjJJSFRaRERiaWdK?=
 =?utf-8?B?czBldk1YQ3hTeXBjc3B5QmN0NUlvRU9LSjdDL2l0YU5wRXVoTWJSS0VCRGg2?=
 =?utf-8?B?V0VXODJGOUFzZmt4MGlTZ2N1cm1QWjFNcmJnLzRCbllpR0F0MEZubUI1U0o3?=
 =?utf-8?B?K3FRcDZ1R3g3bDJSeUFWbjFQVHFTeld6UWtVQnZTdEUxM3psU29oVitCNWli?=
 =?utf-8?B?RldzMHBQbjJ5c2JBdUdtcWViWmxjSnNIRkFycUw4TTZBMWV1NVNqTThnWG01?=
 =?utf-8?B?WjJXWU50OTlLSTJvRnY1TWhnbUEyYURmVzZuNEtqMDd6ckpLQ1NxUDdRcVhZ?=
 =?utf-8?B?L0tDWExIajVnWHFOSTkwRmx0UFBPZnUyaHh4OXBOSmRpelNrYnJodjd3WEpH?=
 =?utf-8?B?aHBoeUtEdGx5WHdkQ3hlcGtOeFU5bmM2ekg0RnBlaGNsZnZkMnhKRGY4eXVq?=
 =?utf-8?B?SlhKelhCUW01SEtiUG43VG0xeVdCbTVRdFFBZzhFdnE1Q09kMXJZbHZOZENX?=
 =?utf-8?B?a0tQb3ZYTElDcHFlYkFuVEZscWtCT01scVlmTkxuRTduVGtKMkZXY25IR0h5?=
 =?utf-8?B?NUtOaWRKRzlYbHRZek1kdnc3NC9oMDdmc2NWQXR5TDBRN09YUVFoVFhUY1gw?=
 =?utf-8?B?RUJ2MFlNaW8zUVBod0ZGU2lwTUx3bDJkYTA4QzJUaHVUODRSeVJiMmpvN1ZK?=
 =?utf-8?B?K1MzdTJRdk5ZWmNmRnphZ3dPZlA4UjdWODY0blJKdG5udTNpQjJrT2RHemVN?=
 =?utf-8?B?ZjAxeFNyL0RlN3c0UnBEYkpPRDByM0RWNHhFVUtNMXByK2lWRHRSUTRrdGI5?=
 =?utf-8?B?c1FCOXVaREFrMjhJbTNETW00STQvQndLdjRWYkk5Y3UydlovOEdXQ0w2QlpJ?=
 =?utf-8?B?UGtJQU5WeElYK3NCWURXd1h5Y1V5Ym4xb2ZNeUJyRGhNZUVod3JRT2V4Yjhu?=
 =?utf-8?B?NnFKaUYrZmdKTEFUL2xMVjhPdTZMdDFEV2hpZDU2RHNncmkxWmhhMDQ3YTQ0?=
 =?utf-8?B?SGdxQlBlUFlGQW01dktMaDUxbmtqbVBCN1QwYVJOaVl6Mi9YVXV1d1p5SnI0?=
 =?utf-8?B?QjRTVHNrWmxEbzVLb3oxMWZzUitUQytjdktvbDdBL3VOSGtTWnpLQU44UEIv?=
 =?utf-8?B?N0U2eUJFcDFMOUp0RVlESzVEZm43eXFkbmR6amZrUGdLQXNlUlBWR2pVTStp?=
 =?utf-8?B?bzdxMUU5aUllN296RzdPWDdCQzRZZTVpck5mY0pqdkFsSzJnK0dVUFJWaU1t?=
 =?utf-8?Q?DmQS+YxO6IfeeJZJ2V1Ou8DDFzz8c4rBhSnQOYQY852Y=3D?=
X-OriginatorOrg: outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: d8d4c245-1b45-446e-6769-08db684ba44b
X-MS-Exchange-CrossTenant-AuthSource: SG2PR06MB3397.apcprd06.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Jun 2023 18:10:29.7341
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 84df9e7f-e9f6-40af-b435-aaaaaaaaaaaa
X-MS-Exchange-CrossTenant-RMS-PersistedConsumerOrg: 00000000-0000-0000-0000-000000000000
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SI2PR06MB5290
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 795
Lines: 23

The 06/08/2023 08:43, Ira Weiny wrote:
> Shesha Bhushan Sreenivasamurthy wrote:
> > Hi Fan,
> >    I am implementing DCD FMAPI commands and planning to start pushing changes to the below branch. That requires the contributions you have made. Can your changes be pushed to the below branch ?
> > 
> > https://gitlab.com/jic23/qemu/-/tree/cxl-2023-05-25
> 
> This is the branch I'm trying to use as well.
> 
> Thanks,
> Ira

Hi Ira & Shesha,
FYI. I reabased my patch series on top of the above branch and created a new
branch here:

https://github.com/moking/qemu-dcd-preview-latest/tree/dcd-preview

It passes the same tests as shown here:
https://lore.kernel.org/linux-cxl/6481f70fca5c2_c82be29440@iweiny-mobl.notmuch/T/#m76f6e85ce3d7292b1982960eb22086ee03922166

-- 
Fan Ni <nifan@outlook.com>

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id CAB27C7EE2E
	for <linux-cxl@archiver.kernel.org>; Fri,  9 Jun 2023 21:07:12 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230044AbjFIVHL (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Fri, 9 Jun 2023 17:07:11 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51524 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229530AbjFIVHK (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Fri, 9 Jun 2023 17:07:10 -0400
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6619B1FDC
        for <linux-cxl@vger.kernel.org>; Fri,  9 Jun 2023 14:07:09 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1686344829; x=1717880829;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=NLoJ/OxNviJlL5lq8UNbLuQnXWATxLli8g63wko0Sek=;
  b=JTv58xh5qBXofCeKnHsjPt1wPpfD+IaK+St95xLtpIGzKcUB1YvAdCtZ
   yMxNITR89HcY/uy4sdhCA30Numbfdpo9orIG+xS8GBbTLomjQmSyQ+8De
   QQ8dXwZpeh+dsCk3DzZMGB4LC+JOTGPwecJlp4lijPcd36wDdEUxP4xC8
   47JizsMVjgIwoa3bBdBGXdeBKcYrCyyRcrEvgvbILPcPm+raXZhx++WZl
   Ejn9A8kqjEEfNsDunM73rng7n/A7fscX/wvvjuC9ZwyBHdImJh+k80ay4
   teIYjEGoiW3/v+WBIzEJaIRR+x+OyuXM+hQmKFC6i5q72QDWQBu2wctCw
   A==;
X-IronPort-AV: E=McAfee;i="6600,9927,10736"; a="347334925"
X-IronPort-AV: E=Sophos;i="6.00,230,1681196400"; 
   d="scan'208";a="347334925"
Received: from orsmga007.jf.intel.com ([10.7.209.58])
  by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Jun 2023 14:07:08 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6600,9927,10736"; a="704681096"
X-IronPort-AV: E=Sophos;i="6.00,230,1681196400"; 
   d="scan'208";a="704681096"
Received: from fmsmsx601.amr.corp.intel.com ([10.18.126.81])
  by orsmga007.jf.intel.com with ESMTP; 09 Jun 2023 14:07:07 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx601.amr.corp.intel.com (10.18.126.81) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Fri, 9 Jun 2023 14:07:07 -0700
Received: from fmsmsx612.amr.corp.intel.com (10.18.126.92) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23; Fri, 9 Jun 2023 14:07:06 -0700
Received: from FMSEDG603.ED.cps.intel.com (10.1.192.133) by
 fmsmsx612.amr.corp.intel.com (10.18.126.92) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.23 via Frontend Transport; Fri, 9 Jun 2023 14:07:06 -0700
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (104.47.55.176)
 by edgegateway.intel.com (192.55.55.68) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.23; Fri, 9 Jun 2023 14:07:05 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=GazuwbwlemBcPr8x1oCqZ1mPOAburDMhGOuBU1Nb1zpTH2YVfbhtO0baOwgoo2lbAFTUY1NYYz3xzm/dcsQ7PuL8Oe5jcKhYrQQ10rKs5DP1eJ/oxsJnWYbouXnm+6VgHmzncAhvcvW2LCpmNC0UAOi68sny+NSGY2mkOy9Vf5bu/Z/q5SRSNzgZjdnQkhRCuS/r5oKKZK5XgNTYek7+IwD9YLWkc7bSWQDYVgTDauHp/q1gpMzk+L2WaUMDPb/++8uXFOcNC0G9F25BPTEfhbswouXau6CGJiL7oIcYJfvxgm6cg6xkXea2GKUo24qfJXxsokcPss/C9FzTgkcU4Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=EUlQrdIvJVLyn+fgOQahxLv72A+dOaCVnTda47phocE=;
 b=QggqiHTNxtZiJyzdvcxRBe1rJbasCbwgmCpBWf2gp3oA/IlVmvg+YI1oCs99mn6vZg6EU616eF6ozPLiaFSpitWUmuotQL+RWZ5f63T00hsn8JTJmEhhiw3mjcSgzTyjSgIiUPtjLHlbsmd4dN5szqePLfFDeq4gT6t8W/SPD0kocLj4TvbOpFY8zywg8rRduAjzU888AYoNUdll9QGk8hAmZ8OjrtsfQWwwqfmdBJ9mqASUH6J2CrDlNz+7fu7lRk8Faga4rm7q6XWqV0KwwjvL11S5/nRJbTu2tY4BgvDIvsnlLyZSOSBCt9yE9WSB9DB4QOhIEZDA4+vMa1b8lw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by MW5PR11MB5810.namprd11.prod.outlook.com (2603:10b6:303:192::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.31; Fri, 9 Jun
 2023 21:06:58 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::7237:cab8:f7f:52a5]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::7237:cab8:f7f:52a5%6]) with mapi id 15.20.6455.037; Fri, 9 Jun 2023
 21:07:03 +0000
Date: Fri, 9 Jun 2023 14:06:54 -0700
From: Ira Weiny <ira.weiny@intel.com>
To: "nifan@outlook.com" <nifan@outlook.com>,
        Ira Weiny <ira.weiny@intel.com>, <sheshas@marvell.com>
CC: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>,
        Fan Ni <fan.ni@samsung.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>
Subject: Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Message-ID: <6483946e8152f_f1132294a2@iweiny-mobl.notmuch>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
 <20230511175609.2091136-1-fan.ni@samsung.com>
 <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
 <20230605175112.GA2290821@bgt-140510-bm03>
 <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <6481f70fca5c2_c82be29440@iweiny-mobl.notmuch>
 <SG2PR06MB3397ED98E693C77C97345792B250A@SG2PR06MB3397.apcprd06.prod.outlook.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <SG2PR06MB3397ED98E693C77C97345792B250A@SG2PR06MB3397.apcprd06.prod.outlook.com>
X-ClientProxiedBy: BY3PR05CA0036.namprd05.prod.outlook.com
 (2603:10b6:a03:39b::11) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|MW5PR11MB5810:EE_
X-MS-Office365-Filtering-Correlation-Id: 1408cd4e-d484-462e-b706-08db692d78b7
X-LD-Processed: 46c98d88-e344-4ed4-8496-4ed7712e255d,ExtAddr
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 9WvSW5/k+5lySrRUuuRMaRJxXx1Dn8vvbAnrBIwgTWbByjlRVVB48G8PjFG7c1WoXyLpVEgE3MBA+Of/Rqs6U/iWzfcPmh4NtY1Rjh/c02cDV70OaE1zbQCYxltwNwi+RvZdM3C4MJsQZS3C8FqARqNjwXll/3SaOlM2etBIHX2gYDI8KWprhUwEDiljU4Lkjuagh8tkxQgINrHYqWUCf0ocmnYufWJGr4Mo2JzOus8BHiXYugIxdVEMRE4xNIgN0Z3dd1pQI5ji/qDOAR39iWW+5CDcqKwzaFSmtkI7biR1UY6M29EpEsC2s34PiOS9tV0rlxNt/wvGtIPZZoQMqx3nkc9cBHKyesQnFHMlvpkXtbuuW/6zpTT4JBJt4OzkszeamI0avYxT+fwk29YG9f6tLEIL3imQcZVKsDednLUdlcEqgmtHTAJgXOjGNlbIvlZaX1DzkG3QEDN5CCa9tvHeKopnd2iSeqH6iukKjCdemW9w2T+h68j8g24FaNkh07aUBVRxIrd9Zp95Dxw7apo1y3tdE7GbGSmnP4ZfbaXtjekJRzHIxSWy2/cvUj07Wu2IoYAZQNKp9IaKmYF/mg==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(136003)(396003)(39860400002)(366004)(376002)(346002)(451199021)(478600001)(316002)(41300700001)(2906002)(110136005)(45080400002)(54906003)(44832011)(7416002)(5660300002)(6486002)(8936002)(66946007)(66556008)(4326008)(8676002)(66476007)(6666004)(26005)(38100700002)(6512007)(6506007)(966005)(9686003)(82960400001)(186003)(83380400001)(86362001);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?UPY2Fx+k01G4u8TS4PHG1h5mZjZt66it8DyBsxQmeuDOEr0LiDkvUkSVXeZa?=
 =?us-ascii?Q?bj07lhUVcSz7G6GdusY0uTJawrRFrvmwRnhxogl5zJmGNmd7BIDI6P7kNwNC?=
 =?us-ascii?Q?88OmKxA00HBfMRNzAoIJ8kooaCr0Be8+1xvahmLb2AtUkTUpOCtC7Et+qkDf?=
 =?us-ascii?Q?EuXO+YeHkO1xOdYyvfSOD5SlwRd7qL6zurFjvMQVtxWdr8WF8I3JLrhW1BlB?=
 =?us-ascii?Q?LixkV+juwAjzhp9kNYbA+KS/EWTX8QlbOJ8/P5QkAXviGXVJrKFQP1wSHjqv?=
 =?us-ascii?Q?L9nLCKQI93BtVrV6YJ6KdgXNy/mrPoYDKrEhPGUtP01ox8QtgvmwbGz8SEsD?=
 =?us-ascii?Q?cTeTiZp2jKeg1tY7+ONSDggZ529368YETqeRKdqfUmVPcQM6BlD4FDYkq+ON?=
 =?us-ascii?Q?NEL90U6lSbypivKWdkV3n4rJ7cgaMq9LOdCsoMptolcwdmZHXiBhbegnj1e5?=
 =?us-ascii?Q?Kc8ytJWrC62w1vw8XGNzFE9B+CNMvaybHc3RKLZg58TSX098Zvs7kfcn5HWW?=
 =?us-ascii?Q?BxsnIhIk0JvHCjY+2rJxyWgbfgKkwcKm8yyTJQ0Ytba7j2e9tOicnnXiPNzo?=
 =?us-ascii?Q?KChbBpqDq0MsHY5nF0WmJxuEhWEFO1VfMqppJRzc4aAKnORvNCqg1FsP0RV6?=
 =?us-ascii?Q?RrowdNoyQeIbSn6VhMPaVDDEsaFfCZlCB4SfvlZiwdJM0uLT0q37CDEIzy2f?=
 =?us-ascii?Q?ZTJDovP6Q6/9ToyUnCfdtN63ZO/M1q3WJZ3Yz+EtbYRRg75YDaBzeYGGgonS?=
 =?us-ascii?Q?lkoJ0sg0e21N7t/nEqLGM6BDE/TwvtOQNOiVPaBy2QBeptz7v8yq+6g3Hqrw?=
 =?us-ascii?Q?q6lDWKLoNWYwnb7CI1quQY80R8T6DYl0Bo0SfY8GcewQCnH4BGNZw3HePefQ?=
 =?us-ascii?Q?Qt32LqFAL6WZTTvswjQmTuaoLiIQ9YDXxwcHUsq69rnda2+t+BdK8erTU1DD?=
 =?us-ascii?Q?DiBQl1dFBRusLK2wM5m+yGmmskLingKJXheRFI+Cm74hWI2sCbGn2D1gKfuB?=
 =?us-ascii?Q?2tijji+tZarM5yEakVc80MMrOo32qIDz0yx0utv9ReRk0/G8Cj7pXcsZtqCB?=
 =?us-ascii?Q?5JF7f3kDYwkAxM1Sy1F3RBcljex20F8mVYhKDe9HzJsQfHXd6MGy8QHC81Un?=
 =?us-ascii?Q?7dsW0jAwsK+UBsF4CB7tllu8beb7Zy/TxEYPAV2Riu7D/FBMaLidMTuv9nHp?=
 =?us-ascii?Q?zFng6OzvBUNxysEXydBGPbUKjOq157B+nwr1P0G+W0kV9y5m/CH0ITOC07x6?=
 =?us-ascii?Q?He1dXyaJVSztju0iYhz2/AA9PAfVKIVF7vVUa5qscAn1Yb0r97vmOO4i4lWg?=
 =?us-ascii?Q?dxRfYaUhXQIhO7yEDUtXH/tx1irJUOZAIJmQQ9eDduGhxnd/6Y++q2ytkaIL?=
 =?us-ascii?Q?/YbCcQ67Mmm/Ajtn71MunLhvniEwn+tbnMrYd1NKdJS/6ZrWkTUn0nQnJchj?=
 =?us-ascii?Q?Duo+NP+K8lB7EbO9mnWTDcVtHxTqbgGYPDujZJcsPlCVQBUHASX4ZbZxtcRY?=
 =?us-ascii?Q?UZ7uI5g35qy0gSE7Li7Js/8jU15zHQfimtX04lbPvofGWuihYZGGg/JL98Fh?=
 =?us-ascii?Q?/VURZ/vcc74zbCzICMLANc784ncC8r8B4IEGsjmL?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 1408cd4e-d484-462e-b706-08db692d78b7
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Jun 2023 21:07:02.8679
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: lOPdw3QRDlrso7aV0Fa2o0p7sgVVcVZux0630u36QV3qeZZ+Ly7JNcYOBmK0BS2V67IFE3RE9GJtASpJZXjB5Q==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW5PR11MB5810
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 5549
Lines: 142

nifan@outlook.com wrote:
> The 06/08/2023 08:43, Ira Weiny wrote:
> > Shesha Bhushan Sreenivasamurthy wrote:

[snip]

> 
> Hi Ira & Shesha,
> FYI. I reabased my patch series on top of the above branch and created a new
> branch here:
> 
> https://github.com/moking/qemu-dcd-preview-latest/tree/dcd-preview

Thanks!

> 
> It passes the same tests as shown here:
> https://lore.kernel.org/linux-cxl/6481f70fca5c2_c82be29440@iweiny-mobl.notmuch/T/#m76f6e85ce3d7292b1982960eb22086ee03922166

I've not gotten very far with this testing.  But I did find that regular
type 3 devices don't work with this change.  I used the patch below to get
this working.  Was there something I was missing to configure a non-DCD
device?

I don't particularly like adding another bool to this call stack.  Seems
like this calls for a flags field but I want to move on to DCD work so I
hacked this in.

Ira

commit ed27935044dcbd2c6ba71f8411b218621f3f4167
Author: Ira Weiny <ira.weiny@intel.com>
Date:   Fri Jun 9 13:56:33 2023 -0700

    hw/mem/cxl_type3: Exclude DCD from CEL when type3 is not DCD
    
    Per CXL 3.0 9.13.3 Dynamic Capacity Device (DCD) when the type 3 memory
    device does not have DCD support the CEL should not include DCD
    configuration commands.
    
    If the number of DC regions supported is 0 skip the DCD commands in the
    CEL.
    
    Applies on top of Fan Ni's work here:
    https://github.com/moking/qemu-dcd-preview-latest/tree/dcd-preview
    
    Not-yet-Signed-off-by: Ira Weiny <ira.weiny@intel.com>

diff --git a/hw/cxl/cxl-device-utils.c b/hw/cxl/cxl-device-utils.c
index a4a2c6a80004..262e35935563 100644
--- a/hw/cxl/cxl-device-utils.c
+++ b/hw/cxl/cxl-device-utils.c
@@ -288,7 +288,7 @@ static void mailbox_reg_init_common(CXLDeviceState *cxl_dstate)
 
 static void memdev_reg_init_common(CXLDeviceState *cxl_dstate) { }
 
-void cxl_device_register_init_common(CXLDeviceState *cxl_dstate)
+void cxl_device_register_init_common(CXLDeviceState *cxl_dstate, bool is_dcd)
 {
     uint64_t *cap_hdrs = cxl_dstate->caps_reg_state64;
     const int cap_count = 3;
@@ -307,7 +307,7 @@ void cxl_device_register_init_common(CXLDeviceState *cxl_dstate)
     cxl_device_cap_init(cxl_dstate, MEMORY_DEVICE, 0x4000, 1);
     memdev_reg_init_common(cxl_dstate);
 
-    cxl_initialize_mailbox(cxl_dstate, false);
+    cxl_initialize_mailbox(cxl_dstate, false, is_dcd);
 }
 
 void cxl_device_register_init_swcci(CXLDeviceState *cxl_dstate)
@@ -329,7 +329,7 @@ void cxl_device_register_init_swcci(CXLDeviceState *cxl_dstate)
     cxl_device_cap_init(cxl_dstate, MEMORY_DEVICE, 0x4000, 1);
     memdev_reg_init_common(cxl_dstate);
 
-    cxl_initialize_mailbox(cxl_dstate, true);
+    cxl_initialize_mailbox(cxl_dstate, true, false);
 }
 
 uint64_t cxl_device_get_timestamp(CXLDeviceState *cxl_dstate)
diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 93b26e717c94..80e9cb9a8f04 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -1526,7 +1526,8 @@ static void bg_timercb(void *opaque)
     }
 }
 
-void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci)
+void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci,
+                            bool is_dcd)
 {
     if (!switch_cci) {
         cxl_dstate->cxl_cmd_set = cxl_cmd_set;
@@ -1534,6 +1535,9 @@ void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci)
         cxl_dstate->cxl_cmd_set = cxl_cmd_set_sw;
     }
     for (int set = 0; set < 256; set++) {
+        if (!is_dcd && set == DCD_CONFIG) {
+            continue;
+        }
         for (int cmd = 0; cmd < 256; cmd++) {
             if (cxl_dstate->cxl_cmd_set[set][cmd].handler) {
                 struct cxl_cmd *c = &cxl_dstate->cxl_cmd_set[set][cmd];
diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 329e8b5915b3..e6e6e125990c 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -1276,9 +1276,11 @@ static void ct3d_reset(DeviceState *dev)
     CXLType3Dev *ct3d = CXL_TYPE3(dev);
     uint32_t *reg_state = ct3d->cxl_cstate.crb.cache_mem_registers;
     uint32_t *write_msk = ct3d->cxl_cstate.crb.cache_mem_regs_write_mask;
+    bool is_dcd;
 
     cxl_component_register_init_common(reg_state, write_msk, CXL2_TYPE3_DEVICE);
-    cxl_device_register_init_common(&ct3d->cxl_dstate);
+    is_dcd = (ct3d->dc.num_regions != 0);
+    cxl_device_register_init_common(&ct3d->cxl_dstate, is_dcd);
 }
 
 static Property ct3_props[] = {
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index 1ccddcca7d0d..4621bba4f533 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -233,7 +233,7 @@ typedef struct cxl_device_state {
 void cxl_device_register_block_init(Object *obj, CXLDeviceState *dev);
 
 /* Set up default values for the register block */
-void cxl_device_register_init_common(CXLDeviceState *dev);
+void cxl_device_register_init_common(CXLDeviceState *dev, bool is_dcd);
 void cxl_device_register_init_swcci(CXLDeviceState *dev);
 
 /*
@@ -280,7 +280,7 @@ CXL_DEVICE_CAPABILITY_HEADER_REGISTER(MEMORY_DEVICE,
                                       CXL_DEVICE_CAP_HDR1_OFFSET +
                                           CXL_DEVICE_CAP_REG_SIZE * 2)
 
-void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci);
+void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci, bool is_dcd);
 void cxl_process_mailbox(CXLDeviceState *cxl_dstate);
 
 #define cxl_device_cap_init(dstate, reg, cap_id, ver)                      \

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id F1F0AC7EE29
	for <linux-cxl@archiver.kernel.org>; Sat, 10 Jun 2023 00:29:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229470AbjFJA3u (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Fri, 9 Jun 2023 20:29:50 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49482 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232532AbjFJA3q (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Fri, 9 Jun 2023 20:29:46 -0400
Received: from mx0b-0016f401.pphosted.com (mx0a-0016f401.pphosted.com [67.231.148.174])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CBA571734
        for <linux-cxl@vger.kernel.org>; Fri,  9 Jun 2023 17:29:44 -0700 (PDT)
Received: from pps.filterd (m0045849.ppops.net [127.0.0.1])
        by mx0a-0016f401.pphosted.com (8.17.1.19/8.17.1.19) with ESMTP id 359Ef627026529;
        Fri, 9 Jun 2023 17:28:35 -0700
Received: from pps.reinject (localhost [127.0.0.1])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r462d1u94-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Fri, 09 Jun 2023 17:28:35 -0700
Received: from m0045849.ppops.net (m0045849.ppops.net [127.0.0.1])
        by pps.reinject (8.17.1.5/8.17.1.5) with ESMTP id 35A0PpwD019776;
        Fri, 9 Jun 2023 17:28:34 -0700
Received: from nam04-mw2-obe.outbound.protection.outlook.com (mail-mw2nam04lp2173.outbound.protection.outlook.com [104.47.73.173])
        by mx0a-0016f401.pphosted.com (PPS) with ESMTPS id 3r462d1u92-1
        (version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=NOT);
        Fri, 09 Jun 2023 17:28:34 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Em8bzvyINFTCkxOTd/81bJc1CQaywW9m+3rVFcQ//AO8N6KJGXfMXjNRRFMqH7vmeLpKiypXnTLicXHV757AwC7jYewhPuQIhd9pGAWLR5By5or+uqWT2o7YNfYlWrg59Pn/gMbIqnpew402fX6RESHlr8kiUcFdnB2Vmcgy7hoAsk2+XJjQy5FTad8BIVCua6Mf2hoxLhdD65IJZclKwXAaVVZR5n/0qbtVZMYLL/xsWJ7bFwNGFeqDPDs4P9bDr5oRd8tj4uhhPd7qprMnuGROmpgu78j+vgtHqHlec+Xb9VorUslIMPZlrvjEpy6+rJpQxOyxXZhisv2sJ1RPPg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ZRecr593fS6PMmE3kMIp9F/XNaP0KigsCmAU8LJyO+s=;
 b=FpP0nG0n1e+q3Q596fwORYib5xrtIxbyvUcP3w0DiUjU06qVjrrsbzvR8DWXpiolIMPaYSdc8RwUINcbI03Rni1Z1yZtM5Ycz41e/mkd6enK6GFlR2rYJqXl8Y1yoc4YeHHQZ6mTdL1BJOPELy5bf+1QM5M+4niguVP7Io10SFEKRPS5AD0jU4mdlrmlbrBfBRVGh1vSd2iEPks3S+tU69z97r32rIba/iZIaFvnPB3GIPAl/UaXetiTRiggLoUyV7AsyIaqnTFg8E7/Lpb+WrGpIAYf69z0Cw4ZeBLysUv9NgoV5AXsv5dPein+yAW6N8kb/i3BoYgnXKfyIwhylA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=marvell.com; dmarc=pass action=none header.from=marvell.com;
 dkim=pass header.d=marvell.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=marvell.onmicrosoft.com; s=selector1-marvell-onmicrosoft-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ZRecr593fS6PMmE3kMIp9F/XNaP0KigsCmAU8LJyO+s=;
 b=V1ZqdpivYinZo2Mhc79V1K4IZJwtfpc07d5Z7gutvi3f0OY5rR3Mp2swmoR7x4f63JhZ5TAiZsyX2Lv2cVaqo0J9qSum/IZD1gdvuDSWzmuEsQHCeUOrNjhtxijvoPKL46vXJ7j1cYNTmRlJXaFp2IiWe5hyYIjb0cAxvODZRoo=
Received: from DM6PR18MB2844.namprd18.prod.outlook.com (2603:10b6:5:16f::29)
 by MW4PR18MB5244.namprd18.prod.outlook.com (2603:10b6:303:1e0::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6455.33; Sat, 10 Jun
 2023 00:28:31 +0000
Received: from DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864]) by DM6PR18MB2844.namprd18.prod.outlook.com
 ([fe80::cd6c:c34b:dc45:b864%6]) with mapi id 15.20.6477.016; Sat, 10 Jun 2023
 00:28:31 +0000
From: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>
To: Ira Weiny <ira.weiny@intel.com>,
        "nifan@outlook.com" <nifan@outlook.com>
CC: Fan Ni <fan.ni@samsung.com>,
        Jonathan Cameron <Jonathan.Cameron@Huawei.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>
Subject: Re: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOK98n/AAgAAEVoCAAymO8IABaaOAgAApGQCAAcOuAIAAN6Fj
Date: Sat, 10 Jun 2023 00:28:30 +0000
Message-ID: <DM6PR18MB2844046EB9F1FDAC6116A188AF56A@DM6PR18MB2844.namprd18.prod.outlook.com>
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
 <20230511175609.2091136-1-fan.ni@samsung.com>
 <647e1cf4e7e5e_7471a2948f@iweiny-mobl.notmuch>
 <20230605175112.GA2290821@bgt-140510-bm03>
 <DM6PR18MB2844A78EB692A69CE10031E2AF53A@DM6PR18MB2844.namprd18.prod.outlook.com>
 <6481f70fca5c2_c82be29440@iweiny-mobl.notmuch>
 <SG2PR06MB3397ED98E693C77C97345792B250A@SG2PR06MB3397.apcprd06.prod.outlook.com>
 <6483946e8152f_f1132294a2@iweiny-mobl.notmuch>
In-Reply-To: <6483946e8152f_f1132294a2@iweiny-mobl.notmuch>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
msip_labels: 
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR18MB2844:EE_|MW4PR18MB5244:EE_
x-ms-office365-filtering-correlation-id: 8bcf865b-08cc-4bf7-8326-08db69499e2c
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: RFG3sKPdF0j6guWqa0PGsOOzSf1fAyvIK1NdWxjEwlkx44G2+itlq5bY4nS22jS/hGm0VSmNP7B18vpWVpRJkd4/TYhKPJLXcNB1CJxCkr4uXDoloIdvX/DOPLTetDAGjz5Nzug6CPseIK+fMuk9VcU3vf0biK14wyrtSnJnMA7jCpx1TiNZgpvqybEgsMOjWBIbgol6W8xuhVsiL/X7+AiBh+mney6srUYo8kuKJbcQsQFiDmGtXz9TeKbWtw3HK1Ra+brWgxCukYZ0fIbpVDujcE7mMWU35fIylHiRHuQTRaNlE68UbcyG4jLwsMdzbEDXGJ/KOZXIuQ+w3ndGShfBKfMotNZJl75To63YzP0HbLdFyocR09kDbK63L3HoqxdYd9QnBwgzAISHPj0ttXllNmAaaP8CviNjUYSJU5HMhz7FkyUze9EetGs0Ili7zJn8vd/FGixYoc97KiLS8JTyCe5vt7idRBJdlrLyVGrIU02K4TH8VVXw+O3CXokPwFtyPCchBf5aZ93O+Cnl8kqaOTf1GxGstN83jaMe7rQMTVx0s/99oTPRFZKW8UXEp/W7ywSIECOxvW9BZESAKFPHP7jLf2d9ejux01XHOoIYGWyevK9mTxk/Fbi7Jf52OoMtcF85XO2DfZg3mgQO8g==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR18MB2844.namprd18.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(366004)(376002)(396003)(39860400002)(136003)(346002)(451199021)(55016003)(122000001)(316002)(110136005)(54906003)(91956017)(478600001)(8676002)(8936002)(45080400002)(4326008)(66946007)(66556008)(76116006)(66476007)(66446008)(64756008)(41300700001)(38100700002)(186003)(83380400001)(71200400001)(7696005)(6506007)(53546011)(9686003)(5660300002)(966005)(26005)(33656002)(86362001)(52536014)(7416002)(38070700005)(2906002);DIR:OUT;SFP:1101;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?iso-8859-1?Q?Jnjn8AgHMFa4xLAKSpozDRcLYni/HjsEV2OzQ5JhNc1zuG10VZX9O1QkfX?=
 =?iso-8859-1?Q?RlARwX93rrGiXMH7SRUTBG1oeMbnL0/MSCkHDGYLklSQ6U+YN1VBala0wZ?=
 =?iso-8859-1?Q?BMO9296PsS4fcxP0vB//xtKSwFzu/bt8eegB0gCjeQac2KQjzqYwFIRmQc?=
 =?iso-8859-1?Q?U5Yx2Tx+4EWYZTIV3jITZiTJmIAISO0+1lhclK7uDrbboTIoFHxBTobZdf?=
 =?iso-8859-1?Q?nvPZHVRBAiynZBQzIq/U6Amr2rQKT8bJrm5+Qqr7N8o6HvC6pEha0Cb4R3?=
 =?iso-8859-1?Q?KPBcgQGSgSwQ6zFFEo/WFF84lrlZyjroB7yvPirLTchAFTqH8UNZMZwKOP?=
 =?iso-8859-1?Q?O0R0wvHH4cd6dY6DoT4bPqIJBLfpQ9B8aA1Pq7t5qs/lVhgjuzVf9FlZJH?=
 =?iso-8859-1?Q?Jv8+R2t0HLPG+MoZSRVoFN7LGtXC7bZYNMCb+pqRGEHNJ/LOiW5ysG9gau?=
 =?iso-8859-1?Q?zpoT9zjwsxN3BETOrL+wzHTK2mr9Er0J/fxsi0VG45aLushZhLTkKCOU/w?=
 =?iso-8859-1?Q?8MC10gbGep1kUkPmX/ufNStXfWZOo5VSujqPloZ5GnZeankjNkPwO9CHqs?=
 =?iso-8859-1?Q?442W/er+Z/2kn+uxS4JSmr827jJj/bQ68CXptFhy66xNJKlO2gC1LRouky?=
 =?iso-8859-1?Q?vy7SpACV6LroPdeRTCxeA4xDXzV+LrghyaUolZzmOwN2wuYhDV6tmZUAwN?=
 =?iso-8859-1?Q?hshv8+owFIuCkIm0O5YuGxr0v4BloEakNPJiPJJqsJUMtawP6XZou65tko?=
 =?iso-8859-1?Q?4JZ5+zK0a8WAM1I8XCRhgMrGWAuoi2nugdKBAg54aCf5RQTSDxlwo6n8/l?=
 =?iso-8859-1?Q?rgZMGihGbF/pVrMb1FwU+YmNljyHJrVc4C7SD8akcDPWgssTdOdfCZcYDG?=
 =?iso-8859-1?Q?RMyJigaAQknv+2x69HsePDMQG7hPl0CpFZOHHh7yqQGzz//ldUoWr3tchi?=
 =?iso-8859-1?Q?9FENFN0DnDNc8zyFNO/9BVllGZTH+2Rm9A+BGLzBarHnbmNngaI/oQpwi/?=
 =?iso-8859-1?Q?LeRokcxECQ1WnNbQ2oKVMp/mf5F7CZMFx+k0kTnbqGfaxPI7aPO4i7Ka37?=
 =?iso-8859-1?Q?MDD9+++kqS+jRPnr3N+kWi+9jmz5NPHK3YCyRT9yCzP8eWDnBEjnNkS+MH?=
 =?iso-8859-1?Q?B3B5Eo1S4AuUuakQDT3Jzs0MhcvtMcAfTcBSexK1kHBNuwFeMknA09uTCl?=
 =?iso-8859-1?Q?12gVaiIxYFjn3YlfkwTMKi73YNPf2uVlpNCc3gWMC0e2Vthko4Wkp0GQUr?=
 =?iso-8859-1?Q?sD8by8+GgU1F4TlNKg3/2XDnC1lJoKcUVUdAmVEbICA2Pm1eo6ZVY7IM5O?=
 =?iso-8859-1?Q?uM9gogWvPJ021iG+ZkIOlprEidg9schqA5cX71isTj/MnZux7BFwqSkh5s?=
 =?iso-8859-1?Q?NpDY5+F1kdNOjkna40W9TkCJuK4+SrKWC4KwSSviz87kSpj7Qt05E7aY89?=
 =?iso-8859-1?Q?ypxNazGgm5OiTGYaMRbWyjEC7I+vmhvqD0dFiDyCo7E1jdfUfcuxmmwaia?=
 =?iso-8859-1?Q?peis7rVyRvVcUOagbTRv6KCDZfq4yxiAq54crNrbVcg6AuArf4voba4+ly?=
 =?iso-8859-1?Q?E30KSutkIN/VvNDg3sNl9TSKTeImCztUL4a6tTpBRAfvmDEoqz9UgtMcDA?=
 =?iso-8859-1?Q?N/c46HF32IBp8=3D?=
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: marvell.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR18MB2844.namprd18.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 8bcf865b-08cc-4bf7-8326-08db69499e2c
X-MS-Exchange-CrossTenant-originalarrivaltime: 10 Jun 2023 00:28:30.9936
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 70e1fb47-1155-421d-87fc-2e58f638b6e0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: QjO4zq0/Mw5gONpCqnyUOVfk7NxThBfpshkwKbBH/NIp1/xggxA2xfwLw/1cUikWLXfOgWnzSSTu+dLN9ZGVqg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR18MB5244
X-Proofpoint-GUID: 3MdnWi-9qpG1dYq94hBOZmlOxynIea1m
X-Proofpoint-ORIG-GUID: 90GfZGEmVtcGVQjQS5Ye_QukWdUs19Dr
X-Proofpoint-Virus-Version: vendor=baseguard
 engine=ICAP:2.0.254,Aquarius:18.0.957,Hydra:6.0.573,FMLib:17.11.176.26
 definitions=2023-06-09_18,2023-06-09_01,2023-05-22_02
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 8901
Lines: 208

=0A=
=0A=
=0A=
From: Ira Weiny <ira.weiny@intel.com>=0A=
Sent: Friday, June 9, 2023 2:06 PM=0A=
To: nifan@outlook.com <nifan@outlook.com>; Ira Weiny <ira.weiny@intel.com>;=
 Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>=0A=
Cc: Shesha Bhushan Sreenivasamurthy <sheshas@marvell.com>; Fan Ni <fan.ni@s=
amsung.com>; Jonathan Cameron <Jonathan.Cameron@huawei.com>; qemu-devel@non=
gnu.org <qemu-devel@nongnu.org>; linux-cxl@vger.kernel.org <linux-cxl@vger.=
kernel.org>; gregory.price@memverge.com <gregory.price@memverge.com>; hchku=
o@avery-design.com.tw <hchkuo@avery-design.com.tw>; cbrowy@avery-design.com=
 <cbrowy@avery-design.com>; dan.j.williams@intel.com <dan.j.williams@intel.=
com>; Adam Manzanares <a.manzanares@samsung.com>; dave@stgolabs.net <dave@s=
tgolabs.net>; nmtadam.samsung@gmail.com <nmtadam.samsung@gmail.com>=0A=
Subject: [EXT] Re: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu =
=0A=
=A0=0A=
External Email=0A=
=0A=
----------------------------------------------------------------------=0A=
nifan@outlook.com wrote:=0A=
> The 06/08/2023 08:43, Ira Weiny wrote:=0A=
> > Shesha Bhushan Sreenivasamurthy wrote:=0A=
=0A=
[snip]=0A=
=0A=
> =0A=
> Hi Ira & Shesha,=0A=
> FYI. I reabased my patch series on top of the above branch and created a =
new=0A=
> branch here:=0A=
> =0A=
> https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__github.com_moking_=
qemu-2Ddcd-2Dpreview-2Dlatest_tree_dcd-2Dpreview&d=3DDwIBAg&c=3DnKjWec2b6R0=
mOyPaz7xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3DSvyB_49EIFU=
T8-ZEVgIEYYjU6-zGTX4wb30kuNLUhkTSHYZK5-C0Gxr7uvefhtj4&s=3DMFD7qlSaTuy-w6aDm=
avIMbSP_aeaqZmSML7IVOX5jLs&e=3D =0A=
=0A=
Thanks!=0A=
=0A=
> =0A=
> It passes the same tests as shown here:=0A=
> https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__lore.kernel.org_li=
nux-2Dcxl_6481f70fca5c2-5Fc82be29440-40iweiny-2Dmobl.notmuch_T_-23m76f6e85c=
e3d7292b1982960eb22086ee03922166&d=3DDwIBAg&c=3DnKjWec2b6R0mOyPaz7xtfQ&r=3D=
Zta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3DSvyB_49EIFUT8-ZEVgIEYYjU6-z=
GTX4wb30kuNLUhkTSHYZK5-C0Gxr7uvefhtj4&s=3De-fQOi0RzSZXxfSz37Bpz1sKtp7Yy0MWq=
onZnswK0RU&e=3D =0A=
=0A=
I've not gotten very far with this testing.=A0 But I did find that regular=
=0A=
type 3 devices don't work with this change.=A0 I used the patch below to ge=
t=0A=
this working.=A0 Was there something I was missing to configure a non-DCD=
=0A=
device?=0A=
=0A=
I don't particularly like adding another bool to this call stack.=A0 Seems=
=0A=
like this calls for a flags field but I want to move on to DCD work so I=0A=
hacked this in.=0A=
=0A=
I am working on the DCD FM-API commands here -=0A=
https://gitlab.com/sheshas/qemu-fmapi/-/tree/cxl-2023-05-25=0A=
-Shesha=0A=
=0A=
Ira=0A=
=0A=
commit ed27935044dcbd2c6ba71f8411b218621f3f4167=0A=
Author: Ira Weiny <ira.weiny@intel.com>=0A=
Date:=A0=A0 Fri Jun 9 13:56:33 2023 -0700=0A=
=0A=
=A0=A0=A0 hw/mem/cxl_type3: Exclude DCD from CEL when type3 is not DCD=0A=
=A0=A0=A0 =0A=
=A0=A0=A0 Per CXL 3.0 9.13.3 Dynamic Capacity Device (DCD) when the type 3 =
memory=0A=
=A0=A0=A0 device does not have DCD support the CEL should not include DCD=
=0A=
=A0=A0=A0 configuration commands.=0A=
=A0=A0=A0 =0A=
=A0=A0=A0 If the number of DC regions supported is 0 skip the DCD commands =
in the=0A=
=A0=A0=A0 CEL.=0A=
=A0=A0=A0 =0A=
=A0=A0=A0 Applies on top of Fan Ni's work here:=0A=
=A0=A0=A0 https://urldefense.proofpoint.com/v2/url?u=3Dhttps-3A__github.com=
_moking_qemu-2Ddcd-2Dpreview-2Dlatest_tree_dcd-2Dpreview&d=3DDwIBAg&c=3DnKj=
Wec2b6R0mOyPaz7xtfQ&r=3DZta64bwn4nurTRpD4LY2OGr8KklkMRPn7Z_Qy0o4unU&m=3DSvy=
B_49EIFUT8-ZEVgIEYYjU6-zGTX4wb30kuNLUhkTSHYZK5-C0Gxr7uvefhtj4&s=3DMFD7qlSaT=
uy-w6aDmavIMbSP_aeaqZmSML7IVOX5jLs&e=3D =0A=
=A0=A0=A0 =0A=
=A0=A0=A0 Not-yet-Signed-off-by: Ira Weiny <ira.weiny@intel.com>=0A=
=0A=
diff --git a/hw/cxl/cxl-device-utils.c b/hw/cxl/cxl-device-utils.c=0A=
index a4a2c6a80004..262e35935563 100644=0A=
--- a/hw/cxl/cxl-device-utils.c=0A=
+++ b/hw/cxl/cxl-device-utils.c=0A=
@@ -288,7 +288,7 @@ static void mailbox_reg_init_common(CXLDeviceState *cxl=
_dstate)=0A=
=A0=0A=
=A0static void memdev_reg_init_common(CXLDeviceState *cxl_dstate) { }=0A=
=A0=0A=
-void cxl_device_register_init_common(CXLDeviceState *cxl_dstate)=0A=
+void cxl_device_register_init_common(CXLDeviceState *cxl_dstate, bool is_d=
cd)=0A=
=A0{=0A=
=A0=A0=A0=A0 uint64_t *cap_hdrs =3D cxl_dstate->caps_reg_state64;=0A=
=A0=A0=A0=A0 const int cap_count =3D 3;=0A=
@@ -307,7 +307,7 @@ void cxl_device_register_init_common(CXLDeviceState *cx=
l_dstate)=0A=
=A0=A0=A0=A0 cxl_device_cap_init(cxl_dstate, MEMORY_DEVICE, 0x4000, 1);=0A=
=A0=A0=A0=A0 memdev_reg_init_common(cxl_dstate);=0A=
=A0=0A=
-=A0=A0=A0 cxl_initialize_mailbox(cxl_dstate, false);=0A=
+=A0=A0=A0 cxl_initialize_mailbox(cxl_dstate, false, is_dcd);=0A=
=A0}=0A=
=A0=0A=
=A0void cxl_device_register_init_swcci(CXLDeviceState *cxl_dstate)=0A=
@@ -329,7 +329,7 @@ void cxl_device_register_init_swcci(CXLDeviceState *cxl=
_dstate)=0A=
=A0=A0=A0=A0 cxl_device_cap_init(cxl_dstate, MEMORY_DEVICE, 0x4000, 1);=0A=
=A0=A0=A0=A0 memdev_reg_init_common(cxl_dstate);=0A=
=A0=0A=
-=A0=A0=A0 cxl_initialize_mailbox(cxl_dstate, true);=0A=
+=A0=A0=A0 cxl_initialize_mailbox(cxl_dstate, true, false);=0A=
=A0}=0A=
=A0=0A=
=A0uint64_t cxl_device_get_timestamp(CXLDeviceState *cxl_dstate)=0A=
diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c=0A=
index 93b26e717c94..80e9cb9a8f04 100644=0A=
--- a/hw/cxl/cxl-mailbox-utils.c=0A=
+++ b/hw/cxl/cxl-mailbox-utils.c=0A=
@@ -1526,7 +1526,8 @@ static void bg_timercb(void *opaque)=0A=
=A0=A0=A0=A0 }=0A=
=A0}=0A=
=A0=0A=
-void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci)=
=0A=
+void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci,=
=0A=
+=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0 bool is_dcd)=0A=
=A0{=0A=
=A0=A0=A0=A0 if (!switch_cci) {=0A=
=A0=A0=A0=A0=A0=A0=A0=A0 cxl_dstate->cxl_cmd_set =3D cxl_cmd_set;=0A=
@@ -1534,6 +1535,9 @@ void cxl_initialize_mailbox(CXLDeviceState *cxl_dstat=
e, bool switch_cci)=0A=
=A0=A0=A0=A0=A0=A0=A0=A0 cxl_dstate->cxl_cmd_set =3D cxl_cmd_set_sw;=0A=
=A0=A0=A0=A0 }=0A=
=A0=A0=A0=A0 for (int set =3D 0; set < 256; set++) {=0A=
+=A0=A0=A0=A0=A0=A0=A0 if (!is_dcd && set =3D=3D DCD_CONFIG) {=0A=
+=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 continue;=0A=
+=A0=A0=A0=A0=A0=A0=A0 }=0A=
=A0=A0=A0=A0=A0=A0=A0=A0 for (int cmd =3D 0; cmd < 256; cmd++) {=0A=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 if (cxl_dstate->cxl_cmd_set[set][cmd].=
handler) {=0A=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 struct cxl_cmd *c =3D &cxl=
_dstate->cxl_cmd_set[set][cmd];=0A=
diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c=0A=
index 329e8b5915b3..e6e6e125990c 100644=0A=
--- a/hw/mem/cxl_type3.c=0A=
+++ b/hw/mem/cxl_type3.c=0A=
@@ -1276,9 +1276,11 @@ static void ct3d_reset(DeviceState *dev)=0A=
=A0=A0=A0=A0 CXLType3Dev *ct3d =3D CXL_TYPE3(dev);=0A=
=A0=A0=A0=A0 uint32_t *reg_state =3D ct3d->cxl_cstate.crb.cache_mem_registe=
rs;=0A=
=A0=A0=A0=A0 uint32_t *write_msk =3D ct3d->cxl_cstate.crb.cache_mem_regs_wr=
ite_mask;=0A=
+=A0=A0=A0 bool is_dcd;=0A=
=A0=0A=
=A0=A0=A0=A0 cxl_component_register_init_common(reg_state, write_msk, CXL2_=
TYPE3_DEVICE);=0A=
-=A0=A0=A0 cxl_device_register_init_common(&ct3d->cxl_dstate);=0A=
+=A0=A0=A0 is_dcd =3D (ct3d->dc.num_regions !=3D 0);=0A=
+=A0=A0=A0 cxl_device_register_init_common(&ct3d->cxl_dstate, is_dcd);=0A=
=A0}=0A=
=A0=0A=
=A0static Property ct3_props[] =3D {=0A=
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h=0A=
index 1ccddcca7d0d..4621bba4f533 100644=0A=
--- a/include/hw/cxl/cxl_device.h=0A=
+++ b/include/hw/cxl/cxl_device.h=0A=
@@ -233,7 +233,7 @@ typedef struct cxl_device_state {=0A=
=A0void cxl_device_register_block_init(Object *obj, CXLDeviceState *dev);=
=0A=
=A0=0A=
=A0/* Set up default values for the register block */=0A=
-void cxl_device_register_init_common(CXLDeviceState *dev);=0A=
+void cxl_device_register_init_common(CXLDeviceState *dev, bool is_dcd);=0A=
=A0void cxl_device_register_init_swcci(CXLDeviceState *dev);=0A=
=A0=0A=
=A0/*=0A=
@@ -280,7 +280,7 @@ CXL_DEVICE_CAPABILITY_HEADER_REGISTER(MEMORY_DEVICE,=0A=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 CXL_DEVICE_CAP_HDR1_OFFSET +=0A=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 CXL_DEVICE_CAP_REG_SIZE=
 * 2)=0A=
=A0=0A=
-void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci);=
=0A=
+void cxl_initialize_mailbox(CXLDeviceState *cxl_dstate, bool switch_cci, b=
ool is_dcd);=0A=
=A0void cxl_process_mailbox(CXLDeviceState *cxl_dstate);=0A=
=A0=0A=
=A0#define cxl_device_cap_init(dstate, reg, cap_id, ver)=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 \=

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6EB28C77B7F
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 17:58:09 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239133AbjEKR6I (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 13:58:08 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51256 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239069AbjEKR5s (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 13:57:48 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 89446A246
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 10:57:17 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175642usoutp010075b2527e4d5104a13b51c5ae9fba33~eKHcDRZ4c3198731987usoutp01q;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230511175642usoutp010075b2527e4d5104a13b51c5ae9fba33~eKHcDRZ4c3198731987usoutp01q
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827802;
        bh=b20nz0VaweLqQdC3LPv3vj8OGNqr5dkkVxALkb0s/r4=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=pZA80jD7ZJIoWrXZEdiANl2azivZvR0fK2kCQVYZh62OKWXFGXQ1yzeLdEtGjvyKU
         dvPZAHxKnOSM52SoBcGGso8RTINdZcBdeVxoOrcr5TD23+WuUWUVBiD+i//w+TDgi6
         DcRCvJwozLw+CN6mwSSlulkfEqrbZrlqHM9rhcUk=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p2cc2d90d8793af33c913386e689233b33~eKHb5YJeV2440824408uscas1p2D;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id DE.8A.19925.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from ussmgxs1new.samsung.com (u89.gpu85.samsung.co.kr
        [203.254.195.89]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc~eKHbZe8Y_2473124731uscas1p1n;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
X-AuditID: cbfec36d-975ff70000004dd5-84-645d2c591473
Received: from SSI-EX4.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs1new.samsung.com (USCPEXMTA) with SMTP id 98.7F.38326.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX4.ssi.samsung.com (105.128.2.229) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:40 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:40 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 2/7] hw/cxl/cxl-mailbox-utils: Add dynamic capacity region
 representative and mailbox command support
Thread-Topic: [RFC 2/7] hw/cxl/cxl-mailbox-utils: Add dynamic capacity
        region representative and mailbox command support
Thread-Index: AQHZhDHwZg5veepn5EaQyLC3G3XrlA==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-3-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrNKsWRmVeSWpSXmKPExsWy7djX87pROrEpBnf1LLrPb2C0mD71AqPF
        6ptrGC0amh6xWLTsfs9ksf/pcxaLVQuvsVmcn3WKxeL5xOdMFkuXPGK2ON67g8WB2+PC5Ams
        HosbXD12zrrL7tFy5C2Qt+clk8fGj//ZPZ5c28zksfn1C2aPqbPrPT5vkgvgiuKySUnNySxL
        LdK3S+DK2HttL2vBbZWKRce3sTYwzpDrYuTkkBAwkZi1YTZbFyMXh5DASkaJaQ8msEM4rUwS
        058+ZYGpurdzIxNEYi2jxOmWVcwQzidGicOL/kI5yxgl/i68ywbSwiagKLGvazuYLSJgLHHs
        8BKwImaBtywSH9e8AZsrLFAqsanxKhNEUZXEzY0HoGw9iTMfT4PVsAioSpy7sYMRxOYVsJQ4
        f6wFLM4pYCWxofkEWD2jgJjE91NrwGxmAXGJW0/mM0HcLSixaPYeZghbTOLfrodsELa8xOQf
        M6BsRYn731+yQ/TqSdyYOoUNwtaWWLbwNTPEXkGJkzOfQMNCUuLgihssIM9ICPRzShy+0sMI
        kXCRONQ6G8qWlrh6fSpQMweQnSyx6iMXRDhHYv6SLVBzrCUW/lnPNIFRZRaSs2chOWMWkjNm
        ITljASPLKkbx0uLi3PTUYsO81HK94sTc4tK8dL3k/NxNjMD0dvrf4dwdjDtufdQ7xMjEwXiI
        UYKDWUmE9+2S6BQh3pTEyqrUovz4otKc1OJDjNIcLErivIa2J5OFBNITS1KzU1MLUotgskwc
        nFINTGu99HqKg1ROf7cOeXt35wv+JN2t1QIHsu6wK+rq9u9/6Bo+cUpIt722e5l++JMj8axd
        LU+7+bgz284ZlreZF/SEK2/Y4x/RkLO9zGnV1UNvLNYe2Z9TcVew4PWT/Qd+r5xnPndFbZL4
        pIqPFa1PvZrtAw9b2m2vL5wnVTdtb3RY5WwxtwVvqsqdnk7N8nutuV5gk8cswzO3jyw7/eH3
        2XDrJjP2FoZH/hYuKyyXyITbHu417xTW/y389uPe6ns3WFZ2f9H1LDhTLyFjF39080uNNYmq
        CUe3B1RzHQjd9+Jg4cJfx33/xy9N2M12+MNmhkMdd5sKdiydpvVd/WxY1eqJO/3X3n/M9Svf
        bdIDByWW4oxEQy3mouJEAJiYx0TeAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrBIsWRmVeSWpSXmKPExsWS2cA0STdSJzbFoKdF1qL7/AZGi+lTLzBa
        rL65htGioekRi0XL7vdMFvufPmexWLXwGpvF+VmnWCyeT3zOZLF0ySNmi+O9O1gcuD0uTJ7A
        6rG4wdVj56y77B4tR94CeXteMnls/Pif3ePJtc1MHptfv2D2mDq73uPzJrkArigum5TUnMyy
        1CJ9uwSujL3X9rIW3FapWHR8G2sD4wy5LkZODgkBE4l7OzcygdhCAqsZJZY0WHQxcgHZnxgl
        ut8dZYZwljFKbJ7cxQhSxSagKLGvazsbiC0iYCxx7PASZhCbWeA1i8S3i9wgtrBAqcSmxqtM
        EDVVEoc7JrNA2HoSZz6eBrNZBFQlzt3YATaTV8BS4vyxFhaIKywlPv7cyQ5icwpYSWxoPgE2
        h1FATOL7qTVMELvEJW49mc8E8YGAxJI955khbFGJl4//sULY8hKTf8xgg7AVJe5/f8kO0asn
        cWPqFDYIW1ti2cLXzBA3CEqcnPmEBaJeUuLgihssExglZiFZNwtJ+ywk7bOQtC9gZFnFKF5a
        XJybXlFsmJdarlecmFtcmpeul5yfu4kRmBhO/zscuYPx6K2PeocYmTgYDzFKcDArifC+XRKd
        IsSbklhZlVqUH19UmpNafIhRmoNFSZxXyHVivJBAemJJanZqakFqEUyWiYNTqoEprXjJ2qpb
        QndW/51yItzw+XHe97YG+SeWG/7Zd/7F7PV9QUEVuq+Me69qCy8OKHOfJHK70XhD8KP338vf
        x9kZXdr2dK7tPraVlQkVoft+fji5ruUX5zr5Dx2fGd6V1p92PscbKvL9P0dzQeg2bYEHXgWR
        byu0nJTmf/kj9MykSCmvYnE0V0912t2vMu2G7Jo37i94X+HYYsccuKCZXeBSvcY5z/kXQy26
        1lTNbA46seaau52UxedLaQmvE17Pt7d8v8av/3+sivTFjzddeiOMxSSbXvJPc/i+wGmfKre2
        TIlj22uNCqs1VQf8OkRLvlVKK3q4/PX7JRTElvpA4nRperelwcaPlzubpjEGtiuxFGckGmox
        FxUnAgCLUE87ewMAAA==
X-CMS-MailID: 20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 4554
Lines: 145

From: Fan Ni <nifan@outlook.com>

Per cxl spec 3.0, add dynamic capacity region representative based on
Table 8-126 and extend the cxl type3 device definition to include dc region
information. Also, based on info in 8.2.9.8.9.1, add 'Get Dynamic Capacity
Configuration' mailbox support.

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/cxl/cxl-mailbox-utils.c  | 68 +++++++++++++++++++++++++++++++++++++
 include/hw/cxl/cxl_device.h | 16 +++++++++
 2 files changed, 84 insertions(+)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 7ff4fbdf22..61c77e52d8 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -81,6 +81,8 @@ enum {
         #define GET_POISON_LIST        0x0
         #define INJECT_POISON          0x1
         #define CLEAR_POISON           0x2
+	DCD_CONFIG =3D 0x48, /*8.2.9.8.9*/
+		#define GET_DC_REGION_CONFIG   0x0
     PHYSICAL_SWITCH =3D 0x51
         #define IDENTIFY_SWITCH_DEVICE      0x0
 };
@@ -935,6 +937,70 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cm=
d *cmd,
     return CXL_MBOX_SUCCESS;
 }
=20
+/*
+ * cxl spec 3.0: 8.2.9.8.9.2
+ * Get Dynamic Capacity Configuration
+ **/
+static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
+		CXLDeviceState *cxl_dstate,
+		uint16_t *len)
+{
+	struct get_dyn_cap_config_in_pl {
+		uint8_t region_cnt;
+		uint8_t start_region_id;
+	} QEMU_PACKED;
+
+    struct get_dyn_cap_config_out_pl {
+		uint8_t num_regions;
+		uint8_t rsvd1[7];
+		struct {
+			uint64_t base;
+			uint64_t decode_len;
+			uint64_t region_len;
+			uint64_t block_size;
+			uint32_t dsmadhandle;
+			uint8_t flags;
+			uint8_t rsvd2[3];
+		} QEMU_PACKED records[];
+	} QEMU_PACKED;
+
+	struct get_dyn_cap_config_in_pl *in =3D (void *)cmd->payload;
+	struct get_dyn_cap_config_out_pl *out =3D (void *)cmd->payload;
+	struct CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_ds=
tate);
+	uint16_t record_count =3D 0, i =3D 0;
+	uint16_t out_pl_len;
+
+	if (in->start_region_id >=3D ct3d->dc.num_regions)
+		record_count =3D 0;
+	else if (ct3d->dc.num_regions - in->start_region_id < in->region_cnt)
+		record_count =3D ct3d->dc.num_regions - in->start_region_id;
+	else
+		record_count =3D in->region_cnt;
+
+	out_pl_len =3D sizeof(*out) + record_count * sizeof(out->records[0]);
+	assert(out_pl_len <=3D CXL_MAILBOX_MAX_PAYLOAD_SIZE);
+
+	memset(out, 0, out_pl_len);
+	out->num_regions =3D record_count;
+	for (; i < record_count; i++) {
+		stq_le_p(&out->records[i].base,
+			ct3d->dc.regions[in->start_region_id+i].base);
+		stq_le_p(&out->records[i].decode_len,
+			ct3d->dc.regions[in->start_region_id+i].decode_len);
+		stq_le_p(&out->records[i].region_len,
+			ct3d->dc.regions[in->start_region_id+i].len);
+		stq_le_p(&out->records[i].block_size,
+			ct3d->dc.regions[in->start_region_id+i].block_size);
+		stl_le_p(&out->records[i].dsmadhandle,
+			ct3d->dc.regions[in->start_region_id+i].dsmadhandle);
+		out->records[i].flags
+			=3D ct3d->dc.regions[in->start_region_id+i].flags;
+	}
+
+	*len =3D out_pl_len;
+	return CXL_MBOX_SUCCESS;
+}
+
 #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
 #define IMMEDIATE_DATA_CHANGE (1 << 2)
 #define IMMEDIATE_POLICY_CHANGE (1 << 3)
@@ -973,6 +1039,8 @@ static struct cxl_cmd cxl_cmd_set[256][256] =3D {
         cmd_media_inject_poison, 8, 0 },
     [MEDIA_AND_POISON][CLEAR_POISON] =3D { "MEDIA_AND_POISON_CLEAR_POISON"=
,
         cmd_media_clear_poison, 72, 0 },
+	[DCD_CONFIG][GET_DC_REGION_CONFIG] =3D { "DCD_GET_DC_REGION_CONFIG",
+		cmd_dcd_get_dyn_cap_config, 2, 0 },
 };
=20
 static struct cxl_cmd cxl_cmd_set_sw[256][256] =3D {
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index e285369693..8a04e53e90 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -383,6 +383,17 @@ typedef struct CXLPoison {
 typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
 #define CXL_POISON_LIST_LIMIT 256
=20
+#define DCD_MAX_REGION_NUM 8
+
+typedef struct CXLDCD_Region {
+	uint64_t base;
+	uint64_t decode_len; /* in multiples of 256MB */
+	uint64_t len;
+	uint64_t block_size;
+	uint32_t dsmadhandle;
+	uint8_t flags;
+} CXLDCD_Region;
+
 struct CXLType3Dev {
     /* Private */
     PCIDevice parent_obj;
@@ -414,6 +425,11 @@ struct CXLType3Dev {
     unsigned int poison_list_cnt;
     bool poison_list_overflowed;
     uint64_t poison_list_overflow_ts;
+
+	struct dynamic_capacity {
+		uint8_t num_regions; // 1-8
+		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
+	} dc;
 };
=20
 #define TYPE_CXL_TYPE3 "cxl-type3"
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 536A4C7EE24
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:09:49 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239181AbjEKSJs (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:09:48 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36960 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239165AbjEKSJo (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:09:44 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 388BE1BFF
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:09:23 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175641usoutp0115b0398b6311cb3f8d1764bcd781afba~eKHbkE1Ug3207532075usoutp01t;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230511175641usoutp0115b0398b6311cb3f8d1764bcd781afba~eKHbkE1Ug3207532075usoutp01t
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827801;
        bh=rrRNzEbBk7uXDE33KzAgh30FBvL7mfwQ8R1WbLoX2TE=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=aV0Xja4YAqBtsAbaxz/EEkhx4NAkqQ/hIlHLDOSuVCKRz3R7Mjmv05LChGpEDr2jk
         p09Ru0gfXDrvI6+fyZ253rCfpsBMLRJVQunn1+j7UnwdyZqIwJeZfCuJ+LD50m3aIg
         33QzDIqGNKJuEVrvB30h2rCjYXYo7uWSU4rTkZfQ=
Received: from ussmges3new.samsung.com (u112.gpu85.samsung.co.kr
        [203.254.195.112]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p2eab43508b4af278d55ba49d239334370~eKHbbSDIm2261722617uscas1p23;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges3new.samsung.com (USCPEMTA) with SMTP id A9.93.20392.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from ussmgxs2new.samsung.com (u91.gpu85.samsung.co.kr
        [203.254.195.91]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p2e2dd6a5b681f73870e33869af0247c06~eKHbIicN61951019510uscas1p2c;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
X-AuditID: cbfec370-81ffe70000024fa8-f7-645d2c59408f
Received: from SSI-EX3.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs2new.samsung.com (USCPEXMTA) with SMTP id 5B.AE.44215.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX3.ssi.samsung.com (105.128.2.228) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:40 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:40 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 1/7] hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to
 output payload of identify memory device command
Thread-Topic: [RFC 1/7] hw/cxl/cxl-mailbox-utils: Add dc_event_log_size
        field to output payload of identify memory device command
Thread-Index: AQHZhDHwaEF1ZZLYJUyUWkAyoCZzdw==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-2-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrLKsWRmVeSWpSXmKPExsWy7djX87qROrEpBt3/lCy6z29gtJg+9QKj
        xeqbaxgtGpoesVi07H7PZLH/6XMWi1ULr7FZnJ91isXi+cTnTBZLlzxitjjeu4PFgdvjwuQJ
        rB6LG1w9ds66y+7RcuQtkLfnJZPHxo//2T2eXNvM5LH59Qtmj6mz6z0+b5IL4IrisklJzcks
        Sy3St0vgylj0YCVLwSXeiiez1rE2MPZydzFyckgImEis+LCfpYuRi0NIYCWjxJdL8xghnFYm
        iffT9zHCVLVtPs8GkVjLKPFw2hQo5xOjxK+3F1ghnGWMEn8X3mUDaWETUJTY17UdzBYRMJY4
        dngJM0gRs8BbFomPa96wgCSEBeokVk9aA7ZdRKCZUaJh4mWoDj2JXz/vghWxCKhKnLuxA+wQ
        XgFLideLmsBqOAWsJDY0n2ACsRkFxCS+n1oDZjMLiEvcejKfCeJwQYlFs/cwQ9hiEv92PWSD
        sOUlJv+YAWUrStz//pIdoldP4sbUKWwQtrbEsoWvmSH2CkqcnPmEBaJeUuLgihtgR0sITOaU
        +PnpIDtEwkXi0qqjUEOlJf7eXQZ0BAeQnSyx6iMXRDhHYv6SLVBzrCUW/lnPNIFRZRaSs2ch
        OWMWkjNmITljASPLKkbx0uLi3PTUYuO81HK94sTc4tK8dL3k/NxNjMAUd/rf4YIdjLdufdQ7
        xMjEwXiIUYKDWUmE9+2S6BQh3pTEyqrUovz4otKc1OJDjNIcLErivIa2J5OFBNITS1KzU1ML
        UotgskwcnFINTFNWZ1a/Xap++KuCWPevysNzrt26Kfpj7paZa+Zt+XI2ufR11xk9BT/nvWze
        my/8WjTZfHP/xgvzXmwP2XFrWk7OPBffi1dffmVZzvs662NnVPOi9xe05Kts1j9o62i42syq
        FrPT78jPqIJFESLOS/ZwreRQvtB90lZhV+C8a6HMmiWvO09Jlry2ehXiYJ55weTEy9unyuxb
        FTbk/iz1+6q+/4PdWrGEGQyy82Y+0v5t4rA9UPhw6UqdSL39x12zC/d9c5vZtVTzc+mWmYUc
        UZaTNi2t/58m9d8h41T3gtcdkhz9DHLv2RM7NmziZZN8PyHo4l2ZabdKVM8tUr1076u4i/7/
        rWFTp85YNP/KpEf8SizFGYmGWsxFxYkAP26LqOADAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrFIsWRmVeSWpSXmKPExsWS2cA0STdSJzbF4EQnj0X3+Q2MFtOnXmC0
        WH1zDaNFQ9MjFouW3e+ZLPY/fc5isWrhNTaL87NOsVg8n/icyWLpkkfMFsd7d7A4cHtcmDyB
        1WNxg6vHzll32T1ajrwF8va8ZPLY+PE/u8eTa5uZPDa/fsHsMXV2vcfnTXIBXFFcNimpOZll
        qUX6dglcGYserGQpuMRb8WTWOtYGxl7uLkZODgkBE4m2zefZuhi5OIQEVjNKzN17lBHC+cQo
        8efnRWYIZxmjxObJXYwgLWwCihL7urazgdgiAsYSxw4vYQaxmQVes0h8uwg2VligTmL1pDUs
        IM0iAs2MEms2b2eHaNCT+PXzLguIzSKgKnHuxg6wobwClhKvFzWBDRUCsj/+3AlWzylgJbGh
        +QQTiM0oICbx/dQaJohl4hK3nsxngvhBQGLJnvPMELaoxMvH/1ghbHmJyT9msEHYihL3v79k
        h+jVk7gxdQobhK0tsWzha2aIGwQlTs58wgJRLylxcMUNlgmMErOQrJuFpH0WkvZZSNoXMLKs
        YhQvLS7OTa8oNspLLdcrTswtLs1L10vOz93ECEwOp/8djt7BePvWR71DjEwcjIcYJTiYlUR4
        3y6JThHiTUmsrEotyo8vKs1JLT7EKM3BoiTO+zJqYryQQHpiSWp2ampBahFMlomDU6qBKU3z
        77QVps+7Ld5dfTNX/3jHxRcfjy87uvA919LZpSdrzAJ/GXfEr8vNCr24jGHO/4naGjFxWgL5
        fhVtfr0uDpHiGzTfuJ2a83VasuyKNVuuckVvyNvsXJ/1n60prDCw4NOaODGHJZYx6/sFjsmn
        2b351bk5O2uZYl0Cd/e7Q03Z083nep+P42e/dv9i1UtVPYdl5gUTtuRY9gbMfRVXZPE+JlRx
        i8oUpzPtH92Ud8XyFSd8n9wj0vC78I7UAZm9U+OX3liof3Taia1Fp2Yxyx0QKNVS0py+PzeW
        /Zv21ZqVkjIvePQNZL85vtVcHHbzWYH27by85x2rTtY+rlx2pMJ4voexmNa+ABnpjMg7SizF
        GYmGWsxFxYkAF8AQj30DAAA=
X-CMS-MailID: 20230511175641uscas1p2e2dd6a5b681f73870e33869af0247c06
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p2e2dd6a5b681f73870e33869af0247c06
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p2e2dd6a5b681f73870e33869af0247c06@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 1697
Lines: 49

From: Fan Ni <nifan@outlook.com>

Based on CXL spec 3.0 Table 8-94 (Identify Memory Device Output
Payload), dynamic capacity event log size should be part of
output of the Identify command.
Add dc_event_log_size to the output payload for the host to get the info.

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/cxl/cxl-mailbox-utils.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 9f8e6722d7..7ff4fbdf22 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -21,6 +21,8 @@
 #include "sysemu/hostmem.h"
=20
 #define CXL_CAPACITY_MULTIPLIER   (256 * MiB)
+/* Experimental value: dynamic capacity event log size */
+#define CXL_DC_EVENT_LOG_SIZE 8
=20
 /*
  * How to add a new command, example. The command set FOO, with cmd BAR.
@@ -519,8 +521,9 @@ static CXLRetCode cmd_identify_memory_device(struct cxl=
_cmd *cmd,
         uint16_t inject_poison_limit;
         uint8_t poison_caps;
         uint8_t qos_telemetry_caps;
+		uint16_t dc_event_log_size;
     } QEMU_PACKED *id;
-    QEMU_BUILD_BUG_ON(sizeof(*id) !=3D 0x43);
+    QEMU_BUILD_BUG_ON(sizeof(*id) !=3D 0x45);
=20
     CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_dstate=
);
     CXLType3Class *cvc =3D CXL_TYPE3_GET_CLASS(ct3d);
@@ -543,6 +546,7 @@ static CXLRetCode cmd_identify_memory_device(struct cxl=
_cmd *cmd,
     st24_le_p(id->poison_list_max_mer, 256);
     /* No limit - so limited by main poison record limit */
     stw_le_p(&id->inject_poison_limit, 0);
+	stw_le_p(&id->dc_event_log_size, CXL_DC_EVENT_LOG_SIZE);
=20
     *len =3D sizeof(*id);
     return CXL_MBOX_SUCCESS;
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E8AB8C7EE22
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:24:09 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S237639AbjEKSYJ (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:24:09 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47464 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S237590AbjEKSYI (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:24:08 -0400
Received: from mailout2.w2.samsung.com (mailout2.w2.samsung.com [211.189.100.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E55FC10C6
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:24:06 -0700 (PDT)
Received: from uscas1p2.samsung.com (unknown [182.198.245.207])
        by mailout2.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175642usoutp02df6b7caf1db5c7964604db29db295e38~eKHcYI77O2377423774usoutp02n;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w2.samsung.com 20230511175642usoutp02df6b7caf1db5c7964604db29db295e38~eKHcYI77O2377423774usoutp02n
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827802;
        bh=drqPJBiApwcNYY9N2OmW3kEYbqgOgaqjVzvL7Zi3zKg=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=bLnzLE+ie0b1gvn2aMpYzD+vyyu4oTTJ06mXAi8CJ2oAyyl9Kak8RfusphTXK3Wsp
         3sheNz22Z6G5/jZOeZaqjOgVMC7Z38kGBuM1U3fplbm99ONMFGJlssik4sikAlxGvU
         f09zSlLfH989oxtuZgjYGi8M/cyrHxbfBJjvd3V8=
Received: from ussmges3new.samsung.com (u112.gpu85.samsung.co.kr
        [203.254.195.112]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p2db67b9bfa163413fd907aea261b78ad8~eKHcQB_pb2037920379uscas1p2S;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
Received: from uscas1p1.samsung.com ( [182.198.245.206]) by
        ussmges3new.samsung.com (USCPEMTA) with SMTP id 9A.93.20392.A5C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from ussmgxs1new.samsung.com (u89.gpu85.samsung.co.kr
        [203.254.195.89]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p27cf2915c8184225bfd581fb6f6dfb2d9~eKHb7Hxc32038420384uscas1p2G;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
X-AuditID: cbfec370-81ffe70000024fa8-f9-645d2c5a62d2
Received: from SSI-EX1.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs1new.samsung.com (USCPEXMTA) with SMTP id 59.7F.38326.95C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX1.ssi.samsung.com (105.128.2.226) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:41 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:41 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 6/7] Add qmp interfaces to add/release dynamic capacity
 extents
Thread-Topic: [RFC 6/7] Add qmp interfaces to add/release dynamic capacity
        extents
Thread-Index: AQHZhDHweOj1egr3rka/i5lzMWKESQ==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-7-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrDKsWRmVeSWpSXmKPExsWy7djXc7pROrEpBu+vSFp0n9/AaDF96gVG
        i9U31zBaNDQ9YrFo2f2eyWL/0+csFqsWXmOzOD/rFIvF84nPmSyWLnnEbHG8dweLA7fHhckT
        WD0WN7h67Jx1l92j5chbIG/PSyaPjR//s3s8ubaZyWPz6xfMHlNn13t83iQXwBXFZZOSmpNZ
        llqkb5fAlfFr0Tm2gu1WFQt+tzE3MP7T62Lk5JAQMJG43XaQrYuRi0NIYCWjxJltT9khnFYm
        iXdzZ7LBVN1Y8B0qsZZR4v+9FcwQzidGiabTL1khnGWMEu+/72EGaWETUJTY17UdrF1EwFji
        2OElYB3MAm9ZJD6uecMCkhAW8JeY3nuaHaIoROLP78OsELaeRNeEv2A1LAKqEudu7GAEsXkF
        LCX6DnxlArE5BawkNjSfALMZBcQkvp9aA2YzC4hL3HoynwnibkGJRbMhDpIAqvm36yHUP/IS
        k3/MgLIVJe5/f8kO0asncWPqFDYIW1ti2cLXzBB7BSVOznzCAlEvKXFwxQ0WkGckBPo5JebM
        OgE1yEWip7uFHcKWlrh6fSpQMweQnSyx6iMXRDhHYv6SLVBzrCUW/lnPNIFRZRaSs2chOWMW
        kjNmITljASPLKkbx0uLi3PTUYuO81HK94sTc4tK8dL3k/NxNjMAEd/rf4YIdjLdufdQ7xMjE
        wXiIUYKDWUmE9+2S6BQh3pTEyqrUovz4otKc1OJDjNIcLErivIa2J5OFBNITS1KzU1MLUotg
        skwcnFINTJGSdY3TFNOzL9n1L9TYuMuW62/TsdsbAllsNhYmBrEVh1+8dP9Yv5JOUYDQYs0Z
        /lsNZJ07s3nf7/H2dQrdKsFxTnYl332ucp8f0/eJSTVtXTmTK+6oxBL5OY/OXJNl6L86S1k2
        3tuAYYt+4wr7Fdxf3jImLk/+f7xT97apzuTabftadtv0n+n8OY0p8vdh+UCXFyr+VgccNHZ7
        3Vi53Of8ZrOKTaLhcXs574mtTVHp1Juzy6Hydcg7KauEu4/mcyzpnrZFeeWf1A/vOm9m3ink
        rLfh/sun8YnVIO9ozhH+bVzHQqafKngUWT/nwT6ODvWQf26vZm9gXy7XJNcRExm+rqNatKpS
        ZnPTNh5hJZbijERDLeai4kQAxEcGL98DAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrJIsWRmVeSWpSXmKPExsWS2cA0STdKJzbF4P5EFovu8xsYLaZPvcBo
        sfrmGkaLhqZHLBYtu98zWex/+pzFYtXCa2wW52edYrF4PvE5k8XSJY+YLY737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSx8eN/do8n1zYzeWx+/YLZY+rseo/Pm+QCuKK4bFJSczLL
        Uov07RK4Mn4tOsdWsN2qYsHvNuYGxn96XYycHBICJhI3Fnxn72Lk4hASWM0osXVnMyuE84lR
        4t7SgywQzjJGicat61hBWtgEFCX2dW1nA7FFBIwljh1ewgxiMwu8ZpH4dpEbxBYW8JXo3b2G
        BaImROLWlqPMELaeRNeEv2BxFgFViXM3djCC2LwClhJ9B74ygdhCQPbHnzvZQWxOASuJDc0n
        wOKMAmIS30+tYYLYJS5x68l8JogXBCSW7DnPDGGLSrx8/I8VwpaXmPxjBhuErShx//tLdohe
        PYkbU6ewQdjaEssWvmaGuEFQ4uTMJywQ9ZISB1fcYJnAKDELybpZSNpnIWmfhaR9ASPLKkbx
        0uLi3PSKYsO81HK94sTc4tK8dL3k/NxNjMDUcPrf4cgdjEdvfdQ7xMjEwXiIUYKDWUmE9+2S
        6BQh3pTEyqrUovz4otKc1OJDjNIcLErivEKuE+OFBNITS1KzU1MLUotgskwcnFINTPJfu1Qs
        cjmjYovv9ZWWLQ0L2sPrsuFGZPGZUxmLo/Xy51s12WjFfpR682qlxdRfZZlJz9vPHG82PaSp
        LO175VVraZVOsaOVWXSJiv93J6EwqZKZ4mdDJl7eeuTqEZdvQfNvvfNmb9ug3LZT5n/5dklt
        s+r7c+ys+PZYtX56UOydejLD2qQ8Ra6Pz9ZOW26WUExrvqOM2+J+/7X5sSnrVx0wyo1jljgp
        8mXH9EupysYfnabzB/bPsJZXY1yw9IpZmfSPfTJ3LY3ucM01cU3Yq/Jqzm/VmMzEihoeo23v
        3M09RCq4++MTNzgxC5Vs+LzwdfLOyqNzmiP2fZSU1737rWXCQfvKU4ddJB099iuxFGckGmox
        FxUnAgD6twOCfAMAAA==
X-CMS-MailID: 20230511175642uscas1p27cf2915c8184225bfd581fb6f6dfb2d9
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175642uscas1p27cf2915c8184225bfd581fb6f6dfb2d9
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p27cf2915c8184225bfd581fb6f6dfb2d9@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 7212
Lines: 267

From: Fan Ni <nifan@outlook.com>

Since fabric manager emulation is not supported yet, the change implements
the functions to add/release dynamic capacity extents as QMP interfaces.

1. Add dynamic capacity extents:

For example, the command to add two continuous extents (each is 128MB
long) to region 0 (starting at dpa offset 0) looks like below:

{ "execute": "qmp_capabilities" }

{ "execute": "cxl-add-dynamic-capacity-event",
    "arguments": {
	"path": "/machine/peripheral/cxl-pmem0",
	"region-id" : 0,
	"num-extent": 2,
	"dpa":0,
	"extent-len": 128
	}
}

2. Release dynamic capacity extents:

For example, the command to release an extent of size 128MB from region
0 (starting at dpa offset 0) look like below:

{ "execute": "cxl-release-dynamic-capacity-event",
	"arguments": {
		 "path": "/machine/peripheral/cxl-pmem0",
		"region-id" : 0,
		 "num-extent": 1 ,
		"dpa":0,
		"extent-len": 128
	}
}

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/mem/cxl_type3.c          | 127 ++++++++++++++++++++++++++++++++++++
 include/hw/cxl/cxl_events.h |  16 +++++
 qapi/cxl.json               |  44 +++++++++++++
 3 files changed, 187 insertions(+)

diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 23954711b5..70d47d43b9 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -1651,6 +1651,133 @@ void qmp_cxl_inject_memory_module_event(const char =
*path, CxlEventLog log,
     }
 }
=20
+static const QemuUUID dynamic_capacity_uuid =3D {
+	.data =3D UUID(0xca95afa7, 0xf183, 0x4018, 0x8c, 0x2f,
+			0x95, 0x26, 0x8e, 0x10, 0x1a, 0x2a),
+};
+
+static void qmp_cxl_process_dynamic_capacity_event(const char *path, CxlEv=
entLog log,
+		uint8_t flags, uint8_t type, uint16_t hid, uint8_t rid, uint32_t extent_=
cnt,
+		CXLDCExtent_raw *extents, Error **errp)
+{
+	Object *obj =3D object_resolve_path(path, NULL);
+	CXLEventDynamicCapacity dCap;
+	CXLEventRecordHdr *hdr =3D &dCap.hdr;
+	CXLDeviceState *cxlds;
+	CXLType3Dev *dcd;
+	int i;
+
+	if (!obj) {
+		error_setg(errp, "Unable to resolve path");
+		return;
+	}
+	if (!object_dynamic_cast(obj, TYPE_CXL_TYPE3)) {
+		error_setg(errp, "Path not point to a valid CXL type3 device");
+		return;
+	}
+
+	dcd =3D CXL_TYPE3(obj);
+	cxlds =3D &dcd->cxl_dstate;
+	memset(&dCap, 0, sizeof(dCap));
+
+	if (!dcd->dc.num_regions) {
+		error_setg(errp, "No dynamic capacity support from the device");
+		return;
+	}
+
+	/*
+	 * 8.2.9.1.5
+	 * All Dynamic Capacity event records shall set the Event Record
+	 * Severity field in the Common Event Record Format to Informational
+	 * Event. All Dynamic Capacity related events shall be logged in the
+	 * Dynamic Capacity Event Log.
+	 */
+	assert(flags & (1<<CXL_EVENT_TYPE_INFO));
+	cxl_assign_event_header(hdr, &dynamic_capacity_uuid, flags, sizeof(dCap))=
;
+
+	/*
+	 * 00h: add capacity
+	 * 01h: release capacity
+	 * 02h: forced capacity release
+	 * 03h: region configuration updated
+	 * 04h: Add capacity response
+	 * 05h: capacity released
+	 **/
+	dCap.type =3D type;
+	stw_le_p(&dCap.host_id, hid);
+	dCap.updated_region_id =3D rid;
+	for (i =3D 0; i < extent_cnt; i++) {
+		extents[i].start_dpa +=3D dcd->dc.regions[rid].base;
+		memcpy(&dCap.dynamic_capacity_extent, &extents[i]
+				, sizeof(CXLDCExtent_raw));
+
+		if (cxl_event_insert(cxlds, CXL_EVENT_TYPE_DYNAMIC_CAP,
+					(CXLEventRecordRaw *)&dCap)) {
+			;
+		}
+		cxl_event_irq_assert(dcd);
+	}
+}
+
+#define MEM_BLK_SIZE_MB 128
+void qmp_cxl_add_dynamic_capacity_event(const char *path, uint8_t region_i=
d,
+		uint32_t num_exent, uint64_t dpa, uint64_t extent_len_MB, Error **errp)
+{
+	uint8_t flags =3D 1 << CXL_EVENT_TYPE_INFO;
+	CXLDCExtent_raw *extents;
+	int i;
+
+	if (extent_len_MB < MEM_BLK_SIZE_MB) {
+		error_setg(errp,
+			"extent size cannot be smaller than memory block size (%dMB)",
+			MEM_BLK_SIZE_MB);
+		return;
+	}
+
+	extents =3D g_new0(CXLDCExtent_raw, num_exent);
+	for (i =3D 0; i < num_exent; i++) {
+		extents[i].start_dpa =3D dpa;
+		extents[i].len =3D extent_len_MB*1024*1024;
+		memset(extents[i].tag, 0, 0x10);
+		extents[i].shared_seq =3D 0;
+		dpa +=3D extents[i].len;
+	}
+
+	qmp_cxl_process_dynamic_capacity_event(path, CXL_EVENT_LOG_INFORMATIONAL,
+			flags, 0x0, 0, region_id, num_exent, extents, errp);
+
+	g_free(extents);
+}
+
+void qmp_cxl_release_dynamic_capacity_event(const char *path, uint8_t regi=
on_id,
+		uint32_t num_exent, uint64_t dpa, uint64_t extent_len_MB, Error **errp)
+{
+	uint8_t flags =3D 1 << CXL_EVENT_TYPE_INFO;
+	CXLDCExtent_raw *extents;
+	int i;
+
+	if (extent_len_MB < MEM_BLK_SIZE_MB) {
+		error_setg(errp,
+			"extent size cannot be smaller than memory block size (%dMB)",
+			MEM_BLK_SIZE_MB);
+		return;
+	}
+
+	extents =3D g_new0(CXLDCExtent_raw, num_exent);
+	for (i =3D 0; i < num_exent; i++) {
+		extents[i].start_dpa =3D dpa;
+		extents[i].len =3D extent_len_MB*1024*1024;
+		memset(extents[i].tag, 0, 0x10);
+		extents[i].shared_seq =3D 0;
+		dpa +=3D extents[i].len;
+	}
+
+	qmp_cxl_process_dynamic_capacity_event(path, CXL_EVENT_LOG_INFORMATIONAL,
+			flags, 0x1, 0, region_id, num_exent, extents, errp);
+
+	g_free(extents);
+}
+
 static void ct3_class_init(ObjectClass *oc, void *data)
 {
     DeviceClass *dc =3D DEVICE_CLASS(oc);
diff --git a/include/hw/cxl/cxl_events.h b/include/hw/cxl/cxl_events.h
index 089ba2091f..dd00458d1d 100644
--- a/include/hw/cxl/cxl_events.h
+++ b/include/hw/cxl/cxl_events.h
@@ -165,4 +165,20 @@ typedef struct CXLEventMemoryModule {
     uint8_t reserved[0x3d];
 } QEMU_PACKED CXLEventMemoryModule;
=20
+/*
+ * Dynamic Capacity Event Record
+ * CXL Rev 3.0 Section 8.2.9.2.1.5: Table 8-47
+ * All fields little endian.
+ */
+typedef struct CXLEventDynamicCapacity {
+	CXLEventRecordHdr hdr;
+	uint8_t type;
+	uint8_t reserved1;
+	uint16_t host_id;
+	uint8_t updated_region_id;
+	uint8_t reserved2[3];
+	uint8_t dynamic_capacity_extent[0x28]; /* defined in cxl_device.h */
+	uint8_t reserved[0x20];
+} QEMU_PACKED CXLEventDynamicCapacity;
+
 #endif /* CXL_EVENTS_H */
diff --git a/qapi/cxl.json b/qapi/cxl.json
index 8b3d30cd71..c9a9a45ce4 100644
--- a/qapi/cxl.json
+++ b/qapi/cxl.json
@@ -264,3 +264,47 @@
             'type': 'CxlCorErrorType'
   }
 }
+
+##
+# @cxl-add-dynamic-capacity-event:
+#
+# Command to add dynamic capacity extent event
+#
+# @path: CXL DCD canonical QOM path
+# @region-id: region id
+# @num-extent: number of extents to add, test only
+# @dpa: start dpa for the operation
+# @extent-len: extent size in MB
+#
+# Since: 8.0
+##
+{ 'command': 'cxl-add-dynamic-capacity-event',
+  'data': { 'path': 'str',
+           'region-id': 'uint8',
+           'num-extent': 'uint32',
+           'dpa':'uint64',
+           'extent-len': 'uint64'
+  }
+}
+
+##
+# @cxl-release-dynamic-capacity-event:
+#
+# Command to add dynamic capacity extent event
+#
+# @path: CXL DCD canonical QOM path
+# @region-id: region id
+# @num-extent: number of extents to add, test only
+# @dpa: start dpa for the operation
+# @extent-len: extent size in MB
+#
+# Since: 8.0
+##
+{ 'command': 'cxl-release-dynamic-capacity-event',
+  'data': { 'path': 'str',
+           'region-id': 'uint8',
+           'num-extent': 'uint32',
+           'dpa':'uint64',
+           'extent-len': 'uint64'
+  }
+}
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 133CCC7EE22
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:10:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239113AbjEKSJt (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:09:49 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36992 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239157AbjEKSJq (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:09:46 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8E0C6526A
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:09:23 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175643usoutp01f41b0c639ba9262c8774684c8b3afc97~eKHdL2JSz3198731987usoutp01r;
        Thu, 11 May 2023 17:56:43 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230511175643usoutp01f41b0c639ba9262c8774684c8b3afc97~eKHdL2JSz3198731987usoutp01r
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827803;
        bh=q8Aobqwfsz7443OdhZVgTB3Eu3TueAadI/bI7iaTUow=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=EjndZF8J/AOZy6fn7stoEVl06F13hlwE066Yd2yCEH11QodeCheFvKHNRVQvP80Ca
         koHtsbYiyDXHhwHBn+ZyT/X7lSYSPR/OyaTBo5S9YMige/uPTCOVSZi1fD/QVpyjkz
         g8ciau1R0uF+V320gL44Yp/GmA1jF+OM8PNmL6/I=
Received: from ussmges2new.samsung.com (u111.gpu85.samsung.co.kr
        [203.254.195.111]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175643uscas1p23306dc0dfe33a1b79ad2123375ecae7c~eKHc3evfM2037920379uscas1p2U;
        Thu, 11 May 2023 17:56:43 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges2new.samsung.com (USCPEMTA) with SMTP id A6.DA.42611.A5C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from ussmgxs3new.samsung.com (u92.gpu85.samsung.co.kr
        [203.254.195.92]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p2c037608a1dd26b19cf970f97ce434c6d~eKHcUx5bS1951019510uscas1p2f;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
X-AuditID: cbfec36f-249ff7000000a673-94-645d2c5ab95e
Received: from SSI-EX4.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs3new.samsung.com (USCPEXMTA) with SMTP id 5B.48.64580.95C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX4.ssi.samsung.com (105.128.2.229) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:41 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:41 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 7/7] hw/mem/cxl_type3: add read/write support to dynamic
 capacity
Thread-Topic: [RFC 7/7] hw/mem/cxl_type3: add read/write support to dynamic
        capacity
Thread-Index: AQHZhDHw5brNkJs1s0eH0nh3056ZGw==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-8-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrHKsWRmVeSWpSXmKPExsWy7djX87pROrEpBt8emlh0n9/AaDF96gVG
        i9U31zBaNDQ9YrFo2f2eyWL/0+csFqsWXmOzOD/rFIvF84nPmSyWLnnEbHG8dweLA7fHhckT
        WD0WN7h67Jx1l92j5chbIG/PSyaPjR//s3s8ubaZyWPz6xfMHlNn13t83iQXwBXFZZOSmpNZ
        llqkb5fAlfF3ahN7wabVjBWzVkxka2B80cLYxcjJISFgIvHr4B6mLkYuDiGBlYwSV+dMY4Nw
        WpkkNm5fxgxTdarzMStEYi2jxIITB6GqPjFKfLu/HcpZxijx/vsesBY2AUWJfV0gCU4OEQFj
        iWOHlzCDFDELvGWR+LjmDQtIQlggUGLFhGOMEEVhEp+On2eGsPUkFh7YBxZnEVCVOHdjB5jN
        K2Apcf/Yd3YQm1PASmJD8wkmEJtRQEzi+6k1YDazgLjErSfzmSDuFpRYNHsP1A9iEv92PWSD
        sOUlJv+YAWUrStz//pIdoldP4sbUKWwQtrbEsoWvmSH2CkqcnPmEBaJeUuLgihssIM9ICPRz
        SlxYfoEVIuEicWtLHzRYpSWmr7kMVMQBZCdLrPrIBRHOkZi/ZAvUHGuJhX/WM01gVJmF5OxZ
        SM6YheSMWUjOWMDIsopRvLS4ODc9tdgoL7Vcrzgxt7g0L10vOT93EyMwyZ3+dzh/B+P1Wx/1
        DjEycTAeYpTgYFYS4X27JDpFiDclsbIqtSg/vqg0J7X4EKM0B4uSOK+h7clkIYH0xJLU7NTU
        gtQimCwTB6dUAxPjw98Nfc2JQg7nzj5asmn5qVkuBfI+iqrChjfnPZdaHVgf6jFjXePJv9uz
        tbcdV/xpnqetPuPyQ12GE2Z29WXccrmhQofmLDtvVqgp0R5eKvu8n+vXrb7XV22eB6xcfizP
        sGCltvPH8EnTIw7JK39WVWcPqzT4pXbt6//+ur9Xdl03Dc9t/8Pi4zQjOKG3va2qxFaP/WJn
        5zkP4Q7BWo3CRUkvf0ksWf4xcep0Rgbr/98SUrvFCmstzqouXlri6SaQH2v2gGNG2l0Gc+WN
        xbnPP+w+vPTGZtNPM6p375+5VE7ryqUnutEP1sy9O3P6vRkaAd1R669O+ralqYNTPYaFe/LG
        xjdzKgt8fLJqipRYijMSDbWYi4oTAeiFzs3hAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrNIsWRmVeSWpSXmKPExsWS2cA0UTdKJzbF4N03fovu8xsYLaZPvcBo
        sfrmGkaLhqZHLBYtu98zWex/+pzFYtXCa2wW52edYrF4PvE5k8XSJY+YLY737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSx8eN/do8n1zYzeWx+/YLZY+rseo/Pm+QCuKK4bFJSczLL
        Uov07RK4Mv5ObWIv2LSasWLWiolsDYwvWhi7GDk5JARMJE51PmbtYuTiEBJYzShx/8wTKOcT
        o8T/lu1MEM4yRonGretYQVrYBBQl9nVtZwOxRQSMJY4dXsIMYjMLvGaR+HaRG8QWFgiUWDHh
        GCNETZhE85b/zBC2nsTCA/vA4iwCqhLnbuwAs3kFLCXuH/vODmILAdkff+4EszkFrCQ2NJ9g
        ArEZBcQkvp9awwSxS1zi1pP5TBAvCEgs2XOeGcIWlXj5+B8rhC0vMfnHDDYIW1Hi/veX7BC9
        ehI3pk5hg7C1JZYtfM0McYOgxMmZT1gg6iUlDq64wTKBUWIWknWzkLTPQtI+C0n7AkaWVYzi
        pcXFuekVxcZ5qeV6xYm5xaV56XrJ+bmbGIHp4fS/wzE7GO/d+qh3iJGJg/EQowQHs5II79sl
        0SlCvCmJlVWpRfnxRaU5qcWHGKU5WJTEeT1iJ8YLCaQnlqRmp6YWpBbBZJk4OKUamHQvrPr7
        5l+ckXRTid9TTsMn944JcVh/0LDNU2U+pbpP1UONd3KbjqNYpIalueHkv9PklLRnuP1S/8Gr
        ZTxHV1Nmq/gHi6CKa1Oq3UrLFTddNzkSlfOqWk8hTvtFPoO456m1DkLPmb41TPux41jEwTjd
        CaoBRZdstX1ME6RCG9NbrlWsTqm43t5ypPP6tJ35Mml2Vav2f03cwad77pP1gtcNxwvrW9Zs
        4ovym1r3XXEO391cNnNzqxn72Duyj83c+en1x3nfG/i5dGT+h/Q9yeZ0VWfP+Zzye6fd/eA9
        vgISe5RNxNYfqDUoevb8dUBP6ykJibtid1KzePzNnBn+77cP8k/R26IkJPN2jaUSS3FGoqEW
        c1FxIgDylzB5fgMAAA==
X-CMS-MailID: 20230511175642uscas1p2c037608a1dd26b19cf970f97ce434c6d
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175642uscas1p2c037608a1dd26b19cf970f97ce434c6d
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p2c037608a1dd26b19cf970f97ce434c6d@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 21265
Lines: 673

From: Fan Ni <nifan@outlook.com>

Before the change, read from or write to dynamic capacity of the memory
device is not support as 1) no host backed file/memory is provided for
it; 2) no address space is created for the dynamic capacity.

With the change, add code to support following:
1. add a new property to type3 device "dc-memdev" to point to host
   memory backend for dynamic capacity;
2. add a bitmap for each region to track whether a block is host backed,
which will be used for address check when read/write dynamic capacity;
3. add namespace for dynamic capacity for read/write support;
4. create cdat entries for each dynamic capacity region;

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/cxl/cxl-mailbox-utils.c  |  21 ++-
 hw/mem/cxl_type3.c          | 336 +++++++++++++++++++++++++++++-------
 include/hw/cxl/cxl_device.h |   8 +-
 3 files changed, 298 insertions(+), 67 deletions(-)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 7212934627..efe61e67fb 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -391,9 +391,11 @@ static CXLRetCode cmd_firmware_update_get_info(struct =
cxl_cmd *cmd,
         char fw_rev4[0x10];
     } QEMU_PACKED *fw_info;
     QEMU_BUILD_BUG_ON(sizeof(*fw_info) !=3D 0x50);
+	CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
=20
     if ((cxl_dstate->vmem_size < CXL_CAPACITY_MULTIPLIER) ||
-        (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER)) {
+			(cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) ||
+		(ct3d->dc.total_dynamic_capicity < CXL_CAPACITY_MULTIPLIER)) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
=20
@@ -534,7 +536,9 @@ static CXLRetCode cmd_identify_memory_device(struct cxl=
_cmd *cmd,
     CXLType3Class *cvc =3D CXL_TYPE3_GET_CLASS(ct3d);
=20
     if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER))=
 ||
-        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))=
) {
+		(!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER)) ||
+		(!QEMU_IS_ALIGNED(ct3d->dc.total_dynamic_capicity,
+						CXL_CAPACITY_MULTIPLIER))) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
=20
@@ -543,7 +547,8 @@ static CXLRetCode cmd_identify_memory_device(struct cxl=
_cmd *cmd,
=20
     snprintf(id->fw_revision, 0x10, "BWFW VERSION %02d", 0);
=20
-    stq_le_p(&id->total_capacity, cxl_dstate->mem_size / CXL_CAPACITY_MULT=
IPLIER);
+	stq_le_p(&id->total_capacity,
+			cxl_dstate->static_mem_size / CXL_CAPACITY_MULTIPLIER);
     stq_le_p(&id->persistent_capacity, cxl_dstate->pmem_size / CXL_CAPACIT=
Y_MULTIPLIER);
     stq_le_p(&id->volatile_capacity, cxl_dstate->vmem_size / CXL_CAPACITY_=
MULTIPLIER);
     stl_le_p(&id->lsa_size, cvc->get_lsa_size(ct3d));
@@ -568,9 +573,12 @@ static CXLRetCode cmd_ccls_get_partition_info(struct c=
xl_cmd *cmd,
         uint64_t next_pmem;
     } QEMU_PACKED *part_info =3D (void *)cmd->payload;
     QEMU_BUILD_BUG_ON(sizeof(*part_info) !=3D 0x20);
+	CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
=20
     if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER))=
 ||
-        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))=
) {
+		(!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER)) ||
+		(!QEMU_IS_ALIGNED(ct3d->dc.total_dynamic_capicity,
+						CXL_CAPACITY_MULTIPLIER))) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
=20
@@ -881,9 +889,8 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd=
 *cmd,
     struct clear_poison_pl *in =3D (void *)cmd->payload;
=20
     dpa =3D ldq_le_p(&in->dpa);
-    if (dpa + 64 > cxl_dstate->mem_size) {
-        return CXL_MBOX_INVALID_PA;
-    }
+	if (dpa + 64 > cxl_dstate->static_mem_size && ct3d->dc.num_regions =3D=3D=
 0)
+		return CXL_MBOX_INVALID_PA;
=20
     QLIST_FOREACH(ent, poison_list, node) {
         /*
diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 70d47d43b9..334660bd0f 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -33,8 +33,8 @@ enum {
 };
=20
 static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
-                                         int dsmad_handle, MemoryRegion *m=
r,
-                                         bool is_pmem, uint64_t dpa_base)
+		int dsmad_handle, uint8_t flags,
+		uint64_t dpa_base, uint64_t size)
 {
     g_autofree CDATDsmas *dsmas =3D NULL;
     g_autofree CDATDslbis *dslbis0 =3D NULL;
@@ -53,9 +53,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **=
cdat_table,
             .length =3D sizeof(*dsmas),
         },
         .DSMADhandle =3D dsmad_handle,
-        .flags =3D is_pmem ? CDAT_DSMAS_FLAG_NV : 0,
+		.flags =3D flags,
         .DPA_base =3D dpa_base,
-        .DPA_length =3D int128_get64(mr->size),
+		.DPA_length =3D size,
     };
=20
     /* For now, no memory side cache, plausiblish numbers */
@@ -137,9 +137,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader =
**cdat_table,
          * NV: Reserved - the non volatile from DSMAS matters
          * V: EFI_MEMORY_SP
          */
-        .EFI_memory_type_attr =3D is_pmem ? 2 : 1,
+		.EFI_memory_type_attr =3D flags ? 2 : 1,
         .DPA_offset =3D 0,
-        .DPA_length =3D int128_get64(mr->size),
+		.DPA_length =3D size,
     };
=20
     /* Header always at start of structure */
@@ -158,14 +158,15 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat=
_table, void *priv)
     g_autofree CDATSubHeader **table =3D NULL;
     CXLType3Dev *ct3d =3D priv;
     MemoryRegion *volatile_mr =3D NULL, *nonvolatile_mr =3D NULL;
+	MemoryRegion *dc_mr =3D NULL;
     int dsmad_handle =3D 0;
     int cur_ent =3D 0;
     int len =3D 0;
     int rc, i;
+	uint64_t vmr_size =3D 0, pmr_size =3D 0;
=20
-    if (!ct3d->hostpmem && !ct3d->hostvmem) {
-        return 0;
-    }
+	if (!ct3d->hostpmem && !ct3d->hostvmem && !ct3d->dc.num_regions)
+		return 0;
=20
     if (ct3d->hostvmem) {
         volatile_mr =3D host_memory_backend_get_memory(ct3d->hostvmem);
@@ -173,6 +174,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_t=
able, void *priv)
             return -EINVAL;
         }
         len +=3D CT3_CDAT_NUM_ENTRIES;
+		vmr_size =3D volatile_mr->size;
     }
=20
     if (ct3d->hostpmem) {
@@ -181,7 +183,19 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_=
table, void *priv)
             return -EINVAL;
         }
         len +=3D CT3_CDAT_NUM_ENTRIES;
-    }
+		pmr_size =3D nonvolatile_mr->size;
+	}
+
+	if (ct3d->dc.num_regions) {
+		if (ct3d->dc.host_dc) {
+			dc_mr =3D host_memory_backend_get_memory(ct3d->dc.host_dc);
+			if (!dc_mr)
+				return -EINVAL;
+			len +=3D CT3_CDAT_NUM_ENTRIES * ct3d->dc.num_regions;
+		} else {
+			return -EINVAL;
+		}
+	}
=20
     table =3D g_malloc0(len * sizeof(*table));
     if (!table) {
@@ -189,23 +203,45 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat=
_table, void *priv)
     }
=20
     /* Now fill them in */
-    if (volatile_mr) {
-        rc =3D ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volati=
le_mr,
-                                           false, 0);
-        if (rc < 0) {
-            return rc;
-        }
-        cur_ent =3D CT3_CDAT_NUM_ENTRIES;
-    }
+	if (volatile_mr) {
+		rc =3D ct3_build_cdat_entries_for_mr(table, dsmad_handle++,
+				0, 0, vmr_size);
+		if (rc < 0)
+			return rc;
+		cur_ent =3D CT3_CDAT_NUM_ENTRIES;
+	}
+
+	if (nonvolatile_mr) {
+		rc =3D ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_handle++,
+				CDAT_DSMAS_FLAG_NV, vmr_size, pmr_size);
+		if (rc < 0)
+			goto error_cleanup;
+		cur_ent +=3D CT3_CDAT_NUM_ENTRIES;
+	}
+
+	if (dc_mr) {
+		uint64_t region_base =3D vmr_size + pmr_size;
+
+		/*
+		 * Currently we create cdat entries for each region, should we only
+		 * create dsmas table instead??
+		 * We assume all dc regions are non-volatile for now.
+		 *
+		 */
+		for (i =3D 0; i < ct3d->dc.num_regions; i++) {
+			rc =3D ct3_build_cdat_entries_for_mr(&(table[cur_ent])
+					, dsmad_handle++
+					, CDAT_DSMAS_FLAG_NV|CDAT_DSMAS_FLAG_DYNAMIC_CAP
+					, region_base, ct3d->dc.regions[i].len);
+			if (rc < 0)
+				goto error_cleanup;
+			ct3d->dc.regions[i].dsmadhandle =3D dsmad_handle-1;
+
+			cur_ent +=3D CT3_CDAT_NUM_ENTRIES;
+			region_base +=3D ct3d->dc.regions[i].len;
+		}
+	}
=20
-    if (nonvolatile_mr) {
-        rc =3D ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_hand=
le++,
-                nonvolatile_mr, true, (volatile_mr ? volatile_mr->size : 0=
));
-        if (rc < 0) {
-            goto error_cleanup;
-        }
-        cur_ent +=3D CT3_CDAT_NUM_ENTRIES;
-    }
     assert(len =3D=3D cur_ent);
=20
     *cdat_table =3D g_steal_pointer(&table);
@@ -706,6 +742,11 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
 		/* dsmad_handle is set when creating cdat table entries */
 		region->flags =3D 0;
=20
+		region->blk_bitmap =3D bitmap_new(region->len / region->block_size);
+		if (!region->blk_bitmap)
+			return -1;
+		bitmap_zero(region->blk_bitmap, region->len / region->block_size);
+
 		region_base +=3D region->len;
 	}
 	QTAILQ_INIT(&ct3d->dc.extents);
@@ -713,11 +754,24 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
 	return 0;
 }
=20
+static void cxl_destroy_toy_regions(CXLType3Dev *ct3d)
+{
+	int i;
+	struct CXLDCD_Region *region;
+
+	for (i =3D 0; i < ct3d->dc.num_regions; i++) {
+		region =3D &ct3d->dc.regions[i];
+		if (region->blk_bitmap)
+			g_free(region->blk_bitmap);
+	}
+}
+
 static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
 {
     DeviceState *ds =3D DEVICE(ct3d);
=20
-    if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem) {
+	if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem
+			&& !ct3d->dc.num_regions) {
         error_setg(errp, "at least one memdev property must be set");
         return false;
     } else if (ct3d->hostmem && ct3d->hostpmem) {
@@ -754,7 +808,7 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error *=
*errp)
         }
         address_space_init(&ct3d->hostvmem_as, vmr, v_name);
         ct3d->cxl_dstate.vmem_size =3D vmr->size;
-        ct3d->cxl_dstate.mem_size +=3D vmr->size;
+		ct3d->cxl_dstate.static_mem_size +=3D vmr->size;
         g_free(v_name);
     }
=20
@@ -777,12 +831,47 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error=
 **errp)
         }
         address_space_init(&ct3d->hostpmem_as, pmr, p_name);
         ct3d->cxl_dstate.pmem_size =3D pmr->size;
-        ct3d->cxl_dstate.mem_size +=3D pmr->size;
+		ct3d->cxl_dstate.static_mem_size +=3D pmr->size;
         g_free(p_name);
     }
=20
-	if (cxl_create_toy_regions(ct3d))
-		return false;
+	ct3d->dc.total_dynamic_capicity =3D 0;
+	if (ct3d->dc.host_dc) {
+		MemoryRegion *dc_mr;
+		char *dc_name;
+		uint64_t total_region_size =3D 0;
+		int i;
+
+		dc_mr =3D host_memory_backend_get_memory(ct3d->dc.host_dc);
+		if (!dc_mr) {
+			error_setg(errp, "dynamic capacity must have backing device");
+			return false;
+		}
+		/* FIXME: set dc as nonvolatile for now */
+		memory_region_set_nonvolatile(dc_mr, true);
+		memory_region_set_enabled(dc_mr, true);
+		host_memory_backend_set_mapped(ct3d->dc.host_dc, true);
+		if (ds->id) {
+			dc_name =3D g_strdup_printf("cxl-dcd-dpa-dc-space:%s", ds->id);
+		} else {
+			dc_name =3D g_strdup("cxl-dcd-dpa-dc-space");
+		}
+		address_space_init(&ct3d->dc.host_dc_as, dc_mr, dc_name);
+
+		if (cxl_create_toy_regions(ct3d)) {
+			return false;
+		}
+
+		for (i =3D 0; i < ct3d->dc.num_regions; i++) {
+			total_region_size +=3D ct3d->dc.regions[i].len;
+		}
+		/* Make sure the host backend is large enough to cover all dc range */
+		assert(total_region_size <=3D dc_mr->size);
+		assert(dc_mr->size % (256*1024*1024) =3D=3D 0);
+
+		ct3d->dc.total_dynamic_capicity =3D total_region_size;
+		g_free(dc_name);
+	}
=20
     return true;
 }
@@ -890,6 +979,10 @@ err_release_cdat:
 err_free_special_ops:
     g_free(regs->special_ops);
 err_address_space_free:
+	if (ct3d->dc.host_dc) {
+		cxl_destroy_toy_regions(ct3d);
+		address_space_destroy(&ct3d->dc.host_dc_as);
+	}
     if (ct3d->hostpmem) {
         address_space_destroy(&ct3d->hostpmem_as);
     }
@@ -909,6 +1002,10 @@ static void ct3_exit(PCIDevice *pci_dev)
     cxl_doe_cdat_release(cxl_cstate);
     spdm_sock_fini(ct3d->doe_spdm.socket);
     g_free(regs->special_ops);
+	if (ct3d->dc.host_dc) {
+		cxl_destroy_toy_regions(ct3d);
+		address_space_destroy(&ct3d->dc.host_dc_as);
+	}
     if (ct3d->hostpmem) {
         address_space_destroy(&ct3d->hostpmem_as);
     }
@@ -917,6 +1014,100 @@ static void ct3_exit(PCIDevice *pci_dev)
     }
 }
=20
+static void set_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
+		uint64_t len)
+{
+	int i;
+	CXLDCD_Region *region =3D NULL;
+
+	if (dpa < ct3d->dc.regions[0].base
+		|| dpa >=3D ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicity)
+		return;
+
+	/*
+	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
+	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
+	 * Region 7 for the highest DPA.
+	 * So we check from the last region to find where the dpa belongs.
+	 * access across multiple regions is not allowed.
+	 **/
+	for (i =3D ct3d->dc.num_regions-1; i >=3D 0; i--) {
+		region =3D &ct3d->dc.regions[i];
+		if (dpa >=3D region->base)
+			break;
+	}
+
+	bitmap_set(region->blk_bitmap, (dpa-region->base)/region->block_size,
+			len/region->block_size);
+}
+
+static bool test_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
+		uint64_t len)
+{
+	int i;
+	CXLDCD_Region *region =3D NULL;
+	uint64_t nbits;
+	long nr;
+
+	if (dpa < ct3d->dc.regions[0].base
+		   || dpa >=3D ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicit=
y)
+		return false;
+
+	/*
+	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
+	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
+	 * Region 7 for the highest DPA.
+	 * So we check from the last region to find where the dpa belongs.
+	 * access across multiple regions is not allowed.
+	 **/
+	for (i =3D ct3d->dc.num_regions-1; i >=3D 0; i--) {
+		region =3D &ct3d->dc.regions[i];
+		if (dpa >=3D region->base)
+			break;
+	}
+
+	nr =3D (dpa-region->base)/region->block_size;
+	nbits =3D (len + region->block_size-1)/region->block_size;
+	if (find_next_zero_bit(region->blk_bitmap, nr+nbits, nr)
+			>=3D nr+nbits)
+		return true;
+
+	return false;
+}
+
+static void clear_region_block_backed(CXLType3Dev *ct3d, uint64_t dpa,
+		uint64_t len)
+{
+	int i;
+	CXLDCD_Region *region =3D NULL;
+	uint64_t nbits;
+	long nr;
+
+	if (dpa < ct3d->dc.regions[0].base
+		|| dpa >=3D ct3d->dc.regions[0].base + ct3d->dc.total_dynamic_capicity)
+		return;
+
+	/*
+	 * spec 3.0 9.13.3: Regions are used in increasing-DPA order, with
+	 * Region 0 being used for the lowest DPA of Dynamic Capacity and
+	 * Region 7 for the highest DPA.
+	 * So we check from the last region to find where the dpa belongs.
+	 * access across multiple regions is not allowed.
+	 **/
+	for (i =3D ct3d->dc.num_regions-1; i >=3D 0; i--) {
+		region =3D &ct3d->dc.regions[i];
+		if (dpa >=3D region->base)
+			break;
+	}
+
+	nr =3D (dpa-region->base) / region->block_size;
+	nbits =3D (len + region->block_size-1) / region->block_size;
+	for (i =3D 0; i < nbits; i++) {
+		clear_bit(nr, region->blk_bitmap);
+		nr++;
+	}
+}
+
 static bool cxl_type3_dpa(CXLType3Dev *ct3d, hwaddr host_addr, uint64_t *d=
pa)
 {
     uint32_t *cache_mem =3D ct3d->cxl_cstate.crb.cache_mem_registers;
@@ -973,16 +1164,24 @@ static int cxl_type3_hpa_to_as_and_dpa(CXLType3Dev *=
ct3d,
                                        AddressSpace **as,
                                        uint64_t *dpa_offset)
 {
-    MemoryRegion *vmr =3D NULL, *pmr =3D NULL;
+	MemoryRegion *vmr =3D NULL, *pmr =3D NULL, *dc_mr =3D NULL;
+	uint64_t vmr_size =3D 0, pmr_size =3D 0, dc_size =3D 0;
=20
     if (ct3d->hostvmem) {
         vmr =3D host_memory_backend_get_memory(ct3d->hostvmem);
+		vmr_size =3D int128_get64(vmr->size);
     }
     if (ct3d->hostpmem) {
         pmr =3D host_memory_backend_get_memory(ct3d->hostpmem);
+		pmr_size =3D int128_get64(pmr->size);
     }
+	if (ct3d->dc.host_dc) {
+		dc_mr =3D host_memory_backend_get_memory(ct3d->dc.host_dc);
+		/* Do we want dc_size to be dc_mr->size or not?? */
+		dc_size =3D ct3d->dc.total_dynamic_capicity;
+	}
=20
-    if (!vmr && !pmr) {
+	if (!vmr && !pmr && !dc_mr) {
         return -ENODEV;
     }
=20
@@ -990,20 +1189,22 @@ static int cxl_type3_hpa_to_as_and_dpa(CXLType3Dev *=
ct3d,
         return -EINVAL;
     }
=20
-    if (*dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
+    if (*dpa_offset >=3D vmr_size + pmr_size + dc_size ||
+       (*dpa_offset >=3D vmr_size + pmr_size && ct3d->dc.num_regions =3D=
=3D 0)) {
         return -EINVAL;
     }
=20
-    if (vmr) {
-        if (*dpa_offset < int128_get64(vmr->size)) {
-            *as =3D &ct3d->hostvmem_as;
-        } else {
-            *as =3D &ct3d->hostpmem_as;
-            *dpa_offset -=3D vmr->size;
-        }
-    } else {
-        *as =3D &ct3d->hostpmem_as;
-    }
+	if (*dpa_offset < vmr_size)
+		*as =3D &ct3d->hostvmem_as;
+	else if (*dpa_offset < vmr_size + pmr_size) {
+		*as =3D &ct3d->hostpmem_as;
+		*dpa_offset -=3D vmr_size;
+	} else {
+		if (!test_region_block_backed(ct3d, *dpa_offset, size))
+			return -ENODEV;
+		*as =3D &ct3d->dc.host_dc_as;
+		*dpa_offset -=3D (vmr_size + pmr_size);
+	}
=20
     return 0;
 }
@@ -1069,6 +1270,8 @@ static Property ct3_props[] =3D {
     DEFINE_PROP_STRING("cdat", CXLType3Dev, cxl_cstate.cdat.filename),
     DEFINE_PROP_UINT16("spdm", CXLType3Dev, spdm_port, 0),
 	DEFINE_PROP_UINT8("num-dc-regions", CXLType3Dev, dc.num_regions, 0),
+	DEFINE_PROP_LINK("dc-memdev", CXLType3Dev, dc.host_dc,
+					TYPE_MEMORY_BACKEND, HostMemoryBackend *),
     DEFINE_PROP_END_OF_LIST(),
 };
=20
@@ -1135,34 +1338,41 @@ static void set_lsa(CXLType3Dev *ct3d, const void *=
buf, uint64_t size,
=20
 static bool set_cacheline(CXLType3Dev *ct3d, uint64_t dpa_offset, uint8_t =
*data)
 {
-    MemoryRegion *vmr =3D NULL, *pmr =3D NULL;
+	MemoryRegion *vmr =3D NULL, *pmr =3D NULL, *dc_mr =3D NULL;
     AddressSpace *as;
+	uint64_t vmr_size =3D 0, pmr_size =3D 0, dc_size =3D 0;
=20
     if (ct3d->hostvmem) {
         vmr =3D host_memory_backend_get_memory(ct3d->hostvmem);
+		vmr_size =3D int128_get64(vmr->size);
     }
     if (ct3d->hostpmem) {
         pmr =3D host_memory_backend_get_memory(ct3d->hostpmem);
+		pmr_size =3D int128_get64(pmr->size);
     }
+	if (ct3d->dc.host_dc) {
+		dc_mr =3D host_memory_backend_get_memory(ct3d->dc.host_dc);
+		dc_size =3D ct3d->dc.total_dynamic_capicity;
+	}
=20
-    if (!vmr && !pmr) {
+    if (!vmr && !pmr && !dc_mr) {
         return false;
     }
=20
-    if (dpa_offset + 64 > int128_get64(ct3d->cxl_dstate.mem_size)) {
-        return false;
-    }
+	if (dpa_offset >=3D vmr_size + pmr_size + dc_size)
+		return false;
+	if (dpa_offset + 64 >=3D vmr_size + pmr_size && ct3d->dc.num_regions =3D=
=3D 0)
+		return false;
=20
-    if (vmr) {
-        if (dpa_offset <=3D int128_get64(vmr->size)) {
-            as =3D &ct3d->hostvmem_as;
-        } else {
-            as =3D &ct3d->hostpmem_as;
-            dpa_offset -=3D vmr->size;
-        }
-    } else {
-        as =3D &ct3d->hostpmem_as;
-    }
+	if (dpa_offset < vmr_size) {
+		as =3D &ct3d->hostvmem_as;
+	} else if (dpa_offset < vmr_size + pmr_size) {
+		as =3D &ct3d->hostpmem_as;
+		dpa_offset -=3D vmr->size;
+	} else {
+		as =3D &ct3d->dc.host_dc_as;
+		dpa_offset -=3D (vmr_size + pmr_size);
+	}
=20
     address_space_write(as, dpa_offset, MEMTXATTRS_UNSPECIFIED, &data, 64)=
;
     return true;
@@ -1711,6 +1921,14 @@ static void qmp_cxl_process_dynamic_capacity_event(c=
onst char *path, CxlEventLog
 		memcpy(&dCap.dynamic_capacity_extent, &extents[i]
 				, sizeof(CXLDCExtent_raw));
=20
+		if (dCap.type =3D=3D 0x0)
+			set_region_block_backed(dcd, extents[i].start_dpa, extents[i].len);
+		else if (dCap.type =3D=3D 0x1)
+			clear_region_block_backed(dcd, extents[i].start_dpa,
+					extents[i].len);
+		else
+			error_setg(errp, "DC event not support yet, no bitmap op");
+
 		if (cxl_event_insert(cxlds, CXL_EVENT_TYPE_DYNAMIC_CAP,
 					(CXLEventRecordRaw *)&dCap)) {
 			;
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index c0c8fcc24b..d9b6776e2c 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -211,7 +211,7 @@ typedef struct cxl_device_state {
     } timestamp;
=20
     /* memory region size, HDM */
-    uint64_t mem_size;
+	uint64_t static_mem_size;
     uint64_t pmem_size;
     uint64_t vmem_size;
=20
@@ -412,6 +412,7 @@ typedef struct CXLDCD_Region {
 	uint64_t block_size;
 	uint32_t dsmadhandle;
 	uint8_t flags;
+	unsigned long *blk_bitmap;
 } CXLDCD_Region;
=20
 struct CXLType3Dev {
@@ -447,12 +448,17 @@ struct CXLType3Dev {
     uint64_t poison_list_overflow_ts;
=20
 	struct dynamic_capacity {
+		HostMemoryBackend *host_dc;
+		AddressSpace host_dc_as;
+
+		uint8_t num_hosts; //Table 7-55
 		uint8_t num_regions; // 1-8
 		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
 		CXLDCDExtentList extents;
=20
 		uint32_t total_extent_count;
 		uint32_t ext_list_gen_seq;
+		uint64_t total_dynamic_capicity; // 256M aligned
 	} dc;
 };
=20
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E75CBC7EE24
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:05:26 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S238948AbjEKSFY (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:05:24 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59868 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239100AbjEKSFV (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:05:21 -0400
Received: from mailout2.w2.samsung.com (mailout2.w2.samsung.com [211.189.100.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C1C4C9EC1
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:04:50 -0700 (PDT)
Received: from uscas1p2.samsung.com (unknown [182.198.245.207])
        by mailout2.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175642usoutp021cee2a55ffb44c18cbdb5b6d3425d1da~eKHb8rVmO2433724337usoutp02U;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w2.samsung.com 20230511175642usoutp021cee2a55ffb44c18cbdb5b6d3425d1da~eKHb8rVmO2433724337usoutp02U
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827802;
        bh=UX2rYCNF7mEa58KU74awtybeT0Okf+CTLNXne31BcQ8=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=QSHBDzocbQfNwJi8lVZgIvQKzlLwxBLHkFKLgKTMus5xYTrKdYIJLxSOzBninaWFQ
         CQAOv0OrUhOgf29oWpBkoHa+fbKrjkQC4yUZU+OIMZY4CuOg3wplP15uPpZoFIp953
         btQBlW/od/URrF0dPgbrJCCDTfkTMEr3LgHuk1J8=
Received: from ussmges2new.samsung.com (u111.gpu85.samsung.co.kr
        [203.254.195.111]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p1277c2430cf100d607b33b68fffa0c239~eKHbzQjpJ3115831158uscas1p17;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
Received: from uscas1p1.samsung.com ( [182.198.245.206]) by
        ussmges2new.samsung.com (USCPEMTA) with SMTP id C5.DA.42611.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from ussmgxs3new.samsung.com (u92.gpu85.samsung.co.kr
        [203.254.195.92]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p13ee26532e3a1de36f6081f970190eeed~eKHbfQNCm0296202962uscas1p1F;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
X-AuditID: cbfec36f-249ff7000000a673-92-645d2c597ee0
Received: from SSI-EX2.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs3new.samsung.com (USCPEXMTA) with SMTP id D9.48.64580.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX2.ssi.samsung.com (105.128.2.227) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:40 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:40 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 3/7] hw/mem/cxl_type3: Add a parameter to pass number of DC
 regions the device supports in qemu command line
Thread-Topic: [RFC 3/7] hw/mem/cxl_type3: Add a parameter to pass number of
        DC regions the device supports in qemu command line
Thread-Index: AQHZhDHwgPX9k8X0Wk2f5wJohcsLYA==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-4-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrNKsWRmVeSWpSXmKPExsWy7djXc7qROrEpBs+fW1p0n9/AaDF96gVG
        i9U31zBaNDQ9YrFo2f2eyWL/0+csFqsWXmOzOD/rFIvF84nPmSyWLnnEbHG8dweLA7fHhckT
        WD0WN7h67Jx1l92j5chbIG/PSyaPjR//s3s8ubaZyWPz6xfMHlNn13t83iQXwBXFZZOSmpNZ
        llqkb5fAlfFg6znGgjeCFV3nj7A1MB7m62Lk5JAQMJFYdnoDaxcjF4eQwEpGic5dixkhnFYm
        iddfl7DDVP19vQ3MFhJYyyhx8kY2RNEnRolrs/awQzjLGCX+LrzLBlLFJqAosa9rO5gtImAs
        cezwEmaQImaBtywSH9e8YQFJCAvUSOyed5kFJCEi0Mgo8eboP1aIDj2J/Y33wfaxCKhKnLux
        gxHE5hWwlJhwt5EZxOYUsJLY0HyCCcRmFBCT+H5qDZjNLCAucevJfCaIuwUlFs3ewwxhi0n8
        2/WQDcKWl5j8YwaUrShx//tLdohePYkbU6ewQdjaEssWvmaG2CsocXLmExaIekmJgytugB0t
        ITCZU6Jr3jqgozmAHBeJF/t4IWqkJaavAXkMJJwsseojF0Q4R2L+ki1QY6wlFv5ZzzSBUWUW
        kqtnIbliFpIrZiG5YgEjyypG8dLi4tz01GKjvNRyveLE3OLSvHS95PzcTYzA9Hb63+H8HYzX
        b33UO8TIxMF4iFGCg1lJhPftkugUId6UxMqq1KL8+KLSnNTiQ4zSHCxK4ryGtieThQTSE0tS
        s1NTC1KLYLJMHJxSDUzyEr+3L817oWTFe0Dhn0dfNbul2fSfzjzyiUUeT234fZ3aClcIvDSf
        xasfWHYq8gQLK5/RNseKo7X5PiySJzOsRG8KbA6Y12Ku71hZa/Xbd1v2tjdi57SbVWQ2Sovf
        zRJ5b544I+qHzG5GSxf9vGcyKznWX7934WfgmsLfSc5uXN6qs2xePlPacyM4zj7as110iuG3
        NP/cnnWNT8JUhI89uigqu3feOYPI8Nr2gv9vF9yU33fgTfjyy2IW3xTbdvlVrgt/Xhh6+9qh
        u3KPr0nPuBS3jE2Oa3L2iRvanRqtP99v3zZvdSDPucyy96snscZo7kn1VddZsExbMPXmVc1v
        5X+al1df89yxUGMbixJLcUaioRZzUXEiANoiPT7eAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrFIsWRmVeSWpSXmKPExsWS2cA0UTdSJzbF4PQ6BYvu8xsYLaZPvcBo
        sfrmGkaLhqZHLBYtu98zWex/+pzFYtXCa2wW52edYrF4PvE5k8XSJY+YLY737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSx8eN/do8n1zYzeWx+/YLZY+rseo/Pm+QCuKK4bFJSczLL
        Uov07RK4Mh5sPcdY8Eawouv8EbYGxsN8XYycHBICJhJ/X29j72Lk4hASWM0osXr3ckYI5xOj
        xMf759kgnGWMEpsndzGCtLAJKErs69rOBmKLCBhLHDu8hBnEZhZ4zSLx7SI3iC0sUCOxe95l
        FpBmEYFGRolHT+4xQjToSexvvM8OYrMIqEqcu7EDLM4rYCkx4W4j2CAhIPvjz51gNZwCVhIb
        mk8wgdiMAmIS30+tYYJYJi5x68l8JogfBCSW7DnPDGGLSrx8/I8VwpaXmPxjBhuErShx//tL
        dohePYkbU6ewQdjaEssWvmaGuEFQ4uTMJywQ9ZISB1fcYJnAKDELybpZSNpnIWmfhaR9ASPL
        Kkbx0uLi3PSKYuO81HK94sTc4tK8dL3k/NxNjMDkcPrf4ZgdjPdufdQ7xMjEwXiIUYKDWUmE
        9+2S6BQh3pTEyqrUovz4otKc1OJDjNIcLErivB6xE+OFBNITS1KzU1MLUotgskwcnFINTAGJ
        DKI6f9QnsU0pZ74pzXTsivHrUL4VnHdF/uu4iVYf0n1wXWRH7IZ9TgsLfH8VP7yWVerz+fXx
        7p1KbWWMDkHhBszb8woy25sO7l7LrDhdemn0AdldfsZMSiFrPzxu3CbddTV/yZTzT7z4wxsy
        L69g5dumEP/y2u2Uip6nQr7/TKZ1GZpwqkhfWpYqle6/e+a8utW6311i7kneU37AkPz7S9c8
        FQVTNyUGsZ/CRRH/jvGVaaq1LTeMK5kq/98gpuv6ttPv/07xCEjbMC2HfYOiU5tvWcdzA2+J
        tc0Xknnf8+wTFdx/IWS5Y/SWFYKPzQLPuZye9TWGT6RLkV+5gv+8b7v5xe+bJJdOiElXYinO
        SDTUYi4qTgQAyB8Y830DAAA=
X-CMS-MailID: 20230511175641uscas1p13ee26532e3a1de36f6081f970190eeed
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p13ee26532e3a1de36f6081f970190eeed
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p13ee26532e3a1de36f6081f970190eeed@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 2207
Lines: 77

From: Fan Ni <nifan@outlook.com>

Add a property 'num-dc-regions' to ct3_props to allow users to create DC
regions.
With the change, users can control the number of DC regions the device
supports.
To make it easier, other parameters of the region like region base, length,
and block size are hard coded. If desired, these parameters
can be added easily.

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/mem/cxl_type3.c | 32 ++++++++++++++++++++++++++++++++
 1 file changed, 32 insertions(+)

diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 2b483d3d8e..b9c375d9b4 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -684,6 +684,34 @@ static void ct3d_reg_write(void *opaque, hwaddr offset=
, uint64_t value,
     }
 }
=20
+/*
+ * Create a dc region to test "Get Dynamic Capacity Configuration" command=
.
+ */
+static int cxl_create_toy_regions(CXLType3Dev *ct3d)
+{
+	int i;
+	uint64_t region_base =3D ct3d->hostvmem?ct3d->hostvmem->size
+		+ ct3d->hostpmem->size:ct3d->hostpmem->size;
+	uint64_t region_len =3D 1024*1024*1024;
+	uint64_t decode_len =3D 4; /* 4*256MB */
+	uint64_t blk_size =3D 2*1024*1024;
+	struct CXLDCD_Region *region;
+
+	for (i =3D 0; i < ct3d->dc.num_regions; i++) {
+		region =3D &ct3d->dc.regions[i];
+		region->base =3D region_base;
+		region->decode_len =3D decode_len;
+		region->len =3D region_len;
+		region->block_size =3D blk_size;
+		/* dsmad_handle is set when creating cdat table entries */
+		region->flags =3D 0;
+
+		region_base +=3D region->len;
+	}
+
+	return 0;
+}
+
 static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
 {
     DeviceState *ds =3D DEVICE(ct3d);
@@ -752,6 +780,9 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error *=
*errp)
         g_free(p_name);
     }
=20
+	if (cxl_create_toy_regions(ct3d))
+		return false;
+
     return true;
 }
=20
@@ -1036,6 +1067,7 @@ static Property ct3_props[] =3D {
     DEFINE_PROP_UINT64("sn", CXLType3Dev, sn, UI64_NULL),
     DEFINE_PROP_STRING("cdat", CXLType3Dev, cxl_cstate.cdat.filename),
     DEFINE_PROP_UINT16("spdm", CXLType3Dev, spdm_port, 0),
+	DEFINE_PROP_UINT8("num-dc-regions", CXLType3Dev, dc.num_regions, 0),
     DEFINE_PROP_END_OF_LIST(),
 };
=20
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 63502C7EE25
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:05:28 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239155AbjEKSF1 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:05:27 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59896 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239105AbjEKSFV (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:05:21 -0400
Received: from mailout2.w2.samsung.com (mailout2.w2.samsung.com [211.189.100.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BA857272C
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:04:50 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout2.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175642usoutp02a9bd665f90f5a3c3cab6da135743beb9~eKHcZj1N82433724337usoutp02V;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w2.samsung.com 20230511175642usoutp02a9bd665f90f5a3c3cab6da135743beb9~eKHcZj1N82433724337usoutp02V
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827802;
        bh=QpULL+ioIPOqLvzKWs8eGwI8BmkLVsKBNOUsNKDjwoE=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=HMBp7IYTtxXGbSnVxibPo2S3lQDG3JkZ23VOe64s/zLpOZZhpJm8DgWZvMWx5djlj
         mI+cl0PhXstiolNMjMXH+tybMmAnJtCu1pkLS8NuN01wF7r76ri2sbWmCuyxPiiixW
         mo50enQRlIkwYAWkD12wdynfio78c+MECkCMcmcA=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p24e812a44f9ce2ea34869a3486ae28eb4~eKHcFH3TW1429314293uscas1p2i;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id AF.8A.19925.A5C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from ussmgxs2new.samsung.com (u91.gpu85.samsung.co.kr
        [203.254.195.91]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p1a998a2d4a20c370f0172db93d537ed39~eKHbyYsd30296202962uscas1p1G;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
X-AuditID: cbfec36d-975ff70000004dd5-86-645d2c5a8261
Received: from SSI-EX3.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs2new.samsung.com (USCPEXMTA) with SMTP id 1C.AE.44215.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX3.ssi.samsung.com (105.128.2.228) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:41 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:41 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 5/7] hw/cxl/cxl-mailbox-utils: Add mailbox commands to support
 add/release dynamic capacity response
Thread-Topic: [RFC 5/7] hw/cxl/cxl-mailbox-utils: Add mailbox commands to
        support add/release dynamic capacity response
Thread-Index: AQHZhDHwpHEBWsJ1h0+7w9AQAuHaPg==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-6-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrNKsWRmVeSWpSXmKPExsWy7djX87pROrEpBj8mCVh0n9/AaDF96gVG
        i9U31zBaNDQ9YrFo2f2eyWL/0+csFqsWXmOzOD/rFIvF84nPmSyWLnnEbHG8dweLA7fHhckT
        WD0WN7h67Jx1l92j5chbIG/PSyaPjR//s3s8ubaZyWPz6xfMHlNn13t83iQXwBXFZZOSmpNZ
        llqkb5fAlbG5ZQNrwTznivajZ9gaGBeZdTFyckgImEg8utvC3MXIxSEksJJRYvqfVcwgCSGB
        ViaJT5v0YIp625+zQxStZZQ4umUilPOJUWLt2x+sEM4yRon33/eAtbMJKErs69rOBmKLCBhL
        HDu8BGwHs8BbFomPa96wgCSEBUoknt1axgJRVCmxYlcfVIOexLbevWCDWARUJc7d2MEIYvMK
        WEp823SaHcTmFLCS2NB8ggnEZhQQk/h+ag2YzSwgLnHryXwmiLsFJRbNhjhIAqjm366HbBC2
        vMTkHzOgbEWJ+99fskP06kncmDqFDcLWlli28DUzxF5BiZMzn7BA1EtKHFxxgwXkGQmBfk6J
        +UuPQyVcJHZuOAC1WFri791lQDYHkJ0sseojF0Q4R2L+ki1Q5dYSC/+sZ5rAqDILydmzkJwx
        C8kZs5CcsYCRZRWjeGlxcW56arFhXmq5XnFibnFpXrpecn7uJkZgejv973DuDsYdtz7qHWJk
        4mA8xCjBwawkwvt2SXSKEG9KYmVValF+fFFpTmrxIUZpDhYlcV5D25PJQgLpiSWp2ampBalF
        MFkmDk6pBiYP9SsMyy5vC9Q92spiah0npXf6x2rRY5KRm3inGe/5eGbukmv6ObWeoQdW6cWf
        qb3sfKlyxrNH/S1/n/762fWC43D0ikvV2YHvHpmdDv92s2BudfuTAL45mU3cDB8XNTyXuiD5
        0Oj1JI0VGwIVhI84lXJcmKob1xX7TH2Z64VTE7nO73vwxpgzkLtejzk5y/zpRB2l+Q/0Zplv
        3cOmeV3Tfu5CNebIOq8jiUFZ0o/9cuICn28oEJ2Wt94v7dNEg1vh9yMnVL+QP7ryBFvqj1qf
        rkiz824zDy/9qmeU0Kq5cqbR/v+RDPvKRO/+yn3492Px42mfl7ieulBwct1Xx80Zv63mLbTU
        nRd/Zl7On1nLlViKMxINtZiLihMBYvfvw94DAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrJIsWRmVeSWpSXmKPExsWS2cA0UTdSJzbF4NV0I4vu8xsYLaZPvcBo
        sfrmGkaLhqZHLBYtu98zWex/+pzFYtXCa2wW52edYrF4PvE5k8XSJY+YLY737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSx8eN/do8n1zYzeWx+/YLZY+rseo/Pm+QCuKK4bFJSczLL
        Uov07RK4Mja3bGAtmOdc0X70DFsD4yKzLkZODgkBE4ne9ufsXYxcHEICqxklfnyYBOV8YpTo
        6Z/CCuEsY5Ro3LqOFaSFTUBRYl/XdjYQW0TAWOLY4SXMIDazwGsWiW8XuUFsYYESiWe3lrFA
        1FRK/L//hBHC1pPY1rsXrJ5FQFXi3I0dYHFeAUuJb5tOs4PYQkD2x587wWxOASuJDc0nmEBs
        RgExie+n1jBB7BKXuPVkPhPECwISS/acZ4awRSVePv7HCmHLS0z+MYMNwlaUuP/9JTtEr57E
        jalT2CBsbYllC18zQ9wgKHFy5hMWiHpJiYMrbrBMYJSYhWTdLCTts5C0z0LSvoCRZRWjeGlx
        cW56RbFRXmq5XnFibnFpXrpecn7uJkZgajj973D0Dsbbtz7qHWJk4mA8xCjBwawkwvt2SXSK
        EG9KYmVValF+fFFpTmrxIUZpDhYlcd6XURPjhQTSE0tSs1NTC1KLYLJMHJxSDUysp4OWLPoe
        ffTE+/ZJ3zeaizH+Nm+8nni+OWfd0y+RaYYf6rb0XHxy3YJB1TzkzuHJhcr5W/Z7aq6W/s/h
        acB2LSvy5Ju10Wum2PEF/1rSxB70VivGasGOC6lnVE6yVqkmt7BMOBxhW976SKhAbdLnh58X
        MjwrXuHk+dpfMlOJx2K1bzJX/BajyTUrp0Zc0Dt3q7NB8cKCzT9n7r6bUMAvZP5shk2giIFN
        Kt8Oh5ow91+LW512LWN8yzvFRvrjxMuPqr8u17a6nDqbyVG348R1Jkk/6c1PDu8IUWINqtyZ
        vrDLtbPI/nGxebGNcMYV9pArNzMfbo/KfV1Sa7LCeMPETSHBBxVqNL/y1XD7ZCmxFGckGmox
        FxUnAgAMiTOtfAMAAA==
X-CMS-MailID: 20230511175642uscas1p1a998a2d4a20c370f0172db93d537ed39
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175642uscas1p1a998a2d4a20c370f0172db93d537ed39
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175642uscas1p1a998a2d4a20c370f0172db93d537ed39@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 8326
Lines: 280

From: Fan Ni <nifan@outlook.com>

Per CXL spec 3.0, we implemented the two mailbox commands:
Add Dynamic Capacity Response (Opcode 4802h) 8.2.9.8.9.3, and
Release Dynamic Capacity Response (Opcode 4803h) 8.2.9.8.9.4.

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/cxl/cxl-mailbox-utils.c  | 223 ++++++++++++++++++++++++++++++++++++
 include/hw/cxl/cxl_device.h |   3 +-
 2 files changed, 225 insertions(+), 1 deletion(-)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index ed2ac154cb..7212934627 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -84,6 +84,8 @@ enum {
 	DCD_CONFIG =3D 0x48, /*8.2.9.8.9*/
 		#define GET_DC_REGION_CONFIG   0x0
 		#define GET_DYN_CAP_EXT_LIST   0x1
+		#define ADD_DYN_CAP_RSP        0x2
+		#define RELEASE_DYN_CAP        0x3
     PHYSICAL_SWITCH =3D 0x51
         #define IDENTIFY_SWITCH_DEVICE      0x0
 };
@@ -1069,6 +1071,221 @@ static CXLRetCode cmd_dcd_get_dyn_cap_ext_list(stru=
ct cxl_cmd *cmd,
 	return CXL_MBOX_SUCCESS;
 }
=20
+static inline int test_bits(const unsigned long *addr, int nr, int size)
+{
+	unsigned long res =3D find_next_zero_bit(addr, size + nr, nr);
+
+	if (res >=3D nr + size)
+		return 1;
+	else
+		return 0;
+}
+
+static uint8_t find_region_id(struct CXLType3Dev *dev, uint64_t dpa
+		, uint64_t len)
+{
+	int8_t i =3D dev->dc.num_regions-1;
+
+	while (i > 0 && dpa < dev->dc.regions[i].base)
+		i--;
+
+	if (dpa < dev->dc.regions[i].base
+			|| dpa + len > dev->dc.regions[i].base + dev->dc.regions[i].len)
+		return dev->dc.num_regions;
+
+	return i;
+}
+
+static CXLRetCode detect_malformed_extent_list(CXLType3Dev *dev, void *dat=
a)
+{
+	struct updated_dc_extent_list_in_pl {
+		uint32_t num_entries_updated;
+		uint8_t rsvd[4];
+		struct {
+			uint64_t start_dpa;
+			uint64_t len;
+			uint8_t rsvd[8];
+		} QEMU_PACKED updated_entries[];
+	} QEMU_PACKED;
+
+	struct updated_dc_extent_list_in_pl *in =3D data;
+	unsigned long *blk_bitmap;
+	uint64_t min_block_size =3D dev->dc.regions[0].block_size;
+	struct CXLDCD_Region *region =3D &dev->dc.regions[0];
+	uint32_t i;
+	uint64_t dpa, len;
+	uint8_t rid;
+
+	for (i =3D 1; i < dev->dc.num_regions; i++) {
+		region =3D &dev->dc.regions[i];
+		if (min_block_size > region->block_size)
+			min_block_size =3D region->block_size;
+	}
+	blk_bitmap =3D bitmap_new((region->len + region->base
+				- dev->dc.regions[0].base) / min_block_size);
+	g_assert(blk_bitmap);
+	bitmap_zero(blk_bitmap, (region->len + region->base
+				- dev->dc.regions[0].base) / min_block_size);
+
+	for (i =3D 0; i < in->num_entries_updated; i++) {
+		dpa =3D in->updated_entries[i].start_dpa;
+		len =3D in->updated_entries[i].len;
+
+		rid =3D find_region_id(dev, dpa, len);
+		if (rid =3D=3D dev->dc.num_regions) {
+			g_free(blk_bitmap);
+			return CXL_MBOX_INVALID_PA;
+		}
+		region =3D &dev->dc.regions[rid];
+		if (dpa % region->block_size || len % region->block_size) {
+			g_free(blk_bitmap);
+			return CXL_MBOX_INVALID_EXTENT_LIST;
+		}
+		/* the dpa range already covered by some other extents in the list */
+		if (test_bits(blk_bitmap, dpa/min_block_size, len/min_block_size)) {
+			g_free(blk_bitmap);
+			return CXL_MBOX_INVALID_EXTENT_LIST;
+		}
+		bitmap_set(blk_bitmap, dpa/min_block_size, len/min_block_size);
+	}
+
+	g_free(blk_bitmap);
+	return CXL_MBOX_SUCCESS;
+}
+
+/*
+ * cxl spec 3.0: 8.2.9.8.9.3
+ * Add Dynamic Capacity Response (opcode 4802h)
+ * Assuming extent list is updated when a extent is added, when receiving
+ * the response, verify and ensure the extent is utilized by the host, and
+ * update extent list  as needed.
+ **/
+static CXLRetCode cmd_dcd_add_dyn_cap_rsp(struct cxl_cmd *cmd,
+		CXLDeviceState *cxl_dstate,
+		uint16_t *len_unused)
+{
+	struct add_dyn_cap_ext_list_in_pl {
+		uint32_t num_entries_updated;
+		uint8_t rsvd[4];
+		struct {
+			uint64_t start_dpa;
+			uint64_t len;
+			uint8_t rsvd[8];
+		} QEMU_PACKED updated_entries[];
+	} QEMU_PACKED;
+
+	struct add_dyn_cap_ext_list_in_pl *in =3D (void *)cmd->payload;
+	struct CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_ds=
tate);
+	CXLDCDExtentList *extent_list =3D &ct3d->dc.extents;
+	CXLDCD_Extent *ent;
+	uint32_t i;
+	uint64_t dpa, len;
+	CXLRetCode rs;
+
+	if (in->num_entries_updated =3D=3D 0)
+		return CXL_MBOX_SUCCESS;
+
+	rs =3D detect_malformed_extent_list(ct3d, in);
+	if (rs !=3D CXL_MBOX_SUCCESS)
+		return rs;
+
+	for (i =3D 0; i < in->num_entries_updated; i++) {
+		dpa =3D in->updated_entries[i].start_dpa;
+		len =3D in->updated_entries[i].len;
+
+		/* Todo: check following
+		 * One or more of the updated extent lists contain Starting DPA
+		 * or Lengths that are out of range of a current extent list
+		 * maintained by the device.
+		 **/
+
+		QTAILQ_FOREACH(ent, extent_list, node) {
+			if (ent->start_dpa =3D=3D dpa && ent->len =3D=3D len)
+				return CXL_MBOX_INVALID_PA;
+			if (ent->start_dpa <=3D dpa
+				&& dpa + len <=3D ent->start_dpa + ent->len) {
+				ent->start_dpa =3D dpa;
+				ent->len =3D len;
+				break;
+			} else if ((dpa < ent->start_dpa + ent->len
+				&& dpa + len > ent->start_dpa + ent->len)
+				|| (dpa < ent->start_dpa && dpa + len > ent->start_dpa))
+				return CXL_MBOX_INVALID_EXTENT_LIST;
+		}
+		// a new extent added
+		if (!ent) {
+			ent =3D g_new0(CXLDCD_Extent, 1);
+			assert(ent);
+			ent->start_dpa =3D dpa;
+			ent->len =3D len;
+			memset(ent->tag, 0, 0x10);
+			ent->shared_seq =3D 0;
+			QTAILQ_INSERT_TAIL(extent_list, ent, node);
+		}
+	}
+
+	return CXL_MBOX_SUCCESS;
+}
+
+/*
+ * Spec 3.0: 8.2.9.8.9.4
+ * Release Dynamic Capacity (opcode 4803h)
+ **/
+static CXLRetCode cmd_dcd_release_dcd_capacity(struct cxl_cmd *cmd,
+		CXLDeviceState *cxl_dstate,
+		uint16_t *len_unused)
+{
+	struct release_dcd_cap_in_pl {
+		uint32_t num_entries_updated;
+		uint8_t rsvd[4];
+		struct {
+			uint64_t start_dpa;
+			uint64_t len;
+			uint8_t rsvd[8];
+		} QEMU_PACKED updated_entries[];
+	} QEMU_PACKED;
+
+	struct release_dcd_cap_in_pl *in =3D (void *)cmd->payload;
+	struct CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_ds=
tate);
+	CXLDCDExtentList *extent_list =3D &ct3d->dc.extents;
+	CXLDCD_Extent *ent;
+	uint32_t i;
+	uint64_t dpa, len;
+	CXLRetCode rs;
+
+	if (in->num_entries_updated =3D=3D 0)
+		return CXL_MBOX_INVALID_INPUT;
+
+	rs =3D detect_malformed_extent_list(ct3d, in);
+	if (rs !=3D CXL_MBOX_SUCCESS)
+		return rs;
+
+		/* Todo: check following
+		 * One or more of the updated extent lists contain Starting DPA
+		 * or Lengths that are out of range of a current extent list
+		 * maintained by the device.
+		 **/
+
+	for (i =3D 0; i < in->num_entries_updated; i++) {
+		dpa =3D in->updated_entries[i].start_dpa;
+		len =3D in->updated_entries[i].len;
+
+		QTAILQ_FOREACH(ent, extent_list, node) {
+			if (ent->start_dpa =3D=3D dpa && ent->len =3D=3D len)
+				break;
+			else if ((dpa < ent->start_dpa + ent->len
+				&& dpa + len > ent->start_dpa + ent->len)
+				|| (dpa < ent->start_dpa && dpa + len > ent->start_dpa))
+				return CXL_MBOX_INVALID_EXTENT_LIST;
+		}
+		/* found the entry, release it */
+		if (ent)
+			QTAILQ_REMOVE(extent_list, ent, node);
+	}
+
+	return CXL_MBOX_SUCCESS;
+}
+
 #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
 #define IMMEDIATE_DATA_CHANGE (1 << 2)
 #define IMMEDIATE_POLICY_CHANGE (1 << 3)
@@ -1112,6 +1329,12 @@ static struct cxl_cmd cxl_cmd_set[256][256] =3D {
 	[DCD_CONFIG][GET_DYN_CAP_EXT_LIST] =3D {
 		"DCD_GET_DYNAMIC_CAPACITY_EXTENT_LIST", cmd_dcd_get_dyn_cap_ext_list,
 		8, 0 },
+	[DCD_CONFIG][ADD_DYN_CAP_RSP] =3D {
+		"ADD_DCD_DYNAMIC_CAPACITY_RESPONSE", cmd_dcd_add_dyn_cap_rsp,
+		~0, IMMEDIATE_DATA_CHANGE },
+	[DCD_CONFIG][RELEASE_DYN_CAP] =3D {
+		"RELEASE_DCD_DYNAMIC_CAPACITY", cmd_dcd_release_dcd_capacity,
+		~0, IMMEDIATE_DATA_CHANGE },
 };
=20
 static struct cxl_cmd cxl_cmd_set_sw[256][256] =3D {
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index 20ad5e7411..c0c8fcc24b 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -131,7 +131,8 @@ typedef enum {
     CXL_MBOX_INCORRECT_PASSPHRASE =3D 0x14,
     CXL_MBOX_UNSUPPORTED_MAILBOX =3D 0x15,
     CXL_MBOX_INVALID_PAYLOAD_LENGTH =3D 0x16,
-    CXL_MBOX_MAX =3D 0x17
+	CXL_MBOX_INVALID_EXTENT_LIST =3D 0x17,
+	CXL_MBOX_MAX =3D 0x18
 } CXLRetCode;
=20
 struct cxl_cmd;
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 41589C7EE25
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:09:50 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239099AbjEKSJt (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:09:49 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36526 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239167AbjEKSJp (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:09:45 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 389CE1FC8
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:09:23 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175642usoutp016ff44876c1154987e787f6a52be0b3fc~eKHcY73Xq3054030540usoutp01K;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230511175642usoutp016ff44876c1154987e787f6a52be0b3fc~eKHcY73Xq3054030540usoutp01K
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827802;
        bh=qnonfFhRqaQhfcHEEqB6lqEoDUX58PGX49mIU0WSJvw=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=J9awrlXHW3ewrOvyfVNQx7Apu1u6fEtn6XtIEydb/O4IsunKFp54sb7+G99twn/vD
         FHPY3M0+4CfWTu2m1XBX3kJ9X/dO6iefMJ6eVZ9Hx2BUQtAdZO7E8j7MVX32WbJpAH
         ESTBrej4jlWKWCacIBRjHrhPdStoU6AukGTQqwoo=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175642uscas1p28fed0f20cf98f207ebd0e580ce44da32~eKHcD9Mj21431814318uscas1p2l;
        Thu, 11 May 2023 17:56:42 +0000 (GMT)
Received: from uscas1p1.samsung.com ( [182.198.245.206]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id 9F.8A.19925.A5C2D546; Thu,
        11 May 2023 13:56:42 -0400 (EDT)
Received: from ussmgxs3new.samsung.com (u92.gpu85.samsung.co.kr
        [203.254.195.92]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530~eKHbw18qu2038420384uscas1p2F;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
X-AuditID: cbfec36d-bdbfe70000004dd5-85-645d2c5a5174
Received: from SSI-EX2.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs3new.samsung.com (USCPEXMTA) with SMTP id 9A.48.64580.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX2.ssi.samsung.com (105.128.2.227) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:40 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:40 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [RFC 4/7] hw/mem/cxl_type3: Add DC extent representative to cxl
 type3 device
Thread-Topic: [RFC 4/7] hw/mem/cxl_type3: Add DC extent representative to
        cxl type3 device
Thread-Index: AQHZhDHwR5sIHyogW0GjyQHnw1WJeg==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-5-fan.ni@samsung.com>
In-Reply-To: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA02Sf0yMcRzH932e5+6ezo6npD6y9QuzhUvDPOXnDHtotpRhynKuR+Hu6K6I
        Pzg/Gi7Wkchz1i+x5JS7jHT9UJk4djVWSy1W4rpdxy4jzIXuOVv/vd7fz/v7+by/n31JPMAq
        CCH3qbJYtUqmiBSKiYfPvtkW7lywK23RudypdF7HfURfK+xE9N23RkRrTw0S9BnLF4xu/mgn
        6KqybiHdwVkJ2n7JjtG3KgZxuv1iHbFmCtNZoBcwN7Xrmcdcv4g589T1TzU4MMbk/iNihrpr
        MabWOYwzhYYTzFdzaIJ4p3hFGqvYd5hVR6/aLc7oebfhUFF0jq7JINKi1nk6RJJALQH79y06
        JCYDqDsInrs8OC9yMTD8bBbqkJ/X9EFvI/jCPQRWx2WMF6MIurkGES9uI/CU9XuvCKkIaNI9
        8nIgtRietVV4++KUiwC3cYSYKEyntsNNj1vEm1LgXttZAc9SsBSd93oIai7YeurQBEuoWDBc
        yPeyHxUH908/xyYYUUEwZjV6GaeCoXeoBONz+0O5oQHnOQjG6wd87wmDgh9FPo6A92MOEX9X
        Cj2FV4Q8z4fbZU6cn+sPL64PEbx/JrRU9nh3AVSeH1QbTvoarYNP5gHf4FlwzfiG4Dcshyq3
        mD9WQEnFA1+f5VD2uwbTozncpNjcpBjcpBjcpBiliKhCwdkajTKd1cSo2CNSjUypyValS+UH
        lWb077u9HG9T1qG6Xre0FWEkakVA4pGBEldFclqAJE129BirPpiqzlawmlY0iyQigyUxK1/I
        A6h0WRZ7gGUPser/VYz0C9FiSyTVwVufiC0HnF2LxYr1C6NU6tJ2bltKgfTXqdCUZLg6UD2/
        0dK3pbnxJ7Z0Wvj0oXyUGa4+mWs6MmhKCuVmRq24xJREd7kiEhTFs/sqN/rr3+61xyZmrBz+
        44nvXiQzy8fW7s5c13I8Icspr7+higsqfjWDW/a12jbF1askH7T05nUKornG/dyvnCTLaFif
        9uzm0iv11s8eR3Lt+J72J5UdF9sHzNvDQuKKd5y4XEMsO6y/a0lEOoeryPam/FNXYKVjo57N
        Xm2KTVUMF7Q19V+vyakp2bTp3OYFynDniNGdlNm8plgYOhoiCG8aeWXc25BvKh0NO54ROPg6
        vio1ktBkyGKicLVG9hfLNra63QMAAA==
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFnrBIsWRmVeSWpSXmKPExsWS2cA0UTdSJzbF4MsbQ4vu8xsYLaZPvcBo
        sfrmGkaLhqZHLBYtu98zWex/+pzFYtXCa2wW52edYrF4PvE5k8XSJY+YLY737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSx8eN/do8n1zYzeWx+/YLZY+rseo/Pm+QCuKK4bFJSczLL
        Uov07RK4Mm7ccyuYoV/RtW82ewPjIfUuRk4OCQETiccTzrF0MXJxCAmsZpQ43L2aEcL5xCjx
        8f55NghnGaPE5sldjCAtbAKKEvu6trOB2CICxhLHDi9hBrGZBV6zSHy7yA1iCwuES5y/+oAR
        oiZGoq+9iQnC1pPYPaOTBcRmEVCVOHdjB1gNr4ClxOyefjBbCMj++HMnO4jNKWAlsaH5BFgv
        o4CYxPdTa5ggdolL3HoynwniBQGJJXvOM0PYohIvH/9jhbDlJSb/mMEGYStK3P/+kh2iV0/i
        xtQpbBC2tsSyha+ZIW4QlDg58wkLRL2kxMEVN1gmMErMQrJuFpL2WUjaZyFpX8DIsopRvLS4
        ODe9otg4L7Vcrzgxt7g0L10vOT93EyMwMZz+dzhmB+O9Wx/1DjEycTAeYpTgYFYS4X27JDpF
        iDclsbIqtSg/vqg0J7X4EKM0B4uSOK9H7MR4IYH0xJLU7NTUgtQimCwTB6dUA5NAn3KvKs+E
        yrqqNVJT96RzmKY/adTRatY+tDAnqyrr65n2so0Tjp1d/7rWUdJdszO/7pr5f6+c6a94Sktk
        VlmVbZ26IPmDsJRQ3xL3meyhDHxJV1+dM+S04bCqY3KZeWVzV9Ce6I03M2smKBj/XLOXQ2kj
        V+SeXQmNIR+Mr83tMbKMnVt+dtKXH19P57K9F3PZ1ib2o9DOPoHVw8Zzu2xUwQrBqkSGj9Uy
        7YErO0Ki17D4365XTFHQj7RLWyDdFPrZlr0r3iDh1+xtW9sVuBalRyurCnx1rZj33fLVjfA9
        08TL5NP3efOpKuv2ecxw6V/w9/bWWN4Fug4/bj6qrnfgWftGqmy577Nn39KVWIozEg21mIuK
        EwESj5NeewMAAA==
X-CMS-MailID: 20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530
References: <20230511175609.2091136-1-fan.ni@samsung.com>
        <CGME20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 5849
Lines: 191

From: Fan Ni <nifan@outlook.com>

Add dynamic capacity extent information to the definition of
CXLType3Dev and add get DC extent list mailbox command based on
CXL.spec.3.0:.8.2.9.8.9.2.

With this command, we can create dc regions as below:

region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
echo 1 > /sys/bus/cxl/devices/$region/interleave_ways

echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
echo 0x30000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size

echo 0x30000000 > /sys/bus/cxl/devices/$region/size
echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
echo 1 > /sys/bus/cxl/devices/$region/commit
echo $region > /sys/bus/cxl/drivers/cxl_region/bind

Signed-off-by: Fan Ni <fan.ni@samsung.com>
---
 hw/cxl/cxl-mailbox-utils.c  | 73 ++++++++++++++++++++++++++++++++++++-
 hw/mem/cxl_type3.c          |  1 +
 include/hw/cxl/cxl_device.h | 23 ++++++++++++
 3 files changed, 96 insertions(+), 1 deletion(-)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 61c77e52d8..ed2ac154cb 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -83,6 +83,7 @@ enum {
         #define CLEAR_POISON           0x2
 	DCD_CONFIG =3D 0x48, /*8.2.9.8.9*/
 		#define GET_DC_REGION_CONFIG   0x0
+		#define GET_DYN_CAP_EXT_LIST   0x1
     PHYSICAL_SWITCH =3D 0x51
         #define IDENTIFY_SWITCH_DEVICE      0x0
 };
@@ -938,7 +939,7 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd=
 *cmd,
 }
=20
 /*
- * cxl spec 3.0: 8.2.9.8.9.2
+ * cxl spec 3.0: 8.2.9.8.9.1
  * Get Dynamic Capacity Configuration
  **/
 static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
@@ -1001,6 +1002,73 @@ static CXLRetCode cmd_dcd_get_dyn_cap_config(struct =
cxl_cmd *cmd,
 	return CXL_MBOX_SUCCESS;
 }
=20
+/*
+ * cxl spec 3.0: 8.2.9.8.9.2
+ * Get Dynamic Capacity Extent List (Opcode 4810h)
+ **/
+static CXLRetCode cmd_dcd_get_dyn_cap_ext_list(struct cxl_cmd *cmd,
+		CXLDeviceState *cxl_dstate,
+		uint16_t *len)
+{
+	struct get_dyn_cap_ext_list_in_pl {
+		uint32_t extent_cnt;
+		uint32_t start_extent_id;
+	} QEMU_PACKED;
+
+	struct get_dyn_cap_ext_list_out_pl {
+		uint32_t count;
+		uint32_t total_extents;
+		uint32_t generation_num;
+		uint8_t rsvd[4];
+		struct {
+			uint64_t start_dpa;
+			uint64_t len;
+			uint8_t tag[0x10];
+			uint16_t shared_seq;
+			uint8_t rsvd[6];
+		} QEMU_PACKED records[];
+	} QEMU_PACKED;
+
+	struct get_dyn_cap_ext_list_in_pl *in =3D (void *)cmd->payload;
+	struct get_dyn_cap_ext_list_out_pl *out =3D (void *)cmd->payload;
+	struct CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_ds=
tate);
+	uint16_t record_count =3D 0, i =3D 0, record_done =3D 0;
+	CXLDCDExtentList *extent_list =3D &ct3d->dc.extents;
+	CXLDCD_Extent *ent;
+	uint16_t out_pl_len;
+
+	if (in->start_extent_id > ct3d->dc.total_extent_count)
+		return CXL_MBOX_INVALID_INPUT;
+
+	if (ct3d->dc.total_extent_count - in->start_extent_id < in->extent_cnt)
+		record_count =3D ct3d->dc.total_extent_count - in->start_extent_id;
+	else
+		record_count =3D in->extent_cnt;
+
+	out_pl_len =3D sizeof(*out) + record_count * sizeof(out->records[0]);
+	assert(out_pl_len <=3D CXL_MAILBOX_MAX_PAYLOAD_SIZE);
+
+	memset(out, 0, out_pl_len);
+	stl_le_p(&out->count, record_count);
+	stl_le_p(&out->total_extents, ct3d->dc.total_extent_count);
+	stl_le_p(&out->generation_num, ct3d->dc.ext_list_gen_seq);
+
+	QTAILQ_FOREACH(ent, extent_list, node) {
+		if (i++ < in->start_extent_id)
+			continue;
+		stq_le_p(&out->records[i].start_dpa, ent->start_dpa);
+		stq_le_p(&out->records[i].len, ent->len);
+		memcpy(&out->records[i].tag, ent->tag, 0x10);
+		stw_le_p(&out->records[i].shared_seq, ent->shared_seq);
+		record_done++;
+		if (record_done =3D=3D record_count)
+			break;
+	}
+
+	*len =3D out_pl_len;
+	return CXL_MBOX_SUCCESS;
+}
+
 #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
 #define IMMEDIATE_DATA_CHANGE (1 << 2)
 #define IMMEDIATE_POLICY_CHANGE (1 << 3)
@@ -1041,6 +1109,9 @@ static struct cxl_cmd cxl_cmd_set[256][256] =3D {
         cmd_media_clear_poison, 72, 0 },
 	[DCD_CONFIG][GET_DC_REGION_CONFIG] =3D { "DCD_GET_DC_REGION_CONFIG",
 		cmd_dcd_get_dyn_cap_config, 2, 0 },
+	[DCD_CONFIG][GET_DYN_CAP_EXT_LIST] =3D {
+		"DCD_GET_DYNAMIC_CAPACITY_EXTENT_LIST", cmd_dcd_get_dyn_cap_ext_list,
+		8, 0 },
 };
=20
 static struct cxl_cmd cxl_cmd_set_sw[256][256] =3D {
diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index b9c375d9b4..23954711b5 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -708,6 +708,7 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
=20
 		region_base +=3D region->len;
 	}
+	QTAILQ_INIT(&ct3d->dc.extents);
=20
 	return 0;
 }
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index 8a04e53e90..20ad5e7411 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -385,6 +385,25 @@ typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
=20
 #define DCD_MAX_REGION_NUM 8
=20
+typedef struct CXLDCD_Extent_raw {
+	uint64_t start_dpa;
+	uint64_t len;
+	uint8_t tag[0x10];
+	uint16_t shared_seq;
+	uint8_t rsvd[0x6];
+} QEMU_PACKED CXLDCExtent_raw;
+
+typedef struct CXLDCD_Extent {
+	uint64_t start_dpa;
+	uint64_t len;
+	uint8_t tag[0x10];
+	uint16_t shared_seq;
+	uint8_t rsvd[0x6];
+
+	QTAILQ_ENTRY(CXLDCD_Extent) node;
+} CXLDCD_Extent;
+typedef QTAILQ_HEAD(, CXLDCD_Extent) CXLDCDExtentList;
+
 typedef struct CXLDCD_Region {
 	uint64_t base;
 	uint64_t decode_len; /* in multiples of 256MB */
@@ -429,6 +448,10 @@ struct CXLType3Dev {
 	struct dynamic_capacity {
 		uint8_t num_regions; // 1-8
 		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
+		CXLDCDExtentList extents;
+
+		uint32_t total_extent_count;
+		uint32_t ext_list_gen_seq;
 	} dc;
 };
=20
--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id BDB42C77B7F
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 18:05:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239062AbjEKSFW (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 14:05:22 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59860 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239065AbjEKSFU (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 14:05:20 -0400
Received: from mailout2.w2.samsung.com (mailout2.w2.samsung.com [211.189.100.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BA68C1BF8
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 11:04:50 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout2.w2.samsung.com (KnoxPortal) with ESMTP id 20230511175641usoutp0272e0e37d55a27172c52c276d6005d446~eKHbdH2uV2433724337usoutp02T;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w2.samsung.com 20230511175641usoutp0272e0e37d55a27172c52c276d6005d446~eKHbdH2uV2433724337usoutp02T
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1683827801;
        bh=oqlYCvn41HPxLDqiATSn+WDpTfWwMYBrNJiG5XMLHV4=;
        h=From:To:CC:Subject:Date:References:From;
        b=lF2J8dJvakD5KpBdxpIq2b7lKU4b6FXAXCMxV2FKCJff17UM5BtvqYWBEh6Q+ck6B
         SW6sZ2j+PRoaRYV6po6uV1JpGrSn8JC0OmMYZILU0JbxsJsVVyU1YiIOWaPvlphRTR
         Y1DRrxgkivK+qKv5QBxCjvY2dJTgcKIdT/wvCimI=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p203375f8025adf3dbbc7ba067098f3c31~eKHbSxuJv1429314293uscas1p2f;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id AD.8A.19925.95C2D546; Thu,
        11 May 2023 13:56:41 -0400 (EDT)
Received: from ussmgxs3new.samsung.com (u92.gpu85.samsung.co.kr
        [203.254.195.92]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c~eKHa4Lush2038820388uscas1p2f;
        Thu, 11 May 2023 17:56:41 +0000 (GMT)
X-AuditID: cbfec36d-975ff70000004dd5-82-645d2c59067d
Received: from SSI-EX2.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs3new.samsung.com (USCPEXMTA) with SMTP id 19.48.64580.85C2D546; Thu,
        11 May 2023 13:56:40 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX2.ssi.samsung.com (105.128.2.227) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 11 May 2023 10:56:40 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        11 May 2023 10:56:40 -0700
From: Fan Ni <fan.ni@samsung.com>
To: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
CC: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>,
        Fan Ni <fan.ni@samsung.com>
Subject: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Topic: [Qemu RFC 0/7] Early enabling of DCD emulation in Qemu
Thread-Index: AQHZhDHwBF2t8l6CHEO7jqFQqFgBOA==
Date: Thu, 11 May 2023 17:56:40 +0000
Message-ID: <20230511175609.2091136-1-fan.ni@samsung.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-mailer: git-send-email 2.25.1
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrOKsWRmVeSWpSXmKPExsWy7djX87qROrEpBstXS1p0n9/AaDF96gVG
        i9U31zBaNDQ9YrFo2f2eyWL/0+csFqsWXmOzOD/rFIvF84nPmSyWLnnEbHG8dweLA7fHhckT
        WD0WN7h67Jx1l92j5chbIG/PSyaPjR//s3s8ubaZyWPz6xfMHlNn13t83iQXwBXFZZOSmpNZ
        llqkb5fAlXFi/l6WghWeFb8/djE1MM627mLk5JAQMJFYdXM9O4gtJLCSUaJ9dy2E3cok0XIo
        AKbm25L1rBDxtYwST594dzFyAdmfGCWuzdrDDuEsY5T4u/AuG0gVm4CixL6u7WC2iICxxLHD
        S5hBipgF3rJIfFzzhgUkISxgLzF5yjnGLkYOoCIXiUvP/CBMPYlznzxBKlgEVCXO3djBCGLz
        ClhKbH7zDWwko4CYxPdTa5hAbGYBcYlbT+YzQRwqKLFo9h5mCFtM4t+uh2wQtrzE5B8zoGxF
        ifvfX7JD9OpJ3Jg6hQ3C1pZYtvA1M8QuQYmTM5+wQNRLShxccYMF5HwJgS8cEnOmtrBCJFwk
        vq3+C7VYWmL6msssIPdLCCRLrPrIBRHOkZi/ZAvUHGuJhX/WQ93MJ/H31yPGCYzKs5C8MAvJ
        SbOQnDQLyUkLGFlWMYqXFhfnpqcWG+allusVJ+YWl+al6yXn525iBKa10/8O5+5g3HHro94h
        RiYOxkOMEhzMSiK8b5dEpwjxpiRWVqUW5ccXleakFh9ilOZgURLnNbQ9mSwkkJ5YkpqdmlqQ
        WgSTZeLglGpgck+R4XixiyuyrkxFX2+Zf4D35udrjn/W9FbhnvB3oWk3i5+ieUkln6PBx1Kn
        dSf+cQXO+1RRv613Ofu2nqaTXVcv7jlbPsfouXV96+dZLYUtbLYROpfffH1memjnA9ufFiXr
        dF2FLGd+XpZTsXib+m1TBmP/987RM2OWno4r9X2f+E7SWD725bHn4dNDp5ca9Ykf0y3wfvm4
        ss1UcY60VcH6+vdPxV/wMdyUTKjb9uHYdv95uYv1pTbnHj3qITantVrzY90p+X8NXlbZsz5d
        avz44/FJd8OOu037G0784Xkta7ut1mFBXNeSCW+/KJbP57kULGPz/83jJlFXucvrfj6c7jP7
        3e1/9fmVDSenKLEUZyQaajEXFScCAP8F+U3aAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFjrPIsWRmVeSWpSXmKPExsWS2cA0STdCJzbFYHKrhUX3+Q2MFtOnXmC0
        WH1zDaNFQ9MjFouW3e+ZLPY/fc5isWrhNTaL87NOsVg8n/icyWLpkkfMFsd7d7A4cHtcmDyB
        1WNxg6vHzll32T1ajrwF8va8ZPLY+PE/u8eTa5uZPDa/fsHsMXV2vcfnTXIBXFFcNimpOZll
        qUX6dglcGSfm72UpWOFZ8ftjF1MD42zrLkZODgkBE4lvS9azdjFycQgJrGaU+PXmIBOE84lR
        4uP982wQzjJGic2TuxhBWtgEFCX2dW1nA7FFBIwljh1ewgxiMwu8ZpH4dpEbxBYWsJeYPOUc
        UD0HUI2LxKVnfhCmnsS5T54gFSwCqhLnbuwAm8grYCmx+c03sImMAmIS30+tYYKYKC5x68l8
        JohDBSSW7DnPDGGLSrx8/I8VwpaXmPxjBhuErShx//tLdohePYkbU6ewQdjaEssWvmaG2CUo
        cXLmExaIekmJgytusExgFJuFZN0sJO2zkLTPQtK+gJFlFaN4aXFxbnpFsXFearlecWJucWle
        ul5yfu4mRmCcn/53OGYH471bH/UOMTJxMB5ilOBgVhLhfbskOkWINyWxsiq1KD++qDQntfgQ
        ozQHi5I4r0fsxHghgfTEktTs1NSC1CKYLBMHp1QDk+DF4GL+tN5m+aObc/T2LBFPEd3qpmHy
        7uJ9FwdLFV+X4zv+dTzhCryeoOleKSP24TrzgsPH5U9HdFw7f6B0zZWwFTkezlw9auLm+m+i
        zLiiTGd7TJjGFXjtsoO83uHGqLf2bxktzicZlv9KXWdvMmn7TLGr371WtnFpZ5bxzJvT8GXV
        8tTb7HO17vyueLpl7ZFFbqu+iBtw2TtdPtmekeb5qHid2LtcOe+spnmntEx7kmb/aTwiGV/+
        tOSK6ecjObs5Hi2Kny1rtyT7WXeVmqSVmpTgM884t3XV3pZ8vSJlGctvngnTvMgf8MVEs2zO
        Zps3hpk3Xp0tK5Xf8cc89szPv9ePLjo66Z/juqUcSizFGYmGWsxFxYkAXZQDvGIDAAA=
X-CMS-MailID: 20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c
CMS-TYPE: 301P
X-CMS-RootMailID: 20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c
References: <CGME20230511175641uscas1p2b1877f9179709b69e293acdd7e57104c@uscas1p2.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 9131
Lines: 253

Since the early draft of DCD support in kernel is out
(https://lore.kernel.org/linux-cxl/20230417164126.GA1904906@bgt-140510-bm03=
/T/#t),
this patch series provide dcd emulation in qemu so people who are intereste=
d
can have an early try. It is noted that the patch series may need to be upd=
ated
accordingly if the kernel side implementation changes.

To support DCD emulation, the patch series add DCD related mailbox command
support (CXL Spec 3.0: 8.2.9.8.9), and extend the cxl type3 memory device
with dynamic capacity extent and region representative.
To support read/write to the dynamic capacity of the device, a host backend
is provided and necessary check mechnism is added to ensure the dynamic
capacity accessed is backed with active dc extents.
Currently FM related mailbox commands (cxl spec 3.0: 7.6.7.6) is not suppor=
ted
, but we add two qmp interfaces for adding/releasing dynamic capacity exten=
ts.
Also, the support for multiple hosts sharing the same DCD case is missing.

Things we can try with the patch series together with kernel dcd code:
1. Create DC regions to cover the address range of the dynamic capacity
regions.
2. Add/release dynamic capacity extents to the device and notify the
kernel.
3. Test kernel side code to accept added dc extents and create dax devices,
and release dc extents and notify the device
4. Online the memory range backed with dc extents and let application use
them.

The patch series is based on Jonathan's local qemu branch:
https://gitlab.com/jic23/qemu/-/tree/cxl-2023-02-28

Simple tests peformed with the patch series:
1 Install cxl modules:

modprobe -a cxl_acpi cxl_core cxl_pci cxl_port cxl_mem

2 Create dc regions:

region=3D$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
echo 0x10000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
echo 0x10000000 > /sys/bus/cxl/devices/$region/size
echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
echo 1 > /sys/bus/cxl/devices/$region/commit
echo $region > /sys/bus/cxl/drivers/cxl_region/bind

/home/fan/cxl/tools-and-scripts# cxl list
[
  {
    "memdevs":[
      {
        "memdev":"mem0",
        "pmem_size":536870912,
        "ram_size":0,
        "serial":0,
        "host":"0000:0d:00.0"
      }
    ]
  },
  {
    "regions":[
      {
        "region":"region0",
        "resource":45365592064,
        "size":268435456,
        "interleave_ways":1,
        "interleave_granularity":256,
        "decode_state":"commit"
      }
    ]
  }
]

3 Add two dc extents (128MB each) through qmp interface

{ "execute": "qmp_capabilities" }

{ "execute": "cxl-add-dynamic-capacity-event",
	"arguments": {
		 "path": "/machine/peripheral/cxl-pmem0",
		"region-id" : 0,
		 "num-extent": 2,
		"dpa":0,
		"extent-len": 128
	}
}

/home/fan/cxl/tools-and-scripts# lsmem
RANGE                                  SIZE   STATE REMOVABLE   BLOCK
0x0000000000000000-0x000000007fffffff    2G  online       yes    0-15
0x0000000100000000-0x000000027fffffff    6G  online       yes   32-79
0x0000000a90000000-0x0000000a9fffffff  256M offline           338-339

Memory block size:       128M
Total online memory:       8G
Total offline memory:    256M


4.Online the momory with 'daxctl online-memory dax0.0' to online the memory

/home/fan/cxl/ndctl# ./build/daxctl/daxctl online-memory dax0.0
[  230.730553] Fallback order for Node 0: 0 1
[  230.730825] Fallback order for Node 1: 1 0
[  230.730953] Built 2 zonelists, mobility grouping on.  Total pages: 20425=
41
[  230.731110] Policy zone: Normal
onlined memory for 1 device

root@bgt-140510-bm03:/home/fan/cxl/ndctl# lsmem
RANGE                                  SIZE   STATE REMOVABLE BLOCK
0x0000000000000000-0x000000007fffffff    2G  online       yes  0-15
0x0000000100000000-0x000000027fffffff    6G  online       yes 32-79
0x0000000a90000000-0x0000000a97ffffff  128M  online       yes   338
0x0000000a98000000-0x0000000a9fffffff  128M offline             339

Memory block size:       128M
Total online memory:     8.1G
Total offline memory:    128M

5 using dc extents as regular memory

/home/fan/cxl/ndctl# numactl --membind=3D1 ls
CONTRIBUTING.md  README.md  clean_config.sh  cscope.out   git-version-gen
ndctl	       scripts	test.h      version.h.in COPYING		 acpi.h
config.h.meson   cxl	  make-git-snapshot.sh	ndctl.spec.in  sles	tools
Documentation	 build	    contrib	     daxctl	  meson.build		rhel
tags	topology.png LICENSES	 ccan	    cscope.files
git-version  meson_options.txt	rpmbuild.sh    test	util


QEMU command line cxl configuration:

RP1=3D"-object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=3D/tmp=
/cxltest.raw,size=3D512M \
-object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3D/tmp/cxltes=
t2.raw,size=3D512M \
-object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/lsa.ra=
w,size=3D512M \
-device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
-device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=3D2 \
-device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,dc-mem=
dev=3Dcxl-mem2,id=3Dcxl-pmem0,num-dc-regions=3D1\
-M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleave-gra=
nularity=3D8k"


Kernel DCD support used to test the changes

The code is tested with the posted kernel dcd support:
https://git.kernel.org/pub/scm/linux/kernel/git/cxl/cxl.git/log/?h=3Dfor-6.=
5/dcd-preview

commit: f425bc34c600e2a3721d6560202962ec41622815

To make the test work, we have made the following changes to the above kern=
el commit:

diff --git a/drivers/cxl/core/mbox.c b/drivers/cxl/core/mbox.c
index 5f04bbc18af5..5f421d3c5cef 100644
--- a/drivers/cxl/core/mbox.c
+++ b/drivers/cxl/core/mbox.c
@@ -68,6 +68,7 @@ static struct cxl_mem_command cxl_mem_commands[CXL_MEM_CO=
MMAND_ID_MAX] =3D {
 	CXL_CMD(SCAN_MEDIA, 0x11, 0, 0),
 	CXL_CMD(GET_SCAN_MEDIA, 0, CXL_VARIABLE_PAYLOAD, 0),
 	CXL_CMD(GET_DC_EXTENT_LIST, 0x8, CXL_VARIABLE_PAYLOAD, 0),
+	CXL_CMD(GET_DC_CONFIG, 0x2, CXL_VARIABLE_PAYLOAD, 0),
 };
=20
 /*
diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c
index 291c716abd49..ae10e3cf43a1 100644
--- a/drivers/cxl/core/region.c
+++ b/drivers/cxl/core/region.c
@@ -194,7 +194,7 @@ static int cxl_region_manage_dc(struct cxl_region *cxlr=
)
 		}
 		cxlds->dc_list_gen_num =3D extent_gen_num;
 		dev_dbg(cxlds->dev, "No of preallocated extents :%d\n", rc);
-		enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);
+		/*enable_irq(cxlds->cxl_irq[CXL_EVENT_TYPE_DCD]);*/
 	}
 	return 0;
 err:
@@ -2810,7 +2810,8 @@ int cxl_add_dc_extent(struct cxl_dev_state *cxlds, st=
ruct resource *alloc_dpa_re
 				dev_dax->align, memremap_compat_align()))) {
 		rc =3D alloc_dev_dax_range(dev_dax, hpa,
 					resource_size(alloc_dpa_res));
-		return rc;
+		if (rc)
+			return rc;
 	}
=20
 	rc =3D xa_insert(&cxlr_dc->dax_dev_list, hpa, dev_dax, GFP_KERNEL);
diff --git a/drivers/cxl/pci.c b/drivers/cxl/pci.c
index 9e45b1056022..653bec203838 100644
--- a/drivers/cxl/pci.c
+++ b/drivers/cxl/pci.c
@@ -659,7 +659,7 @@ static int cxl_event_irqsetup(struct cxl_dev_state *cxl=
ds)
=20
 	/* Driver enables DCD interrupt after creating the dc cxl_region */
 	rc =3D cxl_event_req_irq(cxlds, policy.dyncap_settings, CXL_EVENT_TYPE_DC=
D,
-					IRQF_SHARED | IRQF_ONESHOT | IRQF_NO_AUTOEN);
+					IRQF_SHARED | IRQF_ONESHOT);
 	if (rc) {
 		dev_err(cxlds->dev, "Failed to get interrupt for event dc log\n");
 		return rc;
diff --git a/include/uapi/linux/cxl_mem.h b/include/uapi/linux/cxl_mem.h
index 6ca85861750c..910a48259239 100644
--- a/include/uapi/linux/cxl_mem.h
+++ b/include/uapi/linux/cxl_mem.h
@@ -47,6 +47,7 @@
 	___C(SCAN_MEDIA, "Scan Media"),                                   \
 	___C(GET_SCAN_MEDIA, "Get Scan Media Results"),                   \
 	___C(GET_DC_EXTENT_LIST, "Get dynamic capacity extents"),         \
+	___C(GET_DC_CONFIG, "Get dynamic capacity configuration"),         \
 	___C(MAX, "invalid / last command")
=20
 #define ___C(a, b) CXL_MEM_COMMAND_ID_##a



Fan Ni (7):
  hw/cxl/cxl-mailbox-utils: Add dc_event_log_size field to output
    payload of identify memory device command
  hw/cxl/cxl-mailbox-utils: Add dynamic capacity region representative
    and mailbox command support
  hw/mem/cxl_type3: Add a parameter to pass number of DC regions the
    device supports in qemu command line
  hw/mem/cxl_type3: Add DC extent representative to cxl type3 device
  hw/cxl/cxl-mailbox-utils: Add mailbox commands to support add/release
    dynamic capacity response
  Add qmp interfaces to add/release dynamic capacity extents
  hw/mem/cxl_type3: add read/write support to dynamic capacity

 hw/cxl/cxl-mailbox-utils.c  | 389 +++++++++++++++++++++++++++-
 hw/mem/cxl_type3.c          | 492 +++++++++++++++++++++++++++++++-----
 include/hw/cxl/cxl_device.h |  50 +++-
 include/hw/cxl/cxl_events.h |  16 ++
 qapi/cxl.json               |  44 ++++
 5 files changed, 924 insertions(+), 67 deletions(-)

--=20
2.25.1

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2FCFEC7EE22
	for <linux-cxl@archiver.kernel.org>; Thu, 11 May 2023 21:53:35 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S238825AbjEKVxe (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 11 May 2023 17:53:34 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49322 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S238053AbjEKVxd (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 11 May 2023 17:53:33 -0400
Received: from NAM04-BN8-obe.outbound.protection.outlook.com (mail-bn8nam04on2083.outbound.protection.outlook.com [40.107.100.83])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id ED4C53A93
        for <linux-cxl@vger.kernel.org>; Thu, 11 May 2023 14:53:31 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=g+WVc4+5FJDtaM9AponYIflI/WwzP1LFlKJx7U9HKsDBS2VOblgQBl898rV2wDtPA7Q5OonTTzoImqamGm7vLvcE26ASDwzzAJF+EaAsvTzLiw9XESboWDlBB49dVDfWHHvCfP2dvA6oL0CTxx2HH4EzcICrjhF5adMPRQKFAhOD027KTVxnMLesDOquurz3wkmettbcGuUNmBkywFnYw2ShXY7/scQP49kbppoqkLrNkwbtaFaotdxoms0ts1ijNqO/wIMX0NPphiZHfLAT+okePMpWUPlSWc7D0Mb+lr9i/dd9CRjVXEYPf2UluUIII1JyIsr5QM5e4FEKemSO9g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=qwwKKgPzdVKNUgmcrXxZOvh1R3IP2B74sKEYqUnuFR4=;
 b=AvvS7jVGpMFqUcyqv+jjKfJ4JsfuBlNYfiwWAkTiBSWJlZB8+ukyOKdQ0jmaLSkrHeO0NrOcZM4/45Hd2Vo9a8FD8Lr3dTZ8Qv5a9iRqXZSAM4/0ECOWMz0Co7NRYjVJeYqCspEKh0mVGOmc2GLIANt/5H5FXSdqD9jXf/xWTG4Ff6IIpwBP3V88C7laog2CtBUgqkN6G2F05okqfDJMhGbVmEGlSQbGPqXj3cHbexHmdSYWA4ifO7Ts9gH8gNmUxxb0IAbnw/kTszXl+bo1Rfk8ajVnRAPf6RyPiX1YPEpAUDCDYbBUqF3p/spxk/V1bUYudwNm86HIndmGO/tIEg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=qwwKKgPzdVKNUgmcrXxZOvh1R3IP2B74sKEYqUnuFR4=;
 b=s4h4n3GiVAbqSL8aCcMVxsA/xZPaCpw1RYlIQLOysf+ojgyugryyKPXIzIDbwEpGdc1oTq6F15mlWB2gQZqmdvj1jfea9wvASZrZ9ItlyytHIQGeYX2JxI4Yq1XiL7ffQFuXg40l1xq3cjyy2+iMqCGVmhKe4rZI3D19D4sGIt0=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from MN0PR12MB6222.namprd12.prod.outlook.com (2603:10b6:208:3c2::19)
 by IA0PR12MB8301.namprd12.prod.outlook.com (2603:10b6:208:40b::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6387.20; Thu, 11 May
 2023 21:53:27 +0000
Received: from MN0PR12MB6222.namprd12.prod.outlook.com
 ([fe80::bd4d:3c36:29bb:87de]) by MN0PR12MB6222.namprd12.prod.outlook.com
 ([fe80::bd4d:3c36:29bb:87de%7]) with mapi id 15.20.6387.022; Thu, 11 May 2023
 21:53:27 +0000
Message-ID: <5cf2a93d-1a20-c87b-5276-69feb5056e72@amd.com>
Date: Thu, 11 May 2023 16:53:23 -0500
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Thunderbird/102.10.0
Subject: Re: [RFC 2/7] hw/cxl/cxl-mailbox-utils: Add dynamic capacity region
 representative and mailbox command support
Content-Language: en-US
To: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
Cc: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
 <CGME20230511175641uscas1p165a19a1416facf6603bf1a417121f0dc@uscas1p1.samsung.com>
 <20230511175609.2091136-3-fan.ni@samsung.com>
From: Nathan Fontenot <nafonten@amd.com>
In-Reply-To: <20230511175609.2091136-3-fan.ni@samsung.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: BN9PR03CA0098.namprd03.prod.outlook.com
 (2603:10b6:408:fd::13) To MN0PR12MB6222.namprd12.prod.outlook.com
 (2603:10b6:208:3c2::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: MN0PR12MB6222:EE_|IA0PR12MB8301:EE_
X-MS-Office365-Filtering-Correlation-Id: bf8f8b1e-3dd4-4732-2be1-08db526a2674
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: /KNVcUYWRMyRyRcqNzb2E2bAMuCsxSbZyWWbebBmTekC17srC9Y+gOXl/pbIJU6cZWpziWS48V8pLHhNVwKXwwCmfVSAz4M6GrVu2utAGw6RnYCn6x1bbb2khuEcCSpCHHfwPfSd08TyaQoazU9cJCzycPrc3g4lB4EvpAJrCpurqCdCOIBeYhpGMwZqTODbI3CxHzOWtZvd+Sd6leaGi7czojICfHwO6J09BpkfwqcVywwveNQZuT7KBU/oL+VASVRS8XtGtrEOohpgd0Hlaps7s4HS76yhiSs4f8zdTZQo9+LP4pM5CGlq+CPDAthcjv40YkHitvC/oMj9jhxRm5YjVYG2Ozu2HnBJOATozEoQmlmnewZaQWdQUZI0dCetSWTTwyOoJMOew9rSzlZ+EdVkRWtda8zpCq88rh/D9ou8q3KT+vXM4W9V/HZ0Nv+NwBre4nD7dCf8xHyU+cwGDBd5i33pY6uESn7I8P5xOMK7ELM8JIKK0Rot0nFuswzAN+Pl6ZF2qvd0Xfm/oERo67xpQIj0s3bFrxOjr1Z+/XZfTrL0GtZtg9OFdTrRXU/dF8tKKx/atsOiqyed39RbS3zXARy3jJIBepQYTLCs+a3RAKsyvBknnVWS8Fq7F3E9ezM5AUI9a/tlbbLJo12egw==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN0PR12MB6222.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(39860400002)(136003)(376002)(396003)(366004)(346002)(451199021)(54906003)(110136005)(31686004)(45080400002)(478600001)(4326008)(6666004)(6486002)(66556008)(66946007)(66476007)(316002)(83380400001)(36756003)(2616005)(8676002)(41300700001)(38100700002)(7416002)(8936002)(31696002)(6506007)(186003)(2906002)(26005)(6512007)(5660300002)(15650500001)(53546011)(45980500001)(43740500002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?SHREaTZaSWFnbHRIS0d6L1pGYTZzT2JNSTJQaFdzN0d0SHl3SC9EUVUwRWxN?=
 =?utf-8?B?ZCtHZGRKSTRNZ242YlVVek1TdWNRUytRYmtMaVVOaXVxS2IrWFRZNjBUclF6?=
 =?utf-8?B?aEtWUG1oOEdQVmpBL0VBZGVjdUNEUEMwUlAvMTZsZmFiOGxrSTd0ZkpqbzhQ?=
 =?utf-8?B?S3RuRW9La3AvdDhHM2crY2xkb2RZTUtKVHZ6QWUzQ011L0VhK0h2eVhiMUFF?=
 =?utf-8?B?WWkzczRGNUl0SXJzRjNUT3h6UU95akRjNDFBSEFLL2ZzejF3aE1tajhVTWI5?=
 =?utf-8?B?RjFuMkF6cXp5d3hMTTZmcytROUtRNEUyM1B6cWtSaHAwZ055amVwUGVOMUNi?=
 =?utf-8?B?WGloYWI3S05PbUhKUFdMY2pmQkhwVWg3d25JRzB0VnBMZzhGM2VzUU5oc2Ri?=
 =?utf-8?B?Y3o5QjUxME8wMEhJVVRtOUhvUTRJTEVnQk9pTEFvTHlYbDFVbWpLaUVqNER0?=
 =?utf-8?B?aHNTeWQrek9ibjVObHNKK2ZycER0MXIzQkpkQXUxT0pZTXZpYjJacllTQkNS?=
 =?utf-8?B?b09YT0ZrRldhdm1UekJPNDYvKzNMS3FNV1J4SEFJYnRpaFloUUplR0I0UTFu?=
 =?utf-8?B?SHVvVTUyUEMweWN4WTNMNkY0Y2NDOUNDdlRvV2pjMVkwblc3QUM3V1grR0pn?=
 =?utf-8?B?YlJRRTYwSUI2TzdKeS9BWm84cDRQTXRxcGFsc3ExVXpNM2J5RUhwaU43cHRD?=
 =?utf-8?B?NUVjaWtyZUY0VGZCS3lUOUx5eW4zZVZQZ3BiS0ZVdis3Vko1UzNYS0t2YWht?=
 =?utf-8?B?S0Y4bUJqVXJDTWIzSjFKY1czZGNIRDhLS2dmTjd3ajNSUThvTEFGdjdxcS9v?=
 =?utf-8?B?QmVBbnhhWjh4bnlzb1ZCR3IwemNCTEk2eWxRVUo3ekpaeUdyTjRDTWZyaUFr?=
 =?utf-8?B?V0syZGFRS0g4UHF3QUsyVWNzTmU1UFVqT0hvdDBmeTIxL3V2Q2N0Zi8wSEYy?=
 =?utf-8?B?eDU0OHlvOUpuVnZad2NaK2VEazczL0hYeG03MFhwM2pDK3JPeW9lSE0xNGd0?=
 =?utf-8?B?bDBaRmkyVjFnMFMrWUs3cEN6dEdXcDNyNmZEWExYZ2VEcjJpbkxIdG5mTFpH?=
 =?utf-8?B?RHk5RlNhOXhvZmJrWnRhM1JQWXk1UHg2OFl5V3FhYmJ2MndaRkl4NWdlWjZG?=
 =?utf-8?B?ODBtRFJDRWJGQmQxdmdEZnREMk93clF6N2ZEZ0RISld0cjNVNDUrMG4vUTVI?=
 =?utf-8?B?NGRqSC8vZDY3QnRsQ1ZpZUhxWUFKL05OS2tQaExpaWVkN29oa3U0YzRRUTBw?=
 =?utf-8?B?bUtGQ2ZiUWQ5STFickFMYjdEQ1lPZHFaQk9GWUF3SWdETnRRQzhPYzFVZkRj?=
 =?utf-8?B?OENLSlNRMlNVaStPT25yejQwekNwOGpDRjVnZkFFaFVKd2ZDemoydy9EcUZN?=
 =?utf-8?B?SUJWZXZLUGZVVmYvTHlacnovcVdodVErUXhzM2xFanl3YjMvWURhSUtha0sv?=
 =?utf-8?B?akZxbjVTVE5SK0lOL01IS08rcTRNNy8xZVRhMlE3OUlza3hhY2tCbmtWSnJh?=
 =?utf-8?B?RVgrWmZveWVYaVNXamlSN1hzM1psaFJQOU93UndJNWlVdklMKzlsWlg1WkI3?=
 =?utf-8?B?VUNqK0U1c2RNNURKSk1xc0tRNDJlNDE0aTlRc1Rjd2w3NGppeU5ORHlCKytG?=
 =?utf-8?B?R0pJbW1TVlNMSkhucVNjVjhxY1FqZ1REeWRMRkhWQVlvU1FTQTBMWmYycnpM?=
 =?utf-8?B?V3RwYUFMV1ZPWU5yOXRqVjY3QllMUDhicjA3ZGFIV2t6Nml6MEdCQlJDRkFI?=
 =?utf-8?B?bkpjSUc0VC9uMjJSeDVyV3lIeXR0ejlsTGV1SGsxQSs2clRleE9CWGtuQ0Zz?=
 =?utf-8?B?MVYxSDg5bU5EZk4wdk1VWHR4dmdNRW9uNXJwcllva2lGNnR6Ym5lQWkxSmo1?=
 =?utf-8?B?cG1TOHNMU1FNNXFZak1vT0N3RVY0V0FtVWdlWUdMdkErWWxnd01HYUpBOEhk?=
 =?utf-8?B?cWp4SStHaDVxYWY5bUZxVlQrQU1pRTlJQ3lrY2JqREtLSDVFVTUwZ1JFemNK?=
 =?utf-8?B?enpHNGVUTjdSMGpJbWY0KzhCbVRjZzF5VHoyajh5alB2dEVPbEJML3dEZjhZ?=
 =?utf-8?B?eEdTYTMxMG5XZFl6Y0ljTFhQVHdHNTFjTU0vU0hDaXRLTFNhVVBUWTU1U1ZD?=
 =?utf-8?Q?kalOOGh8corEyszO+SRRnxz3d?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: bf8f8b1e-3dd4-4732-2be1-08db526a2674
X-MS-Exchange-CrossTenant-AuthSource: MN0PR12MB6222.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 11 May 2023 21:53:26.9954
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 4CiEX8Ufnjbf5Rt/2xkNp3lS6EjVhUGSXn7JRr/1TdaYy3nqJIUzmSmbiz7uYzg9CsqlzmXddqQmn3FU4v8QMQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA0PR12MB8301
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 5192
Lines: 153

On 5/11/23 12:56, Fan Ni wrote:
> From: Fan Ni <nifan@outlook.com>
> 
> Per cxl spec 3.0, add dynamic capacity region representative based on
> Table 8-126 and extend the cxl type3 device definition to include dc region
> information. Also, based on info in 8.2.9.8.9.1, add 'Get Dynamic Capacity
> Configuration' mailbox support.
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/cxl/cxl-mailbox-utils.c  | 68 +++++++++++++++++++++++++++++++++++++
>  include/hw/cxl/cxl_device.h | 16 +++++++++
>  2 files changed, 84 insertions(+)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 7ff4fbdf22..61c77e52d8 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -81,6 +81,8 @@ enum {
>          #define GET_POISON_LIST        0x0
>          #define INJECT_POISON          0x1
>          #define CLEAR_POISON           0x2
> +	DCD_CONFIG = 0x48, /*8.2.9.8.9*/
> +		#define GET_DC_REGION_CONFIG   0x0
>      PHYSICAL_SWITCH = 0x51
>          #define IDENTIFY_SWITCH_DEVICE      0x0
>  };
> @@ -935,6 +937,70 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
>      return CXL_MBOX_SUCCESS;
>  }
>  
> +/*
> + * cxl spec 3.0: 8.2.9.8.9.2
> + * Get Dynamic Capacity Configuration
> + **/
> +static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len)
> +{
> +	struct get_dyn_cap_config_in_pl {
> +		uint8_t region_cnt;
> +		uint8_t start_region_id;
> +	} QEMU_PACKED;
> +
> +    struct get_dyn_cap_config_out_pl {
> +		uint8_t num_regions;
> +		uint8_t rsvd1[7];
> +		struct {
> +			uint64_t base;
> +			uint64_t decode_len;
> +			uint64_t region_len;
> +			uint64_t block_size;
> +			uint32_t dsmadhandle;
> +			uint8_t flags;
> +			uint8_t rsvd2[3];
> +		} QEMU_PACKED records[];

Could you declare CXLDCD_Region as QEMU_PACKED and use it here instead of
re-defining the region structure?

> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_config_in_pl *in = (void *)cmd->payload;
> +	struct get_dyn_cap_config_out_pl *out = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	uint16_t record_count = 0, i = 0;
> +	uint16_t out_pl_len;
> +
> +	if (in->start_region_id >= ct3d->dc.num_regions)
> +		record_count = 0;
> +	else if (ct3d->dc.num_regions - in->start_region_id < in->region_cnt)
> +		record_count = ct3d->dc.num_regions - in->start_region_id;
> +	else
> +		record_count = in->region_cnt;
> +
> +	out_pl_len = sizeof(*out) + record_count * sizeof(out->records[0]);
> +	assert(out_pl_len <= CXL_MAILBOX_MAX_PAYLOAD_SIZE);
> +
> +	memset(out, 0, out_pl_len);
> +	out->num_regions = record_count;
> +	for (; i < record_count; i++) {
> +		stq_le_p(&out->records[i].base,
> +			ct3d->dc.regions[in->start_region_id+i].base);
> +		stq_le_p(&out->records[i].decode_len,
> +			ct3d->dc.regions[in->start_region_id+i].decode_len);
> +		stq_le_p(&out->records[i].region_len,
> +			ct3d->dc.regions[in->start_region_id+i].len);
> +		stq_le_p(&out->records[i].block_size,
> +			ct3d->dc.regions[in->start_region_id+i].block_size);
> +		stl_le_p(&out->records[i].dsmadhandle,
> +			ct3d->dc.regions[in->start_region_id+i].dsmadhandle);
> +		out->records[i].flags
> +			= ct3d->dc.regions[in->start_region_id+i].flags;

In this loop your reading from 'in' and writing to 'out' where in and out both
point to the same payload buffer. It works because of the structure layouts but
feels like a bug waiting to happen. Perhaps saving start_region to a local variable
and using that for the loop?

-Nathan

> +	}
> +
> +	*len = out_pl_len;
> +	return CXL_MBOX_SUCCESS;
> +}
> +
>  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
>  #define IMMEDIATE_DATA_CHANGE (1 << 2)
>  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> @@ -973,6 +1039,8 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
>          cmd_media_inject_poison, 8, 0 },
>      [MEDIA_AND_POISON][CLEAR_POISON] = { "MEDIA_AND_POISON_CLEAR_POISON",
>          cmd_media_clear_poison, 72, 0 },
> +	[DCD_CONFIG][GET_DC_REGION_CONFIG] = { "DCD_GET_DC_REGION_CONFIG",
> +		cmd_dcd_get_dyn_cap_config, 2, 0 },
>  };
>  
>  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index e285369693..8a04e53e90 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -383,6 +383,17 @@ typedef struct CXLPoison {
>  typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
>  #define CXL_POISON_LIST_LIMIT 256
>  
> +#define DCD_MAX_REGION_NUM 8
> +
> +typedef struct CXLDCD_Region {
> +	uint64_t base;
> +	uint64_t decode_len; /* in multiples of 256MB */
> +	uint64_t len;
> +	uint64_t block_size;
> +	uint32_t dsmadhandle;
> +	uint8_t flags;
> +} CXLDCD_Region;
> +
>  struct CXLType3Dev {
>      /* Private */
>      PCIDevice parent_obj;
> @@ -414,6 +425,11 @@ struct CXLType3Dev {
>      unsigned int poison_list_cnt;
>      bool poison_list_overflowed;
>      uint64_t poison_list_overflow_ts;
> +
> +	struct dynamic_capacity {
> +		uint8_t num_regions; // 1-8
> +		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
> +	} dc;
>  };
>  
>  #define TYPE_CXL_TYPE3 "cxl-type3"

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DF068C77B7C
	for <linux-cxl@archiver.kernel.org>; Fri, 12 May 2023 18:09:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229544AbjELSJ5 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Fri, 12 May 2023 14:09:57 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:57630 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S237634AbjELSJp (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Fri, 12 May 2023 14:09:45 -0400
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2041.outbound.protection.outlook.com [40.107.236.41])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D78271702
        for <linux-cxl@vger.kernel.org>; Fri, 12 May 2023 11:09:43 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ccUCRr0xdRJxa1t6h4veRyjYgQ3OKsh7njng1fjJw7UofDOB0mVHbRbwYQUWA/nK7tSEAFeD6n3Zh5V6eYsNXEqCiq5U722TucH2Xjgvrq3IGUxVEfTB7TbWP7Lrr84cmx4tFTa+tR4Kjq4ZJEttJXx9/fPecXfSNqO7fTjYktf0tRmVQlaYW2GWHefHRbs6S8ldrfNzY5KNqskwKvnYvyfzVf80w+XQXKOseuFll8SDdnPQZVVOw82V4JyR2plBEiPAdLz7MzHOX1c7hEYh4NiyONQDUtktf2dl2R9aP8o7hn4xFvR5CKwulrHVocPtx4oMirfeLhxqhfxUVtiTNQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=OlH7/v0ZfPETm2uipHihWwD6BGXhKAzH/q2TnKMCVCs=;
 b=IDg6crBYPOxTcwdehzcpA8hkFtYChpTw/aHco4r44EZeW8aI/5IZjeLIqupRJ2VJxBN/MNsGkrMECPj79a54fBE9IVrUZFnnQI1L91AXWXscNtFhkNpURgiF6NGPaKwcc82AjFyny2ARc8LD5SdCYSzvLEkwYl0hhq+T4oDXEgoqjg8HX9y67wAXrsNiqIXgN2Yj0zW8R+bmFrvtECQVW8wEW+HWlgeaAJwO01dKfMmBqjJXAHC124Wbtty/6CbO/GnRs9QaAoUbIowrumDvM+/D3yCb+Ld5elXIya27PyHP/ngcdv+wPWjw9FsbEup56WY5/nigBkI2a+p/FHCwCw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=OlH7/v0ZfPETm2uipHihWwD6BGXhKAzH/q2TnKMCVCs=;
 b=OQoIhGGB+5y8DKN484q0M60icttj2mRgAO+vvYNl9bVIdzABwbuQu+PPF/PKmAS264V/yniZLbiBhe9bj2r5ps1lxbVUur1P3hlBB/jjaRPq+UqdwNj7unBJ30rx6tQVGkDd2rvX7vF1SJGHsS4ble+MHapYNffwswfuBi1FZSs=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=amd.com;
Received: from MN0PR12MB6222.namprd12.prod.outlook.com (2603:10b6:208:3c2::19)
 by MN2PR12MB4455.namprd12.prod.outlook.com (2603:10b6:208:265::23) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6363.33; Fri, 12 May
 2023 18:09:42 +0000
Received: from MN0PR12MB6222.namprd12.prod.outlook.com
 ([fe80::bd4d:3c36:29bb:87de]) by MN0PR12MB6222.namprd12.prod.outlook.com
 ([fe80::bd4d:3c36:29bb:87de%7]) with mapi id 15.20.6387.022; Fri, 12 May 2023
 18:09:41 +0000
Message-ID: <a3e1e3b4-a682-973a-9ab6-b35812717250@amd.com>
Date: Fri, 12 May 2023 13:09:39 -0500
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Thunderbird/102.10.0
Subject: Re: [RFC 4/7] hw/mem/cxl_type3: Add DC extent representative to cxl
 type3 device
Content-Language: en-US
To: Fan Ni <fan.ni@samsung.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>
Cc: "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>,
        "dan.j.williams@intel.com" <dan.j.williams@intel.com>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        "nmtadam.samsung@gmail.com" <nmtadam.samsung@gmail.com>,
        "nifan@outlook.com" <nifan@outlook.com>
References: <20230511175609.2091136-1-fan.ni@samsung.com>
 <CGME20230511175641uscas1p2b70d27b1f20dc2dd54a0530170117530@uscas1p2.samsung.com>
 <20230511175609.2091136-5-fan.ni@samsung.com>
From: Nathan Fontenot <nafonten@amd.com>
In-Reply-To: <20230511175609.2091136-5-fan.ni@samsung.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA1P222CA0043.NAMP222.PROD.OUTLOOK.COM
 (2603:10b6:806:2d0::17) To MN0PR12MB6222.namprd12.prod.outlook.com
 (2603:10b6:208:3c2::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: MN0PR12MB6222:EE_|MN2PR12MB4455:EE_
X-MS-Office365-Filtering-Correlation-Id: 200549e6-0fc1-47ef-73ab-08db53140eb7
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: gjW/ljgxxua6fU847GWJTPxkv77Hj88E+REeJUQbtEdcytUCfxQhk6rysXjnrEUU9JmAlqWG0WnfyUTD6wvuMW76ALZAD58GYA6UMY+9LDD7R0xMuoG62lekpp4mPx7B5DsvBLkUpX75UheuP1SGnJxq2haWYwS83msHtYJRoBAgj0phvWsn2g5vhFbhSl+z7i//37UlUlhmBBKY47pQTaI9zSTvxHzC8MRrFcTPNDKBKu6PCy9DFSv66CDhUQ0+AvWvtuWKfJVr+fEFipcfKwDBlx3r6niV8QjMVIaV8O4IH6ONELd/mxVitQw/SQUPYNdR7VR/z4u7kTzzpRSVL5BpBwRa26oUFWXsq7pq1GZAtxZLKBOH3Z3b4BakwS8AtykwUWYKtKMs///Q3vOlwIt3axdKkDf1aZFkBrmzs5YLXWZrEsu+Xj+dQpnt8LCKonjRnfjwTPXPQFsjQDu4/oBy41k1Cau8OV7WD8FNia560/axjohKhv6yZPc7gW6+jCS2OuoVgA/q33OiVyb/XUng41gnwibqEo1aMRrFB/89xb0HocYUIOhWZQJPHaegRFHWK66xSrbDVCNPJPCH0nPrJ4C02NYTnRnQYYcS+Bfe3iS0LBgzIrDm1OjxBithnutyHflYcNfSzPYcnAOj8A==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN0PR12MB6222.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230028)(4636009)(39860400002)(366004)(346002)(136003)(396003)(376002)(451199021)(38100700002)(53546011)(186003)(31686004)(110136005)(54906003)(316002)(6506007)(83380400001)(6512007)(26005)(41300700001)(8676002)(5660300002)(31696002)(8936002)(66556008)(66476007)(66946007)(4326008)(478600001)(45080400002)(7416002)(36756003)(2616005)(2906002)(6486002)(43740500002)(45980500001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?VmZvWkh2UTZzb29GYlVBanFvS1l3ZmdtUWRab2ZuUHIvaFVLbEtQbXR2N2M3?=
 =?utf-8?B?cXdYNXpzanEvYXdvQSswenZRaGxTUS8zaWp5eVBuUWxWOUdYdkR2bWVlY1NO?=
 =?utf-8?B?UWcxNWtveUhnTSt5NGpjNFpRRHh2a3VLR3VYZjVMdmduQURDNVFscXYrSGpu?=
 =?utf-8?B?eXZJZUhLUG9RVWlMRXpsSzQ0eXJ2QXkvcnNsdVNXNGZsSnVtMlY5aC9PZ2Zz?=
 =?utf-8?B?S3pJall0YStXR1ZIL1c0bWRXck95ckhGQkphOEVZejJ0Z2Z2V0dlNHFLOURY?=
 =?utf-8?B?QlBlOEJNaFIvMTN2Znp3dXVVTEh3dXZWcFlmdUZkVXVWbVZ4STkrNXAyVTBB?=
 =?utf-8?B?OTFiYll2T0tQUDJJb29KS04rOG1ucDhxUExlbkkyR3hoSlc0V1pLdkFmTWll?=
 =?utf-8?B?RVIwc1VzME1mMWdsR0FTYUtNdHE2N3hseHNzUGZMUkpCb05FZXIwOWVIam90?=
 =?utf-8?B?N2pMcloxMmF3VXFZelI2WnZ4QWdwUWRmOEpsZytQTGtxOE1KMUJHaHhXSkpm?=
 =?utf-8?B?MFVBN1VZUU9lTUNjY3VwYzZhVlM0SDNtOCtvaVhqcTZpOUszZkpqYzJMK25U?=
 =?utf-8?B?eE1oOEZ6K3YrZFRvMkxZODg3MlFqTjM3NjlQYlhQS0xtSVFxVjNLR1RZRjZx?=
 =?utf-8?B?dXZvVWVaYjVHMmxmQ0lpMjVkMkVWZlZSaVB1aGRwclJWQXArMGF5WDlmdERl?=
 =?utf-8?B?Z3BPU2FScm1HWWhqRXFiS25YU090U2YvSDdYRnJaVGhKZ1Jmc2FVOUNJZWdW?=
 =?utf-8?B?ODNINldMODBJYWoyY3FOc1R4em9CRGY0QzQ2NmRtMUF6YkFXVmtSbGk2bVVE?=
 =?utf-8?B?VnpxRWxhZ2NsNTRuaHNWb0d3OGdpeVRLM2MxQUt2YmRSaTJqYXhrbEZnYnFI?=
 =?utf-8?B?SDRicDAwM0ZySW1GaE0rd2N1OUI2Q0d2SWJhcWIzVzF2UVZVVmpnd0IwTURF?=
 =?utf-8?B?NENJRGkwREJpL2V6aGJsWTA1LytLcWV3em5BOXBXYkY0c0hPNzI1aWxSZ1J5?=
 =?utf-8?B?UHljNkd5QXNObFFJVDBDd1F1MCtCc0F3ZHBtQkxsWGlzR3BGdmZOODYvcGdU?=
 =?utf-8?B?aEJzRTc3NUZ3ZjN3MGR4RzZORUx5ZzA4a0RVcUdob0ZjSk1xZ2t1YWNsWGFk?=
 =?utf-8?B?djcxYzhVTlBjYmh1UUNveDQyZGpqSVF6WG9ZTWYyUGFSbGlLN3B5a3Fsa0NS?=
 =?utf-8?B?RS9KTkNKQlZvU1M4RWpuem04c0ZiV2cxTlJUZ1VLZEJtOGtTR2RjN2xIVkFp?=
 =?utf-8?B?VWNCWjlpY1VRY1RzeTEvTGgrc3ZSK3Vja3VLR2ZFUzYxNVljYWRReVBITUs3?=
 =?utf-8?B?QzgxQmM3NU5ISmoyUnZMdHNQNXpVdS85Q2VubnpOSGVmTXJLaUs0ekpHa1c5?=
 =?utf-8?B?bndab2VmNjFaU3luMERzTFZGbGcwbXVYaitZSE56NlRBVFQ5S0VoMi9sN1U4?=
 =?utf-8?B?RUlvUXNFUk1nQTQ5OGZQN1owQnBqOGxsWCt0RkVRRzdQNmppeGRlUS9SbURX?=
 =?utf-8?B?MkFNZUhjRWZ0RXFNQXQvcHIzS0x5N0tzTThqQUk4WGJNK3FCc1Z2RWtDdFdR?=
 =?utf-8?B?czdmSGxvbVg3a0xKZERBNFZ5cXRESzFQMGNvN2xIelpVMy93NmRBbDIycmda?=
 =?utf-8?B?VDVTcDVyeWo1QkpXV0VxSXBscXVYQjBoMGJBeDhIZm5YZWZVeXVVdUJkSXpO?=
 =?utf-8?B?T1l5QUJOVEtBc2VGM2U2aDcwbmpsd1k2RmJjYW0xRGJyQ1JDTjN3SFh2MStw?=
 =?utf-8?B?UGRxQzBHYkZ2MnBrdDgvckdRREtia1g4L1hDZEZzU2xySEtNSEIvU0VjejAw?=
 =?utf-8?B?VnpGcys4U1lIL1VHRE9mS21OSkpzMVg4RXNCT0hlTXJ2SEJxM01Xa2VmMnpi?=
 =?utf-8?B?M245T1A1eEdBMStnYXZZWHhIaEhZbERIUlBRandhdmcrenpselpuZE1iS095?=
 =?utf-8?B?UW41eE1oVkZuVkFaM1QraWpmR1cxaGhESWFuaWdDbG15WExnRUpWbFpJbC9P?=
 =?utf-8?B?WndCUTdwZUJsYUxJR3FqUUdPdk9GdEFxTFl3ZHdzZXl3VmQ0dUx6dHVoUWdh?=
 =?utf-8?B?NVoweW9iVFk4YnpOZU0xMkduTHJ4TUZhOFlLNWxCRUlYNk4xa3FPQnJtY3ps?=
 =?utf-8?Q?X+WprsOZ+fFzT2YHDMT5iTIha?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 200549e6-0fc1-47ef-73ab-08db53140eb7
X-MS-Exchange-CrossTenant-AuthSource: MN0PR12MB6222.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 12 May 2023 18:09:41.6673
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: A0vbQyI7pStnwCGiN5ZzZbLTmZQQsbf98BcKy09Ov72mYp4tDxuEAp1tV08kyuQhb6MnKKVMXYdqFFWZZBvPlQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MN2PR12MB4455
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org
Status: RO
Content-Length: 6356
Lines: 196

On 5/11/23 12:56, Fan Ni wrote:
> From: Fan Ni <nifan@outlook.com>
> 
> Add dynamic capacity extent information to the definition of
> CXLType3Dev and add get DC extent list mailbox command based on
> CXL.spec.3.0:.8.2.9.8.9.2.
> 
> With this command, we can create dc regions as below:
> 
> region=$(cat /sys/bus/cxl/devices/decoder0.0/create_dc_region)
> echo $region> /sys/bus/cxl/devices/decoder0.0/create_dc_region
> echo 256 > /sys/bus/cxl/devices/$region/interleave_granularity
> echo 1 > /sys/bus/cxl/devices/$region/interleave_ways
> 
> echo "dc" >/sys/bus/cxl/devices/decoder2.0/mode
> echo 0x30000000 >/sys/bus/cxl/devices/decoder2.0/dpa_size
> 
> echo 0x30000000 > /sys/bus/cxl/devices/$region/size
> echo  "decoder2.0" > /sys/bus/cxl/devices/$region/target0
> echo 1 > /sys/bus/cxl/devices/$region/commit
> echo $region > /sys/bus/cxl/drivers/cxl_region/bind
> 
> Signed-off-by: Fan Ni <fan.ni@samsung.com>
> ---
>  hw/cxl/cxl-mailbox-utils.c  | 73 ++++++++++++++++++++++++++++++++++++-
>  hw/mem/cxl_type3.c          |  1 +
>  include/hw/cxl/cxl_device.h | 23 ++++++++++++
>  3 files changed, 96 insertions(+), 1 deletion(-)
> 
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index 61c77e52d8..ed2ac154cb 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -83,6 +83,7 @@ enum {
>          #define CLEAR_POISON           0x2
>  	DCD_CONFIG = 0x48, /*8.2.9.8.9*/
>  		#define GET_DC_REGION_CONFIG   0x0
> +		#define GET_DYN_CAP_EXT_LIST   0x1
>      PHYSICAL_SWITCH = 0x51
>          #define IDENTIFY_SWITCH_DEVICE      0x0
>  };
> @@ -938,7 +939,7 @@ static CXLRetCode cmd_media_clear_poison(struct cxl_cmd *cmd,
>  }
>  
>  /*
> - * cxl spec 3.0: 8.2.9.8.9.2
> + * cxl spec 3.0: 8.2.9.8.9.1
>   * Get Dynamic Capacity Configuration
>   **/
>  static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
> @@ -1001,6 +1002,73 @@ static CXLRetCode cmd_dcd_get_dyn_cap_config(struct cxl_cmd *cmd,
>  	return CXL_MBOX_SUCCESS;
>  }
>  
> +/*
> + * cxl spec 3.0: 8.2.9.8.9.2
> + * Get Dynamic Capacity Extent List (Opcode 4810h)
> + **/
> +static CXLRetCode cmd_dcd_get_dyn_cap_ext_list(struct cxl_cmd *cmd,
> +		CXLDeviceState *cxl_dstate,
> +		uint16_t *len)
> +{
> +	struct get_dyn_cap_ext_list_in_pl {
> +		uint32_t extent_cnt;
> +		uint32_t start_extent_id;
> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_ext_list_out_pl {
> +		uint32_t count;
> +		uint32_t total_extents;
> +		uint32_t generation_num;
> +		uint8_t rsvd[4];
> +		struct {
> +			uint64_t start_dpa;
> +			uint64_t len;
> +			uint8_t tag[0x10];
> +			uint16_t shared_seq;
> +			uint8_t rsvd[6];
> +		} QEMU_PACKED records[];

Similar to a previous note, could this be CXLDCExtent_raw instead of re-defining
the structure?


> +	} QEMU_PACKED;
> +
> +	struct get_dyn_cap_ext_list_in_pl *in = (void *)cmd->payload;
> +	struct get_dyn_cap_ext_list_out_pl *out = (void *)cmd->payload;
> +	struct CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
> +	uint16_t record_count = 0, i = 0, record_done = 0;
> +	CXLDCDExtentList *extent_list = &ct3d->dc.extents;
> +	CXLDCD_Extent *ent;
> +	uint16_t out_pl_len;
> +
> +	if (in->start_extent_id > ct3d->dc.total_extent_count)
> +		return CXL_MBOX_INVALID_INPUT;
> +
> +	if (ct3d->dc.total_extent_count - in->start_extent_id < in->extent_cnt)
> +		record_count = ct3d->dc.total_extent_count - in->start_extent_id;
> +	else
> +		record_count = in->extent_cnt;
> +
> +	out_pl_len = sizeof(*out) + record_count * sizeof(out->records[0]);
> +	assert(out_pl_len <= CXL_MAILBOX_MAX_PAYLOAD_SIZE);

Perhaps it would be nicer to return a failure here instaead of assert().

-Nathan

> +
> +	memset(out, 0, out_pl_len);
> +	stl_le_p(&out->count, record_count);
> +	stl_le_p(&out->total_extents, ct3d->dc.total_extent_count);
> +	stl_le_p(&out->generation_num, ct3d->dc.ext_list_gen_seq);
> +
> +	QTAILQ_FOREACH(ent, extent_list, node) {
> +		if (i++ < in->start_extent_id)
> +			continue;
> +		stq_le_p(&out->records[i].start_dpa, ent->start_dpa);
> +		stq_le_p(&out->records[i].len, ent->len);
> +		memcpy(&out->records[i].tag, ent->tag, 0x10);
> +		stw_le_p(&out->records[i].shared_seq, ent->shared_seq);
> +		record_done++;
> +		if (record_done == record_count)
> +			break;
> +	}
> +
> +	*len = out_pl_len;
> +	return CXL_MBOX_SUCCESS;
> +}
> +
>  #define IMMEDIATE_CONFIG_CHANGE (1 << 1)
>  #define IMMEDIATE_DATA_CHANGE (1 << 2)
>  #define IMMEDIATE_POLICY_CHANGE (1 << 3)
> @@ -1041,6 +1109,9 @@ static struct cxl_cmd cxl_cmd_set[256][256] = {
>          cmd_media_clear_poison, 72, 0 },
>  	[DCD_CONFIG][GET_DC_REGION_CONFIG] = { "DCD_GET_DC_REGION_CONFIG",
>  		cmd_dcd_get_dyn_cap_config, 2, 0 },
> +	[DCD_CONFIG][GET_DYN_CAP_EXT_LIST] = {
> +		"DCD_GET_DYNAMIC_CAPACITY_EXTENT_LIST", cmd_dcd_get_dyn_cap_ext_list,
> +		8, 0 },
>  };
>  
>  static struct cxl_cmd cxl_cmd_set_sw[256][256] = {
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index b9c375d9b4..23954711b5 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -708,6 +708,7 @@ static int cxl_create_toy_regions(CXLType3Dev *ct3d)
>  
>  		region_base += region->len;
>  	}
> +	QTAILQ_INIT(&ct3d->dc.extents);
>  
>  	return 0;
>  }
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index 8a04e53e90..20ad5e7411 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -385,6 +385,25 @@ typedef QLIST_HEAD(, CXLPoison) CXLPoisonList;
>  
>  #define DCD_MAX_REGION_NUM 8
>  
> +typedef struct CXLDCD_Extent_raw {
> +	uint64_t start_dpa;
> +	uint64_t len;
> +	uint8_t tag[0x10];
> +	uint16_t shared_seq;
> +	uint8_t rsvd[0x6];
> +} QEMU_PACKED CXLDCExtent_raw;
> +
> +typedef struct CXLDCD_Extent {
> +	uint64_t start_dpa;
> +	uint64_t len;
> +	uint8_t tag[0x10];
> +	uint16_t shared_seq;
> +	uint8_t rsvd[0x6];
> +
> +	QTAILQ_ENTRY(CXLDCD_Extent) node;
> +} CXLDCD_Extent;> +typedef QTAILQ_HEAD(, CXLDCD_Extent) CXLDCDExtentList;
> +
>  typedef struct CXLDCD_Region {
>  	uint64_t base;
>  	uint64_t decode_len; /* in multiples of 256MB */
> @@ -429,6 +448,10 @@ struct CXLType3Dev {
>  	struct dynamic_capacity {
>  		uint8_t num_regions; // 1-8
>  		struct CXLDCD_Region regions[DCD_MAX_REGION_NUM];
> +		CXLDCDExtentList extents;
> +
> +		uint32_t total_extent_count;
> +		uint32_t ext_list_gen_seq;
>  	} dc;
>  };
>  

