From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id BDEF7E7D0AF
	for <linux-cxl@archiver.kernel.org>; Thu, 21 Sep 2023 22:24:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232356AbjIUWYt (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 21 Sep 2023 18:24:49 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47100 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229702AbjIUWYj (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 21 Sep 2023 18:24:39 -0400
Received: from mgamail.intel.com (mgamail.intel.com [134.134.136.65])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8570191
        for <linux-cxl@vger.kernel.org>; Thu, 21 Sep 2023 15:24:33 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1695335073; x=1726871073;
  h=date:from:to:cc:subject:message-id:mime-version;
  bh=1HB9V40QWXbtoQf5RoMgnBQIASU1OH67W3vRTuHVkRk=;
  b=B4GIvGr83z5aAgvLtGZu8nYHCSo26xgBaJ8kEK6/jHhQXLGFpu04lMGN
   E+HAEBOc0RnfLUroZJBP0SNPYpdCViEKMnpy71ZAVGe53kp5ySkBLHT61
   9+mdhxJLneyrrg+RoDS+4x9x5VQbXeQ/NN+rParL+N1QsIr5ZNuD1ex4h
   H/kXamLMGE4lpy9Ya1kgptCpjDAYX4aBg07Q4HxK99Aq0h8BLsYzjcdaq
   /V2azayVEXZh7lhTusWsF96TA8FUz2PLe+Llfn2HSooWZU87k1QUWzpMY
   fYda3pfeFeUDOzEGU27GXHhmQpBScBnW7Vm5VQbpKAs+VpsXrV6KThnN9
   Q==;
X-IronPort-AV: E=McAfee;i="6600,9927,10840"; a="384520429"
X-IronPort-AV: E=Sophos;i="6.03,166,1694761200"; 
   d="scan'208";a="384520429"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
  by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 21 Sep 2023 15:24:33 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6600,9927,10840"; a="871010382"
X-IronPort-AV: E=Sophos;i="6.03,166,1694761200"; 
   d="scan'208";a="871010382"
Received: from fmsmsx602.amr.corp.intel.com ([10.18.126.82])
  by orsmga004.jf.intel.com with ESMTP/TLS/AES256-GCM-SHA384; 21 Sep 2023 15:24:33 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx602.amr.corp.intel.com (10.18.126.82) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.32; Thu, 21 Sep 2023 15:24:32 -0700
Received: from fmsmsx611.amr.corp.intel.com (10.18.126.91) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.32; Thu, 21 Sep 2023 15:24:32 -0700
Received: from fmsedg601.ED.cps.intel.com (10.1.192.135) by
 fmsmsx611.amr.corp.intel.com (10.18.126.91) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.32 via Frontend Transport; Thu, 21 Sep 2023 15:24:32 -0700
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (104.47.58.101)
 by edgegateway.intel.com (192.55.55.70) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.32; Thu, 21 Sep 2023 15:24:32 -0700
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=HR+h/0e18Arc8YlMZ//ncmoGS8CVCEXUF9jz1kIeZ90T8jtZuIL/mKNc9j7LBQRD6OuQTWQLQd+2csaPBMLOdTyVBLRhUinM8Vl1joYFCNs45qFuhzQfIxBra9nt4NdBYZJvpPkC8Y8d3EfrY4y5tG3JZyrpxp7aFPvQh97aHDlT/ontWiG905OT/nhJ78OzUuZF1R/apo61CneypO7cq2WWixfFN3FkPPqDfXTXeohlCBH4hgXVc/GIfsxcvWSzo9cG1tFE+Ts+fAzIoNIToyFLfGUePfkPxVl2XW0cKa00o45nm8lpWPFNg31KapLOlh2QTjM/+P8WlNoNPy9rRg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=0wJj09bkWVH47d4PyBVCPsWxQRz0XPyNmgN9/9cSamw=;
 b=NZSq8zp+r17wS4w6tOuZBugv0RcA7DlYPqeq6c7KHMP9Il4b1+9kVmXyRKVkG1M92hsgibU5ttNXGbys0MjX/taBVb7dyswci+/a25Ak8LjyGLvHMUAqgLRt2vstJ2fEbXHqG4Bk5jm/2XWIPXQcu6o2tpyJN6XM+VhH/WbfFEVP8uY2IAbvNxh65KGTfXAiywvgUvb7aYZQkOgE9u9J/rW1u3tn20qQWQJw54b9eiiy2PDyRTXPQyJNxDODkTm+Qog5RMeg65Q3UHNENKqKKK3JM0f8/ZZ8bEaGl/uXbuG+NMkat/fJI0I+LpvRRQL5QBoiuiNatXid4vPZvqDBMA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from SA1PR11MB6733.namprd11.prod.outlook.com (2603:10b6:806:25c::17)
 by BL1PR11MB5479.namprd11.prod.outlook.com (2603:10b6:208:317::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6813.20; Thu, 21 Sep
 2023 22:24:30 +0000
Received: from SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6da5:f747:ba54:6938]) by SA1PR11MB6733.namprd11.prod.outlook.com
 ([fe80::6da5:f747:ba54:6938%6]) with mapi id 15.20.6792.026; Thu, 21 Sep 2023
 22:24:30 +0000
Date: Thu, 21 Sep 2023 15:24:26 -0700
From: Ira Weiny <ira.weiny@intel.com>
To: Fan Ni <fan.ni@samsung.com>
CC: Jonathan Cameron <jonathan.cameron@huawei.com>,
        "Singh, Naveen" <naveen.c.singh@intel.com>,
        <linux-cxl@vger.kernel.org>
Subject: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
X-ClientProxiedBy: SJ0PR05CA0027.namprd05.prod.outlook.com
 (2603:10b6:a03:33b::32) To SA1PR11MB6733.namprd11.prod.outlook.com
 (2603:10b6:806:25c::17)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: SA1PR11MB6733:EE_|BL1PR11MB5479:EE_
X-MS-Office365-Filtering-Correlation-Id: 3af20e05-3c43-47f9-8c16-08dbbaf18613
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 3Y7tHU8Eqf0MIBLslQd2M4YhnZww8Rqg8aiVAeNrSyhYJvK/Mbrnw+l1fh0N03RdkrZE0FrvPdGO7XuWVxEnY+IfDp11SWNWQSHQaUkhLhO70zQn5BH8zQWU2GkJENp12ayW7CiKGN60r9OcKoBe3RmxObwmxabVaUuctWalgrO5gHvcN3zyf/y42t9+3KpZ1J37YAEKaHa3ktoJtW3TFFbtXBMWXJTzxooCuaHBH/WSEHd8CV0t74tWxxT10zIirvRBcHN8IAjmv0CyMRJzlxmtQ7P6SdU5irHa1CqQ5XiwD2dmte1nBPN5eixhmknQXXFRK/65KkwBC+B5Sv/d7zEVIECTLeUFVMvPQUngNfE9lDBdgGZ8rTUY5Iv2WFmJFav2qzn9WaXPL1H49cwexGNr8Nt2OF0BwCO+uERhBy4EZO1B5LCN0dZob9fETAxzjYvyta14vodkt8ZZxciMZopKO5vMnukyf95kbZHzr+RqladiXvzJqPFOCybAPQRpF2ytWqlpFJQnDAgTLL2UHduEfsM3lDyeRrJ2DO+MpgE=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SA1PR11MB6733.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230031)(39860400002)(346002)(136003)(376002)(396003)(366004)(451199024)(1800799009)(186009)(6666004)(6486002)(6506007)(86362001)(9686003)(966005)(38100700002)(82960400001)(6916009)(4744005)(2906002)(5660300002)(478600001)(6512007)(26005)(83380400001)(41300700001)(8676002)(4326008)(66556008)(44832011)(8936002)(66476007)(316002)(66946007)(54906003);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?ERmdyvzRdQAAwa305vVNM2TVWipI9o4v9Eyh6zj8kG6OICeJpmaUQl3a+uS5?=
 =?us-ascii?Q?0KEXvO0t6tJB8B4BWbeTf/SgxDwiRiY7fOCDOuEX96Fh0bxO+ZTxabaj26hT?=
 =?us-ascii?Q?gTw0x+xoZ8mMbCw1CpqP4M4h2McUxdCbhz5s4Z1mlToAPnBcAVs9ulgqYtTc?=
 =?us-ascii?Q?BQSgJSazsNEcXHWcexYRqKDsrB8j8DvjYfYEQAazIJbqM1Bw9R3r3Ym/FjcW?=
 =?us-ascii?Q?kP3TG62/AeocHy7MreWeT8z3Yhp/EmmS1/pbGAtK1BbfrjWVQtw5mdUilPay?=
 =?us-ascii?Q?JfXdejUmxWRsri/+y4o3qRkdjp+7qjI9I3AbdWxcQohC4ZL7g0//7pMl4N8G?=
 =?us-ascii?Q?VYCuB6di2pTsSV0J+Iu8+7YHTC6q7Ao/XOcwXHMsjjcgfW1fA+ExkwDulR4L?=
 =?us-ascii?Q?5Gdo0DdOzcFMxEcSu0OI/iZEHsub3FE5MEnBSXr4MC9W8tCczy5kQcfPe+/j?=
 =?us-ascii?Q?UEqmLvECNWVfCSVFIjp6fMKNOT08e2WI3PGKJ6BqVt68uOGldfASqjkBFUD2?=
 =?us-ascii?Q?cw6DOR6qSu5DDUy64aHzZqdOVmR/hwnJOJdxe1ExZD39Mr4gytiGwD9S/AFl?=
 =?us-ascii?Q?1F2Lu2WE3Lxbb67LKsDRNnIrhrByrNwXpBWzuHscF8WMbIWaUI2tSeyFH1qG?=
 =?us-ascii?Q?9h4V9qFHweqf2ft48sCjFCLstDtQvN9W8c3t/UhBgF3zwPz5gb6QYnJEcd5y?=
 =?us-ascii?Q?LzkdOArqusKct2i0bjhWfXBjOYhbHMjD9884zqQF11eTnOrimFl179Hk3ALv?=
 =?us-ascii?Q?0kXwAP/1/Cyn+1FV/q2P/RCs0i9lVZB8dAN0qQN8ImDUxI7baplIGHf2JUar?=
 =?us-ascii?Q?P1/7QWkTvcMxF9EeYqAS8syejKljUWgIBd+D7U1JoRQaVYFiHluwxfBrd4AC?=
 =?us-ascii?Q?QNCtksUemBSvrDrbwWtMMAUymlpznFb72pLoA7uwDM79L+mS20JyCpJkC28P?=
 =?us-ascii?Q?JrCkqMJ/An9oezCQ2px07WbkFhnHrQCwhQUFjQn58P4eLsGrRgJzWB3Z7Jv+?=
 =?us-ascii?Q?+fbRvnWVEhrPukn7z+bI1/OW1uB9Doh6quKV8ox/YNpGHX3i+epqXZYK+O1P?=
 =?us-ascii?Q?pvQ2yl9/4wNvstmoKFEvWic7CokOuPNR/qIm7jtJOsge1zKBcYwod9se3n9q?=
 =?us-ascii?Q?fzq5TzFg7DlgUGApLIk3+lNyYk7EuvgU1KAhJ3MqVJ+VNFl83QOI+1f3kG0r?=
 =?us-ascii?Q?dGkeMSQsQTzj2MoJcXuBz1Lh7r2vfIgy80DGeSArW1+Fx6e5GO4wRErwWYM/?=
 =?us-ascii?Q?SWGAyMEn/jwQhynfja3Nx4fNZ3z9UMZtO8iNd9ZdEHeLWSisiuCPGQ0TYRZp?=
 =?us-ascii?Q?7vEM4+tfCj7TkjsQOExah54cy06wY4+sjELYs/vUSFArqjY0Vh9mco3WEqsp?=
 =?us-ascii?Q?q7zwtZRCOVDvArBPBTUuWoXC2Gcay62Sc7d+oq6Bxk8o/UuuNCCEEiciSypd?=
 =?us-ascii?Q?zftB8Tto4uht7SgGf7GaIvV+UZVdKMa0ybqP+3TbLkWuPjrINOJy/3uIZh3b?=
 =?us-ascii?Q?TJ/Y0KBwKeGt9PvNyRnav0TB52kfCEXIsE/8SYzy8Y9KzRZbnQEP2o3zTcFi?=
 =?us-ascii?Q?HunDvkSG9ER8ZIGGhhQjPdRKSXjfkVYZu3VFtFL/?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 3af20e05-3c43-47f9-8c16-08dbbaf18613
X-MS-Exchange-CrossTenant-AuthSource: SA1PR11MB6733.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 21 Sep 2023 22:24:30.4504
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: +jF6GU8GyGkPoVkTaAUKzp45Aa+VPXAx3ZkcKbwbE6rIgkj/0PlmAhVMBjzvLJ+eMndeETo0ydcFcZ93ljKasg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR11MB5479
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

Fan,

I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]

I've been testing various things and so far I have a couple of questions.

1) If the qmp command is used to add extents which overlap other extents
   shouldn't that throw an error?  I don't see any validation of this and
   I would think a real device would reject such a request from the FM.

2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
   extents prior to driver load does not seem to work.  And I think this
   is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().

Ira

[1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 21E93E7D0B4
	for <linux-cxl@archiver.kernel.org>; Thu, 21 Sep 2023 22:51:37 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229576AbjIUWvl (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 21 Sep 2023 18:51:41 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43442 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229449AbjIUWvj (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 21 Sep 2023 18:51:39 -0400
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3695CF7
        for <linux-cxl@vger.kernel.org>; Thu, 21 Sep 2023 15:51:32 -0700 (PDT)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20230921225130usoutp01c164b655d0bca7461a6d726b900f8721~HC7z4TkG23250232502usoutp01N;
        Thu, 21 Sep 2023 22:51:30 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20230921225130usoutp01c164b655d0bca7461a6d726b900f8721~HC7z4TkG23250232502usoutp01N
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1695336691;
        bh=MkEbi34F4tluczqqGV3/F3vVfH4sk6DrOrlcbZjWohk=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=diifxKEsdsSW1Wsyl9eKjFGYnuSTd2fnWNb+P+k9KIhFU+6LS+VBMzBMzhMuNE+tU
         F/ztvnxv+qnRDC215kJSDirDvW8O6d4AlJJx7cNkLnhoAYJUqYLIpPAiSGptvo0NSw
         rpnton1WCjNv2jxq2rah/aJY+63/M+QAc2DNJssY=
Received: from ussmges1new.samsung.com (u109.gpu85.samsung.co.kr
        [203.254.195.109]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230921225130uscas1p1d4eca551dc23e7c36234564b19aa074c~HC7zxgFUk1981419814uscas1p1J;
        Thu, 21 Sep 2023 22:51:30 +0000 (GMT)
Received: from uscas1p1.samsung.com ( [182.198.245.206]) by
        ussmges1new.samsung.com (USCPEMTA) with SMTP id B8.24.50148.2F8CC056; Thu,
        21 Sep 2023 18:51:30 -0400 (EDT)
Received: from ussmgxs1new.samsung.com (u89.gpu85.samsung.co.kr
        [203.254.195.89]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20230921225130uscas1p10cf7036ed3f8191d3dc19aeca9586c5b~HC7zaoD_11986419864uscas1p1J;
        Thu, 21 Sep 2023 22:51:30 +0000 (GMT)
X-AuditID: cbfec36d-559ff7000002c3e4-b0-650cc8f2dfe3
Received: from SSI-EX1.ssi.samsung.com ( [105.128.2.145]) by
        ussmgxs1new.samsung.com (USCPEXMTA) with SMTP id 73.6B.28590.2F8CC056; Thu,
        21 Sep 2023 18:51:30 -0400 (EDT)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX1.ssi.samsung.com (105.128.2.226) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 21 Sep 2023 15:51:29 -0700
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        21 Sep 2023 15:51:29 -0700
From: Fan Ni <fan.ni@samsung.com>
To: Ira Weiny <ira.weiny@intel.com>
CC: Jonathan Cameron <jonathan.cameron@huawei.com>,
        "Singh, Naveen" <naveen.c.singh@intel.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Thread-Topic: Questions about the qemu DCD support in cxl-2023-09-13
Thread-Index: AQHZ7NppV1BJ02wCEEmUKS7pYu48ybAmV/CA
Date: Thu, 21 Sep 2023 22:51:29 +0000
Message-ID: <20230921225123.GA3690460@sjcvldevvm72>
In-Reply-To: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="us-ascii"
Content-ID: <8855B4C4DDCE1F4EB8B96688BDD3EDF8@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFupnleLIzCtJLcpLzFFi42LZduzrOd1PJ3hSDT7M17PY//Q5i8WqhdfY
        LM7POsVicaljEaMDi0fLkbesHov3vGTy+LxJLoA5issmJTUnsyy1SN8ugStj97dv7AUbeCo+
        nJ/I2sD4kbOLkZNDQsBE4mz/RcYuRi4OIYGVjBKXlyxmgXBamSQWbl3KCFPV+m85VNVaRonH
        ux5CVX1ilOhq/wHlLGOUeDnzJjtIC5uAosS+ru1sILaIgLLE6X9X2UCKmAVmM0pcmn8MLCEs
        4CzRvHwmK0SRi0TH+XcsELaRxN/7K5i6GDk4WARUJa7czu1iZOfgFTCWWOYPUsApYC3xaP0U
        sOMYBcQkvp9awwRiMwuIS9x6Mp8J4mhBiUWz9zBD2GIS/3Y9ZIOwFSXuf3/JDlGvI7Fg9yc2
        kEXMAnYSu+96QIS1JZYtfA3Wygs05uTMJywQrZISB1fcAPtWQuAAh8TFw/PYIRIuEic3LYCa
        Ly1x9fpUZpCZEgLJEqs+ckGEcyTmL9kCNcdaYuGf9UwTGFVmIbl6FpKLZiFcNAvJRbOQXLSA
        kXUVo3hpcXFuemqxYV5quV5xYm5xaV66XnJ+7iZGYJo5/e9w7g7GHbc+6h1iZOJgPMQowcGs
        JMKb/IkrVYg3JbGyKrUoP76oNCe1+BCjNAeLkjivoe3JZCGB9MSS1OzU1ILUIpgsEwenVANT
        pduFJ+b8T2I3PuuZLr/mZjzjsVhX8X2vd77btmSRrjXLm/z9E78rqxyNeGO+pWP+2j/rfYVc
        Y9l4Ghyc5/1xyFPxuq77KO/axvcbz/+fyHUiLMufL39h87TvBhYXt/uUzQu15Gc9HCxtdfPy
        NZlL+5aeYQmUZrz+e3HXKtbfnCmiF0V/haw9bOb9Q9DP+/P2W09Vl2bOulm9ch3v5ryXtzX1
        q7+z7RBpc7uent44N3BrScWpANM/c7fJdVx5yFrGLrFAWerH35MvWc9VlJb1XllZL7fkXJPv
        Fjudf3dntIQcrGblX6a4+Wcof5fshR4nX8OrXD8j39jn1mrlLdUq+Wc4dUdg6P6VaxYL6+Us
        VWIpzkg01GIuKk4EABczLraiAwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrLIsWRmVeSWpSXmKPExsWS2cA0UffTCZ5Ug8v/xS32P33OYrFq4TU2
        i/OzTrFYXOpYxOjA4tFy5C2rx+I9L5k8Pm+SC2CO4rJJSc3JLEst0rdL4MrY/e0be8EGnooP
        5yeyNjB+5Oxi5OSQEDCRaP23nLGLkYtDSGA1o8SmhetZIZxPjBIvplxiAakSEljGKPFoBjOI
        zSagKLGvazsbiC0ioCxx+t9VNpAGZoHZjBKX5h8DSwgLOEs0L5/JClHkItFx/h0LhG0k8ff+
        CqYuRg4OFgFViSu3c7sY2Tl4BYwllvlDrO1jlLj6ZBbYFE4Ba4lH66cwgtiMAmIS30+tYQKx
        mQXEJW49mc8E8YCAxJI955khbFGJl4//sULYihL3v79kh6jXkViw+xMbyFZmATuJ3Xc9IMLa
        EssWvgZr5RUQlDg58wkLRKukxMEVN1gmMErMQrJtFpJJsxAmzUIyaRaSSQsYWVcxipcWF+em
        VxQb5qWW6xUn5haX5qXrJefnbmIExujpf4cjdzAevfVR7xAjEwfjIUYJDmYlEd7kT1ypQrwp
        iZVVqUX58UWlOanFhxilOViUxHl3TLmYIiSQnliSmp2aWpBaBJNl4uCUamAy69unzd242rXH
        KrdbTLXsZ9ePO3xPPdIf9svs873/xiR24tatPMY/k3/cc2XIiWRkScqzCbM4YRXodHjGv9f9
        6ZFHbvJz2B5dsXiq4cyZV7oPT+fndOrVq77Yxs230KQtcXcQ25muhmVrLrMzWlmnf35p76MS
        /WmpdTxnt8u8Y6/8TVYtl37UcoWlmtus/EC6hvasO2Ztl6wWHPjTcN22eMb10gMG6/Z+TclZ
        m2m/iut9+tP7slk+11MZ0/5NeXN309Zlc4Nf+fxQzb+7svF6wL+n708deBN8TnNV4BXOZ9t3
        SGXvsYtdoLho06HEfTPqTi0I/Xtjwea1tX8MHnG80F9yUCZhxla16Y52zMXuSizFGYmGWsxF
        xYkACI6OfUADAAA=
X-CMS-MailID: 20230921225130uscas1p10cf7036ed3f8191d3dc19aeca9586c5b
CMS-TYPE: 301P
X-CMS-RootMailID: 20230921222437uscas1p158e5ceecab50dcb39e33811f567152d8
References: <CGME20230921222437uscas1p158e5ceecab50dcb39e33811f567152d8@uscas1p1.samsung.com>
        <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:

Hi Ira,

Thanks for reaching out.
For DCD, I think Jonathan's branch does not change much compared to the pat=
ch
series sent out except some obvious issues that blocks the test.

My initial plan was to update the patches after I have tested the
current version with more stable kernel DCD driver.

See below.


> Fan,
>=20
> I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
>=20
> I've been testing various things and so far I have a couple of questions.
>=20
> 1) If the qmp command is used to add extents which overlap other extents
>    shouldn't that throw an error?  I don't see any validation of this and
>    I would think a real device would reject such a request from the FM.
>=20

Yes. We do not have any validation for the overlapped extents here
in current code.

> 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
>    extents prior to driver load does not seem to work.  And I think this
>    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().

I am aware of the issue, yet have not got a chance to fix it.=20

My understanding is whenever we complete adding/releasing
extents, we update it.

I will fix it and other issues mentioned in the comments in the next versio=
n.

Fan
>=20
> Ira
>=20
> [1] https://urldefense.com/v3/__https://gitlab.com/jic23/qemu/-/tree/cxl-=
2023-09-13__;!!EwVzqGoTKBqv-0DWAJBm!WrndoKsXHVaUoln-Jsq7MFRemLlcFYg788t_tDa=
Ft1lS7WFhE2s_5hsI4-WuNzlgLOc0e0DgdcepR368SHU$ =

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A545E14281
	for <linux-cxl@vger.kernel.org>; Mon, 23 Oct 2023 19:48:26 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="X/F2J1U2"
Received: from mail-pj1-x102e.google.com (mail-pj1-x102e.google.com [IPv6:2607:f8b0:4864:20::102e])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 331EC9B
	for <linux-cxl@vger.kernel.org>; Mon, 23 Oct 2023 12:48:25 -0700 (PDT)
Received: by mail-pj1-x102e.google.com with SMTP id 98e67ed59e1d1-27d17f5457fso3526880a91.0
        for <linux-cxl@vger.kernel.org>; Mon, 23 Oct 2023 12:48:25 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1698090504; x=1698695304; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=0+tiyOH1TnHMgGsQR+KPx44H5svtCnR0KCP+/jzjfzM=;
        b=X/F2J1U2fUbd5N8SSUwlj9dJBxVItjnVm2uLGXA5zLgnUnalaQFUMS/lOL8/nrxTrY
         gIzvS9qrASVeRC9qnJyEVFgCOX5uAXxiY6fvDu8BlIeHkLigBqybBXRUlAsJEuXvG7WB
         t0A51ceYQRBQcZnsSSsNABlBN35A5+6B1cNhIuDRZJwmt1oxuJqgj2+1B0GPxE2beep2
         OE3N8egVHHXsKa+szBlAyJdeDqx8GZ6dAb0qEeJXYc7L2mfk2B+huDbSH5ZENNO4YT6z
         5Op+OG+tNF01ntLPYshzA1enJAMf5cCOEOMDgzQyXnEtr7ouiUrFpvRr5m73nC2cl9PZ
         vKpw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1698090504; x=1698695304;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=0+tiyOH1TnHMgGsQR+KPx44H5svtCnR0KCP+/jzjfzM=;
        b=Kne8UwLM4fRffsLfRomhy6sOOtiip7HCtexLN6rfyYPcjgDBNGQDCHh9iQmshyyKze
         6gmimGMaStCdFFH1GMoqdwN4EVpA+QJshncge+dSs58RgGvPw2Ych6ZMvhvLY5MKWJzD
         ymN6e0GPEVx3EhrXDdwxYPtOvN8TnDn3oodrLtrUpXOJh7wnyPqyc9+jpSKtXqW4/NqR
         M/P+ltt6ErJYQBrm2OhonslWkY+f6WBDxzlSR3z+lnJ/3w+0AczicZGZ7yhhJfiBcb6W
         t0R8Pt4afgOt8jIXpo2+eXu4uaZ2XzZVbNC8CtMjvXf4p+pR39xPL3fbKvl8NoAwQtW/
         pdjg==
X-Gm-Message-State: AOJu0YxGhPiRqz1wOhN9JB/6MnSLLIIuy/agq8acUhJ1OC2VO4JWH+Mc
	ZZS5v6rZ2c4PH80lFURVw18=
X-Google-Smtp-Source: AGHT+IHQ8kOJLmtmJqFkcylDTeBUG1RczqsAHdHOKbKfFZtUR0eTo8xD0/oX63o4itJR+9vj+XUpTQ==
X-Received: by 2002:a17:90a:17ef:b0:277:3afc:f27 with SMTP id q102-20020a17090a17ef00b002773afc0f27mr18070556pja.1.1698090504400;
        Mon, 23 Oct 2023 12:48:24 -0700 (PDT)
Received: from debian ([2601:641:380:4e50:5e7c:68d3:5ea1:8eb2])
        by smtp.gmail.com with ESMTPSA id gd22-20020a17090b0fd600b002791d5a3e29sm6136627pjb.6.2023.10.23.12.48.22
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 23 Oct 2023 12:48:24 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Mon, 23 Oct 2023 12:48:02 -0700
To: Ira Weiny <ira.weiny@intel.com>
Cc: Fan Ni <fan.ni@samsung.com>,
	Jonathan Cameron <jonathan.cameron@huawei.com>,
	"Singh, Naveen" <naveen.c.singh@intel.com>,
	linux-cxl@vger.kernel.org, a.manzanares@samsung.com,
	dave@stgolabs.net, nmtadam.samsung@gmail.com
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <ZTbN8mAa256JWTFE@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>

On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:
> Fan,
> 
> I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
> 
> I've been testing various things and so far I have a couple of questions.
> 
> 1) If the qmp command is used to add extents which overlap other extents
>    shouldn't that throw an error?  I don't see any validation of this and
>    I would think a real device would reject such a request from the FM.
> 
> 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
>    extents prior to driver load does not seem to work.  And I think this
>    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().
> 
> Ira
> 
> [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13

Hi Ira,
FYI. I have updated the DCD emulation patch series based on feedbacks on
the previous version.

The new version is here:
https://github.com/moking/qemu-jic-clone/tree/dcd-dev

The code is based on Jonathan's branch cxl-2023-09-26.

The main changes include,

1. Update cxl_find_dc_region to detect the case the range of
the extent cross multiple DC regions.
2. Add comments to explain the checks performed in function
cxl_detect_malformed_extent_list. (Jonathan)
3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
4. Update total_extent_count in add/release dynamic capacity response function.
(Ira and Jorgen Hansen).
5. Fix the logic issue in test_bits and renamed it to
test_any_bits_set to clear its function.
6. Add pending extent list for add/release extent event.
7. When add/release extent response is received, use the pending list to
verify the extents are valid.
8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declaration to
cxl_device.h so it can be used in different files.
9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity event log type.
10. Extract the functionality to delete extent from extent list to a helper
function.
11. Move the update of the bitmap which reflects which blocks are backed with
dc extents from the moment when a dc extent is offered to the moment when it
is accepted from the host.

I was able to test the DCD code you sent previously, let me know if you
find any issues.

Fan

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A58F8219ED
	for <linux-cxl@vger.kernel.org>; Tue, 24 Oct 2023 18:56:26 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="iOOwAkxc"
Received: from mail-yw1-x1130.google.com (mail-yw1-x1130.google.com [IPv6:2607:f8b0:4864:20::1130])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 22CE3D7D
	for <linux-cxl@vger.kernel.org>; Tue, 24 Oct 2023 11:56:25 -0700 (PDT)
Received: by mail-yw1-x1130.google.com with SMTP id 00721157ae682-5a7d9d357faso48649387b3.0
        for <linux-cxl@vger.kernel.org>; Tue, 24 Oct 2023 11:56:25 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1698173784; x=1698778584; darn=vger.kernel.org;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:from:to:cc:subject:date:message-id:reply-to;
        bh=UBXl9Zj719hVGlSSrNcnrS3aFPeT4AGbDU2dqyIe3/w=;
        b=iOOwAkxckvKipk5vMokovs93JDfaMgaPTwz+1KhaujCdEneDObft2b4ONrooURnqBZ
         wxGPZxi9iUPJttVjtJE8vc5X1WSVZCSUW+sE2UX1U8KXzEhnhzZdmJrMg2vwJENCj4Hg
         Nkl7dloekEz1t92long2+JSHoyISaYE+RBP6GBdGC1q7WxW48BWITCknCvDBaDvB/0zU
         DzD7aHQarpimzArYqpRCCeDwP7sIKdMwtT2PvEeNddpbnTVIyK4OZFdDStPa7xd4zHWJ
         NxrMcS7R5+MQHdbSPbn0oZy9M8+Yqv8+MdEfdXxfbXGM3fPvIB4ro5iDy2bfihSxNyy4
         1Pbw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1698173784; x=1698778584;
        h=in-reply-to:content-disposition:mime-version:references:message-id
         :subject:cc:to:date:from:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=UBXl9Zj719hVGlSSrNcnrS3aFPeT4AGbDU2dqyIe3/w=;
        b=NtHoZigduMy6DwMsv4h9bh9YQ0/8WaP0cSKWuYSS69Jh9udhX7SMZEsdcSKaFkLIj5
         LOtOmbSQXwkvZ580Kjsbl65MimETYGzavORr+5NSDl7Fscw4uS4QmAC1uwQN20AZjNec
         Rdyxw8zhQK246ZyxhrRl5V/47+zJvmMc4dJEunt45PEDU46wKxMx/IjlkH91pu4ouVWh
         s3Yp38pYLQ+qZTqyP06XuZK2t9r9XHykT4ZexrIOgFC91syCVYB9Ys31ak+mgrw8zVMA
         apoiOXI3S9M/YRdb2Z+zr8Cykk2sY3gf0cyIZE1ApU7mbenpiftT+FNIREW27jvniunV
         UxNQ==
X-Gm-Message-State: AOJu0YwNEVZy/5T8q9XW1VQbX6+oRmGBvAF0BEhh4z+wETLT2SMR2xie
	xrPoK1hmUc+DffvWz+z+wjg=
X-Google-Smtp-Source: AGHT+IGR5pgBZC173P/hQrkxSG1QL0wlCxKdFBiByrK+4AaluigkyyWuLfDIye12ZOXpjnBgnL5SMA==
X-Received: by 2002:a0d:ea8d:0:b0:5a7:a989:b85c with SMTP id t135-20020a0dea8d000000b005a7a989b85cmr13696578ywe.16.1698173784303;
        Tue, 24 Oct 2023 11:56:24 -0700 (PDT)
Received: from debian ([50.205.20.42])
        by smtp.gmail.com with ESMTPSA id t22-20020a0dea16000000b0059b1f6d1959sm4266801ywe.101.2023.10.24.11.56.23
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 24 Oct 2023 11:56:24 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Tue, 24 Oct 2023 11:56:02 -0700
To: fan <nifan.cxl@gmail.com>
Cc: Ira Weiny <ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>,
	Jonathan Cameron <jonathan.cameron@huawei.com>,
	"Singh, Naveen" <naveen.c.singh@intel.com>,
	linux-cxl@vger.kernel.org, a.manzanares@samsung.com,
	dave@stgolabs.net, nmtadam.samsung@gmail.com
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <ZTgTQs_HJ9Xlb0Ov@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
 <ZTbN8mAa256JWTFE@debian>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <ZTbN8mAa256JWTFE@debian>

On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:
> On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:
> > Fan,
> > 
> > I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
> > 
> > I've been testing various things and so far I have a couple of questions.
> > 
> > 1) If the qmp command is used to add extents which overlap other extents
> >    shouldn't that throw an error?  I don't see any validation of this and
> >    I would think a real device would reject such a request from the FM.
> > 
> > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
> >    extents prior to driver load does not seem to work.  And I think this
> >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().
> > 
> > Ira
> > 
> > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13
> 
> Hi Ira,
> FYI. I have updated the DCD emulation patch series based on feedbacks on
> the previous version.
> 
> The new version is here:
> https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> 
> The code is based on Jonathan's branch cxl-2023-09-26.
> 
> The main changes include,
> 
> 1. Update cxl_find_dc_region to detect the case the range of
> the extent cross multiple DC regions.
> 2. Add comments to explain the checks performed in function
> cxl_detect_malformed_extent_list. (Jonathan)
> 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> 4. Update total_extent_count in add/release dynamic capacity response function.
> (Ira and Jorgen Hansen).
> 5. Fix the logic issue in test_bits and renamed it to
> test_any_bits_set to clear its function.
> 6. Add pending extent list for add/release extent event.
> 7. When add/release extent response is received, use the pending list to
> verify the extents are valid.
> 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declaration to
> cxl_device.h so it can be used in different files.
> 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity event log type.
> 10. Extract the functionality to delete extent from extent list to a helper
> function.
> 11. Move the update of the bitmap which reflects which blocks are backed with
> dc extents from the moment when a dc extent is offered to the moment when it
> is accepted from the host.
> 
> I was able to test the DCD code you sent previously, let me know if you
> find any issues.
> 
> Fan

FYI. 

Updated the last two commits to drop the extents for pending to
release as the host can proactively release dc extents so there can be
no pending-to-release extent list on the device side.

Fan

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C2F3F2D636
	for <linux-cxl@vger.kernel.org>; Wed, 25 Oct 2023 05:26:19 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="MAgo2ZXN"
Received: from mail-pg1-x52b.google.com (mail-pg1-x52b.google.com [IPv6:2607:f8b0:4864:20::52b])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CCFE6128
	for <linux-cxl@vger.kernel.org>; Tue, 24 Oct 2023 22:26:17 -0700 (PDT)
Received: by mail-pg1-x52b.google.com with SMTP id 41be03b00d2f7-5b856d73a12so3973646a12.1
        for <linux-cxl@vger.kernel.org>; Tue, 24 Oct 2023 22:26:17 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1698211577; x=1698816377; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=TYsvkenkOOHMQG0IFPn1E4GNIOMkOOL4/OODSWrd9Q8=;
        b=MAgo2ZXNNdImm22oh4okJFGx5d7TA1M9aJHQzip1dGmWlxJd4qf04RMNCJd8gqo9+t
         UXuKZwMZa59njxcl73I9UXP6c5iZY7zuPNbRCkWHzV9rdta+dkxvo5QzI2MFwWN/LngZ
         oB7ebEFsqeRIaJQjHHoXbvNsdg84Ls6Yb8sPvArmvQJSrWu7HRwGy0Hb/vUGn70H2Wwn
         c7Xof3qfind8/fWuLipvk9buxV41fC8yfcoADnBqbXiwWXSWJfz/ErKIXmCPv8UZyuWJ
         gRbW+A/M7gR/9kXl0faLUsc5gSOnSHMxGUOUbTw3q19NT9Z6HY+BxMKD/uvWFd4v+tah
         vwWg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1698211577; x=1698816377;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=TYsvkenkOOHMQG0IFPn1E4GNIOMkOOL4/OODSWrd9Q8=;
        b=epWuVtHjMTZevW6aHskmAIYHTDllGpM9jUiWz9Shd4R3c2GdgcXHL4bn6zObWgbfgw
         DYBJZX1DEhvDOY8ie/kKlCBSdCRS6YcV3BqfNRpIqeZTdJrgX7IJwl9AcROGxIrC6iSB
         OOqvwcApWWZgc03ZvobqbTV1bOuLO1UmXLOyQcuglBGFiJL7QkKJQLSRGzJu7E0moVVj
         2vxyove2Hyct1M9jFeHjKUe5sc8rXacfACcGpeebdi0CzlTcXPxBpSXgsr3ZdgMAcBaw
         kbwWzMfZViHdQwkyXNWhDb3GBsArgwtd76hz95EhuU5AUmsUSV4Z6B/vfneE1YiX8RjF
         gLYQ==
X-Gm-Message-State: AOJu0YyXnyuRps7dSYgXHKqBl3B4xWjnT2XFK2EqeYeO44Jp7gGcdOEJ
	SV+6tVo+ceNnvFyaYct77SQ=
X-Google-Smtp-Source: AGHT+IFoIV4ClLalYdrVGaeDQ1UOYErb2cqcQaFFYaUBEIi21wc7LPQtu+FfnQLKlirseXsQjNixPg==
X-Received: by 2002:a17:90b:3c4e:b0:27d:2a92:89b2 with SMTP id pm14-20020a17090b3c4e00b0027d2a9289b2mr12830119pjb.33.1698211577146;
        Tue, 24 Oct 2023 22:26:17 -0700 (PDT)
Received: from debian ([2601:641:380:4e50:5e7c:68d3:5ea1:8eb2])
        by smtp.gmail.com with ESMTPSA id bb21-20020a17090b009500b0027d0a60b9c9sm9558236pjb.28.2023.10.24.22.26.16
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 24 Oct 2023 22:26:16 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Tue, 24 Oct 2023 22:25:53 -0700
To: fan <nifan.cxl@gmail.com>
Cc: Ira Weiny <ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>,
	Jonathan Cameron <jonathan.cameron@huawei.com>,
	"Singh, Naveen" <naveen.c.singh@intel.com>,
	linux-cxl@vger.kernel.org, a.manzanares@samsung.com,
	dave@stgolabs.net, nmtadam.samsung@gmail.com
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <ZTim4UPbe2C-tC_w@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
 <ZTbN8mAa256JWTFE@debian>
 <ZTgTQs_HJ9Xlb0Ov@debian>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <ZTgTQs_HJ9Xlb0Ov@debian>

On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote:
> On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:
> > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:
> > > Fan,
> > > 
> > > I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
> > > 
> > > I've been testing various things and so far I have a couple of questions.
> > > 
> > > 1) If the qmp command is used to add extents which overlap other extents
> > >    shouldn't that throw an error?  I don't see any validation of this and
> > >    I would think a real device would reject such a request from the FM.
> > > 
> > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
> > >    extents prior to driver load does not seem to work.  And I think this
> > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().
> > > 
> > > Ira
> > > 
> > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13
> > 
> > Hi Ira,
> > FYI. I have updated the DCD emulation patch series based on feedbacks on
> > the previous version.
> > 
> > The new version is here:
> > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > 
> > The code is based on Jonathan's branch cxl-2023-09-26.
> > 
> > The main changes include,
> > 
> > 1. Update cxl_find_dc_region to detect the case the range of
> > the extent cross multiple DC regions.
> > 2. Add comments to explain the checks performed in function
> > cxl_detect_malformed_extent_list. (Jonathan)
> > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > 4. Update total_extent_count in add/release dynamic capacity response function.
> > (Ira and Jorgen Hansen).
> > 5. Fix the logic issue in test_bits and renamed it to
> > test_any_bits_set to clear its function.
> > 6. Add pending extent list for add/release extent event.
> > 7. When add/release extent response is received, use the pending list to
> > verify the extents are valid.
> > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declaration to
> > cxl_device.h so it can be used in different files.
> > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity event log type.
> > 10. Extract the functionality to delete extent from extent list to a helper
> > function.
> > 11. Move the update of the bitmap which reflects which blocks are backed with
> > dc extents from the moment when a dc extent is offered to the moment when it
> > is accepted from the host.
> > 
> > I was able to test the DCD code you sent previously, let me know if you
> > find any issues.
> > 
> > Fan
> 
> FYI. 
> 
> Updated the last two commits to drop the extents for pending to
> release as the host can proactively release dc extents so there can be
> no pending-to-release extent list on the device side.
> 
> Fan

Ira located a bug when testing dc extent adding with his latest DCD kernel
code.
The dpa passed in the qmp command is offset relative to the base of the
region where the extent is offered, we need to convert it to address relative
to the base address of the base of the region0 so the bit in the bitmap can
be correctly mapped.

Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interfaces to
add/release dynamic capacity extâ€¦) with the following changes to fix the issue.


diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index ea88b53f41..d51f2ef9f5 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(const char *path, CxlEventLog log,
		 extents[i].shared_seq = 0;

		 /* No duplicate or overlapped extents are allowed */
-        dpa -= dcd->dc.regions[0].base;
+        dpa = dpa + dcd->dc.regions[rid].base - dcd->dc.regions[0].base;
		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
			 len / min_block_size)) {
			 error_setg(errp, "duplicate or overlapped extents are detected");


Fan

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 0699BF9C7
	for <linux-cxl@vger.kernel.org>; Thu, 26 Oct 2023 09:01:25 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; dkim=none
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 623A2128
	for <linux-cxl@vger.kernel.org>; Thu, 26 Oct 2023 02:01:24 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4SGKTR08qLz6K6Kc;
	Thu, 26 Oct 2023 16:58:34 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.31; Thu, 26 Oct
 2023 10:01:22 +0100
Date: Thu, 26 Oct 2023 10:01:21 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: fan <nifan.cxl@gmail.com>, <linux-cxl@vger.kernel.org>,
	<a.manzanares@samsung.com>
CC: Ira Weiny <ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>, "Singh,
 Naveen" <naveen.c.singh@intel.com>, <dave@stgolabs.net>,
	<nmtadam.samsung@gmail.com>
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <20231026100121.00007100@Huawei.com>
In-Reply-To: <ZTim4UPbe2C-tC_w@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
	<ZTbN8mAa256JWTFE@debian>
	<ZTgTQs_HJ9Xlb0Ov@debian>
	<ZTim4UPbe2C-tC_w@debian>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: quoted-printable
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100002.china.huawei.com (7.191.160.241) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected

On Tue, 24 Oct 2023 22:25:53 -0700
fan <nifan.cxl@gmail.com> wrote:

> On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote:
> > On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote: =20
> > > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote: =20
> > > > Fan,
> > > >=20
> > > > I'm working off of Jonathan's latest CXL branch with the DCD patche=
s.[1]
> > > >=20
> > > > I've been testing various things and so far I have a couple of ques=
tions.
> > > >=20
> > > > 1) If the qmp command is used to add extents which overlap other ex=
tents
> > > >    shouldn't that throw an error?  I don't see any validation of th=
is and
> > > >    I would think a real device would reject such a request from the=
 FM.
> > > >=20
> > > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to =
add
> > > >    extents prior to driver load does not seem to work.  And I think=
 this
> > > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_li=
st().
> > > >=20
> > > > Ira
> > > >=20
> > > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13 =20
> > >=20
> > > Hi Ira,
> > > FYI. I have updated the DCD emulation patch series based on feedbacks=
 on
> > > the previous version.
> > >=20
> > > The new version is here:
> > > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > >=20
> > > The code is based on Jonathan's branch cxl-2023-09-26.
> > >=20
> > > The main changes include,
> > >=20
> > > 1. Update cxl_find_dc_region to detect the case the range of
> > > the extent cross multiple DC regions.
> > > 2. Add comments to explain the checks performed in function
> > > cxl_detect_malformed_extent_list. (Jonathan)
> > > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > > 4. Update total_extent_count in add/release dynamic capacity response=
 function.
> > > (Ira and Jorgen Hansen).
> > > 5. Fix the logic issue in test_bits and renamed it to
> > > test_any_bits_set to clear its function.
> > > 6. Add pending extent list for add/release extent event.
> > > 7. When add/release extent response is received, use the pending list=
 to
> > > verify the extents are valid.
> > > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declara=
tion to
> > > cxl_device.h so it can be used in different files.
> > > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity eve=
nt log type.
> > > 10. Extract the functionality to delete extent from extent list to a =
helper
> > > function.
> > > 11. Move the update of the bitmap which reflects which blocks are bac=
ked with
> > > dc extents from the moment when a dc extent is offered to the moment =
when it
> > > is accepted from the host.
> > >=20
> > > I was able to test the DCD code you sent previously, let me know if y=
ou
> > > find any issues.
> > >=20
> > > Fan =20
> >=20
> > FYI.=20
> >=20
> > Updated the last two commits to drop the extents for pending to
> > release as the host can proactively release dc extents so there can be
> > no pending-to-release extent list on the device side.
> >=20
> > Fan =20
>=20
> Ira located a bug when testing dc extent adding with his latest DCD kernel
> code.
> The dpa passed in the qmp command is offset relative to the base of the
> region where the extent is offered, we need to convert it to address rela=
tive
> to the base address of the base of the region0 so the bit in the bitmap c=
an
> be correctly mapped.
>=20
> Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interfaces to
> add/release dynamic capacity ext=E2=80=A6) with the following changes to =
fix the issue.

Hi Fan,

I hit this whilst reusing some of your code for the fmapi initiate add DC
command.   Try adding an empty extent list..

"extents": []

boom.

Definitely need to reject that input :)

Jonathan


>=20
>=20
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index ea88b53f41..d51f2ef9f5 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(const =
char *path, CxlEventLog log,
> 		 extents[i].shared_seq =3D 0;
>=20
> 		 /* No duplicate or overlapped extents are allowed */
> -        dpa -=3D dcd->dc.regions[0].base;
> +        dpa =3D dpa + dcd->dc.regions[rid].base - dcd->dc.regions[0].bas=
e;
> 		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
> 			 len / min_block_size)) {
> 			 error_setg(errp, "duplicate or overlapped extents are detected");
>=20
>=20
> Fan
>=20


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 010C4381AE
	for <linux-cxl@vger.kernel.org>; Thu, 26 Oct 2023 16:58:08 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; dkim=none
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AD18C194
	for <linux-cxl@vger.kernel.org>; Thu, 26 Oct 2023 09:58:06 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.226])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4SGX5s0tQyz6K733;
	Fri, 27 Oct 2023 00:57:21 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.31; Thu, 26 Oct
 2023 17:58:04 +0100
Date: Thu, 26 Oct 2023 17:58:03 +0100
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: fan <nifan.cxl@gmail.com>, <linux-cxl@vger.kernel.org>,
	<a.manzanares@samsung.com>
CC: Ira Weiny <ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>, "Singh,
 Naveen" <naveen.c.singh@intel.com>, <dave@stgolabs.net>,
	<nmtadam.samsung@gmail.com>
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <20231026175802.00001cfc@Huawei.com>
In-Reply-To: <20231026100121.00007100@Huawei.com>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
	<ZTbN8mAa256JWTFE@debian>
	<ZTgTQs_HJ9Xlb0Ov@debian>
	<ZTim4UPbe2C-tC_w@debian>
	<20231026100121.00007100@Huawei.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: quoted-printable
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500006.china.huawei.com (7.191.161.198) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected

On Thu, 26 Oct 2023 10:01:21 +0100
Jonathan Cameron <Jonathan.Cameron@Huawei.com> wrote:

> On Tue, 24 Oct 2023 22:25:53 -0700
> fan <nifan.cxl@gmail.com> wrote:
>=20
> > On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote: =20
> > > On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:   =20
> > > > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:   =20
> > > > > Fan,
> > > > >=20
> > > > > I'm working off of Jonathan's latest CXL branch with the DCD patc=
hes.[1]
> > > > >=20
> > > > > I've been testing various things and so far I have a couple of qu=
estions.
> > > > >=20
> > > > > 1) If the qmp command is used to add extents which overlap other =
extents
> > > > >    shouldn't that throw an error?  I don't see any validation of =
this and
> > > > >    I would think a real device would reject such a request from t=
he FM.
> > > > >=20
> > > > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting t=
o add
> > > > >    extents prior to driver load does not seem to work.  And I thi=
nk this
> > > > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_=
list().
> > > > >=20
> > > > > Ira
> > > > >=20
> > > > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13   =20
> > > >=20
> > > > Hi Ira,
> > > > FYI. I have updated the DCD emulation patch series based on feedbac=
ks on
> > > > the previous version.
> > > >=20
> > > > The new version is here:
> > > > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > > >=20
> > > > The code is based on Jonathan's branch cxl-2023-09-26.
> > > >=20
> > > > The main changes include,
> > > >=20
> > > > 1. Update cxl_find_dc_region to detect the case the range of
> > > > the extent cross multiple DC regions.
> > > > 2. Add comments to explain the checks performed in function
> > > > cxl_detect_malformed_extent_list. (Jonathan)
> > > > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > > > 4. Update total_extent_count in add/release dynamic capacity respon=
se function.
> > > > (Ira and Jorgen Hansen).
> > > > 5. Fix the logic issue in test_bits and renamed it to
> > > > test_any_bits_set to clear its function.
> > > > 6. Add pending extent list for add/release extent event.
> > > > 7. When add/release extent response is received, use the pending li=
st to
> > > > verify the extents are valid.
> > > > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list decla=
ration to
> > > > cxl_device.h so it can be used in different files.
> > > > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity e=
vent log type.
> > > > 10. Extract the functionality to delete extent from extent list to =
a helper
> > > > function.
> > > > 11. Move the update of the bitmap which reflects which blocks are b=
acked with
> > > > dc extents from the moment when a dc extent is offered to the momen=
t when it
> > > > is accepted from the host.
> > > >=20
> > > > I was able to test the DCD code you sent previously, let me know if=
 you
> > > > find any issues.
> > > >=20
> > > > Fan   =20
> > >=20
> > > FYI.=20
> > >=20
> > > Updated the last two commits to drop the extents for pending to
> > > release as the host can proactively release dc extents so there can be
> > > no pending-to-release extent list on the device side.
> > >=20
> > > Fan   =20
> >=20
> > Ira located a bug when testing dc extent adding with his latest DCD ker=
nel
> > code.
> > The dpa passed in the qmp command is offset relative to the base of the
> > region where the extent is offered, we need to convert it to address re=
lative
> > to the base address of the base of the region0 so the bit in the bitmap=
 can
> > be correctly mapped.
> >=20
> > Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interfaces to
> > add/release dynamic capacity ext=E2=80=A6) with the following changes t=
o fix the issue. =20
>=20
> Hi Fan,
>=20
> I hit this whilst reusing some of your code for the fmapi initiate add DC
> command.   Try adding an empty extent list..
>=20
> "extents": []
>=20
> boom.
>=20
> Definitely need to reject that input :)

Fan,

Another thing I noticed...

I would not provide a more flexible QMP interface than the FMAPI interfaces.
The key thing I've noticed so far is no need to provide option for a list
of extents in different regions.  Just provide them as separate commands if=
 that
is what is wanted.   That is drop the region-id in QMP out of the extent and
put alongside path in the top level arguements.

{ "execute": "cxl-add-dynamic-capcity",
  "arguements": {
	"path": "cxl-mem1",
	"region-id": 3,
	"extents": [ { "dpa": 0, "len": 6 } ] }}
  }



>=20
> Jonathan
>=20
>=20
> >=20
> >=20
> > diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> > index ea88b53f41..d51f2ef9f5 100644
> > --- a/hw/mem/cxl_type3.c
> > +++ b/hw/mem/cxl_type3.c
> > @@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(cons=
t char *path, CxlEventLog log,
> > 		 extents[i].shared_seq =3D 0;
> >=20
> > 		 /* No duplicate or overlapped extents are allowed */
> > -        dpa -=3D dcd->dc.regions[0].base;
> > +        dpa =3D dpa + dcd->dc.regions[rid].base - dcd->dc.regions[0].b=
ase;
> > 		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
> > 			 len / min_block_size)) {
> > 			 error_setg(errp, "duplicate or overlapped extents are detected");
> >=20
> >=20
> > Fan
> >  =20
>=20
>=20
>=20


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id B94FC39842
	for <linux-cxl@vger.kernel.org>; Fri, 27 Oct 2023 16:34:30 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="gUIgfY09"
Received: from mail-pf1-x430.google.com (mail-pf1-x430.google.com [IPv6:2607:f8b0:4864:20::430])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E0EB3116
	for <linux-cxl@vger.kernel.org>; Fri, 27 Oct 2023 09:34:28 -0700 (PDT)
Received: by mail-pf1-x430.google.com with SMTP id d2e1a72fcca58-6bd73395bceso1671545b3a.0
        for <linux-cxl@vger.kernel.org>; Fri, 27 Oct 2023 09:34:28 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1698424468; x=1699029268; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=he9kZEu2zAoBb0Fgvh0NEGNs6YazgAcKSPIlArJ7H0s=;
        b=gUIgfY09l9ZPrQJIKicf+mLV1WxKSTJkzyiAE/8ooux9/Nc1IYR4Jy6f5tiBubk6Ay
         cbTohpXA5EJ1wX+i27yescquQq+VJcPXx2GWk/buuSNnvTBmuUcUgkwFpgCZoAh+5GlN
         OMl1thPzJUasVCeHyXtWI7PWIX2EkmAUQD4oyF1/bZBg6eV7QfZXGRw4Dozjs+eBa4w6
         NZl1tHfEyx65qZNxlm/gm0v1ReawzuHkieZxbcjkwcmHD9uSxtQe92UlK94zaU9d+iRz
         4XBpaORVt1IQniYMqi8SRnwW+R1YbeK6xnyRi0AL4AKyQUzzFdTPDUM+qvkgDcsBNr3A
         5xHA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1698424468; x=1699029268;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=he9kZEu2zAoBb0Fgvh0NEGNs6YazgAcKSPIlArJ7H0s=;
        b=RTEzCWmYu14/GoI+wCmwYNLfADGrKc9AoNfMob9tkkKTzbGZ9uiKGJnnhL9Il7fApE
         8FTA73kYyi4XaXOdqUw6wOpYS2TXZBGDjmB8AeqTD3hNK0DDqXVERfS6HaDOjqk1OeyX
         l2CJwn4PLdw+lbfLgH+S08Szs9GBpAzc8qzo17oDiTKzRdwdmcJZSisap78eWegoXcUA
         uDunfZiFZ+Dmz779TDEuyJVYtLCR7i4oxs8+JXzfl69VNL5bu0EjTWsT5FnN99ckPdT4
         3OgLAu35Gtei375zGDYuJZ3SWl+TjYqAZmjUqMfld3apS1zudrNvsalBmdHizXgIvTRZ
         luPw==
X-Gm-Message-State: AOJu0YxqpvuanhdKb10UmQlzdFuJFG4RQc+A3yZXEnsitYhy9PQVXmWT
	CknJP0hB44BxkkabGG8nmGnue/Cx4RI=
X-Google-Smtp-Source: AGHT+IHp3sM+r/hodG/A0u6THwjlpWlum7mQfzsthyz4IessqgOl/J5ijxNB8+eJTap8ykWX7jz+GQ==
X-Received: by 2002:a05:6a00:114e:b0:68a:582b:6b62 with SMTP id b14-20020a056a00114e00b0068a582b6b62mr3628710pfm.7.1698424468216;
        Fri, 27 Oct 2023 09:34:28 -0700 (PDT)
Received: from debian ([2601:641:380:4e50:5e7c:68d3:5ea1:8eb2])
        by smtp.gmail.com with ESMTPSA id y11-20020aa79e0b000000b0069029a3196dsm1575339pfq.184.2023.10.27.09.34.26
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 27 Oct 2023 09:34:27 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Fri, 27 Oct 2023 09:34:02 -0700
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: fan <nifan.cxl@gmail.com>, linux-cxl@vger.kernel.org,
	a.manzanares@samsung.com, Ira Weiny <ira.weiny@intel.com>,
	Fan Ni <fan.ni@samsung.com>,
	"Singh, Naveen" <naveen.c.singh@intel.com>, dave@stgolabs.net,
	nmtadam.samsung@gmail.com
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <ZTvmesV_Uc_0Zf6j@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
 <ZTbN8mAa256JWTFE@debian>
 <ZTgTQs_HJ9Xlb0Ov@debian>
 <ZTim4UPbe2C-tC_w@debian>
 <20231026100121.00007100@Huawei.com>
 <20231026175802.00001cfc@Huawei.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20231026175802.00001cfc@Huawei.com>

On Thu, Oct 26, 2023 at 05:58:02PM +0100, Jonathan Cameron wrote:
> On Thu, 26 Oct 2023 10:01:21 +0100
> Jonathan Cameron <Jonathan.Cameron@Huawei.com> wrote:
> 
> > On Tue, 24 Oct 2023 22:25:53 -0700
> > fan <nifan.cxl@gmail.com> wrote:
> > 
> > > On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote:  
> > > > On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:    
> > > > > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:    
> > > > > > Fan,
> > > > > > 
> > > > > > I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
> > > > > > 
> > > > > > I've been testing various things and so far I have a couple of questions.
> > > > > > 
> > > > > > 1) If the qmp command is used to add extents which overlap other extents
> > > > > >    shouldn't that throw an error?  I don't see any validation of this and
> > > > > >    I would think a real device would reject such a request from the FM.
> > > > > > 
> > > > > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
> > > > > >    extents prior to driver load does not seem to work.  And I think this
> > > > > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().
> > > > > > 
> > > > > > Ira
> > > > > > 
> > > > > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13    
> > > > > 
> > > > > Hi Ira,
> > > > > FYI. I have updated the DCD emulation patch series based on feedbacks on
> > > > > the previous version.
> > > > > 
> > > > > The new version is here:
> > > > > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > > > > 
> > > > > The code is based on Jonathan's branch cxl-2023-09-26.
> > > > > 
> > > > > The main changes include,
> > > > > 
> > > > > 1. Update cxl_find_dc_region to detect the case the range of
> > > > > the extent cross multiple DC regions.
> > > > > 2. Add comments to explain the checks performed in function
> > > > > cxl_detect_malformed_extent_list. (Jonathan)
> > > > > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > > > > 4. Update total_extent_count in add/release dynamic capacity response function.
> > > > > (Ira and Jorgen Hansen).
> > > > > 5. Fix the logic issue in test_bits and renamed it to
> > > > > test_any_bits_set to clear its function.
> > > > > 6. Add pending extent list for add/release extent event.
> > > > > 7. When add/release extent response is received, use the pending list to
> > > > > verify the extents are valid.
> > > > > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declaration to
> > > > > cxl_device.h so it can be used in different files.
> > > > > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity event log type.
> > > > > 10. Extract the functionality to delete extent from extent list to a helper
> > > > > function.
> > > > > 11. Move the update of the bitmap which reflects which blocks are backed with
> > > > > dc extents from the moment when a dc extent is offered to the moment when it
> > > > > is accepted from the host.
> > > > > 
> > > > > I was able to test the DCD code you sent previously, let me know if you
> > > > > find any issues.
> > > > > 
> > > > > Fan    
> > > > 
> > > > FYI. 
> > > > 
> > > > Updated the last two commits to drop the extents for pending to
> > > > release as the host can proactively release dc extents so there can be
> > > > no pending-to-release extent list on the device side.
> > > > 
> > > > Fan    
> > > 
> > > Ira located a bug when testing dc extent adding with his latest DCD kernel
> > > code.
> > > The dpa passed in the qmp command is offset relative to the base of the
> > > region where the extent is offered, we need to convert it to address relative
> > > to the base address of the base of the region0 so the bit in the bitmap can
> > > be correctly mapped.
> > > 
> > > Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interfaces to
> > > add/release dynamic capacity extâ€¦) with the following changes to fix the issue.  
> > 
> > Hi Fan,
> > 
> > I hit this whilst reusing some of your code for the fmapi initiate add DC
> > command.   Try adding an empty extent list..
> > 
> > "extents": []
> > 
> > boom.
> > 
> > Definitely need to reject that input :)
> 
> Fan,
> 
> Another thing I noticed...
> 
> I would not provide a more flexible QMP interface than the FMAPI interfaces.
> The key thing I've noticed so far is no need to provide option for a list
> of extents in different regions.  Just provide them as separate commands if that
> is what is wanted.   That is drop the region-id in QMP out of the extent and
> put alongside path in the top level arguements.
> 
> { "execute": "cxl-add-dynamic-capcity",
>   "arguements": {
> 	"path": "cxl-mem1",
> 	"region-id": 3,
> 	"extents": [ { "dpa": 0, "len": 6 } ] }}
>   }
> 
> 
> 
> > 
> > Jonathan

Hi Jonathan,

I updated my branch with the following changes:
1. Add code to detect and reject QMP requests without any extents;
2. Add code to detect and reject QMP requests where the extent len is 0.
3. Change the QMP interface as you suggested above and moved the
region-id out of extents and now each command only takes care of extent
add/release request in a single region.
4. Change the region bitmap length from decode_len to len.

Fan

> > 
> > 
> > > 
> > > 
> > > diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> > > index ea88b53f41..d51f2ef9f5 100644
> > > --- a/hw/mem/cxl_type3.c
> > > +++ b/hw/mem/cxl_type3.c
> > > @@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(const char *path, CxlEventLog log,
> > > 		 extents[i].shared_seq = 0;
> > > 
> > > 		 /* No duplicate or overlapped extents are allowed */
> > > -        dpa -= dcd->dc.regions[0].base;
> > > +        dpa = dpa + dcd->dc.regions[rid].base - dcd->dc.regions[0].base;
> > > 		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
> > > 			 len / min_block_size)) {
> > > 			 error_setg(errp, "duplicate or overlapped extents are detected");
> > > 
> > > 
> > > Fan
> > >   
> > 
> > 
> > 
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A4C4C20338
	for <linux-cxl@vger.kernel.org>; Tue, 31 Oct 2023 17:18:56 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; dkim=none
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6D65A8F
	for <linux-cxl@vger.kernel.org>; Tue, 31 Oct 2023 10:18:54 -0700 (PDT)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4SKcKM7579z6K8wS;
	Wed,  1 Nov 2023 01:17:59 +0800 (CST)
Received: from localhost (10.195.246.117) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.31; Tue, 31 Oct
 2023 17:18:50 +0000
Date: Tue, 31 Oct 2023 17:18:46 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: fan <nifan.cxl@gmail.com>
CC: <linux-cxl@vger.kernel.org>, <a.manzanares@samsung.com>, Ira Weiny
	<ira.weiny@intel.com>, Fan Ni <fan.ni@samsung.com>, "Singh, Naveen"
	<naveen.c.singh@intel.com>, <dave@stgolabs.net>, <nmtadam.samsung@gmail.com>
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <20231031171846.000050d1@Huawei.com>
In-Reply-To: <ZTvmesV_Uc_0Zf6j@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
	<ZTbN8mAa256JWTFE@debian>
	<ZTgTQs_HJ9Xlb0Ov@debian>
	<ZTim4UPbe2C-tC_w@debian>
	<20231026100121.00007100@Huawei.com>
	<20231026175802.00001cfc@Huawei.com>
	<ZTvmesV_Uc_0Zf6j@debian>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: quoted-printable
X-Originating-IP: [10.195.246.117]
X-ClientProxiedBy: lhrpeml100002.china.huawei.com (7.191.160.241) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected

On Fri, 27 Oct 2023 09:34:02 -0700
fan <nifan.cxl@gmail.com> wrote:

> On Thu, Oct 26, 2023 at 05:58:02PM +0100, Jonathan Cameron wrote:
> > On Thu, 26 Oct 2023 10:01:21 +0100
> > Jonathan Cameron <Jonathan.Cameron@Huawei.com> wrote:
> >  =20
> > > On Tue, 24 Oct 2023 22:25:53 -0700
> > > fan <nifan.cxl@gmail.com> wrote:
> > >  =20
> > > > On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote:   =20
> > > > > On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:     =20
> > > > > > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:     =
=20
> > > > > > > Fan,
> > > > > > >=20
> > > > > > > I'm working off of Jonathan's latest CXL branch with the DCD =
patches.[1]
> > > > > > >=20
> > > > > > > I've been testing various things and so far I have a couple o=
f questions.
> > > > > > >=20
> > > > > > > 1) If the qmp command is used to add extents which overlap ot=
her extents
> > > > > > >    shouldn't that throw an error?  I don't see any validation=
 of this and
> > > > > > >    I would think a real device would reject such a request fr=
om the FM.
> > > > > > >=20
> > > > > > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempti=
ng to add
> > > > > > >    extents prior to driver load does not seem to work.  And I=
 think this
> > > > > > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_=
ext_list().
> > > > > > >=20
> > > > > > > Ira
> > > > > > >=20
> > > > > > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13     =
=20
> > > > > >=20
> > > > > > Hi Ira,
> > > > > > FYI. I have updated the DCD emulation patch series based on fee=
dbacks on
> > > > > > the previous version.
> > > > > >=20
> > > > > > The new version is here:
> > > > > > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > > > > >=20
> > > > > > The code is based on Jonathan's branch cxl-2023-09-26.
> > > > > >=20
> > > > > > The main changes include,
> > > > > >=20
> > > > > > 1. Update cxl_find_dc_region to detect the case the range of
> > > > > > the extent cross multiple DC regions.
> > > > > > 2. Add comments to explain the checks performed in function
> > > > > > cxl_detect_malformed_extent_list. (Jonathan)
> > > > > > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > > > > > 4. Update total_extent_count in add/release dynamic capacity re=
sponse function.
> > > > > > (Ira and Jorgen Hansen).
> > > > > > 5. Fix the logic issue in test_bits and renamed it to
> > > > > > test_any_bits_set to clear its function.
> > > > > > 6. Add pending extent list for add/release extent event.
> > > > > > 7. When add/release extent response is received, use the pendin=
g list to
> > > > > > verify the extents are valid.
> > > > > > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list d=
eclaration to
> > > > > > cxl_device.h so it can be used in different files.
> > > > > > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capaci=
ty event log type.
> > > > > > 10. Extract the functionality to delete extent from extent list=
 to a helper
> > > > > > function.
> > > > > > 11. Move the update of the bitmap which reflects which blocks a=
re backed with
> > > > > > dc extents from the moment when a dc extent is offered to the m=
oment when it
> > > > > > is accepted from the host.
> > > > > >=20
> > > > > > I was able to test the DCD code you sent previously, let me kno=
w if you
> > > > > > find any issues.
> > > > > >=20
> > > > > > Fan     =20
> > > > >=20
> > > > > FYI.=20
> > > > >=20
> > > > > Updated the last two commits to drop the extents for pending to
> > > > > release as the host can proactively release dc extents so there c=
an be
> > > > > no pending-to-release extent list on the device side.
> > > > >=20
> > > > > Fan     =20
> > > >=20
> > > > Ira located a bug when testing dc extent adding with his latest DCD=
 kernel
> > > > code.
> > > > The dpa passed in the qmp command is offset relative to the base of=
 the
> > > > region where the extent is offered, we need to convert it to addres=
s relative
> > > > to the base address of the base of the region0 so the bit in the bi=
tmap can
> > > > be correctly mapped.
> > > >=20
> > > > Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interface=
s to
> > > > add/release dynamic capacity ext=E2=80=A6) with the following chang=
es to fix the issue.   =20
> > >=20
> > > Hi Fan,
> > >=20
> > > I hit this whilst reusing some of your code for the fmapi initiate ad=
d DC
> > > command.   Try adding an empty extent list..
> > >=20
> > > "extents": []
> > >=20
> > > boom.
> > >=20
> > > Definitely need to reject that input :) =20
> >=20
> > Fan,
> >=20
> > Another thing I noticed...
> >=20
> > I would not provide a more flexible QMP interface than the FMAPI interf=
aces.
> > The key thing I've noticed so far is no need to provide option for a li=
st
> > of extents in different regions.  Just provide them as separate command=
s if that
> > is what is wanted.   That is drop the region-id in QMP out of the exten=
t and
> > put alongside path in the top level arguements.
> >=20
> > { "execute": "cxl-add-dynamic-capcity",
> >   "arguements": {
> > 	"path": "cxl-mem1",
> > 	"region-id": 3,
> > 	"extents": [ { "dpa": 0, "len": 6 } ] }}
> >   }
> >=20
> >=20
> >  =20
> > >=20
> > > Jonathan =20
>=20
> Hi Jonathan,
>=20
> I updated my branch with the following changes:
> 1. Add code to detect and reject QMP requests without any extents;
> 2. Add code to detect and reject QMP requests where the extent len is 0.
> 3. Change the QMP interface as you suggested above and moved the
> region-id out of extents and now each command only takes care of extent
> add/release request in a single region.
> 4. Change the region bitmap length from decode_len to len.

Great. Looking at what I think is your newest implementation.

dpa is used qmp_cxl_process_dynamic_capacity() for various things that aren=
't
the device physical address (aren't relative to start of device).
That's confusing at times.  The FMAPI commands are all in DPA so I got a bit
lost.  I think you should do all the checks based on actual DPA (so for some
you will then need to subtract the region base).

Now you only have one region, you can do the checking of overlap in that fu=
nction
in one bit per block_size - whatever the block size happens to be.

Otherwise this bit looks good to me.  My initial FMAPI stuff is going to
be a bit of a hack on top, but the aim is to illustrate where there
might be shared code rather than end up with a proper clean result.

Jonathan

>=20
> Fan
>=20
> > >=20
> > >  =20
> > > >=20
> > > >=20
> > > > diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> > > > index ea88b53f41..d51f2ef9f5 100644
> > > > --- a/hw/mem/cxl_type3.c
> > > > +++ b/hw/mem/cxl_type3.c
> > > > @@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(=
const char *path, CxlEventLog log,
> > > > 		 extents[i].shared_seq =3D 0;
> > > >=20
> > > > 		 /* No duplicate or overlapped extents are allowed */
> > > > -        dpa -=3D dcd->dc.regions[0].base;
> > > > +        dpa =3D dpa + dcd->dc.regions[rid].base - dcd->dc.regions[=
0].base;
> > > > 		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
> > > > 			 len / min_block_size)) {
> > > > 			 error_setg(errp, "duplicate or overlapped extents are detected"=
);
> > > >=20
> > > >=20
> > > > Fan
> > > >    =20
> > >=20
> > >=20
> > >  =20
> >  =20
>=20
>=20


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from lindbergh.monkeyblade.net (lindbergh.monkeyblade.net [23.128.96.19])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id AF6D620B3A
	for <linux-cxl@vger.kernel.org>; Tue, 31 Oct 2023 17:44:50 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=gmail.com header.i=@gmail.com header.b="ScieiuAf"
Received: from mail-yw1-x1135.google.com (mail-yw1-x1135.google.com [IPv6:2607:f8b0:4864:20::1135])
	by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D02B7DA
	for <linux-cxl@vger.kernel.org>; Tue, 31 Oct 2023 10:44:48 -0700 (PDT)
Received: by mail-yw1-x1135.google.com with SMTP id 00721157ae682-579de633419so57980237b3.3
        for <linux-cxl@vger.kernel.org>; Tue, 31 Oct 2023 10:44:48 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20230601; t=1698774288; x=1699379088; darn=vger.kernel.org;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from:from:to
         :cc:subject:date:message-id:reply-to;
        bh=mE3lK5hPZIK17eIucMEUfCgzp6ul7cGl6KWb78SvjpY=;
        b=ScieiuAfRW7jx/A+YvzfAfX+nbOXEcwFH+3R/CDsu6siBYDY5BSFlGGckL8frVXntl
         GGS9LXUdjJ6KZwXQqVHCHY57iJwZ4ygONju8GJdBFm77I2o0i0kHbpNcq+v16JbfzHid
         mxtDoBJKlIWVZLo13Dl03LrufoQBUeK4TYC5SIsIj6TyFQCYvZm//G8monzGSC2Bj9Z1
         SeGIzQEtxXk2M5V2L9MyOKRNlQiY2pCU5Hs3GlaZjZbH1UYFYcCD7Ac1UqGhdidBnnYG
         ymEABYhNN4DiSAUIfkkPziFxn1qlrqXVoDPR0LHR6/XZV+6qktUphn1spOHvPpX3fvDi
         TDlQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1698774288; x=1699379088;
        h=in-reply-to:content-transfer-encoding:content-disposition
         :mime-version:references:message-id:subject:cc:to:date:from
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=mE3lK5hPZIK17eIucMEUfCgzp6ul7cGl6KWb78SvjpY=;
        b=GLf4fNg8+rogBhsklxpyJhySXj8IAQnmgAT5BVZkOc9Oh/fSOEI/apUNOCqr21hbfP
         hxs2ABXnVorzrJPI3xAUbu8t3iSheNnUijwx6UNRk2lvUHBs4qCWh/7gv3UL/GNlAPWf
         8ydUg2p0Us8vf9OEcaFzdRLnBftywTHcQDKZU4b/xkVg2FLLK45z8g4UCsuDHm2+RFzM
         Y6+bC78EtqvE8EpfHlFYelUuw86dDZhV+I4/n9LUjyodUCUTIorTthotr34VTb8bB2b+
         vHf9jZieHiRBIsKgQP/4+JY0F8btb58iPNKCjM6AgtTNl8vuqhl9oodSwIZjr5zAuMGi
         QNYg==
X-Gm-Message-State: AOJu0Yy/7Ik/201N323mGcJsEWLdWJ5uWSxKyPwe0dUExAJXH+2Vfcxu
	1s04UmhxUA0bxZenS2JoDrc=
X-Google-Smtp-Source: AGHT+IG+H4xY7VZNz/71fZvQSXRHmqL0k+p5Vaxjte54Xu8RBtv2aokHypk7HBYQMMHfvyMaGh9RhQ==
X-Received: by 2002:a0d:d846:0:b0:5af:abe1:3d4b with SMTP id a67-20020a0dd846000000b005afabe13d4bmr13580654ywe.5.1698774287872;
        Tue, 31 Oct 2023 10:44:47 -0700 (PDT)
Received: from debian ([50.205.20.42])
        by smtp.gmail.com with ESMTPSA id w6-20020a818606000000b0059a34cfa2a5sm1076368ywf.67.2023.10.31.10.44.46
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 31 Oct 2023 10:44:47 -0700 (PDT)
From: fan <nifan.cxl@gmail.com>
X-Google-Original-From: fan <fan@debian>
Date: Tue, 31 Oct 2023 10:44:31 -0700
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: fan <nifan.cxl@gmail.com>, linux-cxl@vger.kernel.org,
	a.manzanares@samsung.com, Ira Weiny <ira.weiny@intel.com>,
	Fan Ni <fan.ni@samsung.com>,
	"Singh, Naveen" <naveen.c.singh@intel.com>, dave@stgolabs.net,
	nmtadam.samsung@gmail.com
Subject: Re: Questions about the qemu DCD support in cxl-2023-09-13
Message-ID: <ZUE8_8Yi0OtLbRyi@debian>
References: <650cc29ab3f64_50d07294e7@iweiny-mobl.notmuch>
 <ZTbN8mAa256JWTFE@debian>
 <ZTgTQs_HJ9Xlb0Ov@debian>
 <ZTim4UPbe2C-tC_w@debian>
 <20231026100121.00007100@Huawei.com>
 <20231026175802.00001cfc@Huawei.com>
 <ZTvmesV_Uc_0Zf6j@debian>
 <20231031171846.000050d1@Huawei.com>
Precedence: bulk
X-Mailing-List: linux-cxl@vger.kernel.org
List-Id: <linux-cxl.vger.kernel.org>
List-Subscribe: <mailto:linux-cxl+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-cxl+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20231031171846.000050d1@Huawei.com>

On Tue, Oct 31, 2023 at 05:18:46PM +0000, Jonathan Cameron wrote:
> On Fri, 27 Oct 2023 09:34:02 -0700
> fan <nifan.cxl@gmail.com> wrote:
> 
> > On Thu, Oct 26, 2023 at 05:58:02PM +0100, Jonathan Cameron wrote:
> > > On Thu, 26 Oct 2023 10:01:21 +0100
> > > Jonathan Cameron <Jonathan.Cameron@Huawei.com> wrote:
> > >   
> > > > On Tue, 24 Oct 2023 22:25:53 -0700
> > > > fan <nifan.cxl@gmail.com> wrote:
> > > >   
> > > > > On Tue, Oct 24, 2023 at 11:56:02AM -0700, fan wrote:    
> > > > > > On Mon, Oct 23, 2023 at 12:48:02PM -0700, fan wrote:      
> > > > > > > On Thu, Sep 21, 2023 at 03:24:26PM -0700, Ira Weiny wrote:      
> > > > > > > > Fan,
> > > > > > > > 
> > > > > > > > I'm working off of Jonathan's latest CXL branch with the DCD patches.[1]
> > > > > > > > 
> > > > > > > > I've been testing various things and so far I have a couple of questions.
> > > > > > > > 
> > > > > > > > 1) If the qmp command is used to add extents which overlap other extents
> > > > > > > >    shouldn't that throw an error?  I don't see any validation of this and
> > > > > > > >    I would think a real device would reject such a request from the FM.
> > > > > > > > 
> > > > > > > > 2) Where is CXLType3Dev->dc.total_extent_count set?  Attempting to add
> > > > > > > >    extents prior to driver load does not seem to work.  And I think this
> > > > > > > >    is because total_extent_count is 0 in cmd_dcd_get_dyn_cap_ext_list().
> > > > > > > > 
> > > > > > > > Ira
> > > > > > > > 
> > > > > > > > [1] https://gitlab.com/jic23/qemu/-/tree/cxl-2023-09-13      
> > > > > > > 
> > > > > > > Hi Ira,
> > > > > > > FYI. I have updated the DCD emulation patch series based on feedbacks on
> > > > > > > the previous version.
> > > > > > > 
> > > > > > > The new version is here:
> > > > > > > https://github.com/moking/qemu-jic-clone/tree/dcd-dev
> > > > > > > 
> > > > > > > The code is based on Jonathan's branch cxl-2023-09-26.
> > > > > > > 
> > > > > > > The main changes include,
> > > > > > > 
> > > > > > > 1. Update cxl_find_dc_region to detect the case the range of
> > > > > > > the extent cross multiple DC regions.
> > > > > > > 2. Add comments to explain the checks performed in function
> > > > > > > cxl_detect_malformed_extent_list. (Jonathan)
> > > > > > > 3. Minimize the checks in cmd_dcd_add_dyn_cap_rsp.(Jonathan)
> > > > > > > 4. Update total_extent_count in add/release dynamic capacity response function.
> > > > > > > (Ira and Jorgen Hansen).
> > > > > > > 5. Fix the logic issue in test_bits and renamed it to
> > > > > > > test_any_bits_set to clear its function.
> > > > > > > 6. Add pending extent list for add/release extent event.
> > > > > > > 7. When add/release extent response is received, use the pending list to
> > > > > > > verify the extents are valid.
> > > > > > > 8. Add test_any_bits_set and cxl_insert_extent_to_extent_list declaration to
> > > > > > > cxl_device.h so it can be used in different files.
> > > > > > > 9. Updated ct3d_qmp_cxl_event_log_enc to include dynamic capacity event log type.
> > > > > > > 10. Extract the functionality to delete extent from extent list to a helper
> > > > > > > function.
> > > > > > > 11. Move the update of the bitmap which reflects which blocks are backed with
> > > > > > > dc extents from the moment when a dc extent is offered to the moment when it
> > > > > > > is accepted from the host.
> > > > > > > 
> > > > > > > I was able to test the DCD code you sent previously, let me know if you
> > > > > > > find any issues.
> > > > > > > 
> > > > > > > Fan      
> > > > > > 
> > > > > > FYI. 
> > > > > > 
> > > > > > Updated the last two commits to drop the extents for pending to
> > > > > > release as the host can proactively release dc extents so there can be
> > > > > > no pending-to-release extent list on the device side.
> > > > > > 
> > > > > > Fan      
> > > > > 
> > > > > Ira located a bug when testing dc extent adding with his latest DCD kernel
> > > > > code.
> > > > > The dpa passed in the qmp command is offset relative to the base of the
> > > > > region where the extent is offered, we need to convert it to address relative
> > > > > to the base address of the base of the region0 so the bit in the bitmap can
> > > > > be correctly mapped.
> > > > > 
> > > > > Update the commit (commit 0ad5136: hw/cxl/events: Add qmp interfaces to
> > > > > add/release dynamic capacity extâ€¦) with the following changes to fix the issue.    
> > > > 
> > > > Hi Fan,
> > > > 
> > > > I hit this whilst reusing some of your code for the fmapi initiate add DC
> > > > command.   Try adding an empty extent list..
> > > > 
> > > > "extents": []
> > > > 
> > > > boom.
> > > > 
> > > > Definitely need to reject that input :)  
> > > 
> > > Fan,
> > > 
> > > Another thing I noticed...
> > > 
> > > I would not provide a more flexible QMP interface than the FMAPI interfaces.
> > > The key thing I've noticed so far is no need to provide option for a list
> > > of extents in different regions.  Just provide them as separate commands if that
> > > is what is wanted.   That is drop the region-id in QMP out of the extent and
> > > put alongside path in the top level arguements.
> > > 
> > > { "execute": "cxl-add-dynamic-capcity",
> > >   "arguements": {
> > > 	"path": "cxl-mem1",
> > > 	"region-id": 3,
> > > 	"extents": [ { "dpa": 0, "len": 6 } ] }}
> > >   }
> > > 
> > > 
> > >   
> > > > 
> > > > Jonathan  
> > 
> > Hi Jonathan,
> > 
> > I updated my branch with the following changes:
> > 1. Add code to detect and reject QMP requests without any extents;
> > 2. Add code to detect and reject QMP requests where the extent len is 0.
> > 3. Change the QMP interface as you suggested above and moved the
> > region-id out of extents and now each command only takes care of extent
> > add/release request in a single region.
> > 4. Change the region bitmap length from decode_len to len.
> 
> Great. Looking at what I think is your newest implementation.
> 
> dpa is used qmp_cxl_process_dynamic_capacity() for various things that aren't
> the device physical address (aren't relative to start of device).
> That's confusing at times.  The FMAPI commands are all in DPA so I got a bit
> lost.  I think you should do all the checks based on actual DPA (so for some
> you will then need to subtract the region base).

The dpa is only used as the offset to the base of current region, not to the
start of the device. We can change it to offset if it causes confusion.

> 
> Now you only have one region, you can do the checking of overlap in that function
> in one bit per block_size - whatever the block size happens to be.

All the checks now are within a single region, and we use one bit per
block_size already in the code.

...

blk_bitmap = bitmap_new(dcd->dc.regions[rid].len / block_size);

https://github.com/moking/qemu-jic-clone/blob/dcd-dev/hw/mem/cxl_type3.c#L2044

One more thing, I forgot to update the interface in the stub.c file for
the new QMP interface, will update.

Fan


...

> 
> Otherwise this bit looks good to me.  My initial FMAPI stuff is going to
> be a bit of a hack on top, but the aim is to illustrate where there
> might be shared code rather than end up with a proper clean result.
> 
> Jonathan
> 
> > 
> > Fan
> > 
> > > > 
> > > >   
> > > > > 
> > > > > 
> > > > > diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> > > > > index ea88b53f41..d51f2ef9f5 100644
> > > > > --- a/hw/mem/cxl_type3.c
> > > > > +++ b/hw/mem/cxl_type3.c
> > > > > @@ -1978,7 +1978,7 @@ static void qmp_cxl_process_dynamic_capacity(const char *path, CxlEventLog log,
> > > > > 		 extents[i].shared_seq = 0;
> > > > > 
> > > > > 		 /* No duplicate or overlapped extents are allowed */
> > > > > -        dpa -= dcd->dc.regions[0].base;
> > > > > +        dpa = dpa + dcd->dc.regions[rid].base - dcd->dc.regions[0].base;
> > > > > 		 if (test_any_bits_set(blk_bitmap, dpa / min_block_size,
> > > > > 			 len / min_block_size)) {
> > > > > 			 error_setg(errp, "duplicate or overlapped extents are detected");
> > > > > 
> > > > > 
> > > > > Fan
> > > > >     
> > > > 
> > > > 
> > > >   
> > >   
> > 
> > 
> 

