From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 11B05C43217
	for <linux-cxl@archiver.kernel.org>; Mon, 28 Nov 2022 15:02:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231157AbiK1PCN (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 28 Nov 2022 10:02:13 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50366 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230501AbiK1PCM (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 28 Nov 2022 10:02:12 -0500
Received: from mail-pj1-x1044.google.com (mail-pj1-x1044.google.com [IPv6:2607:f8b0:4864:20::1044])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 67E8A1FD
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:11 -0800 (PST)
Received: by mail-pj1-x1044.google.com with SMTP id t11-20020a17090a024b00b0021932afece4so3353971pje.5
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=content-transfer-encoding:mime-version:message-id:date:subject:cc
         :to:from:from:to:cc:subject:date:message-id:reply-to;
        bh=lSiDagc7OCOKkLbBACL9tcNTTqBs4oCCRei4cYayvkw=;
        b=bxe7g1HMI2EE3o5gbKfBcq1Zu+ylD7TFNLWqrQXxBiqcurE5/2x/c+wQ0pXkbUZNP+
         I5KXCQlA49AqoOYkpIefi2LL6P/Tm9rNN7z7bq/s6RwvWC7vrgShlb3yHWcj4zHRkFAk
         o0a77cHS146+L849xFSZPq0cmm++VMM7flNwCtSs2iyxoQ8bPx1PMAaZHkuXKd0eHx+w
         w5rSavTvlp/AXlv+UU+K5+TgZcQ6DY3NTE8bA3kln9SPSC2tSuTfjyQoRXdwuNsbgg4r
         cn2b/e61m43WehADZvQ51M9RhBI7DJwYbBrMG/HdPE68IM8jeXt6nu6uukdIb0++pvVA
         5EpA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=content-transfer-encoding:mime-version:message-id:date:subject:cc
         :to:from:x-gm-message-state:from:to:cc:subject:date:message-id
         :reply-to;
        bh=lSiDagc7OCOKkLbBACL9tcNTTqBs4oCCRei4cYayvkw=;
        b=022MX8Z8ZkuVMR3+kShLD//Ti6cjdfxBiC8R2OCwh0l40wcNMjrX5sVP4sAnU62EUz
         5GOL+QKzb/NYZiYQHIZpnoViqczYLp2ig9oZNYzZSKnNJ3tuFqHCooMhxFk6tiEDOLOb
         hbRzgl3TaU9Z9WeVd3XHtlPxR1Kleka1CEurKcsrXBVGKf9vybCb+hqGZFPwsJCLqsxj
         JVZiHg05DCzTuw5PwMIVnTXSdhXomW6ASfGCSAV5OPrb1Uez70FneS1JnGSNag4EwRnY
         +9u3e9hmmkzqzTw7pE7wdPT+GJYnys1Z4BA9J/ao+5tEKLrkGi/o5s1z9I5s8teqfkBp
         BTjQ==
X-Gm-Message-State: ANoB5pkIge5xyDzwIr8jGmOaMukuzrHtLtg0oqjVZhWoN2zBUiikY0ct
        hO5ZfrEU34WT5rn5sFbHnxbel+YUK0kB
X-Google-Smtp-Source: AA0mqf7mR6X2y+/1a55RM670ezMwFDfK4EAwc6sQ2ei/BKWgHagSx8UwAWqAhA98KzQb+1/pOuXL0w==
X-Received: by 2002:a17:902:d58d:b0:188:d6e1:b82b with SMTP id k13-20020a170902d58d00b00188d6e1b82bmr32406922plh.146.1669647730422;
        Mon, 28 Nov 2022 07:02:10 -0800 (PST)
Received: from fedora.mshome.net ([104.184.156.161])
        by smtp.gmail.com with ESMTPSA id a9-20020a170902ecc900b001886ff82680sm8997928plh.127.2022.11.28.07.02.08
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 28 Nov 2022 07:02:09 -0800 (PST)
From: Gregory Price <gourry.memverge@gmail.com>
X-Google-Original-From: Gregory Price <gregory.price@memverge.com>
To: qemu-devel@nongnu.org
Cc: jonathan.cameron@huawei.com, linux-cxl@vger.kernel.org,
        alison.schofield@intel.com, dave@stgolabs.net,
        a.manzanares@samsung.com, bwidawsk@kernel.org,
        gregory.price@memverge.com, hchkuo@avery-design.com.tw,
        cbrowy@avery-design.com, ira.weiny@intel.com
Subject: [RFC v4 0/3] CXL Type-3 Volatile Memory Support
Date: Mon, 28 Nov 2022 10:01:54 -0500
Message-Id: <20221128150157.97724-1-gregory.price@memverge.com>
X-Mailer: git-send-email 2.37.3
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

Changes in this version
    * Minor bug fixes spotted by J. Cameron
    * Whitespace changes to docs and tests moved ahead of patch
    * Address Space access to pmem region is now as(dpa-vmem_len)

Note: Submitted as an extention to the CDAT emulation because the CDAT DSMAS
entry concerns memory mapping and is required to successfully map memory
regions correctly in bios/efi.

See https://gitlab.com/jic23/qemu/-/tree/cxl-2022-11-17 for the base of
this patch set.



This patches provides 2 features to the CXL Type-3 Device:
    1) Volatile Memory Region Support
    2) Multi-Region support (1 Volatile, 1 Persistent)

Summary of Changes per-commit:
1) Add CXL_CAPACITY_MULTIPLIER definition to replace magic numbers
2) Whitespace updates to docs and tests
3) Refactor CDAT DSMAS Initialization for multi-region initialization
   Multi-Region and Volatile Memory support for CXL Type-3 Devices
   Test and Documentation updates

The final patch in this series makes 6 major changes to the type-3
device in order to implement multi-region and volatile region support
    1) The HostMemoryBackend [hostmem] has been replaced by two
       [hostvmem] and [hostpmem] to store volatile and persistent memory
       respectively
    2) The single AddressSpace has been replaced by two AddressSpaces
       [hostvmem_as] and [hostpmem_as] to map respective memdevs.
    3) Each memory region size and total region are stored separately
    4) The CDAT and DVSEC memory map entries have been updated:
       a) if vmem is present, vmem is mapped at DPA(0)
       b) if pmem is present
          i)  and vmem is present, pmem is mapped at DPA(vmem->size)
          ii) else, pmem is mapped at DPA(0)
       c) partitioning of pmem is not supported in this patch set but
          has been discussed and this design should suffice.
    5) Read/Write functions have been updated to access AddressSpaces
       according to the mapping described in #4.  Access to the
       persistent address space is calculated by (dpa-vmem_len)
    6) cxl-mailbox has been updated to report the respective size of
       volatile and persistent memory regions

CXL Spec (3.0) Section 8.2.9.8.2.0 - Get Partition Info
  Active Volatile Memory
    The device shall provide this volatile capacity starting at DPA 0
  Active Persistent Memory
    The device shall provide this persistent capacity starting at the
    DPA immediately following the volatile capacity

Partitioning of Persistent Memory regions may be supported on following
patch sets, but is not supported in this version.


Gregory Price (3):
  hw/cxl: Add CXL_CAPACITY_MULTIPLIER definition
  tests/qtest/cxl-test: whitespace, line ending cleanup
  hw/cxl: Multi-Region CXL Type-3 Devices (Volatile and Persistent)

 docs/system/devices/cxl.rst |  49 ++++--
 hw/cxl/cxl-mailbox-utils.c  |  24 +--
 hw/mem/cxl_type3.c          | 292 +++++++++++++++++++++++++++---------
 include/hw/cxl/cxl_device.h |  11 +-
 tests/qtest/cxl-test.c      | 161 ++++++++++++++------
 5 files changed, 395 insertions(+), 142 deletions(-)

-- 
2.37.3


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 32B93C43217
	for <linux-cxl@archiver.kernel.org>; Mon, 28 Nov 2022 15:02:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231386AbiK1PCQ (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 28 Nov 2022 10:02:16 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50384 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230501AbiK1PCP (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 28 Nov 2022 10:02:15 -0500
Received: from mail-pj1-x1041.google.com (mail-pj1-x1041.google.com [IPv6:2607:f8b0:4864:20::1041])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 011911FD
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:15 -0800 (PST)
Received: by mail-pj1-x1041.google.com with SMTP id o12so1917654pjo.4
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:from:to:cc:subject:date
         :message-id:reply-to;
        bh=vq3NRy72X3AFgsMApkdPvqc33L5sCjSJV7Eox6k+7XI=;
        b=M0SpkFsK0rWgiTfLWrl2MlQpUs5qqZtXuJL4yW6ErK8B59Qql93jQwnrSuH2PHluj7
         gISkW3242hrnVrHa/B4MhOBiN5Q/Z27xjvyJ2zF/cLj/BTWATi+T4nxma4IIe5KxuOkA
         7cAVficGxiM/HUGTC3OLt5+PTjNf2QaFImTkJpWG17U/4UdjkbhrhAE+VQctQwHz1IFo
         4j9qTt0/3/tpyS767fzCuAQ2sUEBNF2WoTWKnzrV4owGA7fP1p+OL5yFBNz9D8JMn/9n
         QZxe5hbdiymY7ZYk3VhwKWiYlkmF6mNNVvKWBzF5jsiaCsj0I/AIq9XSOIMZudWqzRso
         xKhQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=vq3NRy72X3AFgsMApkdPvqc33L5sCjSJV7Eox6k+7XI=;
        b=q/H/rm7z8dd6dMxRdX+bsGNRrz1Ie8KMTPdFWTEEZG+ev6PPZGdJb3+SixUH9lsYAe
         MJX4t8Jw9Q2FTq3qfsqiBBXcEkFTDIYMarhNnggwL30+yzeK3liG28lW23eL9LXOcPYa
         GWVZn/lVpwMOFwzjFEo6ujsTg1RScqaPeLHNcJzCLjtz48r3VCOAZ/qBLf/MlfuhOIm4
         mMxv8XlYJzTH4lg+3BEVw5OfZBXZrArW2uYFJ8zFvGeqmSa3mi8Sd/51xZHwI+RXqF8M
         /gZhJjM8cG3fTnkWtvYhjBbezMbzzDDxvYTfhIb07IJxr66vqy3R/O1Zu/VXdMSOlt+t
         Aacg==
X-Gm-Message-State: ANoB5pmuGl1cIvB/SsYJYyTjMWSu/g1SRNN77LZOWWXWV4ax/3KC4Ukh
        /mjqNUhLsSk2L3chYMiZdQ==
X-Google-Smtp-Source: AA0mqf5Asg0rv13Ipcqg9rT+Nug0on7Ts8fbocO1TgaO81M/DAPYKe31YKDNw3zpbZKo1raYCLWGCQ==
X-Received: by 2002:a17:902:f10c:b0:187:2721:68e1 with SMTP id e12-20020a170902f10c00b00187272168e1mr32523501plb.21.1669647734378;
        Mon, 28 Nov 2022 07:02:14 -0800 (PST)
Received: from fedora.mshome.net ([104.184.156.161])
        by smtp.gmail.com with ESMTPSA id a9-20020a170902ecc900b001886ff82680sm8997928plh.127.2022.11.28.07.02.12
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 28 Nov 2022 07:02:13 -0800 (PST)
From: Gregory Price <gourry.memverge@gmail.com>
X-Google-Original-From: Gregory Price <gregory.price@memverge.com>
To: qemu-devel@nongnu.org
Cc: jonathan.cameron@huawei.com, linux-cxl@vger.kernel.org,
        alison.schofield@intel.com, dave@stgolabs.net,
        a.manzanares@samsung.com, bwidawsk@kernel.org,
        gregory.price@memverge.com, hchkuo@avery-design.com.tw,
        cbrowy@avery-design.com, ira.weiny@intel.com,
        Gregory Price <gourry.memverge@gmail.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>
Subject: [RFC v4 1/3] hw/cxl: Add CXL_CAPACITY_MULTIPLIER definition
Date: Mon, 28 Nov 2022 10:01:55 -0500
Message-Id: <20221128150157.97724-2-gregory.price@memverge.com>
X-Mailer: git-send-email 2.37.3
In-Reply-To: <20221128150157.97724-1-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

From: Gregory Price <gourry.memverge@gmail.com>

Remove usage of magic numbers when accessing capacity fields and replace
with CXL_CAPACITY_MULTIPLIER, matching the kernel definition.

Signed-off-by: Gregory Price <gregory.price@memverge.com>
Reviewed-by: Davidlohr Bueso <dave@stgolabs.net>
Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Signed-off-by: Jonathan Cameron <jonathan.cameron@huawei.com>
---
 hw/cxl/cxl-mailbox-utils.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index 3e23d29e2d..d7543fd5b4 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -15,6 +15,8 @@
 #include "qemu/log.h"
 #include "qemu/uuid.h"
 
+#define CXL_CAPACITY_MULTIPLIER   0x10000000 /* SZ_256M */
+
 /*
  * How to add a new command, example. The command set FOO, with cmd BAR.
  *  1. Add the command set and cmd to the enum.
@@ -267,7 +269,7 @@ static ret_code cmd_firmware_update_get_info(struct cxl_cmd *cmd,
     } QEMU_PACKED *fw_info;
     QEMU_BUILD_BUG_ON(sizeof(*fw_info) != 0x50);
 
-    if (cxl_dstate->pmem_size < (256 << 20)) {
+    if (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
@@ -412,7 +414,7 @@ static ret_code cmd_identify_memory_device(struct cxl_cmd *cmd,
     CXLType3Class *cvc = CXL_TYPE3_GET_CLASS(ct3d);
     uint64_t size = cxl_dstate->pmem_size;
 
-    if (!QEMU_IS_ALIGNED(size, 256 << 20)) {
+    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
@@ -422,8 +424,8 @@ static ret_code cmd_identify_memory_device(struct cxl_cmd *cmd,
     /* PMEM only */
     snprintf(id->fw_revision, 0x10, "BWFW VERSION %02d", 0);
 
-    id->total_capacity = size / (256 << 20);
-    id->persistent_capacity = size / (256 << 20);
+    id->total_capacity = size / CXL_CAPACITY_MULTIPLIER;
+    id->persistent_capacity = size / CXL_CAPACITY_MULTIPLIER;
     id->lsa_size = cvc->get_lsa_size(ct3d);
     id->poison_list_max_mer[1] = 0x1; /* 256 poison records */
 
@@ -444,14 +446,14 @@ static ret_code cmd_ccls_get_partition_info(struct cxl_cmd *cmd,
     QEMU_BUILD_BUG_ON(sizeof(*part_info) != 0x20);
     uint64_t size = cxl_dstate->pmem_size;
 
-    if (!QEMU_IS_ALIGNED(size, 256 << 20)) {
+    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
     /* PMEM only */
     part_info->active_vmem = 0;
     part_info->next_vmem = 0;
-    part_info->active_pmem = size / (256 << 20);
+    part_info->active_pmem = size / CXL_CAPACITY_MULTIPLIER;
     part_info->next_pmem = 0;
 
     *len = sizeof(*part_info);
-- 
2.37.3


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 04C90C43217
	for <linux-cxl@archiver.kernel.org>; Mon, 28 Nov 2022 15:02:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231223AbiK1PCU (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 28 Nov 2022 10:02:20 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50412 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230501AbiK1PCU (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 28 Nov 2022 10:02:20 -0500
Received: from mail-pl1-x644.google.com (mail-pl1-x644.google.com [IPv6:2607:f8b0:4864:20::644])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 08F2122521
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:19 -0800 (PST)
Received: by mail-pl1-x644.google.com with SMTP id jn7so10387912plb.13
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:19 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:from:to:cc:subject:date
         :message-id:reply-to;
        bh=9hD3JWskx463z8JLKarnN8tJtF+i70g6BGCNjkOyahI=;
        b=aXYnzYSZrLZKItaqQyR5woQt+TE7/y0NZh4x/MgPSW90slZ2gnJHnS5PbBUeuCuHR6
         cEahuQcB+M7aHUWsx1M3m50JSTWiM9jyLEoJUasYexM/SocLWfL18BdjjPyfD/Shy1bJ
         PYG7f5XSh4OAldtXFcZMOmUKma/RRRyU5QlKypoqnohBlFCTBbsEYwoJ7cl8Bdaxrpm7
         U1Be+gDNPXUp0Ii086rhLwghEFWv6qruQJFarQAP6tl8TvPc2QKQSvU8tQw00QRnhTIM
         Xw408bD6f9cewGXf3/GN3mVFfUAwCqrUXhqruIQjDGIcu2Mw2Z/cZPSTWscp6HVZDG3t
         Ki9Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=9hD3JWskx463z8JLKarnN8tJtF+i70g6BGCNjkOyahI=;
        b=oUtQ5vANYAP3mVu4rL6aGbrAkkgN69OxIwI8Mr76Ttz3WitV2ivNCTnEunDV/K+EZq
         cJc6dFnXPi5RwqpTLCqOetnEI/3k28tt/uT2+DLQ10Bj/uZnp74FJ0/hcIt+RE8cffSo
         1d10clgYe0bfSLqSWSu892ANFYawXVyhBUh7YMveJOqd8k8JCLlLutjBoBdTMM2FrgRE
         YVlbf1ZXLKsplKemqSU1fNT5rBigNrV5AHjqKte5YcMODjy92IGB5QLSJGmO9Ct4cGub
         ZfG9N6x/HF8XslEjBzPH5yNXbxb9DTC6XgMKaov9/nBbDbVdfbfKR9bA9iRIK/3LNySD
         koBw==
X-Gm-Message-State: ANoB5pkyEzYYPPKQfABJdhVkPxzWh1iQgKYXK3R3DfyrHXCRNxfmqzuW
        S5Xo5kt0YMa2w+JrI/19I5wVFNo1EZi5
X-Google-Smtp-Source: AA0mqf6B3/pu1D4l032e2H/NZQ1mxQcgQM/ErlQ5eHxB64Xt+pSrylggyBAyHN9G/tKGaC6u0Zp7FA==
X-Received: by 2002:a17:902:ec04:b0:189:8c37:6f17 with SMTP id l4-20020a170902ec0400b001898c376f17mr5111507pld.67.1669647737577;
        Mon, 28 Nov 2022 07:02:17 -0800 (PST)
Received: from fedora.mshome.net ([104.184.156.161])
        by smtp.gmail.com with ESMTPSA id a9-20020a170902ecc900b001886ff82680sm8997928plh.127.2022.11.28.07.02.15
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 28 Nov 2022 07:02:17 -0800 (PST)
From: Gregory Price <gourry.memverge@gmail.com>
X-Google-Original-From: Gregory Price <gregory.price@memverge.com>
To: qemu-devel@nongnu.org
Cc: jonathan.cameron@huawei.com, linux-cxl@vger.kernel.org,
        alison.schofield@intel.com, dave@stgolabs.net,
        a.manzanares@samsung.com, bwidawsk@kernel.org,
        gregory.price@memverge.com, hchkuo@avery-design.com.tw,
        cbrowy@avery-design.com, ira.weiny@intel.com
Subject: [RFC v4 2/3] tests/qtest/cxl-test: whitespace, line ending cleanup
Date: Mon, 28 Nov 2022 10:01:56 -0500
Message-Id: <20221128150157.97724-3-gregory.price@memverge.com>
X-Mailer: git-send-email 2.37.3
In-Reply-To: <20221128150157.97724-1-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

Defines are starting to exceed line length limits, align them for
cleanliness before making modifications.

Signed-off-by: Gregory Price <gregory.price@memverge.com>

---
 tests/qtest/cxl-test.c | 99 +++++++++++++++++++++++-------------------
 1 file changed, 54 insertions(+), 45 deletions(-)

diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
index c54f18e76b..e59ba22387 100644
--- a/tests/qtest/cxl-test.c
+++ b/tests/qtest/cxl-test.c
@@ -8,55 +8,64 @@
 #include "qemu/osdep.h"
 #include "libqtest-single.h"
 
-#define QEMU_PXB_CMD "-machine q35,cxl=on " \
-                     "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
-                     "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
-
-#define QEMU_2PXB_CMD "-machine q35,cxl=on "                            \
-                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
-                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
-                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
-
-#define QEMU_VIRT_2PXB_CMD "-machine virt,cxl=on "                      \
-                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
-                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 "  \
-                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
-
-#define QEMU_RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
+#define QEMU_PXB_CMD \
+  "-machine q35,cxl=on " \
+  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
+  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
+
+#define QEMU_2PXB_CMD \
+  "-machine q35,cxl=on " \
+  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
+  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
+ "- M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
+
+#define QEMU_VIRT_2PXB_CMD \
+  "-machine virt,cxl=on " \
+  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
+  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
+  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
+
+#define QEMU_RP \
+  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
 
 /* Dual ports on first pxb */
-#define QEMU_2RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
-                 "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 "
+#define QEMU_2RP \
+  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
+  "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 "
 
 /* Dual ports on each of the pxb instances */
-#define QEMU_4RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
-                 "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 " \
-                 "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
-                 "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
-
-#define QEMU_T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
-                 "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
-                 "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
-
-#define QEMU_2T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M "    \
-                  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
-                  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M "    \
-                  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 "
-
-#define QEMU_4T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
-                  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
-                  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M "    \
-                  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 " \
-                  "-object memory-backend-file,id=cxl-mem2,mem-path=%s,size=256M "    \
-                  "-object memory-backend-file,id=lsa2,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp2,memdev=cxl-mem2,lsa=lsa2,id=cxl-pmem2 " \
-                  "-object memory-backend-file,id=cxl-mem3,mem-path=%s,size=256M "    \
-                  "-object memory-backend-file,id=lsa3,mem-path=%s,size=256M "    \
-                  "-device cxl-type3,bus=rp3,memdev=cxl-mem3,lsa=lsa3,id=cxl-pmem3 "
+#define QEMU_4RP \
+  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
+  "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 " \
+  "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
+  "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
+
+#define QEMU_T3D \
+  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
+  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
+
+#define QEMU_2T3D \
+  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
+  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 "
+
+#define QEMU_4T3D \
+  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
+  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 " \
+  "-object memory-backend-file,id=cxl-mem2,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa2,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp2,memdev=cxl-mem2,lsa=lsa2,id=cxl-pmem2 " \
+  "-object memory-backend-file,id=cxl-mem3,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa3,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp3,memdev=cxl-mem3,lsa=lsa3,id=cxl-pmem3 "
 
 static void cxl_basic_hb(void)
 {
-- 
2.37.3


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8D1F8C433FE
	for <linux-cxl@archiver.kernel.org>; Mon, 28 Nov 2022 15:02:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230501AbiK1PCY (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 28 Nov 2022 10:02:24 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50452 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231542AbiK1PCX (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 28 Nov 2022 10:02:23 -0500
Received: from mail-pl1-x642.google.com (mail-pl1-x642.google.com [IPv6:2607:f8b0:4864:20::642])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 654D72339B
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:21 -0800 (PST)
Received: by mail-pl1-x642.google.com with SMTP id d3so5414659plr.10
        for <linux-cxl@vger.kernel.org>; Mon, 28 Nov 2022 07:02:21 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:from:to:cc:subject:date
         :message-id:reply-to;
        bh=2RmM8Ez5IbghkWBRQRs/E6hpd7YYK9ajyvavSXEFDNM=;
        b=kKnc5uOEEgBCZIsZMTSerG5w89eQem1S1KET96iD7U88YTONh++IVYjrifEZZSU5Qu
         ilBIvKx/F36tlrielcEeqQD9YU0ZyeRnO6uKFuY0/gI458krkC3xYIP4HzcZyaN0VNeN
         9wZsE9/rTku20b3LKgbov2YqO+ybTQ37e7QdIiZYLktzatTk3mBSFTBBhmIcNwhuzSrG
         E+eALDRGnf2IE68V2U/LQaGwSLAm94eEf7gZHcAriAiTTRneWQMZw9nbb6J1uKBm3OEb
         b1xjrnp/JGUNAXt1rIEIXf/Y5zQiB4/VqjtNFlN/wKUi463Wd5OA7QcjttR1RzsguFTR
         oJCw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=2RmM8Ez5IbghkWBRQRs/E6hpd7YYK9ajyvavSXEFDNM=;
        b=fNNzgrsqC4okTg3Xe50KIDkSFSgADQ2sZYjVthrqhxDpU6ROyQAaD/eHuEa2neViWc
         4M/CGUU+viD9Xs42U5wnVBwxy4fZ4WSzOxKLaov8RPzyiJx3gxEDH7IUuosfogpK0H4X
         o9/uCRF38theO+hV6V71GxwPMvFbt/FN4Tj2NUDLZt1b4xgjrc6YoUXse71d8WbszQbz
         2HSSzhaufp9B5cDwZ2qFmEQ6FavssDexbeCGvHfdTqBUopEbPWvWULYCBMXrmJQFB2a6
         PfD6AazTi0epMdBDepPQsSce8cJG5XE0Cd6rvcihasx9yPfkQ4u1Sc3aJVFSntjDE9d/
         eQoQ==
X-Gm-Message-State: ANoB5pn98D/DGpyDsEvpBJgxih23Un1VDqTt6x6wNaLoiP8l2qMSeQOi
        vJBUm5tnCX7bF3v7lrXO5ZeHIXSNjnB2
X-Google-Smtp-Source: AA0mqf7rclHibMjjf2cUydtT4tqfbtOGrJJ2WYXNawOkG41c9+r3x2DDZoGplbcfOslFGl6AsDVv9g==
X-Received: by 2002:a17:902:e80f:b0:188:f571:cea2 with SMTP id u15-20020a170902e80f00b00188f571cea2mr35444285plg.146.1669647740791;
        Mon, 28 Nov 2022 07:02:20 -0800 (PST)
Received: from fedora.mshome.net ([104.184.156.161])
        by smtp.gmail.com with ESMTPSA id a9-20020a170902ecc900b001886ff82680sm8997928plh.127.2022.11.28.07.02.18
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 28 Nov 2022 07:02:20 -0800 (PST)
From: Gregory Price <gourry.memverge@gmail.com>
X-Google-Original-From: Gregory Price <gregory.price@memverge.com>
To: qemu-devel@nongnu.org
Cc: jonathan.cameron@huawei.com, linux-cxl@vger.kernel.org,
        alison.schofield@intel.com, dave@stgolabs.net,
        a.manzanares@samsung.com, bwidawsk@kernel.org,
        gregory.price@memverge.com, hchkuo@avery-design.com.tw,
        cbrowy@avery-design.com, ira.weiny@intel.com,
        Gregory Price <gourry.memverge@gmail.com>,
        Jonathan Cameron <Jonathan.Cameron@huawei.com>
Subject: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile and Persistent)
Date: Mon, 28 Nov 2022 10:01:57 -0500
Message-Id: <20221128150157.97724-4-gregory.price@memverge.com>
X-Mailer: git-send-email 2.37.3
In-Reply-To: <20221128150157.97724-1-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

From: Gregory Price <gourry.memverge@gmail.com>

This commit enables each CXL Type-3 device to contain one volatile
memory region and one persistent region.

Two new properties have been added to cxl-type3 device initialization:
    [volatile-memdev] and [persistent-memdev]

The existing [memdev] property has been deprecated and will default the
memory region to a persistent memory region (although a user may assign
the region to a ram or file backed region). It cannot be used in
combination with the new [persistent-memdev] property.

Partitioning volatile memory from persistent memory is not yet supported.

Volatile memory is mapped at DPA(0x0), while Persistent memory is mapped
at DPA(vmem->size), per CXL Spec 8.2.9.8.2.0 - Get Partition Info.

Signed-off-by: Gregory Price <gregory.price@memverge.com>
Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
---
 docs/system/devices/cxl.rst |  49 ++++--
 hw/cxl/cxl-mailbox-utils.c  |  22 +--
 hw/mem/cxl_type3.c          | 292 +++++++++++++++++++++++++++---------
 include/hw/cxl/cxl_device.h |  11 +-
 tests/qtest/cxl-test.c      |  78 ++++++++--
 5 files changed, 347 insertions(+), 105 deletions(-)

diff --git a/docs/system/devices/cxl.rst b/docs/system/devices/cxl.rst
index f25783a4ec..45639a676a 100644
--- a/docs/system/devices/cxl.rst
+++ b/docs/system/devices/cxl.rst
@@ -300,7 +300,7 @@ Example topology involving a switch::
 
 Example command lines
 ---------------------
-A very simple setup with just one directly attached CXL Type 3 device::
+A very simple setup with just one directly attached CXL Type 3 Persistent Memory device::
 
   qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
   ...
@@ -308,7 +308,28 @@ A very simple setup with just one directly attached CXL Type 3 device::
   -object memory-backend-file,id=cxl-lsa1,share=on,mem-path=/tmp/lsa.raw,size=256M \
   -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
   -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
-  -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
+  -device cxl-type3,bus=root_port13,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
+  -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
+
+A very simple setup with just one directly attached CXL Type 3 Volatile Memory device::
+
+  qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
+  ...
+  -object memory-backend-ram,id=vmem0,share=on,size=256M \
+  -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
+  -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
+  -device cxl-type3,bus=root_port13,volatile-memdev=vmem0,id=cxl-vmem0 \
+  -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
+
+The same volatile setup may optionally include an LSA region::
+
+  qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
+  ...
+  -object memory-backend-ram,id=vmem0,share=on,size=256M \
+  -object memory-backend-file,id=cxl-lsa0,share=on,mem-path=/tmp/lsa.raw,size=256M \
+  -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
+  -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
+  -device cxl-type3,bus=root_port13,volatile-memdev=vmem0,lsa=cxl-lsa0,id=cxl-vmem0 \
   -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
 
 A setup suitable for 4 way interleave. Only one fixed window provided, to enable 2 way
@@ -328,13 +349,13 @@ the CXL Type3 device directly attached (no switches).::
   -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
   -device pxb-cxl,bus_nr=222,bus=pcie.0,id=cxl.2 \
   -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
-  -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
+  -device cxl-type3,bus=root_port13,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
   -device cxl-rp,port=1,bus=cxl.1,id=root_port14,chassis=0,slot=3 \
-  -device cxl-type3,bus=root_port14,memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem1 \
+  -device cxl-type3,bus=root_port14,persistent-memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem1 \
   -device cxl-rp,port=0,bus=cxl.2,id=root_port15,chassis=0,slot=5 \
-  -device cxl-type3,bus=root_port15,memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem2 \
+  -device cxl-type3,bus=root_port15,persistent-memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem2 \
   -device cxl-rp,port=1,bus=cxl.2,id=root_port16,chassis=0,slot=6 \
-  -device cxl-type3,bus=root_port16,memdev=cxl-mem4,lsa=cxl-lsa4,id=cxl-pmem3 \
+  -device cxl-type3,bus=root_port16,persistent-memdev=cxl-mem4,lsa=cxl-lsa4,id=cxl-pmem3 \
   -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.targets.1=cxl.2,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=8k
 
 An example of 4 devices below a switch suitable for 1, 2 or 4 way interleave::
@@ -354,15 +375,23 @@ An example of 4 devices below a switch suitable for 1, 2 or 4 way interleave::
   -device cxl-rp,port=1,bus=cxl.1,id=root_port1,chassis=0,slot=1 \
   -device cxl-upstream,bus=root_port0,id=us0 \
   -device cxl-downstream,port=0,bus=us0,id=swport0,chassis=0,slot=4 \
-  -device cxl-type3,bus=swport0,memdev=cxl-mem0,lsa=cxl-lsa0,id=cxl-pmem0,size=256M \
+  -device cxl-type3,bus=swport0,persistent-memdev=cxl-mem0,lsa=cxl-lsa0,id=cxl-pmem0,size=256M \
   -device cxl-downstream,port=1,bus=us0,id=swport1,chassis=0,slot=5 \
-  -device cxl-type3,bus=swport1,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem1,size=256M \
+  -device cxl-type3,bus=swport1,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem1,size=256M \
   -device cxl-downstream,port=2,bus=us0,id=swport2,chassis=0,slot=6 \
-  -device cxl-type3,bus=swport2,memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem2,size=256M \
+  -device cxl-type3,bus=swport2,persistent-memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem2,size=256M \
   -device cxl-downstream,port=3,bus=us0,id=swport3,chassis=0,slot=7 \
-  -device cxl-type3,bus=swport3,memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem3,size=256M \
+  -device cxl-type3,bus=swport3,persistent-memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem3,size=256M \
   -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=4k
 
+Deprecations
+------------
+
+The Type 3 device [memdev] attribute has been deprecated in favor
+of the [persistent-memdev] and [volatile-memdev] attributes. [memdev]
+will default to a persistent memory device for backward compatibility
+and is incapable of being used in combination with [persistent-memdev].
+
 Kernel Configuration Options
 ----------------------------
 
diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
index d7543fd5b4..44cebb950a 100644
--- a/hw/cxl/cxl-mailbox-utils.c
+++ b/hw/cxl/cxl-mailbox-utils.c
@@ -269,7 +269,8 @@ static ret_code cmd_firmware_update_get_info(struct cxl_cmd *cmd,
     } QEMU_PACKED *fw_info;
     QEMU_BUILD_BUG_ON(sizeof(*fw_info) != 0x50);
 
-    if (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) {
+    if ((cxl_dstate->vmem_size < CXL_CAPACITY_MULTIPLIER) ||
+        (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER)) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
@@ -412,20 +413,20 @@ static ret_code cmd_identify_memory_device(struct cxl_cmd *cmd,
 
     CXLType3Dev *ct3d = container_of(cxl_dstate, CXLType3Dev, cxl_dstate);
     CXLType3Class *cvc = CXL_TYPE3_GET_CLASS(ct3d);
-    uint64_t size = cxl_dstate->pmem_size;
 
-    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
+    if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER)) ||
+        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
     id = (void *)cmd->payload;
     memset(id, 0, sizeof(*id));
 
-    /* PMEM only */
     snprintf(id->fw_revision, 0x10, "BWFW VERSION %02d", 0);
 
-    id->total_capacity = size / CXL_CAPACITY_MULTIPLIER;
-    id->persistent_capacity = size / CXL_CAPACITY_MULTIPLIER;
+    id->total_capacity = cxl_dstate->mem_size / CXL_CAPACITY_MULTIPLIER;
+    id->persistent_capacity = cxl_dstate->pmem_size / CXL_CAPACITY_MULTIPLIER;
+    id->volatile_capacity = cxl_dstate->vmem_size / CXL_CAPACITY_MULTIPLIER;
     id->lsa_size = cvc->get_lsa_size(ct3d);
     id->poison_list_max_mer[1] = 0x1; /* 256 poison records */
 
@@ -444,16 +445,15 @@ static ret_code cmd_ccls_get_partition_info(struct cxl_cmd *cmd,
         uint64_t next_pmem;
     } QEMU_PACKED *part_info = (void *)cmd->payload;
     QEMU_BUILD_BUG_ON(sizeof(*part_info) != 0x20);
-    uint64_t size = cxl_dstate->pmem_size;
 
-    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
+    if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER)) ||
+        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))) {
         return CXL_MBOX_INTERNAL_ERROR;
     }
 
-    /* PMEM only */
-    part_info->active_vmem = 0;
+    part_info->active_vmem = cxl_dstate->vmem_size / CXL_CAPACITY_MULTIPLIER;
     part_info->next_vmem = 0;
-    part_info->active_pmem = size / CXL_CAPACITY_MULTIPLIER;
+    part_info->active_pmem = cxl_dstate->pmem_size / CXL_CAPACITY_MULTIPLIER;
     part_info->next_pmem = 0;
 
     *len = sizeof(*part_info);
diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 0317bd96a6..81dc3def01 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -32,7 +32,8 @@ enum {
 };
 
 static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
-                                         int dsmad_handle, MemoryRegion *mr)
+                                         int dsmad_handle, MemoryRegion *mr,
+                                         bool is_pmem, uint64_t dpa_base)
 {
     g_autofree CDATDsmas *dsmas = NULL;
     g_autofree CDATDslbis *dslbis0 = NULL;
@@ -51,8 +52,8 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
             .length = sizeof(*dsmas),
         },
         .DSMADhandle = dsmad_handle,
-        .flags = CDAT_DSMAS_FLAG_NV,
-        .DPA_base = 0,
+        .flags = is_pmem ? CDAT_DSMAS_FLAG_NV : 0,
+        .DPA_base = dpa_base,
         .DPA_length = int128_get64(mr->size),
     };
 
@@ -151,33 +152,67 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
 static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
 {
     g_autofree CDATSubHeader **table = NULL;
-    MemoryRegion *nonvolatile_mr;
     CXLType3Dev *ct3d = priv;
+    MemoryRegion *volatile_mr = NULL, *nonvolatile_mr = NULL;
     int dsmad_handle = 0;
+    int cur_ent = 0;
+    int len = 0;
     int rc;
 
-    if (!ct3d->hostmem) {
+    if (!ct3d->hostpmem && !ct3d->hostvmem) {
         return 0;
     }
 
-    nonvolatile_mr = host_memory_backend_get_memory(ct3d->hostmem);
-    if (!nonvolatile_mr) {
-        return -EINVAL;
+    if (ct3d->hostvmem) {
+        volatile_mr = host_memory_backend_get_memory(ct3d->hostvmem);
+        if (!volatile_mr) {
+            return -EINVAL;
+        }
+        len += CT3_CDAT_NUM_ENTRIES;
+    }
+
+    if (ct3d->hostpmem) {
+        nonvolatile_mr = host_memory_backend_get_memory(ct3d->hostpmem);
+        if (!nonvolatile_mr) {
+            return -EINVAL;
+        }
+        len += CT3_CDAT_NUM_ENTRIES;
     }
 
-    table = g_malloc0(CT3_CDAT_NUM_ENTRIES * sizeof(*table));
+    table = g_malloc0(len * sizeof(*table));
     if (!table) {
         return -ENOMEM;
     }
 
-    rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, nonvolatile_mr);
-    if (rc < 0) {
-        return rc;
+    /* Now fill them in */
+    if (volatile_mr) {
+        rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
+                                           true, 0);
+        if (rc < 0) {
+            return rc;
+        }
+        cur_ent = CT3_CDAT_NUM_ENTRIES;
+    }
+
+    if (nonvolatile_mr) {
+        rc = ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_handle++,
+                nonvolatile_mr, true, (volatile_mr ? volatile_mr->size : 0));
+        if (rc < 0) {
+            goto error_cleanup;
+        }
+        cur_ent += CT3_CDAT_NUM_ENTRIES;
     }
+    assert(len == cur_ent);
 
     *cdat_table = g_steal_pointer(&table);
 
-    return CT3_CDAT_NUM_ENTRIES;
+    return len;
+error_cleanup:
+    int i;
+    for (i = 0; i < cur_ent; i++) {
+        g_free(table[i]);
+    }
+    return rc;
 }
 
 static void ct3_free_cdat_table(CDATSubHeader **cdat_table, int num, void *priv)
@@ -378,16 +413,48 @@ static void build_dvsecs(CXLType3Dev *ct3d)
     CXLDVSECRegisterLocator *regloc_dvsec;
     uint8_t *dvsec;
     int i;
+    uint32_t range1_size_hi, range1_size_lo,
+             range1_base_hi, range1_base_lo,
+             range2_size_hi = 0, range2_size_lo = 0,
+             range2_base_hi = 0, range2_base_lo = 0;
+
+    /*
+     * Volatile memory is mapped as (0x0)
+     * Persistent memory is mapped at (volatile->size)
+     */
+    if (ct3d->hostvmem) {
+        range1_size_hi = ct3d->hostvmem->size >> 32;
+        range1_size_lo = (2 << 5) | (2 << 2) | 0x3 |
+                         (ct3d->hostvmem->size & 0xF0000000);
+        range1_base_hi = 0;
+        range1_base_lo = 0;
+        if (ct3d->hostpmem) {
+            range2_size_hi = ct3d->hostpmem->size >> 32;
+            range2_size_lo = (2 << 5) | (2 << 2) | 0x3 |
+                             (ct3d->hostpmem->size & 0xF0000000);
+            range2_base_hi = ct3d->hostvmem->size >> 32;
+            range2_base_lo = ct3d->hostvmem->size & 0xF0000000;
+        }
+    } else {
+        range1_size_hi = ct3d->hostpmem->size >> 32;
+        range1_size_lo = (2 << 5) | (2 << 2) | 0x3 |
+                         (ct3d->hostpmem->size & 0xF0000000);
+        range1_base_hi = 0;
+        range1_base_lo = 0;
+    }
 
     dvsec = (uint8_t *)&(CXLDVSECDevice){
         .cap = 0x1e,
         .ctrl = 0x2,
         .status2 = 0x2,
-        .range1_size_hi = ct3d->hostmem->size >> 32,
-        .range1_size_lo = (2 << 5) | (2 << 2) | 0x3 |
-        (ct3d->hostmem->size & 0xF0000000),
-        .range1_base_hi = 0,
-        .range1_base_lo = 0,
+        .range1_size_hi = range1_size_hi,
+        .range1_size_lo = range1_size_lo,
+        .range1_base_hi = range1_base_hi,
+        .range1_base_lo = range1_base_lo,
+        .range2_size_hi = range2_size_hi,
+        .range2_size_lo = range2_size_lo,
+        .range2_base_hi = range2_base_hi,
+        .range2_base_lo = range2_base_lo
     };
     cxl_component_create_dvsec(cxl_cstate, CXL2_TYPE3_DEVICE,
                                PCIE_CXL_DEVICE_DVSEC_LENGTH,
@@ -475,33 +542,62 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
     MemoryRegion *mr;
     char *name;
 
-    if (!ct3d->hostmem) {
-        error_setg(errp, "memdev property must be set");
+    if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem) {
+        error_setg(errp, "at least one memdev property must be set");
         return false;
+    } else if (ct3d->hostmem && ct3d->hostpmem) {
+        error_setg(errp, "[memdev] cannot be used with new "
+                         "[persistent-memdev] property");
+        return false;
+    } else if (ct3d->hostmem) {
+        /* Use of hostmem property implies pmem */
+        ct3d->hostpmem = ct3d->hostmem;
+        ct3d->hostmem = NULL;
     }
 
-    mr = host_memory_backend_get_memory(ct3d->hostmem);
-    if (!mr) {
-        error_setg(errp, "memdev property must be set");
+    if (ct3d->hostpmem && !ct3d->lsa) {
+        error_setg(errp, "lsa property must be set for persistent devices");
         return false;
     }
-    memory_region_set_nonvolatile(mr, true);
-    memory_region_set_enabled(mr, true);
-    host_memory_backend_set_mapped(ct3d->hostmem, true);
 
-    if (ds->id) {
-        name = g_strdup_printf("cxl-type3-dpa-space:%s", ds->id);
-    } else {
-        name = g_strdup("cxl-type3-dpa-space");
+    if (ct3d->hostvmem) {
+        mr = host_memory_backend_get_memory(ct3d->hostvmem);
+        if (!mr) {
+            error_setg(errp, "volatile memdev must have backing device");
+            return false;
+        }
+        memory_region_set_nonvolatile(mr, false);
+        memory_region_set_enabled(mr, true);
+        host_memory_backend_set_mapped(ct3d->hostvmem, true);
+        if (ds->id) {
+            name = g_strdup_printf("cxl-type3-dpa-vmem-space:%s", ds->id);
+        } else {
+            name = g_strdup("cxl-type3-dpa-vmem-space");
+        }
+        address_space_init(&ct3d->hostvmem_as, mr, name);
+        ct3d->cxl_dstate.vmem_size = mr->size;
+        ct3d->cxl_dstate.mem_size += mr->size;
+        g_free(name);
     }
-    address_space_init(&ct3d->hostmem_as, mr, name);
-    g_free(name);
-
-    ct3d->cxl_dstate.pmem_size = ct3d->hostmem->size;
 
-    if (!ct3d->lsa) {
-        error_setg(errp, "lsa property must be set");
-        return false;
+    if (ct3d->hostpmem) {
+        mr = host_memory_backend_get_memory(ct3d->hostpmem);
+        if (!mr) {
+            error_setg(errp, "persistent memdev must have backing device");
+            return false;
+        }
+        memory_region_set_nonvolatile(mr, true);
+        memory_region_set_enabled(mr, true);
+        host_memory_backend_set_mapped(ct3d->hostpmem, true);
+        if (ds->id) {
+            name = g_strdup_printf("cxl-type3-dpa-pmem-space:%s", ds->id);
+        } else {
+            name = g_strdup("cxl-type3-dpa-pmem-space");
+        }
+        address_space_init(&ct3d->hostpmem_as, mr, name);
+        ct3d->cxl_dstate.pmem_size = mr->size;
+        ct3d->cxl_dstate.mem_size += mr->size;
+        g_free(name);
     }
 
     return true;
@@ -609,7 +705,12 @@ err_free_spdm_socket:
 err_free_special_ops:
     g_free(regs->special_ops);
 err_address_space_free:
-    address_space_destroy(&ct3d->hostmem_as);
+    if (ct3d->hostvmem) {
+        address_space_destroy(&ct3d->hostvmem_as);
+    }
+    if (ct3d->hostpmem) {
+        address_space_destroy(&ct3d->hostpmem_as);
+    }
     return;
 }
 
@@ -623,7 +724,12 @@ static void ct3_exit(PCIDevice *pci_dev)
     cxl_doe_cdat_release(cxl_cstate);
     spdm_sock_fini(ct3d->doe_spdm.socket);
     g_free(regs->special_ops);
-    address_space_destroy(&ct3d->hostmem_as);
+    if (ct3d->hostvmem) {
+        address_space_destroy(&ct3d->hostvmem_as);
+    }
+    if (ct3d->hostpmem) {
+        address_space_destroy(&ct3d->hostpmem_as);
+    }
 }
 
 /* TODO: Support multiple HDM decoders and DPA skip */
@@ -663,11 +769,17 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
 {
     CXLType3Dev *ct3d = CXL_TYPE3(d);
     uint64_t dpa_offset;
-    MemoryRegion *mr;
+    MemoryRegion *vmr = NULL, *pmr = NULL;
+    AddressSpace *as;
 
-    /* TODO support volatile region */
-    mr = host_memory_backend_get_memory(ct3d->hostmem);
-    if (!mr) {
+    if (ct3d->hostvmem) {
+        vmr = host_memory_backend_get_memory(ct3d->hostvmem);
+    }
+    if (ct3d->hostpmem) {
+        pmr = host_memory_backend_get_memory(ct3d->hostpmem);
+    }
+
+    if (!vmr && !pmr) {
         return MEMTX_ERROR;
     }
 
@@ -675,11 +787,22 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
         return MEMTX_ERROR;
     }
 
-    if (dpa_offset > int128_get64(mr->size)) {
+    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
         return MEMTX_ERROR;
     }
 
-    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data, size);
+    if (vmr) {
+        if (dpa_offset <= int128_get64(vmr->size)) {
+            as = &ct3d->hostvmem_as;
+        } else {
+            as = &ct3d->hostpmem_as;
+            dpa_offset -= vmr->size;
+        }
+    }
+    else {
+        as = &ct3d->hostpmem_as;
+    }
+    return address_space_read(as, dpa_offset, attrs, data, size);
 }
 
 MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
@@ -687,10 +810,17 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
 {
     CXLType3Dev *ct3d = CXL_TYPE3(d);
     uint64_t dpa_offset;
-    MemoryRegion *mr;
+    MemoryRegion *vmr = NULL, *pmr = NULL;
+    AddressSpace *as;
 
-    mr = host_memory_backend_get_memory(ct3d->hostmem);
-    if (!mr) {
+    if (ct3d->hostvmem) {
+        vmr = host_memory_backend_get_memory(ct3d->hostvmem);
+    }
+    if (ct3d->hostpmem) {
+        pmr = host_memory_backend_get_memory(ct3d->hostpmem);
+    }
+
+    if (!vmr && !pmr) {
         return MEMTX_OK;
     }
 
@@ -698,11 +828,22 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
         return MEMTX_OK;
     }
 
-    if (dpa_offset > int128_get64(mr->size)) {
+    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
         return MEMTX_OK;
     }
-    return address_space_write(&ct3d->hostmem_as, dpa_offset, attrs,
-                               &data, size);
+
+    if (vmr) {
+        if (dpa_offset <= int128_get64(vmr->size)) {
+            as = &ct3d->hostvmem_as;
+        } else {
+            as = &ct3d->hostpmem_as;
+            dpa_offset -= vmr->size;
+        }
+    }
+    else {
+        as = &ct3d->hostpmem_as;
+    }
+    return address_space_write(as, dpa_offset, attrs, &data, size);
 }
 
 static void ct3d_reset(DeviceState *dev)
@@ -717,7 +858,11 @@ static void ct3d_reset(DeviceState *dev)
 
 static Property ct3_props[] = {
     DEFINE_PROP_LINK("memdev", CXLType3Dev, hostmem, TYPE_MEMORY_BACKEND,
-                     HostMemoryBackend *),
+                     HostMemoryBackend *), /* for backward compatibility */
+    DEFINE_PROP_LINK("persistent-memdev", CXLType3Dev, hostpmem,
+                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
+    DEFINE_PROP_LINK("volatile-memdev", CXLType3Dev, hostvmem,
+                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
     DEFINE_PROP_LINK("lsa", CXLType3Dev, lsa, TYPE_MEMORY_BACKEND,
                      HostMemoryBackend *),
     DEFINE_PROP_UINT64("sn", CXLType3Dev, sn, UI64_NULL),
@@ -728,10 +873,12 @@ static Property ct3_props[] = {
 
 static uint64_t get_lsa_size(CXLType3Dev *ct3d)
 {
-    MemoryRegion *mr;
-
-    mr = host_memory_backend_get_memory(ct3d->lsa);
-    return memory_region_size(mr);
+    MemoryRegion *mr = NULL;
+    if (ct3d->lsa) {
+        mr = host_memory_backend_get_memory(ct3d->lsa);
+        return memory_region_size(mr);
+    }
+    return 0;
 }
 
 static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
@@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
 static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
                     uint64_t offset)
 {
-    MemoryRegion *mr;
+    MemoryRegion *mr = NULL;
     void *lsa;
 
-    mr = host_memory_backend_get_memory(ct3d->lsa);
-    validate_lsa_access(mr, size, offset);
+    if (ct3d->lsa) {
+        mr = host_memory_backend_get_memory(ct3d->lsa);
+        validate_lsa_access(mr, size, offset);
 
-    lsa = memory_region_get_ram_ptr(mr) + offset;
-    memcpy(buf, lsa, size);
+        lsa = memory_region_get_ram_ptr(mr) + offset;
+        memcpy(buf, lsa, size);
+        return size;
+    }
 
-    return size;
+    return 0;
 }
 
 static void set_lsa(CXLType3Dev *ct3d, const void *buf, uint64_t size,
                     uint64_t offset)
 {
-    MemoryRegion *mr;
-    void *lsa;
+    MemoryRegion *mr = NULL;
+    void *lsa = NULL;
 
-    mr = host_memory_backend_get_memory(ct3d->lsa);
-    validate_lsa_access(mr, size, offset);
+    if (ct3d->lsa) {
+        mr = host_memory_backend_get_memory(ct3d->lsa);
+        validate_lsa_access(mr, size, offset);
 
-    lsa = memory_region_get_ram_ptr(mr) + offset;
-    memcpy(lsa, buf, size);
-    memory_region_set_dirty(mr, offset, size);
+        lsa = memory_region_get_ram_ptr(mr) + offset;
+        memcpy(lsa, buf, size);
+        memory_region_set_dirty(mr, offset, size);
+    }
 
     /*
      * Just like the PMEM, if the guest is not allowed to exit gracefully, label
@@ -978,7 +1130,7 @@ static void ct3_class_init(ObjectClass *oc, void *data)
     pc->config_read = ct3d_config_read;
 
     set_bit(DEVICE_CATEGORY_STORAGE, dc->categories);
-    dc->desc = "CXL PMEM Device (Type 3)";
+    dc->desc = "CXL Memory Device (Type 3)";
     dc->reset = ct3d_reset;
     device_class_set_props(dc, ct3_props);
 
diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
index 1cd71afcb6..1b366b739c 100644
--- a/include/hw/cxl/cxl_device.h
+++ b/include/hw/cxl/cxl_device.h
@@ -180,8 +180,10 @@ typedef struct cxl_device_state {
         uint64_t host_set;
     } timestamp;
 
-    /* memory region for persistent memory, HDM */
+    /* memory region size, HDM */
+    uint64_t mem_size;
     uint64_t pmem_size;
+    uint64_t vmem_size;
 
     struct cxl_cmd (*cxl_cmd_set)[256];
     /* Move me later */
@@ -311,12 +313,15 @@ struct CXLType3Dev {
     PCIDevice parent_obj;
 
     /* Properties */
-    HostMemoryBackend *hostmem;
+    HostMemoryBackend *hostmem; /* deprecated */
+    HostMemoryBackend *hostvmem;
+    HostMemoryBackend *hostpmem;
     HostMemoryBackend *lsa;
     uint64_t sn;
 
     /* State */
-    AddressSpace hostmem_as;
+    AddressSpace hostvmem_as;
+    AddressSpace hostpmem_as;
     CXLComponentState cxl_cstate;
     CXLDeviceState cxl_dstate;
 
diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
index e59ba22387..6893f54e28 100644
--- a/tests/qtest/cxl-test.c
+++ b/tests/qtest/cxl-test.c
@@ -40,32 +40,46 @@
   "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
   "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
 
-#define QEMU_T3D \
+#define QEMU_T3D_DEPRECATED \
   "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
-  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
   "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
 
+#define QEMU_T3D_PMEM \
+  "-object memory-backend-file,id=m0,mem-path=%s,size=256M " \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp0,persistent-memdev=cxl-m0,lsa=lsa0,id=pmem0 "
+
+#define QEMU_T3D_VMEM \
+  "-object memory-backend-ram,id=mem0,size=256M " \
+  "-device cxl-type3,bus=rp0,volatile-memdev=mem0,id=mem0 "
+
+#define QEMU_T3D_VMEM_LSA \
+  "-object memory-backend-ram,id=mem0,size=256M " \
+  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
+  "-device cxl-type3,bus=rp0,volatile-memdev=mem0,lsa=lsa0,id=mem0 "
+
 #define QEMU_2T3D \
   "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
+  "-device cxl-type3,bus=rp0,persistent-memdev=cxl-mem0,lsa=lsa0,id=pmem0 " \
   "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 "
+  "-device cxl-type3,bus=rp1,persistent-memdev=cxl-mem1,lsa=lsa1,id=pmem1 "
 
 #define QEMU_4T3D \
   "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
+  "-device cxl-type3,bus=rp0,persistent-memdev=cxl-mem0,lsa=lsa0,id=pmem0 " \
   "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 " \
+  "-device cxl-type3,bus=rp1,persistent-memdev=cxl-mem1,lsa=lsa1,id=pmem1 " \
   "-object memory-backend-file,id=cxl-mem2,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa2,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp2,memdev=cxl-mem2,lsa=lsa2,id=cxl-pmem2 " \
+  "-device cxl-type3,bus=rp2,persistent-memdev=cxl-mem2,lsa=lsa2,id=pmem2 " \
   "-object memory-backend-file,id=cxl-mem3,mem-path=%s,size=256M " \
   "-object memory-backend-file,id=lsa3,mem-path=%s,size=256M " \
-  "-device cxl-type3,bus=rp3,memdev=cxl-mem3,lsa=lsa3,id=cxl-pmem3 "
+  "-device cxl-type3,bus=rp3,persistent-memdev=cxl-mem3,lsa=lsa3,id=pmem3 "
 
 static void cxl_basic_hb(void)
 {
@@ -104,14 +118,53 @@ static void cxl_2root_port(void)
 }
 
 #ifdef CONFIG_POSIX
-static void cxl_t3d(void)
+static void cxl_t3d_deprecated(void)
+{
+    g_autoptr(GString) cmdline = g_string_new(NULL);
+    g_autofree const char *tmpfs = NULL;
+
+    tmpfs = g_dir_make_tmp("cxl-test-XXXXXX", NULL);
+
+    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_DEPRECATED,
+                    tmpfs, tmpfs);
+
+    qtest_start(cmdline->str);
+    qtest_end();
+}
+
+static void cxl_t3d_persistent(void)
+{
+    g_autoptr(GString) cmdline = g_string_new(NULL);
+    g_autofree const char *tmpfs = NULL;
+
+    tmpfs = g_dir_make_tmp("cxl-test-XXXXXX", NULL);
+
+    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_PMEM,
+                    tmpfs, tmpfs);
+
+    qtest_start(cmdline->str);
+    qtest_end();
+}
+
+static void cxl_t3d_volatile(void)
+{
+    g_autoptr(GString) cmdline = g_string_new(NULL);
+
+    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_VMEM);
+
+    qtest_start(cmdline->str);
+    qtest_end();
+}
+
+static void cxl_t3d_volatile_lsa(void)
 {
     g_autoptr(GString) cmdline = g_string_new(NULL);
     g_autofree const char *tmpfs = NULL;
 
     tmpfs = g_dir_make_tmp("cxl-test-XXXXXX", NULL);
 
-    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D, tmpfs, tmpfs);
+    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_VMEM_LSA,
+                    tmpfs);
 
     qtest_start(cmdline->str);
     qtest_end();
@@ -179,7 +232,10 @@ int main(int argc, char **argv)
         qtest_add_func("/pci/cxl/rp", cxl_root_port);
         qtest_add_func("/pci/cxl/rp_x2", cxl_2root_port);
 #ifdef CONFIG_POSIX
-        qtest_add_func("/pci/cxl/type3_device", cxl_t3d);
+        qtest_add_func("/pci/cxl/type3_device", cxl_t3d_deprecated);
+        qtest_add_func("/pci/cxl/type3_device_pmem", cxl_t3d_persistent);
+        qtest_add_func("/pci/cxl/type3_device_vmem", cxl_t3d_volatile);
+        qtest_add_func("/pci/cxl/type3_device_vmem_lsa", cxl_t3d_volatile_lsa);
         qtest_add_func("/pci/cxl/rp_x2_type3_x2", cxl_1pxb_2rp_2t3d);
         qtest_add_func("/pci/cxl/pxb_x2_root_port_x4_type3_x4",
                        cxl_2pxb_4rp_4t3d);
-- 
2.37.3


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 7BDDBC4332F
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Dec 2022 22:57:07 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229715AbiLHW4g (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Dec 2022 17:56:36 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43448 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230155AbiLHW4H (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Dec 2022 17:56:07 -0500
Received: from mailout1.w2.samsung.com (mailout1.w2.samsung.com [211.189.100.11])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5E00975BF3
        for <linux-cxl@vger.kernel.org>; Thu,  8 Dec 2022 14:56:02 -0800 (PST)
Received: from uscas1p1.samsung.com (unknown [182.198.245.206])
        by mailout1.w2.samsung.com (KnoxPortal) with ESMTP id 20221208225600usoutp01dd38b1c5514a2b230306b4dbc9ad57a1~u82y56DpZ1962919629usoutp01N;
        Thu,  8 Dec 2022 22:56:00 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout1.w2.samsung.com 20221208225600usoutp01dd38b1c5514a2b230306b4dbc9ad57a1~u82y56DpZ1962919629usoutp01N
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1670540160;
        bh=ocsYp28Tth+3zD5MLF5QT9tb+Rg9WD1gFA4PZyZC4mc=;
        h=From:To:CC:Subject:Date:In-Reply-To:References:From;
        b=LEeGCQS9sNg78rCMQ8LYpAnwSV6Epv3CNO++6GQYAv26IXasCtgK2idftwfPkloSa
         NyNxFq30JiLOD6OUtqs1+9iHOO5akGQjEHN9r8IS22YMhbpf9DSBDpnDBxxuISsoFD
         IU7Kb1S2XegE8sZaIwi0PVHwNzu1Gc9vpIY13GRU=
Received: from ussmges3new.samsung.com (u112.gpu85.samsung.co.kr
        [203.254.195.112]) by uscas1p2.samsung.com (KnoxPortal) with ESMTP id
        20221208225559uscas1p2d6c077b638b1972e49b83f4016a05450~u82yU7irG1552415524uscas1p2r;
        Thu,  8 Dec 2022 22:55:59 +0000 (GMT)
Received: from uscas1p2.samsung.com ( [182.198.245.207]) by
        ussmges3new.samsung.com (USCPEMTA) with SMTP id 20.7F.09913.F7B62936; Thu, 
        8 Dec 2022 17:55:59 -0500 (EST)
Received: from ussmgxs2new.samsung.com (u91.gpu85.samsung.co.kr
        [203.254.195.91]) by uscas1p1.samsung.com (KnoxPortal) with ESMTP id
        20221208225559uscas1p1e9e2c7c8f9a1654a5f41cef2c47859a8~u82x4lxh53169031690uscas1p1_;
        Thu,  8 Dec 2022 22:55:59 +0000 (GMT)
X-AuditID: cbfec370-75dff700000026b9-a7-63926b7f7bc2
Received: from SSI-EX4.ssi.samsung.com ( [105.128.2.146]) by
        ussmgxs2new.samsung.com (USCPEXMTA) with SMTP id 5B.0F.09775.E7B62936; Thu, 
        8 Dec 2022 17:55:58 -0500 (EST)
Received: from SSI-EX2.ssi.samsung.com (105.128.2.227) by
        SSI-EX4.ssi.samsung.com (105.128.2.229) with Microsoft SMTP Server
        (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
        15.1.2375.24; Thu, 8 Dec 2022 14:55:58 -0800
Received: from SSI-EX2.ssi.samsung.com ([105.128.2.227]) by
        SSI-EX2.ssi.samsung.com ([105.128.2.227]) with mapi id 15.01.2375.024; Thu,
        8 Dec 2022 14:55:58 -0800
From: Fan Ni <fan.ni@samsung.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "alison.schofield@intel.com" <alison.schofield@intel.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "bwidawsk@kernel.org" <bwidawsk@kernel.org>,
        "gregory.price@memverge.com" <gregory.price@memverge.com>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Thread-Topic: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
        and Persistent)
Thread-Index: AQHZC1g8x4Cae0a18kydNyc5okwvVQ==
Date: Thu, 8 Dec 2022 22:55:58 +0000
Message-ID: <20221208225515.GA2510517@bgt-140510-bm03>
In-Reply-To: <20221128150157.97724-4-gregory.price@memverge.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [105.128.2.176]
Content-Type: text/plain; charset="iso-8859-1"
Content-ID: <78375C6CD99D5F479807009127196A3D@ssi.samsung.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFrrNKsWRmVeSWpSXmKPExsWy7djX87r12ZOSDTpviVjcfXyBzaJ58mJG
        i+7zGxgtVt9cw2jx4s9zJouGpkcsFi273zNZ7H/6nMVi1cJrbBbnZ51isTjeu4PFgdvjwuQJ
        rB6LG1w9ds66y+7RcuQtkLfnJZPHplWdbB4bP/5n93hybTOTx9TZ9R6fN8kFcEVx2aSk5mSW
        pRbp2yVwZSyZf4m54HEfU8Wc9naWBsb5Fxi7GDk5JARMJC7/uc/SxcjFISSwklFiW99+Jgin
        lUniysGD7DBVy37/YYRIrGWUeLLpMhuE85FR4kTjW1YIZymjxN/2q2wgLWwCihL7uraD2SIC
        uhI7Og+DdTALXGCROP7uMNAsDg5hgViJ1i4+iJo4iQlbJ0DV60lMevqOCcRmEVCReNZ1Eczm
        FTCTaL52BOwkTgEHiSOznoLVMwqISXw/tQashllAXOLWk/lMEGcLSiyavYcZwhaT+LfrIRuE
        rShx//tLdoh6PYkbU6ewQdh2EhOavrBC2NoSyxa+ZobYKyhxcuYTFoheSYmDK26AA0xCYDqn
        xLuPK6Fh5CJxcfdhqGXSEn/vLoM6olriTM85JoiGFkaJS42boYqsJf51XmOfwKgyC8nhs5Ac
        NQvJUbOQHDULyVELGFlXMYqXFhfnpqcWG+ellusVJ+YWl+al6yXn525iBKa/0/8OF+xgvHXr
        o94hRiYOxkOMEhzMSiK8y5ZNTBbiTUmsrEotyo8vKs1JLT7EKM3BoiTOu2ZKR7KQQHpiSWp2
        ampBahFMlomDU6qBKXXhuvki7XmL3BZ3XledUz65vu6I8mMntfXOTJs+v0+erXJ2+bov/8tb
        zDNm7Ctj+aqvtzb4rM3PgC9BgRlbLv7c7nD89zXpwLsrAxYIXC2eojvbavP1SRv/NJr+aOo9
        IWo3+/i0U8d3Oz6teqzZ5Oe5LKLpneijiOXmxxteMNio1axt2aCjm/Ao6+eX9ZM4j2QorbrC
        9UGJr6Rw+eU0hg+i7ct9FU7YnT3n67570sWpfztE3JR19FddmNXuem1H/Q/TCD2Vma9f9fLJ
        b1qx51Hi2p/6/d3z36/1uP5SeoLMj47bNUc+8Yq7VZkVyK261lQ/40rQT41X4T+fzeTPZBSO
        DT0+91va1nMTYs3F3qxTYinOSDTUYi4qTgQAwUbW1O4DAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFvrOIsWRmVeSWpSXmKPExsWS2cA0Sbcue1KywcerphZ3H19gs2ievJjR
        ovv8BkaL1TfXMFq8+POcyaKh6RGLRcvu90wW+58+Z7FYtfAam8X5WadYLI737mBx4Pa4MHkC
        q8fiBlePnbPusnu0HHkL5O15yeSxaVUnm8fGj//ZPZ5c28zkMXV2vcfnTXIBXFFcNimpOZll
        qUX6dglcGUvmX2IueNzHVDGnvZ2lgXH+BcYuRk4OCQETiWW//wDZXBxCAqsZJSYseQnlfGSU
        WLXsDxOEs5RR4tq6iWwgLWwCihL7uraD2SICuhI7Og+zgRQxC1xgkTj+7jBQOweHsECsRGsX
        H0RNnMTc87tYIWw9iUlP3zGB2CwCKhLPui6C2bwCZhLN146wg9hCAqUSR1sXgcU5BRwkjsx6
        CraLUUBM4vupNWBxZgFxiVtP5jNBvCAgsWTPeWYIW1Ti5eN/rBC2osT97y/ZIer1JG5MncIG
        YdtJTGj6wgpha0ssW/iaGeIGQYmTM5+wQPRKShxccYNlAqPELCTrZiEZNQvJqFlIRs1CMmoB
        I+sqRvHS4uLc9Ipio7zUcr3ixNzi0rx0veT83E2MwLRx+t/h6B2Mt2991DvEyMTBeIhRgoNZ
        SYR32bKJyUK8KYmVValF+fFFpTmpxYcYpTlYlMR5X0ZNjBcSSE8sSc1OTS1ILYLJMnFwSjUw
        GV2use+w7eBScEx358zoKDNbct6+s+v4nbIGjkuuf9le/vGaXmXq6OLR08EWKzx37rUa9r/F
        zK8F9ZkONm7UKgrUbrxzI69tA9+Co2d7DTPijDR311RcvPWJ+c7UqMtPNliGe/Bff+ql7XFv
        G+sl7efLVThuNpVyGfPlr7c+efnD8zMTTe/Mi1q0+fv3K2lmSr9+aBadf73qktMSzT8fxfiD
        Er6u5V7LHLX4zduiOsYd0y5wTvKu1j1zW+LZ1Ll72FdKWZZlZh/ePfuVjPkrTZdlWZsiDErd
        1AQn2B402nGx4cmqukMr3jQ2zfup4bvVuLf9nAH7BO1ollsb+o6Ez803Dl26UnzFNO5k/6o5
        SizFGYmGWsxFxYkAe5pMpIoDAAA=
X-CMS-MailID: 20221208225559uscas1p1e9e2c7c8f9a1654a5f41cef2c47859a8
CMS-TYPE: 301P
X-CMS-RootMailID: 20221208225559uscas1p1e9e2c7c8f9a1654a5f41cef2c47859a8
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
        <CGME20221208225559uscas1p1e9e2c7c8f9a1654a5f41cef2c47859a8@uscas1p1.samsung.com>
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, Nov 28, 2022 at 10:01:57AM -0500, Gregory Price wrote:

> From: Gregory Price <gourry.memverge@gmail.com>
>=20
> This commit enables each CXL Type-3 device to contain one volatile
> memory region and one persistent region.
>=20
> Two new properties have been added to cxl-type3 device initialization:
>     [volatile-memdev] and [persistent-memdev]
>=20
> The existing [memdev] property has been deprecated and will default the
> memory region to a persistent memory region (although a user may assign
> the region to a ram or file backed region). It cannot be used in
> combination with the new [persistent-memdev] property.
>=20
> Partitioning volatile memory from persistent memory is not yet supported.
>=20
> Volatile memory is mapped at DPA(0x0), while Persistent memory is mapped
> at DPA(vmem->size), per CXL Spec 8.2.9.8.2.0 - Get Partition Info.
>=20
> Signed-off-by: Gregory Price <gregory.price@memverge.com>
> Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
> ---
>  docs/system/devices/cxl.rst |  49 ++++--
>  hw/cxl/cxl-mailbox-utils.c  |  22 +--
>  hw/mem/cxl_type3.c          | 292 +++++++++++++++++++++++++++---------
>  include/hw/cxl/cxl_device.h |  11 +-
>  tests/qtest/cxl-test.c      |  78 ++++++++--
>  5 files changed, 347 insertions(+), 105 deletions(-)
>=20
> diff --git a/docs/system/devices/cxl.rst b/docs/system/devices/cxl.rst
> index f25783a4ec..45639a676a 100644
> --- a/docs/system/devices/cxl.rst
> +++ b/docs/system/devices/cxl.rst
> @@ -300,7 +300,7 @@ Example topology involving a switch::
> =20
>  Example command lines
>  ---------------------
> -A very simple setup with just one directly attached CXL Type 3 device::
> +A very simple setup with just one directly attached CXL Type 3 Persisten=
t Memory device::
> =20
>    qemu-system-aarch64 -M virt,gic-version=3D3,cxl=3Don -m 4g,maxmem=3D8G=
,slots=3D8 -cpu max \
>    ...
> @@ -308,7 +308,28 @@ A very simple setup with just one directly attached =
CXL Type 3 device::
>    -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3D/tmp/l=
sa.raw,size=3D256M \
>    -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
>    -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> -  -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,i=
d=3Dcxl-pmem0 \
> +  -device cxl-type3,bus=3Droot_port13,persistent-memdev=3Dcxl-mem1,lsa=
=3Dcxl-lsa1,id=3Dcxl-pmem0 \
> +  -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G
> +
> +A very simple setup with just one directly attached CXL Type 3 Volatile =
Memory device::
> +
> +  qemu-system-aarch64 -M virt,gic-version=3D3,cxl=3Don -m 4g,maxmem=3D8G=
,slots=3D8 -cpu max \
> +  ...
> +  -object memory-backend-ram,id=3Dvmem0,share=3Don,size=3D256M \
> +  -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
> +  -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> +  -device cxl-type3,bus=3Droot_port13,volatile-memdev=3Dvmem0,id=3Dcxl-v=
mem0 \
> +  -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G
> +
> +The same volatile setup may optionally include an LSA region::
> +
> +  qemu-system-aarch64 -M virt,gic-version=3D3,cxl=3Don -m 4g,maxmem=3D8G=
,slots=3D8 -cpu max \
> +  ...
> +  -object memory-backend-ram,id=3Dvmem0,share=3Don,size=3D256M \
> +  -object memory-backend-file,id=3Dcxl-lsa0,share=3Don,mem-path=3D/tmp/l=
sa.raw,size=3D256M \
> +  -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
> +  -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> +  -device cxl-type3,bus=3Droot_port13,volatile-memdev=3Dvmem0,lsa=3Dcxl-=
lsa0,id=3Dcxl-vmem0 \
>    -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G
> =20
>  A setup suitable for 4 way interleave. Only one fixed window provided, t=
o enable 2 way
> @@ -328,13 +349,13 @@ the CXL Type3 device directly attached (no switches=
).::
>    -device pxb-cxl,bus_nr=3D12,bus=3Dpcie.0,id=3Dcxl.1 \
>    -device pxb-cxl,bus_nr=3D222,bus=3Dpcie.0,id=3Dcxl.2 \
>    -device cxl-rp,port=3D0,bus=3Dcxl.1,id=3Droot_port13,chassis=3D0,slot=
=3D2 \
> -  -device cxl-type3,bus=3Droot_port13,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,i=
d=3Dcxl-pmem0 \
> +  -device cxl-type3,bus=3Droot_port13,persistent-memdev=3Dcxl-mem1,lsa=
=3Dcxl-lsa1,id=3Dcxl-pmem0 \
>    -device cxl-rp,port=3D1,bus=3Dcxl.1,id=3Droot_port14,chassis=3D0,slot=
=3D3 \
> -  -device cxl-type3,bus=3Droot_port14,memdev=3Dcxl-mem2,lsa=3Dcxl-lsa2,i=
d=3Dcxl-pmem1 \
> +  -device cxl-type3,bus=3Droot_port14,persistent-memdev=3Dcxl-mem2,lsa=
=3Dcxl-lsa2,id=3Dcxl-pmem1 \
>    -device cxl-rp,port=3D0,bus=3Dcxl.2,id=3Droot_port15,chassis=3D0,slot=
=3D5 \
> -  -device cxl-type3,bus=3Droot_port15,memdev=3Dcxl-mem3,lsa=3Dcxl-lsa3,i=
d=3Dcxl-pmem2 \
> +  -device cxl-type3,bus=3Droot_port15,persistent-memdev=3Dcxl-mem3,lsa=
=3Dcxl-lsa3,id=3Dcxl-pmem2 \
>    -device cxl-rp,port=3D1,bus=3Dcxl.2,id=3Droot_port16,chassis=3D0,slot=
=3D6 \
> -  -device cxl-type3,bus=3Droot_port16,memdev=3Dcxl-mem4,lsa=3Dcxl-lsa4,i=
d=3Dcxl-pmem3 \
> +  -device cxl-type3,bus=3Droot_port16,persistent-memdev=3Dcxl-mem4,lsa=
=3Dcxl-lsa4,id=3Dcxl-pmem3 \
>    -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.targets.1=3Dcxl.2,cxl-fmw.0.s=
ize=3D4G,cxl-fmw.0.interleave-granularity=3D8k
> =20
>  An example of 4 devices below a switch suitable for 1, 2 or 4 way interl=
eave::
> @@ -354,15 +375,23 @@ An example of 4 devices below a switch suitable for=
 1, 2 or 4 way interleave::
>    -device cxl-rp,port=3D1,bus=3Dcxl.1,id=3Droot_port1,chassis=3D0,slot=
=3D1 \
>    -device cxl-upstream,bus=3Droot_port0,id=3Dus0 \
>    -device cxl-downstream,port=3D0,bus=3Dus0,id=3Dswport0,chassis=3D0,slo=
t=3D4 \
> -  -device cxl-type3,bus=3Dswport0,memdev=3Dcxl-mem0,lsa=3Dcxl-lsa0,id=3D=
cxl-pmem0,size=3D256M \
> +  -device cxl-type3,bus=3Dswport0,persistent-memdev=3Dcxl-mem0,lsa=3Dcxl=
-lsa0,id=3Dcxl-pmem0,size=3D256M \
>    -device cxl-downstream,port=3D1,bus=3Dus0,id=3Dswport1,chassis=3D0,slo=
t=3D5 \
> -  -device cxl-type3,bus=3Dswport1,memdev=3Dcxl-mem1,lsa=3Dcxl-lsa1,id=3D=
cxl-pmem1,size=3D256M \
> +  -device cxl-type3,bus=3Dswport1,persistent-memdev=3Dcxl-mem1,lsa=3Dcxl=
-lsa1,id=3Dcxl-pmem1,size=3D256M \
>    -device cxl-downstream,port=3D2,bus=3Dus0,id=3Dswport2,chassis=3D0,slo=
t=3D6 \
> -  -device cxl-type3,bus=3Dswport2,memdev=3Dcxl-mem2,lsa=3Dcxl-lsa2,id=3D=
cxl-pmem2,size=3D256M \
> +  -device cxl-type3,bus=3Dswport2,persistent-memdev=3Dcxl-mem2,lsa=3Dcxl=
-lsa2,id=3Dcxl-pmem2,size=3D256M \
>    -device cxl-downstream,port=3D3,bus=3Dus0,id=3Dswport3,chassis=3D0,slo=
t=3D7 \
> -  -device cxl-type3,bus=3Dswport3,memdev=3Dcxl-mem3,lsa=3Dcxl-lsa3,id=3D=
cxl-pmem3,size=3D256M \
> +  -device cxl-type3,bus=3Dswport3,persistent-memdev=3Dcxl-mem3,lsa=3Dcxl=
-lsa3,id=3Dcxl-pmem3,size=3D256M \
>    -M cxl-fmw.0.targets.0=3Dcxl.1,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleav=
e-granularity=3D4k
> =20
> +Deprecations
> +------------
> +
> +The Type 3 device [memdev] attribute has been deprecated in favor
> +of the [persistent-memdev] and [volatile-memdev] attributes. [memdev]
> +will default to a persistent memory device for backward compatibility
> +and is incapable of being used in combination with [persistent-memdev].
> +
>  Kernel Configuration Options
>  ----------------------------
> =20
> diff --git a/hw/cxl/cxl-mailbox-utils.c b/hw/cxl/cxl-mailbox-utils.c
> index d7543fd5b4..44cebb950a 100644
> --- a/hw/cxl/cxl-mailbox-utils.c
> +++ b/hw/cxl/cxl-mailbox-utils.c
> @@ -269,7 +269,8 @@ static ret_code cmd_firmware_update_get_info(struct c=
xl_cmd *cmd,
>      } QEMU_PACKED *fw_info;
>      QEMU_BUILD_BUG_ON(sizeof(*fw_info) !=3D 0x50);
> =20
> -    if (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) {
> +    if ((cxl_dstate->vmem_size < CXL_CAPACITY_MULTIPLIER) ||
> +        (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER)) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
For a cxl configuration with only pmem or vmem, vmem_size or pmem_size
can be 0 and fail the check?=20

> =20
> @@ -412,20 +413,20 @@ static ret_code cmd_identify_memory_device(struct c=
xl_cmd *cmd,
> =20
>      CXLType3Dev *ct3d =3D container_of(cxl_dstate, CXLType3Dev, cxl_dsta=
te);
>      CXLType3Class *cvc =3D CXL_TYPE3_GET_CLASS(ct3d);
> -    uint64_t size =3D cxl_dstate->pmem_size;
> =20
> -    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
> +    if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER=
)) ||
> +        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER=
))) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
> =20
>      id =3D (void *)cmd->payload;
>      memset(id, 0, sizeof(*id));
> =20
> -    /* PMEM only */
>      snprintf(id->fw_revision, 0x10, "BWFW VERSION %02d", 0);
> =20
> -    id->total_capacity =3D size / CXL_CAPACITY_MULTIPLIER;
> -    id->persistent_capacity =3D size / CXL_CAPACITY_MULTIPLIER;
> +    id->total_capacity =3D cxl_dstate->mem_size / CXL_CAPACITY_MULTIPLIE=
R;
> +    id->persistent_capacity =3D cxl_dstate->pmem_size / CXL_CAPACITY_MUL=
TIPLIER;
> +    id->volatile_capacity =3D cxl_dstate->vmem_size / CXL_CAPACITY_MULTI=
PLIER;
>      id->lsa_size =3D cvc->get_lsa_size(ct3d);
>      id->poison_list_max_mer[1] =3D 0x1; /* 256 poison records */
> =20
> @@ -444,16 +445,15 @@ static ret_code cmd_ccls_get_partition_info(struct =
cxl_cmd *cmd,
>          uint64_t next_pmem;
>      } QEMU_PACKED *part_info =3D (void *)cmd->payload;
>      QEMU_BUILD_BUG_ON(sizeof(*part_info) !=3D 0x20);
> -    uint64_t size =3D cxl_dstate->pmem_size;
> =20
> -    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
> +    if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER=
)) ||
> +        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER=
))) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
> =20
> -    /* PMEM only */
> -    part_info->active_vmem =3D 0;
> +    part_info->active_vmem =3D cxl_dstate->vmem_size / CXL_CAPACITY_MULT=
IPLIER;
>      part_info->next_vmem =3D 0;
> -    part_info->active_pmem =3D size / CXL_CAPACITY_MULTIPLIER;
> +    part_info->active_pmem =3D cxl_dstate->pmem_size / CXL_CAPACITY_MULT=
IPLIER;
>      part_info->next_pmem =3D 0;
> =20
>      *len =3D sizeof(*part_info);
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 0317bd96a6..81dc3def01 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -32,7 +32,8 @@ enum {
>  };
> =20
>  static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
> -                                         int dsmad_handle, MemoryRegion =
*mr)
> +                                         int dsmad_handle, MemoryRegion =
*mr,
> +                                         bool is_pmem, uint64_t dpa_base=
)
>  {
>      g_autofree CDATDsmas *dsmas =3D NULL;
>      g_autofree CDATDslbis *dslbis0 =3D NULL;
> @@ -51,8 +52,8 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader =
**cdat_table,
>              .length =3D sizeof(*dsmas),
>          },
>          .DSMADhandle =3D dsmad_handle,
> -        .flags =3D CDAT_DSMAS_FLAG_NV,
> -        .DPA_base =3D 0,
> +        .flags =3D is_pmem ? CDAT_DSMAS_FLAG_NV : 0,
> +        .DPA_base =3D dpa_base,
>          .DPA_length =3D int128_get64(mr->size),
>      };
> =20
> @@ -151,33 +152,67 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHea=
der **cdat_table,
>  static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>  {
>      g_autofree CDATSubHeader **table =3D NULL;
> -    MemoryRegion *nonvolatile_mr;
>      CXLType3Dev *ct3d =3D priv;
> +    MemoryRegion *volatile_mr =3D NULL, *nonvolatile_mr =3D NULL;
>      int dsmad_handle =3D 0;
> +    int cur_ent =3D 0;
> +    int len =3D 0;
>      int rc;
> =20
> -    if (!ct3d->hostmem) {
> +    if (!ct3d->hostpmem && !ct3d->hostvmem) {
>          return 0;
>      }
> =20
> -    nonvolatile_mr =3D host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!nonvolatile_mr) {
> -        return -EINVAL;
> +    if (ct3d->hostvmem) {
> +        volatile_mr =3D host_memory_backend_get_memory(ct3d->hostvmem);
> +        if (!volatile_mr) {
> +            return -EINVAL;
> +        }
> +        len +=3D CT3_CDAT_NUM_ENTRIES;
> +    }
> +
> +    if (ct3d->hostpmem) {
> +        nonvolatile_mr =3D host_memory_backend_get_memory(ct3d->hostpmem=
);
> +        if (!nonvolatile_mr) {
> +            return -EINVAL;
> +        }
> +        len +=3D CT3_CDAT_NUM_ENTRIES;
>      }
> =20
> -    table =3D g_malloc0(CT3_CDAT_NUM_ENTRIES * sizeof(*table));
> +    table =3D g_malloc0(len * sizeof(*table));
>      if (!table) {
>          return -ENOMEM;
>      }
> =20
> -    rc =3D ct3_build_cdat_entries_for_mr(table, dsmad_handle++, nonvolat=
ile_mr);
> -    if (rc < 0) {
> -        return rc;
> +    /* Now fill them in */
> +    if (volatile_mr) {
> +        rc =3D ct3_build_cdat_entries_for_mr(table, dsmad_handle++, vola=
tile_mr,
> +                                           true, 0);
> +        if (rc < 0) {
> +            return rc;
> +        }
> +        cur_ent =3D CT3_CDAT_NUM_ENTRIES;
> +    }
> +
> +    if (nonvolatile_mr) {
> +        rc =3D ct3_build_cdat_entries_for_mr(&(table[cur_ent]), dsmad_ha=
ndle++,
> +                nonvolatile_mr, true, (volatile_mr ? volatile_mr->size :=
 0));
> +        if (rc < 0) {
> +            goto error_cleanup;
> +        }
> +        cur_ent +=3D CT3_CDAT_NUM_ENTRIES;
>      }
> +    assert(len =3D=3D cur_ent);
> =20
>      *cdat_table =3D g_steal_pointer(&table);
> =20
> -    return CT3_CDAT_NUM_ENTRIES;
> +    return len;
> +error_cleanup:
> +    int i;
> +    for (i =3D 0; i < cur_ent; i++) {
> +        g_free(table[i]);
> +    }
> +    return rc;
>  }

I hit an error when compiling with gcc version 9.4.0
(Ubuntu 9.4.0-1ubuntu1~20.04.1), maybe moving the declaration of `i` to
the following loop.


../hw/mem/cxl_type3.c:211:5: error: a label can only be part of a statement
and a declaration is not a statement
=A0 211 | =A0 =A0 int i;
=A0 =A0 =A0 | =A0 =A0 ^~~
> =20
>  static void ct3_free_cdat_table(CDATSubHeader **cdat_table, int num, voi=
d *priv)
> @@ -378,16 +413,48 @@ static void build_dvsecs(CXLType3Dev *ct3d)
>      CXLDVSECRegisterLocator *regloc_dvsec;
>      uint8_t *dvsec;
>      int i;
> +    uint32_t range1_size_hi, range1_size_lo,
> +             range1_base_hi, range1_base_lo,
> +             range2_size_hi =3D 0, range2_size_lo =3D 0,
> +             range2_base_hi =3D 0, range2_base_lo =3D 0;
> +
> +    /*
> +     * Volatile memory is mapped as (0x0)
> +     * Persistent memory is mapped at (volatile->size)
> +     */
> +    if (ct3d->hostvmem) {
> +        range1_size_hi =3D ct3d->hostvmem->size >> 32;
> +        range1_size_lo =3D (2 << 5) | (2 << 2) | 0x3 |
> +                         (ct3d->hostvmem->size & 0xF0000000);
> +        range1_base_hi =3D 0;
> +        range1_base_lo =3D 0;
> +        if (ct3d->hostpmem) {
> +            range2_size_hi =3D ct3d->hostpmem->size >> 32;
> +            range2_size_lo =3D (2 << 5) | (2 << 2) | 0x3 |
> +                             (ct3d->hostpmem->size & 0xF0000000);
> +            range2_base_hi =3D ct3d->hostvmem->size >> 32;
> +            range2_base_lo =3D ct3d->hostvmem->size & 0xF0000000;
> +        }
> +    } else {
> +        range1_size_hi =3D ct3d->hostpmem->size >> 32;
> +        range1_size_lo =3D (2 << 5) | (2 << 2) | 0x3 |
> +                         (ct3d->hostpmem->size & 0xF0000000);
> +        range1_base_hi =3D 0;
> +        range1_base_lo =3D 0;
> +    }
> =20
>      dvsec =3D (uint8_t *)&(CXLDVSECDevice){
>          .cap =3D 0x1e,
>          .ctrl =3D 0x2,
>          .status2 =3D 0x2,
> -        .range1_size_hi =3D ct3d->hostmem->size >> 32,
> -        .range1_size_lo =3D (2 << 5) | (2 << 2) | 0x3 |
> -        (ct3d->hostmem->size & 0xF0000000),
> -        .range1_base_hi =3D 0,
> -        .range1_base_lo =3D 0,
> +        .range1_size_hi =3D range1_size_hi,
> +        .range1_size_lo =3D range1_size_lo,
> +        .range1_base_hi =3D range1_base_hi,
> +        .range1_base_lo =3D range1_base_lo,
> +        .range2_size_hi =3D range2_size_hi,
> +        .range2_size_lo =3D range2_size_lo,
> +        .range2_base_hi =3D range2_base_hi,
> +        .range2_base_lo =3D range2_base_lo
>      };
>      cxl_component_create_dvsec(cxl_cstate, CXL2_TYPE3_DEVICE,
>                                 PCIE_CXL_DEVICE_DVSEC_LENGTH,
> @@ -475,33 +542,62 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Err=
or **errp)
>      MemoryRegion *mr;
>      char *name;
> =20
> -    if (!ct3d->hostmem) {
> -        error_setg(errp, "memdev property must be set");
> +    if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem) {
> +        error_setg(errp, "at least one memdev property must be set");
>          return false;
> +    } else if (ct3d->hostmem && ct3d->hostpmem) {
> +        error_setg(errp, "[memdev] cannot be used with new "
> +                         "[persistent-memdev] property");
> +        return false;
> +    } else if (ct3d->hostmem) {
> +        /* Use of hostmem property implies pmem */
> +        ct3d->hostpmem =3D ct3d->hostmem;
> +        ct3d->hostmem =3D NULL;
>      }
> =20
> -    mr =3D host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> -        error_setg(errp, "memdev property must be set");
> +    if (ct3d->hostpmem && !ct3d->lsa) {
> +        error_setg(errp, "lsa property must be set for persistent device=
s");
>          return false;
>      }
> -    memory_region_set_nonvolatile(mr, true);
> -    memory_region_set_enabled(mr, true);
> -    host_memory_backend_set_mapped(ct3d->hostmem, true);
> =20
> -    if (ds->id) {
> -        name =3D g_strdup_printf("cxl-type3-dpa-space:%s", ds->id);
> -    } else {
> -        name =3D g_strdup("cxl-type3-dpa-space");
> +    if (ct3d->hostvmem) {
> +        mr =3D host_memory_backend_get_memory(ct3d->hostvmem);
> +        if (!mr) {
> +            error_setg(errp, "volatile memdev must have backing device")=
;
> +            return false;
> +        }
> +        memory_region_set_nonvolatile(mr, false);
> +        memory_region_set_enabled(mr, true);
> +        host_memory_backend_set_mapped(ct3d->hostvmem, true);
> +        if (ds->id) {
> +            name =3D g_strdup_printf("cxl-type3-dpa-vmem-space:%s", ds->=
id);
> +        } else {
> +            name =3D g_strdup("cxl-type3-dpa-vmem-space");
> +        }
> +        address_space_init(&ct3d->hostvmem_as, mr, name);
> +        ct3d->cxl_dstate.vmem_size =3D mr->size;
> +        ct3d->cxl_dstate.mem_size +=3D mr->size;
> +        g_free(name);
>      }
> -    address_space_init(&ct3d->hostmem_as, mr, name);
> -    g_free(name);
> -
> -    ct3d->cxl_dstate.pmem_size =3D ct3d->hostmem->size;
> =20
> -    if (!ct3d->lsa) {
> -        error_setg(errp, "lsa property must be set");
> -        return false;
> +    if (ct3d->hostpmem) {
> +        mr =3D host_memory_backend_get_memory(ct3d->hostpmem);
> +        if (!mr) {
> +            error_setg(errp, "persistent memdev must have backing device=
");
> +            return false;
> +        }
> +        memory_region_set_nonvolatile(mr, true);
> +        memory_region_set_enabled(mr, true);
> +        host_memory_backend_set_mapped(ct3d->hostpmem, true);
> +        if (ds->id) {
> +            name =3D g_strdup_printf("cxl-type3-dpa-pmem-space:%s", ds->=
id);
> +        } else {
> +            name =3D g_strdup("cxl-type3-dpa-pmem-space");
> +        }
> +        address_space_init(&ct3d->hostpmem_as, mr, name);
> +        ct3d->cxl_dstate.pmem_size =3D mr->size;
> +        ct3d->cxl_dstate.mem_size +=3D mr->size;
> +        g_free(name);
>      }
> =20
>      return true;
> @@ -609,7 +705,12 @@ err_free_spdm_socket:
>  err_free_special_ops:
>      g_free(regs->special_ops);
>  err_address_space_free:
> -    address_space_destroy(&ct3d->hostmem_as);
> +    if (ct3d->hostvmem) {
> +        address_space_destroy(&ct3d->hostvmem_as);
> +    }
> +    if (ct3d->hostpmem) {
> +        address_space_destroy(&ct3d->hostpmem_as);
> +    }
>      return;
>  }
> =20
> @@ -623,7 +724,12 @@ static void ct3_exit(PCIDevice *pci_dev)
>      cxl_doe_cdat_release(cxl_cstate);
>      spdm_sock_fini(ct3d->doe_spdm.socket);
>      g_free(regs->special_ops);
> -    address_space_destroy(&ct3d->hostmem_as);
> +    if (ct3d->hostvmem) {
> +        address_space_destroy(&ct3d->hostvmem_as);
> +    }
> +    if (ct3d->hostpmem) {
> +        address_space_destroy(&ct3d->hostpmem_as);
> +    }
>  }
> =20
>  /* TODO: Support multiple HDM decoders and DPA skip */
> @@ -663,11 +769,17 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr hos=
t_addr, uint64_t *data,
>  {
>      CXLType3Dev *ct3d =3D CXL_TYPE3(d);
>      uint64_t dpa_offset;
> -    MemoryRegion *mr;
> +    MemoryRegion *vmr =3D NULL, *pmr =3D NULL;
> +    AddressSpace *as;
> =20
> -    /* TODO support volatile region */
> -    mr =3D host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> +    if (ct3d->hostvmem) {
> +        vmr =3D host_memory_backend_get_memory(ct3d->hostvmem);
> +    }
> +    if (ct3d->hostpmem) {
> +        pmr =3D host_memory_backend_get_memory(ct3d->hostpmem);
> +    }
> +
> +    if (!vmr && !pmr) {
>          return MEMTX_ERROR;
>      }
> =20
> @@ -675,11 +787,22 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr hos=
t_addr, uint64_t *data,
>          return MEMTX_ERROR;
>      }
> =20
> -    if (dpa_offset > int128_get64(mr->size)) {
> +    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
>          return MEMTX_ERROR;
>      }
> =20
> -    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data=
, size);
> +    if (vmr) {
> +        if (dpa_offset <=3D int128_get64(vmr->size)) {
> +            as =3D &ct3d->hostvmem_as;
> +        } else {
> +            as =3D &ct3d->hostpmem_as;
> +            dpa_offset -=3D vmr->size;
> +        }
> +    }
> +    else {
> +        as =3D &ct3d->hostpmem_as;
> +    }
> +    return address_space_read(as, dpa_offset, attrs, data, size);
>  }
> =20
>  MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t dat=
a,
> @@ -687,10 +810,17 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr ho=
st_addr, uint64_t data,
>  {
>      CXLType3Dev *ct3d =3D CXL_TYPE3(d);
>      uint64_t dpa_offset;
> -    MemoryRegion *mr;
> +    MemoryRegion *vmr =3D NULL, *pmr =3D NULL;
> +    AddressSpace *as;
> =20
> -    mr =3D host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> +    if (ct3d->hostvmem) {
> +        vmr =3D host_memory_backend_get_memory(ct3d->hostvmem);
> +    }
> +    if (ct3d->hostpmem) {
> +        pmr =3D host_memory_backend_get_memory(ct3d->hostpmem);
> +    }
> +
> +    if (!vmr && !pmr) {
>          return MEMTX_OK;
>      }
> =20
> @@ -698,11 +828,22 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr ho=
st_addr, uint64_t data,
>          return MEMTX_OK;
>      }
> =20
> -    if (dpa_offset > int128_get64(mr->size)) {
> +    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
>          return MEMTX_OK;
>      }
> -    return address_space_write(&ct3d->hostmem_as, dpa_offset, attrs,
> -                               &data, size);
> +
> +    if (vmr) {
> +        if (dpa_offset <=3D int128_get64(vmr->size)) {
> +            as =3D &ct3d->hostvmem_as;
> +        } else {
> +            as =3D &ct3d->hostpmem_as;
> +            dpa_offset -=3D vmr->size;
> +        }
> +    }
> +    else {
> +        as =3D &ct3d->hostpmem_as;
> +    }
> +    return address_space_write(as, dpa_offset, attrs, &data, size);
>  }
> =20
>  static void ct3d_reset(DeviceState *dev)
> @@ -717,7 +858,11 @@ static void ct3d_reset(DeviceState *dev)
> =20
>  static Property ct3_props[] =3D {
>      DEFINE_PROP_LINK("memdev", CXLType3Dev, hostmem, TYPE_MEMORY_BACKEND=
,
> -                     HostMemoryBackend *),
> +                     HostMemoryBackend *), /* for backward compatibility=
 */
> +    DEFINE_PROP_LINK("persistent-memdev", CXLType3Dev, hostpmem,
> +                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
> +    DEFINE_PROP_LINK("volatile-memdev", CXLType3Dev, hostvmem,
> +                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
>      DEFINE_PROP_LINK("lsa", CXLType3Dev, lsa, TYPE_MEMORY_BACKEND,
>                       HostMemoryBackend *),
>      DEFINE_PROP_UINT64("sn", CXLType3Dev, sn, UI64_NULL),
> @@ -728,10 +873,12 @@ static Property ct3_props[] =3D {
> =20
>  static uint64_t get_lsa_size(CXLType3Dev *ct3d)
>  {
> -    MemoryRegion *mr;
> -
> -    mr =3D host_memory_backend_get_memory(ct3d->lsa);
> -    return memory_region_size(mr);
> +    MemoryRegion *mr =3D NULL;
> +    if (ct3d->lsa) {
> +        mr =3D host_memory_backend_get_memory(ct3d->lsa);
> +        return memory_region_size(mr);
> +    }
> +    return 0;
>  }
> =20
>  static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
> @@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, u=
int64_t size,
>  static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> +    MemoryRegion *mr =3D NULL;
>      void *lsa;
> =20
> -    mr =3D host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {
> +        mr =3D host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
> =20
> -    lsa =3D memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(buf, lsa, size);
> +        lsa =3D memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(buf, lsa, size);
> +        return size;
> +    }
> =20
> -    return size;
> +    return 0;
>  }
> =20
>  static void set_lsa(CXLType3Dev *ct3d, const void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> -    void *lsa;
> +    MemoryRegion *mr =3D NULL;
> +    void *lsa =3D NULL;
> =20
> -    mr =3D host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {
> +        mr =3D host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
> =20
> -    lsa =3D memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(lsa, buf, size);
> -    memory_region_set_dirty(mr, offset, size);
> +        lsa =3D memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(lsa, buf, size);
> +        memory_region_set_dirty(mr, offset, size);
> +    }
> =20
>      /*
>       * Just like the PMEM, if the guest is not allowed to exit gracefull=
y, label
> @@ -978,7 +1130,7 @@ static void ct3_class_init(ObjectClass *oc, void *da=
ta)
>      pc->config_read =3D ct3d_config_read;
> =20
>      set_bit(DEVICE_CATEGORY_STORAGE, dc->categories);
> -    dc->desc =3D "CXL PMEM Device (Type 3)";
> +    dc->desc =3D "CXL Memory Device (Type 3)";
>      dc->reset =3D ct3d_reset;
>      device_class_set_props(dc, ct3_props);
> =20
> diff --git a/include/hw/cxl/cxl_device.h b/include/hw/cxl/cxl_device.h
> index 1cd71afcb6..1b366b739c 100644
> --- a/include/hw/cxl/cxl_device.h
> +++ b/include/hw/cxl/cxl_device.h
> @@ -180,8 +180,10 @@ typedef struct cxl_device_state {
>          uint64_t host_set;
>      } timestamp;
> =20
> -    /* memory region for persistent memory, HDM */
> +    /* memory region size, HDM */
> +    uint64_t mem_size;
>      uint64_t pmem_size;
> +    uint64_t vmem_size;
> =20
>      struct cxl_cmd (*cxl_cmd_set)[256];
>      /* Move me later */
> @@ -311,12 +313,15 @@ struct CXLType3Dev {
>      PCIDevice parent_obj;
> =20
>      /* Properties */
> -    HostMemoryBackend *hostmem;
> +    HostMemoryBackend *hostmem; /* deprecated */
> +    HostMemoryBackend *hostvmem;
> +    HostMemoryBackend *hostpmem;
>      HostMemoryBackend *lsa;
>      uint64_t sn;
> =20
>      /* State */
> -    AddressSpace hostmem_as;
> +    AddressSpace hostvmem_as;
> +    AddressSpace hostpmem_as;
>      CXLComponentState cxl_cstate;
>      CXLDeviceState cxl_dstate;
> =20
> diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> index e59ba22387..6893f54e28 100644
> --- a/tests/qtest/cxl-test.c
> +++ b/tests/qtest/cxl-test.c
> @@ -40,32 +40,46 @@
>    "-device cxl-rp,id=3Drp2,bus=3Dcxl.1,chassis=3D0,slot=3D2 " \
>    "-device cxl-rp,id=3Drp3,bus=3Dcxl.1,chassis=3D0,slot=3D3 "
> =20
> -#define QEMU_T3D \
> +#define QEMU_T3D_DEPRECATED \
>    "-object memory-backend-file,id=3Dcxl-mem0,mem-path=3D%s,size=3D256M "=
 \
> -  "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M "    =
\
> +  "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M " \
>    "-device cxl-type3,bus=3Drp0,memdev=3Dcxl-mem0,lsa=3Dlsa0,id=3Dcxl-pme=
m0 "
> =20
> +#define QEMU_T3D_PMEM \
> +  "-object memory-backend-file,id=3Dm0,mem-path=3D%s,size=3D256M " \
> +  "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M " \
> +  "-device cxl-type3,bus=3Drp0,persistent-memdev=3Dcxl-m0,lsa=3Dlsa0,id=
=3Dpmem0 "
> +
> +#define QEMU_T3D_VMEM \
> +  "-object memory-backend-ram,id=3Dmem0,size=3D256M " \
> +  "-device cxl-type3,bus=3Drp0,volatile-memdev=3Dmem0,id=3Dmem0 "
> +
> +#define QEMU_T3D_VMEM_LSA \
> +  "-object memory-backend-ram,id=3Dmem0,size=3D256M " \
> +  "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M " \
> +  "-device cxl-type3,bus=3Drp0,volatile-memdev=3Dmem0,lsa=3Dlsa0,id=3Dme=
m0 "
> +
>  #define QEMU_2T3D \
>    "-object memory-backend-file,id=3Dcxl-mem0,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp0,memdev=3Dcxl-mem0,lsa=3Dlsa0,id=3Dcxl-pme=
m0 " \
> +  "-device cxl-type3,bus=3Drp0,persistent-memdev=3Dcxl-mem0,lsa=3Dlsa0,i=
d=3Dpmem0 " \
>    "-object memory-backend-file,id=3Dcxl-mem1,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa1,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp1,memdev=3Dcxl-mem1,lsa=3Dlsa1,id=3Dcxl-pme=
m1 "
> +  "-device cxl-type3,bus=3Drp1,persistent-memdev=3Dcxl-mem1,lsa=3Dlsa1,i=
d=3Dpmem1 "
> =20
>  #define QEMU_4T3D \
>    "-object memory-backend-file,id=3Dcxl-mem0,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa0,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp0,memdev=3Dcxl-mem0,lsa=3Dlsa0,id=3Dcxl-pme=
m0 " \
> +  "-device cxl-type3,bus=3Drp0,persistent-memdev=3Dcxl-mem0,lsa=3Dlsa0,i=
d=3Dpmem0 " \
>    "-object memory-backend-file,id=3Dcxl-mem1,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa1,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp1,memdev=3Dcxl-mem1,lsa=3Dlsa1,id=3Dcxl-pme=
m1 " \
> +  "-device cxl-type3,bus=3Drp1,persistent-memdev=3Dcxl-mem1,lsa=3Dlsa1,i=
d=3Dpmem1 " \
>    "-object memory-backend-file,id=3Dcxl-mem2,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa2,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp2,memdev=3Dcxl-mem2,lsa=3Dlsa2,id=3Dcxl-pme=
m2 " \
> +  "-device cxl-type3,bus=3Drp2,persistent-memdev=3Dcxl-mem2,lsa=3Dlsa2,i=
d=3Dpmem2 " \
>    "-object memory-backend-file,id=3Dcxl-mem3,mem-path=3D%s,size=3D256M "=
 \
>    "-object memory-backend-file,id=3Dlsa3,mem-path=3D%s,size=3D256M " \
> -  "-device cxl-type3,bus=3Drp3,memdev=3Dcxl-mem3,lsa=3Dlsa3,id=3Dcxl-pme=
m3 "
> +  "-device cxl-type3,bus=3Drp3,persistent-memdev=3Dcxl-mem3,lsa=3Dlsa3,i=
d=3Dpmem3 "
> =20
>  static void cxl_basic_hb(void)
>  {
> @@ -104,14 +118,53 @@ static void cxl_2root_port(void)
>  }
> =20
>  #ifdef CONFIG_POSIX
> -static void cxl_t3d(void)
> +static void cxl_t3d_deprecated(void)
> +{
> +    g_autoptr(GString) cmdline =3D g_string_new(NULL);
> +    g_autofree const char *tmpfs =3D NULL;
> +
> +    tmpfs =3D g_dir_make_tmp("cxl-test-XXXXXX", NULL);
> +
> +    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_DEPRECATED,
> +                    tmpfs, tmpfs);
> +
> +    qtest_start(cmdline->str);
> +    qtest_end();
> +}
> +
> +static void cxl_t3d_persistent(void)
> +{
> +    g_autoptr(GString) cmdline =3D g_string_new(NULL);
> +    g_autofree const char *tmpfs =3D NULL;
> +
> +    tmpfs =3D g_dir_make_tmp("cxl-test-XXXXXX", NULL);
> +
> +    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_PMEM,
> +                    tmpfs, tmpfs);
> +
> +    qtest_start(cmdline->str);
> +    qtest_end();
> +}
> +
> +static void cxl_t3d_volatile(void)
> +{
> +    g_autoptr(GString) cmdline =3D g_string_new(NULL);
> +
> +    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_VMEM);
> +
> +    qtest_start(cmdline->str);
> +    qtest_end();
> +}
> +
> +static void cxl_t3d_volatile_lsa(void)
>  {
>      g_autoptr(GString) cmdline =3D g_string_new(NULL);
>      g_autofree const char *tmpfs =3D NULL;
> =20
>      tmpfs =3D g_dir_make_tmp("cxl-test-XXXXXX", NULL);
> =20
> -    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D, tmpfs, tmpfs=
);
> +    g_string_printf(cmdline, QEMU_PXB_CMD QEMU_RP QEMU_T3D_VMEM_LSA,
> +                    tmpfs);
> =20
>      qtest_start(cmdline->str);
>      qtest_end();
> @@ -179,7 +232,10 @@ int main(int argc, char **argv)
>          qtest_add_func("/pci/cxl/rp", cxl_root_port);
>          qtest_add_func("/pci/cxl/rp_x2", cxl_2root_port);
>  #ifdef CONFIG_POSIX
> -        qtest_add_func("/pci/cxl/type3_device", cxl_t3d);
> +        qtest_add_func("/pci/cxl/type3_device", cxl_t3d_deprecated);
> +        qtest_add_func("/pci/cxl/type3_device_pmem", cxl_t3d_persistent)=
;
> +        qtest_add_func("/pci/cxl/type3_device_vmem", cxl_t3d_volatile);
> +        qtest_add_func("/pci/cxl/type3_device_vmem_lsa", cxl_t3d_volatil=
e_lsa);
>          qtest_add_func("/pci/cxl/rp_x2_type3_x2", cxl_1pxb_2rp_2t3d);
>          qtest_add_func("/pci/cxl/pxb_x2_root_port_x4_type3_x4",
>                         cxl_2pxb_4rp_4t3d);
> --=20
> 2.37.3
>=20
> =

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 9D610C4332F
	for <linux-cxl@archiver.kernel.org>; Thu,  8 Dec 2022 23:06:42 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229760AbiLHXGm (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 8 Dec 2022 18:06:42 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49948 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229462AbiLHXGl (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 8 Dec 2022 18:06:41 -0500
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2058.outbound.protection.outlook.com [40.107.237.58])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 992BC6427
        for <linux-cxl@vger.kernel.org>; Thu,  8 Dec 2022 15:06:40 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ocjkiapfCL/Ig5pn56m1YZUh5VWhd/LEiwoTVW3uu5BzKwMMbfT7xZ/eZbSZ+asrJXBc1DOhQwZ71akGAks8oyrmII2Y9dFj7orQ0fPGQVJUxuCPL3Jr3v76grIsySsmqhVebGOMAn/na8QsHs3KpL7mKlEl/9mS54mkjaMb7nM9EWLqGVMxxGBoRWXXG32dRaeUF3M5fHDNdh0SiZ0a1BSCe7pmUTRgnGHqEQgcqEXglhx4nOlYxEEWXE53kUU/zF+6NEGqPkh0Kez961qcNWl8wF4dWK7x/ymDcSnuRW1bY4TobCZC8MS4HYh+INdiR9GHqHYhZ0f90x8PCsSEdQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=mBm2BqJFi6IgSi+hknI7CO2qPLWTWVEzqLmDVbfrpAk=;
 b=dG8JSzbSMgHLUchXsAL5+o6jf2qkFCq13sbmaj0mRuOAieOoJY6H6ZC90zspNvCMA0C4B4FbN3s8bUyR1q85Qw9jbFNLHrm1YuiEHdVwbtjk6HFgRBlKMt4IRfjSqmYKVA8BABXiP7hG8sz8/ewNq6alskn3cDzelyv5+oCz0D6HghQTx2tqA7NZiu1xO+Iz1T6n7WSZAtWRSpKfigVTDKQpYU5Gc8vMMfvUqwfL6UDdVV8dDG9JkE06X4fH9kJtIxk+YExbMSgvdf55fAedJLsVlb4gHBlUTp5SU87mqMi0J/x0W0X/GGtPQ8tfAGCOSWL7spSkT/tUZzM5q8d4yA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=mBm2BqJFi6IgSi+hknI7CO2qPLWTWVEzqLmDVbfrpAk=;
 b=nP1S0nF33s5mKB7mtd+RDYgE6JcIvAIBigh8/vEoI+A5S7EW5xnM2J2IGeGSz5JnRiXjnPTuBDzZdzNySyRB1Pny8kW54bi6Fpxg9BndIgh40EV77rfueFU7X9cUL+Q58edfipVkqdXHSLbwKPiu940jiAnbS2V/A+zJoF96jJQ=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by IA1PR17MB6672.namprd17.prod.outlook.com (2603:10b6:208:3db::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.5880.11; Thu, 8 Dec
 2022 23:06:36 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df%6]) with mapi id 15.20.5880.016; Thu, 8 Dec 2022
 23:06:36 +0000
Date: Thu, 8 Dec 2022 18:06:30 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Fan Ni <fan.ni@samsung.com>
Cc: Gregory Price <gourry.memverge@gmail.com>,
        "qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
        "jonathan.cameron@huawei.com" <jonathan.cameron@huawei.com>,
        "linux-cxl@vger.kernel.org" <linux-cxl@vger.kernel.org>,
        "alison.schofield@intel.com" <alison.schofield@intel.com>,
        "dave@stgolabs.net" <dave@stgolabs.net>,
        Adam Manzanares <a.manzanares@samsung.com>,
        "bwidawsk@kernel.org" <bwidawsk@kernel.org>,
        "hchkuo@avery-design.com.tw" <hchkuo@avery-design.com.tw>,
        "cbrowy@avery-design.com" <cbrowy@avery-design.com>,
        "ira.weiny@intel.com" <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y5Jt9iPs8GX9EMug@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <CGME20221208225559uscas1p1e9e2c7c8f9a1654a5f41cef2c47859a8@uscas1p1.samsung.com>
 <20221208225515.GA2510517@bgt-140510-bm03>
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20221208225515.GA2510517@bgt-140510-bm03>
X-ClientProxiedBy: SJ0PR03CA0040.namprd03.prod.outlook.com
 (2603:10b6:a03:33e::15) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|IA1PR17MB6672:EE_
X-MS-Office365-Filtering-Correlation-Id: 0e9f8e4e-3cd4-44e9-4929-08dad970db1b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: Yn8dIaQnPaJpn5jFLj4dpga6x7+JMz1p14W2lBHjzZ/r+oY1r/hvh6OMXb5ENilxIh184SbFpKHXlfWm8eZj32M2przJZBsfbijKuBlpmdoIGQSK28tXSHCJcK6kVTrOP0nhjtrYedAm1o4iWehKlHQLS/w6Nqycx0AwGSYXWPJ5nvL/jFYcacjoPXKqYwsV9u077IpMhDbP9f25JG+2Bl1sGA9fPDuSmUtN2uFsFX5CmsQ0ITZPVGXqOLnKAyig4C2a0TOyNqz9g6I3ePgnPkEPViVlkJIChVMBgcHNO22m5B4bdLEgXyA5dAOoc8nxVJ2F9Tc1OIOHPh8s66BmKpYz8Nx+7dyTBIqo+awMWRkDezmYQvYaYRcPiG/cWlyXFSQtycIx+UmPtj0ovcOElh1nVmqZSZptMSbhxQrVlBrXiiLHorJFpJeIWhMcYVlxE3rbd9xzS0cNhif36tBWaWwEoZsaKVdSuEvd+VpOrdX1zePtcoRCfizWTGOPlvFNSQJXOo+66YGim2WLIVUSYkNLouSg4yvLQehse5afR+JTQa8yQkcQ0We9HRcJF0W173o19nt2unq5wiJvSc7GFgnFKKLqCn9sMs5SRTMa+lz8XY8VbRhG1tkhnFSZmS7h8WzkYn9YgSl7xoGsQiNsHQ==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(396003)(376002)(346002)(136003)(39840400004)(366004)(451199015)(6506007)(2906002)(86362001)(6916009)(54906003)(186003)(26005)(6512007)(41300700001)(2616005)(7416002)(316002)(44832011)(8936002)(5660300002)(36756003)(66946007)(478600001)(66556008)(66476007)(8676002)(6486002)(4326008)(38100700002)(6666004);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?iso-8859-1?Q?6aWgm5bEBBBsYf4k9Jgbo+TbYxBrYd8qBsrzAWMOlEaiFwDnpiKPLhio40?=
 =?iso-8859-1?Q?kcui3/r/92aeSuYDAKQWLSby4Wd8+SXiLMCezes8kWARBeSSsESVX57SkQ?=
 =?iso-8859-1?Q?nAXGCt8QhMPBAUsP9OtVrWsEoTPkvwmTWJBiU1mNPpBj3jc5XuL7CuDdTl?=
 =?iso-8859-1?Q?Oz9BSW+E1YJks5rcEc0Ze35db0EeUUbckXLYmUIs/Wrs7T9SuUEGNKcgfU?=
 =?iso-8859-1?Q?eKn54O9Izi+r2sd47Fly3wjbJoJa07hmTL3en0lwnDJfgGFUbDKLZhQT0d?=
 =?iso-8859-1?Q?ThMbcBjVqDSEDalnkcF4vRTs43y8jan51Sd7Rss8euP78tO00yr2Km+j9I?=
 =?iso-8859-1?Q?gWhK5LFBKLe6YVxNIZlcTMBBCXttFNbv2K+tIaJtyjA+JBHYcjzrKPouoS?=
 =?iso-8859-1?Q?nvSVJnPBoSucFdEDXYnaZeWp3sK3hwT5M0iQ/Im/PIK++vNEkoxk6bNi+s?=
 =?iso-8859-1?Q?AWV6bWzalyDQ67Jq5eIxQ32aNo64w7hB5QTpGVIWDICndI7yS/9DpEGWjM?=
 =?iso-8859-1?Q?n+kNlJ1e8oysOZ6+QE4GtkEY8b4DUGUQKhj8+7++QEZ1mY1yXqpw8YLt1d?=
 =?iso-8859-1?Q?joTU6HOJDkCMIfkqC6iRRyq9Mk/7ipDIf8hVkxbMJ8CpcsfhDW5tHC5YTr?=
 =?iso-8859-1?Q?HtKiRY7BIq4wt8Y/k5b0FrGrNLkZzo9nuji7+jaQ3GGSJw27UJyWjTmFA3?=
 =?iso-8859-1?Q?EQw/pUIR6rh6tvHYrL6g2tna4A0TNyKIdzZgM+7HANQsl707w01TsHtSY/?=
 =?iso-8859-1?Q?XZCCkVuqsdLL66bwqXxrgXaVYUR7FM4ArE/riaHD86ibrWzBmWpuZF4aui?=
 =?iso-8859-1?Q?+j8BVM9nRWfmUdHJ4K9n/IqzwA00rR7jEgJVNAOB9taGZ+U7mYEvnucfL4?=
 =?iso-8859-1?Q?SM7Vk4ZxbC7xr+yUiXHYR08kHCqv0pASIl8lArL+e569b1NoXJhS4ny3xo?=
 =?iso-8859-1?Q?fDeyXs1Z2H8m+aQeuakP6sTkT6SbFrntXI3JNj8/WQsCQGd3W2YOpREF6x?=
 =?iso-8859-1?Q?TUYE5+LlwMg5By4busLr2u/PC9lrm7uy0aIZ0k0WTvp6WSGvu8aqDwPviQ?=
 =?iso-8859-1?Q?JwqstMMDiOn/ZWCISZiJVOM8aYd+ze6aw51pINMmFGLClcNLHFJzPqPi05?=
 =?iso-8859-1?Q?lOXIkhA+ywynoFMXNZ4In76xvmVm+LYOxQLihdWuQZHZrtiUyS5a13lB+k?=
 =?iso-8859-1?Q?iLGG54/Miaoy5SdGOvBUW3EUjwzGcUIRkDnoZY9EcMB/Jxo3tmjut1zMPl?=
 =?iso-8859-1?Q?FgZOXKcgMh9O6vSlO15D5zrdpgq2aCHwp6vbinqTX9YWZnq4yYV5KOjyq1?=
 =?iso-8859-1?Q?vIBihgatWhPCK186EN56MAnq+bChXWyXkf9ZNbhL7VMfwSPgLfaAokp+f4?=
 =?iso-8859-1?Q?47oeXYPgSNvT/wWgzr+R44zX/6vwgjDLpmVJdLhbbjjE/2rxQV176cdoAt?=
 =?iso-8859-1?Q?XE78kXGGr24FEgyt+W+5JI8pHmt1KvGUbixI2GNT79VK/8yi0nx5H7hZW5?=
 =?iso-8859-1?Q?SQfNfuyuDB59a/x6DkJjts2YCHobxGuBBlpWEwLF59sMJeIrGnESacBBRU?=
 =?iso-8859-1?Q?gD0sLsmhaoXP+ofCN5EPORoFwZrVDrtLkEybRjUsCdYHHTJg6+hSYToSXp?=
 =?iso-8859-1?Q?l+FHqd+y84engqDEpyq5F2ek4S3gWI7DjpDX8UmFh41Oe9fZgr/7v9sw?=
 =?iso-8859-1?Q?=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 0e9f8e4e-3cd4-44e9-4929-08dad970db1b
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Dec 2022 23:06:36.4253
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: oR1z5nyDM+xaPPEwrEo8bKKsh+Bwgq/bsU2obelJllC2RSqeYVBqWNE6Kao2wmscDihu+fRMmxX7aGsC6x4W4Q6+Doh6INjN2PcaHvre/qc=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: IA1PR17MB6672
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, Dec 08, 2022 at 10:55:58PM +0000, Fan Ni wrote:
> On Mon, Nov 28, 2022 at 10:01:57AM -0500, Gregory Price wrote:
> >  
> > -    if (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER) {
> > +    if ((cxl_dstate->vmem_size < CXL_CAPACITY_MULTIPLIER) ||
> > +        (cxl_dstate->pmem_size < CXL_CAPACITY_MULTIPLIER)) {
> >          return CXL_MBOX_INTERNAL_ERROR;
> >      }
> For a cxl configuration with only pmem or vmem, vmem_size or pmem_size
> can be 0 and fail the check? 
> 

While nonsensical, i believe it's technically supported.  The prior
implementation likewise enabled pmem_size to be 0 in these checks.

> >  
> > +error_cleanup:
> > +    int i;
> > +    for (i = 0; i < cur_ent; i++) {
> > +        g_free(table[i]);
> > +    }
> > +    return rc;
> >  }
> 
> I hit an error when compiling with gcc version 9.4.0
> (Ubuntu 9.4.0-1ubuntu1~20.04.1), maybe moving the declaration of `i` to
> the following loop.
> 
> 
> ../hw/mem/cxl_type3.c:211:5: error: a label can only be part of a statement
> and a declaration is not a statement
>  211 |   int i;
>    |   ^~~

Moved the declaration to the top fo the function with the rest of the
declarations. Good catch.


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0B362C4332F
	for <linux-cxl@archiver.kernel.org>; Mon, 19 Dec 2022 12:42:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231712AbiLSMmW (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 19 Dec 2022 07:42:22 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50892 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231439AbiLSMmV (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 19 Dec 2022 07:42:21 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D8BCFDFC6
        for <linux-cxl@vger.kernel.org>; Mon, 19 Dec 2022 04:42:17 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.226])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4NbK7R5psxz6H6jT;
        Mon, 19 Dec 2022 20:40:51 +0800 (CST)
Received: from localhost (10.45.149.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Mon, 19 Dec
 2022 12:42:14 +0000
Date: Mon, 19 Dec 2022 12:42:11 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        <alison.schofield@intel.com>, <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <bwidawsk@kernel.org>,
        <gregory.price@memverge.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20221219124211.000032b7@Huawei.com>
In-Reply-To: <20221128150157.97724-4-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.45.149.76]
X-ClientProxiedBy: lhrpeml500006.china.huawei.com (7.191.161.198) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, 28 Nov 2022 10:01:57 -0500
Gregory Price <gourry.memverge@gmail.com> wrote:

> From: Gregory Price <gourry.memverge@gmail.com>
> 
> This commit enables each CXL Type-3 device to contain one volatile
> memory region and one persistent region.
> 
> Two new properties have been added to cxl-type3 device initialization:
>     [volatile-memdev] and [persistent-memdev]
> 
> The existing [memdev] property has been deprecated and will default the
> memory region to a persistent memory region (although a user may assign
> the region to a ram or file backed region). It cannot be used in
> combination with the new [persistent-memdev] property.
> 
> Partitioning volatile memory from persistent memory is not yet supported.
> 
> Volatile memory is mapped at DPA(0x0), while Persistent memory is mapped
> at DPA(vmem->size), per CXL Spec 8.2.9.8.2.0 - Get Partition Info.
> 
> Signed-off-by: Gregory Price <gregory.price@memverge.com>
> Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

As a process thing, when reworking a patch I picked up for the
CXL qemu gitlab tree, drop the SOB that I added as it's not relevant
to the new patch.

Some minor comments inline. I've fixed these up (and the int i from
the other review) whilst applying to my local tree.  That tree is a bit
of a mess at the moment, so probably won't push out to gitlab until
after the holidays.  Still no need to post a new version unless you particularly
want to or there are other changes to make.

My current plan for sending this upstream is to do it after a couple of
other series - the driver being what is needed for the current kernel code
testing:

1) Trivial cleanup (I'll probably pull patch 1 of this series into that)
2) The RAS error injection series - kernel code already upstream.
3) The event injection series (Ira is going to send an updated RFC)
   kernel code on list.

4) This series probably. My main concern here is that we don't really have
   any way of testing this yet. It's small enough that doesn't bother me
   to much though.


Hopefully some other series in parallel that aren't focused on the type 3 device
so can merge in other orders.


> ---
>  docs/system/devices/cxl.rst |  49 ++++--
>  hw/cxl/cxl-mailbox-utils.c  |  22 +--
>  hw/mem/cxl_type3.c          | 292 +++++++++++++++++++++++++++---------
>  include/hw/cxl/cxl_device.h |  11 +-
>  tests/qtest/cxl-test.c      |  78 ++++++++--
>  5 files changed, 347 insertions(+), 105 deletions(-)
> 
> diff --git a/docs/system/devices/cxl.rst b/docs/system/devices/cxl.rst
> index f25783a4ec..45639a676a 100644
> --- a/docs/system/devices/cxl.rst
> +++ b/docs/system/devices/cxl.rst
> @@ -300,7 +300,7 @@ Example topology involving a switch::
>  
>  Example command lines
>  ---------------------
> -A very simple setup with just one directly attached CXL Type 3 device::
> +A very simple setup with just one directly attached CXL Type 3 Persistent Memory device::
>  
>    qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
>    ...
> @@ -308,7 +308,28 @@ A very simple setup with just one directly attached CXL Type 3 device::
>    -object memory-backend-file,id=cxl-lsa1,share=on,mem-path=/tmp/lsa.raw,size=256M \
>    -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
>    -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> -  -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
> +  -device cxl-type3,bus=root_port13,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
> +  -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
> +
> +A very simple setup with just one directly attached CXL Type 3 Volatile Memory device::
> +
> +  qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
> +  ...
> +  -object memory-backend-ram,id=vmem0,share=on,size=256M \
> +  -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
> +  -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> +  -device cxl-type3,bus=root_port13,volatile-memdev=vmem0,id=cxl-vmem0 \
> +  -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
> +
> +The same volatile setup may optionally include an LSA region::
> +
> +  qemu-system-aarch64 -M virt,gic-version=3,cxl=on -m 4g,maxmem=8G,slots=8 -cpu max \
> +  ...
> +  -object memory-backend-ram,id=vmem0,share=on,size=256M \
> +  -object memory-backend-file,id=cxl-lsa0,share=on,mem-path=/tmp/lsa.raw,size=256M \
> +  -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
> +  -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> +  -device cxl-type3,bus=root_port13,volatile-memdev=vmem0,lsa=cxl-lsa0,id=cxl-vmem0 \
>    -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G
>  
>  A setup suitable for 4 way interleave. Only one fixed window provided, to enable 2 way
> @@ -328,13 +349,13 @@ the CXL Type3 device directly attached (no switches).::
>    -device pxb-cxl,bus_nr=12,bus=pcie.0,id=cxl.1 \
>    -device pxb-cxl,bus_nr=222,bus=pcie.0,id=cxl.2 \
>    -device cxl-rp,port=0,bus=cxl.1,id=root_port13,chassis=0,slot=2 \
> -  -device cxl-type3,bus=root_port13,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
> +  -device cxl-type3,bus=root_port13,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem0 \
>    -device cxl-rp,port=1,bus=cxl.1,id=root_port14,chassis=0,slot=3 \
> -  -device cxl-type3,bus=root_port14,memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem1 \
> +  -device cxl-type3,bus=root_port14,persistent-memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem1 \
>    -device cxl-rp,port=0,bus=cxl.2,id=root_port15,chassis=0,slot=5 \
> -  -device cxl-type3,bus=root_port15,memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem2 \
> +  -device cxl-type3,bus=root_port15,persistent-memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem2 \
>    -device cxl-rp,port=1,bus=cxl.2,id=root_port16,chassis=0,slot=6 \
> -  -device cxl-type3,bus=root_port16,memdev=cxl-mem4,lsa=cxl-lsa4,id=cxl-pmem3 \
> +  -device cxl-type3,bus=root_port16,persistent-memdev=cxl-mem4,lsa=cxl-lsa4,id=cxl-pmem3 \
>    -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.targets.1=cxl.2,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=8k
>  
>  An example of 4 devices below a switch suitable for 1, 2 or 4 way interleave::
> @@ -354,15 +375,23 @@ An example of 4 devices below a switch suitable for 1, 2 or 4 way interleave::
>    -device cxl-rp,port=1,bus=cxl.1,id=root_port1,chassis=0,slot=1 \
>    -device cxl-upstream,bus=root_port0,id=us0 \
>    -device cxl-downstream,port=0,bus=us0,id=swport0,chassis=0,slot=4 \
> -  -device cxl-type3,bus=swport0,memdev=cxl-mem0,lsa=cxl-lsa0,id=cxl-pmem0,size=256M \
> +  -device cxl-type3,bus=swport0,persistent-memdev=cxl-mem0,lsa=cxl-lsa0,id=cxl-pmem0,size=256M \
>    -device cxl-downstream,port=1,bus=us0,id=swport1,chassis=0,slot=5 \
> -  -device cxl-type3,bus=swport1,memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem1,size=256M \
> +  -device cxl-type3,bus=swport1,persistent-memdev=cxl-mem1,lsa=cxl-lsa1,id=cxl-pmem1,size=256M \
>    -device cxl-downstream,port=2,bus=us0,id=swport2,chassis=0,slot=6 \
> -  -device cxl-type3,bus=swport2,memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem2,size=256M \
> +  -device cxl-type3,bus=swport2,persistent-memdev=cxl-mem2,lsa=cxl-lsa2,id=cxl-pmem2,size=256M \
>    -device cxl-downstream,port=3,bus=us0,id=swport3,chassis=0,slot=7 \
> -  -device cxl-type3,bus=swport3,memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem3,size=256M \
> +  -device cxl-type3,bus=swport3,persistent-memdev=cxl-mem3,lsa=cxl-lsa3,id=cxl-pmem3,size=256M \
>    -M cxl-fmw.0.targets.0=cxl.1,cxl-fmw.0.size=4G,cxl-fmw.0.interleave-granularity=4k
>  
> +Deprecations
> +------------
> +
> +The Type 3 device [memdev] attribute has been deprecated in favor
> +of the [persistent-memdev] and [volatile-memdev] attributes. [memdev]

That's not quite correct as it sort of implies we could previously use
memdev for the volatile case.

Also curiously short line wrap here. I'll tweak this.  Whilst the rest of the file is also
wrapped oddly, lets not make it worse.

> +will default to a persistent memory device for backward compatibility
> +and is incapable of being used in combination with [persistent-memdev].
> +
>  Kernel Configuration Options
>  ----------------------------
>  


>  
> @@ -444,16 +445,15 @@ static ret_code cmd_ccls_get_partition_info(struct cxl_cmd *cmd,
>          uint64_t next_pmem;
>      } QEMU_PACKED *part_info = (void *)cmd->payload;
>      QEMU_BUILD_BUG_ON(sizeof(*part_info) != 0x20);
> -    uint64_t size = cxl_dstate->pmem_size;
>  
> -    if (!QEMU_IS_ALIGNED(size, CXL_CAPACITY_MULTIPLIER)) {
> +    if ((!QEMU_IS_ALIGNED(cxl_dstate->vmem_size, CXL_CAPACITY_MULTIPLIER)) ||
> +        (!QEMU_IS_ALIGNED(cxl_dstate->pmem_size, CXL_CAPACITY_MULTIPLIER))) {
>          return CXL_MBOX_INTERNAL_ERROR;
>      }
>  
> -    /* PMEM only */
> -    part_info->active_vmem = 0;
> +    part_info->active_vmem = cxl_dstate->vmem_size / CXL_CAPACITY_MULTIPLIER;
>      part_info->next_vmem = 0;

Unrelated to this patch, but it might be a nice follow up to add a comment somewhere
near here to say that next_vmem == 0 && next_pmem == 0 corresponds to no partition
change.  I had to check the spec on that :)

> -    part_info->active_pmem = size / CXL_CAPACITY_MULTIPLIER;
> +    part_info->active_pmem = cxl_dstate->pmem_size / CXL_CAPACITY_MULTIPLIER;
>      part_info->next_pmem = 0;
>  
>      *len = sizeof(*part_info);
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 0317bd96a6..81dc3def01 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c


>      dvsec = (uint8_t *)&(CXLDVSECDevice){
>          .cap = 0x1e,
>          .ctrl = 0x2,
>          .status2 = 0x2,
> -        .range1_size_hi = ct3d->hostmem->size >> 32,
> -        .range1_size_lo = (2 << 5) | (2 << 2) | 0x3 |
> -        (ct3d->hostmem->size & 0xF0000000),
> -        .range1_base_hi = 0,
> -        .range1_base_lo = 0,
> +        .range1_size_hi = range1_size_hi,
> +        .range1_size_lo = range1_size_lo,
> +        .range1_base_hi = range1_base_hi,
> +        .range1_base_lo = range1_base_lo,
> +        .range2_size_hi = range2_size_hi,
> +        .range2_size_lo = range2_size_lo,
> +        .range2_base_hi = range2_base_hi,
> +        .range2_base_lo = range2_base_lo

Trivial but add a trailing comma.  The structure might well get bigger in future
so we may want to add stuff here and the lack of a comma will make that noisier
than it needs to be.

>      };
>      cxl_component_create_dvsec(cxl_cstate, CXL2_TYPE3_DEVICE,
>                                 PCIE_CXL_DEVICE_DVSEC_LENGTH,
> @@ -475,33 +542,62 @@ static bool cxl_setup_memory(CXLType3Dev *ct3d, Error **errp)
>      MemoryRegion *mr;
>      char *name;
>  
> -    if (!ct3d->hostmem) {
> -        error_setg(errp, "memdev property must be set");
> +    if (!ct3d->hostmem && !ct3d->hostvmem && !ct3d->hostpmem) {
> +        error_setg(errp, "at least one memdev property must be set");
>          return false;
> +    } else if (ct3d->hostmem && ct3d->hostpmem) {
> +        error_setg(errp, "[memdev] cannot be used with new "
> +                         "[persistent-memdev] property");
> +        return false;
> +    } else if (ct3d->hostmem) {
> +        /* Use of hostmem property implies pmem */
> +        ct3d->hostpmem = ct3d->hostmem;
> +        ct3d->hostmem = NULL;
>      }
>  
> -    mr = host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> -        error_setg(errp, "memdev property must be set");
> +    if (ct3d->hostpmem && !ct3d->lsa) {
> +        error_setg(errp, "lsa property must be set for persistent devices");
>          return false;
>      }
> -    memory_region_set_nonvolatile(mr, true);
> -    memory_region_set_enabled(mr, true);
> -    host_memory_backend_set_mapped(ct3d->hostmem, true);
>  
> -    if (ds->id) {
> -        name = g_strdup_printf("cxl-type3-dpa-space:%s", ds->id);
> -    } else {
> -        name = g_strdup("cxl-type3-dpa-space");
> +    if (ct3d->hostvmem) {
> +        mr = host_memory_backend_get_memory(ct3d->hostvmem);
> +        if (!mr) {
> +            error_setg(errp, "volatile memdev must have backing device");
> +            return false;
> +        }
> +        memory_region_set_nonvolatile(mr, false);
> +        memory_region_set_enabled(mr, true);
> +        host_memory_backend_set_mapped(ct3d->hostvmem, true);
> +        if (ds->id) {
> +            name = g_strdup_printf("cxl-type3-dpa-vmem-space:%s", ds->id);
> +        } else {
> +            name = g_strdup("cxl-type3-dpa-vmem-space");
> +        }
> +        address_space_init(&ct3d->hostvmem_as, mr, name);
> +        ct3d->cxl_dstate.vmem_size = mr->size;
> +        ct3d->cxl_dstate.mem_size += mr->size;
> +        g_free(name);
>      }
> -    address_space_init(&ct3d->hostmem_as, mr, name);
> -    g_free(name);
> -
> -    ct3d->cxl_dstate.pmem_size = ct3d->hostmem->size;
>  
> -    if (!ct3d->lsa) {
> -        error_setg(errp, "lsa property must be set");
> -        return false;
> +    if (ct3d->hostpmem) {
> +        mr = host_memory_backend_get_memory(ct3d->hostpmem);
> +        if (!mr) {
> +            error_setg(errp, "persistent memdev must have backing device");
> +            return false;
> +        }
> +        memory_region_set_nonvolatile(mr, true);
> +        memory_region_set_enabled(mr, true);
> +        host_memory_backend_set_mapped(ct3d->hostpmem, true);
> +        if (ds->id) {
> +            name = g_strdup_printf("cxl-type3-dpa-pmem-space:%s", ds->id);
> +        } else {
> +            name = g_strdup("cxl-type3-dpa-pmem-space");
> +        }
> +        address_space_init(&ct3d->hostpmem_as, mr, name);
> +        ct3d->cxl_dstate.pmem_size = mr->size;
> +        ct3d->cxl_dstate.mem_size += mr->size;
> +        g_free(name);
>      }
>  
>      return true;
> @@ -609,7 +705,12 @@ err_free_spdm_socket:
>  err_free_special_ops:
>      g_free(regs->special_ops);
>  err_address_space_free:
> -    address_space_destroy(&ct3d->hostmem_as);
> +    if (ct3d->hostvmem) {
> +        address_space_destroy(&ct3d->hostvmem_as);
> +    }
> +    if (ct3d->hostpmem) {
> +        address_space_destroy(&ct3d->hostpmem_as);
> +    }

These two should be in opposite order (tear down in reverse of setup)

>      return;
>  }
>  
> @@ -623,7 +724,12 @@ static void ct3_exit(PCIDevice *pci_dev)
>      cxl_doe_cdat_release(cxl_cstate);
>      spdm_sock_fini(ct3d->doe_spdm.socket);
>      g_free(regs->special_ops);
> -    address_space_destroy(&ct3d->hostmem_as);
> +    if (ct3d->hostvmem) {
> +        address_space_destroy(&ct3d->hostvmem_as);
> +    }
> +    if (ct3d->hostpmem) {
> +        address_space_destroy(&ct3d->hostpmem_as);
> +    }

Same here.  Almost worth factoring this out but it's undoing setup_memory
and I can't immediately think of what the undo version of that should be called
so maybe we can avoid that for now by leaving these here.

>  }
>  
>  /* TODO: Support multiple HDM decoders and DPA skip */
> @@ -663,11 +769,17 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
>  {
>      CXLType3Dev *ct3d = CXL_TYPE3(d);
>      uint64_t dpa_offset;
> -    MemoryRegion *mr;
> +    MemoryRegion *vmr = NULL, *pmr = NULL;
> +    AddressSpace *as;
>  
> -    /* TODO support volatile region */
> -    mr = host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> +    if (ct3d->hostvmem) {
> +        vmr = host_memory_backend_get_memory(ct3d->hostvmem);
> +    }
> +    if (ct3d->hostpmem) {
> +        pmr = host_memory_backend_get_memory(ct3d->hostpmem);
> +    }
> +
> +    if (!vmr && !pmr) {
>          return MEMTX_ERROR;
>      }
>  
> @@ -675,11 +787,22 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
>          return MEMTX_ERROR;
>      }
>  
> -    if (dpa_offset > int128_get64(mr->size)) {
> +    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
>          return MEMTX_ERROR;
>      }
>  
> -    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data, size);
> +    if (vmr) {
> +        if (dpa_offset <= int128_get64(vmr->size)) {
> +            as = &ct3d->hostvmem_as;

As a follow up it might be worth exploring if we can combine the two address spaces.
I'm not keen to do it yet, because of no simple way to test it and it's less obviously
correct than just having separate address spaces.

Would involve mapping a the two hostmem regions into a container memory region which
would be the one we use to build the address space.  Advantage would be that we wouldn't
need special handling for which region it was in here or the write path as QEMUs
normal heirarchical memory regions would handle that for us.
I'm not 100% sure it would work though!

> +        } else {
> +            as = &ct3d->hostpmem_as;
> +            dpa_offset -= vmr->size;
> +        }
> +    }
> +    else {
> +        as = &ct3d->hostpmem_as;
> +    }
> +    return address_space_read(as, dpa_offset, attrs, data, size);
>  }



>  
>  static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
> @@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
>  static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> +    MemoryRegion *mr = NULL;

No reason to set this to NULL.

>      void *lsa;
>  
> -    mr = host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {

Flip logic to return early.  Nicer anyway plus reduces diff
making this slightly easier to review.


> +        mr = host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
>  
> -    lsa = memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(buf, lsa, size);
> +        lsa = memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(buf, lsa, size);
> +        return size;
> +    }
>  
> -    return size;
> +    return 0;

Hmm. Maybe this should return an error, but then we can't use the uint64_t as a return
value.  As this function would never be called with !ct3d->lsa let's leave it as it stands.

>  }
>  
>  static void set_lsa(CXLType3Dev *ct3d, const void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> -    void *lsa;
> +    MemoryRegion *mr = NULL;
> +    void *lsa = NULL;
As above these NULL values aren't read.
>  
> -    mr = host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {

Flip logic here as well

> +        mr = host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
>  
> -    lsa = memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(lsa, buf, size);
> -    memory_region_set_dirty(mr, offset, size);
> +        lsa = memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(lsa, buf, size);
> +        memory_region_set_dirty(mr, offset, size);
> +    }
>  

> diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> index e59ba22387..6893f54e28 100644
> --- a/tests/qtest/cxl-test.c
> +++ b/tests/qtest/cxl-test.c
> @@ -40,32 +40,46 @@
>    "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
>    "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
>  
> -#define QEMU_T3D \
> +#define QEMU_T3D_DEPRECATED \
>    "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> -  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \

This belongs in previous patch. 

> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
>    "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
>  

Rest looks good to me.

Jonathan


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4CBE4C4332F
	for <linux-cxl@archiver.kernel.org>; Mon, 19 Dec 2022 16:12:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230226AbiLSQMq (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 19 Dec 2022 11:12:46 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:48750 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229618AbiLSQMp (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 19 Dec 2022 11:12:45 -0500
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2054.outbound.protection.outlook.com [40.107.93.54])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4077B95A0
        for <linux-cxl@vger.kernel.org>; Mon, 19 Dec 2022 08:12:44 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=G7pzW9HoGQh3fGNs2s5qOcApBAwNAMYNOZNtb9ihcf2FeBpTJUjFuTXoXXEeA6FV6n07YMXZNfNwZjLC06+Lax0nwS+7+FkAMauJXf8zZca7cX2PWGerJE/Gpl0uPMvFZC2Lvfe0yUyTcusAB+5909JxiOKQze/isC9g91RyoPpAR19uow5EseW5kpVah11dex9RPtVTYI1nZ4lTFXgnq4HcLrbH3GMaFWUY7QZ1gEjOnKLuUVfFntgkoRrlFpBcLmAf00gmhiANugY6xsRqSg9ph/MALr9MOuz9kx2QjEKFgOimWZytaVhSCkO7DcttcLrC30XGn8GneyvNe/+Lig==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=WIlNWpRvNQiagD5PJ1KNa8BiVxUMfoI+XYyZg/Ce/s8=;
 b=KzZYfTPLhlBjKovronR0+dDnKtNryOaM+5d3ZGunlp0cyN0zfeH6pvDyRN4IZ+G0q7UXY7wU/AXAU9MFEvP0MGat0J30oP2SM3ijNiPCo60hODmOgYeQlX5h14PztXNQFVrdW7vV6GmZOy5YNc/3quQS6xrQKnL2ZMibF+Ob5RYgz3CtUZSCNyfhez9KXBHLv30n8bWGB6ZKeOqcKMTqX82wAFLj5jrOHWwpVDN9G8UzrDRZQFPfg3AgqUPB0SwGWtJwZcOToFeFNeSc48hzCHZqzN9cNskXWfinCd8GYHfR/riUJmblligr0+DlT3RLfhTVYysnXRuD+lgcO/4KhQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=WIlNWpRvNQiagD5PJ1KNa8BiVxUMfoI+XYyZg/Ce/s8=;
 b=qfKCPWV3MMhKu0h+6mYzYWjrirpHRm0DDqBh6HudKa83F/duQXbhZzVthU6bi6VBtKCNYA+AJ48CKtHglQfaEPwkKwRF9O4CGo520DuksOrw9im2ErPIDVKWCu24s4O0sv6HVOD6fX2kloqXT6+WpwnQPsiv1qocHbqWqG1muB0=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by DM4PR17MB6293.namprd17.prod.outlook.com (2603:10b6:8:10b::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.5924.16; Mon, 19 Dec
 2022 16:12:41 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df%6]) with mapi id 15.20.5924.016; Mon, 19 Dec 2022
 16:12:41 +0000
Date: Mon, 19 Dec 2022 11:12:34 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org, alison.schofield@intel.com,
        dave@stgolabs.net, a.manzanares@samsung.com, bwidawsk@kernel.org,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y6CNcuIzUVmKL0SM@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <20221219124211.000032b7@Huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20221219124211.000032b7@Huawei.com>
X-ClientProxiedBy: MN2PR14CA0003.namprd14.prod.outlook.com
 (2603:10b6:208:23e::8) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|DM4PR17MB6293:EE_
X-MS-Office365-Filtering-Correlation-Id: 588dac1c-5e18-443a-7312-08dae1dbdac2
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: dbMkEYwRRNHd5V2Mw2MewWMmbcFohBe9XZPCplhJ52oiBhohAkqfAJcewFMlmIAzpPPG8Av/KyVv7sflHMFUgmBUv9nP2GJZA0t9LGCNZa6FzHhroQlWOE3MA330L+5Wc1fCOVMxG5b2j5ZPQrj1If7LQ1yzwuLJ4xs8PLQAnYl9hnuaR50LGXijx5jK3AalPJnpUNoh3SPzDCIY3cxFJSY6SkxK6wjyfhGbtD9uoeQn+mcQH87fahr9pLUcKrYMg4xbbKwWBMw5LAp1sWUpyzXqceNkhdTza7jr70jwWHGIF1Hpm4YA5064XPMtbFCBgGeS3GksbAnWfb5sdo7g3PLTojAEQOOGjCubJBANRN2RGUCR5V6ZFQ/LvYJgZUoXsHrOpEoXndXiafrlRdApn2XSpYKoZw9RObHDy1Wmq8+aX5gFUcMykMt6TdKZEz6UYB/0nroNmrPXzt6BXyOSMPmgSxCtk2EFtc1gPBiHUjImEhc5/S913+F9rMIDOUrNkJQnPVFO5HJ4IY1usQukCdyBFod60GJaZ7FwJsRxGl3lJnxpYXH1vY/dxI8l+fm04U6+khxAFRCGv/jsU+Vgf7Nw8Lft/diQHyZaVuHdTJRk0FmSiQFYI6xR/khOCqz9VD5dL3JZhi4l+Ho8Iw+dtw==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(346002)(136003)(376002)(396003)(366004)(39840400004)(451199015)(2616005)(5660300002)(7416002)(6486002)(6666004)(478600001)(83380400001)(6916009)(316002)(186003)(4326008)(66556008)(66946007)(66476007)(8676002)(8936002)(6506007)(41300700001)(44832011)(26005)(6512007)(2906002)(86362001)(36756003)(38100700002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?T+BA/j9LEKHdLR5jslh2McSKTp23ZvTtMS5Cnf17Uyj9yaY8Oryl0TgltMhr?=
 =?us-ascii?Q?Ni9NTbcW/nm29gYZzQLVDXueGxAyhKE9kmRj1Wa0Q5N6E095e1dQUSLYsk2y?=
 =?us-ascii?Q?51uyxqFk5dB05/1MGJvYy8GlplD1w2XaLa4ySh4wH4HSwCzIcFuOnwW5D+V5?=
 =?us-ascii?Q?dkoVUwbdzFjNIyELaAjRzAnftQqm8znV0a2dWM1A+YvVRzCoGqZ3eTF9GtmG?=
 =?us-ascii?Q?EG/wNEYLcyPd5jUBJAA/9g499LOdCQ/vBzE3F0fqnUZY4Zo3THGun9xHLLWB?=
 =?us-ascii?Q?iTfdL8rCCog0crZajp2XIA9g8nVSfGwowragphANgG7d73wnQ9PXzc5eDlB9?=
 =?us-ascii?Q?ikGIWczESPH1n9EfwSuxeuy2RDbubyyjz8xfnlJne3VOiL0anXsrjg/UT2uD?=
 =?us-ascii?Q?uu+AdhvJmHQkeY4MFMNtkECbjvj3OxtNtHj8hMejlv+2Cl2Pa8qow6SgYqUU?=
 =?us-ascii?Q?MljNVg+liGz2fIzfhZXJvOzcXe7jiwHmKPLrs1uKlgmfchhH7IHmXEdADHAJ?=
 =?us-ascii?Q?RquIjo9Cb4UyyYHUQ93XjEOMU/GSuqhbLo/PgDcyzQOPpk3Wu3EjgP4MrdDT?=
 =?us-ascii?Q?JjizkLQWHqSSpMm13+DRPXogku/q8eFM3Zt70RGNfSCZRmfETkA4VRAZaqS6?=
 =?us-ascii?Q?KsJxxX6r5uv6QsjQ6KxQON4j1S0kpotLursYwnQNBOUG4WaZUf3PAaEevFC4?=
 =?us-ascii?Q?qXlezia3IHMtL4Hio9CiVzrEbAklvE0vbm8cx+Pp+bp5b/lmQf4WdXCvH3Nh?=
 =?us-ascii?Q?3NLF+mS835ht7S3UACjS608tBQBUiCEmR/AiODkJqrkTE3f4+4NREdISoNJR?=
 =?us-ascii?Q?4BfW4QGnkrCc2Ye2H5+iBqTwgFpMHmGm7IEF/kLBnWXhh5CmR9A6Ps/jPi1J?=
 =?us-ascii?Q?mcCJiyLM4GxeihsHYuQEpt6Sofwq02bv0J2RXHYDUjSKGdKo26gMgpWUVBAl?=
 =?us-ascii?Q?KtQRD2tkuKhTFNSKFezusQapCvytj0mdHIxOguaV98vSIBnTdqMmg4PMUoOa?=
 =?us-ascii?Q?J8iDRJGiurRsoOa2OFSLYBVC4lEWeU60mQAaPbcMhhCnu2og73kixh5CCZgQ?=
 =?us-ascii?Q?c2ogv3Ww8leXGeZrqRQXrFpgX4vYiZG4zS3+sJPDd843s6nVlP18n3OSgieo?=
 =?us-ascii?Q?EsiVjhCicYTvuAyknCC5wQ5FwxEsFyZVmWfaqXbIf089zUpmHDo2Gk/NblIU?=
 =?us-ascii?Q?PTN0c8mmHXPpMSH3wrSUJW6nrzv+7PTJb1JoZf3uh+OidnozfJkixmxBsNrZ?=
 =?us-ascii?Q?aMQZAybBZTubcWTvLWoPsOiXrOsQPYpQjWJiWqqGrTwofWD7J5R++AqWQx3V?=
 =?us-ascii?Q?aPgSGJfzbyRucJUcYv0o9ob4nkKAqffSQh3cf8bSczAOykzz+6scyLVugoBL?=
 =?us-ascii?Q?5mbqctRv/pPq9Q3mI7wKbvNgXLBy6OE1ZishtQyLOu4d1kqZFODUt7+dzjCI?=
 =?us-ascii?Q?Foc1qGKKyBTyRhvKkVCyjyJqnLOzg3i9fz68eApTYSvvw9djQVBvIKJZqePR?=
 =?us-ascii?Q?NgRwcu7XREBYBCn/v1WGJavNT7AxBTZRDnU+HaMf6oYwgyqkdfBTNLJwQPer?=
 =?us-ascii?Q?CjIV0Vn8YarCtkgXmpaMi/WGxu3MYMmErSWaCVi6NnrCpjMk1uKGgdT9CwPh?=
 =?us-ascii?Q?8w=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 588dac1c-5e18-443a-7312-08dae1dbdac2
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 19 Dec 2022 16:12:41.2797
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: e5yOymBQD6Hir781vC6hCIhcYvjV9EHtdNMWCX3oBVuOqZ6upArf0Xmm/sIu4SHM5RKSjC7li5RBsZ/37OcXmglwrFacN6QTtHqxeq9c0Qc=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM4PR17MB6293
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, Dec 19, 2022 at 12:42:11PM +0000, Jonathan Cameron wrote:
> As a process thing, when reworking a patch I picked up for the
> CXL qemu gitlab tree, drop the SOB that I added as it's not relevant
> to the new patch.
> 

ack

> Still no need to post a new version unless you particularly
> want to or there are other changes to make.

ack

> > +Deprecations
> > +------------
> > +
> > +The Type 3 device [memdev] attribute has been deprecated in favor
> > +of the [persistent-memdev] and [volatile-memdev] attributes. [memdev]
> 
> That's not quite correct as it sort of implies we could previously use
> memdev for the volatile case.

An early version of the patch explicitly errored out / warned the user
if they attempted to do this, but that got rebuffed.  This could be
added back in.

> > -    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data, size);
> > +    if (vmr) {
> > +        if (dpa_offset <= int128_get64(vmr->size)) {
> > +            as = &ct3d->hostvmem_as;
> 
> As a follow up it might be worth exploring if we can combine the two address spaces.
> I'm not keen to do it yet, because of no simple way to test it and it's less obviously
> correct than just having separate address spaces.
> 
> Would involve mapping a the two hostmem regions into a container memory region which
> would be the one we use to build the address space.  Advantage would be that we wouldn't
> need special handling for which region it was in here or the write path as QEMUs
> normal heirarchical memory regions would handle that for us.
> I'm not 100% sure it would work though!
> 

Originally I had tried putting them both into one, with the thought that
since it's technically one device address space there should only be one
way to access the address space instead of two.

After investigating, the address space has to be initialized with a
memdev, and an address space only supports a single memdev, so i settled
on two address spaces in order to keep the memdevs separate (considering
each region may have different attributes).

This opens the question as to how to actually represent a persistent
memory device that can be partitioned as volatile.

Consider the following setup:

device[pmem 512mb, volatile 512 mb]
produces:
    memdev(512mb, pmem) && memdev(512mb, volatile)

But if I partition the device to 256p/768v, when i access data in range
[256mb,512mb), then i have volatile data going into the persistent memory
store by nature of the fact that the capacity is located in that memdev.

An alternative would be to require a vmem region the same size as the
pmem region (+ whatever additional volatile capacity), but this
means using 2x the resources to represent the real capacity of the
device. That's not good.

Another alternative would be to create a wrapper memdev that encompasses
persistent and volatile operations, and then create the partitioning
logic on top of it, such that it can use a single memdev while handling
whatever sematics only apply to each individual region.

The tl;dr here:  Going down to a single address space would probably
require writing a wrapper memdev that abstracts away all the
partitioning logic.  Maybe that's worth it?

> > @@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
> >  static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
> >                      uint64_t offset)
> >  {
> > -    return size;
> > +    return 0;
> 
> Hmm. Maybe this should return an error, but then we can't use the uint64_t as a return
> value.  As this function would never be called with !ct3d->lsa let's leave it as it stands.
> 
> >  }

I originally wanted to do that, but I chose to keep the current contract
semantics so as to minimize the change set.  I agree though that this
should probably return an error.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5DABDC4332F
	for <linux-cxl@archiver.kernel.org>; Mon, 19 Dec 2022 17:25:12 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231693AbiLSRZL (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 19 Dec 2022 12:25:11 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:54872 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229618AbiLSRZJ (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 19 Dec 2022 12:25:09 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 56719D7E
        for <linux-cxl@vger.kernel.org>; Mon, 19 Dec 2022 09:25:07 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4NbRLp38H2z67KPP;
        Tue, 20 Dec 2022 01:21:06 +0800 (CST)
Received: from localhost (10.81.210.222) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Mon, 19 Dec
 2022 17:25:03 +0000
Date: Mon, 19 Dec 2022 17:25:02 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Gregory Price <gourry.memverge@gmail.com>, <qemu-devel@nongnu.org>,
        <linux-cxl@vger.kernel.org>, <alison.schofield@intel.com>,
        <dave@stgolabs.net>, <a.manzanares@samsung.com>,
        <bwidawsk@kernel.org>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20221219172502.00001338@Huawei.com>
In-Reply-To: <Y6CNcuIzUVmKL0SM@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
        <20221219124211.000032b7@Huawei.com>
        <Y6CNcuIzUVmKL0SM@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.210.222]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, 19 Dec 2022 11:12:34 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> On Mon, Dec 19, 2022 at 12:42:11PM +0000, Jonathan Cameron wrote:
> > As a process thing, when reworking a patch I picked up for the
> > CXL qemu gitlab tree, drop the SOB that I added as it's not relevant
> > to the new patch.
> >   
> 
> ack
> 
> > Still no need to post a new version unless you particularly
> > want to or there are other changes to make.  
> 
> ack
> 
> > > +Deprecations
> > > +------------
> > > +
> > > +The Type 3 device [memdev] attribute has been deprecated in favor
> > > +of the [persistent-memdev] and [volatile-memdev] attributes. [memdev]  
> > 
> > That's not quite correct as it sort of implies we could previously use
> > memdev for the volatile case.  
> 
> An early version of the patch explicitly errored out / warned the user
> if they attempted to do this, but that got rebuffed.  This could be
> added back in.

Ah. I was unclear. I just mean that the deprecation text here is a little
misleading.  Not commenting on the functionality in this patch.

> 
> > > -    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data, size);
> > > +    if (vmr) {
> > > +        if (dpa_offset <= int128_get64(vmr->size)) {
> > > +            as = &ct3d->hostvmem_as;  
> > 
> > As a follow up it might be worth exploring if we can combine the two address spaces.
> > I'm not keen to do it yet, because of no simple way to test it and it's less obviously
> > correct than just having separate address spaces.
> > 
> > Would involve mapping a the two hostmem regions into a container memory region which
> > would be the one we use to build the address space.  Advantage would be that we wouldn't
> > need special handling for which region it was in here or the write path as QEMUs
> > normal heirarchical memory regions would handle that for us.
> > I'm not 100% sure it would work though!
> >   
> 
> Originally I had tried putting them both into one, with the thought that
> since it's technically one device address space there should only be one
> way to access the address space instead of two.
> 
> After investigating, the address space has to be initialized with a
> memdev, and an address space only supports a single memdev, so i settled
> on two address spaces in order to keep the memdevs separate (considering
> each region may have different attributes).

I think an address space needs a memory region, not a memdev.
Initialize a container region with memory_region_init()
We could then add the two memdev associated regions (with different 
attributes) as subregions using memory_region_add_subregion()

Similar is done for the system memory
https://elixir.bootlin.com/qemu/latest/source/softmmu/physmem.c#L2675
creates it.  Then it's mostly accessed by get_system_memory()

Memory is then added to that at particular base addresses via for example
https://elixir.bootlin.com/qemu/latest/source/hw/arm/virt.c#L2210
and similar.
I think we can do the same here.

> 
> This opens the question as to how to actually represent a persistent
> memory device that can be partitioned as volatile.
> 
> Consider the following setup:
> 
> device[pmem 512mb, volatile 512 mb]
> produces:
>     memdev(512mb, pmem) && memdev(512mb, volatile)
> 
> But if I partition the device to 256p/768v, when i access data in range
> [256mb,512mb), then i have volatile data going into the persistent memory
> store by nature of the fact that the capacity is located in that memdev.
> 
> An alternative would be to require a vmem region the same size as the
> pmem region (+ whatever additional volatile capacity), but this
> means using 2x the resources to represent the real capacity of the
> device. That's not good.

Do we care enough about the overhead, given this is emulation only?
Not that I think this is the way to go

> 
> Another alternative would be to create a wrapper memdev that encompasses
> persistent and volatile operations, and then create the partitioning
> logic on top of it, such that it can use a single memdev while handling
> whatever sematics only apply to each individual region.
> 
> The tl;dr here:  Going down to a single address space would probably
> require writing a wrapper memdev that abstracts away all the
> partitioning logic.  Maybe that's worth it?

For current setup, I think we can just create memory region that handles both of them.

For the partitioning case, lots of options.  I'm not sure what will work best.
Maybe we just decide we don't care if a persistent region (memdev-pmem) is presented
as volatile. I don't think it will do any real harm in the emulation, but maybe
I'm wrong on that?

> 
> > > @@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
> > >  static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
> > >                      uint64_t offset)
> > >  {
> > > -    return size;
> > > +    return 0;  
> > 
> > Hmm. Maybe this should return an error, but then we can't use the uint64_t as a return
> > value.  As this function would never be called with !ct3d->lsa let's leave it as it stands.
> >   
> > >  }  
> 
> I originally wanted to do that, but I chose to keep the current contract
> semantics so as to minimize the change set.  I agree though that this
> should probably return an error.

Lets leave it for now.

Curious question on this lot. How are you testing it?  Some exciting scripts
to bring the hdm decoders up etc for the volatile region? Or some prototype
driver code?

Jonathan


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2E88AC4332F
	for <linux-cxl@archiver.kernel.org>; Mon, 19 Dec 2022 17:55:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229712AbiLSRz5 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 19 Dec 2022 12:55:57 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60726 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231726AbiLSRz4 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 19 Dec 2022 12:55:56 -0500
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2044.outbound.protection.outlook.com [40.107.237.44])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 23802BC8C
        for <linux-cxl@vger.kernel.org>; Mon, 19 Dec 2022 09:55:55 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=TBoB5lwVoZLIyIAXEInvK/TjalbKMMm34xYpNNc+jh1a8sRqE39SlCshhYbHCQJ1zVGW3UNLZCGoRBke2Db7DKmLzQQ7KbxJjZ0HLl1DVP/zfXFQJauUWnEHcibnvZf39fBsF4clVMaCGf2XXajG7gS2I8GD1TwtJSJNfpLQRMXooL626vXtA+UNWIbx99Kqi5GLQ3UboOILXUCpJWOZb/AE9FPzum1RH8yZWlH3FlWF3s/zwHTVPJ1EvDIKJR9bTS3qatXSe6WW6xUPo9XDHSY/wilkY9fnLJFFZXCSZ2Jr/Bwlz/KVOdZfU8R4k6Xl4WbIU3miw87XZPyZmUf1/Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=ydvMM7ue9jj1FPbyDoIu88XHQsLSu9iE8hO+Rpqb/AM=;
 b=VfmdVhFT/FbFEKOOefwlB8VsrmYRSLJg6JW2dRSq1OC9LKhRP/TfrRmeoBigKuqCpPMxHJnYMkgW9bn69ApQntfrR/nctHMaFbLdhRkFRTjnYKxMQFcXNAUOXXp7+tjGsSYwY1CIKILVEjpjHxhLw0qOYJ2GaQU9//Ibyr2XxQNrEg4yh40IyOfrC/sfAbU1sdhdsxpeFMgiTPnS/adezhqBmTsOaXIaUR/ODkYX15ZurTA0VdHI4ynn5LqZE/jO74wLKT0EB3e6RfHuHzjDP2q2kIe8hNCJdmyX6SqinhiDl+ze0PINwbuWf/KE9YvRV+ArxLayxvU6xOGVxdZVrw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ydvMM7ue9jj1FPbyDoIu88XHQsLSu9iE8hO+Rpqb/AM=;
 b=A7dlpyFUSA0VcApY26RCXJNcN3+y9ekXx/GjkfukkjF8fxTKIxl1at97rPMjAMq2LYQp/hkvOAS+/qFE7fd1YHHyUlAP1U9bXRJYBHUyE5nEYu7dezdHJtj+el9Z7OtGCnuxRx2xECDpL70GoeOmguFuhvGBxsi0jINHK9RN2dI=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by MW4PR17MB4778.namprd17.prod.outlook.com (2603:10b6:303:10b::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.5924.16; Mon, 19 Dec
 2022 17:55:47 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df%6]) with mapi id 15.20.5924.016; Mon, 19 Dec 2022
 17:55:46 +0000
Date: Mon, 19 Dec 2022 12:55:44 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org, alison.schofield@intel.com,
        dave@stgolabs.net, a.manzanares@samsung.com, bwidawsk@kernel.org,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y6CloIiuruB/h7qp@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <20221219124211.000032b7@Huawei.com>
 <Y6CNcuIzUVmKL0SM@memverge.com>
 <20221219172502.00001338@Huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20221219172502.00001338@Huawei.com>
X-ClientProxiedBy: BL0PR02CA0061.namprd02.prod.outlook.com
 (2603:10b6:207:3d::38) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|MW4PR17MB4778:EE_
X-MS-Office365-Filtering-Correlation-Id: f5ee2101-5dbe-41e1-bae6-08dae1ea41a8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: +5KAhbXRCZvbxPGyOvzfiUJSFJdT9P4ML9sYl5CC6v8yXlwlAirigdoyTDhZ25g86JUqe7rQfNDSEx77NO3oC7+0jIhZOtcG6FziULBg2ueEUByS7yGwEusZ25qW0GXqCgzY7+2kNJvUV/m5uJJyEsuA8caLYeIyiRO6CmiUFCpmPf/bYt8L1htzYySusYIkKKiUdP+jfX4vM5b8sueaCV2N0pRTcjTpTEqHCPQ59rJ0CjdgA/bClnjOIe5KH2HhubOuOIvpxnTnLk3HnGqTuuwnt8oytWdt8Bud8K8JOijroIesyIrOrjGMsrYZq1AM/NhEyxx+8I9ytLi16bReSMG/vLWnfR6U+a24s/aOBFZnHWOnr/j3FfuPAwwZyLnqpHxnQdxKHrG4O+POXTY6HT/ES1HL/xZEtCFnehdSK11wpMgTN3We/EO1qD4w0ABp7oh/7dhHX+rq5GPDo9EJixWe3cMILuwFb174yJz+wkdVtgM4czWuQgY2rvEHSJMIwTs44llBUBFC6uI7ZVAIDGZnAfvrD6d6yilixIOZQfzASwzKt/cT3Lz6/isfmiuW+rjyzqdGU110DXXYjvpXtMxySImZ7aJTlxRyPFWY6lGKaOQcYQuathzbUXrPEprzjdL4a2+XsyGeaKD5JxfvzHnPylcGeZ/sb+kD6DI7yKhSmkEKNZGyLOeZp0qF7kPI
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(39840400004)(366004)(376002)(396003)(346002)(136003)(451199015)(2906002)(86362001)(478600001)(186003)(26005)(66946007)(66476007)(4326008)(41300700001)(8676002)(2616005)(966005)(6916009)(316002)(6506007)(83380400001)(38100700002)(7416002)(8936002)(5660300002)(6486002)(44832011)(66556008)(6512007)(36756003);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?FXGK3LLLP4anFACnbT7Mkk4PMfehZw0AV+esPOF0TatEb3IQOhSxvEA9oRDM?=
 =?us-ascii?Q?wfCI66oFJUxhGCEsEhsgBEn7Lbv+aXLgxiIk1g1XeKTwG0yf2O4jvPwoBFMy?=
 =?us-ascii?Q?SMNXKB18fIJd5VHFGPgSA1W+Xe/GHwDaUyqJJRP58BLyFpTD4k+5IkjRoAaI?=
 =?us-ascii?Q?tyH/5GMqmLxHh10cXCo7lxo5wvc8QOkwSPIHMrsIjvlRYnF9XSrB2hUnVy04?=
 =?us-ascii?Q?wUt77gQQbtCOfxzzbpTb8kVnRN3smJA5TgyvaVou1oxscMe4Esxe4qSFvrI+?=
 =?us-ascii?Q?aPapCjklq7u8CLXketAR3P8xiVFd+hxdHVWUFHQFesq4CqfmQlPGSlXho1tV?=
 =?us-ascii?Q?EhaZsGAcx2LL+GsYiZrL+KBaCz2SXKt5VM2IbwNVdJ5Lc6mIoNwStX243dBA?=
 =?us-ascii?Q?qcjkgzmicia9afho3GkdY1LczRdQSRAvgAo732DxQ7eTG3d/NViUHcM4ZzOy?=
 =?us-ascii?Q?HsRupoeK/jyVQmWjRBAzf0LYDNx19EdzzieChMshkP3si3QHWgb1KWjb99Up?=
 =?us-ascii?Q?IEX7ZwfEM9bZObrQI1N03BnnHdMJaGlTbeLmfq981ziWdmYIjOfjtLYhYiw/?=
 =?us-ascii?Q?dTb2yCDNfIHVE5bcxBLV51Ji3pb06rgta6xizenJJ6lbOrOnjnUQCjvMv2xj?=
 =?us-ascii?Q?TTl2jyt1QQfGEaLL6mfr8IRMhdAyV33MC8Fg8GXmu1EZ5IPNjnEZSc8IlfJq?=
 =?us-ascii?Q?PPn2J7GIsVeNEc9TlFwirXTq7tWev+GLql39Vl3nohxoQCiIBJa7V+Kwf0Ch?=
 =?us-ascii?Q?qQ0OYKZ89l2B8qX9ru0ILwT+Fy1Qri7Y8zJxw5v69lSw3/1W8sXtlDtwlSuW?=
 =?us-ascii?Q?ePpoqTQAuylspRShP1OSrDlp3d4Nu5YCKfstdJ5zYMB4JP2xBrFca/UGwltD?=
 =?us-ascii?Q?KwO0sEZ0C0jyXYNiaWcjaR39BL1lB6CZ0ygKYBkRS3iasZOwbTAGl5dcWwUb?=
 =?us-ascii?Q?yw7r2ulzRrC3MXXtQjbCwxVow2kLgWuESJ/iv/Yc0O5IhXgIqH/qrb1RJiZM?=
 =?us-ascii?Q?9ACWxdodrG5UGtEMTRyYRFbNyfaJToaz6Ah88FXQexXRPN6o/vxNraDRdKqX?=
 =?us-ascii?Q?acpNA46ivldfXqMAKagA/R6jMvlFacZKCu+178Ok6/W89OmIFo8vkGa8Y7C6?=
 =?us-ascii?Q?oaVafJSvozeJpGM3L76PGWYxoCi3vg75949qMaHvPVtaAAbtsQ80UFP39Ysc?=
 =?us-ascii?Q?Mdvl3nj6FChuMYnGOUHMAZ3SNI5oT/7eRGAOqKrDPF3XE57ZrlWJpDE4HVbd?=
 =?us-ascii?Q?1JLGD+uBXXiTlSrO2Lhk/StiSJAd05kSy9azAP4PjSKJQtn5lvZ/vYrWpbS+?=
 =?us-ascii?Q?xgsIBoeyy/hiKvzTeHSL+QbYkVzEuD6dT1bOSt0UMo4k9IH2vmJ7o1O4l0Gt?=
 =?us-ascii?Q?62ecsN21zeloFC/J+QbFvwCYPg/WO9jITueYa1A99YlBtp86dvwkCSOKXXLZ?=
 =?us-ascii?Q?b46Qy01D2f41/VwM3LZiYEJhnQ1u5HFKaNq/t1ssWfaQPRiMRLMZF/fuQhiS?=
 =?us-ascii?Q?zpyxpPobPzCkjXv/VDc0GyCwcKjW3FCyzpOMV556AkOLwSPHpIAU4GnYavrS?=
 =?us-ascii?Q?4deNWcSrWaQrgd5dJR7qDDUitr517SnaXwXoJMw0Qo7Na+DUWgrrr2AYsY2d?=
 =?us-ascii?Q?zQ=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: f5ee2101-5dbe-41e1-bae6-08dae1ea41a8
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 19 Dec 2022 17:55:46.7613
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: FioReu0E+qHx5qQjL1DKA7fFuVvKbQ5xuS006D0n3CrRLlrk51FYu8abj0GnfetMG1Q6KOUYkJeqxdcaVqiJUY2hQkrkpuuYfpMplB4A21g=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW4PR17MB4778
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

> I think an address space needs a memory region, not a memdev.
> Initialize a container region with memory_region_init()
> We could then add the two memdev associated regions (with different 
> attributes) as subregions using memory_region_add_subregion()
> 
> Similar is done for the system memory
> https://elixir.bootlin.com/qemu/latest/source/softmmu/physmem.c#L2675
> creates it.  Then it's mostly accessed by get_system_memory()
> 
> Memory is then added to that at particular base addresses via for example
> https://elixir.bootlin.com/qemu/latest/source/hw/arm/virt.c#L2210
> and similar.
> I think we can do the same here.
>

Ah, I'm just confused then, this seems reasonable

> Curious question on this lot. How are you testing it?  Some exciting scripts
> to bring the hdm decoders up etc for the volatile region? Or some prototype
> driver code?

Unfortunately I got pulled off this work for a bit to handle something
more pressing.  I have only tested that the existing functionality
(persistent mode) works as intended, and that at least the ndctl/cxl
tools report capacity as expected.

As of right now there is no code in the driver to actually touch these
regions in a way that works to be able to online these volatile regions
- at least so far as I know.

I don't remember where I left off, but some pmem-to-ram tutorials online
suggest you could online pmem regions like this

cxl create-region -d decoder0.0 -m mem0
echo offline > /sys/devices/system/memory/auto_online_blocks
ndctl create-namespace -f --mode devdax --continue
daxctl enable-device [device name]
daxctl reconfigure-device --mode=system-ram all

However I don't think this is successful in creating the dax devices,
and therefore the reconfiguring into ram.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5FCC0C4332F
	for <linux-cxl@archiver.kernel.org>; Tue, 20 Dec 2022 15:35:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233191AbiLTPfB (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 20 Dec 2022 10:35:01 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:35464 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229758AbiLTPfA (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 20 Dec 2022 10:35:00 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E9A3BB489
        for <linux-cxl@vger.kernel.org>; Tue, 20 Dec 2022 07:34:57 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Nc0w83lHcz67L21;
        Tue, 20 Dec 2022 23:33:28 +0800 (CST)
Received: from localhost (10.81.208.216) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Tue, 20 Dec
 2022 15:34:54 +0000
Date: Tue, 20 Dec 2022 15:34:53 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Gregory Price <gourry.memverge@gmail.com>, <qemu-devel@nongnu.org>,
        <linux-cxl@vger.kernel.org>, <alison.schofield@intel.com>,
        <dave@stgolabs.net>, <a.manzanares@samsung.com>,
        <bwidawsk@kernel.org>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20221220153453.00000436@Huawei.com>
In-Reply-To: <Y6CloIiuruB/h7qp@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
        <20221219124211.000032b7@Huawei.com>
        <Y6CNcuIzUVmKL0SM@memverge.com>
        <20221219172502.00001338@Huawei.com>
        <Y6CloIiuruB/h7qp@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.81.208.216]
X-ClientProxiedBy: lhrpeml500004.china.huawei.com (7.191.163.9) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, 19 Dec 2022 12:55:44 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> > I think an address space needs a memory region, not a memdev.
> > Initialize a container region with memory_region_init()
> > We could then add the two memdev associated regions (with different 
> > attributes) as subregions using memory_region_add_subregion()
> > 
> > Similar is done for the system memory
> > https://elixir.bootlin.com/qemu/latest/source/softmmu/physmem.c#L2675
> > creates it.  Then it's mostly accessed by get_system_memory()
> > 
> > Memory is then added to that at particular base addresses via for example
> > https://elixir.bootlin.com/qemu/latest/source/hw/arm/virt.c#L2210
> > and similar.
> > I think we can do the same here.
> >  
> 
> Ah, I'm just confused then, this seems reasonable
> 
> > Curious question on this lot. How are you testing it?  Some exciting scripts
> > to bring the hdm decoders up etc for the volatile region? Or some prototype
> > driver code?  
> 
> Unfortunately I got pulled off this work for a bit to handle something
> more pressing.  

No problem. It happens to us all!

> I have only tested that the existing functionality
> (persistent mode) works as intended, and that at least the ndctl/cxl
> tools report capacity as expected.
> 
> As of right now there is no code in the driver to actually touch these
> regions in a way that works to be able to online these volatile regions
> - at least so far as I know.
> 
> I don't remember where I left off, but some pmem-to-ram tutorials online
> suggest you could online pmem regions like this
> 
> cxl create-region -d decoder0.0 -m mem0
> echo offline > /sys/devices/system/memory/auto_online_blocks
> ndctl create-namespace -f --mode devdax --continue
> daxctl enable-device [device name]
> daxctl reconfigure-device --mode=system-ram all
> 
> However I don't think this is successful in creating the dax devices,
> and therefore the reconfiguring into ram.

Sure. I only bothered testing the it in some dax modes rather than via kmem.
It 'should' work but more testing needed there.

However as you've noted, that only applies to the pmem regions at the moment.
I wondered if you'd scripted the HDM decoder setup etc for test purposes
(so what the driver will do). Alternative to that would be enabling the driver
support. Not sure if anyone is looking at that yet. Final alternative would
be to port the existing EDK2 based support to work on QEMU.  All non trivial
jobs so may take a while,

Jonathan

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0A1FFC4332F
	for <linux-cxl@archiver.kernel.org>; Tue, 20 Dec 2022 19:27:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229536AbiLTT1q (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 20 Dec 2022 14:27:46 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:54326 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229724AbiLTT1p (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 20 Dec 2022 14:27:45 -0500
Received: from NAM12-BN8-obe.outbound.protection.outlook.com (mail-bn8nam12on2073.outbound.protection.outlook.com [40.107.237.73])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 21983186A3
        for <linux-cxl@vger.kernel.org>; Tue, 20 Dec 2022 11:27:44 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=flilmcRpaB51Hw2fj/1ZOKarjQq42G8umEJZ8lmAOmY+lBw6ri8Kyar9LgQPce8uAbySFD6pB7QAuAC7m5r8WucMIgiyPjkyv2xDnuyxeG0nmTWH++mJK7qrHkuXf0HPLZtmzotijwH1UpBsyRRxJAL86YqBGYIP7HFSIc3kaJuxL7EW+NEqwbEGq/82j7BeUPZfkb98uqcLx78J3eyVVbbNSjkCa89i+wTdyiVoy7fDXzDW2z71D9hpJ0UPkK0fzTxR29KRgHT5IVdhzQV4cmHU+uBbUk32stlvEXbYiblx9Q78ORAoc3oa7mujzHB5zHiJU3TtwcPDSnj9irhKxg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=3as4TVMyY5VlHxb0SQhyBYmcK0FgnGrCFr4RPlXlxak=;
 b=SHOHBBlkQimsHEjN8WXaT88gTc93SS/epjSCQy7d09fMPHTW01Z6Hwja48UcWOxz015RM5T4zaoEdMSIzRMUNG4jdce/U6GwntUYNTZATJjh+sbb8RpjAZVm4O4u//RTQEnANBHgMq+9EZX5SE55Kv4qkSpy6OMPSMfMZ6dktVgy7N3tF4sWk46c3chfXsCzlkvuosGM7INvNgWoCg33R0F5+vzDDScultcwKbIFJB+EH24OQ6mkJW3yUQ5yqZQHoZJ+mpbj4SfMkE03XtFcxNKapAvJ0qvTsEFavfmhqoqibWrOjA7lU3qwGK5/raWAbQz5/gJAf1Kzegvck5Jyyg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=3as4TVMyY5VlHxb0SQhyBYmcK0FgnGrCFr4RPlXlxak=;
 b=f1HXI/vC0OSbvsgWCMBWhHMlYDm4HQAaqGx9NSeC3OFN1gdeNbE1Z/f3/MTKLnglL728ehmqofV5MJGOFZOW2yptaXRD36z6EjwGZ8Qi2br4a97WgkcyXcUTrzKxOr/RJ908hvwZiWEIAQfmJvom+nIMefXeUdvGjh863kkgsgA=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by DM8PR17MB4885.namprd17.prod.outlook.com (2603:10b6:8:28::9) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.5924.16; Tue, 20 Dec 2022 19:27:41 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::3299:1f35:894f:69df%6]) with mapi id 15.20.5924.016; Tue, 20 Dec 2022
 19:27:41 +0000
Date: Tue, 20 Dec 2022 14:27:31 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org, alison.schofield@intel.com,
        dave@stgolabs.net, a.manzanares@samsung.com, bwidawsk@kernel.org,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y6IMoxKZOc7eUPCg@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <20221219124211.000032b7@Huawei.com>
 <Y6CNcuIzUVmKL0SM@memverge.com>
 <20221219172502.00001338@Huawei.com>
 <Y6CloIiuruB/h7qp@memverge.com>
 <20221220153453.00000436@Huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20221220153453.00000436@Huawei.com>
X-ClientProxiedBy: BYAPR06CA0028.namprd06.prod.outlook.com
 (2603:10b6:a03:d4::41) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|DM8PR17MB4885:EE_
X-MS-Office365-Filtering-Correlation-Id: c7825579-8a48-40a1-ce14-08dae2c042da
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: DLDdqofaarON+tCe3anyIhvdv3U8NRnaZa873BCAHtK10T2mPMFICr6WkmWOZm73NFzDeGxv86DmXDC+CjPmlJtEV/uhTOwxCQ+quNQ1/JZeF119MLKhMAfMLryU9lhb1LWXUDXO8AlEdf3Mo+RCbov2z3JLt0uSc1fn3Qu0ak1xpJSdq97nJsOEP+uUovw7V4o+T4JS/9BN7IFOWpnRSg/P0QUYy9r+PXSTPom/UxnrqLlIn+zvEOqMHHzWNGcQ6H/j4klFmOneeiXDlR+sijzG5VaWUka+kI4EHeWn87+mvWNaOVP3Fh2CTDkC3Ir1PN6MMN0Gqeo2/VTA4z/Pd4hZsgKNa0IGxzBXgRtLaXhqafodQz3ORo+lD+QQGHkk1lXY3gjz3oqyr4JWJLvelJJApm9Nnp+HMDtnQ9ZVFkRrFsW86aV0gdchtOL9gUE366l9Vqpgm0ewN/YuGxXQDA+LPpJUlj7fN0cgKWzJwakHYT5k/ro321tMoP47zN/sE2SLUXVrjxFb6hhQlcnPYqvP5fHuumrShIMFQUKKTx58zveiqZgw80KMIHmnC4PDVkFvF2D0TYeVLad1EyzaYpiLi8vvqAhII70/5xzN3vY9J4+O3OxkxroBuDjVuLxqZVFOK+F39tUB89KOn4gdWA==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(136003)(376002)(396003)(366004)(39840400004)(346002)(451199015)(2906002)(86362001)(4326008)(478600001)(66556008)(6512007)(2616005)(26005)(8676002)(41300700001)(6916009)(316002)(8936002)(7416002)(6666004)(6506007)(38100700002)(5660300002)(83380400001)(6486002)(66946007)(44832011)(186003)(66476007)(36756003);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?Ffx1kAt5+T18ihhKFMZrC6SldC02KHNQdSv4TGD8EPkPi6spKFbks7nvea+Y?=
 =?us-ascii?Q?Q05FucWYRDNMQuRsEIuKgiSzd+/oaXEqU7pk10TEfBKDydVWY7GR49fj+4Y8?=
 =?us-ascii?Q?hB+EURaNS9dyGeHl3kA0Q0B7G3957qt6LXRq9TiL913cNb8qraShNIYngqOL?=
 =?us-ascii?Q?faLNESP5bqgRwa9ThzjaEOM8bxji7LM4uGXYJxcMVNz/lMn8WxJqIH6zsHzf?=
 =?us-ascii?Q?Hd29Mpljif7s6Pg+G+MDoX3+DkSr0vkGY/XWRaEBb+JAwbrJd8OlVC+Mz7i+?=
 =?us-ascii?Q?ln2Ms6UefNEDJOG+OaPFvryubDyA/jAibNdTgz3Zog/CLA7naYTgGi6sVhTq?=
 =?us-ascii?Q?JKnilPShuIQTeHn9tsnRrF02XOYiLyW89pzl0tfWKuEqo7s9452BPJT1ZAW+?=
 =?us-ascii?Q?tYZ9WHQ7IBs8f1hA8/hzLiUnu6vShaqGa46aOmbPpEc7FbK0kE1jA07zaRaQ?=
 =?us-ascii?Q?w97kpOt5uwZA03IV1VlClURADceefoCbc6torM236FJnMXHiOM0ASKMvToiE?=
 =?us-ascii?Q?5qZT12kFBwegOFMHaObZuCBU37DKOmrM9vPZjZCjkiOjHllixNuo3Z4RtBRP?=
 =?us-ascii?Q?ohnNWDRJsT78Thm9kDzu1rBWv3QUYNqNbaRfGijgfpsVRH2Yc5uWPHSRG2CX?=
 =?us-ascii?Q?7HQTKyTf437VGvEF4T9BpYc9w1TlPZx8vrdxrKJOlWOVQvK45UGpN/a1pfiW?=
 =?us-ascii?Q?EYGmcJSpIrgoF6O9ZCwFt/t/kF3KhJqvicyV9Wb7rOwSEDafUyAuWBDb69BB?=
 =?us-ascii?Q?V9AYsttg9xNqoMwhBN5Wr/TJrNMOJP2GYFSUexSlMxiWAv7f61YDSZXGKQKq?=
 =?us-ascii?Q?XgaF/pqE/L2UnFCJTXMNjP3pUpIPHvWlEC6aWAIbc3SdXyuo5h+GK8wPldsh?=
 =?us-ascii?Q?qXBNrSrtC31jisXQoZJSNs7snUDAvUkm9aDeDfVMc5Q35LKqIqL0eXa0zPOJ?=
 =?us-ascii?Q?2cfN4NbYbJEW0GF1AO/hvgYIDtU0K9gUYjah7Hi7l8Ojbgrt8AJoDALxGLtL?=
 =?us-ascii?Q?nWuaqot5T/i8V687X2R5k8uPgL/9Dh2yVFmmy8MFxnSBZDUJRgSSCmUv4gZE?=
 =?us-ascii?Q?kPAOWzk3iY6EcE1lwwzCEsZHCVxX1Jj025znfI4nzyphnjpjqxJzqpEtJJrQ?=
 =?us-ascii?Q?PlOGMP2bFelIVqwEpaorJ0C78/A9gLDByNB+3xqKVuGfB/pwRVL7Qt83PFcB?=
 =?us-ascii?Q?BrBce8LdSygrbk0K9Txq1E/RfSHynVJywc0zEBSkGSrxPi7MTHE6GFvAR4VL?=
 =?us-ascii?Q?aQ3jOsq2rbVM4MOwhQB6bnKTbu96LQVsgB6O15e4cQFmJXFUHQ2/zhWtumrG?=
 =?us-ascii?Q?MOobm4oYOEF6rjafz1RMHExfTCrKyuyVdoXMWtjeI/O2rSH7rU0V2NXwwrej?=
 =?us-ascii?Q?9LxVQRPinqx7QLNX1jjujWcdcP6AWDBqd2Yn9p9Qlu9wJzgr1W+dUicxBIjw?=
 =?us-ascii?Q?xev7YdSLFZN3ciQgCDpS9um5jCa0dS0Vb6GRchy5t5LizZr0y7tB6+/o7Vu2?=
 =?us-ascii?Q?7JvjiO8yowT12pbHAr9JRt7Yz2PQ4m0rZJOGYOWRs1dBZq2e2ohQtr79C2NQ?=
 =?us-ascii?Q?IXu1PV5+0KfrC+6T8G3zLi9Gz7zpoBebmozqLtkK+KHR5icBPZh7C4Zor8FK?=
 =?us-ascii?Q?vA=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: c7825579-8a48-40a1-ce14-08dae2c042da
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 20 Dec 2022 19:27:41.3330
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: m7uwI1QLwrOMGiLHNRlCHpEBA4F+y5le7gaFI+FtwhjTvxz/DXSyfmHdypL8PE03aRtBKBNA9ALqg/cGoR/jFv/bsiyfuFy90ObMVLfz3w0=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM8PR17MB4885
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Tue, Dec 20, 2022 at 03:34:53PM +0000, Jonathan Cameron wrote:
> > However I don't think this is successful in creating the dax devices,
> > and therefore the reconfiguring into ram.
> 
> Sure. I only bothered testing the it in some dax modes rather than via kmem.
> It 'should' work but more testing needed there.
> 
> However as you've noted, that only applies to the pmem regions at the moment.
> I wondered if you'd scripted the HDM decoder setup etc for test purposes
> (so what the driver will do). Alternative to that would be enabling the driver
> support. Not sure if anyone is looking at that yet. Final alternative would
> be to port the existing EDK2 based support to work on QEMU.  All non trivial
> jobs so may take a while,
> 
> Jonathan

Also, I'm relatively new to this corner of the kernel (mm, regions, dax,
etc), so i need to spend a week or two with uninterrupted tinkering with
how adding new memory regions from these devices is actually "supposed
to work" in a dynamic-capacity world.

At least in theory, the partitioning of persistent and volatile memory
regions on one of these type-3 devices should end up looking a bit like
dynamic capacity when doing runtime reconfiguring.

For example, considering

Device(512mb PMEM, 512 VMEM), I'd want, at least i think

CMFW-Volatile:    max window size(1024mb) - Numa 2
CMFW-Persistent:  max window size(512mb)  - Numa 3

Then we'd need the kernel support for

1) Online 2x256mb volatile regions in Numa 2
2) Online 2x256mb persistent regions in Numa 3
3) Offline persistent region (256mb:512mb)
4) Reconfigure device to 256Pmem/768Volatile
   a) change decoders in device accordingly
5) Online 1x256mb volatile region in Numa 2

The question is whether you can do this without offlining the other
adjacent regions.  I just don't know enough about the region subsystem
to say what is "correct" behavior here.

On the device side, I need to go look at the mailbox commands to go
about implementing the reconfiguration / decoder reprogramming.

I guess the "decoder" reprogramming is essentially changing the
read/write commands to adjust based on v/pmem_active vs v/pmem_size?

I suppose I can look at this chunk next.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id CFDF8C3DA7D
	for <linux-cxl@archiver.kernel.org>; Tue,  3 Jan 2023 15:57:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233158AbjACP4n (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 3 Jan 2023 10:56:43 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33600 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233135AbjACP4e (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 3 Jan 2023 10:56:34 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 62CED386
        for <linux-cxl@vger.kernel.org>; Tue,  3 Jan 2023 07:56:33 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Nmcft1qjwz6HJZv;
        Tue,  3 Jan 2023 23:51:50 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Tue, 3 Jan
 2023 15:56:30 +0000
Date: Tue, 3 Jan 2023 15:56:29 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Gregory Price <gourry.memverge@gmail.com>, <qemu-devel@nongnu.org>,
        <linux-cxl@vger.kernel.org>, <alison.schofield@intel.com>,
        <dave@stgolabs.net>, <a.manzanares@samsung.com>,
        <bwidawsk@kernel.org>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230103155629.00007466@Huawei.com>
In-Reply-To: <Y6IMoxKZOc7eUPCg@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
        <20221219124211.000032b7@Huawei.com>
        <Y6CNcuIzUVmKL0SM@memverge.com>
        <20221219172502.00001338@Huawei.com>
        <Y6CloIiuruB/h7qp@memverge.com>
        <20221220153453.00000436@Huawei.com>
        <Y6IMoxKZOc7eUPCg@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml100002.china.huawei.com (7.191.160.241) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Tue, 20 Dec 2022 14:27:31 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> On Tue, Dec 20, 2022 at 03:34:53PM +0000, Jonathan Cameron wrote:
> > > However I don't think this is successful in creating the dax devices,
> > > and therefore the reconfiguring into ram.  
> > 
> > Sure. I only bothered testing the it in some dax modes rather than via kmem.
> > It 'should' work but more testing needed there.
> > 
> > However as you've noted, that only applies to the pmem regions at the moment.
> > I wondered if you'd scripted the HDM decoder setup etc for test purposes
> > (so what the driver will do). Alternative to that would be enabling the driver
> > support. Not sure if anyone is looking at that yet. Final alternative would
> > be to port the existing EDK2 based support to work on QEMU.  All non trivial
> > jobs so may take a while,
> > 
> > Jonathan  
> 
> Also, I'm relatively new to this corner of the kernel (mm, regions, dax,
> etc), so i need to spend a week or two with uninterrupted tinkering with
> how adding new memory regions from these devices is actually "supposed
> to work" in a dynamic-capacity world.
> 
> At least in theory, the partitioning of persistent and volatile memory
> regions on one of these type-3 devices should end up looking a bit like
> dynamic capacity when doing runtime reconfiguring.
> 
> For example, considering
> 
> Device(512mb PMEM, 512 VMEM), I'd want, at least i think
> 
> CMFW-Volatile:    max window size(1024mb) - Numa 2
> CMFW-Persistent:  max window size(512mb)  - Numa 3
> 
> Then we'd need the kernel support for
> 
> 1) Online 2x256mb volatile regions in Numa 2
> 2) Online 2x256mb persistent regions in Numa 3
> 3) Offline persistent region (256mb:512mb)
> 4) Reconfigure device to 256Pmem/768Volatile
>    a) change decoders in device accordingly
> 5) Online 1x256mb volatile region in Numa 2
> 
> The question is whether you can do this without offlining the other
> adjacent regions.  I just don't know enough about the region subsystem
> to say what is "correct" behavior here.

Whilst you probably 'can' do fine grained offline / online (to some
degree anyway) I'm not sure if people consider it an important
usecase. If decoder reprogramming is involved things will get very fiddly
so at least in first instance I'd advocate just ripping it all down and
building up again.  Or in the simple case, just block attempts to reconfigure
at the partitioning if either side is in use.

> 
> On the device side, I need to go look at the mailbox commands to go
> about implementing the reconfiguration / decoder reprogramming.
> 
> I guess the "decoder" reprogramming is essentially changing the
> read/write commands to adjust based on v/pmem_active vs v/pmem_size?

Yup.  We also need multiple decoder support in general in QEMU.
It's not that high on my list as my main focus this cycle is going
to be on reducing the out of tree patch set by upstreaming stuff.

> 
> I suppose I can look at this chunk next.

Great.

Jonathan



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.lore.kernel.org (Postfix) with ESMTPS id 458AAC3DA7D
	for <qemu-devel@archiver.kernel.org>; Tue,  3 Jan 2023 16:03:28 +0000 (UTC)
Received: from localhost ([::1] helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces@nongnu.org>)
	id 1pCjkV-0003Po-5a; Tue, 03 Jan 2023 11:02:47 -0500
Received: from eggs.gnu.org ([2001:470:142:3::10])
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <gourry.memverge@gmail.com>)
 id 1pCjkT-0003P4-UB
 for qemu-devel@nongnu.org; Tue, 03 Jan 2023 11:02:45 -0500
Received: from mail-yw1-x1143.google.com ([2607:f8b0:4864:20::1143])
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.90_1) (envelope-from <gourry.memverge@gmail.com>)
 id 1pCjkS-00072o-2F
 for qemu-devel@nongnu.org; Tue, 03 Jan 2023 11:02:45 -0500
Received: by mail-yw1-x1143.google.com with SMTP id
 00721157ae682-4a263c4ddbaso104331797b3.0
 for <qemu-devel@nongnu.org>; Tue, 03 Jan 2023 08:02:43 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112;
 h=cc:to:subject:message-id:date:from:in-reply-to:references
 :mime-version:from:to:cc:subject:date:message-id:reply-to;
 bh=TDHN064xHQdS1jqkFgm2KixRG8yuImA7A0unjHmPZ0E=;
 b=T4mBMOJNRxSljtBgY4sZOYyoBKi5VWBXaPLV2Uc2PkmP/wvH8cbK5iO0/eT20KdW4e
 BHbrVCHqcY3QKk6N9IVI7uz+ftST1l5UoZK125Ed1hwoB7HctE5lXN+T7GkHU8U2dJzL
 gPjSZpIDu3DbhpKHiWjtXR9OB3fGbjn1Um0+dlTPlRA26dIKcrNujZxZQAtzQWNPs7f3
 tHYCrI3rZZO/310u1cEodoVAO7w0AZlGSAY4JdLF0/mI+T7ZsIlxZvq413AC5uH0jT7l
 Sq9nPMEwBbQf2DegAJkTYKNFPo6XNNbGCThLQxAGBzW44R0qFdFlUtlJCkyT78j2zWYJ
 pYiw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20210112;
 h=cc:to:subject:message-id:date:from:in-reply-to:references
 :mime-version:x-gm-message-state:from:to:cc:subject:date:message-id
 :reply-to;
 bh=TDHN064xHQdS1jqkFgm2KixRG8yuImA7A0unjHmPZ0E=;
 b=q5lAxGcAExXCHauuHqlt4yqr3dKO+2xH0Ua7vNRp1NucgJVCDP3/DpvX599x7GhRI/
 hUs9LTxRGpRcLuHQZeYT9Qc78sG+M939kq0g/+54ZZ89ZLy5mMYLF7S5R7aeyHdjju8+
 sKU7kf4tc3wXVO4RrKx2AAT3udHIvJ8bebXufPYmNxSH6ej2MJotqzWAgm8SYZrRdf7U
 Tg0y9x/4OG8M1uErBk1x+2g8NUbiPkBoa/c7XwM8IruZIi6so4gOTaWLkb0XxHVCvGLP
 WC7tGud3DUikNXwtB+uzrT+lrjNhrrRwWdZ3KPeB0WJv4s/R8LUo85cATbkanDko5avd
 ANqw==
X-Gm-Message-State: AFqh2kocKukeaw9MFRgsiIbeUOd9HASp3QFdHqwmbvd/sDPnPLvGMu1y
 NL7Bn1QUy7gWXvW90J/48+BeUd2x6M75Rb/GLw==
X-Google-Smtp-Source: AMrXdXtPxyR1Vb5c0j0TWxwbBW7VQOwtfQzBsVqowrjZqFW/NylcwiPS767HZT2+i8tIjDFQ0X4Axkgk5svru7gV4t8=
X-Received: by 2002:a81:8381:0:b0:467:9c7b:c0dc with SMTP id
 t123-20020a818381000000b004679c7bc0dcmr4150463ywf.463.1672761762619; Tue, 03
 Jan 2023 08:02:42 -0800 (PST)
MIME-Version: 1.0
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <20221219124211.000032b7@Huawei.com>
 <Y6CNcuIzUVmKL0SM@memverge.com> <20221219172502.00001338@Huawei.com>
 <Y6CloIiuruB/h7qp@memverge.com> <20221220153453.00000436@Huawei.com>
 <Y6IMoxKZOc7eUPCg@memverge.com> <20230103155629.00007466@Huawei.com>
In-Reply-To: <20230103155629.00007466@Huawei.com>
From: Gregory Price <gourry.memverge@gmail.com>
Date: Tue, 3 Jan 2023 11:02:31 -0500
Message-ID: <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gregory.price@memverge.com>, qemu-devel@nongnu.org, 
 linux-cxl@vger.kernel.org, Alison Schofield <alison.schofield@intel.com>, 
 Davidlohr Bueso <dave@stgolabs.net>, a.manzanares@samsung.com, 
 Ben Widawsky <bwidawsk@kernel.org>, hchkuo@avery-design.com.tw,
 cbrowy@avery-design.com, ira.weiny@intel.com
Content-Type: multipart/alternative; boundary="000000000000a7a5d505f15e32c1"
Received-SPF: pass client-ip=2607:f8b0:4864:20::1143;
 envelope-from=gourry.memverge@gmail.com; helo=mail-yw1-x1143.google.com
X-Spam_score_int: -20
X-Spam_score: -2.1
X-Spam_bar: --
X-Spam_report: (-2.1 / 5.0 requ) BAYES_00=-1.9, DKIM_SIGNED=0.1,
 DKIM_VALID=-0.1, DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1, FREEMAIL_FROM=0.001,
 HTML_MESSAGE=0.001, RCVD_IN_DNSWL_NONE=-0.0001, SPF_HELO_NONE=0.001,
 SPF_PASS=-0.001 autolearn=ham autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Errors-To: qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org
Sender: qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org

--000000000000a7a5d505f15e32c1
Content-Type: text/plain; charset="UTF-8"

The fine grained control would be a precursor to an emulated pooling
device.  If you can demonstrate it with a singleton attached device, you
could just implement an exclusivity table in a shared file, and set the
shared memory to a file backend as well.  Boom, shared memory pool across
qemu instances.

On Tue, Jan 3, 2023, 10:56 AM Jonathan Cameron <Jonathan.Cameron@huawei.com>
wrote:

> On Tue, 20 Dec 2022 14:27:31 -0500
> Gregory Price <gregory.price@memverge.com> wrote:
>
> > On Tue, Dec 20, 2022 at 03:34:53PM +0000, Jonathan Cameron wrote:
> > > > However I don't think this is successful in creating the dax devices,
> > > > and therefore the reconfiguring into ram.
> > >
> > > Sure. I only bothered testing the it in some dax modes rather than via
> kmem.
> > > It 'should' work but more testing needed there.
> > >
> > > However as you've noted, that only applies to the pmem regions at the
> moment.
> > > I wondered if you'd scripted the HDM decoder setup etc for test
> purposes
> > > (so what the driver will do). Alternative to that would be enabling
> the driver
> > > support. Not sure if anyone is looking at that yet. Final alternative
> would
> > > be to port the existing EDK2 based support to work on QEMU.  All non
> trivial
> > > jobs so may take a while,
> > >
> > > Jonathan
> >
> > Also, I'm relatively new to this corner of the kernel (mm, regions, dax,
> > etc), so i need to spend a week or two with uninterrupted tinkering with
> > how adding new memory regions from these devices is actually "supposed
> > to work" in a dynamic-capacity world.
> >
> > At least in theory, the partitioning of persistent and volatile memory
> > regions on one of these type-3 devices should end up looking a bit like
> > dynamic capacity when doing runtime reconfiguring.
> >
> > For example, considering
> >
> > Device(512mb PMEM, 512 VMEM), I'd want, at least i think
> >
> > CMFW-Volatile:    max window size(1024mb) - Numa 2
> > CMFW-Persistent:  max window size(512mb)  - Numa 3
> >
> > Then we'd need the kernel support for
> >
> > 1) Online 2x256mb volatile regions in Numa 2
> > 2) Online 2x256mb persistent regions in Numa 3
> > 3) Offline persistent region (256mb:512mb)
> > 4) Reconfigure device to 256Pmem/768Volatile
> >    a) change decoders in device accordingly
> > 5) Online 1x256mb volatile region in Numa 2
> >
> > The question is whether you can do this without offlining the other
> > adjacent regions.  I just don't know enough about the region subsystem
> > to say what is "correct" behavior here.
>
> Whilst you probably 'can' do fine grained offline / online (to some
> degree anyway) I'm not sure if people consider it an important
> usecase. If decoder reprogramming is involved things will get very fiddly
> so at least in first instance I'd advocate just ripping it all down and
> building up again.  Or in the simple case, just block attempts to
> reconfigure
> at the partitioning if either side is in use.
>
> >
> > On the device side, I need to go look at the mailbox commands to go
> > about implementing the reconfiguration / decoder reprogramming.
> >
> > I guess the "decoder" reprogramming is essentially changing the
> > read/write commands to adjust based on v/pmem_active vs v/pmem_size?
>
> Yup.  We also need multiple decoder support in general in QEMU.
> It's not that high on my list as my main focus this cycle is going
> to be on reducing the out of tree patch set by upstreaming stuff.
>
> >
> > I suppose I can look at this chunk next.
>
> Great.
>
> Jonathan
>
>
>

--000000000000a7a5d505f15e32c1
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"auto">The fine grained control would be a precursor to an emula=
ted pooling device.=C2=A0 If you can demonstrate it with a singleton attach=
ed device, you could just implement an exclusivity table in a shared file, =
and set the shared memory to a file backend as well.=C2=A0 Boom, shared mem=
ory pool across qemu instances.</div><br><div class=3D"gmail_quote"><div di=
r=3D"ltr" class=3D"gmail_attr">On Tue, Jan 3, 2023, 10:56 AM Jonathan Camer=
on &lt;<a href=3D"mailto:Jonathan.Cameron@huawei.com">Jonathan.Cameron@huaw=
ei.com</a>&gt; wrote:<br></div><blockquote class=3D"gmail_quote" style=3D"m=
argin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">On Tue, 20 De=
c 2022 14:27:31 -0500<br>
Gregory Price &lt;<a href=3D"mailto:gregory.price@memverge.com" target=3D"_=
blank" rel=3D"noreferrer">gregory.price@memverge.com</a>&gt; wrote:<br>
<br>
&gt; On Tue, Dec 20, 2022 at 03:34:53PM +0000, Jonathan Cameron wrote:<br>
&gt; &gt; &gt; However I don&#39;t think this is successful in creating the=
 dax devices,<br>
&gt; &gt; &gt; and therefore the reconfiguring into ram.=C2=A0 <br>
&gt; &gt; <br>
&gt; &gt; Sure. I only bothered testing the it in some dax modes rather tha=
n via kmem.<br>
&gt; &gt; It &#39;should&#39; work but more testing needed there.<br>
&gt; &gt; <br>
&gt; &gt; However as you&#39;ve noted, that only applies to the pmem region=
s at the moment.<br>
&gt; &gt; I wondered if you&#39;d scripted the HDM decoder setup etc for te=
st purposes<br>
&gt; &gt; (so what the driver will do). Alternative to that would be enabli=
ng the driver<br>
&gt; &gt; support. Not sure if anyone is looking at that yet. Final alterna=
tive would<br>
&gt; &gt; be to port the existing EDK2 based support to work on QEMU.=C2=A0=
 All non trivial<br>
&gt; &gt; jobs so may take a while,<br>
&gt; &gt; <br>
&gt; &gt; Jonathan=C2=A0 <br>
&gt; <br>
&gt; Also, I&#39;m relatively new to this corner of the kernel (mm, regions=
, dax,<br>
&gt; etc), so i need to spend a week or two with uninterrupted tinkering wi=
th<br>
&gt; how adding new memory regions from these devices is actually &quot;sup=
posed<br>
&gt; to work&quot; in a dynamic-capacity world.<br>
&gt; <br>
&gt; At least in theory, the partitioning of persistent and volatile memory=
<br>
&gt; regions on one of these type-3 devices should end up looking a bit lik=
e<br>
&gt; dynamic capacity when doing runtime reconfiguring.<br>
&gt; <br>
&gt; For example, considering<br>
&gt; <br>
&gt; Device(512mb PMEM, 512 VMEM), I&#39;d want, at least i think<br>
&gt; <br>
&gt; CMFW-Volatile:=C2=A0 =C2=A0 max window size(1024mb) - Numa 2<br>
&gt; CMFW-Persistent:=C2=A0 max window size(512mb)=C2=A0 - Numa 3<br>
&gt; <br>
&gt; Then we&#39;d need the kernel support for<br>
&gt; <br>
&gt; 1) Online 2x256mb volatile regions in Numa 2<br>
&gt; 2) Online 2x256mb persistent regions in Numa 3<br>
&gt; 3) Offline persistent region (256mb:512mb)<br>
&gt; 4) Reconfigure device to 256Pmem/768Volatile<br>
&gt;=C2=A0 =C2=A0 a) change decoders in device accordingly<br>
&gt; 5) Online 1x256mb volatile region in Numa 2<br>
&gt; <br>
&gt; The question is whether you can do this without offlining the other<br=
>
&gt; adjacent regions.=C2=A0 I just don&#39;t know enough about the region =
subsystem<br>
&gt; to say what is &quot;correct&quot; behavior here.<br>
<br>
Whilst you probably &#39;can&#39; do fine grained offline / online (to some=
<br>
degree anyway) I&#39;m not sure if people consider it an important<br>
usecase. If decoder reprogramming is involved things will get very fiddly<b=
r>
so at least in first instance I&#39;d advocate just ripping it all down and=
<br>
building up again.=C2=A0 Or in the simple case, just block attempts to reco=
nfigure<br>
at the partitioning if either side is in use.<br>
<br>
&gt; <br>
&gt; On the device side, I need to go look at the mailbox commands to go<br=
>
&gt; about implementing the reconfiguration / decoder reprogramming.<br>
&gt; <br>
&gt; I guess the &quot;decoder&quot; reprogramming is essentially changing =
the<br>
&gt; read/write commands to adjust based on v/pmem_active vs v/pmem_size?<b=
r>
<br>
Yup.=C2=A0 We also need multiple decoder support in general in QEMU.<br>
It&#39;s not that high on my list as my main focus this cycle is going<br>
to be on reducing the out of tree patch set by upstreaming stuff.<br>
<br>
&gt; <br>
&gt; I suppose I can look at this chunk next.<br>
<br>
Great.<br>
<br>
Jonathan<br>
<br>
<br>
</blockquote></div>

--000000000000a7a5d505f15e32c1--


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8DD69C3DA7D
	for <linux-cxl@archiver.kernel.org>; Tue,  3 Jan 2023 18:15:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S238652AbjACSPa (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 3 Jan 2023 13:15:30 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37610 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S238550AbjACSP3 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 3 Jan 2023 13:15:29 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id EF2642185
        for <linux-cxl@vger.kernel.org>; Tue,  3 Jan 2023 10:15:27 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4Nmgl91x61z686w8;
        Wed,  4 Jan 2023 02:10:45 +0800 (CST)
Received: from localhost (10.122.247.231) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Tue, 3 Jan
 2023 18:15:25 +0000
Date: Tue, 3 Jan 2023 18:15:24 +0000
From: Jonathan Cameron <Jonathan.Cameron@huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: Gregory Price <gregory.price@memverge.com>,
        <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        Alison Schofield <alison.schofield@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, Ben Widawsky <bwidawsk@kernel.org>,
        <hchkuo@avery-design.com.tw>, <cbrowy@avery-design.com>,
        <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230103181524.00003e14@huawei.com>
In-Reply-To: <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
        <20221219124211.000032b7@Huawei.com>
        <Y6CNcuIzUVmKL0SM@memverge.com>
        <20221219172502.00001338@Huawei.com>
        <Y6CloIiuruB/h7qp@memverge.com>
        <20221220153453.00000436@Huawei.com>
        <Y6IMoxKZOc7eUPCg@memverge.com>
        <20230103155629.00007466@Huawei.com>
        <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
Organization: Huawei Technologies R&D (UK) Ltd.
X-Mailer: Claws Mail 4.0.0 (GTK+ 3.24.29; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.122.247.231]
X-ClientProxiedBy: lhrpeml500002.china.huawei.com (7.191.160.78) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Tue, 3 Jan 2023 11:02:31 -0500
Gregory Price <gourry.memverge@gmail.com> wrote:

> The fine grained control would be a precursor to an emulated pooling
> device.  If you can demonstrate it with a singleton attached device, you
> could just implement an exclusivity table in a shared file, and set the
> shared memory to a file backend as well.  Boom, shared memory pool across
> qemu instances.

For Dynamic capacity based pooling I agree, but a lot of work is needed to make that
function correctly.  The partitioning support is a much nearer term target and
there is no real need for them to look similar - on kernel side of things I'm
not yet convinced it's even a sensible route to make them look similar as DCD
is far less constrained than partitioning and expected usecases are probably
entirely different.

Hotplug based pooling (CXL 2.0 approach) is much simpler in OS because in that
case we always get full blown hotplug events.

Whilst I agree that pooling is interesting to emulate, my preference for initial
case would be moving between virtual PCIe heirarchies attached to different
root ports / host bridges on a single host.  That may be simpler to get going / test
than multiple hosts.

Right now I'd just like a static device with mixture of pmem / volatile plus 2+
HDM decoders and kernel support for that.

Jonathan

> 
> On Tue, Jan 3, 2023, 10:56 AM Jonathan Cameron <Jonathan.Cameron@huawei.com>
> wrote:
> 
> > On Tue, 20 Dec 2022 14:27:31 -0500
> > Gregory Price <gregory.price@memverge.com> wrote:
> >  
> > > On Tue, Dec 20, 2022 at 03:34:53PM +0000, Jonathan Cameron wrote:  
> > > > > However I don't think this is successful in creating the dax devices,
> > > > > and therefore the reconfiguring into ram.  
> > > >
> > > > Sure. I only bothered testing the it in some dax modes rather than via  
> > kmem.  
> > > > It 'should' work but more testing needed there.
> > > >
> > > > However as you've noted, that only applies to the pmem regions at the  
> > moment.  
> > > > I wondered if you'd scripted the HDM decoder setup etc for test  
> > purposes  
> > > > (so what the driver will do). Alternative to that would be enabling  
> > the driver  
> > > > support. Not sure if anyone is looking at that yet. Final alternative  
> > would  
> > > > be to port the existing EDK2 based support to work on QEMU.  All non  
> > trivial  
> > > > jobs so may take a while,
> > > >
> > > > Jonathan  
> > >
> > > Also, I'm relatively new to this corner of the kernel (mm, regions, dax,
> > > etc), so i need to spend a week or two with uninterrupted tinkering with
> > > how adding new memory regions from these devices is actually "supposed
> > > to work" in a dynamic-capacity world.
> > >
> > > At least in theory, the partitioning of persistent and volatile memory
> > > regions on one of these type-3 devices should end up looking a bit like
> > > dynamic capacity when doing runtime reconfiguring.
> > >
> > > For example, considering
> > >
> > > Device(512mb PMEM, 512 VMEM), I'd want, at least i think
> > >
> > > CMFW-Volatile:    max window size(1024mb) - Numa 2
> > > CMFW-Persistent:  max window size(512mb)  - Numa 3
> > >
> > > Then we'd need the kernel support for
> > >
> > > 1) Online 2x256mb volatile regions in Numa 2
> > > 2) Online 2x256mb persistent regions in Numa 3
> > > 3) Offline persistent region (256mb:512mb)
> > > 4) Reconfigure device to 256Pmem/768Volatile
> > >    a) change decoders in device accordingly
> > > 5) Online 1x256mb volatile region in Numa 2
> > >
> > > The question is whether you can do this without offlining the other
> > > adjacent regions.  I just don't know enough about the region subsystem
> > > to say what is "correct" behavior here.  
> >
> > Whilst you probably 'can' do fine grained offline / online (to some
> > degree anyway) I'm not sure if people consider it an important
> > usecase. If decoder reprogramming is involved things will get very fiddly
> > so at least in first instance I'd advocate just ripping it all down and
> > building up again.  Or in the simple case, just block attempts to
> > reconfigure
> > at the partitioning if either side is in use.
> >  
> > >
> > > On the device side, I need to go look at the mailbox commands to go
> > > about implementing the reconfiguration / decoder reprogramming.
> > >
> > > I guess the "decoder" reprogramming is essentially changing the
> > > read/write commands to adjust based on v/pmem_active vs v/pmem_size?  
> >
> > Yup.  We also need multiple decoder support in general in QEMU.
> > It's not that high on my list as my main focus this cycle is going
> > to be on reducing the out of tree patch set by upstreaming stuff.
> >  
> > >
> > > I suppose I can look at this chunk next.  
> >
> > Great.
> >
> > Jonathan
> >
> >
> >  
> 


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D9E3EC3DA7D
	for <linux-cxl@archiver.kernel.org>; Thu,  5 Jan 2023 14:38:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233400AbjAEOiP (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 5 Jan 2023 09:38:15 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:42654 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229514AbjAEOiO (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 5 Jan 2023 09:38:14 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D48ED59331
        for <linux-cxl@vger.kernel.org>; Thu,  5 Jan 2023 06:38:11 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.206])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4NnptJ48YXz6J6Hs;
        Thu,  5 Jan 2023 22:35:52 +0800 (CST)
Received: from localhost (10.122.247.231) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Thu, 5 Jan
 2023 14:38:08 +0000
Date: Thu, 5 Jan 2023 14:38:07 +0000
From: Jonathan Cameron <Jonathan.Cameron@huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        <alison.schofield@intel.com>, <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <bwidawsk@kernel.org>,
        <gregory.price@memverge.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 2/3] tests/qtest/cxl-test: whitespace, line ending
 cleanup
Message-ID: <20230105143807.0000315a@huawei.com>
In-Reply-To: <20221128150157.97724-3-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-3-gregory.price@memverge.com>
Organization: Huawei Technologies R&D (UK) Ltd.
X-Mailer: Claws Mail 4.0.0 (GTK+ 3.24.29; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.122.247.231]
X-ClientProxiedBy: lhrpeml500003.china.huawei.com (7.191.162.67) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, 28 Nov 2022 10:01:56 -0500
Gregory Price <gourry.memverge@gmail.com> wrote:

> Defines are starting to exceed line length limits, align them for
> cleanliness before making modifications.
> 
> Signed-off-by: Gregory Price <gregory.price@memverge.com>

Hi Gregory,

I was just reordering my tree and noticed that you've only
gone with 2 space indent.  Given 4 spaces is the convention in QEMU
for other uses, I've switched my local copy of this over to 4 spaces.

Note there was also a single inconsistent 1 space indent - see below.

Jonathan

> 
> ---
>  tests/qtest/cxl-test.c | 99 +++++++++++++++++++++++-------------------
>  1 file changed, 54 insertions(+), 45 deletions(-)
> 
> diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> index c54f18e76b..e59ba22387 100644
> --- a/tests/qtest/cxl-test.c
> +++ b/tests/qtest/cxl-test.c
> @@ -8,55 +8,64 @@
>  #include "qemu/osdep.h"
>  #include "libqtest-single.h"
>  
> -#define QEMU_PXB_CMD "-machine q35,cxl=on " \
> -                     "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> -                     "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> -
> -#define QEMU_2PXB_CMD "-machine q35,cxl=on "                            \
> -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> -
> -#define QEMU_VIRT_2PXB_CMD "-machine virt,cxl=on "                      \
> -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 "  \
> -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> -
> -#define QEMU_RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
> +#define QEMU_PXB_CMD \
> +  "-machine q35,cxl=on " \
> +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> +  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> +
> +#define QEMU_2PXB_CMD \
> +  "-machine q35,cxl=on " \
> +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> +  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> + "- M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
This one only has one space.

> +
> +#define QEMU_VIRT_2PXB_CMD \
> +  "-machine virt,cxl=on " \
> +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> +  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> +  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> +
> +#define QEMU_RP \
> +  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
>  
>  /* Dual ports on first pxb */
> -#define QEMU_2RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
> -                 "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 "
> +#define QEMU_2RP \
> +  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
> +  "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 "
>  
>  /* Dual ports on each of the pxb instances */
> -#define QEMU_4RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
> -                 "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 " \
> -                 "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
> -                 "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
> -
> -#define QEMU_T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> -                 "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> -                 "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
> -
> -#define QEMU_2T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M "    \
> -                  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
> -                  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M "    \
> -                  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 "
> -
> -#define QEMU_4T3D "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> -                  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
> -                  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M "    \
> -                  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 " \
> -                  "-object memory-backend-file,id=cxl-mem2,mem-path=%s,size=256M "    \
> -                  "-object memory-backend-file,id=lsa2,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp2,memdev=cxl-mem2,lsa=lsa2,id=cxl-pmem2 " \
> -                  "-object memory-backend-file,id=cxl-mem3,mem-path=%s,size=256M "    \
> -                  "-object memory-backend-file,id=lsa3,mem-path=%s,size=256M "    \
> -                  "-device cxl-type3,bus=rp3,memdev=cxl-mem3,lsa=lsa3,id=cxl-pmem3 "
> +#define QEMU_4RP \
> +  "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 " \
> +  "-device cxl-rp,id=rp1,bus=cxl.0,chassis=0,slot=1 " \
> +  "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
> +  "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
> +
> +#define QEMU_T3D \
> +  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> +  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
> +
> +#define QEMU_2T3D \
> +  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
> +  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 "
> +
> +#define QEMU_4T3D \
> +  "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 " \
> +  "-object memory-backend-file,id=cxl-mem1,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa1,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp1,memdev=cxl-mem1,lsa=lsa1,id=cxl-pmem1 " \
> +  "-object memory-backend-file,id=cxl-mem2,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa2,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp2,memdev=cxl-mem2,lsa=lsa2,id=cxl-pmem2 " \
> +  "-object memory-backend-file,id=cxl-mem3,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa3,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp3,memdev=cxl-mem3,lsa=lsa3,id=cxl-pmem3 "
>  
>  static void cxl_basic_hb(void)
>  {


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id EBE2EC00A5A
	for <linux-cxl@archiver.kernel.org>; Thu, 19 Jan 2023 17:15:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229634AbjASRP6 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 19 Jan 2023 12:15:58 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58284 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229771AbjASRP5 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 19 Jan 2023 12:15:57 -0500
Received: from NAM10-BN7-obe.outbound.protection.outlook.com (mail-bn7nam10on2086.outbound.protection.outlook.com [40.107.92.86])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5DDEA8C910
        for <linux-cxl@vger.kernel.org>; Thu, 19 Jan 2023 09:15:54 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=C50QWXXdDqZf4V/2elmWb/D8qzGtJYhcr88G+pY9jdNEXD6K4jGk/yGn3dtuKoi1bUlaQa+OxFYf1vCTYDOX4PlTSWBRzq4o3Jze8evMEgIMKR7payaCdxZ/aFKuLzs0bq/bw1kt9xV3o88EA4d/Ocs83vT29k1r1HCrV2UtZEKpWK1+qq2Hg4DEJVE+CdHtC4V+Vq6nuGJbLZ81lK6JXegKEIfHM6/D6rBcmHt2/6md/rrx7Btm2kdyz/67IEdbhEf2P8Fmnt0x7TjmuM9NT6zJH/P4e4BZO0Vurxjf2Pe5okYhDGGe/knYURgVHmvU/mUcdZpFFc12z80BQ6/tUQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=7TAZtZYQC2r7RLC7OZPxxPxT7UGIqWQGpZX0Rxxsu0E=;
 b=NhazAtSojx9WcAAPAQ6xNXloFPURbwJR6h1xNYOE07MXFARGynfyrti6fEY4+ingcj20gmMI1XrFKAN8tYFefDUO/xiHbVe4B5qMd+cmt19FotnWb8XAjXrDysBGwZwsbgfC9baog5vmt3eATmPRGzm4YmPkMWkwk6O5sgmlulJ/txP2LMLrNWCaTZ4gOsR13oQrGvf9JkB6yn/y5N/Q5XqGUtkPlJEJya0sGZkU9eitjTrT/y2sddB1qymSI28K1NCmPy+0A2X2jshS1h4+qWMZB5CFe7xPyY2gJmis60zdyCaTH8hOAeyuNHNPCyOYPK3XFevWoLwPLoJ7dDp5sw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=7TAZtZYQC2r7RLC7OZPxxPxT7UGIqWQGpZX0Rxxsu0E=;
 b=Wb0/TumvwBKlbA31OwgXTfS2q19MHxEFqTLkJmYAI2LJYvnY1ADzwrrM7h8dv0m2zU9gM0tIPgdkB5MakGcx1WQuAJXu+pAbdRVuC55oK9QpfroHwpP7gk3NfOdMb/cs7i1sP64FvZuKuphXcIXHRHUk79Q9+jUiR/Qo+cI8VCk=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by BY5PR17MB3890.namprd17.prod.outlook.com (2603:10b6:a03:235::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6002.13; Thu, 19 Jan
 2023 17:15:51 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%4]) with mapi id 15.20.5986.023; Thu, 19 Jan 2023
 17:15:51 +0000
Date: Thu, 19 Jan 2023 12:15:45 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org,
        Alison Schofield <alison.schofield@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>, a.manzanares@samsung.com,
        Ben Widawsky <bwidawsk@kernel.org>, hchkuo@avery-design.com.tw,
        cbrowy@avery-design.com, ira.weiny@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y8l6wYKstOB/iBzT@memverge.com>
References: <20221128150157.97724-4-gregory.price@memverge.com>
 <20221219124211.000032b7@Huawei.com>
 <Y6CNcuIzUVmKL0SM@memverge.com>
 <20221219172502.00001338@Huawei.com>
 <Y6CloIiuruB/h7qp@memverge.com>
 <20221220153453.00000436@Huawei.com>
 <Y6IMoxKZOc7eUPCg@memverge.com>
 <20230103155629.00007466@Huawei.com>
 <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
 <20230103181524.00003e14@huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230103181524.00003e14@huawei.com>
X-ClientProxiedBy: SJ0PR13CA0115.namprd13.prod.outlook.com
 (2603:10b6:a03:2c5::30) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|BY5PR17MB3890:EE_
X-MS-Office365-Filtering-Correlation-Id: 39f97610-dd2e-4cbc-0791-08dafa40d07b
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: zQNuck21yp5UlZyO22fVZtepbHA5BiPi64F/2sZitFk3B9IRHPQ2KQe85KjLzM9ijdirUUQ5zsFIYcJErB5cUgoDJoPKXxm3eGBai2uG1A8j3YRkOz5sSyk5QaMXF3E5SnLnFTkcgEmD8LMRx6JbdboCg6bRdlNoyrBU5aN0zhs54RpxhioIilBj2dpWqzaB9AvZrM6SdaB4IRy+9D4qPgVslatsYIt1IzSArU4P5F/hS5O9kCae3MeC+4i4QQ6/ebB56GSUOI0P/+jnR8F9JiSAFHbxun3KzkIXZHmu1/HPE1LJ43/e6BexmsfZ08a9G5dgnQnjk4PS7fGw+ydUSQOQvNyE73PPhq77d69ag9xfCilbq4dHHgpDmIzPFAslC+3cfehKzt3xlxQFP4lmSSljb5hXSY3d2JzwvrmG7KJIaXrY9er+5p1anTxBa8uXwsxOx5VFB9Btu/JzSBRRNuivpFxr/Gq4Ajkwqo0lShU2sO02B/ANRaUV9LvOIL+ngY0cbSwMfqsHWsGbB8Fpgnnpgk0hxqAbLGQTv2HFT75nC7cS8b2/2rgFQCyKnv9Ym3pBBOIisCfCEVm+m3yU4Hpv4jv8y3LAqW4+3bY1Fm74TTzeECRngLsDjn6oBypUkY9LTnCh75tz6AUbedlFo9uMmmm+tZTwfhynUJvPa7nvi1K1ASeAkrh/Ibc8o6h8
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(376002)(366004)(346002)(136003)(39830400003)(396003)(451199015)(6486002)(26005)(66556008)(478600001)(41300700001)(6512007)(186003)(86362001)(316002)(54906003)(2616005)(38100700002)(66946007)(66476007)(6506007)(36756003)(2906002)(5660300002)(6666004)(7416002)(44832011)(4326008)(4744005)(6916009)(8936002)(8676002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?gM7rRZqp0ESSFxMqfxqWjBOb2Em98RlWl1RQW/SMR6nZrzipnCzsnh1uWr+j?=
 =?us-ascii?Q?jT05bvL6pDdpm3hjtoFwdxcOGN37x2PIBu3koMi3qs4o7ru94ITlMJQa6hWo?=
 =?us-ascii?Q?yhg4gXPKcTu7n4cmsrvtc6Uw6RFIPt1P2mI6xbQbqwgxyqrQHUuCmeUT/DbT?=
 =?us-ascii?Q?Su4TWgfjs5RozkLUdrOKcSbMA1kr0X4Q/6X506KXEe+WyrNNkmr6oytTXEy8?=
 =?us-ascii?Q?ZRgXAiVelif92xIjZn/s/p6v4c3A6NPowqJLLFX9yEMMDfp5WA7SL5xzNH2W?=
 =?us-ascii?Q?zIoj3ZpvFz4LTPAKzLG7Py68kNTExb8U27BJnrukqG8kdGFvyHYkqMoK/jCI?=
 =?us-ascii?Q?Gt1DbzfG38SMUEcRxSSQOaUcGgbBwAkHNdMtaIkfhgoQYe1XEYVobruzrCh1?=
 =?us-ascii?Q?YMbeGnnHmaHSbGmPcbt7Snra29GBnlQ4DM6RrvlTo3tUrFNnBICy3PKvmzVT?=
 =?us-ascii?Q?2njUrnscX/Dti+c5kFLUdecYuv6J2PgmgbKCgTL/yeRslWr5JxrBqxxqGVEz?=
 =?us-ascii?Q?MCSkG5DLUMuEHI4chdRMD15Z9sZ/As1CEDmqSJnQ5/2IXGKh+zF2fKIyYJu4?=
 =?us-ascii?Q?hk63kQbqa2Cr0answ97c/T6Csz6wmU528W7mfAOd97O+Cu6B1dEZ+eGmyImq?=
 =?us-ascii?Q?mpOn4pj4TUHXWM5DyJRodUtIQC5mdBQKecggtDk9CVcQrRAz71rHNAXBfoOy?=
 =?us-ascii?Q?6t2NFq+q7YnY1cATi5zOPBl7ZVp1KAF3rwcsTg7alGHaOE4qoEzseZLqDH2T?=
 =?us-ascii?Q?a+x/QTYFlXaT8frp0TvkqySMxDqmkdByVlB0aWcvNL+OjVDxcPfVkS1B72cC?=
 =?us-ascii?Q?9D/CFlTbTVEj/HYthpFw9oBLxsbOYoAvtn3gsXvEbe7/+E9T7GNvZiva9AN4?=
 =?us-ascii?Q?LSIWEw4mYtxSP4Snb1aJVStU9B27a0l9XIIZHFhPzFxAHKjJmcl22cAzneMy?=
 =?us-ascii?Q?rZ5hPRN6pQSCAjZlpFPV/oIXjAFPk4j6Ez3Z6Xhl5HBEUsWGGsk9GYv1jlZs?=
 =?us-ascii?Q?hApMKYnkpP/kK6vS8g74Ws8s1ArmeS2VnDX69ij2QFkd8wlh9lZXBRx9Irh8?=
 =?us-ascii?Q?w/YbwBT7PW0y6XodL/U3/e6jPDC90qIHJEPsc2Bw0Axhe5PkMDLYwAibQJcz?=
 =?us-ascii?Q?Xj9DeXaDhxumqeD0OOTOsXXg0ixtqzFpyoSNtiNNaCR8goLQUnxgEdYIgwrQ?=
 =?us-ascii?Q?MLG+v65Ztc2cmQwqHx9FokfnFOKw6/Fca7UIDLgHx/9HWzyu7qHXYIRL6N49?=
 =?us-ascii?Q?4a8KM7JmbckwOh+4v9yHCv2cV2A2rleMaufkZs6Gbxl7gIF63e+0M01NhGlI?=
 =?us-ascii?Q?tPIouhA8SnIDvrzhCjCLjmFuGosdcKtgSsg59lh8VJmtitUIMfnHO9yaQSEb?=
 =?us-ascii?Q?eja7LHC1iK9MRi7N74GDHgnj1GWfkOGbPE4MJ3DX8dLm0r4iMVTw37CMN8d/?=
 =?us-ascii?Q?TOg9AxsLBiXbHbASCFBG0ALUq8ssNALgMt7+xM89WL97q+F+Y96naFKMR7TL?=
 =?us-ascii?Q?08XJA36nZoczg1Uu6raLeujhP4aEXiTGGKwissAnAfLPeseDyrojDDO88sy4?=
 =?us-ascii?Q?ddDpbfraobCeAs4Bk1+tKaw5C+y//xlAeydb7LVB/zACd1btkP1pTWFotSEA?=
 =?us-ascii?Q?ew=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 39f97610-dd2e-4cbc-0791-08dafa40d07b
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 19 Jan 2023 17:15:51.0014
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: ULJ0i+Wd2DRY1Rg0AyoDWlKR+GGKdL13WqO8kCwQzv4EwC7+9mQuDkvu7qGpPZKjliavt1DhDwLgXaxHVaIiA+cMspeBgarksPD4KJabANw=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BY5PR17MB3890
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org


Found a bug, not sure how we missed this, probably happed with rebasing
and some fixups. We're presently reporting the volatile region as
non-volatile, 1 line patch.

Jonathan do you want a separate patch shipped or would you rather just
apply a fixup to the commit in your current branch?

diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 919cdf141e..1c5168e2e4 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -187,7 +187,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
     /* Now fill them in */
     if (volatile_mr) {
         rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
-                                           true, 0);
+                                           false, 0);
         if (rc < 0) {
             return rc;
         }

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id BE3B7C004D4
	for <linux-cxl@archiver.kernel.org>; Thu, 19 Jan 2023 17:31:18 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229568AbjASRbS (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 19 Jan 2023 12:31:18 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40558 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229446AbjASRbR (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 19 Jan 2023 12:31:17 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DE7548693
        for <linux-cxl@vger.kernel.org>; Thu, 19 Jan 2023 09:31:15 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.201])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4NyV1c1Mflz6J79N;
        Fri, 20 Jan 2023 01:27:16 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Thu, 19 Jan
 2023 17:31:13 +0000
Date: Thu, 19 Jan 2023 17:31:12 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Gregory Price <gourry.memverge@gmail.com>, <qemu-devel@nongnu.org>,
        <linux-cxl@vger.kernel.org>,
        Alison Schofield <alison.schofield@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, "Ben Widawsky" <bwidawsk@kernel.org>,
        <hchkuo@avery-design.com.tw>, <cbrowy@avery-design.com>,
        <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230119173112.00005acc@Huawei.com>
In-Reply-To: <Y8l6wYKstOB/iBzT@memverge.com>
References: <20221128150157.97724-4-gregory.price@memverge.com>
        <20221219124211.000032b7@Huawei.com>
        <Y6CNcuIzUVmKL0SM@memverge.com>
        <20221219172502.00001338@Huawei.com>
        <Y6CloIiuruB/h7qp@memverge.com>
        <20221220153453.00000436@Huawei.com>
        <Y6IMoxKZOc7eUPCg@memverge.com>
        <20230103155629.00007466@Huawei.com>
        <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
        <20230103181524.00003e14@huawei.com>
        <Y8l6wYKstOB/iBzT@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500001.china.huawei.com (7.191.163.213) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, 19 Jan 2023 12:15:45 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> Found a bug, not sure how we missed this, probably happed with rebasing
> and some fixups. We're presently reporting the volatile region as
> non-volatile, 1 line patch.
> 
> Jonathan do you want a separate patch shipped or would you rather just
> apply a fixup to the commit in your current branch?
I'll fix up as I'd only squash the patch in anyway.

If tomorrow is slightly less crazy busy than today I'll push out a new
tree with this and the pass through decoders support RFC
(I'll post that to the lists as well)

Jonathan

> 
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 919cdf141e..1c5168e2e4 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -187,7 +187,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>      /* Now fill them in */
>      if (volatile_mr) {
>          rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
> -                                           true, 0);
> +                                           false, 0);
>          if (rc < 0) {
>              return rc;
>          }


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8CE87C004D4
	for <linux-cxl@archiver.kernel.org>; Thu, 19 Jan 2023 22:30:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229696AbjASWap (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Thu, 19 Jan 2023 17:30:45 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60966 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230331AbjASWaG (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Thu, 19 Jan 2023 17:30:06 -0500
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (mail-bn8nam11on2040.outbound.protection.outlook.com [40.107.236.40])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1B8A5A731D
        for <linux-cxl@vger.kernel.org>; Thu, 19 Jan 2023 14:13:48 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=LaIGXbL2WjWV+KrOoWpii4cee7nXBR2Rp9JJId+vXIdHIB2Vz7p0XZH6rden6wsXfOfEa05PpgFCW3MUQamkbnm82sWqhuv8CKK0hLyEAtyWS8OR0vNEq3gST8QXJwS09YDUO5CyJqE4kGkBg1vn1zOBgcESejE2NmmQ4bl6GIn0guOsVcanGiEEQBDNXQ7+qRQRSPyZrldIShb//4vaGfDfVOxZvlLlP666VmHYWKccwTN5Eqd3Xy61u70pDJD20T4a/sMGNrN96EjfRFqCkc7LQ864UjCQP08bQU9d4FvRiBgKEF9gkmWgb1M5cXAlZJFTQJwnwPKB7+PsqhqTpg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=LYbk+yy/EM4kGOh3uhQ7vHTmarYxoItI8j67XVEfhYs=;
 b=lRNrWzuYmLz9Pptl/1ww9QvQoRhMeLJ2K0SkbG+fMAlgMZ76kPR94WulrmMfcbdkFCLGFs9OlpmaFH4C33E8LyuwZZM1+Tmk1FNd58NeOP2T66a7yWaccO/WovN/JIVjqENCfiwQzbxN+5GyuSKgDE9Dvp2TUDwCNaYoi3GpSFLO33Jjcd1MiT36lypWHoUdc4SMQJJgyvC8iMr9vk2gd7B6TZTPC5iOu76qY7XQlHxN36fq7NmmjdFWyWfNxiXVzad7J8KaWd2miy1gC3PAHyXNDt7otiawu4hrZCflE+vOP46rUaKv3BJmEViFCzG/6+q/BQY+VXFr35IuvynE0g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=LYbk+yy/EM4kGOh3uhQ7vHTmarYxoItI8j67XVEfhYs=;
 b=ZusvfRvTfEhz2LlNd86qlmQjyNOOa3jUMGzMhOSo+0CIZCqWYt6+KlEvrBtdVstKE3C7P/MeRNQP4TDmObANHtOPdQVk4CMRavbJaF/at+aJg32qL6AHfM/MT+Jny/QEpnw5ajFKpYxAd0zn9qR4wdnMlAgqH+FX8L2qby/yOu8=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by PH0PR17MB4472.namprd17.prod.outlook.com (2603:10b6:510:15::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6002.25; Thu, 19 Jan
 2023 22:13:46 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%4]) with mapi id 15.20.5986.023; Thu, 19 Jan 2023
 22:13:46 +0000
Date: Thu, 19 Jan 2023 17:13:40 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org,
        Alison Schofield <alison.schofield@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>, a.manzanares@samsung.com,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com, dan.j.williams@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y8nAlDYxCtC/vINL@memverge.com>
References: <Y6CNcuIzUVmKL0SM@memverge.com>
 <20221219172502.00001338@Huawei.com>
 <Y6CloIiuruB/h7qp@memverge.com>
 <20221220153453.00000436@Huawei.com>
 <Y6IMoxKZOc7eUPCg@memverge.com>
 <20230103155629.00007466@Huawei.com>
 <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
 <20230103181524.00003e14@huawei.com>
 <Y8l6wYKstOB/iBzT@memverge.com>
 <20230119173112.00005acc@Huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230119173112.00005acc@Huawei.com>
X-ClientProxiedBy: BY3PR05CA0058.namprd05.prod.outlook.com
 (2603:10b6:a03:39b::33) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|PH0PR17MB4472:EE_
X-MS-Office365-Filtering-Correlation-Id: 2df4b8eb-a549-496d-a997-08dafa6a6ed8
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: Vn6rQa5NuQbjPS17SlR7ZNNKRnFE5+0dgLoD0VIBtwXVBinJm+bWKfUENS+C0jeMElp7Km5Ds8/zxwLEWq7IPSw13emVQ8/NSwF+IrE6rHPet+RxVSpQQlLZnX6Q/v5fIr2UHA5c3/Q0ya2KLv1ZfPtb/Gfr3p8mJlwN338Jy/n03byBvmRIwcWYfeJ2uP+DFr00n6RUOFvygRRTxXSE1chg+1aNkL4hjsRKKtvKMiDEw9cXczGX62LDTTK7rJmgkUgODAfNPYEvPHgsE46EijG6wTYZOtNK9yPkhWyhM5Ph+iN7M/DNKpTdv+SnBHx7woi9PjNP2kKcXZdUmmkGpL827/eDXkggB9vVVte7+QjW/heno/8ZiLp4HiXjZftzAUUyA+eHYiqKqIBSRh8qKGTz3LRGMP9DLAKWrKsGJXObRdnwakRxJ9OZxMCZwFsh5sBcUgZ7ix09OCOaFNh3QeKJ3jiv5YxDaa7p7s4X7ph81bOJU+9Lyrau7RCz8TljPlSDTQsQSysnKvEQCcAO+my/QJ6KwlGQLDqZa/JbG1W3W+5xWASEnPAbJCH6DHxs41oYu0dOmOZr3BoxfLdWHShc8ZbWIjGZIp7f0NDTyRwCrTgfPJoU44yA3Quzw9qGhu8XJBpMInMYZUIWnYujMg==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230022)(346002)(136003)(366004)(396003)(376002)(39830400003)(451199015)(86362001)(5660300002)(7416002)(41300700001)(44832011)(8936002)(38100700002)(36756003)(6486002)(186003)(54906003)(478600001)(26005)(6666004)(6512007)(6506007)(316002)(6916009)(8676002)(66476007)(4326008)(66556008)(66946007)(2616005)(2906002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?FYaBFc7Tn40/CDVShj0Pjc4xBPoKa88CQCKEL9zdu80IV4ZcHUw5K/WFtStL?=
 =?us-ascii?Q?WW9UUG/4WMc9i16+GCeX8yenMbk6vsrCpKBFO54dC5UoeB7HO7kaOuuYrFcc?=
 =?us-ascii?Q?EmbXgnM/XZAWPv1eD9TKkUmNBTx6o79bodrnVGy7SbfuVucKglBCxHLX9xHh?=
 =?us-ascii?Q?aqU72PC4AzpEmdInn8C9cCMgL8V3AYi1ByvKw/VvgQSRwQFgvjmrGa+j7uxF?=
 =?us-ascii?Q?nPgDl2ypUpkoL2p7qHl+qbssqmxUE2JgyE7yR7SXXsTrm6s/8ypOZpadUTOB?=
 =?us-ascii?Q?cmV6KuxUcFksHIswhKgRZELkULcRM+ETW/EXto3JQBliSsF1xefGO6TN35Zb?=
 =?us-ascii?Q?9ihdNtOzXjH8a/xUTe2snDQp1Kdh0FLuEA+FRHZ1NUySJitVI+R4FJz7e96K?=
 =?us-ascii?Q?cIspQxYHRAvlb88ZBch1hF/vDqsMEZnRHVobpx68CcamFa2tPFCzIT1z5Suh?=
 =?us-ascii?Q?Sa8pFX/mblqcKfWQ5p6eHVDWUhAqopzUcR6QK6XxzzLgGdHi7nkoCEsl2CXN?=
 =?us-ascii?Q?UB+/f+I+h/HU2nQon0oH7rvP0ZPeQYbCDRF6/DnFAWZ/wKNVrmIUHfRhJD+g?=
 =?us-ascii?Q?yP+outt/h6HwYYSMOZ55glppHYOlGCG2AXoir5r065GjpoODhepHODNB4WYF?=
 =?us-ascii?Q?xb1rzTn/nZsFV6xHD5Zp+WOmpHx7Th2GxRoF+/kD5/ufhTyUHV833AcZOy0C?=
 =?us-ascii?Q?WExBjQhmmBbyuhS10LhvMW5wBJw5+PrSRjAbOFstpdOyMAyM+l+y89sLszx0?=
 =?us-ascii?Q?rIfz3EAhxfEaQNXaWhReQCU2/QRjWWddryk942L98QXhdpsj0sACnm0eZpEI?=
 =?us-ascii?Q?OLTFELdQJfVkNNS1zGqbZ8abNG1V2CaLBNntPUNHkLdU8ObOstbPNLLIhc2H?=
 =?us-ascii?Q?PN/ajqhH8vl3+Lk3u6ti2UQmo+rVcSCwDtyq6Yg+TIAiLqMzrgzB4DgKck6h?=
 =?us-ascii?Q?DYLk4InY82JYFmyT2fSME4COD4wotDfjtlIYoJsyp33z7UTm/y1krozcLegW?=
 =?us-ascii?Q?53iphQAEbXlQY2oLCJZ4kl4SR/M/QQPiUEDlrsdoG3Ngxss3fsIxO4iurCMS?=
 =?us-ascii?Q?umrqYjo2UEnezYxjNxT+8Y8MP9w8Ai0aC5GUPl+Z/5q0Hnk7vtS40hR/87ME?=
 =?us-ascii?Q?cUi7Hk9SfrDYJmaqQRQl8fgBwDjYhpOrow5kURkOKBrEPrYwOAijDDhex9tu?=
 =?us-ascii?Q?8J3/vGOQ5vNtU+cs4T/kPjVqYr+N9uW2y3gO64F4Je04UVt2J+7Ud7sDLHhQ?=
 =?us-ascii?Q?aZl34ScVvdrpQv3yJNdNjuzLjog7vrubX6wjLSdr8x3OUzv7yhgNHZsbzjG5?=
 =?us-ascii?Q?oT87SasrwoxacxXyXDRvD5CGhHuMGMs6cWYPgRAh+26mvFTKzX98V0Rw75SX?=
 =?us-ascii?Q?risZY1K+oN1AOW2GEfjsfutWPIF2nzQAoO8LzBsO06C2xVa7BdGUIzu1ewjW?=
 =?us-ascii?Q?ZeFLa+bqN3uVhAzgrCj/eI7Ow1QdyssHc357saA6u5UaaleALkotQDKrdqiA?=
 =?us-ascii?Q?KBdL1IpICxCU3xkl2yfUwwfLrtEy4aSqywI9b5YExtnRJYT6F6UJMp7pVvpH?=
 =?us-ascii?Q?afnCCPHS53t0Ca3RjQMCKuEY5OzNN2URhwtVA6NayYD8lOir5mMmtiGEY6YV?=
 =?us-ascii?Q?Hw=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 2df4b8eb-a549-496d-a997-08dafa6a6ed8
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 19 Jan 2023 22:13:46.2016
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 3enZPVUBF4R0fd4n64IuWPfDXgwe+aTVcXjtLSj1X9lrxbrnQYeI5lz3olHhAkob4W3em6+EFKPraBtAfyzDKjC4sDC0AdzA01Tt547R4U0=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH0PR17MB4472
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, Jan 19, 2023 at 05:31:12PM +0000, Jonathan Cameron wrote:
> On Thu, 19 Jan 2023 12:15:45 -0500
> Gregory Price <gregory.price@memverge.com> wrote:
> 
> > Found a bug, not sure how we missed this, probably happed with rebasing
> > and some fixups. We're presently reporting the volatile region as
> > non-volatile, 1 line patch.
> > 
> > Jonathan do you want a separate patch shipped or would you rather just
> > apply a fixup to the commit in your current branch?
> I'll fix up as I'd only squash the patch in anyway.
> 
> If tomorrow is slightly less crazy busy than today I'll push out a new
> tree with this and the pass through decoders support RFC
> (I'll post that to the lists as well)
> 
> Jonathan
> 

Aye aye! 

One other change to consider: the .EFI_memory_type_attr right now is set
to RESERVED.  Should this field actually be EFI_MEMORY_SP? Or is there a
reason for explicitly Reserved?

0: EfiConventionalMemory
1: EfiConventionalMemory w/ EFI_MEMORY_SP Attribute
2: EfiReservedMemoryType

I remember reading a while back that the intended marking is
special-purpose rather than reserved, but i'm hitting my wall on
knowledge.  

Dan may know, but I couldn't divine the correct setting from the kernel
(obviously this is EFI level code, so i didn't expect to).



One other thing that I am noticing:  When a CFMW is registered, an
nvdimm_bridge device becomes present in /sys/bus/cxl/devices -
regardless of whether the type3 device is persistent or volatile.

This makes me believe we aren't setting something up correctly in the
CDAT or something, but other than the below changes everything else
looks correct.  This could imply a kernel driver bug, but i've been
validating against real hardware and this behavior is not seen, even
with functional CXL memory expander devices (which the BIOS obviously
has a hand in setting up).

I started validating the DVSECs, but likewise i didn't see any
indication of error either.



diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
index 919cdf141e..4daa0cf0f6 100644
--- a/hw/mem/cxl_type3.c
+++ b/hw/mem/cxl_type3.c
@@ -132,8 +132,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
             .length = sizeof(*dsemts),
         },
         .DSMAS_handle = dsmad_handle,
-        /* Reserved - the non volatile from DSMAS matters */
-        .EFI_memory_type_attr = 2,
+        /* Reserved if NV - the non volatile from DSMAS matters
+         * otherwise label this EFI_MEMORY_SP (special purpose) */
+        .EFI_memory_type_attr = is_pmem ? 2 : 1,
         .DPA_offset = 0,
         .DPA_length = int128_get64(mr->size),
     };
@@ -187,7 +188,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
     /* Now fill them in */
     if (volatile_mr) {
         rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
-                                           true, 0);
+                                           false, 0);
         if (rc < 0) {
             return rc;
         }

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E8046C05027
	for <linux-cxl@archiver.kernel.org>; Fri, 20 Jan 2023 10:59:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229560AbjATK75 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Fri, 20 Jan 2023 05:59:57 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59978 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230070AbjATK74 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Fri, 20 Jan 2023 05:59:56 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 96526CDC3
        for <linux-cxl@vger.kernel.org>; Fri, 20 Jan 2023 02:59:54 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.207])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4NyxHY6vx3z688Kq;
        Fri, 20 Jan 2023 18:55:53 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Fri, 20 Jan
 2023 10:59:51 +0000
Date: Fri, 20 Jan 2023 10:59:50 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gregory.price@memverge.com>
CC: Gregory Price <gourry.memverge@gmail.com>, <qemu-devel@nongnu.org>,
        <linux-cxl@vger.kernel.org>,
        Alison Schofield <alison.schofield@intel.com>,
        Davidlohr Bueso <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>,
        <dan.j.williams@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230120105950.00004d27@Huawei.com>
In-Reply-To: <Y8nAlDYxCtC/vINL@memverge.com>
References: <Y6CNcuIzUVmKL0SM@memverge.com>
        <20221219172502.00001338@Huawei.com>
        <Y6CloIiuruB/h7qp@memverge.com>
        <20221220153453.00000436@Huawei.com>
        <Y6IMoxKZOc7eUPCg@memverge.com>
        <20230103155629.00007466@Huawei.com>
        <CAD3UvdQ7nZab7Y+tbc1Ox-zqzse4C16dwv6qtOAgfe4dA6_crQ@mail.gmail.com>
        <20230103181524.00003e14@huawei.com>
        <Y8l6wYKstOB/iBzT@memverge.com>
        <20230119173112.00005acc@Huawei.com>
        <Y8nAlDYxCtC/vINL@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500001.china.huawei.com (7.191.163.213) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, 19 Jan 2023 17:13:40 -0500
Gregory Price <gregory.price@memverge.com> wrote:

> On Thu, Jan 19, 2023 at 05:31:12PM +0000, Jonathan Cameron wrote:
> > On Thu, 19 Jan 2023 12:15:45 -0500
> > Gregory Price <gregory.price@memverge.com> wrote:
> >   
> > > Found a bug, not sure how we missed this, probably happed with rebasing
> > > and some fixups. We're presently reporting the volatile region as
> > > non-volatile, 1 line patch.
> > > 
> > > Jonathan do you want a separate patch shipped or would you rather just
> > > apply a fixup to the commit in your current branch?  
> > I'll fix up as I'd only squash the patch in anyway.
> > 
> > If tomorrow is slightly less crazy busy than today I'll push out a new
> > tree with this and the pass through decoders support RFC
> > (I'll post that to the lists as well)
> > 
> > Jonathan
> >   
> 
> Aye aye! 
> 
> One other change to consider: the .EFI_memory_type_attr right now is set
> to RESERVED.  Should this field actually be EFI_MEMORY_SP? Or is there a
> reason for explicitly Reserved?
> 
> 0: EfiConventionalMemory
> 1: EfiConventionalMemory w/ EFI_MEMORY_SP Attribute
> 2: EfiReservedMemoryType
> 
> I remember reading a while back that the intended marking is
> special-purpose rather than reserved, but i'm hitting my wall on
> knowledge.  
> 
> Dan may know, but I couldn't divine the correct setting from the kernel
> (obviously this is EFI level code, so i didn't expect to).

Yes, would be better to report as EfiConventionalMemory + SP
Shouldn't hugely matter from practical point of view though (I haven't
checked) as both mean driver managed and this is more about
policy than anything else.

> 
> 
> 
> One other thing that I am noticing:  When a CFMW is registered, an
> nvdimm_bridge device becomes present in /sys/bus/cxl/devices -
> regardless of whether the type3 device is persistent or volatile.
> 

That's one for Dan.  Key here is I don't think anyone is claiming the
kernel code yet supports 'hot plug / cold plug' of volatile type 3
devices.  I expect a non trivial amount of work to enable that
simply because it hasn't previously been of interest.

> This makes me believe we aren't setting something up correctly in the
> CDAT or something, but other than the below changes everything else
> looks correct.  This could imply a kernel driver bug, but i've been
> validating against real hardware and this behavior is not seen, even
> with functional CXL memory expander devices (which the BIOS obviously
> has a hand in setting up).
> 
> I started validating the DVSECs, but likewise i didn't see any
> indication of error either.
> 
> 
> 
> diff --git a/hw/mem/cxl_type3.c b/hw/mem/cxl_type3.c
> index 919cdf141e..4daa0cf0f6 100644
> --- a/hw/mem/cxl_type3.c
> +++ b/hw/mem/cxl_type3.c
> @@ -132,8 +132,9 @@ static int ct3_build_cdat_entries_for_mr(CDATSubHeader **cdat_table,
>              .length = sizeof(*dsemts),
>          },
>          .DSMAS_handle = dsmad_handle,
> -        /* Reserved - the non volatile from DSMAS matters */
> -        .EFI_memory_type_attr = 2,
> +        /* Reserved if NV - the non volatile from DSMAS matters
> +         * otherwise label this EFI_MEMORY_SP (special purpose) */
> +        .EFI_memory_type_attr = is_pmem ? 2 : 1,
>          .DPA_offset = 0,
>          .DPA_length = int128_get64(mr->size),
>      };
> @@ -187,7 +188,7 @@ static int ct3_build_cdat_table(CDATSubHeader ***cdat_table, void *priv)
>      /* Now fill them in */
>      if (volatile_mr) {
>          rc = ct3_build_cdat_entries_for_mr(table, dsmad_handle++, volatile_mr,
> -                                           true, 0);
> +                                           false, 0);
>          if (rc < 0) {
>              return rc;
>          }


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0C19DC54EAA
	for <linux-cxl@archiver.kernel.org>; Mon, 30 Jan 2023 13:11:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231469AbjA3NL5 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 30 Jan 2023 08:11:57 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:35624 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230340AbjA3NL4 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 30 Jan 2023 08:11:56 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CDF7F5B9D
        for <linux-cxl@vger.kernel.org>; Mon, 30 Jan 2023 05:11:54 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4P57pk5gz7z6880d;
        Mon, 30 Jan 2023 21:10:54 +0800 (CST)
Received: from localhost (10.122.247.231) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Mon, 30 Jan
 2023 13:11:51 +0000
Date: Mon, 30 Jan 2023 13:11:50 +0000
From: Jonathan Cameron <Jonathan.Cameron@huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        <alison.schofield@intel.com>, <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <bwidawsk@kernel.org>,
        <gregory.price@memverge.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 2/3] tests/qtest/cxl-test: whitespace, line ending
 cleanup
Message-ID: <20230130131150.000023a1@huawei.com>
In-Reply-To: <20230105143807.0000315a@huawei.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-3-gregory.price@memverge.com>
        <20230105143807.0000315a@huawei.com>
Organization: Huawei Technologies R&D (UK) Ltd.
X-Mailer: Claws Mail 4.0.0 (GTK+ 3.24.29; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.122.247.231]
X-ClientProxiedBy: lhrpeml100005.china.huawei.com (7.191.160.25) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Thu, 5 Jan 2023 14:38:07 +0000
Jonathan Cameron <Jonathan.Cameron@huawei.com> wrote:

> On Mon, 28 Nov 2022 10:01:56 -0500
> Gregory Price <gourry.memverge@gmail.com> wrote:
> 
> > Defines are starting to exceed line length limits, align them for
> > cleanliness before making modifications.
> > 
> > Signed-off-by: Gregory Price <gregory.price@memverge.com>  
> 
> Hi Gregory,
> 
> I was just reordering my tree and noticed that you've only
> gone with 2 space indent.  Given 4 spaces is the convention in QEMU
> for other uses, I've switched my local copy of this over to 4 spaces.
> 
> Note there was also a single inconsistent 1 space indent - see below.
> 
> Jonathan
> 
> > 
> > ---
> >  tests/qtest/cxl-test.c | 99 +++++++++++++++++++++++-------------------
> >  1 file changed, 54 insertions(+), 45 deletions(-)
> > 
> > diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> > index c54f18e76b..e59ba22387 100644
> > --- a/tests/qtest/cxl-test.c
> > +++ b/tests/qtest/cxl-test.c
> > @@ -8,55 +8,64 @@
> >  #include "qemu/osdep.h"
> >  #include "libqtest-single.h"
> >  
> > -#define QEMU_PXB_CMD "-machine q35,cxl=on " \
> > -                     "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > -                     "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> > -
> > -#define QEMU_2PXB_CMD "-machine q35,cxl=on "                            \
> > -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> > -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> > -
> > -#define QEMU_VIRT_2PXB_CMD "-machine virt,cxl=on "                      \
> > -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 "  \
> > -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> > -
> > -#define QEMU_RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
> > +#define QEMU_PXB_CMD \
> > +  "-machine q35,cxl=on " \
> > +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> > +  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> > +
> > +#define QEMU_2PXB_CMD \
> > +  "-machine q35,cxl=on " \
> > +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> > +  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> > + "- M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "  
> This one only has one space.
It also has a space after the - that I somehow missed. Fixed up in the version I'm
carrying. Will push out a new tree once I've caught up with some other pending items.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D11EBC54EED
	for <linux-cxl@archiver.kernel.org>; Mon, 30 Jan 2023 13:24:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S235472AbjA3NY6 (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 30 Jan 2023 08:24:58 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:41240 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229694AbjA3NY4 (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 30 Jan 2023 08:24:56 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2D4B034004
        for <linux-cxl@vger.kernel.org>; Mon, 30 Jan 2023 05:24:55 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.226])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4P585l08WQz6J9xg;
        Mon, 30 Jan 2023 21:23:55 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Mon, 30 Jan
 2023 13:24:52 +0000
Date: Mon, 30 Jan 2023 13:24:51 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        <alison.schofield@intel.com>, <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <bwidawsk@kernel.org>,
        <gregory.price@memverge.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230130132451.00002d5b@Huawei.com>
In-Reply-To: <20221128150157.97724-4-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500003.china.huawei.com (7.191.162.67) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org


> diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> index e59ba22387..6893f54e28 100644
> --- a/tests/qtest/cxl-test.c
> +++ b/tests/qtest/cxl-test.c
> @@ -40,32 +40,46 @@
>    "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
>    "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
>  
> -#define QEMU_T3D \
> +#define QEMU_T3D_DEPRECATED \
>    "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> -  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
>    "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
>  
> +#define QEMU_T3D_PMEM \
> +  "-object memory-backend-file,id=m0,mem-path=%s,size=256M " \
> +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
> +  "-device cxl-type3,bus=rp0,persistent-memdev=cxl-m0,lsa=lsa0,id=pmem0 "
naming mismatch. I've fixed up with mem0 as the device name. 
The naming isn't totally consistent so I may tweak this some more before
sending for upstream.



From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1792EC61D97
	for <linux-cxl@archiver.kernel.org>; Mon, 30 Jan 2023 17:14:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S237565AbjA3ROn (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 30 Jan 2023 12:14:43 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38054 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S234878AbjA3ROm (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 30 Jan 2023 12:14:42 -0500
Received: from NAM02-DM3-obe.outbound.protection.outlook.com (mail-dm3nam02on2086.outbound.protection.outlook.com [40.107.95.86])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A5524410B2
        for <linux-cxl@vger.kernel.org>; Mon, 30 Jan 2023 09:14:40 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=TGh9psYAXqIGIH3AQTdnTRZzBVyuyPaUa9erfSegkJ9krzKZfdA30TkBFMf+h3M/v89ltgXOBQS08eWZjcCEfdldK7Mewis/7CS+nG1XHNg3ciX3kKJwdkZVNn3Lw9nt2Aa7rvcA23lTQoa6sPOC7kRs7k2WfHkMgw4jquiRZ9RxCvpphUGo8MTu4dGuuy2HhfrPCA9dlSuIXEMGphjvl3ol0epaIt5ZpK3WHuTnk5TG2D8YjvW/OgARWR0bi3hazWnze6ccH01UiY6cJOgFUjio5l4DWC9Sugiq/t/+f9MLIkZiYu9FsYASwarXEffueAkRklYHPUoqMdmIQ0hPsg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=arNRaUPZRomFx/eLzmPoXtsThJTfFy55D8hjGRS1yiE=;
 b=RG7GQphOenuN+nVlHv+ipeGxg68lEadx91aBnrJClxyXPhBnA5w44AXjm65YjJzL7OagOFodZB5Z3wALy5K8RQNIG1ecAJlzS0oIv7SmonojpGnf69+SyrjCNetk+pQYwTaMf4LJa6KVoIWOocibWdg9s/prqu8engmEduYbd2pE/QL9ZrjuzC2itN8nwj3KVW5gJjsk+deG23mFw035bYNRC9+11g1FbHBF1lCVBg+kPTBJLvy5u7b2JEp3x8Tplh2djb4sy8OY5Ef2TvxvqykxJuljjbx9sF6lOSy1qLoYNDzY/Wu0lv+kJH9/v8XkY0lXUZvC6E4tMGA0XY43FA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=arNRaUPZRomFx/eLzmPoXtsThJTfFy55D8hjGRS1yiE=;
 b=GTIPJhJxSzY3uftxbEy1XoQG7/JjlnhwbTdNVNrdCjUXYm6Vq3LHzZtAWh6cXHJ42QksxJvfo/iHQ6HZA6jN8yNS8B/27Ef6CaJG72nKWHgbXTsDLCTsmG/TeT1AAbRWcWcPeT/s+zp2SWcHwOGJ0ETAXvH4onmCl3pil2TXRrA=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by DS0PR17MB6197.namprd17.prod.outlook.com (2603:10b6:8:d3::7) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.6043.22; Mon, 30 Jan 2023 17:14:37 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%4]) with mapi id 15.20.6043.028; Mon, 30 Jan 2023
 17:14:37 +0000
Date: Mon, 30 Jan 2023 09:37:15 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org, alison.schofield@intel.com,
        dave@stgolabs.net, a.manzanares@samsung.com, bwidawsk@kernel.org,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <Y9fWG2Owlqzkd244@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-4-gregory.price@memverge.com>
 <20230130132451.00002d5b@Huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230130132451.00002d5b@Huawei.com>
X-ClientProxiedBy: BYAPR08CA0023.namprd08.prod.outlook.com
 (2603:10b6:a03:100::36) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|DS0PR17MB6197:EE_
X-MS-Office365-Filtering-Correlation-Id: 836c208d-143d-418f-162c-08db02e576d6
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: To7qAv4+6bTKbKSQjjAWrl7bZFyfLfDG+8+4scE8Vw8zPwcu4zrmLf/7jsIoAQ9muCW5Szp7sRwJFr4bpKeLyDbR1locTUhCTzsoGlXpMVZMQsu7Oa63N+P4lY0ejf1NulnBX2Fgtr84MwfABPGW2TMBGJec4botYsk/q3NTqr73CgLgSez6k/qzLpOmV5UtJgZxm/yv3ggpMdVx9yhW+2pCuSZUYd0PVTYDhRB0pLiEzfTCuCk5NZXy9o+tlKdfTqQ7+yZ4KztIpALlyWSfOFEQ0qlygAcNiz25kZzeQc7IQ13R4Wlw6BPj8CjFSa9jwX378gbANk03M84UyOEIvxDjbbOtUVlSsHa3RkkGDG1555BsRmq0l6n9RAlZPIz2OYf/cQRiRetHupQLylkPJO8no5a7lxaeyksJzA77WtlAjU4XfpXSiNR2zBESrEZL1EMsgP1NuWYc1hufCpTcXhoiff3B6psR2tr5s10uEzHR2WHVfWBFa6C3dZbpOOz0o0NCJPc9gB8cSCXSMrw88U2KOpje2th42Ffd5sO8Avnfeo14BzbZx0uK5mhTGEGfDh8vLHFtusId8GJKYWrC/Cy3LoFgNeqTyMPeaRLm6QNJKFhcY224CW0oAHsHwKeYTIugFNOs7c1aG/wI33CCMA==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(376002)(39840400004)(396003)(346002)(366004)(136003)(451199018)(2906002)(44832011)(7416002)(86362001)(26005)(6486002)(6666004)(6506007)(5660300002)(66946007)(478600001)(8676002)(38100700002)(66556008)(41300700001)(66476007)(2616005)(6512007)(186003)(6916009)(316002)(8936002)(36756003)(4326008);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?99dLINNtH7QMQ+8FUHO5sWSMAWIYJDG3UxGTM+ZfHOzo0Y8MmxHKRlDS5yLX?=
 =?us-ascii?Q?WyIOpcnSFF9r/vwwhGeqB9E8q70iBDB2Hjl8pTp1+i5Nhf1Wr9leJ8d+llRE?=
 =?us-ascii?Q?rzvqhofWd5Ho/vBeRFimsWb9Z0S8XO9pLGwq/djNghxOse8u/NEPfaXUXknh?=
 =?us-ascii?Q?sEESq70vJohorOQj8eAIULwXvdrZX3VWJLnXrk40jg95o525eRtzLDsjoHkn?=
 =?us-ascii?Q?Hk8oihEVVjkRkRXeM0L05bEx7+U9Uz3IjJuXl44NdUL+usEyGhVK+UtRY4qK?=
 =?us-ascii?Q?RwV5jel914mr+w9Ze3Bjg7UB4AX3wJ6LjWIDChk4YBlPJKnqZUbTdPA3dPsi?=
 =?us-ascii?Q?wT3cQDAjhYUhp15nVXopj1jni3NBCWLnUvG87/kCsaLAWYtBFyRGkbRKy9Ab?=
 =?us-ascii?Q?zcEXPDSP2kNduxP9TVN+7mFo235QvV19o4KhlOvJO5+tGYLFcK4dxAXJhTjw?=
 =?us-ascii?Q?9/JsNIzHKj3wL/OUrDizXB6vmnKA6eJ/N/tDYpB6AYi0uRG7lmZCqbYlvk2V?=
 =?us-ascii?Q?DQ4qNZQxASQUcvvqEJataUnKrpt7x5BX8AJbPgzw4H2pZ0Mc5+Z1KBB6VBZ6?=
 =?us-ascii?Q?EOfwd/w/5mpFBZLTNgZIEI0EWPc5oOZVpd6Hw3koUSG0FdTO/LYqyxBacpHB?=
 =?us-ascii?Q?5fng4/PCqYubbz0SGG2+I7Zs35Ce6Vc42fNJQWoQKI5ug/WDjrDK242lw8Ht?=
 =?us-ascii?Q?tj/Ry8q58UfXqxSm9ERDCgLxAbBZwa3lKMPmlYqz5PvYByAOwhuhwoS1kOlz?=
 =?us-ascii?Q?hLYaC5h5h59Cqk8sVeV7RYgviGG4NtJERO2mXGhIvV7IMKilDw4y+Fs45Itl?=
 =?us-ascii?Q?N8Q7t6wBOZJYuiEOz/uBqAvC6HSiVMq6HpgfLXKOWDjLXQ7ygy+V5oL+f8r/?=
 =?us-ascii?Q?9UXKYwoPmdYc+KU9ZsbXYa7MlYzevoiji8Aab0HXa2xxGmDa0qSYW5eCQ1Zv?=
 =?us-ascii?Q?tLU+eHhawItNmD7hnkNdkM/IWmL4MVwvrIjE5FJXAE/TXuoJclLDAY5bW18D?=
 =?us-ascii?Q?H/zdsM3smgvPeCA4mD5lI3jb5RAZqbP9GX+q4ehIaoBnycvt6MMBTmyvBmfX?=
 =?us-ascii?Q?4xxovWC2zOV+ymxPDFQabmEaEOkv6rFHhxdghDhMTcUrcdLgRV+aWHoNgk46?=
 =?us-ascii?Q?BqZOrTasB4x2OhE+FGWAdTiDQXbtsZoC5DAU7gqvz5vGWnMk5cJ7zGVRdfhy?=
 =?us-ascii?Q?QI+rjqo67nqCLqxYYFelCZy172Zr+S8gWjl5CgxdxtbeQ9u4EhjYBFz+fGPV?=
 =?us-ascii?Q?70CSbN8kmGyl3Pmh+fjYhvolhR+cGRUgIKPJF0WsCdRPujxDTv2EkLOBT0ae?=
 =?us-ascii?Q?VHMnvU4GY2f1YAJ4MGKVe+qjmEDuYUk5Ym/t38TxdCEa2uNptIv5hZpIHlPf?=
 =?us-ascii?Q?BtXxYLG7Xuxpi8mliZfSCKV56Eq5GQd06hvko9fHXovfc+IY2t8XrDIuOKv5?=
 =?us-ascii?Q?QlResXJlfOyffh/SihsV9uoK8eT1OOb7eKZhfLfN/PixhNnjBwgITOdvo8dl?=
 =?us-ascii?Q?DIHkIAu/vFwSO8bf+p1zbIJPHxbcPUCmJGrU5Fu+K11Bx/OjSkJ6in7ydoxH?=
 =?us-ascii?Q?xAP3v0+zNoczEgNT6qPh6srPpp0WQ4o96z6b+6cfybr4UkzEoQiJsSOMBrwQ?=
 =?us-ascii?Q?Mg=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 836c208d-143d-418f-162c-08db02e576d6
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 30 Jan 2023 17:14:36.9752
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: dpuYKV/KGoIFrp9XUAEyObnIY7NV81Hxv08j9wbyGbNBmofCHjbWUNz4UnBkwsFtukc3cZAgesHWzPa9mcLO9Gs2kvvK6hi0UbOcLG+nLPk=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR17MB6197
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, Jan 30, 2023 at 01:24:51PM +0000, Jonathan Cameron wrote:
> 
> > diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> > index e59ba22387..6893f54e28 100644
> > --- a/tests/qtest/cxl-test.c
> > +++ b/tests/qtest/cxl-test.c
> > @@ -40,32 +40,46 @@
> >    "-device cxl-rp,id=rp2,bus=cxl.1,chassis=0,slot=2 " \
> >    "-device cxl-rp,id=rp3,bus=cxl.1,chassis=0,slot=3 "
> >  
> > -#define QEMU_T3D \
> > +#define QEMU_T3D_DEPRECATED \
> >    "-object memory-backend-file,id=cxl-mem0,mem-path=%s,size=256M " \
> > -  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M "    \
> > +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
> >    "-device cxl-type3,bus=rp0,memdev=cxl-mem0,lsa=lsa0,id=cxl-pmem0 "
> >  
> > +#define QEMU_T3D_PMEM \
> > +  "-object memory-backend-file,id=m0,mem-path=%s,size=256M " \
> > +  "-object memory-backend-file,id=lsa0,mem-path=%s,size=256M " \
> > +  "-device cxl-type3,bus=rp0,persistent-memdev=cxl-m0,lsa=lsa0,id=pmem0 "
> naming mismatch. I've fixed up with mem0 as the device name. 
> The naming isn't totally consistent so I may tweak this some more before
> sending for upstream.
> 
>

ack

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 00D23C54EAA
	for <linux-cxl@archiver.kernel.org>; Mon, 30 Jan 2023 17:16:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S236937AbjA3RQJ (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Mon, 30 Jan 2023 12:16:09 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39138 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S236102AbjA3RQI (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Mon, 30 Jan 2023 12:16:08 -0500
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (mail-dm6nam10on2062.outbound.protection.outlook.com [40.107.93.62])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 96E171B540
        for <linux-cxl@vger.kernel.org>; Mon, 30 Jan 2023 09:16:05 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=eX7ybODJZcGtGUMDL5rcTSGIQemqQ9hiWtWAtQ2G8hHcZdc2MjU3M5BsGpDqRssMfoeACPhLOaOjmfTaSGrvrCku8G9s6xcOrEf7FENMo6UOgaG+03hVJYpWQL59uNihGVRwzoC8Y+q0PwiH6/mYDMxW9T5RYsQx/9Zw1mXOqU9RwKBAQBAmb0UXjCoTUeIvQDwKFSCuDYxqnKe9pea7TQqDgKEHsejIb1XOvrNoe5sziWtg8hxquN4pPQ8AJ8LCAUw92Kuz2PIvCESPPqYDNlEgnDHwYvxHXN8XeK6TbowT4RB6OSz5NC4TnbtzX91iC8j+ZoDmRoFhB2ROiRPFzw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=l8y6L9BimaYAJY6ENVE1B/tBoU3juv0Fe6dUMwUOCrc=;
 b=RYah/XVK0aFkHQiUR/QPr6jgqUTGoGdux6uW9OswydQ7m6yHAPU3ca7RZP2Fr7doeUc0r8b1jgHlTMLIV4Kbfd/yKW1lq5W8T+ImI498/0GkaLxNUsldysOdZkK/CnCWHyqp7G3dkhXTkbkb8+nTTSLT9amrTU9gMK7SP2g+alY4gvRPFXTSxB5Z/DEy/JCXQxTKXlebHnBfZoJo3Gd7QqaUUTVWUdh28VZNHvKRz3ceCgJEMsP6heN93/v8guATPYPobuzIOrrz3pn0W8/+TTGXKEGzCpehItyn2qLXQ55WXnzg4t0rQ16g+UbMhXchMCFQjdlXlMzznI6ZZ7FegA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=memverge.com; dmarc=pass action=none header.from=memverge.com;
 dkim=pass header.d=memverge.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=memverge.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=l8y6L9BimaYAJY6ENVE1B/tBoU3juv0Fe6dUMwUOCrc=;
 b=UXDPh1HZUE91FQdfWSWmFkWE2OLzL/ZuF9/rcSrbo76JfpxwPyL6TVEbo02K/RWHFYJNoWnetdhhXKJm3W10YM8eoSd5hzX5LgHaY3G/UxKKdkZFlied/BR7x1exNBXvvcPxD5Riv9nNb9ddtjTlQrFt9ct1ViE640eb3pKhbQk=
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=memverge.com;
Received: from BN6PR17MB3121.namprd17.prod.outlook.com (2603:10b6:405:7c::19)
 by BY5PR17MB3987.namprd17.prod.outlook.com (2603:10b6:a03:23f::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6043.30; Mon, 30 Jan
 2023 17:16:02 +0000
Received: from BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660]) by BN6PR17MB3121.namprd17.prod.outlook.com
 ([fe80::d253:1eb3:9347:c660%4]) with mapi id 15.20.6043.028; Mon, 30 Jan 2023
 17:16:02 +0000
Date: Mon, 30 Jan 2023 09:38:52 -0500
From: Gregory Price <gregory.price@memverge.com>
To: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Cc: Gregory Price <gourry.memverge@gmail.com>, qemu-devel@nongnu.org,
        linux-cxl@vger.kernel.org, alison.schofield@intel.com,
        dave@stgolabs.net, a.manzanares@samsung.com, bwidawsk@kernel.org,
        hchkuo@avery-design.com.tw, cbrowy@avery-design.com,
        ira.weiny@intel.com
Subject: Re: [RFC v4 2/3] tests/qtest/cxl-test: whitespace, line ending
 cleanup
Message-ID: <Y9fWfI1ul9J86JWc@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
 <20221128150157.97724-3-gregory.price@memverge.com>
 <20230105143807.0000315a@huawei.com>
 <20230130131150.000023a1@huawei.com>
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230130131150.000023a1@huawei.com>
X-ClientProxiedBy: SJ0PR03CA0110.namprd03.prod.outlook.com
 (2603:10b6:a03:333::25) To BN6PR17MB3121.namprd17.prod.outlook.com
 (2603:10b6:405:7c::19)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: BN6PR17MB3121:EE_|BY5PR17MB3987:EE_
X-MS-Office365-Filtering-Correlation-Id: 44f2c345-9776-4e7e-767e-08db02e5a9de
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 56tIrPT962/AvGbeoi8SUiG6LdLM38InShNLWXdAFc9jQLpVNfo1Xxe/ak6OdMJvnyrDhQFXJWv3Bw/F6Ke2IkuB/74Y/+KrFdRFrnHjHdKDfTfp3Sp5l9eH74j5p605iynzG9e9xc8uDmOoPw+GhP46p/xEeGiHVaWA3pkW9yrhoj/wNRTzjbQOU+W1v4pG+Qx6VT66SGow+18Mjndoks4PjK76ug7+XzfplyvQvxsFjsJCPDoIrtiRFknNyi/TITo0dm2ucU8ZipqMJYFt2lr1sfwK33N/gaTuT4uBft9aZ2GrKeaJ7W1SmwTF4towLDtEyVifRMY7TaubrRtY9lnluy/+UZHwYCsmFstp9lcZlnpEd4rKM5ZMmGWd93xyEVqQL9YbksM1CAoQhqXEfyDHs9Tbf63KQHdWbNOyOl2eakUh0PvBrdAImQcud8X1Hui7kuL00uaPrVbVNYzPw8MzSaVevgrT6ZMHQG8H7fhgExhVqJiAUMLvFcpH4roMB2fEQKN4NorJzMd9JFEk6hN9/DEPEB5pvfUxq2Id74UILeaxCthJSwGY0nsPjiNSlESfQMEAGPbgpajbVMAjr2hSZq2liXIEzXPTjyVxSrRWrFG2SNPjwCskE6T3yFYG72MacBcVZ3krmPbgmqceSg==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:BN6PR17MB3121.namprd17.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(136003)(346002)(366004)(376002)(396003)(39830400003)(451199018)(7416002)(2616005)(316002)(5660300002)(2906002)(41300700001)(8936002)(66556008)(478600001)(6486002)(6666004)(66476007)(66946007)(6916009)(4326008)(6506007)(6512007)(186003)(26005)(8676002)(44832011)(83380400001)(38100700002)(86362001)(36756003);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?tfImD+XrKBKAwKTp0ndBy6h27oS1yKSWgTiCVcJ8EISQldbn9QdZI8pwx8P1?=
 =?us-ascii?Q?DXAbuvesNB+QEHddUPBtWLsqxNSf+RgD8GC4gGJq3DJ0e37xlvVU0WDZmVSZ?=
 =?us-ascii?Q?UXzT7mmkVo9mhRc6786R8XZc0B9BbgxNf5TBjpldsZEBdzP53cFxblBciIxk?=
 =?us-ascii?Q?ma4LbLhBKzXiNDwB5y0MJbPXLmyEXNTXT7GDu8i8XW0up8W0uSaVIsQS9UaT?=
 =?us-ascii?Q?jA2Z4uI4t1Tv1sfPhYluJ48MuPvhUObq4B6kARmOXr7pmdr22PGnczK78afv?=
 =?us-ascii?Q?Im5e+Qm1AgvMxleJ4uHkdiQkcpEBht0a3RgSf9v/4/ErZsLmjiui42dyXpwx?=
 =?us-ascii?Q?UeUL2nBwjSDO2Pl/ZFwjEGBmhzRJ1OUN7bJk5LUFVI91BekkJyVS1k+LwGeB?=
 =?us-ascii?Q?T0BbL+EqNQqOaqyjc6oqu19kVNhMr0oBzj6DhLs1vYdFhCLOiwKrbOWXXJR2?=
 =?us-ascii?Q?wQt5rWNbGiHlQWmFJV3zfpCYdV46hNBBEGLn58GPYrUx2FNcGKSh1wDS3egL?=
 =?us-ascii?Q?zd0+nVFyMniRz6HZCbMnlny1XMNZlVnJPTtwfzi8Gb2awkp88NLVbCvrJxbf?=
 =?us-ascii?Q?sobTzVCe7BncpzxnZAQBcwAPg4aNxDDsa6myaovTRlE3alFib1rCUGknw1F0?=
 =?us-ascii?Q?9I2U4NvB5q0eFPht6vNO7S2Ov+SjKcWwA692bKd4/oOSICkCFGxTWROnP3LX?=
 =?us-ascii?Q?dhOudYRnZKbo/VfqnTjX8V2qPBuweuGOO2zAnN+Fsg4plUOWHYgieNL9qc21?=
 =?us-ascii?Q?LC8JQmLAak7Y6bm90QBnJVR09vcE2260hai0mXHSApWy5/ypHl5dwhFqGVku?=
 =?us-ascii?Q?+4bXyWWZU7plrb+rTL/VYBVdcgkWPqiIKYcbTkCMLKBE8AN5pzyIbYVDvosJ?=
 =?us-ascii?Q?0m3P2tUFXIT6JG6GoJG5ySQVU2zmiqdr7GMN9ClxMVxSwZOQlf7nEAubZzYS?=
 =?us-ascii?Q?qFXTQLPtR9c3kYFRCfvMS7G5FzVDqOFcPdIBo7VgVNvEXOWe3eJF3LvVDZGx?=
 =?us-ascii?Q?Ofq9B8afZGmYwxtenPCTf0FNzF38Wulh34JDhy3AO4oLtFRyyZ73nD1aDUOc?=
 =?us-ascii?Q?e5YzNVU6NrUOk085pIccKxJ8fIW/VbM6vjgZgYMQEFvU+3T83F1lEXedEz1X?=
 =?us-ascii?Q?kM28ZvOGky2G9bx14zh4WbgOI7Tcae4+Mw4hGoP9/Dzm04nQKAZIZrI3AiYc?=
 =?us-ascii?Q?bmMcbez3Nt1D0S9CltuKp8WE9cR/hQOo2RZsRCGmLu3rtRPMeKzFyAXhFtMj?=
 =?us-ascii?Q?8XPdvVFAFsMTcy06bP/agFZ0eiJht0hbEpTMjWdg3Ts1RGl88Pu7+GrzSYrM?=
 =?us-ascii?Q?LbP96YU80yQPnIdMtMOSNL/1BFBPrYS2kVUM8LptVGx1QKt8xB5FZvk3AdvK?=
 =?us-ascii?Q?1yO+St4MBuT2vH631Qcf/l8nPRwRz8xe9LBMm1YLvPzXWgpqt4Bz1JumSved?=
 =?us-ascii?Q?QYvS0vWKzby0UvBC0MB55yTZjH7lNAgQtqX8OF3O4pVVbd+loJCj4hv5AgaT?=
 =?us-ascii?Q?s7DrSBjbjv+nM/XO6y9o3yS7v9266F/ULItnELp9L9LBF+ftmBJh4H6s46rW?=
 =?us-ascii?Q?VLAufP6ThRuzfhuxuilaUqArmwBVjQCNWIKHr1LTxavTkR0fmXYANxp9elR8?=
 =?us-ascii?Q?eQ=3D=3D?=
X-OriginatorOrg: memverge.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 44f2c345-9776-4e7e-767e-08db02e5a9de
X-MS-Exchange-CrossTenant-AuthSource: BN6PR17MB3121.namprd17.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 30 Jan 2023 17:16:02.5314
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 5c90cb59-37e7-4c81-9c07-00473d5fb682
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: FEvjSazrG0n79n1CJlwVeVLYvHS7iMTqXD2pW7ahrC0vu4IJMbMRJLhSZvnRvZIo1G8FJRElf/418qycTPoPF/rQ+aRZTQt4ksrtrE9xxcU=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BY5PR17MB3987
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, Jan 30, 2023 at 01:11:50PM +0000, Jonathan Cameron wrote:
> On Thu, 5 Jan 2023 14:38:07 +0000
> Jonathan Cameron <Jonathan.Cameron@huawei.com> wrote:
> 
> > On Mon, 28 Nov 2022 10:01:56 -0500
> > Gregory Price <gourry.memverge@gmail.com> wrote:
> > 
> > > Defines are starting to exceed line length limits, align them for
> > > cleanliness before making modifications.
> > > 
> > > Signed-off-by: Gregory Price <gregory.price@memverge.com>  
> > 
> > Hi Gregory,
> > 
> > I was just reordering my tree and noticed that you've only
> > gone with 2 space indent.  Given 4 spaces is the convention in QEMU
> > for other uses, I've switched my local copy of this over to 4 spaces.
> > 
> > Note there was also a single inconsistent 1 space indent - see below.
> > 
> > Jonathan
> > 
> > > 
> > > ---
> > >  tests/qtest/cxl-test.c | 99 +++++++++++++++++++++++-------------------
> > >  1 file changed, 54 insertions(+), 45 deletions(-)
> > > 
> > > diff --git a/tests/qtest/cxl-test.c b/tests/qtest/cxl-test.c
> > > index c54f18e76b..e59ba22387 100644
> > > --- a/tests/qtest/cxl-test.c
> > > +++ b/tests/qtest/cxl-test.c
> > > @@ -8,55 +8,64 @@
> > >  #include "qemu/osdep.h"
> > >  #include "libqtest-single.h"
> > >  
> > > -#define QEMU_PXB_CMD "-machine q35,cxl=on " \
> > > -                     "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > > -                     "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> > > -
> > > -#define QEMU_2PXB_CMD "-machine q35,cxl=on "                            \
> > > -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > > -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> > > -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> > > -
> > > -#define QEMU_VIRT_2PXB_CMD "-machine virt,cxl=on "                      \
> > > -                      "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 "  \
> > > -                      "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 "  \
> > > -                      "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "
> > > -
> > > -#define QEMU_RP "-device cxl-rp,id=rp0,bus=cxl.0,chassis=0,slot=0 "
> > > +#define QEMU_PXB_CMD \
> > > +  "-machine q35,cxl=on " \
> > > +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> > > +  "-M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.size=4G "
> > > +
> > > +#define QEMU_2PXB_CMD \
> > > +  "-machine q35,cxl=on " \
> > > +  "-device pxb-cxl,id=cxl.0,bus=pcie.0,bus_nr=52 " \
> > > +  "-device pxb-cxl,id=cxl.1,bus=pcie.0,bus_nr=53 " \
> > > + "- M cxl-fmw.0.targets.0=cxl.0,cxl-fmw.0.targets.1=cxl.1,cxl-fmw.0.size=4G "  
> > This one only has one space.
> It also has a space after the - that I somehow missed. Fixed up in the version I'm
> carrying. Will push out a new tree once I've caught up with some other pending items.

ack

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-cxl-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 216C9C38142
	for <linux-cxl@archiver.kernel.org>; Tue, 31 Jan 2023 11:53:26 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229962AbjAaLxZ (ORCPT <rfc822;linux-cxl@archiver.kernel.org>);
        Tue, 31 Jan 2023 06:53:25 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:50466 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230377AbjAaLxV (ORCPT
        <rfc822;linux-cxl@vger.kernel.org>); Tue, 31 Jan 2023 06:53:21 -0500
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0F682DBC3
        for <linux-cxl@vger.kernel.org>; Tue, 31 Jan 2023 03:53:18 -0800 (PST)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
        by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4P5jyV4x0Lz6J6CH;
        Tue, 31 Jan 2023 19:49:38 +0800 (CST)
Received: from localhost (10.122.247.231) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2375.34; Tue, 31 Jan
 2023 11:53:15 +0000
Date: Tue, 31 Jan 2023 11:53:14 +0000
From: Jonathan Cameron <Jonathan.Cameron@huawei.com>
To: Gregory Price <gourry.memverge@gmail.com>
CC: <qemu-devel@nongnu.org>, <linux-cxl@vger.kernel.org>,
        <alison.schofield@intel.com>, <dave@stgolabs.net>,
        <a.manzanares@samsung.com>, <bwidawsk@kernel.org>,
        <gregory.price@memverge.com>, <hchkuo@avery-design.com.tw>,
        <cbrowy@avery-design.com>, <ira.weiny@intel.com>
Subject: Re: [RFC v4 3/3] hw/cxl: Multi-Region CXL Type-3 Devices (Volatile
 and Persistent)
Message-ID: <20230131115314.00004f7e@huawei.com>
In-Reply-To: <20221128150157.97724-4-gregory.price@memverge.com>
References: <20221128150157.97724-1-gregory.price@memverge.com>
        <20221128150157.97724-4-gregory.price@memverge.com>
Organization: Huawei Technologies R&D (UK) Ltd.
X-Mailer: Claws Mail 4.0.0 (GTK+ 3.24.29; x86_64-w64-mingw32)
MIME-Version: 1.0
Content-Type: text/plain; charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Originating-IP: [10.122.247.231]
X-ClientProxiedBy: lhrpeml500002.china.huawei.com (7.191.160.78) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <linux-cxl.vger.kernel.org>
X-Mailing-List: linux-cxl@vger.kernel.org

On Mon, 28 Nov 2022 10:01:57 -0500
Gregory Price <gourry.memverge@gmail.com> wrote:

> From: Gregory Price <gourry.memverge@gmail.com>
> 
> This commit enables each CXL Type-3 device to contain one volatile
> memory region and one persistent region.
> 
> Two new properties have been added to cxl-type3 device initialization:
>     [volatile-memdev] and [persistent-memdev]
> 
> The existing [memdev] property has been deprecated and will default the
> memory region to a persistent memory region (although a user may assign
> the region to a ram or file backed region). It cannot be used in
> combination with the new [persistent-memdev] property.
> 
> Partitioning volatile memory from persistent memory is not yet supported.
> 
> Volatile memory is mapped at DPA(0x0), while Persistent memory is mapped
> at DPA(vmem->size), per CXL Spec 8.2.9.8.2.0 - Get Partition Info.
> 
> Signed-off-by: Gregory Price <gregory.price@memverge.com>
> Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>

I'm taking another look at these and tweaking what I'm carrying as I go
with a plan to post them for merging shortly.

Anyhow, a few more changes I wanted to call out here so they don't come
as a surprise / are things to focus on in reviewing that version 
(hopefully post it later today or maybe tomorrow).

Most of this is reducing the diff / duplication of code to make review a
tiny bit easier (hopefully)

...
  
>  /* TODO: Support multiple HDM decoders and DPA skip */
> @@ -663,11 +769,17 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
>  {
>      CXLType3Dev *ct3d = CXL_TYPE3(d);
>      uint64_t dpa_offset;
> -    MemoryRegion *mr;
> +    MemoryRegion *vmr = NULL, *pmr = NULL;
> +    AddressSpace *as;

We end up with a lot of duplication between cxl_type3_read and cxl_type3_write()
so I've factored out a _get_as_and_dpa() function that deals with establish
where the memory we then read or write is. 

>  
> -    /* TODO support volatile region */
> -    mr = host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> +    if (ct3d->hostvmem) {
> +        vmr = host_memory_backend_get_memory(ct3d->hostvmem);
> +    }
> +    if (ct3d->hostpmem) {
> +        pmr = host_memory_backend_get_memory(ct3d->hostpmem);
> +    }
> +
> +    if (!vmr && !pmr) {
>          return MEMTX_ERROR;
>      }
>  
> @@ -675,11 +787,22 @@ MemTxResult cxl_type3_read(PCIDevice *d, hwaddr host_addr, uint64_t *data,
>          return MEMTX_ERROR;
>      }
>  
> -    if (dpa_offset > int128_get64(mr->size)) {
> +    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
>          return MEMTX_ERROR;
>      }
>  
> -    return address_space_read(&ct3d->hostmem_as, dpa_offset, attrs, data, size);
> +    if (vmr) {
> +        if (dpa_offset <= int128_get64(vmr->size)) {
> +            as = &ct3d->hostvmem_as;
> +        } else {
> +            as = &ct3d->hostpmem_as;
> +            dpa_offset -= vmr->size;
> +        }
> +    }
> +    else {
> +        as = &ct3d->hostpmem_as;
> +    }
> +    return address_space_read(as, dpa_offset, attrs, data, size);
>  }
>  
>  MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
> @@ -687,10 +810,17 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
>  {
>      CXLType3Dev *ct3d = CXL_TYPE3(d);
>      uint64_t dpa_offset;
> -    MemoryRegion *mr;
> +    MemoryRegion *vmr = NULL, *pmr = NULL;
> +    AddressSpace *as;
>  
> -    mr = host_memory_backend_get_memory(ct3d->hostmem);
> -    if (!mr) {
> +    if (ct3d->hostvmem) {
> +        vmr = host_memory_backend_get_memory(ct3d->hostvmem);
> +    }
> +    if (ct3d->hostpmem) {
> +        pmr = host_memory_backend_get_memory(ct3d->hostpmem);
> +    }
> +
> +    if (!vmr && !pmr) {
>          return MEMTX_OK;
>      }
>  
> @@ -698,11 +828,22 @@ MemTxResult cxl_type3_write(PCIDevice *d, hwaddr host_addr, uint64_t data,
>          return MEMTX_OK;
>      }
>  
> -    if (dpa_offset > int128_get64(mr->size)) {
> +    if (dpa_offset > int128_get64(ct3d->cxl_dstate.mem_size)) {
>          return MEMTX_OK;
>      }
> -    return address_space_write(&ct3d->hostmem_as, dpa_offset, attrs,
> -                               &data, size);
> +
> +    if (vmr) {
> +        if (dpa_offset <= int128_get64(vmr->size)) {
> +            as = &ct3d->hostvmem_as;
> +        } else {
> +            as = &ct3d->hostpmem_as;
> +            dpa_offset -= vmr->size;
> +        }
> +    }
> +    else {
> +        as = &ct3d->hostpmem_as;
> +    }
> +    return address_space_write(as, dpa_offset, attrs, &data, size);
>  }
>  
>  static void ct3d_reset(DeviceState *dev)
> @@ -717,7 +858,11 @@ static void ct3d_reset(DeviceState *dev)
>  
>  static Property ct3_props[] = {
>      DEFINE_PROP_LINK("memdev", CXLType3Dev, hostmem, TYPE_MEMORY_BACKEND,
> -                     HostMemoryBackend *),
> +                     HostMemoryBackend *), /* for backward compatibility */
> +    DEFINE_PROP_LINK("persistent-memdev", CXLType3Dev, hostpmem,
> +                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
> +    DEFINE_PROP_LINK("volatile-memdev", CXLType3Dev, hostvmem,
> +                     TYPE_MEMORY_BACKEND, HostMemoryBackend *),
>      DEFINE_PROP_LINK("lsa", CXLType3Dev, lsa, TYPE_MEMORY_BACKEND,
>                       HostMemoryBackend *),
>      DEFINE_PROP_UINT64("sn", CXLType3Dev, sn, UI64_NULL),
> @@ -728,10 +873,12 @@ static Property ct3_props[] = {
>  
>  static uint64_t get_lsa_size(CXLType3Dev *ct3d)
>  {
> -    MemoryRegion *mr;
> -
> -    mr = host_memory_backend_get_memory(ct3d->lsa);
> -    return memory_region_size(mr);
> +    MemoryRegion *mr = NULL;
> +    if (ct3d->lsa) {

I flipped this logic as reduces the resulting diff and makes patch a little
easier to read.

> +        mr = host_memory_backend_get_memory(ct3d->lsa);
> +        return memory_region_size(mr);
> +    }
> +    return 0;
>  }
>  
>  static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
> @@ -744,30 +891,35 @@ static void validate_lsa_access(MemoryRegion *mr, uint64_t size,
>  static uint64_t get_lsa(CXLType3Dev *ct3d, void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> +    MemoryRegion *mr = NULL;
>      void *lsa;
>  
> -    mr = host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {

Flipped this one as well.

> +        mr = host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
>  
> -    lsa = memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(buf, lsa, size);
> +        lsa = memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(buf, lsa, size);
> +        return size;
> +    }
>  
> -    return size;
> +    return 0;
>  }
>  
>  static void set_lsa(CXLType3Dev *ct3d, const void *buf, uint64_t size,
>                      uint64_t offset)
>  {
> -    MemoryRegion *mr;
> -    void *lsa;
> +    MemoryRegion *mr = NULL;
> +    void *lsa = NULL;
>  
> -    mr = host_memory_backend_get_memory(ct3d->lsa);
> -    validate_lsa_access(mr, size, offset);
> +    if (ct3d->lsa) {
> +        mr = host_memory_backend_get_memory(ct3d->lsa);
> +        validate_lsa_access(mr, size, offset);
>  
> -    lsa = memory_region_get_ram_ptr(mr) + offset;
> -    memcpy(lsa, buf, size);
> -    memory_region_set_dirty(mr, offset, size);
> +        lsa = memory_region_get_ram_ptr(mr) + offset;
> +        memcpy(lsa, buf, size);
> +        memory_region_set_dirty(mr, offset, size);
> +    }
>  
>      /*
>       * Just like the PMEM, if the guest is not allowed to exit gracefully, label
> @@ -978,7 +1130,7 @@ static void ct3_class_init(ObjectClass *oc, void *data)
>      pc->config_read = ct3d_config_read;
>  
>      set_bit(DEVICE_CATEGORY_STORAGE, dc->categories);
> -    dc->desc = "CXL PMEM Device (Type 3)";
> +    dc->desc = "CXL Memory Device (Type 3)";
>      dc->reset = ct3d_reset;
>      device_class_set_props(dc, ct3_props);
>  
>

